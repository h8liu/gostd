<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8000984">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8001039">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8001093">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8001144">package</span>&nbsp;<span class="ident" id="8001152">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8001157">import</span>&nbsp;<span class="op" id="8001164">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001167">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001190">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001200">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001207">&#34;math/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001220">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001231">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001242">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001253">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001261">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8001272">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8001279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="8001282">func</span>&nbsp;<span class="ident" id="8001287">init</span><span class="op" id="8001291">(</span><span class="op" id="8001292">)</span>&nbsp;<span class="op" id="8001294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8001297">type</span>&nbsp;<span class="ident" id="8001302">dbConn</span>&nbsp;<span class="keyword" id="8001309">struct</span>&nbsp;<span class="op" id="8001316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001320">db</span>&nbsp;<span class="op" id="8001323">*</span><span class="ident" id="8001324">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001329">c</span>&nbsp;&nbsp;<span class="op" id="8001332">*</span><span class="ident" id="8001333">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8001345">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001348">freedFrom</span>&nbsp;<span class="op" id="8001358">:=</span>&nbsp;<span class="builtinfunc" id="8001361">make</span><span class="op" id="8001365">(</span><span class="keyword" id="8001366">map</span><span class="op" id="8001369">[</span><span class="ident" id="8001370">dbConn</span><span class="op" id="8001376">]</span><span class="builtintype" id="8001377">string</span><span class="op" id="8001383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001386">putConnHook</span>&nbsp;<span class="op" id="8001398">=</span>&nbsp;<span class="keyword" id="8001400">func</span><span class="op" id="8001404">(</span><span class="ident" id="8001405">db</span>&nbsp;<span class="op" id="8001408">*</span><span class="ident" id="8001409">DB</span><span class="op" id="8001411">,</span>&nbsp;<span class="ident" id="8001413">c</span>&nbsp;<span class="op" id="8001415">*</span><span class="ident" id="8001416">driverConn</span><span class="op" id="8001426">)</span>&nbsp;<span class="op" id="8001428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001432">idx</span>&nbsp;<span class="op" id="8001436">:=</span>&nbsp;<span class="op" id="8001439">-</span><span class="num" id="8001440">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8001444">for</span>&nbsp;<span class="ident" id="8001448">i</span><span class="op" id="8001449">,</span>&nbsp;<span class="ident" id="8001451">v</span>&nbsp;<span class="op" id="8001453">:=</span>&nbsp;<span class="keyword" id="8001456">range</span>&nbsp;<span class="ident" id="8001462">db</span><span class="op" id="8001464">.</span><span class="ident" id="8001465">freeConn</span>&nbsp;<span class="op" id="8001474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8001479">if</span>&nbsp;<span class="ident" id="8001482">v</span>&nbsp;<span class="op" id="8001484">==</span>&nbsp;<span class="ident" id="8001487">c</span>&nbsp;<span class="op" id="8001489">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001495">idx</span>&nbsp;<span class="op" id="8001499">=</span>&nbsp;<span class="ident" id="8001501">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8001507">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8001516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8001520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8001524">if</span>&nbsp;<span class="ident" id="8001527">idx</span>&nbsp;<span class="op" id="8001531">&gt;=</span>&nbsp;<span class="num" id="8001534">0</span>&nbsp;<span class="op" id="8001536">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8001541">//&nbsp;print&nbsp;before&nbsp;panic,&nbsp;as&nbsp;panic&nbsp;may&nbsp;get&nbsp;lost&nbsp;due&nbsp;to&nbsp;conflicting&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8001614">//&nbsp;(all&nbsp;goroutines&nbsp;asleep)&nbsp;elsewhere,&nbsp;since&nbsp;we&nbsp;might&nbsp;not&nbsp;unlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8001681">//&nbsp;the&nbsp;mutex&nbsp;in&nbsp;freeConn&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8001715">println</span><span class="op" id="8001722">(</span><span class="string" id="8001723">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&nbsp;conflicts&nbsp;are:\nA)&nbsp;&#34;</span>&nbsp;<span class="op" id="8001766">+</span>&nbsp;<span class="ident" id="8001768">freedFrom</span><span class="op" id="8001777">[</span><span class="ident" id="8001778">dbConn</span><span class="op" id="8001784">{</span><span class="ident" id="8001785">db</span><span class="op" id="8001787">,</span>&nbsp;<span class="ident" id="8001789">c</span><span class="op" id="8001790">}</span><span class="op" id="8001791">]</span>&nbsp;<span class="op" id="8001793">+</span>&nbsp;<span class="string" id="8001795">&#34;\n\nand\nB)&nbsp;&#34;</span>&nbsp;<span class="op" id="8001810">+</span>&nbsp;<span class="ident" id="8001812">stack</span><span class="op" id="8001817">(</span><span class="op" id="8001818">)</span><span class="op" id="8001819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8001824">panic</span><span class="op" id="8001829">(</span><span class="string" id="8001830">&#34;double&nbsp;free&nbsp;of&nbsp;conn.&#34;</span><span class="op" id="8001852">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8001856">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8001860">freedFrom</span><span class="op" id="8001869">[</span><span class="ident" id="8001870">dbConn</span><span class="op" id="8001876">{</span><span class="ident" id="8001877">db</span><span class="op" id="8001879">,</span>&nbsp;<span class="ident" id="8001881">c</span><span class="op" id="8001882">}</span><span class="op" id="8001883">]</span>&nbsp;<span class="op" id="8001885">=</span>&nbsp;<span class="ident" id="8001887">stack</span><span class="op" id="8001892">(</span><span class="op" id="8001893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8001896">}</span><br>
<span class="lineno"></span><span class="op" id="8001898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="8001901">const</span>&nbsp;<span class="ident" id="8001907">fakeDBName</span>&nbsp;<span class="op" id="8001918">=</span>&nbsp;<span class="string" id="8001920">&#34;foo&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8001927">var</span>&nbsp;<span class="ident" id="8001931">chrisBirthday</span>&nbsp;<span class="op" id="8001945">=</span>&nbsp;<span class="ident" id="8001947">time</span><span class="op" id="8001951">.</span><span class="ident" id="8001952">Unix</span><span class="op" id="8001956">(</span><span class="num" id="8001957">123456789</span><span class="op" id="8001966">,</span>&nbsp;<span class="num" id="8001968">0</span><span class="op" id="8001969">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8001972">func</span>&nbsp;<span class="ident" id="8001977">newTestDB</span><span class="op" id="8001986">(</span><span class="ident" id="8001987">t</span>&nbsp;<span class="ident" id="8001989">testing</span><span class="op" id="8001996">.</span><span class="ident" id="8001997">TB</span><span class="op" id="8001999">,</span>&nbsp;<span class="ident" id="8002001">name</span>&nbsp;<span class="builtintype" id="8002006">string</span><span class="op" id="8002012">)</span>&nbsp;<span class="op" id="8002014">*</span><span class="ident" id="8002015">DB</span>&nbsp;<span class="op" id="8002018">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002021">db</span><span class="op" id="8002023">,</span>&nbsp;<span class="ident" id="8002025">err</span>&nbsp;<span class="op" id="8002029">:=</span>&nbsp;<span class="ident" id="8002032">Open</span><span class="op" id="8002036">(</span><span class="string" id="8002037">&#34;test&#34;</span><span class="op" id="8002043">,</span>&nbsp;<span class="ident" id="8002045">fakeDBName</span><span class="op" id="8002055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002058">if</span>&nbsp;<span class="ident" id="8002061">err</span>&nbsp;<span class="op" id="8002065">!=</span>&nbsp;<span class="ident" id="8002068">nil</span>&nbsp;<span class="op" id="8002072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002076">t</span><span class="op" id="8002077">.</span><span class="ident" id="8002078">Fatalf</span><span class="op" id="8002084">(</span><span class="string" id="8002085">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8002095">,</span>&nbsp;<span class="ident" id="8002097">err</span><span class="op" id="8002100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8002103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002106">if</span>&nbsp;<span class="ident" id="8002109">_</span><span class="op" id="8002110">,</span>&nbsp;<span class="ident" id="8002112">err</span>&nbsp;<span class="op" id="8002116">:=</span>&nbsp;<span class="ident" id="8002119">db</span><span class="op" id="8002121">.</span><span class="ident" id="8002122">Exec</span><span class="op" id="8002126">(</span><span class="string" id="8002127">&#34;WIPE&#34;</span><span class="op" id="8002133">)</span><span class="op" id="8002134">;</span>&nbsp;<span class="ident" id="8002136">err</span>&nbsp;<span class="op" id="8002140">!=</span>&nbsp;<span class="ident" id="8002143">nil</span>&nbsp;<span class="op" id="8002147">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002151">t</span><span class="op" id="8002152">.</span><span class="ident" id="8002153">Fatalf</span><span class="op" id="8002159">(</span><span class="string" id="8002160">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8002175">,</span>&nbsp;<span class="ident" id="8002177">err</span><span class="op" id="8002180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8002183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002186">if</span>&nbsp;<span class="ident" id="8002189">name</span>&nbsp;<span class="op" id="8002194">==</span>&nbsp;<span class="string" id="8002197">&#34;people&#34;</span>&nbsp;<span class="op" id="8002206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002210">exec</span><span class="op" id="8002214">(</span><span class="ident" id="8002215">t</span><span class="op" id="8002216">,</span>&nbsp;<span class="ident" id="8002218">db</span><span class="op" id="8002220">,</span>&nbsp;<span class="string" id="8002222">&#34;CREATE|people|name=string,age=int32,photo=blob,dead=bool,bdate=datetime&#34;</span><span class="op" id="8002295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002299">exec</span><span class="op" id="8002303">(</span><span class="ident" id="8002304">t</span><span class="op" id="8002305">,</span>&nbsp;<span class="ident" id="8002307">db</span><span class="op" id="8002309">,</span>&nbsp;<span class="string" id="8002311">&#34;INSERT|people|name=Alice,age=?,photo=APHOTO&#34;</span><span class="op" id="8002356">,</span>&nbsp;<span class="num" id="8002358">1</span><span class="op" id="8002359">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002363">exec</span><span class="op" id="8002367">(</span><span class="ident" id="8002368">t</span><span class="op" id="8002369">,</span>&nbsp;<span class="ident" id="8002371">db</span><span class="op" id="8002373">,</span>&nbsp;<span class="string" id="8002375">&#34;INSERT|people|name=Bob,age=?,photo=BPHOTO&#34;</span><span class="op" id="8002418">,</span>&nbsp;<span class="num" id="8002420">2</span><span class="op" id="8002421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002425">exec</span><span class="op" id="8002429">(</span><span class="ident" id="8002430">t</span><span class="op" id="8002431">,</span>&nbsp;<span class="ident" id="8002433">db</span><span class="op" id="8002435">,</span>&nbsp;<span class="string" id="8002437">&#34;INSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8002490">,</span>&nbsp;<span class="num" id="8002492">3</span><span class="op" id="8002493">,</span>&nbsp;<span class="ident" id="8002495">chrisBirthday</span><span class="op" id="8002508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8002511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002514">if</span>&nbsp;<span class="ident" id="8002517">name</span>&nbsp;<span class="op" id="8002522">==</span>&nbsp;<span class="string" id="8002525">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="8002538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8002542">//&nbsp;Magic&nbsp;table&nbsp;name&nbsp;and&nbsp;column,&nbsp;known&nbsp;by&nbsp;fakedb_test.go.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002601">exec</span><span class="op" id="8002605">(</span><span class="ident" id="8002606">t</span><span class="op" id="8002607">,</span>&nbsp;<span class="ident" id="8002609">db</span><span class="op" id="8002611">,</span>&nbsp;<span class="string" id="8002613">&#34;CREATE|magicquery|op=string,millis=int32&#34;</span><span class="op" id="8002655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002659">exec</span><span class="op" id="8002663">(</span><span class="ident" id="8002664">t</span><span class="op" id="8002665">,</span>&nbsp;<span class="ident" id="8002667">db</span><span class="op" id="8002669">,</span>&nbsp;<span class="string" id="8002671">&#34;INSERT|magicquery|op=sleep,millis=10&#34;</span><span class="op" id="8002709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8002712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002715">return</span>&nbsp;<span class="ident" id="8002722">db</span><br>
<span class="lineno"></span><span class="op" id="8002725">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="8002728">func</span>&nbsp;<span class="ident" id="8002733">exec</span><span class="op" id="8002737">(</span><span class="ident" id="8002738">t</span>&nbsp;<span class="ident" id="8002740">testing</span><span class="op" id="8002747">.</span><span class="ident" id="8002748">TB</span><span class="op" id="8002750">,</span>&nbsp;<span class="ident" id="8002752">db</span>&nbsp;<span class="op" id="8002755">*</span><span class="ident" id="8002756">DB</span><span class="op" id="8002758">,</span>&nbsp;<span class="ident" id="8002760">query</span>&nbsp;<span class="builtintype" id="8002766">string</span><span class="op" id="8002772">,</span>&nbsp;<span class="ident" id="8002774">args</span>&nbsp;<span class="op" id="8002779">...</span><span class="keyword" id="8002782">interface</span><span class="op" id="8002791">{</span><span class="op" id="8002792">}</span><span class="op" id="8002793">)</span>&nbsp;<span class="op" id="8002795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002798">_</span><span class="op" id="8002799">,</span>&nbsp;<span class="ident" id="8002801">err</span>&nbsp;<span class="op" id="8002805">:=</span>&nbsp;<span class="ident" id="8002808">db</span><span class="op" id="8002810">.</span><span class="ident" id="8002811">Exec</span><span class="op" id="8002815">(</span><span class="ident" id="8002816">query</span><span class="op" id="8002821">,</span>&nbsp;<span class="ident" id="8002823">args</span><span class="op" id="8002827">...</span><span class="op" id="8002830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002833">if</span>&nbsp;<span class="ident" id="8002836">err</span>&nbsp;<span class="op" id="8002840">!=</span>&nbsp;<span class="ident" id="8002843">nil</span>&nbsp;<span class="op" id="8002847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002851">t</span><span class="op" id="8002852">.</span><span class="ident" id="8002853">Fatalf</span><span class="op" id="8002859">(</span><span class="string" id="8002860">&#34;Exec&nbsp;of&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="8002876">,</span>&nbsp;<span class="ident" id="8002878">query</span><span class="op" id="8002883">,</span>&nbsp;<span class="ident" id="8002885">err</span><span class="op" id="8002888">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8002891">}</span><br>
<span class="lineno"></span><span class="op" id="8002893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8002896">func</span>&nbsp;<span class="ident" id="8002901">closeDB</span><span class="op" id="8002908">(</span><span class="ident" id="8002909">t</span>&nbsp;<span class="ident" id="8002911">testing</span><span class="op" id="8002918">.</span><span class="ident" id="8002919">TB</span><span class="op" id="8002921">,</span>&nbsp;<span class="ident" id="8002923">db</span>&nbsp;<span class="op" id="8002926">*</span><span class="ident" id="8002927">DB</span><span class="op" id="8002929">)</span>&nbsp;<span class="op" id="8002931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8002934">if</span>&nbsp;<span class="ident" id="8002937">e</span>&nbsp;<span class="op" id="8002939">:=</span>&nbsp;<span class="builtinfunc" id="8002942">recover</span><span class="op" id="8002949">(</span><span class="op" id="8002950">)</span><span class="op" id="8002951">;</span>&nbsp;<span class="ident" id="8002953">e</span>&nbsp;<span class="op" id="8002955">!=</span>&nbsp;<span class="ident" id="8002958">nil</span>&nbsp;<span class="op" id="8002962">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8002966">fmt</span><span class="op" id="8002969">.</span><span class="ident" id="8002970">Printf</span><span class="op" id="8002976">(</span><span class="string" id="8002977">&#34;Panic:&nbsp;%v\n&#34;</span><span class="op" id="8002990">,</span>&nbsp;<span class="ident" id="8002992">e</span><span class="op" id="8002993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8002997">panic</span><span class="op" id="8003002">(</span><span class="ident" id="8003003">e</span><span class="op" id="8003004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003010">defer</span>&nbsp;<span class="ident" id="8003016">setHookpostCloseConn</span><span class="op" id="8003036">(</span><span class="ident" id="8003037">nil</span><span class="op" id="8003040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003043">setHookpostCloseConn</span><span class="op" id="8003063">(</span><span class="keyword" id="8003064">func</span><span class="op" id="8003068">(</span><span class="ident" id="8003069">_</span>&nbsp;<span class="op" id="8003071">*</span><span class="ident" id="8003072">fakeConn</span><span class="op" id="8003080">,</span>&nbsp;<span class="ident" id="8003082">err</span>&nbsp;<span class="builtintype" id="8003086">error</span><span class="op" id="8003091">)</span>&nbsp;<span class="op" id="8003093">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003097">if</span>&nbsp;<span class="ident" id="8003100">err</span>&nbsp;<span class="op" id="8003104">!=</span>&nbsp;<span class="ident" id="8003107">nil</span>&nbsp;<span class="op" id="8003111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003116">t</span><span class="op" id="8003117">.</span><span class="ident" id="8003118">Errorf</span><span class="op" id="8003124">(</span><span class="string" id="8003125">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8003153">,</span>&nbsp;<span class="ident" id="8003155">err</span><span class="op" id="8003158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003165">}</span><span class="op" id="8003166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003169">for</span>&nbsp;<span class="ident" id="8003173">i</span><span class="op" id="8003174">,</span>&nbsp;<span class="ident" id="8003176">dc</span>&nbsp;<span class="op" id="8003179">:=</span>&nbsp;<span class="keyword" id="8003182">range</span>&nbsp;<span class="ident" id="8003188">db</span><span class="op" id="8003190">.</span><span class="ident" id="8003191">freeConn</span>&nbsp;<span class="op" id="8003200">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003204">if</span>&nbsp;<span class="ident" id="8003207">n</span>&nbsp;<span class="op" id="8003209">:=</span>&nbsp;<span class="builtinfunc" id="8003212">len</span><span class="op" id="8003215">(</span><span class="ident" id="8003216">dc</span><span class="op" id="8003218">.</span><span class="ident" id="8003219">openStmt</span><span class="op" id="8003227">)</span><span class="op" id="8003228">;</span>&nbsp;<span class="ident" id="8003230">n</span>&nbsp;<span class="op" id="8003232">&gt;</span>&nbsp;<span class="num" id="8003234">0</span>&nbsp;<span class="op" id="8003236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8003241">//&nbsp;Just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;This&nbsp;is&nbsp;legal&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8003285">//&nbsp;general,&nbsp;but&nbsp;if&nbsp;we&nbsp;make&nbsp;the&nbsp;tests&nbsp;clean&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8003334">//&nbsp;their&nbsp;statements&nbsp;first,&nbsp;then&nbsp;we&nbsp;can&nbsp;safely</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8003383">//&nbsp;verify&nbsp;this&nbsp;is&nbsp;always&nbsp;zero&nbsp;here,&nbsp;and&nbsp;any</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8003430">//&nbsp;other&nbsp;value&nbsp;is&nbsp;a&nbsp;leak.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003459">t</span><span class="op" id="8003460">.</span><span class="ident" id="8003461">Errorf</span><span class="op" id="8003467">(</span><span class="string" id="8003468">&#34;while&nbsp;closing&nbsp;db,&nbsp;freeConn&nbsp;%d/%d&nbsp;had&nbsp;%d&nbsp;open&nbsp;stmts;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8003528">,</span>&nbsp;<span class="ident" id="8003530">i</span><span class="op" id="8003531">,</span>&nbsp;<span class="builtinfunc" id="8003533">len</span><span class="op" id="8003536">(</span><span class="ident" id="8003537">db</span><span class="op" id="8003539">.</span><span class="ident" id="8003540">freeConn</span><span class="op" id="8003548">)</span><span class="op" id="8003549">,</span>&nbsp;<span class="ident" id="8003551">n</span><span class="op" id="8003552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003562">err</span>&nbsp;<span class="op" id="8003566">:=</span>&nbsp;<span class="ident" id="8003569">db</span><span class="op" id="8003571">.</span><span class="ident" id="8003572">Close</span><span class="op" id="8003577">(</span><span class="op" id="8003578">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003581">if</span>&nbsp;<span class="ident" id="8003584">err</span>&nbsp;<span class="op" id="8003588">!=</span>&nbsp;<span class="ident" id="8003591">nil</span>&nbsp;<span class="op" id="8003595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003599">t</span><span class="op" id="8003600">.</span><span class="ident" id="8003601">Fatalf</span><span class="op" id="8003607">(</span><span class="string" id="8003608">&#34;error&nbsp;closing&nbsp;DB:&nbsp;%v&#34;</span><span class="op" id="8003630">,</span>&nbsp;<span class="ident" id="8003632">err</span><span class="op" id="8003635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003641">db</span><span class="op" id="8003643">.</span><span class="ident" id="8003644">mu</span><span class="op" id="8003646">.</span><span class="ident" id="8003647">Lock</span><span class="op" id="8003651">(</span><span class="op" id="8003652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003655">count</span>&nbsp;<span class="op" id="8003661">:=</span>&nbsp;<span class="ident" id="8003664">db</span><span class="op" id="8003666">.</span><span class="ident" id="8003667">numOpen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003676">db</span><span class="op" id="8003678">.</span><span class="ident" id="8003679">mu</span><span class="op" id="8003681">.</span><span class="ident" id="8003682">Unlock</span><span class="op" id="8003688">(</span><span class="op" id="8003689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003692">if</span>&nbsp;<span class="ident" id="8003695">count</span>&nbsp;<span class="op" id="8003701">!=</span>&nbsp;<span class="num" id="8003704">0</span>&nbsp;<span class="op" id="8003706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003710">t</span><span class="op" id="8003711">.</span><span class="ident" id="8003712">Fatalf</span><span class="op" id="8003718">(</span><span class="string" id="8003719">&#34;%d&nbsp;connections&nbsp;still&nbsp;open&nbsp;after&nbsp;closing&nbsp;DB&#34;</span><span class="op" id="8003763">,</span>&nbsp;<span class="ident" id="8003765">db</span><span class="op" id="8003767">.</span><span class="ident" id="8003768">numOpen</span><span class="op" id="8003775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8003778">}</span><br>
<span class="lineno"></span><span class="op" id="8003780">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="comment" id="8003783">//&nbsp;numPrepares&nbsp;assumes&nbsp;that&nbsp;db&nbsp;has&nbsp;exactly&nbsp;1&nbsp;idle&nbsp;conn&nbsp;and&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="8003850">//&nbsp;its&nbsp;count&nbsp;of&nbsp;calls&nbsp;to&nbsp;Prepare</span><br>
<span class="lineno"></span><span class="keyword" id="8003883">func</span>&nbsp;<span class="ident" id="8003888">numPrepares</span><span class="op" id="8003899">(</span><span class="ident" id="8003900">t</span>&nbsp;<span class="op" id="8003902">*</span><span class="ident" id="8003903">testing</span><span class="op" id="8003910">.</span><span class="ident" id="8003911">T</span><span class="op" id="8003912">,</span>&nbsp;<span class="ident" id="8003914">db</span>&nbsp;<span class="op" id="8003917">*</span><span class="ident" id="8003918">DB</span><span class="op" id="8003920">)</span>&nbsp;<span class="builtintype" id="8003922">int</span>&nbsp;<span class="op" id="8003926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8003929">if</span>&nbsp;<span class="ident" id="8003932">n</span>&nbsp;<span class="op" id="8003934">:=</span>&nbsp;<span class="builtinfunc" id="8003937">len</span><span class="op" id="8003940">(</span><span class="ident" id="8003941">db</span><span class="op" id="8003943">.</span><span class="ident" id="8003944">freeConn</span><span class="op" id="8003952">)</span><span class="op" id="8003953">;</span>&nbsp;<span class="ident" id="8003955">n</span>&nbsp;<span class="op" id="8003957">!=</span>&nbsp;<span class="num" id="8003960">1</span>&nbsp;<span class="op" id="8003962">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8003966">t</span><span class="op" id="8003967">.</span><span class="ident" id="8003968">Fatalf</span><span class="op" id="8003974">(</span><span class="string" id="8003975">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8004000">,</span>&nbsp;<span class="ident" id="8004002">n</span><span class="op" id="8004003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8004006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004009">return</span>&nbsp;<span class="ident" id="8004016">db</span><span class="op" id="8004018">.</span><span class="ident" id="8004019">freeConn</span><span class="op" id="8004027">[</span><span class="num" id="8004028">0</span><span class="op" id="8004029">]</span><span class="op" id="8004030">.</span><span class="ident" id="8004031">ci</span><span class="op" id="8004033">.</span><span class="op" id="8004034">(</span><span class="op" id="8004035">*</span><span class="ident" id="8004036">fakeConn</span><span class="op" id="8004044">)</span><span class="op" id="8004045">.</span><span class="ident" id="8004046">numPrepare</span><br>
<span class="lineno"></span><span class="op" id="8004057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="8004060">func</span>&nbsp;<span class="op" id="8004065">(</span><span class="ident" id="8004066">db</span>&nbsp;<span class="op" id="8004069">*</span><span class="ident" id="8004070">DB</span><span class="op" id="8004072">)</span>&nbsp;<span class="ident" id="8004074">numDeps</span><span class="op" id="8004081">(</span><span class="op" id="8004082">)</span>&nbsp;<span class="builtintype" id="8004084">int</span>&nbsp;<span class="op" id="8004088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004091">db</span><span class="op" id="8004093">.</span><span class="ident" id="8004094">mu</span><span class="op" id="8004096">.</span><span class="ident" id="8004097">Lock</span><span class="op" id="8004101">(</span><span class="op" id="8004102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004105">defer</span>&nbsp;<span class="ident" id="8004111">db</span><span class="op" id="8004113">.</span><span class="ident" id="8004114">mu</span><span class="op" id="8004116">.</span><span class="ident" id="8004117">Unlock</span><span class="op" id="8004123">(</span><span class="op" id="8004124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004127">return</span>&nbsp;<span class="builtinfunc" id="8004134">len</span><span class="op" id="8004137">(</span><span class="ident" id="8004138">db</span><span class="op" id="8004140">.</span><span class="ident" id="8004141">dep</span><span class="op" id="8004144">)</span><br>
<span class="lineno"></span><span class="op" id="8004146">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="8004149">//&nbsp;Dependencies&nbsp;are&nbsp;closed&nbsp;via&nbsp;a&nbsp;goroutine,&nbsp;so&nbsp;this&nbsp;polls&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="8004219">//&nbsp;numDeps&nbsp;to&nbsp;fall&nbsp;to&nbsp;want,&nbsp;waiting&nbsp;up&nbsp;to&nbsp;d.</span><br>
<span class="lineno"></span><span class="keyword" id="8004264">func</span>&nbsp;<span class="op" id="8004269">(</span><span class="ident" id="8004270">db</span>&nbsp;<span class="op" id="8004273">*</span><span class="ident" id="8004274">DB</span><span class="op" id="8004276">)</span>&nbsp;<span class="ident" id="8004278">numDepsPollUntil</span><span class="op" id="8004294">(</span><span class="ident" id="8004295">want</span>&nbsp;<span class="builtintype" id="8004300">int</span><span class="op" id="8004303">,</span>&nbsp;<span class="ident" id="8004305">d</span>&nbsp;<span class="ident" id="8004307">time</span><span class="op" id="8004311">.</span><span class="ident" id="8004312">Duration</span><span class="op" id="8004320">)</span>&nbsp;<span class="builtintype" id="8004322">int</span>&nbsp;<span class="op" id="8004326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004329">deadline</span>&nbsp;<span class="op" id="8004338">:=</span>&nbsp;<span class="ident" id="8004341">time</span><span class="op" id="8004345">.</span><span class="ident" id="8004346">Now</span><span class="op" id="8004349">(</span><span class="op" id="8004350">)</span><span class="op" id="8004351">.</span><span class="ident" id="8004352">Add</span><span class="op" id="8004355">(</span><span class="ident" id="8004356">d</span><span class="op" id="8004357">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004360">for</span>&nbsp;<span class="op" id="8004364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004368">n</span>&nbsp;<span class="op" id="8004370">:=</span>&nbsp;<span class="ident" id="8004373">db</span><span class="op" id="8004375">.</span><span class="ident" id="8004376">numDeps</span><span class="op" id="8004383">(</span><span class="op" id="8004384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004388">if</span>&nbsp;<span class="ident" id="8004391">n</span>&nbsp;<span class="op" id="8004393">&lt;=</span>&nbsp;<span class="ident" id="8004396">want</span>&nbsp;<span class="op" id="8004401">||</span>&nbsp;<span class="ident" id="8004404">time</span><span class="op" id="8004408">.</span><span class="ident" id="8004409">Now</span><span class="op" id="8004412">(</span><span class="op" id="8004413">)</span><span class="op" id="8004414">.</span><span class="ident" id="8004415">After</span><span class="op" id="8004420">(</span><span class="ident" id="8004421">deadline</span><span class="op" id="8004429">)</span>&nbsp;<span class="op" id="8004431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004436">return</span>&nbsp;<span class="ident" id="8004443">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8004447">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004451">time</span><span class="op" id="8004455">.</span><span class="ident" id="8004456">Sleep</span><span class="op" id="8004461">(</span><span class="num" id="8004462">50</span>&nbsp;<span class="op" id="8004465">*</span>&nbsp;<span class="ident" id="8004467">time</span><span class="op" id="8004471">.</span><span class="ident" id="8004472">Millisecond</span><span class="op" id="8004483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8004486">}</span><br>
<span class="lineno"></span><span class="op" id="8004488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8004491">func</span>&nbsp;<span class="op" id="8004496">(</span><span class="ident" id="8004497">db</span>&nbsp;<span class="op" id="8004500">*</span><span class="ident" id="8004501">DB</span><span class="op" id="8004503">)</span>&nbsp;<span class="ident" id="8004505">numFreeConns</span><span class="op" id="8004517">(</span><span class="op" id="8004518">)</span>&nbsp;<span class="builtintype" id="8004520">int</span>&nbsp;<span class="op" id="8004524">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004527">db</span><span class="op" id="8004529">.</span><span class="ident" id="8004530">mu</span><span class="op" id="8004532">.</span><span class="ident" id="8004533">Lock</span><span class="op" id="8004537">(</span><span class="op" id="8004538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004541">defer</span>&nbsp;<span class="ident" id="8004547">db</span><span class="op" id="8004549">.</span><span class="ident" id="8004550">mu</span><span class="op" id="8004552">.</span><span class="ident" id="8004553">Unlock</span><span class="op" id="8004559">(</span><span class="op" id="8004560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004563">return</span>&nbsp;<span class="builtinfunc" id="8004570">len</span><span class="op" id="8004573">(</span><span class="ident" id="8004574">db</span><span class="op" id="8004576">.</span><span class="ident" id="8004577">freeConn</span><span class="op" id="8004585">)</span><br>
<span class="lineno"></span><span class="op" id="8004587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="8004590">func</span>&nbsp;<span class="op" id="8004595">(</span><span class="ident" id="8004596">db</span>&nbsp;<span class="op" id="8004599">*</span><span class="ident" id="8004600">DB</span><span class="op" id="8004602">)</span>&nbsp;<span class="ident" id="8004604">dumpDeps</span><span class="op" id="8004612">(</span><span class="ident" id="8004613">t</span>&nbsp;<span class="op" id="8004615">*</span><span class="ident" id="8004616">testing</span><span class="op" id="8004623">.</span><span class="ident" id="8004624">T</span><span class="op" id="8004625">)</span>&nbsp;<span class="op" id="8004627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004630">for</span>&nbsp;<span class="ident" id="8004634">fc</span>&nbsp;<span class="op" id="8004637">:=</span>&nbsp;<span class="keyword" id="8004640">range</span>&nbsp;<span class="ident" id="8004646">db</span><span class="op" id="8004648">.</span><span class="ident" id="8004649">dep</span>&nbsp;<span class="op" id="8004653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004657">db</span><span class="op" id="8004659">.</span><span class="ident" id="8004660">dumpDep</span><span class="op" id="8004667">(</span><span class="ident" id="8004668">t</span><span class="op" id="8004669">,</span>&nbsp;<span class="num" id="8004671">0</span><span class="op" id="8004672">,</span>&nbsp;<span class="ident" id="8004674">fc</span><span class="op" id="8004676">,</span>&nbsp;<span class="keyword" id="8004678">map</span><span class="op" id="8004681">[</span><span class="ident" id="8004682">finalCloser</span><span class="op" id="8004693">]</span><span class="builtintype" id="8004694">bool</span><span class="op" id="8004698">{</span><span class="op" id="8004699">}</span><span class="op" id="8004700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8004703">}</span><br>
<span class="lineno"></span><span class="op" id="8004705">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="8004708">func</span>&nbsp;<span class="op" id="8004713">(</span><span class="ident" id="8004714">db</span>&nbsp;<span class="op" id="8004717">*</span><span class="ident" id="8004718">DB</span><span class="op" id="8004720">)</span>&nbsp;<span class="ident" id="8004722">dumpDep</span><span class="op" id="8004729">(</span><span class="ident" id="8004730">t</span>&nbsp;<span class="op" id="8004732">*</span><span class="ident" id="8004733">testing</span><span class="op" id="8004740">.</span><span class="ident" id="8004741">T</span><span class="op" id="8004742">,</span>&nbsp;<span class="ident" id="8004744">depth</span>&nbsp;<span class="builtintype" id="8004750">int</span><span class="op" id="8004753">,</span>&nbsp;<span class="ident" id="8004755">dep</span>&nbsp;<span class="ident" id="8004759">finalCloser</span><span class="op" id="8004770">,</span>&nbsp;<span class="ident" id="8004772">seen</span>&nbsp;<span class="keyword" id="8004777">map</span><span class="op" id="8004780">[</span><span class="ident" id="8004781">finalCloser</span><span class="op" id="8004792">]</span><span class="builtintype" id="8004793">bool</span><span class="op" id="8004797">)</span>&nbsp;<span class="op" id="8004799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004802">seen</span><span class="op" id="8004806">[</span><span class="ident" id="8004807">dep</span><span class="op" id="8004810">]</span>&nbsp;<span class="op" id="8004812">=</span>&nbsp;<span class="builtintype" id="8004814">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004820">indent</span>&nbsp;<span class="op" id="8004827">:=</span>&nbsp;<span class="ident" id="8004830">strings</span><span class="op" id="8004837">.</span><span class="ident" id="8004838">Repeat</span><span class="op" id="8004844">(</span><span class="string" id="8004845">&#34;&nbsp;&nbsp;&#34;</span><span class="op" id="8004849">,</span>&nbsp;<span class="ident" id="8004851">depth</span><span class="op" id="8004856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004859">ds</span>&nbsp;<span class="op" id="8004862">:=</span>&nbsp;<span class="ident" id="8004865">db</span><span class="op" id="8004867">.</span><span class="ident" id="8004868">dep</span><span class="op" id="8004871">[</span><span class="ident" id="8004872">dep</span><span class="op" id="8004875">]</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004878">for</span>&nbsp;<span class="ident" id="8004882">k</span>&nbsp;<span class="op" id="8004884">:=</span>&nbsp;<span class="keyword" id="8004887">range</span>&nbsp;<span class="ident" id="8004893">ds</span>&nbsp;<span class="op" id="8004896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8004900">t</span><span class="op" id="8004901">.</span><span class="ident" id="8004902">Logf</span><span class="op" id="8004906">(</span><span class="string" id="8004907">&#34;%s%T&nbsp;(%p)&nbsp;waiting&nbsp;for&nbsp;-&gt;&nbsp;%T&nbsp;(%p)&#34;</span><span class="op" id="8004941">,</span>&nbsp;<span class="ident" id="8004943">indent</span><span class="op" id="8004949">,</span>&nbsp;<span class="ident" id="8004951">dep</span><span class="op" id="8004954">,</span>&nbsp;<span class="ident" id="8004956">dep</span><span class="op" id="8004959">,</span>&nbsp;<span class="ident" id="8004961">k</span><span class="op" id="8004962">,</span>&nbsp;<span class="ident" id="8004964">k</span><span class="op" id="8004965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8004969">if</span>&nbsp;<span class="ident" id="8004972">fc</span><span class="op" id="8004974">,</span>&nbsp;<span class="ident" id="8004976">ok</span>&nbsp;<span class="op" id="8004979">:=</span>&nbsp;<span class="ident" id="8004982">k</span><span class="op" id="8004983">.</span><span class="op" id="8004984">(</span><span class="ident" id="8004985">finalCloser</span><span class="op" id="8004996">)</span><span class="op" id="8004997">;</span>&nbsp;<span class="ident" id="8004999">ok</span>&nbsp;<span class="op" id="8005002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005007">if</span>&nbsp;<span class="op" id="8005010">!</span><span class="ident" id="8005011">seen</span><span class="op" id="8005015">[</span><span class="ident" id="8005016">fc</span><span class="op" id="8005018">]</span>&nbsp;<span class="op" id="8005020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005026">db</span><span class="op" id="8005028">.</span><span class="ident" id="8005029">dumpDep</span><span class="op" id="8005036">(</span><span class="ident" id="8005037">t</span><span class="op" id="8005038">,</span>&nbsp;<span class="ident" id="8005040">depth</span><span class="op" id="8005045">+</span><span class="num" id="8005046">1</span><span class="op" id="8005047">,</span>&nbsp;<span class="ident" id="8005049">fc</span><span class="op" id="8005051">,</span>&nbsp;<span class="ident" id="8005053">seen</span><span class="op" id="8005057">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005069">}</span><br>
<span class="lineno"></span><span class="op" id="8005071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8005074">func</span>&nbsp;<span class="ident" id="8005079">TestQuery</span><span class="op" id="8005088">(</span><span class="ident" id="8005089">t</span>&nbsp;<span class="op" id="8005091">*</span><span class="ident" id="8005092">testing</span><span class="op" id="8005099">.</span><span class="ident" id="8005100">T</span><span class="op" id="8005101">)</span>&nbsp;<span class="op" id="8005103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005106">db</span>&nbsp;<span class="op" id="8005109">:=</span>&nbsp;<span class="ident" id="8005112">newTestDB</span><span class="op" id="8005121">(</span><span class="ident" id="8005122">t</span><span class="op" id="8005123">,</span>&nbsp;<span class="string" id="8005125">&#34;people&#34;</span><span class="op" id="8005133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005136">defer</span>&nbsp;<span class="ident" id="8005142">closeDB</span><span class="op" id="8005149">(</span><span class="ident" id="8005150">t</span><span class="op" id="8005151">,</span>&nbsp;<span class="ident" id="8005153">db</span><span class="op" id="8005155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005158">prepares0</span>&nbsp;<span class="op" id="8005168">:=</span>&nbsp;<span class="ident" id="8005171">numPrepares</span><span class="op" id="8005182">(</span><span class="ident" id="8005183">t</span><span class="op" id="8005184">,</span>&nbsp;<span class="ident" id="8005186">db</span><span class="op" id="8005188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005191">rows</span><span class="op" id="8005195">,</span>&nbsp;<span class="ident" id="8005197">err</span>&nbsp;<span class="op" id="8005201">:=</span>&nbsp;<span class="ident" id="8005204">db</span><span class="op" id="8005206">.</span><span class="ident" id="8005207">Query</span><span class="op" id="8005212">(</span><span class="string" id="8005213">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8005238">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005241">if</span>&nbsp;<span class="ident" id="8005244">err</span>&nbsp;<span class="op" id="8005248">!=</span>&nbsp;<span class="ident" id="8005251">nil</span>&nbsp;<span class="op" id="8005255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005259">t</span><span class="op" id="8005260">.</span><span class="ident" id="8005261">Fatalf</span><span class="op" id="8005267">(</span><span class="string" id="8005268">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8005279">,</span>&nbsp;<span class="ident" id="8005281">err</span><span class="op" id="8005284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005290">type</span>&nbsp;<span class="ident" id="8005295">row</span>&nbsp;<span class="keyword" id="8005299">struct</span>&nbsp;<span class="op" id="8005306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005310">age</span>&nbsp;&nbsp;<span class="builtintype" id="8005315">int</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005321">name</span>&nbsp;<span class="builtintype" id="8005326">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005337">got</span>&nbsp;<span class="op" id="8005341">:=</span>&nbsp;<span class="op" id="8005344">[</span><span class="op" id="8005345">]</span><span class="ident" id="8005346">row</span><span class="op" id="8005349">{</span><span class="op" id="8005350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005353">for</span>&nbsp;<span class="ident" id="8005357">rows</span><span class="op" id="8005361">.</span><span class="ident" id="8005362">Next</span><span class="op" id="8005366">(</span><span class="op" id="8005367">)</span>&nbsp;<span class="op" id="8005369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005373">var</span>&nbsp;<span class="ident" id="8005377">r</span>&nbsp;<span class="ident" id="8005379">row</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005385">err</span>&nbsp;<span class="op" id="8005389">=</span>&nbsp;<span class="ident" id="8005391">rows</span><span class="op" id="8005395">.</span><span class="ident" id="8005396">Scan</span><span class="op" id="8005400">(</span><span class="op" id="8005401">&amp;</span><span class="ident" id="8005402">r</span><span class="op" id="8005403">.</span><span class="ident" id="8005404">age</span><span class="op" id="8005407">,</span>&nbsp;<span class="op" id="8005409">&amp;</span><span class="ident" id="8005410">r</span><span class="op" id="8005411">.</span><span class="ident" id="8005412">name</span><span class="op" id="8005416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005420">if</span>&nbsp;<span class="ident" id="8005423">err</span>&nbsp;<span class="op" id="8005427">!=</span>&nbsp;<span class="ident" id="8005430">nil</span>&nbsp;<span class="op" id="8005434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005439">t</span><span class="op" id="8005440">.</span><span class="ident" id="8005441">Fatalf</span><span class="op" id="8005447">(</span><span class="string" id="8005448">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8005458">,</span>&nbsp;<span class="ident" id="8005460">err</span><span class="op" id="8005463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005471">got</span>&nbsp;<span class="op" id="8005475">=</span>&nbsp;<span class="builtinfunc" id="8005477">append</span><span class="op" id="8005483">(</span><span class="ident" id="8005484">got</span><span class="op" id="8005487">,</span>&nbsp;<span class="ident" id="8005489">r</span><span class="op" id="8005490">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005496">err</span>&nbsp;<span class="op" id="8005500">=</span>&nbsp;<span class="ident" id="8005502">rows</span><span class="op" id="8005506">.</span><span class="ident" id="8005507">Err</span><span class="op" id="8005510">(</span><span class="op" id="8005511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005514">if</span>&nbsp;<span class="ident" id="8005517">err</span>&nbsp;<span class="op" id="8005521">!=</span>&nbsp;<span class="ident" id="8005524">nil</span>&nbsp;<span class="op" id="8005528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005532">t</span><span class="op" id="8005533">.</span><span class="ident" id="8005534">Fatalf</span><span class="op" id="8005540">(</span><span class="string" id="8005541">&#34;Err:&nbsp;%v&#34;</span><span class="op" id="8005550">,</span>&nbsp;<span class="ident" id="8005552">err</span><span class="op" id="8005555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005558">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005561">want</span>&nbsp;<span class="op" id="8005566">:=</span>&nbsp;<span class="op" id="8005569">[</span><span class="op" id="8005570">]</span><span class="ident" id="8005571">row</span><span class="op" id="8005574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005578">{</span><span class="ident" id="8005579">age</span><span class="op" id="8005582">:</span>&nbsp;<span class="num" id="8005584">1</span><span class="op" id="8005585">,</span>&nbsp;<span class="ident" id="8005587">name</span><span class="op" id="8005591">:</span>&nbsp;<span class="string" id="8005593">&#34;Alice&#34;</span><span class="op" id="8005600">}</span><span class="op" id="8005601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005605">{</span><span class="ident" id="8005606">age</span><span class="op" id="8005609">:</span>&nbsp;<span class="num" id="8005611">2</span><span class="op" id="8005612">,</span>&nbsp;<span class="ident" id="8005614">name</span><span class="op" id="8005618">:</span>&nbsp;<span class="string" id="8005620">&#34;Bob&#34;</span><span class="op" id="8005625">}</span><span class="op" id="8005626">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005630">{</span><span class="ident" id="8005631">age</span><span class="op" id="8005634">:</span>&nbsp;<span class="num" id="8005636">3</span><span class="op" id="8005637">,</span>&nbsp;<span class="ident" id="8005639">name</span><span class="op" id="8005643">:</span>&nbsp;<span class="string" id="8005645">&#34;Chris&#34;</span><span class="op" id="8005652">}</span><span class="op" id="8005653">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005656">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005659">if</span>&nbsp;<span class="op" id="8005662">!</span><span class="ident" id="8005663">reflect</span><span class="op" id="8005670">.</span><span class="ident" id="8005671">DeepEqual</span><span class="op" id="8005680">(</span><span class="ident" id="8005681">got</span><span class="op" id="8005684">,</span>&nbsp;<span class="ident" id="8005686">want</span><span class="op" id="8005690">)</span>&nbsp;<span class="op" id="8005692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005696">t</span><span class="op" id="8005697">.</span><span class="ident" id="8005698">Errorf</span><span class="op" id="8005704">(</span><span class="string" id="8005705">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8005738">,</span>&nbsp;<span class="ident" id="8005740">got</span><span class="op" id="8005743">,</span>&nbsp;<span class="ident" id="8005745">want</span><span class="op" id="8005749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8005756">//&nbsp;And&nbsp;verify&nbsp;that&nbsp;the&nbsp;final&nbsp;rows.Next()&nbsp;call,&nbsp;which&nbsp;hit&nbsp;EOF,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8005819">//&nbsp;also&nbsp;closed&nbsp;the&nbsp;rows&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005856">if</span>&nbsp;<span class="ident" id="8005859">n</span>&nbsp;<span class="op" id="8005861">:=</span>&nbsp;<span class="ident" id="8005864">db</span><span class="op" id="8005866">.</span><span class="ident" id="8005867">numFreeConns</span><span class="op" id="8005879">(</span><span class="op" id="8005880">)</span><span class="op" id="8005881">;</span>&nbsp;<span class="ident" id="8005883">n</span>&nbsp;<span class="op" id="8005885">!=</span>&nbsp;<span class="num" id="8005888">1</span>&nbsp;<span class="op" id="8005890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8005894">t</span><span class="op" id="8005895">.</span><span class="ident" id="8005896">Fatalf</span><span class="op" id="8005902">(</span><span class="string" id="8005903">&#34;free&nbsp;conns&nbsp;after&nbsp;query&nbsp;hitting&nbsp;EOF&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8005952">,</span>&nbsp;<span class="ident" id="8005954">n</span><span class="op" id="8005955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8005958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8005961">if</span>&nbsp;<span class="ident" id="8005964">prepares</span>&nbsp;<span class="op" id="8005973">:=</span>&nbsp;<span class="ident" id="8005976">numPrepares</span><span class="op" id="8005987">(</span><span class="ident" id="8005988">t</span><span class="op" id="8005989">,</span>&nbsp;<span class="ident" id="8005991">db</span><span class="op" id="8005993">)</span>&nbsp;<span class="op" id="8005995">-</span>&nbsp;<span class="ident" id="8005997">prepares0</span><span class="op" id="8006006">;</span>&nbsp;<span class="ident" id="8006008">prepares</span>&nbsp;<span class="op" id="8006017">!=</span>&nbsp;<span class="num" id="8006020">1</span>&nbsp;<span class="op" id="8006022">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006026">t</span><span class="op" id="8006027">.</span><span class="ident" id="8006028">Errorf</span><span class="op" id="8006034">(</span><span class="string" id="8006035">&#34;executed&nbsp;%d&nbsp;Prepare&nbsp;statements;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8006075">,</span>&nbsp;<span class="ident" id="8006077">prepares</span><span class="op" id="8006085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006088">}</span><br>
<span class="lineno"></span><span class="op" id="8006090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8006093">func</span>&nbsp;<span class="ident" id="8006098">TestByteOwnership</span><span class="op" id="8006115">(</span><span class="ident" id="8006116">t</span>&nbsp;<span class="op" id="8006118">*</span><span class="ident" id="8006119">testing</span><span class="op" id="8006126">.</span><span class="ident" id="8006127">T</span><span class="op" id="8006128">)</span>&nbsp;<span class="op" id="8006130">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006133">db</span>&nbsp;<span class="op" id="8006136">:=</span>&nbsp;<span class="ident" id="8006139">newTestDB</span><span class="op" id="8006148">(</span><span class="ident" id="8006149">t</span><span class="op" id="8006150">,</span>&nbsp;<span class="string" id="8006152">&#34;people&#34;</span><span class="op" id="8006160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006163">defer</span>&nbsp;<span class="ident" id="8006169">closeDB</span><span class="op" id="8006176">(</span><span class="ident" id="8006177">t</span><span class="op" id="8006178">,</span>&nbsp;<span class="ident" id="8006180">db</span><span class="op" id="8006182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006185">rows</span><span class="op" id="8006189">,</span>&nbsp;<span class="ident" id="8006191">err</span>&nbsp;<span class="op" id="8006195">:=</span>&nbsp;<span class="ident" id="8006198">db</span><span class="op" id="8006200">.</span><span class="ident" id="8006201">Query</span><span class="op" id="8006206">(</span><span class="string" id="8006207">&#34;SELECT|people|name,photo|&#34;</span><span class="op" id="8006234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006237">if</span>&nbsp;<span class="ident" id="8006240">err</span>&nbsp;<span class="op" id="8006244">!=</span>&nbsp;<span class="ident" id="8006247">nil</span>&nbsp;<span class="op" id="8006251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006255">t</span><span class="op" id="8006256">.</span><span class="ident" id="8006257">Fatalf</span><span class="op" id="8006263">(</span><span class="string" id="8006264">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8006275">,</span>&nbsp;<span class="ident" id="8006277">err</span><span class="op" id="8006280">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006286">type</span>&nbsp;<span class="ident" id="8006291">row</span>&nbsp;<span class="keyword" id="8006295">struct</span>&nbsp;<span class="op" id="8006302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006306">name</span>&nbsp;&nbsp;<span class="op" id="8006312">[</span><span class="op" id="8006313">]</span><span class="builtintype" id="8006314">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006321">photo</span>&nbsp;<span class="ident" id="8006327">RawBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006337">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006340">got</span>&nbsp;<span class="op" id="8006344">:=</span>&nbsp;<span class="op" id="8006347">[</span><span class="op" id="8006348">]</span><span class="ident" id="8006349">row</span><span class="op" id="8006352">{</span><span class="op" id="8006353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006356">for</span>&nbsp;<span class="ident" id="8006360">rows</span><span class="op" id="8006364">.</span><span class="ident" id="8006365">Next</span><span class="op" id="8006369">(</span><span class="op" id="8006370">)</span>&nbsp;<span class="op" id="8006372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006376">var</span>&nbsp;<span class="ident" id="8006380">r</span>&nbsp;<span class="ident" id="8006382">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006388">err</span>&nbsp;<span class="op" id="8006392">=</span>&nbsp;<span class="ident" id="8006394">rows</span><span class="op" id="8006398">.</span><span class="ident" id="8006399">Scan</span><span class="op" id="8006403">(</span><span class="op" id="8006404">&amp;</span><span class="ident" id="8006405">r</span><span class="op" id="8006406">.</span><span class="ident" id="8006407">name</span><span class="op" id="8006411">,</span>&nbsp;<span class="op" id="8006413">&amp;</span><span class="ident" id="8006414">r</span><span class="op" id="8006415">.</span><span class="ident" id="8006416">photo</span><span class="op" id="8006421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006425">if</span>&nbsp;<span class="ident" id="8006428">err</span>&nbsp;<span class="op" id="8006432">!=</span>&nbsp;<span class="ident" id="8006435">nil</span>&nbsp;<span class="op" id="8006439">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006444">t</span><span class="op" id="8006445">.</span><span class="ident" id="8006446">Fatalf</span><span class="op" id="8006452">(</span><span class="string" id="8006453">&#34;Scan:&nbsp;%v&#34;</span><span class="op" id="8006463">,</span>&nbsp;<span class="ident" id="8006465">err</span><span class="op" id="8006468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006476">got</span>&nbsp;<span class="op" id="8006480">=</span>&nbsp;<span class="builtinfunc" id="8006482">append</span><span class="op" id="8006488">(</span><span class="ident" id="8006489">got</span><span class="op" id="8006492">,</span>&nbsp;<span class="ident" id="8006494">r</span><span class="op" id="8006495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006501">corruptMemory</span>&nbsp;<span class="op" id="8006515">:=</span>&nbsp;<span class="op" id="8006518">[</span><span class="op" id="8006519">]</span><span class="builtintype" id="8006520">byte</span><span class="op" id="8006524">(</span><span class="string" id="8006525">&#34;\xffPHOTO&#34;</span><span class="op" id="8006536">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006539">want</span>&nbsp;<span class="op" id="8006544">:=</span>&nbsp;<span class="op" id="8006547">[</span><span class="op" id="8006548">]</span><span class="ident" id="8006549">row</span><span class="op" id="8006552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006556">{</span><span class="ident" id="8006557">name</span><span class="op" id="8006561">:</span>&nbsp;<span class="op" id="8006563">[</span><span class="op" id="8006564">]</span><span class="builtintype" id="8006565">byte</span><span class="op" id="8006569">(</span><span class="string" id="8006570">&#34;Alice&#34;</span><span class="op" id="8006577">)</span><span class="op" id="8006578">,</span>&nbsp;<span class="ident" id="8006580">photo</span><span class="op" id="8006585">:</span>&nbsp;<span class="ident" id="8006587">corruptMemory</span><span class="op" id="8006600">}</span><span class="op" id="8006601">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006605">{</span><span class="ident" id="8006606">name</span><span class="op" id="8006610">:</span>&nbsp;<span class="op" id="8006612">[</span><span class="op" id="8006613">]</span><span class="builtintype" id="8006614">byte</span><span class="op" id="8006618">(</span><span class="string" id="8006619">&#34;Bob&#34;</span><span class="op" id="8006624">)</span><span class="op" id="8006625">,</span>&nbsp;<span class="ident" id="8006627">photo</span><span class="op" id="8006632">:</span>&nbsp;<span class="ident" id="8006634">corruptMemory</span><span class="op" id="8006647">}</span><span class="op" id="8006648">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006652">{</span><span class="ident" id="8006653">name</span><span class="op" id="8006657">:</span>&nbsp;<span class="op" id="8006659">[</span><span class="op" id="8006660">]</span><span class="builtintype" id="8006661">byte</span><span class="op" id="8006665">(</span><span class="string" id="8006666">&#34;Chris&#34;</span><span class="op" id="8006673">)</span><span class="op" id="8006674">,</span>&nbsp;<span class="ident" id="8006676">photo</span><span class="op" id="8006681">:</span>&nbsp;<span class="ident" id="8006683">corruptMemory</span><span class="op" id="8006696">}</span><span class="op" id="8006697">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006700">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006703">if</span>&nbsp;<span class="op" id="8006706">!</span><span class="ident" id="8006707">reflect</span><span class="op" id="8006714">.</span><span class="ident" id="8006715">DeepEqual</span><span class="op" id="8006724">(</span><span class="ident" id="8006725">got</span><span class="op" id="8006728">,</span>&nbsp;<span class="ident" id="8006730">want</span><span class="op" id="8006734">)</span>&nbsp;<span class="op" id="8006736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006740">t</span><span class="op" id="8006741">.</span><span class="ident" id="8006742">Errorf</span><span class="op" id="8006748">(</span><span class="string" id="8006749">&#34;mismatch.\n&nbsp;got:&nbsp;%#v\nwant:&nbsp;%#v&#34;</span><span class="op" id="8006782">,</span>&nbsp;<span class="ident" id="8006784">got</span><span class="op" id="8006787">,</span>&nbsp;<span class="ident" id="8006789">want</span><span class="op" id="8006793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006800">var</span>&nbsp;<span class="ident" id="8006804">photo</span>&nbsp;<span class="ident" id="8006810">RawBytes</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006820">err</span>&nbsp;<span class="op" id="8006824">=</span>&nbsp;<span class="ident" id="8006826">db</span><span class="op" id="8006828">.</span><span class="ident" id="8006829">QueryRow</span><span class="op" id="8006837">(</span><span class="string" id="8006838">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8006866">,</span>&nbsp;<span class="string" id="8006868">&#34;Alice&#34;</span><span class="op" id="8006875">)</span><span class="op" id="8006876">.</span><span class="ident" id="8006877">Scan</span><span class="op" id="8006881">(</span><span class="op" id="8006882">&amp;</span><span class="ident" id="8006883">photo</span><span class="op" id="8006888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8006891">if</span>&nbsp;<span class="ident" id="8006894">err</span>&nbsp;<span class="op" id="8006898">==</span>&nbsp;<span class="ident" id="8006901">nil</span>&nbsp;<span class="op" id="8006905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8006909">t</span><span class="op" id="8006910">.</span><span class="ident" id="8006911">Error</span><span class="op" id="8006916">(</span><span class="string" id="8006917">&#34;want&nbsp;error&nbsp;scanning&nbsp;into&nbsp;RawBytes&nbsp;from&nbsp;QueryRow&#34;</span><span class="op" id="8006966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8006969">}</span><br>
<span class="lineno"></span><span class="op" id="8006971">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="8006974">func</span>&nbsp;<span class="ident" id="8006979">TestRowsColumns</span><span class="op" id="8006994">(</span><span class="ident" id="8006995">t</span>&nbsp;<span class="op" id="8006997">*</span><span class="ident" id="8006998">testing</span><span class="op" id="8007005">.</span><span class="ident" id="8007006">T</span><span class="op" id="8007007">)</span>&nbsp;<span class="op" id="8007009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007012">db</span>&nbsp;<span class="op" id="8007015">:=</span>&nbsp;<span class="ident" id="8007018">newTestDB</span><span class="op" id="8007027">(</span><span class="ident" id="8007028">t</span><span class="op" id="8007029">,</span>&nbsp;<span class="string" id="8007031">&#34;people&#34;</span><span class="op" id="8007039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007042">defer</span>&nbsp;<span class="ident" id="8007048">closeDB</span><span class="op" id="8007055">(</span><span class="ident" id="8007056">t</span><span class="op" id="8007057">,</span>&nbsp;<span class="ident" id="8007059">db</span><span class="op" id="8007061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007064">rows</span><span class="op" id="8007068">,</span>&nbsp;<span class="ident" id="8007070">err</span>&nbsp;<span class="op" id="8007074">:=</span>&nbsp;<span class="ident" id="8007077">db</span><span class="op" id="8007079">.</span><span class="ident" id="8007080">Query</span><span class="op" id="8007085">(</span><span class="string" id="8007086">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8007111">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007114">if</span>&nbsp;<span class="ident" id="8007117">err</span>&nbsp;<span class="op" id="8007121">!=</span>&nbsp;<span class="ident" id="8007124">nil</span>&nbsp;<span class="op" id="8007128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007132">t</span><span class="op" id="8007133">.</span><span class="ident" id="8007134">Fatalf</span><span class="op" id="8007140">(</span><span class="string" id="8007141">&#34;Query:&nbsp;%v&#34;</span><span class="op" id="8007152">,</span>&nbsp;<span class="ident" id="8007154">err</span><span class="op" id="8007157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8007160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007163">cols</span><span class="op" id="8007167">,</span>&nbsp;<span class="ident" id="8007169">err</span>&nbsp;<span class="op" id="8007173">:=</span>&nbsp;<span class="ident" id="8007176">rows</span><span class="op" id="8007180">.</span><span class="ident" id="8007181">Columns</span><span class="op" id="8007188">(</span><span class="op" id="8007189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007192">if</span>&nbsp;<span class="ident" id="8007195">err</span>&nbsp;<span class="op" id="8007199">!=</span>&nbsp;<span class="ident" id="8007202">nil</span>&nbsp;<span class="op" id="8007206">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007210">t</span><span class="op" id="8007211">.</span><span class="ident" id="8007212">Fatalf</span><span class="op" id="8007218">(</span><span class="string" id="8007219">&#34;Columns:&nbsp;%v&#34;</span><span class="op" id="8007232">,</span>&nbsp;<span class="ident" id="8007234">err</span><span class="op" id="8007237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8007240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007243">want</span>&nbsp;<span class="op" id="8007248">:=</span>&nbsp;<span class="op" id="8007251">[</span><span class="op" id="8007252">]</span><span class="builtintype" id="8007253">string</span><span class="op" id="8007259">{</span><span class="string" id="8007260">&#34;age&#34;</span><span class="op" id="8007265">,</span>&nbsp;<span class="string" id="8007267">&#34;name&#34;</span><span class="op" id="8007273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007276">if</span>&nbsp;<span class="op" id="8007279">!</span><span class="ident" id="8007280">reflect</span><span class="op" id="8007287">.</span><span class="ident" id="8007288">DeepEqual</span><span class="op" id="8007297">(</span><span class="ident" id="8007298">cols</span><span class="op" id="8007302">,</span>&nbsp;<span class="ident" id="8007304">want</span><span class="op" id="8007308">)</span>&nbsp;<span class="op" id="8007310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007314">t</span><span class="op" id="8007315">.</span><span class="ident" id="8007316">Errorf</span><span class="op" id="8007322">(</span><span class="string" id="8007323">&#34;got&nbsp;%#v;&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8007342">,</span>&nbsp;<span class="ident" id="8007344">cols</span><span class="op" id="8007348">,</span>&nbsp;<span class="ident" id="8007350">want</span><span class="op" id="8007354">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8007357">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007360">if</span>&nbsp;<span class="ident" id="8007363">err</span>&nbsp;<span class="op" id="8007367">:=</span>&nbsp;<span class="ident" id="8007370">rows</span><span class="op" id="8007374">.</span><span class="ident" id="8007375">Close</span><span class="op" id="8007380">(</span><span class="op" id="8007381">)</span><span class="op" id="8007382">;</span>&nbsp;<span class="ident" id="8007384">err</span>&nbsp;<span class="op" id="8007388">!=</span>&nbsp;<span class="ident" id="8007391">nil</span>&nbsp;<span class="op" id="8007395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007399">t</span><span class="op" id="8007400">.</span><span class="ident" id="8007401">Errorf</span><span class="op" id="8007407">(</span><span class="string" id="8007408">&#34;error&nbsp;closing&nbsp;rows:&nbsp;%s&#34;</span><span class="op" id="8007432">,</span>&nbsp;<span class="ident" id="8007434">err</span><span class="op" id="8007437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8007440">}</span><br>
<span class="lineno"></span><span class="op" id="8007442">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="8007445">func</span>&nbsp;<span class="ident" id="8007450">TestQueryRow</span><span class="op" id="8007462">(</span><span class="ident" id="8007463">t</span>&nbsp;<span class="op" id="8007465">*</span><span class="ident" id="8007466">testing</span><span class="op" id="8007473">.</span><span class="ident" id="8007474">T</span><span class="op" id="8007475">)</span>&nbsp;<span class="op" id="8007477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007480">db</span>&nbsp;<span class="op" id="8007483">:=</span>&nbsp;<span class="ident" id="8007486">newTestDB</span><span class="op" id="8007495">(</span><span class="ident" id="8007496">t</span><span class="op" id="8007497">,</span>&nbsp;<span class="string" id="8007499">&#34;people&#34;</span><span class="op" id="8007507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007510">defer</span>&nbsp;<span class="ident" id="8007516">closeDB</span><span class="op" id="8007523">(</span><span class="ident" id="8007524">t</span><span class="op" id="8007525">,</span>&nbsp;<span class="ident" id="8007527">db</span><span class="op" id="8007529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007532">var</span>&nbsp;<span class="ident" id="8007536">name</span>&nbsp;<span class="builtintype" id="8007541">string</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007549">var</span>&nbsp;<span class="ident" id="8007553">age</span>&nbsp;<span class="builtintype" id="8007557">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007562">var</span>&nbsp;<span class="ident" id="8007566">birthday</span>&nbsp;<span class="ident" id="8007575">time</span><span class="op" id="8007579">.</span><span class="ident" id="8007580">Time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007587">err</span>&nbsp;<span class="op" id="8007591">:=</span>&nbsp;<span class="ident" id="8007594">db</span><span class="op" id="8007596">.</span><span class="ident" id="8007597">QueryRow</span><span class="op" id="8007605">(</span><span class="string" id="8007606">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8007636">,</span>&nbsp;<span class="num" id="8007638">3</span><span class="op" id="8007639">)</span><span class="op" id="8007640">.</span><span class="ident" id="8007641">Scan</span><span class="op" id="8007645">(</span><span class="op" id="8007646">&amp;</span><span class="ident" id="8007647">age</span><span class="op" id="8007650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007653">if</span>&nbsp;<span class="ident" id="8007656">err</span>&nbsp;<span class="op" id="8007660">==</span>&nbsp;<span class="ident" id="8007663">nil</span>&nbsp;<span class="op" id="8007667">||</span>&nbsp;<span class="op" id="8007670">!</span><span class="ident" id="8007671">strings</span><span class="op" id="8007678">.</span><span class="ident" id="8007679">Contains</span><span class="op" id="8007687">(</span><span class="ident" id="8007688">err</span><span class="op" id="8007691">.</span><span class="ident" id="8007692">Error</span><span class="op" id="8007697">(</span><span class="op" id="8007698">)</span><span class="op" id="8007699">,</span>&nbsp;<span class="string" id="8007701">&#34;expected&nbsp;2&nbsp;destination&nbsp;arguments&#34;</span><span class="op" id="8007735">)</span>&nbsp;<span class="op" id="8007737">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007741">t</span><span class="op" id="8007742">.</span><span class="ident" id="8007743">Errorf</span><span class="op" id="8007749">(</span><span class="string" id="8007750">&#34;expected&nbsp;error&nbsp;from&nbsp;wrong&nbsp;number&nbsp;of&nbsp;arguments;&nbsp;actually&nbsp;got:&nbsp;%v&#34;</span><span class="op" id="8007815">,</span>&nbsp;<span class="ident" id="8007817">err</span><span class="op" id="8007820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8007823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007827">err</span>&nbsp;<span class="op" id="8007831">=</span>&nbsp;<span class="ident" id="8007833">db</span><span class="op" id="8007835">.</span><span class="ident" id="8007836">QueryRow</span><span class="op" id="8007844">(</span><span class="string" id="8007845">&#34;SELECT|people|bdate|age=?&#34;</span><span class="op" id="8007872">,</span>&nbsp;<span class="num" id="8007874">3</span><span class="op" id="8007875">)</span><span class="op" id="8007876">.</span><span class="ident" id="8007877">Scan</span><span class="op" id="8007881">(</span><span class="op" id="8007882">&amp;</span><span class="ident" id="8007883">birthday</span><span class="op" id="8007891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8007894">if</span>&nbsp;<span class="ident" id="8007897">err</span>&nbsp;<span class="op" id="8007901">!=</span>&nbsp;<span class="ident" id="8007904">nil</span>&nbsp;<span class="op" id="8007908">||</span>&nbsp;<span class="op" id="8007911">!</span><span class="ident" id="8007912">birthday</span><span class="op" id="8007920">.</span><span class="ident" id="8007921">Equal</span><span class="op" id="8007926">(</span><span class="ident" id="8007927">chrisBirthday</span><span class="op" id="8007940">)</span>&nbsp;<span class="op" id="8007942">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8007946">t</span><span class="op" id="8007947">.</span><span class="ident" id="8007948">Errorf</span><span class="op" id="8007954">(</span><span class="string" id="8007955">&#34;chris&nbsp;birthday&nbsp;=&nbsp;%v,&nbsp;err&nbsp;=&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8007995">,</span>&nbsp;<span class="ident" id="8007997">birthday</span><span class="op" id="8008005">,</span>&nbsp;<span class="ident" id="8008007">err</span><span class="op" id="8008010">,</span>&nbsp;<span class="ident" id="8008012">chrisBirthday</span><span class="op" id="8008025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008032">err</span>&nbsp;<span class="op" id="8008036">=</span>&nbsp;<span class="ident" id="8008038">db</span><span class="op" id="8008040">.</span><span class="ident" id="8008041">QueryRow</span><span class="op" id="8008049">(</span><span class="string" id="8008050">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8008080">,</span>&nbsp;<span class="num" id="8008082">2</span><span class="op" id="8008083">)</span><span class="op" id="8008084">.</span><span class="ident" id="8008085">Scan</span><span class="op" id="8008089">(</span><span class="op" id="8008090">&amp;</span><span class="ident" id="8008091">age</span><span class="op" id="8008094">,</span>&nbsp;<span class="op" id="8008096">&amp;</span><span class="ident" id="8008097">name</span><span class="op" id="8008101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008104">if</span>&nbsp;<span class="ident" id="8008107">err</span>&nbsp;<span class="op" id="8008111">!=</span>&nbsp;<span class="ident" id="8008114">nil</span>&nbsp;<span class="op" id="8008118">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008122">t</span><span class="op" id="8008123">.</span><span class="ident" id="8008124">Fatalf</span><span class="op" id="8008130">(</span><span class="string" id="8008131">&#34;age&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8008154">,</span>&nbsp;<span class="ident" id="8008156">err</span><span class="op" id="8008159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008165">if</span>&nbsp;<span class="ident" id="8008168">name</span>&nbsp;<span class="op" id="8008173">!=</span>&nbsp;<span class="string" id="8008176">&#34;Bob&#34;</span>&nbsp;<span class="op" id="8008182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008186">t</span><span class="op" id="8008187">.</span><span class="ident" id="8008188">Errorf</span><span class="op" id="8008194">(</span><span class="string" id="8008195">&#34;expected&nbsp;name&nbsp;Bob,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8008222">,</span>&nbsp;<span class="ident" id="8008224">name</span><span class="op" id="8008228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008231">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008234">if</span>&nbsp;<span class="ident" id="8008237">age</span>&nbsp;<span class="op" id="8008241">!=</span>&nbsp;<span class="num" id="8008244">2</span>&nbsp;<span class="op" id="8008246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008250">t</span><span class="op" id="8008251">.</span><span class="ident" id="8008252">Errorf</span><span class="op" id="8008258">(</span><span class="string" id="8008259">&#34;expected&nbsp;age&nbsp;2,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8008283">,</span>&nbsp;<span class="ident" id="8008285">age</span><span class="op" id="8008288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008295">err</span>&nbsp;<span class="op" id="8008299">=</span>&nbsp;<span class="ident" id="8008301">db</span><span class="op" id="8008303">.</span><span class="ident" id="8008304">QueryRow</span><span class="op" id="8008312">(</span><span class="string" id="8008313">&#34;SELECT|people|age,name|name=?&#34;</span><span class="op" id="8008344">,</span>&nbsp;<span class="string" id="8008346">&#34;Alice&#34;</span><span class="op" id="8008353">)</span><span class="op" id="8008354">.</span><span class="ident" id="8008355">Scan</span><span class="op" id="8008359">(</span><span class="op" id="8008360">&amp;</span><span class="ident" id="8008361">age</span><span class="op" id="8008364">,</span>&nbsp;<span class="op" id="8008366">&amp;</span><span class="ident" id="8008367">name</span><span class="op" id="8008371">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008374">if</span>&nbsp;<span class="ident" id="8008377">err</span>&nbsp;<span class="op" id="8008381">!=</span>&nbsp;<span class="ident" id="8008384">nil</span>&nbsp;<span class="op" id="8008388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008392">t</span><span class="op" id="8008393">.</span><span class="ident" id="8008394">Fatalf</span><span class="op" id="8008400">(</span><span class="string" id="8008401">&#34;name&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8008425">,</span>&nbsp;<span class="ident" id="8008427">err</span><span class="op" id="8008430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008436">if</span>&nbsp;<span class="ident" id="8008439">name</span>&nbsp;<span class="op" id="8008444">!=</span>&nbsp;<span class="string" id="8008447">&#34;Alice&#34;</span>&nbsp;<span class="op" id="8008455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008459">t</span><span class="op" id="8008460">.</span><span class="ident" id="8008461">Errorf</span><span class="op" id="8008467">(</span><span class="string" id="8008468">&#34;expected&nbsp;name&nbsp;Alice,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="8008497">,</span>&nbsp;<span class="ident" id="8008499">name</span><span class="op" id="8008503">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008509">if</span>&nbsp;<span class="ident" id="8008512">age</span>&nbsp;<span class="op" id="8008516">!=</span>&nbsp;<span class="num" id="8008519">1</span>&nbsp;<span class="op" id="8008521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008525">t</span><span class="op" id="8008526">.</span><span class="ident" id="8008527">Errorf</span><span class="op" id="8008533">(</span><span class="string" id="8008534">&#34;expected&nbsp;age&nbsp;1,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8008558">,</span>&nbsp;<span class="ident" id="8008560">age</span><span class="op" id="8008563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008570">var</span>&nbsp;<span class="ident" id="8008574">photo</span>&nbsp;<span class="op" id="8008580">[</span><span class="op" id="8008581">]</span><span class="builtintype" id="8008582">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008588">err</span>&nbsp;<span class="op" id="8008592">=</span>&nbsp;<span class="ident" id="8008594">db</span><span class="op" id="8008596">.</span><span class="ident" id="8008597">QueryRow</span><span class="op" id="8008605">(</span><span class="string" id="8008606">&#34;SELECT|people|photo|name=?&#34;</span><span class="op" id="8008634">,</span>&nbsp;<span class="string" id="8008636">&#34;Alice&#34;</span><span class="op" id="8008643">)</span><span class="op" id="8008644">.</span><span class="ident" id="8008645">Scan</span><span class="op" id="8008649">(</span><span class="op" id="8008650">&amp;</span><span class="ident" id="8008651">photo</span><span class="op" id="8008656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008659">if</span>&nbsp;<span class="ident" id="8008662">err</span>&nbsp;<span class="op" id="8008666">!=</span>&nbsp;<span class="ident" id="8008669">nil</span>&nbsp;<span class="op" id="8008673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008677">t</span><span class="op" id="8008678">.</span><span class="ident" id="8008679">Fatalf</span><span class="op" id="8008685">(</span><span class="string" id="8008686">&#34;photo&nbsp;QueryRow+Scan:&nbsp;%v&#34;</span><span class="op" id="8008711">,</span>&nbsp;<span class="ident" id="8008713">err</span><span class="op" id="8008716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008719">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008722">want</span>&nbsp;<span class="op" id="8008727">:=</span>&nbsp;<span class="op" id="8008730">[</span><span class="op" id="8008731">]</span><span class="builtintype" id="8008732">byte</span><span class="op" id="8008736">(</span><span class="string" id="8008737">&#34;APHOTO&#34;</span><span class="op" id="8008745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008748">if</span>&nbsp;<span class="op" id="8008751">!</span><span class="ident" id="8008752">reflect</span><span class="op" id="8008759">.</span><span class="ident" id="8008760">DeepEqual</span><span class="op" id="8008769">(</span><span class="ident" id="8008770">photo</span><span class="op" id="8008775">,</span>&nbsp;<span class="ident" id="8008777">want</span><span class="op" id="8008781">)</span>&nbsp;<span class="op" id="8008783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008787">t</span><span class="op" id="8008788">.</span><span class="ident" id="8008789">Errorf</span><span class="op" id="8008795">(</span><span class="string" id="8008796">&#34;photo&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8008817">,</span>&nbsp;<span class="ident" id="8008819">photo</span><span class="op" id="8008824">,</span>&nbsp;<span class="ident" id="8008826">want</span><span class="op" id="8008830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8008833">}</span><br>
<span class="lineno"></span><span class="op" id="8008835">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="8008838">func</span>&nbsp;<span class="ident" id="8008843">TestStatementErrorAfterClose</span><span class="op" id="8008871">(</span><span class="ident" id="8008872">t</span>&nbsp;<span class="op" id="8008874">*</span><span class="ident" id="8008875">testing</span><span class="op" id="8008882">.</span><span class="ident" id="8008883">T</span><span class="op" id="8008884">)</span>&nbsp;<span class="op" id="8008886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008889">db</span>&nbsp;<span class="op" id="8008892">:=</span>&nbsp;<span class="ident" id="8008895">newTestDB</span><span class="op" id="8008904">(</span><span class="ident" id="8008905">t</span><span class="op" id="8008906">,</span>&nbsp;<span class="string" id="8008908">&#34;people&#34;</span><span class="op" id="8008916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008919">defer</span>&nbsp;<span class="ident" id="8008925">closeDB</span><span class="op" id="8008932">(</span><span class="ident" id="8008933">t</span><span class="op" id="8008934">,</span>&nbsp;<span class="ident" id="8008936">db</span><span class="op" id="8008938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8008941">stmt</span><span class="op" id="8008945">,</span>&nbsp;<span class="ident" id="8008947">err</span>&nbsp;<span class="op" id="8008951">:=</span>&nbsp;<span class="ident" id="8008954">db</span><span class="op" id="8008956">.</span><span class="ident" id="8008957">Prepare</span><span class="op" id="8008964">(</span><span class="string" id="8008965">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8008991">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8008994">if</span>&nbsp;<span class="ident" id="8008997">err</span>&nbsp;<span class="op" id="8009001">!=</span>&nbsp;<span class="ident" id="8009004">nil</span>&nbsp;<span class="op" id="8009008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009012">t</span><span class="op" id="8009013">.</span><span class="ident" id="8009014">Fatalf</span><span class="op" id="8009020">(</span><span class="string" id="8009021">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8009034">,</span>&nbsp;<span class="ident" id="8009036">err</span><span class="op" id="8009039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009045">err</span>&nbsp;<span class="op" id="8009049">=</span>&nbsp;<span class="ident" id="8009051">stmt</span><span class="op" id="8009055">.</span><span class="ident" id="8009056">Close</span><span class="op" id="8009061">(</span><span class="op" id="8009062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009065">if</span>&nbsp;<span class="ident" id="8009068">err</span>&nbsp;<span class="op" id="8009072">!=</span>&nbsp;<span class="ident" id="8009075">nil</span>&nbsp;<span class="op" id="8009079">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009083">t</span><span class="op" id="8009084">.</span><span class="ident" id="8009085">Fatalf</span><span class="op" id="8009091">(</span><span class="string" id="8009092">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="8009103">,</span>&nbsp;<span class="ident" id="8009105">err</span><span class="op" id="8009108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009114">var</span>&nbsp;<span class="ident" id="8009118">name</span>&nbsp;<span class="builtintype" id="8009123">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009131">err</span>&nbsp;<span class="op" id="8009135">=</span>&nbsp;<span class="ident" id="8009137">stmt</span><span class="op" id="8009141">.</span><span class="ident" id="8009142">QueryRow</span><span class="op" id="8009150">(</span><span class="string" id="8009151">&#34;foo&#34;</span><span class="op" id="8009156">)</span><span class="op" id="8009157">.</span><span class="ident" id="8009158">Scan</span><span class="op" id="8009162">(</span><span class="op" id="8009163">&amp;</span><span class="ident" id="8009164">name</span><span class="op" id="8009168">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009171">if</span>&nbsp;<span class="ident" id="8009174">err</span>&nbsp;<span class="op" id="8009178">==</span>&nbsp;<span class="ident" id="8009181">nil</span>&nbsp;<span class="op" id="8009185">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009189">t</span><span class="op" id="8009190">.</span><span class="ident" id="8009191">Errorf</span><span class="op" id="8009197">(</span><span class="string" id="8009198">&#34;expected&nbsp;error&nbsp;from&nbsp;QueryRow.Scan&nbsp;after&nbsp;Stmt.Close&#34;</span><span class="op" id="8009250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009253">}</span><br>
<span class="lineno"></span><span class="op" id="8009255">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8009258">func</span>&nbsp;<span class="ident" id="8009263">TestStatementQueryRow</span><span class="op" id="8009284">(</span><span class="ident" id="8009285">t</span>&nbsp;<span class="op" id="8009287">*</span><span class="ident" id="8009288">testing</span><span class="op" id="8009295">.</span><span class="ident" id="8009296">T</span><span class="op" id="8009297">)</span>&nbsp;<span class="op" id="8009299">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009302">db</span>&nbsp;<span class="op" id="8009305">:=</span>&nbsp;<span class="ident" id="8009308">newTestDB</span><span class="op" id="8009317">(</span><span class="ident" id="8009318">t</span><span class="op" id="8009319">,</span>&nbsp;<span class="string" id="8009321">&#34;people&#34;</span><span class="op" id="8009329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009332">defer</span>&nbsp;<span class="ident" id="8009338">closeDB</span><span class="op" id="8009345">(</span><span class="ident" id="8009346">t</span><span class="op" id="8009347">,</span>&nbsp;<span class="ident" id="8009349">db</span><span class="op" id="8009351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009354">stmt</span><span class="op" id="8009358">,</span>&nbsp;<span class="ident" id="8009360">err</span>&nbsp;<span class="op" id="8009364">:=</span>&nbsp;<span class="ident" id="8009367">db</span><span class="op" id="8009369">.</span><span class="ident" id="8009370">Prepare</span><span class="op" id="8009377">(</span><span class="string" id="8009378">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8009404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009407">if</span>&nbsp;<span class="ident" id="8009410">err</span>&nbsp;<span class="op" id="8009414">!=</span>&nbsp;<span class="ident" id="8009417">nil</span>&nbsp;<span class="op" id="8009421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009425">t</span><span class="op" id="8009426">.</span><span class="ident" id="8009427">Fatalf</span><span class="op" id="8009433">(</span><span class="string" id="8009434">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8009447">,</span>&nbsp;<span class="ident" id="8009449">err</span><span class="op" id="8009452">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009458">defer</span>&nbsp;<span class="ident" id="8009464">stmt</span><span class="op" id="8009468">.</span><span class="ident" id="8009469">Close</span><span class="op" id="8009474">(</span><span class="op" id="8009475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009478">var</span>&nbsp;<span class="ident" id="8009482">age</span>&nbsp;<span class="builtintype" id="8009486">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009491">for</span>&nbsp;<span class="ident" id="8009495">n</span><span class="op" id="8009496">,</span>&nbsp;<span class="ident" id="8009498">tt</span>&nbsp;<span class="op" id="8009501">:=</span>&nbsp;<span class="keyword" id="8009504">range</span>&nbsp;<span class="op" id="8009510">[</span><span class="op" id="8009511">]</span><span class="keyword" id="8009512">struct</span>&nbsp;<span class="op" id="8009519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009523">name</span>&nbsp;<span class="builtintype" id="8009528">string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009537">want</span>&nbsp;<span class="builtintype" id="8009542">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009547">}</span><span class="op" id="8009548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009552">{</span><span class="string" id="8009553">&#34;Alice&#34;</span><span class="op" id="8009560">,</span>&nbsp;<span class="num" id="8009562">1</span><span class="op" id="8009563">}</span><span class="op" id="8009564">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009568">{</span><span class="string" id="8009569">&#34;Bob&#34;</span><span class="op" id="8009574">,</span>&nbsp;<span class="num" id="8009576">2</span><span class="op" id="8009577">}</span><span class="op" id="8009578">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009582">{</span><span class="string" id="8009583">&#34;Chris&#34;</span><span class="op" id="8009590">,</span>&nbsp;<span class="num" id="8009592">3</span><span class="op" id="8009593">}</span><span class="op" id="8009594">,</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009597">}</span>&nbsp;<span class="op" id="8009599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009603">if</span>&nbsp;<span class="ident" id="8009606">err</span>&nbsp;<span class="op" id="8009610">:=</span>&nbsp;<span class="ident" id="8009613">stmt</span><span class="op" id="8009617">.</span><span class="ident" id="8009618">QueryRow</span><span class="op" id="8009626">(</span><span class="ident" id="8009627">tt</span><span class="op" id="8009629">.</span><span class="ident" id="8009630">name</span><span class="op" id="8009634">)</span><span class="op" id="8009635">.</span><span class="ident" id="8009636">Scan</span><span class="op" id="8009640">(</span><span class="op" id="8009641">&amp;</span><span class="ident" id="8009642">age</span><span class="op" id="8009645">)</span><span class="op" id="8009646">;</span>&nbsp;<span class="ident" id="8009648">err</span>&nbsp;<span class="op" id="8009652">!=</span>&nbsp;<span class="ident" id="8009655">nil</span>&nbsp;<span class="op" id="8009659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009664">t</span><span class="op" id="8009665">.</span><span class="ident" id="8009666">Errorf</span><span class="op" id="8009672">(</span><span class="string" id="8009673">&#34;%d:&nbsp;on&nbsp;%q,&nbsp;QueryRow/Scan:&nbsp;%v&#34;</span><span class="op" id="8009703">,</span>&nbsp;<span class="ident" id="8009705">n</span><span class="op" id="8009706">,</span>&nbsp;<span class="ident" id="8009708">tt</span><span class="op" id="8009710">.</span><span class="ident" id="8009711">name</span><span class="op" id="8009715">,</span>&nbsp;<span class="ident" id="8009717">err</span><span class="op" id="8009720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009724">}</span>&nbsp;<span class="keyword" id="8009726">else</span>&nbsp;<span class="keyword" id="8009731">if</span>&nbsp;<span class="ident" id="8009734">age</span>&nbsp;<span class="op" id="8009738">!=</span>&nbsp;<span class="ident" id="8009741">tt</span><span class="op" id="8009743">.</span><span class="ident" id="8009744">want</span>&nbsp;<span class="op" id="8009749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009754">t</span><span class="op" id="8009755">.</span><span class="ident" id="8009756">Errorf</span><span class="op" id="8009762">(</span><span class="string" id="8009763">&#34;%d:&nbsp;age=%d,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8009784">,</span>&nbsp;<span class="ident" id="8009786">n</span><span class="op" id="8009787">,</span>&nbsp;<span class="ident" id="8009789">age</span><span class="op" id="8009792">,</span>&nbsp;<span class="ident" id="8009794">tt</span><span class="op" id="8009796">.</span><span class="ident" id="8009797">want</span><span class="op" id="8009801">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8009808">}</span><br>
<span class="lineno"></span><span class="op" id="8009810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8009813">//&nbsp;golang.org/issue/3734</span><br>
<span class="lineno">360</span><span class="keyword" id="8009838">func</span>&nbsp;<span class="ident" id="8009843">TestStatementQueryRowConcurrent</span><span class="op" id="8009874">(</span><span class="ident" id="8009875">t</span>&nbsp;<span class="op" id="8009877">*</span><span class="ident" id="8009878">testing</span><span class="op" id="8009885">.</span><span class="ident" id="8009886">T</span><span class="op" id="8009887">)</span>&nbsp;<span class="op" id="8009889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009892">db</span>&nbsp;<span class="op" id="8009895">:=</span>&nbsp;<span class="ident" id="8009898">newTestDB</span><span class="op" id="8009907">(</span><span class="ident" id="8009908">t</span><span class="op" id="8009909">,</span>&nbsp;<span class="string" id="8009911">&#34;people&#34;</span><span class="op" id="8009919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009922">defer</span>&nbsp;<span class="ident" id="8009928">closeDB</span><span class="op" id="8009935">(</span><span class="ident" id="8009936">t</span><span class="op" id="8009937">,</span>&nbsp;<span class="ident" id="8009939">db</span><span class="op" id="8009941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8009944">stmt</span><span class="op" id="8009948">,</span>&nbsp;<span class="ident" id="8009950">err</span>&nbsp;<span class="op" id="8009954">:=</span>&nbsp;<span class="ident" id="8009957">db</span><span class="op" id="8009959">.</span><span class="ident" id="8009960">Prepare</span><span class="op" id="8009967">(</span><span class="string" id="8009968">&#34;SELECT|people|age|name=?&#34;</span><span class="op" id="8009994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8009997">if</span>&nbsp;<span class="ident" id="8010000">err</span>&nbsp;<span class="op" id="8010004">!=</span>&nbsp;<span class="ident" id="8010007">nil</span>&nbsp;<span class="op" id="8010011">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010015">t</span><span class="op" id="8010016">.</span><span class="ident" id="8010017">Fatalf</span><span class="op" id="8010023">(</span><span class="string" id="8010024">&#34;Prepare:&nbsp;%v&#34;</span><span class="op" id="8010037">,</span>&nbsp;<span class="ident" id="8010039">err</span><span class="op" id="8010042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010048">defer</span>&nbsp;<span class="ident" id="8010054">stmt</span><span class="op" id="8010058">.</span><span class="ident" id="8010059">Close</span><span class="op" id="8010064">(</span><span class="op" id="8010065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010069">const</span>&nbsp;<span class="ident" id="8010075">n</span>&nbsp;<span class="op" id="8010077">=</span>&nbsp;<span class="num" id="8010079">10</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010083">ch</span>&nbsp;<span class="op" id="8010086">:=</span>&nbsp;<span class="builtinfunc" id="8010089">make</span><span class="op" id="8010093">(</span><span class="keyword" id="8010094">chan</span>&nbsp;<span class="builtintype" id="8010099">error</span><span class="op" id="8010104">,</span>&nbsp;<span class="ident" id="8010106">n</span><span class="op" id="8010107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010110">for</span>&nbsp;<span class="ident" id="8010114">i</span>&nbsp;<span class="op" id="8010116">:=</span>&nbsp;<span class="num" id="8010119">0</span><span class="op" id="8010120">;</span>&nbsp;<span class="ident" id="8010122">i</span>&nbsp;<span class="op" id="8010124">&lt;</span>&nbsp;<span class="ident" id="8010126">n</span><span class="op" id="8010127">;</span>&nbsp;<span class="ident" id="8010129">i</span><span class="op" id="8010130">++</span>&nbsp;<span class="op" id="8010133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010137">go</span>&nbsp;<span class="keyword" id="8010140">func</span><span class="op" id="8010144">(</span><span class="op" id="8010145">)</span>&nbsp;<span class="op" id="8010147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010152">var</span>&nbsp;<span class="ident" id="8010156">age</span>&nbsp;<span class="builtintype" id="8010160">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010167">err</span>&nbsp;<span class="op" id="8010171">:=</span>&nbsp;<span class="ident" id="8010174">stmt</span><span class="op" id="8010178">.</span><span class="ident" id="8010179">QueryRow</span><span class="op" id="8010187">(</span><span class="string" id="8010188">&#34;Alice&#34;</span><span class="op" id="8010195">)</span><span class="op" id="8010196">.</span><span class="ident" id="8010197">Scan</span><span class="op" id="8010201">(</span><span class="op" id="8010202">&amp;</span><span class="ident" id="8010203">age</span><span class="op" id="8010206">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010211">if</span>&nbsp;<span class="ident" id="8010214">err</span>&nbsp;<span class="op" id="8010218">==</span>&nbsp;<span class="ident" id="8010221">nil</span>&nbsp;<span class="op" id="8010225">&amp;&amp;</span>&nbsp;<span class="ident" id="8010228">age</span>&nbsp;<span class="op" id="8010232">!=</span>&nbsp;<span class="num" id="8010235">1</span>&nbsp;<span class="op" id="8010237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010243">err</span>&nbsp;<span class="op" id="8010247">=</span>&nbsp;<span class="ident" id="8010249">fmt</span><span class="op" id="8010252">.</span><span class="ident" id="8010253">Errorf</span><span class="op" id="8010259">(</span><span class="string" id="8010260">&#34;unexpected&nbsp;age&nbsp;%d&#34;</span><span class="op" id="8010279">,</span>&nbsp;<span class="ident" id="8010281">age</span><span class="op" id="8010284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010294">ch</span>&nbsp;<span class="op" id="8010297">&lt;-</span>&nbsp;<span class="ident" id="8010300">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010306">}</span><span class="op" id="8010307">(</span><span class="op" id="8010308">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010314">for</span>&nbsp;<span class="ident" id="8010318">i</span>&nbsp;<span class="op" id="8010320">:=</span>&nbsp;<span class="num" id="8010323">0</span><span class="op" id="8010324">;</span>&nbsp;<span class="ident" id="8010326">i</span>&nbsp;<span class="op" id="8010328">&lt;</span>&nbsp;<span class="ident" id="8010330">n</span><span class="op" id="8010331">;</span>&nbsp;<span class="ident" id="8010333">i</span><span class="op" id="8010334">++</span>&nbsp;<span class="op" id="8010337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010341">if</span>&nbsp;<span class="ident" id="8010344">err</span>&nbsp;<span class="op" id="8010348">:=</span>&nbsp;<span class="op" id="8010351">&lt;-</span><span class="ident" id="8010353">ch</span><span class="op" id="8010355">;</span>&nbsp;<span class="ident" id="8010357">err</span>&nbsp;<span class="op" id="8010361">!=</span>&nbsp;<span class="ident" id="8010364">nil</span>&nbsp;<span class="op" id="8010368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010373">t</span><span class="op" id="8010374">.</span><span class="ident" id="8010375">Error</span><span class="op" id="8010380">(</span><span class="ident" id="8010381">err</span><span class="op" id="8010384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010388">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010391">}</span><br>
<span class="lineno"></span><span class="op" id="8010393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8010396">//&nbsp;just&nbsp;a&nbsp;test&nbsp;of&nbsp;fakedb&nbsp;itself</span><br>
<span class="lineno"></span><span class="keyword" id="8010428">func</span>&nbsp;<span class="ident" id="8010433">TestBogusPreboundParameters</span><span class="op" id="8010460">(</span><span class="ident" id="8010461">t</span>&nbsp;<span class="op" id="8010463">*</span><span class="ident" id="8010464">testing</span><span class="op" id="8010471">.</span><span class="ident" id="8010472">T</span><span class="op" id="8010473">)</span>&nbsp;<span class="op" id="8010475">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010478">db</span>&nbsp;<span class="op" id="8010481">:=</span>&nbsp;<span class="ident" id="8010484">newTestDB</span><span class="op" id="8010493">(</span><span class="ident" id="8010494">t</span><span class="op" id="8010495">,</span>&nbsp;<span class="string" id="8010497">&#34;foo&#34;</span><span class="op" id="8010502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010505">defer</span>&nbsp;<span class="ident" id="8010511">closeDB</span><span class="op" id="8010518">(</span><span class="ident" id="8010519">t</span><span class="op" id="8010520">,</span>&nbsp;<span class="ident" id="8010522">db</span><span class="op" id="8010524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010527">exec</span><span class="op" id="8010531">(</span><span class="ident" id="8010532">t</span><span class="op" id="8010533">,</span>&nbsp;<span class="ident" id="8010535">db</span><span class="op" id="8010537">,</span>&nbsp;<span class="string" id="8010539">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8010582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010585">_</span><span class="op" id="8010586">,</span>&nbsp;<span class="ident" id="8010588">err</span>&nbsp;<span class="op" id="8010592">:=</span>&nbsp;<span class="ident" id="8010595">db</span><span class="op" id="8010597">.</span><span class="ident" id="8010598">Prepare</span><span class="op" id="8010605">(</span><span class="string" id="8010606">&#34;INSERT|t1|name=?,age=bogusconversion&#34;</span><span class="op" id="8010644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010647">if</span>&nbsp;<span class="ident" id="8010650">err</span>&nbsp;<span class="op" id="8010654">==</span>&nbsp;<span class="ident" id="8010657">nil</span>&nbsp;<span class="op" id="8010661">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010665">t</span><span class="op" id="8010666">.</span><span class="ident" id="8010667">Fatalf</span><span class="op" id="8010673">(</span><span class="string" id="8010674">&#34;expected&nbsp;error&#34;</span><span class="op" id="8010690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010696">if</span>&nbsp;<span class="ident" id="8010699">err</span><span class="op" id="8010702">.</span><span class="ident" id="8010703">Error</span><span class="op" id="8010708">(</span><span class="op" id="8010709">)</span>&nbsp;<span class="op" id="8010711">!=</span>&nbsp;<span class="string" id="8010714">`fakedb:&nbsp;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;&#34;bogusconversion&#34;`</span>&nbsp;<span class="op" id="8010775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010779">t</span><span class="op" id="8010780">.</span><span class="ident" id="8010781">Errorf</span><span class="op" id="8010787">(</span><span class="string" id="8010788">&#34;unexpected&nbsp;error:&nbsp;%v&#34;</span><span class="op" id="8010810">,</span>&nbsp;<span class="ident" id="8010812">err</span><span class="op" id="8010815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8010818">}</span><br>
<span class="lineno">400</span><span class="op" id="8010820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8010823">func</span>&nbsp;<span class="ident" id="8010828">TestExec</span><span class="op" id="8010836">(</span><span class="ident" id="8010837">t</span>&nbsp;<span class="op" id="8010839">*</span><span class="ident" id="8010840">testing</span><span class="op" id="8010847">.</span><span class="ident" id="8010848">T</span><span class="op" id="8010849">)</span>&nbsp;<span class="op" id="8010851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010854">db</span>&nbsp;<span class="op" id="8010857">:=</span>&nbsp;<span class="ident" id="8010860">newTestDB</span><span class="op" id="8010869">(</span><span class="ident" id="8010870">t</span><span class="op" id="8010871">,</span>&nbsp;<span class="string" id="8010873">&#34;foo&#34;</span><span class="op" id="8010878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8010881">defer</span>&nbsp;<span class="ident" id="8010887">closeDB</span><span class="op" id="8010894">(</span><span class="ident" id="8010895">t</span><span class="op" id="8010896">,</span>&nbsp;<span class="ident" id="8010898">db</span><span class="op" id="8010900">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010903">exec</span><span class="op" id="8010907">(</span><span class="ident" id="8010908">t</span><span class="op" id="8010909">,</span>&nbsp;<span class="ident" id="8010911">db</span><span class="op" id="8010913">,</span>&nbsp;<span class="string" id="8010915">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8010958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8010961">stmt</span><span class="op" id="8010965">,</span>&nbsp;<span class="ident" id="8010967">err</span>&nbsp;<span class="op" id="8010971">:=</span>&nbsp;<span class="ident" id="8010974">db</span><span class="op" id="8010976">.</span><span class="ident" id="8010977">Prepare</span><span class="op" id="8010984">(</span><span class="string" id="8010985">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8011009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011012">if</span>&nbsp;<span class="ident" id="8011015">err</span>&nbsp;<span class="op" id="8011019">!=</span>&nbsp;<span class="ident" id="8011022">nil</span>&nbsp;<span class="op" id="8011026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011030">t</span><span class="op" id="8011031">.</span><span class="ident" id="8011032">Errorf</span><span class="op" id="8011038">(</span><span class="string" id="8011039">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8011059">,</span>&nbsp;<span class="ident" id="8011061">stmt</span><span class="op" id="8011065">,</span>&nbsp;<span class="ident" id="8011067">err</span><span class="op" id="8011070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011073">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011076">defer</span>&nbsp;<span class="ident" id="8011082">stmt</span><span class="op" id="8011086">.</span><span class="ident" id="8011087">Close</span><span class="op" id="8011092">(</span><span class="op" id="8011093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011097">type</span>&nbsp;<span class="ident" id="8011102">execTest</span>&nbsp;<span class="keyword" id="8011111">struct</span>&nbsp;<span class="op" id="8011118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011122">args</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8011130">[</span><span class="op" id="8011131">]</span><span class="keyword" id="8011132">interface</span><span class="op" id="8011141">{</span><span class="op" id="8011142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011146">wantErr</span>&nbsp;<span class="builtintype" id="8011154">string</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011165">execTests</span>&nbsp;<span class="op" id="8011175">:=</span>&nbsp;<span class="op" id="8011178">[</span><span class="op" id="8011179">]</span><span class="ident" id="8011180">execTest</span><span class="op" id="8011188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8011192">//&nbsp;Okay:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011203">{</span><span class="op" id="8011204">[</span><span class="op" id="8011205">]</span><span class="keyword" id="8011206">interface</span><span class="op" id="8011215">{</span><span class="op" id="8011216">}</span><span class="op" id="8011217">{</span><span class="string" id="8011218">&#34;Brad&#34;</span><span class="op" id="8011224">,</span>&nbsp;<span class="num" id="8011226">31</span><span class="op" id="8011228">}</span><span class="op" id="8011229">,</span>&nbsp;<span class="string" id="8011231">&#34;&#34;</span><span class="op" id="8011233">}</span><span class="op" id="8011234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011238">{</span><span class="op" id="8011239">[</span><span class="op" id="8011240">]</span><span class="keyword" id="8011241">interface</span><span class="op" id="8011250">{</span><span class="op" id="8011251">}</span><span class="op" id="8011252">{</span><span class="string" id="8011253">&#34;Brad&#34;</span><span class="op" id="8011259">,</span>&nbsp;<span class="ident" id="8011261">int64</span><span class="op" id="8011266">(</span><span class="num" id="8011267">31</span><span class="op" id="8011269">)</span><span class="op" id="8011270">}</span><span class="op" id="8011271">,</span>&nbsp;<span class="string" id="8011273">&#34;&#34;</span><span class="op" id="8011275">}</span><span class="op" id="8011276">,</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011280">{</span><span class="op" id="8011281">[</span><span class="op" id="8011282">]</span><span class="keyword" id="8011283">interface</span><span class="op" id="8011292">{</span><span class="op" id="8011293">}</span><span class="op" id="8011294">{</span><span class="string" id="8011295">&#34;Bob&#34;</span><span class="op" id="8011300">,</span>&nbsp;<span class="string" id="8011302">&#34;32&#34;</span><span class="op" id="8011306">}</span><span class="op" id="8011307">,</span>&nbsp;<span class="string" id="8011309">&#34;&#34;</span><span class="op" id="8011311">}</span><span class="op" id="8011312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011316">{</span><span class="op" id="8011317">[</span><span class="op" id="8011318">]</span><span class="keyword" id="8011319">interface</span><span class="op" id="8011328">{</span><span class="op" id="8011329">}</span><span class="op" id="8011330">{</span><span class="num" id="8011331">7</span><span class="op" id="8011332">,</span>&nbsp;<span class="num" id="8011334">9</span><span class="op" id="8011335">}</span><span class="op" id="8011336">,</span>&nbsp;<span class="string" id="8011338">&#34;&#34;</span><span class="op" id="8011340">}</span><span class="op" id="8011341">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8011346">//&nbsp;Invalid&nbsp;conversions:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011372">{</span><span class="op" id="8011373">[</span><span class="op" id="8011374">]</span><span class="keyword" id="8011375">interface</span><span class="op" id="8011384">{</span><span class="op" id="8011385">}</span><span class="op" id="8011386">{</span><span class="string" id="8011387">&#34;Brad&#34;</span><span class="op" id="8011393">,</span>&nbsp;<span class="ident" id="8011395">int64</span><span class="op" id="8011400">(</span><span class="num" id="8011401">0xFFFFFFFF</span><span class="op" id="8011411">)</span><span class="op" id="8011412">}</span><span class="op" id="8011413">,</span>&nbsp;<span class="string" id="8011415">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;4294967295&nbsp;overflows&nbsp;int32&#34;</span><span class="op" id="8011497">}</span><span class="op" id="8011498">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011502">{</span><span class="op" id="8011503">[</span><span class="op" id="8011504">]</span><span class="keyword" id="8011505">interface</span><span class="op" id="8011514">{</span><span class="op" id="8011515">}</span><span class="op" id="8011516">{</span><span class="string" id="8011517">&#34;Brad&#34;</span><span class="op" id="8011523">,</span>&nbsp;<span class="string" id="8011525">&#34;strconv&nbsp;fail&#34;</span><span class="op" id="8011539">}</span><span class="op" id="8011540">,</span>&nbsp;<span class="string" id="8011542">&#34;sql:&nbsp;converting&nbsp;argument&nbsp;#1&#39;s&nbsp;type:&nbsp;sql/driver:&nbsp;value&nbsp;\&#34;strconv&nbsp;fail\&#34;&nbsp;can&#39;t&nbsp;be&nbsp;converted&nbsp;to&nbsp;int32&#34;</span><span class="op" id="8011642">}</span><span class="op" id="8011643">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8011648">//&nbsp;Wrong&nbsp;number&nbsp;of&nbsp;args:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011675">{</span><span class="op" id="8011676">[</span><span class="op" id="8011677">]</span><span class="keyword" id="8011678">interface</span><span class="op" id="8011687">{</span><span class="op" id="8011688">}</span><span class="op" id="8011689">{</span><span class="op" id="8011690">}</span><span class="op" id="8011691">,</span>&nbsp;<span class="string" id="8011693">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;0&#34;</span><span class="op" id="8011727">}</span><span class="op" id="8011728">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011732">{</span><span class="op" id="8011733">[</span><span class="op" id="8011734">]</span><span class="keyword" id="8011735">interface</span><span class="op" id="8011744">{</span><span class="op" id="8011745">}</span><span class="op" id="8011746">{</span><span class="num" id="8011747">1</span><span class="op" id="8011748">,</span>&nbsp;<span class="num" id="8011750">2</span><span class="op" id="8011751">,</span>&nbsp;<span class="num" id="8011753">3</span><span class="op" id="8011754">}</span><span class="op" id="8011755">,</span>&nbsp;<span class="string" id="8011757">&#34;sql:&nbsp;expected&nbsp;2&nbsp;arguments,&nbsp;got&nbsp;3&#34;</span><span class="op" id="8011791">}</span><span class="op" id="8011792">,</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011798">for</span>&nbsp;<span class="ident" id="8011802">n</span><span class="op" id="8011803">,</span>&nbsp;<span class="ident" id="8011805">et</span>&nbsp;<span class="op" id="8011808">:=</span>&nbsp;<span class="keyword" id="8011811">range</span>&nbsp;<span class="ident" id="8011817">execTests</span>&nbsp;<span class="op" id="8011827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011831">_</span><span class="op" id="8011832">,</span>&nbsp;<span class="ident" id="8011834">err</span>&nbsp;<span class="op" id="8011838">:=</span>&nbsp;<span class="ident" id="8011841">stmt</span><span class="op" id="8011845">.</span><span class="ident" id="8011846">Exec</span><span class="op" id="8011850">(</span><span class="ident" id="8011851">et</span><span class="op" id="8011853">.</span><span class="ident" id="8011854">args</span><span class="op" id="8011858">...</span><span class="op" id="8011861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011865">errStr</span>&nbsp;<span class="op" id="8011872">:=</span>&nbsp;<span class="string" id="8011875">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011880">if</span>&nbsp;<span class="ident" id="8011883">err</span>&nbsp;<span class="op" id="8011887">!=</span>&nbsp;<span class="ident" id="8011890">nil</span>&nbsp;<span class="op" id="8011894">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011899">errStr</span>&nbsp;<span class="op" id="8011906">=</span>&nbsp;<span class="ident" id="8011908">err</span><span class="op" id="8011911">.</span><span class="ident" id="8011912">Error</span><span class="op" id="8011917">(</span><span class="op" id="8011918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8011922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8011926">if</span>&nbsp;<span class="ident" id="8011929">errStr</span>&nbsp;<span class="op" id="8011936">!=</span>&nbsp;<span class="ident" id="8011939">et</span><span class="op" id="8011941">.</span><span class="ident" id="8011942">wantErr</span>&nbsp;<span class="op" id="8011950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8011955">t</span><span class="op" id="8011956">.</span><span class="ident" id="8011957">Errorf</span><span class="op" id="8011963">(</span><span class="string" id="8011964">&#34;stmt.Execute&nbsp;#%d:&nbsp;for&nbsp;%v,&nbsp;got&nbsp;error&nbsp;%q,&nbsp;want&nbsp;error&nbsp;%q&#34;</span><span class="op" id="8012019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012025">n</span><span class="op" id="8012026">,</span>&nbsp;<span class="ident" id="8012028">et</span><span class="op" id="8012030">.</span><span class="ident" id="8012031">args</span><span class="op" id="8012035">,</span>&nbsp;<span class="ident" id="8012037">errStr</span><span class="op" id="8012043">,</span>&nbsp;<span class="ident" id="8012045">et</span><span class="op" id="8012047">.</span><span class="ident" id="8012048">wantErr</span><span class="op" id="8012055">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012062">}</span><br>
<span class="lineno"></span><span class="op" id="8012064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8012067">func</span>&nbsp;<span class="ident" id="8012072">TestTxPrepare</span><span class="op" id="8012085">(</span><span class="ident" id="8012086">t</span>&nbsp;<span class="op" id="8012088">*</span><span class="ident" id="8012089">testing</span><span class="op" id="8012096">.</span><span class="ident" id="8012097">T</span><span class="op" id="8012098">)</span>&nbsp;<span class="op" id="8012100">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012103">db</span>&nbsp;<span class="op" id="8012106">:=</span>&nbsp;<span class="ident" id="8012109">newTestDB</span><span class="op" id="8012118">(</span><span class="ident" id="8012119">t</span><span class="op" id="8012120">,</span>&nbsp;<span class="string" id="8012122">&#34;&#34;</span><span class="op" id="8012124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012127">defer</span>&nbsp;<span class="ident" id="8012133">closeDB</span><span class="op" id="8012140">(</span><span class="ident" id="8012141">t</span><span class="op" id="8012142">,</span>&nbsp;<span class="ident" id="8012144">db</span><span class="op" id="8012146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012149">exec</span><span class="op" id="8012153">(</span><span class="ident" id="8012154">t</span><span class="op" id="8012155">,</span>&nbsp;<span class="ident" id="8012157">db</span><span class="op" id="8012159">,</span>&nbsp;<span class="string" id="8012161">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8012204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012207">tx</span><span class="op" id="8012209">,</span>&nbsp;<span class="ident" id="8012211">err</span>&nbsp;<span class="op" id="8012215">:=</span>&nbsp;<span class="ident" id="8012218">db</span><span class="op" id="8012220">.</span><span class="ident" id="8012221">Begin</span><span class="op" id="8012226">(</span><span class="op" id="8012227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012230">if</span>&nbsp;<span class="ident" id="8012233">err</span>&nbsp;<span class="op" id="8012237">!=</span>&nbsp;<span class="ident" id="8012240">nil</span>&nbsp;<span class="op" id="8012244">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012248">t</span><span class="op" id="8012249">.</span><span class="ident" id="8012250">Fatalf</span><span class="op" id="8012256">(</span><span class="string" id="8012257">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8012269">,</span>&nbsp;<span class="ident" id="8012271">err</span><span class="op" id="8012274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012280">stmt</span><span class="op" id="8012284">,</span>&nbsp;<span class="ident" id="8012286">err</span>&nbsp;<span class="op" id="8012290">:=</span>&nbsp;<span class="ident" id="8012293">tx</span><span class="op" id="8012295">.</span><span class="ident" id="8012296">Prepare</span><span class="op" id="8012303">(</span><span class="string" id="8012304">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8012328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012331">if</span>&nbsp;<span class="ident" id="8012334">err</span>&nbsp;<span class="op" id="8012338">!=</span>&nbsp;<span class="ident" id="8012341">nil</span>&nbsp;<span class="op" id="8012345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012349">t</span><span class="op" id="8012350">.</span><span class="ident" id="8012351">Fatalf</span><span class="op" id="8012357">(</span><span class="string" id="8012358">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8012378">,</span>&nbsp;<span class="ident" id="8012380">stmt</span><span class="op" id="8012384">,</span>&nbsp;<span class="ident" id="8012386">err</span><span class="op" id="8012389">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012395">defer</span>&nbsp;<span class="ident" id="8012401">stmt</span><span class="op" id="8012405">.</span><span class="ident" id="8012406">Close</span><span class="op" id="8012411">(</span><span class="op" id="8012412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012415">_</span><span class="op" id="8012416">,</span>&nbsp;<span class="ident" id="8012418">err</span>&nbsp;<span class="op" id="8012422">=</span>&nbsp;<span class="ident" id="8012424">stmt</span><span class="op" id="8012428">.</span><span class="ident" id="8012429">Exec</span><span class="op" id="8012433">(</span><span class="string" id="8012434">&#34;Bobby&#34;</span><span class="op" id="8012441">,</span>&nbsp;<span class="num" id="8012443">7</span><span class="op" id="8012444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012447">if</span>&nbsp;<span class="ident" id="8012450">err</span>&nbsp;<span class="op" id="8012454">!=</span>&nbsp;<span class="ident" id="8012457">nil</span>&nbsp;<span class="op" id="8012461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012465">t</span><span class="op" id="8012466">.</span><span class="ident" id="8012467">Fatalf</span><span class="op" id="8012473">(</span><span class="string" id="8012474">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8012485">,</span>&nbsp;<span class="ident" id="8012487">err</span><span class="op" id="8012490">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012496">err</span>&nbsp;<span class="op" id="8012500">=</span>&nbsp;<span class="ident" id="8012502">tx</span><span class="op" id="8012504">.</span><span class="ident" id="8012505">Commit</span><span class="op" id="8012511">(</span><span class="op" id="8012512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012515">if</span>&nbsp;<span class="ident" id="8012518">err</span>&nbsp;<span class="op" id="8012522">!=</span>&nbsp;<span class="ident" id="8012525">nil</span>&nbsp;<span class="op" id="8012529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012533">t</span><span class="op" id="8012534">.</span><span class="ident" id="8012535">Fatalf</span><span class="op" id="8012541">(</span><span class="string" id="8012542">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8012555">,</span>&nbsp;<span class="ident" id="8012557">err</span><span class="op" id="8012560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012563">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8012566">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012612">if</span>&nbsp;<span class="op" id="8012615">!</span><span class="ident" id="8012616">stmt</span><span class="op" id="8012620">.</span><span class="ident" id="8012621">closed</span>&nbsp;<span class="op" id="8012628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012632">t</span><span class="op" id="8012633">.</span><span class="ident" id="8012634">Fatal</span><span class="op" id="8012639">(</span><span class="string" id="8012640">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8012670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012673">}</span><br>
<span class="lineno"></span><span class="op" id="8012675">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="keyword" id="8012678">func</span>&nbsp;<span class="ident" id="8012683">TestTxStmt</span><span class="op" id="8012693">(</span><span class="ident" id="8012694">t</span>&nbsp;<span class="op" id="8012696">*</span><span class="ident" id="8012697">testing</span><span class="op" id="8012704">.</span><span class="ident" id="8012705">T</span><span class="op" id="8012706">)</span>&nbsp;<span class="op" id="8012708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012711">db</span>&nbsp;<span class="op" id="8012714">:=</span>&nbsp;<span class="ident" id="8012717">newTestDB</span><span class="op" id="8012726">(</span><span class="ident" id="8012727">t</span><span class="op" id="8012728">,</span>&nbsp;<span class="string" id="8012730">&#34;&#34;</span><span class="op" id="8012732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012735">defer</span>&nbsp;<span class="ident" id="8012741">closeDB</span><span class="op" id="8012748">(</span><span class="ident" id="8012749">t</span><span class="op" id="8012750">,</span>&nbsp;<span class="ident" id="8012752">db</span><span class="op" id="8012754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012757">exec</span><span class="op" id="8012761">(</span><span class="ident" id="8012762">t</span><span class="op" id="8012763">,</span>&nbsp;<span class="ident" id="8012765">db</span><span class="op" id="8012767">,</span>&nbsp;<span class="string" id="8012769">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8012812">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012815">stmt</span><span class="op" id="8012819">,</span>&nbsp;<span class="ident" id="8012821">err</span>&nbsp;<span class="op" id="8012825">:=</span>&nbsp;<span class="ident" id="8012828">db</span><span class="op" id="8012830">.</span><span class="ident" id="8012831">Prepare</span><span class="op" id="8012838">(</span><span class="string" id="8012839">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8012863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012866">if</span>&nbsp;<span class="ident" id="8012869">err</span>&nbsp;<span class="op" id="8012873">!=</span>&nbsp;<span class="ident" id="8012876">nil</span>&nbsp;<span class="op" id="8012880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012884">t</span><span class="op" id="8012885">.</span><span class="ident" id="8012886">Fatalf</span><span class="op" id="8012892">(</span><span class="string" id="8012893">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8012913">,</span>&nbsp;<span class="ident" id="8012915">stmt</span><span class="op" id="8012919">,</span>&nbsp;<span class="ident" id="8012921">err</span><span class="op" id="8012924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8012927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012930">defer</span>&nbsp;<span class="ident" id="8012936">stmt</span><span class="op" id="8012940">.</span><span class="ident" id="8012941">Close</span><span class="op" id="8012946">(</span><span class="op" id="8012947">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012950">tx</span><span class="op" id="8012952">,</span>&nbsp;<span class="ident" id="8012954">err</span>&nbsp;<span class="op" id="8012958">:=</span>&nbsp;<span class="ident" id="8012961">db</span><span class="op" id="8012963">.</span><span class="ident" id="8012964">Begin</span><span class="op" id="8012969">(</span><span class="op" id="8012970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8012973">if</span>&nbsp;<span class="ident" id="8012976">err</span>&nbsp;<span class="op" id="8012980">!=</span>&nbsp;<span class="ident" id="8012983">nil</span>&nbsp;<span class="op" id="8012987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8012991">t</span><span class="op" id="8012992">.</span><span class="ident" id="8012993">Fatalf</span><span class="op" id="8012999">(</span><span class="string" id="8013000">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8013012">,</span>&nbsp;<span class="ident" id="8013014">err</span><span class="op" id="8013017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013023">txs</span>&nbsp;<span class="op" id="8013027">:=</span>&nbsp;<span class="ident" id="8013030">tx</span><span class="op" id="8013032">.</span><span class="ident" id="8013033">Stmt</span><span class="op" id="8013037">(</span><span class="ident" id="8013038">stmt</span><span class="op" id="8013042">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013045">defer</span>&nbsp;<span class="ident" id="8013051">txs</span><span class="op" id="8013054">.</span><span class="ident" id="8013055">Close</span><span class="op" id="8013060">(</span><span class="op" id="8013061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013064">_</span><span class="op" id="8013065">,</span>&nbsp;<span class="ident" id="8013067">err</span>&nbsp;<span class="op" id="8013071">=</span>&nbsp;<span class="ident" id="8013073">txs</span><span class="op" id="8013076">.</span><span class="ident" id="8013077">Exec</span><span class="op" id="8013081">(</span><span class="string" id="8013082">&#34;Bobby&#34;</span><span class="op" id="8013089">,</span>&nbsp;<span class="num" id="8013091">7</span><span class="op" id="8013092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013095">if</span>&nbsp;<span class="ident" id="8013098">err</span>&nbsp;<span class="op" id="8013102">!=</span>&nbsp;<span class="ident" id="8013105">nil</span>&nbsp;<span class="op" id="8013109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013113">t</span><span class="op" id="8013114">.</span><span class="ident" id="8013115">Fatalf</span><span class="op" id="8013121">(</span><span class="string" id="8013122">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8013133">,</span>&nbsp;<span class="ident" id="8013135">err</span><span class="op" id="8013138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013141">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013144">err</span>&nbsp;<span class="op" id="8013148">=</span>&nbsp;<span class="ident" id="8013150">tx</span><span class="op" id="8013152">.</span><span class="ident" id="8013153">Commit</span><span class="op" id="8013159">(</span><span class="op" id="8013160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013163">if</span>&nbsp;<span class="ident" id="8013166">err</span>&nbsp;<span class="op" id="8013170">!=</span>&nbsp;<span class="ident" id="8013173">nil</span>&nbsp;<span class="op" id="8013177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013181">t</span><span class="op" id="8013182">.</span><span class="ident" id="8013183">Fatalf</span><span class="op" id="8013189">(</span><span class="string" id="8013190">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8013203">,</span>&nbsp;<span class="ident" id="8013205">err</span><span class="op" id="8013208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8013214">//&nbsp;Commit()&nbsp;should&nbsp;have&nbsp;closed&nbsp;the&nbsp;statement</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013260">if</span>&nbsp;<span class="op" id="8013263">!</span><span class="ident" id="8013264">txs</span><span class="op" id="8013267">.</span><span class="ident" id="8013268">closed</span>&nbsp;<span class="op" id="8013275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013279">t</span><span class="op" id="8013280">.</span><span class="ident" id="8013281">Fatal</span><span class="op" id="8013286">(</span><span class="string" id="8013287">&#34;Stmt&nbsp;not&nbsp;closed&nbsp;after&nbsp;Commit&#34;</span><span class="op" id="8013317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013320">}</span><br>
<span class="lineno"></span><span class="op" id="8013322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">500</span><span class="comment" id="8013325">//&nbsp;Issue:&nbsp;http://golang.org/issue/2784</span><br>
<span class="lineno"></span><span class="comment" id="8013364">//&nbsp;This&nbsp;test&nbsp;didn&#39;t&nbsp;fail&nbsp;before&nbsp;because&nbsp;we&nbsp;got&nbsp;lucky&nbsp;with&nbsp;the&nbsp;fakedb&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="8013441">//&nbsp;It&nbsp;was&nbsp;failing,&nbsp;and&nbsp;now&nbsp;not,&nbsp;in&nbsp;github.com/bradfitz/go-sql-test</span><br>
<span class="lineno"></span><span class="keyword" id="8013508">func</span>&nbsp;<span class="ident" id="8013513">TestTxQuery</span><span class="op" id="8013524">(</span><span class="ident" id="8013525">t</span>&nbsp;<span class="op" id="8013527">*</span><span class="ident" id="8013528">testing</span><span class="op" id="8013535">.</span><span class="ident" id="8013536">T</span><span class="op" id="8013537">)</span>&nbsp;<span class="op" id="8013539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013542">db</span>&nbsp;<span class="op" id="8013545">:=</span>&nbsp;<span class="ident" id="8013548">newTestDB</span><span class="op" id="8013557">(</span><span class="ident" id="8013558">t</span><span class="op" id="8013559">,</span>&nbsp;<span class="string" id="8013561">&#34;&#34;</span><span class="op" id="8013563">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013566">defer</span>&nbsp;<span class="ident" id="8013572">closeDB</span><span class="op" id="8013579">(</span><span class="ident" id="8013580">t</span><span class="op" id="8013581">,</span>&nbsp;<span class="ident" id="8013583">db</span><span class="op" id="8013585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013588">exec</span><span class="op" id="8013592">(</span><span class="ident" id="8013593">t</span><span class="op" id="8013594">,</span>&nbsp;<span class="ident" id="8013596">db</span><span class="op" id="8013598">,</span>&nbsp;<span class="string" id="8013600">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8013643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013646">exec</span><span class="op" id="8013650">(</span><span class="ident" id="8013651">t</span><span class="op" id="8013652">,</span>&nbsp;<span class="ident" id="8013654">db</span><span class="op" id="8013656">,</span>&nbsp;<span class="string" id="8013658">&#34;INSERT|t1|name=Alice&#34;</span><span class="op" id="8013680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013684">tx</span><span class="op" id="8013686">,</span>&nbsp;<span class="ident" id="8013688">err</span>&nbsp;<span class="op" id="8013692">:=</span>&nbsp;<span class="ident" id="8013695">db</span><span class="op" id="8013697">.</span><span class="ident" id="8013698">Begin</span><span class="op" id="8013703">(</span><span class="op" id="8013704">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013707">if</span>&nbsp;<span class="ident" id="8013710">err</span>&nbsp;<span class="op" id="8013714">!=</span>&nbsp;<span class="ident" id="8013717">nil</span>&nbsp;<span class="op" id="8013721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013725">t</span><span class="op" id="8013726">.</span><span class="ident" id="8013727">Fatal</span><span class="op" id="8013732">(</span><span class="ident" id="8013733">err</span><span class="op" id="8013736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013742">defer</span>&nbsp;<span class="ident" id="8013748">tx</span><span class="op" id="8013750">.</span><span class="ident" id="8013751">Rollback</span><span class="op" id="8013759">(</span><span class="op" id="8013760">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013764">r</span><span class="op" id="8013765">,</span>&nbsp;<span class="ident" id="8013767">err</span>&nbsp;<span class="op" id="8013771">:=</span>&nbsp;<span class="ident" id="8013774">tx</span><span class="op" id="8013776">.</span><span class="ident" id="8013777">Query</span><span class="op" id="8013782">(</span><span class="string" id="8013783">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8013800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013803">if</span>&nbsp;<span class="ident" id="8013806">err</span>&nbsp;<span class="op" id="8013810">!=</span>&nbsp;<span class="ident" id="8013813">nil</span>&nbsp;<span class="op" id="8013817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013821">t</span><span class="op" id="8013822">.</span><span class="ident" id="8013823">Fatal</span><span class="op" id="8013828">(</span><span class="ident" id="8013829">err</span><span class="op" id="8013832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013838">defer</span>&nbsp;<span class="ident" id="8013844">r</span><span class="op" id="8013845">.</span><span class="ident" id="8013846">Close</span><span class="op" id="8013851">(</span><span class="op" id="8013852">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013856">if</span>&nbsp;<span class="op" id="8013859">!</span><span class="ident" id="8013860">r</span><span class="op" id="8013861">.</span><span class="ident" id="8013862">Next</span><span class="op" id="8013866">(</span><span class="op" id="8013867">)</span>&nbsp;<span class="op" id="8013869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013873">if</span>&nbsp;<span class="ident" id="8013876">r</span><span class="op" id="8013877">.</span><span class="ident" id="8013878">Err</span><span class="op" id="8013881">(</span><span class="op" id="8013882">)</span>&nbsp;<span class="op" id="8013884">!=</span>&nbsp;<span class="ident" id="8013887">nil</span>&nbsp;<span class="op" id="8013891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013896">t</span><span class="op" id="8013897">.</span><span class="ident" id="8013898">Fatal</span><span class="op" id="8013903">(</span><span class="ident" id="8013904">r</span><span class="op" id="8013905">.</span><span class="ident" id="8013906">Err</span><span class="op" id="8013909">(</span><span class="op" id="8013910">)</span><span class="op" id="8013911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013915">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013919">t</span><span class="op" id="8013920">.</span><span class="ident" id="8013921">Fatal</span><span class="op" id="8013926">(</span><span class="string" id="8013927">&#34;expected&nbsp;one&nbsp;row&#34;</span><span class="op" id="8013945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8013948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013952">var</span>&nbsp;<span class="ident" id="8013956">x</span>&nbsp;<span class="builtintype" id="8013958">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8013966">err</span>&nbsp;<span class="op" id="8013970">=</span>&nbsp;<span class="ident" id="8013972">r</span><span class="op" id="8013973">.</span><span class="ident" id="8013974">Scan</span><span class="op" id="8013978">(</span><span class="op" id="8013979">&amp;</span><span class="ident" id="8013980">x</span><span class="op" id="8013981">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8013984">if</span>&nbsp;<span class="ident" id="8013987">err</span>&nbsp;<span class="op" id="8013991">!=</span>&nbsp;<span class="ident" id="8013994">nil</span>&nbsp;<span class="op" id="8013998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014002">t</span><span class="op" id="8014003">.</span><span class="ident" id="8014004">Fatal</span><span class="op" id="8014009">(</span><span class="ident" id="8014010">err</span><span class="op" id="8014013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014016">}</span><br>
<span class="lineno"></span><span class="op" id="8014018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8014021">func</span>&nbsp;<span class="ident" id="8014026">TestTxQueryInvalid</span><span class="op" id="8014044">(</span><span class="ident" id="8014045">t</span>&nbsp;<span class="op" id="8014047">*</span><span class="ident" id="8014048">testing</span><span class="op" id="8014055">.</span><span class="ident" id="8014056">T</span><span class="op" id="8014057">)</span>&nbsp;<span class="op" id="8014059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014062">db</span>&nbsp;<span class="op" id="8014065">:=</span>&nbsp;<span class="ident" id="8014068">newTestDB</span><span class="op" id="8014077">(</span><span class="ident" id="8014078">t</span><span class="op" id="8014079">,</span>&nbsp;<span class="string" id="8014081">&#34;&#34;</span><span class="op" id="8014083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014086">defer</span>&nbsp;<span class="ident" id="8014092">closeDB</span><span class="op" id="8014099">(</span><span class="ident" id="8014100">t</span><span class="op" id="8014101">,</span>&nbsp;<span class="ident" id="8014103">db</span><span class="op" id="8014105">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014109">tx</span><span class="op" id="8014111">,</span>&nbsp;<span class="ident" id="8014113">err</span>&nbsp;<span class="op" id="8014117">:=</span>&nbsp;<span class="ident" id="8014120">db</span><span class="op" id="8014122">.</span><span class="ident" id="8014123">Begin</span><span class="op" id="8014128">(</span><span class="op" id="8014129">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014132">if</span>&nbsp;<span class="ident" id="8014135">err</span>&nbsp;<span class="op" id="8014139">!=</span>&nbsp;<span class="ident" id="8014142">nil</span>&nbsp;<span class="op" id="8014146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014150">t</span><span class="op" id="8014151">.</span><span class="ident" id="8014152">Fatal</span><span class="op" id="8014157">(</span><span class="ident" id="8014158">err</span><span class="op" id="8014161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014167">defer</span>&nbsp;<span class="ident" id="8014173">tx</span><span class="op" id="8014175">.</span><span class="ident" id="8014176">Rollback</span><span class="op" id="8014184">(</span><span class="op" id="8014185">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014189">_</span><span class="op" id="8014190">,</span>&nbsp;<span class="ident" id="8014192">err</span>&nbsp;<span class="op" id="8014196">=</span>&nbsp;<span class="ident" id="8014198">tx</span><span class="op" id="8014200">.</span><span class="ident" id="8014201">Query</span><span class="op" id="8014206">(</span><span class="string" id="8014207">&#34;SELECT|t1|name|&#34;</span><span class="op" id="8014224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014227">if</span>&nbsp;<span class="ident" id="8014230">err</span>&nbsp;<span class="op" id="8014234">==</span>&nbsp;<span class="ident" id="8014237">nil</span>&nbsp;<span class="op" id="8014241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014245">t</span><span class="op" id="8014246">.</span><span class="ident" id="8014247">Fatal</span><span class="op" id="8014252">(</span><span class="string" id="8014253">&#34;Error&nbsp;expected&#34;</span><span class="op" id="8014269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014272">}</span><br>
<span class="lineno"></span><span class="op" id="8014274">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="8014277">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;4433,&nbsp;that&nbsp;retries&nbsp;in&nbsp;Begin&nbsp;happen&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="8014340">//&nbsp;conn.Begin()&nbsp;returns&nbsp;ErrBadConn</span><br>
<span class="lineno"></span><span class="keyword" id="8014375">func</span>&nbsp;<span class="ident" id="8014380">TestTxErrBadConn</span><span class="op" id="8014396">(</span><span class="ident" id="8014397">t</span>&nbsp;<span class="op" id="8014399">*</span><span class="ident" id="8014400">testing</span><span class="op" id="8014407">.</span><span class="ident" id="8014408">T</span><span class="op" id="8014409">)</span>&nbsp;<span class="op" id="8014411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014414">db</span><span class="op" id="8014416">,</span>&nbsp;<span class="ident" id="8014418">err</span>&nbsp;<span class="op" id="8014422">:=</span>&nbsp;<span class="ident" id="8014425">Open</span><span class="op" id="8014429">(</span><span class="string" id="8014430">&#34;test&#34;</span><span class="op" id="8014436">,</span>&nbsp;<span class="ident" id="8014438">fakeDBName</span><span class="op" id="8014448">+</span><span class="string" id="8014449">&#34;;badConn&#34;</span><span class="op" id="8014459">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014462">if</span>&nbsp;<span class="ident" id="8014465">err</span>&nbsp;<span class="op" id="8014469">!=</span>&nbsp;<span class="ident" id="8014472">nil</span>&nbsp;<span class="op" id="8014476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014480">t</span><span class="op" id="8014481">.</span><span class="ident" id="8014482">Fatalf</span><span class="op" id="8014488">(</span><span class="string" id="8014489">&#34;Open:&nbsp;%v&#34;</span><span class="op" id="8014499">,</span>&nbsp;<span class="ident" id="8014501">err</span><span class="op" id="8014504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014510">if</span>&nbsp;<span class="ident" id="8014513">_</span><span class="op" id="8014514">,</span>&nbsp;<span class="ident" id="8014516">err</span>&nbsp;<span class="op" id="8014520">:=</span>&nbsp;<span class="ident" id="8014523">db</span><span class="op" id="8014525">.</span><span class="ident" id="8014526">Exec</span><span class="op" id="8014530">(</span><span class="string" id="8014531">&#34;WIPE&#34;</span><span class="op" id="8014537">)</span><span class="op" id="8014538">;</span>&nbsp;<span class="ident" id="8014540">err</span>&nbsp;<span class="op" id="8014544">!=</span>&nbsp;<span class="ident" id="8014547">nil</span>&nbsp;<span class="op" id="8014551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014555">t</span><span class="op" id="8014556">.</span><span class="ident" id="8014557">Fatalf</span><span class="op" id="8014563">(</span><span class="string" id="8014564">&#34;exec&nbsp;wipe:&nbsp;%v&#34;</span><span class="op" id="8014579">,</span>&nbsp;<span class="ident" id="8014581">err</span><span class="op" id="8014584">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014590">defer</span>&nbsp;<span class="ident" id="8014596">closeDB</span><span class="op" id="8014603">(</span><span class="ident" id="8014604">t</span><span class="op" id="8014605">,</span>&nbsp;<span class="ident" id="8014607">db</span><span class="op" id="8014609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014612">exec</span><span class="op" id="8014616">(</span><span class="ident" id="8014617">t</span><span class="op" id="8014618">,</span>&nbsp;<span class="ident" id="8014620">db</span><span class="op" id="8014622">,</span>&nbsp;<span class="string" id="8014624">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8014667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014670">stmt</span><span class="op" id="8014674">,</span>&nbsp;<span class="ident" id="8014676">err</span>&nbsp;<span class="op" id="8014680">:=</span>&nbsp;<span class="ident" id="8014683">db</span><span class="op" id="8014685">.</span><span class="ident" id="8014686">Prepare</span><span class="op" id="8014693">(</span><span class="string" id="8014694">&#34;INSERT|t1|name=?,age=?&#34;</span><span class="op" id="8014718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014721">if</span>&nbsp;<span class="ident" id="8014724">err</span>&nbsp;<span class="op" id="8014728">!=</span>&nbsp;<span class="ident" id="8014731">nil</span>&nbsp;<span class="op" id="8014735">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014739">t</span><span class="op" id="8014740">.</span><span class="ident" id="8014741">Fatalf</span><span class="op" id="8014747">(</span><span class="string" id="8014748">&#34;Stmt,&nbsp;err&nbsp;=&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="8014768">,</span>&nbsp;<span class="ident" id="8014770">stmt</span><span class="op" id="8014774">,</span>&nbsp;<span class="ident" id="8014776">err</span><span class="op" id="8014779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014785">defer</span>&nbsp;<span class="ident" id="8014791">stmt</span><span class="op" id="8014795">.</span><span class="ident" id="8014796">Close</span><span class="op" id="8014801">(</span><span class="op" id="8014802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014805">tx</span><span class="op" id="8014807">,</span>&nbsp;<span class="ident" id="8014809">err</span>&nbsp;<span class="op" id="8014813">:=</span>&nbsp;<span class="ident" id="8014816">db</span><span class="op" id="8014818">.</span><span class="ident" id="8014819">Begin</span><span class="op" id="8014824">(</span><span class="op" id="8014825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014828">if</span>&nbsp;<span class="ident" id="8014831">err</span>&nbsp;<span class="op" id="8014835">!=</span>&nbsp;<span class="ident" id="8014838">nil</span>&nbsp;<span class="op" id="8014842">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014846">t</span><span class="op" id="8014847">.</span><span class="ident" id="8014848">Fatalf</span><span class="op" id="8014854">(</span><span class="string" id="8014855">&#34;Begin&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8014867">,</span>&nbsp;<span class="ident" id="8014869">err</span><span class="op" id="8014872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014878">txs</span>&nbsp;<span class="op" id="8014882">:=</span>&nbsp;<span class="ident" id="8014885">tx</span><span class="op" id="8014887">.</span><span class="ident" id="8014888">Stmt</span><span class="op" id="8014892">(</span><span class="ident" id="8014893">stmt</span><span class="op" id="8014897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014900">defer</span>&nbsp;<span class="ident" id="8014906">txs</span><span class="op" id="8014909">.</span><span class="ident" id="8014910">Close</span><span class="op" id="8014915">(</span><span class="op" id="8014916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014919">_</span><span class="op" id="8014920">,</span>&nbsp;<span class="ident" id="8014922">err</span>&nbsp;<span class="op" id="8014926">=</span>&nbsp;<span class="ident" id="8014928">txs</span><span class="op" id="8014931">.</span><span class="ident" id="8014932">Exec</span><span class="op" id="8014936">(</span><span class="string" id="8014937">&#34;Bobby&#34;</span><span class="op" id="8014944">,</span>&nbsp;<span class="num" id="8014946">7</span><span class="op" id="8014947">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8014950">if</span>&nbsp;<span class="ident" id="8014953">err</span>&nbsp;<span class="op" id="8014957">!=</span>&nbsp;<span class="ident" id="8014960">nil</span>&nbsp;<span class="op" id="8014964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014968">t</span><span class="op" id="8014969">.</span><span class="ident" id="8014970">Fatalf</span><span class="op" id="8014976">(</span><span class="string" id="8014977">&#34;Exec&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8014988">,</span>&nbsp;<span class="ident" id="8014990">err</span><span class="op" id="8014993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8014996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8014999">err</span>&nbsp;<span class="op" id="8015003">=</span>&nbsp;<span class="ident" id="8015005">tx</span><span class="op" id="8015007">.</span><span class="ident" id="8015008">Commit</span><span class="op" id="8015014">(</span><span class="op" id="8015015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015018">if</span>&nbsp;<span class="ident" id="8015021">err</span>&nbsp;<span class="op" id="8015025">!=</span>&nbsp;<span class="ident" id="8015028">nil</span>&nbsp;<span class="op" id="8015032">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015036">t</span><span class="op" id="8015037">.</span><span class="ident" id="8015038">Fatalf</span><span class="op" id="8015044">(</span><span class="string" id="8015045">&#34;Commit&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8015058">,</span>&nbsp;<span class="ident" id="8015060">err</span><span class="op" id="8015063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015066">}</span><br>
<span class="lineno"></span><span class="op" id="8015068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8015071">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2542,&nbsp;that&nbsp;we&nbsp;release&nbsp;a&nbsp;lock&nbsp;when&nbsp;querying&nbsp;on</span><br>
<span class="lineno">585</span><span class="comment" id="8015140">//&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="8015164">func</span>&nbsp;<span class="ident" id="8015169">TestIssue2542Deadlock</span><span class="op" id="8015190">(</span><span class="ident" id="8015191">t</span>&nbsp;<span class="op" id="8015193">*</span><span class="ident" id="8015194">testing</span><span class="op" id="8015201">.</span><span class="ident" id="8015202">T</span><span class="op" id="8015203">)</span>&nbsp;<span class="op" id="8015205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015208">db</span>&nbsp;<span class="op" id="8015211">:=</span>&nbsp;<span class="ident" id="8015214">newTestDB</span><span class="op" id="8015223">(</span><span class="ident" id="8015224">t</span><span class="op" id="8015225">,</span>&nbsp;<span class="string" id="8015227">&#34;people&#34;</span><span class="op" id="8015235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015238">closeDB</span><span class="op" id="8015245">(</span><span class="ident" id="8015246">t</span><span class="op" id="8015247">,</span>&nbsp;<span class="ident" id="8015249">db</span><span class="op" id="8015251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015254">for</span>&nbsp;<span class="ident" id="8015258">i</span>&nbsp;<span class="op" id="8015260">:=</span>&nbsp;<span class="num" id="8015263">0</span><span class="op" id="8015264">;</span>&nbsp;<span class="ident" id="8015266">i</span>&nbsp;<span class="op" id="8015268">&lt;</span>&nbsp;<span class="num" id="8015270">2</span><span class="op" id="8015271">;</span>&nbsp;<span class="ident" id="8015273">i</span><span class="op" id="8015274">++</span>&nbsp;<span class="op" id="8015277">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015281">_</span><span class="op" id="8015282">,</span>&nbsp;<span class="ident" id="8015284">err</span>&nbsp;<span class="op" id="8015288">:=</span>&nbsp;<span class="ident" id="8015291">db</span><span class="op" id="8015293">.</span><span class="ident" id="8015294">Query</span><span class="op" id="8015299">(</span><span class="string" id="8015300">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8015325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015329">if</span>&nbsp;<span class="ident" id="8015332">err</span>&nbsp;<span class="op" id="8015336">==</span>&nbsp;<span class="ident" id="8015339">nil</span>&nbsp;<span class="op" id="8015343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015348">t</span><span class="op" id="8015349">.</span><span class="ident" id="8015350">Fatalf</span><span class="op" id="8015356">(</span><span class="string" id="8015357">&#34;expected&nbsp;error&#34;</span><span class="op" id="8015373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015380">}</span><br>
<span class="lineno">595</span><span class="op" id="8015382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8015385">//&nbsp;From&nbsp;golang.org/issue/3865</span><br>
<span class="lineno"></span><span class="keyword" id="8015415">func</span>&nbsp;<span class="ident" id="8015420">TestCloseStmtBeforeRows</span><span class="op" id="8015443">(</span><span class="ident" id="8015444">t</span>&nbsp;<span class="op" id="8015446">*</span><span class="ident" id="8015447">testing</span><span class="op" id="8015454">.</span><span class="ident" id="8015455">T</span><span class="op" id="8015456">)</span>&nbsp;<span class="op" id="8015458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015461">db</span>&nbsp;<span class="op" id="8015464">:=</span>&nbsp;<span class="ident" id="8015467">newTestDB</span><span class="op" id="8015476">(</span><span class="ident" id="8015477">t</span><span class="op" id="8015478">,</span>&nbsp;<span class="string" id="8015480">&#34;people&#34;</span><span class="op" id="8015488">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015491">defer</span>&nbsp;<span class="ident" id="8015497">closeDB</span><span class="op" id="8015504">(</span><span class="ident" id="8015505">t</span><span class="op" id="8015506">,</span>&nbsp;<span class="ident" id="8015508">db</span><span class="op" id="8015510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015514">s</span><span class="op" id="8015515">,</span>&nbsp;<span class="ident" id="8015517">err</span>&nbsp;<span class="op" id="8015521">:=</span>&nbsp;<span class="ident" id="8015524">db</span><span class="op" id="8015526">.</span><span class="ident" id="8015527">Prepare</span><span class="op" id="8015534">(</span><span class="string" id="8015535">&#34;SELECT|people|name|&#34;</span><span class="op" id="8015556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015559">if</span>&nbsp;<span class="ident" id="8015562">err</span>&nbsp;<span class="op" id="8015566">!=</span>&nbsp;<span class="ident" id="8015569">nil</span>&nbsp;<span class="op" id="8015573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015577">t</span><span class="op" id="8015578">.</span><span class="ident" id="8015579">Fatal</span><span class="op" id="8015584">(</span><span class="ident" id="8015585">err</span><span class="op" id="8015588">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015595">r</span><span class="op" id="8015596">,</span>&nbsp;<span class="ident" id="8015598">err</span>&nbsp;<span class="op" id="8015602">:=</span>&nbsp;<span class="ident" id="8015605">s</span><span class="op" id="8015606">.</span><span class="ident" id="8015607">Query</span><span class="op" id="8015612">(</span><span class="op" id="8015613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015616">if</span>&nbsp;<span class="ident" id="8015619">err</span>&nbsp;<span class="op" id="8015623">!=</span>&nbsp;<span class="ident" id="8015626">nil</span>&nbsp;<span class="op" id="8015630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015634">s</span><span class="op" id="8015635">.</span><span class="ident" id="8015636">Close</span><span class="op" id="8015641">(</span><span class="op" id="8015642">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015646">t</span><span class="op" id="8015647">.</span><span class="ident" id="8015648">Fatal</span><span class="op" id="8015653">(</span><span class="ident" id="8015654">err</span><span class="op" id="8015657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015664">err</span>&nbsp;<span class="op" id="8015668">=</span>&nbsp;<span class="ident" id="8015670">s</span><span class="op" id="8015671">.</span><span class="ident" id="8015672">Close</span><span class="op" id="8015677">(</span><span class="op" id="8015678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015681">if</span>&nbsp;<span class="ident" id="8015684">err</span>&nbsp;<span class="op" id="8015688">!=</span>&nbsp;<span class="ident" id="8015691">nil</span>&nbsp;<span class="op" id="8015695">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015699">t</span><span class="op" id="8015700">.</span><span class="ident" id="8015701">Fatal</span><span class="op" id="8015706">(</span><span class="ident" id="8015707">err</span><span class="op" id="8015710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8015713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015717">r</span><span class="op" id="8015718">.</span><span class="ident" id="8015719">Close</span><span class="op" id="8015724">(</span><span class="op" id="8015725">)</span><br>
<span class="lineno"></span><span class="op" id="8015727">}</span><br>
<span class="lineno">620</span><br>
<span class="lineno"></span><span class="comment" id="8015730">//&nbsp;Tests&nbsp;fix&nbsp;for&nbsp;issue&nbsp;2788,&nbsp;that&nbsp;we&nbsp;bind&nbsp;nil&nbsp;to&nbsp;a&nbsp;[]byte&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="8015795">//&nbsp;value&nbsp;in&nbsp;the&nbsp;column&nbsp;is&nbsp;sql&nbsp;null</span><br>
<span class="lineno"></span><span class="keyword" id="8015830">func</span>&nbsp;<span class="ident" id="8015835">TestNullByteSlice</span><span class="op" id="8015852">(</span><span class="ident" id="8015853">t</span>&nbsp;<span class="op" id="8015855">*</span><span class="ident" id="8015856">testing</span><span class="op" id="8015863">.</span><span class="ident" id="8015864">T</span><span class="op" id="8015865">)</span>&nbsp;<span class="op" id="8015867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015870">db</span>&nbsp;<span class="op" id="8015873">:=</span>&nbsp;<span class="ident" id="8015876">newTestDB</span><span class="op" id="8015885">(</span><span class="ident" id="8015886">t</span><span class="op" id="8015887">,</span>&nbsp;<span class="string" id="8015889">&#34;&#34;</span><span class="op" id="8015891">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8015894">defer</span>&nbsp;<span class="ident" id="8015900">closeDB</span><span class="op" id="8015907">(</span><span class="ident" id="8015908">t</span><span class="op" id="8015909">,</span>&nbsp;<span class="ident" id="8015911">db</span><span class="op" id="8015913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015916">exec</span><span class="op" id="8015920">(</span><span class="ident" id="8015921">t</span><span class="op" id="8015922">,</span>&nbsp;<span class="ident" id="8015924">db</span><span class="op" id="8015926">,</span>&nbsp;<span class="string" id="8015928">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8015963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8015966">exec</span><span class="op" id="8015970">(</span><span class="ident" id="8015971">t</span><span class="op" id="8015972">,</span>&nbsp;<span class="ident" id="8015974">db</span><span class="op" id="8015976">,</span>&nbsp;<span class="string" id="8015978">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8016001">,</span>&nbsp;<span class="ident" id="8016003">nil</span><span class="op" id="8016006">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016010">var</span>&nbsp;<span class="ident" id="8016014">name</span>&nbsp;<span class="op" id="8016019">[</span><span class="op" id="8016020">]</span><span class="builtintype" id="8016021">byte</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016028">err</span>&nbsp;<span class="op" id="8016032">:=</span>&nbsp;<span class="ident" id="8016035">db</span><span class="op" id="8016037">.</span><span class="ident" id="8016038">QueryRow</span><span class="op" id="8016046">(</span><span class="string" id="8016047">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8016067">,</span>&nbsp;<span class="num" id="8016069">10</span><span class="op" id="8016071">)</span><span class="op" id="8016072">.</span><span class="ident" id="8016073">Scan</span><span class="op" id="8016077">(</span><span class="op" id="8016078">&amp;</span><span class="ident" id="8016079">name</span><span class="op" id="8016083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016086">if</span>&nbsp;<span class="ident" id="8016089">err</span>&nbsp;<span class="op" id="8016093">!=</span>&nbsp;<span class="ident" id="8016096">nil</span>&nbsp;<span class="op" id="8016100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016104">t</span><span class="op" id="8016105">.</span><span class="ident" id="8016106">Fatal</span><span class="op" id="8016111">(</span><span class="ident" id="8016112">err</span><span class="op" id="8016115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016118">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016121">if</span>&nbsp;<span class="ident" id="8016124">name</span>&nbsp;<span class="op" id="8016129">!=</span>&nbsp;<span class="ident" id="8016132">nil</span>&nbsp;<span class="op" id="8016136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016140">t</span><span class="op" id="8016141">.</span><span class="ident" id="8016142">Fatalf</span><span class="op" id="8016148">(</span><span class="string" id="8016149">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;nil&nbsp;for&nbsp;null&nbsp;column&nbsp;value,&nbsp;got:&nbsp;%#v&#34;</span><span class="op" id="8016208">,</span>&nbsp;<span class="ident" id="8016210">name</span><span class="op" id="8016214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016221">exec</span><span class="op" id="8016225">(</span><span class="ident" id="8016226">t</span><span class="op" id="8016227">,</span>&nbsp;<span class="ident" id="8016229">db</span><span class="op" id="8016231">,</span>&nbsp;<span class="string" id="8016233">&#34;INSERT|t|id=11,name=?&#34;</span><span class="op" id="8016256">,</span>&nbsp;<span class="string" id="8016258">&#34;bob&#34;</span><span class="op" id="8016263">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016266">err</span>&nbsp;<span class="op" id="8016270">=</span>&nbsp;<span class="ident" id="8016272">db</span><span class="op" id="8016274">.</span><span class="ident" id="8016275">QueryRow</span><span class="op" id="8016283">(</span><span class="string" id="8016284">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8016304">,</span>&nbsp;<span class="num" id="8016306">11</span><span class="op" id="8016308">)</span><span class="op" id="8016309">.</span><span class="ident" id="8016310">Scan</span><span class="op" id="8016314">(</span><span class="op" id="8016315">&amp;</span><span class="ident" id="8016316">name</span><span class="op" id="8016320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016323">if</span>&nbsp;<span class="ident" id="8016326">err</span>&nbsp;<span class="op" id="8016330">!=</span>&nbsp;<span class="ident" id="8016333">nil</span>&nbsp;<span class="op" id="8016337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016341">t</span><span class="op" id="8016342">.</span><span class="ident" id="8016343">Fatal</span><span class="op" id="8016348">(</span><span class="ident" id="8016349">err</span><span class="op" id="8016352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016358">if</span>&nbsp;<span class="builtintype" id="8016361">string</span><span class="op" id="8016367">(</span><span class="ident" id="8016368">name</span><span class="op" id="8016372">)</span>&nbsp;<span class="op" id="8016374">!=</span>&nbsp;<span class="string" id="8016377">&#34;bob&#34;</span>&nbsp;<span class="op" id="8016383">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016387">t</span><span class="op" id="8016388">.</span><span class="ident" id="8016389">Fatalf</span><span class="op" id="8016395">(</span><span class="string" id="8016396">&#34;name&nbsp;[]byte&nbsp;should&nbsp;be&nbsp;bob,&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="8016432">,</span>&nbsp;<span class="builtintype" id="8016434">string</span><span class="op" id="8016440">(</span><span class="ident" id="8016441">name</span><span class="op" id="8016445">)</span><span class="op" id="8016446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016449">}</span><br>
<span class="lineno"></span><span class="op" id="8016451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8016454">func</span>&nbsp;<span class="ident" id="8016459">TestPointerParamsAndScans</span><span class="op" id="8016484">(</span><span class="ident" id="8016485">t</span>&nbsp;<span class="op" id="8016487">*</span><span class="ident" id="8016488">testing</span><span class="op" id="8016495">.</span><span class="ident" id="8016496">T</span><span class="op" id="8016497">)</span>&nbsp;<span class="op" id="8016499">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016502">db</span>&nbsp;<span class="op" id="8016505">:=</span>&nbsp;<span class="ident" id="8016508">newTestDB</span><span class="op" id="8016517">(</span><span class="ident" id="8016518">t</span><span class="op" id="8016519">,</span>&nbsp;<span class="string" id="8016521">&#34;&#34;</span><span class="op" id="8016523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016526">defer</span>&nbsp;<span class="ident" id="8016532">closeDB</span><span class="op" id="8016539">(</span><span class="ident" id="8016540">t</span><span class="op" id="8016541">,</span>&nbsp;<span class="ident" id="8016543">db</span><span class="op" id="8016545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016548">exec</span><span class="op" id="8016552">(</span><span class="ident" id="8016553">t</span><span class="op" id="8016554">,</span>&nbsp;<span class="ident" id="8016556">db</span><span class="op" id="8016558">,</span>&nbsp;<span class="string" id="8016560">&#34;CREATE|t|id=int32,name=nullstring&#34;</span><span class="op" id="8016595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016599">bob</span>&nbsp;<span class="op" id="8016603">:=</span>&nbsp;<span class="string" id="8016606">&#34;bob&#34;</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016613">var</span>&nbsp;<span class="ident" id="8016617">name</span>&nbsp;<span class="op" id="8016622">*</span><span class="builtintype" id="8016623">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016632">name</span>&nbsp;<span class="op" id="8016637">=</span>&nbsp;<span class="op" id="8016639">&amp;</span><span class="ident" id="8016640">bob</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016645">exec</span><span class="op" id="8016649">(</span><span class="ident" id="8016650">t</span><span class="op" id="8016651">,</span>&nbsp;<span class="ident" id="8016653">db</span><span class="op" id="8016655">,</span>&nbsp;<span class="string" id="8016657">&#34;INSERT|t|id=10,name=?&#34;</span><span class="op" id="8016680">,</span>&nbsp;<span class="ident" id="8016682">name</span><span class="op" id="8016686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016689">name</span>&nbsp;<span class="op" id="8016694">=</span>&nbsp;<span class="ident" id="8016696">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016701">exec</span><span class="op" id="8016705">(</span><span class="ident" id="8016706">t</span><span class="op" id="8016707">,</span>&nbsp;<span class="ident" id="8016709">db</span><span class="op" id="8016711">,</span>&nbsp;<span class="string" id="8016713">&#34;INSERT|t|id=20,name=?&#34;</span><span class="op" id="8016736">,</span>&nbsp;<span class="ident" id="8016738">name</span><span class="op" id="8016742">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016746">err</span>&nbsp;<span class="op" id="8016750">:=</span>&nbsp;<span class="ident" id="8016753">db</span><span class="op" id="8016755">.</span><span class="ident" id="8016756">QueryRow</span><span class="op" id="8016764">(</span><span class="string" id="8016765">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8016785">,</span>&nbsp;<span class="num" id="8016787">10</span><span class="op" id="8016789">)</span><span class="op" id="8016790">.</span><span class="ident" id="8016791">Scan</span><span class="op" id="8016795">(</span><span class="op" id="8016796">&amp;</span><span class="ident" id="8016797">name</span><span class="op" id="8016801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016804">if</span>&nbsp;<span class="ident" id="8016807">err</span>&nbsp;<span class="op" id="8016811">!=</span>&nbsp;<span class="ident" id="8016814">nil</span>&nbsp;<span class="op" id="8016818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016822">t</span><span class="op" id="8016823">.</span><span class="ident" id="8016824">Fatalf</span><span class="op" id="8016830">(</span><span class="string" id="8016831">&#34;querying&nbsp;id&nbsp;10:&nbsp;%v&#34;</span><span class="op" id="8016851">,</span>&nbsp;<span class="ident" id="8016853">err</span><span class="op" id="8016856">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8016862">if</span>&nbsp;<span class="ident" id="8016865">name</span>&nbsp;<span class="op" id="8016870">==</span>&nbsp;<span class="ident" id="8016873">nil</span>&nbsp;<span class="op" id="8016877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016881">t</span><span class="op" id="8016882">.</span><span class="ident" id="8016883">Errorf</span><span class="op" id="8016889">(</span><span class="string" id="8016890">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;nil;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8016920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8016923">}</span>&nbsp;<span class="keyword" id="8016925">else</span>&nbsp;<span class="keyword" id="8016930">if</span>&nbsp;<span class="op" id="8016933">*</span><span class="ident" id="8016934">name</span>&nbsp;<span class="op" id="8016939">!=</span>&nbsp;<span class="string" id="8016942">&#34;bob&#34;</span>&nbsp;<span class="op" id="8016948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8016952">t</span><span class="op" id="8016953">.</span><span class="ident" id="8016954">Errorf</span><span class="op" id="8016960">(</span><span class="string" id="8016961">&#34;id&nbsp;10&#39;s&nbsp;name&nbsp;=&nbsp;%q;&nbsp;want&nbsp;bob&#34;</span><span class="op" id="8016990">,</span>&nbsp;<span class="op" id="8016992">*</span><span class="ident" id="8016993">name</span><span class="op" id="8016997">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017004">err</span>&nbsp;<span class="op" id="8017008">=</span>&nbsp;<span class="ident" id="8017010">db</span><span class="op" id="8017012">.</span><span class="ident" id="8017013">QueryRow</span><span class="op" id="8017021">(</span><span class="string" id="8017022">&#34;SELECT|t|name|id=?&#34;</span><span class="op" id="8017042">,</span>&nbsp;<span class="num" id="8017044">20</span><span class="op" id="8017046">)</span><span class="op" id="8017047">.</span><span class="ident" id="8017048">Scan</span><span class="op" id="8017052">(</span><span class="op" id="8017053">&amp;</span><span class="ident" id="8017054">name</span><span class="op" id="8017058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017061">if</span>&nbsp;<span class="ident" id="8017064">err</span>&nbsp;<span class="op" id="8017068">!=</span>&nbsp;<span class="ident" id="8017071">nil</span>&nbsp;<span class="op" id="8017075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017079">t</span><span class="op" id="8017080">.</span><span class="ident" id="8017081">Fatalf</span><span class="op" id="8017087">(</span><span class="string" id="8017088">&#34;querying&nbsp;id&nbsp;20:&nbsp;%v&#34;</span><span class="op" id="8017108">,</span>&nbsp;<span class="ident" id="8017110">err</span><span class="op" id="8017113">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017119">if</span>&nbsp;<span class="ident" id="8017122">name</span>&nbsp;<span class="op" id="8017127">!=</span>&nbsp;<span class="ident" id="8017130">nil</span>&nbsp;<span class="op" id="8017134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017138">t</span><span class="op" id="8017139">.</span><span class="ident" id="8017140">Errorf</span><span class="op" id="8017146">(</span><span class="string" id="8017147">&#34;id&nbsp;20&nbsp;=&nbsp;%q;&nbsp;want&nbsp;nil&#34;</span><span class="op" id="8017169">,</span>&nbsp;<span class="op" id="8017171">*</span><span class="ident" id="8017172">name</span><span class="op" id="8017176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017179">}</span><br>
<span class="lineno"></span><span class="op" id="8017181">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="8017184">func</span>&nbsp;<span class="ident" id="8017189">TestQueryRowClosingStmt</span><span class="op" id="8017212">(</span><span class="ident" id="8017213">t</span>&nbsp;<span class="op" id="8017215">*</span><span class="ident" id="8017216">testing</span><span class="op" id="8017223">.</span><span class="ident" id="8017224">T</span><span class="op" id="8017225">)</span>&nbsp;<span class="op" id="8017227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017230">db</span>&nbsp;<span class="op" id="8017233">:=</span>&nbsp;<span class="ident" id="8017236">newTestDB</span><span class="op" id="8017245">(</span><span class="ident" id="8017246">t</span><span class="op" id="8017247">,</span>&nbsp;<span class="string" id="8017249">&#34;people&#34;</span><span class="op" id="8017257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017260">defer</span>&nbsp;<span class="ident" id="8017266">closeDB</span><span class="op" id="8017273">(</span><span class="ident" id="8017274">t</span><span class="op" id="8017275">,</span>&nbsp;<span class="ident" id="8017277">db</span><span class="op" id="8017279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017282">var</span>&nbsp;<span class="ident" id="8017286">name</span>&nbsp;<span class="builtintype" id="8017291">string</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017299">var</span>&nbsp;<span class="ident" id="8017303">age</span>&nbsp;<span class="builtintype" id="8017307">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017312">err</span>&nbsp;<span class="op" id="8017316">:=</span>&nbsp;<span class="ident" id="8017319">db</span><span class="op" id="8017321">.</span><span class="ident" id="8017322">QueryRow</span><span class="op" id="8017330">(</span><span class="string" id="8017331">&#34;SELECT|people|age,name|age=?&#34;</span><span class="op" id="8017361">,</span>&nbsp;<span class="num" id="8017363">3</span><span class="op" id="8017364">)</span><span class="op" id="8017365">.</span><span class="ident" id="8017366">Scan</span><span class="op" id="8017370">(</span><span class="op" id="8017371">&amp;</span><span class="ident" id="8017372">age</span><span class="op" id="8017375">,</span>&nbsp;<span class="op" id="8017377">&amp;</span><span class="ident" id="8017378">name</span><span class="op" id="8017382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017385">if</span>&nbsp;<span class="ident" id="8017388">err</span>&nbsp;<span class="op" id="8017392">!=</span>&nbsp;<span class="ident" id="8017395">nil</span>&nbsp;<span class="op" id="8017399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017403">t</span><span class="op" id="8017404">.</span><span class="ident" id="8017405">Fatal</span><span class="op" id="8017410">(</span><span class="ident" id="8017411">err</span><span class="op" id="8017414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017417">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017420">if</span>&nbsp;<span class="builtinfunc" id="8017423">len</span><span class="op" id="8017426">(</span><span class="ident" id="8017427">db</span><span class="op" id="8017429">.</span><span class="ident" id="8017430">freeConn</span><span class="op" id="8017438">)</span>&nbsp;<span class="op" id="8017440">!=</span>&nbsp;<span class="num" id="8017443">1</span>&nbsp;<span class="op" id="8017445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017449">t</span><span class="op" id="8017450">.</span><span class="ident" id="8017451">Fatalf</span><span class="op" id="8017457">(</span><span class="string" id="8017458">&#34;expected&nbsp;1&nbsp;free&nbsp;conn&#34;</span><span class="op" id="8017480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017486">fakeConn</span>&nbsp;<span class="op" id="8017495">:=</span>&nbsp;<span class="ident" id="8017498">db</span><span class="op" id="8017500">.</span><span class="ident" id="8017501">freeConn</span><span class="op" id="8017509">[</span><span class="num" id="8017510">0</span><span class="op" id="8017511">]</span><span class="op" id="8017512">.</span><span class="ident" id="8017513">ci</span><span class="op" id="8017515">.</span><span class="op" id="8017516">(</span><span class="op" id="8017517">*</span><span class="ident" id="8017518">fakeConn</span><span class="op" id="8017526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017529">if</span>&nbsp;<span class="ident" id="8017532">made</span><span class="op" id="8017536">,</span>&nbsp;<span class="ident" id="8017538">closed</span>&nbsp;<span class="op" id="8017545">:=</span>&nbsp;<span class="ident" id="8017548">fakeConn</span><span class="op" id="8017556">.</span><span class="ident" id="8017557">stmtsMade</span><span class="op" id="8017566">,</span>&nbsp;<span class="ident" id="8017568">fakeConn</span><span class="op" id="8017576">.</span><span class="ident" id="8017577">stmtsClosed</span><span class="op" id="8017588">;</span>&nbsp;<span class="ident" id="8017590">made</span>&nbsp;<span class="op" id="8017595">!=</span>&nbsp;<span class="ident" id="8017598">closed</span>&nbsp;<span class="op" id="8017605">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017609">t</span><span class="op" id="8017610">.</span><span class="ident" id="8017611">Errorf</span><span class="op" id="8017617">(</span><span class="string" id="8017618">&#34;statement&nbsp;close&nbsp;mismatch:&nbsp;made&nbsp;%d,&nbsp;closed&nbsp;%d&#34;</span><span class="op" id="8017664">,</span>&nbsp;<span class="ident" id="8017666">made</span><span class="op" id="8017670">,</span>&nbsp;<span class="ident" id="8017672">closed</span><span class="op" id="8017678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017681">}</span><br>
<span class="lineno"></span><span class="op" id="8017683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8017686">//&nbsp;Test&nbsp;issue&nbsp;6651</span><br>
<span class="lineno">700</span><span class="keyword" id="8017705">func</span>&nbsp;<span class="ident" id="8017710">TestIssue6651</span><span class="op" id="8017723">(</span><span class="ident" id="8017724">t</span>&nbsp;<span class="op" id="8017726">*</span><span class="ident" id="8017727">testing</span><span class="op" id="8017734">.</span><span class="ident" id="8017735">T</span><span class="op" id="8017736">)</span>&nbsp;<span class="op" id="8017738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017741">db</span>&nbsp;<span class="op" id="8017744">:=</span>&nbsp;<span class="ident" id="8017747">newTestDB</span><span class="op" id="8017756">(</span><span class="ident" id="8017757">t</span><span class="op" id="8017758">,</span>&nbsp;<span class="string" id="8017760">&#34;people&#34;</span><span class="op" id="8017768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017771">defer</span>&nbsp;<span class="ident" id="8017777">closeDB</span><span class="op" id="8017784">(</span><span class="ident" id="8017785">t</span><span class="op" id="8017786">,</span>&nbsp;<span class="ident" id="8017788">db</span><span class="op" id="8017790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017794">var</span>&nbsp;<span class="ident" id="8017798">v</span>&nbsp;<span class="builtintype" id="8017800">string</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017809">want</span>&nbsp;<span class="op" id="8017814">:=</span>&nbsp;<span class="string" id="8017817">&#34;error&nbsp;in&nbsp;rows.Next&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017839">rowsCursorNextHook</span>&nbsp;<span class="op" id="8017858">=</span>&nbsp;<span class="keyword" id="8017860">func</span><span class="op" id="8017864">(</span><span class="ident" id="8017865">dest</span>&nbsp;<span class="op" id="8017870">[</span><span class="op" id="8017871">]</span><span class="ident" id="8017872">driver</span><span class="op" id="8017878">.</span><span class="ident" id="8017879">Value</span><span class="op" id="8017884">)</span>&nbsp;<span class="builtintype" id="8017886">error</span>&nbsp;<span class="op" id="8017892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017896">return</span>&nbsp;<span class="ident" id="8017903">fmt</span><span class="op" id="8017906">.</span><span class="ident" id="8017907">Errorf</span><span class="op" id="8017913">(</span><span class="ident" id="8017914">want</span><span class="op" id="8017918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8017921">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8017924">defer</span>&nbsp;<span class="keyword" id="8017930">func</span><span class="op" id="8017934">(</span><span class="op" id="8017935">)</span>&nbsp;<span class="op" id="8017937">{</span>&nbsp;<span class="ident" id="8017939">rowsCursorNextHook</span>&nbsp;<span class="op" id="8017958">=</span>&nbsp;<span class="ident" id="8017960">nil</span>&nbsp;<span class="op" id="8017964">}</span><span class="op" id="8017965">(</span><span class="op" id="8017966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8017969">err</span>&nbsp;<span class="op" id="8017973">:=</span>&nbsp;<span class="ident" id="8017976">db</span><span class="op" id="8017978">.</span><span class="ident" id="8017979">QueryRow</span><span class="op" id="8017987">(</span><span class="string" id="8017988">&#34;SELECT|people|name|&#34;</span><span class="op" id="8018009">)</span><span class="op" id="8018010">.</span><span class="ident" id="8018011">Scan</span><span class="op" id="8018015">(</span><span class="op" id="8018016">&amp;</span><span class="ident" id="8018017">v</span><span class="op" id="8018018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8018021">if</span>&nbsp;<span class="ident" id="8018024">err</span>&nbsp;<span class="op" id="8018028">==</span>&nbsp;<span class="ident" id="8018031">nil</span>&nbsp;<span class="op" id="8018035">||</span>&nbsp;<span class="ident" id="8018038">err</span><span class="op" id="8018041">.</span><span class="ident" id="8018042">Error</span><span class="op" id="8018047">(</span><span class="op" id="8018048">)</span>&nbsp;<span class="op" id="8018050">!=</span>&nbsp;<span class="ident" id="8018053">want</span>&nbsp;<span class="op" id="8018058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018062">t</span><span class="op" id="8018063">.</span><span class="ident" id="8018064">Errorf</span><span class="op" id="8018070">(</span><span class="string" id="8018071">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8018092">,</span>&nbsp;<span class="ident" id="8018094">err</span><span class="op" id="8018097">,</span>&nbsp;<span class="ident" id="8018099">want</span><span class="op" id="8018103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018106">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018109">rowsCursorNextHook</span>&nbsp;<span class="op" id="8018128">=</span>&nbsp;<span class="ident" id="8018130">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018136">want</span>&nbsp;<span class="op" id="8018141">=</span>&nbsp;<span class="string" id="8018143">&#34;error&nbsp;in&nbsp;rows.Close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018166">rowsCloseHook</span>&nbsp;<span class="op" id="8018180">=</span>&nbsp;<span class="keyword" id="8018182">func</span><span class="op" id="8018186">(</span><span class="ident" id="8018187">rows</span>&nbsp;<span class="op" id="8018192">*</span><span class="ident" id="8018193">Rows</span><span class="op" id="8018197">,</span>&nbsp;<span class="ident" id="8018199">err</span>&nbsp;<span class="op" id="8018203">*</span><span class="builtintype" id="8018204">error</span><span class="op" id="8018209">)</span>&nbsp;<span class="op" id="8018211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018215">*</span><span class="ident" id="8018216">err</span>&nbsp;<span class="op" id="8018220">=</span>&nbsp;<span class="ident" id="8018222">fmt</span><span class="op" id="8018225">.</span><span class="ident" id="8018226">Errorf</span><span class="op" id="8018232">(</span><span class="ident" id="8018233">want</span><span class="op" id="8018237">)</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8018243">defer</span>&nbsp;<span class="keyword" id="8018249">func</span><span class="op" id="8018253">(</span><span class="op" id="8018254">)</span>&nbsp;<span class="op" id="8018256">{</span>&nbsp;<span class="ident" id="8018258">rowsCloseHook</span>&nbsp;<span class="op" id="8018272">=</span>&nbsp;<span class="ident" id="8018274">nil</span>&nbsp;<span class="op" id="8018278">}</span><span class="op" id="8018279">(</span><span class="op" id="8018280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018283">err</span>&nbsp;<span class="op" id="8018287">=</span>&nbsp;<span class="ident" id="8018289">db</span><span class="op" id="8018291">.</span><span class="ident" id="8018292">QueryRow</span><span class="op" id="8018300">(</span><span class="string" id="8018301">&#34;SELECT|people|name|&#34;</span><span class="op" id="8018322">)</span><span class="op" id="8018323">.</span><span class="ident" id="8018324">Scan</span><span class="op" id="8018328">(</span><span class="op" id="8018329">&amp;</span><span class="ident" id="8018330">v</span><span class="op" id="8018331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8018334">if</span>&nbsp;<span class="ident" id="8018337">err</span>&nbsp;<span class="op" id="8018341">==</span>&nbsp;<span class="ident" id="8018344">nil</span>&nbsp;<span class="op" id="8018348">||</span>&nbsp;<span class="ident" id="8018351">err</span><span class="op" id="8018354">.</span><span class="ident" id="8018355">Error</span><span class="op" id="8018360">(</span><span class="op" id="8018361">)</span>&nbsp;<span class="op" id="8018363">!=</span>&nbsp;<span class="ident" id="8018366">want</span>&nbsp;<span class="op" id="8018371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018375">t</span><span class="op" id="8018376">.</span><span class="ident" id="8018377">Errorf</span><span class="op" id="8018383">(</span><span class="string" id="8018384">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8018405">,</span>&nbsp;<span class="ident" id="8018407">err</span><span class="op" id="8018410">,</span>&nbsp;<span class="ident" id="8018412">want</span><span class="op" id="8018416">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018419">}</span><br>
<span class="lineno"></span><span class="op" id="8018421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8018424">type</span>&nbsp;<span class="ident" id="8018429">nullTestRow</span>&nbsp;<span class="keyword" id="8018441">struct</span>&nbsp;<span class="op" id="8018448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018451">nullParam</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="8018464">interface</span><span class="op" id="8018473">{</span><span class="op" id="8018474">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018477">notNullParam</span>&nbsp;<span class="keyword" id="8018490">interface</span><span class="op" id="8018499">{</span><span class="op" id="8018500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018503">scanNullVal</span>&nbsp;&nbsp;<span class="keyword" id="8018516">interface</span><span class="op" id="8018525">{</span><span class="op" id="8018526">}</span><br>
<span class="lineno"></span><span class="op" id="8018528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8018531">type</span>&nbsp;<span class="ident" id="8018536">nullTestSpec</span>&nbsp;<span class="keyword" id="8018549">struct</span>&nbsp;<span class="op" id="8018556">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018559">nullType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8018571">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018579">notNullType</span>&nbsp;<span class="builtintype" id="8018591">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018599">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8018611">[</span><span class="num" id="8018612">6</span><span class="op" id="8018613">]</span><span class="ident" id="8018614">nullTestRow</span><br>
<span class="lineno"></span><span class="op" id="8018626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">740</span><span class="keyword" id="8018629">func</span>&nbsp;<span class="ident" id="8018634">TestNullStringParam</span><span class="op" id="8018653">(</span><span class="ident" id="8018654">t</span>&nbsp;<span class="op" id="8018656">*</span><span class="ident" id="8018657">testing</span><span class="op" id="8018664">.</span><span class="ident" id="8018665">T</span><span class="op" id="8018666">)</span>&nbsp;<span class="op" id="8018668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8018671">spec</span>&nbsp;<span class="op" id="8018676">:=</span>&nbsp;<span class="ident" id="8018679">nullTestSpec</span><span class="op" id="8018691">{</span><span class="string" id="8018692">&#34;nullstring&#34;</span><span class="op" id="8018704">,</span>&nbsp;<span class="string" id="8018706">&#34;string&#34;</span><span class="op" id="8018714">,</span>&nbsp;<span class="op" id="8018716">[</span><span class="num" id="8018717">6</span><span class="op" id="8018718">]</span><span class="ident" id="8018719">nullTestRow</span><span class="op" id="8018730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018734">{</span><span class="ident" id="8018735">NullString</span><span class="op" id="8018745">{</span><span class="string" id="8018746">&#34;aqua&#34;</span><span class="op" id="8018752">,</span>&nbsp;<span class="builtintype" id="8018754">true</span><span class="op" id="8018758">}</span><span class="op" id="8018759">,</span>&nbsp;<span class="string" id="8018761">&#34;&#34;</span><span class="op" id="8018763">,</span>&nbsp;<span class="ident" id="8018765">NullString</span><span class="op" id="8018775">{</span><span class="string" id="8018776">&#34;aqua&#34;</span><span class="op" id="8018782">,</span>&nbsp;<span class="builtintype" id="8018784">true</span><span class="op" id="8018788">}</span><span class="op" id="8018789">}</span><span class="op" id="8018790">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018794">{</span><span class="ident" id="8018795">NullString</span><span class="op" id="8018805">{</span><span class="string" id="8018806">&#34;brown&#34;</span><span class="op" id="8018813">,</span>&nbsp;<span class="builtintype" id="8018815">false</span><span class="op" id="8018820">}</span><span class="op" id="8018821">,</span>&nbsp;<span class="string" id="8018823">&#34;&#34;</span><span class="op" id="8018825">,</span>&nbsp;<span class="ident" id="8018827">NullString</span><span class="op" id="8018837">{</span><span class="string" id="8018838">&#34;&#34;</span><span class="op" id="8018840">,</span>&nbsp;<span class="builtintype" id="8018842">false</span><span class="op" id="8018847">}</span><span class="op" id="8018848">}</span><span class="op" id="8018849">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018853">{</span><span class="string" id="8018854">&#34;chartreuse&#34;</span><span class="op" id="8018866">,</span>&nbsp;<span class="string" id="8018868">&#34;&#34;</span><span class="op" id="8018870">,</span>&nbsp;<span class="ident" id="8018872">NullString</span><span class="op" id="8018882">{</span><span class="string" id="8018883">&#34;chartreuse&#34;</span><span class="op" id="8018895">,</span>&nbsp;<span class="builtintype" id="8018897">true</span><span class="op" id="8018901">}</span><span class="op" id="8018902">}</span><span class="op" id="8018903">,</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018907">{</span><span class="ident" id="8018908">NullString</span><span class="op" id="8018918">{</span><span class="string" id="8018919">&#34;darkred&#34;</span><span class="op" id="8018928">,</span>&nbsp;<span class="builtintype" id="8018930">true</span><span class="op" id="8018934">}</span><span class="op" id="8018935">,</span>&nbsp;<span class="string" id="8018937">&#34;&#34;</span><span class="op" id="8018939">,</span>&nbsp;<span class="ident" id="8018941">NullString</span><span class="op" id="8018951">{</span><span class="string" id="8018952">&#34;darkred&#34;</span><span class="op" id="8018961">,</span>&nbsp;<span class="builtintype" id="8018963">true</span><span class="op" id="8018967">}</span><span class="op" id="8018968">}</span><span class="op" id="8018969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8018973">{</span><span class="ident" id="8018974">NullString</span><span class="op" id="8018984">{</span><span class="string" id="8018985">&#34;eel&#34;</span><span class="op" id="8018990">,</span>&nbsp;<span class="builtintype" id="8018992">false</span><span class="op" id="8018997">}</span><span class="op" id="8018998">,</span>&nbsp;<span class="string" id="8019000">&#34;&#34;</span><span class="op" id="8019002">,</span>&nbsp;<span class="ident" id="8019004">NullString</span><span class="op" id="8019014">{</span><span class="string" id="8019015">&#34;&#34;</span><span class="op" id="8019017">,</span>&nbsp;<span class="builtintype" id="8019019">false</span><span class="op" id="8019024">}</span><span class="op" id="8019025">}</span><span class="op" id="8019026">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019030">{</span><span class="string" id="8019031">&#34;foo&#34;</span><span class="op" id="8019036">,</span>&nbsp;<span class="ident" id="8019038">NullString</span><span class="op" id="8019048">{</span><span class="string" id="8019049">&#34;black&#34;</span><span class="op" id="8019056">,</span>&nbsp;<span class="builtintype" id="8019058">false</span><span class="op" id="8019063">}</span><span class="op" id="8019064">,</span>&nbsp;<span class="ident" id="8019066">nil</span><span class="op" id="8019069">}</span><span class="op" id="8019070">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019073">}</span><span class="op" id="8019074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019077">nullTestRun</span><span class="op" id="8019088">(</span><span class="ident" id="8019089">t</span><span class="op" id="8019090">,</span>&nbsp;<span class="ident" id="8019092">spec</span><span class="op" id="8019096">)</span><br>
<span class="lineno">750</span><span class="op" id="8019098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8019101">func</span>&nbsp;<span class="ident" id="8019106">TestNullInt64Param</span><span class="op" id="8019124">(</span><span class="ident" id="8019125">t</span>&nbsp;<span class="op" id="8019127">*</span><span class="ident" id="8019128">testing</span><span class="op" id="8019135">.</span><span class="ident" id="8019136">T</span><span class="op" id="8019137">)</span>&nbsp;<span class="op" id="8019139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019142">spec</span>&nbsp;<span class="op" id="8019147">:=</span>&nbsp;<span class="ident" id="8019150">nullTestSpec</span><span class="op" id="8019162">{</span><span class="string" id="8019163">&#34;nullint64&#34;</span><span class="op" id="8019174">,</span>&nbsp;<span class="string" id="8019176">&#34;int64&#34;</span><span class="op" id="8019183">,</span>&nbsp;<span class="op" id="8019185">[</span><span class="num" id="8019186">6</span><span class="op" id="8019187">]</span><span class="ident" id="8019188">nullTestRow</span><span class="op" id="8019199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019203">{</span><span class="ident" id="8019204">NullInt64</span><span class="op" id="8019213">{</span><span class="num" id="8019214">31</span><span class="op" id="8019216">,</span>&nbsp;<span class="builtintype" id="8019218">true</span><span class="op" id="8019222">}</span><span class="op" id="8019223">,</span>&nbsp;<span class="num" id="8019225">1</span><span class="op" id="8019226">,</span>&nbsp;<span class="ident" id="8019228">NullInt64</span><span class="op" id="8019237">{</span><span class="num" id="8019238">31</span><span class="op" id="8019240">,</span>&nbsp;<span class="builtintype" id="8019242">true</span><span class="op" id="8019246">}</span><span class="op" id="8019247">}</span><span class="op" id="8019248">,</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019252">{</span><span class="ident" id="8019253">NullInt64</span><span class="op" id="8019262">{</span><span class="op" id="8019263">-</span><span class="num" id="8019264">22</span><span class="op" id="8019266">,</span>&nbsp;<span class="builtintype" id="8019268">false</span><span class="op" id="8019273">}</span><span class="op" id="8019274">,</span>&nbsp;<span class="num" id="8019276">1</span><span class="op" id="8019277">,</span>&nbsp;<span class="ident" id="8019279">NullInt64</span><span class="op" id="8019288">{</span><span class="num" id="8019289">0</span><span class="op" id="8019290">,</span>&nbsp;<span class="builtintype" id="8019292">false</span><span class="op" id="8019297">}</span><span class="op" id="8019298">}</span><span class="op" id="8019299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019303">{</span><span class="num" id="8019304">22</span><span class="op" id="8019306">,</span>&nbsp;<span class="num" id="8019308">1</span><span class="op" id="8019309">,</span>&nbsp;<span class="ident" id="8019311">NullInt64</span><span class="op" id="8019320">{</span><span class="num" id="8019321">22</span><span class="op" id="8019323">,</span>&nbsp;<span class="builtintype" id="8019325">true</span><span class="op" id="8019329">}</span><span class="op" id="8019330">}</span><span class="op" id="8019331">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019335">{</span><span class="ident" id="8019336">NullInt64</span><span class="op" id="8019345">{</span><span class="num" id="8019346">33</span><span class="op" id="8019348">,</span>&nbsp;<span class="builtintype" id="8019350">true</span><span class="op" id="8019354">}</span><span class="op" id="8019355">,</span>&nbsp;<span class="num" id="8019357">1</span><span class="op" id="8019358">,</span>&nbsp;<span class="ident" id="8019360">NullInt64</span><span class="op" id="8019369">{</span><span class="num" id="8019370">33</span><span class="op" id="8019372">,</span>&nbsp;<span class="builtintype" id="8019374">true</span><span class="op" id="8019378">}</span><span class="op" id="8019379">}</span><span class="op" id="8019380">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019384">{</span><span class="ident" id="8019385">NullInt64</span><span class="op" id="8019394">{</span><span class="num" id="8019395">222</span><span class="op" id="8019398">,</span>&nbsp;<span class="builtintype" id="8019400">false</span><span class="op" id="8019405">}</span><span class="op" id="8019406">,</span>&nbsp;<span class="num" id="8019408">1</span><span class="op" id="8019409">,</span>&nbsp;<span class="ident" id="8019411">NullInt64</span><span class="op" id="8019420">{</span><span class="num" id="8019421">0</span><span class="op" id="8019422">,</span>&nbsp;<span class="builtintype" id="8019424">false</span><span class="op" id="8019429">}</span><span class="op" id="8019430">}</span><span class="op" id="8019431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019435">{</span><span class="num" id="8019436">0</span><span class="op" id="8019437">,</span>&nbsp;<span class="ident" id="8019439">NullInt64</span><span class="op" id="8019448">{</span><span class="num" id="8019449">31</span><span class="op" id="8019451">,</span>&nbsp;<span class="builtintype" id="8019453">false</span><span class="op" id="8019458">}</span><span class="op" id="8019459">,</span>&nbsp;<span class="ident" id="8019461">nil</span><span class="op" id="8019464">}</span><span class="op" id="8019465">,</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019468">}</span><span class="op" id="8019469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019472">nullTestRun</span><span class="op" id="8019483">(</span><span class="ident" id="8019484">t</span><span class="op" id="8019485">,</span>&nbsp;<span class="ident" id="8019487">spec</span><span class="op" id="8019491">)</span><br>
<span class="lineno"></span><span class="op" id="8019493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8019496">func</span>&nbsp;<span class="ident" id="8019501">TestNullFloat64Param</span><span class="op" id="8019521">(</span><span class="ident" id="8019522">t</span>&nbsp;<span class="op" id="8019524">*</span><span class="ident" id="8019525">testing</span><span class="op" id="8019532">.</span><span class="ident" id="8019533">T</span><span class="op" id="8019534">)</span>&nbsp;<span class="op" id="8019536">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019539">spec</span>&nbsp;<span class="op" id="8019544">:=</span>&nbsp;<span class="ident" id="8019547">nullTestSpec</span><span class="op" id="8019559">{</span><span class="string" id="8019560">&#34;nullfloat64&#34;</span><span class="op" id="8019573">,</span>&nbsp;<span class="string" id="8019575">&#34;float64&#34;</span><span class="op" id="8019584">,</span>&nbsp;<span class="op" id="8019586">[</span><span class="num" id="8019587">6</span><span class="op" id="8019588">]</span><span class="ident" id="8019589">nullTestRow</span><span class="op" id="8019600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019604">{</span><span class="ident" id="8019605">NullFloat64</span><span class="op" id="8019616">{</span><span class="num" id="8019617">31.2</span><span class="op" id="8019621">,</span>&nbsp;<span class="builtintype" id="8019623">true</span><span class="op" id="8019627">}</span><span class="op" id="8019628">,</span>&nbsp;<span class="num" id="8019630">1</span><span class="op" id="8019631">,</span>&nbsp;<span class="ident" id="8019633">NullFloat64</span><span class="op" id="8019644">{</span><span class="num" id="8019645">31.2</span><span class="op" id="8019649">,</span>&nbsp;<span class="builtintype" id="8019651">true</span><span class="op" id="8019655">}</span><span class="op" id="8019656">}</span><span class="op" id="8019657">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019661">{</span><span class="ident" id="8019662">NullFloat64</span><span class="op" id="8019673">{</span><span class="num" id="8019674">13.1</span><span class="op" id="8019678">,</span>&nbsp;<span class="builtintype" id="8019680">false</span><span class="op" id="8019685">}</span><span class="op" id="8019686">,</span>&nbsp;<span class="num" id="8019688">1</span><span class="op" id="8019689">,</span>&nbsp;<span class="ident" id="8019691">NullFloat64</span><span class="op" id="8019702">{</span><span class="num" id="8019703">0</span><span class="op" id="8019704">,</span>&nbsp;<span class="builtintype" id="8019706">false</span><span class="op" id="8019711">}</span><span class="op" id="8019712">}</span><span class="op" id="8019713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019717">{</span><span class="op" id="8019718">-</span><span class="num" id="8019719">22.9</span><span class="op" id="8019723">,</span>&nbsp;<span class="num" id="8019725">1</span><span class="op" id="8019726">,</span>&nbsp;<span class="ident" id="8019728">NullFloat64</span><span class="op" id="8019739">{</span><span class="op" id="8019740">-</span><span class="num" id="8019741">22.9</span><span class="op" id="8019745">,</span>&nbsp;<span class="builtintype" id="8019747">true</span><span class="op" id="8019751">}</span><span class="op" id="8019752">}</span><span class="op" id="8019753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019757">{</span><span class="ident" id="8019758">NullFloat64</span><span class="op" id="8019769">{</span><span class="num" id="8019770">33.81</span><span class="op" id="8019775">,</span>&nbsp;<span class="builtintype" id="8019777">true</span><span class="op" id="8019781">}</span><span class="op" id="8019782">,</span>&nbsp;<span class="num" id="8019784">1</span><span class="op" id="8019785">,</span>&nbsp;<span class="ident" id="8019787">NullFloat64</span><span class="op" id="8019798">{</span><span class="num" id="8019799">33.81</span><span class="op" id="8019804">,</span>&nbsp;<span class="builtintype" id="8019806">true</span><span class="op" id="8019810">}</span><span class="op" id="8019811">}</span><span class="op" id="8019812">,</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019816">{</span><span class="ident" id="8019817">NullFloat64</span><span class="op" id="8019828">{</span><span class="num" id="8019829">222</span><span class="op" id="8019832">,</span>&nbsp;<span class="builtintype" id="8019834">false</span><span class="op" id="8019839">}</span><span class="op" id="8019840">,</span>&nbsp;<span class="num" id="8019842">1</span><span class="op" id="8019843">,</span>&nbsp;<span class="ident" id="8019845">NullFloat64</span><span class="op" id="8019856">{</span><span class="num" id="8019857">0</span><span class="op" id="8019858">,</span>&nbsp;<span class="builtintype" id="8019860">false</span><span class="op" id="8019865">}</span><span class="op" id="8019866">}</span><span class="op" id="8019867">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019871">{</span><span class="num" id="8019872">10</span><span class="op" id="8019874">,</span>&nbsp;<span class="ident" id="8019876">NullFloat64</span><span class="op" id="8019887">{</span><span class="num" id="8019888">31.2</span><span class="op" id="8019892">,</span>&nbsp;<span class="builtintype" id="8019894">false</span><span class="op" id="8019899">}</span><span class="op" id="8019900">,</span>&nbsp;<span class="ident" id="8019902">nil</span><span class="op" id="8019905">}</span><span class="op" id="8019906">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8019909">}</span><span class="op" id="8019910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019913">nullTestRun</span><span class="op" id="8019924">(</span><span class="ident" id="8019925">t</span><span class="op" id="8019926">,</span>&nbsp;<span class="ident" id="8019928">spec</span><span class="op" id="8019932">)</span><br>
<span class="lineno"></span><span class="op" id="8019934">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="keyword" id="8019937">func</span>&nbsp;<span class="ident" id="8019942">TestNullBoolParam</span><span class="op" id="8019959">(</span><span class="ident" id="8019960">t</span>&nbsp;<span class="op" id="8019962">*</span><span class="ident" id="8019963">testing</span><span class="op" id="8019970">.</span><span class="ident" id="8019971">T</span><span class="op" id="8019972">)</span>&nbsp;<span class="op" id="8019974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8019977">spec</span>&nbsp;<span class="op" id="8019982">:=</span>&nbsp;<span class="ident" id="8019985">nullTestSpec</span><span class="op" id="8019997">{</span><span class="string" id="8019998">&#34;nullbool&#34;</span><span class="op" id="8020008">,</span>&nbsp;<span class="string" id="8020010">&#34;bool&#34;</span><span class="op" id="8020016">,</span>&nbsp;<span class="op" id="8020018">[</span><span class="num" id="8020019">6</span><span class="op" id="8020020">]</span><span class="ident" id="8020021">nullTestRow</span><span class="op" id="8020032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020036">{</span><span class="ident" id="8020037">NullBool</span><span class="op" id="8020045">{</span><span class="builtintype" id="8020046">false</span><span class="op" id="8020051">,</span>&nbsp;<span class="builtintype" id="8020053">true</span><span class="op" id="8020057">}</span><span class="op" id="8020058">,</span>&nbsp;<span class="builtintype" id="8020060">true</span><span class="op" id="8020064">,</span>&nbsp;<span class="ident" id="8020066">NullBool</span><span class="op" id="8020074">{</span><span class="builtintype" id="8020075">false</span><span class="op" id="8020080">,</span>&nbsp;<span class="builtintype" id="8020082">true</span><span class="op" id="8020086">}</span><span class="op" id="8020087">}</span><span class="op" id="8020088">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020092">{</span><span class="ident" id="8020093">NullBool</span><span class="op" id="8020101">{</span><span class="builtintype" id="8020102">true</span><span class="op" id="8020106">,</span>&nbsp;<span class="builtintype" id="8020108">false</span><span class="op" id="8020113">}</span><span class="op" id="8020114">,</span>&nbsp;<span class="builtintype" id="8020116">false</span><span class="op" id="8020121">,</span>&nbsp;<span class="ident" id="8020123">NullBool</span><span class="op" id="8020131">{</span><span class="builtintype" id="8020132">false</span><span class="op" id="8020137">,</span>&nbsp;<span class="builtintype" id="8020139">false</span><span class="op" id="8020144">}</span><span class="op" id="8020145">}</span><span class="op" id="8020146">,</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020150">{</span><span class="builtintype" id="8020151">true</span><span class="op" id="8020155">,</span>&nbsp;<span class="builtintype" id="8020157">true</span><span class="op" id="8020161">,</span>&nbsp;<span class="ident" id="8020163">NullBool</span><span class="op" id="8020171">{</span><span class="builtintype" id="8020172">true</span><span class="op" id="8020176">,</span>&nbsp;<span class="builtintype" id="8020178">true</span><span class="op" id="8020182">}</span><span class="op" id="8020183">}</span><span class="op" id="8020184">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020188">{</span><span class="ident" id="8020189">NullBool</span><span class="op" id="8020197">{</span><span class="builtintype" id="8020198">true</span><span class="op" id="8020202">,</span>&nbsp;<span class="builtintype" id="8020204">true</span><span class="op" id="8020208">}</span><span class="op" id="8020209">,</span>&nbsp;<span class="builtintype" id="8020211">false</span><span class="op" id="8020216">,</span>&nbsp;<span class="ident" id="8020218">NullBool</span><span class="op" id="8020226">{</span><span class="builtintype" id="8020227">true</span><span class="op" id="8020231">,</span>&nbsp;<span class="builtintype" id="8020233">true</span><span class="op" id="8020237">}</span><span class="op" id="8020238">}</span><span class="op" id="8020239">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020243">{</span><span class="ident" id="8020244">NullBool</span><span class="op" id="8020252">{</span><span class="builtintype" id="8020253">true</span><span class="op" id="8020257">,</span>&nbsp;<span class="builtintype" id="8020259">false</span><span class="op" id="8020264">}</span><span class="op" id="8020265">,</span>&nbsp;<span class="builtintype" id="8020267">true</span><span class="op" id="8020271">,</span>&nbsp;<span class="ident" id="8020273">NullBool</span><span class="op" id="8020281">{</span><span class="builtintype" id="8020282">false</span><span class="op" id="8020287">,</span>&nbsp;<span class="builtintype" id="8020289">false</span><span class="op" id="8020294">}</span><span class="op" id="8020295">}</span><span class="op" id="8020296">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020300">{</span><span class="builtintype" id="8020301">true</span><span class="op" id="8020305">,</span>&nbsp;<span class="ident" id="8020307">NullBool</span><span class="op" id="8020315">{</span><span class="builtintype" id="8020316">true</span><span class="op" id="8020320">,</span>&nbsp;<span class="builtintype" id="8020322">false</span><span class="op" id="8020327">}</span><span class="op" id="8020328">,</span>&nbsp;<span class="ident" id="8020330">nil</span><span class="op" id="8020333">}</span><span class="op" id="8020334">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020337">}</span><span class="op" id="8020338">}</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020341">nullTestRun</span><span class="op" id="8020352">(</span><span class="ident" id="8020353">t</span><span class="op" id="8020354">,</span>&nbsp;<span class="ident" id="8020356">spec</span><span class="op" id="8020360">)</span><br>
<span class="lineno"></span><span class="op" id="8020362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8020365">func</span>&nbsp;<span class="ident" id="8020370">nullTestRun</span><span class="op" id="8020381">(</span><span class="ident" id="8020382">t</span>&nbsp;<span class="op" id="8020384">*</span><span class="ident" id="8020385">testing</span><span class="op" id="8020392">.</span><span class="ident" id="8020393">T</span><span class="op" id="8020394">,</span>&nbsp;<span class="ident" id="8020396">spec</span>&nbsp;<span class="ident" id="8020401">nullTestSpec</span><span class="op" id="8020413">)</span>&nbsp;<span class="op" id="8020415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020418">db</span>&nbsp;<span class="op" id="8020421">:=</span>&nbsp;<span class="ident" id="8020424">newTestDB</span><span class="op" id="8020433">(</span><span class="ident" id="8020434">t</span><span class="op" id="8020435">,</span>&nbsp;<span class="string" id="8020437">&#34;&#34;</span><span class="op" id="8020439">)</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8020442">defer</span>&nbsp;<span class="ident" id="8020448">closeDB</span><span class="op" id="8020455">(</span><span class="ident" id="8020456">t</span><span class="op" id="8020457">,</span>&nbsp;<span class="ident" id="8020459">db</span><span class="op" id="8020461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020464">exec</span><span class="op" id="8020468">(</span><span class="ident" id="8020469">t</span><span class="op" id="8020470">,</span>&nbsp;<span class="ident" id="8020472">db</span><span class="op" id="8020474">,</span>&nbsp;<span class="ident" id="8020476">fmt</span><span class="op" id="8020479">.</span><span class="ident" id="8020480">Sprintf</span><span class="op" id="8020487">(</span><span class="string" id="8020488">&#34;CREATE|t|id=int32,name=string,nullf=%s,notnullf=%s&#34;</span><span class="op" id="8020540">,</span>&nbsp;<span class="ident" id="8020542">spec</span><span class="op" id="8020546">.</span><span class="ident" id="8020547">nullType</span><span class="op" id="8020555">,</span>&nbsp;<span class="ident" id="8020557">spec</span><span class="op" id="8020561">.</span><span class="ident" id="8020562">notNullType</span><span class="op" id="8020573">)</span><span class="op" id="8020574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8020578">//&nbsp;Inserts&nbsp;with&nbsp;db.Exec:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020604">exec</span><span class="op" id="8020608">(</span><span class="ident" id="8020609">t</span><span class="op" id="8020610">,</span>&nbsp;<span class="ident" id="8020612">db</span><span class="op" id="8020614">,</span>&nbsp;<span class="string" id="8020616">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8020657">,</span>&nbsp;<span class="num" id="8020659">1</span><span class="op" id="8020660">,</span>&nbsp;<span class="string" id="8020662">&#34;alice&#34;</span><span class="op" id="8020669">,</span>&nbsp;<span class="ident" id="8020671">spec</span><span class="op" id="8020675">.</span><span class="ident" id="8020676">rows</span><span class="op" id="8020680">[</span><span class="num" id="8020681">0</span><span class="op" id="8020682">]</span><span class="op" id="8020683">.</span><span class="ident" id="8020684">nullParam</span><span class="op" id="8020693">,</span>&nbsp;<span class="ident" id="8020695">spec</span><span class="op" id="8020699">.</span><span class="ident" id="8020700">rows</span><span class="op" id="8020704">[</span><span class="num" id="8020705">0</span><span class="op" id="8020706">]</span><span class="op" id="8020707">.</span><span class="ident" id="8020708">notNullParam</span><span class="op" id="8020720">)</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020723">exec</span><span class="op" id="8020727">(</span><span class="ident" id="8020728">t</span><span class="op" id="8020729">,</span>&nbsp;<span class="ident" id="8020731">db</span><span class="op" id="8020733">,</span>&nbsp;<span class="string" id="8020735">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8020776">,</span>&nbsp;<span class="num" id="8020778">2</span><span class="op" id="8020779">,</span>&nbsp;<span class="string" id="8020781">&#34;bob&#34;</span><span class="op" id="8020786">,</span>&nbsp;<span class="ident" id="8020788">spec</span><span class="op" id="8020792">.</span><span class="ident" id="8020793">rows</span><span class="op" id="8020797">[</span><span class="num" id="8020798">1</span><span class="op" id="8020799">]</span><span class="op" id="8020800">.</span><span class="ident" id="8020801">nullParam</span><span class="op" id="8020810">,</span>&nbsp;<span class="ident" id="8020812">spec</span><span class="op" id="8020816">.</span><span class="ident" id="8020817">rows</span><span class="op" id="8020821">[</span><span class="num" id="8020822">1</span><span class="op" id="8020823">]</span><span class="op" id="8020824">.</span><span class="ident" id="8020825">notNullParam</span><span class="op" id="8020837">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8020841">//&nbsp;Inserts&nbsp;with&nbsp;a&nbsp;prepared&nbsp;statement:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020880">stmt</span><span class="op" id="8020884">,</span>&nbsp;<span class="ident" id="8020886">err</span>&nbsp;<span class="op" id="8020890">:=</span>&nbsp;<span class="ident" id="8020893">db</span><span class="op" id="8020895">.</span><span class="ident" id="8020896">Prepare</span><span class="op" id="8020903">(</span><span class="string" id="8020904">&#34;INSERT|t|id=?,name=?,nullf=?,notnullf=?&#34;</span><span class="op" id="8020945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8020948">if</span>&nbsp;<span class="ident" id="8020951">err</span>&nbsp;<span class="op" id="8020955">!=</span>&nbsp;<span class="ident" id="8020958">nil</span>&nbsp;<span class="op" id="8020962">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8020966">t</span><span class="op" id="8020967">.</span><span class="ident" id="8020968">Fatalf</span><span class="op" id="8020974">(</span><span class="string" id="8020975">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8020988">,</span>&nbsp;<span class="ident" id="8020990">err</span><span class="op" id="8020993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8020996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8020999">defer</span>&nbsp;<span class="ident" id="8021005">stmt</span><span class="op" id="8021009">.</span><span class="ident" id="8021010">Close</span><span class="op" id="8021015">(</span><span class="op" id="8021016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8021019">if</span>&nbsp;<span class="ident" id="8021022">_</span><span class="op" id="8021023">,</span>&nbsp;<span class="ident" id="8021025">err</span>&nbsp;<span class="op" id="8021029">:=</span>&nbsp;<span class="ident" id="8021032">stmt</span><span class="op" id="8021036">.</span><span class="ident" id="8021037">Exec</span><span class="op" id="8021041">(</span><span class="num" id="8021042">3</span><span class="op" id="8021043">,</span>&nbsp;<span class="string" id="8021045">&#34;chris&#34;</span><span class="op" id="8021052">,</span>&nbsp;<span class="ident" id="8021054">spec</span><span class="op" id="8021058">.</span><span class="ident" id="8021059">rows</span><span class="op" id="8021063">[</span><span class="num" id="8021064">2</span><span class="op" id="8021065">]</span><span class="op" id="8021066">.</span><span class="ident" id="8021067">nullParam</span><span class="op" id="8021076">,</span>&nbsp;<span class="ident" id="8021078">spec</span><span class="op" id="8021082">.</span><span class="ident" id="8021083">rows</span><span class="op" id="8021087">[</span><span class="num" id="8021088">2</span><span class="op" id="8021089">]</span><span class="op" id="8021090">.</span><span class="ident" id="8021091">notNullParam</span><span class="op" id="8021103">)</span><span class="op" id="8021104">;</span>&nbsp;<span class="ident" id="8021106">err</span>&nbsp;<span class="op" id="8021110">!=</span>&nbsp;<span class="ident" id="8021113">nil</span>&nbsp;<span class="op" id="8021117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8021121">t</span><span class="op" id="8021122">.</span><span class="ident" id="8021123">Errorf</span><span class="op" id="8021129">(</span><span class="string" id="8021130">&#34;exec&nbsp;insert&nbsp;chris:&nbsp;%v&#34;</span><span class="op" id="8021153">,</span>&nbsp;<span class="ident" id="8021155">err</span><span class="op" id="8021158">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8021161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8021164">if</span>&nbsp;<span class="ident" id="8021167">_</span><span class="op" id="8021168">,</span>&nbsp;<span class="ident" id="8021170">err</span>&nbsp;<span class="op" id="8021174">:=</span>&nbsp;<span class="ident" id="8021177">stmt</span><span class="op" id="8021181">.</span><span class="ident" id="8021182">Exec</span><span class="op" id="8021186">(</span><span class="num" id="8021187">4</span><span class="op" id="8021188">,</span>&nbsp;<span class="string" id="8021190">&#34;dave&#34;</span><span class="op" id="8021196">,</span>&nbsp;<span class="ident" id="8021198">spec</span><span class="op" id="8021202">.</span><span class="ident" id="8021203">rows</span><span class="op" id="8021207">[</span><span class="num" id="8021208">3</span><span class="op" id="8021209">]</span><span class="op" id="8021210">.</span><span class="ident" id="8021211">nullParam</span><span class="op" id="8021220">,</span>&nbsp;<span class="ident" id="8021222">spec</span><span class="op" id="8021226">.</span><span class="ident" id="8021227">rows</span><span class="op" id="8021231">[</span><span class="num" id="8021232">3</span><span class="op" id="8021233">]</span><span class="op" id="8021234">.</span><span class="ident" id="8021235">notNullParam</span><span class="op" id="8021247">)</span><span class="op" id="8021248">;</span>&nbsp;<span class="ident" id="8021250">err</span>&nbsp;<span class="op" id="8021254">!=</span>&nbsp;<span class="ident" id="8021257">nil</span>&nbsp;<span class="op" id="8021261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8021265">t</span><span class="op" id="8021266">.</span><span class="ident" id="8021267">Errorf</span><span class="op" id="8021273">(</span><span class="string" id="8021274">&#34;exec&nbsp;insert&nbsp;dave:&nbsp;%v&#34;</span><span class="op" id="8021296">,</span>&nbsp;<span class="ident" id="8021298">err</span><span class="op" id="8021301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8021304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8021307">if</span>&nbsp;<span class="ident" id="8021310">_</span><span class="op" id="8021311">,</span>&nbsp;<span class="ident" id="8021313">err</span>&nbsp;<span class="op" id="8021317">:=</span>&nbsp;<span class="ident" id="8021320">stmt</span><span class="op" id="8021324">.</span><span class="ident" id="8021325">Exec</span><span class="op" id="8021329">(</span><span class="num" id="8021330">5</span><span class="op" id="8021331">,</span>&nbsp;<span class="string" id="8021333">&#34;eleanor&#34;</span><span class="op" id="8021342">,</span>&nbsp;<span class="ident" id="8021344">spec</span><span class="op" id="8021348">.</span><span class="ident" id="8021349">rows</span><span class="op" id="8021353">[</span><span class="num" id="8021354">4</span><span class="op" id="8021355">]</span><span class="op" id="8021356">.</span><span class="ident" id="8021357">nullParam</span><span class="op" id="8021366">,</span>&nbsp;<span class="ident" id="8021368">spec</span><span class="op" id="8021372">.</span><span class="ident" id="8021373">rows</span><span class="op" id="8021377">[</span><span class="num" id="8021378">4</span><span class="op" id="8021379">]</span><span class="op" id="8021380">.</span><span class="ident" id="8021381">notNullParam</span><span class="op" id="8021393">)</span><span class="op" id="8021394">;</span>&nbsp;<span class="ident" id="8021396">err</span>&nbsp;<span class="op" id="8021400">!=</span>&nbsp;<span class="ident" id="8021403">nil</span>&nbsp;<span class="op" id="8021407">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8021411">t</span><span class="op" id="8021412">.</span><span class="ident" id="8021413">Errorf</span><span class="op" id="8021419">(</span><span class="string" id="8021420">&#34;exec&nbsp;insert&nbsp;eleanor:&nbsp;%v&#34;</span><span class="op" id="8021445">,</span>&nbsp;<span class="ident" id="8021447">err</span><span class="op" id="8021450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8021453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021457">//&nbsp;Can&#39;t&nbsp;put&nbsp;null&nbsp;val&nbsp;into&nbsp;non-null&nbsp;col</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8021498">if</span>&nbsp;<span class="ident" id="8021501">_</span><span class="op" id="8021502">,</span>&nbsp;<span class="ident" id="8021504">err</span>&nbsp;<span class="op" id="8021508">:=</span>&nbsp;<span class="ident" id="8021511">stmt</span><span class="op" id="8021515">.</span><span class="ident" id="8021516">Exec</span><span class="op" id="8021520">(</span><span class="num" id="8021521">6</span><span class="op" id="8021522">,</span>&nbsp;<span class="string" id="8021524">&#34;bob&#34;</span><span class="op" id="8021529">,</span>&nbsp;<span class="ident" id="8021531">spec</span><span class="op" id="8021535">.</span><span class="ident" id="8021536">rows</span><span class="op" id="8021540">[</span><span class="num" id="8021541">5</span><span class="op" id="8021542">]</span><span class="op" id="8021543">.</span><span class="ident" id="8021544">nullParam</span><span class="op" id="8021553">,</span>&nbsp;<span class="ident" id="8021555">spec</span><span class="op" id="8021559">.</span><span class="ident" id="8021560">rows</span><span class="op" id="8021564">[</span><span class="num" id="8021565">5</span><span class="op" id="8021566">]</span><span class="op" id="8021567">.</span><span class="ident" id="8021568">notNullParam</span><span class="op" id="8021580">)</span><span class="op" id="8021581">;</span>&nbsp;<span class="ident" id="8021583">err</span>&nbsp;<span class="op" id="8021587">==</span>&nbsp;<span class="ident" id="8021590">nil</span>&nbsp;<span class="op" id="8021594">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8021598">t</span><span class="op" id="8021599">.</span><span class="ident" id="8021600">Errorf</span><span class="op" id="8021606">(</span><span class="string" id="8021607">&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;val&nbsp;with&nbsp;prepared&nbsp;statement&nbsp;Exec&#34;</span><span class="op" id="8021670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8021673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8021677">_</span><span class="op" id="8021678">,</span>&nbsp;<span class="ident" id="8021680">err</span>&nbsp;<span class="op" id="8021684">=</span>&nbsp;<span class="ident" id="8021686">db</span><span class="op" id="8021688">.</span><span class="ident" id="8021689">Exec</span><span class="op" id="8021693">(</span><span class="string" id="8021694">&#34;INSERT|t|id=?,name=?,nullf=?&#34;</span><span class="op" id="8021724">,</span>&nbsp;<span class="num" id="8021726">999</span><span class="op" id="8021729">,</span>&nbsp;<span class="ident" id="8021731">nil</span><span class="op" id="8021734">,</span>&nbsp;<span class="ident" id="8021736">nil</span><span class="op" id="8021739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8021742">if</span>&nbsp;<span class="ident" id="8021745">err</span>&nbsp;<span class="op" id="8021749">==</span>&nbsp;<span class="ident" id="8021752">nil</span>&nbsp;<span class="op" id="8021756">{</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021760">//&nbsp;TODO:&nbsp;this&nbsp;test&nbsp;fails,&nbsp;but&nbsp;it&#39;s&nbsp;just&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021810">//&nbsp;fakeConn&nbsp;implements&nbsp;the&nbsp;optional&nbsp;Execer&nbsp;interface,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021866">//&nbsp;so&nbsp;arguably&nbsp;this&nbsp;is&nbsp;the&nbsp;correct&nbsp;behavior.&nbsp;&nbsp;But</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021918">//&nbsp;maybe&nbsp;I&nbsp;should&nbsp;flesh&nbsp;out&nbsp;the&nbsp;fakeConn.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8021966">//&nbsp;implementation&nbsp;so&nbsp;this&nbsp;properly&nbsp;fails.</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8022010">//&nbsp;t.Errorf(&#34;expected&nbsp;error&nbsp;inserting&nbsp;nil&nbsp;name&nbsp;with&nbsp;Exec&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8022070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022074">paramtype</span>&nbsp;<span class="op" id="8022084">:=</span>&nbsp;<span class="ident" id="8022087">reflect</span><span class="op" id="8022094">.</span><span class="ident" id="8022095">TypeOf</span><span class="op" id="8022101">(</span><span class="ident" id="8022102">spec</span><span class="op" id="8022106">.</span><span class="ident" id="8022107">rows</span><span class="op" id="8022111">[</span><span class="num" id="8022112">0</span><span class="op" id="8022113">]</span><span class="op" id="8022114">.</span><span class="ident" id="8022115">nullParam</span><span class="op" id="8022124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022127">bindVal</span>&nbsp;<span class="op" id="8022135">:=</span>&nbsp;<span class="ident" id="8022138">reflect</span><span class="op" id="8022145">.</span><span class="ident" id="8022146">New</span><span class="op" id="8022149">(</span><span class="ident" id="8022150">paramtype</span><span class="op" id="8022159">)</span><span class="op" id="8022160">.</span><span class="ident" id="8022161">Interface</span><span class="op" id="8022170">(</span><span class="op" id="8022171">)</span><br>
<span class="lineno">830</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022175">for</span>&nbsp;<span class="ident" id="8022179">i</span>&nbsp;<span class="op" id="8022181">:=</span>&nbsp;<span class="num" id="8022184">0</span><span class="op" id="8022185">;</span>&nbsp;<span class="ident" id="8022187">i</span>&nbsp;<span class="op" id="8022189">&lt;</span>&nbsp;<span class="num" id="8022191">5</span><span class="op" id="8022192">;</span>&nbsp;<span class="ident" id="8022194">i</span><span class="op" id="8022195">++</span>&nbsp;<span class="op" id="8022198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022202">id</span>&nbsp;<span class="op" id="8022205">:=</span>&nbsp;<span class="ident" id="8022208">i</span>&nbsp;<span class="op" id="8022210">+</span>&nbsp;<span class="num" id="8022212">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022216">if</span>&nbsp;<span class="ident" id="8022219">err</span>&nbsp;<span class="op" id="8022223">:=</span>&nbsp;<span class="ident" id="8022226">db</span><span class="op" id="8022228">.</span><span class="ident" id="8022229">QueryRow</span><span class="op" id="8022237">(</span><span class="string" id="8022238">&#34;SELECT|t|nullf|id=?&#34;</span><span class="op" id="8022259">,</span>&nbsp;<span class="ident" id="8022261">id</span><span class="op" id="8022263">)</span><span class="op" id="8022264">.</span><span class="ident" id="8022265">Scan</span><span class="op" id="8022269">(</span><span class="ident" id="8022270">bindVal</span><span class="op" id="8022277">)</span><span class="op" id="8022278">;</span>&nbsp;<span class="ident" id="8022280">err</span>&nbsp;<span class="op" id="8022284">!=</span>&nbsp;<span class="ident" id="8022287">nil</span>&nbsp;<span class="op" id="8022291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022296">t</span><span class="op" id="8022297">.</span><span class="ident" id="8022298">Errorf</span><span class="op" id="8022304">(</span><span class="string" id="8022305">&#34;id=%d&nbsp;Scan:&nbsp;%v&#34;</span><span class="op" id="8022321">,</span>&nbsp;<span class="ident" id="8022323">id</span><span class="op" id="8022325">,</span>&nbsp;<span class="ident" id="8022327">err</span><span class="op" id="8022330">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8022334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022338">bindValDeref</span>&nbsp;<span class="op" id="8022351">:=</span>&nbsp;<span class="ident" id="8022354">reflect</span><span class="op" id="8022361">.</span><span class="ident" id="8022362">ValueOf</span><span class="op" id="8022369">(</span><span class="ident" id="8022370">bindVal</span><span class="op" id="8022377">)</span><span class="op" id="8022378">.</span><span class="ident" id="8022379">Elem</span><span class="op" id="8022383">(</span><span class="op" id="8022384">)</span><span class="op" id="8022385">.</span><span class="ident" id="8022386">Interface</span><span class="op" id="8022395">(</span><span class="op" id="8022396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022400">if</span>&nbsp;<span class="op" id="8022403">!</span><span class="ident" id="8022404">reflect</span><span class="op" id="8022411">.</span><span class="ident" id="8022412">DeepEqual</span><span class="op" id="8022421">(</span><span class="ident" id="8022422">bindValDeref</span><span class="op" id="8022434">,</span>&nbsp;<span class="ident" id="8022436">spec</span><span class="op" id="8022440">.</span><span class="ident" id="8022441">rows</span><span class="op" id="8022445">[</span><span class="ident" id="8022446">i</span><span class="op" id="8022447">]</span><span class="op" id="8022448">.</span><span class="ident" id="8022449">scanNullVal</span><span class="op" id="8022460">)</span>&nbsp;<span class="op" id="8022462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022467">t</span><span class="op" id="8022468">.</span><span class="ident" id="8022469">Errorf</span><span class="op" id="8022475">(</span><span class="string" id="8022476">&#34;id=%d&nbsp;got&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8022501">,</span>&nbsp;<span class="ident" id="8022503">id</span><span class="op" id="8022505">,</span>&nbsp;<span class="ident" id="8022507">bindValDeref</span><span class="op" id="8022519">,</span>&nbsp;<span class="ident" id="8022521">spec</span><span class="op" id="8022525">.</span><span class="ident" id="8022526">rows</span><span class="op" id="8022530">[</span><span class="ident" id="8022531">i</span><span class="op" id="8022532">]</span><span class="op" id="8022533">.</span><span class="ident" id="8022534">scanNullVal</span><span class="op" id="8022545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8022549">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8022552">}</span><br>
<span class="lineno"></span><span class="op" id="8022554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8022557">//&nbsp;golang.org/issue/4859</span><br>
<span class="lineno"></span><span class="keyword" id="8022582">func</span>&nbsp;<span class="ident" id="8022587">TestQueryRowNilScanDest</span><span class="op" id="8022610">(</span><span class="ident" id="8022611">t</span>&nbsp;<span class="op" id="8022613">*</span><span class="ident" id="8022614">testing</span><span class="op" id="8022621">.</span><span class="ident" id="8022622">T</span><span class="op" id="8022623">)</span>&nbsp;<span class="op" id="8022625">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022628">db</span>&nbsp;<span class="op" id="8022631">:=</span>&nbsp;<span class="ident" id="8022634">newTestDB</span><span class="op" id="8022643">(</span><span class="ident" id="8022644">t</span><span class="op" id="8022645">,</span>&nbsp;<span class="string" id="8022647">&#34;people&#34;</span><span class="op" id="8022655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022658">defer</span>&nbsp;<span class="ident" id="8022664">closeDB</span><span class="op" id="8022671">(</span><span class="ident" id="8022672">t</span><span class="op" id="8022673">,</span>&nbsp;<span class="ident" id="8022675">db</span><span class="op" id="8022677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022680">var</span>&nbsp;<span class="ident" id="8022684">name</span>&nbsp;<span class="op" id="8022689">*</span><span class="builtintype" id="8022690">string</span>&nbsp;<span class="comment" id="8022697">//&nbsp;nil&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022713">err</span>&nbsp;<span class="op" id="8022717">:=</span>&nbsp;<span class="ident" id="8022720">db</span><span class="op" id="8022722">.</span><span class="ident" id="8022723">QueryRow</span><span class="op" id="8022731">(</span><span class="string" id="8022732">&#34;SELECT|people|name|&#34;</span><span class="op" id="8022753">)</span><span class="op" id="8022754">.</span><span class="ident" id="8022755">Scan</span><span class="op" id="8022759">(</span><span class="ident" id="8022760">name</span><span class="op" id="8022764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022767">want</span>&nbsp;<span class="op" id="8022772">:=</span>&nbsp;<span class="string" id="8022775">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;0:&nbsp;destination&nbsp;pointer&nbsp;is&nbsp;nil&#34;</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8022840">if</span>&nbsp;<span class="ident" id="8022843">err</span>&nbsp;<span class="op" id="8022847">==</span>&nbsp;<span class="ident" id="8022850">nil</span>&nbsp;<span class="op" id="8022854">||</span>&nbsp;<span class="ident" id="8022857">err</span><span class="op" id="8022860">.</span><span class="ident" id="8022861">Error</span><span class="op" id="8022866">(</span><span class="op" id="8022867">)</span>&nbsp;<span class="op" id="8022869">!=</span>&nbsp;<span class="ident" id="8022872">want</span>&nbsp;<span class="op" id="8022877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022881">t</span><span class="op" id="8022882">.</span><span class="ident" id="8022883">Errorf</span><span class="op" id="8022889">(</span><span class="string" id="8022890">&#34;error&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8022911">,</span>&nbsp;<span class="ident" id="8022913">err</span><span class="op" id="8022916">.</span><span class="ident" id="8022917">Error</span><span class="op" id="8022922">(</span><span class="op" id="8022923">)</span><span class="op" id="8022924">,</span>&nbsp;<span class="ident" id="8022926">want</span><span class="op" id="8022930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8022933">}</span><br>
<span class="lineno"></span><span class="op" id="8022935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">855</span><span class="keyword" id="8022938">func</span>&nbsp;<span class="ident" id="8022943">TestIssue4902</span><span class="op" id="8022956">(</span><span class="ident" id="8022957">t</span>&nbsp;<span class="op" id="8022959">*</span><span class="ident" id="8022960">testing</span><span class="op" id="8022967">.</span><span class="ident" id="8022968">T</span><span class="op" id="8022969">)</span>&nbsp;<span class="op" id="8022971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8022974">db</span>&nbsp;<span class="op" id="8022977">:=</span>&nbsp;<span class="ident" id="8022980">newTestDB</span><span class="op" id="8022989">(</span><span class="ident" id="8022990">t</span><span class="op" id="8022991">,</span>&nbsp;<span class="string" id="8022993">&#34;people&#34;</span><span class="op" id="8023001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023004">defer</span>&nbsp;<span class="ident" id="8023010">closeDB</span><span class="op" id="8023017">(</span><span class="ident" id="8023018">t</span><span class="op" id="8023019">,</span>&nbsp;<span class="ident" id="8023021">db</span><span class="op" id="8023023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023027">driver</span>&nbsp;<span class="op" id="8023034">:=</span>&nbsp;<span class="ident" id="8023037">db</span><span class="op" id="8023039">.</span><span class="ident" id="8023040">driver</span><span class="op" id="8023046">.</span><span class="op" id="8023047">(</span><span class="op" id="8023048">*</span><span class="ident" id="8023049">fakeDriver</span><span class="op" id="8023059">)</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023062">opens0</span>&nbsp;<span class="op" id="8023069">:=</span>&nbsp;<span class="ident" id="8023072">driver</span><span class="op" id="8023078">.</span><span class="ident" id="8023079">openCount</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023091">var</span>&nbsp;<span class="ident" id="8023095">stmt</span>&nbsp;<span class="op" id="8023100">*</span><span class="ident" id="8023101">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023107">var</span>&nbsp;<span class="ident" id="8023111">err</span>&nbsp;<span class="builtintype" id="8023115">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023122">for</span>&nbsp;<span class="ident" id="8023126">i</span>&nbsp;<span class="op" id="8023128">:=</span>&nbsp;<span class="num" id="8023131">0</span><span class="op" id="8023132">;</span>&nbsp;<span class="ident" id="8023134">i</span>&nbsp;<span class="op" id="8023136">&lt;</span>&nbsp;<span class="num" id="8023138">10</span><span class="op" id="8023140">;</span>&nbsp;<span class="ident" id="8023142">i</span><span class="op" id="8023143">++</span>&nbsp;<span class="op" id="8023146">{</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023150">stmt</span><span class="op" id="8023154">,</span>&nbsp;<span class="ident" id="8023156">err</span>&nbsp;<span class="op" id="8023160">=</span>&nbsp;<span class="ident" id="8023162">db</span><span class="op" id="8023164">.</span><span class="ident" id="8023165">Prepare</span><span class="op" id="8023172">(</span><span class="string" id="8023173">&#34;SELECT|people|name|&#34;</span><span class="op" id="8023194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023198">if</span>&nbsp;<span class="ident" id="8023201">err</span>&nbsp;<span class="op" id="8023205">!=</span>&nbsp;<span class="ident" id="8023208">nil</span>&nbsp;<span class="op" id="8023212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023217">t</span><span class="op" id="8023218">.</span><span class="ident" id="8023219">Fatal</span><span class="op" id="8023224">(</span><span class="ident" id="8023225">err</span><span class="op" id="8023228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023236">err</span>&nbsp;<span class="op" id="8023240">=</span>&nbsp;<span class="ident" id="8023242">stmt</span><span class="op" id="8023246">.</span><span class="ident" id="8023247">Close</span><span class="op" id="8023252">(</span><span class="op" id="8023253">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023257">if</span>&nbsp;<span class="ident" id="8023260">err</span>&nbsp;<span class="op" id="8023264">!=</span>&nbsp;<span class="ident" id="8023267">nil</span>&nbsp;<span class="op" id="8023271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023276">t</span><span class="op" id="8023277">.</span><span class="ident" id="8023278">Fatal</span><span class="op" id="8023283">(</span><span class="ident" id="8023284">err</span><span class="op" id="8023287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023298">opens</span>&nbsp;<span class="op" id="8023304">:=</span>&nbsp;<span class="ident" id="8023307">driver</span><span class="op" id="8023313">.</span><span class="ident" id="8023314">openCount</span>&nbsp;<span class="op" id="8023324">-</span>&nbsp;<span class="ident" id="8023326">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023334">if</span>&nbsp;<span class="ident" id="8023337">opens</span>&nbsp;<span class="op" id="8023343">&gt;</span>&nbsp;<span class="num" id="8023345">1</span>&nbsp;<span class="op" id="8023347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023351">t</span><span class="op" id="8023352">.</span><span class="ident" id="8023353">Errorf</span><span class="op" id="8023359">(</span><span class="string" id="8023360">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8023383">,</span>&nbsp;<span class="ident" id="8023385">opens</span><span class="op" id="8023390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023394">t</span><span class="op" id="8023395">.</span><span class="ident" id="8023396">Logf</span><span class="op" id="8023400">(</span><span class="string" id="8023401">&#34;db&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8023411">,</span>&nbsp;<span class="ident" id="8023413">db</span><span class="op" id="8023415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023419">t</span><span class="op" id="8023420">.</span><span class="ident" id="8023421">Logf</span><span class="op" id="8023425">(</span><span class="string" id="8023426">&#34;driver&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8023440">,</span>&nbsp;<span class="ident" id="8023442">driver</span><span class="op" id="8023448">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023452">t</span><span class="op" id="8023453">.</span><span class="ident" id="8023454">Logf</span><span class="op" id="8023458">(</span><span class="string" id="8023459">&#34;stmt&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8023471">,</span>&nbsp;<span class="ident" id="8023473">stmt</span><span class="op" id="8023477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023480">}</span><br>
<span class="lineno"></span><span class="op" id="8023482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8023485">//&nbsp;Issue&nbsp;3857</span><br>
<span class="lineno">885</span><span class="comment" id="8023499">//&nbsp;This&nbsp;used&nbsp;to&nbsp;deadlock.</span><br>
<span class="lineno"></span><span class="keyword" id="8023525">func</span>&nbsp;<span class="ident" id="8023530">TestSimultaneousQueries</span><span class="op" id="8023553">(</span><span class="ident" id="8023554">t</span>&nbsp;<span class="op" id="8023556">*</span><span class="ident" id="8023557">testing</span><span class="op" id="8023564">.</span><span class="ident" id="8023565">T</span><span class="op" id="8023566">)</span>&nbsp;<span class="op" id="8023568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023571">db</span>&nbsp;<span class="op" id="8023574">:=</span>&nbsp;<span class="ident" id="8023577">newTestDB</span><span class="op" id="8023586">(</span><span class="ident" id="8023587">t</span><span class="op" id="8023588">,</span>&nbsp;<span class="string" id="8023590">&#34;people&#34;</span><span class="op" id="8023598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023601">defer</span>&nbsp;<span class="ident" id="8023607">closeDB</span><span class="op" id="8023614">(</span><span class="ident" id="8023615">t</span><span class="op" id="8023616">,</span>&nbsp;<span class="ident" id="8023618">db</span><span class="op" id="8023620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023624">tx</span><span class="op" id="8023626">,</span>&nbsp;<span class="ident" id="8023628">err</span>&nbsp;<span class="op" id="8023632">:=</span>&nbsp;<span class="ident" id="8023635">db</span><span class="op" id="8023637">.</span><span class="ident" id="8023638">Begin</span><span class="op" id="8023643">(</span><span class="op" id="8023644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023647">if</span>&nbsp;<span class="ident" id="8023650">err</span>&nbsp;<span class="op" id="8023654">!=</span>&nbsp;<span class="ident" id="8023657">nil</span>&nbsp;<span class="op" id="8023661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023665">t</span><span class="op" id="8023666">.</span><span class="ident" id="8023667">Fatal</span><span class="op" id="8023672">(</span><span class="ident" id="8023673">err</span><span class="op" id="8023676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023682">defer</span>&nbsp;<span class="ident" id="8023688">tx</span><span class="op" id="8023690">.</span><span class="ident" id="8023691">Rollback</span><span class="op" id="8023699">(</span><span class="op" id="8023700">)</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023704">r1</span><span class="op" id="8023706">,</span>&nbsp;<span class="ident" id="8023708">err</span>&nbsp;<span class="op" id="8023712">:=</span>&nbsp;<span class="ident" id="8023715">tx</span><span class="op" id="8023717">.</span><span class="ident" id="8023718">Query</span><span class="op" id="8023723">(</span><span class="string" id="8023724">&#34;SELECT|people|name|&#34;</span><span class="op" id="8023745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023748">if</span>&nbsp;<span class="ident" id="8023751">err</span>&nbsp;<span class="op" id="8023755">!=</span>&nbsp;<span class="ident" id="8023758">nil</span>&nbsp;<span class="op" id="8023762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023766">t</span><span class="op" id="8023767">.</span><span class="ident" id="8023768">Fatal</span><span class="op" id="8023773">(</span><span class="ident" id="8023774">err</span><span class="op" id="8023777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023780">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023783">defer</span>&nbsp;<span class="ident" id="8023789">r1</span><span class="op" id="8023791">.</span><span class="ident" id="8023792">Close</span><span class="op" id="8023797">(</span><span class="op" id="8023798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023802">r2</span><span class="op" id="8023804">,</span>&nbsp;<span class="ident" id="8023806">err</span>&nbsp;<span class="op" id="8023810">:=</span>&nbsp;<span class="ident" id="8023813">tx</span><span class="op" id="8023815">.</span><span class="ident" id="8023816">Query</span><span class="op" id="8023821">(</span><span class="string" id="8023822">&#34;SELECT|people|name|&#34;</span><span class="op" id="8023843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023846">if</span>&nbsp;<span class="ident" id="8023849">err</span>&nbsp;<span class="op" id="8023853">!=</span>&nbsp;<span class="ident" id="8023856">nil</span>&nbsp;<span class="op" id="8023860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023864">t</span><span class="op" id="8023865">.</span><span class="ident" id="8023866">Fatal</span><span class="op" id="8023871">(</span><span class="ident" id="8023872">err</span><span class="op" id="8023875">)</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8023878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023881">defer</span>&nbsp;<span class="ident" id="8023887">r2</span><span class="op" id="8023889">.</span><span class="ident" id="8023890">Close</span><span class="op" id="8023895">(</span><span class="op" id="8023896">)</span><br>
<span class="lineno"></span><span class="op" id="8023898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8023901">func</span>&nbsp;<span class="ident" id="8023906">TestMaxIdleConns</span><span class="op" id="8023922">(</span><span class="ident" id="8023923">t</span>&nbsp;<span class="op" id="8023925">*</span><span class="ident" id="8023926">testing</span><span class="op" id="8023933">.</span><span class="ident" id="8023934">T</span><span class="op" id="8023935">)</span>&nbsp;<span class="op" id="8023937">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023940">db</span>&nbsp;<span class="op" id="8023943">:=</span>&nbsp;<span class="ident" id="8023946">newTestDB</span><span class="op" id="8023955">(</span><span class="ident" id="8023956">t</span><span class="op" id="8023957">,</span>&nbsp;<span class="string" id="8023959">&#34;people&#34;</span><span class="op" id="8023967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8023970">defer</span>&nbsp;<span class="ident" id="8023976">closeDB</span><span class="op" id="8023983">(</span><span class="ident" id="8023984">t</span><span class="op" id="8023985">,</span>&nbsp;<span class="ident" id="8023987">db</span><span class="op" id="8023989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8023993">tx</span><span class="op" id="8023995">,</span>&nbsp;<span class="ident" id="8023997">err</span>&nbsp;<span class="op" id="8024001">:=</span>&nbsp;<span class="ident" id="8024004">db</span><span class="op" id="8024006">.</span><span class="ident" id="8024007">Begin</span><span class="op" id="8024012">(</span><span class="op" id="8024013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024016">if</span>&nbsp;<span class="ident" id="8024019">err</span>&nbsp;<span class="op" id="8024023">!=</span>&nbsp;<span class="ident" id="8024026">nil</span>&nbsp;<span class="op" id="8024030">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024034">t</span><span class="op" id="8024035">.</span><span class="ident" id="8024036">Fatal</span><span class="op" id="8024041">(</span><span class="ident" id="8024042">err</span><span class="op" id="8024045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024051">tx</span><span class="op" id="8024053">.</span><span class="ident" id="8024054">Commit</span><span class="op" id="8024060">(</span><span class="op" id="8024061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024064">if</span>&nbsp;<span class="ident" id="8024067">got</span>&nbsp;<span class="op" id="8024071">:=</span>&nbsp;<span class="builtinfunc" id="8024074">len</span><span class="op" id="8024077">(</span><span class="ident" id="8024078">db</span><span class="op" id="8024080">.</span><span class="ident" id="8024081">freeConn</span><span class="op" id="8024089">)</span><span class="op" id="8024090">;</span>&nbsp;<span class="ident" id="8024092">got</span>&nbsp;<span class="op" id="8024096">!=</span>&nbsp;<span class="num" id="8024099">1</span>&nbsp;<span class="op" id="8024101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024105">t</span><span class="op" id="8024106">.</span><span class="ident" id="8024107">Errorf</span><span class="op" id="8024113">(</span><span class="string" id="8024114">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8024138">,</span>&nbsp;<span class="ident" id="8024140">got</span><span class="op" id="8024143">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024150">db</span><span class="op" id="8024152">.</span><span class="ident" id="8024153">SetMaxIdleConns</span><span class="op" id="8024168">(</span><span class="num" id="8024169">0</span><span class="op" id="8024170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024174">if</span>&nbsp;<span class="ident" id="8024177">got</span>&nbsp;<span class="op" id="8024181">:=</span>&nbsp;<span class="builtinfunc" id="8024184">len</span><span class="op" id="8024187">(</span><span class="ident" id="8024188">db</span><span class="op" id="8024190">.</span><span class="ident" id="8024191">freeConn</span><span class="op" id="8024199">)</span><span class="op" id="8024200">;</span>&nbsp;<span class="ident" id="8024202">got</span>&nbsp;<span class="op" id="8024206">!=</span>&nbsp;<span class="num" id="8024209">0</span>&nbsp;<span class="op" id="8024211">{</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024215">t</span><span class="op" id="8024216">.</span><span class="ident" id="8024217">Errorf</span><span class="op" id="8024223">(</span><span class="string" id="8024224">&#34;freeConns&nbsp;after&nbsp;set&nbsp;to&nbsp;zero&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8024266">,</span>&nbsp;<span class="ident" id="8024268">got</span><span class="op" id="8024271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024278">tx</span><span class="op" id="8024280">,</span>&nbsp;<span class="ident" id="8024282">err</span>&nbsp;<span class="op" id="8024286">=</span>&nbsp;<span class="ident" id="8024288">db</span><span class="op" id="8024290">.</span><span class="ident" id="8024291">Begin</span><span class="op" id="8024296">(</span><span class="op" id="8024297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024300">if</span>&nbsp;<span class="ident" id="8024303">err</span>&nbsp;<span class="op" id="8024307">!=</span>&nbsp;<span class="ident" id="8024310">nil</span>&nbsp;<span class="op" id="8024314">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024318">t</span><span class="op" id="8024319">.</span><span class="ident" id="8024320">Fatal</span><span class="op" id="8024325">(</span><span class="ident" id="8024326">err</span><span class="op" id="8024329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024335">tx</span><span class="op" id="8024337">.</span><span class="ident" id="8024338">Commit</span><span class="op" id="8024344">(</span><span class="op" id="8024345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024348">if</span>&nbsp;<span class="ident" id="8024351">got</span>&nbsp;<span class="op" id="8024355">:=</span>&nbsp;<span class="builtinfunc" id="8024358">len</span><span class="op" id="8024361">(</span><span class="ident" id="8024362">db</span><span class="op" id="8024364">.</span><span class="ident" id="8024365">freeConn</span><span class="op" id="8024373">)</span><span class="op" id="8024374">;</span>&nbsp;<span class="ident" id="8024376">got</span>&nbsp;<span class="op" id="8024380">!=</span>&nbsp;<span class="num" id="8024383">0</span>&nbsp;<span class="op" id="8024385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024389">t</span><span class="op" id="8024390">.</span><span class="ident" id="8024391">Errorf</span><span class="op" id="8024397">(</span><span class="string" id="8024398">&#34;freeConns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8024422">,</span>&nbsp;<span class="ident" id="8024424">got</span><span class="op" id="8024427">)</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024430">}</span><br>
<span class="lineno"></span><span class="op" id="8024432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8024435">func</span>&nbsp;<span class="ident" id="8024440">TestMaxOpenConns</span><span class="op" id="8024456">(</span><span class="ident" id="8024457">t</span>&nbsp;<span class="op" id="8024459">*</span><span class="ident" id="8024460">testing</span><span class="op" id="8024467">.</span><span class="ident" id="8024468">T</span><span class="op" id="8024469">)</span>&nbsp;<span class="op" id="8024471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024474">if</span>&nbsp;<span class="ident" id="8024477">testing</span><span class="op" id="8024484">.</span><span class="ident" id="8024485">Short</span><span class="op" id="8024490">(</span><span class="op" id="8024491">)</span>&nbsp;<span class="op" id="8024493">{</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024497">t</span><span class="op" id="8024498">.</span><span class="ident" id="8024499">Skip</span><span class="op" id="8024503">(</span><span class="string" id="8024504">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8024528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024534">defer</span>&nbsp;<span class="ident" id="8024540">setHookpostCloseConn</span><span class="op" id="8024560">(</span><span class="ident" id="8024561">nil</span><span class="op" id="8024564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024567">setHookpostCloseConn</span><span class="op" id="8024587">(</span><span class="keyword" id="8024588">func</span><span class="op" id="8024592">(</span><span class="ident" id="8024593">_</span>&nbsp;<span class="op" id="8024595">*</span><span class="ident" id="8024596">fakeConn</span><span class="op" id="8024604">,</span>&nbsp;<span class="ident" id="8024606">err</span>&nbsp;<span class="builtintype" id="8024610">error</span><span class="op" id="8024615">)</span>&nbsp;<span class="op" id="8024617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024621">if</span>&nbsp;<span class="ident" id="8024624">err</span>&nbsp;<span class="op" id="8024628">!=</span>&nbsp;<span class="ident" id="8024631">nil</span>&nbsp;<span class="op" id="8024635">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024640">t</span><span class="op" id="8024641">.</span><span class="ident" id="8024642">Errorf</span><span class="op" id="8024648">(</span><span class="string" id="8024649">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8024677">,</span>&nbsp;<span class="ident" id="8024679">err</span><span class="op" id="8024682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024689">}</span><span class="op" id="8024690">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024694">db</span>&nbsp;<span class="op" id="8024697">:=</span>&nbsp;<span class="ident" id="8024700">newTestDB</span><span class="op" id="8024709">(</span><span class="ident" id="8024710">t</span><span class="op" id="8024711">,</span>&nbsp;<span class="string" id="8024713">&#34;magicquery&#34;</span><span class="op" id="8024725">)</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024728">defer</span>&nbsp;<span class="ident" id="8024734">closeDB</span><span class="op" id="8024741">(</span><span class="ident" id="8024742">t</span><span class="op" id="8024743">,</span>&nbsp;<span class="ident" id="8024745">db</span><span class="op" id="8024747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024751">driver</span>&nbsp;<span class="op" id="8024758">:=</span>&nbsp;<span class="ident" id="8024761">db</span><span class="op" id="8024763">.</span><span class="ident" id="8024764">driver</span><span class="op" id="8024770">.</span><span class="op" id="8024771">(</span><span class="op" id="8024772">*</span><span class="ident" id="8024773">fakeDriver</span><span class="op" id="8024783">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8024787">//&nbsp;Force&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;0&nbsp;so&nbsp;we&nbsp;can&nbsp;get&nbsp;an&nbsp;accurate</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8024859">//&nbsp;count&nbsp;for&nbsp;the&nbsp;test</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024882">db</span><span class="op" id="8024884">.</span><span class="ident" id="8024885">SetMaxIdleConns</span><span class="op" id="8024900">(</span><span class="num" id="8024901">0</span><span class="op" id="8024902">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024906">if</span>&nbsp;<span class="ident" id="8024909">g</span><span class="op" id="8024910">,</span>&nbsp;<span class="ident" id="8024912">w</span>&nbsp;<span class="op" id="8024914">:=</span>&nbsp;<span class="ident" id="8024917">db</span><span class="op" id="8024919">.</span><span class="ident" id="8024920">numFreeConns</span><span class="op" id="8024932">(</span><span class="op" id="8024933">)</span><span class="op" id="8024934">,</span>&nbsp;<span class="num" id="8024936">0</span><span class="op" id="8024937">;</span>&nbsp;<span class="ident" id="8024939">g</span>&nbsp;<span class="op" id="8024941">!=</span>&nbsp;<span class="ident" id="8024944">w</span>&nbsp;<span class="op" id="8024946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8024950">t</span><span class="op" id="8024951">.</span><span class="ident" id="8024952">Errorf</span><span class="op" id="8024958">(</span><span class="string" id="8024959">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8024985">,</span>&nbsp;<span class="ident" id="8024987">g</span><span class="op" id="8024988">,</span>&nbsp;<span class="ident" id="8024990">w</span><span class="op" id="8024991">)</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8024994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8024998">if</span>&nbsp;<span class="ident" id="8025001">n</span>&nbsp;<span class="op" id="8025003">:=</span>&nbsp;<span class="ident" id="8025006">db</span><span class="op" id="8025008">.</span><span class="ident" id="8025009">numDepsPollUntil</span><span class="op" id="8025025">(</span><span class="num" id="8025026">0</span><span class="op" id="8025027">,</span>&nbsp;<span class="ident" id="8025029">time</span><span class="op" id="8025033">.</span><span class="ident" id="8025034">Second</span><span class="op" id="8025040">)</span><span class="op" id="8025041">;</span>&nbsp;<span class="ident" id="8025043">n</span>&nbsp;<span class="op" id="8025045">&gt;</span>&nbsp;<span class="num" id="8025047">0</span>&nbsp;<span class="op" id="8025049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025053">t</span><span class="op" id="8025054">.</span><span class="ident" id="8025055">Errorf</span><span class="op" id="8025061">(</span><span class="string" id="8025062">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8025103">,</span>&nbsp;<span class="ident" id="8025105">n</span><span class="op" id="8025106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025110">db</span><span class="op" id="8025112">.</span><span class="ident" id="8025113">dumpDeps</span><span class="op" id="8025121">(</span><span class="ident" id="8025122">t</span><span class="op" id="8025123">)</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025130">driver</span><span class="op" id="8025136">.</span><span class="ident" id="8025137">mu</span><span class="op" id="8025139">.</span><span class="ident" id="8025140">Lock</span><span class="op" id="8025144">(</span><span class="op" id="8025145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025148">opens0</span>&nbsp;<span class="op" id="8025155">:=</span>&nbsp;<span class="ident" id="8025158">driver</span><span class="op" id="8025164">.</span><span class="ident" id="8025165">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025176">closes0</span>&nbsp;<span class="op" id="8025184">:=</span>&nbsp;<span class="ident" id="8025187">driver</span><span class="op" id="8025193">.</span><span class="ident" id="8025194">closeCount</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025206">driver</span><span class="op" id="8025212">.</span><span class="ident" id="8025213">mu</span><span class="op" id="8025215">.</span><span class="ident" id="8025216">Unlock</span><span class="op" id="8025222">(</span><span class="op" id="8025223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025227">db</span><span class="op" id="8025229">.</span><span class="ident" id="8025230">SetMaxIdleConns</span><span class="op" id="8025245">(</span><span class="num" id="8025246">10</span><span class="op" id="8025248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025251">db</span><span class="op" id="8025253">.</span><span class="ident" id="8025254">SetMaxOpenConns</span><span class="op" id="8025269">(</span><span class="num" id="8025270">10</span><span class="op" id="8025272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025276">stmt</span><span class="op" id="8025280">,</span>&nbsp;<span class="ident" id="8025282">err</span>&nbsp;<span class="op" id="8025286">:=</span>&nbsp;<span class="ident" id="8025289">db</span><span class="op" id="8025291">.</span><span class="ident" id="8025292">Prepare</span><span class="op" id="8025299">(</span><span class="string" id="8025300">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8025336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025339">if</span>&nbsp;<span class="ident" id="8025342">err</span>&nbsp;<span class="op" id="8025346">!=</span>&nbsp;<span class="ident" id="8025349">nil</span>&nbsp;<span class="op" id="8025353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025357">t</span><span class="op" id="8025358">.</span><span class="ident" id="8025359">Fatal</span><span class="op" id="8025364">(</span><span class="ident" id="8025365">err</span><span class="op" id="8025368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8025375">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025411">const</span>&nbsp;<span class="op" id="8025417">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025421">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025433">=</span>&nbsp;<span class="num" id="8025435">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025440">sleepMillis</span>&nbsp;<span class="op" id="8025452">=</span>&nbsp;<span class="num" id="8025454">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025459">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8025471">=</span>&nbsp;<span class="num" id="8025473">2</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025479">var</span>&nbsp;<span class="ident" id="8025483">wg</span>&nbsp;<span class="ident" id="8025486">sync</span><span class="op" id="8025490">.</span><span class="ident" id="8025491">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025502">for</span>&nbsp;<span class="ident" id="8025506">batch</span>&nbsp;<span class="op" id="8025512">:=</span>&nbsp;<span class="num" id="8025515">0</span><span class="op" id="8025516">;</span>&nbsp;<span class="ident" id="8025518">batch</span>&nbsp;<span class="op" id="8025524">&lt;</span>&nbsp;<span class="ident" id="8025526">nbatch</span><span class="op" id="8025532">;</span>&nbsp;<span class="ident" id="8025534">batch</span><span class="op" id="8025539">++</span>&nbsp;<span class="op" id="8025542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025546">for</span>&nbsp;<span class="ident" id="8025550">i</span>&nbsp;<span class="op" id="8025552">:=</span>&nbsp;<span class="num" id="8025555">0</span><span class="op" id="8025556">;</span>&nbsp;<span class="ident" id="8025558">i</span>&nbsp;<span class="op" id="8025560">&lt;</span>&nbsp;<span class="ident" id="8025562">nquery</span><span class="op" id="8025568">;</span>&nbsp;<span class="ident" id="8025570">i</span><span class="op" id="8025571">++</span>&nbsp;<span class="op" id="8025574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025579">wg</span><span class="op" id="8025581">.</span><span class="ident" id="8025582">Add</span><span class="op" id="8025585">(</span><span class="num" id="8025586">1</span><span class="op" id="8025587">)</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025592">go</span>&nbsp;<span class="keyword" id="8025595">func</span><span class="op" id="8025599">(</span><span class="op" id="8025600">)</span>&nbsp;<span class="op" id="8025602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025608">defer</span>&nbsp;<span class="ident" id="8025614">wg</span><span class="op" id="8025616">.</span><span class="ident" id="8025617">Done</span><span class="op" id="8025621">(</span><span class="op" id="8025622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025628">var</span>&nbsp;<span class="ident" id="8025632">op</span>&nbsp;<span class="builtintype" id="8025635">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025646">if</span>&nbsp;<span class="ident" id="8025649">err</span>&nbsp;<span class="op" id="8025653">:=</span>&nbsp;<span class="ident" id="8025656">stmt</span><span class="op" id="8025660">.</span><span class="ident" id="8025661">QueryRow</span><span class="op" id="8025669">(</span><span class="string" id="8025670">&#34;sleep&#34;</span><span class="op" id="8025677">,</span>&nbsp;<span class="ident" id="8025679">sleepMillis</span><span class="op" id="8025690">)</span><span class="op" id="8025691">.</span><span class="ident" id="8025692">Scan</span><span class="op" id="8025696">(</span><span class="op" id="8025697">&amp;</span><span class="ident" id="8025698">op</span><span class="op" id="8025700">)</span><span class="op" id="8025701">;</span>&nbsp;<span class="ident" id="8025703">err</span>&nbsp;<span class="op" id="8025707">!=</span>&nbsp;<span class="ident" id="8025710">nil</span>&nbsp;<span class="op" id="8025714">&amp;&amp;</span>&nbsp;<span class="ident" id="8025717">err</span>&nbsp;<span class="op" id="8025721">!=</span>&nbsp;<span class="ident" id="8025724">ErrNoRows</span>&nbsp;<span class="op" id="8025734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025741">t</span><span class="op" id="8025742">.</span><span class="ident" id="8025743">Error</span><span class="op" id="8025748">(</span><span class="ident" id="8025749">err</span><span class="op" id="8025752">)</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025763">}</span><span class="op" id="8025764">(</span><span class="op" id="8025765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8025773">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8025830">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8025887">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025908">time</span><span class="op" id="8025912">.</span><span class="ident" id="8025913">Sleep</span><span class="op" id="8025918">(</span><span class="num" id="8025919">2</span>&nbsp;<span class="op" id="8025921">*</span>&nbsp;<span class="ident" id="8025923">sleepMillis</span>&nbsp;<span class="op" id="8025935">*</span>&nbsp;<span class="ident" id="8025937">time</span><span class="op" id="8025941">.</span><span class="ident" id="8025942">Millisecond</span><span class="op" id="8025953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8025956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8025959">wg</span><span class="op" id="8025961">.</span><span class="ident" id="8025962">Wait</span><span class="op" id="8025966">(</span><span class="op" id="8025967">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8025971">if</span>&nbsp;<span class="ident" id="8025974">g</span><span class="op" id="8025975">,</span>&nbsp;<span class="ident" id="8025977">w</span>&nbsp;<span class="op" id="8025979">:=</span>&nbsp;<span class="ident" id="8025982">db</span><span class="op" id="8025984">.</span><span class="ident" id="8025985">numFreeConns</span><span class="op" id="8025997">(</span><span class="op" id="8025998">)</span><span class="op" id="8025999">,</span>&nbsp;<span class="num" id="8026001">10</span><span class="op" id="8026003">;</span>&nbsp;<span class="ident" id="8026005">g</span>&nbsp;<span class="op" id="8026007">!=</span>&nbsp;<span class="ident" id="8026010">w</span>&nbsp;<span class="op" id="8026012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026016">t</span><span class="op" id="8026017">.</span><span class="ident" id="8026018">Errorf</span><span class="op" id="8026024">(</span><span class="string" id="8026025">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8026051">,</span>&nbsp;<span class="ident" id="8026053">g</span><span class="op" id="8026054">,</span>&nbsp;<span class="ident" id="8026056">w</span><span class="op" id="8026057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026064">if</span>&nbsp;<span class="ident" id="8026067">n</span>&nbsp;<span class="op" id="8026069">:=</span>&nbsp;<span class="ident" id="8026072">db</span><span class="op" id="8026074">.</span><span class="ident" id="8026075">numDepsPollUntil</span><span class="op" id="8026091">(</span><span class="num" id="8026092">20</span><span class="op" id="8026094">,</span>&nbsp;<span class="ident" id="8026096">time</span><span class="op" id="8026100">.</span><span class="ident" id="8026101">Second</span><span class="op" id="8026107">)</span><span class="op" id="8026108">;</span>&nbsp;<span class="ident" id="8026110">n</span>&nbsp;<span class="op" id="8026112">&gt;</span>&nbsp;<span class="num" id="8026114">20</span>&nbsp;<span class="op" id="8026117">{</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026121">t</span><span class="op" id="8026122">.</span><span class="ident" id="8026123">Errorf</span><span class="op" id="8026129">(</span><span class="string" id="8026130">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;20&#34;</span><span class="op" id="8026175">,</span>&nbsp;<span class="ident" id="8026177">n</span><span class="op" id="8026178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026182">db</span><span class="op" id="8026184">.</span><span class="ident" id="8026185">dumpDeps</span><span class="op" id="8026193">(</span><span class="ident" id="8026194">t</span><span class="op" id="8026195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026202">driver</span><span class="op" id="8026208">.</span><span class="ident" id="8026209">mu</span><span class="op" id="8026211">.</span><span class="ident" id="8026212">Lock</span><span class="op" id="8026216">(</span><span class="op" id="8026217">)</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026220">opens</span>&nbsp;<span class="op" id="8026226">:=</span>&nbsp;<span class="ident" id="8026229">driver</span><span class="op" id="8026235">.</span><span class="ident" id="8026236">openCount</span>&nbsp;<span class="op" id="8026246">-</span>&nbsp;<span class="ident" id="8026248">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026256">closes</span>&nbsp;<span class="op" id="8026263">:=</span>&nbsp;<span class="ident" id="8026266">driver</span><span class="op" id="8026272">.</span><span class="ident" id="8026273">closeCount</span>&nbsp;<span class="op" id="8026284">-</span>&nbsp;<span class="ident" id="8026286">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026295">driver</span><span class="op" id="8026301">.</span><span class="ident" id="8026302">mu</span><span class="op" id="8026304">.</span><span class="ident" id="8026305">Unlock</span><span class="op" id="8026311">(</span><span class="op" id="8026312">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026316">if</span>&nbsp;<span class="ident" id="8026319">opens</span>&nbsp;<span class="op" id="8026325">&gt;</span>&nbsp;<span class="num" id="8026327">10</span>&nbsp;<span class="op" id="8026330">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026334">t</span><span class="op" id="8026335">.</span><span class="ident" id="8026336">Logf</span><span class="op" id="8026340">(</span><span class="string" id="8026341">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8026358">,</span>&nbsp;<span class="ident" id="8026360">opens</span><span class="op" id="8026365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026369">t</span><span class="op" id="8026370">.</span><span class="ident" id="8026371">Logf</span><span class="op" id="8026375">(</span><span class="string" id="8026376">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8026394">,</span>&nbsp;<span class="ident" id="8026396">closes</span><span class="op" id="8026402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026406">t</span><span class="op" id="8026407">.</span><span class="ident" id="8026408">Errorf</span><span class="op" id="8026414">(</span><span class="string" id="8026415">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8026455">,</span>&nbsp;<span class="ident" id="8026457">opens</span><span class="op" id="8026462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026466">db</span><span class="op" id="8026468">.</span><span class="ident" id="8026469">dumpDeps</span><span class="op" id="8026477">(</span><span class="ident" id="8026478">t</span><span class="op" id="8026479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026482">}</span><br>
<span class="lineno">1025</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026486">if</span>&nbsp;<span class="ident" id="8026489">err</span>&nbsp;<span class="op" id="8026493">:=</span>&nbsp;<span class="ident" id="8026496">stmt</span><span class="op" id="8026500">.</span><span class="ident" id="8026501">Close</span><span class="op" id="8026506">(</span><span class="op" id="8026507">)</span><span class="op" id="8026508">;</span>&nbsp;<span class="ident" id="8026510">err</span>&nbsp;<span class="op" id="8026514">!=</span>&nbsp;<span class="ident" id="8026517">nil</span>&nbsp;<span class="op" id="8026521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026525">t</span><span class="op" id="8026526">.</span><span class="ident" id="8026527">Fatal</span><span class="op" id="8026532">(</span><span class="ident" id="8026533">err</span><span class="op" id="8026536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026543">if</span>&nbsp;<span class="ident" id="8026546">g</span><span class="op" id="8026547">,</span>&nbsp;<span class="ident" id="8026549">w</span>&nbsp;<span class="op" id="8026551">:=</span>&nbsp;<span class="ident" id="8026554">db</span><span class="op" id="8026556">.</span><span class="ident" id="8026557">numFreeConns</span><span class="op" id="8026569">(</span><span class="op" id="8026570">)</span><span class="op" id="8026571">,</span>&nbsp;<span class="num" id="8026573">10</span><span class="op" id="8026575">;</span>&nbsp;<span class="ident" id="8026577">g</span>&nbsp;<span class="op" id="8026579">!=</span>&nbsp;<span class="ident" id="8026582">w</span>&nbsp;<span class="op" id="8026584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026588">t</span><span class="op" id="8026589">.</span><span class="ident" id="8026590">Errorf</span><span class="op" id="8026596">(</span><span class="string" id="8026597">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8026623">,</span>&nbsp;<span class="ident" id="8026625">g</span><span class="op" id="8026626">,</span>&nbsp;<span class="ident" id="8026628">w</span><span class="op" id="8026629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026636">if</span>&nbsp;<span class="ident" id="8026639">n</span>&nbsp;<span class="op" id="8026641">:=</span>&nbsp;<span class="ident" id="8026644">db</span><span class="op" id="8026646">.</span><span class="ident" id="8026647">numDepsPollUntil</span><span class="op" id="8026663">(</span><span class="num" id="8026664">10</span><span class="op" id="8026666">,</span>&nbsp;<span class="ident" id="8026668">time</span><span class="op" id="8026672">.</span><span class="ident" id="8026673">Second</span><span class="op" id="8026679">)</span><span class="op" id="8026680">;</span>&nbsp;<span class="ident" id="8026682">n</span>&nbsp;<span class="op" id="8026684">&gt;</span>&nbsp;<span class="num" id="8026686">10</span>&nbsp;<span class="op" id="8026689">{</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026693">t</span><span class="op" id="8026694">.</span><span class="ident" id="8026695">Errorf</span><span class="op" id="8026701">(</span><span class="string" id="8026702">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;10&#34;</span><span class="op" id="8026747">,</span>&nbsp;<span class="ident" id="8026749">n</span><span class="op" id="8026750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026754">db</span><span class="op" id="8026756">.</span><span class="ident" id="8026757">dumpDeps</span><span class="op" id="8026765">(</span><span class="ident" id="8026766">t</span><span class="op" id="8026767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026774">db</span><span class="op" id="8026776">.</span><span class="ident" id="8026777">SetMaxOpenConns</span><span class="op" id="8026792">(</span><span class="num" id="8026793">5</span><span class="op" id="8026794">)</span><br>
<span class="lineno">1040</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026798">if</span>&nbsp;<span class="ident" id="8026801">g</span><span class="op" id="8026802">,</span>&nbsp;<span class="ident" id="8026804">w</span>&nbsp;<span class="op" id="8026806">:=</span>&nbsp;<span class="ident" id="8026809">db</span><span class="op" id="8026811">.</span><span class="ident" id="8026812">numFreeConns</span><span class="op" id="8026824">(</span><span class="op" id="8026825">)</span><span class="op" id="8026826">,</span>&nbsp;<span class="num" id="8026828">5</span><span class="op" id="8026829">;</span>&nbsp;<span class="ident" id="8026831">g</span>&nbsp;<span class="op" id="8026833">!=</span>&nbsp;<span class="ident" id="8026836">w</span>&nbsp;<span class="op" id="8026838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026842">t</span><span class="op" id="8026843">.</span><span class="ident" id="8026844">Errorf</span><span class="op" id="8026850">(</span><span class="string" id="8026851">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8026877">,</span>&nbsp;<span class="ident" id="8026879">g</span><span class="op" id="8026880">,</span>&nbsp;<span class="ident" id="8026882">w</span><span class="op" id="8026883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8026886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8026890">if</span>&nbsp;<span class="ident" id="8026893">n</span>&nbsp;<span class="op" id="8026895">:=</span>&nbsp;<span class="ident" id="8026898">db</span><span class="op" id="8026900">.</span><span class="ident" id="8026901">numDepsPollUntil</span><span class="op" id="8026917">(</span><span class="num" id="8026918">5</span><span class="op" id="8026919">,</span>&nbsp;<span class="ident" id="8026921">time</span><span class="op" id="8026925">.</span><span class="ident" id="8026926">Second</span><span class="op" id="8026932">)</span><span class="op" id="8026933">;</span>&nbsp;<span class="ident" id="8026935">n</span>&nbsp;<span class="op" id="8026937">&gt;</span>&nbsp;<span class="num" id="8026939">5</span>&nbsp;<span class="op" id="8026941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8026945">t</span><span class="op" id="8026946">.</span><span class="ident" id="8026947">Errorf</span><span class="op" id="8026953">(</span><span class="string" id="8026954">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8026995">,</span>&nbsp;<span class="ident" id="8026997">n</span><span class="op" id="8026998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027002">db</span><span class="op" id="8027004">.</span><span class="ident" id="8027005">dumpDeps</span><span class="op" id="8027013">(</span><span class="ident" id="8027014">t</span><span class="op" id="8027015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027022">db</span><span class="op" id="8027024">.</span><span class="ident" id="8027025">SetMaxOpenConns</span><span class="op" id="8027040">(</span><span class="num" id="8027041">0</span><span class="op" id="8027042">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027046">if</span>&nbsp;<span class="ident" id="8027049">g</span><span class="op" id="8027050">,</span>&nbsp;<span class="ident" id="8027052">w</span>&nbsp;<span class="op" id="8027054">:=</span>&nbsp;<span class="ident" id="8027057">db</span><span class="op" id="8027059">.</span><span class="ident" id="8027060">numFreeConns</span><span class="op" id="8027072">(</span><span class="op" id="8027073">)</span><span class="op" id="8027074">,</span>&nbsp;<span class="num" id="8027076">5</span><span class="op" id="8027077">;</span>&nbsp;<span class="ident" id="8027079">g</span>&nbsp;<span class="op" id="8027081">!=</span>&nbsp;<span class="ident" id="8027084">w</span>&nbsp;<span class="op" id="8027086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027090">t</span><span class="op" id="8027091">.</span><span class="ident" id="8027092">Errorf</span><span class="op" id="8027098">(</span><span class="string" id="8027099">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8027125">,</span>&nbsp;<span class="ident" id="8027127">g</span><span class="op" id="8027128">,</span>&nbsp;<span class="ident" id="8027130">w</span><span class="op" id="8027131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027134">}</span><br>
<span class="lineno">1055</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027138">if</span>&nbsp;<span class="ident" id="8027141">n</span>&nbsp;<span class="op" id="8027143">:=</span>&nbsp;<span class="ident" id="8027146">db</span><span class="op" id="8027148">.</span><span class="ident" id="8027149">numDepsPollUntil</span><span class="op" id="8027165">(</span><span class="num" id="8027166">5</span><span class="op" id="8027167">,</span>&nbsp;<span class="ident" id="8027169">time</span><span class="op" id="8027173">.</span><span class="ident" id="8027174">Second</span><span class="op" id="8027180">)</span><span class="op" id="8027181">;</span>&nbsp;<span class="ident" id="8027183">n</span>&nbsp;<span class="op" id="8027185">&gt;</span>&nbsp;<span class="num" id="8027187">5</span>&nbsp;<span class="op" id="8027189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027193">t</span><span class="op" id="8027194">.</span><span class="ident" id="8027195">Errorf</span><span class="op" id="8027201">(</span><span class="string" id="8027202">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8027243">,</span>&nbsp;<span class="ident" id="8027245">n</span><span class="op" id="8027246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027250">db</span><span class="op" id="8027252">.</span><span class="ident" id="8027253">dumpDeps</span><span class="op" id="8027261">(</span><span class="ident" id="8027262">t</span><span class="op" id="8027263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027266">}</span><br>
<span class="lineno">1060</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027270">db</span><span class="op" id="8027272">.</span><span class="ident" id="8027273">SetMaxIdleConns</span><span class="op" id="8027288">(</span><span class="num" id="8027289">0</span><span class="op" id="8027290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027294">if</span>&nbsp;<span class="ident" id="8027297">g</span><span class="op" id="8027298">,</span>&nbsp;<span class="ident" id="8027300">w</span>&nbsp;<span class="op" id="8027302">:=</span>&nbsp;<span class="ident" id="8027305">db</span><span class="op" id="8027307">.</span><span class="ident" id="8027308">numFreeConns</span><span class="op" id="8027320">(</span><span class="op" id="8027321">)</span><span class="op" id="8027322">,</span>&nbsp;<span class="num" id="8027324">0</span><span class="op" id="8027325">;</span>&nbsp;<span class="ident" id="8027327">g</span>&nbsp;<span class="op" id="8027329">!=</span>&nbsp;<span class="ident" id="8027332">w</span>&nbsp;<span class="op" id="8027334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027338">t</span><span class="op" id="8027339">.</span><span class="ident" id="8027340">Errorf</span><span class="op" id="8027346">(</span><span class="string" id="8027347">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8027373">,</span>&nbsp;<span class="ident" id="8027375">g</span><span class="op" id="8027376">,</span>&nbsp;<span class="ident" id="8027378">w</span><span class="op" id="8027379">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027386">if</span>&nbsp;<span class="ident" id="8027389">n</span>&nbsp;<span class="op" id="8027391">:=</span>&nbsp;<span class="ident" id="8027394">db</span><span class="op" id="8027396">.</span><span class="ident" id="8027397">numDepsPollUntil</span><span class="op" id="8027413">(</span><span class="num" id="8027414">0</span><span class="op" id="8027415">,</span>&nbsp;<span class="ident" id="8027417">time</span><span class="op" id="8027421">.</span><span class="ident" id="8027422">Second</span><span class="op" id="8027428">)</span><span class="op" id="8027429">;</span>&nbsp;<span class="ident" id="8027431">n</span>&nbsp;<span class="op" id="8027433">&gt;</span>&nbsp;<span class="num" id="8027435">0</span>&nbsp;<span class="op" id="8027437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027441">t</span><span class="op" id="8027442">.</span><span class="ident" id="8027443">Errorf</span><span class="op" id="8027449">(</span><span class="string" id="8027450">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8027491">,</span>&nbsp;<span class="ident" id="8027493">n</span><span class="op" id="8027494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027498">db</span><span class="op" id="8027500">.</span><span class="ident" id="8027501">dumpDeps</span><span class="op" id="8027509">(</span><span class="ident" id="8027510">t</span><span class="op" id="8027511">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027514">}</span><br>
<span class="lineno"></span><span class="op" id="8027516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8027519">func</span>&nbsp;<span class="ident" id="8027524">TestSingleOpenConn</span><span class="op" id="8027542">(</span><span class="ident" id="8027543">t</span>&nbsp;<span class="op" id="8027545">*</span><span class="ident" id="8027546">testing</span><span class="op" id="8027553">.</span><span class="ident" id="8027554">T</span><span class="op" id="8027555">)</span>&nbsp;<span class="op" id="8027557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027560">db</span>&nbsp;<span class="op" id="8027563">:=</span>&nbsp;<span class="ident" id="8027566">newTestDB</span><span class="op" id="8027575">(</span><span class="ident" id="8027576">t</span><span class="op" id="8027577">,</span>&nbsp;<span class="string" id="8027579">&#34;people&#34;</span><span class="op" id="8027587">)</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027590">defer</span>&nbsp;<span class="ident" id="8027596">closeDB</span><span class="op" id="8027603">(</span><span class="ident" id="8027604">t</span><span class="op" id="8027605">,</span>&nbsp;<span class="ident" id="8027607">db</span><span class="op" id="8027609">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027613">db</span><span class="op" id="8027615">.</span><span class="ident" id="8027616">SetMaxOpenConns</span><span class="op" id="8027631">(</span><span class="num" id="8027632">1</span><span class="op" id="8027633">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027637">rows</span><span class="op" id="8027641">,</span>&nbsp;<span class="ident" id="8027643">err</span>&nbsp;<span class="op" id="8027647">:=</span>&nbsp;<span class="ident" id="8027650">db</span><span class="op" id="8027652">.</span><span class="ident" id="8027653">Query</span><span class="op" id="8027658">(</span><span class="string" id="8027659">&#34;SELECT|people|name|&#34;</span><span class="op" id="8027680">)</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027683">if</span>&nbsp;<span class="ident" id="8027686">err</span>&nbsp;<span class="op" id="8027690">!=</span>&nbsp;<span class="ident" id="8027693">nil</span>&nbsp;<span class="op" id="8027697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027701">t</span><span class="op" id="8027702">.</span><span class="ident" id="8027703">Fatal</span><span class="op" id="8027708">(</span><span class="ident" id="8027709">err</span><span class="op" id="8027712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027718">if</span>&nbsp;<span class="ident" id="8027721">err</span>&nbsp;<span class="op" id="8027725">=</span>&nbsp;<span class="ident" id="8027727">rows</span><span class="op" id="8027731">.</span><span class="ident" id="8027732">Close</span><span class="op" id="8027737">(</span><span class="op" id="8027738">)</span><span class="op" id="8027739">;</span>&nbsp;<span class="ident" id="8027741">err</span>&nbsp;<span class="op" id="8027745">!=</span>&nbsp;<span class="ident" id="8027748">nil</span>&nbsp;<span class="op" id="8027752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027756">t</span><span class="op" id="8027757">.</span><span class="ident" id="8027758">Fatal</span><span class="op" id="8027763">(</span><span class="ident" id="8027764">err</span><span class="op" id="8027767">)</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8027773">//&nbsp;shouldn&#39;t&nbsp;deadlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027796">rows</span><span class="op" id="8027800">,</span>&nbsp;<span class="ident" id="8027802">err</span>&nbsp;<span class="op" id="8027806">=</span>&nbsp;<span class="ident" id="8027808">db</span><span class="op" id="8027810">.</span><span class="ident" id="8027811">Query</span><span class="op" id="8027816">(</span><span class="string" id="8027817">&#34;SELECT|people|name|&#34;</span><span class="op" id="8027838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027841">if</span>&nbsp;<span class="ident" id="8027844">err</span>&nbsp;<span class="op" id="8027848">!=</span>&nbsp;<span class="ident" id="8027851">nil</span>&nbsp;<span class="op" id="8027855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027859">t</span><span class="op" id="8027860">.</span><span class="ident" id="8027861">Fatal</span><span class="op" id="8027866">(</span><span class="ident" id="8027867">err</span><span class="op" id="8027870">)</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027876">if</span>&nbsp;<span class="ident" id="8027879">err</span>&nbsp;<span class="op" id="8027883">=</span>&nbsp;<span class="ident" id="8027885">rows</span><span class="op" id="8027889">.</span><span class="ident" id="8027890">Close</span><span class="op" id="8027895">(</span><span class="op" id="8027896">)</span><span class="op" id="8027897">;</span>&nbsp;<span class="ident" id="8027899">err</span>&nbsp;<span class="op" id="8027903">!=</span>&nbsp;<span class="ident" id="8027906">nil</span>&nbsp;<span class="op" id="8027910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8027914">t</span><span class="op" id="8027915">.</span><span class="ident" id="8027916">Fatal</span><span class="op" id="8027921">(</span><span class="ident" id="8027922">err</span><span class="op" id="8027925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8027928">}</span><br>
<span class="lineno"></span><span class="op" id="8027930">}</span><br>
<span class="lineno">1095</span><br>
<span class="lineno"></span><span class="comment" id="8027933">//&nbsp;golang.org/issue/5323</span><br>
<span class="lineno"></span><span class="keyword" id="8027958">func</span>&nbsp;<span class="ident" id="8027963">TestStmtCloseDeps</span><span class="op" id="8027980">(</span><span class="ident" id="8027981">t</span>&nbsp;<span class="op" id="8027983">*</span><span class="ident" id="8027984">testing</span><span class="op" id="8027991">.</span><span class="ident" id="8027992">T</span><span class="op" id="8027993">)</span>&nbsp;<span class="op" id="8027995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8027998">if</span>&nbsp;<span class="ident" id="8028001">testing</span><span class="op" id="8028008">.</span><span class="ident" id="8028009">Short</span><span class="op" id="8028014">(</span><span class="op" id="8028015">)</span>&nbsp;<span class="op" id="8028017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028021">t</span><span class="op" id="8028022">.</span><span class="ident" id="8028023">Skip</span><span class="op" id="8028027">(</span><span class="string" id="8028028">&#34;skipping&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8028052">)</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028058">defer</span>&nbsp;<span class="ident" id="8028064">setHookpostCloseConn</span><span class="op" id="8028084">(</span><span class="ident" id="8028085">nil</span><span class="op" id="8028088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028091">setHookpostCloseConn</span><span class="op" id="8028111">(</span><span class="keyword" id="8028112">func</span><span class="op" id="8028116">(</span><span class="ident" id="8028117">_</span>&nbsp;<span class="op" id="8028119">*</span><span class="ident" id="8028120">fakeConn</span><span class="op" id="8028128">,</span>&nbsp;<span class="ident" id="8028130">err</span>&nbsp;<span class="builtintype" id="8028134">error</span><span class="op" id="8028139">)</span>&nbsp;<span class="op" id="8028141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028145">if</span>&nbsp;<span class="ident" id="8028148">err</span>&nbsp;<span class="op" id="8028152">!=</span>&nbsp;<span class="ident" id="8028155">nil</span>&nbsp;<span class="op" id="8028159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028164">t</span><span class="op" id="8028165">.</span><span class="ident" id="8028166">Errorf</span><span class="op" id="8028172">(</span><span class="string" id="8028173">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="8028201">,</span>&nbsp;<span class="ident" id="8028203">err</span><span class="op" id="8028206">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028213">}</span><span class="op" id="8028214">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028218">db</span>&nbsp;<span class="op" id="8028221">:=</span>&nbsp;<span class="ident" id="8028224">newTestDB</span><span class="op" id="8028233">(</span><span class="ident" id="8028234">t</span><span class="op" id="8028235">,</span>&nbsp;<span class="string" id="8028237">&#34;magicquery&#34;</span><span class="op" id="8028249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028252">defer</span>&nbsp;<span class="ident" id="8028258">closeDB</span><span class="op" id="8028265">(</span><span class="ident" id="8028266">t</span><span class="op" id="8028267">,</span>&nbsp;<span class="ident" id="8028269">db</span><span class="op" id="8028271">)</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028275">driver</span>&nbsp;<span class="op" id="8028282">:=</span>&nbsp;<span class="ident" id="8028285">db</span><span class="op" id="8028287">.</span><span class="ident" id="8028288">driver</span><span class="op" id="8028294">.</span><span class="op" id="8028295">(</span><span class="op" id="8028296">*</span><span class="ident" id="8028297">fakeDriver</span><span class="op" id="8028307">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028311">driver</span><span class="op" id="8028317">.</span><span class="ident" id="8028318">mu</span><span class="op" id="8028320">.</span><span class="ident" id="8028321">Lock</span><span class="op" id="8028325">(</span><span class="op" id="8028326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028329">opens0</span>&nbsp;<span class="op" id="8028336">:=</span>&nbsp;<span class="ident" id="8028339">driver</span><span class="op" id="8028345">.</span><span class="ident" id="8028346">openCount</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028357">closes0</span>&nbsp;<span class="op" id="8028365">:=</span>&nbsp;<span class="ident" id="8028368">driver</span><span class="op" id="8028374">.</span><span class="ident" id="8028375">closeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028387">driver</span><span class="op" id="8028393">.</span><span class="ident" id="8028394">mu</span><span class="op" id="8028396">.</span><span class="ident" id="8028397">Unlock</span><span class="op" id="8028403">(</span><span class="op" id="8028404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028407">openDelta0</span>&nbsp;<span class="op" id="8028418">:=</span>&nbsp;<span class="ident" id="8028421">opens0</span>&nbsp;<span class="op" id="8028428">-</span>&nbsp;<span class="ident" id="8028430">closes0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028440">stmt</span><span class="op" id="8028444">,</span>&nbsp;<span class="ident" id="8028446">err</span>&nbsp;<span class="op" id="8028450">:=</span>&nbsp;<span class="ident" id="8028453">db</span><span class="op" id="8028455">.</span><span class="ident" id="8028456">Prepare</span><span class="op" id="8028463">(</span><span class="string" id="8028464">&#34;SELECT|magicquery|op|op=?,millis=?&#34;</span><span class="op" id="8028500">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028503">if</span>&nbsp;<span class="ident" id="8028506">err</span>&nbsp;<span class="op" id="8028510">!=</span>&nbsp;<span class="ident" id="8028513">nil</span>&nbsp;<span class="op" id="8028517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028521">t</span><span class="op" id="8028522">.</span><span class="ident" id="8028523">Fatal</span><span class="op" id="8028528">(</span><span class="ident" id="8028529">err</span><span class="op" id="8028532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8028539">//&nbsp;Start&nbsp;50&nbsp;parallel&nbsp;slow&nbsp;queries.</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028575">const</span>&nbsp;<span class="op" id="8028581">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028585">nquery</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028597">=</span>&nbsp;<span class="num" id="8028599">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028604">sleepMillis</span>&nbsp;<span class="op" id="8028616">=</span>&nbsp;<span class="num" id="8028618">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028623">nbatch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8028635">=</span>&nbsp;<span class="num" id="8028637">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028640">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028643">var</span>&nbsp;<span class="ident" id="8028647">wg</span>&nbsp;<span class="ident" id="8028650">sync</span><span class="op" id="8028654">.</span><span class="ident" id="8028655">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028666">for</span>&nbsp;<span class="ident" id="8028670">batch</span>&nbsp;<span class="op" id="8028676">:=</span>&nbsp;<span class="num" id="8028679">0</span><span class="op" id="8028680">;</span>&nbsp;<span class="ident" id="8028682">batch</span>&nbsp;<span class="op" id="8028688">&lt;</span>&nbsp;<span class="ident" id="8028690">nbatch</span><span class="op" id="8028696">;</span>&nbsp;<span class="ident" id="8028698">batch</span><span class="op" id="8028703">++</span>&nbsp;<span class="op" id="8028706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028710">for</span>&nbsp;<span class="ident" id="8028714">i</span>&nbsp;<span class="op" id="8028716">:=</span>&nbsp;<span class="num" id="8028719">0</span><span class="op" id="8028720">;</span>&nbsp;<span class="ident" id="8028722">i</span>&nbsp;<span class="op" id="8028724">&lt;</span>&nbsp;<span class="ident" id="8028726">nquery</span><span class="op" id="8028732">;</span>&nbsp;<span class="ident" id="8028734">i</span><span class="op" id="8028735">++</span>&nbsp;<span class="op" id="8028738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028743">wg</span><span class="op" id="8028745">.</span><span class="ident" id="8028746">Add</span><span class="op" id="8028749">(</span><span class="num" id="8028750">1</span><span class="op" id="8028751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028756">go</span>&nbsp;<span class="keyword" id="8028759">func</span><span class="op" id="8028763">(</span><span class="op" id="8028764">)</span>&nbsp;<span class="op" id="8028766">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028772">defer</span>&nbsp;<span class="ident" id="8028778">wg</span><span class="op" id="8028780">.</span><span class="ident" id="8028781">Done</span><span class="op" id="8028785">(</span><span class="op" id="8028786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028792">var</span>&nbsp;<span class="ident" id="8028796">op</span>&nbsp;<span class="builtintype" id="8028799">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8028810">if</span>&nbsp;<span class="ident" id="8028813">err</span>&nbsp;<span class="op" id="8028817">:=</span>&nbsp;<span class="ident" id="8028820">stmt</span><span class="op" id="8028824">.</span><span class="ident" id="8028825">QueryRow</span><span class="op" id="8028833">(</span><span class="string" id="8028834">&#34;sleep&#34;</span><span class="op" id="8028841">,</span>&nbsp;<span class="ident" id="8028843">sleepMillis</span><span class="op" id="8028854">)</span><span class="op" id="8028855">.</span><span class="ident" id="8028856">Scan</span><span class="op" id="8028860">(</span><span class="op" id="8028861">&amp;</span><span class="ident" id="8028862">op</span><span class="op" id="8028864">)</span><span class="op" id="8028865">;</span>&nbsp;<span class="ident" id="8028867">err</span>&nbsp;<span class="op" id="8028871">!=</span>&nbsp;<span class="ident" id="8028874">nil</span>&nbsp;<span class="op" id="8028878">&amp;&amp;</span>&nbsp;<span class="ident" id="8028881">err</span>&nbsp;<span class="op" id="8028885">!=</span>&nbsp;<span class="ident" id="8028888">ErrNoRows</span>&nbsp;<span class="op" id="8028898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8028905">t</span><span class="op" id="8028906">.</span><span class="ident" id="8028907">Error</span><span class="op" id="8028912">(</span><span class="ident" id="8028913">err</span><span class="op" id="8028916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028922">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028927">}</span><span class="op" id="8028928">(</span><span class="op" id="8028929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8028933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8028937">//&nbsp;Sleep&nbsp;for&nbsp;twice&nbsp;the&nbsp;expected&nbsp;length&nbsp;of&nbsp;time&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8028994">//&nbsp;batch&nbsp;of&nbsp;50&nbsp;queries&nbsp;above&nbsp;to&nbsp;finish&nbsp;before&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8029051">//&nbsp;the&nbsp;next&nbsp;round.</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029072">time</span><span class="op" id="8029076">.</span><span class="ident" id="8029077">Sleep</span><span class="op" id="8029082">(</span><span class="num" id="8029083">2</span>&nbsp;<span class="op" id="8029085">*</span>&nbsp;<span class="ident" id="8029087">sleepMillis</span>&nbsp;<span class="op" id="8029099">*</span>&nbsp;<span class="ident" id="8029101">time</span><span class="op" id="8029105">.</span><span class="ident" id="8029106">Millisecond</span><span class="op" id="8029117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029123">wg</span><span class="op" id="8029125">.</span><span class="ident" id="8029126">Wait</span><span class="op" id="8029130">(</span><span class="op" id="8029131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029135">if</span>&nbsp;<span class="ident" id="8029138">g</span><span class="op" id="8029139">,</span>&nbsp;<span class="ident" id="8029141">w</span>&nbsp;<span class="op" id="8029143">:=</span>&nbsp;<span class="ident" id="8029146">db</span><span class="op" id="8029148">.</span><span class="ident" id="8029149">numFreeConns</span><span class="op" id="8029161">(</span><span class="op" id="8029162">)</span><span class="op" id="8029163">,</span>&nbsp;<span class="num" id="8029165">2</span><span class="op" id="8029166">;</span>&nbsp;<span class="ident" id="8029168">g</span>&nbsp;<span class="op" id="8029170">!=</span>&nbsp;<span class="ident" id="8029173">w</span>&nbsp;<span class="op" id="8029175">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029179">t</span><span class="op" id="8029180">.</span><span class="ident" id="8029181">Errorf</span><span class="op" id="8029187">(</span><span class="string" id="8029188">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8029214">,</span>&nbsp;<span class="ident" id="8029216">g</span><span class="op" id="8029217">,</span>&nbsp;<span class="ident" id="8029219">w</span><span class="op" id="8029220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029227">if</span>&nbsp;<span class="ident" id="8029230">n</span>&nbsp;<span class="op" id="8029232">:=</span>&nbsp;<span class="ident" id="8029235">db</span><span class="op" id="8029237">.</span><span class="ident" id="8029238">numDepsPollUntil</span><span class="op" id="8029254">(</span><span class="num" id="8029255">4</span><span class="op" id="8029256">,</span>&nbsp;<span class="ident" id="8029258">time</span><span class="op" id="8029262">.</span><span class="ident" id="8029263">Second</span><span class="op" id="8029269">)</span><span class="op" id="8029270">;</span>&nbsp;<span class="ident" id="8029272">n</span>&nbsp;<span class="op" id="8029274">&gt;</span>&nbsp;<span class="num" id="8029276">4</span>&nbsp;<span class="op" id="8029278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029282">t</span><span class="op" id="8029283">.</span><span class="ident" id="8029284">Errorf</span><span class="op" id="8029290">(</span><span class="string" id="8029291">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;4&#34;</span><span class="op" id="8029335">,</span>&nbsp;<span class="ident" id="8029337">n</span><span class="op" id="8029338">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029342">db</span><span class="op" id="8029344">.</span><span class="ident" id="8029345">dumpDeps</span><span class="op" id="8029353">(</span><span class="ident" id="8029354">t</span><span class="op" id="8029355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029362">driver</span><span class="op" id="8029368">.</span><span class="ident" id="8029369">mu</span><span class="op" id="8029371">.</span><span class="ident" id="8029372">Lock</span><span class="op" id="8029376">(</span><span class="op" id="8029377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029380">opens</span>&nbsp;<span class="op" id="8029386">:=</span>&nbsp;<span class="ident" id="8029389">driver</span><span class="op" id="8029395">.</span><span class="ident" id="8029396">openCount</span>&nbsp;<span class="op" id="8029406">-</span>&nbsp;<span class="ident" id="8029408">opens0</span><br>
<span class="lineno">1160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029416">closes</span>&nbsp;<span class="op" id="8029423">:=</span>&nbsp;<span class="ident" id="8029426">driver</span><span class="op" id="8029432">.</span><span class="ident" id="8029433">closeCount</span>&nbsp;<span class="op" id="8029444">-</span>&nbsp;<span class="ident" id="8029446">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029455">openDelta</span>&nbsp;<span class="op" id="8029465">:=</span>&nbsp;<span class="op" id="8029468">(</span><span class="ident" id="8029469">driver</span><span class="op" id="8029475">.</span><span class="ident" id="8029476">openCount</span>&nbsp;<span class="op" id="8029486">-</span>&nbsp;<span class="ident" id="8029488">driver</span><span class="op" id="8029494">.</span><span class="ident" id="8029495">closeCount</span><span class="op" id="8029505">)</span>&nbsp;<span class="op" id="8029507">-</span>&nbsp;<span class="ident" id="8029509">openDelta0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029521">driver</span><span class="op" id="8029527">.</span><span class="ident" id="8029528">mu</span><span class="op" id="8029530">.</span><span class="ident" id="8029531">Unlock</span><span class="op" id="8029537">(</span><span class="op" id="8029538">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029542">if</span>&nbsp;<span class="ident" id="8029545">openDelta</span>&nbsp;<span class="op" id="8029555">&gt;</span>&nbsp;<span class="num" id="8029557">2</span>&nbsp;<span class="op" id="8029559">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029563">t</span><span class="op" id="8029564">.</span><span class="ident" id="8029565">Logf</span><span class="op" id="8029569">(</span><span class="string" id="8029570">&#34;open&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8029587">,</span>&nbsp;<span class="ident" id="8029589">opens</span><span class="op" id="8029594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029598">t</span><span class="op" id="8029599">.</span><span class="ident" id="8029600">Logf</span><span class="op" id="8029604">(</span><span class="string" id="8029605">&#34;close&nbsp;calls&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8029623">,</span>&nbsp;<span class="ident" id="8029625">closes</span><span class="op" id="8029631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029635">t</span><span class="op" id="8029636">.</span><span class="ident" id="8029637">Logf</span><span class="op" id="8029641">(</span><span class="string" id="8029642">&#34;open&nbsp;delta&nbsp;=&nbsp;%d&#34;</span><span class="op" id="8029659">,</span>&nbsp;<span class="ident" id="8029661">openDelta</span><span class="op" id="8029670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029674">t</span><span class="op" id="8029675">.</span><span class="ident" id="8029676">Errorf</span><span class="op" id="8029682">(</span><span class="string" id="8029683">&#34;db&nbsp;connections&nbsp;opened&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8029722">,</span>&nbsp;<span class="ident" id="8029724">openDelta</span><span class="op" id="8029733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029737">db</span><span class="op" id="8029739">.</span><span class="ident" id="8029740">dumpDeps</span><span class="op" id="8029748">(</span><span class="ident" id="8029749">t</span><span class="op" id="8029750">)</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029757">if</span>&nbsp;<span class="builtinfunc" id="8029760">len</span><span class="op" id="8029763">(</span><span class="ident" id="8029764">stmt</span><span class="op" id="8029768">.</span><span class="ident" id="8029769">css</span><span class="op" id="8029772">)</span>&nbsp;<span class="op" id="8029774">&gt;</span>&nbsp;<span class="ident" id="8029776">nquery</span>&nbsp;<span class="op" id="8029783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029787">t</span><span class="op" id="8029788">.</span><span class="ident" id="8029789">Errorf</span><span class="op" id="8029795">(</span><span class="string" id="8029796">&#34;len(stmt.css)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;%d&#34;</span><span class="op" id="8029828">,</span>&nbsp;<span class="builtinfunc" id="8029830">len</span><span class="op" id="8029833">(</span><span class="ident" id="8029834">stmt</span><span class="op" id="8029838">.</span><span class="ident" id="8029839">css</span><span class="op" id="8029842">)</span><span class="op" id="8029843">,</span>&nbsp;<span class="ident" id="8029845">nquery</span><span class="op" id="8029851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029854">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029858">if</span>&nbsp;<span class="ident" id="8029861">err</span>&nbsp;<span class="op" id="8029865">:=</span>&nbsp;<span class="ident" id="8029868">stmt</span><span class="op" id="8029872">.</span><span class="ident" id="8029873">Close</span><span class="op" id="8029878">(</span><span class="op" id="8029879">)</span><span class="op" id="8029880">;</span>&nbsp;<span class="ident" id="8029882">err</span>&nbsp;<span class="op" id="8029886">!=</span>&nbsp;<span class="ident" id="8029889">nil</span>&nbsp;<span class="op" id="8029893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029897">t</span><span class="op" id="8029898">.</span><span class="ident" id="8029899">Fatal</span><span class="op" id="8029904">(</span><span class="ident" id="8029905">err</span><span class="op" id="8029908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8029911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8029915">if</span>&nbsp;<span class="ident" id="8029918">g</span><span class="op" id="8029919">,</span>&nbsp;<span class="ident" id="8029921">w</span>&nbsp;<span class="op" id="8029923">:=</span>&nbsp;<span class="ident" id="8029926">db</span><span class="op" id="8029928">.</span><span class="ident" id="8029929">numFreeConns</span><span class="op" id="8029941">(</span><span class="op" id="8029942">)</span><span class="op" id="8029943">,</span>&nbsp;<span class="num" id="8029945">2</span><span class="op" id="8029946">;</span>&nbsp;<span class="ident" id="8029948">g</span>&nbsp;<span class="op" id="8029950">!=</span>&nbsp;<span class="ident" id="8029953">w</span>&nbsp;<span class="op" id="8029955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8029959">t</span><span class="op" id="8029960">.</span><span class="ident" id="8029961">Errorf</span><span class="op" id="8029967">(</span><span class="string" id="8029968">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8029994">,</span>&nbsp;<span class="ident" id="8029996">g</span><span class="op" id="8029997">,</span>&nbsp;<span class="ident" id="8029999">w</span><span class="op" id="8030000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030007">if</span>&nbsp;<span class="ident" id="8030010">n</span>&nbsp;<span class="op" id="8030012">:=</span>&nbsp;<span class="ident" id="8030015">db</span><span class="op" id="8030017">.</span><span class="ident" id="8030018">numDepsPollUntil</span><span class="op" id="8030034">(</span><span class="num" id="8030035">2</span><span class="op" id="8030036">,</span>&nbsp;<span class="ident" id="8030038">time</span><span class="op" id="8030042">.</span><span class="ident" id="8030043">Second</span><span class="op" id="8030049">)</span><span class="op" id="8030050">;</span>&nbsp;<span class="ident" id="8030052">n</span>&nbsp;<span class="op" id="8030054">&gt;</span>&nbsp;<span class="num" id="8030056">2</span>&nbsp;<span class="op" id="8030058">{</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030062">t</span><span class="op" id="8030063">.</span><span class="ident" id="8030064">Errorf</span><span class="op" id="8030070">(</span><span class="string" id="8030071">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;&lt;=&nbsp;2&#34;</span><span class="op" id="8030115">,</span>&nbsp;<span class="ident" id="8030117">n</span><span class="op" id="8030118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030122">db</span><span class="op" id="8030124">.</span><span class="ident" id="8030125">dumpDeps</span><span class="op" id="8030133">(</span><span class="ident" id="8030134">t</span><span class="op" id="8030135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030142">db</span><span class="op" id="8030144">.</span><span class="ident" id="8030145">SetMaxIdleConns</span><span class="op" id="8030160">(</span><span class="num" id="8030161">0</span><span class="op" id="8030162">)</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030166">if</span>&nbsp;<span class="ident" id="8030169">g</span><span class="op" id="8030170">,</span>&nbsp;<span class="ident" id="8030172">w</span>&nbsp;<span class="op" id="8030174">:=</span>&nbsp;<span class="ident" id="8030177">db</span><span class="op" id="8030179">.</span><span class="ident" id="8030180">numFreeConns</span><span class="op" id="8030192">(</span><span class="op" id="8030193">)</span><span class="op" id="8030194">,</span>&nbsp;<span class="num" id="8030196">0</span><span class="op" id="8030197">;</span>&nbsp;<span class="ident" id="8030199">g</span>&nbsp;<span class="op" id="8030201">!=</span>&nbsp;<span class="ident" id="8030204">w</span>&nbsp;<span class="op" id="8030206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030210">t</span><span class="op" id="8030211">.</span><span class="ident" id="8030212">Errorf</span><span class="op" id="8030218">(</span><span class="string" id="8030219">&#34;free&nbsp;conns&nbsp;=&nbsp;%d;&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8030245">,</span>&nbsp;<span class="ident" id="8030247">g</span><span class="op" id="8030248">,</span>&nbsp;<span class="ident" id="8030250">w</span><span class="op" id="8030251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030258">if</span>&nbsp;<span class="ident" id="8030261">n</span>&nbsp;<span class="op" id="8030263">:=</span>&nbsp;<span class="ident" id="8030266">db</span><span class="op" id="8030268">.</span><span class="ident" id="8030269">numDepsPollUntil</span><span class="op" id="8030285">(</span><span class="num" id="8030286">0</span><span class="op" id="8030287">,</span>&nbsp;<span class="ident" id="8030289">time</span><span class="op" id="8030293">.</span><span class="ident" id="8030294">Second</span><span class="op" id="8030300">)</span><span class="op" id="8030301">;</span>&nbsp;<span class="ident" id="8030303">n</span>&nbsp;<span class="op" id="8030305">&gt;</span>&nbsp;<span class="num" id="8030307">0</span>&nbsp;<span class="op" id="8030309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030313">t</span><span class="op" id="8030314">.</span><span class="ident" id="8030315">Errorf</span><span class="op" id="8030321">(</span><span class="string" id="8030322">&#34;number&nbsp;of&nbsp;dependencies&nbsp;=&nbsp;%d;&nbsp;expected&nbsp;0&#34;</span><span class="op" id="8030363">,</span>&nbsp;<span class="ident" id="8030365">n</span><span class="op" id="8030366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030370">db</span><span class="op" id="8030372">.</span><span class="ident" id="8030373">dumpDeps</span><span class="op" id="8030381">(</span><span class="ident" id="8030382">t</span><span class="op" id="8030383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030386">}</span><br>
<span class="lineno"></span><span class="op" id="8030388">}</span><br>
<span class="lineno">1200</span><br>
<span class="lineno"></span><span class="comment" id="8030391">//&nbsp;golang.org/issue/5046</span><br>
<span class="lineno"></span><span class="keyword" id="8030416">func</span>&nbsp;<span class="ident" id="8030421">TestCloseConnBeforeStmts</span><span class="op" id="8030445">(</span><span class="ident" id="8030446">t</span>&nbsp;<span class="op" id="8030448">*</span><span class="ident" id="8030449">testing</span><span class="op" id="8030456">.</span><span class="ident" id="8030457">T</span><span class="op" id="8030458">)</span>&nbsp;<span class="op" id="8030460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030463">db</span>&nbsp;<span class="op" id="8030466">:=</span>&nbsp;<span class="ident" id="8030469">newTestDB</span><span class="op" id="8030478">(</span><span class="ident" id="8030479">t</span><span class="op" id="8030480">,</span>&nbsp;<span class="string" id="8030482">&#34;people&#34;</span><span class="op" id="8030490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030493">defer</span>&nbsp;<span class="ident" id="8030499">closeDB</span><span class="op" id="8030506">(</span><span class="ident" id="8030507">t</span><span class="op" id="8030508">,</span>&nbsp;<span class="ident" id="8030510">db</span><span class="op" id="8030512">)</span><br>
<span class="lineno">1205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030516">defer</span>&nbsp;<span class="ident" id="8030522">setHookpostCloseConn</span><span class="op" id="8030542">(</span><span class="ident" id="8030543">nil</span><span class="op" id="8030546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030549">setHookpostCloseConn</span><span class="op" id="8030569">(</span><span class="keyword" id="8030570">func</span><span class="op" id="8030574">(</span><span class="ident" id="8030575">_</span>&nbsp;<span class="op" id="8030577">*</span><span class="ident" id="8030578">fakeConn</span><span class="op" id="8030586">,</span>&nbsp;<span class="ident" id="8030588">err</span>&nbsp;<span class="builtintype" id="8030592">error</span><span class="op" id="8030597">)</span>&nbsp;<span class="op" id="8030599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030603">if</span>&nbsp;<span class="ident" id="8030606">err</span>&nbsp;<span class="op" id="8030610">!=</span>&nbsp;<span class="ident" id="8030613">nil</span>&nbsp;<span class="op" id="8030617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030622">t</span><span class="op" id="8030623">.</span><span class="ident" id="8030624">Errorf</span><span class="op" id="8030630">(</span><span class="string" id="8030631">&#34;Error&nbsp;closing&nbsp;fakeConn:&nbsp;%v;&nbsp;from&nbsp;%s&#34;</span><span class="op" id="8030668">,</span>&nbsp;<span class="ident" id="8030670">err</span><span class="op" id="8030673">,</span>&nbsp;<span class="ident" id="8030675">stack</span><span class="op" id="8030680">(</span><span class="op" id="8030681">)</span><span class="op" id="8030682">)</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030687">db</span><span class="op" id="8030689">.</span><span class="ident" id="8030690">dumpDeps</span><span class="op" id="8030698">(</span><span class="ident" id="8030699">t</span><span class="op" id="8030700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030705">t</span><span class="op" id="8030706">.</span><span class="ident" id="8030707">Errorf</span><span class="op" id="8030713">(</span><span class="string" id="8030714">&#34;DB&nbsp;=&nbsp;%#v&#34;</span><span class="op" id="8030724">,</span>&nbsp;<span class="ident" id="8030726">db</span><span class="op" id="8030728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030735">}</span><span class="op" id="8030736">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030740">stmt</span><span class="op" id="8030744">,</span>&nbsp;<span class="ident" id="8030746">err</span>&nbsp;<span class="op" id="8030750">:=</span>&nbsp;<span class="ident" id="8030753">db</span><span class="op" id="8030755">.</span><span class="ident" id="8030756">Prepare</span><span class="op" id="8030763">(</span><span class="string" id="8030764">&#34;SELECT|people|name|&#34;</span><span class="op" id="8030785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030788">if</span>&nbsp;<span class="ident" id="8030791">err</span>&nbsp;<span class="op" id="8030795">!=</span>&nbsp;<span class="ident" id="8030798">nil</span>&nbsp;<span class="op" id="8030802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030806">t</span><span class="op" id="8030807">.</span><span class="ident" id="8030808">Fatal</span><span class="op" id="8030813">(</span><span class="ident" id="8030814">err</span><span class="op" id="8030817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030824">if</span>&nbsp;<span class="builtinfunc" id="8030827">len</span><span class="op" id="8030830">(</span><span class="ident" id="8030831">db</span><span class="op" id="8030833">.</span><span class="ident" id="8030834">freeConn</span><span class="op" id="8030842">)</span>&nbsp;<span class="op" id="8030844">!=</span>&nbsp;<span class="num" id="8030847">1</span>&nbsp;<span class="op" id="8030849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030853">t</span><span class="op" id="8030854">.</span><span class="ident" id="8030855">Fatalf</span><span class="op" id="8030861">(</span><span class="string" id="8030862">&#34;expected&nbsp;1&nbsp;freeConn;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="8030891">,</span>&nbsp;<span class="builtinfunc" id="8030893">len</span><span class="op" id="8030896">(</span><span class="ident" id="8030897">db</span><span class="op" id="8030899">.</span><span class="ident" id="8030900">freeConn</span><span class="op" id="8030908">)</span><span class="op" id="8030909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030915">dc</span>&nbsp;<span class="op" id="8030918">:=</span>&nbsp;<span class="ident" id="8030921">db</span><span class="op" id="8030923">.</span><span class="ident" id="8030924">freeConn</span><span class="op" id="8030932">[</span><span class="num" id="8030933">0</span><span class="op" id="8030934">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030937">if</span>&nbsp;<span class="ident" id="8030940">dc</span><span class="op" id="8030942">.</span><span class="ident" id="8030943">closed</span>&nbsp;<span class="op" id="8030950">{</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8030954">t</span><span class="op" id="8030955">.</span><span class="ident" id="8030956">Errorf</span><span class="op" id="8030962">(</span><span class="string" id="8030963">&#34;conn&nbsp;shouldn&#39;t&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8030989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8030992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8030996">if</span>&nbsp;<span class="ident" id="8030999">n</span>&nbsp;<span class="op" id="8031001">:=</span>&nbsp;<span class="builtinfunc" id="8031004">len</span><span class="op" id="8031007">(</span><span class="ident" id="8031008">dc</span><span class="op" id="8031010">.</span><span class="ident" id="8031011">openStmt</span><span class="op" id="8031019">)</span><span class="op" id="8031020">;</span>&nbsp;<span class="ident" id="8031022">n</span>&nbsp;<span class="op" id="8031024">!=</span>&nbsp;<span class="num" id="8031027">1</span>&nbsp;<span class="op" id="8031029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031033">t</span><span class="op" id="8031034">.</span><span class="ident" id="8031035">Errorf</span><span class="op" id="8031041">(</span><span class="string" id="8031042">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;1&#34;</span><span class="op" id="8031080">,</span>&nbsp;<span class="ident" id="8031082">n</span><span class="op" id="8031083">)</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031089">err</span>&nbsp;<span class="op" id="8031093">=</span>&nbsp;<span class="ident" id="8031095">db</span><span class="op" id="8031097">.</span><span class="ident" id="8031098">Close</span><span class="op" id="8031103">(</span><span class="op" id="8031104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031107">if</span>&nbsp;<span class="ident" id="8031110">err</span>&nbsp;<span class="op" id="8031114">!=</span>&nbsp;<span class="ident" id="8031117">nil</span>&nbsp;<span class="op" id="8031121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031125">t</span><span class="op" id="8031126">.</span><span class="ident" id="8031127">Errorf</span><span class="op" id="8031133">(</span><span class="string" id="8031134">&#34;db&nbsp;Close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8031149">,</span>&nbsp;<span class="ident" id="8031151">err</span><span class="op" id="8031154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031157">}</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031160">if</span>&nbsp;<span class="op" id="8031163">!</span><span class="ident" id="8031164">dc</span><span class="op" id="8031166">.</span><span class="ident" id="8031167">closed</span>&nbsp;<span class="op" id="8031174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031178">t</span><span class="op" id="8031179">.</span><span class="ident" id="8031180">Errorf</span><span class="op" id="8031186">(</span><span class="string" id="8031187">&#34;after&nbsp;db.Close,&nbsp;driverConn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8031232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031238">if</span>&nbsp;<span class="ident" id="8031241">n</span>&nbsp;<span class="op" id="8031243">:=</span>&nbsp;<span class="builtinfunc" id="8031246">len</span><span class="op" id="8031249">(</span><span class="ident" id="8031250">dc</span><span class="op" id="8031252">.</span><span class="ident" id="8031253">openStmt</span><span class="op" id="8031261">)</span><span class="op" id="8031262">;</span>&nbsp;<span class="ident" id="8031264">n</span>&nbsp;<span class="op" id="8031266">!=</span>&nbsp;<span class="num" id="8031269">0</span>&nbsp;<span class="op" id="8031271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031275">t</span><span class="op" id="8031276">.</span><span class="ident" id="8031277">Errorf</span><span class="op" id="8031283">(</span><span class="string" id="8031284">&#34;driverConn&nbsp;num&nbsp;openStmt&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8031322">,</span>&nbsp;<span class="ident" id="8031324">n</span><span class="op" id="8031325">)</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031332">err</span>&nbsp;<span class="op" id="8031336">=</span>&nbsp;<span class="ident" id="8031338">stmt</span><span class="op" id="8031342">.</span><span class="ident" id="8031343">Close</span><span class="op" id="8031348">(</span><span class="op" id="8031349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031352">if</span>&nbsp;<span class="ident" id="8031355">err</span>&nbsp;<span class="op" id="8031359">!=</span>&nbsp;<span class="ident" id="8031362">nil</span>&nbsp;<span class="op" id="8031366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031370">t</span><span class="op" id="8031371">.</span><span class="ident" id="8031372">Errorf</span><span class="op" id="8031378">(</span><span class="string" id="8031379">&#34;Stmt&nbsp;close&nbsp;=&nbsp;%v&#34;</span><span class="op" id="8031396">,</span>&nbsp;<span class="ident" id="8031398">err</span><span class="op" id="8031401">)</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031408">if</span>&nbsp;<span class="op" id="8031411">!</span><span class="ident" id="8031412">dc</span><span class="op" id="8031414">.</span><span class="ident" id="8031415">closed</span>&nbsp;<span class="op" id="8031422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031426">t</span><span class="op" id="8031427">.</span><span class="ident" id="8031428">Errorf</span><span class="op" id="8031434">(</span><span class="string" id="8031435">&#34;conn&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="8031458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031461">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031464">if</span>&nbsp;<span class="ident" id="8031467">dc</span><span class="op" id="8031469">.</span><span class="ident" id="8031470">ci</span>&nbsp;<span class="op" id="8031473">!=</span>&nbsp;<span class="ident" id="8031476">nil</span>&nbsp;<span class="op" id="8031480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031484">t</span><span class="op" id="8031485">.</span><span class="ident" id="8031486">Errorf</span><span class="op" id="8031492">(</span><span class="string" id="8031493">&#34;after&nbsp;Stmt&nbsp;Close,&nbsp;driverConn&#39;s&nbsp;Conn&nbsp;interface&nbsp;should&nbsp;be&nbsp;nil&#34;</span><span class="op" id="8031554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031557">}</span><br>
<span class="lineno"></span><span class="op" id="8031559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1255</span><span class="comment" id="8031562">//&nbsp;golang.org/issue/5283:&nbsp;don&#39;t&nbsp;release&nbsp;the&nbsp;Rows&#39;&nbsp;connection&nbsp;in&nbsp;Close</span><br>
<span class="lineno"></span><span class="comment" id="8031632">//&nbsp;before&nbsp;calling&nbsp;Stmt.Close.</span><br>
<span class="lineno"></span><span class="keyword" id="8031662">func</span>&nbsp;<span class="ident" id="8031667">TestRowsCloseOrder</span><span class="op" id="8031685">(</span><span class="ident" id="8031686">t</span>&nbsp;<span class="op" id="8031688">*</span><span class="ident" id="8031689">testing</span><span class="op" id="8031696">.</span><span class="ident" id="8031697">T</span><span class="op" id="8031698">)</span>&nbsp;<span class="op" id="8031700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031703">db</span>&nbsp;<span class="op" id="8031706">:=</span>&nbsp;<span class="ident" id="8031709">newTestDB</span><span class="op" id="8031718">(</span><span class="ident" id="8031719">t</span><span class="op" id="8031720">,</span>&nbsp;<span class="string" id="8031722">&#34;people&#34;</span><span class="op" id="8031730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031733">defer</span>&nbsp;<span class="ident" id="8031739">closeDB</span><span class="op" id="8031746">(</span><span class="ident" id="8031747">t</span><span class="op" id="8031748">,</span>&nbsp;<span class="ident" id="8031750">db</span><span class="op" id="8031752">)</span><br>
<span class="lineno">1260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031756">db</span><span class="op" id="8031758">.</span><span class="ident" id="8031759">SetMaxIdleConns</span><span class="op" id="8031774">(</span><span class="num" id="8031775">0</span><span class="op" id="8031776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031779">setStrictFakeConnClose</span><span class="op" id="8031801">(</span><span class="ident" id="8031802">t</span><span class="op" id="8031803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031806">defer</span>&nbsp;<span class="ident" id="8031812">setStrictFakeConnClose</span><span class="op" id="8031834">(</span><span class="ident" id="8031835">nil</span><span class="op" id="8031838">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031842">rows</span><span class="op" id="8031846">,</span>&nbsp;<span class="ident" id="8031848">err</span>&nbsp;<span class="op" id="8031852">:=</span>&nbsp;<span class="ident" id="8031855">db</span><span class="op" id="8031857">.</span><span class="ident" id="8031858">Query</span><span class="op" id="8031863">(</span><span class="string" id="8031864">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8031889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031892">if</span>&nbsp;<span class="ident" id="8031895">err</span>&nbsp;<span class="op" id="8031899">!=</span>&nbsp;<span class="ident" id="8031902">nil</span>&nbsp;<span class="op" id="8031906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031910">t</span><span class="op" id="8031911">.</span><span class="ident" id="8031912">Fatal</span><span class="op" id="8031917">(</span><span class="ident" id="8031918">err</span><span class="op" id="8031921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031927">err</span>&nbsp;<span class="op" id="8031931">=</span>&nbsp;<span class="ident" id="8031933">rows</span><span class="op" id="8031937">.</span><span class="ident" id="8031938">Close</span><span class="op" id="8031943">(</span><span class="op" id="8031944">)</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8031947">if</span>&nbsp;<span class="ident" id="8031950">err</span>&nbsp;<span class="op" id="8031954">!=</span>&nbsp;<span class="ident" id="8031957">nil</span>&nbsp;<span class="op" id="8031961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8031965">t</span><span class="op" id="8031966">.</span><span class="ident" id="8031967">Fatal</span><span class="op" id="8031972">(</span><span class="ident" id="8031973">err</span><span class="op" id="8031976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8031979">}</span><br>
<span class="lineno"></span><span class="op" id="8031981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1275</span><span class="keyword" id="8031984">func</span>&nbsp;<span class="ident" id="8031989">TestRowsImplicitClose</span><span class="op" id="8032010">(</span><span class="ident" id="8032011">t</span>&nbsp;<span class="op" id="8032013">*</span><span class="ident" id="8032014">testing</span><span class="op" id="8032021">.</span><span class="ident" id="8032022">T</span><span class="op" id="8032023">)</span>&nbsp;<span class="op" id="8032025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032028">db</span>&nbsp;<span class="op" id="8032031">:=</span>&nbsp;<span class="ident" id="8032034">newTestDB</span><span class="op" id="8032043">(</span><span class="ident" id="8032044">t</span><span class="op" id="8032045">,</span>&nbsp;<span class="string" id="8032047">&#34;people&#34;</span><span class="op" id="8032055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032058">defer</span>&nbsp;<span class="ident" id="8032064">closeDB</span><span class="op" id="8032071">(</span><span class="ident" id="8032072">t</span><span class="op" id="8032073">,</span>&nbsp;<span class="ident" id="8032075">db</span><span class="op" id="8032077">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032081">rows</span><span class="op" id="8032085">,</span>&nbsp;<span class="ident" id="8032087">err</span>&nbsp;<span class="op" id="8032091">:=</span>&nbsp;<span class="ident" id="8032094">db</span><span class="op" id="8032096">.</span><span class="ident" id="8032097">Query</span><span class="op" id="8032102">(</span><span class="string" id="8032103">&#34;SELECT|people|age,name|&#34;</span><span class="op" id="8032128">)</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032131">if</span>&nbsp;<span class="ident" id="8032134">err</span>&nbsp;<span class="op" id="8032138">!=</span>&nbsp;<span class="ident" id="8032141">nil</span>&nbsp;<span class="op" id="8032145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032149">t</span><span class="op" id="8032150">.</span><span class="ident" id="8032151">Fatal</span><span class="op" id="8032156">(</span><span class="ident" id="8032157">err</span><span class="op" id="8032160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032167">want</span><span class="op" id="8032171">,</span>&nbsp;<span class="ident" id="8032173">fail</span>&nbsp;<span class="op" id="8032178">:=</span>&nbsp;<span class="num" id="8032181">2</span><span class="op" id="8032182">,</span>&nbsp;<span class="ident" id="8032184">errors</span><span class="op" id="8032190">.</span><span class="ident" id="8032191">New</span><span class="op" id="8032194">(</span><span class="string" id="8032195">&#34;fail&#34;</span><span class="op" id="8032201">)</span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032204">r</span>&nbsp;<span class="op" id="8032206">:=</span>&nbsp;<span class="ident" id="8032209">rows</span><span class="op" id="8032213">.</span><span class="ident" id="8032214">rowsi</span><span class="op" id="8032219">.</span><span class="op" id="8032220">(</span><span class="op" id="8032221">*</span><span class="ident" id="8032222">rowsCursor</span><span class="op" id="8032232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032235">r</span><span class="op" id="8032236">.</span><span class="ident" id="8032237">errPos</span><span class="op" id="8032243">,</span>&nbsp;<span class="ident" id="8032245">r</span><span class="op" id="8032246">.</span><span class="ident" id="8032247">err</span>&nbsp;<span class="op" id="8032251">=</span>&nbsp;<span class="ident" id="8032253">want</span><span class="op" id="8032257">,</span>&nbsp;<span class="ident" id="8032259">fail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032266">got</span>&nbsp;<span class="op" id="8032270">:=</span>&nbsp;<span class="num" id="8032273">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032276">for</span>&nbsp;<span class="ident" id="8032280">rows</span><span class="op" id="8032284">.</span><span class="ident" id="8032285">Next</span><span class="op" id="8032289">(</span><span class="op" id="8032290">)</span>&nbsp;<span class="op" id="8032292">{</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032296">got</span><span class="op" id="8032299">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032306">if</span>&nbsp;<span class="ident" id="8032309">got</span>&nbsp;<span class="op" id="8032313">!=</span>&nbsp;<span class="ident" id="8032316">want</span>&nbsp;<span class="op" id="8032321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032325">t</span><span class="op" id="8032326">.</span><span class="ident" id="8032327">Errorf</span><span class="op" id="8032333">(</span><span class="string" id="8032334">&#34;got&nbsp;%d&nbsp;rows,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8032356">,</span>&nbsp;<span class="ident" id="8032358">got</span><span class="op" id="8032361">,</span>&nbsp;<span class="ident" id="8032363">want</span><span class="op" id="8032367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032370">}</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032373">if</span>&nbsp;<span class="ident" id="8032376">err</span>&nbsp;<span class="op" id="8032380">:=</span>&nbsp;<span class="ident" id="8032383">rows</span><span class="op" id="8032387">.</span><span class="ident" id="8032388">Err</span><span class="op" id="8032391">(</span><span class="op" id="8032392">)</span><span class="op" id="8032393">;</span>&nbsp;<span class="ident" id="8032395">err</span>&nbsp;<span class="op" id="8032399">!=</span>&nbsp;<span class="ident" id="8032402">fail</span>&nbsp;<span class="op" id="8032407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032411">t</span><span class="op" id="8032412">.</span><span class="ident" id="8032413">Errorf</span><span class="op" id="8032419">(</span><span class="string" id="8032420">&#34;got&nbsp;error&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8032443">,</span>&nbsp;<span class="ident" id="8032445">err</span><span class="op" id="8032448">,</span>&nbsp;<span class="ident" id="8032450">fail</span><span class="op" id="8032454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032460">if</span>&nbsp;<span class="op" id="8032463">!</span><span class="ident" id="8032464">r</span><span class="op" id="8032465">.</span><span class="ident" id="8032466">closed</span>&nbsp;<span class="op" id="8032473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032477">t</span><span class="op" id="8032478">.</span><span class="ident" id="8032479">Errorf</span><span class="op" id="8032485">(</span><span class="string" id="8032486">&#34;r.closed&nbsp;is&nbsp;false,&nbsp;want&nbsp;true&#34;</span><span class="op" id="8032516">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032519">}</span><br>
<span class="lineno"></span><span class="op" id="8032521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8032524">func</span>&nbsp;<span class="ident" id="8032529">TestStmtCloseOrder</span><span class="op" id="8032547">(</span><span class="ident" id="8032548">t</span>&nbsp;<span class="op" id="8032550">*</span><span class="ident" id="8032551">testing</span><span class="op" id="8032558">.</span><span class="ident" id="8032559">T</span><span class="op" id="8032560">)</span>&nbsp;<span class="op" id="8032562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032565">db</span>&nbsp;<span class="op" id="8032568">:=</span>&nbsp;<span class="ident" id="8032571">newTestDB</span><span class="op" id="8032580">(</span><span class="ident" id="8032581">t</span><span class="op" id="8032582">,</span>&nbsp;<span class="string" id="8032584">&#34;people&#34;</span><span class="op" id="8032592">)</span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032595">defer</span>&nbsp;<span class="ident" id="8032601">closeDB</span><span class="op" id="8032608">(</span><span class="ident" id="8032609">t</span><span class="op" id="8032610">,</span>&nbsp;<span class="ident" id="8032612">db</span><span class="op" id="8032614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032618">db</span><span class="op" id="8032620">.</span><span class="ident" id="8032621">SetMaxIdleConns</span><span class="op" id="8032636">(</span><span class="num" id="8032637">0</span><span class="op" id="8032638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032641">setStrictFakeConnClose</span><span class="op" id="8032663">(</span><span class="ident" id="8032664">t</span><span class="op" id="8032665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032668">defer</span>&nbsp;<span class="ident" id="8032674">setStrictFakeConnClose</span><span class="op" id="8032696">(</span><span class="ident" id="8032697">nil</span><span class="op" id="8032700">)</span><br>
<span class="lineno">1310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032704">_</span><span class="op" id="8032705">,</span>&nbsp;<span class="ident" id="8032707">err</span>&nbsp;<span class="op" id="8032711">:=</span>&nbsp;<span class="ident" id="8032714">db</span><span class="op" id="8032716">.</span><span class="ident" id="8032717">Query</span><span class="op" id="8032722">(</span><span class="string" id="8032723">&#34;SELECT|non_existent|name|&#34;</span><span class="op" id="8032750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032753">if</span>&nbsp;<span class="ident" id="8032756">err</span>&nbsp;<span class="op" id="8032760">==</span>&nbsp;<span class="ident" id="8032763">nil</span>&nbsp;<span class="op" id="8032767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032771">t</span><span class="op" id="8032772">.</span><span class="ident" id="8032773">Fatal</span><span class="op" id="8032778">(</span><span class="string" id="8032779">&#34;Quering&nbsp;non-existent&nbsp;table&nbsp;should&nbsp;fail&#34;</span><span class="op" id="8032819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8032822">}</span><br>
<span class="lineno">1315</span><span class="op" id="8032824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8032827">//&nbsp;golang.org/issue/5781</span><br>
<span class="lineno"></span><span class="keyword" id="8032852">func</span>&nbsp;<span class="ident" id="8032857">TestErrBadConnReconnect</span><span class="op" id="8032880">(</span><span class="ident" id="8032881">t</span>&nbsp;<span class="op" id="8032883">*</span><span class="ident" id="8032884">testing</span><span class="op" id="8032891">.</span><span class="ident" id="8032892">T</span><span class="op" id="8032893">)</span>&nbsp;<span class="op" id="8032895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032898">db</span>&nbsp;<span class="op" id="8032901">:=</span>&nbsp;<span class="ident" id="8032904">newTestDB</span><span class="op" id="8032913">(</span><span class="ident" id="8032914">t</span><span class="op" id="8032915">,</span>&nbsp;<span class="string" id="8032917">&#34;foo&#34;</span><span class="op" id="8032922">)</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8032925">defer</span>&nbsp;<span class="ident" id="8032931">closeDB</span><span class="op" id="8032938">(</span><span class="ident" id="8032939">t</span><span class="op" id="8032940">,</span>&nbsp;<span class="ident" id="8032942">db</span><span class="op" id="8032944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8032947">exec</span><span class="op" id="8032951">(</span><span class="ident" id="8032952">t</span><span class="op" id="8032953">,</span>&nbsp;<span class="ident" id="8032955">db</span><span class="op" id="8032957">,</span>&nbsp;<span class="string" id="8032959">&#34;CREATE|t1|name=string,age=int32,dead=bool&#34;</span><span class="op" id="8033002">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033006">simulateBadConn</span>&nbsp;<span class="op" id="8033022">:=</span>&nbsp;<span class="keyword" id="8033025">func</span><span class="op" id="8033029">(</span><span class="ident" id="8033030">name</span>&nbsp;<span class="builtintype" id="8033035">string</span><span class="op" id="8033041">,</span>&nbsp;<span class="ident" id="8033043">hook</span>&nbsp;<span class="op" id="8033048">*</span><span class="keyword" id="8033049">func</span><span class="op" id="8033053">(</span><span class="op" id="8033054">)</span>&nbsp;<span class="builtintype" id="8033056">bool</span><span class="op" id="8033060">,</span>&nbsp;<span class="ident" id="8033062">op</span>&nbsp;<span class="keyword" id="8033065">func</span><span class="op" id="8033069">(</span><span class="op" id="8033070">)</span>&nbsp;<span class="builtintype" id="8033072">error</span><span class="op" id="8033077">)</span>&nbsp;<span class="op" id="8033079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033083">broken</span><span class="op" id="8033089">,</span>&nbsp;<span class="ident" id="8033091">retried</span>&nbsp;<span class="op" id="8033099">:=</span>&nbsp;<span class="builtintype" id="8033102">false</span><span class="op" id="8033107">,</span>&nbsp;<span class="builtintype" id="8033109">false</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033117">numOpen</span>&nbsp;<span class="op" id="8033125">:=</span>&nbsp;<span class="ident" id="8033128">db</span><span class="op" id="8033130">.</span><span class="ident" id="8033131">numOpen</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8033142">//&nbsp;simulate&nbsp;a&nbsp;broken&nbsp;connection&nbsp;on&nbsp;the&nbsp;first&nbsp;try</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033193">*</span><span class="ident" id="8033194">hook</span>&nbsp;<span class="op" id="8033199">=</span>&nbsp;<span class="keyword" id="8033201">func</span><span class="op" id="8033205">(</span><span class="op" id="8033206">)</span>&nbsp;<span class="builtintype" id="8033208">bool</span>&nbsp;<span class="op" id="8033213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033218">if</span>&nbsp;<span class="op" id="8033221">!</span><span class="ident" id="8033222">broken</span>&nbsp;<span class="op" id="8033229">{</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033235">broken</span>&nbsp;<span class="op" id="8033242">=</span>&nbsp;<span class="builtintype" id="8033244">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033253">return</span>&nbsp;<span class="builtintype" id="8033260">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033273">retried</span>&nbsp;<span class="op" id="8033281">=</span>&nbsp;<span class="builtintype" id="8033283">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033291">return</span>&nbsp;<span class="builtintype" id="8033298">false</span><br>
<span class="lineno">1335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033311">if</span>&nbsp;<span class="ident" id="8033314">err</span>&nbsp;<span class="op" id="8033318">:=</span>&nbsp;<span class="ident" id="8033321">op</span><span class="op" id="8033323">(</span><span class="op" id="8033324">)</span><span class="op" id="8033325">;</span>&nbsp;<span class="ident" id="8033327">err</span>&nbsp;<span class="op" id="8033331">!=</span>&nbsp;<span class="ident" id="8033334">nil</span>&nbsp;<span class="op" id="8033338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033343">t</span><span class="op" id="8033344">.</span><span class="ident" id="8033345">Errorf</span><span class="op" id="8033351">(</span><span class="ident" id="8033352">name</span><span class="op" id="8033356">+</span><span class="string" id="8033357">&#34;:&nbsp;%v&#34;</span><span class="op" id="8033363">,</span>&nbsp;<span class="ident" id="8033365">err</span><span class="op" id="8033368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033373">return</span><br>
<span class="lineno">1340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033387">if</span>&nbsp;<span class="op" id="8033390">!</span><span class="ident" id="8033391">broken</span>&nbsp;<span class="op" id="8033398">||</span>&nbsp;<span class="op" id="8033401">!</span><span class="ident" id="8033402">retried</span>&nbsp;<span class="op" id="8033410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033415">t</span><span class="op" id="8033416">.</span><span class="ident" id="8033417">Error</span><span class="op" id="8033422">(</span><span class="ident" id="8033423">name</span>&nbsp;<span class="op" id="8033428">+</span>&nbsp;<span class="string" id="8033430">&#34;:&nbsp;Failed&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="8033470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033474">}</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033478">*</span><span class="ident" id="8033479">hook</span>&nbsp;<span class="op" id="8033484">=</span>&nbsp;<span class="ident" id="8033486">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033493">if</span>&nbsp;<span class="ident" id="8033496">numOpen</span>&nbsp;<span class="op" id="8033504">!=</span>&nbsp;<span class="ident" id="8033507">db</span><span class="op" id="8033509">.</span><span class="ident" id="8033510">numOpen</span>&nbsp;<span class="op" id="8033518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033523">t</span><span class="op" id="8033524">.</span><span class="ident" id="8033525">Errorf</span><span class="op" id="8033531">(</span><span class="ident" id="8033532">name</span><span class="op" id="8033536">+</span><span class="string" id="8033537">&#34;:&nbsp;leaked&nbsp;%d&nbsp;connection(s)!&#34;</span><span class="op" id="8033565">,</span>&nbsp;<span class="ident" id="8033567">db</span><span class="op" id="8033569">.</span><span class="ident" id="8033570">numOpen</span><span class="op" id="8033577">-</span><span class="ident" id="8033578">numOpen</span><span class="op" id="8033585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033590">numOpen</span>&nbsp;<span class="op" id="8033598">=</span>&nbsp;<span class="ident" id="8033600">db</span><span class="op" id="8033602">.</span><span class="ident" id="8033603">numOpen</span><br>
<span class="lineno">1350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8033620">//&nbsp;db.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033632">dbExec</span>&nbsp;<span class="op" id="8033639">:=</span>&nbsp;<span class="keyword" id="8033642">func</span><span class="op" id="8033646">(</span><span class="op" id="8033647">)</span>&nbsp;<span class="builtintype" id="8033649">error</span>&nbsp;<span class="op" id="8033655">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033659">_</span><span class="op" id="8033660">,</span>&nbsp;<span class="ident" id="8033662">err</span>&nbsp;<span class="op" id="8033666">:=</span>&nbsp;<span class="ident" id="8033669">db</span><span class="op" id="8033671">.</span><span class="ident" id="8033672">Exec</span><span class="op" id="8033676">(</span><span class="string" id="8033677">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8033708">,</span>&nbsp;<span class="string" id="8033710">&#34;Gordon&#34;</span><span class="op" id="8033718">,</span>&nbsp;<span class="num" id="8033720">3</span><span class="op" id="8033721">,</span>&nbsp;<span class="builtintype" id="8033723">true</span><span class="op" id="8033727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033731">return</span>&nbsp;<span class="ident" id="8033738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033746">simulateBadConn</span><span class="op" id="8033761">(</span><span class="string" id="8033762">&#34;db.Exec&nbsp;prepare&#34;</span><span class="op" id="8033779">,</span>&nbsp;<span class="op" id="8033781">&amp;</span><span class="ident" id="8033782">hookPrepareBadConn</span><span class="op" id="8033800">,</span>&nbsp;<span class="ident" id="8033802">dbExec</span><span class="op" id="8033808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033811">simulateBadConn</span><span class="op" id="8033826">(</span><span class="string" id="8033827">&#34;db.Exec&nbsp;exec&#34;</span><span class="op" id="8033841">,</span>&nbsp;<span class="op" id="8033843">&amp;</span><span class="ident" id="8033844">hookExecBadConn</span><span class="op" id="8033859">,</span>&nbsp;<span class="ident" id="8033861">dbExec</span><span class="op" id="8033867">)</span><br>
<span class="lineno">1360</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8033871">//&nbsp;db.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033884">dbQuery</span>&nbsp;<span class="op" id="8033892">:=</span>&nbsp;<span class="keyword" id="8033895">func</span><span class="op" id="8033899">(</span><span class="op" id="8033900">)</span>&nbsp;<span class="builtintype" id="8033902">error</span>&nbsp;<span class="op" id="8033908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033912">rows</span><span class="op" id="8033916">,</span>&nbsp;<span class="ident" id="8033918">err</span>&nbsp;<span class="op" id="8033922">:=</span>&nbsp;<span class="ident" id="8033925">db</span><span class="op" id="8033927">.</span><span class="ident" id="8033928">Query</span><span class="op" id="8033933">(</span><span class="string" id="8033934">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8033955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8033959">if</span>&nbsp;<span class="ident" id="8033962">err</span>&nbsp;<span class="op" id="8033966">==</span>&nbsp;<span class="ident" id="8033969">nil</span>&nbsp;<span class="op" id="8033973">{</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8033978">err</span>&nbsp;<span class="op" id="8033982">=</span>&nbsp;<span class="ident" id="8033984">rows</span><span class="op" id="8033988">.</span><span class="ident" id="8033989">Close</span><span class="op" id="8033994">(</span><span class="op" id="8033995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8033999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034003">return</span>&nbsp;<span class="ident" id="8034010">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034018">simulateBadConn</span><span class="op" id="8034033">(</span><span class="string" id="8034034">&#34;db.Query&nbsp;prepare&#34;</span><span class="op" id="8034052">,</span>&nbsp;<span class="op" id="8034054">&amp;</span><span class="ident" id="8034055">hookPrepareBadConn</span><span class="op" id="8034073">,</span>&nbsp;<span class="ident" id="8034075">dbQuery</span><span class="op" id="8034082">)</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034085">simulateBadConn</span><span class="op" id="8034100">(</span><span class="string" id="8034101">&#34;db.Query&nbsp;query&#34;</span><span class="op" id="8034117">,</span>&nbsp;<span class="op" id="8034119">&amp;</span><span class="ident" id="8034120">hookQueryBadConn</span><span class="op" id="8034136">,</span>&nbsp;<span class="ident" id="8034138">dbQuery</span><span class="op" id="8034145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8034149">//&nbsp;db.Prepare</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034164">simulateBadConn</span><span class="op" id="8034179">(</span><span class="string" id="8034180">&#34;db.Prepare&#34;</span><span class="op" id="8034192">,</span>&nbsp;<span class="op" id="8034194">&amp;</span><span class="ident" id="8034195">hookPrepareBadConn</span><span class="op" id="8034213">,</span>&nbsp;<span class="keyword" id="8034215">func</span><span class="op" id="8034219">(</span><span class="op" id="8034220">)</span>&nbsp;<span class="builtintype" id="8034222">error</span>&nbsp;<span class="op" id="8034228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034232">stmt</span><span class="op" id="8034236">,</span>&nbsp;<span class="ident" id="8034238">err</span>&nbsp;<span class="op" id="8034242">:=</span>&nbsp;<span class="ident" id="8034245">db</span><span class="op" id="8034247">.</span><span class="ident" id="8034248">Prepare</span><span class="op" id="8034255">(</span><span class="string" id="8034256">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8034287">)</span><br>
<span class="lineno">1375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034291">if</span>&nbsp;<span class="ident" id="8034294">err</span>&nbsp;<span class="op" id="8034298">!=</span>&nbsp;<span class="ident" id="8034301">nil</span>&nbsp;<span class="op" id="8034305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034310">return</span>&nbsp;<span class="ident" id="8034317">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034327">stmt</span><span class="op" id="8034331">.</span><span class="ident" id="8034332">Close</span><span class="op" id="8034337">(</span><span class="op" id="8034338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034342">return</span>&nbsp;<span class="ident" id="8034349">nil</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034354">}</span><span class="op" id="8034355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8034359">//&nbsp;Provide&nbsp;a&nbsp;way&nbsp;to&nbsp;force&nbsp;a&nbsp;re-prepare&nbsp;of&nbsp;a&nbsp;statement&nbsp;on&nbsp;next&nbsp;execution</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034432">forcePrepare</span>&nbsp;<span class="op" id="8034445">:=</span>&nbsp;<span class="keyword" id="8034448">func</span><span class="op" id="8034452">(</span><span class="ident" id="8034453">stmt</span>&nbsp;<span class="op" id="8034458">*</span><span class="ident" id="8034459">Stmt</span><span class="op" id="8034463">)</span>&nbsp;<span class="op" id="8034465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034469">stmt</span><span class="op" id="8034473">.</span><span class="ident" id="8034474">css</span>&nbsp;<span class="op" id="8034478">=</span>&nbsp;<span class="ident" id="8034480">nil</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8034489">//&nbsp;stmt.Exec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034503">stmt1</span><span class="op" id="8034508">,</span>&nbsp;<span class="ident" id="8034510">err</span>&nbsp;<span class="op" id="8034514">:=</span>&nbsp;<span class="ident" id="8034517">db</span><span class="op" id="8034519">.</span><span class="ident" id="8034520">Prepare</span><span class="op" id="8034527">(</span><span class="string" id="8034528">&#34;INSERT|t1|name=?,age=?,dead=?&#34;</span><span class="op" id="8034559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034562">if</span>&nbsp;<span class="ident" id="8034565">err</span>&nbsp;<span class="op" id="8034569">!=</span>&nbsp;<span class="ident" id="8034572">nil</span>&nbsp;<span class="op" id="8034576">{</span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034580">t</span><span class="op" id="8034581">.</span><span class="ident" id="8034582">Fatalf</span><span class="op" id="8034588">(</span><span class="string" id="8034589">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8034602">,</span>&nbsp;<span class="ident" id="8034604">err</span><span class="op" id="8034607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034613">defer</span>&nbsp;<span class="ident" id="8034619">stmt1</span><span class="op" id="8034624">.</span><span class="ident" id="8034625">Close</span><span class="op" id="8034630">(</span><span class="op" id="8034631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8034634">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034679">forcePrepare</span><span class="op" id="8034691">(</span><span class="ident" id="8034692">stmt1</span><span class="op" id="8034697">)</span><br>
<span class="lineno">1395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034701">stmtExec</span>&nbsp;<span class="op" id="8034710">:=</span>&nbsp;<span class="keyword" id="8034713">func</span><span class="op" id="8034717">(</span><span class="op" id="8034718">)</span>&nbsp;<span class="builtintype" id="8034720">error</span>&nbsp;<span class="op" id="8034726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034730">_</span><span class="op" id="8034731">,</span>&nbsp;<span class="ident" id="8034733">err</span>&nbsp;<span class="op" id="8034737">:=</span>&nbsp;<span class="ident" id="8034740">stmt1</span><span class="op" id="8034745">.</span><span class="ident" id="8034746">Exec</span><span class="op" id="8034750">(</span><span class="string" id="8034751">&#34;Gopher&#34;</span><span class="op" id="8034759">,</span>&nbsp;<span class="num" id="8034761">3</span><span class="op" id="8034762">,</span>&nbsp;<span class="builtintype" id="8034764">false</span><span class="op" id="8034769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034773">return</span>&nbsp;<span class="ident" id="8034780">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8034785">}</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034788">simulateBadConn</span><span class="op" id="8034803">(</span><span class="string" id="8034804">&#34;stmt.Exec&nbsp;prepare&#34;</span><span class="op" id="8034823">,</span>&nbsp;<span class="op" id="8034825">&amp;</span><span class="ident" id="8034826">hookPrepareBadConn</span><span class="op" id="8034844">,</span>&nbsp;<span class="ident" id="8034846">stmtExec</span><span class="op" id="8034854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034857">simulateBadConn</span><span class="op" id="8034872">(</span><span class="string" id="8034873">&#34;stmt.Exec&nbsp;exec&#34;</span><span class="op" id="8034889">,</span>&nbsp;<span class="op" id="8034891">&amp;</span><span class="ident" id="8034892">hookExecBadConn</span><span class="op" id="8034907">,</span>&nbsp;<span class="ident" id="8034909">stmtExec</span><span class="op" id="8034917">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8034921">//&nbsp;stmt.Query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8034936">stmt2</span><span class="op" id="8034941">,</span>&nbsp;<span class="ident" id="8034943">err</span>&nbsp;<span class="op" id="8034947">:=</span>&nbsp;<span class="ident" id="8034950">db</span><span class="op" id="8034952">.</span><span class="ident" id="8034953">Prepare</span><span class="op" id="8034960">(</span><span class="string" id="8034961">&#34;SELECT|t1|age,name|&#34;</span><span class="op" id="8034982">)</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8034985">if</span>&nbsp;<span class="ident" id="8034988">err</span>&nbsp;<span class="op" id="8034992">!=</span>&nbsp;<span class="ident" id="8034995">nil</span>&nbsp;<span class="op" id="8034999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035003">t</span><span class="op" id="8035004">.</span><span class="ident" id="8035005">Fatalf</span><span class="op" id="8035011">(</span><span class="string" id="8035012">&#34;prepare:&nbsp;%v&#34;</span><span class="op" id="8035025">,</span>&nbsp;<span class="ident" id="8035027">err</span><span class="op" id="8035030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8035033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035036">defer</span>&nbsp;<span class="ident" id="8035042">stmt2</span><span class="op" id="8035047">.</span><span class="ident" id="8035048">Close</span><span class="op" id="8035053">(</span><span class="op" id="8035054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8035057">//&nbsp;make&nbsp;sure&nbsp;we&nbsp;must&nbsp;prepare&nbsp;the&nbsp;stmt&nbsp;first</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035102">forcePrepare</span><span class="op" id="8035114">(</span><span class="ident" id="8035115">stmt2</span><span class="op" id="8035120">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035124">stmtQuery</span>&nbsp;<span class="op" id="8035134">:=</span>&nbsp;<span class="keyword" id="8035137">func</span><span class="op" id="8035141">(</span><span class="op" id="8035142">)</span>&nbsp;<span class="builtintype" id="8035144">error</span>&nbsp;<span class="op" id="8035150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035154">rows</span><span class="op" id="8035158">,</span>&nbsp;<span class="ident" id="8035160">err</span>&nbsp;<span class="op" id="8035164">:=</span>&nbsp;<span class="ident" id="8035167">stmt2</span><span class="op" id="8035172">.</span><span class="ident" id="8035173">Query</span><span class="op" id="8035178">(</span><span class="op" id="8035179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035183">if</span>&nbsp;<span class="ident" id="8035186">err</span>&nbsp;<span class="op" id="8035190">==</span>&nbsp;<span class="ident" id="8035193">nil</span>&nbsp;<span class="op" id="8035197">{</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035202">err</span>&nbsp;<span class="op" id="8035206">=</span>&nbsp;<span class="ident" id="8035208">rows</span><span class="op" id="8035212">.</span><span class="ident" id="8035213">Close</span><span class="op" id="8035218">(</span><span class="op" id="8035219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8035223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035227">return</span>&nbsp;<span class="ident" id="8035234">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8035239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035242">simulateBadConn</span><span class="op" id="8035257">(</span><span class="string" id="8035258">&#34;stmt.Query&nbsp;prepare&#34;</span><span class="op" id="8035278">,</span>&nbsp;<span class="op" id="8035280">&amp;</span><span class="ident" id="8035281">hookPrepareBadConn</span><span class="op" id="8035299">,</span>&nbsp;<span class="ident" id="8035301">stmtQuery</span><span class="op" id="8035310">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035313">simulateBadConn</span><span class="op" id="8035328">(</span><span class="string" id="8035329">&#34;stmt.Query&nbsp;exec&#34;</span><span class="op" id="8035346">,</span>&nbsp;<span class="op" id="8035348">&amp;</span><span class="ident" id="8035349">hookQueryBadConn</span><span class="op" id="8035365">,</span>&nbsp;<span class="ident" id="8035367">stmtQuery</span><span class="op" id="8035376">)</span><br>
<span class="lineno"></span><span class="op" id="8035378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8035381">type</span>&nbsp;<span class="ident" id="8035386">concurrentTest</span>&nbsp;<span class="keyword" id="8035401">interface</span>&nbsp;<span class="op" id="8035411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035414">init</span><span class="op" id="8035418">(</span><span class="ident" id="8035419">t</span>&nbsp;<span class="ident" id="8035421">testing</span><span class="op" id="8035428">.</span><span class="ident" id="8035429">TB</span><span class="op" id="8035431">,</span>&nbsp;<span class="ident" id="8035433">db</span>&nbsp;<span class="op" id="8035436">*</span><span class="ident" id="8035437">DB</span><span class="op" id="8035439">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035442">finish</span><span class="op" id="8035448">(</span><span class="ident" id="8035449">t</span>&nbsp;<span class="ident" id="8035451">testing</span><span class="op" id="8035458">.</span><span class="ident" id="8035459">TB</span><span class="op" id="8035461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035464">test</span><span class="op" id="8035468">(</span><span class="ident" id="8035469">t</span>&nbsp;<span class="ident" id="8035471">testing</span><span class="op" id="8035478">.</span><span class="ident" id="8035479">TB</span><span class="op" id="8035481">)</span>&nbsp;<span class="builtintype" id="8035483">error</span><br>
<span class="lineno"></span><span class="op" id="8035489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8035492">type</span>&nbsp;<span class="ident" id="8035497">concurrentDBQueryTest</span>&nbsp;<span class="keyword" id="8035519">struct</span>&nbsp;<span class="op" id="8035526">{</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035529">db</span>&nbsp;<span class="op" id="8035532">*</span><span class="ident" id="8035533">DB</span><br>
<span class="lineno"></span><span class="op" id="8035536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8035539">func</span>&nbsp;<span class="op" id="8035544">(</span><span class="ident" id="8035545">c</span>&nbsp;<span class="op" id="8035547">*</span><span class="ident" id="8035548">concurrentDBQueryTest</span><span class="op" id="8035569">)</span>&nbsp;<span class="ident" id="8035571">init</span><span class="op" id="8035575">(</span><span class="ident" id="8035576">t</span>&nbsp;<span class="ident" id="8035578">testing</span><span class="op" id="8035585">.</span><span class="ident" id="8035586">TB</span><span class="op" id="8035588">,</span>&nbsp;<span class="ident" id="8035590">db</span>&nbsp;<span class="op" id="8035593">*</span><span class="ident" id="8035594">DB</span><span class="op" id="8035596">)</span>&nbsp;<span class="op" id="8035598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035601">c</span><span class="op" id="8035602">.</span><span class="ident" id="8035603">db</span>&nbsp;<span class="op" id="8035606">=</span>&nbsp;<span class="ident" id="8035608">db</span><br>
<span class="lineno">1435</span><span class="op" id="8035611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8035614">func</span>&nbsp;<span class="op" id="8035619">(</span><span class="ident" id="8035620">c</span>&nbsp;<span class="op" id="8035622">*</span><span class="ident" id="8035623">concurrentDBQueryTest</span><span class="op" id="8035644">)</span>&nbsp;<span class="ident" id="8035646">finish</span><span class="op" id="8035652">(</span><span class="ident" id="8035653">t</span>&nbsp;<span class="ident" id="8035655">testing</span><span class="op" id="8035662">.</span><span class="ident" id="8035663">TB</span><span class="op" id="8035665">)</span>&nbsp;<span class="op" id="8035667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035670">c</span><span class="op" id="8035671">.</span><span class="ident" id="8035672">db</span>&nbsp;<span class="op" id="8035675">=</span>&nbsp;<span class="ident" id="8035677">nil</span><br>
<span class="lineno"></span><span class="op" id="8035681">}</span><br>
<span class="lineno">1440</span><br>
<span class="lineno"></span><span class="keyword" id="8035684">func</span>&nbsp;<span class="op" id="8035689">(</span><span class="ident" id="8035690">c</span>&nbsp;<span class="op" id="8035692">*</span><span class="ident" id="8035693">concurrentDBQueryTest</span><span class="op" id="8035714">)</span>&nbsp;<span class="ident" id="8035716">test</span><span class="op" id="8035720">(</span><span class="ident" id="8035721">t</span>&nbsp;<span class="ident" id="8035723">testing</span><span class="op" id="8035730">.</span><span class="ident" id="8035731">TB</span><span class="op" id="8035733">)</span>&nbsp;<span class="builtintype" id="8035735">error</span>&nbsp;<span class="op" id="8035741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035744">rows</span><span class="op" id="8035748">,</span>&nbsp;<span class="ident" id="8035750">err</span>&nbsp;<span class="op" id="8035754">:=</span>&nbsp;<span class="ident" id="8035757">c</span><span class="op" id="8035758">.</span><span class="ident" id="8035759">db</span><span class="op" id="8035761">.</span><span class="ident" id="8035762">Query</span><span class="op" id="8035767">(</span><span class="string" id="8035768">&#34;SELECT|people|name|&#34;</span><span class="op" id="8035789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035792">if</span>&nbsp;<span class="ident" id="8035795">err</span>&nbsp;<span class="op" id="8035799">!=</span>&nbsp;<span class="ident" id="8035802">nil</span>&nbsp;<span class="op" id="8035806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035810">t</span><span class="op" id="8035811">.</span><span class="ident" id="8035812">Error</span><span class="op" id="8035817">(</span><span class="ident" id="8035818">err</span><span class="op" id="8035821">)</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035825">return</span>&nbsp;<span class="ident" id="8035832">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8035837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035840">var</span>&nbsp;<span class="ident" id="8035844">name</span>&nbsp;<span class="builtintype" id="8035849">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035857">for</span>&nbsp;<span class="ident" id="8035861">rows</span><span class="op" id="8035865">.</span><span class="ident" id="8035866">Next</span><span class="op" id="8035870">(</span><span class="op" id="8035871">)</span>&nbsp;<span class="op" id="8035873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035877">rows</span><span class="op" id="8035881">.</span><span class="ident" id="8035882">Scan</span><span class="op" id="8035886">(</span><span class="op" id="8035887">&amp;</span><span class="ident" id="8035888">name</span><span class="op" id="8035892">)</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8035895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035898">rows</span><span class="op" id="8035902">.</span><span class="ident" id="8035903">Close</span><span class="op" id="8035908">(</span><span class="op" id="8035909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8035912">return</span>&nbsp;<span class="ident" id="8035919">nil</span><br>
<span class="lineno"></span><span class="op" id="8035923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1455</span><span class="keyword" id="8035926">type</span>&nbsp;<span class="ident" id="8035931">concurrentDBExecTest</span>&nbsp;<span class="keyword" id="8035952">struct</span>&nbsp;<span class="op" id="8035959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8035962">db</span>&nbsp;<span class="op" id="8035965">*</span><span class="ident" id="8035966">DB</span><br>
<span class="lineno"></span><span class="op" id="8035969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8035972">func</span>&nbsp;<span class="op" id="8035977">(</span><span class="ident" id="8035978">c</span>&nbsp;<span class="op" id="8035980">*</span><span class="ident" id="8035981">concurrentDBExecTest</span><span class="op" id="8036001">)</span>&nbsp;<span class="ident" id="8036003">init</span><span class="op" id="8036007">(</span><span class="ident" id="8036008">t</span>&nbsp;<span class="ident" id="8036010">testing</span><span class="op" id="8036017">.</span><span class="ident" id="8036018">TB</span><span class="op" id="8036020">,</span>&nbsp;<span class="ident" id="8036022">db</span>&nbsp;<span class="op" id="8036025">*</span><span class="ident" id="8036026">DB</span><span class="op" id="8036028">)</span>&nbsp;<span class="op" id="8036030">{</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036033">c</span><span class="op" id="8036034">.</span><span class="ident" id="8036035">db</span>&nbsp;<span class="op" id="8036038">=</span>&nbsp;<span class="ident" id="8036040">db</span><br>
<span class="lineno"></span><span class="op" id="8036043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8036046">func</span>&nbsp;<span class="op" id="8036051">(</span><span class="ident" id="8036052">c</span>&nbsp;<span class="op" id="8036054">*</span><span class="ident" id="8036055">concurrentDBExecTest</span><span class="op" id="8036075">)</span>&nbsp;<span class="ident" id="8036077">finish</span><span class="op" id="8036083">(</span><span class="ident" id="8036084">t</span>&nbsp;<span class="ident" id="8036086">testing</span><span class="op" id="8036093">.</span><span class="ident" id="8036094">TB</span><span class="op" id="8036096">)</span>&nbsp;<span class="op" id="8036098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036101">c</span><span class="op" id="8036102">.</span><span class="ident" id="8036103">db</span>&nbsp;<span class="op" id="8036106">=</span>&nbsp;<span class="ident" id="8036108">nil</span><br>
<span class="lineno">1465</span><span class="op" id="8036112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8036115">func</span>&nbsp;<span class="op" id="8036120">(</span><span class="ident" id="8036121">c</span>&nbsp;<span class="op" id="8036123">*</span><span class="ident" id="8036124">concurrentDBExecTest</span><span class="op" id="8036144">)</span>&nbsp;<span class="ident" id="8036146">test</span><span class="op" id="8036150">(</span><span class="ident" id="8036151">t</span>&nbsp;<span class="ident" id="8036153">testing</span><span class="op" id="8036160">.</span><span class="ident" id="8036161">TB</span><span class="op" id="8036163">)</span>&nbsp;<span class="builtintype" id="8036165">error</span>&nbsp;<span class="op" id="8036171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036174">_</span><span class="op" id="8036175">,</span>&nbsp;<span class="ident" id="8036177">err</span>&nbsp;<span class="op" id="8036181">:=</span>&nbsp;<span class="ident" id="8036184">c</span><span class="op" id="8036185">.</span><span class="ident" id="8036186">db</span><span class="op" id="8036188">.</span><span class="ident" id="8036189">Exec</span><span class="op" id="8036193">(</span><span class="string" id="8036194">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8036247">,</span>&nbsp;<span class="num" id="8036249">3</span><span class="op" id="8036250">,</span>&nbsp;<span class="ident" id="8036252">chrisBirthday</span><span class="op" id="8036265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036268">if</span>&nbsp;<span class="ident" id="8036271">err</span>&nbsp;<span class="op" id="8036275">!=</span>&nbsp;<span class="ident" id="8036278">nil</span>&nbsp;<span class="op" id="8036282">{</span><br>
<span class="lineno">1470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036286">t</span><span class="op" id="8036287">.</span><span class="ident" id="8036288">Error</span><span class="op" id="8036293">(</span><span class="ident" id="8036294">err</span><span class="op" id="8036297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036301">return</span>&nbsp;<span class="ident" id="8036308">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8036313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036316">return</span>&nbsp;<span class="ident" id="8036323">nil</span><br>
<span class="lineno"></span><span class="op" id="8036327">}</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span><span class="keyword" id="8036330">type</span>&nbsp;<span class="ident" id="8036335">concurrentStmtQueryTest</span>&nbsp;<span class="keyword" id="8036359">struct</span>&nbsp;<span class="op" id="8036366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036369">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8036374">*</span><span class="ident" id="8036375">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036379">stmt</span>&nbsp;<span class="op" id="8036384">*</span><span class="ident" id="8036385">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8036390">}</span><br>
<span class="lineno">1480</span><br>
<span class="lineno"></span><span class="keyword" id="8036393">func</span>&nbsp;<span class="op" id="8036398">(</span><span class="ident" id="8036399">c</span>&nbsp;<span class="op" id="8036401">*</span><span class="ident" id="8036402">concurrentStmtQueryTest</span><span class="op" id="8036425">)</span>&nbsp;<span class="ident" id="8036427">init</span><span class="op" id="8036431">(</span><span class="ident" id="8036432">t</span>&nbsp;<span class="ident" id="8036434">testing</span><span class="op" id="8036441">.</span><span class="ident" id="8036442">TB</span><span class="op" id="8036444">,</span>&nbsp;<span class="ident" id="8036446">db</span>&nbsp;<span class="op" id="8036449">*</span><span class="ident" id="8036450">DB</span><span class="op" id="8036452">)</span>&nbsp;<span class="op" id="8036454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036457">c</span><span class="op" id="8036458">.</span><span class="ident" id="8036459">db</span>&nbsp;<span class="op" id="8036462">=</span>&nbsp;<span class="ident" id="8036464">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036468">var</span>&nbsp;<span class="ident" id="8036472">err</span>&nbsp;<span class="builtintype" id="8036476">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036483">c</span><span class="op" id="8036484">.</span><span class="ident" id="8036485">stmt</span><span class="op" id="8036489">,</span>&nbsp;<span class="ident" id="8036491">err</span>&nbsp;<span class="op" id="8036495">=</span>&nbsp;<span class="ident" id="8036497">db</span><span class="op" id="8036499">.</span><span class="ident" id="8036500">Prepare</span><span class="op" id="8036507">(</span><span class="string" id="8036508">&#34;SELECT|people|name|&#34;</span><span class="op" id="8036529">)</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036532">if</span>&nbsp;<span class="ident" id="8036535">err</span>&nbsp;<span class="op" id="8036539">!=</span>&nbsp;<span class="ident" id="8036542">nil</span>&nbsp;<span class="op" id="8036546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036550">t</span><span class="op" id="8036551">.</span><span class="ident" id="8036552">Fatal</span><span class="op" id="8036557">(</span><span class="ident" id="8036558">err</span><span class="op" id="8036561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8036564">}</span><br>
<span class="lineno"></span><span class="op" id="8036566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1490</span><span class="keyword" id="8036569">func</span>&nbsp;<span class="op" id="8036574">(</span><span class="ident" id="8036575">c</span>&nbsp;<span class="op" id="8036577">*</span><span class="ident" id="8036578">concurrentStmtQueryTest</span><span class="op" id="8036601">)</span>&nbsp;<span class="ident" id="8036603">finish</span><span class="op" id="8036609">(</span><span class="ident" id="8036610">t</span>&nbsp;<span class="ident" id="8036612">testing</span><span class="op" id="8036619">.</span><span class="ident" id="8036620">TB</span><span class="op" id="8036622">)</span>&nbsp;<span class="op" id="8036624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036627">if</span>&nbsp;<span class="ident" id="8036630">c</span><span class="op" id="8036631">.</span><span class="ident" id="8036632">stmt</span>&nbsp;<span class="op" id="8036637">!=</span>&nbsp;<span class="ident" id="8036640">nil</span>&nbsp;<span class="op" id="8036644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036648">c</span><span class="op" id="8036649">.</span><span class="ident" id="8036650">stmt</span><span class="op" id="8036654">.</span><span class="ident" id="8036655">Close</span><span class="op" id="8036660">(</span><span class="op" id="8036661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036665">c</span><span class="op" id="8036666">.</span><span class="ident" id="8036667">stmt</span>&nbsp;<span class="op" id="8036672">=</span>&nbsp;<span class="ident" id="8036674">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8036679">}</span><br>
<span class="lineno">1495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036682">c</span><span class="op" id="8036683">.</span><span class="ident" id="8036684">db</span>&nbsp;<span class="op" id="8036687">=</span>&nbsp;<span class="ident" id="8036689">nil</span><br>
<span class="lineno"></span><span class="op" id="8036693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8036696">func</span>&nbsp;<span class="op" id="8036701">(</span><span class="ident" id="8036702">c</span>&nbsp;<span class="op" id="8036704">*</span><span class="ident" id="8036705">concurrentStmtQueryTest</span><span class="op" id="8036728">)</span>&nbsp;<span class="ident" id="8036730">test</span><span class="op" id="8036734">(</span><span class="ident" id="8036735">t</span>&nbsp;<span class="ident" id="8036737">testing</span><span class="op" id="8036744">.</span><span class="ident" id="8036745">TB</span><span class="op" id="8036747">)</span>&nbsp;<span class="builtintype" id="8036749">error</span>&nbsp;<span class="op" id="8036755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036758">rows</span><span class="op" id="8036762">,</span>&nbsp;<span class="ident" id="8036764">err</span>&nbsp;<span class="op" id="8036768">:=</span>&nbsp;<span class="ident" id="8036771">c</span><span class="op" id="8036772">.</span><span class="ident" id="8036773">stmt</span><span class="op" id="8036777">.</span><span class="ident" id="8036778">Query</span><span class="op" id="8036783">(</span><span class="op" id="8036784">)</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036787">if</span>&nbsp;<span class="ident" id="8036790">err</span>&nbsp;<span class="op" id="8036794">!=</span>&nbsp;<span class="ident" id="8036797">nil</span>&nbsp;<span class="op" id="8036801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036805">t</span><span class="op" id="8036806">.</span><span class="ident" id="8036807">Errorf</span><span class="op" id="8036813">(</span><span class="string" id="8036814">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8036835">,</span>&nbsp;<span class="ident" id="8036837">err</span><span class="op" id="8036840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036844">return</span>&nbsp;<span class="ident" id="8036851">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8036856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036860">var</span>&nbsp;<span class="ident" id="8036864">name</span>&nbsp;<span class="builtintype" id="8036869">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036877">for</span>&nbsp;<span class="ident" id="8036881">rows</span><span class="op" id="8036885">.</span><span class="ident" id="8036886">Next</span><span class="op" id="8036890">(</span><span class="op" id="8036891">)</span>&nbsp;<span class="op" id="8036893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036897">rows</span><span class="op" id="8036901">.</span><span class="ident" id="8036902">Scan</span><span class="op" id="8036906">(</span><span class="op" id="8036907">&amp;</span><span class="ident" id="8036908">name</span><span class="op" id="8036912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8036915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036918">rows</span><span class="op" id="8036922">.</span><span class="ident" id="8036923">Close</span><span class="op" id="8036928">(</span><span class="op" id="8036929">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8036932">return</span>&nbsp;<span class="ident" id="8036939">nil</span><br>
<span class="lineno"></span><span class="op" id="8036943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8036946">type</span>&nbsp;<span class="ident" id="8036951">concurrentStmtExecTest</span>&nbsp;<span class="keyword" id="8036974">struct</span>&nbsp;<span class="op" id="8036981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036984">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8036989">*</span><span class="ident" id="8036990">DB</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8036994">stmt</span>&nbsp;<span class="op" id="8036999">*</span><span class="ident" id="8037000">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8037005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037008">func</span>&nbsp;<span class="op" id="8037013">(</span><span class="ident" id="8037014">c</span>&nbsp;<span class="op" id="8037016">*</span><span class="ident" id="8037017">concurrentStmtExecTest</span><span class="op" id="8037039">)</span>&nbsp;<span class="ident" id="8037041">init</span><span class="op" id="8037045">(</span><span class="ident" id="8037046">t</span>&nbsp;<span class="ident" id="8037048">testing</span><span class="op" id="8037055">.</span><span class="ident" id="8037056">TB</span><span class="op" id="8037058">,</span>&nbsp;<span class="ident" id="8037060">db</span>&nbsp;<span class="op" id="8037063">*</span><span class="ident" id="8037064">DB</span><span class="op" id="8037066">)</span>&nbsp;<span class="op" id="8037068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037071">c</span><span class="op" id="8037072">.</span><span class="ident" id="8037073">db</span>&nbsp;<span class="op" id="8037076">=</span>&nbsp;<span class="ident" id="8037078">db</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037082">var</span>&nbsp;<span class="ident" id="8037086">err</span>&nbsp;<span class="builtintype" id="8037090">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037097">c</span><span class="op" id="8037098">.</span><span class="ident" id="8037099">stmt</span><span class="op" id="8037103">,</span>&nbsp;<span class="ident" id="8037105">err</span>&nbsp;<span class="op" id="8037109">=</span>&nbsp;<span class="ident" id="8037111">db</span><span class="op" id="8037113">.</span><span class="ident" id="8037114">Prepare</span><span class="op" id="8037121">(</span><span class="string" id="8037122">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8037175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037178">if</span>&nbsp;<span class="ident" id="8037181">err</span>&nbsp;<span class="op" id="8037185">!=</span>&nbsp;<span class="ident" id="8037188">nil</span>&nbsp;<span class="op" id="8037192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037196">t</span><span class="op" id="8037197">.</span><span class="ident" id="8037198">Fatal</span><span class="op" id="8037203">(</span><span class="ident" id="8037204">err</span><span class="op" id="8037207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037210">}</span><br>
<span class="lineno">1525</span><span class="op" id="8037212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037215">func</span>&nbsp;<span class="op" id="8037220">(</span><span class="ident" id="8037221">c</span>&nbsp;<span class="op" id="8037223">*</span><span class="ident" id="8037224">concurrentStmtExecTest</span><span class="op" id="8037246">)</span>&nbsp;<span class="ident" id="8037248">finish</span><span class="op" id="8037254">(</span><span class="ident" id="8037255">t</span>&nbsp;<span class="ident" id="8037257">testing</span><span class="op" id="8037264">.</span><span class="ident" id="8037265">TB</span><span class="op" id="8037267">)</span>&nbsp;<span class="op" id="8037269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037272">if</span>&nbsp;<span class="ident" id="8037275">c</span><span class="op" id="8037276">.</span><span class="ident" id="8037277">stmt</span>&nbsp;<span class="op" id="8037282">!=</span>&nbsp;<span class="ident" id="8037285">nil</span>&nbsp;<span class="op" id="8037289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037293">c</span><span class="op" id="8037294">.</span><span class="ident" id="8037295">stmt</span><span class="op" id="8037299">.</span><span class="ident" id="8037300">Close</span><span class="op" id="8037305">(</span><span class="op" id="8037306">)</span><br>
<span class="lineno">1530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037310">c</span><span class="op" id="8037311">.</span><span class="ident" id="8037312">stmt</span>&nbsp;<span class="op" id="8037317">=</span>&nbsp;<span class="ident" id="8037319">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037327">c</span><span class="op" id="8037328">.</span><span class="ident" id="8037329">db</span>&nbsp;<span class="op" id="8037332">=</span>&nbsp;<span class="ident" id="8037334">nil</span><br>
<span class="lineno"></span><span class="op" id="8037338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1535</span><span class="keyword" id="8037341">func</span>&nbsp;<span class="op" id="8037346">(</span><span class="ident" id="8037347">c</span>&nbsp;<span class="op" id="8037349">*</span><span class="ident" id="8037350">concurrentStmtExecTest</span><span class="op" id="8037372">)</span>&nbsp;<span class="ident" id="8037374">test</span><span class="op" id="8037378">(</span><span class="ident" id="8037379">t</span>&nbsp;<span class="ident" id="8037381">testing</span><span class="op" id="8037388">.</span><span class="ident" id="8037389">TB</span><span class="op" id="8037391">)</span>&nbsp;<span class="builtintype" id="8037393">error</span>&nbsp;<span class="op" id="8037399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037402">_</span><span class="op" id="8037403">,</span>&nbsp;<span class="ident" id="8037405">err</span>&nbsp;<span class="op" id="8037409">:=</span>&nbsp;<span class="ident" id="8037412">c</span><span class="op" id="8037413">.</span><span class="ident" id="8037414">stmt</span><span class="op" id="8037418">.</span><span class="ident" id="8037419">Exec</span><span class="op" id="8037423">(</span><span class="num" id="8037424">3</span><span class="op" id="8037425">,</span>&nbsp;<span class="ident" id="8037427">chrisBirthday</span><span class="op" id="8037440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037443">if</span>&nbsp;<span class="ident" id="8037446">err</span>&nbsp;<span class="op" id="8037450">!=</span>&nbsp;<span class="ident" id="8037453">nil</span>&nbsp;<span class="op" id="8037457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037461">t</span><span class="op" id="8037462">.</span><span class="ident" id="8037463">Errorf</span><span class="op" id="8037469">(</span><span class="string" id="8037470">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8037490">,</span>&nbsp;<span class="ident" id="8037492">err</span><span class="op" id="8037495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037499">return</span>&nbsp;<span class="ident" id="8037506">err</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037514">return</span>&nbsp;<span class="ident" id="8037521">nil</span><br>
<span class="lineno"></span><span class="op" id="8037525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037528">type</span>&nbsp;<span class="ident" id="8037533">concurrentTxQueryTest</span>&nbsp;<span class="keyword" id="8037555">struct</span>&nbsp;<span class="op" id="8037562">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037565">db</span>&nbsp;<span class="op" id="8037568">*</span><span class="ident" id="8037569">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037573">tx</span>&nbsp;<span class="op" id="8037576">*</span><span class="ident" id="8037577">Tx</span><br>
<span class="lineno"></span><span class="op" id="8037580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037583">func</span>&nbsp;<span class="op" id="8037588">(</span><span class="ident" id="8037589">c</span>&nbsp;<span class="op" id="8037591">*</span><span class="ident" id="8037592">concurrentTxQueryTest</span><span class="op" id="8037613">)</span>&nbsp;<span class="ident" id="8037615">init</span><span class="op" id="8037619">(</span><span class="ident" id="8037620">t</span>&nbsp;<span class="ident" id="8037622">testing</span><span class="op" id="8037629">.</span><span class="ident" id="8037630">TB</span><span class="op" id="8037632">,</span>&nbsp;<span class="ident" id="8037634">db</span>&nbsp;<span class="op" id="8037637">*</span><span class="ident" id="8037638">DB</span><span class="op" id="8037640">)</span>&nbsp;<span class="op" id="8037642">{</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037645">c</span><span class="op" id="8037646">.</span><span class="ident" id="8037647">db</span>&nbsp;<span class="op" id="8037650">=</span>&nbsp;<span class="ident" id="8037652">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037656">var</span>&nbsp;<span class="ident" id="8037660">err</span>&nbsp;<span class="builtintype" id="8037664">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037671">c</span><span class="op" id="8037672">.</span><span class="ident" id="8037673">tx</span><span class="op" id="8037675">,</span>&nbsp;<span class="ident" id="8037677">err</span>&nbsp;<span class="op" id="8037681">=</span>&nbsp;<span class="ident" id="8037683">c</span><span class="op" id="8037684">.</span><span class="ident" id="8037685">db</span><span class="op" id="8037687">.</span><span class="ident" id="8037688">Begin</span><span class="op" id="8037693">(</span><span class="op" id="8037694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037697">if</span>&nbsp;<span class="ident" id="8037700">err</span>&nbsp;<span class="op" id="8037704">!=</span>&nbsp;<span class="ident" id="8037707">nil</span>&nbsp;<span class="op" id="8037711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037715">t</span><span class="op" id="8037716">.</span><span class="ident" id="8037717">Fatal</span><span class="op" id="8037722">(</span><span class="ident" id="8037723">err</span><span class="op" id="8037726">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037729">}</span><br>
<span class="lineno"></span><span class="op" id="8037731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8037734">func</span>&nbsp;<span class="op" id="8037739">(</span><span class="ident" id="8037740">c</span>&nbsp;<span class="op" id="8037742">*</span><span class="ident" id="8037743">concurrentTxQueryTest</span><span class="op" id="8037764">)</span>&nbsp;<span class="ident" id="8037766">finish</span><span class="op" id="8037772">(</span><span class="ident" id="8037773">t</span>&nbsp;<span class="ident" id="8037775">testing</span><span class="op" id="8037782">.</span><span class="ident" id="8037783">TB</span><span class="op" id="8037785">)</span>&nbsp;<span class="op" id="8037787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037790">if</span>&nbsp;<span class="ident" id="8037793">c</span><span class="op" id="8037794">.</span><span class="ident" id="8037795">tx</span>&nbsp;<span class="op" id="8037798">!=</span>&nbsp;<span class="ident" id="8037801">nil</span>&nbsp;<span class="op" id="8037805">{</span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037809">c</span><span class="op" id="8037810">.</span><span class="ident" id="8037811">tx</span><span class="op" id="8037813">.</span><span class="ident" id="8037814">Rollback</span><span class="op" id="8037822">(</span><span class="op" id="8037823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037827">c</span><span class="op" id="8037828">.</span><span class="ident" id="8037829">tx</span>&nbsp;<span class="op" id="8037832">=</span>&nbsp;<span class="ident" id="8037834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8037839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037842">c</span><span class="op" id="8037843">.</span><span class="ident" id="8037844">db</span>&nbsp;<span class="op" id="8037847">=</span>&nbsp;<span class="ident" id="8037849">nil</span><br>
<span class="lineno"></span><span class="op" id="8037853">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span><span class="keyword" id="8037856">func</span>&nbsp;<span class="op" id="8037861">(</span><span class="ident" id="8037862">c</span>&nbsp;<span class="op" id="8037864">*</span><span class="ident" id="8037865">concurrentTxQueryTest</span><span class="op" id="8037886">)</span>&nbsp;<span class="ident" id="8037888">test</span><span class="op" id="8037892">(</span><span class="ident" id="8037893">t</span>&nbsp;<span class="ident" id="8037895">testing</span><span class="op" id="8037902">.</span><span class="ident" id="8037903">TB</span><span class="op" id="8037905">)</span>&nbsp;<span class="builtintype" id="8037907">error</span>&nbsp;<span class="op" id="8037913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037916">rows</span><span class="op" id="8037920">,</span>&nbsp;<span class="ident" id="8037922">err</span>&nbsp;<span class="op" id="8037926">:=</span>&nbsp;<span class="ident" id="8037929">c</span><span class="op" id="8037930">.</span><span class="ident" id="8037931">db</span><span class="op" id="8037933">.</span><span class="ident" id="8037934">Query</span><span class="op" id="8037939">(</span><span class="string" id="8037940">&#34;SELECT|people|name|&#34;</span><span class="op" id="8037961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037964">if</span>&nbsp;<span class="ident" id="8037967">err</span>&nbsp;<span class="op" id="8037971">!=</span>&nbsp;<span class="ident" id="8037974">nil</span>&nbsp;<span class="op" id="8037978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8037982">t</span><span class="op" id="8037983">.</span><span class="ident" id="8037984">Error</span><span class="op" id="8037989">(</span><span class="ident" id="8037990">err</span><span class="op" id="8037993">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8037997">return</span>&nbsp;<span class="ident" id="8038004">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038012">var</span>&nbsp;<span class="ident" id="8038016">name</span>&nbsp;<span class="builtintype" id="8038021">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038029">for</span>&nbsp;<span class="ident" id="8038033">rows</span><span class="op" id="8038037">.</span><span class="ident" id="8038038">Next</span><span class="op" id="8038042">(</span><span class="op" id="8038043">)</span>&nbsp;<span class="op" id="8038045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038049">rows</span><span class="op" id="8038053">.</span><span class="ident" id="8038054">Scan</span><span class="op" id="8038058">(</span><span class="op" id="8038059">&amp;</span><span class="ident" id="8038060">name</span><span class="op" id="8038064">)</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038067">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038070">rows</span><span class="op" id="8038074">.</span><span class="ident" id="8038075">Close</span><span class="op" id="8038080">(</span><span class="op" id="8038081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038084">return</span>&nbsp;<span class="ident" id="8038091">nil</span><br>
<span class="lineno"></span><span class="op" id="8038095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1580</span><span class="keyword" id="8038098">type</span>&nbsp;<span class="ident" id="8038103">concurrentTxExecTest</span>&nbsp;<span class="keyword" id="8038124">struct</span>&nbsp;<span class="op" id="8038131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038134">db</span>&nbsp;<span class="op" id="8038137">*</span><span class="ident" id="8038138">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038142">tx</span>&nbsp;<span class="op" id="8038145">*</span><span class="ident" id="8038146">Tx</span><br>
<span class="lineno"></span><span class="op" id="8038149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1585</span><span class="keyword" id="8038152">func</span>&nbsp;<span class="op" id="8038157">(</span><span class="ident" id="8038158">c</span>&nbsp;<span class="op" id="8038160">*</span><span class="ident" id="8038161">concurrentTxExecTest</span><span class="op" id="8038181">)</span>&nbsp;<span class="ident" id="8038183">init</span><span class="op" id="8038187">(</span><span class="ident" id="8038188">t</span>&nbsp;<span class="ident" id="8038190">testing</span><span class="op" id="8038197">.</span><span class="ident" id="8038198">TB</span><span class="op" id="8038200">,</span>&nbsp;<span class="ident" id="8038202">db</span>&nbsp;<span class="op" id="8038205">*</span><span class="ident" id="8038206">DB</span><span class="op" id="8038208">)</span>&nbsp;<span class="op" id="8038210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038213">c</span><span class="op" id="8038214">.</span><span class="ident" id="8038215">db</span>&nbsp;<span class="op" id="8038218">=</span>&nbsp;<span class="ident" id="8038220">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038224">var</span>&nbsp;<span class="ident" id="8038228">err</span>&nbsp;<span class="builtintype" id="8038232">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038239">c</span><span class="op" id="8038240">.</span><span class="ident" id="8038241">tx</span><span class="op" id="8038243">,</span>&nbsp;<span class="ident" id="8038245">err</span>&nbsp;<span class="op" id="8038249">=</span>&nbsp;<span class="ident" id="8038251">c</span><span class="op" id="8038252">.</span><span class="ident" id="8038253">db</span><span class="op" id="8038255">.</span><span class="ident" id="8038256">Begin</span><span class="op" id="8038261">(</span><span class="op" id="8038262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038265">if</span>&nbsp;<span class="ident" id="8038268">err</span>&nbsp;<span class="op" id="8038272">!=</span>&nbsp;<span class="ident" id="8038275">nil</span>&nbsp;<span class="op" id="8038279">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038283">t</span><span class="op" id="8038284">.</span><span class="ident" id="8038285">Fatal</span><span class="op" id="8038290">(</span><span class="ident" id="8038291">err</span><span class="op" id="8038294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038297">}</span><br>
<span class="lineno"></span><span class="op" id="8038299">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038302">func</span>&nbsp;<span class="op" id="8038307">(</span><span class="ident" id="8038308">c</span>&nbsp;<span class="op" id="8038310">*</span><span class="ident" id="8038311">concurrentTxExecTest</span><span class="op" id="8038331">)</span>&nbsp;<span class="ident" id="8038333">finish</span><span class="op" id="8038339">(</span><span class="ident" id="8038340">t</span>&nbsp;<span class="ident" id="8038342">testing</span><span class="op" id="8038349">.</span><span class="ident" id="8038350">TB</span><span class="op" id="8038352">)</span>&nbsp;<span class="op" id="8038354">{</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038357">if</span>&nbsp;<span class="ident" id="8038360">c</span><span class="op" id="8038361">.</span><span class="ident" id="8038362">tx</span>&nbsp;<span class="op" id="8038365">!=</span>&nbsp;<span class="ident" id="8038368">nil</span>&nbsp;<span class="op" id="8038372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038376">c</span><span class="op" id="8038377">.</span><span class="ident" id="8038378">tx</span><span class="op" id="8038380">.</span><span class="ident" id="8038381">Rollback</span><span class="op" id="8038389">(</span><span class="op" id="8038390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038394">c</span><span class="op" id="8038395">.</span><span class="ident" id="8038396">tx</span>&nbsp;<span class="op" id="8038399">=</span>&nbsp;<span class="ident" id="8038401">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038409">c</span><span class="op" id="8038410">.</span><span class="ident" id="8038411">db</span>&nbsp;<span class="op" id="8038414">=</span>&nbsp;<span class="ident" id="8038416">nil</span><br>
<span class="lineno">1600</span><span class="op" id="8038420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038423">func</span>&nbsp;<span class="op" id="8038428">(</span><span class="ident" id="8038429">c</span>&nbsp;<span class="op" id="8038431">*</span><span class="ident" id="8038432">concurrentTxExecTest</span><span class="op" id="8038452">)</span>&nbsp;<span class="ident" id="8038454">test</span><span class="op" id="8038458">(</span><span class="ident" id="8038459">t</span>&nbsp;<span class="ident" id="8038461">testing</span><span class="op" id="8038468">.</span><span class="ident" id="8038469">TB</span><span class="op" id="8038471">)</span>&nbsp;<span class="builtintype" id="8038473">error</span>&nbsp;<span class="op" id="8038479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038482">_</span><span class="op" id="8038483">,</span>&nbsp;<span class="ident" id="8038485">err</span>&nbsp;<span class="op" id="8038489">:=</span>&nbsp;<span class="ident" id="8038492">c</span><span class="op" id="8038493">.</span><span class="ident" id="8038494">tx</span><span class="op" id="8038496">.</span><span class="ident" id="8038497">Exec</span><span class="op" id="8038501">(</span><span class="string" id="8038502">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8038555">,</span>&nbsp;<span class="num" id="8038557">3</span><span class="op" id="8038558">,</span>&nbsp;<span class="ident" id="8038560">chrisBirthday</span><span class="op" id="8038573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038576">if</span>&nbsp;<span class="ident" id="8038579">err</span>&nbsp;<span class="op" id="8038583">!=</span>&nbsp;<span class="ident" id="8038586">nil</span>&nbsp;<span class="op" id="8038590">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038594">t</span><span class="op" id="8038595">.</span><span class="ident" id="8038596">Error</span><span class="op" id="8038601">(</span><span class="ident" id="8038602">err</span><span class="op" id="8038605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038609">return</span>&nbsp;<span class="ident" id="8038616">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038624">return</span>&nbsp;<span class="ident" id="8038631">nil</span><br>
<span class="lineno"></span><span class="op" id="8038635">}</span><br>
<span class="lineno">1610</span><br>
<span class="lineno"></span><span class="keyword" id="8038638">type</span>&nbsp;<span class="ident" id="8038643">concurrentTxStmtQueryTest</span>&nbsp;<span class="keyword" id="8038669">struct</span>&nbsp;<span class="op" id="8038676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038679">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8038684">*</span><span class="ident" id="8038685">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038689">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8038694">*</span><span class="ident" id="8038695">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038699">stmt</span>&nbsp;<span class="op" id="8038704">*</span><span class="ident" id="8038705">Stmt</span><br>
<span class="lineno">1615</span><span class="op" id="8038710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8038713">func</span>&nbsp;<span class="op" id="8038718">(</span><span class="ident" id="8038719">c</span>&nbsp;<span class="op" id="8038721">*</span><span class="ident" id="8038722">concurrentTxStmtQueryTest</span><span class="op" id="8038747">)</span>&nbsp;<span class="ident" id="8038749">init</span><span class="op" id="8038753">(</span><span class="ident" id="8038754">t</span>&nbsp;<span class="ident" id="8038756">testing</span><span class="op" id="8038763">.</span><span class="ident" id="8038764">TB</span><span class="op" id="8038766">,</span>&nbsp;<span class="ident" id="8038768">db</span>&nbsp;<span class="op" id="8038771">*</span><span class="ident" id="8038772">DB</span><span class="op" id="8038774">)</span>&nbsp;<span class="op" id="8038776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038779">c</span><span class="op" id="8038780">.</span><span class="ident" id="8038781">db</span>&nbsp;<span class="op" id="8038784">=</span>&nbsp;<span class="ident" id="8038786">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038790">var</span>&nbsp;<span class="ident" id="8038794">err</span>&nbsp;<span class="builtintype" id="8038798">error</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038805">c</span><span class="op" id="8038806">.</span><span class="ident" id="8038807">tx</span><span class="op" id="8038809">,</span>&nbsp;<span class="ident" id="8038811">err</span>&nbsp;<span class="op" id="8038815">=</span>&nbsp;<span class="ident" id="8038817">c</span><span class="op" id="8038818">.</span><span class="ident" id="8038819">db</span><span class="op" id="8038821">.</span><span class="ident" id="8038822">Begin</span><span class="op" id="8038827">(</span><span class="op" id="8038828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038831">if</span>&nbsp;<span class="ident" id="8038834">err</span>&nbsp;<span class="op" id="8038838">!=</span>&nbsp;<span class="ident" id="8038841">nil</span>&nbsp;<span class="op" id="8038845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038849">t</span><span class="op" id="8038850">.</span><span class="ident" id="8038851">Fatal</span><span class="op" id="8038856">(</span><span class="ident" id="8038857">err</span><span class="op" id="8038860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038866">c</span><span class="op" id="8038867">.</span><span class="ident" id="8038868">stmt</span><span class="op" id="8038872">,</span>&nbsp;<span class="ident" id="8038874">err</span>&nbsp;<span class="op" id="8038878">=</span>&nbsp;<span class="ident" id="8038880">c</span><span class="op" id="8038881">.</span><span class="ident" id="8038882">tx</span><span class="op" id="8038884">.</span><span class="ident" id="8038885">Prepare</span><span class="op" id="8038892">(</span><span class="string" id="8038893">&#34;SELECT|people|name|&#34;</span><span class="op" id="8038914">)</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8038917">if</span>&nbsp;<span class="ident" id="8038920">err</span>&nbsp;<span class="op" id="8038924">!=</span>&nbsp;<span class="ident" id="8038927">nil</span>&nbsp;<span class="op" id="8038931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8038935">t</span><span class="op" id="8038936">.</span><span class="ident" id="8038937">Fatal</span><span class="op" id="8038942">(</span><span class="ident" id="8038943">err</span><span class="op" id="8038946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8038949">}</span><br>
<span class="lineno"></span><span class="op" id="8038951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1630</span><span class="keyword" id="8038954">func</span>&nbsp;<span class="op" id="8038959">(</span><span class="ident" id="8038960">c</span>&nbsp;<span class="op" id="8038962">*</span><span class="ident" id="8038963">concurrentTxStmtQueryTest</span><span class="op" id="8038988">)</span>&nbsp;<span class="ident" id="8038990">finish</span><span class="op" id="8038996">(</span><span class="ident" id="8038997">t</span>&nbsp;<span class="ident" id="8038999">testing</span><span class="op" id="8039006">.</span><span class="ident" id="8039007">TB</span><span class="op" id="8039009">)</span>&nbsp;<span class="op" id="8039011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039014">if</span>&nbsp;<span class="ident" id="8039017">c</span><span class="op" id="8039018">.</span><span class="ident" id="8039019">stmt</span>&nbsp;<span class="op" id="8039024">!=</span>&nbsp;<span class="ident" id="8039027">nil</span>&nbsp;<span class="op" id="8039031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039035">c</span><span class="op" id="8039036">.</span><span class="ident" id="8039037">stmt</span><span class="op" id="8039041">.</span><span class="ident" id="8039042">Close</span><span class="op" id="8039047">(</span><span class="op" id="8039048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039052">c</span><span class="op" id="8039053">.</span><span class="ident" id="8039054">stmt</span>&nbsp;<span class="op" id="8039059">=</span>&nbsp;<span class="ident" id="8039061">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039066">}</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039069">if</span>&nbsp;<span class="ident" id="8039072">c</span><span class="op" id="8039073">.</span><span class="ident" id="8039074">tx</span>&nbsp;<span class="op" id="8039077">!=</span>&nbsp;<span class="ident" id="8039080">nil</span>&nbsp;<span class="op" id="8039084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039088">c</span><span class="op" id="8039089">.</span><span class="ident" id="8039090">tx</span><span class="op" id="8039092">.</span><span class="ident" id="8039093">Rollback</span><span class="op" id="8039101">(</span><span class="op" id="8039102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039106">c</span><span class="op" id="8039107">.</span><span class="ident" id="8039108">tx</span>&nbsp;<span class="op" id="8039111">=</span>&nbsp;<span class="ident" id="8039113">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039121">c</span><span class="op" id="8039122">.</span><span class="ident" id="8039123">db</span>&nbsp;<span class="op" id="8039126">=</span>&nbsp;<span class="ident" id="8039128">nil</span><br>
<span class="lineno">1640</span><span class="op" id="8039132">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039135">func</span>&nbsp;<span class="op" id="8039140">(</span><span class="ident" id="8039141">c</span>&nbsp;<span class="op" id="8039143">*</span><span class="ident" id="8039144">concurrentTxStmtQueryTest</span><span class="op" id="8039169">)</span>&nbsp;<span class="ident" id="8039171">test</span><span class="op" id="8039175">(</span><span class="ident" id="8039176">t</span>&nbsp;<span class="ident" id="8039178">testing</span><span class="op" id="8039185">.</span><span class="ident" id="8039186">TB</span><span class="op" id="8039188">)</span>&nbsp;<span class="builtintype" id="8039190">error</span>&nbsp;<span class="op" id="8039196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039199">rows</span><span class="op" id="8039203">,</span>&nbsp;<span class="ident" id="8039205">err</span>&nbsp;<span class="op" id="8039209">:=</span>&nbsp;<span class="ident" id="8039212">c</span><span class="op" id="8039213">.</span><span class="ident" id="8039214">stmt</span><span class="op" id="8039218">.</span><span class="ident" id="8039219">Query</span><span class="op" id="8039224">(</span><span class="op" id="8039225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039228">if</span>&nbsp;<span class="ident" id="8039231">err</span>&nbsp;<span class="op" id="8039235">!=</span>&nbsp;<span class="ident" id="8039238">nil</span>&nbsp;<span class="op" id="8039242">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039246">t</span><span class="op" id="8039247">.</span><span class="ident" id="8039248">Errorf</span><span class="op" id="8039254">(</span><span class="string" id="8039255">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8039276">,</span>&nbsp;<span class="ident" id="8039278">err</span><span class="op" id="8039281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039285">return</span>&nbsp;<span class="ident" id="8039292">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039301">var</span>&nbsp;<span class="ident" id="8039305">name</span>&nbsp;<span class="builtintype" id="8039310">string</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039318">for</span>&nbsp;<span class="ident" id="8039322">rows</span><span class="op" id="8039326">.</span><span class="ident" id="8039327">Next</span><span class="op" id="8039331">(</span><span class="op" id="8039332">)</span>&nbsp;<span class="op" id="8039334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039338">rows</span><span class="op" id="8039342">.</span><span class="ident" id="8039343">Scan</span><span class="op" id="8039347">(</span><span class="op" id="8039348">&amp;</span><span class="ident" id="8039349">name</span><span class="op" id="8039353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039359">rows</span><span class="op" id="8039363">.</span><span class="ident" id="8039364">Close</span><span class="op" id="8039369">(</span><span class="op" id="8039370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039373">return</span>&nbsp;<span class="ident" id="8039380">nil</span><br>
<span class="lineno">1655</span><span class="op" id="8039384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039387">type</span>&nbsp;<span class="ident" id="8039392">concurrentTxStmtExecTest</span>&nbsp;<span class="keyword" id="8039417">struct</span>&nbsp;<span class="op" id="8039424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039427">db</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8039432">*</span><span class="ident" id="8039433">DB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039437">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="8039442">*</span><span class="ident" id="8039443">Tx</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039447">stmt</span>&nbsp;<span class="op" id="8039452">*</span><span class="ident" id="8039453">Stmt</span><br>
<span class="lineno"></span><span class="op" id="8039458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039461">func</span>&nbsp;<span class="op" id="8039466">(</span><span class="ident" id="8039467">c</span>&nbsp;<span class="op" id="8039469">*</span><span class="ident" id="8039470">concurrentTxStmtExecTest</span><span class="op" id="8039494">)</span>&nbsp;<span class="ident" id="8039496">init</span><span class="op" id="8039500">(</span><span class="ident" id="8039501">t</span>&nbsp;<span class="ident" id="8039503">testing</span><span class="op" id="8039510">.</span><span class="ident" id="8039511">TB</span><span class="op" id="8039513">,</span>&nbsp;<span class="ident" id="8039515">db</span>&nbsp;<span class="op" id="8039518">*</span><span class="ident" id="8039519">DB</span><span class="op" id="8039521">)</span>&nbsp;<span class="op" id="8039523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039526">c</span><span class="op" id="8039527">.</span><span class="ident" id="8039528">db</span>&nbsp;<span class="op" id="8039531">=</span>&nbsp;<span class="ident" id="8039533">db</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039537">var</span>&nbsp;<span class="ident" id="8039541">err</span>&nbsp;<span class="builtintype" id="8039545">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039552">c</span><span class="op" id="8039553">.</span><span class="ident" id="8039554">tx</span><span class="op" id="8039556">,</span>&nbsp;<span class="ident" id="8039558">err</span>&nbsp;<span class="op" id="8039562">=</span>&nbsp;<span class="ident" id="8039564">c</span><span class="op" id="8039565">.</span><span class="ident" id="8039566">db</span><span class="op" id="8039568">.</span><span class="ident" id="8039569">Begin</span><span class="op" id="8039574">(</span><span class="op" id="8039575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039578">if</span>&nbsp;<span class="ident" id="8039581">err</span>&nbsp;<span class="op" id="8039585">!=</span>&nbsp;<span class="ident" id="8039588">nil</span>&nbsp;<span class="op" id="8039592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039596">t</span><span class="op" id="8039597">.</span><span class="ident" id="8039598">Fatal</span><span class="op" id="8039603">(</span><span class="ident" id="8039604">err</span><span class="op" id="8039607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039610">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039613">c</span><span class="op" id="8039614">.</span><span class="ident" id="8039615">stmt</span><span class="op" id="8039619">,</span>&nbsp;<span class="ident" id="8039621">err</span>&nbsp;<span class="op" id="8039625">=</span>&nbsp;<span class="ident" id="8039627">c</span><span class="op" id="8039628">.</span><span class="ident" id="8039629">tx</span><span class="op" id="8039631">.</span><span class="ident" id="8039632">Prepare</span><span class="op" id="8039639">(</span><span class="string" id="8039640">&#34;NOSERT|people|name=Chris,age=?,photo=CPHOTO,bdate=?&#34;</span><span class="op" id="8039693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039696">if</span>&nbsp;<span class="ident" id="8039699">err</span>&nbsp;<span class="op" id="8039703">!=</span>&nbsp;<span class="ident" id="8039706">nil</span>&nbsp;<span class="op" id="8039710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039714">t</span><span class="op" id="8039715">.</span><span class="ident" id="8039716">Fatal</span><span class="op" id="8039721">(</span><span class="ident" id="8039722">err</span><span class="op" id="8039725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039728">}</span><br>
<span class="lineno"></span><span class="op" id="8039730">}</span><br>
<span class="lineno">1675</span><br>
<span class="lineno"></span><span class="keyword" id="8039733">func</span>&nbsp;<span class="op" id="8039738">(</span><span class="ident" id="8039739">c</span>&nbsp;<span class="op" id="8039741">*</span><span class="ident" id="8039742">concurrentTxStmtExecTest</span><span class="op" id="8039766">)</span>&nbsp;<span class="ident" id="8039768">finish</span><span class="op" id="8039774">(</span><span class="ident" id="8039775">t</span>&nbsp;<span class="ident" id="8039777">testing</span><span class="op" id="8039784">.</span><span class="ident" id="8039785">TB</span><span class="op" id="8039787">)</span>&nbsp;<span class="op" id="8039789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039792">if</span>&nbsp;<span class="ident" id="8039795">c</span><span class="op" id="8039796">.</span><span class="ident" id="8039797">stmt</span>&nbsp;<span class="op" id="8039802">!=</span>&nbsp;<span class="ident" id="8039805">nil</span>&nbsp;<span class="op" id="8039809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039813">c</span><span class="op" id="8039814">.</span><span class="ident" id="8039815">stmt</span><span class="op" id="8039819">.</span><span class="ident" id="8039820">Close</span><span class="op" id="8039825">(</span><span class="op" id="8039826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039830">c</span><span class="op" id="8039831">.</span><span class="ident" id="8039832">stmt</span>&nbsp;<span class="op" id="8039837">=</span>&nbsp;<span class="ident" id="8039839">nil</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8039847">if</span>&nbsp;<span class="ident" id="8039850">c</span><span class="op" id="8039851">.</span><span class="ident" id="8039852">tx</span>&nbsp;<span class="op" id="8039855">!=</span>&nbsp;<span class="ident" id="8039858">nil</span>&nbsp;<span class="op" id="8039862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039866">c</span><span class="op" id="8039867">.</span><span class="ident" id="8039868">tx</span><span class="op" id="8039870">.</span><span class="ident" id="8039871">Rollback</span><span class="op" id="8039879">(</span><span class="op" id="8039880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039884">c</span><span class="op" id="8039885">.</span><span class="ident" id="8039886">tx</span>&nbsp;<span class="op" id="8039889">=</span>&nbsp;<span class="ident" id="8039891">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8039896">}</span><br>
<span class="lineno">1685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039899">c</span><span class="op" id="8039900">.</span><span class="ident" id="8039901">db</span>&nbsp;<span class="op" id="8039904">=</span>&nbsp;<span class="ident" id="8039906">nil</span><br>
<span class="lineno"></span><span class="op" id="8039910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8039913">func</span>&nbsp;<span class="op" id="8039918">(</span><span class="ident" id="8039919">c</span>&nbsp;<span class="op" id="8039921">*</span><span class="ident" id="8039922">concurrentTxStmtExecTest</span><span class="op" id="8039946">)</span>&nbsp;<span class="ident" id="8039948">test</span><span class="op" id="8039952">(</span><span class="ident" id="8039953">t</span>&nbsp;<span class="ident" id="8039955">testing</span><span class="op" id="8039962">.</span><span class="ident" id="8039963">TB</span><span class="op" id="8039965">)</span>&nbsp;<span class="builtintype" id="8039967">error</span>&nbsp;<span class="op" id="8039973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8039976">_</span><span class="op" id="8039977">,</span>&nbsp;<span class="ident" id="8039979">err</span>&nbsp;<span class="op" id="8039983">:=</span>&nbsp;<span class="ident" id="8039986">c</span><span class="op" id="8039987">.</span><span class="ident" id="8039988">stmt</span><span class="op" id="8039992">.</span><span class="ident" id="8039993">Exec</span><span class="op" id="8039997">(</span><span class="num" id="8039998">3</span><span class="op" id="8039999">,</span>&nbsp;<span class="ident" id="8040001">chrisBirthday</span><span class="op" id="8040014">)</span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040017">if</span>&nbsp;<span class="ident" id="8040020">err</span>&nbsp;<span class="op" id="8040024">!=</span>&nbsp;<span class="ident" id="8040027">nil</span>&nbsp;<span class="op" id="8040031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040035">t</span><span class="op" id="8040036">.</span><span class="ident" id="8040037">Errorf</span><span class="op" id="8040043">(</span><span class="string" id="8040044">&#34;error&nbsp;on&nbsp;exec:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8040064">,</span>&nbsp;<span class="ident" id="8040066">err</span><span class="op" id="8040069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040073">return</span>&nbsp;<span class="ident" id="8040080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040088">return</span>&nbsp;<span class="ident" id="8040095">nil</span><br>
<span class="lineno">1695</span><span class="op" id="8040099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040102">type</span>&nbsp;<span class="ident" id="8040107">concurrentRandomTest</span>&nbsp;<span class="keyword" id="8040128">struct</span>&nbsp;<span class="op" id="8040135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040138">tests</span>&nbsp;<span class="op" id="8040144">[</span><span class="op" id="8040145">]</span><span class="ident" id="8040146">concurrentTest</span><br>
<span class="lineno"></span><span class="op" id="8040161">}</span><br>
<span class="lineno">1700</span><br>
<span class="lineno"></span><span class="keyword" id="8040164">func</span>&nbsp;<span class="op" id="8040169">(</span><span class="ident" id="8040170">c</span>&nbsp;<span class="op" id="8040172">*</span><span class="ident" id="8040173">concurrentRandomTest</span><span class="op" id="8040193">)</span>&nbsp;<span class="ident" id="8040195">init</span><span class="op" id="8040199">(</span><span class="ident" id="8040200">t</span>&nbsp;<span class="ident" id="8040202">testing</span><span class="op" id="8040209">.</span><span class="ident" id="8040210">TB</span><span class="op" id="8040212">,</span>&nbsp;<span class="ident" id="8040214">db</span>&nbsp;<span class="op" id="8040217">*</span><span class="ident" id="8040218">DB</span><span class="op" id="8040220">)</span>&nbsp;<span class="op" id="8040222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040225">c</span><span class="op" id="8040226">.</span><span class="ident" id="8040227">tests</span>&nbsp;<span class="op" id="8040233">=</span>&nbsp;<span class="op" id="8040235">[</span><span class="op" id="8040236">]</span><span class="ident" id="8040237">concurrentTest</span><span class="op" id="8040251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040255">new</span><span class="op" id="8040258">(</span><span class="ident" id="8040259">concurrentDBQueryTest</span><span class="op" id="8040280">)</span><span class="op" id="8040281">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040285">new</span><span class="op" id="8040288">(</span><span class="ident" id="8040289">concurrentDBExecTest</span><span class="op" id="8040309">)</span><span class="op" id="8040310">,</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040314">new</span><span class="op" id="8040317">(</span><span class="ident" id="8040318">concurrentStmtQueryTest</span><span class="op" id="8040341">)</span><span class="op" id="8040342">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040346">new</span><span class="op" id="8040349">(</span><span class="ident" id="8040350">concurrentStmtExecTest</span><span class="op" id="8040372">)</span><span class="op" id="8040373">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040377">new</span><span class="op" id="8040380">(</span><span class="ident" id="8040381">concurrentTxQueryTest</span><span class="op" id="8040402">)</span><span class="op" id="8040403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040407">new</span><span class="op" id="8040410">(</span><span class="ident" id="8040411">concurrentTxExecTest</span><span class="op" id="8040431">)</span><span class="op" id="8040432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040436">new</span><span class="op" id="8040439">(</span><span class="ident" id="8040440">concurrentTxStmtQueryTest</span><span class="op" id="8040465">)</span><span class="op" id="8040466">,</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8040470">new</span><span class="op" id="8040473">(</span><span class="ident" id="8040474">concurrentTxStmtExecTest</span><span class="op" id="8040498">)</span><span class="op" id="8040499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040505">for</span>&nbsp;<span class="ident" id="8040509">_</span><span class="op" id="8040510">,</span>&nbsp;<span class="ident" id="8040512">ct</span>&nbsp;<span class="op" id="8040515">:=</span>&nbsp;<span class="keyword" id="8040518">range</span>&nbsp;<span class="ident" id="8040524">c</span><span class="op" id="8040525">.</span><span class="ident" id="8040526">tests</span>&nbsp;<span class="op" id="8040532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040536">ct</span><span class="op" id="8040538">.</span><span class="ident" id="8040539">init</span><span class="op" id="8040543">(</span><span class="ident" id="8040544">t</span><span class="op" id="8040545">,</span>&nbsp;<span class="ident" id="8040547">db</span><span class="op" id="8040549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040552">}</span><br>
<span class="lineno">1715</span><span class="op" id="8040554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040557">func</span>&nbsp;<span class="op" id="8040562">(</span><span class="ident" id="8040563">c</span>&nbsp;<span class="op" id="8040565">*</span><span class="ident" id="8040566">concurrentRandomTest</span><span class="op" id="8040586">)</span>&nbsp;<span class="ident" id="8040588">finish</span><span class="op" id="8040594">(</span><span class="ident" id="8040595">t</span>&nbsp;<span class="ident" id="8040597">testing</span><span class="op" id="8040604">.</span><span class="ident" id="8040605">TB</span><span class="op" id="8040607">)</span>&nbsp;<span class="op" id="8040609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040612">for</span>&nbsp;<span class="ident" id="8040616">_</span><span class="op" id="8040617">,</span>&nbsp;<span class="ident" id="8040619">ct</span>&nbsp;<span class="op" id="8040622">:=</span>&nbsp;<span class="keyword" id="8040625">range</span>&nbsp;<span class="ident" id="8040631">c</span><span class="op" id="8040632">.</span><span class="ident" id="8040633">tests</span>&nbsp;<span class="op" id="8040639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040643">ct</span><span class="op" id="8040645">.</span><span class="ident" id="8040646">finish</span><span class="op" id="8040652">(</span><span class="ident" id="8040653">t</span><span class="op" id="8040654">)</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040657">}</span><br>
<span class="lineno"></span><span class="op" id="8040659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040662">func</span>&nbsp;<span class="op" id="8040667">(</span><span class="ident" id="8040668">c</span>&nbsp;<span class="op" id="8040670">*</span><span class="ident" id="8040671">concurrentRandomTest</span><span class="op" id="8040691">)</span>&nbsp;<span class="ident" id="8040693">test</span><span class="op" id="8040697">(</span><span class="ident" id="8040698">t</span>&nbsp;<span class="ident" id="8040700">testing</span><span class="op" id="8040707">.</span><span class="ident" id="8040708">TB</span><span class="op" id="8040710">)</span>&nbsp;<span class="builtintype" id="8040712">error</span>&nbsp;<span class="op" id="8040718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040721">ct</span>&nbsp;<span class="op" id="8040724">:=</span>&nbsp;<span class="ident" id="8040727">c</span><span class="op" id="8040728">.</span><span class="ident" id="8040729">tests</span><span class="op" id="8040734">[</span><span class="ident" id="8040735">rand</span><span class="op" id="8040739">.</span><span class="ident" id="8040740">Intn</span><span class="op" id="8040744">(</span><span class="builtinfunc" id="8040745">len</span><span class="op" id="8040748">(</span><span class="ident" id="8040749">c</span><span class="op" id="8040750">.</span><span class="ident" id="8040751">tests</span><span class="op" id="8040756">)</span><span class="op" id="8040757">)</span><span class="op" id="8040758">]</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040761">return</span>&nbsp;<span class="ident" id="8040768">ct</span><span class="op" id="8040770">.</span><span class="ident" id="8040771">test</span><span class="op" id="8040775">(</span><span class="ident" id="8040776">t</span><span class="op" id="8040777">)</span><br>
<span class="lineno"></span><span class="op" id="8040779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8040782">func</span>&nbsp;<span class="ident" id="8040787">doConcurrentTest</span><span class="op" id="8040803">(</span><span class="ident" id="8040804">t</span>&nbsp;<span class="ident" id="8040806">testing</span><span class="op" id="8040813">.</span><span class="ident" id="8040814">TB</span><span class="op" id="8040816">,</span>&nbsp;<span class="ident" id="8040818">ct</span>&nbsp;<span class="ident" id="8040821">concurrentTest</span><span class="op" id="8040835">)</span>&nbsp;<span class="op" id="8040837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040840">maxProcs</span><span class="op" id="8040848">,</span>&nbsp;<span class="ident" id="8040850">numReqs</span>&nbsp;<span class="op" id="8040858">:=</span>&nbsp;<span class="num" id="8040861">1</span><span class="op" id="8040862">,</span>&nbsp;<span class="num" id="8040864">500</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040869">if</span>&nbsp;<span class="ident" id="8040872">testing</span><span class="op" id="8040879">.</span><span class="ident" id="8040880">Short</span><span class="op" id="8040885">(</span><span class="op" id="8040886">)</span>&nbsp;<span class="op" id="8040888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040892">maxProcs</span><span class="op" id="8040900">,</span>&nbsp;<span class="ident" id="8040902">numReqs</span>&nbsp;<span class="op" id="8040910">=</span>&nbsp;<span class="num" id="8040912">4</span><span class="op" id="8040913">,</span>&nbsp;<span class="num" id="8040915">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8040919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8040922">defer</span>&nbsp;<span class="ident" id="8040928">runtime</span><span class="op" id="8040935">.</span><span class="ident" id="8040936">GOMAXPROCS</span><span class="op" id="8040946">(</span><span class="ident" id="8040947">runtime</span><span class="op" id="8040954">.</span><span class="ident" id="8040955">GOMAXPROCS</span><span class="op" id="8040965">(</span><span class="ident" id="8040966">maxProcs</span><span class="op" id="8040974">)</span><span class="op" id="8040975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8040979">db</span>&nbsp;<span class="op" id="8040982">:=</span>&nbsp;<span class="ident" id="8040985">newTestDB</span><span class="op" id="8040994">(</span><span class="ident" id="8040995">t</span><span class="op" id="8040996">,</span>&nbsp;<span class="string" id="8040998">&#34;people&#34;</span><span class="op" id="8041006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041009">defer</span>&nbsp;<span class="ident" id="8041015">closeDB</span><span class="op" id="8041022">(</span><span class="ident" id="8041023">t</span><span class="op" id="8041024">,</span>&nbsp;<span class="ident" id="8041026">db</span><span class="op" id="8041028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041032">ct</span><span class="op" id="8041034">.</span><span class="ident" id="8041035">init</span><span class="op" id="8041039">(</span><span class="ident" id="8041040">t</span><span class="op" id="8041041">,</span>&nbsp;<span class="ident" id="8041043">db</span><span class="op" id="8041045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041048">defer</span>&nbsp;<span class="ident" id="8041054">ct</span><span class="op" id="8041056">.</span><span class="ident" id="8041057">finish</span><span class="op" id="8041063">(</span><span class="ident" id="8041064">t</span><span class="op" id="8041065">)</span><br>
<span class="lineno">1740</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041069">var</span>&nbsp;<span class="ident" id="8041073">wg</span>&nbsp;<span class="ident" id="8041076">sync</span><span class="op" id="8041080">.</span><span class="ident" id="8041081">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041092">wg</span><span class="op" id="8041094">.</span><span class="ident" id="8041095">Add</span><span class="op" id="8041098">(</span><span class="ident" id="8041099">numReqs</span><span class="op" id="8041106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041110">reqs</span>&nbsp;<span class="op" id="8041115">:=</span>&nbsp;<span class="builtinfunc" id="8041118">make</span><span class="op" id="8041122">(</span><span class="keyword" id="8041123">chan</span>&nbsp;<span class="builtintype" id="8041128">bool</span><span class="op" id="8041132">)</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041135">defer</span>&nbsp;<span class="builtinfunc" id="8041141">close</span><span class="op" id="8041146">(</span><span class="ident" id="8041147">reqs</span><span class="op" id="8041151">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041155">for</span>&nbsp;<span class="ident" id="8041159">i</span>&nbsp;<span class="op" id="8041161">:=</span>&nbsp;<span class="num" id="8041164">0</span><span class="op" id="8041165">;</span>&nbsp;<span class="ident" id="8041167">i</span>&nbsp;<span class="op" id="8041169">&lt;</span>&nbsp;<span class="ident" id="8041171">maxProcs</span><span class="op" id="8041179">*</span><span class="num" id="8041180">2</span><span class="op" id="8041181">;</span>&nbsp;<span class="ident" id="8041183">i</span><span class="op" id="8041184">++</span>&nbsp;<span class="op" id="8041187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041191">go</span>&nbsp;<span class="keyword" id="8041194">func</span><span class="op" id="8041198">(</span><span class="op" id="8041199">)</span>&nbsp;<span class="op" id="8041201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041206">for</span>&nbsp;<span class="keyword" id="8041210">range</span>&nbsp;<span class="ident" id="8041216">reqs</span>&nbsp;<span class="op" id="8041221">{</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041227">err</span>&nbsp;<span class="op" id="8041231">:=</span>&nbsp;<span class="ident" id="8041234">ct</span><span class="op" id="8041236">.</span><span class="ident" id="8041237">test</span><span class="op" id="8041241">(</span><span class="ident" id="8041242">t</span><span class="op" id="8041243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041249">if</span>&nbsp;<span class="ident" id="8041252">err</span>&nbsp;<span class="op" id="8041256">!=</span>&nbsp;<span class="ident" id="8041259">nil</span>&nbsp;<span class="op" id="8041263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041270">wg</span><span class="op" id="8041272">.</span><span class="ident" id="8041273">Done</span><span class="op" id="8041277">(</span><span class="op" id="8041278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041285">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041298">}</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041304">wg</span><span class="op" id="8041306">.</span><span class="ident" id="8041307">Done</span><span class="op" id="8041311">(</span><span class="op" id="8041312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041321">}</span><span class="op" id="8041322">(</span><span class="op" id="8041323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041330">for</span>&nbsp;<span class="ident" id="8041334">i</span>&nbsp;<span class="op" id="8041336">:=</span>&nbsp;<span class="num" id="8041339">0</span><span class="op" id="8041340">;</span>&nbsp;<span class="ident" id="8041342">i</span>&nbsp;<span class="op" id="8041344">&lt;</span>&nbsp;<span class="ident" id="8041346">numReqs</span><span class="op" id="8041353">;</span>&nbsp;<span class="ident" id="8041355">i</span><span class="op" id="8041356">++</span>&nbsp;<span class="op" id="8041359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041363">reqs</span>&nbsp;<span class="op" id="8041368">&lt;-</span>&nbsp;<span class="builtintype" id="8041371">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041381">wg</span><span class="op" id="8041383">.</span><span class="ident" id="8041384">Wait</span><span class="op" id="8041388">(</span><span class="op" id="8041389">)</span><br>
<span class="lineno">1765</span><span class="op" id="8041391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8041394">func</span>&nbsp;<span class="ident" id="8041399">manyConcurrentQueries</span><span class="op" id="8041420">(</span><span class="ident" id="8041421">t</span>&nbsp;<span class="ident" id="8041423">testing</span><span class="op" id="8041430">.</span><span class="ident" id="8041431">TB</span><span class="op" id="8041433">)</span>&nbsp;<span class="op" id="8041435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041438">maxProcs</span><span class="op" id="8041446">,</span>&nbsp;<span class="ident" id="8041448">numReqs</span>&nbsp;<span class="op" id="8041456">:=</span>&nbsp;<span class="num" id="8041459">16</span><span class="op" id="8041461">,</span>&nbsp;<span class="num" id="8041463">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041468">if</span>&nbsp;<span class="ident" id="8041471">testing</span><span class="op" id="8041478">.</span><span class="ident" id="8041479">Short</span><span class="op" id="8041484">(</span><span class="op" id="8041485">)</span>&nbsp;<span class="op" id="8041487">{</span><br>
<span class="lineno">1770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041491">maxProcs</span><span class="op" id="8041499">,</span>&nbsp;<span class="ident" id="8041501">numReqs</span>&nbsp;<span class="op" id="8041509">=</span>&nbsp;<span class="num" id="8041511">4</span><span class="op" id="8041512">,</span>&nbsp;<span class="num" id="8041514">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041521">defer</span>&nbsp;<span class="ident" id="8041527">runtime</span><span class="op" id="8041534">.</span><span class="ident" id="8041535">GOMAXPROCS</span><span class="op" id="8041545">(</span><span class="ident" id="8041546">runtime</span><span class="op" id="8041553">.</span><span class="ident" id="8041554">GOMAXPROCS</span><span class="op" id="8041564">(</span><span class="ident" id="8041565">maxProcs</span><span class="op" id="8041573">)</span><span class="op" id="8041574">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041578">db</span>&nbsp;<span class="op" id="8041581">:=</span>&nbsp;<span class="ident" id="8041584">newTestDB</span><span class="op" id="8041593">(</span><span class="ident" id="8041594">t</span><span class="op" id="8041595">,</span>&nbsp;<span class="string" id="8041597">&#34;people&#34;</span><span class="op" id="8041605">)</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041608">defer</span>&nbsp;<span class="ident" id="8041614">closeDB</span><span class="op" id="8041621">(</span><span class="ident" id="8041622">t</span><span class="op" id="8041623">,</span>&nbsp;<span class="ident" id="8041625">db</span><span class="op" id="8041627">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041631">stmt</span><span class="op" id="8041635">,</span>&nbsp;<span class="ident" id="8041637">err</span>&nbsp;<span class="op" id="8041641">:=</span>&nbsp;<span class="ident" id="8041644">db</span><span class="op" id="8041646">.</span><span class="ident" id="8041647">Prepare</span><span class="op" id="8041654">(</span><span class="string" id="8041655">&#34;SELECT|people|name|&#34;</span><span class="op" id="8041676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041679">if</span>&nbsp;<span class="ident" id="8041682">err</span>&nbsp;<span class="op" id="8041686">!=</span>&nbsp;<span class="ident" id="8041689">nil</span>&nbsp;<span class="op" id="8041693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041697">t</span><span class="op" id="8041698">.</span><span class="ident" id="8041699">Fatal</span><span class="op" id="8041704">(</span><span class="ident" id="8041705">err</span><span class="op" id="8041708">)</span><br>
<span class="lineno">1780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8041711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041714">defer</span>&nbsp;<span class="ident" id="8041720">stmt</span><span class="op" id="8041724">.</span><span class="ident" id="8041725">Close</span><span class="op" id="8041730">(</span><span class="op" id="8041731">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041735">var</span>&nbsp;<span class="ident" id="8041739">wg</span>&nbsp;<span class="ident" id="8041742">sync</span><span class="op" id="8041746">.</span><span class="ident" id="8041747">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041758">wg</span><span class="op" id="8041760">.</span><span class="ident" id="8041761">Add</span><span class="op" id="8041764">(</span><span class="ident" id="8041765">numReqs</span><span class="op" id="8041772">)</span><br>
<span class="lineno">1785</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041776">reqs</span>&nbsp;<span class="op" id="8041781">:=</span>&nbsp;<span class="builtinfunc" id="8041784">make</span><span class="op" id="8041788">(</span><span class="keyword" id="8041789">chan</span>&nbsp;<span class="builtintype" id="8041794">bool</span><span class="op" id="8041798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041801">defer</span>&nbsp;<span class="builtinfunc" id="8041807">close</span><span class="op" id="8041812">(</span><span class="ident" id="8041813">reqs</span><span class="op" id="8041817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041821">for</span>&nbsp;<span class="ident" id="8041825">i</span>&nbsp;<span class="op" id="8041827">:=</span>&nbsp;<span class="num" id="8041830">0</span><span class="op" id="8041831">;</span>&nbsp;<span class="ident" id="8041833">i</span>&nbsp;<span class="op" id="8041835">&lt;</span>&nbsp;<span class="ident" id="8041837">maxProcs</span><span class="op" id="8041845">*</span><span class="num" id="8041846">2</span><span class="op" id="8041847">;</span>&nbsp;<span class="ident" id="8041849">i</span><span class="op" id="8041850">++</span>&nbsp;<span class="op" id="8041853">{</span><br>
<span class="lineno">1790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041857">go</span>&nbsp;<span class="keyword" id="8041860">func</span><span class="op" id="8041864">(</span><span class="op" id="8041865">)</span>&nbsp;<span class="op" id="8041867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041872">for</span>&nbsp;<span class="keyword" id="8041876">range</span>&nbsp;<span class="ident" id="8041882">reqs</span>&nbsp;<span class="op" id="8041887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041893">rows</span><span class="op" id="8041897">,</span>&nbsp;<span class="ident" id="8041899">err</span>&nbsp;<span class="op" id="8041903">:=</span>&nbsp;<span class="ident" id="8041906">stmt</span><span class="op" id="8041910">.</span><span class="ident" id="8041911">Query</span><span class="op" id="8041916">(</span><span class="op" id="8041917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8041923">if</span>&nbsp;<span class="ident" id="8041926">err</span>&nbsp;<span class="op" id="8041930">!=</span>&nbsp;<span class="ident" id="8041933">nil</span>&nbsp;<span class="op" id="8041937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041944">t</span><span class="op" id="8041945">.</span><span class="ident" id="8041946">Errorf</span><span class="op" id="8041952">(</span><span class="string" id="8041953">&#34;error&nbsp;on&nbsp;query:&nbsp;&nbsp;%v&#34;</span><span class="op" id="8041974">,</span>&nbsp;<span class="ident" id="8041976">err</span><span class="op" id="8041979">)</span><br>
<span class="lineno">1795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8041986">wg</span><span class="op" id="8041988">.</span><span class="ident" id="8041989">Done</span><span class="op" id="8041993">(</span><span class="op" id="8041994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042001">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042014">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042021">var</span>&nbsp;<span class="ident" id="8042025">name</span>&nbsp;<span class="builtintype" id="8042030">string</span><br>
<span class="lineno">1800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042041">for</span>&nbsp;<span class="ident" id="8042045">rows</span><span class="op" id="8042049">.</span><span class="ident" id="8042050">Next</span><span class="op" id="8042054">(</span><span class="op" id="8042055">)</span>&nbsp;<span class="op" id="8042057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042064">rows</span><span class="op" id="8042068">.</span><span class="ident" id="8042069">Scan</span><span class="op" id="8042073">(</span><span class="op" id="8042074">&amp;</span><span class="ident" id="8042075">name</span><span class="op" id="8042079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042091">rows</span><span class="op" id="8042095">.</span><span class="ident" id="8042096">Close</span><span class="op" id="8042101">(</span><span class="op" id="8042102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042109">wg</span><span class="op" id="8042111">.</span><span class="ident" id="8042112">Done</span><span class="op" id="8042116">(</span><span class="op" id="8042117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042126">}</span><span class="op" id="8042127">(</span><span class="op" id="8042128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042135">for</span>&nbsp;<span class="ident" id="8042139">i</span>&nbsp;<span class="op" id="8042141">:=</span>&nbsp;<span class="num" id="8042144">0</span><span class="op" id="8042145">;</span>&nbsp;<span class="ident" id="8042147">i</span>&nbsp;<span class="op" id="8042149">&lt;</span>&nbsp;<span class="ident" id="8042151">numReqs</span><span class="op" id="8042158">;</span>&nbsp;<span class="ident" id="8042160">i</span><span class="op" id="8042161">++</span>&nbsp;<span class="op" id="8042164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042168">reqs</span>&nbsp;<span class="op" id="8042173">&lt;-</span>&nbsp;<span class="builtintype" id="8042176">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042186">wg</span><span class="op" id="8042188">.</span><span class="ident" id="8042189">Wait</span><span class="op" id="8042193">(</span><span class="op" id="8042194">)</span><br>
<span class="lineno">1815</span><span class="op" id="8042196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8042199">func</span>&nbsp;<span class="ident" id="8042204">TestIssue6081</span><span class="op" id="8042217">(</span><span class="ident" id="8042218">t</span>&nbsp;<span class="op" id="8042220">*</span><span class="ident" id="8042221">testing</span><span class="op" id="8042228">.</span><span class="ident" id="8042229">T</span><span class="op" id="8042230">)</span>&nbsp;<span class="op" id="8042232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042235">db</span>&nbsp;<span class="op" id="8042238">:=</span>&nbsp;<span class="ident" id="8042241">newTestDB</span><span class="op" id="8042250">(</span><span class="ident" id="8042251">t</span><span class="op" id="8042252">,</span>&nbsp;<span class="string" id="8042254">&#34;people&#34;</span><span class="op" id="8042262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042265">defer</span>&nbsp;<span class="ident" id="8042271">closeDB</span><span class="op" id="8042278">(</span><span class="ident" id="8042279">t</span><span class="op" id="8042280">,</span>&nbsp;<span class="ident" id="8042282">db</span><span class="op" id="8042284">)</span><br>
<span class="lineno">1820</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042288">drv</span>&nbsp;<span class="op" id="8042292">:=</span>&nbsp;<span class="ident" id="8042295">db</span><span class="op" id="8042297">.</span><span class="ident" id="8042298">driver</span><span class="op" id="8042304">.</span><span class="op" id="8042305">(</span><span class="op" id="8042306">*</span><span class="ident" id="8042307">fakeDriver</span><span class="op" id="8042317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042320">drv</span><span class="op" id="8042323">.</span><span class="ident" id="8042324">mu</span><span class="op" id="8042326">.</span><span class="ident" id="8042327">Lock</span><span class="op" id="8042331">(</span><span class="op" id="8042332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042335">opens0</span>&nbsp;<span class="op" id="8042342">:=</span>&nbsp;<span class="ident" id="8042345">drv</span><span class="op" id="8042348">.</span><span class="ident" id="8042349">openCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042360">closes0</span>&nbsp;<span class="op" id="8042368">:=</span>&nbsp;<span class="ident" id="8042371">drv</span><span class="op" id="8042374">.</span><span class="ident" id="8042375">closeCount</span><br>
<span class="lineno">1825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042387">drv</span><span class="op" id="8042390">.</span><span class="ident" id="8042391">mu</span><span class="op" id="8042393">.</span><span class="ident" id="8042394">Unlock</span><span class="op" id="8042400">(</span><span class="op" id="8042401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042405">stmt</span><span class="op" id="8042409">,</span>&nbsp;<span class="ident" id="8042411">err</span>&nbsp;<span class="op" id="8042415">:=</span>&nbsp;<span class="ident" id="8042418">db</span><span class="op" id="8042420">.</span><span class="ident" id="8042421">Prepare</span><span class="op" id="8042428">(</span><span class="string" id="8042429">&#34;SELECT|people|name|&#34;</span><span class="op" id="8042450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042453">if</span>&nbsp;<span class="ident" id="8042456">err</span>&nbsp;<span class="op" id="8042460">!=</span>&nbsp;<span class="ident" id="8042463">nil</span>&nbsp;<span class="op" id="8042467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042471">t</span><span class="op" id="8042472">.</span><span class="ident" id="8042473">Fatal</span><span class="op" id="8042478">(</span><span class="ident" id="8042479">err</span><span class="op" id="8042482">)</span><br>
<span class="lineno">1830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042488">rowsCloseHook</span>&nbsp;<span class="op" id="8042502">=</span>&nbsp;<span class="keyword" id="8042504">func</span><span class="op" id="8042508">(</span><span class="ident" id="8042509">rows</span>&nbsp;<span class="op" id="8042514">*</span><span class="ident" id="8042515">Rows</span><span class="op" id="8042519">,</span>&nbsp;<span class="ident" id="8042521">err</span>&nbsp;<span class="op" id="8042525">*</span><span class="builtintype" id="8042526">error</span><span class="op" id="8042531">)</span>&nbsp;<span class="op" id="8042533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042537">*</span><span class="ident" id="8042538">err</span>&nbsp;<span class="op" id="8042542">=</span>&nbsp;<span class="ident" id="8042544">driver</span><span class="op" id="8042550">.</span><span class="ident" id="8042551">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042566">defer</span>&nbsp;<span class="keyword" id="8042572">func</span><span class="op" id="8042576">(</span><span class="op" id="8042577">)</span>&nbsp;<span class="op" id="8042579">{</span>&nbsp;<span class="ident" id="8042581">rowsCloseHook</span>&nbsp;<span class="op" id="8042595">=</span>&nbsp;<span class="ident" id="8042597">nil</span>&nbsp;<span class="op" id="8042601">}</span><span class="op" id="8042602">(</span><span class="op" id="8042603">)</span><br>
<span class="lineno">1835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042606">for</span>&nbsp;<span class="ident" id="8042610">i</span>&nbsp;<span class="op" id="8042612">:=</span>&nbsp;<span class="num" id="8042615">0</span><span class="op" id="8042616">;</span>&nbsp;<span class="ident" id="8042618">i</span>&nbsp;<span class="op" id="8042620">&lt;</span>&nbsp;<span class="num" id="8042622">10</span><span class="op" id="8042624">;</span>&nbsp;<span class="ident" id="8042626">i</span><span class="op" id="8042627">++</span>&nbsp;<span class="op" id="8042630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042634">rows</span><span class="op" id="8042638">,</span>&nbsp;<span class="ident" id="8042640">err</span>&nbsp;<span class="op" id="8042644">:=</span>&nbsp;<span class="ident" id="8042647">stmt</span><span class="op" id="8042651">.</span><span class="ident" id="8042652">Query</span><span class="op" id="8042657">(</span><span class="op" id="8042658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042662">if</span>&nbsp;<span class="ident" id="8042665">err</span>&nbsp;<span class="op" id="8042669">!=</span>&nbsp;<span class="ident" id="8042672">nil</span>&nbsp;<span class="op" id="8042676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042681">t</span><span class="op" id="8042682">.</span><span class="ident" id="8042683">Fatal</span><span class="op" id="8042688">(</span><span class="ident" id="8042689">err</span><span class="op" id="8042692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042696">}</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042700">rows</span><span class="op" id="8042704">.</span><span class="ident" id="8042705">Close</span><span class="op" id="8042710">(</span><span class="op" id="8042711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042717">if</span>&nbsp;<span class="ident" id="8042720">n</span>&nbsp;<span class="op" id="8042722">:=</span>&nbsp;<span class="builtinfunc" id="8042725">len</span><span class="op" id="8042728">(</span><span class="ident" id="8042729">stmt</span><span class="op" id="8042733">.</span><span class="ident" id="8042734">css</span><span class="op" id="8042737">)</span><span class="op" id="8042738">;</span>&nbsp;<span class="ident" id="8042740">n</span>&nbsp;<span class="op" id="8042742">&gt;</span>&nbsp;<span class="num" id="8042744">1</span>&nbsp;<span class="op" id="8042746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042750">t</span><span class="op" id="8042751">.</span><span class="ident" id="8042752">Errorf</span><span class="op" id="8042758">(</span><span class="string" id="8042759">&#34;len(css&nbsp;slice)&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;=&nbsp;1&#34;</span><span class="op" id="8042791">,</span>&nbsp;<span class="ident" id="8042793">n</span><span class="op" id="8042794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042797">}</span><br>
<span class="lineno">1845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042800">stmt</span><span class="op" id="8042804">.</span><span class="ident" id="8042805">Close</span><span class="op" id="8042810">(</span><span class="op" id="8042811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8042814">if</span>&nbsp;<span class="ident" id="8042817">n</span>&nbsp;<span class="op" id="8042819">:=</span>&nbsp;<span class="builtinfunc" id="8042822">len</span><span class="op" id="8042825">(</span><span class="ident" id="8042826">stmt</span><span class="op" id="8042830">.</span><span class="ident" id="8042831">css</span><span class="op" id="8042834">)</span><span class="op" id="8042835">;</span>&nbsp;<span class="ident" id="8042837">n</span>&nbsp;<span class="op" id="8042839">!=</span>&nbsp;<span class="num" id="8042842">0</span>&nbsp;<span class="op" id="8042844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042848">t</span><span class="op" id="8042849">.</span><span class="ident" id="8042850">Errorf</span><span class="op" id="8042856">(</span><span class="string" id="8042857">&#34;len(css&nbsp;slice)&nbsp;after&nbsp;Close&nbsp;=&nbsp;%d;&nbsp;want&nbsp;0&#34;</span><span class="op" id="8042898">,</span>&nbsp;<span class="ident" id="8042900">n</span><span class="op" id="8042901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8042904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1850</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042908">drv</span><span class="op" id="8042911">.</span><span class="ident" id="8042912">mu</span><span class="op" id="8042914">.</span><span class="ident" id="8042915">Lock</span><span class="op" id="8042919">(</span><span class="op" id="8042920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042923">opens</span>&nbsp;<span class="op" id="8042929">:=</span>&nbsp;<span class="ident" id="8042932">drv</span><span class="op" id="8042935">.</span><span class="ident" id="8042936">openCount</span>&nbsp;<span class="op" id="8042946">-</span>&nbsp;<span class="ident" id="8042948">opens0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042956">closes</span>&nbsp;<span class="op" id="8042963">:=</span>&nbsp;<span class="ident" id="8042966">drv</span><span class="op" id="8042969">.</span><span class="ident" id="8042970">closeCount</span>&nbsp;<span class="op" id="8042981">-</span>&nbsp;<span class="ident" id="8042983">closes0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8042992">drv</span><span class="op" id="8042995">.</span><span class="ident" id="8042996">mu</span><span class="op" id="8042998">.</span><span class="ident" id="8042999">Unlock</span><span class="op" id="8043005">(</span><span class="op" id="8043006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8043009">if</span>&nbsp;<span class="ident" id="8043012">opens</span>&nbsp;<span class="op" id="8043018">&lt;</span>&nbsp;<span class="num" id="8043020">9</span>&nbsp;<span class="op" id="8043022">{</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043026">t</span><span class="op" id="8043027">.</span><span class="ident" id="8043028">Errorf</span><span class="op" id="8043034">(</span><span class="string" id="8043035">&#34;opens&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8043058">,</span>&nbsp;<span class="ident" id="8043060">opens</span><span class="op" id="8043065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8043068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8043071">if</span>&nbsp;<span class="ident" id="8043074">closes</span>&nbsp;<span class="op" id="8043081">&lt;</span>&nbsp;<span class="num" id="8043083">9</span>&nbsp;<span class="op" id="8043085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043089">t</span><span class="op" id="8043090">.</span><span class="ident" id="8043091">Errorf</span><span class="op" id="8043097">(</span><span class="string" id="8043098">&#34;closes&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&gt;=&nbsp;9&#34;</span><span class="op" id="8043122">,</span>&nbsp;<span class="ident" id="8043124">closes</span><span class="op" id="8043130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8043133">}</span><br>
<span class="lineno">1860</span><span class="op" id="8043135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8043138">func</span>&nbsp;<span class="ident" id="8043143">TestConcurrency</span><span class="op" id="8043158">(</span><span class="ident" id="8043159">t</span>&nbsp;<span class="op" id="8043161">*</span><span class="ident" id="8043162">testing</span><span class="op" id="8043169">.</span><span class="ident" id="8043170">T</span><span class="op" id="8043171">)</span>&nbsp;<span class="op" id="8043173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043176">doConcurrentTest</span><span class="op" id="8043192">(</span><span class="ident" id="8043193">t</span><span class="op" id="8043194">,</span>&nbsp;<span class="builtinfunc" id="8043196">new</span><span class="op" id="8043199">(</span><span class="ident" id="8043200">concurrentDBQueryTest</span><span class="op" id="8043221">)</span><span class="op" id="8043222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043225">doConcurrentTest</span><span class="op" id="8043241">(</span><span class="ident" id="8043242">t</span><span class="op" id="8043243">,</span>&nbsp;<span class="builtinfunc" id="8043245">new</span><span class="op" id="8043248">(</span><span class="ident" id="8043249">concurrentDBExecTest</span><span class="op" id="8043269">)</span><span class="op" id="8043270">)</span><br>
<span class="lineno">1865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043273">doConcurrentTest</span><span class="op" id="8043289">(</span><span class="ident" id="8043290">t</span><span class="op" id="8043291">,</span>&nbsp;<span class="builtinfunc" id="8043293">new</span><span class="op" id="8043296">(</span><span class="ident" id="8043297">concurrentStmtQueryTest</span><span class="op" id="8043320">)</span><span class="op" id="8043321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043324">doConcurrentTest</span><span class="op" id="8043340">(</span><span class="ident" id="8043341">t</span><span class="op" id="8043342">,</span>&nbsp;<span class="builtinfunc" id="8043344">new</span><span class="op" id="8043347">(</span><span class="ident" id="8043348">concurrentStmtExecTest</span><span class="op" id="8043370">)</span><span class="op" id="8043371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043374">doConcurrentTest</span><span class="op" id="8043390">(</span><span class="ident" id="8043391">t</span><span class="op" id="8043392">,</span>&nbsp;<span class="builtinfunc" id="8043394">new</span><span class="op" id="8043397">(</span><span class="ident" id="8043398">concurrentTxQueryTest</span><span class="op" id="8043419">)</span><span class="op" id="8043420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043423">doConcurrentTest</span><span class="op" id="8043439">(</span><span class="ident" id="8043440">t</span><span class="op" id="8043441">,</span>&nbsp;<span class="builtinfunc" id="8043443">new</span><span class="op" id="8043446">(</span><span class="ident" id="8043447">concurrentTxExecTest</span><span class="op" id="8043467">)</span><span class="op" id="8043468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043471">doConcurrentTest</span><span class="op" id="8043487">(</span><span class="ident" id="8043488">t</span><span class="op" id="8043489">,</span>&nbsp;<span class="builtinfunc" id="8043491">new</span><span class="op" id="8043494">(</span><span class="ident" id="8043495">concurrentTxStmtQueryTest</span><span class="op" id="8043520">)</span><span class="op" id="8043521">)</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043524">doConcurrentTest</span><span class="op" id="8043540">(</span><span class="ident" id="8043541">t</span><span class="op" id="8043542">,</span>&nbsp;<span class="builtinfunc" id="8043544">new</span><span class="op" id="8043547">(</span><span class="ident" id="8043548">concurrentTxStmtExecTest</span><span class="op" id="8043572">)</span><span class="op" id="8043573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043576">doConcurrentTest</span><span class="op" id="8043592">(</span><span class="ident" id="8043593">t</span><span class="op" id="8043594">,</span>&nbsp;<span class="builtinfunc" id="8043596">new</span><span class="op" id="8043599">(</span><span class="ident" id="8043600">concurrentRandomTest</span><span class="op" id="8043620">)</span><span class="op" id="8043621">)</span><br>
<span class="lineno"></span><span class="op" id="8043623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8043626">func</span>&nbsp;<span class="ident" id="8043631">TestConnectionLeak</span><span class="op" id="8043649">(</span><span class="ident" id="8043650">t</span>&nbsp;<span class="op" id="8043652">*</span><span class="ident" id="8043653">testing</span><span class="op" id="8043660">.</span><span class="ident" id="8043661">T</span><span class="op" id="8043662">)</span>&nbsp;<span class="op" id="8043664">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043667">db</span>&nbsp;<span class="op" id="8043670">:=</span>&nbsp;<span class="ident" id="8043673">newTestDB</span><span class="op" id="8043682">(</span><span class="ident" id="8043683">t</span><span class="op" id="8043684">,</span>&nbsp;<span class="string" id="8043686">&#34;people&#34;</span><span class="op" id="8043694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8043697">defer</span>&nbsp;<span class="ident" id="8043703">closeDB</span><span class="op" id="8043710">(</span><span class="ident" id="8043711">t</span><span class="op" id="8043712">,</span>&nbsp;<span class="ident" id="8043714">db</span><span class="op" id="8043716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8043719">//&nbsp;Start&nbsp;by&nbsp;opening&nbsp;defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043760">rows</span>&nbsp;<span class="op" id="8043765">:=</span>&nbsp;<span class="builtinfunc" id="8043768">make</span><span class="op" id="8043772">(</span><span class="op" id="8043773">[</span><span class="op" id="8043774">]</span><span class="op" id="8043775">*</span><span class="ident" id="8043776">Rows</span><span class="op" id="8043780">,</span>&nbsp;<span class="ident" id="8043782">defaultMaxIdleConns</span><span class="op" id="8043801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8043804">//&nbsp;We&nbsp;need&nbsp;to&nbsp;SetMaxOpenConns&nbsp;&gt;&nbsp;MaxIdleConns,&nbsp;so&nbsp;the&nbsp;DB&nbsp;can&nbsp;open</span><br>
<span class="lineno">1880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8043870">//&nbsp;a&nbsp;new&nbsp;connection&nbsp;and&nbsp;we&nbsp;can&nbsp;fill&nbsp;the&nbsp;idle&nbsp;queue&nbsp;with&nbsp;the&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8043940">//&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8043957">db</span><span class="op" id="8043959">.</span><span class="ident" id="8043960">SetMaxOpenConns</span><span class="op" id="8043975">(</span><span class="builtinfunc" id="8043976">len</span><span class="op" id="8043979">(</span><span class="ident" id="8043980">rows</span><span class="op" id="8043984">)</span>&nbsp;<span class="op" id="8043986">+</span>&nbsp;<span class="num" id="8043988">1</span><span class="op" id="8043989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8043992">for</span>&nbsp;<span class="ident" id="8043996">ii</span>&nbsp;<span class="op" id="8043999">:=</span>&nbsp;<span class="keyword" id="8044002">range</span>&nbsp;<span class="ident" id="8044008">rows</span>&nbsp;<span class="op" id="8044013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044017">r</span><span class="op" id="8044018">,</span>&nbsp;<span class="ident" id="8044020">err</span>&nbsp;<span class="op" id="8044024">:=</span>&nbsp;<span class="ident" id="8044027">db</span><span class="op" id="8044029">.</span><span class="ident" id="8044030">Query</span><span class="op" id="8044035">(</span><span class="string" id="8044036">&#34;SELECT|people|name|&#34;</span><span class="op" id="8044057">)</span><br>
<span class="lineno">1885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044061">if</span>&nbsp;<span class="ident" id="8044064">err</span>&nbsp;<span class="op" id="8044068">!=</span>&nbsp;<span class="ident" id="8044071">nil</span>&nbsp;<span class="op" id="8044075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044080">t</span><span class="op" id="8044081">.</span><span class="ident" id="8044082">Fatal</span><span class="op" id="8044087">(</span><span class="ident" id="8044088">err</span><span class="op" id="8044091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044099">r</span><span class="op" id="8044100">.</span><span class="ident" id="8044101">Next</span><span class="op" id="8044105">(</span><span class="op" id="8044106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044110">if</span>&nbsp;<span class="ident" id="8044113">err</span>&nbsp;<span class="op" id="8044117">:=</span>&nbsp;<span class="ident" id="8044120">r</span><span class="op" id="8044121">.</span><span class="ident" id="8044122">Err</span><span class="op" id="8044125">(</span><span class="op" id="8044126">)</span><span class="op" id="8044127">;</span>&nbsp;<span class="ident" id="8044129">err</span>&nbsp;<span class="op" id="8044133">!=</span>&nbsp;<span class="ident" id="8044136">nil</span>&nbsp;<span class="op" id="8044140">{</span><br>
<span class="lineno">1890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044145">t</span><span class="op" id="8044146">.</span><span class="ident" id="8044147">Fatal</span><span class="op" id="8044152">(</span><span class="ident" id="8044153">err</span><span class="op" id="8044156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044164">rows</span><span class="op" id="8044168">[</span><span class="ident" id="8044169">ii</span><span class="op" id="8044171">]</span>&nbsp;<span class="op" id="8044173">=</span>&nbsp;<span class="ident" id="8044175">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044181">//&nbsp;Now&nbsp;we&nbsp;have&nbsp;defaultMaxIdleConns&nbsp;busy&nbsp;connections.&nbsp;Open</span><br>
<span class="lineno">1895</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044240">//&nbsp;a&nbsp;new&nbsp;one,&nbsp;but&nbsp;wait&nbsp;until&nbsp;the&nbsp;busy&nbsp;connections&nbsp;are&nbsp;released</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044304">//&nbsp;before&nbsp;returning&nbsp;control&nbsp;to&nbsp;DB.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044340">drv</span>&nbsp;<span class="op" id="8044344">:=</span>&nbsp;<span class="ident" id="8044347">db</span><span class="op" id="8044349">.</span><span class="ident" id="8044350">driver</span><span class="op" id="8044356">.</span><span class="op" id="8044357">(</span><span class="op" id="8044358">*</span><span class="ident" id="8044359">fakeDriver</span><span class="op" id="8044369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044372">drv</span><span class="op" id="8044375">.</span><span class="ident" id="8044376">waitCh</span>&nbsp;<span class="op" id="8044383">=</span>&nbsp;<span class="builtinfunc" id="8044385">make</span><span class="op" id="8044389">(</span><span class="keyword" id="8044390">chan</span>&nbsp;<span class="keyword" id="8044395">struct</span><span class="op" id="8044401">{</span><span class="op" id="8044402">}</span><span class="op" id="8044403">,</span>&nbsp;<span class="num" id="8044405">1</span><span class="op" id="8044406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044409">drv</span><span class="op" id="8044412">.</span><span class="ident" id="8044413">waitingCh</span>&nbsp;<span class="op" id="8044423">=</span>&nbsp;<span class="builtinfunc" id="8044425">make</span><span class="op" id="8044429">(</span><span class="keyword" id="8044430">chan</span>&nbsp;<span class="keyword" id="8044435">struct</span><span class="op" id="8044441">{</span><span class="op" id="8044442">}</span><span class="op" id="8044443">,</span>&nbsp;<span class="num" id="8044445">1</span><span class="op" id="8044446">)</span><br>
<span class="lineno">1900</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044449">var</span>&nbsp;<span class="ident" id="8044453">wg</span>&nbsp;<span class="ident" id="8044456">sync</span><span class="op" id="8044460">.</span><span class="ident" id="8044461">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044472">wg</span><span class="op" id="8044474">.</span><span class="ident" id="8044475">Add</span><span class="op" id="8044478">(</span><span class="num" id="8044479">1</span><span class="op" id="8044480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044483">go</span>&nbsp;<span class="keyword" id="8044486">func</span><span class="op" id="8044490">(</span><span class="op" id="8044491">)</span>&nbsp;<span class="op" id="8044493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044497">r</span><span class="op" id="8044498">,</span>&nbsp;<span class="ident" id="8044500">err</span>&nbsp;<span class="op" id="8044504">:=</span>&nbsp;<span class="ident" id="8044507">db</span><span class="op" id="8044509">.</span><span class="ident" id="8044510">Query</span><span class="op" id="8044515">(</span><span class="string" id="8044516">&#34;SELECT|people|name|&#34;</span><span class="op" id="8044537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044541">if</span>&nbsp;<span class="ident" id="8044544">err</span>&nbsp;<span class="op" id="8044548">!=</span>&nbsp;<span class="ident" id="8044551">nil</span>&nbsp;<span class="op" id="8044555">{</span><br>
<span class="lineno">1905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044560">t</span><span class="op" id="8044561">.</span><span class="ident" id="8044562">Fatal</span><span class="op" id="8044567">(</span><span class="ident" id="8044568">err</span><span class="op" id="8044571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044579">r</span><span class="op" id="8044580">.</span><span class="ident" id="8044581">Close</span><span class="op" id="8044586">(</span><span class="op" id="8044587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044591">wg</span><span class="op" id="8044593">.</span><span class="ident" id="8044594">Done</span><span class="op" id="8044598">(</span><span class="op" id="8044599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044602">}</span><span class="op" id="8044603">(</span><span class="op" id="8044604">)</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044607">//&nbsp;Wait&nbsp;until&nbsp;the&nbsp;goroutine&nbsp;we&#39;ve&nbsp;just&nbsp;created&nbsp;has&nbsp;started&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044676">&lt;-</span><span class="ident" id="8044678">drv</span><span class="op" id="8044681">.</span><span class="ident" id="8044682">waitingCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044693">//&nbsp;Now&nbsp;close&nbsp;the&nbsp;busy&nbsp;connections.&nbsp;This&nbsp;provides&nbsp;a&nbsp;connection&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044760">//&nbsp;the&nbsp;blocked&nbsp;goroutine&nbsp;and&nbsp;then&nbsp;fills&nbsp;up&nbsp;the&nbsp;idle&nbsp;queue.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8044820">for</span>&nbsp;<span class="ident" id="8044824">_</span><span class="op" id="8044825">,</span>&nbsp;<span class="ident" id="8044827">v</span>&nbsp;<span class="op" id="8044829">:=</span>&nbsp;<span class="keyword" id="8044832">range</span>&nbsp;<span class="ident" id="8044838">rows</span>&nbsp;<span class="op" id="8044843">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8044847">v</span><span class="op" id="8044848">.</span><span class="ident" id="8044849">Close</span><span class="op" id="8044854">(</span><span class="op" id="8044855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8044858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044861">//&nbsp;At&nbsp;this&nbsp;point&nbsp;we&nbsp;give&nbsp;the&nbsp;new&nbsp;connection&nbsp;to&nbsp;DB.&nbsp;This&nbsp;connection&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8044932">//&nbsp;now&nbsp;useless,&nbsp;since&nbsp;the&nbsp;idle&nbsp;queue&nbsp;is&nbsp;full&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8045003">//&nbsp;requests.&nbsp;DB&nbsp;should&nbsp;deal&nbsp;with&nbsp;this&nbsp;situation&nbsp;without&nbsp;leaking&nbsp;the</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8045072">//&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045088">drv</span><span class="op" id="8045091">.</span><span class="ident" id="8045092">waitCh</span>&nbsp;<span class="op" id="8045099">&lt;-</span>&nbsp;<span class="keyword" id="8045102">struct</span><span class="op" id="8045108">{</span><span class="op" id="8045109">}</span><span class="op" id="8045110">{</span><span class="op" id="8045111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045114">wg</span><span class="op" id="8045116">.</span><span class="ident" id="8045117">Wait</span><span class="op" id="8045121">(</span><span class="op" id="8045122">)</span><br>
<span class="lineno"></span><span class="op" id="8045124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1925</span><span class="keyword" id="8045127">func</span>&nbsp;<span class="ident" id="8045132">BenchmarkConcurrentDBExec</span><span class="op" id="8045157">(</span><span class="ident" id="8045158">b</span>&nbsp;<span class="op" id="8045160">*</span><span class="ident" id="8045161">testing</span><span class="op" id="8045168">.</span><span class="ident" id="8045169">B</span><span class="op" id="8045170">)</span>&nbsp;<span class="op" id="8045172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045175">b</span><span class="op" id="8045176">.</span><span class="ident" id="8045177">ReportAllocs</span><span class="op" id="8045189">(</span><span class="op" id="8045190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045193">ct</span>&nbsp;<span class="op" id="8045196">:=</span>&nbsp;<span class="builtinfunc" id="8045199">new</span><span class="op" id="8045202">(</span><span class="ident" id="8045203">concurrentDBExecTest</span><span class="op" id="8045223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045226">for</span>&nbsp;<span class="ident" id="8045230">i</span>&nbsp;<span class="op" id="8045232">:=</span>&nbsp;<span class="num" id="8045235">0</span><span class="op" id="8045236">;</span>&nbsp;<span class="ident" id="8045238">i</span>&nbsp;<span class="op" id="8045240">&lt;</span>&nbsp;<span class="ident" id="8045242">b</span><span class="op" id="8045243">.</span><span class="ident" id="8045244">N</span><span class="op" id="8045245">;</span>&nbsp;<span class="ident" id="8045247">i</span><span class="op" id="8045248">++</span>&nbsp;<span class="op" id="8045251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045255">doConcurrentTest</span><span class="op" id="8045271">(</span><span class="ident" id="8045272">b</span><span class="op" id="8045273">,</span>&nbsp;<span class="ident" id="8045275">ct</span><span class="op" id="8045277">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045280">}</span><br>
<span class="lineno"></span><span class="op" id="8045282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8045285">func</span>&nbsp;<span class="ident" id="8045290">BenchmarkConcurrentStmtQuery</span><span class="op" id="8045318">(</span><span class="ident" id="8045319">b</span>&nbsp;<span class="op" id="8045321">*</span><span class="ident" id="8045322">testing</span><span class="op" id="8045329">.</span><span class="ident" id="8045330">B</span><span class="op" id="8045331">)</span>&nbsp;<span class="op" id="8045333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045336">b</span><span class="op" id="8045337">.</span><span class="ident" id="8045338">ReportAllocs</span><span class="op" id="8045350">(</span><span class="op" id="8045351">)</span><br>
<span class="lineno">1935</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045354">ct</span>&nbsp;<span class="op" id="8045357">:=</span>&nbsp;<span class="builtinfunc" id="8045360">new</span><span class="op" id="8045363">(</span><span class="ident" id="8045364">concurrentStmtQueryTest</span><span class="op" id="8045387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045390">for</span>&nbsp;<span class="ident" id="8045394">i</span>&nbsp;<span class="op" id="8045396">:=</span>&nbsp;<span class="num" id="8045399">0</span><span class="op" id="8045400">;</span>&nbsp;<span class="ident" id="8045402">i</span>&nbsp;<span class="op" id="8045404">&lt;</span>&nbsp;<span class="ident" id="8045406">b</span><span class="op" id="8045407">.</span><span class="ident" id="8045408">N</span><span class="op" id="8045409">;</span>&nbsp;<span class="ident" id="8045411">i</span><span class="op" id="8045412">++</span>&nbsp;<span class="op" id="8045415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045419">doConcurrentTest</span><span class="op" id="8045435">(</span><span class="ident" id="8045436">b</span><span class="op" id="8045437">,</span>&nbsp;<span class="ident" id="8045439">ct</span><span class="op" id="8045441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045444">}</span><br>
<span class="lineno"></span><span class="op" id="8045446">}</span><br>
<span class="lineno">1940</span><br>
<span class="lineno"></span><span class="keyword" id="8045449">func</span>&nbsp;<span class="ident" id="8045454">BenchmarkConcurrentStmtExec</span><span class="op" id="8045481">(</span><span class="ident" id="8045482">b</span>&nbsp;<span class="op" id="8045484">*</span><span class="ident" id="8045485">testing</span><span class="op" id="8045492">.</span><span class="ident" id="8045493">B</span><span class="op" id="8045494">)</span>&nbsp;<span class="op" id="8045496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045499">b</span><span class="op" id="8045500">.</span><span class="ident" id="8045501">ReportAllocs</span><span class="op" id="8045513">(</span><span class="op" id="8045514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045517">ct</span>&nbsp;<span class="op" id="8045520">:=</span>&nbsp;<span class="builtinfunc" id="8045523">new</span><span class="op" id="8045526">(</span><span class="ident" id="8045527">concurrentStmtExecTest</span><span class="op" id="8045549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045552">for</span>&nbsp;<span class="ident" id="8045556">i</span>&nbsp;<span class="op" id="8045558">:=</span>&nbsp;<span class="num" id="8045561">0</span><span class="op" id="8045562">;</span>&nbsp;<span class="ident" id="8045564">i</span>&nbsp;<span class="op" id="8045566">&lt;</span>&nbsp;<span class="ident" id="8045568">b</span><span class="op" id="8045569">.</span><span class="ident" id="8045570">N</span><span class="op" id="8045571">;</span>&nbsp;<span class="ident" id="8045573">i</span><span class="op" id="8045574">++</span>&nbsp;<span class="op" id="8045577">{</span><br>
<span class="lineno">1945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045581">doConcurrentTest</span><span class="op" id="8045597">(</span><span class="ident" id="8045598">b</span><span class="op" id="8045599">,</span>&nbsp;<span class="ident" id="8045601">ct</span><span class="op" id="8045603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045606">}</span><br>
<span class="lineno"></span><span class="op" id="8045608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8045611">func</span>&nbsp;<span class="ident" id="8045616">BenchmarkConcurrentTxQuery</span><span class="op" id="8045642">(</span><span class="ident" id="8045643">b</span>&nbsp;<span class="op" id="8045645">*</span><span class="ident" id="8045646">testing</span><span class="op" id="8045653">.</span><span class="ident" id="8045654">B</span><span class="op" id="8045655">)</span>&nbsp;<span class="op" id="8045657">{</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045660">b</span><span class="op" id="8045661">.</span><span class="ident" id="8045662">ReportAllocs</span><span class="op" id="8045674">(</span><span class="op" id="8045675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045678">ct</span>&nbsp;<span class="op" id="8045681">:=</span>&nbsp;<span class="builtinfunc" id="8045684">new</span><span class="op" id="8045687">(</span><span class="ident" id="8045688">concurrentTxQueryTest</span><span class="op" id="8045709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045712">for</span>&nbsp;<span class="ident" id="8045716">i</span>&nbsp;<span class="op" id="8045718">:=</span>&nbsp;<span class="num" id="8045721">0</span><span class="op" id="8045722">;</span>&nbsp;<span class="ident" id="8045724">i</span>&nbsp;<span class="op" id="8045726">&lt;</span>&nbsp;<span class="ident" id="8045728">b</span><span class="op" id="8045729">.</span><span class="ident" id="8045730">N</span><span class="op" id="8045731">;</span>&nbsp;<span class="ident" id="8045733">i</span><span class="op" id="8045734">++</span>&nbsp;<span class="op" id="8045737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045741">doConcurrentTest</span><span class="op" id="8045757">(</span><span class="ident" id="8045758">b</span><span class="op" id="8045759">,</span>&nbsp;<span class="ident" id="8045761">ct</span><span class="op" id="8045763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045766">}</span><br>
<span class="lineno">1955</span><span class="op" id="8045768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8045771">func</span>&nbsp;<span class="ident" id="8045776">BenchmarkConcurrentTxExec</span><span class="op" id="8045801">(</span><span class="ident" id="8045802">b</span>&nbsp;<span class="op" id="8045804">*</span><span class="ident" id="8045805">testing</span><span class="op" id="8045812">.</span><span class="ident" id="8045813">B</span><span class="op" id="8045814">)</span>&nbsp;<span class="op" id="8045816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045819">b</span><span class="op" id="8045820">.</span><span class="ident" id="8045821">ReportAllocs</span><span class="op" id="8045833">(</span><span class="op" id="8045834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045837">ct</span>&nbsp;<span class="op" id="8045840">:=</span>&nbsp;<span class="builtinfunc" id="8045843">new</span><span class="op" id="8045846">(</span><span class="ident" id="8045847">concurrentTxExecTest</span><span class="op" id="8045867">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8045870">for</span>&nbsp;<span class="ident" id="8045874">i</span>&nbsp;<span class="op" id="8045876">:=</span>&nbsp;<span class="num" id="8045879">0</span><span class="op" id="8045880">;</span>&nbsp;<span class="ident" id="8045882">i</span>&nbsp;<span class="op" id="8045884">&lt;</span>&nbsp;<span class="ident" id="8045886">b</span><span class="op" id="8045887">.</span><span class="ident" id="8045888">N</span><span class="op" id="8045889">;</span>&nbsp;<span class="ident" id="8045891">i</span><span class="op" id="8045892">++</span>&nbsp;<span class="op" id="8045895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045899">doConcurrentTest</span><span class="op" id="8045915">(</span><span class="ident" id="8045916">b</span><span class="op" id="8045917">,</span>&nbsp;<span class="ident" id="8045919">ct</span><span class="op" id="8045921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8045924">}</span><br>
<span class="lineno"></span><span class="op" id="8045926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1965</span><span class="keyword" id="8045929">func</span>&nbsp;<span class="ident" id="8045934">BenchmarkConcurrentTxStmtQuery</span><span class="op" id="8045964">(</span><span class="ident" id="8045965">b</span>&nbsp;<span class="op" id="8045967">*</span><span class="ident" id="8045968">testing</span><span class="op" id="8045975">.</span><span class="ident" id="8045976">B</span><span class="op" id="8045977">)</span>&nbsp;<span class="op" id="8045979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8045982">b</span><span class="op" id="8045983">.</span><span class="ident" id="8045984">ReportAllocs</span><span class="op" id="8045996">(</span><span class="op" id="8045997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046000">ct</span>&nbsp;<span class="op" id="8046003">:=</span>&nbsp;<span class="builtinfunc" id="8046006">new</span><span class="op" id="8046009">(</span><span class="ident" id="8046010">concurrentTxStmtQueryTest</span><span class="op" id="8046035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046038">for</span>&nbsp;<span class="ident" id="8046042">i</span>&nbsp;<span class="op" id="8046044">:=</span>&nbsp;<span class="num" id="8046047">0</span><span class="op" id="8046048">;</span>&nbsp;<span class="ident" id="8046050">i</span>&nbsp;<span class="op" id="8046052">&lt;</span>&nbsp;<span class="ident" id="8046054">b</span><span class="op" id="8046055">.</span><span class="ident" id="8046056">N</span><span class="op" id="8046057">;</span>&nbsp;<span class="ident" id="8046059">i</span><span class="op" id="8046060">++</span>&nbsp;<span class="op" id="8046063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046067">doConcurrentTest</span><span class="op" id="8046083">(</span><span class="ident" id="8046084">b</span><span class="op" id="8046085">,</span>&nbsp;<span class="ident" id="8046087">ct</span><span class="op" id="8046089">)</span><br>
<span class="lineno">1970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046092">}</span><br>
<span class="lineno"></span><span class="op" id="8046094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8046097">func</span>&nbsp;<span class="ident" id="8046102">BenchmarkConcurrentTxStmtExec</span><span class="op" id="8046131">(</span><span class="ident" id="8046132">b</span>&nbsp;<span class="op" id="8046134">*</span><span class="ident" id="8046135">testing</span><span class="op" id="8046142">.</span><span class="ident" id="8046143">B</span><span class="op" id="8046144">)</span>&nbsp;<span class="op" id="8046146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046149">b</span><span class="op" id="8046150">.</span><span class="ident" id="8046151">ReportAllocs</span><span class="op" id="8046163">(</span><span class="op" id="8046164">)</span><br>
<span class="lineno">1975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046167">ct</span>&nbsp;<span class="op" id="8046170">:=</span>&nbsp;<span class="builtinfunc" id="8046173">new</span><span class="op" id="8046176">(</span><span class="ident" id="8046177">concurrentTxStmtExecTest</span><span class="op" id="8046201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046204">for</span>&nbsp;<span class="ident" id="8046208">i</span>&nbsp;<span class="op" id="8046210">:=</span>&nbsp;<span class="num" id="8046213">0</span><span class="op" id="8046214">;</span>&nbsp;<span class="ident" id="8046216">i</span>&nbsp;<span class="op" id="8046218">&lt;</span>&nbsp;<span class="ident" id="8046220">b</span><span class="op" id="8046221">.</span><span class="ident" id="8046222">N</span><span class="op" id="8046223">;</span>&nbsp;<span class="ident" id="8046225">i</span><span class="op" id="8046226">++</span>&nbsp;<span class="op" id="8046229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046233">doConcurrentTest</span><span class="op" id="8046249">(</span><span class="ident" id="8046250">b</span><span class="op" id="8046251">,</span>&nbsp;<span class="ident" id="8046253">ct</span><span class="op" id="8046255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046258">}</span><br>
<span class="lineno"></span><span class="op" id="8046260">}</span><br>
<span class="lineno">1980</span><br>
<span class="lineno"></span><span class="keyword" id="8046263">func</span>&nbsp;<span class="ident" id="8046268">BenchmarkConcurrentRandom</span><span class="op" id="8046293">(</span><span class="ident" id="8046294">b</span>&nbsp;<span class="op" id="8046296">*</span><span class="ident" id="8046297">testing</span><span class="op" id="8046304">.</span><span class="ident" id="8046305">B</span><span class="op" id="8046306">)</span>&nbsp;<span class="op" id="8046308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046311">b</span><span class="op" id="8046312">.</span><span class="ident" id="8046313">ReportAllocs</span><span class="op" id="8046325">(</span><span class="op" id="8046326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046329">ct</span>&nbsp;<span class="op" id="8046332">:=</span>&nbsp;<span class="builtinfunc" id="8046335">new</span><span class="op" id="8046338">(</span><span class="ident" id="8046339">concurrentRandomTest</span><span class="op" id="8046359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8046362">for</span>&nbsp;<span class="ident" id="8046366">i</span>&nbsp;<span class="op" id="8046368">:=</span>&nbsp;<span class="num" id="8046371">0</span><span class="op" id="8046372">;</span>&nbsp;<span class="ident" id="8046374">i</span>&nbsp;<span class="op" id="8046376">&lt;</span>&nbsp;<span class="ident" id="8046378">b</span><span class="op" id="8046379">.</span><span class="ident" id="8046380">N</span><span class="op" id="8046381">;</span>&nbsp;<span class="ident" id="8046383">i</span><span class="op" id="8046384">++</span>&nbsp;<span class="op" id="8046387">{</span><br>
<span class="lineno">1985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8046391">doConcurrentTest</span><span class="op" id="8046407">(</span><span class="ident" id="8046408">b</span><span class="op" id="8046409">,</span>&nbsp;<span class="ident" id="8046411">ct</span><span class="op" id="8046413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8046416">}</span><br>
<span class="lineno"></span><span class="op" id="8046418">}</span>
</div>
</body>
</html>
