<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html" class="current">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1566023">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1566078">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1566132">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1566183">//&nbsp;Malloc&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="1566204">//&nbsp;Patterned&nbsp;after&nbsp;tcmalloc&#39;s&nbsp;algorithms;&nbsp;shorter&nbsp;code.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1566261">package</span>&nbsp;<span class="ident" id="1566269">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="1566278">import</span>&nbsp;<span class="op" id="1566285">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1566288">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1566297">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1566300">//&nbsp;NOTE(rsc):&nbsp;Everything&nbsp;here&nbsp;could&nbsp;use&nbsp;cas&nbsp;if&nbsp;contention&nbsp;became&nbsp;an&nbsp;issue.</span><br>
<span class="lineno">15</span><span class="keyword" id="1566375">var</span>&nbsp;<span class="ident" id="1566379">proflock</span>&nbsp;<span class="ident" id="1566388">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1566395">//&nbsp;All&nbsp;memory&nbsp;allocations&nbsp;are&nbsp;local&nbsp;and&nbsp;do&nbsp;not&nbsp;escape&nbsp;outside&nbsp;of&nbsp;the&nbsp;profiler.</span><br>
<span class="lineno"></span><span class="comment" id="1566474">//&nbsp;The&nbsp;profiler&nbsp;is&nbsp;forbidden&nbsp;from&nbsp;referring&nbsp;to&nbsp;garbage-collected&nbsp;memory.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1566548">const</span>&nbsp;<span class="op" id="1566554">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566557">//&nbsp;profile&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566575">memProfile</span>&nbsp;<span class="ident" id="1566586">bucketType</span>&nbsp;<span class="op" id="1566597">=</span>&nbsp;<span class="num" id="1566599">1</span>&nbsp;<span class="op" id="1566601">+</span>&nbsp;<span class="ident" id="1566603">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566609">blockProfile</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566624">//&nbsp;size&nbsp;of&nbsp;bucket&nbsp;hash&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566654">buckHashSize</span>&nbsp;<span class="op" id="1566667">=</span>&nbsp;<span class="num" id="1566669">179999</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1566678">//&nbsp;max&nbsp;depth&nbsp;of&nbsp;stack&nbsp;to&nbsp;record&nbsp;in&nbsp;bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1566721">maxStack</span>&nbsp;<span class="op" id="1566730">=</span>&nbsp;<span class="num" id="1566732">32</span><br>
<span class="lineno">30</span><span class="op" id="1566735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1566738">type</span>&nbsp;<span class="ident" id="1566743">bucketType</span>&nbsp;<span class="builtintype" id="1566754">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1566759">//&nbsp;A&nbsp;bucket&nbsp;holds&nbsp;per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno">35</span><span class="comment" id="1566815">//&nbsp;The&nbsp;representation&nbsp;is&nbsp;a&nbsp;bit&nbsp;sleazy,&nbsp;inherited&nbsp;from&nbsp;C.</span><br>
<span class="lineno"></span><span class="comment" id="1566872">//&nbsp;This&nbsp;struct&nbsp;defines&nbsp;the&nbsp;bucket&nbsp;header.&nbsp;It&nbsp;is&nbsp;followed&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1566932">//&nbsp;memory&nbsp;by&nbsp;the&nbsp;stack&nbsp;words&nbsp;and&nbsp;then&nbsp;the&nbsp;actual&nbsp;record</span><br>
<span class="lineno"></span><span class="comment" id="1566988">//&nbsp;data,&nbsp;either&nbsp;a&nbsp;memRecord&nbsp;or&nbsp;a&nbsp;blockRecord.</span><br>
<span class="lineno"></span><span class="comment" id="1567034">//</span><br>
<span class="lineno">40</span><span class="comment" id="1567037">//&nbsp;Per-call-stack&nbsp;profiling&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="1567078">//&nbsp;Lookup&nbsp;by&nbsp;hashing&nbsp;call&nbsp;stack&nbsp;into&nbsp;a&nbsp;linked-list&nbsp;hash&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="1567141">type</span>&nbsp;<span class="ident" id="1567146">bucket</span>&nbsp;<span class="keyword" id="1567153">struct</span>&nbsp;<span class="op" id="1567160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567163">next</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1567171">*</span><span class="ident" id="1567172">bucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567180">allnext</span>&nbsp;<span class="op" id="1567188">*</span><span class="ident" id="1567189">bucket</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567197">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567205">bucketType</span>&nbsp;<span class="comment" id="1567216">//&nbsp;memBucket&nbsp;or&nbsp;blockBucket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567245">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1567253">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567262">size</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1567270">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1567279">nstk</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1567287">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1567295">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment" id="1567298">//&nbsp;A&nbsp;memRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;memProfile,</span><br>
<span class="lineno"></span><span class="comment" id="1567365">//&nbsp;part&nbsp;of&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1567396">type</span>&nbsp;<span class="ident" id="1567401">memRecord</span>&nbsp;<span class="keyword" id="1567411">struct</span>&nbsp;<span class="op" id="1567418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567421">//&nbsp;The&nbsp;following&nbsp;complex&nbsp;3-stage&nbsp;scheme&nbsp;of&nbsp;stats&nbsp;accumulation</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567484">//&nbsp;is&nbsp;required&nbsp;to&nbsp;obtain&nbsp;a&nbsp;consistent&nbsp;picture&nbsp;of&nbsp;mallocs&nbsp;and&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567552">//&nbsp;for&nbsp;some&nbsp;point&nbsp;in&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567580">//&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;mallocs&nbsp;come&nbsp;in&nbsp;real&nbsp;time,&nbsp;while&nbsp;frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567643">//&nbsp;come&nbsp;only&nbsp;after&nbsp;a&nbsp;GC&nbsp;during&nbsp;concurrent&nbsp;sweeping.&nbsp;So&nbsp;if&nbsp;we&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567711">//&nbsp;naively&nbsp;count&nbsp;them,&nbsp;we&nbsp;would&nbsp;get&nbsp;a&nbsp;skew&nbsp;toward&nbsp;mallocs.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567771">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567775">//&nbsp;Mallocs&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567818">//&nbsp;Explicit&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;recent&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567868">//&nbsp;GC&nbsp;frees&nbsp;are&nbsp;accounted&nbsp;in&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567910">//&nbsp;After&nbsp;GC&nbsp;prev&nbsp;stats&nbsp;are&nbsp;added&nbsp;to&nbsp;final&nbsp;stats&nbsp;and</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1567963">//&nbsp;recent&nbsp;stats&nbsp;are&nbsp;moved&nbsp;into&nbsp;prev&nbsp;stats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568007">allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568019">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568028">frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568040">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568049">alloc_bytes</span>&nbsp;<span class="builtintype" id="1568061">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568070">free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1568082">uintptr</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1568092">//&nbsp;changes&nbsp;between&nbsp;next-to-last&nbsp;GC&nbsp;and&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568140">prev_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568157">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568166">prev_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568183">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568192">prev_alloc_bytes</span>&nbsp;<span class="builtintype" id="1568209">uintptr</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568218">prev_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1568235">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1568245">//&nbsp;changes&nbsp;since&nbsp;last&nbsp;GC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568271">recent_allocs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568290">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568299">recent_frees</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1568318">uintptr</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568327">recent_alloc_bytes</span>&nbsp;<span class="builtintype" id="1568346">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568355">recent_free_bytes</span>&nbsp;&nbsp;<span class="builtintype" id="1568374">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1568382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1568385">//&nbsp;A&nbsp;blockRecord&nbsp;is&nbsp;the&nbsp;bucket&nbsp;data&nbsp;for&nbsp;a&nbsp;bucket&nbsp;of&nbsp;type&nbsp;blockProfile,</span><br>
<span class="lineno">85</span><span class="comment" id="1568456">//&nbsp;part&nbsp;of&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="1568489">type</span>&nbsp;<span class="ident" id="1568494">blockRecord</span>&nbsp;<span class="keyword" id="1568506">struct</span>&nbsp;<span class="op" id="1568513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568516">count</span>&nbsp;&nbsp;<span class="ident" id="1568523">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568530">cycles</span>&nbsp;<span class="ident" id="1568537">int64</span><br>
<span class="lineno"></span><span class="op" id="1568543">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="1568546">var</span>&nbsp;<span class="op" id="1568550">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568553">mbuckets</span>&nbsp;&nbsp;<span class="op" id="1568563">*</span><span class="ident" id="1568564">bucket</span>&nbsp;<span class="comment" id="1568571">//&nbsp;memory&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568598">bbuckets</span>&nbsp;&nbsp;<span class="op" id="1568608">*</span><span class="ident" id="1568609">bucket</span>&nbsp;<span class="comment" id="1568616">//&nbsp;blocking&nbsp;profile&nbsp;buckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568645">buckhash</span>&nbsp;&nbsp;<span class="op" id="1568655">*</span><span class="op" id="1568656">[</span><span class="num" id="1568657">179999</span><span class="op" id="1568663">]</span><span class="op" id="1568664">*</span><span class="ident" id="1568665">bucket</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568673">bucketmem</span>&nbsp;<span class="builtintype" id="1568683">uintptr</span><br>
<span class="lineno"></span><span class="op" id="1568691">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1568694">//&nbsp;newBucket&nbsp;allocates&nbsp;a&nbsp;bucket&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;number&nbsp;of&nbsp;stack&nbsp;entries.</span><br>
<span class="lineno"></span><span class="keyword" id="1568775">func</span>&nbsp;<span class="ident" id="1568780">newBucket</span><span class="op" id="1568789">(</span><span class="ident" id="1568790">typ</span>&nbsp;<span class="ident" id="1568794">bucketType</span><span class="op" id="1568804">,</span>&nbsp;<span class="ident" id="1568806">nstk</span>&nbsp;<span class="builtintype" id="1568811">int</span><span class="op" id="1568814">)</span>&nbsp;<span class="op" id="1568816">*</span><span class="ident" id="1568817">bucket</span>&nbsp;<span class="op" id="1568824">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568827">size</span>&nbsp;<span class="op" id="1568832">:=</span>&nbsp;<span class="ident" id="1568835">unsafe</span><span class="op" id="1568841">.</span><span class="ident" id="1568842">Sizeof</span><span class="op" id="1568848">(</span><span class="ident" id="1568849">bucket</span><span class="op" id="1568855">{</span><span class="op" id="1568856">}</span><span class="op" id="1568857">)</span>&nbsp;<span class="op" id="1568859">+</span>&nbsp;<span class="builtintype" id="1568861">uintptr</span><span class="op" id="1568868">(</span><span class="ident" id="1568869">nstk</span><span class="op" id="1568873">)</span><span class="op" id="1568874">*</span><span class="ident" id="1568875">unsafe</span><span class="op" id="1568881">.</span><span class="ident" id="1568882">Sizeof</span><span class="op" id="1568888">(</span><span class="builtintype" id="1568889">uintptr</span><span class="op" id="1568896">(</span><span class="num" id="1568897">0</span><span class="op" id="1568898">)</span><span class="op" id="1568899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568902">switch</span>&nbsp;<span class="ident" id="1568909">typ</span>&nbsp;<span class="op" id="1568913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568916">default</span><span class="op" id="1568923">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568927">gothrow</span><span class="op" id="1568934">(</span><span class="string" id="1568935">&#34;invalid&nbsp;profile&nbsp;bucket&nbsp;type&#34;</span><span class="op" id="1568964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1568967">case</span>&nbsp;<span class="ident" id="1568972">memProfile</span><span class="op" id="1568982">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1568986">size</span>&nbsp;<span class="op" id="1568991">+=</span>&nbsp;<span class="ident" id="1568994">unsafe</span><span class="op" id="1569000">.</span><span class="ident" id="1569001">Sizeof</span><span class="op" id="1569007">(</span><span class="ident" id="1569008">memRecord</span><span class="op" id="1569017">{</span><span class="op" id="1569018">}</span><span class="op" id="1569019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569022">case</span>&nbsp;<span class="ident" id="1569027">blockProfile</span><span class="op" id="1569039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569043">size</span>&nbsp;<span class="op" id="1569048">+=</span>&nbsp;<span class="ident" id="1569051">unsafe</span><span class="op" id="1569057">.</span><span class="ident" id="1569058">Sizeof</span><span class="op" id="1569064">(</span><span class="ident" id="1569065">blockRecord</span><span class="op" id="1569076">{</span><span class="op" id="1569077">}</span><span class="op" id="1569078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569085">b</span>&nbsp;<span class="op" id="1569087">:=</span>&nbsp;<span class="op" id="1569090">(</span><span class="op" id="1569091">*</span><span class="ident" id="1569092">bucket</span><span class="op" id="1569098">)</span><span class="op" id="1569099">(</span><span class="ident" id="1569100">persistentalloc</span><span class="op" id="1569115">(</span><span class="ident" id="1569116">size</span><span class="op" id="1569120">,</span>&nbsp;<span class="num" id="1569122">0</span><span class="op" id="1569123">,</span>&nbsp;<span class="op" id="1569125">&amp;</span><span class="ident" id="1569126">memstats</span><span class="op" id="1569134">.</span><span class="ident" id="1569135">buckhash_sys</span><span class="op" id="1569147">)</span><span class="op" id="1569148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569151">bucketmem</span>&nbsp;<span class="op" id="1569161">+=</span>&nbsp;<span class="ident" id="1569164">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569170">b</span><span class="op" id="1569171">.</span><span class="ident" id="1569172">typ</span>&nbsp;<span class="op" id="1569176">=</span>&nbsp;<span class="ident" id="1569178">typ</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569183">b</span><span class="op" id="1569184">.</span><span class="ident" id="1569185">nstk</span>&nbsp;<span class="op" id="1569190">=</span>&nbsp;<span class="builtintype" id="1569192">uintptr</span><span class="op" id="1569199">(</span><span class="ident" id="1569200">nstk</span><span class="op" id="1569204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569207">return</span>&nbsp;<span class="ident" id="1569214">b</span><br>
<span class="lineno">115</span><span class="op" id="1569216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1569219">//&nbsp;stk&nbsp;returns&nbsp;the&nbsp;slice&nbsp;in&nbsp;b&nbsp;holding&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1569268">func</span>&nbsp;<span class="op" id="1569273">(</span><span class="ident" id="1569274">b</span>&nbsp;<span class="op" id="1569276">*</span><span class="ident" id="1569277">bucket</span><span class="op" id="1569283">)</span>&nbsp;<span class="ident" id="1569285">stk</span><span class="op" id="1569288">(</span><span class="op" id="1569289">)</span>&nbsp;<span class="op" id="1569291">[</span><span class="op" id="1569292">]</span><span class="builtintype" id="1569293">uintptr</span>&nbsp;<span class="op" id="1569301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569304">stk</span>&nbsp;<span class="op" id="1569308">:=</span>&nbsp;<span class="op" id="1569311">(</span><span class="op" id="1569312">*</span><span class="op" id="1569313">[</span><span class="ident" id="1569314">maxStack</span><span class="op" id="1569322">]</span><span class="builtintype" id="1569323">uintptr</span><span class="op" id="1569330">)</span><span class="op" id="1569331">(</span><span class="ident" id="1569332">add</span><span class="op" id="1569335">(</span><span class="ident" id="1569336">unsafe</span><span class="op" id="1569342">.</span><span class="ident" id="1569343">Pointer</span><span class="op" id="1569350">(</span><span class="ident" id="1569351">b</span><span class="op" id="1569352">)</span><span class="op" id="1569353">,</span>&nbsp;<span class="ident" id="1569355">unsafe</span><span class="op" id="1569361">.</span><span class="ident" id="1569362">Sizeof</span><span class="op" id="1569368">(</span><span class="op" id="1569369">*</span><span class="ident" id="1569370">b</span><span class="op" id="1569371">)</span><span class="op" id="1569372">)</span><span class="op" id="1569373">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569376">return</span>&nbsp;<span class="ident" id="1569383">stk</span><span class="op" id="1569386">[</span><span class="op" id="1569387">:</span><span class="ident" id="1569388">b</span><span class="op" id="1569389">.</span><span class="ident" id="1569390">nstk</span><span class="op" id="1569394">:</span><span class="ident" id="1569395">b</span><span class="op" id="1569396">.</span><span class="ident" id="1569397">nstk</span><span class="op" id="1569401">]</span><br>
<span class="lineno"></span><span class="op" id="1569403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1569406">//&nbsp;mp&nbsp;returns&nbsp;the&nbsp;memRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;memProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1569475">func</span>&nbsp;<span class="op" id="1569480">(</span><span class="ident" id="1569481">b</span>&nbsp;<span class="op" id="1569483">*</span><span class="ident" id="1569484">bucket</span><span class="op" id="1569490">)</span>&nbsp;<span class="ident" id="1569492">mp</span><span class="op" id="1569494">(</span><span class="op" id="1569495">)</span>&nbsp;<span class="op" id="1569497">*</span><span class="ident" id="1569498">memRecord</span>&nbsp;<span class="op" id="1569508">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569511">if</span>&nbsp;<span class="ident" id="1569514">b</span><span class="op" id="1569515">.</span><span class="ident" id="1569516">typ</span>&nbsp;<span class="op" id="1569520">!=</span>&nbsp;<span class="ident" id="1569523">memProfile</span>&nbsp;<span class="op" id="1569534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569538">gothrow</span><span class="op" id="1569545">(</span><span class="string" id="1569546">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.mp&#34;</span><span class="op" id="1569568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569574">data</span>&nbsp;<span class="op" id="1569579">:=</span>&nbsp;<span class="ident" id="1569582">add</span><span class="op" id="1569585">(</span><span class="ident" id="1569586">unsafe</span><span class="op" id="1569592">.</span><span class="ident" id="1569593">Pointer</span><span class="op" id="1569600">(</span><span class="ident" id="1569601">b</span><span class="op" id="1569602">)</span><span class="op" id="1569603">,</span>&nbsp;<span class="ident" id="1569605">unsafe</span><span class="op" id="1569611">.</span><span class="ident" id="1569612">Sizeof</span><span class="op" id="1569618">(</span><span class="op" id="1569619">*</span><span class="ident" id="1569620">b</span><span class="op" id="1569621">)</span><span class="op" id="1569622">+</span><span class="ident" id="1569623">b</span><span class="op" id="1569624">.</span><span class="ident" id="1569625">nstk</span><span class="op" id="1569629">*</span><span class="ident" id="1569630">unsafe</span><span class="op" id="1569636">.</span><span class="ident" id="1569637">Sizeof</span><span class="op" id="1569643">(</span><span class="builtintype" id="1569644">uintptr</span><span class="op" id="1569651">(</span><span class="num" id="1569652">0</span><span class="op" id="1569653">)</span><span class="op" id="1569654">)</span><span class="op" id="1569655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569658">return</span>&nbsp;<span class="op" id="1569665">(</span><span class="op" id="1569666">*</span><span class="ident" id="1569667">memRecord</span><span class="op" id="1569676">)</span><span class="op" id="1569677">(</span><span class="ident" id="1569678">data</span><span class="op" id="1569682">)</span><br>
<span class="lineno">130</span><span class="op" id="1569684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1569687">//&nbsp;bp&nbsp;returns&nbsp;the&nbsp;blockRecord&nbsp;associated&nbsp;with&nbsp;the&nbsp;blockProfile&nbsp;bucket&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="1569760">func</span>&nbsp;<span class="op" id="1569765">(</span><span class="ident" id="1569766">b</span>&nbsp;<span class="op" id="1569768">*</span><span class="ident" id="1569769">bucket</span><span class="op" id="1569775">)</span>&nbsp;<span class="ident" id="1569777">bp</span><span class="op" id="1569779">(</span><span class="op" id="1569780">)</span>&nbsp;<span class="op" id="1569782">*</span><span class="ident" id="1569783">blockRecord</span>&nbsp;<span class="op" id="1569795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569798">if</span>&nbsp;<span class="ident" id="1569801">b</span><span class="op" id="1569802">.</span><span class="ident" id="1569803">typ</span>&nbsp;<span class="op" id="1569807">!=</span>&nbsp;<span class="ident" id="1569810">blockProfile</span>&nbsp;<span class="op" id="1569823">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569827">gothrow</span><span class="op" id="1569834">(</span><span class="string" id="1569835">&#34;bad&nbsp;use&nbsp;of&nbsp;bucket.bp&#34;</span><span class="op" id="1569857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1569860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1569863">data</span>&nbsp;<span class="op" id="1569868">:=</span>&nbsp;<span class="ident" id="1569871">add</span><span class="op" id="1569874">(</span><span class="ident" id="1569875">unsafe</span><span class="op" id="1569881">.</span><span class="ident" id="1569882">Pointer</span><span class="op" id="1569889">(</span><span class="ident" id="1569890">b</span><span class="op" id="1569891">)</span><span class="op" id="1569892">,</span>&nbsp;<span class="ident" id="1569894">unsafe</span><span class="op" id="1569900">.</span><span class="ident" id="1569901">Sizeof</span><span class="op" id="1569907">(</span><span class="op" id="1569908">*</span><span class="ident" id="1569909">b</span><span class="op" id="1569910">)</span><span class="op" id="1569911">+</span><span class="ident" id="1569912">b</span><span class="op" id="1569913">.</span><span class="ident" id="1569914">nstk</span><span class="op" id="1569918">*</span><span class="ident" id="1569919">unsafe</span><span class="op" id="1569925">.</span><span class="ident" id="1569926">Sizeof</span><span class="op" id="1569932">(</span><span class="builtintype" id="1569933">uintptr</span><span class="op" id="1569940">(</span><span class="num" id="1569941">0</span><span class="op" id="1569942">)</span><span class="op" id="1569943">)</span><span class="op" id="1569944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1569947">return</span>&nbsp;<span class="op" id="1569954">(</span><span class="op" id="1569955">*</span><span class="ident" id="1569956">blockRecord</span><span class="op" id="1569967">)</span><span class="op" id="1569968">(</span><span class="ident" id="1569969">data</span><span class="op" id="1569973">)</span><br>
<span class="lineno"></span><span class="op" id="1569975">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="1569978">//&nbsp;Return&nbsp;the&nbsp;bucket&nbsp;for&nbsp;stk[0:nstk],&nbsp;allocating&nbsp;new&nbsp;bucket&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="keyword" id="1570049">func</span>&nbsp;<span class="ident" id="1570054">stkbucket</span><span class="op" id="1570063">(</span><span class="ident" id="1570064">typ</span>&nbsp;<span class="ident" id="1570068">bucketType</span><span class="op" id="1570078">,</span>&nbsp;<span class="ident" id="1570080">size</span>&nbsp;<span class="builtintype" id="1570085">uintptr</span><span class="op" id="1570092">,</span>&nbsp;<span class="ident" id="1570094">stk</span>&nbsp;<span class="op" id="1570098">[</span><span class="op" id="1570099">]</span><span class="builtintype" id="1570100">uintptr</span><span class="op" id="1570107">,</span>&nbsp;<span class="ident" id="1570109">alloc</span>&nbsp;<span class="builtintype" id="1570115">bool</span><span class="op" id="1570119">)</span>&nbsp;<span class="op" id="1570121">*</span><span class="ident" id="1570122">bucket</span>&nbsp;<span class="op" id="1570129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570132">if</span>&nbsp;<span class="ident" id="1570135">buckhash</span>&nbsp;<span class="op" id="1570144">==</span>&nbsp;<span class="ident" id="1570147">nil</span>&nbsp;<span class="op" id="1570151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570155">buckhash</span>&nbsp;<span class="op" id="1570164">=</span>&nbsp;<span class="op" id="1570166">(</span><span class="op" id="1570167">*</span><span class="op" id="1570168">[</span><span class="ident" id="1570169">buckHashSize</span><span class="op" id="1570181">]</span><span class="op" id="1570182">*</span><span class="ident" id="1570183">bucket</span><span class="op" id="1570189">)</span><span class="op" id="1570190">(</span><span class="ident" id="1570191">sysAlloc</span><span class="op" id="1570199">(</span><span class="ident" id="1570200">unsafe</span><span class="op" id="1570206">.</span><span class="ident" id="1570207">Sizeof</span><span class="op" id="1570213">(</span><span class="op" id="1570214">*</span><span class="ident" id="1570215">buckhash</span><span class="op" id="1570223">)</span><span class="op" id="1570224">,</span>&nbsp;<span class="op" id="1570226">&amp;</span><span class="ident" id="1570227">memstats</span><span class="op" id="1570235">.</span><span class="ident" id="1570236">buckhash_sys</span><span class="op" id="1570248">)</span><span class="op" id="1570249">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570253">if</span>&nbsp;<span class="ident" id="1570256">buckhash</span>&nbsp;<span class="op" id="1570265">==</span>&nbsp;<span class="ident" id="1570268">nil</span>&nbsp;<span class="op" id="1570272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570277">gothrow</span><span class="op" id="1570284">(</span><span class="string" id="1570285">&#34;runtime:&nbsp;cannot&nbsp;allocate&nbsp;memory&#34;</span><span class="op" id="1570318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570329">//&nbsp;Hash&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570345">var</span>&nbsp;<span class="ident" id="1570349">h</span>&nbsp;<span class="builtintype" id="1570351">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570360">for</span>&nbsp;<span class="ident" id="1570364">_</span><span class="op" id="1570365">,</span>&nbsp;<span class="ident" id="1570367">pc</span>&nbsp;<span class="op" id="1570370">:=</span>&nbsp;<span class="keyword" id="1570373">range</span>&nbsp;<span class="ident" id="1570379">stk</span>&nbsp;<span class="op" id="1570383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570387">h</span>&nbsp;<span class="op" id="1570389">+=</span>&nbsp;<span class="ident" id="1570392">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570397">h</span>&nbsp;<span class="op" id="1570399">+=</span>&nbsp;<span class="ident" id="1570402">h</span>&nbsp;<span class="op" id="1570404">&lt;&lt;</span>&nbsp;<span class="num" id="1570407">10</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570412">h</span>&nbsp;<span class="op" id="1570414">^=</span>&nbsp;<span class="ident" id="1570417">h</span>&nbsp;<span class="op" id="1570419">&gt;&gt;</span>&nbsp;<span class="num" id="1570422">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570428">//&nbsp;hash&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570445">h</span>&nbsp;<span class="op" id="1570447">+=</span>&nbsp;<span class="ident" id="1570450">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570456">h</span>&nbsp;<span class="op" id="1570458">+=</span>&nbsp;<span class="ident" id="1570461">h</span>&nbsp;<span class="op" id="1570463">&lt;&lt;</span>&nbsp;<span class="num" id="1570466">10</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570470">h</span>&nbsp;<span class="op" id="1570472">^=</span>&nbsp;<span class="ident" id="1570475">h</span>&nbsp;<span class="op" id="1570477">&gt;&gt;</span>&nbsp;<span class="num" id="1570480">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570483">//&nbsp;finalize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570496">h</span>&nbsp;<span class="op" id="1570498">+=</span>&nbsp;<span class="ident" id="1570501">h</span>&nbsp;<span class="op" id="1570503">&lt;&lt;</span>&nbsp;<span class="num" id="1570506">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570509">h</span>&nbsp;<span class="op" id="1570511">^=</span>&nbsp;<span class="ident" id="1570514">h</span>&nbsp;<span class="op" id="1570516">&gt;&gt;</span>&nbsp;<span class="num" id="1570519">11</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570524">i</span>&nbsp;<span class="op" id="1570526">:=</span>&nbsp;<span class="builtintype" id="1570529">int</span><span class="op" id="1570532">(</span><span class="ident" id="1570533">h</span>&nbsp;<span class="op" id="1570535">%</span>&nbsp;<span class="ident" id="1570537">buckHashSize</span><span class="op" id="1570549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570552">for</span>&nbsp;<span class="ident" id="1570556">b</span>&nbsp;<span class="op" id="1570558">:=</span>&nbsp;<span class="ident" id="1570561">buckhash</span><span class="op" id="1570569">[</span><span class="ident" id="1570570">i</span><span class="op" id="1570571">]</span><span class="op" id="1570572">;</span>&nbsp;<span class="ident" id="1570574">b</span>&nbsp;<span class="op" id="1570576">!=</span>&nbsp;<span class="ident" id="1570579">nil</span><span class="op" id="1570582">;</span>&nbsp;<span class="ident" id="1570584">b</span>&nbsp;<span class="op" id="1570586">=</span>&nbsp;<span class="ident" id="1570588">b</span><span class="op" id="1570589">.</span><span class="ident" id="1570590">next</span>&nbsp;<span class="op" id="1570595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570599">if</span>&nbsp;<span class="ident" id="1570602">b</span><span class="op" id="1570603">.</span><span class="ident" id="1570604">typ</span>&nbsp;<span class="op" id="1570608">==</span>&nbsp;<span class="ident" id="1570611">typ</span>&nbsp;<span class="op" id="1570615">&amp;&amp;</span>&nbsp;<span class="ident" id="1570618">b</span><span class="op" id="1570619">.</span><span class="ident" id="1570620">hash</span>&nbsp;<span class="op" id="1570625">==</span>&nbsp;<span class="ident" id="1570628">h</span>&nbsp;<span class="op" id="1570630">&amp;&amp;</span>&nbsp;<span class="ident" id="1570633">b</span><span class="op" id="1570634">.</span><span class="ident" id="1570635">size</span>&nbsp;<span class="op" id="1570640">==</span>&nbsp;<span class="ident" id="1570643">size</span>&nbsp;<span class="op" id="1570648">&amp;&amp;</span>&nbsp;<span class="ident" id="1570651">eqslice</span><span class="op" id="1570658">(</span><span class="ident" id="1570659">b</span><span class="op" id="1570660">.</span><span class="ident" id="1570661">stk</span><span class="op" id="1570664">(</span><span class="op" id="1570665">)</span><span class="op" id="1570666">,</span>&nbsp;<span class="ident" id="1570668">stk</span><span class="op" id="1570671">)</span>&nbsp;<span class="op" id="1570673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570678">return</span>&nbsp;<span class="ident" id="1570685">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570689">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570692">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570696">if</span>&nbsp;<span class="op" id="1570699">!</span><span class="ident" id="1570700">alloc</span>&nbsp;<span class="op" id="1570706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570710">return</span>&nbsp;<span class="ident" id="1570717">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570722">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1570726">//&nbsp;Create&nbsp;new&nbsp;bucket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570749">b</span>&nbsp;<span class="op" id="1570751">:=</span>&nbsp;<span class="ident" id="1570754">newBucket</span><span class="op" id="1570763">(</span><span class="ident" id="1570764">typ</span><span class="op" id="1570767">,</span>&nbsp;<span class="builtinfunc" id="1570769">len</span><span class="op" id="1570772">(</span><span class="ident" id="1570773">stk</span><span class="op" id="1570776">)</span><span class="op" id="1570777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1570780">copy</span><span class="op" id="1570784">(</span><span class="ident" id="1570785">b</span><span class="op" id="1570786">.</span><span class="ident" id="1570787">stk</span><span class="op" id="1570790">(</span><span class="op" id="1570791">)</span><span class="op" id="1570792">,</span>&nbsp;<span class="ident" id="1570794">stk</span><span class="op" id="1570797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570800">b</span><span class="op" id="1570801">.</span><span class="ident" id="1570802">hash</span>&nbsp;<span class="op" id="1570807">=</span>&nbsp;<span class="ident" id="1570809">h</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570812">b</span><span class="op" id="1570813">.</span><span class="ident" id="1570814">size</span>&nbsp;<span class="op" id="1570819">=</span>&nbsp;<span class="ident" id="1570821">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570827">b</span><span class="op" id="1570828">.</span><span class="ident" id="1570829">next</span>&nbsp;<span class="op" id="1570834">=</span>&nbsp;<span class="ident" id="1570836">buckhash</span><span class="op" id="1570844">[</span><span class="ident" id="1570845">i</span><span class="op" id="1570846">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570849">buckhash</span><span class="op" id="1570857">[</span><span class="ident" id="1570858">i</span><span class="op" id="1570859">]</span>&nbsp;<span class="op" id="1570861">=</span>&nbsp;<span class="ident" id="1570863">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570866">if</span>&nbsp;<span class="ident" id="1570869">typ</span>&nbsp;<span class="op" id="1570873">==</span>&nbsp;<span class="ident" id="1570876">memProfile</span>&nbsp;<span class="op" id="1570887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570891">b</span><span class="op" id="1570892">.</span><span class="ident" id="1570893">allnext</span>&nbsp;<span class="op" id="1570901">=</span>&nbsp;<span class="ident" id="1570903">mbuckets</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570914">mbuckets</span>&nbsp;<span class="op" id="1570923">=</span>&nbsp;<span class="ident" id="1570925">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570928">}</span>&nbsp;<span class="keyword" id="1570930">else</span>&nbsp;<span class="op" id="1570935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570939">b</span><span class="op" id="1570940">.</span><span class="ident" id="1570941">allnext</span>&nbsp;<span class="op" id="1570949">=</span>&nbsp;<span class="ident" id="1570951">bbuckets</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1570962">bbuckets</span>&nbsp;<span class="op" id="1570971">=</span>&nbsp;<span class="ident" id="1570973">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1570976">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1570979">return</span>&nbsp;<span class="ident" id="1570986">b</span><br>
<span class="lineno"></span><span class="op" id="1570988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1570991">func</span>&nbsp;<span class="ident" id="1570996">sysAlloc</span><span class="op" id="1571004">(</span><span class="ident" id="1571005">n</span>&nbsp;<span class="builtintype" id="1571007">uintptr</span><span class="op" id="1571014">,</span>&nbsp;<span class="ident" id="1571016">stat</span>&nbsp;<span class="op" id="1571021">*</span><span class="ident" id="1571022">uint64</span><span class="op" id="1571028">)</span>&nbsp;<span class="ident" id="1571030">unsafe</span><span class="op" id="1571036">.</span><span class="ident" id="1571037">Pointer</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="1571046">func</span>&nbsp;<span class="ident" id="1571051">eqslice</span><span class="op" id="1571058">(</span><span class="ident" id="1571059">x</span><span class="op" id="1571060">,</span>&nbsp;<span class="ident" id="1571062">y</span>&nbsp;<span class="op" id="1571064">[</span><span class="op" id="1571065">]</span><span class="builtintype" id="1571066">uintptr</span><span class="op" id="1571073">)</span>&nbsp;<span class="builtintype" id="1571075">bool</span>&nbsp;<span class="op" id="1571080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571083">if</span>&nbsp;<span class="builtinfunc" id="1571086">len</span><span class="op" id="1571089">(</span><span class="ident" id="1571090">x</span><span class="op" id="1571091">)</span>&nbsp;<span class="op" id="1571093">!=</span>&nbsp;<span class="builtinfunc" id="1571096">len</span><span class="op" id="1571099">(</span><span class="ident" id="1571100">y</span><span class="op" id="1571101">)</span>&nbsp;<span class="op" id="1571103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571107">return</span>&nbsp;<span class="builtintype" id="1571114">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571124">for</span>&nbsp;<span class="ident" id="1571128">i</span><span class="op" id="1571129">,</span>&nbsp;<span class="ident" id="1571131">xi</span>&nbsp;<span class="op" id="1571134">:=</span>&nbsp;<span class="keyword" id="1571137">range</span>&nbsp;<span class="ident" id="1571143">x</span>&nbsp;<span class="op" id="1571145">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571149">if</span>&nbsp;<span class="ident" id="1571152">xi</span>&nbsp;<span class="op" id="1571155">!=</span>&nbsp;<span class="ident" id="1571158">y</span><span class="op" id="1571159">[</span><span class="ident" id="1571160">i</span><span class="op" id="1571161">]</span>&nbsp;<span class="op" id="1571163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571168">return</span>&nbsp;<span class="builtintype" id="1571175">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571189">return</span>&nbsp;<span class="builtintype" id="1571196">true</span><br>
<span class="lineno">205</span><span class="op" id="1571201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1571204">func</span>&nbsp;<span class="ident" id="1571209">mprof_GC</span><span class="op" id="1571217">(</span><span class="op" id="1571218">)</span>&nbsp;<span class="op" id="1571220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571223">for</span>&nbsp;<span class="ident" id="1571227">b</span>&nbsp;<span class="op" id="1571229">:=</span>&nbsp;<span class="ident" id="1571232">mbuckets</span><span class="op" id="1571240">;</span>&nbsp;<span class="ident" id="1571242">b</span>&nbsp;<span class="op" id="1571244">!=</span>&nbsp;<span class="ident" id="1571247">nil</span><span class="op" id="1571250">;</span>&nbsp;<span class="ident" id="1571252">b</span>&nbsp;<span class="op" id="1571254">=</span>&nbsp;<span class="ident" id="1571256">b</span><span class="op" id="1571257">.</span><span class="ident" id="1571258">allnext</span>&nbsp;<span class="op" id="1571266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571270">mp</span>&nbsp;<span class="op" id="1571273">:=</span>&nbsp;<span class="ident" id="1571276">b</span><span class="op" id="1571277">.</span><span class="ident" id="1571278">mp</span><span class="op" id="1571280">(</span><span class="op" id="1571281">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571285">mp</span><span class="op" id="1571287">.</span><span class="ident" id="1571288">allocs</span>&nbsp;<span class="op" id="1571295">+=</span>&nbsp;<span class="ident" id="1571298">mp</span><span class="op" id="1571300">.</span><span class="ident" id="1571301">prev_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571315">mp</span><span class="op" id="1571317">.</span><span class="ident" id="1571318">frees</span>&nbsp;<span class="op" id="1571324">+=</span>&nbsp;<span class="ident" id="1571327">mp</span><span class="op" id="1571329">.</span><span class="ident" id="1571330">prev_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571343">mp</span><span class="op" id="1571345">.</span><span class="ident" id="1571346">alloc_bytes</span>&nbsp;<span class="op" id="1571358">+=</span>&nbsp;<span class="ident" id="1571361">mp</span><span class="op" id="1571363">.</span><span class="ident" id="1571364">prev_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571383">mp</span><span class="op" id="1571385">.</span><span class="ident" id="1571386">free_bytes</span>&nbsp;<span class="op" id="1571397">+=</span>&nbsp;<span class="ident" id="1571400">mp</span><span class="op" id="1571402">.</span><span class="ident" id="1571403">prev_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571422">mp</span><span class="op" id="1571424">.</span><span class="ident" id="1571425">prev_allocs</span>&nbsp;<span class="op" id="1571437">=</span>&nbsp;<span class="ident" id="1571439">mp</span><span class="op" id="1571441">.</span><span class="ident" id="1571442">recent_allocs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571458">mp</span><span class="op" id="1571460">.</span><span class="ident" id="1571461">prev_frees</span>&nbsp;<span class="op" id="1571472">=</span>&nbsp;<span class="ident" id="1571474">mp</span><span class="op" id="1571476">.</span><span class="ident" id="1571477">recent_frees</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571492">mp</span><span class="op" id="1571494">.</span><span class="ident" id="1571495">prev_alloc_bytes</span>&nbsp;<span class="op" id="1571512">=</span>&nbsp;<span class="ident" id="1571514">mp</span><span class="op" id="1571516">.</span><span class="ident" id="1571517">recent_alloc_bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571538">mp</span><span class="op" id="1571540">.</span><span class="ident" id="1571541">prev_free_bytes</span>&nbsp;<span class="op" id="1571557">=</span>&nbsp;<span class="ident" id="1571559">mp</span><span class="op" id="1571561">.</span><span class="ident" id="1571562">recent_free_bytes</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571583">mp</span><span class="op" id="1571585">.</span><span class="ident" id="1571586">recent_allocs</span>&nbsp;<span class="op" id="1571600">=</span>&nbsp;<span class="num" id="1571602">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571606">mp</span><span class="op" id="1571608">.</span><span class="ident" id="1571609">recent_frees</span>&nbsp;<span class="op" id="1571622">=</span>&nbsp;<span class="num" id="1571624">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571628">mp</span><span class="op" id="1571630">.</span><span class="ident" id="1571631">recent_alloc_bytes</span>&nbsp;<span class="op" id="1571650">=</span>&nbsp;<span class="num" id="1571652">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571656">mp</span><span class="op" id="1571658">.</span><span class="ident" id="1571659">recent_free_bytes</span>&nbsp;<span class="op" id="1571677">=</span>&nbsp;<span class="num" id="1571679">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1571682">}</span><br>
<span class="lineno">225</span><span class="op" id="1571684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1571687">//&nbsp;Record&nbsp;that&nbsp;a&nbsp;gc&nbsp;just&nbsp;happened:&nbsp;all&nbsp;the&nbsp;&#39;recent&#39;&nbsp;statistics&nbsp;are&nbsp;now&nbsp;real.</span><br>
<span class="lineno"></span><span class="keyword" id="1571764">func</span>&nbsp;<span class="ident" id="1571769">mProf_GC</span><span class="op" id="1571777">(</span><span class="op" id="1571778">)</span>&nbsp;<span class="op" id="1571780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571783">lock</span><span class="op" id="1571787">(</span><span class="op" id="1571788">&amp;</span><span class="ident" id="1571789">proflock</span><span class="op" id="1571797">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571800">mprof_GC</span><span class="op" id="1571808">(</span><span class="op" id="1571809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571812">unlock</span><span class="op" id="1571818">(</span><span class="op" id="1571819">&amp;</span><span class="ident" id="1571820">proflock</span><span class="op" id="1571828">)</span><br>
<span class="lineno"></span><span class="op" id="1571830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1571833">//&nbsp;Called&nbsp;by&nbsp;malloc&nbsp;to&nbsp;record&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno">235</span><span class="keyword" id="1571881">func</span>&nbsp;<span class="ident" id="1571886">mProf_Malloc</span><span class="op" id="1571898">(</span><span class="ident" id="1571899">p</span>&nbsp;<span class="ident" id="1571901">unsafe</span><span class="op" id="1571907">.</span><span class="ident" id="1571908">Pointer</span><span class="op" id="1571915">,</span>&nbsp;<span class="ident" id="1571917">size</span>&nbsp;<span class="builtintype" id="1571922">uintptr</span><span class="op" id="1571929">)</span>&nbsp;<span class="op" id="1571931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1571934">var</span>&nbsp;<span class="ident" id="1571938">stk</span>&nbsp;<span class="op" id="1571942">[</span><span class="ident" id="1571943">maxStack</span><span class="op" id="1571951">]</span><span class="builtintype" id="1571952">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1571961">nstk</span>&nbsp;<span class="op" id="1571966">:=</span>&nbsp;<span class="ident" id="1571969">callers</span><span class="op" id="1571976">(</span><span class="num" id="1571977">4</span><span class="op" id="1571978">,</span>&nbsp;<span class="op" id="1571980">&amp;</span><span class="ident" id="1571981">stk</span><span class="op" id="1571984">[</span><span class="num" id="1571985">0</span><span class="op" id="1571986">]</span><span class="op" id="1571987">,</span>&nbsp;<span class="builtinfunc" id="1571989">len</span><span class="op" id="1571992">(</span><span class="ident" id="1571993">stk</span><span class="op" id="1571996">)</span><span class="op" id="1571997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572000">lock</span><span class="op" id="1572004">(</span><span class="op" id="1572005">&amp;</span><span class="ident" id="1572006">proflock</span><span class="op" id="1572014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572017">b</span>&nbsp;<span class="op" id="1572019">:=</span>&nbsp;<span class="ident" id="1572022">stkbucket</span><span class="op" id="1572031">(</span><span class="ident" id="1572032">memProfile</span><span class="op" id="1572042">,</span>&nbsp;<span class="ident" id="1572044">size</span><span class="op" id="1572048">,</span>&nbsp;<span class="ident" id="1572050">stk</span><span class="op" id="1572053">[</span><span class="op" id="1572054">:</span><span class="ident" id="1572055">nstk</span><span class="op" id="1572059">]</span><span class="op" id="1572060">,</span>&nbsp;<span class="builtintype" id="1572062">true</span><span class="op" id="1572066">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572069">mp</span>&nbsp;<span class="op" id="1572072">:=</span>&nbsp;<span class="ident" id="1572075">b</span><span class="op" id="1572076">.</span><span class="ident" id="1572077">mp</span><span class="op" id="1572079">(</span><span class="op" id="1572080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572083">mp</span><span class="op" id="1572085">.</span><span class="ident" id="1572086">recent_allocs</span><span class="op" id="1572099">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572103">mp</span><span class="op" id="1572105">.</span><span class="ident" id="1572106">recent_alloc_bytes</span>&nbsp;<span class="op" id="1572125">+=</span>&nbsp;<span class="ident" id="1572128">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572134">unlock</span><span class="op" id="1572140">(</span><span class="op" id="1572141">&amp;</span><span class="ident" id="1572142">proflock</span><span class="op" id="1572150">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572154">//&nbsp;Setprofilebucket&nbsp;locks&nbsp;a&nbsp;bunch&nbsp;of&nbsp;other&nbsp;mutexes,&nbsp;so&nbsp;we&nbsp;call&nbsp;it&nbsp;outside&nbsp;of&nbsp;proflock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572242">//&nbsp;This&nbsp;reduces&nbsp;potential&nbsp;contention&nbsp;and&nbsp;chances&nbsp;of&nbsp;deadlocks.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572306">//&nbsp;Since&nbsp;the&nbsp;object&nbsp;must&nbsp;be&nbsp;alive&nbsp;during&nbsp;call&nbsp;to&nbsp;mProf_Malloc,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1572370">//&nbsp;it&#39;s&nbsp;fine&nbsp;to&nbsp;do&nbsp;this&nbsp;non-atomically.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572411">setprofilebucket</span><span class="op" id="1572427">(</span><span class="ident" id="1572428">p</span><span class="op" id="1572429">,</span>&nbsp;<span class="ident" id="1572431">b</span><span class="op" id="1572432">)</span><br>
<span class="lineno">250</span><span class="op" id="1572434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1572437">func</span>&nbsp;<span class="ident" id="1572442">setprofilebucket_m</span><span class="op" id="1572460">(</span><span class="op" id="1572461">)</span>&nbsp;<span class="comment" id="1572463">//&nbsp;mheap.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1572475">func</span>&nbsp;<span class="ident" id="1572480">setprofilebucket</span><span class="op" id="1572496">(</span><span class="ident" id="1572497">p</span>&nbsp;<span class="ident" id="1572499">unsafe</span><span class="op" id="1572505">.</span><span class="ident" id="1572506">Pointer</span><span class="op" id="1572513">,</span>&nbsp;<span class="ident" id="1572515">b</span>&nbsp;<span class="op" id="1572517">*</span><span class="ident" id="1572518">bucket</span><span class="op" id="1572524">)</span>&nbsp;<span class="op" id="1572526">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572529">g</span>&nbsp;<span class="op" id="1572531">:=</span>&nbsp;<span class="ident" id="1572534">getg</span><span class="op" id="1572538">(</span><span class="op" id="1572539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572542">g</span><span class="op" id="1572543">.</span><span class="ident" id="1572544">m</span><span class="op" id="1572545">.</span><span class="ident" id="1572546">ptrarg</span><span class="op" id="1572552">[</span><span class="num" id="1572553">0</span><span class="op" id="1572554">]</span>&nbsp;<span class="op" id="1572556">=</span>&nbsp;<span class="ident" id="1572558">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572561">g</span><span class="op" id="1572562">.</span><span class="ident" id="1572563">m</span><span class="op" id="1572564">.</span><span class="ident" id="1572565">ptrarg</span><span class="op" id="1572571">[</span><span class="num" id="1572572">1</span><span class="op" id="1572573">]</span>&nbsp;<span class="op" id="1572575">=</span>&nbsp;<span class="ident" id="1572577">unsafe</span><span class="op" id="1572583">.</span><span class="ident" id="1572584">Pointer</span><span class="op" id="1572591">(</span><span class="ident" id="1572592">b</span><span class="op" id="1572593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572596">onM</span><span class="op" id="1572599">(</span><span class="ident" id="1572600">setprofilebucket_m</span><span class="op" id="1572618">)</span><br>
<span class="lineno"></span><span class="op" id="1572620">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="1572623">//&nbsp;Called&nbsp;when&nbsp;freeing&nbsp;a&nbsp;profiled&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="1572664">func</span>&nbsp;<span class="ident" id="1572669">mProf_Free</span><span class="op" id="1572679">(</span><span class="ident" id="1572680">b</span>&nbsp;<span class="op" id="1572682">*</span><span class="ident" id="1572683">bucket</span><span class="op" id="1572689">,</span>&nbsp;<span class="ident" id="1572691">size</span>&nbsp;<span class="builtintype" id="1572696">uintptr</span><span class="op" id="1572703">,</span>&nbsp;<span class="ident" id="1572705">freed</span>&nbsp;<span class="builtintype" id="1572711">bool</span><span class="op" id="1572715">)</span>&nbsp;<span class="op" id="1572717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572720">lock</span><span class="op" id="1572724">(</span><span class="op" id="1572725">&amp;</span><span class="ident" id="1572726">proflock</span><span class="op" id="1572734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572737">mp</span>&nbsp;<span class="op" id="1572740">:=</span>&nbsp;<span class="ident" id="1572743">b</span><span class="op" id="1572744">.</span><span class="ident" id="1572745">mp</span><span class="op" id="1572747">(</span><span class="op" id="1572748">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1572751">if</span>&nbsp;<span class="ident" id="1572754">freed</span>&nbsp;<span class="op" id="1572760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572764">mp</span><span class="op" id="1572766">.</span><span class="ident" id="1572767">recent_frees</span><span class="op" id="1572779">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572784">mp</span><span class="op" id="1572786">.</span><span class="ident" id="1572787">recent_free_bytes</span>&nbsp;<span class="op" id="1572805">+=</span>&nbsp;<span class="ident" id="1572808">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572814">}</span>&nbsp;<span class="keyword" id="1572816">else</span>&nbsp;<span class="op" id="1572821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572825">mp</span><span class="op" id="1572827">.</span><span class="ident" id="1572828">prev_frees</span><span class="op" id="1572838">++</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572843">mp</span><span class="op" id="1572845">.</span><span class="ident" id="1572846">prev_free_bytes</span>&nbsp;<span class="op" id="1572862">+=</span>&nbsp;<span class="ident" id="1572865">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1572871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1572874">unlock</span><span class="op" id="1572880">(</span><span class="op" id="1572881">&amp;</span><span class="ident" id="1572882">proflock</span><span class="op" id="1572890">)</span><br>
<span class="lineno"></span><span class="op" id="1572892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="1572895">var</span>&nbsp;<span class="ident" id="1572899">blockprofilerate</span>&nbsp;<span class="ident" id="1572916">uint64</span>&nbsp;<span class="comment" id="1572923">//&nbsp;in&nbsp;CPU&nbsp;ticks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1572940">//&nbsp;SetBlockProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;goroutine&nbsp;blocking&nbsp;events</span><br>
<span class="lineno"></span><span class="comment" id="1573014">//&nbsp;that&nbsp;are&nbsp;reported&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.&nbsp;&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample</span><br>
<span class="lineno"></span><span class="comment" id="1573089">//&nbsp;an&nbsp;average&nbsp;of&nbsp;one&nbsp;blocking&nbsp;event&nbsp;per&nbsp;rate&nbsp;nanoseconds&nbsp;spent&nbsp;blocked.</span><br>
<span class="lineno">280</span><span class="comment" id="1573161">//</span><br>
<span class="lineno"></span><span class="comment" id="1573164">//&nbsp;To&nbsp;include&nbsp;every&nbsp;blocking&nbsp;event&nbsp;in&nbsp;the&nbsp;profile,&nbsp;pass&nbsp;rate&nbsp;=&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1573230">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;pass&nbsp;rate&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="1573281">func</span>&nbsp;<span class="ident" id="1573286">SetBlockProfileRate</span><span class="op" id="1573305">(</span><span class="ident" id="1573306">rate</span>&nbsp;<span class="builtintype" id="1573311">int</span><span class="op" id="1573314">)</span>&nbsp;<span class="op" id="1573316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573319">var</span>&nbsp;<span class="ident" id="1573323">r</span>&nbsp;<span class="ident" id="1573325">int64</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573332">if</span>&nbsp;<span class="ident" id="1573335">rate</span>&nbsp;<span class="op" id="1573340">&lt;=</span>&nbsp;<span class="num" id="1573343">0</span>&nbsp;<span class="op" id="1573345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573349">r</span>&nbsp;<span class="op" id="1573351">=</span>&nbsp;<span class="num" id="1573353">0</span>&nbsp;<span class="comment" id="1573355">//&nbsp;disable&nbsp;profiling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573377">}</span>&nbsp;<span class="keyword" id="1573379">else</span>&nbsp;<span class="keyword" id="1573384">if</span>&nbsp;<span class="ident" id="1573387">rate</span>&nbsp;<span class="op" id="1573392">==</span>&nbsp;<span class="num" id="1573395">1</span>&nbsp;<span class="op" id="1573397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573401">r</span>&nbsp;<span class="op" id="1573403">=</span>&nbsp;<span class="num" id="1573405">1</span>&nbsp;<span class="comment" id="1573407">//&nbsp;profile&nbsp;everything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573430">}</span>&nbsp;<span class="keyword" id="1573432">else</span>&nbsp;<span class="op" id="1573437">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1573441">//&nbsp;convert&nbsp;ns&nbsp;to&nbsp;cycles,&nbsp;use&nbsp;float64&nbsp;to&nbsp;prevent&nbsp;overflow&nbsp;during&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573522">r</span>&nbsp;<span class="op" id="1573524">=</span>&nbsp;<span class="ident" id="1573526">int64</span><span class="op" id="1573531">(</span><span class="builtintype" id="1573532">float64</span><span class="op" id="1573539">(</span><span class="ident" id="1573540">rate</span><span class="op" id="1573544">)</span>&nbsp;<span class="op" id="1573546">*</span>&nbsp;<span class="builtintype" id="1573548">float64</span><span class="op" id="1573555">(</span><span class="ident" id="1573556">tickspersecond</span><span class="op" id="1573570">(</span><span class="op" id="1573571">)</span><span class="op" id="1573572">)</span>&nbsp;<span class="op" id="1573574">/</span>&nbsp;<span class="op" id="1573576">(</span><span class="num" id="1573577">1000</span>&nbsp;<span class="op" id="1573582">*</span>&nbsp;<span class="num" id="1573584">1000</span>&nbsp;<span class="op" id="1573589">*</span>&nbsp;<span class="num" id="1573591">1000</span><span class="op" id="1573595">)</span><span class="op" id="1573596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573600">if</span>&nbsp;<span class="ident" id="1573603">r</span>&nbsp;<span class="op" id="1573605">==</span>&nbsp;<span class="num" id="1573608">0</span>&nbsp;<span class="op" id="1573610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573615">r</span>&nbsp;<span class="op" id="1573617">=</span>&nbsp;<span class="num" id="1573619">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573623">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573630">atomicstore64</span><span class="op" id="1573643">(</span><span class="op" id="1573644">&amp;</span><span class="ident" id="1573645">blockprofilerate</span><span class="op" id="1573661">,</span>&nbsp;<span class="ident" id="1573663">uint64</span><span class="op" id="1573669">(</span><span class="ident" id="1573670">r</span><span class="op" id="1573671">)</span><span class="op" id="1573672">)</span><br>
<span class="lineno"></span><span class="op" id="1573674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="keyword" id="1573677">func</span>&nbsp;<span class="ident" id="1573682">blockevent</span><span class="op" id="1573692">(</span><span class="ident" id="1573693">cycles</span>&nbsp;<span class="ident" id="1573700">int64</span><span class="op" id="1573705">,</span>&nbsp;<span class="ident" id="1573707">skip</span>&nbsp;<span class="builtintype" id="1573712">int</span><span class="op" id="1573715">)</span>&nbsp;<span class="op" id="1573717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573720">if</span>&nbsp;<span class="ident" id="1573723">cycles</span>&nbsp;<span class="op" id="1573730">&lt;=</span>&nbsp;<span class="num" id="1573733">0</span>&nbsp;<span class="op" id="1573735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573739">cycles</span>&nbsp;<span class="op" id="1573746">=</span>&nbsp;<span class="num" id="1573748">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573754">rate</span>&nbsp;<span class="op" id="1573759">:=</span>&nbsp;<span class="ident" id="1573762">int64</span><span class="op" id="1573767">(</span><span class="ident" id="1573768">atomicload64</span><span class="op" id="1573780">(</span><span class="op" id="1573781">&amp;</span><span class="ident" id="1573782">blockprofilerate</span><span class="op" id="1573798">)</span><span class="op" id="1573799">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573802">if</span>&nbsp;<span class="ident" id="1573805">rate</span>&nbsp;<span class="op" id="1573810">&lt;=</span>&nbsp;<span class="num" id="1573813">0</span>&nbsp;<span class="op" id="1573815">||</span>&nbsp;<span class="op" id="1573818">(</span><span class="ident" id="1573819">rate</span>&nbsp;<span class="op" id="1573824">&gt;</span>&nbsp;<span class="ident" id="1573826">cycles</span>&nbsp;<span class="op" id="1573833">&amp;&amp;</span>&nbsp;<span class="ident" id="1573836">int64</span><span class="op" id="1573841">(</span><span class="ident" id="1573842">fastrand1</span><span class="op" id="1573851">(</span><span class="op" id="1573852">)</span><span class="op" id="1573853">)</span><span class="op" id="1573854">%</span><span class="ident" id="1573855">rate</span>&nbsp;<span class="op" id="1573860">&gt;</span>&nbsp;<span class="ident" id="1573862">cycles</span><span class="op" id="1573868">)</span>&nbsp;<span class="op" id="1573870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573874">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1573882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573885">gp</span>&nbsp;<span class="op" id="1573888">:=</span>&nbsp;<span class="ident" id="1573891">getg</span><span class="op" id="1573895">(</span><span class="op" id="1573896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573899">var</span>&nbsp;<span class="ident" id="1573903">nstk</span>&nbsp;<span class="builtintype" id="1573908">int</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573913">var</span>&nbsp;<span class="ident" id="1573917">stk</span>&nbsp;<span class="op" id="1573921">[</span><span class="ident" id="1573922">maxStack</span><span class="op" id="1573930">]</span><span class="builtintype" id="1573931">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1573940">if</span>&nbsp;<span class="ident" id="1573943">gp</span><span class="op" id="1573945">.</span><span class="ident" id="1573946">m</span><span class="op" id="1573947">.</span><span class="ident" id="1573948">curg</span>&nbsp;<span class="op" id="1573953">==</span>&nbsp;<span class="ident" id="1573956">nil</span>&nbsp;<span class="op" id="1573960">||</span>&nbsp;<span class="ident" id="1573963">gp</span><span class="op" id="1573965">.</span><span class="ident" id="1573966">m</span><span class="op" id="1573967">.</span><span class="ident" id="1573968">curg</span>&nbsp;<span class="op" id="1573973">==</span>&nbsp;<span class="ident" id="1573976">gp</span>&nbsp;<span class="op" id="1573979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1573983">nstk</span>&nbsp;<span class="op" id="1573988">=</span>&nbsp;<span class="ident" id="1573990">callers</span><span class="op" id="1573997">(</span><span class="ident" id="1573998">skip</span><span class="op" id="1574002">,</span>&nbsp;<span class="op" id="1574004">&amp;</span><span class="ident" id="1574005">stk</span><span class="op" id="1574008">[</span><span class="num" id="1574009">0</span><span class="op" id="1574010">]</span><span class="op" id="1574011">,</span>&nbsp;<span class="builtinfunc" id="1574013">len</span><span class="op" id="1574016">(</span><span class="ident" id="1574017">stk</span><span class="op" id="1574020">)</span><span class="op" id="1574021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574024">}</span>&nbsp;<span class="keyword" id="1574026">else</span>&nbsp;<span class="op" id="1574031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574035">nstk</span>&nbsp;<span class="op" id="1574040">=</span>&nbsp;<span class="ident" id="1574042">gcallers</span><span class="op" id="1574050">(</span><span class="ident" id="1574051">gp</span><span class="op" id="1574053">.</span><span class="ident" id="1574054">m</span><span class="op" id="1574055">.</span><span class="ident" id="1574056">curg</span><span class="op" id="1574060">,</span>&nbsp;<span class="ident" id="1574062">skip</span><span class="op" id="1574066">,</span>&nbsp;<span class="op" id="1574068">&amp;</span><span class="ident" id="1574069">stk</span><span class="op" id="1574072">[</span><span class="num" id="1574073">0</span><span class="op" id="1574074">]</span><span class="op" id="1574075">,</span>&nbsp;<span class="builtinfunc" id="1574077">len</span><span class="op" id="1574080">(</span><span class="ident" id="1574081">stk</span><span class="op" id="1574084">)</span><span class="op" id="1574085">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574091">lock</span><span class="op" id="1574095">(</span><span class="op" id="1574096">&amp;</span><span class="ident" id="1574097">proflock</span><span class="op" id="1574105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574108">b</span>&nbsp;<span class="op" id="1574110">:=</span>&nbsp;<span class="ident" id="1574113">stkbucket</span><span class="op" id="1574122">(</span><span class="ident" id="1574123">blockProfile</span><span class="op" id="1574135">,</span>&nbsp;<span class="num" id="1574137">0</span><span class="op" id="1574138">,</span>&nbsp;<span class="ident" id="1574140">stk</span><span class="op" id="1574143">[</span><span class="op" id="1574144">:</span><span class="ident" id="1574145">nstk</span><span class="op" id="1574149">]</span><span class="op" id="1574150">,</span>&nbsp;<span class="builtintype" id="1574152">true</span><span class="op" id="1574156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574159">b</span><span class="op" id="1574160">.</span><span class="ident" id="1574161">bp</span><span class="op" id="1574163">(</span><span class="op" id="1574164">)</span><span class="op" id="1574165">.</span><span class="ident" id="1574166">count</span><span class="op" id="1574171">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574175">b</span><span class="op" id="1574176">.</span><span class="ident" id="1574177">bp</span><span class="op" id="1574179">(</span><span class="op" id="1574180">)</span><span class="op" id="1574181">.</span><span class="ident" id="1574182">cycles</span>&nbsp;<span class="op" id="1574189">+=</span>&nbsp;<span class="ident" id="1574192">cycles</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574200">unlock</span><span class="op" id="1574206">(</span><span class="op" id="1574207">&amp;</span><span class="ident" id="1574208">proflock</span><span class="op" id="1574216">)</span><br>
<span class="lineno"></span><span class="op" id="1574218">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1574221">//&nbsp;Go&nbsp;interface&nbsp;to&nbsp;profile&nbsp;data.</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="1574255">//&nbsp;A&nbsp;StackRecord&nbsp;describes&nbsp;a&nbsp;single&nbsp;execution&nbsp;stack.</span><br>
<span class="lineno"></span><span class="keyword" id="1574308">type</span>&nbsp;<span class="ident" id="1574313">StackRecord</span>&nbsp;<span class="keyword" id="1574325">struct</span>&nbsp;<span class="op" id="1574332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1574335">Stack0</span>&nbsp;<span class="op" id="1574342">[</span><span class="num" id="1574343">32</span><span class="op" id="1574345">]</span><span class="builtintype" id="1574346">uintptr</span>&nbsp;<span class="comment" id="1574354">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1574408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="1574411">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1574472">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno"></span><span class="keyword" id="1574497">func</span>&nbsp;<span class="op" id="1574502">(</span><span class="ident" id="1574503">r</span>&nbsp;<span class="op" id="1574505">*</span><span class="ident" id="1574506">StackRecord</span><span class="op" id="1574517">)</span>&nbsp;<span class="ident" id="1574519">Stack</span><span class="op" id="1574524">(</span><span class="op" id="1574525">)</span>&nbsp;<span class="op" id="1574527">[</span><span class="op" id="1574528">]</span><span class="builtintype" id="1574529">uintptr</span>&nbsp;<span class="op" id="1574537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574540">for</span>&nbsp;<span class="ident" id="1574544">i</span><span class="op" id="1574545">,</span>&nbsp;<span class="ident" id="1574547">v</span>&nbsp;<span class="op" id="1574549">:=</span>&nbsp;<span class="keyword" id="1574552">range</span>&nbsp;<span class="ident" id="1574558">r</span><span class="op" id="1574559">.</span><span class="ident" id="1574560">Stack0</span>&nbsp;<span class="op" id="1574567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574571">if</span>&nbsp;<span class="ident" id="1574574">v</span>&nbsp;<span class="op" id="1574576">==</span>&nbsp;<span class="num" id="1574579">0</span>&nbsp;<span class="op" id="1574581">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574586">return</span>&nbsp;<span class="ident" id="1574593">r</span><span class="op" id="1574594">.</span><span class="ident" id="1574595">Stack0</span><span class="op" id="1574601">[</span><span class="num" id="1574602">0</span><span class="op" id="1574603">:</span><span class="ident" id="1574604">i</span><span class="op" id="1574605">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1574612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1574615">return</span>&nbsp;<span class="ident" id="1574622">r</span><span class="op" id="1574623">.</span><span class="ident" id="1574624">Stack0</span><span class="op" id="1574630">[</span><span class="num" id="1574631">0</span><span class="op" id="1574632">:</span><span class="op" id="1574633">]</span><br>
<span class="lineno"></span><span class="op" id="1574635">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment" id="1574638">//&nbsp;MemProfileRate&nbsp;controls&nbsp;the&nbsp;fraction&nbsp;of&nbsp;memory&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="1574700">//&nbsp;that&nbsp;are&nbsp;recorded&nbsp;and&nbsp;reported&nbsp;in&nbsp;the&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1574757">//&nbsp;The&nbsp;profiler&nbsp;aims&nbsp;to&nbsp;sample&nbsp;an&nbsp;average&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1574802">//&nbsp;one&nbsp;allocation&nbsp;per&nbsp;MemProfileRate&nbsp;bytes&nbsp;allocated.</span><br>
<span class="lineno">345</span><span class="comment" id="1574856">//</span><br>
<span class="lineno"></span><span class="comment" id="1574859">//&nbsp;To&nbsp;include&nbsp;every&nbsp;allocated&nbsp;block&nbsp;in&nbsp;the&nbsp;profile,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="1574936">//&nbsp;To&nbsp;turn&nbsp;off&nbsp;profiling&nbsp;entirely,&nbsp;set&nbsp;MemProfileRate&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment" id="1574996">//</span><br>
<span class="lineno"></span><span class="comment" id="1574999">//&nbsp;The&nbsp;tools&nbsp;that&nbsp;process&nbsp;the&nbsp;memory&nbsp;profiles&nbsp;assume&nbsp;that&nbsp;the</span><br>
<span class="lineno">350</span><span class="comment" id="1575061">//&nbsp;profile&nbsp;rate&nbsp;is&nbsp;constant&nbsp;across&nbsp;the&nbsp;lifetime&nbsp;of&nbsp;the&nbsp;program</span><br>
<span class="lineno"></span><span class="comment" id="1575124">//&nbsp;and&nbsp;equal&nbsp;to&nbsp;the&nbsp;current&nbsp;value.&nbsp;&nbsp;Programs&nbsp;that&nbsp;change&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1575185">//&nbsp;memory&nbsp;profiling&nbsp;rate&nbsp;should&nbsp;do&nbsp;so&nbsp;just&nbsp;once,&nbsp;as&nbsp;early&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1575246">//&nbsp;possible&nbsp;in&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;program&nbsp;(for&nbsp;example,</span><br>
<span class="lineno"></span><span class="comment" id="1575304">//&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;main).</span><br>
<span class="lineno">355</span><span class="keyword" id="1575334">var</span>&nbsp;<span class="ident" id="1575338">MemProfileRate</span>&nbsp;<span class="builtintype" id="1575353">int</span>&nbsp;<span class="op" id="1575357">=</span>&nbsp;<span class="num" id="1575359">512</span>&nbsp;<span class="op" id="1575363">*</span>&nbsp;<span class="num" id="1575365">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575371">//&nbsp;A&nbsp;MemProfileRecord&nbsp;describes&nbsp;the&nbsp;live&nbsp;objects&nbsp;allocated</span><br>
<span class="lineno"></span><span class="comment" id="1575430">//&nbsp;by&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1575478">type</span>&nbsp;<span class="ident" id="1575483">MemProfileRecord</span>&nbsp;<span class="keyword" id="1575500">struct</span>&nbsp;<span class="op" id="1575507">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575510">AllocBytes</span><span class="op" id="1575520">,</span>&nbsp;<span class="ident" id="1575522">FreeBytes</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575536">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575548">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575585">AllocObjects</span><span class="op" id="1575597">,</span>&nbsp;<span class="ident" id="1575599">FreeObjects</span>&nbsp;<span class="ident" id="1575611">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1575623">//&nbsp;number&nbsp;of&nbsp;objects&nbsp;allocated,&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1575662">Stack0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1575688">[</span><span class="num" id="1575689">32</span><span class="op" id="1575691">]</span><span class="builtintype" id="1575692">uintptr</span>&nbsp;<span class="comment" id="1575700">//&nbsp;stack&nbsp;trace&nbsp;for&nbsp;this&nbsp;record;&nbsp;ends&nbsp;at&nbsp;first&nbsp;0&nbsp;entry</span><br>
<span class="lineno"></span><span class="op" id="1575754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="1575757">//&nbsp;InUseBytes&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;in&nbsp;use&nbsp;(AllocBytes&nbsp;-&nbsp;FreeBytes).</span><br>
<span class="lineno"></span><span class="keyword" id="1575832">func</span>&nbsp;<span class="op" id="1575837">(</span><span class="ident" id="1575838">r</span>&nbsp;<span class="op" id="1575840">*</span><span class="ident" id="1575841">MemProfileRecord</span><span class="op" id="1575857">)</span>&nbsp;<span class="ident" id="1575859">InUseBytes</span><span class="op" id="1575869">(</span><span class="op" id="1575870">)</span>&nbsp;<span class="ident" id="1575872">int64</span>&nbsp;<span class="op" id="1575878">{</span>&nbsp;<span class="keyword" id="1575880">return</span>&nbsp;<span class="ident" id="1575887">r</span><span class="op" id="1575888">.</span><span class="ident" id="1575889">AllocBytes</span>&nbsp;<span class="op" id="1575900">-</span>&nbsp;<span class="ident" id="1575902">r</span><span class="op" id="1575903">.</span><span class="ident" id="1575904">FreeBytes</span>&nbsp;<span class="op" id="1575914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1575917">//&nbsp;InUseObjects&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;in&nbsp;use&nbsp;(AllocObjects&nbsp;-&nbsp;FreeObjects).</span><br>
<span class="lineno"></span><span class="keyword" id="1576000">func</span>&nbsp;<span class="op" id="1576005">(</span><span class="ident" id="1576006">r</span>&nbsp;<span class="op" id="1576008">*</span><span class="ident" id="1576009">MemProfileRecord</span><span class="op" id="1576025">)</span>&nbsp;<span class="ident" id="1576027">InUseObjects</span><span class="op" id="1576039">(</span><span class="op" id="1576040">)</span>&nbsp;<span class="ident" id="1576042">int64</span>&nbsp;<span class="op" id="1576048">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576051">return</span>&nbsp;<span class="ident" id="1576058">r</span><span class="op" id="1576059">.</span><span class="ident" id="1576060">AllocObjects</span>&nbsp;<span class="op" id="1576073">-</span>&nbsp;<span class="ident" id="1576075">r</span><span class="op" id="1576076">.</span><span class="ident" id="1576077">FreeObjects</span><br>
<span class="lineno"></span><span class="op" id="1576089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576092">//&nbsp;Stack&nbsp;returns&nbsp;the&nbsp;stack&nbsp;trace&nbsp;associated&nbsp;with&nbsp;the&nbsp;record,</span><br>
<span class="lineno"></span><span class="comment" id="1576153">//&nbsp;a&nbsp;prefix&nbsp;of&nbsp;r.Stack0.</span><br>
<span class="lineno">375</span><span class="keyword" id="1576178">func</span>&nbsp;<span class="op" id="1576183">(</span><span class="ident" id="1576184">r</span>&nbsp;<span class="op" id="1576186">*</span><span class="ident" id="1576187">MemProfileRecord</span><span class="op" id="1576203">)</span>&nbsp;<span class="ident" id="1576205">Stack</span><span class="op" id="1576210">(</span><span class="op" id="1576211">)</span>&nbsp;<span class="op" id="1576213">[</span><span class="op" id="1576214">]</span><span class="builtintype" id="1576215">uintptr</span>&nbsp;<span class="op" id="1576223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576226">for</span>&nbsp;<span class="ident" id="1576230">i</span><span class="op" id="1576231">,</span>&nbsp;<span class="ident" id="1576233">v</span>&nbsp;<span class="op" id="1576235">:=</span>&nbsp;<span class="keyword" id="1576238">range</span>&nbsp;<span class="ident" id="1576244">r</span><span class="op" id="1576245">.</span><span class="ident" id="1576246">Stack0</span>&nbsp;<span class="op" id="1576253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576257">if</span>&nbsp;<span class="ident" id="1576260">v</span>&nbsp;<span class="op" id="1576262">==</span>&nbsp;<span class="num" id="1576265">0</span>&nbsp;<span class="op" id="1576267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576272">return</span>&nbsp;<span class="ident" id="1576279">r</span><span class="op" id="1576280">.</span><span class="ident" id="1576281">Stack0</span><span class="op" id="1576287">[</span><span class="num" id="1576288">0</span><span class="op" id="1576289">:</span><span class="ident" id="1576290">i</span><span class="op" id="1576291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576295">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1576298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1576301">return</span>&nbsp;<span class="ident" id="1576308">r</span><span class="op" id="1576309">.</span><span class="ident" id="1576310">Stack0</span><span class="op" id="1576316">[</span><span class="num" id="1576317">0</span><span class="op" id="1576318">:</span><span class="op" id="1576319">]</span><br>
<span class="lineno"></span><span class="op" id="1576321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1576324">//&nbsp;MemProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;memory&nbsp;profile.</span><br>
<span class="lineno">385</span><span class="comment" id="1576402">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;MemProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1576479">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;MemProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1576548">//</span><br>
<span class="lineno"></span><span class="comment" id="1576551">//&nbsp;If&nbsp;inuseZero&nbsp;is&nbsp;true,&nbsp;the&nbsp;profile&nbsp;includes&nbsp;allocation&nbsp;records</span><br>
<span class="lineno"></span><span class="comment" id="1576616">//&nbsp;where&nbsp;r.AllocBytes&nbsp;&gt;&nbsp;0&nbsp;but&nbsp;r.AllocBytes&nbsp;==&nbsp;r.FreeBytes.</span><br>
<span class="lineno">390</span><span class="comment" id="1576675">//&nbsp;These&nbsp;are&nbsp;sites&nbsp;where&nbsp;memory&nbsp;was&nbsp;allocated,&nbsp;but&nbsp;it&nbsp;has&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="1576737">//&nbsp;been&nbsp;released&nbsp;back&nbsp;to&nbsp;the&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="1576775">//</span><br>
<span class="lineno"></span><span class="comment" id="1576778">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1576834">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.memprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno">395</span><span class="comment" id="1576889">//&nbsp;of&nbsp;calling&nbsp;MemProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1576924">func</span>&nbsp;<span class="ident" id="1576929">MemProfile</span><span class="op" id="1576939">(</span><span class="ident" id="1576940">p</span>&nbsp;<span class="op" id="1576942">[</span><span class="op" id="1576943">]</span><span class="ident" id="1576944">MemProfileRecord</span><span class="op" id="1576960">,</span>&nbsp;<span class="ident" id="1576962">inuseZero</span>&nbsp;<span class="builtintype" id="1576972">bool</span><span class="op" id="1576976">)</span>&nbsp;<span class="op" id="1576978">(</span><span class="ident" id="1576979">n</span>&nbsp;<span class="builtintype" id="1576981">int</span><span class="op" id="1576984">,</span>&nbsp;<span class="ident" id="1576986">ok</span>&nbsp;<span class="builtintype" id="1576989">bool</span><span class="op" id="1576993">)</span>&nbsp;<span class="op" id="1576995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1576998">lock</span><span class="op" id="1577002">(</span><span class="op" id="1577003">&amp;</span><span class="ident" id="1577004">proflock</span><span class="op" id="1577012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577015">clear</span>&nbsp;<span class="op" id="1577021">:=</span>&nbsp;<span class="builtintype" id="1577024">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577030">for</span>&nbsp;<span class="ident" id="1577034">b</span>&nbsp;<span class="op" id="1577036">:=</span>&nbsp;<span class="ident" id="1577039">mbuckets</span><span class="op" id="1577047">;</span>&nbsp;<span class="ident" id="1577049">b</span>&nbsp;<span class="op" id="1577051">!=</span>&nbsp;<span class="ident" id="1577054">nil</span><span class="op" id="1577057">;</span>&nbsp;<span class="ident" id="1577059">b</span>&nbsp;<span class="op" id="1577061">=</span>&nbsp;<span class="ident" id="1577063">b</span><span class="op" id="1577064">.</span><span class="ident" id="1577065">allnext</span>&nbsp;<span class="op" id="1577073">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577077">mp</span>&nbsp;<span class="op" id="1577080">:=</span>&nbsp;<span class="ident" id="1577083">b</span><span class="op" id="1577084">.</span><span class="ident" id="1577085">mp</span><span class="op" id="1577087">(</span><span class="op" id="1577088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577092">if</span>&nbsp;<span class="ident" id="1577095">inuseZero</span>&nbsp;<span class="op" id="1577105">||</span>&nbsp;<span class="ident" id="1577108">mp</span><span class="op" id="1577110">.</span><span class="ident" id="1577111">alloc_bytes</span>&nbsp;<span class="op" id="1577123">!=</span>&nbsp;<span class="ident" id="1577126">mp</span><span class="op" id="1577128">.</span><span class="ident" id="1577129">free_bytes</span>&nbsp;<span class="op" id="1577140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577145">n</span><span class="op" id="1577146">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577155">if</span>&nbsp;<span class="ident" id="1577158">mp</span><span class="op" id="1577160">.</span><span class="ident" id="1577161">allocs</span>&nbsp;<span class="op" id="1577168">!=</span>&nbsp;<span class="num" id="1577171">0</span>&nbsp;<span class="op" id="1577173">||</span>&nbsp;<span class="ident" id="1577176">mp</span><span class="op" id="1577178">.</span><span class="ident" id="1577179">frees</span>&nbsp;<span class="op" id="1577185">!=</span>&nbsp;<span class="num" id="1577188">0</span>&nbsp;<span class="op" id="1577190">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577195">clear</span>&nbsp;<span class="op" id="1577201">=</span>&nbsp;<span class="builtintype" id="1577203">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577217">if</span>&nbsp;<span class="ident" id="1577220">clear</span>&nbsp;<span class="op" id="1577226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1577230">//&nbsp;Absolutely&nbsp;no&nbsp;data,&nbsp;suggesting&nbsp;that&nbsp;a&nbsp;garbage&nbsp;collection</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1577292">//&nbsp;has&nbsp;not&nbsp;yet&nbsp;happened.&nbsp;In&nbsp;order&nbsp;to&nbsp;allow&nbsp;profiling&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1577352">//&nbsp;garbage&nbsp;collection&nbsp;is&nbsp;disabled&nbsp;from&nbsp;the&nbsp;beginning&nbsp;of&nbsp;execution,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1577421">//&nbsp;accumulate&nbsp;stats&nbsp;as&nbsp;if&nbsp;a&nbsp;GC&nbsp;just&nbsp;happened,&nbsp;and&nbsp;recount&nbsp;buckets.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577490">mprof_GC</span><span class="op" id="1577498">(</span><span class="op" id="1577499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577503">mprof_GC</span><span class="op" id="1577511">(</span><span class="op" id="1577512">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577516">n</span>&nbsp;<span class="op" id="1577518">=</span>&nbsp;<span class="num" id="1577520">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577524">for</span>&nbsp;<span class="ident" id="1577528">b</span>&nbsp;<span class="op" id="1577530">:=</span>&nbsp;<span class="ident" id="1577533">mbuckets</span><span class="op" id="1577541">;</span>&nbsp;<span class="ident" id="1577543">b</span>&nbsp;<span class="op" id="1577545">!=</span>&nbsp;<span class="ident" id="1577548">nil</span><span class="op" id="1577551">;</span>&nbsp;<span class="ident" id="1577553">b</span>&nbsp;<span class="op" id="1577555">=</span>&nbsp;<span class="ident" id="1577557">b</span><span class="op" id="1577558">.</span><span class="ident" id="1577559">allnext</span>&nbsp;<span class="op" id="1577567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577572">mp</span>&nbsp;<span class="op" id="1577575">:=</span>&nbsp;<span class="ident" id="1577578">b</span><span class="op" id="1577579">.</span><span class="ident" id="1577580">mp</span><span class="op" id="1577582">(</span><span class="op" id="1577583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577588">if</span>&nbsp;<span class="ident" id="1577591">inuseZero</span>&nbsp;<span class="op" id="1577601">||</span>&nbsp;<span class="ident" id="1577604">mp</span><span class="op" id="1577606">.</span><span class="ident" id="1577607">alloc_bytes</span>&nbsp;<span class="op" id="1577619">!=</span>&nbsp;<span class="ident" id="1577622">mp</span><span class="op" id="1577624">.</span><span class="ident" id="1577625">free_bytes</span>&nbsp;<span class="op" id="1577636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577642">n</span><span class="op" id="1577643">++</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577659">if</span>&nbsp;<span class="ident" id="1577662">n</span>&nbsp;<span class="op" id="1577664">&lt;=</span>&nbsp;<span class="builtinfunc" id="1577667">len</span><span class="op" id="1577670">(</span><span class="ident" id="1577671">p</span><span class="op" id="1577672">)</span>&nbsp;<span class="op" id="1577674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577678">ok</span>&nbsp;<span class="op" id="1577681">=</span>&nbsp;<span class="builtintype" id="1577683">true</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577690">idx</span>&nbsp;<span class="op" id="1577694">:=</span>&nbsp;<span class="num" id="1577697">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577701">for</span>&nbsp;<span class="ident" id="1577705">b</span>&nbsp;<span class="op" id="1577707">:=</span>&nbsp;<span class="ident" id="1577710">mbuckets</span><span class="op" id="1577718">;</span>&nbsp;<span class="ident" id="1577720">b</span>&nbsp;<span class="op" id="1577722">!=</span>&nbsp;<span class="ident" id="1577725">nil</span><span class="op" id="1577728">;</span>&nbsp;<span class="ident" id="1577730">b</span>&nbsp;<span class="op" id="1577732">=</span>&nbsp;<span class="ident" id="1577734">b</span><span class="op" id="1577735">.</span><span class="ident" id="1577736">allnext</span>&nbsp;<span class="op" id="1577744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577749">mp</span>&nbsp;<span class="op" id="1577752">:=</span>&nbsp;<span class="ident" id="1577755">b</span><span class="op" id="1577756">.</span><span class="ident" id="1577757">mp</span><span class="op" id="1577759">(</span><span class="op" id="1577760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577765">if</span>&nbsp;<span class="ident" id="1577768">inuseZero</span>&nbsp;<span class="op" id="1577778">||</span>&nbsp;<span class="ident" id="1577781">mp</span><span class="op" id="1577783">.</span><span class="ident" id="1577784">alloc_bytes</span>&nbsp;<span class="op" id="1577796">!=</span>&nbsp;<span class="ident" id="1577799">mp</span><span class="op" id="1577801">.</span><span class="ident" id="1577802">free_bytes</span>&nbsp;<span class="op" id="1577813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577819">record</span><span class="op" id="1577825">(</span><span class="op" id="1577826">&amp;</span><span class="ident" id="1577827">p</span><span class="op" id="1577828">[</span><span class="ident" id="1577829">idx</span><span class="op" id="1577832">]</span><span class="op" id="1577833">,</span>&nbsp;<span class="ident" id="1577835">b</span><span class="op" id="1577836">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577842">idx</span><span class="op" id="1577845">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1577858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577861">unlock</span><span class="op" id="1577867">(</span><span class="op" id="1577868">&amp;</span><span class="ident" id="1577869">proflock</span><span class="op" id="1577877">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1577880">return</span><br>
<span class="lineno"></span><span class="op" id="1577887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1577890">//&nbsp;Write&nbsp;b&#39;s&nbsp;data&nbsp;to&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="1577914">func</span>&nbsp;<span class="ident" id="1577919">record</span><span class="op" id="1577925">(</span><span class="ident" id="1577926">r</span>&nbsp;<span class="op" id="1577928">*</span><span class="ident" id="1577929">MemProfileRecord</span><span class="op" id="1577945">,</span>&nbsp;<span class="ident" id="1577947">b</span>&nbsp;<span class="op" id="1577949">*</span><span class="ident" id="1577950">bucket</span><span class="op" id="1577956">)</span>&nbsp;<span class="op" id="1577958">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577961">mp</span>&nbsp;<span class="op" id="1577964">:=</span>&nbsp;<span class="ident" id="1577967">b</span><span class="op" id="1577968">.</span><span class="ident" id="1577969">mp</span><span class="op" id="1577971">(</span><span class="op" id="1577972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1577975">r</span><span class="op" id="1577976">.</span><span class="ident" id="1577977">AllocBytes</span>&nbsp;<span class="op" id="1577988">=</span>&nbsp;<span class="ident" id="1577990">int64</span><span class="op" id="1577995">(</span><span class="ident" id="1577996">mp</span><span class="op" id="1577998">.</span><span class="ident" id="1577999">alloc_bytes</span><span class="op" id="1578010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578013">r</span><span class="op" id="1578014">.</span><span class="ident" id="1578015">FreeBytes</span>&nbsp;<span class="op" id="1578025">=</span>&nbsp;<span class="ident" id="1578027">int64</span><span class="op" id="1578032">(</span><span class="ident" id="1578033">mp</span><span class="op" id="1578035">.</span><span class="ident" id="1578036">free_bytes</span><span class="op" id="1578046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578049">r</span><span class="op" id="1578050">.</span><span class="ident" id="1578051">AllocObjects</span>&nbsp;<span class="op" id="1578064">=</span>&nbsp;<span class="ident" id="1578066">int64</span><span class="op" id="1578071">(</span><span class="ident" id="1578072">mp</span><span class="op" id="1578074">.</span><span class="ident" id="1578075">allocs</span><span class="op" id="1578081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578084">r</span><span class="op" id="1578085">.</span><span class="ident" id="1578086">FreeObjects</span>&nbsp;<span class="op" id="1578098">=</span>&nbsp;<span class="ident" id="1578100">int64</span><span class="op" id="1578105">(</span><span class="ident" id="1578106">mp</span><span class="op" id="1578108">.</span><span class="ident" id="1578109">frees</span><span class="op" id="1578114">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1578117">copy</span><span class="op" id="1578121">(</span><span class="ident" id="1578122">r</span><span class="op" id="1578123">.</span><span class="ident" id="1578124">Stack0</span><span class="op" id="1578130">[</span><span class="op" id="1578131">:</span><span class="op" id="1578132">]</span><span class="op" id="1578133">,</span>&nbsp;<span class="ident" id="1578135">b</span><span class="op" id="1578136">.</span><span class="ident" id="1578137">stk</span><span class="op" id="1578140">(</span><span class="op" id="1578141">)</span><span class="op" id="1578142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1578145">for</span>&nbsp;<span class="ident" id="1578149">i</span>&nbsp;<span class="op" id="1578151">:=</span>&nbsp;<span class="builtintype" id="1578154">int</span><span class="op" id="1578157">(</span><span class="ident" id="1578158">b</span><span class="op" id="1578159">.</span><span class="ident" id="1578160">nstk</span><span class="op" id="1578164">)</span><span class="op" id="1578165">;</span>&nbsp;<span class="ident" id="1578167">i</span>&nbsp;<span class="op" id="1578169">&lt;</span>&nbsp;<span class="builtinfunc" id="1578171">len</span><span class="op" id="1578174">(</span><span class="ident" id="1578175">r</span><span class="op" id="1578176">.</span><span class="ident" id="1578177">Stack0</span><span class="op" id="1578183">)</span><span class="op" id="1578184">;</span>&nbsp;<span class="ident" id="1578186">i</span><span class="op" id="1578187">++</span>&nbsp;<span class="op" id="1578190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578194">r</span><span class="op" id="1578195">.</span><span class="ident" id="1578196">Stack0</span><span class="op" id="1578202">[</span><span class="ident" id="1578203">i</span><span class="op" id="1578204">]</span>&nbsp;<span class="op" id="1578206">=</span>&nbsp;<span class="num" id="1578208">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1578211">}</span><br>
<span class="lineno"></span><span class="op" id="1578213">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span><span class="keyword" id="1578216">func</span>&nbsp;<span class="ident" id="1578221">iterate_memprof</span><span class="op" id="1578236">(</span><span class="ident" id="1578237">fn</span>&nbsp;<span class="keyword" id="1578240">func</span><span class="op" id="1578244">(</span><span class="op" id="1578245">*</span><span class="ident" id="1578246">bucket</span><span class="op" id="1578252">,</span>&nbsp;<span class="builtintype" id="1578254">uintptr</span><span class="op" id="1578261">,</span>&nbsp;<span class="op" id="1578263">*</span><span class="builtintype" id="1578264">uintptr</span><span class="op" id="1578271">,</span>&nbsp;<span class="builtintype" id="1578273">uintptr</span><span class="op" id="1578280">,</span>&nbsp;<span class="builtintype" id="1578282">uintptr</span><span class="op" id="1578289">,</span>&nbsp;<span class="builtintype" id="1578291">uintptr</span><span class="op" id="1578298">)</span><span class="op" id="1578299">)</span>&nbsp;<span class="op" id="1578301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578304">lock</span><span class="op" id="1578308">(</span><span class="op" id="1578309">&amp;</span><span class="ident" id="1578310">proflock</span><span class="op" id="1578318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1578321">for</span>&nbsp;<span class="ident" id="1578325">b</span>&nbsp;<span class="op" id="1578327">:=</span>&nbsp;<span class="ident" id="1578330">mbuckets</span><span class="op" id="1578338">;</span>&nbsp;<span class="ident" id="1578340">b</span>&nbsp;<span class="op" id="1578342">!=</span>&nbsp;<span class="ident" id="1578345">nil</span><span class="op" id="1578348">;</span>&nbsp;<span class="ident" id="1578350">b</span>&nbsp;<span class="op" id="1578352">=</span>&nbsp;<span class="ident" id="1578354">b</span><span class="op" id="1578355">.</span><span class="ident" id="1578356">allnext</span>&nbsp;<span class="op" id="1578364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578368">mp</span>&nbsp;<span class="op" id="1578371">:=</span>&nbsp;<span class="ident" id="1578374">b</span><span class="op" id="1578375">.</span><span class="ident" id="1578376">mp</span><span class="op" id="1578378">(</span><span class="op" id="1578379">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578383">fn</span><span class="op" id="1578385">(</span><span class="ident" id="1578386">b</span><span class="op" id="1578387">,</span>&nbsp;<span class="builtintype" id="1578389">uintptr</span><span class="op" id="1578396">(</span><span class="ident" id="1578397">b</span><span class="op" id="1578398">.</span><span class="ident" id="1578399">nstk</span><span class="op" id="1578403">)</span><span class="op" id="1578404">,</span>&nbsp;<span class="op" id="1578406">&amp;</span><span class="ident" id="1578407">b</span><span class="op" id="1578408">.</span><span class="ident" id="1578409">stk</span><span class="op" id="1578412">(</span><span class="op" id="1578413">)</span><span class="op" id="1578414">[</span><span class="num" id="1578415">0</span><span class="op" id="1578416">]</span><span class="op" id="1578417">,</span>&nbsp;<span class="ident" id="1578419">b</span><span class="op" id="1578420">.</span><span class="ident" id="1578421">size</span><span class="op" id="1578425">,</span>&nbsp;<span class="ident" id="1578427">mp</span><span class="op" id="1578429">.</span><span class="ident" id="1578430">allocs</span><span class="op" id="1578436">,</span>&nbsp;<span class="ident" id="1578438">mp</span><span class="op" id="1578440">.</span><span class="ident" id="1578441">frees</span><span class="op" id="1578446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1578449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578452">unlock</span><span class="op" id="1578458">(</span><span class="op" id="1578459">&amp;</span><span class="ident" id="1578460">proflock</span><span class="op" id="1578468">)</span><br>
<span class="lineno"></span><span class="op" id="1578470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="1578473">//&nbsp;BlockProfileRecord&nbsp;describes&nbsp;blocking&nbsp;events&nbsp;originated</span><br>
<span class="lineno"></span><span class="comment" id="1578532">//&nbsp;at&nbsp;a&nbsp;particular&nbsp;call&nbsp;sequence&nbsp;(stack&nbsp;trace).</span><br>
<span class="lineno"></span><span class="keyword" id="1578580">type</span>&nbsp;<span class="ident" id="1578585">BlockProfileRecord</span>&nbsp;<span class="keyword" id="1578604">struct</span>&nbsp;<span class="op" id="1578611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578614">Count</span>&nbsp;&nbsp;<span class="ident" id="1578621">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578628">Cycles</span>&nbsp;<span class="ident" id="1578635">int64</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1578642">StackRecord</span><br>
<span class="lineno"></span><span class="op" id="1578654">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1578657">//&nbsp;BlockProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1578739">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;BlockProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">470</span><span class="comment" id="1578818">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;BlockProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1578889">//</span><br>
<span class="lineno"></span><span class="comment" id="1578892">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="1578948">//&nbsp;the&nbsp;testing&nbsp;package&#39;s&nbsp;-test.blockprofile&nbsp;flag&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1579005">//&nbsp;of&nbsp;calling&nbsp;BlockProfile&nbsp;directly.</span><br>
<span class="lineno">475</span><span class="keyword" id="1579042">func</span>&nbsp;<span class="ident" id="1579047">BlockProfile</span><span class="op" id="1579059">(</span><span class="ident" id="1579060">p</span>&nbsp;<span class="op" id="1579062">[</span><span class="op" id="1579063">]</span><span class="ident" id="1579064">BlockProfileRecord</span><span class="op" id="1579082">)</span>&nbsp;<span class="op" id="1579084">(</span><span class="ident" id="1579085">n</span>&nbsp;<span class="builtintype" id="1579087">int</span><span class="op" id="1579090">,</span>&nbsp;<span class="ident" id="1579092">ok</span>&nbsp;<span class="builtintype" id="1579095">bool</span><span class="op" id="1579099">)</span>&nbsp;<span class="op" id="1579101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579104">lock</span><span class="op" id="1579108">(</span><span class="op" id="1579109">&amp;</span><span class="ident" id="1579110">proflock</span><span class="op" id="1579118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579121">for</span>&nbsp;<span class="ident" id="1579125">b</span>&nbsp;<span class="op" id="1579127">:=</span>&nbsp;<span class="ident" id="1579130">bbuckets</span><span class="op" id="1579138">;</span>&nbsp;<span class="ident" id="1579140">b</span>&nbsp;<span class="op" id="1579142">!=</span>&nbsp;<span class="ident" id="1579145">nil</span><span class="op" id="1579148">;</span>&nbsp;<span class="ident" id="1579150">b</span>&nbsp;<span class="op" id="1579152">=</span>&nbsp;<span class="ident" id="1579154">b</span><span class="op" id="1579155">.</span><span class="ident" id="1579156">allnext</span>&nbsp;<span class="op" id="1579164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579168">n</span><span class="op" id="1579169">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579173">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579176">if</span>&nbsp;<span class="ident" id="1579179">n</span>&nbsp;<span class="op" id="1579181">&lt;=</span>&nbsp;<span class="builtinfunc" id="1579184">len</span><span class="op" id="1579187">(</span><span class="ident" id="1579188">p</span><span class="op" id="1579189">)</span>&nbsp;<span class="op" id="1579191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579195">ok</span>&nbsp;<span class="op" id="1579198">=</span>&nbsp;<span class="builtintype" id="1579200">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579207">for</span>&nbsp;<span class="ident" id="1579211">b</span>&nbsp;<span class="op" id="1579213">:=</span>&nbsp;<span class="ident" id="1579216">bbuckets</span><span class="op" id="1579224">;</span>&nbsp;<span class="ident" id="1579226">b</span>&nbsp;<span class="op" id="1579228">!=</span>&nbsp;<span class="ident" id="1579231">nil</span><span class="op" id="1579234">;</span>&nbsp;<span class="ident" id="1579236">b</span>&nbsp;<span class="op" id="1579238">=</span>&nbsp;<span class="ident" id="1579240">b</span><span class="op" id="1579241">.</span><span class="ident" id="1579242">allnext</span>&nbsp;<span class="op" id="1579250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579255">bp</span>&nbsp;<span class="op" id="1579258">:=</span>&nbsp;<span class="ident" id="1579261">b</span><span class="op" id="1579262">.</span><span class="ident" id="1579263">bp</span><span class="op" id="1579265">(</span><span class="op" id="1579266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579271">r</span>&nbsp;<span class="op" id="1579273">:=</span>&nbsp;<span class="op" id="1579276">&amp;</span><span class="ident" id="1579277">p</span><span class="op" id="1579278">[</span><span class="num" id="1579279">0</span><span class="op" id="1579280">]</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579285">r</span><span class="op" id="1579286">.</span><span class="ident" id="1579287">Count</span>&nbsp;<span class="op" id="1579293">=</span>&nbsp;<span class="ident" id="1579295">int64</span><span class="op" id="1579300">(</span><span class="ident" id="1579301">bp</span><span class="op" id="1579303">.</span><span class="ident" id="1579304">count</span><span class="op" id="1579309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579314">r</span><span class="op" id="1579315">.</span><span class="ident" id="1579316">Cycles</span>&nbsp;<span class="op" id="1579323">=</span>&nbsp;<span class="ident" id="1579325">int64</span><span class="op" id="1579330">(</span><span class="ident" id="1579331">bp</span><span class="op" id="1579333">.</span><span class="ident" id="1579334">cycles</span><span class="op" id="1579340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579345">i</span>&nbsp;<span class="op" id="1579347">:=</span>&nbsp;<span class="builtinfunc" id="1579350">copy</span><span class="op" id="1579354">(</span><span class="ident" id="1579355">r</span><span class="op" id="1579356">.</span><span class="ident" id="1579357">Stack0</span><span class="op" id="1579363">[</span><span class="op" id="1579364">:</span><span class="op" id="1579365">]</span><span class="op" id="1579366">,</span>&nbsp;<span class="ident" id="1579368">b</span><span class="op" id="1579369">.</span><span class="ident" id="1579370">stk</span><span class="op" id="1579373">(</span><span class="op" id="1579374">)</span><span class="op" id="1579375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579380">for</span>&nbsp;<span class="op" id="1579384">;</span>&nbsp;<span class="ident" id="1579386">i</span>&nbsp;<span class="op" id="1579388">&lt;</span>&nbsp;<span class="builtinfunc" id="1579390">len</span><span class="op" id="1579393">(</span><span class="ident" id="1579394">r</span><span class="op" id="1579395">.</span><span class="ident" id="1579396">Stack0</span><span class="op" id="1579402">)</span><span class="op" id="1579403">;</span>&nbsp;<span class="ident" id="1579405">i</span><span class="op" id="1579406">++</span>&nbsp;<span class="op" id="1579409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579415">r</span><span class="op" id="1579416">.</span><span class="ident" id="1579417">Stack0</span><span class="op" id="1579423">[</span><span class="ident" id="1579424">i</span><span class="op" id="1579425">]</span>&nbsp;<span class="op" id="1579427">=</span>&nbsp;<span class="num" id="1579429">0</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579439">p</span>&nbsp;<span class="op" id="1579441">=</span>&nbsp;<span class="ident" id="1579443">p</span><span class="op" id="1579444">[</span><span class="num" id="1579445">1</span><span class="op" id="1579446">:</span><span class="op" id="1579447">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1579454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579457">unlock</span><span class="op" id="1579463">(</span><span class="op" id="1579464">&amp;</span><span class="ident" id="1579465">proflock</span><span class="op" id="1579473">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579476">return</span><br>
<span class="lineno"></span><span class="op" id="1579483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1579486">//&nbsp;ThreadCreateProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;thread&nbsp;creation&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="1579574">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno">500</span><span class="comment" id="1579660">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;ThreadCreateProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1579738">//</span><br>
<span class="lineno"></span><span class="comment" id="1579741">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1579802">//&nbsp;of&nbsp;calling&nbsp;ThreadCreateProfile&nbsp;directly.</span><br>
<span class="lineno"></span><span class="keyword" id="1579846">func</span>&nbsp;<span class="ident" id="1579851">ThreadCreateProfile</span><span class="op" id="1579870">(</span><span class="ident" id="1579871">p</span>&nbsp;<span class="op" id="1579873">[</span><span class="op" id="1579874">]</span><span class="ident" id="1579875">StackRecord</span><span class="op" id="1579886">)</span>&nbsp;<span class="op" id="1579888">(</span><span class="ident" id="1579889">n</span>&nbsp;<span class="builtintype" id="1579891">int</span><span class="op" id="1579894">,</span>&nbsp;<span class="ident" id="1579896">ok</span>&nbsp;<span class="builtintype" id="1579899">bool</span><span class="op" id="1579903">)</span>&nbsp;<span class="op" id="1579905">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1579908">first</span>&nbsp;<span class="op" id="1579914">:=</span>&nbsp;<span class="op" id="1579917">(</span><span class="op" id="1579918">*</span><span class="ident" id="1579919">m</span><span class="op" id="1579920">)</span><span class="op" id="1579921">(</span><span class="ident" id="1579922">atomicloadp</span><span class="op" id="1579933">(</span><span class="ident" id="1579934">unsafe</span><span class="op" id="1579940">.</span><span class="ident" id="1579941">Pointer</span><span class="op" id="1579948">(</span><span class="op" id="1579949">&amp;</span><span class="ident" id="1579950">allm</span><span class="op" id="1579954">)</span><span class="op" id="1579955">)</span><span class="op" id="1579956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1579959">for</span>&nbsp;<span class="ident" id="1579963">mp</span>&nbsp;<span class="op" id="1579966">:=</span>&nbsp;<span class="ident" id="1579969">first</span><span class="op" id="1579974">;</span>&nbsp;<span class="ident" id="1579976">mp</span>&nbsp;<span class="op" id="1579979">!=</span>&nbsp;<span class="ident" id="1579982">nil</span><span class="op" id="1579985">;</span>&nbsp;<span class="ident" id="1579987">mp</span>&nbsp;<span class="op" id="1579990">=</span>&nbsp;<span class="ident" id="1579992">mp</span><span class="op" id="1579994">.</span><span class="ident" id="1579995">alllink</span>&nbsp;<span class="op" id="1580003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580007">n</span><span class="op" id="1580008">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1580012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580015">if</span>&nbsp;<span class="ident" id="1580018">n</span>&nbsp;<span class="op" id="1580020">&lt;=</span>&nbsp;<span class="builtinfunc" id="1580023">len</span><span class="op" id="1580026">(</span><span class="ident" id="1580027">p</span><span class="op" id="1580028">)</span>&nbsp;<span class="op" id="1580030">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580034">ok</span>&nbsp;<span class="op" id="1580037">=</span>&nbsp;<span class="builtintype" id="1580039">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580046">i</span>&nbsp;<span class="op" id="1580048">:=</span>&nbsp;<span class="num" id="1580051">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580055">for</span>&nbsp;<span class="ident" id="1580059">mp</span>&nbsp;<span class="op" id="1580062">:=</span>&nbsp;<span class="ident" id="1580065">first</span><span class="op" id="1580070">;</span>&nbsp;<span class="ident" id="1580072">mp</span>&nbsp;<span class="op" id="1580075">!=</span>&nbsp;<span class="ident" id="1580078">nil</span><span class="op" id="1580081">;</span>&nbsp;<span class="ident" id="1580083">mp</span>&nbsp;<span class="op" id="1580086">=</span>&nbsp;<span class="ident" id="1580088">mp</span><span class="op" id="1580090">.</span><span class="ident" id="1580091">alllink</span>&nbsp;<span class="op" id="1580099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580104">for</span>&nbsp;<span class="ident" id="1580108">s</span>&nbsp;<span class="op" id="1580110">:=</span>&nbsp;<span class="keyword" id="1580113">range</span>&nbsp;<span class="ident" id="1580119">mp</span><span class="op" id="1580121">.</span><span class="ident" id="1580122">createstack</span>&nbsp;<span class="op" id="1580134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580140">p</span><span class="op" id="1580141">[</span><span class="ident" id="1580142">i</span><span class="op" id="1580143">]</span><span class="op" id="1580144">.</span><span class="ident" id="1580145">Stack0</span><span class="op" id="1580151">[</span><span class="ident" id="1580152">s</span><span class="op" id="1580153">]</span>&nbsp;<span class="op" id="1580155">=</span>&nbsp;<span class="builtintype" id="1580157">uintptr</span><span class="op" id="1580164">(</span><span class="ident" id="1580165">mp</span><span class="op" id="1580167">.</span><span class="ident" id="1580168">createstack</span><span class="op" id="1580179">[</span><span class="ident" id="1580180">s</span><span class="op" id="1580181">]</span><span class="op" id="1580182">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1580187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580192">i</span><span class="op" id="1580193">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1580198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1580201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580204">return</span><br>
<span class="lineno">520</span><span class="op" id="1580211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1580214">var</span>&nbsp;<span class="ident" id="1580218">allgs</span>&nbsp;<span class="op" id="1580224">[</span><span class="op" id="1580225">]</span><span class="op" id="1580226">*</span><span class="ident" id="1580227">g</span>&nbsp;<span class="comment" id="1580229">//&nbsp;proc.c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1580240">//&nbsp;GoroutineProfile&nbsp;returns&nbsp;n,&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;active&nbsp;goroutine&nbsp;stack&nbsp;profile.</span><br>
<span class="lineno">525</span><span class="comment" id="1580332">//&nbsp;If&nbsp;len(p)&nbsp;&gt;=&nbsp;n,&nbsp;GoroutineProfile&nbsp;copies&nbsp;the&nbsp;profile&nbsp;into&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;true.</span><br>
<span class="lineno"></span><span class="comment" id="1580415">//&nbsp;If&nbsp;len(p)&nbsp;&lt;&nbsp;n,&nbsp;GoroutineProfile&nbsp;does&nbsp;not&nbsp;change&nbsp;p&nbsp;and&nbsp;returns&nbsp;n,&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="1580490">//</span><br>
<span class="lineno"></span><span class="comment" id="1580493">//&nbsp;Most&nbsp;clients&nbsp;should&nbsp;use&nbsp;the&nbsp;runtime/pprof&nbsp;package&nbsp;instead</span><br>
<span class="lineno"></span><span class="comment" id="1580554">//&nbsp;of&nbsp;calling&nbsp;GoroutineProfile&nbsp;directly.</span><br>
<span class="lineno">530</span><span class="keyword" id="1580595">func</span>&nbsp;<span class="ident" id="1580600">GoroutineProfile</span><span class="op" id="1580616">(</span><span class="ident" id="1580617">p</span>&nbsp;<span class="op" id="1580619">[</span><span class="op" id="1580620">]</span><span class="ident" id="1580621">StackRecord</span><span class="op" id="1580632">)</span>&nbsp;<span class="op" id="1580634">(</span><span class="ident" id="1580635">n</span>&nbsp;<span class="builtintype" id="1580637">int</span><span class="op" id="1580640">,</span>&nbsp;<span class="ident" id="1580642">ok</span>&nbsp;<span class="builtintype" id="1580645">bool</span><span class="op" id="1580649">)</span>&nbsp;<span class="op" id="1580651">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580655">n</span>&nbsp;<span class="op" id="1580657">=</span>&nbsp;<span class="ident" id="1580659">NumGoroutine</span><span class="op" id="1580671">(</span><span class="op" id="1580672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580675">if</span>&nbsp;<span class="ident" id="1580678">n</span>&nbsp;<span class="op" id="1580680">&lt;=</span>&nbsp;<span class="builtinfunc" id="1580683">len</span><span class="op" id="1580686">(</span><span class="ident" id="1580687">p</span><span class="op" id="1580688">)</span>&nbsp;<span class="op" id="1580690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580694">gp</span>&nbsp;<span class="op" id="1580697">:=</span>&nbsp;<span class="ident" id="1580700">getg</span><span class="op" id="1580704">(</span><span class="op" id="1580705">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580709">semacquire</span><span class="op" id="1580719">(</span><span class="op" id="1580720">&amp;</span><span class="ident" id="1580721">worldsema</span><span class="op" id="1580730">,</span>&nbsp;<span class="builtintype" id="1580732">false</span><span class="op" id="1580737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580741">gp</span><span class="op" id="1580743">.</span><span class="ident" id="1580744">m</span><span class="op" id="1580745">.</span><span class="ident" id="1580746">gcing</span>&nbsp;<span class="op" id="1580752">=</span>&nbsp;<span class="num" id="1580754">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580758">onM</span><span class="op" id="1580761">(</span><span class="ident" id="1580762">stoptheworld</span><span class="op" id="1580774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580779">n</span>&nbsp;<span class="op" id="1580781">=</span>&nbsp;<span class="ident" id="1580783">NumGoroutine</span><span class="op" id="1580795">(</span><span class="op" id="1580796">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580800">if</span>&nbsp;<span class="ident" id="1580803">n</span>&nbsp;<span class="op" id="1580805">&lt;=</span>&nbsp;<span class="builtinfunc" id="1580808">len</span><span class="op" id="1580811">(</span><span class="ident" id="1580812">p</span><span class="op" id="1580813">)</span>&nbsp;<span class="op" id="1580815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580820">ok</span>&nbsp;<span class="op" id="1580823">=</span>&nbsp;<span class="builtintype" id="1580825">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580833">r</span>&nbsp;<span class="op" id="1580835">:=</span>&nbsp;<span class="ident" id="1580838">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580843">sp</span>&nbsp;<span class="op" id="1580846">:=</span>&nbsp;<span class="ident" id="1580849">getcallersp</span><span class="op" id="1580860">(</span><span class="ident" id="1580861">unsafe</span><span class="op" id="1580867">.</span><span class="ident" id="1580868">Pointer</span><span class="op" id="1580875">(</span><span class="op" id="1580876">&amp;</span><span class="ident" id="1580877">p</span><span class="op" id="1580878">)</span><span class="op" id="1580879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580884">pc</span>&nbsp;<span class="op" id="1580887">:=</span>&nbsp;<span class="ident" id="1580890">getcallerpc</span><span class="op" id="1580901">(</span><span class="ident" id="1580902">unsafe</span><span class="op" id="1580908">.</span><span class="ident" id="1580909">Pointer</span><span class="op" id="1580916">(</span><span class="op" id="1580917">&amp;</span><span class="ident" id="1580918">p</span><span class="op" id="1580919">)</span><span class="op" id="1580920">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580925">onM</span><span class="op" id="1580928">(</span><span class="keyword" id="1580929">func</span><span class="op" id="1580933">(</span><span class="op" id="1580934">)</span>&nbsp;<span class="op" id="1580936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580942">saveg</span><span class="op" id="1580947">(</span><span class="ident" id="1580948">pc</span><span class="op" id="1580950">,</span>&nbsp;<span class="ident" id="1580952">sp</span><span class="op" id="1580954">,</span>&nbsp;<span class="ident" id="1580956">gp</span><span class="op" id="1580958">,</span>&nbsp;<span class="op" id="1580960">&amp;</span><span class="ident" id="1580961">r</span><span class="op" id="1580962">[</span><span class="num" id="1580963">0</span><span class="op" id="1580964">]</span><span class="op" id="1580965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1580970">}</span><span class="op" id="1580971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1580976">r</span>&nbsp;<span class="op" id="1580978">=</span>&nbsp;<span class="ident" id="1580980">r</span><span class="op" id="1580981">[</span><span class="num" id="1580982">1</span><span class="op" id="1580983">:</span><span class="op" id="1580984">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1580989">for</span>&nbsp;<span class="ident" id="1580993">_</span><span class="op" id="1580994">,</span>&nbsp;<span class="ident" id="1580996">gp1</span>&nbsp;<span class="op" id="1581000">:=</span>&nbsp;<span class="keyword" id="1581003">range</span>&nbsp;<span class="ident" id="1581009">allgs</span>&nbsp;<span class="op" id="1581015">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581021">if</span>&nbsp;<span class="ident" id="1581024">gp1</span>&nbsp;<span class="op" id="1581028">==</span>&nbsp;<span class="ident" id="1581031">gp</span>&nbsp;<span class="op" id="1581034">||</span>&nbsp;<span class="ident" id="1581037">readgstatus</span><span class="op" id="1581048">(</span><span class="ident" id="1581049">gp1</span><span class="op" id="1581052">)</span>&nbsp;<span class="op" id="1581054">==</span>&nbsp;<span class="ident" id="1581057">_Gdead</span>&nbsp;<span class="op" id="1581064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581071">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581090">saveg</span><span class="op" id="1581095">(</span><span class="op" id="1581096">^</span><span class="builtintype" id="1581097">uintptr</span><span class="op" id="1581104">(</span><span class="num" id="1581105">0</span><span class="op" id="1581106">)</span><span class="op" id="1581107">,</span>&nbsp;<span class="op" id="1581109">^</span><span class="builtintype" id="1581110">uintptr</span><span class="op" id="1581117">(</span><span class="num" id="1581118">0</span><span class="op" id="1581119">)</span><span class="op" id="1581120">,</span>&nbsp;<span class="ident" id="1581122">gp1</span><span class="op" id="1581125">,</span>&nbsp;<span class="op" id="1581127">&amp;</span><span class="ident" id="1581128">r</span><span class="op" id="1581129">[</span><span class="num" id="1581130">0</span><span class="op" id="1581131">]</span><span class="op" id="1581132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581138">r</span>&nbsp;<span class="op" id="1581140">=</span>&nbsp;<span class="ident" id="1581142">r</span><span class="op" id="1581143">[</span><span class="num" id="1581144">1</span><span class="op" id="1581145">:</span><span class="op" id="1581146">]</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581160">gp</span><span class="op" id="1581162">.</span><span class="ident" id="1581163">m</span><span class="op" id="1581164">.</span><span class="ident" id="1581165">gcing</span>&nbsp;<span class="op" id="1581171">=</span>&nbsp;<span class="num" id="1581173">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581177">semrelease</span><span class="op" id="1581187">(</span><span class="op" id="1581188">&amp;</span><span class="ident" id="1581189">worldsema</span><span class="op" id="1581198">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581202">onM</span><span class="op" id="1581205">(</span><span class="ident" id="1581206">starttheworld</span><span class="op" id="1581219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581226">return</span>&nbsp;<span class="ident" id="1581233">n</span><span class="op" id="1581234">,</span>&nbsp;<span class="ident" id="1581236">ok</span><br>
<span class="lineno"></span><span class="op" id="1581239">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="keyword" id="1581242">func</span>&nbsp;<span class="ident" id="1581247">saveg</span><span class="op" id="1581252">(</span><span class="ident" id="1581253">pc</span><span class="op" id="1581255">,</span>&nbsp;<span class="ident" id="1581257">sp</span>&nbsp;<span class="builtintype" id="1581260">uintptr</span><span class="op" id="1581267">,</span>&nbsp;<span class="ident" id="1581269">gp</span>&nbsp;<span class="op" id="1581272">*</span><span class="ident" id="1581273">g</span><span class="op" id="1581274">,</span>&nbsp;<span class="ident" id="1581276">r</span>&nbsp;<span class="op" id="1581278">*</span><span class="ident" id="1581279">StackRecord</span><span class="op" id="1581290">)</span>&nbsp;<span class="op" id="1581292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581295">n</span>&nbsp;<span class="op" id="1581297">:=</span>&nbsp;<span class="ident" id="1581300">gentraceback</span><span class="op" id="1581312">(</span><span class="ident" id="1581313">pc</span><span class="op" id="1581315">,</span>&nbsp;<span class="ident" id="1581317">sp</span><span class="op" id="1581319">,</span>&nbsp;<span class="num" id="1581321">0</span><span class="op" id="1581322">,</span>&nbsp;<span class="ident" id="1581324">gp</span><span class="op" id="1581326">,</span>&nbsp;<span class="num" id="1581328">0</span><span class="op" id="1581329">,</span>&nbsp;<span class="op" id="1581331">&amp;</span><span class="ident" id="1581332">r</span><span class="op" id="1581333">.</span><span class="ident" id="1581334">Stack0</span><span class="op" id="1581340">[</span><span class="num" id="1581341">0</span><span class="op" id="1581342">]</span><span class="op" id="1581343">,</span>&nbsp;<span class="builtinfunc" id="1581345">len</span><span class="op" id="1581348">(</span><span class="ident" id="1581349">r</span><span class="op" id="1581350">.</span><span class="ident" id="1581351">Stack0</span><span class="op" id="1581357">)</span><span class="op" id="1581358">,</span>&nbsp;<span class="ident" id="1581360">nil</span><span class="op" id="1581363">,</span>&nbsp;<span class="ident" id="1581365">nil</span><span class="op" id="1581368">,</span>&nbsp;<span class="num" id="1581370">0</span><span class="op" id="1581371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581374">if</span>&nbsp;<span class="ident" id="1581377">n</span>&nbsp;<span class="op" id="1581379">&lt;</span>&nbsp;<span class="builtinfunc" id="1581381">len</span><span class="op" id="1581384">(</span><span class="ident" id="1581385">r</span><span class="op" id="1581386">.</span><span class="ident" id="1581387">Stack0</span><span class="op" id="1581393">)</span>&nbsp;<span class="op" id="1581395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581399">r</span><span class="op" id="1581400">.</span><span class="ident" id="1581401">Stack0</span><span class="op" id="1581407">[</span><span class="ident" id="1581408">n</span><span class="op" id="1581409">]</span>&nbsp;<span class="op" id="1581411">=</span>&nbsp;<span class="num" id="1581413">0</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581416">}</span><br>
<span class="lineno"></span><span class="op" id="1581418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1581421">//&nbsp;Stack&nbsp;formats&nbsp;a&nbsp;stack&nbsp;trace&nbsp;of&nbsp;the&nbsp;calling&nbsp;goroutine&nbsp;into&nbsp;buf</span><br>
<span class="lineno"></span><span class="comment" id="1581486">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;to&nbsp;buf.</span><br>
<span class="lineno">575</span><span class="comment" id="1581537">//&nbsp;If&nbsp;all&nbsp;is&nbsp;true,&nbsp;Stack&nbsp;formats&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;other&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="1581607">//&nbsp;into&nbsp;buf&nbsp;after&nbsp;the&nbsp;trace&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span><span class="keyword" id="1581662">func</span>&nbsp;<span class="ident" id="1581667">Stack</span><span class="op" id="1581672">(</span><span class="ident" id="1581673">buf</span>&nbsp;<span class="op" id="1581677">[</span><span class="op" id="1581678">]</span><span class="builtintype" id="1581679">byte</span><span class="op" id="1581683">,</span>&nbsp;<span class="ident" id="1581685">all</span>&nbsp;<span class="builtintype" id="1581689">bool</span><span class="op" id="1581693">)</span>&nbsp;<span class="builtintype" id="1581695">int</span>&nbsp;<span class="op" id="1581699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581702">mp</span>&nbsp;<span class="op" id="1581705">:=</span>&nbsp;<span class="ident" id="1581708">acquirem</span><span class="op" id="1581716">(</span><span class="op" id="1581717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581720">gp</span>&nbsp;<span class="op" id="1581723">:=</span>&nbsp;<span class="ident" id="1581726">mp</span><span class="op" id="1581728">.</span><span class="ident" id="1581729">curg</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581735">if</span>&nbsp;<span class="ident" id="1581738">all</span>&nbsp;<span class="op" id="1581742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581746">semacquire</span><span class="op" id="1581756">(</span><span class="op" id="1581757">&amp;</span><span class="ident" id="1581758">worldsema</span><span class="op" id="1581767">,</span>&nbsp;<span class="builtintype" id="1581769">false</span><span class="op" id="1581774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581778">mp</span><span class="op" id="1581780">.</span><span class="ident" id="1581781">gcing</span>&nbsp;<span class="op" id="1581787">=</span>&nbsp;<span class="num" id="1581789">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581793">releasem</span><span class="op" id="1581801">(</span><span class="ident" id="1581802">mp</span><span class="op" id="1581804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581808">onM</span><span class="op" id="1581811">(</span><span class="ident" id="1581812">stoptheworld</span><span class="op" id="1581824">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581828">if</span>&nbsp;<span class="ident" id="1581831">mp</span>&nbsp;<span class="op" id="1581834">!=</span>&nbsp;<span class="ident" id="1581837">acquirem</span><span class="op" id="1581845">(</span><span class="op" id="1581846">)</span>&nbsp;<span class="op" id="1581848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581853">gothrow</span><span class="op" id="1581860">(</span><span class="string" id="1581861">&#34;Stack:&nbsp;rescheduled&#34;</span><span class="op" id="1581881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1581888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581892">n</span>&nbsp;<span class="op" id="1581894">:=</span>&nbsp;<span class="num" id="1581897">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1581900">if</span>&nbsp;<span class="builtinfunc" id="1581903">len</span><span class="op" id="1581906">(</span><span class="ident" id="1581907">buf</span><span class="op" id="1581910">)</span>&nbsp;<span class="op" id="1581912">&gt;</span>&nbsp;<span class="num" id="1581914">0</span>&nbsp;<span class="op" id="1581916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581920">sp</span>&nbsp;<span class="op" id="1581923">:=</span>&nbsp;<span class="ident" id="1581926">getcallersp</span><span class="op" id="1581937">(</span><span class="ident" id="1581938">unsafe</span><span class="op" id="1581944">.</span><span class="ident" id="1581945">Pointer</span><span class="op" id="1581952">(</span><span class="op" id="1581953">&amp;</span><span class="ident" id="1581954">buf</span><span class="op" id="1581957">)</span><span class="op" id="1581958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1581962">pc</span>&nbsp;<span class="op" id="1581965">:=</span>&nbsp;<span class="ident" id="1581968">getcallerpc</span><span class="op" id="1581979">(</span><span class="ident" id="1581980">unsafe</span><span class="op" id="1581986">.</span><span class="ident" id="1581987">Pointer</span><span class="op" id="1581994">(</span><span class="op" id="1581995">&amp;</span><span class="ident" id="1581996">buf</span><span class="op" id="1581999">)</span><span class="op" id="1582000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582004">onM</span><span class="op" id="1582007">(</span><span class="keyword" id="1582008">func</span><span class="op" id="1582012">(</span><span class="op" id="1582013">)</span>&nbsp;<span class="op" id="1582015">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582020">g0</span>&nbsp;<span class="op" id="1582023">:=</span>&nbsp;<span class="ident" id="1582026">getg</span><span class="op" id="1582030">(</span><span class="op" id="1582031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582036">g0</span><span class="op" id="1582038">.</span><span class="ident" id="1582039">writebuf</span>&nbsp;<span class="op" id="1582048">=</span>&nbsp;<span class="ident" id="1582050">buf</span><span class="op" id="1582053">[</span><span class="num" id="1582054">0</span><span class="op" id="1582055">:</span><span class="num" id="1582056">0</span><span class="op" id="1582057">:</span><span class="builtinfunc" id="1582058">len</span><span class="op" id="1582061">(</span><span class="ident" id="1582062">buf</span><span class="op" id="1582065">)</span><span class="op" id="1582066">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582071">goroutineheader</span><span class="op" id="1582086">(</span><span class="ident" id="1582087">gp</span><span class="op" id="1582089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582094">traceback</span><span class="op" id="1582103">(</span><span class="ident" id="1582104">pc</span><span class="op" id="1582106">,</span>&nbsp;<span class="ident" id="1582108">sp</span><span class="op" id="1582110">,</span>&nbsp;<span class="num" id="1582112">0</span><span class="op" id="1582113">,</span>&nbsp;<span class="ident" id="1582115">gp</span><span class="op" id="1582117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582122">if</span>&nbsp;<span class="ident" id="1582125">all</span>&nbsp;<span class="op" id="1582129">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582135">tracebackothers</span><span class="op" id="1582150">(</span><span class="ident" id="1582151">gp</span><span class="op" id="1582153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582163">n</span>&nbsp;<span class="op" id="1582165">=</span>&nbsp;<span class="builtinfunc" id="1582167">len</span><span class="op" id="1582170">(</span><span class="ident" id="1582171">g0</span><span class="op" id="1582173">.</span><span class="ident" id="1582174">writebuf</span><span class="op" id="1582182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582187">g0</span><span class="op" id="1582189">.</span><span class="ident" id="1582190">writebuf</span>&nbsp;<span class="op" id="1582199">=</span>&nbsp;<span class="ident" id="1582201">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582207">}</span><span class="op" id="1582208">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582211">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582215">if</span>&nbsp;<span class="ident" id="1582218">all</span>&nbsp;<span class="op" id="1582222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582226">mp</span><span class="op" id="1582228">.</span><span class="ident" id="1582229">gcing</span>&nbsp;<span class="op" id="1582235">=</span>&nbsp;<span class="num" id="1582237">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582241">semrelease</span><span class="op" id="1582251">(</span><span class="op" id="1582252">&amp;</span><span class="ident" id="1582253">worldsema</span><span class="op" id="1582262">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582266">onM</span><span class="op" id="1582269">(</span><span class="ident" id="1582270">starttheworld</span><span class="op" id="1582283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582289">releasem</span><span class="op" id="1582297">(</span><span class="ident" id="1582298">mp</span><span class="op" id="1582300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582303">return</span>&nbsp;<span class="ident" id="1582310">n</span><br>
<span class="lineno"></span><span class="op" id="1582312">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span><span class="comment" id="1582315">//&nbsp;Tracing&nbsp;of&nbsp;alloc/free/gc.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1582345">var</span>&nbsp;<span class="ident" id="1582349">tracelock</span>&nbsp;<span class="ident" id="1582359">mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="1582366">func</span>&nbsp;<span class="ident" id="1582371">tracealloc</span><span class="op" id="1582381">(</span><span class="ident" id="1582382">p</span>&nbsp;<span class="ident" id="1582384">unsafe</span><span class="op" id="1582390">.</span><span class="ident" id="1582391">Pointer</span><span class="op" id="1582398">,</span>&nbsp;<span class="ident" id="1582400">size</span>&nbsp;<span class="builtintype" id="1582405">uintptr</span><span class="op" id="1582412">,</span>&nbsp;<span class="ident" id="1582414">typ</span>&nbsp;<span class="op" id="1582418">*</span><span class="ident" id="1582419">_type</span><span class="op" id="1582424">)</span>&nbsp;<span class="op" id="1582426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582429">lock</span><span class="op" id="1582433">(</span><span class="op" id="1582434">&amp;</span><span class="ident" id="1582435">tracelock</span><span class="op" id="1582444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582447">gp</span>&nbsp;<span class="op" id="1582450">:=</span>&nbsp;<span class="ident" id="1582453">getg</span><span class="op" id="1582457">(</span><span class="op" id="1582458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582461">gp</span><span class="op" id="1582463">.</span><span class="ident" id="1582464">m</span><span class="op" id="1582465">.</span><span class="ident" id="1582466">traceback</span>&nbsp;<span class="op" id="1582476">=</span>&nbsp;<span class="num" id="1582478">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582481">if</span>&nbsp;<span class="ident" id="1582484">typ</span>&nbsp;<span class="op" id="1582488">==</span>&nbsp;<span class="ident" id="1582491">nil</span>&nbsp;<span class="op" id="1582495">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1582499">print</span><span class="op" id="1582504">(</span><span class="string" id="1582505">&#34;tracealloc(&#34;</span><span class="op" id="1582518">,</span>&nbsp;<span class="ident" id="1582520">p</span><span class="op" id="1582521">,</span>&nbsp;<span class="string" id="1582523">&#34;,&nbsp;&#34;</span><span class="op" id="1582527">,</span>&nbsp;<span class="ident" id="1582529">hex</span><span class="op" id="1582532">(</span><span class="ident" id="1582533">size</span><span class="op" id="1582537">)</span><span class="op" id="1582538">,</span>&nbsp;<span class="string" id="1582540">&#34;)\n&#34;</span><span class="op" id="1582545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582548">}</span>&nbsp;<span class="keyword" id="1582550">else</span>&nbsp;<span class="op" id="1582555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1582559">print</span><span class="op" id="1582564">(</span><span class="string" id="1582565">&#34;tracealloc(&#34;</span><span class="op" id="1582578">,</span>&nbsp;<span class="ident" id="1582580">p</span><span class="op" id="1582581">,</span>&nbsp;<span class="string" id="1582583">&#34;,&nbsp;&#34;</span><span class="op" id="1582587">,</span>&nbsp;<span class="ident" id="1582589">hex</span><span class="op" id="1582592">(</span><span class="ident" id="1582593">size</span><span class="op" id="1582597">)</span><span class="op" id="1582598">,</span>&nbsp;<span class="string" id="1582600">&#34;,&nbsp;&#34;</span><span class="op" id="1582604">,</span>&nbsp;<span class="op" id="1582606">*</span><span class="ident" id="1582607">typ</span><span class="op" id="1582610">.</span><span class="ident" id="1582611">_string</span><span class="op" id="1582618">,</span>&nbsp;<span class="string" id="1582620">&#34;)\n&#34;</span><span class="op" id="1582625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1582631">if</span>&nbsp;<span class="ident" id="1582634">gp</span><span class="op" id="1582636">.</span><span class="ident" id="1582637">m</span><span class="op" id="1582638">.</span><span class="ident" id="1582639">curg</span>&nbsp;<span class="op" id="1582644">==</span>&nbsp;<span class="ident" id="1582647">nil</span>&nbsp;<span class="op" id="1582651">||</span>&nbsp;<span class="ident" id="1582654">gp</span>&nbsp;<span class="op" id="1582657">==</span>&nbsp;<span class="ident" id="1582660">gp</span><span class="op" id="1582662">.</span><span class="ident" id="1582663">m</span><span class="op" id="1582664">.</span><span class="ident" id="1582665">curg</span>&nbsp;<span class="op" id="1582670">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582674">goroutineheader</span><span class="op" id="1582689">(</span><span class="ident" id="1582690">gp</span><span class="op" id="1582692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582696">pc</span>&nbsp;<span class="op" id="1582699">:=</span>&nbsp;<span class="ident" id="1582702">getcallerpc</span><span class="op" id="1582713">(</span><span class="ident" id="1582714">unsafe</span><span class="op" id="1582720">.</span><span class="ident" id="1582721">Pointer</span><span class="op" id="1582728">(</span><span class="op" id="1582729">&amp;</span><span class="ident" id="1582730">p</span><span class="op" id="1582731">)</span><span class="op" id="1582732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582736">sp</span>&nbsp;<span class="op" id="1582739">:=</span>&nbsp;<span class="ident" id="1582742">getcallersp</span><span class="op" id="1582753">(</span><span class="ident" id="1582754">unsafe</span><span class="op" id="1582760">.</span><span class="ident" id="1582761">Pointer</span><span class="op" id="1582768">(</span><span class="op" id="1582769">&amp;</span><span class="ident" id="1582770">p</span><span class="op" id="1582771">)</span><span class="op" id="1582772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582776">onM</span><span class="op" id="1582779">(</span><span class="keyword" id="1582780">func</span><span class="op" id="1582784">(</span><span class="op" id="1582785">)</span>&nbsp;<span class="op" id="1582787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582792">traceback</span><span class="op" id="1582801">(</span><span class="ident" id="1582802">pc</span><span class="op" id="1582804">,</span>&nbsp;<span class="ident" id="1582806">sp</span><span class="op" id="1582808">,</span>&nbsp;<span class="num" id="1582810">0</span><span class="op" id="1582811">,</span>&nbsp;<span class="ident" id="1582813">gp</span><span class="op" id="1582815">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582819">}</span><span class="op" id="1582820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582823">}</span>&nbsp;<span class="keyword" id="1582825">else</span>&nbsp;<span class="op" id="1582830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582834">goroutineheader</span><span class="op" id="1582849">(</span><span class="ident" id="1582850">gp</span><span class="op" id="1582852">.</span><span class="ident" id="1582853">m</span><span class="op" id="1582854">.</span><span class="ident" id="1582855">curg</span><span class="op" id="1582859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582863">traceback</span><span class="op" id="1582872">(</span><span class="op" id="1582873">^</span><span class="builtintype" id="1582874">uintptr</span><span class="op" id="1582881">(</span><span class="num" id="1582882">0</span><span class="op" id="1582883">)</span><span class="op" id="1582884">,</span>&nbsp;<span class="op" id="1582886">^</span><span class="builtintype" id="1582887">uintptr</span><span class="op" id="1582894">(</span><span class="num" id="1582895">0</span><span class="op" id="1582896">)</span><span class="op" id="1582897">,</span>&nbsp;<span class="num" id="1582899">0</span><span class="op" id="1582900">,</span>&nbsp;<span class="ident" id="1582902">gp</span><span class="op" id="1582904">.</span><span class="ident" id="1582905">m</span><span class="op" id="1582906">.</span><span class="ident" id="1582907">curg</span><span class="op" id="1582911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1582914">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1582917">print</span><span class="op" id="1582922">(</span><span class="string" id="1582923">&#34;\n&#34;</span><span class="op" id="1582927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582930">gp</span><span class="op" id="1582932">.</span><span class="ident" id="1582933">m</span><span class="op" id="1582934">.</span><span class="ident" id="1582935">traceback</span>&nbsp;<span class="op" id="1582945">=</span>&nbsp;<span class="num" id="1582947">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1582950">unlock</span><span class="op" id="1582956">(</span><span class="op" id="1582957">&amp;</span><span class="ident" id="1582958">tracelock</span><span class="op" id="1582967">)</span><br>
<span class="lineno"></span><span class="op" id="1582969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span><span class="keyword" id="1582972">func</span>&nbsp;<span class="ident" id="1582977">tracefree</span><span class="op" id="1582986">(</span><span class="ident" id="1582987">p</span>&nbsp;<span class="ident" id="1582989">unsafe</span><span class="op" id="1582995">.</span><span class="ident" id="1582996">Pointer</span><span class="op" id="1583003">,</span>&nbsp;<span class="ident" id="1583005">size</span>&nbsp;<span class="builtintype" id="1583010">uintptr</span><span class="op" id="1583017">)</span>&nbsp;<span class="op" id="1583019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583022">lock</span><span class="op" id="1583026">(</span><span class="op" id="1583027">&amp;</span><span class="ident" id="1583028">tracelock</span><span class="op" id="1583037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583040">gp</span>&nbsp;<span class="op" id="1583043">:=</span>&nbsp;<span class="ident" id="1583046">getg</span><span class="op" id="1583050">(</span><span class="op" id="1583051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583054">gp</span><span class="op" id="1583056">.</span><span class="ident" id="1583057">m</span><span class="op" id="1583058">.</span><span class="ident" id="1583059">traceback</span>&nbsp;<span class="op" id="1583069">=</span>&nbsp;<span class="num" id="1583071">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583074">print</span><span class="op" id="1583079">(</span><span class="string" id="1583080">&#34;tracefree(&#34;</span><span class="op" id="1583092">,</span>&nbsp;<span class="ident" id="1583094">p</span><span class="op" id="1583095">,</span>&nbsp;<span class="string" id="1583097">&#34;,&nbsp;&#34;</span><span class="op" id="1583101">,</span>&nbsp;<span class="ident" id="1583103">hex</span><span class="op" id="1583106">(</span><span class="ident" id="1583107">size</span><span class="op" id="1583111">)</span><span class="op" id="1583112">,</span>&nbsp;<span class="string" id="1583114">&#34;)\n&#34;</span><span class="op" id="1583119">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583122">goroutineheader</span><span class="op" id="1583137">(</span><span class="ident" id="1583138">gp</span><span class="op" id="1583140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583143">pc</span>&nbsp;<span class="op" id="1583146">:=</span>&nbsp;<span class="ident" id="1583149">getcallerpc</span><span class="op" id="1583160">(</span><span class="ident" id="1583161">unsafe</span><span class="op" id="1583167">.</span><span class="ident" id="1583168">Pointer</span><span class="op" id="1583175">(</span><span class="op" id="1583176">&amp;</span><span class="ident" id="1583177">p</span><span class="op" id="1583178">)</span><span class="op" id="1583179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583182">sp</span>&nbsp;<span class="op" id="1583185">:=</span>&nbsp;<span class="ident" id="1583188">getcallersp</span><span class="op" id="1583199">(</span><span class="ident" id="1583200">unsafe</span><span class="op" id="1583206">.</span><span class="ident" id="1583207">Pointer</span><span class="op" id="1583214">(</span><span class="op" id="1583215">&amp;</span><span class="ident" id="1583216">p</span><span class="op" id="1583217">)</span><span class="op" id="1583218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583221">onM</span><span class="op" id="1583224">(</span><span class="keyword" id="1583225">func</span><span class="op" id="1583229">(</span><span class="op" id="1583230">)</span>&nbsp;<span class="op" id="1583232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583236">traceback</span><span class="op" id="1583245">(</span><span class="ident" id="1583246">pc</span><span class="op" id="1583248">,</span>&nbsp;<span class="ident" id="1583250">sp</span><span class="op" id="1583252">,</span>&nbsp;<span class="num" id="1583254">0</span><span class="op" id="1583255">,</span>&nbsp;<span class="ident" id="1583257">gp</span><span class="op" id="1583259">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1583262">}</span><span class="op" id="1583263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583266">print</span><span class="op" id="1583271">(</span><span class="string" id="1583272">&#34;\n&#34;</span><span class="op" id="1583276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583279">gp</span><span class="op" id="1583281">.</span><span class="ident" id="1583282">m</span><span class="op" id="1583283">.</span><span class="ident" id="1583284">traceback</span>&nbsp;<span class="op" id="1583294">=</span>&nbsp;<span class="num" id="1583296">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583299">unlock</span><span class="op" id="1583305">(</span><span class="op" id="1583306">&amp;</span><span class="ident" id="1583307">tracelock</span><span class="op" id="1583316">)</span><br>
<span class="lineno"></span><span class="op" id="1583318">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="keyword" id="1583321">func</span>&nbsp;<span class="ident" id="1583326">tracegc</span><span class="op" id="1583333">(</span><span class="op" id="1583334">)</span>&nbsp;<span class="op" id="1583336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583339">lock</span><span class="op" id="1583343">(</span><span class="op" id="1583344">&amp;</span><span class="ident" id="1583345">tracelock</span><span class="op" id="1583354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583357">gp</span>&nbsp;<span class="op" id="1583360">:=</span>&nbsp;<span class="ident" id="1583363">getg</span><span class="op" id="1583367">(</span><span class="op" id="1583368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583371">gp</span><span class="op" id="1583373">.</span><span class="ident" id="1583374">m</span><span class="op" id="1583375">.</span><span class="ident" id="1583376">traceback</span>&nbsp;<span class="op" id="1583386">=</span>&nbsp;<span class="num" id="1583388">2</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583391">print</span><span class="op" id="1583396">(</span><span class="string" id="1583397">&#34;tracegc()\n&#34;</span><span class="op" id="1583410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1583413">//&nbsp;running&nbsp;on&nbsp;m-&gt;g0&nbsp;stack;&nbsp;show&nbsp;all&nbsp;non-g0&nbsp;goroutines</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583468">tracebackothers</span><span class="op" id="1583483">(</span><span class="ident" id="1583484">gp</span><span class="op" id="1583486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583489">print</span><span class="op" id="1583494">(</span><span class="string" id="1583495">&#34;end&nbsp;tracegc\n&#34;</span><span class="op" id="1583510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1583513">print</span><span class="op" id="1583518">(</span><span class="string" id="1583519">&#34;\n&#34;</span><span class="op" id="1583523">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583526">gp</span><span class="op" id="1583528">.</span><span class="ident" id="1583529">m</span><span class="op" id="1583530">.</span><span class="ident" id="1583531">traceback</span>&nbsp;<span class="op" id="1583541">=</span>&nbsp;<span class="num" id="1583543">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1583546">unlock</span><span class="op" id="1583552">(</span><span class="op" id="1583553">&amp;</span><span class="ident" id="1583554">tracelock</span><span class="op" id="1583563">)</span><br>
<span class="lineno"></span><span class="op" id="1583565">}</span>
</div>
</body>
</html>
