<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html" class="current">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1668028">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1668083">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1668137">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1668188">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;runtime&nbsp;support&nbsp;for&nbsp;signal&nbsp;handling.</span><br>
<span class="lineno"></span><span class="comment" id="1668249">//</span><br>
<span class="lineno"></span><span class="comment" id="1668252">//&nbsp;Most&nbsp;synchronization&nbsp;primitives&nbsp;are&nbsp;not&nbsp;available&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="1668310">//&nbsp;the&nbsp;signal&nbsp;handler&nbsp;(it&nbsp;cannot&nbsp;block,&nbsp;allocate&nbsp;memory,&nbsp;or&nbsp;use&nbsp;locks)</span><br>
<span class="lineno"></span><span class="comment" id="1668381">//&nbsp;so&nbsp;the&nbsp;handler&nbsp;communicates&nbsp;with&nbsp;a&nbsp;processing&nbsp;goroutine</span><br>
<span class="lineno">10</span><span class="comment" id="1668440">//&nbsp;via&nbsp;struct&nbsp;sig,&nbsp;below.</span><br>
<span class="lineno"></span><span class="comment" id="1668466">//</span><br>
<span class="lineno"></span><span class="comment" id="1668469">//&nbsp;sigsend&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;signal&nbsp;handler&nbsp;to&nbsp;queue&nbsp;a&nbsp;new&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1668535">//&nbsp;signal_recv&nbsp;is&nbsp;called&nbsp;by&nbsp;the&nbsp;Go&nbsp;program&nbsp;to&nbsp;receive&nbsp;a&nbsp;newly&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno"></span><span class="comment" id="1668612">//&nbsp;Synchronization&nbsp;between&nbsp;sigsend&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;sig.state</span><br>
<span class="lineno">15</span><span class="comment" id="1668689">//&nbsp;variable.&nbsp;&nbsp;It&nbsp;can&nbsp;be&nbsp;in&nbsp;3&nbsp;states:&nbsp;sigIdle,&nbsp;sigReceiving&nbsp;and&nbsp;sigSending.</span><br>
<span class="lineno"></span><span class="comment" id="1668764">//&nbsp;sigReceiving&nbsp;means&nbsp;that&nbsp;signal_recv&nbsp;is&nbsp;blocked&nbsp;on&nbsp;sig.Note&nbsp;and&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="1668843">//&nbsp;new&nbsp;pending&nbsp;signals.</span><br>
<span class="lineno"></span><span class="comment" id="1668867">//&nbsp;sigSending&nbsp;means&nbsp;that&nbsp;sig.mask&nbsp;*may*&nbsp;contain&nbsp;new&nbsp;pending&nbsp;signals,</span><br>
<span class="lineno"></span><span class="comment" id="1668936">//&nbsp;signal_recv&nbsp;can&#39;t&nbsp;be&nbsp;blocked&nbsp;in&nbsp;this&nbsp;state.</span><br>
<span class="lineno">20</span><span class="comment" id="1668983">//&nbsp;sigIdle&nbsp;means&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;new&nbsp;pending&nbsp;signals&nbsp;and&nbsp;signal_recv&nbsp;is&nbsp;not&nbsp;blocked.</span><br>
<span class="lineno"></span><span class="comment" id="1669070">//&nbsp;Transitions&nbsp;between&nbsp;states&nbsp;are&nbsp;done&nbsp;atomically&nbsp;with&nbsp;CAS.</span><br>
<span class="lineno"></span><span class="comment" id="1669130">//&nbsp;When&nbsp;signal_recv&nbsp;is&nbsp;unblocked,&nbsp;it&nbsp;resets&nbsp;sig.Note&nbsp;and&nbsp;rechecks&nbsp;sig.mask.</span><br>
<span class="lineno"></span><span class="comment" id="1669206">//&nbsp;If&nbsp;several&nbsp;sigsends&nbsp;and&nbsp;signal_recv&nbsp;execute&nbsp;concurrently,&nbsp;it&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1669282">//&nbsp;unnecessary&nbsp;rechecks&nbsp;of&nbsp;sig.mask,&nbsp;but&nbsp;it&nbsp;cannot&nbsp;lead&nbsp;to&nbsp;missed&nbsp;signals</span><br>
<span class="lineno">25</span><span class="comment" id="1669356">//&nbsp;nor&nbsp;deadlocks.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1669375">package</span>&nbsp;<span class="ident" id="1669383">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1669392">import</span>&nbsp;<span class="string" id="1669399">&#34;unsafe&#34;</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="1669409">var</span>&nbsp;<span class="ident" id="1669413">sig</span>&nbsp;<span class="keyword" id="1669417">struct</span>&nbsp;<span class="op" id="1669424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669427">note</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="1669434">note</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669440">mask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1669447">[</span><span class="op" id="1669448">(</span><span class="ident" id="1669449">_NSIG</span>&nbsp;<span class="op" id="1669455">+</span>&nbsp;<span class="num" id="1669457">31</span><span class="op" id="1669459">)</span>&nbsp;<span class="op" id="1669461">/</span>&nbsp;<span class="num" id="1669463">32</span><span class="op" id="1669465">]</span><span class="builtintype" id="1669466">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669474">wanted</span>&nbsp;<span class="op" id="1669481">[</span><span class="op" id="1669482">(</span><span class="ident" id="1669483">_NSIG</span>&nbsp;<span class="op" id="1669489">+</span>&nbsp;<span class="num" id="1669491">31</span><span class="op" id="1669493">)</span>&nbsp;<span class="op" id="1669495">/</span>&nbsp;<span class="num" id="1669497">32</span><span class="op" id="1669499">]</span><span class="builtintype" id="1669500">uint32</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669508">recv</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1669515">[</span><span class="op" id="1669516">(</span><span class="ident" id="1669517">_NSIG</span>&nbsp;<span class="op" id="1669523">+</span>&nbsp;<span class="num" id="1669525">31</span><span class="op" id="1669527">)</span>&nbsp;<span class="op" id="1669529">/</span>&nbsp;<span class="num" id="1669531">32</span><span class="op" id="1669533">]</span><span class="builtintype" id="1669534">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669542">state</span>&nbsp;&nbsp;<span class="builtintype" id="1669549">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669557">inuse</span>&nbsp;&nbsp;<span class="builtintype" id="1669564">bool</span><br>
<span class="lineno"></span><span class="op" id="1669569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="1669572">const</span>&nbsp;<span class="op" id="1669578">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669581">sigIdle</span>&nbsp;<span class="op" id="1669589">=</span>&nbsp;<span class="ident" id="1669591">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669597">sigReceiving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669611">sigSending</span><br>
<span class="lineno"></span><span class="op" id="1669622">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="1669625">//&nbsp;Called&nbsp;from&nbsp;sighandler&nbsp;to&nbsp;send&nbsp;a&nbsp;signal&nbsp;back&nbsp;out&nbsp;of&nbsp;the&nbsp;signal&nbsp;handling&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1669708">//&nbsp;Reports&nbsp;whether&nbsp;the&nbsp;signal&nbsp;was&nbsp;sent.&nbsp;If&nbsp;not,&nbsp;the&nbsp;caller&nbsp;typically&nbsp;crashes&nbsp;the&nbsp;program.</span><br>
<span class="lineno"></span><span class="keyword" id="1669798">func</span>&nbsp;<span class="ident" id="1669803">sigsend</span><span class="op" id="1669810">(</span><span class="ident" id="1669811">s</span>&nbsp;<span class="builtintype" id="1669813">int32</span><span class="op" id="1669818">)</span>&nbsp;<span class="builtintype" id="1669820">bool</span>&nbsp;<span class="op" id="1669825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1669828">bit</span>&nbsp;<span class="op" id="1669832">:=</span>&nbsp;<span class="builtintype" id="1669835">uint32</span><span class="op" id="1669841">(</span><span class="num" id="1669842">1</span><span class="op" id="1669843">)</span>&nbsp;<span class="op" id="1669845">&lt;&lt;</span>&nbsp;<span class="builtintype" id="1669848">uint</span><span class="op" id="1669852">(</span><span class="ident" id="1669853">s</span><span class="op" id="1669854">&amp;</span><span class="num" id="1669855">31</span><span class="op" id="1669857">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669860">if</span>&nbsp;<span class="op" id="1669863">!</span><span class="ident" id="1669864">sig</span><span class="op" id="1669867">.</span><span class="ident" id="1669868">inuse</span>&nbsp;<span class="op" id="1669874">||</span>&nbsp;<span class="ident" id="1669877">s</span>&nbsp;<span class="op" id="1669879">&lt;</span>&nbsp;<span class="num" id="1669881">0</span>&nbsp;<span class="op" id="1669883">||</span>&nbsp;<span class="builtintype" id="1669886">int</span><span class="op" id="1669889">(</span><span class="ident" id="1669890">s</span><span class="op" id="1669891">)</span>&nbsp;<span class="op" id="1669893">&gt;=</span>&nbsp;<span class="num" id="1669896">32</span><span class="op" id="1669898">*</span><span class="builtinfunc" id="1669899">len</span><span class="op" id="1669902">(</span><span class="ident" id="1669903">sig</span><span class="op" id="1669906">.</span><span class="ident" id="1669907">wanted</span><span class="op" id="1669913">)</span>&nbsp;<span class="op" id="1669915">||</span>&nbsp;<span class="ident" id="1669918">sig</span><span class="op" id="1669921">.</span><span class="ident" id="1669922">wanted</span><span class="op" id="1669928">[</span><span class="ident" id="1669929">s</span><span class="op" id="1669930">/</span><span class="num" id="1669931">32</span><span class="op" id="1669933">]</span><span class="op" id="1669934">&amp;</span><span class="ident" id="1669935">bit</span>&nbsp;<span class="op" id="1669939">==</span>&nbsp;<span class="num" id="1669942">0</span>&nbsp;<span class="op" id="1669944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1669948">return</span>&nbsp;<span class="builtintype" id="1669955">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1669962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1669966">//&nbsp;Add&nbsp;signal&nbsp;to&nbsp;outgoing&nbsp;queue.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670000">for</span>&nbsp;<span class="op" id="1670004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670008">mask</span>&nbsp;<span class="op" id="1670013">:=</span>&nbsp;<span class="ident" id="1670016">sig</span><span class="op" id="1670019">.</span><span class="ident" id="1670020">mask</span><span class="op" id="1670024">[</span><span class="ident" id="1670025">s</span><span class="op" id="1670026">/</span><span class="num" id="1670027">32</span><span class="op" id="1670029">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670033">if</span>&nbsp;<span class="ident" id="1670036">mask</span><span class="op" id="1670040">&amp;</span><span class="ident" id="1670041">bit</span>&nbsp;<span class="op" id="1670045">!=</span>&nbsp;<span class="num" id="1670048">0</span>&nbsp;<span class="op" id="1670050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670055">return</span>&nbsp;<span class="builtintype" id="1670062">true</span>&nbsp;<span class="comment" id="1670067">//&nbsp;signal&nbsp;already&nbsp;in&nbsp;queue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670096">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670100">if</span>&nbsp;<span class="ident" id="1670103">cas</span><span class="op" id="1670106">(</span><span class="op" id="1670107">&amp;</span><span class="ident" id="1670108">sig</span><span class="op" id="1670111">.</span><span class="ident" id="1670112">mask</span><span class="op" id="1670116">[</span><span class="ident" id="1670117">s</span><span class="op" id="1670118">/</span><span class="num" id="1670119">32</span><span class="op" id="1670121">]</span><span class="op" id="1670122">,</span>&nbsp;<span class="ident" id="1670124">mask</span><span class="op" id="1670128">,</span>&nbsp;<span class="ident" id="1670130">mask</span><span class="op" id="1670134">|</span><span class="ident" id="1670135">bit</span><span class="op" id="1670138">)</span>&nbsp;<span class="op" id="1670140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670145">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1670160">//&nbsp;Notify&nbsp;receiver&nbsp;that&nbsp;queue&nbsp;has&nbsp;new&nbsp;bit.</span><br>
<span class="lineno"></span><span class="ident" id="1670203">Send</span><span class="op" id="1670207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670210">for</span>&nbsp;<span class="op" id="1670214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670218">switch</span>&nbsp;<span class="ident" id="1670225">atomicload</span><span class="op" id="1670235">(</span><span class="op" id="1670236">&amp;</span><span class="ident" id="1670237">sig</span><span class="op" id="1670240">.</span><span class="ident" id="1670241">state</span><span class="op" id="1670246">)</span>&nbsp;<span class="op" id="1670248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670252">default</span><span class="op" id="1670259">:</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670264">gothrow</span><span class="op" id="1670271">(</span><span class="string" id="1670272">&#34;sigsend:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1670301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670305">case</span>&nbsp;<span class="ident" id="1670310">sigIdle</span><span class="op" id="1670317">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670322">if</span>&nbsp;<span class="ident" id="1670325">cas</span><span class="op" id="1670328">(</span><span class="op" id="1670329">&amp;</span><span class="ident" id="1670330">sig</span><span class="op" id="1670333">.</span><span class="ident" id="1670334">state</span><span class="op" id="1670339">,</span>&nbsp;<span class="ident" id="1670341">sigIdle</span><span class="op" id="1670348">,</span>&nbsp;<span class="ident" id="1670350">sigSending</span><span class="op" id="1670360">)</span>&nbsp;<span class="op" id="1670362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670368">break</span>&nbsp;<span class="ident" id="1670374">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670382">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670386">case</span>&nbsp;<span class="ident" id="1670391">sigSending</span><span class="op" id="1670401">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1670406">//&nbsp;notification&nbsp;already&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670441">break</span>&nbsp;<span class="ident" id="1670447">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670454">case</span>&nbsp;<span class="ident" id="1670459">sigReceiving</span><span class="op" id="1670471">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670476">if</span>&nbsp;<span class="ident" id="1670479">cas</span><span class="op" id="1670482">(</span><span class="op" id="1670483">&amp;</span><span class="ident" id="1670484">sig</span><span class="op" id="1670487">.</span><span class="ident" id="1670488">state</span><span class="op" id="1670493">,</span>&nbsp;<span class="ident" id="1670495">sigReceiving</span><span class="op" id="1670507">,</span>&nbsp;<span class="ident" id="1670509">sigIdle</span><span class="op" id="1670516">)</span>&nbsp;<span class="op" id="1670518">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670524">notewakeup</span><span class="op" id="1670534">(</span><span class="op" id="1670535">&amp;</span><span class="ident" id="1670536">sig</span><span class="op" id="1670539">.</span><span class="ident" id="1670540">note</span><span class="op" id="1670544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670550">break</span>&nbsp;<span class="ident" id="1670556">Send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670571">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670575">return</span>&nbsp;<span class="builtintype" id="1670582">true</span><br>
<span class="lineno"></span><span class="op" id="1670587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1670590">//&nbsp;Called&nbsp;to&nbsp;receive&nbsp;the&nbsp;next&nbsp;queued&nbsp;signal.</span><br>
<span class="lineno">90</span><span class="comment" id="1670635">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1670693">func</span>&nbsp;<span class="ident" id="1670698">signal_recv</span><span class="op" id="1670709">(</span><span class="op" id="1670710">)</span>&nbsp;<span class="builtintype" id="1670712">uint32</span>&nbsp;<span class="op" id="1670719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670722">for</span>&nbsp;<span class="op" id="1670726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1670730">//&nbsp;Serve&nbsp;any&nbsp;signals&nbsp;from&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670770">for</span>&nbsp;<span class="ident" id="1670774">i</span>&nbsp;<span class="op" id="1670776">:=</span>&nbsp;<span class="builtintype" id="1670779">uint32</span><span class="op" id="1670785">(</span><span class="num" id="1670786">0</span><span class="op" id="1670787">)</span><span class="op" id="1670788">;</span>&nbsp;<span class="ident" id="1670790">i</span>&nbsp;<span class="op" id="1670792">&lt;</span>&nbsp;<span class="ident" id="1670794">_NSIG</span><span class="op" id="1670799">;</span>&nbsp;<span class="ident" id="1670801">i</span><span class="op" id="1670802">++</span>&nbsp;<span class="op" id="1670805">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670810">if</span>&nbsp;<span class="ident" id="1670813">sig</span><span class="op" id="1670816">.</span><span class="ident" id="1670817">recv</span><span class="op" id="1670821">[</span><span class="ident" id="1670822">i</span><span class="op" id="1670823">/</span><span class="num" id="1670824">32</span><span class="op" id="1670826">]</span><span class="op" id="1670827">&amp;</span><span class="op" id="1670828">(</span><span class="num" id="1670829">1</span><span class="op" id="1670830">&lt;&lt;</span><span class="op" id="1670832">(</span><span class="ident" id="1670833">i</span><span class="op" id="1670834">&amp;</span><span class="num" id="1670835">31</span><span class="op" id="1670837">)</span><span class="op" id="1670838">)</span>&nbsp;<span class="op" id="1670840">!=</span>&nbsp;<span class="num" id="1670843">0</span>&nbsp;<span class="op" id="1670845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670851">sig</span><span class="op" id="1670854">.</span><span class="ident" id="1670855">recv</span><span class="op" id="1670859">[</span><span class="ident" id="1670860">i</span><span class="op" id="1670861">/</span><span class="num" id="1670862">32</span><span class="op" id="1670864">]</span>&nbsp;<span class="op" id="1670866">&amp;^=</span>&nbsp;<span class="num" id="1670870">1</span>&nbsp;<span class="op" id="1670872">&lt;&lt;</span>&nbsp;<span class="op" id="1670875">(</span><span class="ident" id="1670876">i</span>&nbsp;<span class="op" id="1670878">&amp;</span>&nbsp;<span class="num" id="1670880">31</span><span class="op" id="1670882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670888">return</span>&nbsp;<span class="ident" id="1670895">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1670904">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1670909">//&nbsp;Wait&nbsp;for&nbsp;updates&nbsp;to&nbsp;be&nbsp;available&nbsp;from&nbsp;signal&nbsp;sender.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1670966">Receive</span><span class="op" id="1670973">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670977">for</span>&nbsp;<span class="op" id="1670981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1670986">switch</span>&nbsp;<span class="ident" id="1670993">atomicload</span><span class="op" id="1671003">(</span><span class="op" id="1671004">&amp;</span><span class="ident" id="1671005">sig</span><span class="op" id="1671008">.</span><span class="ident" id="1671009">state</span><span class="op" id="1671014">)</span>&nbsp;<span class="op" id="1671016">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671021">default</span><span class="op" id="1671028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671034">gothrow</span><span class="op" id="1671041">(</span><span class="string" id="1671042">&#34;signal_recv:&nbsp;inconsistent&nbsp;state&#34;</span><span class="op" id="1671075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671080">case</span>&nbsp;<span class="ident" id="1671085">sigIdle</span><span class="op" id="1671092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671098">if</span>&nbsp;<span class="ident" id="1671101">cas</span><span class="op" id="1671104">(</span><span class="op" id="1671105">&amp;</span><span class="ident" id="1671106">sig</span><span class="op" id="1671109">.</span><span class="ident" id="1671110">state</span><span class="op" id="1671115">,</span>&nbsp;<span class="ident" id="1671117">sigIdle</span><span class="op" id="1671124">,</span>&nbsp;<span class="ident" id="1671126">sigReceiving</span><span class="op" id="1671138">)</span>&nbsp;<span class="op" id="1671140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671147">notetsleepg</span><span class="op" id="1671158">(</span><span class="op" id="1671159">&amp;</span><span class="ident" id="1671160">sig</span><span class="op" id="1671163">.</span><span class="ident" id="1671164">note</span><span class="op" id="1671168">,</span>&nbsp;<span class="op" id="1671170">-</span><span class="num" id="1671171">1</span><span class="op" id="1671172">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671179">noteclear</span><span class="op" id="1671188">(</span><span class="op" id="1671189">&amp;</span><span class="ident" id="1671190">sig</span><span class="op" id="1671193">.</span><span class="ident" id="1671194">note</span><span class="op" id="1671198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671205">break</span>&nbsp;<span class="ident" id="1671211">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671228">case</span>&nbsp;<span class="ident" id="1671233">sigSending</span><span class="op" id="1671243">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671249">if</span>&nbsp;<span class="ident" id="1671252">cas</span><span class="op" id="1671255">(</span><span class="op" id="1671256">&amp;</span><span class="ident" id="1671257">sig</span><span class="op" id="1671260">.</span><span class="ident" id="1671261">state</span><span class="op" id="1671266">,</span>&nbsp;<span class="ident" id="1671268">sigSending</span><span class="op" id="1671278">,</span>&nbsp;<span class="ident" id="1671280">sigIdle</span><span class="op" id="1671287">)</span>&nbsp;<span class="op" id="1671289">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671296">break</span>&nbsp;<span class="ident" id="1671302">Receive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671328">//&nbsp;Incorporate&nbsp;updates&nbsp;from&nbsp;sender&nbsp;into&nbsp;local&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671382">for</span>&nbsp;<span class="ident" id="1671386">i</span>&nbsp;<span class="op" id="1671388">:=</span>&nbsp;<span class="keyword" id="1671391">range</span>&nbsp;<span class="ident" id="1671397">sig</span><span class="op" id="1671400">.</span><span class="ident" id="1671401">mask</span>&nbsp;<span class="op" id="1671406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671411">sig</span><span class="op" id="1671414">.</span><span class="ident" id="1671415">recv</span><span class="op" id="1671419">[</span><span class="ident" id="1671420">i</span><span class="op" id="1671421">]</span>&nbsp;<span class="op" id="1671423">=</span>&nbsp;<span class="ident" id="1671425">xchg</span><span class="op" id="1671429">(</span><span class="op" id="1671430">&amp;</span><span class="ident" id="1671431">sig</span><span class="op" id="1671434">.</span><span class="ident" id="1671435">mask</span><span class="op" id="1671439">[</span><span class="ident" id="1671440">i</span><span class="op" id="1671441">]</span><span class="op" id="1671442">,</span>&nbsp;<span class="num" id="1671444">0</span><span class="op" id="1671445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671452">}</span><br>
<span class="lineno">125</span><span class="op" id="1671454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1671457">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1671515">func</span>&nbsp;<span class="ident" id="1671520">signal_enable</span><span class="op" id="1671533">(</span><span class="ident" id="1671534">s</span>&nbsp;<span class="builtintype" id="1671536">uint32</span><span class="op" id="1671542">)</span>&nbsp;<span class="op" id="1671544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671547">if</span>&nbsp;<span class="op" id="1671550">!</span><span class="ident" id="1671551">sig</span><span class="op" id="1671554">.</span><span class="ident" id="1671555">inuse</span>&nbsp;<span class="op" id="1671561">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671565">//&nbsp;The&nbsp;first&nbsp;call&nbsp;to&nbsp;signal_enable&nbsp;is&nbsp;for&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671612">//&nbsp;to&nbsp;use&nbsp;for&nbsp;initialization.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;pass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1671662">//&nbsp;signal&nbsp;information&nbsp;in&nbsp;m.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671692">sig</span><span class="op" id="1671695">.</span><span class="ident" id="1671696">inuse</span>&nbsp;<span class="op" id="1671702">=</span>&nbsp;<span class="builtintype" id="1671704">true</span>&nbsp;<span class="comment" id="1671709">//&nbsp;enable&nbsp;reception&nbsp;of&nbsp;signals;&nbsp;cannot&nbsp;disable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671758">noteclear</span><span class="op" id="1671767">(</span><span class="op" id="1671768">&amp;</span><span class="ident" id="1671769">sig</span><span class="op" id="1671772">.</span><span class="ident" id="1671773">note</span><span class="op" id="1671777">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671781">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671793">if</span>&nbsp;<span class="builtintype" id="1671796">int</span><span class="op" id="1671799">(</span><span class="ident" id="1671800">s</span><span class="op" id="1671801">)</span>&nbsp;<span class="op" id="1671803">&gt;=</span>&nbsp;<span class="builtinfunc" id="1671806">len</span><span class="op" id="1671809">(</span><span class="ident" id="1671810">sig</span><span class="op" id="1671813">.</span><span class="ident" id="1671814">wanted</span><span class="op" id="1671820">)</span><span class="op" id="1671821">*</span><span class="num" id="1671822">32</span>&nbsp;<span class="op" id="1671825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671829">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1671837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671840">sig</span><span class="op" id="1671843">.</span><span class="ident" id="1671844">wanted</span><span class="op" id="1671850">[</span><span class="ident" id="1671851">s</span><span class="op" id="1671852">/</span><span class="num" id="1671853">32</span><span class="op" id="1671855">]</span>&nbsp;<span class="op" id="1671857">|=</span>&nbsp;<span class="num" id="1671860">1</span>&nbsp;<span class="op" id="1671862">&lt;&lt;</span>&nbsp;<span class="op" id="1671865">(</span><span class="ident" id="1671866">s</span>&nbsp;<span class="op" id="1671868">&amp;</span>&nbsp;<span class="num" id="1671870">31</span><span class="op" id="1671872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1671875">sigenable_go</span><span class="op" id="1671887">(</span><span class="ident" id="1671888">s</span><span class="op" id="1671889">)</span><br>
<span class="lineno"></span><span class="op" id="1671891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1671894">//&nbsp;Must&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;a&nbsp;single&nbsp;goroutine&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno"></span><span class="keyword" id="1671952">func</span>&nbsp;<span class="ident" id="1671957">signal_disable</span><span class="op" id="1671971">(</span><span class="ident" id="1671972">s</span>&nbsp;<span class="builtintype" id="1671974">uint32</span><span class="op" id="1671980">)</span>&nbsp;<span class="op" id="1671982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1671985">if</span>&nbsp;<span class="builtintype" id="1671988">int</span><span class="op" id="1671991">(</span><span class="ident" id="1671992">s</span><span class="op" id="1671993">)</span>&nbsp;<span class="op" id="1671995">&gt;=</span>&nbsp;<span class="builtinfunc" id="1671998">len</span><span class="op" id="1672001">(</span><span class="ident" id="1672002">sig</span><span class="op" id="1672005">.</span><span class="ident" id="1672006">wanted</span><span class="op" id="1672012">)</span><span class="op" id="1672013">*</span><span class="num" id="1672014">32</span>&nbsp;<span class="op" id="1672017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1672021">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1672029">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672032">sig</span><span class="op" id="1672035">.</span><span class="ident" id="1672036">wanted</span><span class="op" id="1672042">[</span><span class="ident" id="1672043">s</span><span class="op" id="1672044">/</span><span class="num" id="1672045">32</span><span class="op" id="1672047">]</span>&nbsp;<span class="op" id="1672049">&amp;^=</span>&nbsp;<span class="num" id="1672053">1</span>&nbsp;<span class="op" id="1672055">&lt;&lt;</span>&nbsp;<span class="op" id="1672058">(</span><span class="ident" id="1672059">s</span>&nbsp;<span class="op" id="1672061">&amp;</span>&nbsp;<span class="num" id="1672063">31</span><span class="op" id="1672065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672068">sigdisable_go</span><span class="op" id="1672081">(</span><span class="ident" id="1672082">s</span><span class="op" id="1672083">)</span><br>
<span class="lineno"></span><span class="op" id="1672085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1672088">//&nbsp;This&nbsp;runs&nbsp;on&nbsp;a&nbsp;foreign&nbsp;stack,&nbsp;without&nbsp;an&nbsp;m&nbsp;or&nbsp;a&nbsp;g.&nbsp;&nbsp;No&nbsp;stack&nbsp;split.</span><br>
<span class="lineno">155</span><span class="comment" id="1672159">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1672172">func</span>&nbsp;<span class="ident" id="1672177">badsignal</span><span class="op" id="1672186">(</span><span class="ident" id="1672187">sig</span>&nbsp;<span class="builtintype" id="1672191">uintptr</span><span class="op" id="1672198">)</span>&nbsp;<span class="op" id="1672200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672203">cgocallback</span><span class="op" id="1672214">(</span><span class="ident" id="1672215">unsafe</span><span class="op" id="1672221">.</span><span class="ident" id="1672222">Pointer</span><span class="op" id="1672229">(</span><span class="ident" id="1672230">funcPC</span><span class="op" id="1672236">(</span><span class="ident" id="1672237">sigsend</span><span class="op" id="1672244">)</span><span class="op" id="1672245">)</span><span class="op" id="1672246">,</span>&nbsp;<span class="ident" id="1672248">noescape</span><span class="op" id="1672256">(</span><span class="ident" id="1672257">unsafe</span><span class="op" id="1672263">.</span><span class="ident" id="1672264">Pointer</span><span class="op" id="1672271">(</span><span class="op" id="1672272">&amp;</span><span class="ident" id="1672273">sig</span><span class="op" id="1672276">)</span><span class="op" id="1672277">)</span><span class="op" id="1672278">,</span>&nbsp;<span class="ident" id="1672280">unsafe</span><span class="op" id="1672286">.</span><span class="ident" id="1672287">Sizeof</span><span class="op" id="1672293">(</span><span class="ident" id="1672294">sig</span><span class="op" id="1672297">)</span><span class="op" id="1672298">)</span><br>
<span class="lineno"></span><span class="op" id="1672300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="1672303">func</span>&nbsp;<span class="ident" id="1672308">sigenable_m</span><span class="op" id="1672319">(</span><span class="op" id="1672320">)</span><br>
<span class="lineno"></span><span class="keyword" id="1672322">func</span>&nbsp;<span class="ident" id="1672327">sigdisable_m</span><span class="op" id="1672339">(</span><span class="op" id="1672340">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1672343">func</span>&nbsp;<span class="ident" id="1672348">sigenable_go</span><span class="op" id="1672360">(</span><span class="ident" id="1672361">s</span>&nbsp;<span class="builtintype" id="1672363">uint32</span><span class="op" id="1672369">)</span>&nbsp;<span class="op" id="1672371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672374">g</span>&nbsp;<span class="op" id="1672376">:=</span>&nbsp;<span class="ident" id="1672379">getg</span><span class="op" id="1672383">(</span><span class="op" id="1672384">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672387">g</span><span class="op" id="1672388">.</span><span class="ident" id="1672389">m</span><span class="op" id="1672390">.</span><span class="ident" id="1672391">scalararg</span><span class="op" id="1672400">[</span><span class="num" id="1672401">0</span><span class="op" id="1672402">]</span>&nbsp;<span class="op" id="1672404">=</span>&nbsp;<span class="builtintype" id="1672406">uintptr</span><span class="op" id="1672413">(</span><span class="ident" id="1672414">s</span><span class="op" id="1672415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672418">onM</span><span class="op" id="1672421">(</span><span class="ident" id="1672422">sigenable_m</span><span class="op" id="1672433">)</span><br>
<span class="lineno"></span><span class="op" id="1672435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1672438">func</span>&nbsp;<span class="ident" id="1672443">sigdisable_go</span><span class="op" id="1672456">(</span><span class="ident" id="1672457">s</span>&nbsp;<span class="builtintype" id="1672459">uint32</span><span class="op" id="1672465">)</span>&nbsp;<span class="op" id="1672467">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672470">g</span>&nbsp;<span class="op" id="1672472">:=</span>&nbsp;<span class="ident" id="1672475">getg</span><span class="op" id="1672479">(</span><span class="op" id="1672480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672483">g</span><span class="op" id="1672484">.</span><span class="ident" id="1672485">m</span><span class="op" id="1672486">.</span><span class="ident" id="1672487">scalararg</span><span class="op" id="1672496">[</span><span class="num" id="1672497">0</span><span class="op" id="1672498">]</span>&nbsp;<span class="op" id="1672500">=</span>&nbsp;<span class="builtintype" id="1672502">uintptr</span><span class="op" id="1672509">(</span><span class="ident" id="1672510">s</span><span class="op" id="1672511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1672514">onM</span><span class="op" id="1672517">(</span><span class="ident" id="1672518">sigdisable_m</span><span class="op" id="1672530">)</span><br>
<span class="lineno"></span><span class="op" id="1672532">}</span>
</div>
</body>
</html>
