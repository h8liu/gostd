<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3013107">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3013162">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3013216">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3013267">//&nbsp;HTTP&nbsp;server.&nbsp;&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013299">package</span>&nbsp;<span class="ident" id="3013307">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3013313">import</span>&nbsp;<span class="op" id="3013320">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013323">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013332">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013346">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013356">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013363">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013369">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013382">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013389">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013396">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013407">&#34;os&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013413">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013421">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013432">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013443">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013454">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013462">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3013477">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3013484">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3013487">//&nbsp;Errors&nbsp;introduced&nbsp;by&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">30</span><span class="keyword" id="3013528">var</span>&nbsp;<span class="op" id="3013532">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013535">ErrWriteAfterFlush</span>&nbsp;<span class="op" id="3013554">=</span>&nbsp;<span class="ident" id="3013556">errors</span><span class="op" id="3013562">.</span><span class="ident" id="3013563">New</span><span class="op" id="3013566">(</span><span class="string" id="3013567">&#34;Conn.Write&nbsp;called&nbsp;after&nbsp;Flush&#34;</span><span class="op" id="3013598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013601">ErrBodyNotAllowed</span>&nbsp;&nbsp;<span class="op" id="3013620">=</span>&nbsp;<span class="ident" id="3013622">errors</span><span class="op" id="3013628">.</span><span class="ident" id="3013629">New</span><span class="op" id="3013632">(</span><span class="string" id="3013633">&#34;http:&nbsp;request&nbsp;method&nbsp;or&nbsp;response&nbsp;status&nbsp;code&nbsp;does&nbsp;not&nbsp;allow&nbsp;body&#34;</span><span class="op" id="3013699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013702">ErrHijacked</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3013721">=</span>&nbsp;<span class="ident" id="3013723">errors</span><span class="op" id="3013729">.</span><span class="ident" id="3013730">New</span><span class="op" id="3013733">(</span><span class="string" id="3013734">&#34;Conn&nbsp;has&nbsp;been&nbsp;hijacked&#34;</span><span class="op" id="3013758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3013761">ErrContentLength</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3013780">=</span>&nbsp;<span class="ident" id="3013782">errors</span><span class="op" id="3013788">.</span><span class="ident" id="3013789">New</span><span class="op" id="3013792">(</span><span class="string" id="3013793">&#34;Conn.Write&nbsp;wrote&nbsp;more&nbsp;than&nbsp;the&nbsp;declared&nbsp;Content-Length&#34;</span><span class="op" id="3013849">)</span><br>
<span class="lineno">35</span><span class="op" id="3013851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3013854">//&nbsp;Objects&nbsp;implementing&nbsp;the&nbsp;Handler&nbsp;interface&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3013907">//&nbsp;registered&nbsp;to&nbsp;serve&nbsp;a&nbsp;particular&nbsp;path&nbsp;or&nbsp;subtree</span><br>
<span class="lineno"></span><span class="comment" id="3013959">//&nbsp;in&nbsp;the&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">40</span><span class="comment" id="3013982">//</span><br>
<span class="lineno"></span><span class="comment" id="3013985">//&nbsp;ServeHTTP&nbsp;should&nbsp;write&nbsp;reply&nbsp;headers&nbsp;and&nbsp;data&nbsp;to&nbsp;the&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3014056">//&nbsp;and&nbsp;then&nbsp;return.&nbsp;&nbsp;Returning&nbsp;signals&nbsp;that&nbsp;the&nbsp;request&nbsp;is&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3014124">//&nbsp;and&nbsp;that&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;can&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3014187">//&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">45</span><span class="comment" id="3014206">//</span><br>
<span class="lineno"></span><span class="comment" id="3014209">//&nbsp;If&nbsp;ServeHTTP&nbsp;panics,&nbsp;the&nbsp;server&nbsp;(the&nbsp;caller&nbsp;of&nbsp;ServeHTTP)&nbsp;assumes</span><br>
<span class="lineno"></span><span class="comment" id="3014278">//&nbsp;that&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;panic&nbsp;was&nbsp;isolated&nbsp;to&nbsp;the&nbsp;active&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3014346">//&nbsp;It&nbsp;recovers&nbsp;the&nbsp;panic,&nbsp;logs&nbsp;a&nbsp;stack&nbsp;trace&nbsp;to&nbsp;the&nbsp;server&nbsp;error&nbsp;log,</span><br>
<span class="lineno"></span><span class="comment" id="3014416">//&nbsp;and&nbsp;hangs&nbsp;up&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">50</span><span class="comment" id="3014448">//</span><br>
<span class="lineno"></span><span class="keyword" id="3014451">type</span>&nbsp;<span class="ident" id="3014456">Handler</span>&nbsp;<span class="keyword" id="3014464">interface</span>&nbsp;<span class="op" id="3014474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014477">ServeHTTP</span><span class="op" id="3014486">(</span><span class="ident" id="3014487">ResponseWriter</span><span class="op" id="3014501">,</span>&nbsp;<span class="op" id="3014503">*</span><span class="ident" id="3014504">Request</span><span class="op" id="3014511">)</span><br>
<span class="lineno"></span><span class="op" id="3014513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3014516">//&nbsp;A&nbsp;ResponseWriter&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3014576">//&nbsp;construct&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3014607">type</span>&nbsp;<span class="ident" id="3014612">ResponseWriter</span>&nbsp;<span class="keyword" id="3014627">interface</span>&nbsp;<span class="op" id="3014637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014640">//&nbsp;Header&nbsp;returns&nbsp;the&nbsp;header&nbsp;map&nbsp;that&nbsp;will&nbsp;be&nbsp;sent&nbsp;by&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014708">//&nbsp;Changing&nbsp;the&nbsp;header&nbsp;after&nbsp;a&nbsp;call&nbsp;to&nbsp;WriteHeader&nbsp;(or&nbsp;Write)&nbsp;has</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014775">//&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3014790">Header</span><span class="op" id="3014796">(</span><span class="op" id="3014797">)</span>&nbsp;<span class="ident" id="3014799">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014808">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;data&nbsp;to&nbsp;the&nbsp;connection&nbsp;as&nbsp;part&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014878">//&nbsp;If&nbsp;WriteHeader&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;called,&nbsp;Write&nbsp;calls&nbsp;WriteHeader(http.StatusOK)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3014961">//&nbsp;before&nbsp;writing&nbsp;the&nbsp;data.&nbsp;&nbsp;If&nbsp;the&nbsp;Header&nbsp;does&nbsp;not&nbsp;contain&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015024">//&nbsp;Content-Type&nbsp;line,&nbsp;Write&nbsp;adds&nbsp;a&nbsp;Content-Type&nbsp;set&nbsp;to&nbsp;the&nbsp;result&nbsp;of&nbsp;passing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015102">//&nbsp;the&nbsp;initial&nbsp;512&nbsp;bytes&nbsp;of&nbsp;written&nbsp;data&nbsp;to&nbsp;DetectContentType.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015166">Write</span><span class="op" id="3015171">(</span><span class="op" id="3015172">[</span><span class="op" id="3015173">]</span><span class="builtintype" id="3015174">byte</span><span class="op" id="3015178">)</span>&nbsp;<span class="op" id="3015180">(</span><span class="builtintype" id="3015181">int</span><span class="op" id="3015184">,</span>&nbsp;<span class="builtintype" id="3015186">error</span><span class="op" id="3015191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015195">//&nbsp;WriteHeader&nbsp;sends&nbsp;an&nbsp;HTTP&nbsp;response&nbsp;header&nbsp;with&nbsp;status&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015259">//&nbsp;If&nbsp;WriteHeader&nbsp;is&nbsp;not&nbsp;called&nbsp;explicitly,&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Write</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015328">//&nbsp;will&nbsp;trigger&nbsp;an&nbsp;implicit&nbsp;WriteHeader(http.StatusOK).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015385">//&nbsp;Thus&nbsp;explicit&nbsp;calls&nbsp;to&nbsp;WriteHeader&nbsp;are&nbsp;mainly&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015443">//&nbsp;send&nbsp;error&nbsp;codes.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015465">WriteHeader</span><span class="op" id="3015476">(</span><span class="builtintype" id="3015477">int</span><span class="op" id="3015480">)</span><br>
<span class="lineno"></span><span class="op" id="3015482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3015485">//&nbsp;The&nbsp;Flusher&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3015555">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;flush&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno">80</span><span class="comment" id="3015612">//</span><br>
<span class="lineno"></span><span class="comment" id="3015615">//&nbsp;Note&nbsp;that&nbsp;even&nbsp;for&nbsp;ResponseWriters&nbsp;that&nbsp;support&nbsp;Flush,</span><br>
<span class="lineno"></span><span class="comment" id="3015673">//&nbsp;if&nbsp;the&nbsp;client&nbsp;is&nbsp;connected&nbsp;through&nbsp;an&nbsp;HTTP&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3015726">//&nbsp;the&nbsp;buffered&nbsp;data&nbsp;may&nbsp;not&nbsp;reach&nbsp;the&nbsp;client&nbsp;until&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span><span class="comment" id="3015791">//&nbsp;completes.</span><br>
<span class="lineno">85</span><span class="keyword" id="3015805">type</span>&nbsp;<span class="ident" id="3015810">Flusher</span>&nbsp;<span class="keyword" id="3015818">interface</span>&nbsp;<span class="op" id="3015828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3015831">//&nbsp;Flush&nbsp;sends&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3015880">Flush</span><span class="op" id="3015885">(</span><span class="op" id="3015886">)</span><br>
<span class="lineno"></span><span class="op" id="3015888">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="comment" id="3015891">//&nbsp;The&nbsp;Hijacker&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;that&nbsp;allow</span><br>
<span class="lineno"></span><span class="comment" id="3015962">//&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;to&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3016010">type</span>&nbsp;<span class="ident" id="3016015">Hijacker</span>&nbsp;<span class="keyword" id="3016024">interface</span>&nbsp;<span class="op" id="3016034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016037">//&nbsp;Hijack&nbsp;lets&nbsp;the&nbsp;caller&nbsp;take&nbsp;over&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016090">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Hijack(),&nbsp;the&nbsp;HTTP&nbsp;server&nbsp;library</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016144">//&nbsp;will&nbsp;not&nbsp;do&nbsp;anything&nbsp;else&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016195">//&nbsp;It&nbsp;becomes&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;manage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016248">//&nbsp;and&nbsp;close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016278">Hijack</span><span class="op" id="3016284">(</span><span class="op" id="3016285">)</span>&nbsp;<span class="op" id="3016287">(</span><span class="ident" id="3016288">net</span><span class="op" id="3016291">.</span><span class="ident" id="3016292">Conn</span><span class="op" id="3016296">,</span>&nbsp;<span class="op" id="3016298">*</span><span class="ident" id="3016299">bufio</span><span class="op" id="3016304">.</span><span class="ident" id="3016305">ReadWriter</span><span class="op" id="3016315">,</span>&nbsp;<span class="builtintype" id="3016317">error</span><span class="op" id="3016322">)</span><br>
<span class="lineno"></span><span class="op" id="3016324">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="3016327">//&nbsp;The&nbsp;CloseNotifier&nbsp;interface&nbsp;is&nbsp;implemented&nbsp;by&nbsp;ResponseWriters&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3016398">//&nbsp;allow&nbsp;detecting&nbsp;when&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span><span class="comment" id="3016463">//</span><br>
<span class="lineno"></span><span class="comment" id="3016466">//&nbsp;This&nbsp;mechanism&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;cancel&nbsp;long&nbsp;operations&nbsp;on&nbsp;the&nbsp;server</span><br>
<span class="lineno">105</span><span class="comment" id="3016536">//&nbsp;if&nbsp;the&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;before&nbsp;the&nbsp;response&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3016600">type</span>&nbsp;<span class="ident" id="3016605">CloseNotifier</span>&nbsp;<span class="keyword" id="3016619">interface</span>&nbsp;<span class="op" id="3016629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016632">//&nbsp;CloseNotify&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;receives&nbsp;a&nbsp;single&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016695">//&nbsp;when&nbsp;the&nbsp;client&nbsp;connection&nbsp;has&nbsp;gone&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016741">CloseNotify</span><span class="op" id="3016752">(</span><span class="op" id="3016753">)</span>&nbsp;<span class="op" id="3016755">&lt;-</span><span class="keyword" id="3016757">chan</span>&nbsp;<span class="builtintype" id="3016762">bool</span><br>
<span class="lineno">110</span><span class="op" id="3016767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3016770">//&nbsp;A&nbsp;conn&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3016830">type</span>&nbsp;<span class="ident" id="3016835">conn</span>&nbsp;<span class="keyword" id="3016840">struct</span>&nbsp;<span class="op" id="3016847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016850">remoteAddr</span>&nbsp;<span class="builtintype" id="3016861">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016882">//&nbsp;network&nbsp;address&nbsp;of&nbsp;remote&nbsp;side</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016917">server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3016928">*</span><span class="ident" id="3016929">Server</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3016949">//&nbsp;the&nbsp;Server&nbsp;on&nbsp;which&nbsp;the&nbsp;connection&nbsp;arrived</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3016996">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017007">net</span><span class="op" id="3017010">.</span><span class="ident" id="3017011">Conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017028">//&nbsp;i/o&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017047">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017058">io</span><span class="op" id="3017060">.</span><span class="ident" id="3017061">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017079">//&nbsp;checkConnErrorWriter&#39;s&nbsp;copy&nbsp;of&nbsp;wrc,&nbsp;not&nbsp;zeroed&nbsp;on&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017140">werr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3017151">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017172">//&nbsp;any&nbsp;errors&nbsp;writing&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017200">sr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017211">liveSwitchReader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017232">//&nbsp;where&nbsp;the&nbsp;LimitReader&nbsp;reads&nbsp;from;&nbsp;usually&nbsp;the&nbsp;rwc</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017286">lr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017297">*</span><span class="ident" id="3017298">io</span><span class="op" id="3017300">.</span><span class="ident" id="3017301">LimitedReader</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017318">//&nbsp;io.LimitReader(sr)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017341">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017352">*</span><span class="ident" id="3017353">bufio</span><span class="op" id="3017358">.</span><span class="ident" id="3017359">ReadWriter</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017373">//&nbsp;buffered(lr,rwc),&nbsp;reading&nbsp;from&nbsp;bufio-&gt;limitReader-&gt;sr-&gt;rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017436">tlsState</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3017447">*</span><span class="ident" id="3017448">tls</span><span class="op" id="3017451">.</span><span class="ident" id="3017452">ConnectionState</span>&nbsp;<span class="comment" id="3017468">//&nbsp;or&nbsp;nil&nbsp;when&nbsp;not&nbsp;using&nbsp;TLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017499">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017512">sync</span><span class="op" id="3017516">.</span><span class="ident" id="3017517">Mutex</span>&nbsp;<span class="comment" id="3017523">//&nbsp;guards&nbsp;the&nbsp;following</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017548">clientGone</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3017561">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017572">//&nbsp;if&nbsp;client&nbsp;has&nbsp;disconnected&nbsp;mid-request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017615">closeNotifyc</span>&nbsp;<span class="keyword" id="3017628">chan</span>&nbsp;<span class="builtintype" id="3017633">bool</span>&nbsp;&nbsp;<span class="comment" id="3017639">//&nbsp;made&nbsp;lazily</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017655">hijackedv</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3017668">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3017679">//&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked&nbsp;by&nbsp;handler</span><br>
<span class="lineno"></span><span class="op" id="3017722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="3017725">func</span>&nbsp;<span class="op" id="3017730">(</span><span class="ident" id="3017731">c</span>&nbsp;<span class="op" id="3017733">*</span><span class="ident" id="3017734">conn</span><span class="op" id="3017738">)</span>&nbsp;<span class="ident" id="3017740">hijacked</span><span class="op" id="3017748">(</span><span class="op" id="3017749">)</span>&nbsp;<span class="builtintype" id="3017751">bool</span>&nbsp;<span class="op" id="3017756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017759">c</span><span class="op" id="3017760">.</span><span class="ident" id="3017761">mu</span><span class="op" id="3017763">.</span><span class="ident" id="3017764">Lock</span><span class="op" id="3017768">(</span><span class="op" id="3017769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017772">defer</span>&nbsp;<span class="ident" id="3017778">c</span><span class="op" id="3017779">.</span><span class="ident" id="3017780">mu</span><span class="op" id="3017782">.</span><span class="ident" id="3017783">Unlock</span><span class="op" id="3017789">(</span><span class="op" id="3017790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017793">return</span>&nbsp;<span class="ident" id="3017800">c</span><span class="op" id="3017801">.</span><span class="ident" id="3017802">hijackedv</span><br>
<span class="lineno"></span><span class="op" id="3017812">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="3017815">func</span>&nbsp;<span class="op" id="3017820">(</span><span class="ident" id="3017821">c</span>&nbsp;<span class="op" id="3017823">*</span><span class="ident" id="3017824">conn</span><span class="op" id="3017828">)</span>&nbsp;<span class="ident" id="3017830">hijack</span><span class="op" id="3017836">(</span><span class="op" id="3017837">)</span>&nbsp;<span class="op" id="3017839">(</span><span class="ident" id="3017840">rwc</span>&nbsp;<span class="ident" id="3017844">net</span><span class="op" id="3017847">.</span><span class="ident" id="3017848">Conn</span><span class="op" id="3017852">,</span>&nbsp;<span class="ident" id="3017854">buf</span>&nbsp;<span class="op" id="3017858">*</span><span class="ident" id="3017859">bufio</span><span class="op" id="3017864">.</span><span class="ident" id="3017865">ReadWriter</span><span class="op" id="3017875">,</span>&nbsp;<span class="ident" id="3017877">err</span>&nbsp;<span class="builtintype" id="3017881">error</span><span class="op" id="3017886">)</span>&nbsp;<span class="op" id="3017888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3017891">c</span><span class="op" id="3017892">.</span><span class="ident" id="3017893">mu</span><span class="op" id="3017895">.</span><span class="ident" id="3017896">Lock</span><span class="op" id="3017900">(</span><span class="op" id="3017901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017904">defer</span>&nbsp;<span class="ident" id="3017910">c</span><span class="op" id="3017911">.</span><span class="ident" id="3017912">mu</span><span class="op" id="3017914">.</span><span class="ident" id="3017915">Unlock</span><span class="op" id="3017921">(</span><span class="op" id="3017922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017925">if</span>&nbsp;<span class="ident" id="3017928">c</span><span class="op" id="3017929">.</span><span class="ident" id="3017930">hijackedv</span>&nbsp;<span class="op" id="3017940">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017944">return</span>&nbsp;<span class="builtintype" id="3017951">nil</span><span class="op" id="3017954">,</span>&nbsp;<span class="builtintype" id="3017956">nil</span><span class="op" id="3017959">,</span>&nbsp;<span class="ident" id="3017961">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3017974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3017977">if</span>&nbsp;<span class="ident" id="3017980">c</span><span class="op" id="3017981">.</span><span class="ident" id="3017982">closeNotifyc</span>&nbsp;<span class="op" id="3017995">!=</span>&nbsp;<span class="builtintype" id="3017998">nil</span>&nbsp;<span class="op" id="3018002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018006">return</span>&nbsp;<span class="builtintype" id="3018013">nil</span><span class="op" id="3018016">,</span>&nbsp;<span class="builtintype" id="3018018">nil</span><span class="op" id="3018021">,</span>&nbsp;<span class="ident" id="3018023">errors</span><span class="op" id="3018029">.</span><span class="ident" id="3018030">New</span><span class="op" id="3018033">(</span><span class="string" id="3018034">&#34;http:&nbsp;Hijack&nbsp;is&nbsp;incompatible&nbsp;with&nbsp;use&nbsp;of&nbsp;CloseNotifier&#34;</span><span class="op" id="3018090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018093">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018096">c</span><span class="op" id="3018097">.</span><span class="ident" id="3018098">hijackedv</span>&nbsp;<span class="op" id="3018108">=</span>&nbsp;<span class="builtintype" id="3018110">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018116">rwc</span>&nbsp;<span class="op" id="3018120">=</span>&nbsp;<span class="ident" id="3018122">c</span><span class="op" id="3018123">.</span><span class="ident" id="3018124">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018129">buf</span>&nbsp;<span class="op" id="3018133">=</span>&nbsp;<span class="ident" id="3018135">c</span><span class="op" id="3018136">.</span><span class="ident" id="3018137">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018142">c</span><span class="op" id="3018143">.</span><span class="ident" id="3018144">rwc</span>&nbsp;<span class="op" id="3018148">=</span>&nbsp;<span class="builtintype" id="3018150">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018155">c</span><span class="op" id="3018156">.</span><span class="ident" id="3018157">buf</span>&nbsp;<span class="op" id="3018161">=</span>&nbsp;<span class="builtintype" id="3018163">nil</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018168">c</span><span class="op" id="3018169">.</span><span class="ident" id="3018170">setState</span><span class="op" id="3018178">(</span><span class="ident" id="3018179">rwc</span><span class="op" id="3018182">,</span>&nbsp;<span class="ident" id="3018184">StateHijacked</span><span class="op" id="3018197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018200">return</span><br>
<span class="lineno"></span><span class="op" id="3018207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3018210">func</span>&nbsp;<span class="op" id="3018215">(</span><span class="ident" id="3018216">c</span>&nbsp;<span class="op" id="3018218">*</span><span class="ident" id="3018219">conn</span><span class="op" id="3018223">)</span>&nbsp;<span class="ident" id="3018225">closeNotify</span><span class="op" id="3018236">(</span><span class="op" id="3018237">)</span>&nbsp;<span class="op" id="3018239">&lt;-</span><span class="keyword" id="3018241">chan</span>&nbsp;<span class="builtintype" id="3018246">bool</span>&nbsp;<span class="op" id="3018251">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018254">c</span><span class="op" id="3018255">.</span><span class="ident" id="3018256">mu</span><span class="op" id="3018258">.</span><span class="ident" id="3018259">Lock</span><span class="op" id="3018263">(</span><span class="op" id="3018264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018267">defer</span>&nbsp;<span class="ident" id="3018273">c</span><span class="op" id="3018274">.</span><span class="ident" id="3018275">mu</span><span class="op" id="3018277">.</span><span class="ident" id="3018278">Unlock</span><span class="op" id="3018284">(</span><span class="op" id="3018285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018288">if</span>&nbsp;<span class="ident" id="3018291">c</span><span class="op" id="3018292">.</span><span class="ident" id="3018293">closeNotifyc</span>&nbsp;<span class="op" id="3018306">==</span>&nbsp;<span class="builtintype" id="3018309">nil</span>&nbsp;<span class="op" id="3018313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018317">c</span><span class="op" id="3018318">.</span><span class="ident" id="3018319">closeNotifyc</span>&nbsp;<span class="op" id="3018332">=</span>&nbsp;<span class="builtinfunc" id="3018334">make</span><span class="op" id="3018338">(</span><span class="keyword" id="3018339">chan</span>&nbsp;<span class="builtintype" id="3018344">bool</span><span class="op" id="3018348">,</span>&nbsp;<span class="num" id="3018350">1</span><span class="op" id="3018351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018355">if</span>&nbsp;<span class="ident" id="3018358">c</span><span class="op" id="3018359">.</span><span class="ident" id="3018360">hijackedv</span>&nbsp;<span class="op" id="3018370">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3018375">//&nbsp;to&nbsp;obey&nbsp;the&nbsp;function&nbsp;signature,&nbsp;even&nbsp;though</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3018425">//&nbsp;it&#39;ll&nbsp;never&nbsp;receive&nbsp;a&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018460">return</span>&nbsp;<span class="ident" id="3018467">c</span><span class="op" id="3018468">.</span><span class="ident" id="3018469">closeNotifyc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018488">pr</span><span class="op" id="3018490">,</span>&nbsp;<span class="ident" id="3018492">pw</span>&nbsp;<span class="op" id="3018495">:=</span>&nbsp;<span class="ident" id="3018498">io</span><span class="op" id="3018500">.</span><span class="ident" id="3018501">Pipe</span><span class="op" id="3018505">(</span><span class="op" id="3018506">)</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018511">readSource</span>&nbsp;<span class="op" id="3018522">:=</span>&nbsp;<span class="ident" id="3018525">c</span><span class="op" id="3018526">.</span><span class="ident" id="3018527">sr</span><span class="op" id="3018529">.</span><span class="ident" id="3018530">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018534">c</span><span class="op" id="3018535">.</span><span class="ident" id="3018536">sr</span><span class="op" id="3018538">.</span><span class="ident" id="3018539">Lock</span><span class="op" id="3018543">(</span><span class="op" id="3018544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018548">c</span><span class="op" id="3018549">.</span><span class="ident" id="3018550">sr</span><span class="op" id="3018552">.</span><span class="ident" id="3018553">r</span>&nbsp;<span class="op" id="3018555">=</span>&nbsp;<span class="ident" id="3018557">pr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018562">c</span><span class="op" id="3018563">.</span><span class="ident" id="3018564">sr</span><span class="op" id="3018566">.</span><span class="ident" id="3018567">Unlock</span><span class="op" id="3018573">(</span><span class="op" id="3018574">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018578">go</span>&nbsp;<span class="keyword" id="3018581">func</span><span class="op" id="3018585">(</span><span class="op" id="3018586">)</span>&nbsp;<span class="op" id="3018588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018593">_</span><span class="op" id="3018594">,</span>&nbsp;<span class="ident" id="3018596">err</span>&nbsp;<span class="op" id="3018600">:=</span>&nbsp;<span class="ident" id="3018603">io</span><span class="op" id="3018605">.</span><span class="ident" id="3018606">Copy</span><span class="op" id="3018610">(</span><span class="ident" id="3018611">pw</span><span class="op" id="3018613">,</span>&nbsp;<span class="ident" id="3018615">readSource</span><span class="op" id="3018625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018630">if</span>&nbsp;<span class="ident" id="3018633">err</span>&nbsp;<span class="op" id="3018637">==</span>&nbsp;<span class="builtintype" id="3018640">nil</span>&nbsp;<span class="op" id="3018644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018650">err</span>&nbsp;<span class="op" id="3018654">=</span>&nbsp;<span class="ident" id="3018656">io</span><span class="op" id="3018658">.</span><span class="ident" id="3018659">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018666">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018671">pw</span><span class="op" id="3018673">.</span><span class="ident" id="3018674">CloseWithError</span><span class="op" id="3018688">(</span><span class="ident" id="3018689">err</span><span class="op" id="3018692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018697">c</span><span class="op" id="3018698">.</span><span class="ident" id="3018699">noteClientGone</span><span class="op" id="3018713">(</span><span class="op" id="3018714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018718">}</span><span class="op" id="3018719">(</span><span class="op" id="3018720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018726">return</span>&nbsp;<span class="ident" id="3018733">c</span><span class="op" id="3018734">.</span><span class="ident" id="3018735">closeNotifyc</span><br>
<span class="lineno">180</span><span class="op" id="3018748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3018751">func</span>&nbsp;<span class="op" id="3018756">(</span><span class="ident" id="3018757">c</span>&nbsp;<span class="op" id="3018759">*</span><span class="ident" id="3018760">conn</span><span class="op" id="3018764">)</span>&nbsp;<span class="ident" id="3018766">noteClientGone</span><span class="op" id="3018780">(</span><span class="op" id="3018781">)</span>&nbsp;<span class="op" id="3018783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018786">c</span><span class="op" id="3018787">.</span><span class="ident" id="3018788">mu</span><span class="op" id="3018790">.</span><span class="ident" id="3018791">Lock</span><span class="op" id="3018795">(</span><span class="op" id="3018796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018799">defer</span>&nbsp;<span class="ident" id="3018805">c</span><span class="op" id="3018806">.</span><span class="ident" id="3018807">mu</span><span class="op" id="3018809">.</span><span class="ident" id="3018810">Unlock</span><span class="op" id="3018816">(</span><span class="op" id="3018817">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3018820">if</span>&nbsp;<span class="ident" id="3018823">c</span><span class="op" id="3018824">.</span><span class="ident" id="3018825">closeNotifyc</span>&nbsp;<span class="op" id="3018838">!=</span>&nbsp;<span class="builtintype" id="3018841">nil</span>&nbsp;<span class="op" id="3018845">&amp;&amp;</span>&nbsp;<span class="op" id="3018848">!</span><span class="ident" id="3018849">c</span><span class="op" id="3018850">.</span><span class="ident" id="3018851">clientGone</span>&nbsp;<span class="op" id="3018862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018866">c</span><span class="op" id="3018867">.</span><span class="ident" id="3018868">closeNotifyc</span>&nbsp;<span class="op" id="3018881">&lt;-</span>&nbsp;<span class="builtintype" id="3018884">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3018890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3018893">c</span><span class="op" id="3018894">.</span><span class="ident" id="3018895">clientGone</span>&nbsp;<span class="op" id="3018906">=</span>&nbsp;<span class="builtintype" id="3018908">true</span><br>
<span class="lineno"></span><span class="op" id="3018913">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3018916">//&nbsp;A&nbsp;switchReader&nbsp;can&nbsp;have&nbsp;its&nbsp;Reader&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3018974">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Reads&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3019026">type</span>&nbsp;<span class="ident" id="3019031">switchReader</span>&nbsp;<span class="keyword" id="3019044">struct</span>&nbsp;<span class="op" id="3019051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019054">io</span><span class="op" id="3019056">.</span><span class="ident" id="3019057">Reader</span><br>
<span class="lineno">195</span><span class="op" id="3019064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3019067">//&nbsp;A&nbsp;switchWriter&nbsp;can&nbsp;have&nbsp;its&nbsp;Writer&nbsp;changed&nbsp;at&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="comment" id="3019125">//&nbsp;It&#39;s&nbsp;not&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;Writes&nbsp;and&nbsp;switches.</span><br>
<span class="lineno"></span><span class="keyword" id="3019178">type</span>&nbsp;<span class="ident" id="3019183">switchWriter</span>&nbsp;<span class="keyword" id="3019196">struct</span>&nbsp;<span class="op" id="3019203">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019206">io</span><span class="op" id="3019208">.</span><span class="ident" id="3019209">Writer</span><br>
<span class="lineno"></span><span class="op" id="3019216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3019219">//&nbsp;A&nbsp;liveSwitchReader&nbsp;is&nbsp;a&nbsp;switchReader&nbsp;that&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent</span><br>
<span class="lineno"></span><span class="comment" id="3019286">//&nbsp;reads&nbsp;and&nbsp;switches,&nbsp;if&nbsp;its&nbsp;mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno">205</span><span class="keyword" id="3019331">type</span>&nbsp;<span class="ident" id="3019336">liveSwitchReader</span>&nbsp;<span class="keyword" id="3019353">struct</span>&nbsp;<span class="op" id="3019360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019363">sync</span><span class="op" id="3019367">.</span><span class="ident" id="3019368">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019375">r</span>&nbsp;<span class="ident" id="3019377">io</span><span class="op" id="3019379">.</span><span class="ident" id="3019380">Reader</span><br>
<span class="lineno"></span><span class="op" id="3019387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="keyword" id="3019390">func</span>&nbsp;<span class="op" id="3019395">(</span><span class="ident" id="3019396">sr</span>&nbsp;<span class="op" id="3019399">*</span><span class="ident" id="3019400">liveSwitchReader</span><span class="op" id="3019416">)</span>&nbsp;<span class="ident" id="3019418">Read</span><span class="op" id="3019422">(</span><span class="ident" id="3019423">p</span>&nbsp;<span class="op" id="3019425">[</span><span class="op" id="3019426">]</span><span class="builtintype" id="3019427">byte</span><span class="op" id="3019431">)</span>&nbsp;<span class="op" id="3019433">(</span><span class="ident" id="3019434">n</span>&nbsp;<span class="builtintype" id="3019436">int</span><span class="op" id="3019439">,</span>&nbsp;<span class="ident" id="3019441">err</span>&nbsp;<span class="builtintype" id="3019445">error</span><span class="op" id="3019450">)</span>&nbsp;<span class="op" id="3019452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019455">sr</span><span class="op" id="3019457">.</span><span class="ident" id="3019458">Lock</span><span class="op" id="3019462">(</span><span class="op" id="3019463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019466">r</span>&nbsp;<span class="op" id="3019468">:=</span>&nbsp;<span class="ident" id="3019471">sr</span><span class="op" id="3019473">.</span><span class="ident" id="3019474">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3019477">sr</span><span class="op" id="3019479">.</span><span class="ident" id="3019480">Unlock</span><span class="op" id="3019486">(</span><span class="op" id="3019487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3019490">return</span>&nbsp;<span class="ident" id="3019497">r</span><span class="op" id="3019498">.</span><span class="ident" id="3019499">Read</span><span class="op" id="3019503">(</span><span class="ident" id="3019504">p</span><span class="op" id="3019505">)</span><br>
<span class="lineno">215</span><span class="op" id="3019507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3019510">//&nbsp;This&nbsp;should&nbsp;be&nbsp;&gt;=&nbsp;512&nbsp;bytes&nbsp;for&nbsp;DetectContentType,</span><br>
<span class="lineno"></span><span class="comment" id="3019564">//&nbsp;but&nbsp;otherwise&nbsp;it&#39;s&nbsp;somewhat&nbsp;arbitrary.</span><br>
<span class="lineno"></span><span class="keyword" id="3019606">const</span>&nbsp;<span class="ident" id="3019612">bufferBeforeChunkingSize</span>&nbsp;<span class="op" id="3019637">=</span>&nbsp;<span class="num" id="3019639">2048</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3019645">//&nbsp;chunkWriter&nbsp;writes&nbsp;to&nbsp;a&nbsp;response&#39;s&nbsp;conn&nbsp;buffer,&nbsp;and&nbsp;is&nbsp;the&nbsp;writer</span><br>
<span class="lineno"></span><span class="comment" id="3019714">//&nbsp;wrapped&nbsp;by&nbsp;the&nbsp;response.bufw&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="3019763">//</span><br>
<span class="lineno"></span><span class="comment" id="3019766">//&nbsp;chunkWriter&nbsp;also&nbsp;is&nbsp;responsible&nbsp;for&nbsp;finalizing&nbsp;the&nbsp;Header,&nbsp;including</span><br>
<span class="lineno">225</span><span class="comment" id="3019838">//&nbsp;conditionally&nbsp;setting&nbsp;the&nbsp;Content-Type&nbsp;and&nbsp;setting&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span><span class="comment" id="3019909">//&nbsp;in&nbsp;cases&nbsp;where&nbsp;the&nbsp;handler&#39;s&nbsp;final&nbsp;output&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3019981">//&nbsp;size.&nbsp;It&nbsp;also&nbsp;conditionally&nbsp;adds&nbsp;chunk&nbsp;headers,&nbsp;when&nbsp;in&nbsp;chunking&nbsp;mode.</span><br>
<span class="lineno"></span><span class="comment" id="3020055">//</span><br>
<span class="lineno"></span><span class="comment" id="3020058">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;above&nbsp;(*response).Write&nbsp;for&nbsp;the&nbsp;entire&nbsp;write&nbsp;flow.</span><br>
<span class="lineno">230</span><span class="keyword" id="3020128">type</span>&nbsp;<span class="ident" id="3020133">chunkWriter</span>&nbsp;<span class="keyword" id="3020145">struct</span>&nbsp;<span class="op" id="3020152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020155">res</span>&nbsp;<span class="op" id="3020159">*</span><span class="ident" id="3020160">response</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020171">//&nbsp;header&nbsp;is&nbsp;either&nbsp;nil&nbsp;or&nbsp;a&nbsp;deep&nbsp;clone&nbsp;of&nbsp;res.handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020233">//&nbsp;at&nbsp;the&nbsp;time&nbsp;of&nbsp;res.WriteHeader,&nbsp;if&nbsp;res.WriteHeader&nbsp;is</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020291">//&nbsp;called&nbsp;and&nbsp;extra&nbsp;buffering&nbsp;is&nbsp;being&nbsp;done&nbsp;to&nbsp;calculate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020349">//&nbsp;Content-Type&nbsp;and/or&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020389">header</span>&nbsp;<span class="ident" id="3020396">Header</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020405">//&nbsp;wroteHeader&nbsp;tells&nbsp;whether&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;written&nbsp;to&nbsp;&#34;the</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020469">//&nbsp;wire&#34;&nbsp;(or&nbsp;rather:&nbsp;w.conn.buf).&nbsp;this&nbsp;is&nbsp;unlike</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020519">//&nbsp;(*response).wroteHeader,&nbsp;which&nbsp;tells&nbsp;only&nbsp;whether&nbsp;it&nbsp;was</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020580">//&nbsp;logically&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020603">wroteHeader</span>&nbsp;<span class="builtintype" id="3020615">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020622">//&nbsp;set&nbsp;by&nbsp;the&nbsp;writeHeader&nbsp;method:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020657">chunking</span>&nbsp;<span class="builtintype" id="3020666">bool</span>&nbsp;<span class="comment" id="3020671">//&nbsp;using&nbsp;chunked&nbsp;transfer&nbsp;encoding&nbsp;for&nbsp;reply&nbsp;body</span><br>
<span class="lineno"></span><span class="op" id="3020721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3020724">var</span>&nbsp;<span class="op" id="3020728">(</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020731">crlf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020742">=</span>&nbsp;<span class="op" id="3020744">[</span><span class="op" id="3020745">]</span><span class="builtintype" id="3020746">byte</span><span class="op" id="3020750">(</span><span class="string" id="3020751">&#34;\r\n&#34;</span><span class="op" id="3020757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020760">colonSpace</span>&nbsp;<span class="op" id="3020771">=</span>&nbsp;<span class="op" id="3020773">[</span><span class="op" id="3020774">]</span><span class="builtintype" id="3020775">byte</span><span class="op" id="3020779">(</span><span class="string" id="3020780">&#34;:&nbsp;&#34;</span><span class="op" id="3020784">)</span><br>
<span class="lineno"></span><span class="op" id="3020786">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3020789">func</span>&nbsp;<span class="op" id="3020794">(</span><span class="ident" id="3020795">cw</span>&nbsp;<span class="op" id="3020798">*</span><span class="ident" id="3020799">chunkWriter</span><span class="op" id="3020810">)</span>&nbsp;<span class="ident" id="3020812">Write</span><span class="op" id="3020817">(</span><span class="ident" id="3020818">p</span>&nbsp;<span class="op" id="3020820">[</span><span class="op" id="3020821">]</span><span class="builtintype" id="3020822">byte</span><span class="op" id="3020826">)</span>&nbsp;<span class="op" id="3020828">(</span><span class="ident" id="3020829">n</span>&nbsp;<span class="builtintype" id="3020831">int</span><span class="op" id="3020834">,</span>&nbsp;<span class="ident" id="3020836">err</span>&nbsp;<span class="builtintype" id="3020840">error</span><span class="op" id="3020845">)</span>&nbsp;<span class="op" id="3020847">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020850">if</span>&nbsp;<span class="op" id="3020853">!</span><span class="ident" id="3020854">cw</span><span class="op" id="3020856">.</span><span class="ident" id="3020857">wroteHeader</span>&nbsp;<span class="op" id="3020869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020873">cw</span><span class="op" id="3020875">.</span><span class="ident" id="3020876">writeHeader</span><span class="op" id="3020887">(</span><span class="ident" id="3020888">p</span><span class="op" id="3020889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020895">if</span>&nbsp;<span class="ident" id="3020898">cw</span><span class="op" id="3020900">.</span><span class="ident" id="3020901">res</span><span class="op" id="3020904">.</span><span class="ident" id="3020905">req</span><span class="op" id="3020908">.</span><span class="ident" id="3020909">Method</span>&nbsp;<span class="op" id="3020916">==</span>&nbsp;<span class="string" id="3020919">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3020926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3020930">//&nbsp;Eat&nbsp;writes.</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020947">return</span>&nbsp;<span class="builtinfunc" id="3020954">len</span><span class="op" id="3020957">(</span><span class="ident" id="3020958">p</span><span class="op" id="3020959">)</span><span class="op" id="3020960">,</span>&nbsp;<span class="builtintype" id="3020962">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3020967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3020970">if</span>&nbsp;<span class="ident" id="3020973">cw</span><span class="op" id="3020975">.</span><span class="ident" id="3020976">chunking</span>&nbsp;<span class="op" id="3020985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3020989">_</span><span class="op" id="3020990">,</span>&nbsp;<span class="ident" id="3020992">err</span>&nbsp;<span class="op" id="3020996">=</span>&nbsp;<span class="ident" id="3020998">fmt</span><span class="op" id="3021001">.</span><span class="ident" id="3021002">Fprintf</span><span class="op" id="3021009">(</span><span class="ident" id="3021010">cw</span><span class="op" id="3021012">.</span><span class="ident" id="3021013">res</span><span class="op" id="3021016">.</span><span class="ident" id="3021017">conn</span><span class="op" id="3021021">.</span><span class="ident" id="3021022">buf</span><span class="op" id="3021025">,</span>&nbsp;<span class="string" id="3021027">&#34;%x\r\n&#34;</span><span class="op" id="3021035">,</span>&nbsp;<span class="builtinfunc" id="3021037">len</span><span class="op" id="3021040">(</span><span class="ident" id="3021041">p</span><span class="op" id="3021042">)</span><span class="op" id="3021043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021047">if</span>&nbsp;<span class="ident" id="3021050">err</span>&nbsp;<span class="op" id="3021054">!=</span>&nbsp;<span class="builtintype" id="3021057">nil</span>&nbsp;<span class="op" id="3021061">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021066">cw</span><span class="op" id="3021068">.</span><span class="ident" id="3021069">res</span><span class="op" id="3021072">.</span><span class="ident" id="3021073">conn</span><span class="op" id="3021077">.</span><span class="ident" id="3021078">rwc</span><span class="op" id="3021081">.</span><span class="ident" id="3021082">Close</span><span class="op" id="3021087">(</span><span class="op" id="3021088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021093">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021108">n</span><span class="op" id="3021109">,</span>&nbsp;<span class="ident" id="3021111">err</span>&nbsp;<span class="op" id="3021115">=</span>&nbsp;<span class="ident" id="3021117">cw</span><span class="op" id="3021119">.</span><span class="ident" id="3021120">res</span><span class="op" id="3021123">.</span><span class="ident" id="3021124">conn</span><span class="op" id="3021128">.</span><span class="ident" id="3021129">buf</span><span class="op" id="3021132">.</span><span class="ident" id="3021133">Write</span><span class="op" id="3021138">(</span><span class="ident" id="3021139">p</span><span class="op" id="3021140">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021143">if</span>&nbsp;<span class="ident" id="3021146">cw</span><span class="op" id="3021148">.</span><span class="ident" id="3021149">chunking</span>&nbsp;<span class="op" id="3021158">&amp;&amp;</span>&nbsp;<span class="ident" id="3021161">err</span>&nbsp;<span class="op" id="3021165">==</span>&nbsp;<span class="builtintype" id="3021168">nil</span>&nbsp;<span class="op" id="3021172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021176">_</span><span class="op" id="3021177">,</span>&nbsp;<span class="ident" id="3021179">err</span>&nbsp;<span class="op" id="3021183">=</span>&nbsp;<span class="ident" id="3021185">cw</span><span class="op" id="3021187">.</span><span class="ident" id="3021188">res</span><span class="op" id="3021191">.</span><span class="ident" id="3021192">conn</span><span class="op" id="3021196">.</span><span class="ident" id="3021197">buf</span><span class="op" id="3021200">.</span><span class="ident" id="3021201">Write</span><span class="op" id="3021206">(</span><span class="ident" id="3021207">crlf</span><span class="op" id="3021211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021217">if</span>&nbsp;<span class="ident" id="3021220">err</span>&nbsp;<span class="op" id="3021224">!=</span>&nbsp;<span class="builtintype" id="3021227">nil</span>&nbsp;<span class="op" id="3021231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021235">cw</span><span class="op" id="3021237">.</span><span class="ident" id="3021238">res</span><span class="op" id="3021241">.</span><span class="ident" id="3021242">conn</span><span class="op" id="3021246">.</span><span class="ident" id="3021247">rwc</span><span class="op" id="3021250">.</span><span class="ident" id="3021251">Close</span><span class="op" id="3021256">(</span><span class="op" id="3021257">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021263">return</span><br>
<span class="lineno"></span><span class="op" id="3021270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3021273">func</span>&nbsp;<span class="op" id="3021278">(</span><span class="ident" id="3021279">cw</span>&nbsp;<span class="op" id="3021282">*</span><span class="ident" id="3021283">chunkWriter</span><span class="op" id="3021294">)</span>&nbsp;<span class="ident" id="3021296">flush</span><span class="op" id="3021301">(</span><span class="op" id="3021302">)</span>&nbsp;<span class="op" id="3021304">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021307">if</span>&nbsp;<span class="op" id="3021310">!</span><span class="ident" id="3021311">cw</span><span class="op" id="3021313">.</span><span class="ident" id="3021314">wroteHeader</span>&nbsp;<span class="op" id="3021326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021330">cw</span><span class="op" id="3021332">.</span><span class="ident" id="3021333">writeHeader</span><span class="op" id="3021344">(</span><span class="builtintype" id="3021345">nil</span><span class="op" id="3021348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021354">cw</span><span class="op" id="3021356">.</span><span class="ident" id="3021357">res</span><span class="op" id="3021360">.</span><span class="ident" id="3021361">conn</span><span class="op" id="3021365">.</span><span class="ident" id="3021366">buf</span><span class="op" id="3021369">.</span><span class="ident" id="3021370">Flush</span><span class="op" id="3021375">(</span><span class="op" id="3021376">)</span><br>
<span class="lineno"></span><span class="op" id="3021378">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="3021381">func</span>&nbsp;<span class="op" id="3021386">(</span><span class="ident" id="3021387">cw</span>&nbsp;<span class="op" id="3021390">*</span><span class="ident" id="3021391">chunkWriter</span><span class="op" id="3021402">)</span>&nbsp;<span class="builtinfunc" id="3021404">close</span><span class="op" id="3021409">(</span><span class="op" id="3021410">)</span>&nbsp;<span class="op" id="3021412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021415">if</span>&nbsp;<span class="op" id="3021418">!</span><span class="ident" id="3021419">cw</span><span class="op" id="3021421">.</span><span class="ident" id="3021422">wroteHeader</span>&nbsp;<span class="op" id="3021434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021438">cw</span><span class="op" id="3021440">.</span><span class="ident" id="3021441">writeHeader</span><span class="op" id="3021452">(</span><span class="builtintype" id="3021453">nil</span><span class="op" id="3021456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021459">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3021462">if</span>&nbsp;<span class="ident" id="3021465">cw</span><span class="op" id="3021467">.</span><span class="ident" id="3021468">chunking</span>&nbsp;<span class="op" id="3021477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021481">//&nbsp;zero&nbsp;EOF&nbsp;chunk,&nbsp;trailer&nbsp;key/value&nbsp;pairs&nbsp;(currently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021537">//&nbsp;unsupported&nbsp;in&nbsp;Go&#39;s&nbsp;server),&nbsp;followed&nbsp;by&nbsp;a&nbsp;blank</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021591">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021602">cw</span><span class="op" id="3021604">.</span><span class="ident" id="3021605">res</span><span class="op" id="3021608">.</span><span class="ident" id="3021609">conn</span><span class="op" id="3021613">.</span><span class="ident" id="3021614">buf</span><span class="op" id="3021617">.</span><span class="ident" id="3021618">WriteString</span><span class="op" id="3021629">(</span><span class="string" id="3021630">&#34;0\r\n\r\n&#34;</span><span class="op" id="3021641">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021644">}</span><br>
<span class="lineno"></span><span class="op" id="3021646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3021649">//&nbsp;A&nbsp;response&nbsp;represents&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;HTTP&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="3021711">type</span>&nbsp;<span class="ident" id="3021716">response</span>&nbsp;<span class="keyword" id="3021725">struct</span>&nbsp;<span class="op" id="3021732">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021735">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021749">*</span><span class="ident" id="3021750">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021756">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3021770">*</span><span class="ident" id="3021771">Request</span>&nbsp;<span class="comment" id="3021779">//&nbsp;request&nbsp;for&nbsp;this&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021809">wroteHeader</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3021823">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021832">//&nbsp;reply&nbsp;header&nbsp;has&nbsp;been&nbsp;(logically)&nbsp;written</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021878">wroteContinue</span>&nbsp;<span class="builtintype" id="3021892">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3021901">//&nbsp;100&nbsp;Continue&nbsp;response&nbsp;was&nbsp;written</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3021940">w</span>&nbsp;&nbsp;<span class="op" id="3021943">*</span><span class="ident" id="3021944">bufio</span><span class="op" id="3021949">.</span><span class="ident" id="3021950">Writer</span>&nbsp;<span class="comment" id="3021957">//&nbsp;buffers&nbsp;output&nbsp;in&nbsp;chunks&nbsp;to&nbsp;chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022001">cw</span>&nbsp;<span class="ident" id="3022004">chunkWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022017">sw</span>&nbsp;<span class="op" id="3022020">*</span><span class="ident" id="3022021">switchWriter</span>&nbsp;<span class="comment" id="3022034">//&nbsp;of&nbsp;the&nbsp;bufio.Writer,&nbsp;for&nbsp;return&nbsp;to&nbsp;putBufioWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022089">//&nbsp;handlerHeader&nbsp;is&nbsp;the&nbsp;Header&nbsp;that&nbsp;Handlers&nbsp;get&nbsp;access&nbsp;to,</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022150">//&nbsp;which&nbsp;may&nbsp;be&nbsp;retained&nbsp;and&nbsp;mutated&nbsp;even&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022212">//&nbsp;handlerHeader&nbsp;is&nbsp;copied&nbsp;into&nbsp;cw.header&nbsp;at&nbsp;WriteHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022270">//&nbsp;time,&nbsp;and&nbsp;privately&nbsp;mutated&nbsp;thereafter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022314">handlerHeader</span>&nbsp;<span class="ident" id="3022328">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022336">calledHeader</span>&nbsp;&nbsp;<span class="builtintype" id="3022350">bool</span>&nbsp;<span class="comment" id="3022355">//&nbsp;handler&nbsp;accessed&nbsp;handlerHeader&nbsp;via&nbsp;Header</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022402">written</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022416">int64</span>&nbsp;<span class="comment" id="3022422">//&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;in&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022458">contentLength</span>&nbsp;<span class="ident" id="3022472">int64</span>&nbsp;<span class="comment" id="3022478">//&nbsp;explicitly-declared&nbsp;Content-Length;&nbsp;or&nbsp;-1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022524">status</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3022538">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3022544">//&nbsp;status&nbsp;code&nbsp;passed&nbsp;to&nbsp;WriteHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022583">//&nbsp;close&nbsp;connection&nbsp;after&nbsp;this&nbsp;reply.&nbsp;&nbsp;set&nbsp;on&nbsp;request&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022642">//&nbsp;updated&nbsp;after&nbsp;response&nbsp;from&nbsp;handler&nbsp;if&nbsp;there&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022695">//&nbsp;&#34;Connection:&nbsp;keep-alive&#34;&nbsp;response&nbsp;header&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022746">//&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3022766">closeAfterReply</span>&nbsp;<span class="builtintype" id="3022782">bool</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022789">//&nbsp;requestBodyLimitHit&nbsp;is&nbsp;set&nbsp;by&nbsp;requestTooLarge&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022844">//&nbsp;maxBytesReader&nbsp;hits&nbsp;its&nbsp;max&nbsp;size.&nbsp;It&nbsp;is&nbsp;checked&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022899">//&nbsp;WriteHeader,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;don&#39;t&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3022950">//&nbsp;remaining&nbsp;request&nbsp;body&nbsp;to&nbsp;try&nbsp;to&nbsp;advance&nbsp;to&nbsp;the&nbsp;next&nbsp;HTTP</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023012">//&nbsp;request.&nbsp;Instead,&nbsp;when&nbsp;this&nbsp;is&nbsp;set,&nbsp;we&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023068">//&nbsp;subsequent&nbsp;requests&nbsp;on&nbsp;this&nbsp;connection&nbsp;and&nbsp;stop&nbsp;reading</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023128">//&nbsp;input&nbsp;from&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023147">requestBodyLimitHit</span>&nbsp;<span class="builtintype" id="3023167">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023174">handlerDone</span>&nbsp;<span class="builtintype" id="3023186">bool</span>&nbsp;<span class="comment" id="3023191">//&nbsp;set&nbsp;true&nbsp;when&nbsp;the&nbsp;handler&nbsp;exits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3023228">//&nbsp;Buffers&nbsp;for&nbsp;Date&nbsp;and&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023268">dateBuf</span>&nbsp;<span class="op" id="3023276">[</span><span class="builtinfunc" id="3023277">len</span><span class="op" id="3023280">(</span><span class="ident" id="3023281">TimeFormat</span><span class="op" id="3023291">)</span><span class="op" id="3023292">]</span><span class="builtintype" id="3023293">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023299">clenBuf</span>&nbsp;<span class="op" id="3023307">[</span><span class="num" id="3023308">10</span><span class="op" id="3023310">]</span><span class="builtintype" id="3023311">byte</span><br>
<span class="lineno">340</span><span class="op" id="3023316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3023319">//&nbsp;requestTooLarge&nbsp;is&nbsp;called&nbsp;by&nbsp;maxBytesReader&nbsp;when&nbsp;too&nbsp;much&nbsp;input&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="3023390">//&nbsp;been&nbsp;read&nbsp;from&nbsp;the&nbsp;client.</span><br>
<span class="lineno"></span><span class="keyword" id="3023420">func</span>&nbsp;<span class="op" id="3023425">(</span><span class="ident" id="3023426">w</span>&nbsp;<span class="op" id="3023428">*</span><span class="ident" id="3023429">response</span><span class="op" id="3023437">)</span>&nbsp;<span class="ident" id="3023439">requestTooLarge</span><span class="op" id="3023454">(</span><span class="op" id="3023455">)</span>&nbsp;<span class="op" id="3023457">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023460">w</span><span class="op" id="3023461">.</span><span class="ident" id="3023462">closeAfterReply</span>&nbsp;<span class="op" id="3023478">=</span>&nbsp;<span class="builtintype" id="3023480">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023486">w</span><span class="op" id="3023487">.</span><span class="ident" id="3023488">requestBodyLimitHit</span>&nbsp;<span class="op" id="3023508">=</span>&nbsp;<span class="builtintype" id="3023510">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023516">if</span>&nbsp;<span class="op" id="3023519">!</span><span class="ident" id="3023520">w</span><span class="op" id="3023521">.</span><span class="ident" id="3023522">wroteHeader</span>&nbsp;<span class="op" id="3023534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023538">w</span><span class="op" id="3023539">.</span><span class="ident" id="3023540">Header</span><span class="op" id="3023546">(</span><span class="op" id="3023547">)</span><span class="op" id="3023548">.</span><span class="ident" id="3023549">Set</span><span class="op" id="3023552">(</span><span class="string" id="3023553">&#34;Connection&#34;</span><span class="op" id="3023565">,</span>&nbsp;<span class="string" id="3023567">&#34;close&#34;</span><span class="op" id="3023574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3023577">}</span><br>
<span class="lineno">350</span><span class="op" id="3023579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3023582">//&nbsp;needsSniff&nbsp;reports&nbsp;whether&nbsp;a&nbsp;Content-Type&nbsp;still&nbsp;needs&nbsp;to&nbsp;be&nbsp;sniffed.</span><br>
<span class="lineno"></span><span class="keyword" id="3023654">func</span>&nbsp;<span class="op" id="3023659">(</span><span class="ident" id="3023660">w</span>&nbsp;<span class="op" id="3023662">*</span><span class="ident" id="3023663">response</span><span class="op" id="3023671">)</span>&nbsp;<span class="ident" id="3023673">needsSniff</span><span class="op" id="3023683">(</span><span class="op" id="3023684">)</span>&nbsp;<span class="builtintype" id="3023686">bool</span>&nbsp;<span class="op" id="3023691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023694">_</span><span class="op" id="3023695">,</span>&nbsp;<span class="ident" id="3023697">haveType</span>&nbsp;<span class="op" id="3023706">:=</span>&nbsp;<span class="ident" id="3023709">w</span><span class="op" id="3023710">.</span><span class="ident" id="3023711">handlerHeader</span><span class="op" id="3023724">[</span><span class="string" id="3023725">&#34;Content-Type&#34;</span><span class="op" id="3023739">]</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023742">return</span>&nbsp;<span class="op" id="3023749">!</span><span class="ident" id="3023750">w</span><span class="op" id="3023751">.</span><span class="ident" id="3023752">cw</span><span class="op" id="3023754">.</span><span class="ident" id="3023755">wroteHeader</span>&nbsp;<span class="op" id="3023767">&amp;&amp;</span>&nbsp;<span class="op" id="3023770">!</span><span class="ident" id="3023771">haveType</span>&nbsp;<span class="op" id="3023780">&amp;&amp;</span>&nbsp;<span class="ident" id="3023783">w</span><span class="op" id="3023784">.</span><span class="ident" id="3023785">written</span>&nbsp;<span class="op" id="3023793">&lt;</span>&nbsp;<span class="ident" id="3023795">sniffLen</span><br>
<span class="lineno"></span><span class="op" id="3023804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3023807">//&nbsp;writerOnly&nbsp;hides&nbsp;an&nbsp;io.Writer&nbsp;value&#39;s&nbsp;optional&nbsp;ReadFrom&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3023873">//&nbsp;from&nbsp;io.Copy.</span><br>
<span class="lineno">360</span><span class="keyword" id="3023890">type</span>&nbsp;<span class="ident" id="3023895">writerOnly</span>&nbsp;<span class="keyword" id="3023906">struct</span>&nbsp;<span class="op" id="3023913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3023916">io</span><span class="op" id="3023918">.</span><span class="ident" id="3023919">Writer</span><br>
<span class="lineno"></span><span class="op" id="3023926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3023929">func</span>&nbsp;<span class="ident" id="3023934">srcIsRegularFile</span><span class="op" id="3023950">(</span><span class="ident" id="3023951">src</span>&nbsp;<span class="ident" id="3023955">io</span><span class="op" id="3023957">.</span><span class="ident" id="3023958">Reader</span><span class="op" id="3023964">)</span>&nbsp;<span class="op" id="3023966">(</span><span class="ident" id="3023967">isRegular</span>&nbsp;<span class="builtintype" id="3023977">bool</span><span class="op" id="3023981">,</span>&nbsp;<span class="ident" id="3023983">err</span>&nbsp;<span class="builtintype" id="3023987">error</span><span class="op" id="3023992">)</span>&nbsp;<span class="op" id="3023994">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3023997">switch</span>&nbsp;<span class="ident" id="3024004">v</span>&nbsp;<span class="op" id="3024006">:=</span>&nbsp;<span class="ident" id="3024009">src</span><span class="op" id="3024012">.</span><span class="op" id="3024013">(</span><span class="keyword" id="3024014">type</span><span class="op" id="3024018">)</span>&nbsp;<span class="op" id="3024020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024023">case</span>&nbsp;<span class="op" id="3024028">*</span><span class="ident" id="3024029">os</span><span class="op" id="3024031">.</span><span class="ident" id="3024032">File</span><span class="op" id="3024036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024040">fi</span><span class="op" id="3024042">,</span>&nbsp;<span class="ident" id="3024044">err</span>&nbsp;<span class="op" id="3024048">:=</span>&nbsp;<span class="ident" id="3024051">v</span><span class="op" id="3024052">.</span><span class="ident" id="3024053">Stat</span><span class="op" id="3024057">(</span><span class="op" id="3024058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024062">if</span>&nbsp;<span class="ident" id="3024065">err</span>&nbsp;<span class="op" id="3024069">!=</span>&nbsp;<span class="builtintype" id="3024072">nil</span>&nbsp;<span class="op" id="3024076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024081">return</span>&nbsp;<span class="builtintype" id="3024088">false</span><span class="op" id="3024093">,</span>&nbsp;<span class="ident" id="3024095">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024105">return</span>&nbsp;<span class="ident" id="3024112">fi</span><span class="op" id="3024114">.</span><span class="ident" id="3024115">Mode</span><span class="op" id="3024119">(</span><span class="op" id="3024120">)</span><span class="op" id="3024121">.</span><span class="ident" id="3024122">IsRegular</span><span class="op" id="3024131">(</span><span class="op" id="3024132">)</span><span class="op" id="3024133">,</span>&nbsp;<span class="builtintype" id="3024135">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024140">case</span>&nbsp;<span class="op" id="3024145">*</span><span class="ident" id="3024146">io</span><span class="op" id="3024148">.</span><span class="ident" id="3024149">LimitedReader</span><span class="op" id="3024162">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024166">return</span>&nbsp;<span class="ident" id="3024173">srcIsRegularFile</span><span class="op" id="3024189">(</span><span class="ident" id="3024190">v</span><span class="op" id="3024191">.</span><span class="ident" id="3024192">R</span><span class="op" id="3024193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024196">default</span><span class="op" id="3024203">:</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024207">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024215">}</span><br>
<span class="lineno"></span><span class="op" id="3024217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3024220">//&nbsp;ReadFrom&nbsp;is&nbsp;here&nbsp;to&nbsp;optimize&nbsp;copying&nbsp;from&nbsp;an&nbsp;*os.File&nbsp;regular&nbsp;file</span><br>
<span class="lineno">380</span><span class="comment" id="3024290">//&nbsp;to&nbsp;a&nbsp;*net.TCPConn&nbsp;with&nbsp;sendfile.</span><br>
<span class="lineno"></span><span class="keyword" id="3024326">func</span>&nbsp;<span class="op" id="3024331">(</span><span class="ident" id="3024332">w</span>&nbsp;<span class="op" id="3024334">*</span><span class="ident" id="3024335">response</span><span class="op" id="3024343">)</span>&nbsp;<span class="ident" id="3024345">ReadFrom</span><span class="op" id="3024353">(</span><span class="ident" id="3024354">src</span>&nbsp;<span class="ident" id="3024358">io</span><span class="op" id="3024360">.</span><span class="ident" id="3024361">Reader</span><span class="op" id="3024367">)</span>&nbsp;<span class="op" id="3024369">(</span><span class="ident" id="3024370">n</span>&nbsp;<span class="ident" id="3024372">int64</span><span class="op" id="3024377">,</span>&nbsp;<span class="ident" id="3024379">err</span>&nbsp;<span class="builtintype" id="3024383">error</span><span class="op" id="3024388">)</span>&nbsp;<span class="op" id="3024390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024393">//&nbsp;Our&nbsp;underlying&nbsp;w.conn.rwc&nbsp;is&nbsp;usually&nbsp;a&nbsp;*TCPConn&nbsp;(with&nbsp;its</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024455">//&nbsp;own&nbsp;ReadFrom&nbsp;method).&nbsp;If&nbsp;not,&nbsp;or&nbsp;if&nbsp;our&nbsp;src&nbsp;isn&#39;t&nbsp;a&nbsp;regular</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024519">//&nbsp;file,&nbsp;just&nbsp;fall&nbsp;back&nbsp;to&nbsp;the&nbsp;normal&nbsp;copy&nbsp;method.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024571">rf</span><span class="op" id="3024573">,</span>&nbsp;<span class="ident" id="3024575">ok</span>&nbsp;<span class="op" id="3024578">:=</span>&nbsp;<span class="ident" id="3024581">w</span><span class="op" id="3024582">.</span><span class="ident" id="3024583">conn</span><span class="op" id="3024587">.</span><span class="ident" id="3024588">rwc</span><span class="op" id="3024591">.</span><span class="op" id="3024592">(</span><span class="ident" id="3024593">io</span><span class="op" id="3024595">.</span><span class="ident" id="3024596">ReaderFrom</span><span class="op" id="3024606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024609">regFile</span><span class="op" id="3024616">,</span>&nbsp;<span class="ident" id="3024618">err</span>&nbsp;<span class="op" id="3024622">:=</span>&nbsp;<span class="ident" id="3024625">srcIsRegularFile</span><span class="op" id="3024641">(</span><span class="ident" id="3024642">src</span><span class="op" id="3024645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024648">if</span>&nbsp;<span class="ident" id="3024651">err</span>&nbsp;<span class="op" id="3024655">!=</span>&nbsp;<span class="builtintype" id="3024658">nil</span>&nbsp;<span class="op" id="3024662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024666">return</span>&nbsp;<span class="num" id="3024673">0</span><span class="op" id="3024674">,</span>&nbsp;<span class="ident" id="3024676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024681">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024684">if</span>&nbsp;<span class="op" id="3024687">!</span><span class="ident" id="3024688">ok</span>&nbsp;<span class="op" id="3024691">||</span>&nbsp;<span class="op" id="3024694">!</span><span class="ident" id="3024695">regFile</span>&nbsp;<span class="op" id="3024703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024707">return</span>&nbsp;<span class="ident" id="3024714">io</span><span class="op" id="3024716">.</span><span class="ident" id="3024717">Copy</span><span class="op" id="3024721">(</span><span class="ident" id="3024722">writerOnly</span><span class="op" id="3024732">{</span><span class="ident" id="3024733">w</span><span class="op" id="3024734">}</span><span class="op" id="3024735">,</span>&nbsp;<span class="ident" id="3024737">src</span><span class="op" id="3024740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3024747">//&nbsp;sendfile&nbsp;path:</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024767">if</span>&nbsp;<span class="op" id="3024770">!</span><span class="ident" id="3024771">w</span><span class="op" id="3024772">.</span><span class="ident" id="3024773">wroteHeader</span>&nbsp;<span class="op" id="3024785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024789">w</span><span class="op" id="3024790">.</span><span class="ident" id="3024791">WriteHeader</span><span class="op" id="3024802">(</span><span class="ident" id="3024803">StatusOK</span><span class="op" id="3024811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024818">if</span>&nbsp;<span class="ident" id="3024821">w</span><span class="op" id="3024822">.</span><span class="ident" id="3024823">needsSniff</span><span class="op" id="3024833">(</span><span class="op" id="3024834">)</span>&nbsp;<span class="op" id="3024836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024840">n0</span><span class="op" id="3024842">,</span>&nbsp;<span class="ident" id="3024844">err</span>&nbsp;<span class="op" id="3024848">:=</span>&nbsp;<span class="ident" id="3024851">io</span><span class="op" id="3024853">.</span><span class="ident" id="3024854">Copy</span><span class="op" id="3024858">(</span><span class="ident" id="3024859">writerOnly</span><span class="op" id="3024869">{</span><span class="ident" id="3024870">w</span><span class="op" id="3024871">}</span><span class="op" id="3024872">,</span>&nbsp;<span class="ident" id="3024874">io</span><span class="op" id="3024876">.</span><span class="ident" id="3024877">LimitReader</span><span class="op" id="3024888">(</span><span class="ident" id="3024889">src</span><span class="op" id="3024892">,</span>&nbsp;<span class="ident" id="3024894">sniffLen</span><span class="op" id="3024902">)</span><span class="op" id="3024903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024907">n</span>&nbsp;<span class="op" id="3024909">+=</span>&nbsp;<span class="ident" id="3024912">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024917">if</span>&nbsp;<span class="ident" id="3024920">err</span>&nbsp;<span class="op" id="3024924">!=</span>&nbsp;<span class="builtintype" id="3024927">nil</span>&nbsp;<span class="op" id="3024931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3024936">return</span>&nbsp;<span class="ident" id="3024943">n</span><span class="op" id="3024944">,</span>&nbsp;<span class="ident" id="3024946">err</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3024955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3024959">w</span><span class="op" id="3024960">.</span><span class="ident" id="3024961">w</span><span class="op" id="3024962">.</span><span class="ident" id="3024963">Flush</span><span class="op" id="3024968">(</span><span class="op" id="3024969">)</span>&nbsp;&nbsp;<span class="comment" id="3024972">//&nbsp;get&nbsp;rid&nbsp;of&nbsp;any&nbsp;previous&nbsp;writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025007">w</span><span class="op" id="3025008">.</span><span class="ident" id="3025009">cw</span><span class="op" id="3025011">.</span><span class="ident" id="3025012">flush</span><span class="op" id="3025017">(</span><span class="op" id="3025018">)</span>&nbsp;<span class="comment" id="3025020">//&nbsp;make&nbsp;sure&nbsp;Header&nbsp;is&nbsp;written;&nbsp;flush&nbsp;data&nbsp;to&nbsp;rwc</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3025072">//&nbsp;Now&nbsp;that&nbsp;cw&nbsp;has&nbsp;been&nbsp;flushed,&nbsp;its&nbsp;chunking&nbsp;field&nbsp;is&nbsp;guaranteed&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025152">if</span>&nbsp;<span class="op" id="3025155">!</span><span class="ident" id="3025156">w</span><span class="op" id="3025157">.</span><span class="ident" id="3025158">cw</span><span class="op" id="3025160">.</span><span class="ident" id="3025161">chunking</span>&nbsp;<span class="op" id="3025170">&amp;&amp;</span>&nbsp;<span class="ident" id="3025173">w</span><span class="op" id="3025174">.</span><span class="ident" id="3025175">bodyAllowed</span><span class="op" id="3025186">(</span><span class="op" id="3025187">)</span>&nbsp;<span class="op" id="3025189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025193">n0</span><span class="op" id="3025195">,</span>&nbsp;<span class="ident" id="3025197">err</span>&nbsp;<span class="op" id="3025201">:=</span>&nbsp;<span class="ident" id="3025204">rf</span><span class="op" id="3025206">.</span><span class="ident" id="3025207">ReadFrom</span><span class="op" id="3025215">(</span><span class="ident" id="3025216">src</span><span class="op" id="3025219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025223">n</span>&nbsp;<span class="op" id="3025225">+=</span>&nbsp;<span class="ident" id="3025228">n0</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025233">w</span><span class="op" id="3025234">.</span><span class="ident" id="3025235">written</span>&nbsp;<span class="op" id="3025243">+=</span>&nbsp;<span class="ident" id="3025246">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025251">return</span>&nbsp;<span class="ident" id="3025258">n</span><span class="op" id="3025259">,</span>&nbsp;<span class="ident" id="3025261">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025270">n0</span><span class="op" id="3025272">,</span>&nbsp;<span class="ident" id="3025274">err</span>&nbsp;<span class="op" id="3025278">:=</span>&nbsp;<span class="ident" id="3025281">io</span><span class="op" id="3025283">.</span><span class="ident" id="3025284">Copy</span><span class="op" id="3025288">(</span><span class="ident" id="3025289">writerOnly</span><span class="op" id="3025299">{</span><span class="ident" id="3025300">w</span><span class="op" id="3025301">}</span><span class="op" id="3025302">,</span>&nbsp;<span class="ident" id="3025304">src</span><span class="op" id="3025307">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025310">n</span>&nbsp;<span class="op" id="3025312">+=</span>&nbsp;<span class="ident" id="3025315">n0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025319">return</span>&nbsp;<span class="ident" id="3025326">n</span><span class="op" id="3025327">,</span>&nbsp;<span class="ident" id="3025329">err</span><br>
<span class="lineno"></span><span class="op" id="3025333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3025336">//&nbsp;noLimit&nbsp;is&nbsp;an&nbsp;effective&nbsp;infinite&nbsp;upper&nbsp;bound&nbsp;for&nbsp;io.LimitedReader</span><br>
<span class="lineno">425</span><span class="keyword" id="3025405">const</span>&nbsp;<span class="ident" id="3025411">noLimit</span>&nbsp;<span class="ident" id="3025419">int64</span>&nbsp;<span class="op" id="3025425">=</span>&nbsp;<span class="op" id="3025427">(</span><span class="num" id="3025428">1</span>&nbsp;<span class="op" id="3025430">&lt;&lt;</span>&nbsp;<span class="num" id="3025433">63</span><span class="op" id="3025435">)</span>&nbsp;<span class="op" id="3025437">-</span>&nbsp;<span class="num" id="3025439">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3025442">//&nbsp;debugServerConnections&nbsp;controls&nbsp;whether&nbsp;all&nbsp;server&nbsp;connections&nbsp;are&nbsp;wrapped</span><br>
<span class="lineno"></span><span class="comment" id="3025520">//&nbsp;with&nbsp;a&nbsp;verbose&nbsp;logging&nbsp;wrapper.</span><br>
<span class="lineno"></span><span class="keyword" id="3025555">const</span>&nbsp;<span class="ident" id="3025561">debugServerConnections</span>&nbsp;<span class="op" id="3025584">=</span>&nbsp;<span class="builtintype" id="3025586">false</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="comment" id="3025593">//&nbsp;Create&nbsp;new&nbsp;connection&nbsp;from&nbsp;rwc.</span><br>
<span class="lineno"></span><span class="keyword" id="3025628">func</span>&nbsp;<span class="op" id="3025633">(</span><span class="ident" id="3025634">srv</span>&nbsp;<span class="op" id="3025638">*</span><span class="ident" id="3025639">Server</span><span class="op" id="3025645">)</span>&nbsp;<span class="ident" id="3025647">newConn</span><span class="op" id="3025654">(</span><span class="ident" id="3025655">rwc</span>&nbsp;<span class="ident" id="3025659">net</span><span class="op" id="3025662">.</span><span class="ident" id="3025663">Conn</span><span class="op" id="3025667">)</span>&nbsp;<span class="op" id="3025669">(</span><span class="ident" id="3025670">c</span>&nbsp;<span class="op" id="3025672">*</span><span class="ident" id="3025673">conn</span><span class="op" id="3025677">,</span>&nbsp;<span class="ident" id="3025679">err</span>&nbsp;<span class="builtintype" id="3025683">error</span><span class="op" id="3025688">)</span>&nbsp;<span class="op" id="3025690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025693">c</span>&nbsp;<span class="op" id="3025695">=</span>&nbsp;<span class="builtinfunc" id="3025697">new</span><span class="op" id="3025700">(</span><span class="ident" id="3025701">conn</span><span class="op" id="3025705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025708">c</span><span class="op" id="3025709">.</span><span class="ident" id="3025710">remoteAddr</span>&nbsp;<span class="op" id="3025721">=</span>&nbsp;<span class="ident" id="3025723">rwc</span><span class="op" id="3025726">.</span><span class="ident" id="3025727">RemoteAddr</span><span class="op" id="3025737">(</span><span class="op" id="3025738">)</span><span class="op" id="3025739">.</span><span class="ident" id="3025740">String</span><span class="op" id="3025746">(</span><span class="op" id="3025747">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025750">c</span><span class="op" id="3025751">.</span><span class="ident" id="3025752">server</span>&nbsp;<span class="op" id="3025759">=</span>&nbsp;<span class="ident" id="3025761">srv</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025766">c</span><span class="op" id="3025767">.</span><span class="ident" id="3025768">rwc</span>&nbsp;<span class="op" id="3025772">=</span>&nbsp;<span class="ident" id="3025774">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025779">c</span><span class="op" id="3025780">.</span><span class="ident" id="3025781">w</span>&nbsp;<span class="op" id="3025783">=</span>&nbsp;<span class="ident" id="3025785">rwc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3025790">if</span>&nbsp;<span class="ident" id="3025793">debugServerConnections</span>&nbsp;<span class="op" id="3025816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025820">c</span><span class="op" id="3025821">.</span><span class="ident" id="3025822">rwc</span>&nbsp;<span class="op" id="3025826">=</span>&nbsp;<span class="ident" id="3025828">newLoggingConn</span><span class="op" id="3025842">(</span><span class="string" id="3025843">&#34;server&#34;</span><span class="op" id="3025851">,</span>&nbsp;<span class="ident" id="3025853">c</span><span class="op" id="3025854">.</span><span class="ident" id="3025855">rwc</span><span class="op" id="3025858">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3025861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025864">c</span><span class="op" id="3025865">.</span><span class="ident" id="3025866">sr</span>&nbsp;<span class="op" id="3025869">=</span>&nbsp;<span class="ident" id="3025871">liveSwitchReader</span><span class="op" id="3025887">{</span><span class="ident" id="3025888">r</span><span class="op" id="3025889">:</span>&nbsp;<span class="ident" id="3025891">c</span><span class="op" id="3025892">.</span><span class="ident" id="3025893">rwc</span><span class="op" id="3025896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025899">c</span><span class="op" id="3025900">.</span><span class="ident" id="3025901">lr</span>&nbsp;<span class="op" id="3025904">=</span>&nbsp;<span class="ident" id="3025906">io</span><span class="op" id="3025908">.</span><span class="ident" id="3025909">LimitReader</span><span class="op" id="3025920">(</span><span class="op" id="3025921">&amp;</span><span class="ident" id="3025922">c</span><span class="op" id="3025923">.</span><span class="ident" id="3025924">sr</span><span class="op" id="3025926">,</span>&nbsp;<span class="ident" id="3025928">noLimit</span><span class="op" id="3025935">)</span><span class="op" id="3025936">.</span><span class="op" id="3025937">(</span><span class="op" id="3025938">*</span><span class="ident" id="3025939">io</span><span class="op" id="3025941">.</span><span class="ident" id="3025942">LimitedReader</span><span class="op" id="3025955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025958">br</span>&nbsp;<span class="op" id="3025961">:=</span>&nbsp;<span class="ident" id="3025964">newBufioReader</span><span class="op" id="3025978">(</span><span class="ident" id="3025979">c</span><span class="op" id="3025980">.</span><span class="ident" id="3025981">lr</span><span class="op" id="3025983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3025986">bw</span>&nbsp;<span class="op" id="3025989">:=</span>&nbsp;<span class="ident" id="3025992">newBufioWriterSize</span><span class="op" id="3026010">(</span><span class="ident" id="3026011">checkConnErrorWriter</span><span class="op" id="3026031">{</span><span class="ident" id="3026032">c</span><span class="op" id="3026033">}</span><span class="op" id="3026034">,</span>&nbsp;<span class="num" id="3026036">4</span><span class="op" id="3026037">&lt;&lt;</span><span class="num" id="3026039">10</span><span class="op" id="3026041">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026044">c</span><span class="op" id="3026045">.</span><span class="ident" id="3026046">buf</span>&nbsp;<span class="op" id="3026050">=</span>&nbsp;<span class="ident" id="3026052">bufio</span><span class="op" id="3026057">.</span><span class="ident" id="3026058">NewReadWriter</span><span class="op" id="3026071">(</span><span class="ident" id="3026072">br</span><span class="op" id="3026074">,</span>&nbsp;<span class="ident" id="3026076">bw</span><span class="op" id="3026078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026081">return</span>&nbsp;<span class="ident" id="3026088">c</span><span class="op" id="3026089">,</span>&nbsp;<span class="builtintype" id="3026091">nil</span><br>
<span class="lineno"></span><span class="op" id="3026095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3026098">var</span>&nbsp;<span class="op" id="3026102">(</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026105">bufioReaderPool</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3026123">sync</span><span class="op" id="3026127">.</span><span class="ident" id="3026128">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026134">bufioWriter2kPool</span>&nbsp;<span class="ident" id="3026152">sync</span><span class="op" id="3026156">.</span><span class="ident" id="3026157">Pool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026163">bufioWriter4kPool</span>&nbsp;<span class="ident" id="3026181">sync</span><span class="op" id="3026185">.</span><span class="ident" id="3026186">Pool</span><br>
<span class="lineno"></span><span class="op" id="3026191">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span><span class="keyword" id="3026194">func</span>&nbsp;<span class="ident" id="3026199">bufioWriterPool</span><span class="op" id="3026214">(</span><span class="ident" id="3026215">size</span>&nbsp;<span class="builtintype" id="3026220">int</span><span class="op" id="3026223">)</span>&nbsp;<span class="op" id="3026225">*</span><span class="ident" id="3026226">sync</span><span class="op" id="3026230">.</span><span class="ident" id="3026231">Pool</span>&nbsp;<span class="op" id="3026236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026239">switch</span>&nbsp;<span class="ident" id="3026246">size</span>&nbsp;<span class="op" id="3026251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026254">case</span>&nbsp;<span class="num" id="3026259">2</span>&nbsp;<span class="op" id="3026261">&lt;&lt;</span>&nbsp;<span class="num" id="3026264">10</span><span class="op" id="3026266">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026270">return</span>&nbsp;<span class="op" id="3026277">&amp;</span><span class="ident" id="3026278">bufioWriter2kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026297">case</span>&nbsp;<span class="num" id="3026302">4</span>&nbsp;<span class="op" id="3026304">&lt;&lt;</span>&nbsp;<span class="num" id="3026307">10</span><span class="op" id="3026309">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026313">return</span>&nbsp;<span class="op" id="3026320">&amp;</span><span class="ident" id="3026321">bufioWriter4kPool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026343">return</span>&nbsp;<span class="builtintype" id="3026350">nil</span><br>
<span class="lineno"></span><span class="op" id="3026354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="keyword" id="3026357">func</span>&nbsp;<span class="ident" id="3026362">newBufioReader</span><span class="op" id="3026376">(</span><span class="ident" id="3026377">r</span>&nbsp;<span class="ident" id="3026379">io</span><span class="op" id="3026381">.</span><span class="ident" id="3026382">Reader</span><span class="op" id="3026388">)</span>&nbsp;<span class="op" id="3026390">*</span><span class="ident" id="3026391">bufio</span><span class="op" id="3026396">.</span><span class="ident" id="3026397">Reader</span>&nbsp;<span class="op" id="3026404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026407">if</span>&nbsp;<span class="ident" id="3026410">v</span>&nbsp;<span class="op" id="3026412">:=</span>&nbsp;<span class="ident" id="3026415">bufioReaderPool</span><span class="op" id="3026430">.</span><span class="ident" id="3026431">Get</span><span class="op" id="3026434">(</span><span class="op" id="3026435">)</span><span class="op" id="3026436">;</span>&nbsp;<span class="ident" id="3026438">v</span>&nbsp;<span class="op" id="3026440">!=</span>&nbsp;<span class="builtintype" id="3026443">nil</span>&nbsp;<span class="op" id="3026447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026451">br</span>&nbsp;<span class="op" id="3026454">:=</span>&nbsp;<span class="ident" id="3026457">v</span><span class="op" id="3026458">.</span><span class="op" id="3026459">(</span><span class="op" id="3026460">*</span><span class="ident" id="3026461">bufio</span><span class="op" id="3026466">.</span><span class="ident" id="3026467">Reader</span><span class="op" id="3026473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026477">br</span><span class="op" id="3026479">.</span><span class="ident" id="3026480">Reset</span><span class="op" id="3026485">(</span><span class="ident" id="3026486">r</span><span class="op" id="3026487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026491">return</span>&nbsp;<span class="ident" id="3026498">br</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026505">return</span>&nbsp;<span class="ident" id="3026512">bufio</span><span class="op" id="3026517">.</span><span class="ident" id="3026518">NewReader</span><span class="op" id="3026527">(</span><span class="ident" id="3026528">r</span><span class="op" id="3026529">)</span><br>
<span class="lineno"></span><span class="op" id="3026531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3026534">func</span>&nbsp;<span class="ident" id="3026539">putBufioReader</span><span class="op" id="3026553">(</span><span class="ident" id="3026554">br</span>&nbsp;<span class="op" id="3026557">*</span><span class="ident" id="3026558">bufio</span><span class="op" id="3026563">.</span><span class="ident" id="3026564">Reader</span><span class="op" id="3026570">)</span>&nbsp;<span class="op" id="3026572">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026575">br</span><span class="op" id="3026577">.</span><span class="ident" id="3026578">Reset</span><span class="op" id="3026583">(</span><span class="builtintype" id="3026584">nil</span><span class="op" id="3026587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026590">bufioReaderPool</span><span class="op" id="3026605">.</span><span class="ident" id="3026606">Put</span><span class="op" id="3026609">(</span><span class="ident" id="3026610">br</span><span class="op" id="3026612">)</span><br>
<span class="lineno"></span><span class="op" id="3026614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3026617">func</span>&nbsp;<span class="ident" id="3026622">newBufioWriterSize</span><span class="op" id="3026640">(</span><span class="ident" id="3026641">w</span>&nbsp;<span class="ident" id="3026643">io</span><span class="op" id="3026645">.</span><span class="ident" id="3026646">Writer</span><span class="op" id="3026652">,</span>&nbsp;<span class="ident" id="3026654">size</span>&nbsp;<span class="builtintype" id="3026659">int</span><span class="op" id="3026662">)</span>&nbsp;<span class="op" id="3026664">*</span><span class="ident" id="3026665">bufio</span><span class="op" id="3026670">.</span><span class="ident" id="3026671">Writer</span>&nbsp;<span class="op" id="3026678">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026681">pool</span>&nbsp;<span class="op" id="3026686">:=</span>&nbsp;<span class="ident" id="3026689">bufioWriterPool</span><span class="op" id="3026704">(</span><span class="ident" id="3026705">size</span><span class="op" id="3026709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026712">if</span>&nbsp;<span class="ident" id="3026715">pool</span>&nbsp;<span class="op" id="3026720">!=</span>&nbsp;<span class="builtintype" id="3026723">nil</span>&nbsp;<span class="op" id="3026727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026731">if</span>&nbsp;<span class="ident" id="3026734">v</span>&nbsp;<span class="op" id="3026736">:=</span>&nbsp;<span class="ident" id="3026739">pool</span><span class="op" id="3026743">.</span><span class="ident" id="3026744">Get</span><span class="op" id="3026747">(</span><span class="op" id="3026748">)</span><span class="op" id="3026749">;</span>&nbsp;<span class="ident" id="3026751">v</span>&nbsp;<span class="op" id="3026753">!=</span>&nbsp;<span class="builtintype" id="3026756">nil</span>&nbsp;<span class="op" id="3026760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026765">bw</span>&nbsp;<span class="op" id="3026768">:=</span>&nbsp;<span class="ident" id="3026771">v</span><span class="op" id="3026772">.</span><span class="op" id="3026773">(</span><span class="op" id="3026774">*</span><span class="ident" id="3026775">bufio</span><span class="op" id="3026780">.</span><span class="ident" id="3026781">Writer</span><span class="op" id="3026787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026792">bw</span><span class="op" id="3026794">.</span><span class="ident" id="3026795">Reset</span><span class="op" id="3026800">(</span><span class="ident" id="3026801">w</span><span class="op" id="3026802">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026807">return</span>&nbsp;<span class="ident" id="3026814">bw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026822">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026825">return</span>&nbsp;<span class="ident" id="3026832">bufio</span><span class="op" id="3026837">.</span><span class="ident" id="3026838">NewWriterSize</span><span class="op" id="3026851">(</span><span class="ident" id="3026852">w</span><span class="op" id="3026853">,</span>&nbsp;<span class="ident" id="3026855">size</span><span class="op" id="3026859">)</span><br>
<span class="lineno"></span><span class="op" id="3026861">}</span><br>
<span class="lineno">490</span><br>
<span class="lineno"></span><span class="keyword" id="3026864">func</span>&nbsp;<span class="ident" id="3026869">putBufioWriter</span><span class="op" id="3026883">(</span><span class="ident" id="3026884">bw</span>&nbsp;<span class="op" id="3026887">*</span><span class="ident" id="3026888">bufio</span><span class="op" id="3026893">.</span><span class="ident" id="3026894">Writer</span><span class="op" id="3026900">)</span>&nbsp;<span class="op" id="3026902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026905">bw</span><span class="op" id="3026907">.</span><span class="ident" id="3026908">Reset</span><span class="op" id="3026913">(</span><span class="builtintype" id="3026914">nil</span><span class="op" id="3026917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3026920">if</span>&nbsp;<span class="ident" id="3026923">pool</span>&nbsp;<span class="op" id="3026928">:=</span>&nbsp;<span class="ident" id="3026931">bufioWriterPool</span><span class="op" id="3026946">(</span><span class="ident" id="3026947">bw</span><span class="op" id="3026949">.</span><span class="ident" id="3026950">Available</span><span class="op" id="3026959">(</span><span class="op" id="3026960">)</span><span class="op" id="3026961">)</span><span class="op" id="3026962">;</span>&nbsp;<span class="ident" id="3026964">pool</span>&nbsp;<span class="op" id="3026969">!=</span>&nbsp;<span class="builtintype" id="3026972">nil</span>&nbsp;<span class="op" id="3026976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3026980">pool</span><span class="op" id="3026984">.</span><span class="ident" id="3026985">Put</span><span class="op" id="3026988">(</span><span class="ident" id="3026989">bw</span><span class="op" id="3026991">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3026994">}</span><br>
<span class="lineno"></span><span class="op" id="3026996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3026999">//&nbsp;DefaultMaxHeaderBytes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;permitted&nbsp;size&nbsp;of&nbsp;the&nbsp;headers</span><br>
<span class="lineno"></span><span class="comment" id="3027069">//&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;request.</span><br>
<span class="lineno">500</span><span class="comment" id="3027092">//&nbsp;This&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;setting&nbsp;Server.MaxHeaderBytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3027152">const</span>&nbsp;<span class="ident" id="3027158">DefaultMaxHeaderBytes</span>&nbsp;<span class="op" id="3027180">=</span>&nbsp;<span class="num" id="3027182">1</span>&nbsp;<span class="op" id="3027184">&lt;&lt;</span>&nbsp;<span class="num" id="3027187">20</span>&nbsp;<span class="comment" id="3027190">//&nbsp;1&nbsp;MB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3027199">func</span>&nbsp;<span class="op" id="3027204">(</span><span class="ident" id="3027205">srv</span>&nbsp;<span class="op" id="3027209">*</span><span class="ident" id="3027210">Server</span><span class="op" id="3027216">)</span>&nbsp;<span class="ident" id="3027218">maxHeaderBytes</span><span class="op" id="3027232">(</span><span class="op" id="3027233">)</span>&nbsp;<span class="builtintype" id="3027235">int</span>&nbsp;<span class="op" id="3027239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027242">if</span>&nbsp;<span class="ident" id="3027245">srv</span><span class="op" id="3027248">.</span><span class="ident" id="3027249">MaxHeaderBytes</span>&nbsp;<span class="op" id="3027264">&gt;</span>&nbsp;<span class="num" id="3027266">0</span>&nbsp;<span class="op" id="3027268">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027272">return</span>&nbsp;<span class="ident" id="3027279">srv</span><span class="op" id="3027282">.</span><span class="ident" id="3027283">MaxHeaderBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027302">return</span>&nbsp;<span class="ident" id="3027309">DefaultMaxHeaderBytes</span><br>
<span class="lineno"></span><span class="op" id="3027331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3027334">func</span>&nbsp;<span class="op" id="3027339">(</span><span class="ident" id="3027340">srv</span>&nbsp;<span class="op" id="3027344">*</span><span class="ident" id="3027345">Server</span><span class="op" id="3027351">)</span>&nbsp;<span class="ident" id="3027353">initialLimitedReaderSize</span><span class="op" id="3027377">(</span><span class="op" id="3027378">)</span>&nbsp;<span class="ident" id="3027380">int64</span>&nbsp;<span class="op" id="3027386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027389">return</span>&nbsp;<span class="ident" id="3027396">int64</span><span class="op" id="3027401">(</span><span class="ident" id="3027402">srv</span><span class="op" id="3027405">.</span><span class="ident" id="3027406">maxHeaderBytes</span><span class="op" id="3027420">(</span><span class="op" id="3027421">)</span><span class="op" id="3027422">)</span>&nbsp;<span class="op" id="3027424">+</span>&nbsp;<span class="num" id="3027426">4096</span>&nbsp;<span class="comment" id="3027431">//&nbsp;bufio&nbsp;slop</span><br>
<span class="lineno"></span><span class="op" id="3027445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3027448">//&nbsp;wrapper&nbsp;around&nbsp;io.ReaderCloser&nbsp;which&nbsp;on&nbsp;first&nbsp;read,&nbsp;sends&nbsp;an</span><br>
<span class="lineno">515</span><span class="comment" id="3027512">//&nbsp;HTTP/1.1&nbsp;100&nbsp;Continue&nbsp;header</span><br>
<span class="lineno"></span><span class="keyword" id="3027544">type</span>&nbsp;<span class="ident" id="3027549">expectContinueReader</span>&nbsp;<span class="keyword" id="3027570">struct</span>&nbsp;<span class="op" id="3027577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027580">resp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027591">*</span><span class="ident" id="3027592">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027602">readCloser</span>&nbsp;<span class="ident" id="3027613">io</span><span class="op" id="3027615">.</span><span class="ident" id="3027616">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027628">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3027639">bool</span><br>
<span class="lineno">520</span><span class="op" id="3027644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3027647">func</span>&nbsp;<span class="op" id="3027652">(</span><span class="ident" id="3027653">ecr</span>&nbsp;<span class="op" id="3027657">*</span><span class="ident" id="3027658">expectContinueReader</span><span class="op" id="3027678">)</span>&nbsp;<span class="ident" id="3027680">Read</span><span class="op" id="3027684">(</span><span class="ident" id="3027685">p</span>&nbsp;<span class="op" id="3027687">[</span><span class="op" id="3027688">]</span><span class="builtintype" id="3027689">byte</span><span class="op" id="3027693">)</span>&nbsp;<span class="op" id="3027695">(</span><span class="ident" id="3027696">n</span>&nbsp;<span class="builtintype" id="3027698">int</span><span class="op" id="3027701">,</span>&nbsp;<span class="ident" id="3027703">err</span>&nbsp;<span class="builtintype" id="3027707">error</span><span class="op" id="3027712">)</span>&nbsp;<span class="op" id="3027714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027717">if</span>&nbsp;<span class="ident" id="3027720">ecr</span><span class="op" id="3027723">.</span><span class="ident" id="3027724">closed</span>&nbsp;<span class="op" id="3027731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027735">return</span>&nbsp;<span class="num" id="3027742">0</span><span class="op" id="3027743">,</span>&nbsp;<span class="ident" id="3027745">ErrBodyReadAfterClose</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027771">if</span>&nbsp;<span class="op" id="3027774">!</span><span class="ident" id="3027775">ecr</span><span class="op" id="3027778">.</span><span class="ident" id="3027779">resp</span><span class="op" id="3027783">.</span><span class="ident" id="3027784">wroteContinue</span>&nbsp;<span class="op" id="3027798">&amp;&amp;</span>&nbsp;<span class="op" id="3027801">!</span><span class="ident" id="3027802">ecr</span><span class="op" id="3027805">.</span><span class="ident" id="3027806">resp</span><span class="op" id="3027810">.</span><span class="ident" id="3027811">conn</span><span class="op" id="3027815">.</span><span class="ident" id="3027816">hijacked</span><span class="op" id="3027824">(</span><span class="op" id="3027825">)</span>&nbsp;<span class="op" id="3027827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027831">ecr</span><span class="op" id="3027834">.</span><span class="ident" id="3027835">resp</span><span class="op" id="3027839">.</span><span class="ident" id="3027840">wroteContinue</span>&nbsp;<span class="op" id="3027854">=</span>&nbsp;<span class="builtintype" id="3027856">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027863">ecr</span><span class="op" id="3027866">.</span><span class="ident" id="3027867">resp</span><span class="op" id="3027871">.</span><span class="ident" id="3027872">conn</span><span class="op" id="3027876">.</span><span class="ident" id="3027877">buf</span><span class="op" id="3027880">.</span><span class="ident" id="3027881">WriteString</span><span class="op" id="3027892">(</span><span class="string" id="3027893">&#34;HTTP/1.1&nbsp;100&nbsp;Continue\r\n\r\n&#34;</span><span class="op" id="3027924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3027928">ecr</span><span class="op" id="3027931">.</span><span class="ident" id="3027932">resp</span><span class="op" id="3027936">.</span><span class="ident" id="3027937">conn</span><span class="op" id="3027941">.</span><span class="ident" id="3027942">buf</span><span class="op" id="3027945">.</span><span class="ident" id="3027946">Flush</span><span class="op" id="3027951">(</span><span class="op" id="3027952">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3027955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3027958">return</span>&nbsp;<span class="ident" id="3027965">ecr</span><span class="op" id="3027968">.</span><span class="ident" id="3027969">readCloser</span><span class="op" id="3027979">.</span><span class="ident" id="3027980">Read</span><span class="op" id="3027984">(</span><span class="ident" id="3027985">p</span><span class="op" id="3027986">)</span><br>
<span class="lineno"></span><span class="op" id="3027988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3027991">func</span>&nbsp;<span class="op" id="3027996">(</span><span class="ident" id="3027997">ecr</span>&nbsp;<span class="op" id="3028001">*</span><span class="ident" id="3028002">expectContinueReader</span><span class="op" id="3028022">)</span>&nbsp;<span class="ident" id="3028024">Close</span><span class="op" id="3028029">(</span><span class="op" id="3028030">)</span>&nbsp;<span class="builtintype" id="3028032">error</span>&nbsp;<span class="op" id="3028038">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028041">ecr</span><span class="op" id="3028044">.</span><span class="ident" id="3028045">closed</span>&nbsp;<span class="op" id="3028052">=</span>&nbsp;<span class="builtintype" id="3028054">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028060">return</span>&nbsp;<span class="ident" id="3028067">ecr</span><span class="op" id="3028070">.</span><span class="ident" id="3028071">readCloser</span><span class="op" id="3028081">.</span><span class="ident" id="3028082">Close</span><span class="op" id="3028087">(</span><span class="op" id="3028088">)</span><br>
<span class="lineno"></span><span class="op" id="3028090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3028093">//&nbsp;TimeFormat&nbsp;is&nbsp;the&nbsp;time&nbsp;format&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno">540</span><span class="comment" id="3028138">//&nbsp;time.Parse&nbsp;and&nbsp;time.Time.Format&nbsp;when&nbsp;parsing</span><br>
<span class="lineno"></span><span class="comment" id="3028186">//&nbsp;or&nbsp;generating&nbsp;times&nbsp;in&nbsp;HTTP&nbsp;headers.</span><br>
<span class="lineno"></span><span class="comment" id="3028226">//&nbsp;It&nbsp;is&nbsp;like&nbsp;time.RFC1123&nbsp;but&nbsp;hard&nbsp;codes&nbsp;GMT&nbsp;as&nbsp;the&nbsp;time&nbsp;zone.</span><br>
<span class="lineno"></span><span class="keyword" id="3028290">const</span>&nbsp;<span class="ident" id="3028296">TimeFormat</span>&nbsp;<span class="op" id="3028307">=</span>&nbsp;<span class="string" id="3028309">&#34;Mon,&nbsp;02&nbsp;Jan&nbsp;2006&nbsp;15:04:05&nbsp;GMT&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">545</span><span class="comment" id="3028342">//&nbsp;appendTime&nbsp;is&nbsp;a&nbsp;non-allocating&nbsp;version&nbsp;of&nbsp;[]byte(t.UTC().Format(TimeFormat))</span><br>
<span class="lineno"></span><span class="keyword" id="3028422">func</span>&nbsp;<span class="ident" id="3028427">appendTime</span><span class="op" id="3028437">(</span><span class="ident" id="3028438">b</span>&nbsp;<span class="op" id="3028440">[</span><span class="op" id="3028441">]</span><span class="builtintype" id="3028442">byte</span><span class="op" id="3028446">,</span>&nbsp;<span class="ident" id="3028448">t</span>&nbsp;<span class="ident" id="3028450">time</span><span class="op" id="3028454">.</span><span class="ident" id="3028455">Time</span><span class="op" id="3028459">)</span>&nbsp;<span class="op" id="3028461">[</span><span class="op" id="3028462">]</span><span class="builtintype" id="3028463">byte</span>&nbsp;<span class="op" id="3028468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028471">const</span>&nbsp;<span class="ident" id="3028477">days</span>&nbsp;<span class="op" id="3028482">=</span>&nbsp;<span class="string" id="3028484">&#34;SunMonTueWedThuFriSat&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028509">const</span>&nbsp;<span class="ident" id="3028515">months</span>&nbsp;<span class="op" id="3028522">=</span>&nbsp;<span class="string" id="3028524">&#34;JanFebMarAprMayJunJulAugSepOctNovDec&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028565">t</span>&nbsp;<span class="op" id="3028567">=</span>&nbsp;<span class="ident" id="3028569">t</span><span class="op" id="3028570">.</span><span class="ident" id="3028571">UTC</span><span class="op" id="3028574">(</span><span class="op" id="3028575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028578">yy</span><span class="op" id="3028580">,</span>&nbsp;<span class="ident" id="3028582">mm</span><span class="op" id="3028584">,</span>&nbsp;<span class="ident" id="3028586">dd</span>&nbsp;<span class="op" id="3028589">:=</span>&nbsp;<span class="ident" id="3028592">t</span><span class="op" id="3028593">.</span><span class="ident" id="3028594">Date</span><span class="op" id="3028598">(</span><span class="op" id="3028599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028602">hh</span><span class="op" id="3028604">,</span>&nbsp;<span class="ident" id="3028606">mn</span><span class="op" id="3028608">,</span>&nbsp;<span class="ident" id="3028610">ss</span>&nbsp;<span class="op" id="3028613">:=</span>&nbsp;<span class="ident" id="3028616">t</span><span class="op" id="3028617">.</span><span class="ident" id="3028618">Clock</span><span class="op" id="3028623">(</span><span class="op" id="3028624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028627">day</span>&nbsp;<span class="op" id="3028631">:=</span>&nbsp;<span class="ident" id="3028634">days</span><span class="op" id="3028638">[</span><span class="num" id="3028639">3</span><span class="op" id="3028640">*</span><span class="ident" id="3028641">t</span><span class="op" id="3028642">.</span><span class="ident" id="3028643">Weekday</span><span class="op" id="3028650">(</span><span class="op" id="3028651">)</span><span class="op" id="3028652">:</span><span class="op" id="3028653">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028656">mon</span>&nbsp;<span class="op" id="3028660">:=</span>&nbsp;<span class="ident" id="3028663">months</span><span class="op" id="3028669">[</span><span class="num" id="3028670">3</span><span class="op" id="3028671">*</span><span class="op" id="3028672">(</span><span class="ident" id="3028673">mm</span><span class="op" id="3028675">-</span><span class="num" id="3028676">1</span><span class="op" id="3028677">)</span><span class="op" id="3028678">:</span><span class="op" id="3028679">]</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3028683">return</span>&nbsp;<span class="builtinfunc" id="3028690">append</span><span class="op" id="3028696">(</span><span class="ident" id="3028697">b</span><span class="op" id="3028698">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028702">day</span><span class="op" id="3028705">[</span><span class="num" id="3028706">0</span><span class="op" id="3028707">]</span><span class="op" id="3028708">,</span>&nbsp;<span class="ident" id="3028710">day</span><span class="op" id="3028713">[</span><span class="num" id="3028714">1</span><span class="op" id="3028715">]</span><span class="op" id="3028716">,</span>&nbsp;<span class="ident" id="3028718">day</span><span class="op" id="3028721">[</span><span class="num" id="3028722">2</span><span class="op" id="3028723">]</span><span class="op" id="3028724">,</span>&nbsp;<span class="string" id="3028726">&#39;,&#39;</span><span class="op" id="3028729">,</span>&nbsp;<span class="string" id="3028731">&#39;&nbsp;&#39;</span><span class="op" id="3028734">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3028738">byte</span><span class="op" id="3028742">(</span><span class="string" id="3028743">&#39;0&#39;</span><span class="op" id="3028746">+</span><span class="ident" id="3028747">dd</span><span class="op" id="3028749">/</span><span class="num" id="3028750">10</span><span class="op" id="3028752">)</span><span class="op" id="3028753">,</span>&nbsp;<span class="builtintype" id="3028755">byte</span><span class="op" id="3028759">(</span><span class="string" id="3028760">&#39;0&#39;</span><span class="op" id="3028763">+</span><span class="ident" id="3028764">dd</span><span class="op" id="3028766">%</span><span class="num" id="3028767">10</span><span class="op" id="3028769">)</span><span class="op" id="3028770">,</span>&nbsp;<span class="string" id="3028772">&#39;&nbsp;&#39;</span><span class="op" id="3028775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3028779">mon</span><span class="op" id="3028782">[</span><span class="num" id="3028783">0</span><span class="op" id="3028784">]</span><span class="op" id="3028785">,</span>&nbsp;<span class="ident" id="3028787">mon</span><span class="op" id="3028790">[</span><span class="num" id="3028791">1</span><span class="op" id="3028792">]</span><span class="op" id="3028793">,</span>&nbsp;<span class="ident" id="3028795">mon</span><span class="op" id="3028798">[</span><span class="num" id="3028799">2</span><span class="op" id="3028800">]</span><span class="op" id="3028801">,</span>&nbsp;<span class="string" id="3028803">&#39;&nbsp;&#39;</span><span class="op" id="3028806">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3028810">byte</span><span class="op" id="3028814">(</span><span class="string" id="3028815">&#39;0&#39;</span><span class="op" id="3028818">+</span><span class="ident" id="3028819">yy</span><span class="op" id="3028821">/</span><span class="num" id="3028822">1000</span><span class="op" id="3028826">)</span><span class="op" id="3028827">,</span>&nbsp;<span class="builtintype" id="3028829">byte</span><span class="op" id="3028833">(</span><span class="string" id="3028834">&#39;0&#39;</span><span class="op" id="3028837">+</span><span class="op" id="3028838">(</span><span class="ident" id="3028839">yy</span><span class="op" id="3028841">/</span><span class="num" id="3028842">100</span><span class="op" id="3028845">)</span><span class="op" id="3028846">%</span><span class="num" id="3028847">10</span><span class="op" id="3028849">)</span><span class="op" id="3028850">,</span>&nbsp;<span class="builtintype" id="3028852">byte</span><span class="op" id="3028856">(</span><span class="string" id="3028857">&#39;0&#39;</span><span class="op" id="3028860">+</span><span class="op" id="3028861">(</span><span class="ident" id="3028862">yy</span><span class="op" id="3028864">/</span><span class="num" id="3028865">10</span><span class="op" id="3028867">)</span><span class="op" id="3028868">%</span><span class="num" id="3028869">10</span><span class="op" id="3028871">)</span><span class="op" id="3028872">,</span>&nbsp;<span class="builtintype" id="3028874">byte</span><span class="op" id="3028878">(</span><span class="string" id="3028879">&#39;0&#39;</span><span class="op" id="3028882">+</span><span class="ident" id="3028883">yy</span><span class="op" id="3028885">%</span><span class="num" id="3028886">10</span><span class="op" id="3028888">)</span><span class="op" id="3028889">,</span>&nbsp;<span class="string" id="3028891">&#39;&nbsp;&#39;</span><span class="op" id="3028894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3028898">byte</span><span class="op" id="3028902">(</span><span class="string" id="3028903">&#39;0&#39;</span><span class="op" id="3028906">+</span><span class="ident" id="3028907">hh</span><span class="op" id="3028909">/</span><span class="num" id="3028910">10</span><span class="op" id="3028912">)</span><span class="op" id="3028913">,</span>&nbsp;<span class="builtintype" id="3028915">byte</span><span class="op" id="3028919">(</span><span class="string" id="3028920">&#39;0&#39;</span><span class="op" id="3028923">+</span><span class="ident" id="3028924">hh</span><span class="op" id="3028926">%</span><span class="num" id="3028927">10</span><span class="op" id="3028929">)</span><span class="op" id="3028930">,</span>&nbsp;<span class="string" id="3028932">&#39;:&#39;</span><span class="op" id="3028935">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3028939">byte</span><span class="op" id="3028943">(</span><span class="string" id="3028944">&#39;0&#39;</span><span class="op" id="3028947">+</span><span class="ident" id="3028948">mn</span><span class="op" id="3028950">/</span><span class="num" id="3028951">10</span><span class="op" id="3028953">)</span><span class="op" id="3028954">,</span>&nbsp;<span class="builtintype" id="3028956">byte</span><span class="op" id="3028960">(</span><span class="string" id="3028961">&#39;0&#39;</span><span class="op" id="3028964">+</span><span class="ident" id="3028965">mn</span><span class="op" id="3028967">%</span><span class="num" id="3028968">10</span><span class="op" id="3028970">)</span><span class="op" id="3028971">,</span>&nbsp;<span class="string" id="3028973">&#39;:&#39;</span><span class="op" id="3028976">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3028980">byte</span><span class="op" id="3028984">(</span><span class="string" id="3028985">&#39;0&#39;</span><span class="op" id="3028988">+</span><span class="ident" id="3028989">ss</span><span class="op" id="3028991">/</span><span class="num" id="3028992">10</span><span class="op" id="3028994">)</span><span class="op" id="3028995">,</span>&nbsp;<span class="builtintype" id="3028997">byte</span><span class="op" id="3029001">(</span><span class="string" id="3029002">&#39;0&#39;</span><span class="op" id="3029005">+</span><span class="ident" id="3029006">ss</span><span class="op" id="3029008">%</span><span class="num" id="3029009">10</span><span class="op" id="3029011">)</span><span class="op" id="3029012">,</span>&nbsp;<span class="string" id="3029014">&#39;&nbsp;&#39;</span><span class="op" id="3029017">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3029021">&#39;G&#39;</span><span class="op" id="3029024">,</span>&nbsp;<span class="string" id="3029026">&#39;M&#39;</span><span class="op" id="3029029">,</span>&nbsp;<span class="string" id="3029031">&#39;T&#39;</span><span class="op" id="3029034">)</span><br>
<span class="lineno">565</span><span class="op" id="3029036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3029039">var</span>&nbsp;<span class="ident" id="3029043">errTooLarge</span>&nbsp;<span class="op" id="3029055">=</span>&nbsp;<span class="ident" id="3029057">errors</span><span class="op" id="3029063">.</span><span class="ident" id="3029064">New</span><span class="op" id="3029067">(</span><span class="string" id="3029068">&#34;http:&nbsp;request&nbsp;too&nbsp;large&#34;</span><span class="op" id="3029093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3029096">//&nbsp;Read&nbsp;next&nbsp;request&nbsp;from&nbsp;connection.</span><br>
<span class="lineno">570</span><span class="keyword" id="3029134">func</span>&nbsp;<span class="op" id="3029139">(</span><span class="ident" id="3029140">c</span>&nbsp;<span class="op" id="3029142">*</span><span class="ident" id="3029143">conn</span><span class="op" id="3029147">)</span>&nbsp;<span class="ident" id="3029149">readRequest</span><span class="op" id="3029160">(</span><span class="op" id="3029161">)</span>&nbsp;<span class="op" id="3029163">(</span><span class="ident" id="3029164">w</span>&nbsp;<span class="op" id="3029166">*</span><span class="ident" id="3029167">response</span><span class="op" id="3029175">,</span>&nbsp;<span class="ident" id="3029177">err</span>&nbsp;<span class="builtintype" id="3029181">error</span><span class="op" id="3029186">)</span>&nbsp;<span class="op" id="3029188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029191">if</span>&nbsp;<span class="ident" id="3029194">c</span><span class="op" id="3029195">.</span><span class="ident" id="3029196">hijacked</span><span class="op" id="3029204">(</span><span class="op" id="3029205">)</span>&nbsp;<span class="op" id="3029207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029211">return</span>&nbsp;<span class="builtintype" id="3029218">nil</span><span class="op" id="3029221">,</span>&nbsp;<span class="ident" id="3029223">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029240">if</span>&nbsp;<span class="ident" id="3029243">d</span>&nbsp;<span class="op" id="3029245">:=</span>&nbsp;<span class="ident" id="3029248">c</span><span class="op" id="3029249">.</span><span class="ident" id="3029250">server</span><span class="op" id="3029256">.</span><span class="ident" id="3029257">ReadTimeout</span><span class="op" id="3029268">;</span>&nbsp;<span class="ident" id="3029270">d</span>&nbsp;<span class="op" id="3029272">!=</span>&nbsp;<span class="num" id="3029275">0</span>&nbsp;<span class="op" id="3029277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029281">c</span><span class="op" id="3029282">.</span><span class="ident" id="3029283">rwc</span><span class="op" id="3029286">.</span><span class="ident" id="3029287">SetReadDeadline</span><span class="op" id="3029302">(</span><span class="ident" id="3029303">time</span><span class="op" id="3029307">.</span><span class="ident" id="3029308">Now</span><span class="op" id="3029311">(</span><span class="op" id="3029312">)</span><span class="op" id="3029313">.</span><span class="ident" id="3029314">Add</span><span class="op" id="3029317">(</span><span class="ident" id="3029318">d</span><span class="op" id="3029319">)</span><span class="op" id="3029320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029326">if</span>&nbsp;<span class="ident" id="3029329">d</span>&nbsp;<span class="op" id="3029331">:=</span>&nbsp;<span class="ident" id="3029334">c</span><span class="op" id="3029335">.</span><span class="ident" id="3029336">server</span><span class="op" id="3029342">.</span><span class="ident" id="3029343">WriteTimeout</span><span class="op" id="3029355">;</span>&nbsp;<span class="ident" id="3029357">d</span>&nbsp;<span class="op" id="3029359">!=</span>&nbsp;<span class="num" id="3029362">0</span>&nbsp;<span class="op" id="3029364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029368">defer</span>&nbsp;<span class="keyword" id="3029374">func</span><span class="op" id="3029378">(</span><span class="op" id="3029379">)</span>&nbsp;<span class="op" id="3029381">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029386">c</span><span class="op" id="3029387">.</span><span class="ident" id="3029388">rwc</span><span class="op" id="3029391">.</span><span class="ident" id="3029392">SetWriteDeadline</span><span class="op" id="3029408">(</span><span class="ident" id="3029409">time</span><span class="op" id="3029413">.</span><span class="ident" id="3029414">Now</span><span class="op" id="3029417">(</span><span class="op" id="3029418">)</span><span class="op" id="3029419">.</span><span class="ident" id="3029420">Add</span><span class="op" id="3029423">(</span><span class="ident" id="3029424">d</span><span class="op" id="3029425">)</span><span class="op" id="3029426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029430">}</span><span class="op" id="3029431">(</span><span class="op" id="3029432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029439">c</span><span class="op" id="3029440">.</span><span class="ident" id="3029441">lr</span><span class="op" id="3029443">.</span><span class="ident" id="3029444">N</span>&nbsp;<span class="op" id="3029446">=</span>&nbsp;<span class="ident" id="3029448">c</span><span class="op" id="3029449">.</span><span class="ident" id="3029450">server</span><span class="op" id="3029456">.</span><span class="ident" id="3029457">initialLimitedReaderSize</span><span class="op" id="3029481">(</span><span class="op" id="3029482">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029485">var</span>&nbsp;<span class="ident" id="3029489">req</span>&nbsp;<span class="op" id="3029493">*</span><span class="ident" id="3029494">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029503">if</span>&nbsp;<span class="ident" id="3029506">req</span><span class="op" id="3029509">,</span>&nbsp;<span class="ident" id="3029511">err</span>&nbsp;<span class="op" id="3029515">=</span>&nbsp;<span class="ident" id="3029517">ReadRequest</span><span class="op" id="3029528">(</span><span class="ident" id="3029529">c</span><span class="op" id="3029530">.</span><span class="ident" id="3029531">buf</span><span class="op" id="3029534">.</span><span class="ident" id="3029535">Reader</span><span class="op" id="3029541">)</span><span class="op" id="3029542">;</span>&nbsp;<span class="ident" id="3029544">err</span>&nbsp;<span class="op" id="3029548">!=</span>&nbsp;<span class="builtintype" id="3029551">nil</span>&nbsp;<span class="op" id="3029555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029559">if</span>&nbsp;<span class="ident" id="3029562">c</span><span class="op" id="3029563">.</span><span class="ident" id="3029564">lr</span><span class="op" id="3029566">.</span><span class="ident" id="3029567">N</span>&nbsp;<span class="op" id="3029569">==</span>&nbsp;<span class="num" id="3029572">0</span>&nbsp;<span class="op" id="3029574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029579">return</span>&nbsp;<span class="builtintype" id="3029586">nil</span><span class="op" id="3029589">,</span>&nbsp;<span class="ident" id="3029591">errTooLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029605">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029609">return</span>&nbsp;<span class="builtintype" id="3029616">nil</span><span class="op" id="3029619">,</span>&nbsp;<span class="ident" id="3029621">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029629">c</span><span class="op" id="3029630">.</span><span class="ident" id="3029631">lr</span><span class="op" id="3029633">.</span><span class="ident" id="3029634">N</span>&nbsp;<span class="op" id="3029636">=</span>&nbsp;<span class="ident" id="3029638">noLimit</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029648">req</span><span class="op" id="3029651">.</span><span class="ident" id="3029652">RemoteAddr</span>&nbsp;<span class="op" id="3029663">=</span>&nbsp;<span class="ident" id="3029665">c</span><span class="op" id="3029666">.</span><span class="ident" id="3029667">remoteAddr</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029679">req</span><span class="op" id="3029682">.</span><span class="ident" id="3029683">TLS</span>&nbsp;<span class="op" id="3029687">=</span>&nbsp;<span class="ident" id="3029689">c</span><span class="op" id="3029690">.</span><span class="ident" id="3029691">tlsState</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029702">w</span>&nbsp;<span class="op" id="3029704">=</span>&nbsp;<span class="op" id="3029706">&amp;</span><span class="ident" id="3029707">response</span><span class="op" id="3029715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029719">conn</span><span class="op" id="3029723">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029734">c</span><span class="op" id="3029735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029739">req</span><span class="op" id="3029742">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029754">req</span><span class="op" id="3029757">,</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029761">handlerHeader</span><span class="op" id="3029774">:</span>&nbsp;<span class="builtinfunc" id="3029776">make</span><span class="op" id="3029780">(</span><span class="ident" id="3029781">Header</span><span class="op" id="3029787">)</span><span class="op" id="3029788">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029792">contentLength</span><span class="op" id="3029805">:</span>&nbsp;<span class="op" id="3029807">-</span><span class="num" id="3029808">1</span><span class="op" id="3029809">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3029812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029815">w</span><span class="op" id="3029816">.</span><span class="ident" id="3029817">cw</span><span class="op" id="3029819">.</span><span class="ident" id="3029820">res</span>&nbsp;<span class="op" id="3029824">=</span>&nbsp;<span class="ident" id="3029826">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3029829">w</span><span class="op" id="3029830">.</span><span class="ident" id="3029831">w</span>&nbsp;<span class="op" id="3029833">=</span>&nbsp;<span class="ident" id="3029835">newBufioWriterSize</span><span class="op" id="3029853">(</span><span class="op" id="3029854">&amp;</span><span class="ident" id="3029855">w</span><span class="op" id="3029856">.</span><span class="ident" id="3029857">cw</span><span class="op" id="3029859">,</span>&nbsp;<span class="ident" id="3029861">bufferBeforeChunkingSize</span><span class="op" id="3029885">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029888">return</span>&nbsp;<span class="ident" id="3029895">w</span><span class="op" id="3029896">,</span>&nbsp;<span class="builtintype" id="3029898">nil</span><br>
<span class="lineno"></span><span class="op" id="3029902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3029905">func</span>&nbsp;<span class="op" id="3029910">(</span><span class="ident" id="3029911">w</span>&nbsp;<span class="op" id="3029913">*</span><span class="ident" id="3029914">response</span><span class="op" id="3029922">)</span>&nbsp;<span class="ident" id="3029924">Header</span><span class="op" id="3029930">(</span><span class="op" id="3029931">)</span>&nbsp;<span class="ident" id="3029933">Header</span>&nbsp;<span class="op" id="3029940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3029943">if</span>&nbsp;<span class="ident" id="3029946">w</span><span class="op" id="3029947">.</span><span class="ident" id="3029948">cw</span><span class="op" id="3029950">.</span><span class="ident" id="3029951">header</span>&nbsp;<span class="op" id="3029958">==</span>&nbsp;<span class="builtintype" id="3029961">nil</span>&nbsp;<span class="op" id="3029965">&amp;&amp;</span>&nbsp;<span class="ident" id="3029968">w</span><span class="op" id="3029969">.</span><span class="ident" id="3029970">wroteHeader</span>&nbsp;<span class="op" id="3029982">&amp;&amp;</span>&nbsp;<span class="op" id="3029985">!</span><span class="ident" id="3029986">w</span><span class="op" id="3029987">.</span><span class="ident" id="3029988">cw</span><span class="op" id="3029990">.</span><span class="ident" id="3029991">wroteHeader</span>&nbsp;<span class="op" id="3030003">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3030007">//&nbsp;Accessing&nbsp;the&nbsp;header&nbsp;between&nbsp;logically&nbsp;writing&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3030062">//&nbsp;and&nbsp;physically&nbsp;writing&nbsp;it&nbsp;means&nbsp;we&nbsp;need&nbsp;to&nbsp;allocate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3030119">//&nbsp;a&nbsp;clone&nbsp;to&nbsp;snapshot&nbsp;the&nbsp;logically&nbsp;written&nbsp;state.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030173">w</span><span class="op" id="3030174">.</span><span class="ident" id="3030175">cw</span><span class="op" id="3030177">.</span><span class="ident" id="3030178">header</span>&nbsp;<span class="op" id="3030185">=</span>&nbsp;<span class="ident" id="3030187">w</span><span class="op" id="3030188">.</span><span class="ident" id="3030189">handlerHeader</span><span class="op" id="3030202">.</span><span class="ident" id="3030203">clone</span><span class="op" id="3030208">(</span><span class="op" id="3030209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030212">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030215">w</span><span class="op" id="3030216">.</span><span class="ident" id="3030217">calledHeader</span>&nbsp;<span class="op" id="3030230">=</span>&nbsp;<span class="builtintype" id="3030232">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030238">return</span>&nbsp;<span class="ident" id="3030245">w</span><span class="op" id="3030246">.</span><span class="ident" id="3030247">handlerHeader</span><br>
<span class="lineno"></span><span class="op" id="3030261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3030264">//&nbsp;maxPostHandlerReadBytes&nbsp;is&nbsp;the&nbsp;max&nbsp;number&nbsp;of&nbsp;Request.Body&nbsp;bytes&nbsp;not</span><br>
<span class="lineno">620</span><span class="comment" id="3030335">//&nbsp;consumed&nbsp;by&nbsp;a&nbsp;handler&nbsp;that&nbsp;the&nbsp;server&nbsp;will&nbsp;read&nbsp;from&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3030402">//&nbsp;in&nbsp;order&nbsp;to&nbsp;keep&nbsp;a&nbsp;connection&nbsp;alive.&nbsp;&nbsp;If&nbsp;there&nbsp;are&nbsp;more&nbsp;bytes&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3030472">//&nbsp;this&nbsp;then&nbsp;the&nbsp;server&nbsp;to&nbsp;be&nbsp;paranoid&nbsp;instead&nbsp;sends&nbsp;a&nbsp;&#34;Connection:</span><br>
<span class="lineno"></span><span class="comment" id="3030540">//&nbsp;close&#34;&nbsp;response.</span><br>
<span class="lineno"></span><span class="comment" id="3030560">//</span><br>
<span class="lineno">625</span><span class="comment" id="3030563">//&nbsp;This&nbsp;number&nbsp;is&nbsp;approximately&nbsp;what&nbsp;a&nbsp;typical&nbsp;machine&#39;s&nbsp;TCP&nbsp;buffer</span><br>
<span class="lineno"></span><span class="comment" id="3030631">//&nbsp;size&nbsp;is&nbsp;anyway.&nbsp;&nbsp;(if&nbsp;we&nbsp;have&nbsp;the&nbsp;bytes&nbsp;on&nbsp;the&nbsp;machine,&nbsp;we&nbsp;might&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3030701">//&nbsp;well&nbsp;read&nbsp;them)</span><br>
<span class="lineno"></span><span class="keyword" id="3030720">const</span>&nbsp;<span class="ident" id="3030726">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3030750">=</span>&nbsp;<span class="num" id="3030752">256</span>&nbsp;<span class="op" id="3030756">&lt;&lt;</span>&nbsp;<span class="num" id="3030759">10</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3030763">func</span>&nbsp;<span class="op" id="3030768">(</span><span class="ident" id="3030769">w</span>&nbsp;<span class="op" id="3030771">*</span><span class="ident" id="3030772">response</span><span class="op" id="3030780">)</span>&nbsp;<span class="ident" id="3030782">WriteHeader</span><span class="op" id="3030793">(</span><span class="ident" id="3030794">code</span>&nbsp;<span class="builtintype" id="3030799">int</span><span class="op" id="3030802">)</span>&nbsp;<span class="op" id="3030804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030807">if</span>&nbsp;<span class="ident" id="3030810">w</span><span class="op" id="3030811">.</span><span class="ident" id="3030812">conn</span><span class="op" id="3030816">.</span><span class="ident" id="3030817">hijacked</span><span class="op" id="3030825">(</span><span class="op" id="3030826">)</span>&nbsp;<span class="op" id="3030828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030832">w</span><span class="op" id="3030833">.</span><span class="ident" id="3030834">conn</span><span class="op" id="3030838">.</span><span class="ident" id="3030839">server</span><span class="op" id="3030845">.</span><span class="ident" id="3030846">logf</span><span class="op" id="3030850">(</span><span class="string" id="3030851">&#34;http:&nbsp;response.WriteHeader&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3030902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030906">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3030914">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3030917">if</span>&nbsp;<span class="ident" id="3030920">w</span><span class="op" id="3030921">.</span><span class="ident" id="3030922">wroteHeader</span>&nbsp;<span class="op" id="3030934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3030938">w</span><span class="op" id="3030939">.</span><span class="ident" id="3030940">conn</span><span class="op" id="3030944">.</span><span class="ident" id="3030945">server</span><span class="op" id="3030951">.</span><span class="ident" id="3030952">logf</span><span class="op" id="3030956">(</span><span class="string" id="3030957">&#34;http:&nbsp;multiple&nbsp;response.WriteHeader&nbsp;calls&#34;</span><span class="op" id="3031000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031004">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031015">w</span><span class="op" id="3031016">.</span><span class="ident" id="3031017">wroteHeader</span>&nbsp;<span class="op" id="3031029">=</span>&nbsp;<span class="builtintype" id="3031031">true</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031037">w</span><span class="op" id="3031038">.</span><span class="ident" id="3031039">status</span>&nbsp;<span class="op" id="3031046">=</span>&nbsp;<span class="ident" id="3031048">code</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031055">if</span>&nbsp;<span class="ident" id="3031058">w</span><span class="op" id="3031059">.</span><span class="ident" id="3031060">calledHeader</span>&nbsp;<span class="op" id="3031073">&amp;&amp;</span>&nbsp;<span class="ident" id="3031076">w</span><span class="op" id="3031077">.</span><span class="ident" id="3031078">cw</span><span class="op" id="3031080">.</span><span class="ident" id="3031081">header</span>&nbsp;<span class="op" id="3031088">==</span>&nbsp;<span class="builtintype" id="3031091">nil</span>&nbsp;<span class="op" id="3031095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031099">w</span><span class="op" id="3031100">.</span><span class="ident" id="3031101">cw</span><span class="op" id="3031103">.</span><span class="ident" id="3031104">header</span>&nbsp;<span class="op" id="3031111">=</span>&nbsp;<span class="ident" id="3031113">w</span><span class="op" id="3031114">.</span><span class="ident" id="3031115">handlerHeader</span><span class="op" id="3031128">.</span><span class="ident" id="3031129">clone</span><span class="op" id="3031134">(</span><span class="op" id="3031135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031138">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031142">if</span>&nbsp;<span class="ident" id="3031145">cl</span>&nbsp;<span class="op" id="3031148">:=</span>&nbsp;<span class="ident" id="3031151">w</span><span class="op" id="3031152">.</span><span class="ident" id="3031153">handlerHeader</span><span class="op" id="3031166">.</span><span class="ident" id="3031167">get</span><span class="op" id="3031170">(</span><span class="string" id="3031171">&#34;Content-Length&#34;</span><span class="op" id="3031187">)</span><span class="op" id="3031188">;</span>&nbsp;<span class="ident" id="3031190">cl</span>&nbsp;<span class="op" id="3031193">!=</span>&nbsp;<span class="string" id="3031196">&#34;&#34;</span>&nbsp;<span class="op" id="3031199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031203">v</span><span class="op" id="3031204">,</span>&nbsp;<span class="ident" id="3031206">err</span>&nbsp;<span class="op" id="3031210">:=</span>&nbsp;<span class="ident" id="3031213">strconv</span><span class="op" id="3031220">.</span><span class="ident" id="3031221">ParseInt</span><span class="op" id="3031229">(</span><span class="ident" id="3031230">cl</span><span class="op" id="3031232">,</span>&nbsp;<span class="num" id="3031234">10</span><span class="op" id="3031236">,</span>&nbsp;<span class="num" id="3031238">64</span><span class="op" id="3031240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3031244">if</span>&nbsp;<span class="ident" id="3031247">err</span>&nbsp;<span class="op" id="3031251">==</span>&nbsp;<span class="builtintype" id="3031254">nil</span>&nbsp;<span class="op" id="3031258">&amp;&amp;</span>&nbsp;<span class="ident" id="3031261">v</span>&nbsp;<span class="op" id="3031263">&gt;=</span>&nbsp;<span class="num" id="3031266">0</span>&nbsp;<span class="op" id="3031268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031273">w</span><span class="op" id="3031274">.</span><span class="ident" id="3031275">contentLength</span>&nbsp;<span class="op" id="3031289">=</span>&nbsp;<span class="ident" id="3031291">v</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031295">}</span>&nbsp;<span class="keyword" id="3031297">else</span>&nbsp;<span class="op" id="3031302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031307">w</span><span class="op" id="3031308">.</span><span class="ident" id="3031309">conn</span><span class="op" id="3031313">.</span><span class="ident" id="3031314">server</span><span class="op" id="3031320">.</span><span class="ident" id="3031321">logf</span><span class="op" id="3031325">(</span><span class="string" id="3031326">&#34;http:&nbsp;invalid&nbsp;Content-Length&nbsp;of&nbsp;%q&#34;</span><span class="op" id="3031362">,</span>&nbsp;<span class="ident" id="3031364">cl</span><span class="op" id="3031366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031371">w</span><span class="op" id="3031372">.</span><span class="ident" id="3031373">handlerHeader</span><span class="op" id="3031386">.</span><span class="ident" id="3031387">Del</span><span class="op" id="3031390">(</span><span class="string" id="3031391">&#34;Content-Length&#34;</span><span class="op" id="3031407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031414">}</span><br>
<span class="lineno">655</span><span class="op" id="3031416">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3031419">//&nbsp;extraHeader&nbsp;is&nbsp;the&nbsp;set&nbsp;of&nbsp;headers&nbsp;sometimes&nbsp;added&nbsp;by&nbsp;chunkWriter.writeHeader.</span><br>
<span class="lineno"></span><span class="comment" id="3031500">//&nbsp;This&nbsp;type&nbsp;is&nbsp;used&nbsp;to&nbsp;avoid&nbsp;extra&nbsp;allocations&nbsp;from&nbsp;cloning&nbsp;and/or&nbsp;populating</span><br>
<span class="lineno"></span><span class="comment" id="3031579">//&nbsp;the&nbsp;response&nbsp;Header&nbsp;map&nbsp;and&nbsp;all&nbsp;its&nbsp;1-element&nbsp;slices.</span><br>
<span class="lineno">660</span><span class="keyword" id="3031636">type</span>&nbsp;<span class="ident" id="3031641">extraHeader</span>&nbsp;<span class="keyword" id="3031653">struct</span>&nbsp;<span class="op" id="3031660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031663">contentType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3031680">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031688">connection</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3031705">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031713">transferEncoding</span>&nbsp;<span class="builtintype" id="3031730">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031738">date</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031755">[</span><span class="op" id="3031756">]</span><span class="builtintype" id="3031757">byte</span>&nbsp;<span class="comment" id="3031762">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3031785">contentLength</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031802">[</span><span class="op" id="3031803">]</span><span class="builtintype" id="3031804">byte</span>&nbsp;<span class="comment" id="3031809">//&nbsp;written&nbsp;if&nbsp;not&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3031831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3031834">//&nbsp;Sorted&nbsp;the&nbsp;same&nbsp;as&nbsp;extraHeader.Write&#39;s&nbsp;loop.</span><br>
<span class="lineno"></span><span class="keyword" id="3031882">var</span>&nbsp;<span class="ident" id="3031886">extraHeaderKeys</span>&nbsp;<span class="op" id="3031902">=</span>&nbsp;<span class="op" id="3031904">[</span><span class="op" id="3031905">]</span><span class="op" id="3031906">[</span><span class="op" id="3031907">]</span><span class="builtintype" id="3031908">byte</span><span class="op" id="3031912">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031915">[</span><span class="op" id="3031916">]</span><span class="builtintype" id="3031917">byte</span><span class="op" id="3031921">(</span><span class="string" id="3031922">&#34;Content-Type&#34;</span><span class="op" id="3031936">)</span><span class="op" id="3031937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031940">[</span><span class="op" id="3031941">]</span><span class="builtintype" id="3031942">byte</span><span class="op" id="3031946">(</span><span class="string" id="3031947">&#34;Connection&#34;</span><span class="op" id="3031959">)</span><span class="op" id="3031960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3031963">[</span><span class="op" id="3031964">]</span><span class="builtintype" id="3031965">byte</span><span class="op" id="3031969">(</span><span class="string" id="3031970">&#34;Transfer-Encoding&#34;</span><span class="op" id="3031989">)</span><span class="op" id="3031990">,</span><br>
<span class="lineno"></span><span class="op" id="3031992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">675</span><span class="keyword" id="3031995">var</span>&nbsp;<span class="op" id="3031999">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032002">headerContentLength</span>&nbsp;<span class="op" id="3032022">=</span>&nbsp;<span class="op" id="3032024">[</span><span class="op" id="3032025">]</span><span class="builtintype" id="3032026">byte</span><span class="op" id="3032030">(</span><span class="string" id="3032031">&#34;Content-Length:&nbsp;&#34;</span><span class="op" id="3032049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032052">headerDate</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3032072">=</span>&nbsp;<span class="op" id="3032074">[</span><span class="op" id="3032075">]</span><span class="builtintype" id="3032076">byte</span><span class="op" id="3032080">(</span><span class="string" id="3032081">&#34;Date:&nbsp;&#34;</span><span class="op" id="3032089">)</span><br>
<span class="lineno"></span><span class="op" id="3032091">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="comment" id="3032094">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;headers&nbsp;described&nbsp;in&nbsp;h&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="3032143">//</span><br>
<span class="lineno"></span><span class="comment" id="3032146">//&nbsp;This&nbsp;method&nbsp;has&nbsp;a&nbsp;value&nbsp;receiver,&nbsp;despite&nbsp;the&nbsp;somewhat&nbsp;large&nbsp;size</span><br>
<span class="lineno"></span><span class="comment" id="3032215">//&nbsp;of&nbsp;h,&nbsp;because&nbsp;it&nbsp;prevents&nbsp;an&nbsp;allocation.&nbsp;The&nbsp;escape&nbsp;analysis&nbsp;isn&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="3032285">//&nbsp;smart&nbsp;enough&nbsp;to&nbsp;realize&nbsp;this&nbsp;function&nbsp;doesn&#39;t&nbsp;mutate&nbsp;h.</span><br>
<span class="lineno">685</span><span class="keyword" id="3032344">func</span>&nbsp;<span class="op" id="3032349">(</span><span class="ident" id="3032350">h</span>&nbsp;<span class="ident" id="3032352">extraHeader</span><span class="op" id="3032363">)</span>&nbsp;<span class="ident" id="3032365">Write</span><span class="op" id="3032370">(</span><span class="ident" id="3032371">w</span>&nbsp;<span class="op" id="3032373">*</span><span class="ident" id="3032374">bufio</span><span class="op" id="3032379">.</span><span class="ident" id="3032380">Writer</span><span class="op" id="3032386">)</span>&nbsp;<span class="op" id="3032388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3032391">if</span>&nbsp;<span class="ident" id="3032394">h</span><span class="op" id="3032395">.</span><span class="ident" id="3032396">date</span>&nbsp;<span class="op" id="3032401">!=</span>&nbsp;<span class="builtintype" id="3032404">nil</span>&nbsp;<span class="op" id="3032408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032412">w</span><span class="op" id="3032413">.</span><span class="ident" id="3032414">Write</span><span class="op" id="3032419">(</span><span class="ident" id="3032420">headerDate</span><span class="op" id="3032430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032434">w</span><span class="op" id="3032435">.</span><span class="ident" id="3032436">Write</span><span class="op" id="3032441">(</span><span class="ident" id="3032442">h</span><span class="op" id="3032443">.</span><span class="ident" id="3032444">date</span><span class="op" id="3032448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032452">w</span><span class="op" id="3032453">.</span><span class="ident" id="3032454">Write</span><span class="op" id="3032459">(</span><span class="ident" id="3032460">crlf</span><span class="op" id="3032464">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3032467">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3032470">if</span>&nbsp;<span class="ident" id="3032473">h</span><span class="op" id="3032474">.</span><span class="ident" id="3032475">contentLength</span>&nbsp;<span class="op" id="3032489">!=</span>&nbsp;<span class="builtintype" id="3032492">nil</span>&nbsp;<span class="op" id="3032496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032500">w</span><span class="op" id="3032501">.</span><span class="ident" id="3032502">Write</span><span class="op" id="3032507">(</span><span class="ident" id="3032508">headerContentLength</span><span class="op" id="3032527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032531">w</span><span class="op" id="3032532">.</span><span class="ident" id="3032533">Write</span><span class="op" id="3032538">(</span><span class="ident" id="3032539">h</span><span class="op" id="3032540">.</span><span class="ident" id="3032541">contentLength</span><span class="op" id="3032554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032558">w</span><span class="op" id="3032559">.</span><span class="ident" id="3032560">Write</span><span class="op" id="3032565">(</span><span class="ident" id="3032566">crlf</span><span class="op" id="3032570">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3032573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3032576">for</span>&nbsp;<span class="ident" id="3032580">i</span><span class="op" id="3032581">,</span>&nbsp;<span class="ident" id="3032583">v</span>&nbsp;<span class="op" id="3032585">:=</span>&nbsp;<span class="keyword" id="3032588">range</span>&nbsp;<span class="op" id="3032594">[</span><span class="op" id="3032595">]</span><span class="builtintype" id="3032596">string</span><span class="op" id="3032602">{</span><span class="ident" id="3032603">h</span><span class="op" id="3032604">.</span><span class="ident" id="3032605">contentType</span><span class="op" id="3032616">,</span>&nbsp;<span class="ident" id="3032618">h</span><span class="op" id="3032619">.</span><span class="ident" id="3032620">connection</span><span class="op" id="3032630">,</span>&nbsp;<span class="ident" id="3032632">h</span><span class="op" id="3032633">.</span><span class="ident" id="3032634">transferEncoding</span><span class="op" id="3032650">}</span>&nbsp;<span class="op" id="3032652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3032656">if</span>&nbsp;<span class="ident" id="3032659">v</span>&nbsp;<span class="op" id="3032661">!=</span>&nbsp;<span class="string" id="3032664">&#34;&#34;</span>&nbsp;<span class="op" id="3032667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032672">w</span><span class="op" id="3032673">.</span><span class="ident" id="3032674">Write</span><span class="op" id="3032679">(</span><span class="ident" id="3032680">extraHeaderKeys</span><span class="op" id="3032695">[</span><span class="ident" id="3032696">i</span><span class="op" id="3032697">]</span><span class="op" id="3032698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032703">w</span><span class="op" id="3032704">.</span><span class="ident" id="3032705">Write</span><span class="op" id="3032710">(</span><span class="ident" id="3032711">colonSpace</span><span class="op" id="3032721">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032726">w</span><span class="op" id="3032727">.</span><span class="ident" id="3032728">WriteString</span><span class="op" id="3032739">(</span><span class="ident" id="3032740">v</span><span class="op" id="3032741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3032746">w</span><span class="op" id="3032747">.</span><span class="ident" id="3032748">Write</span><span class="op" id="3032753">(</span><span class="ident" id="3032754">crlf</span><span class="op" id="3032758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3032762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3032765">}</span><br>
<span class="lineno"></span><span class="op" id="3032767">}</span><br>
<span class="lineno">705</span><br>
<span class="lineno"></span><span class="comment" id="3032770">//&nbsp;writeHeader&nbsp;finalizes&nbsp;the&nbsp;header&nbsp;sent&nbsp;to&nbsp;the&nbsp;client&nbsp;and&nbsp;writes&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3032839">//&nbsp;to&nbsp;cw.res.conn.buf.</span><br>
<span class="lineno"></span><span class="comment" id="3032862">//</span><br>
<span class="lineno"></span><span class="comment" id="3032865">//&nbsp;p&nbsp;is&nbsp;not&nbsp;written&nbsp;by&nbsp;writeHeader,&nbsp;but&nbsp;is&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;the&nbsp;body</span><br>
<span class="lineno">710</span><span class="comment" id="3032936">//&nbsp;that&nbsp;will&nbsp;be&nbsp;written.&nbsp;&nbsp;It&nbsp;is&nbsp;sniffed&nbsp;for&nbsp;a&nbsp;Content-Type&nbsp;if&nbsp;none&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3033006">//&nbsp;set&nbsp;explicitly.&nbsp;&nbsp;It&#39;s&nbsp;also&nbsp;used&nbsp;to&nbsp;set&nbsp;the&nbsp;Content-Length,&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3033075">//&nbsp;total&nbsp;body&nbsp;size&nbsp;was&nbsp;small&nbsp;and&nbsp;the&nbsp;handler&nbsp;has&nbsp;already&nbsp;finished</span><br>
<span class="lineno"></span><span class="comment" id="3033141">//&nbsp;running.</span><br>
<span class="lineno"></span><span class="keyword" id="3033153">func</span>&nbsp;<span class="op" id="3033158">(</span><span class="ident" id="3033159">cw</span>&nbsp;<span class="op" id="3033162">*</span><span class="ident" id="3033163">chunkWriter</span><span class="op" id="3033174">)</span>&nbsp;<span class="ident" id="3033176">writeHeader</span><span class="op" id="3033187">(</span><span class="ident" id="3033188">p</span>&nbsp;<span class="op" id="3033190">[</span><span class="op" id="3033191">]</span><span class="builtintype" id="3033192">byte</span><span class="op" id="3033196">)</span>&nbsp;<span class="op" id="3033198">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033201">if</span>&nbsp;<span class="ident" id="3033204">cw</span><span class="op" id="3033206">.</span><span class="ident" id="3033207">wroteHeader</span>&nbsp;<span class="op" id="3033219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033223">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033234">cw</span><span class="op" id="3033236">.</span><span class="ident" id="3033237">wroteHeader</span>&nbsp;<span class="op" id="3033249">=</span>&nbsp;<span class="builtintype" id="3033251">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033258">w</span>&nbsp;<span class="op" id="3033260">:=</span>&nbsp;<span class="ident" id="3033263">cw</span><span class="op" id="3033265">.</span><span class="ident" id="3033266">res</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033271">keepAlivesEnabled</span>&nbsp;<span class="op" id="3033289">:=</span>&nbsp;<span class="ident" id="3033292">w</span><span class="op" id="3033293">.</span><span class="ident" id="3033294">conn</span><span class="op" id="3033298">.</span><span class="ident" id="3033299">server</span><span class="op" id="3033305">.</span><span class="ident" id="3033306">doKeepAlives</span><span class="op" id="3033318">(</span><span class="op" id="3033319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033322">isHEAD</span>&nbsp;<span class="op" id="3033329">:=</span>&nbsp;<span class="ident" id="3033332">w</span><span class="op" id="3033333">.</span><span class="ident" id="3033334">req</span><span class="op" id="3033337">.</span><span class="ident" id="3033338">Method</span>&nbsp;<span class="op" id="3033345">==</span>&nbsp;<span class="string" id="3033348">&#34;HEAD&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3033357">//&nbsp;header&nbsp;is&nbsp;written&nbsp;out&nbsp;to&nbsp;w.conn.buf&nbsp;below.&nbsp;Depending&nbsp;on&nbsp;the</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3033421">//&nbsp;state&nbsp;of&nbsp;the&nbsp;handler,&nbsp;we&nbsp;either&nbsp;own&nbsp;the&nbsp;map&nbsp;or&nbsp;not.&nbsp;If&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3033483">//&nbsp;don&#39;t&nbsp;own&nbsp;it,&nbsp;the&nbsp;exclude&nbsp;map&nbsp;is&nbsp;created&nbsp;lazily&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3033539">//&nbsp;WriteSubset&nbsp;to&nbsp;remove&nbsp;headers.&nbsp;The&nbsp;setHeader&nbsp;struct&nbsp;holds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3033601">//&nbsp;headers&nbsp;we&nbsp;need&nbsp;to&nbsp;add.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033629">header</span>&nbsp;<span class="op" id="3033636">:=</span>&nbsp;<span class="ident" id="3033639">cw</span><span class="op" id="3033641">.</span><span class="ident" id="3033642">header</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033650">owned</span>&nbsp;<span class="op" id="3033656">:=</span>&nbsp;<span class="ident" id="3033659">header</span>&nbsp;<span class="op" id="3033666">!=</span>&nbsp;<span class="builtintype" id="3033669">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033674">if</span>&nbsp;<span class="op" id="3033677">!</span><span class="ident" id="3033678">owned</span>&nbsp;<span class="op" id="3033684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033688">header</span>&nbsp;<span class="op" id="3033695">=</span>&nbsp;<span class="ident" id="3033697">w</span><span class="op" id="3033698">.</span><span class="ident" id="3033699">handlerHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033717">var</span>&nbsp;<span class="ident" id="3033721">excludeHeader</span>&nbsp;<span class="keyword" id="3033735">map</span><span class="op" id="3033738">[</span><span class="builtintype" id="3033739">string</span><span class="op" id="3033745">]</span><span class="builtintype" id="3033746">bool</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033752">delHeader</span>&nbsp;<span class="op" id="3033762">:=</span>&nbsp;<span class="keyword" id="3033765">func</span><span class="op" id="3033769">(</span><span class="ident" id="3033770">key</span>&nbsp;<span class="builtintype" id="3033774">string</span><span class="op" id="3033780">)</span>&nbsp;<span class="op" id="3033782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033786">if</span>&nbsp;<span class="ident" id="3033789">owned</span>&nbsp;<span class="op" id="3033795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033800">header</span><span class="op" id="3033806">.</span><span class="ident" id="3033807">Del</span><span class="op" id="3033810">(</span><span class="ident" id="3033811">key</span><span class="op" id="3033814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033819">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033828">}</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033832">if</span>&nbsp;<span class="ident" id="3033835">_</span><span class="op" id="3033836">,</span>&nbsp;<span class="ident" id="3033838">ok</span>&nbsp;<span class="op" id="3033841">:=</span>&nbsp;<span class="ident" id="3033844">header</span><span class="op" id="3033850">[</span><span class="ident" id="3033851">key</span><span class="op" id="3033854">]</span><span class="op" id="3033855">;</span>&nbsp;<span class="op" id="3033857">!</span><span class="ident" id="3033858">ok</span>&nbsp;<span class="op" id="3033861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033866">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033879">if</span>&nbsp;<span class="ident" id="3033882">excludeHeader</span>&nbsp;<span class="op" id="3033896">==</span>&nbsp;<span class="builtintype" id="3033899">nil</span>&nbsp;<span class="op" id="3033903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033908">excludeHeader</span>&nbsp;<span class="op" id="3033922">=</span>&nbsp;<span class="builtinfunc" id="3033924">make</span><span class="op" id="3033928">(</span><span class="keyword" id="3033929">map</span><span class="op" id="3033932">[</span><span class="builtintype" id="3033933">string</span><span class="op" id="3033939">]</span><span class="builtintype" id="3033940">bool</span><span class="op" id="3033944">)</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3033952">excludeHeader</span><span class="op" id="3033965">[</span><span class="ident" id="3033966">key</span><span class="op" id="3033969">]</span>&nbsp;<span class="op" id="3033971">=</span>&nbsp;<span class="builtintype" id="3033973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3033979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3033982">var</span>&nbsp;<span class="ident" id="3033986">setHeader</span>&nbsp;<span class="ident" id="3033996">extraHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034010">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;is&nbsp;done&nbsp;but&nbsp;never&nbsp;sent&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034069">//&nbsp;response&nbsp;header&nbsp;and&nbsp;this&nbsp;is&nbsp;our&nbsp;first&nbsp;(and&nbsp;last)&nbsp;write,&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034133">//&nbsp;it,&nbsp;even&nbsp;to&nbsp;zero.&nbsp;This&nbsp;helps&nbsp;HTTP/1.0&nbsp;clients&nbsp;keep&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034194">//&nbsp;&#34;keep-alive&#34;&nbsp;connections&nbsp;alive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034230">//&nbsp;Exceptions:&nbsp;304/204/1xx&nbsp;responses&nbsp;never&nbsp;get&nbsp;Content-Length,&nbsp;and&nbsp;if</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034301">//&nbsp;it&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;difference&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034365">//&nbsp;0&nbsp;actual&nbsp;bytes&nbsp;and&nbsp;0&nbsp;bytes&nbsp;because&nbsp;the&nbsp;handler&nbsp;noticed&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034427">//&nbsp;was&nbsp;a&nbsp;HEAD&nbsp;request&nbsp;and&nbsp;chose&nbsp;not&nbsp;to&nbsp;write&nbsp;anything.&nbsp;&nbsp;So&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034491">//&nbsp;HEAD,&nbsp;the&nbsp;handler&nbsp;should&nbsp;either&nbsp;write&nbsp;the&nbsp;Content-Length&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034555">//&nbsp;write&nbsp;non-zero&nbsp;bytes.&nbsp;&nbsp;If&nbsp;it&#39;s&nbsp;actually&nbsp;0&nbsp;bytes&nbsp;and&nbsp;the</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034615">//&nbsp;handler&nbsp;never&nbsp;looked&nbsp;at&nbsp;the&nbsp;Request.Method,&nbsp;we&nbsp;just&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034677">//&nbsp;send&nbsp;a&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3034711">if</span>&nbsp;<span class="ident" id="3034714">w</span><span class="op" id="3034715">.</span><span class="ident" id="3034716">handlerDone</span>&nbsp;<span class="op" id="3034728">&amp;&amp;</span>&nbsp;<span class="ident" id="3034731">bodyAllowedForStatus</span><span class="op" id="3034751">(</span><span class="ident" id="3034752">w</span><span class="op" id="3034753">.</span><span class="ident" id="3034754">status</span><span class="op" id="3034760">)</span>&nbsp;<span class="op" id="3034762">&amp;&amp;</span>&nbsp;<span class="ident" id="3034765">header</span><span class="op" id="3034771">.</span><span class="ident" id="3034772">get</span><span class="op" id="3034775">(</span><span class="string" id="3034776">&#34;Content-Length&#34;</span><span class="op" id="3034792">)</span>&nbsp;<span class="op" id="3034794">==</span>&nbsp;<span class="string" id="3034797">&#34;&#34;</span>&nbsp;<span class="op" id="3034800">&amp;&amp;</span>&nbsp;<span class="op" id="3034803">(</span><span class="op" id="3034804">!</span><span class="ident" id="3034805">isHEAD</span>&nbsp;<span class="op" id="3034812">||</span>&nbsp;<span class="builtinfunc" id="3034815">len</span><span class="op" id="3034818">(</span><span class="ident" id="3034819">p</span><span class="op" id="3034820">)</span>&nbsp;<span class="op" id="3034822">&gt;</span>&nbsp;<span class="num" id="3034824">0</span><span class="op" id="3034825">)</span>&nbsp;<span class="op" id="3034827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3034831">w</span><span class="op" id="3034832">.</span><span class="ident" id="3034833">contentLength</span>&nbsp;<span class="op" id="3034847">=</span>&nbsp;<span class="ident" id="3034849">int64</span><span class="op" id="3034854">(</span><span class="builtinfunc" id="3034855">len</span><span class="op" id="3034858">(</span><span class="ident" id="3034859">p</span><span class="op" id="3034860">)</span><span class="op" id="3034861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3034865">setHeader</span><span class="op" id="3034874">.</span><span class="ident" id="3034875">contentLength</span>&nbsp;<span class="op" id="3034889">=</span>&nbsp;<span class="ident" id="3034891">strconv</span><span class="op" id="3034898">.</span><span class="ident" id="3034899">AppendInt</span><span class="op" id="3034908">(</span><span class="ident" id="3034909">cw</span><span class="op" id="3034911">.</span><span class="ident" id="3034912">res</span><span class="op" id="3034915">.</span><span class="ident" id="3034916">clenBuf</span><span class="op" id="3034923">[</span><span class="op" id="3034924">:</span><span class="num" id="3034925">0</span><span class="op" id="3034926">]</span><span class="op" id="3034927">,</span>&nbsp;<span class="ident" id="3034929">int64</span><span class="op" id="3034934">(</span><span class="builtinfunc" id="3034935">len</span><span class="op" id="3034938">(</span><span class="ident" id="3034939">p</span><span class="op" id="3034940">)</span><span class="op" id="3034941">)</span><span class="op" id="3034942">,</span>&nbsp;<span class="num" id="3034944">10</span><span class="op" id="3034946">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3034949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3034953">//&nbsp;If&nbsp;this&nbsp;was&nbsp;an&nbsp;HTTP/1.0&nbsp;request&nbsp;with&nbsp;keep-alive&nbsp;and&nbsp;we&nbsp;sent&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035019">//&nbsp;Content-Length&nbsp;back,&nbsp;we&nbsp;can&nbsp;make&nbsp;this&nbsp;a&nbsp;keep-alive&nbsp;response&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035087">if</span>&nbsp;<span class="ident" id="3035090">w</span><span class="op" id="3035091">.</span><span class="ident" id="3035092">req</span><span class="op" id="3035095">.</span><span class="ident" id="3035096">wantsHttp10KeepAlive</span><span class="op" id="3035116">(</span><span class="op" id="3035117">)</span>&nbsp;<span class="op" id="3035119">&amp;&amp;</span>&nbsp;<span class="ident" id="3035122">keepAlivesEnabled</span>&nbsp;<span class="op" id="3035140">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035144">sentLength</span>&nbsp;<span class="op" id="3035155">:=</span>&nbsp;<span class="ident" id="3035158">header</span><span class="op" id="3035164">.</span><span class="ident" id="3035165">get</span><span class="op" id="3035168">(</span><span class="string" id="3035169">&#34;Content-Length&#34;</span><span class="op" id="3035185">)</span>&nbsp;<span class="op" id="3035187">!=</span>&nbsp;<span class="string" id="3035190">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035195">if</span>&nbsp;<span class="ident" id="3035198">sentLength</span>&nbsp;<span class="op" id="3035209">&amp;&amp;</span>&nbsp;<span class="ident" id="3035212">header</span><span class="op" id="3035218">.</span><span class="ident" id="3035219">get</span><span class="op" id="3035222">(</span><span class="string" id="3035223">&#34;Connection&#34;</span><span class="op" id="3035235">)</span>&nbsp;<span class="op" id="3035237">==</span>&nbsp;<span class="string" id="3035240">&#34;keep-alive&#34;</span>&nbsp;<span class="op" id="3035253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035258">w</span><span class="op" id="3035259">.</span><span class="ident" id="3035260">closeAfterReply</span>&nbsp;<span class="op" id="3035276">=</span>&nbsp;<span class="builtintype" id="3035278">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035289">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035293">//&nbsp;Check&nbsp;for&nbsp;a&nbsp;explicit&nbsp;(and&nbsp;valid)&nbsp;Content-Length&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035353">hasCL</span>&nbsp;<span class="op" id="3035359">:=</span>&nbsp;<span class="ident" id="3035362">w</span><span class="op" id="3035363">.</span><span class="ident" id="3035364">contentLength</span>&nbsp;<span class="op" id="3035378">!=</span>&nbsp;<span class="op" id="3035381">-</span><span class="num" id="3035382">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035386">if</span>&nbsp;<span class="ident" id="3035389">w</span><span class="op" id="3035390">.</span><span class="ident" id="3035391">req</span><span class="op" id="3035394">.</span><span class="ident" id="3035395">wantsHttp10KeepAlive</span><span class="op" id="3035415">(</span><span class="op" id="3035416">)</span>&nbsp;<span class="op" id="3035418">&amp;&amp;</span>&nbsp;<span class="op" id="3035421">(</span><span class="ident" id="3035422">isHEAD</span>&nbsp;<span class="op" id="3035429">||</span>&nbsp;<span class="ident" id="3035432">hasCL</span><span class="op" id="3035437">)</span>&nbsp;<span class="op" id="3035439">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035443">_</span><span class="op" id="3035444">,</span>&nbsp;<span class="ident" id="3035446">connectionHeaderSet</span>&nbsp;<span class="op" id="3035466">:=</span>&nbsp;<span class="ident" id="3035469">header</span><span class="op" id="3035475">[</span><span class="string" id="3035476">&#34;Connection&#34;</span><span class="op" id="3035488">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035492">if</span>&nbsp;<span class="op" id="3035495">!</span><span class="ident" id="3035496">connectionHeaderSet</span>&nbsp;<span class="op" id="3035516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035521">setHeader</span><span class="op" id="3035530">.</span><span class="ident" id="3035531">connection</span>&nbsp;<span class="op" id="3035542">=</span>&nbsp;<span class="string" id="3035544">&#34;keep-alive&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035562">}</span>&nbsp;<span class="keyword" id="3035564">else</span>&nbsp;<span class="keyword" id="3035569">if</span>&nbsp;<span class="op" id="3035572">!</span><span class="ident" id="3035573">w</span><span class="op" id="3035574">.</span><span class="ident" id="3035575">req</span><span class="op" id="3035578">.</span><span class="ident" id="3035579">ProtoAtLeast</span><span class="op" id="3035591">(</span><span class="num" id="3035592">1</span><span class="op" id="3035593">,</span>&nbsp;<span class="num" id="3035595">1</span><span class="op" id="3035596">)</span>&nbsp;<span class="op" id="3035598">||</span>&nbsp;<span class="ident" id="3035601">w</span><span class="op" id="3035602">.</span><span class="ident" id="3035603">req</span><span class="op" id="3035606">.</span><span class="ident" id="3035607">wantsClose</span><span class="op" id="3035617">(</span><span class="op" id="3035618">)</span>&nbsp;<span class="op" id="3035620">{</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035624">w</span><span class="op" id="3035625">.</span><span class="ident" id="3035626">closeAfterReply</span>&nbsp;<span class="op" id="3035642">=</span>&nbsp;<span class="builtintype" id="3035644">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035654">if</span>&nbsp;<span class="ident" id="3035657">header</span><span class="op" id="3035663">.</span><span class="ident" id="3035664">get</span><span class="op" id="3035667">(</span><span class="string" id="3035668">&#34;Connection&#34;</span><span class="op" id="3035680">)</span>&nbsp;<span class="op" id="3035682">==</span>&nbsp;<span class="string" id="3035685">&#34;close&#34;</span>&nbsp;<span class="op" id="3035693">||</span>&nbsp;<span class="op" id="3035696">!</span><span class="ident" id="3035697">keepAlivesEnabled</span>&nbsp;<span class="op" id="3035715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3035719">w</span><span class="op" id="3035720">.</span><span class="ident" id="3035721">closeAfterReply</span>&nbsp;<span class="op" id="3035737">=</span>&nbsp;<span class="builtintype" id="3035739">true</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3035745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035749">//&nbsp;Per&nbsp;RFC&nbsp;2616,&nbsp;we&nbsp;should&nbsp;consume&nbsp;the&nbsp;request&nbsp;body&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035809">//&nbsp;replying,&nbsp;if&nbsp;the&nbsp;handler&nbsp;hasn&#39;t&nbsp;already&nbsp;done&nbsp;so.&nbsp;&nbsp;But&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035870">//&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;do&nbsp;an&nbsp;unbounded&nbsp;amount&nbsp;of&nbsp;reading&nbsp;here&nbsp;for</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3035931">//&nbsp;DoS&nbsp;reasons,&nbsp;so&nbsp;we&nbsp;only&nbsp;try&nbsp;up&nbsp;to&nbsp;a&nbsp;threshold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3035982">if</span>&nbsp;<span class="ident" id="3035985">w</span><span class="op" id="3035986">.</span><span class="ident" id="3035987">req</span><span class="op" id="3035990">.</span><span class="ident" id="3035991">ContentLength</span>&nbsp;<span class="op" id="3036005">!=</span>&nbsp;<span class="num" id="3036008">0</span>&nbsp;<span class="op" id="3036010">&amp;&amp;</span>&nbsp;<span class="op" id="3036013">!</span><span class="ident" id="3036014">w</span><span class="op" id="3036015">.</span><span class="ident" id="3036016">closeAfterReply</span>&nbsp;<span class="op" id="3036032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036036">ecr</span><span class="op" id="3036039">,</span>&nbsp;<span class="ident" id="3036041">isExpecter</span>&nbsp;<span class="op" id="3036052">:=</span>&nbsp;<span class="ident" id="3036055">w</span><span class="op" id="3036056">.</span><span class="ident" id="3036057">req</span><span class="op" id="3036060">.</span><span class="ident" id="3036061">Body</span><span class="op" id="3036065">.</span><span class="op" id="3036066">(</span><span class="op" id="3036067">*</span><span class="ident" id="3036068">expectContinueReader</span><span class="op" id="3036088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036092">if</span>&nbsp;<span class="op" id="3036095">!</span><span class="ident" id="3036096">isExpecter</span>&nbsp;<span class="op" id="3036107">||</span>&nbsp;<span class="ident" id="3036110">ecr</span><span class="op" id="3036113">.</span><span class="ident" id="3036114">resp</span><span class="op" id="3036118">.</span><span class="ident" id="3036119">wroteContinue</span>&nbsp;<span class="op" id="3036133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036138">n</span><span class="op" id="3036139">,</span>&nbsp;<span class="ident" id="3036141">_</span>&nbsp;<span class="op" id="3036143">:=</span>&nbsp;<span class="ident" id="3036146">io</span><span class="op" id="3036148">.</span><span class="ident" id="3036149">CopyN</span><span class="op" id="3036154">(</span><span class="ident" id="3036155">ioutil</span><span class="op" id="3036161">.</span><span class="ident" id="3036162">Discard</span><span class="op" id="3036169">,</span>&nbsp;<span class="ident" id="3036171">w</span><span class="op" id="3036172">.</span><span class="ident" id="3036173">req</span><span class="op" id="3036176">.</span><span class="ident" id="3036177">Body</span><span class="op" id="3036181">,</span>&nbsp;<span class="ident" id="3036183">maxPostHandlerReadBytes</span><span class="op" id="3036206">+</span><span class="num" id="3036207">1</span><span class="op" id="3036208">)</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036213">if</span>&nbsp;<span class="ident" id="3036216">n</span>&nbsp;<span class="op" id="3036218">&gt;=</span>&nbsp;<span class="ident" id="3036221">maxPostHandlerReadBytes</span>&nbsp;<span class="op" id="3036245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036251">w</span><span class="op" id="3036252">.</span><span class="ident" id="3036253">requestTooLarge</span><span class="op" id="3036268">(</span><span class="op" id="3036269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036275">delHeader</span><span class="op" id="3036284">(</span><span class="string" id="3036285">&#34;Connection&#34;</span><span class="op" id="3036297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036303">setHeader</span><span class="op" id="3036312">.</span><span class="ident" id="3036313">connection</span>&nbsp;<span class="op" id="3036324">=</span>&nbsp;<span class="string" id="3036326">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036337">}</span>&nbsp;<span class="keyword" id="3036339">else</span>&nbsp;<span class="op" id="3036344">{</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036350">w</span><span class="op" id="3036351">.</span><span class="ident" id="3036352">req</span><span class="op" id="3036355">.</span><span class="ident" id="3036356">Body</span><span class="op" id="3036360">.</span><span class="ident" id="3036361">Close</span><span class="op" id="3036366">(</span><span class="op" id="3036367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036379">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036383">code</span>&nbsp;<span class="op" id="3036388">:=</span>&nbsp;<span class="ident" id="3036391">w</span><span class="op" id="3036392">.</span><span class="ident" id="3036393">status</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036401">if</span>&nbsp;<span class="ident" id="3036404">bodyAllowedForStatus</span><span class="op" id="3036424">(</span><span class="ident" id="3036425">code</span><span class="op" id="3036429">)</span>&nbsp;<span class="op" id="3036431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3036435">//&nbsp;If&nbsp;no&nbsp;content&nbsp;type,&nbsp;apply&nbsp;sniffing&nbsp;algorithm&nbsp;to&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036494">_</span><span class="op" id="3036495">,</span>&nbsp;<span class="ident" id="3036497">haveType</span>&nbsp;<span class="op" id="3036506">:=</span>&nbsp;<span class="ident" id="3036509">header</span><span class="op" id="3036515">[</span><span class="string" id="3036516">&#34;Content-Type&#34;</span><span class="op" id="3036530">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036534">if</span>&nbsp;<span class="op" id="3036537">!</span><span class="ident" id="3036538">haveType</span>&nbsp;<span class="op" id="3036547">{</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036552">setHeader</span><span class="op" id="3036561">.</span><span class="ident" id="3036562">contentType</span>&nbsp;<span class="op" id="3036574">=</span>&nbsp;<span class="ident" id="3036576">DetectContentType</span><span class="op" id="3036593">(</span><span class="ident" id="3036594">p</span><span class="op" id="3036595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036602">}</span>&nbsp;<span class="keyword" id="3036604">else</span>&nbsp;<span class="op" id="3036609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036613">for</span>&nbsp;<span class="ident" id="3036617">_</span><span class="op" id="3036618">,</span>&nbsp;<span class="ident" id="3036620">k</span>&nbsp;<span class="op" id="3036622">:=</span>&nbsp;<span class="keyword" id="3036625">range</span>&nbsp;<span class="ident" id="3036631">suppressedHeaders</span><span class="op" id="3036648">(</span><span class="ident" id="3036649">code</span><span class="op" id="3036653">)</span>&nbsp;<span class="op" id="3036655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036660">delHeader</span><span class="op" id="3036669">(</span><span class="ident" id="3036670">k</span><span class="op" id="3036671">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036682">if</span>&nbsp;<span class="ident" id="3036685">_</span><span class="op" id="3036686">,</span>&nbsp;<span class="ident" id="3036688">ok</span>&nbsp;<span class="op" id="3036691">:=</span>&nbsp;<span class="ident" id="3036694">header</span><span class="op" id="3036700">[</span><span class="string" id="3036701">&#34;Date&#34;</span><span class="op" id="3036707">]</span><span class="op" id="3036708">;</span>&nbsp;<span class="op" id="3036710">!</span><span class="ident" id="3036711">ok</span>&nbsp;<span class="op" id="3036714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036718">setHeader</span><span class="op" id="3036727">.</span><span class="ident" id="3036728">date</span>&nbsp;<span class="op" id="3036733">=</span>&nbsp;<span class="ident" id="3036735">appendTime</span><span class="op" id="3036745">(</span><span class="ident" id="3036746">cw</span><span class="op" id="3036748">.</span><span class="ident" id="3036749">res</span><span class="op" id="3036752">.</span><span class="ident" id="3036753">dateBuf</span><span class="op" id="3036760">[</span><span class="op" id="3036761">:</span><span class="num" id="3036762">0</span><span class="op" id="3036763">]</span><span class="op" id="3036764">,</span>&nbsp;<span class="ident" id="3036766">time</span><span class="op" id="3036770">.</span><span class="ident" id="3036771">Now</span><span class="op" id="3036774">(</span><span class="op" id="3036775">)</span><span class="op" id="3036776">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3036779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036783">te</span>&nbsp;<span class="op" id="3036786">:=</span>&nbsp;<span class="ident" id="3036789">header</span><span class="op" id="3036795">.</span><span class="ident" id="3036796">get</span><span class="op" id="3036799">(</span><span class="string" id="3036800">&#34;Transfer-Encoding&#34;</span><span class="op" id="3036819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036822">hasTE</span>&nbsp;<span class="op" id="3036828">:=</span>&nbsp;<span class="ident" id="3036831">te</span>&nbsp;<span class="op" id="3036834">!=</span>&nbsp;<span class="string" id="3036837">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3036841">if</span>&nbsp;<span class="ident" id="3036844">hasCL</span>&nbsp;<span class="op" id="3036850">&amp;&amp;</span>&nbsp;<span class="ident" id="3036853">hasTE</span>&nbsp;<span class="op" id="3036859">&amp;&amp;</span>&nbsp;<span class="ident" id="3036862">te</span>&nbsp;<span class="op" id="3036865">!=</span>&nbsp;<span class="string" id="3036868">&#34;identity&#34;</span>&nbsp;<span class="op" id="3036879">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3036883">//&nbsp;TODO:&nbsp;return&nbsp;an&nbsp;error&nbsp;if&nbsp;WriteHeader&nbsp;gets&nbsp;a&nbsp;return&nbsp;parameter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3036949">//&nbsp;For&nbsp;now&nbsp;just&nbsp;ignore&nbsp;the&nbsp;Content-Length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3036994">w</span><span class="op" id="3036995">.</span><span class="ident" id="3036996">conn</span><span class="op" id="3037000">.</span><span class="ident" id="3037001">server</span><span class="op" id="3037007">.</span><span class="ident" id="3037008">logf</span><span class="op" id="3037012">(</span><span class="string" id="3037013">&#34;http:&nbsp;WriteHeader&nbsp;called&nbsp;with&nbsp;both&nbsp;Transfer-Encoding&nbsp;of&nbsp;%q&nbsp;and&nbsp;a&nbsp;Content-Length&nbsp;of&nbsp;%d&#34;</span><span class="op" id="3037100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037105">te</span><span class="op" id="3037107">,</span>&nbsp;<span class="ident" id="3037109">w</span><span class="op" id="3037110">.</span><span class="ident" id="3037111">contentLength</span><span class="op" id="3037124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037128">delHeader</span><span class="op" id="3037137">(</span><span class="string" id="3037138">&#34;Content-Length&#34;</span><span class="op" id="3037154">)</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037158">hasCL</span>&nbsp;<span class="op" id="3037164">=</span>&nbsp;<span class="builtintype" id="3037166">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3037177">if</span>&nbsp;<span class="ident" id="3037180">w</span><span class="op" id="3037181">.</span><span class="ident" id="3037182">req</span><span class="op" id="3037185">.</span><span class="ident" id="3037186">Method</span>&nbsp;<span class="op" id="3037193">==</span>&nbsp;<span class="string" id="3037196">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3037203">||</span>&nbsp;<span class="op" id="3037206">!</span><span class="ident" id="3037207">bodyAllowedForStatus</span><span class="op" id="3037227">(</span><span class="ident" id="3037228">code</span><span class="op" id="3037232">)</span>&nbsp;<span class="op" id="3037234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037238">//&nbsp;do&nbsp;nothing</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037253">}</span>&nbsp;<span class="keyword" id="3037255">else</span>&nbsp;<span class="keyword" id="3037260">if</span>&nbsp;<span class="ident" id="3037263">code</span>&nbsp;<span class="op" id="3037268">==</span>&nbsp;<span class="ident" id="3037271">StatusNoContent</span>&nbsp;<span class="op" id="3037287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037291">delHeader</span><span class="op" id="3037300">(</span><span class="string" id="3037301">&#34;Transfer-Encoding&#34;</span><span class="op" id="3037320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037323">}</span>&nbsp;<span class="keyword" id="3037325">else</span>&nbsp;<span class="keyword" id="3037330">if</span>&nbsp;<span class="ident" id="3037333">hasCL</span>&nbsp;<span class="op" id="3037339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037343">delHeader</span><span class="op" id="3037352">(</span><span class="string" id="3037353">&#34;Transfer-Encoding&#34;</span><span class="op" id="3037372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037375">}</span>&nbsp;<span class="keyword" id="3037377">else</span>&nbsp;<span class="keyword" id="3037382">if</span>&nbsp;<span class="ident" id="3037385">w</span><span class="op" id="3037386">.</span><span class="ident" id="3037387">req</span><span class="op" id="3037390">.</span><span class="ident" id="3037391">ProtoAtLeast</span><span class="op" id="3037403">(</span><span class="num" id="3037404">1</span><span class="op" id="3037405">,</span>&nbsp;<span class="num" id="3037407">1</span><span class="op" id="3037408">)</span>&nbsp;<span class="op" id="3037410">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037414">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;Transfer-Encoding&nbsp;has&nbsp;been&nbsp;set&nbsp;to&nbsp;identity,&nbsp;&nbsp;and&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037492">//&nbsp;content-length&nbsp;has&nbsp;been&nbsp;provided.&nbsp;The&nbsp;connection&nbsp;must&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037571">//&nbsp;reply&nbsp;is&nbsp;written,&nbsp;and&nbsp;no&nbsp;chunking&nbsp;is&nbsp;to&nbsp;be&nbsp;done.&nbsp;This&nbsp;is&nbsp;the&nbsp;setup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037643">//&nbsp;recommended&nbsp;in&nbsp;the&nbsp;Server-Sent&nbsp;Events&nbsp;candidate&nbsp;recommendation&nbsp;11,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037715">//&nbsp;section&nbsp;8.</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3037731">if</span>&nbsp;<span class="ident" id="3037734">hasTE</span>&nbsp;<span class="op" id="3037740">&amp;&amp;</span>&nbsp;<span class="ident" id="3037743">te</span>&nbsp;<span class="op" id="3037746">==</span>&nbsp;<span class="string" id="3037749">&#34;identity&#34;</span>&nbsp;<span class="op" id="3037760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037765">cw</span><span class="op" id="3037767">.</span><span class="ident" id="3037768">chunking</span>&nbsp;<span class="op" id="3037777">=</span>&nbsp;<span class="builtintype" id="3037779">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037788">w</span><span class="op" id="3037789">.</span><span class="ident" id="3037790">closeAfterReply</span>&nbsp;<span class="op" id="3037806">=</span>&nbsp;<span class="builtintype" id="3037808">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037815">}</span>&nbsp;<span class="keyword" id="3037817">else</span>&nbsp;<span class="op" id="3037822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037827">//&nbsp;HTTP/1.1&nbsp;or&nbsp;greater:&nbsp;use&nbsp;chunked&nbsp;transfer&nbsp;encoding</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3037884">//&nbsp;to&nbsp;avoid&nbsp;closing&nbsp;the&nbsp;connection&nbsp;at&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037930">cw</span><span class="op" id="3037932">.</span><span class="ident" id="3037933">chunking</span>&nbsp;<span class="op" id="3037942">=</span>&nbsp;<span class="builtintype" id="3037944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3037952">setHeader</span><span class="op" id="3037961">.</span><span class="ident" id="3037962">transferEncoding</span>&nbsp;<span class="op" id="3037979">=</span>&nbsp;<span class="string" id="3037981">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3037996">}</span>&nbsp;<span class="keyword" id="3037998">else</span>&nbsp;<span class="op" id="3038003">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3038007">//&nbsp;HTTP&nbsp;version&nbsp;&lt;&nbsp;1.1:&nbsp;cannot&nbsp;do&nbsp;chunked&nbsp;transfer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3038059">//&nbsp;encoding&nbsp;and&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;the&nbsp;Content-Length&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3038113">//&nbsp;signal&nbsp;EOF&nbsp;by&nbsp;closing&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038152">w</span><span class="op" id="3038153">.</span><span class="ident" id="3038154">closeAfterReply</span>&nbsp;<span class="op" id="3038170">=</span>&nbsp;<span class="builtintype" id="3038172">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038179">delHeader</span><span class="op" id="3038188">(</span><span class="string" id="3038189">&#34;Transfer-Encoding&#34;</span><span class="op" id="3038208">)</span>&nbsp;<span class="comment" id="3038210">//&nbsp;in&nbsp;case&nbsp;already&nbsp;set</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3038234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3038238">//&nbsp;Cannot&nbsp;use&nbsp;Content-Length&nbsp;with&nbsp;non-identity&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3038305">if</span>&nbsp;<span class="ident" id="3038308">cw</span><span class="op" id="3038310">.</span><span class="ident" id="3038311">chunking</span>&nbsp;<span class="op" id="3038320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038324">delHeader</span><span class="op" id="3038333">(</span><span class="string" id="3038334">&#34;Content-Length&#34;</span><span class="op" id="3038350">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3038353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3038356">if</span>&nbsp;<span class="op" id="3038359">!</span><span class="ident" id="3038360">w</span><span class="op" id="3038361">.</span><span class="ident" id="3038362">req</span><span class="op" id="3038365">.</span><span class="ident" id="3038366">ProtoAtLeast</span><span class="op" id="3038378">(</span><span class="num" id="3038379">1</span><span class="op" id="3038380">,</span>&nbsp;<span class="num" id="3038382">0</span><span class="op" id="3038383">)</span>&nbsp;<span class="op" id="3038385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3038389">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3038397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3038401">if</span>&nbsp;<span class="ident" id="3038404">w</span><span class="op" id="3038405">.</span><span class="ident" id="3038406">closeAfterReply</span>&nbsp;<span class="op" id="3038422">&amp;&amp;</span>&nbsp;<span class="op" id="3038425">(</span><span class="op" id="3038426">!</span><span class="ident" id="3038427">keepAlivesEnabled</span>&nbsp;<span class="op" id="3038445">||</span>&nbsp;<span class="op" id="3038448">!</span><span class="ident" id="3038449">hasToken</span><span class="op" id="3038457">(</span><span class="ident" id="3038458">cw</span><span class="op" id="3038460">.</span><span class="ident" id="3038461">header</span><span class="op" id="3038467">.</span><span class="ident" id="3038468">get</span><span class="op" id="3038471">(</span><span class="string" id="3038472">&#34;Connection&#34;</span><span class="op" id="3038484">)</span><span class="op" id="3038485">,</span>&nbsp;<span class="string" id="3038487">&#34;close&#34;</span><span class="op" id="3038494">)</span><span class="op" id="3038495">)</span>&nbsp;<span class="op" id="3038497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038501">delHeader</span><span class="op" id="3038510">(</span><span class="string" id="3038511">&#34;Connection&#34;</span><span class="op" id="3038523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3038527">if</span>&nbsp;<span class="ident" id="3038530">w</span><span class="op" id="3038531">.</span><span class="ident" id="3038532">req</span><span class="op" id="3038535">.</span><span class="ident" id="3038536">ProtoAtLeast</span><span class="op" id="3038548">(</span><span class="num" id="3038549">1</span><span class="op" id="3038550">,</span>&nbsp;<span class="num" id="3038552">1</span><span class="op" id="3038553">)</span>&nbsp;<span class="op" id="3038555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038560">setHeader</span><span class="op" id="3038569">.</span><span class="ident" id="3038570">connection</span>&nbsp;<span class="op" id="3038581">=</span>&nbsp;<span class="string" id="3038583">&#34;close&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3038593">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3038596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038600">w</span><span class="op" id="3038601">.</span><span class="ident" id="3038602">conn</span><span class="op" id="3038606">.</span><span class="ident" id="3038607">buf</span><span class="op" id="3038610">.</span><span class="ident" id="3038611">WriteString</span><span class="op" id="3038622">(</span><span class="ident" id="3038623">statusLine</span><span class="op" id="3038633">(</span><span class="ident" id="3038634">w</span><span class="op" id="3038635">.</span><span class="ident" id="3038636">req</span><span class="op" id="3038639">,</span>&nbsp;<span class="ident" id="3038641">code</span><span class="op" id="3038645">)</span><span class="op" id="3038646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038649">cw</span><span class="op" id="3038651">.</span><span class="ident" id="3038652">header</span><span class="op" id="3038658">.</span><span class="ident" id="3038659">WriteSubset</span><span class="op" id="3038670">(</span><span class="ident" id="3038671">w</span><span class="op" id="3038672">.</span><span class="ident" id="3038673">conn</span><span class="op" id="3038677">.</span><span class="ident" id="3038678">buf</span><span class="op" id="3038681">,</span>&nbsp;<span class="ident" id="3038683">excludeHeader</span><span class="op" id="3038696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038699">setHeader</span><span class="op" id="3038708">.</span><span class="ident" id="3038709">Write</span><span class="op" id="3038714">(</span><span class="ident" id="3038715">w</span><span class="op" id="3038716">.</span><span class="ident" id="3038717">conn</span><span class="op" id="3038721">.</span><span class="ident" id="3038722">buf</span><span class="op" id="3038725">.</span><span class="ident" id="3038726">Writer</span><span class="op" id="3038732">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3038735">w</span><span class="op" id="3038736">.</span><span class="ident" id="3038737">conn</span><span class="op" id="3038741">.</span><span class="ident" id="3038742">buf</span><span class="op" id="3038745">.</span><span class="ident" id="3038746">Write</span><span class="op" id="3038751">(</span><span class="ident" id="3038752">crlf</span><span class="op" id="3038756">)</span><br>
<span class="lineno"></span><span class="op" id="3038758">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3038761">//&nbsp;statusLines&nbsp;is&nbsp;a&nbsp;cache&nbsp;of&nbsp;Status-Line&nbsp;strings,&nbsp;keyed&nbsp;by&nbsp;code&nbsp;(for</span><br>
<span class="lineno"></span><span class="comment" id="3038830">//&nbsp;HTTP/1.1)&nbsp;or&nbsp;negative&nbsp;code&nbsp;(for&nbsp;HTTP/1.0).&nbsp;This&nbsp;is&nbsp;faster&nbsp;than&nbsp;a</span><br>
<span class="lineno">890</span><span class="comment" id="3038898">//&nbsp;map&nbsp;keyed&nbsp;by&nbsp;struct&nbsp;of&nbsp;two&nbsp;fields.&nbsp;This&nbsp;map&#39;s&nbsp;max&nbsp;size&nbsp;is&nbsp;bounded</span><br>
<span class="lineno"></span><span class="comment" id="3038967">//&nbsp;by&nbsp;2*len(statusText),&nbsp;two&nbsp;protocol&nbsp;types&nbsp;for&nbsp;each&nbsp;known&nbsp;official</span><br>
<span class="lineno"></span><span class="comment" id="3039035">//&nbsp;status&nbsp;code&nbsp;in&nbsp;the&nbsp;statusText&nbsp;map.</span><br>
<span class="lineno"></span><span class="keyword" id="3039073">var</span>&nbsp;<span class="op" id="3039077">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039080">statusMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039092">sync</span><span class="op" id="3039096">.</span><span class="ident" id="3039097">RWMutex</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039106">statusLines</span>&nbsp;<span class="op" id="3039118">=</span>&nbsp;<span class="builtinfunc" id="3039120">make</span><span class="op" id="3039124">(</span><span class="keyword" id="3039125">map</span><span class="op" id="3039128">[</span><span class="builtintype" id="3039129">int</span><span class="op" id="3039132">]</span><span class="builtintype" id="3039133">string</span><span class="op" id="3039139">)</span><br>
<span class="lineno"></span><span class="op" id="3039141">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3039144">//&nbsp;statusLine&nbsp;returns&nbsp;a&nbsp;response&nbsp;Status-Line&nbsp;(RFC&nbsp;2616&nbsp;Section&nbsp;6.1)</span><br>
<span class="lineno"></span><span class="comment" id="3039212">//&nbsp;for&nbsp;the&nbsp;given&nbsp;request&nbsp;and&nbsp;response&nbsp;status&nbsp;code.</span><br>
<span class="lineno">900</span><span class="keyword" id="3039263">func</span>&nbsp;<span class="ident" id="3039268">statusLine</span><span class="op" id="3039278">(</span><span class="ident" id="3039279">req</span>&nbsp;<span class="op" id="3039283">*</span><span class="ident" id="3039284">Request</span><span class="op" id="3039291">,</span>&nbsp;<span class="ident" id="3039293">code</span>&nbsp;<span class="builtintype" id="3039298">int</span><span class="op" id="3039301">)</span>&nbsp;<span class="builtintype" id="3039303">string</span>&nbsp;<span class="op" id="3039310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3039313">//&nbsp;Fast&nbsp;path:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039328">key</span>&nbsp;<span class="op" id="3039332">:=</span>&nbsp;<span class="ident" id="3039335">code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039341">proto11</span>&nbsp;<span class="op" id="3039349">:=</span>&nbsp;<span class="ident" id="3039352">req</span><span class="op" id="3039355">.</span><span class="ident" id="3039356">ProtoAtLeast</span><span class="op" id="3039368">(</span><span class="num" id="3039369">1</span><span class="op" id="3039370">,</span>&nbsp;<span class="num" id="3039372">1</span><span class="op" id="3039373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039376">if</span>&nbsp;<span class="op" id="3039379">!</span><span class="ident" id="3039380">proto11</span>&nbsp;<span class="op" id="3039388">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039392">key</span>&nbsp;<span class="op" id="3039396">=</span>&nbsp;<span class="op" id="3039398">-</span><span class="ident" id="3039399">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3039404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039407">statusMu</span><span class="op" id="3039415">.</span><span class="ident" id="3039416">RLock</span><span class="op" id="3039421">(</span><span class="op" id="3039422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039425">line</span><span class="op" id="3039429">,</span>&nbsp;<span class="ident" id="3039431">ok</span>&nbsp;<span class="op" id="3039434">:=</span>&nbsp;<span class="ident" id="3039437">statusLines</span><span class="op" id="3039448">[</span><span class="ident" id="3039449">key</span><span class="op" id="3039452">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039455">statusMu</span><span class="op" id="3039463">.</span><span class="ident" id="3039464">RUnlock</span><span class="op" id="3039471">(</span><span class="op" id="3039472">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039475">if</span>&nbsp;<span class="ident" id="3039478">ok</span>&nbsp;<span class="op" id="3039481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039485">return</span>&nbsp;<span class="ident" id="3039492">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3039498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3039502">//&nbsp;Slow&nbsp;path:</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039517">proto</span>&nbsp;<span class="op" id="3039523">:=</span>&nbsp;<span class="string" id="3039526">&#34;HTTP/1.0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039538">if</span>&nbsp;<span class="ident" id="3039541">proto11</span>&nbsp;<span class="op" id="3039549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039553">proto</span>&nbsp;<span class="op" id="3039559">=</span>&nbsp;<span class="string" id="3039561">&#34;HTTP/1.1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3039573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039576">codestring</span>&nbsp;<span class="op" id="3039587">:=</span>&nbsp;<span class="ident" id="3039590">strconv</span><span class="op" id="3039597">.</span><span class="ident" id="3039598">Itoa</span><span class="op" id="3039602">(</span><span class="ident" id="3039603">code</span><span class="op" id="3039607">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039610">text</span><span class="op" id="3039614">,</span>&nbsp;<span class="ident" id="3039616">ok</span>&nbsp;<span class="op" id="3039619">:=</span>&nbsp;<span class="ident" id="3039622">statusText</span><span class="op" id="3039632">[</span><span class="ident" id="3039633">code</span><span class="op" id="3039637">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039640">if</span>&nbsp;<span class="op" id="3039643">!</span><span class="ident" id="3039644">ok</span>&nbsp;<span class="op" id="3039647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039651">text</span>&nbsp;<span class="op" id="3039656">=</span>&nbsp;<span class="string" id="3039658">&#34;status&nbsp;code&nbsp;&#34;</span>&nbsp;<span class="op" id="3039673">+</span>&nbsp;<span class="ident" id="3039675">codestring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3039687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039690">line</span>&nbsp;<span class="op" id="3039695">=</span>&nbsp;<span class="ident" id="3039697">proto</span>&nbsp;<span class="op" id="3039703">+</span>&nbsp;<span class="string" id="3039705">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3039709">+</span>&nbsp;<span class="ident" id="3039711">codestring</span>&nbsp;<span class="op" id="3039722">+</span>&nbsp;<span class="string" id="3039724">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="3039728">+</span>&nbsp;<span class="ident" id="3039730">text</span>&nbsp;<span class="op" id="3039735">+</span>&nbsp;<span class="string" id="3039737">&#34;\r\n&#34;</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039745">if</span>&nbsp;<span class="ident" id="3039748">ok</span>&nbsp;<span class="op" id="3039751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039755">statusMu</span><span class="op" id="3039763">.</span><span class="ident" id="3039764">Lock</span><span class="op" id="3039768">(</span><span class="op" id="3039769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039773">defer</span>&nbsp;<span class="ident" id="3039779">statusMu</span><span class="op" id="3039787">.</span><span class="ident" id="3039788">Unlock</span><span class="op" id="3039794">(</span><span class="op" id="3039795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3039799">statusLines</span><span class="op" id="3039810">[</span><span class="ident" id="3039811">key</span><span class="op" id="3039814">]</span>&nbsp;<span class="op" id="3039816">=</span>&nbsp;<span class="ident" id="3039818">line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3039824">}</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3039827">return</span>&nbsp;<span class="ident" id="3039834">line</span><br>
<span class="lineno"></span><span class="op" id="3039839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3039842">//&nbsp;bodyAllowed&nbsp;returns&nbsp;true&nbsp;if&nbsp;a&nbsp;Write&nbsp;is&nbsp;allowed&nbsp;for&nbsp;this&nbsp;response&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3039916">//&nbsp;It&#39;s&nbsp;illegal&nbsp;to&nbsp;call&nbsp;this&nbsp;before&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;flushed.</span><br>
<span class="lineno">935</span><span class="keyword" id="3039981">func</span>&nbsp;<span class="op" id="3039986">(</span><span class="ident" id="3039987">w</span>&nbsp;<span class="op" id="3039989">*</span><span class="ident" id="3039990">response</span><span class="op" id="3039998">)</span>&nbsp;<span class="ident" id="3040000">bodyAllowed</span><span class="op" id="3040011">(</span><span class="op" id="3040012">)</span>&nbsp;<span class="builtintype" id="3040014">bool</span>&nbsp;<span class="op" id="3040019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3040022">if</span>&nbsp;<span class="op" id="3040025">!</span><span class="ident" id="3040026">w</span><span class="op" id="3040027">.</span><span class="ident" id="3040028">wroteHeader</span>&nbsp;<span class="op" id="3040040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3040044">panic</span><span class="op" id="3040049">(</span><span class="string" id="3040050">&#34;&#34;</span><span class="op" id="3040052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3040055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3040058">return</span>&nbsp;<span class="ident" id="3040065">bodyAllowedForStatus</span><span class="op" id="3040085">(</span><span class="ident" id="3040086">w</span><span class="op" id="3040087">.</span><span class="ident" id="3040088">status</span><span class="op" id="3040094">)</span><br>
<span class="lineno">940</span><span class="op" id="3040096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3040099">//&nbsp;The&nbsp;Life&nbsp;Of&nbsp;A&nbsp;Write&nbsp;is&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span><span class="comment" id="3040136">//</span><br>
<span class="lineno"></span><span class="comment" id="3040139">//&nbsp;Handler&nbsp;starts.&nbsp;No&nbsp;header&nbsp;has&nbsp;been&nbsp;sent.&nbsp;The&nbsp;handler&nbsp;can&nbsp;either</span><br>
<span class="lineno">945</span><span class="comment" id="3040206">//&nbsp;write&nbsp;a&nbsp;header,&nbsp;or&nbsp;just&nbsp;start&nbsp;writing.&nbsp;&nbsp;Writing&nbsp;before&nbsp;sending&nbsp;a&nbsp;header</span><br>
<span class="lineno"></span><span class="comment" id="3040281">//&nbsp;sends&nbsp;an&nbsp;implicitly&nbsp;empty&nbsp;200&nbsp;OK&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3040325">//</span><br>
<span class="lineno"></span><span class="comment" id="3040328">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;declare&nbsp;a&nbsp;Content-Length&nbsp;up&nbsp;front,&nbsp;we&nbsp;either</span><br>
<span class="lineno"></span><span class="comment" id="3040398">//&nbsp;go&nbsp;into&nbsp;chunking&nbsp;mode&nbsp;or,&nbsp;if&nbsp;the&nbsp;handler&nbsp;finishes&nbsp;running&nbsp;before</span><br>
<span class="lineno">950</span><span class="comment" id="3040466">//&nbsp;the&nbsp;chunking&nbsp;buffer&nbsp;size,&nbsp;we&nbsp;compute&nbsp;a&nbsp;Content-Length&nbsp;and&nbsp;send&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3040537">//&nbsp;in&nbsp;the&nbsp;header&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="3040563">//</span><br>
<span class="lineno"></span><span class="comment" id="3040566">//&nbsp;Likewise,&nbsp;if&nbsp;the&nbsp;handler&nbsp;didn&#39;t&nbsp;set&nbsp;a&nbsp;Content-Type,&nbsp;we&nbsp;sniff&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3040635">//&nbsp;from&nbsp;the&nbsp;initial&nbsp;chunk&nbsp;of&nbsp;output.</span><br>
<span class="lineno">955</span><span class="comment" id="3040672">//</span><br>
<span class="lineno"></span><span class="comment" id="3040675">//&nbsp;The&nbsp;Writers&nbsp;are&nbsp;wired&nbsp;together&nbsp;like:</span><br>
<span class="lineno"></span><span class="comment" id="3040715">//</span><br>
<span class="lineno"></span><span class="comment" id="3040718">//&nbsp;1.&nbsp;*response&nbsp;(the&nbsp;ResponseWriter)&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3040758">//&nbsp;2.&nbsp;(*response).w,&nbsp;a&nbsp;*bufio.Writer&nbsp;of&nbsp;bufferBeforeChunkingSize&nbsp;bytes</span><br>
<span class="lineno">960</span><span class="comment" id="3040829">//&nbsp;3.&nbsp;chunkWriter.Writer&nbsp;(whose&nbsp;writeHeader&nbsp;finalizes&nbsp;Content-Length/Type)</span><br>
<span class="lineno"></span><span class="comment" id="3040904">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;which&nbsp;writes&nbsp;the&nbsp;chunk&nbsp;headers,&nbsp;if&nbsp;needed.</span><br>
<span class="lineno"></span><span class="comment" id="3040957">//&nbsp;4.&nbsp;conn.buf,&nbsp;a&nbsp;bufio.Writer&nbsp;of&nbsp;default&nbsp;(4kB)&nbsp;bytes,&nbsp;writing&nbsp;to&nbsp;-&gt;</span><br>
<span class="lineno"></span><span class="comment" id="3041026">//&nbsp;5.&nbsp;checkConnErrorWriter{c},&nbsp;which&nbsp;notes&nbsp;any&nbsp;non-nil&nbsp;error&nbsp;on&nbsp;Write</span><br>
<span class="lineno"></span><span class="comment" id="3041096">//&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;populates&nbsp;c.werr&nbsp;with&nbsp;it&nbsp;if&nbsp;so.&nbsp;but&nbsp;otherwise&nbsp;writes&nbsp;to:</span><br>
<span class="lineno">965</span><span class="comment" id="3041163">//&nbsp;6.&nbsp;the&nbsp;rwc,&nbsp;the&nbsp;net.Conn.</span><br>
<span class="lineno"></span><span class="comment" id="3041192">//</span><br>
<span class="lineno"></span><span class="comment" id="3041195">//&nbsp;TODO(bradfitz):&nbsp;short-circuit&nbsp;some&nbsp;of&nbsp;the&nbsp;buffering&nbsp;when&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3041259">//&nbsp;initial&nbsp;header&nbsp;contains&nbsp;both&nbsp;a&nbsp;Content-Type&nbsp;and&nbsp;Content-Length.</span><br>
<span class="lineno"></span><span class="comment" id="3041326">//&nbsp;Also&nbsp;short-circuit&nbsp;in&nbsp;(1)&nbsp;when&nbsp;the&nbsp;header&#39;s&nbsp;been&nbsp;sent&nbsp;and&nbsp;not&nbsp;in</span><br>
<span class="lineno">970</span><span class="comment" id="3041394">//&nbsp;chunking&nbsp;mode,&nbsp;writing&nbsp;directly&nbsp;to&nbsp;(4)&nbsp;instead,&nbsp;if&nbsp;(2)&nbsp;has&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="3041459">//&nbsp;buffered&nbsp;data.&nbsp;&nbsp;More&nbsp;generally,&nbsp;we&nbsp;could&nbsp;short-circuit&nbsp;from&nbsp;(1)&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3041529">//&nbsp;(3)&nbsp;even&nbsp;in&nbsp;chunking&nbsp;mode&nbsp;if&nbsp;the&nbsp;write&nbsp;size&nbsp;from&nbsp;(1)&nbsp;is&nbsp;over&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3041598">//&nbsp;threshold&nbsp;and&nbsp;nothing&nbsp;is&nbsp;in&nbsp;(2).&nbsp;&nbsp;The&nbsp;answer&nbsp;might&nbsp;be&nbsp;mostly&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3041669">//&nbsp;bufferBeforeChunkingSize&nbsp;smaller&nbsp;and&nbsp;having&nbsp;bufio&#39;s&nbsp;fast-paths&nbsp;deal</span><br>
<span class="lineno">975</span><span class="comment" id="3041740">//&nbsp;with&nbsp;this&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="3041762">func</span>&nbsp;<span class="op" id="3041767">(</span><span class="ident" id="3041768">w</span>&nbsp;<span class="op" id="3041770">*</span><span class="ident" id="3041771">response</span><span class="op" id="3041779">)</span>&nbsp;<span class="ident" id="3041781">Write</span><span class="op" id="3041786">(</span><span class="ident" id="3041787">data</span>&nbsp;<span class="op" id="3041792">[</span><span class="op" id="3041793">]</span><span class="builtintype" id="3041794">byte</span><span class="op" id="3041798">)</span>&nbsp;<span class="op" id="3041800">(</span><span class="ident" id="3041801">n</span>&nbsp;<span class="builtintype" id="3041803">int</span><span class="op" id="3041806">,</span>&nbsp;<span class="ident" id="3041808">err</span>&nbsp;<span class="builtintype" id="3041812">error</span><span class="op" id="3041817">)</span>&nbsp;<span class="op" id="3041819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3041822">return</span>&nbsp;<span class="ident" id="3041829">w</span><span class="op" id="3041830">.</span><span class="ident" id="3041831">write</span><span class="op" id="3041836">(</span><span class="builtinfunc" id="3041837">len</span><span class="op" id="3041840">(</span><span class="ident" id="3041841">data</span><span class="op" id="3041845">)</span><span class="op" id="3041846">,</span>&nbsp;<span class="ident" id="3041848">data</span><span class="op" id="3041852">,</span>&nbsp;<span class="string" id="3041854">&#34;&#34;</span><span class="op" id="3041856">)</span><br>
<span class="lineno"></span><span class="op" id="3041858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3041861">func</span>&nbsp;<span class="op" id="3041866">(</span><span class="ident" id="3041867">w</span>&nbsp;<span class="op" id="3041869">*</span><span class="ident" id="3041870">response</span><span class="op" id="3041878">)</span>&nbsp;<span class="ident" id="3041880">WriteString</span><span class="op" id="3041891">(</span><span class="ident" id="3041892">data</span>&nbsp;<span class="builtintype" id="3041897">string</span><span class="op" id="3041903">)</span>&nbsp;<span class="op" id="3041905">(</span><span class="ident" id="3041906">n</span>&nbsp;<span class="builtintype" id="3041908">int</span><span class="op" id="3041911">,</span>&nbsp;<span class="ident" id="3041913">err</span>&nbsp;<span class="builtintype" id="3041917">error</span><span class="op" id="3041922">)</span>&nbsp;<span class="op" id="3041924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3041927">return</span>&nbsp;<span class="ident" id="3041934">w</span><span class="op" id="3041935">.</span><span class="ident" id="3041936">write</span><span class="op" id="3041941">(</span><span class="builtinfunc" id="3041942">len</span><span class="op" id="3041945">(</span><span class="ident" id="3041946">data</span><span class="op" id="3041950">)</span><span class="op" id="3041951">,</span>&nbsp;<span class="builtintype" id="3041953">nil</span><span class="op" id="3041956">,</span>&nbsp;<span class="ident" id="3041958">data</span><span class="op" id="3041962">)</span><br>
<span class="lineno"></span><span class="op" id="3041964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3041967">//&nbsp;either&nbsp;dataB&nbsp;or&nbsp;dataS&nbsp;is&nbsp;non-zero.</span><br>
<span class="lineno">985</span><span class="keyword" id="3042005">func</span>&nbsp;<span class="op" id="3042010">(</span><span class="ident" id="3042011">w</span>&nbsp;<span class="op" id="3042013">*</span><span class="ident" id="3042014">response</span><span class="op" id="3042022">)</span>&nbsp;<span class="ident" id="3042024">write</span><span class="op" id="3042029">(</span><span class="ident" id="3042030">lenData</span>&nbsp;<span class="builtintype" id="3042038">int</span><span class="op" id="3042041">,</span>&nbsp;<span class="ident" id="3042043">dataB</span>&nbsp;<span class="op" id="3042049">[</span><span class="op" id="3042050">]</span><span class="builtintype" id="3042051">byte</span><span class="op" id="3042055">,</span>&nbsp;<span class="ident" id="3042057">dataS</span>&nbsp;<span class="builtintype" id="3042063">string</span><span class="op" id="3042069">)</span>&nbsp;<span class="op" id="3042071">(</span><span class="ident" id="3042072">n</span>&nbsp;<span class="builtintype" id="3042074">int</span><span class="op" id="3042077">,</span>&nbsp;<span class="ident" id="3042079">err</span>&nbsp;<span class="builtintype" id="3042083">error</span><span class="op" id="3042088">)</span>&nbsp;<span class="op" id="3042090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042093">if</span>&nbsp;<span class="ident" id="3042096">w</span><span class="op" id="3042097">.</span><span class="ident" id="3042098">conn</span><span class="op" id="3042102">.</span><span class="ident" id="3042103">hijacked</span><span class="op" id="3042111">(</span><span class="op" id="3042112">)</span>&nbsp;<span class="op" id="3042114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042118">w</span><span class="op" id="3042119">.</span><span class="ident" id="3042120">conn</span><span class="op" id="3042124">.</span><span class="ident" id="3042125">server</span><span class="op" id="3042131">.</span><span class="ident" id="3042132">logf</span><span class="op" id="3042136">(</span><span class="string" id="3042137">&#34;http:&nbsp;response.Write&nbsp;on&nbsp;hijacked&nbsp;connection&#34;</span><span class="op" id="3042182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042186">return</span>&nbsp;<span class="num" id="3042193">0</span><span class="op" id="3042194">,</span>&nbsp;<span class="ident" id="3042196">ErrHijacked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042209">}</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042212">if</span>&nbsp;<span class="op" id="3042215">!</span><span class="ident" id="3042216">w</span><span class="op" id="3042217">.</span><span class="ident" id="3042218">wroteHeader</span>&nbsp;<span class="op" id="3042230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042234">w</span><span class="op" id="3042235">.</span><span class="ident" id="3042236">WriteHeader</span><span class="op" id="3042247">(</span><span class="ident" id="3042248">StatusOK</span><span class="op" id="3042256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042262">if</span>&nbsp;<span class="ident" id="3042265">lenData</span>&nbsp;<span class="op" id="3042273">==</span>&nbsp;<span class="num" id="3042276">0</span>&nbsp;<span class="op" id="3042278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042282">return</span>&nbsp;<span class="num" id="3042289">0</span><span class="op" id="3042290">,</span>&nbsp;<span class="builtintype" id="3042292">nil</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042300">if</span>&nbsp;<span class="op" id="3042303">!</span><span class="ident" id="3042304">w</span><span class="op" id="3042305">.</span><span class="ident" id="3042306">bodyAllowed</span><span class="op" id="3042317">(</span><span class="op" id="3042318">)</span>&nbsp;<span class="op" id="3042320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042324">return</span>&nbsp;<span class="num" id="3042331">0</span><span class="op" id="3042332">,</span>&nbsp;<span class="ident" id="3042334">ErrBodyNotAllowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042357">w</span><span class="op" id="3042358">.</span><span class="ident" id="3042359">written</span>&nbsp;<span class="op" id="3042367">+=</span>&nbsp;<span class="ident" id="3042370">int64</span><span class="op" id="3042375">(</span><span class="ident" id="3042376">lenData</span><span class="op" id="3042383">)</span>&nbsp;<span class="comment" id="3042385">//&nbsp;ignoring&nbsp;errors,&nbsp;for&nbsp;errorKludge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042422">if</span>&nbsp;<span class="ident" id="3042425">w</span><span class="op" id="3042426">.</span><span class="ident" id="3042427">contentLength</span>&nbsp;<span class="op" id="3042441">!=</span>&nbsp;<span class="op" id="3042444">-</span><span class="num" id="3042445">1</span>&nbsp;<span class="op" id="3042447">&amp;&amp;</span>&nbsp;<span class="ident" id="3042450">w</span><span class="op" id="3042451">.</span><span class="ident" id="3042452">written</span>&nbsp;<span class="op" id="3042460">&gt;</span>&nbsp;<span class="ident" id="3042462">w</span><span class="op" id="3042463">.</span><span class="ident" id="3042464">contentLength</span>&nbsp;<span class="op" id="3042478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042482">return</span>&nbsp;<span class="num" id="3042489">0</span><span class="op" id="3042490">,</span>&nbsp;<span class="ident" id="3042492">ErrContentLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042513">if</span>&nbsp;<span class="ident" id="3042516">dataB</span>&nbsp;<span class="op" id="3042522">!=</span>&nbsp;<span class="builtintype" id="3042525">nil</span>&nbsp;<span class="op" id="3042529">{</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042533">return</span>&nbsp;<span class="ident" id="3042540">w</span><span class="op" id="3042541">.</span><span class="ident" id="3042542">w</span><span class="op" id="3042543">.</span><span class="ident" id="3042544">Write</span><span class="op" id="3042549">(</span><span class="ident" id="3042550">dataB</span><span class="op" id="3042555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042558">}</span>&nbsp;<span class="keyword" id="3042560">else</span>&nbsp;<span class="op" id="3042565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042569">return</span>&nbsp;<span class="ident" id="3042576">w</span><span class="op" id="3042577">.</span><span class="ident" id="3042578">w</span><span class="op" id="3042579">.</span><span class="ident" id="3042580">WriteString</span><span class="op" id="3042591">(</span><span class="ident" id="3042592">dataS</span><span class="op" id="3042597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042600">}</span><br>
<span class="lineno"></span><span class="op" id="3042602">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span><span class="keyword" id="3042605">func</span>&nbsp;<span class="op" id="3042610">(</span><span class="ident" id="3042611">w</span>&nbsp;<span class="op" id="3042613">*</span><span class="ident" id="3042614">response</span><span class="op" id="3042622">)</span>&nbsp;<span class="ident" id="3042624">finishRequest</span><span class="op" id="3042637">(</span><span class="op" id="3042638">)</span>&nbsp;<span class="op" id="3042640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042643">w</span><span class="op" id="3042644">.</span><span class="ident" id="3042645">handlerDone</span>&nbsp;<span class="op" id="3042657">=</span>&nbsp;<span class="builtintype" id="3042659">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042666">if</span>&nbsp;<span class="op" id="3042669">!</span><span class="ident" id="3042670">w</span><span class="op" id="3042671">.</span><span class="ident" id="3042672">wroteHeader</span>&nbsp;<span class="op" id="3042684">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042688">w</span><span class="op" id="3042689">.</span><span class="ident" id="3042690">WriteHeader</span><span class="op" id="3042701">(</span><span class="ident" id="3042702">StatusOK</span><span class="op" id="3042710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042717">w</span><span class="op" id="3042718">.</span><span class="ident" id="3042719">w</span><span class="op" id="3042720">.</span><span class="ident" id="3042721">Flush</span><span class="op" id="3042726">(</span><span class="op" id="3042727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042730">putBufioWriter</span><span class="op" id="3042744">(</span><span class="ident" id="3042745">w</span><span class="op" id="3042746">.</span><span class="ident" id="3042747">w</span><span class="op" id="3042748">)</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042751">w</span><span class="op" id="3042752">.</span><span class="ident" id="3042753">cw</span><span class="op" id="3042755">.</span><span class="builtinfunc" id="3042756">close</span><span class="op" id="3042761">(</span><span class="op" id="3042762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042765">w</span><span class="op" id="3042766">.</span><span class="ident" id="3042767">conn</span><span class="op" id="3042771">.</span><span class="ident" id="3042772">buf</span><span class="op" id="3042775">.</span><span class="ident" id="3042776">Flush</span><span class="op" id="3042781">(</span><span class="op" id="3042782">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3042786">//&nbsp;Close&nbsp;the&nbsp;body&nbsp;(regardless&nbsp;of&nbsp;w.closeAfterReply)&nbsp;so&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3042849">//&nbsp;re-use&nbsp;its&nbsp;bufio.Reader&nbsp;later&nbsp;safely.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042891">w</span><span class="op" id="3042892">.</span><span class="ident" id="3042893">req</span><span class="op" id="3042896">.</span><span class="ident" id="3042897">Body</span><span class="op" id="3042901">.</span><span class="ident" id="3042902">Close</span><span class="op" id="3042907">(</span><span class="op" id="3042908">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042912">if</span>&nbsp;<span class="ident" id="3042915">w</span><span class="op" id="3042916">.</span><span class="ident" id="3042917">req</span><span class="op" id="3042920">.</span><span class="ident" id="3042921">MultipartForm</span>&nbsp;<span class="op" id="3042935">!=</span>&nbsp;<span class="builtintype" id="3042938">nil</span>&nbsp;<span class="op" id="3042942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3042946">w</span><span class="op" id="3042947">.</span><span class="ident" id="3042948">req</span><span class="op" id="3042951">.</span><span class="ident" id="3042952">MultipartForm</span><span class="op" id="3042965">.</span><span class="ident" id="3042966">RemoveAll</span><span class="op" id="3042975">(</span><span class="op" id="3042976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3042979">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3042983">if</span>&nbsp;<span class="ident" id="3042986">w</span><span class="op" id="3042987">.</span><span class="ident" id="3042988">req</span><span class="op" id="3042991">.</span><span class="ident" id="3042992">Method</span>&nbsp;<span class="op" id="3042999">!=</span>&nbsp;<span class="string" id="3043002">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3043009">&amp;&amp;</span>&nbsp;<span class="ident" id="3043012">w</span><span class="op" id="3043013">.</span><span class="ident" id="3043014">contentLength</span>&nbsp;<span class="op" id="3043028">!=</span>&nbsp;<span class="op" id="3043031">-</span><span class="num" id="3043032">1</span>&nbsp;<span class="op" id="3043034">&amp;&amp;</span>&nbsp;<span class="ident" id="3043037">w</span><span class="op" id="3043038">.</span><span class="ident" id="3043039">bodyAllowed</span><span class="op" id="3043050">(</span><span class="op" id="3043051">)</span>&nbsp;<span class="op" id="3043053">&amp;&amp;</span>&nbsp;<span class="ident" id="3043056">w</span><span class="op" id="3043057">.</span><span class="ident" id="3043058">contentLength</span>&nbsp;<span class="op" id="3043072">!=</span>&nbsp;<span class="ident" id="3043075">w</span><span class="op" id="3043076">.</span><span class="ident" id="3043077">written</span>&nbsp;<span class="op" id="3043085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043089">//&nbsp;Did&nbsp;not&nbsp;write&nbsp;enough.&nbsp;Avoid&nbsp;getting&nbsp;out&nbsp;of&nbsp;sync.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043143">w</span><span class="op" id="3043144">.</span><span class="ident" id="3043145">closeAfterReply</span>&nbsp;<span class="op" id="3043161">=</span>&nbsp;<span class="builtintype" id="3043163">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3043169">}</span><br>
<span class="lineno">1035</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043173">//&nbsp;There&nbsp;was&nbsp;some&nbsp;error&nbsp;writing&nbsp;to&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043235">//&nbsp;during&nbsp;the&nbsp;request,&nbsp;so&nbsp;don&#39;t&nbsp;re-use&nbsp;this&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3043286">if</span>&nbsp;<span class="ident" id="3043289">w</span><span class="op" id="3043290">.</span><span class="ident" id="3043291">conn</span><span class="op" id="3043295">.</span><span class="ident" id="3043296">werr</span>&nbsp;<span class="op" id="3043301">!=</span>&nbsp;<span class="builtintype" id="3043304">nil</span>&nbsp;<span class="op" id="3043308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043312">w</span><span class="op" id="3043313">.</span><span class="ident" id="3043314">closeAfterReply</span>&nbsp;<span class="op" id="3043330">=</span>&nbsp;<span class="builtintype" id="3043332">true</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3043338">}</span><br>
<span class="lineno"></span><span class="op" id="3043340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3043343">func</span>&nbsp;<span class="op" id="3043348">(</span><span class="ident" id="3043349">w</span>&nbsp;<span class="op" id="3043351">*</span><span class="ident" id="3043352">response</span><span class="op" id="3043360">)</span>&nbsp;<span class="ident" id="3043362">Flush</span><span class="op" id="3043367">(</span><span class="op" id="3043368">)</span>&nbsp;<span class="op" id="3043370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3043373">if</span>&nbsp;<span class="op" id="3043376">!</span><span class="ident" id="3043377">w</span><span class="op" id="3043378">.</span><span class="ident" id="3043379">wroteHeader</span>&nbsp;<span class="op" id="3043391">{</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043395">w</span><span class="op" id="3043396">.</span><span class="ident" id="3043397">WriteHeader</span><span class="op" id="3043408">(</span><span class="ident" id="3043409">StatusOK</span><span class="op" id="3043417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3043420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043423">w</span><span class="op" id="3043424">.</span><span class="ident" id="3043425">w</span><span class="op" id="3043426">.</span><span class="ident" id="3043427">Flush</span><span class="op" id="3043432">(</span><span class="op" id="3043433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043436">w</span><span class="op" id="3043437">.</span><span class="ident" id="3043438">cw</span><span class="op" id="3043440">.</span><span class="ident" id="3043441">flush</span><span class="op" id="3043446">(</span><span class="op" id="3043447">)</span><br>
<span class="lineno"></span><span class="op" id="3043449">}</span><br>
<span class="lineno">1050</span><br>
<span class="lineno"></span><span class="keyword" id="3043452">func</span>&nbsp;<span class="op" id="3043457">(</span><span class="ident" id="3043458">c</span>&nbsp;<span class="op" id="3043460">*</span><span class="ident" id="3043461">conn</span><span class="op" id="3043465">)</span>&nbsp;<span class="ident" id="3043467">finalFlush</span><span class="op" id="3043477">(</span><span class="op" id="3043478">)</span>&nbsp;<span class="op" id="3043480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3043483">if</span>&nbsp;<span class="ident" id="3043486">c</span><span class="op" id="3043487">.</span><span class="ident" id="3043488">buf</span>&nbsp;<span class="op" id="3043492">!=</span>&nbsp;<span class="builtintype" id="3043495">nil</span>&nbsp;<span class="op" id="3043499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043503">c</span><span class="op" id="3043504">.</span><span class="ident" id="3043505">buf</span><span class="op" id="3043508">.</span><span class="ident" id="3043509">Flush</span><span class="op" id="3043514">(</span><span class="op" id="3043515">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043520">//&nbsp;Steal&nbsp;the&nbsp;bufio.Reader&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043590">//&nbsp;reader&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043627">putBufioReader</span><span class="op" id="3043641">(</span><span class="ident" id="3043642">c</span><span class="op" id="3043643">.</span><span class="ident" id="3043644">buf</span><span class="op" id="3043647">.</span><span class="ident" id="3043648">Reader</span><span class="op" id="3043654">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043659">//&nbsp;Steal&nbsp;the&nbsp;bufio.Writer&nbsp;(~4KB&nbsp;worth&nbsp;of&nbsp;memory)&nbsp;and&nbsp;its&nbsp;associated</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3043729">//&nbsp;writer&nbsp;for&nbsp;a&nbsp;future&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043766">putBufioWriter</span><span class="op" id="3043780">(</span><span class="ident" id="3043781">c</span><span class="op" id="3043782">.</span><span class="ident" id="3043783">buf</span><span class="op" id="3043786">.</span><span class="ident" id="3043787">Writer</span><span class="op" id="3043793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043798">c</span><span class="op" id="3043799">.</span><span class="ident" id="3043800">buf</span>&nbsp;<span class="op" id="3043804">=</span>&nbsp;<span class="builtintype" id="3043806">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3043811">}</span><br>
<span class="lineno">1065</span><span class="op" id="3043813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3043816">//&nbsp;Close&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3043841">func</span>&nbsp;<span class="op" id="3043846">(</span><span class="ident" id="3043847">c</span>&nbsp;<span class="op" id="3043849">*</span><span class="ident" id="3043850">conn</span><span class="op" id="3043854">)</span>&nbsp;<span class="builtinfunc" id="3043856">close</span><span class="op" id="3043861">(</span><span class="op" id="3043862">)</span>&nbsp;<span class="op" id="3043864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043867">c</span><span class="op" id="3043868">.</span><span class="ident" id="3043869">finalFlush</span><span class="op" id="3043879">(</span><span class="op" id="3043880">)</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3043883">if</span>&nbsp;<span class="ident" id="3043886">c</span><span class="op" id="3043887">.</span><span class="ident" id="3043888">rwc</span>&nbsp;<span class="op" id="3043892">!=</span>&nbsp;<span class="builtintype" id="3043895">nil</span>&nbsp;<span class="op" id="3043899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043903">c</span><span class="op" id="3043904">.</span><span class="ident" id="3043905">rwc</span><span class="op" id="3043908">.</span><span class="ident" id="3043909">Close</span><span class="op" id="3043914">(</span><span class="op" id="3043915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3043919">c</span><span class="op" id="3043920">.</span><span class="ident" id="3043921">rwc</span>&nbsp;<span class="op" id="3043925">=</span>&nbsp;<span class="builtintype" id="3043927">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3043932">}</span><br>
<span class="lineno"></span><span class="op" id="3043934">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span><span class="comment" id="3043937">//&nbsp;rstAvoidanceDelay&nbsp;is&nbsp;the&nbsp;amount&nbsp;of&nbsp;time&nbsp;we&nbsp;sleep&nbsp;after&nbsp;closing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3044007">//&nbsp;write&nbsp;side&nbsp;of&nbsp;a&nbsp;TCP&nbsp;connection&nbsp;before&nbsp;closing&nbsp;the&nbsp;entire&nbsp;socket.</span><br>
<span class="lineno"></span><span class="comment" id="3044075">//&nbsp;By&nbsp;sleeping,&nbsp;we&nbsp;increase&nbsp;the&nbsp;chances&nbsp;that&nbsp;the&nbsp;client&nbsp;sees&nbsp;our&nbsp;FIN</span><br>
<span class="lineno"></span><span class="comment" id="3044144">//&nbsp;and&nbsp;processes&nbsp;its&nbsp;final&nbsp;data&nbsp;before&nbsp;they&nbsp;process&nbsp;the&nbsp;subsequent&nbsp;RST</span><br>
<span class="lineno">1080</span><span class="comment" id="3044215">//&nbsp;from&nbsp;closing&nbsp;a&nbsp;connection&nbsp;with&nbsp;known&nbsp;unread&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3044268">//&nbsp;This&nbsp;RST&nbsp;seems&nbsp;to&nbsp;occur&nbsp;mostly&nbsp;on&nbsp;BSD&nbsp;systems.&nbsp;(And&nbsp;Windows?)</span><br>
<span class="lineno"></span><span class="comment" id="3044333">//&nbsp;This&nbsp;timeout&nbsp;is&nbsp;somewhat&nbsp;arbitrary&nbsp;(~latency&nbsp;around&nbsp;the&nbsp;planet).</span><br>
<span class="lineno"></span><span class="keyword" id="3044401">const</span>&nbsp;<span class="ident" id="3044407">rstAvoidanceDelay</span>&nbsp;<span class="op" id="3044425">=</span>&nbsp;<span class="num" id="3044427">500</span>&nbsp;<span class="op" id="3044431">*</span>&nbsp;<span class="ident" id="3044433">time</span><span class="op" id="3044437">.</span><span class="ident" id="3044438">Millisecond</span><br>
<span class="lineno"></span><br>
<span class="lineno">1085</span><span class="keyword" id="3044451">type</span>&nbsp;<span class="ident" id="3044456">closeWriter</span>&nbsp;<span class="keyword" id="3044468">interface</span>&nbsp;<span class="op" id="3044478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3044481">CloseWrite</span><span class="op" id="3044491">(</span><span class="op" id="3044492">)</span>&nbsp;<span class="builtintype" id="3044494">error</span><br>
<span class="lineno"></span><span class="op" id="3044500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3044503">var</span>&nbsp;<span class="ident" id="3044507">_</span>&nbsp;<span class="ident" id="3044509">closeWriter</span>&nbsp;<span class="op" id="3044521">=</span>&nbsp;<span class="op" id="3044523">(</span><span class="op" id="3044524">*</span><span class="ident" id="3044525">net</span><span class="op" id="3044528">.</span><span class="ident" id="3044529">TCPConn</span><span class="op" id="3044536">)</span><span class="op" id="3044537">(</span><span class="builtintype" id="3044538">nil</span><span class="op" id="3044541">)</span><br>
<span class="lineno">1090</span><br>
<span class="lineno"></span><span class="comment" id="3044544">//&nbsp;closeWrite&nbsp;flushes&nbsp;any&nbsp;outstanding&nbsp;data&nbsp;and&nbsp;sends&nbsp;a&nbsp;FIN&nbsp;packet&nbsp;(if</span><br>
<span class="lineno"></span><span class="comment" id="3044614">//&nbsp;client&nbsp;is&nbsp;connected&nbsp;via&nbsp;TCP),&nbsp;signalling&nbsp;that&nbsp;we&#39;re&nbsp;done.&nbsp;&nbsp;We&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3044684">//&nbsp;pause&nbsp;for&nbsp;a&nbsp;bit,&nbsp;hoping&nbsp;the&nbsp;client&nbsp;processes&nbsp;it&nbsp;before&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3044746">//&nbsp;subsequent&nbsp;RST.</span><br>
<span class="lineno">1095</span><span class="comment" id="3044765">//</span><br>
<span class="lineno"></span><span class="comment" id="3044768">//&nbsp;See&nbsp;http://golang.org/issue/3595</span><br>
<span class="lineno"></span><span class="keyword" id="3044804">func</span>&nbsp;<span class="op" id="3044809">(</span><span class="ident" id="3044810">c</span>&nbsp;<span class="op" id="3044812">*</span><span class="ident" id="3044813">conn</span><span class="op" id="3044817">)</span>&nbsp;<span class="ident" id="3044819">closeWriteAndWait</span><span class="op" id="3044836">(</span><span class="op" id="3044837">)</span>&nbsp;<span class="op" id="3044839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3044842">c</span><span class="op" id="3044843">.</span><span class="ident" id="3044844">finalFlush</span><span class="op" id="3044854">(</span><span class="op" id="3044855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3044858">if</span>&nbsp;<span class="ident" id="3044861">tcp</span><span class="op" id="3044864">,</span>&nbsp;<span class="ident" id="3044866">ok</span>&nbsp;<span class="op" id="3044869">:=</span>&nbsp;<span class="ident" id="3044872">c</span><span class="op" id="3044873">.</span><span class="ident" id="3044874">rwc</span><span class="op" id="3044877">.</span><span class="op" id="3044878">(</span><span class="ident" id="3044879">closeWriter</span><span class="op" id="3044890">)</span><span class="op" id="3044891">;</span>&nbsp;<span class="ident" id="3044893">ok</span>&nbsp;<span class="op" id="3044896">{</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3044900">tcp</span><span class="op" id="3044903">.</span><span class="ident" id="3044904">CloseWrite</span><span class="op" id="3044914">(</span><span class="op" id="3044915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3044918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3044921">time</span><span class="op" id="3044925">.</span><span class="ident" id="3044926">Sleep</span><span class="op" id="3044931">(</span><span class="ident" id="3044932">rstAvoidanceDelay</span><span class="op" id="3044949">)</span><br>
<span class="lineno"></span><span class="op" id="3044951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1105</span><span class="comment" id="3044954">//&nbsp;validNPN&nbsp;reports&nbsp;whether&nbsp;the&nbsp;proto&nbsp;is&nbsp;not&nbsp;a&nbsp;blacklisted&nbsp;Next</span><br>
<span class="lineno"></span><span class="comment" id="3045018">//&nbsp;Protocol&nbsp;Negotiation&nbsp;protocol.&nbsp;&nbsp;Empty&nbsp;and&nbsp;built-in&nbsp;protocol&nbsp;types</span><br>
<span class="lineno"></span><span class="comment" id="3045087">//&nbsp;are&nbsp;blacklisted&nbsp;and&nbsp;can&#39;t&nbsp;be&nbsp;overridden&nbsp;with&nbsp;alternate</span><br>
<span class="lineno"></span><span class="comment" id="3045145">//&nbsp;implementations.</span><br>
<span class="lineno"></span><span class="keyword" id="3045165">func</span>&nbsp;<span class="ident" id="3045170">validNPN</span><span class="op" id="3045178">(</span><span class="ident" id="3045179">proto</span>&nbsp;<span class="builtintype" id="3045185">string</span><span class="op" id="3045191">)</span>&nbsp;<span class="builtintype" id="3045193">bool</span>&nbsp;<span class="op" id="3045198">{</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045201">switch</span>&nbsp;<span class="ident" id="3045208">proto</span>&nbsp;<span class="op" id="3045214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045217">case</span>&nbsp;<span class="string" id="3045222">&#34;&#34;</span><span class="op" id="3045224">,</span>&nbsp;<span class="string" id="3045226">&#34;http/1.1&#34;</span><span class="op" id="3045236">,</span>&nbsp;<span class="string" id="3045238">&#34;http/1.0&#34;</span><span class="op" id="3045248">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045252">return</span>&nbsp;<span class="builtintype" id="3045259">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045269">return</span>&nbsp;<span class="builtintype" id="3045276">true</span><br>
<span class="lineno">1115</span><span class="op" id="3045281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3045284">func</span>&nbsp;<span class="op" id="3045289">(</span><span class="ident" id="3045290">c</span>&nbsp;<span class="op" id="3045292">*</span><span class="ident" id="3045293">conn</span><span class="op" id="3045297">)</span>&nbsp;<span class="ident" id="3045299">setState</span><span class="op" id="3045307">(</span><span class="ident" id="3045308">nc</span>&nbsp;<span class="ident" id="3045311">net</span><span class="op" id="3045314">.</span><span class="ident" id="3045315">Conn</span><span class="op" id="3045319">,</span>&nbsp;<span class="ident" id="3045321">state</span>&nbsp;<span class="ident" id="3045327">ConnState</span><span class="op" id="3045336">)</span>&nbsp;<span class="op" id="3045338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045341">if</span>&nbsp;<span class="ident" id="3045344">hook</span>&nbsp;<span class="op" id="3045349">:=</span>&nbsp;<span class="ident" id="3045352">c</span><span class="op" id="3045353">.</span><span class="ident" id="3045354">server</span><span class="op" id="3045360">.</span><span class="ident" id="3045361">ConnState</span><span class="op" id="3045370">;</span>&nbsp;<span class="ident" id="3045372">hook</span>&nbsp;<span class="op" id="3045377">!=</span>&nbsp;<span class="builtintype" id="3045380">nil</span>&nbsp;<span class="op" id="3045384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045388">hook</span><span class="op" id="3045392">(</span><span class="ident" id="3045393">nc</span><span class="op" id="3045395">,</span>&nbsp;<span class="ident" id="3045397">state</span><span class="op" id="3045402">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045405">}</span><br>
<span class="lineno"></span><span class="op" id="3045407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3045410">//&nbsp;Serve&nbsp;a&nbsp;new&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3045437">func</span>&nbsp;<span class="op" id="3045442">(</span><span class="ident" id="3045443">c</span>&nbsp;<span class="op" id="3045445">*</span><span class="ident" id="3045446">conn</span><span class="op" id="3045450">)</span>&nbsp;<span class="ident" id="3045452">serve</span><span class="op" id="3045457">(</span><span class="op" id="3045458">)</span>&nbsp;<span class="op" id="3045460">{</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045463">origConn</span>&nbsp;<span class="op" id="3045472">:=</span>&nbsp;<span class="ident" id="3045475">c</span><span class="op" id="3045476">.</span><span class="ident" id="3045477">rwc</span>&nbsp;<span class="comment" id="3045481">//&nbsp;copy&nbsp;it&nbsp;before&nbsp;it&#39;s&nbsp;set&nbsp;nil&nbsp;on&nbsp;Close&nbsp;or&nbsp;Hijack</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045532">defer</span>&nbsp;<span class="keyword" id="3045538">func</span><span class="op" id="3045542">(</span><span class="op" id="3045543">)</span>&nbsp;<span class="op" id="3045545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045549">if</span>&nbsp;<span class="ident" id="3045552">err</span>&nbsp;<span class="op" id="3045556">:=</span>&nbsp;<span class="builtinfunc" id="3045559">recover</span><span class="op" id="3045566">(</span><span class="op" id="3045567">)</span><span class="op" id="3045568">;</span>&nbsp;<span class="ident" id="3045570">err</span>&nbsp;<span class="op" id="3045574">!=</span>&nbsp;<span class="builtintype" id="3045577">nil</span>&nbsp;<span class="op" id="3045581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045586">const</span>&nbsp;<span class="ident" id="3045592">size</span>&nbsp;<span class="op" id="3045597">=</span>&nbsp;<span class="num" id="3045599">64</span>&nbsp;<span class="op" id="3045602">&lt;&lt;</span>&nbsp;<span class="num" id="3045605">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045611">buf</span>&nbsp;<span class="op" id="3045615">:=</span>&nbsp;<span class="builtinfunc" id="3045618">make</span><span class="op" id="3045622">(</span><span class="op" id="3045623">[</span><span class="op" id="3045624">]</span><span class="builtintype" id="3045625">byte</span><span class="op" id="3045629">,</span>&nbsp;<span class="ident" id="3045631">size</span><span class="op" id="3045635">)</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045640">buf</span>&nbsp;<span class="op" id="3045644">=</span>&nbsp;<span class="ident" id="3045646">buf</span><span class="op" id="3045649">[</span><span class="op" id="3045650">:</span><span class="ident" id="3045651">runtime</span><span class="op" id="3045658">.</span><span class="ident" id="3045659">Stack</span><span class="op" id="3045664">(</span><span class="ident" id="3045665">buf</span><span class="op" id="3045668">,</span>&nbsp;<span class="builtintype" id="3045670">false</span><span class="op" id="3045675">)</span><span class="op" id="3045676">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045681">c</span><span class="op" id="3045682">.</span><span class="ident" id="3045683">server</span><span class="op" id="3045689">.</span><span class="ident" id="3045690">logf</span><span class="op" id="3045694">(</span><span class="string" id="3045695">&#34;http:&nbsp;panic&nbsp;serving&nbsp;%v:&nbsp;%v\n%s&#34;</span><span class="op" id="3045727">,</span>&nbsp;<span class="ident" id="3045729">c</span><span class="op" id="3045730">.</span><span class="ident" id="3045731">remoteAddr</span><span class="op" id="3045741">,</span>&nbsp;<span class="ident" id="3045743">err</span><span class="op" id="3045746">,</span>&nbsp;<span class="ident" id="3045748">buf</span><span class="op" id="3045751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045759">if</span>&nbsp;<span class="op" id="3045762">!</span><span class="ident" id="3045763">c</span><span class="op" id="3045764">.</span><span class="ident" id="3045765">hijacked</span><span class="op" id="3045773">(</span><span class="op" id="3045774">)</span>&nbsp;<span class="op" id="3045776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045781">c</span><span class="op" id="3045782">.</span><span class="builtinfunc" id="3045783">close</span><span class="op" id="3045788">(</span><span class="op" id="3045789">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045794">c</span><span class="op" id="3045795">.</span><span class="ident" id="3045796">setState</span><span class="op" id="3045804">(</span><span class="ident" id="3045805">origConn</span><span class="op" id="3045813">,</span>&nbsp;<span class="ident" id="3045815">StateClosed</span><span class="op" id="3045826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045833">}</span><span class="op" id="3045834">(</span><span class="op" id="3045835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045839">if</span>&nbsp;<span class="ident" id="3045842">tlsConn</span><span class="op" id="3045849">,</span>&nbsp;<span class="ident" id="3045851">ok</span>&nbsp;<span class="op" id="3045854">:=</span>&nbsp;<span class="ident" id="3045857">c</span><span class="op" id="3045858">.</span><span class="ident" id="3045859">rwc</span><span class="op" id="3045862">.</span><span class="op" id="3045863">(</span><span class="op" id="3045864">*</span><span class="ident" id="3045865">tls</span><span class="op" id="3045868">.</span><span class="ident" id="3045869">Conn</span><span class="op" id="3045873">)</span><span class="op" id="3045874">;</span>&nbsp;<span class="ident" id="3045876">ok</span>&nbsp;<span class="op" id="3045879">{</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045883">if</span>&nbsp;<span class="ident" id="3045886">d</span>&nbsp;<span class="op" id="3045888">:=</span>&nbsp;<span class="ident" id="3045891">c</span><span class="op" id="3045892">.</span><span class="ident" id="3045893">server</span><span class="op" id="3045899">.</span><span class="ident" id="3045900">ReadTimeout</span><span class="op" id="3045911">;</span>&nbsp;<span class="ident" id="3045913">d</span>&nbsp;<span class="op" id="3045915">!=</span>&nbsp;<span class="num" id="3045918">0</span>&nbsp;<span class="op" id="3045920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3045925">c</span><span class="op" id="3045926">.</span><span class="ident" id="3045927">rwc</span><span class="op" id="3045930">.</span><span class="ident" id="3045931">SetReadDeadline</span><span class="op" id="3045946">(</span><span class="ident" id="3045947">time</span><span class="op" id="3045951">.</span><span class="ident" id="3045952">Now</span><span class="op" id="3045955">(</span><span class="op" id="3045956">)</span><span class="op" id="3045957">.</span><span class="ident" id="3045958">Add</span><span class="op" id="3045961">(</span><span class="ident" id="3045962">d</span><span class="op" id="3045963">)</span><span class="op" id="3045964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3045968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3045972">if</span>&nbsp;<span class="ident" id="3045975">d</span>&nbsp;<span class="op" id="3045977">:=</span>&nbsp;<span class="ident" id="3045980">c</span><span class="op" id="3045981">.</span><span class="ident" id="3045982">server</span><span class="op" id="3045988">.</span><span class="ident" id="3045989">WriteTimeout</span><span class="op" id="3046001">;</span>&nbsp;<span class="ident" id="3046003">d</span>&nbsp;<span class="op" id="3046005">!=</span>&nbsp;<span class="num" id="3046008">0</span>&nbsp;<span class="op" id="3046010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046015">c</span><span class="op" id="3046016">.</span><span class="ident" id="3046017">rwc</span><span class="op" id="3046020">.</span><span class="ident" id="3046021">SetWriteDeadline</span><span class="op" id="3046037">(</span><span class="ident" id="3046038">time</span><span class="op" id="3046042">.</span><span class="ident" id="3046043">Now</span><span class="op" id="3046046">(</span><span class="op" id="3046047">)</span><span class="op" id="3046048">.</span><span class="ident" id="3046049">Add</span><span class="op" id="3046052">(</span><span class="ident" id="3046053">d</span><span class="op" id="3046054">)</span><span class="op" id="3046055">)</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046063">if</span>&nbsp;<span class="ident" id="3046066">err</span>&nbsp;<span class="op" id="3046070">:=</span>&nbsp;<span class="ident" id="3046073">tlsConn</span><span class="op" id="3046080">.</span><span class="ident" id="3046081">Handshake</span><span class="op" id="3046090">(</span><span class="op" id="3046091">)</span><span class="op" id="3046092">;</span>&nbsp;<span class="ident" id="3046094">err</span>&nbsp;<span class="op" id="3046098">!=</span>&nbsp;<span class="builtintype" id="3046101">nil</span>&nbsp;<span class="op" id="3046105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046110">c</span><span class="op" id="3046111">.</span><span class="ident" id="3046112">server</span><span class="op" id="3046118">.</span><span class="ident" id="3046119">logf</span><span class="op" id="3046123">(</span><span class="string" id="3046124">&#34;http:&nbsp;TLS&nbsp;handshake&nbsp;error&nbsp;from&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3046163">,</span>&nbsp;<span class="ident" id="3046165">c</span><span class="op" id="3046166">.</span><span class="ident" id="3046167">rwc</span><span class="op" id="3046170">.</span><span class="ident" id="3046171">RemoteAddr</span><span class="op" id="3046181">(</span><span class="op" id="3046182">)</span><span class="op" id="3046183">,</span>&nbsp;<span class="ident" id="3046185">err</span><span class="op" id="3046188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046193">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046202">}</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046206">c</span><span class="op" id="3046207">.</span><span class="ident" id="3046208">tlsState</span>&nbsp;<span class="op" id="3046217">=</span>&nbsp;<span class="builtinfunc" id="3046219">new</span><span class="op" id="3046222">(</span><span class="ident" id="3046223">tls</span><span class="op" id="3046226">.</span><span class="ident" id="3046227">ConnectionState</span><span class="op" id="3046242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046246">*</span><span class="ident" id="3046247">c</span><span class="op" id="3046248">.</span><span class="ident" id="3046249">tlsState</span>&nbsp;<span class="op" id="3046258">=</span>&nbsp;<span class="ident" id="3046260">tlsConn</span><span class="op" id="3046267">.</span><span class="ident" id="3046268">ConnectionState</span><span class="op" id="3046283">(</span><span class="op" id="3046284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046288">if</span>&nbsp;<span class="ident" id="3046291">proto</span>&nbsp;<span class="op" id="3046297">:=</span>&nbsp;<span class="ident" id="3046300">c</span><span class="op" id="3046301">.</span><span class="ident" id="3046302">tlsState</span><span class="op" id="3046310">.</span><span class="ident" id="3046311">NegotiatedProtocol</span><span class="op" id="3046329">;</span>&nbsp;<span class="ident" id="3046331">validNPN</span><span class="op" id="3046339">(</span><span class="ident" id="3046340">proto</span><span class="op" id="3046345">)</span>&nbsp;<span class="op" id="3046347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046352">if</span>&nbsp;<span class="ident" id="3046355">fn</span>&nbsp;<span class="op" id="3046358">:=</span>&nbsp;<span class="ident" id="3046361">c</span><span class="op" id="3046362">.</span><span class="ident" id="3046363">server</span><span class="op" id="3046369">.</span><span class="ident" id="3046370">TLSNextProto</span><span class="op" id="3046382">[</span><span class="ident" id="3046383">proto</span><span class="op" id="3046388">]</span><span class="op" id="3046389">;</span>&nbsp;<span class="ident" id="3046391">fn</span>&nbsp;<span class="op" id="3046394">!=</span>&nbsp;<span class="builtintype" id="3046397">nil</span>&nbsp;<span class="op" id="3046401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046407">h</span>&nbsp;<span class="op" id="3046409">:=</span>&nbsp;<span class="ident" id="3046412">initNPNRequest</span><span class="op" id="3046426">{</span><span class="ident" id="3046427">tlsConn</span><span class="op" id="3046434">,</span>&nbsp;<span class="ident" id="3046436">serverHandler</span><span class="op" id="3046449">{</span><span class="ident" id="3046450">c</span><span class="op" id="3046451">.</span><span class="ident" id="3046452">server</span><span class="op" id="3046458">}</span><span class="op" id="3046459">}</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046465">fn</span><span class="op" id="3046467">(</span><span class="ident" id="3046468">c</span><span class="op" id="3046469">.</span><span class="ident" id="3046470">server</span><span class="op" id="3046476">,</span>&nbsp;<span class="ident" id="3046478">tlsConn</span><span class="op" id="3046485">,</span>&nbsp;<span class="ident" id="3046487">h</span><span class="op" id="3046488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046498">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046510">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046514">for</span>&nbsp;<span class="op" id="3046518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046522">w</span><span class="op" id="3046523">,</span>&nbsp;<span class="ident" id="3046525">err</span>&nbsp;<span class="op" id="3046529">:=</span>&nbsp;<span class="ident" id="3046532">c</span><span class="op" id="3046533">.</span><span class="ident" id="3046534">readRequest</span><span class="op" id="3046545">(</span><span class="op" id="3046546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046550">if</span>&nbsp;<span class="ident" id="3046553">c</span><span class="op" id="3046554">.</span><span class="ident" id="3046555">lr</span><span class="op" id="3046557">.</span><span class="ident" id="3046558">N</span>&nbsp;<span class="op" id="3046560">!=</span>&nbsp;<span class="ident" id="3046563">c</span><span class="op" id="3046564">.</span><span class="ident" id="3046565">server</span><span class="op" id="3046571">.</span><span class="ident" id="3046572">initialLimitedReaderSize</span><span class="op" id="3046596">(</span><span class="op" id="3046597">)</span>&nbsp;<span class="op" id="3046599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046604">//&nbsp;If&nbsp;we&nbsp;read&nbsp;any&nbsp;bytes&nbsp;off&nbsp;the&nbsp;wire,&nbsp;we&#39;re&nbsp;active.</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046659">c</span><span class="op" id="3046660">.</span><span class="ident" id="3046661">setState</span><span class="op" id="3046669">(</span><span class="ident" id="3046670">c</span><span class="op" id="3046671">.</span><span class="ident" id="3046672">rwc</span><span class="op" id="3046675">,</span>&nbsp;<span class="ident" id="3046677">StateActive</span><span class="op" id="3046688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3046692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046696">if</span>&nbsp;<span class="ident" id="3046699">err</span>&nbsp;<span class="op" id="3046703">!=</span>&nbsp;<span class="builtintype" id="3046706">nil</span>&nbsp;<span class="op" id="3046710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3046715">if</span>&nbsp;<span class="ident" id="3046718">err</span>&nbsp;<span class="op" id="3046722">==</span>&nbsp;<span class="ident" id="3046725">errTooLarge</span>&nbsp;<span class="op" id="3046737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046743">//&nbsp;Their&nbsp;HTTP&nbsp;client&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;be</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046786">//&nbsp;able&nbsp;to&nbsp;read&nbsp;this&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046820">//&nbsp;responding&nbsp;to&nbsp;them&nbsp;and&nbsp;hanging&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046861">//&nbsp;while&nbsp;they&#39;re&nbsp;still&nbsp;writing&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3046902">//&nbsp;request.&nbsp;&nbsp;Undefined&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3046939">io</span><span class="op" id="3046941">.</span><span class="ident" id="3046942">WriteString</span><span class="op" id="3046953">(</span><span class="ident" id="3046954">c</span><span class="op" id="3046955">.</span><span class="ident" id="3046956">rwc</span><span class="op" id="3046959">,</span>&nbsp;<span class="string" id="3046961">&#34;HTTP/1.1&nbsp;413&nbsp;Request&nbsp;Entity&nbsp;Too&nbsp;Large\r\n\r\n&#34;</span><span class="op" id="3047008">)</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047014">c</span><span class="op" id="3047015">.</span><span class="ident" id="3047016">closeWriteAndWait</span><span class="op" id="3047033">(</span><span class="op" id="3047034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047040">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047049">}</span>&nbsp;<span class="keyword" id="3047051">else</span>&nbsp;<span class="keyword" id="3047056">if</span>&nbsp;<span class="ident" id="3047059">err</span>&nbsp;<span class="op" id="3047063">==</span>&nbsp;<span class="ident" id="3047066">io</span><span class="op" id="3047068">.</span><span class="ident" id="3047069">EOF</span>&nbsp;<span class="op" id="3047073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047079">break</span>&nbsp;<span class="comment" id="3047085">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047103">}</span>&nbsp;<span class="keyword" id="3047105">else</span>&nbsp;<span class="keyword" id="3047110">if</span>&nbsp;<span class="ident" id="3047113">neterr</span><span class="op" id="3047119">,</span>&nbsp;<span class="ident" id="3047121">ok</span>&nbsp;<span class="op" id="3047124">:=</span>&nbsp;<span class="ident" id="3047127">err</span><span class="op" id="3047130">.</span><span class="op" id="3047131">(</span><span class="ident" id="3047132">net</span><span class="op" id="3047135">.</span><span class="ident" id="3047136">Error</span><span class="op" id="3047141">)</span><span class="op" id="3047142">;</span>&nbsp;<span class="ident" id="3047144">ok</span>&nbsp;<span class="op" id="3047147">&amp;&amp;</span>&nbsp;<span class="ident" id="3047150">neterr</span><span class="op" id="3047156">.</span><span class="ident" id="3047157">Timeout</span><span class="op" id="3047164">(</span><span class="op" id="3047165">)</span>&nbsp;<span class="op" id="3047167">{</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047173">break</span>&nbsp;<span class="comment" id="3047179">//&nbsp;Don&#39;t&nbsp;reply</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047202">io</span><span class="op" id="3047204">.</span><span class="ident" id="3047205">WriteString</span><span class="op" id="3047216">(</span><span class="ident" id="3047217">c</span><span class="op" id="3047218">.</span><span class="ident" id="3047219">rwc</span><span class="op" id="3047222">,</span>&nbsp;<span class="string" id="3047224">&#34;HTTP/1.1&nbsp;400&nbsp;Bad&nbsp;Request\r\n\r\n&#34;</span><span class="op" id="3047258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047263">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047271">}</span><br>
<span class="lineno">1185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047276">//&nbsp;Expect&nbsp;100&nbsp;Continue&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047309">req</span>&nbsp;<span class="op" id="3047313">:=</span>&nbsp;<span class="ident" id="3047316">w</span><span class="op" id="3047317">.</span><span class="ident" id="3047318">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047324">if</span>&nbsp;<span class="ident" id="3047327">req</span><span class="op" id="3047330">.</span><span class="ident" id="3047331">expectsContinue</span><span class="op" id="3047346">(</span><span class="op" id="3047347">)</span>&nbsp;<span class="op" id="3047349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047354">if</span>&nbsp;<span class="ident" id="3047357">req</span><span class="op" id="3047360">.</span><span class="ident" id="3047361">ProtoAtLeast</span><span class="op" id="3047373">(</span><span class="num" id="3047374">1</span><span class="op" id="3047375">,</span>&nbsp;<span class="num" id="3047377">1</span><span class="op" id="3047378">)</span>&nbsp;<span class="op" id="3047380">&amp;&amp;</span>&nbsp;<span class="ident" id="3047383">req</span><span class="op" id="3047386">.</span><span class="ident" id="3047387">ContentLength</span>&nbsp;<span class="op" id="3047401">!=</span>&nbsp;<span class="num" id="3047404">0</span>&nbsp;<span class="op" id="3047406">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047412">//&nbsp;Wrap&nbsp;the&nbsp;Body&nbsp;reader&nbsp;with&nbsp;one&nbsp;that&nbsp;replies&nbsp;on&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047480">req</span><span class="op" id="3047483">.</span><span class="ident" id="3047484">Body</span>&nbsp;<span class="op" id="3047489">=</span>&nbsp;<span class="op" id="3047491">&amp;</span><span class="ident" id="3047492">expectContinueReader</span><span class="op" id="3047512">{</span><span class="ident" id="3047513">readCloser</span><span class="op" id="3047523">:</span>&nbsp;<span class="ident" id="3047525">req</span><span class="op" id="3047528">.</span><span class="ident" id="3047529">Body</span><span class="op" id="3047533">,</span>&nbsp;<span class="ident" id="3047535">resp</span><span class="op" id="3047539">:</span>&nbsp;<span class="ident" id="3047541">w</span><span class="op" id="3047542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047552">req</span><span class="op" id="3047555">.</span><span class="ident" id="3047556">Header</span><span class="op" id="3047562">.</span><span class="ident" id="3047563">Del</span><span class="op" id="3047566">(</span><span class="string" id="3047567">&#34;Expect&#34;</span><span class="op" id="3047575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047579">}</span>&nbsp;<span class="keyword" id="3047581">else</span>&nbsp;<span class="keyword" id="3047586">if</span>&nbsp;<span class="ident" id="3047589">req</span><span class="op" id="3047592">.</span><span class="ident" id="3047593">Header</span><span class="op" id="3047599">.</span><span class="ident" id="3047600">get</span><span class="op" id="3047603">(</span><span class="string" id="3047604">&#34;Expect&#34;</span><span class="op" id="3047612">)</span>&nbsp;<span class="op" id="3047614">!=</span>&nbsp;<span class="string" id="3047617">&#34;&#34;</span>&nbsp;<span class="op" id="3047620">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3047625">w</span><span class="op" id="3047626">.</span><span class="ident" id="3047627">sendExpectationFailed</span><span class="op" id="3047648">(</span><span class="op" id="3047649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3047654">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3047662">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047667">//&nbsp;HTTP&nbsp;cannot&nbsp;have&nbsp;multiple&nbsp;simultaneous&nbsp;active&nbsp;requests.[*]</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047731">//&nbsp;Until&nbsp;the&nbsp;server&nbsp;replies&nbsp;to&nbsp;this&nbsp;request,&nbsp;it&nbsp;can&#39;t&nbsp;read&nbsp;another,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047801">//&nbsp;so&nbsp;we&nbsp;might&nbsp;as&nbsp;well&nbsp;run&nbsp;the&nbsp;handler&nbsp;in&nbsp;this&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047861">//&nbsp;[*]&nbsp;Not&nbsp;strictly&nbsp;true:&nbsp;HTTP&nbsp;pipelining.&nbsp;&nbsp;We&nbsp;could&nbsp;let&nbsp;them&nbsp;all&nbsp;process</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3047937">//&nbsp;in&nbsp;parallel&nbsp;even&nbsp;if&nbsp;their&nbsp;responses&nbsp;need&nbsp;to&nbsp;be&nbsp;serialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048001">serverHandler</span><span class="op" id="3048014">{</span><span class="ident" id="3048015">c</span><span class="op" id="3048016">.</span><span class="ident" id="3048017">server</span><span class="op" id="3048023">}</span><span class="op" id="3048024">.</span><span class="ident" id="3048025">ServeHTTP</span><span class="op" id="3048034">(</span><span class="ident" id="3048035">w</span><span class="op" id="3048036">,</span>&nbsp;<span class="ident" id="3048038">w</span><span class="op" id="3048039">.</span><span class="ident" id="3048040">req</span><span class="op" id="3048043">)</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3048047">if</span>&nbsp;<span class="ident" id="3048050">c</span><span class="op" id="3048051">.</span><span class="ident" id="3048052">hijacked</span><span class="op" id="3048060">(</span><span class="op" id="3048061">)</span>&nbsp;<span class="op" id="3048063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3048068">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3048077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048081">w</span><span class="op" id="3048082">.</span><span class="ident" id="3048083">finishRequest</span><span class="op" id="3048096">(</span><span class="op" id="3048097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3048101">if</span>&nbsp;<span class="ident" id="3048104">w</span><span class="op" id="3048105">.</span><span class="ident" id="3048106">closeAfterReply</span>&nbsp;<span class="op" id="3048122">{</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3048127">if</span>&nbsp;<span class="ident" id="3048130">w</span><span class="op" id="3048131">.</span><span class="ident" id="3048132">requestBodyLimitHit</span>&nbsp;<span class="op" id="3048152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048158">c</span><span class="op" id="3048159">.</span><span class="ident" id="3048160">closeWriteAndWait</span><span class="op" id="3048177">(</span><span class="op" id="3048178">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3048183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3048188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3048196">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048200">c</span><span class="op" id="3048201">.</span><span class="ident" id="3048202">setState</span><span class="op" id="3048210">(</span><span class="ident" id="3048211">c</span><span class="op" id="3048212">.</span><span class="ident" id="3048213">rwc</span><span class="op" id="3048216">,</span>&nbsp;<span class="ident" id="3048218">StateIdle</span><span class="op" id="3048227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3048230">}</span><br>
<span class="lineno"></span><span class="op" id="3048232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3048235">func</span>&nbsp;<span class="op" id="3048240">(</span><span class="ident" id="3048241">w</span>&nbsp;<span class="op" id="3048243">*</span><span class="ident" id="3048244">response</span><span class="op" id="3048252">)</span>&nbsp;<span class="ident" id="3048254">sendExpectationFailed</span><span class="op" id="3048275">(</span><span class="op" id="3048276">)</span>&nbsp;<span class="op" id="3048278">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048281">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;ServeHTTP&nbsp;handlers&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048331">//&nbsp;requests&nbsp;with&nbsp;non-standard&nbsp;expectation[s]?&nbsp;Seems</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048384">//&nbsp;theoretical&nbsp;at&nbsp;best,&nbsp;and&nbsp;doesn&#39;t&nbsp;fit&nbsp;into&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048434">//&nbsp;current&nbsp;ServeHTTP&nbsp;model&nbsp;anyway.&nbsp;&nbsp;We&#39;d&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048484">//&nbsp;make&nbsp;the&nbsp;ResponseWriter&nbsp;an&nbsp;optional</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048524">//&nbsp;&#34;ExpectReplier&#34;&nbsp;interface&nbsp;or&nbsp;something.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048568">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048572">//&nbsp;For&nbsp;now&nbsp;we&#39;ll&nbsp;just&nbsp;obey&nbsp;RFC&nbsp;2616&nbsp;14.20&nbsp;which&nbsp;says</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048626">//&nbsp;&#34;If&nbsp;a&nbsp;server&nbsp;receives&nbsp;a&nbsp;request&nbsp;containing&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048676">//&nbsp;Expect&nbsp;field&nbsp;that&nbsp;includes&nbsp;an&nbsp;expectation-</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048723">//&nbsp;extension&nbsp;that&nbsp;it&nbsp;does&nbsp;not&nbsp;support,&nbsp;it&nbsp;MUST</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3048771">//&nbsp;respond&nbsp;with&nbsp;a&nbsp;417&nbsp;(Expectation&nbsp;Failed)&nbsp;status.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048824">w</span><span class="op" id="3048825">.</span><span class="ident" id="3048826">Header</span><span class="op" id="3048832">(</span><span class="op" id="3048833">)</span><span class="op" id="3048834">.</span><span class="ident" id="3048835">Set</span><span class="op" id="3048838">(</span><span class="string" id="3048839">&#34;Connection&#34;</span><span class="op" id="3048851">,</span>&nbsp;<span class="string" id="3048853">&#34;close&#34;</span><span class="op" id="3048860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048863">w</span><span class="op" id="3048864">.</span><span class="ident" id="3048865">WriteHeader</span><span class="op" id="3048876">(</span><span class="ident" id="3048877">StatusExpectationFailed</span><span class="op" id="3048900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3048903">w</span><span class="op" id="3048904">.</span><span class="ident" id="3048905">finishRequest</span><span class="op" id="3048918">(</span><span class="op" id="3048919">)</span><br>
<span class="lineno">1235</span><span class="op" id="3048921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3048924">//&nbsp;Hijack&nbsp;implements&nbsp;the&nbsp;Hijacker.Hijack&nbsp;method.&nbsp;Our&nbsp;response&nbsp;is&nbsp;both&nbsp;a&nbsp;ResponseWriter</span><br>
<span class="lineno"></span><span class="comment" id="3049011">//&nbsp;and&nbsp;a&nbsp;Hijacker.</span><br>
<span class="lineno"></span><span class="keyword" id="3049030">func</span>&nbsp;<span class="op" id="3049035">(</span><span class="ident" id="3049036">w</span>&nbsp;<span class="op" id="3049038">*</span><span class="ident" id="3049039">response</span><span class="op" id="3049047">)</span>&nbsp;<span class="ident" id="3049049">Hijack</span><span class="op" id="3049055">(</span><span class="op" id="3049056">)</span>&nbsp;<span class="op" id="3049058">(</span><span class="ident" id="3049059">rwc</span>&nbsp;<span class="ident" id="3049063">net</span><span class="op" id="3049066">.</span><span class="ident" id="3049067">Conn</span><span class="op" id="3049071">,</span>&nbsp;<span class="ident" id="3049073">buf</span>&nbsp;<span class="op" id="3049077">*</span><span class="ident" id="3049078">bufio</span><span class="op" id="3049083">.</span><span class="ident" id="3049084">ReadWriter</span><span class="op" id="3049094">,</span>&nbsp;<span class="ident" id="3049096">err</span>&nbsp;<span class="builtintype" id="3049100">error</span><span class="op" id="3049105">)</span>&nbsp;<span class="op" id="3049107">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3049110">if</span>&nbsp;<span class="ident" id="3049113">w</span><span class="op" id="3049114">.</span><span class="ident" id="3049115">wroteHeader</span>&nbsp;<span class="op" id="3049127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3049131">w</span><span class="op" id="3049132">.</span><span class="ident" id="3049133">cw</span><span class="op" id="3049135">.</span><span class="ident" id="3049136">flush</span><span class="op" id="3049141">(</span><span class="op" id="3049142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3049145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3049148">//&nbsp;Release&nbsp;the&nbsp;bufioWriter&nbsp;that&nbsp;writes&nbsp;to&nbsp;the&nbsp;chunk&nbsp;writer,&nbsp;it&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3049219">//&nbsp;used&nbsp;after&nbsp;a&nbsp;connection&nbsp;has&nbsp;been&nbsp;hijacked.</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3049266">rwc</span><span class="op" id="3049269">,</span>&nbsp;<span class="ident" id="3049271">buf</span><span class="op" id="3049274">,</span>&nbsp;<span class="ident" id="3049276">err</span>&nbsp;<span class="op" id="3049280">=</span>&nbsp;<span class="ident" id="3049282">w</span><span class="op" id="3049283">.</span><span class="ident" id="3049284">conn</span><span class="op" id="3049288">.</span><span class="ident" id="3049289">hijack</span><span class="op" id="3049295">(</span><span class="op" id="3049296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3049299">if</span>&nbsp;<span class="ident" id="3049302">err</span>&nbsp;<span class="op" id="3049306">==</span>&nbsp;<span class="builtintype" id="3049309">nil</span>&nbsp;<span class="op" id="3049313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3049317">putBufioWriter</span><span class="op" id="3049331">(</span><span class="ident" id="3049332">w</span><span class="op" id="3049333">.</span><span class="ident" id="3049334">w</span><span class="op" id="3049335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3049339">w</span><span class="op" id="3049340">.</span><span class="ident" id="3049341">w</span>&nbsp;<span class="op" id="3049343">=</span>&nbsp;<span class="builtintype" id="3049345">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3049350">}</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3049353">return</span>&nbsp;<span class="ident" id="3049360">rwc</span><span class="op" id="3049363">,</span>&nbsp;<span class="ident" id="3049365">buf</span><span class="op" id="3049368">,</span>&nbsp;<span class="ident" id="3049370">err</span><br>
<span class="lineno"></span><span class="op" id="3049374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3049377">func</span>&nbsp;<span class="op" id="3049382">(</span><span class="ident" id="3049383">w</span>&nbsp;<span class="op" id="3049385">*</span><span class="ident" id="3049386">response</span><span class="op" id="3049394">)</span>&nbsp;<span class="ident" id="3049396">CloseNotify</span><span class="op" id="3049407">(</span><span class="op" id="3049408">)</span>&nbsp;<span class="op" id="3049410">&lt;-</span><span class="keyword" id="3049412">chan</span>&nbsp;<span class="builtintype" id="3049417">bool</span>&nbsp;<span class="op" id="3049422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3049425">return</span>&nbsp;<span class="ident" id="3049432">w</span><span class="op" id="3049433">.</span><span class="ident" id="3049434">conn</span><span class="op" id="3049438">.</span><span class="ident" id="3049439">closeNotify</span><span class="op" id="3049450">(</span><span class="op" id="3049451">)</span><br>
<span class="lineno">1255</span><span class="op" id="3049453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3049456">//&nbsp;The&nbsp;HandlerFunc&nbsp;type&nbsp;is&nbsp;an&nbsp;adapter&nbsp;to&nbsp;allow&nbsp;the&nbsp;use&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3049514">//&nbsp;ordinary&nbsp;functions&nbsp;as&nbsp;HTTP&nbsp;handlers.&nbsp;&nbsp;If&nbsp;f&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno"></span><span class="comment" id="3049574">//&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;signature,&nbsp;HandlerFunc(f)&nbsp;is&nbsp;a</span><br>
<span class="lineno">1260</span><span class="comment" id="3049629">//&nbsp;Handler&nbsp;object&nbsp;that&nbsp;calls&nbsp;f.</span><br>
<span class="lineno"></span><span class="keyword" id="3049661">type</span>&nbsp;<span class="ident" id="3049666">HandlerFunc</span>&nbsp;<span class="keyword" id="3049678">func</span><span class="op" id="3049682">(</span><span class="ident" id="3049683">ResponseWriter</span><span class="op" id="3049697">,</span>&nbsp;<span class="op" id="3049699">*</span><span class="ident" id="3049700">Request</span><span class="op" id="3049707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3049710">//&nbsp;ServeHTTP&nbsp;calls&nbsp;f(w,&nbsp;r).</span><br>
<span class="lineno"></span><span class="keyword" id="3049738">func</span>&nbsp;<span class="op" id="3049743">(</span><span class="ident" id="3049744">f</span>&nbsp;<span class="ident" id="3049746">HandlerFunc</span><span class="op" id="3049757">)</span>&nbsp;<span class="ident" id="3049759">ServeHTTP</span><span class="op" id="3049768">(</span><span class="ident" id="3049769">w</span>&nbsp;<span class="ident" id="3049771">ResponseWriter</span><span class="op" id="3049785">,</span>&nbsp;<span class="ident" id="3049787">r</span>&nbsp;<span class="op" id="3049789">*</span><span class="ident" id="3049790">Request</span><span class="op" id="3049797">)</span>&nbsp;<span class="op" id="3049799">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3049802">f</span><span class="op" id="3049803">(</span><span class="ident" id="3049804">w</span><span class="op" id="3049805">,</span>&nbsp;<span class="ident" id="3049807">r</span><span class="op" id="3049808">)</span><br>
<span class="lineno"></span><span class="op" id="3049810">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3049813">//&nbsp;Helper&nbsp;handlers</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3049833">//&nbsp;Error&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;the&nbsp;specified&nbsp;error&nbsp;message&nbsp;and&nbsp;HTTP&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="3049913">//&nbsp;The&nbsp;error&nbsp;message&nbsp;should&nbsp;be&nbsp;plain&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword" id="3049956">func</span>&nbsp;<span class="ident" id="3049961">Error</span><span class="op" id="3049966">(</span><span class="ident" id="3049967">w</span>&nbsp;<span class="ident" id="3049969">ResponseWriter</span><span class="op" id="3049983">,</span>&nbsp;<span class="builtintype" id="3049985">error</span>&nbsp;<span class="builtintype" id="3049991">string</span><span class="op" id="3049997">,</span>&nbsp;<span class="ident" id="3049999">code</span>&nbsp;<span class="builtintype" id="3050004">int</span><span class="op" id="3050007">)</span>&nbsp;<span class="op" id="3050009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3050012">w</span><span class="op" id="3050013">.</span><span class="ident" id="3050014">Header</span><span class="op" id="3050020">(</span><span class="op" id="3050021">)</span><span class="op" id="3050022">.</span><span class="ident" id="3050023">Set</span><span class="op" id="3050026">(</span><span class="string" id="3050027">&#34;Content-Type&#34;</span><span class="op" id="3050041">,</span>&nbsp;<span class="string" id="3050043">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="3050070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3050073">w</span><span class="op" id="3050074">.</span><span class="ident" id="3050075">WriteHeader</span><span class="op" id="3050086">(</span><span class="ident" id="3050087">code</span><span class="op" id="3050091">)</span><br>
<span class="lineno">1275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3050094">fmt</span><span class="op" id="3050097">.</span><span class="ident" id="3050098">Fprintln</span><span class="op" id="3050106">(</span><span class="ident" id="3050107">w</span><span class="op" id="3050108">,</span>&nbsp;<span class="builtintype" id="3050110">error</span><span class="op" id="3050115">)</span><br>
<span class="lineno"></span><span class="op" id="3050117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3050120">//&nbsp;NotFound&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3050189">func</span>&nbsp;<span class="ident" id="3050194">NotFound</span><span class="op" id="3050202">(</span><span class="ident" id="3050203">w</span>&nbsp;<span class="ident" id="3050205">ResponseWriter</span><span class="op" id="3050219">,</span>&nbsp;<span class="ident" id="3050221">r</span>&nbsp;<span class="op" id="3050223">*</span><span class="ident" id="3050224">Request</span><span class="op" id="3050231">)</span>&nbsp;<span class="op" id="3050233">{</span>&nbsp;<span class="ident" id="3050235">Error</span><span class="op" id="3050240">(</span><span class="ident" id="3050241">w</span><span class="op" id="3050242">,</span>&nbsp;<span class="string" id="3050244">&#34;404&nbsp;page&nbsp;not&nbsp;found&#34;</span><span class="op" id="3050264">,</span>&nbsp;<span class="ident" id="3050266">StatusNotFound</span><span class="op" id="3050280">)</span>&nbsp;<span class="op" id="3050282">}</span><br>
<span class="lineno">1280</span><br>
<span class="lineno"></span><span class="comment" id="3050285">//&nbsp;NotFoundHandler&nbsp;returns&nbsp;a&nbsp;simple&nbsp;request&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="3050337">//&nbsp;that&nbsp;replies&nbsp;to&nbsp;each&nbsp;request&nbsp;with&nbsp;a&nbsp;``404&nbsp;page&nbsp;not&nbsp;found&#39;&#39;&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3050406">func</span>&nbsp;<span class="ident" id="3050411">NotFoundHandler</span><span class="op" id="3050426">(</span><span class="op" id="3050427">)</span>&nbsp;<span class="ident" id="3050429">Handler</span>&nbsp;<span class="op" id="3050437">{</span>&nbsp;<span class="keyword" id="3050439">return</span>&nbsp;<span class="ident" id="3050446">HandlerFunc</span><span class="op" id="3050457">(</span><span class="ident" id="3050458">NotFound</span><span class="op" id="3050466">)</span>&nbsp;<span class="op" id="3050468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span><span class="comment" id="3050471">//&nbsp;StripPrefix&nbsp;returns&nbsp;a&nbsp;handler&nbsp;that&nbsp;serves&nbsp;HTTP&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3050530">//&nbsp;by&nbsp;removing&nbsp;the&nbsp;given&nbsp;prefix&nbsp;from&nbsp;the&nbsp;request&nbsp;URL&#39;s&nbsp;Path</span><br>
<span class="lineno"></span><span class="comment" id="3050590">//&nbsp;and&nbsp;invoking&nbsp;the&nbsp;handler&nbsp;h.&nbsp;StripPrefix&nbsp;handles&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3050643">//&nbsp;request&nbsp;for&nbsp;a&nbsp;path&nbsp;that&nbsp;doesn&#39;t&nbsp;begin&nbsp;with&nbsp;prefix&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3050699">//&nbsp;replying&nbsp;with&nbsp;an&nbsp;HTTP&nbsp;404&nbsp;not&nbsp;found&nbsp;error.</span><br>
<span class="lineno">1290</span><span class="keyword" id="3050745">func</span>&nbsp;<span class="ident" id="3050750">StripPrefix</span><span class="op" id="3050761">(</span><span class="ident" id="3050762">prefix</span>&nbsp;<span class="builtintype" id="3050769">string</span><span class="op" id="3050775">,</span>&nbsp;<span class="ident" id="3050777">h</span>&nbsp;<span class="ident" id="3050779">Handler</span><span class="op" id="3050786">)</span>&nbsp;<span class="ident" id="3050788">Handler</span>&nbsp;<span class="op" id="3050796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3050799">if</span>&nbsp;<span class="ident" id="3050802">prefix</span>&nbsp;<span class="op" id="3050809">==</span>&nbsp;<span class="string" id="3050812">&#34;&#34;</span>&nbsp;<span class="op" id="3050815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3050819">return</span>&nbsp;<span class="ident" id="3050826">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3050829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3050832">return</span>&nbsp;<span class="ident" id="3050839">HandlerFunc</span><span class="op" id="3050850">(</span><span class="keyword" id="3050851">func</span><span class="op" id="3050855">(</span><span class="ident" id="3050856">w</span>&nbsp;<span class="ident" id="3050858">ResponseWriter</span><span class="op" id="3050872">,</span>&nbsp;<span class="ident" id="3050874">r</span>&nbsp;<span class="op" id="3050876">*</span><span class="ident" id="3050877">Request</span><span class="op" id="3050884">)</span>&nbsp;<span class="op" id="3050886">{</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3050890">if</span>&nbsp;<span class="ident" id="3050893">p</span>&nbsp;<span class="op" id="3050895">:=</span>&nbsp;<span class="ident" id="3050898">strings</span><span class="op" id="3050905">.</span><span class="ident" id="3050906">TrimPrefix</span><span class="op" id="3050916">(</span><span class="ident" id="3050917">r</span><span class="op" id="3050918">.</span><span class="ident" id="3050919">URL</span><span class="op" id="3050922">.</span><span class="ident" id="3050923">Path</span><span class="op" id="3050927">,</span>&nbsp;<span class="ident" id="3050929">prefix</span><span class="op" id="3050935">)</span><span class="op" id="3050936">;</span>&nbsp;<span class="builtinfunc" id="3050938">len</span><span class="op" id="3050941">(</span><span class="ident" id="3050942">p</span><span class="op" id="3050943">)</span>&nbsp;<span class="op" id="3050945">&lt;</span>&nbsp;<span class="builtinfunc" id="3050947">len</span><span class="op" id="3050950">(</span><span class="ident" id="3050951">r</span><span class="op" id="3050952">.</span><span class="ident" id="3050953">URL</span><span class="op" id="3050956">.</span><span class="ident" id="3050957">Path</span><span class="op" id="3050961">)</span>&nbsp;<span class="op" id="3050963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3050968">r</span><span class="op" id="3050969">.</span><span class="ident" id="3050970">URL</span><span class="op" id="3050973">.</span><span class="ident" id="3050974">Path</span>&nbsp;<span class="op" id="3050979">=</span>&nbsp;<span class="ident" id="3050981">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3050986">h</span><span class="op" id="3050987">.</span><span class="ident" id="3050988">ServeHTTP</span><span class="op" id="3050997">(</span><span class="ident" id="3050998">w</span><span class="op" id="3050999">,</span>&nbsp;<span class="ident" id="3051001">r</span><span class="op" id="3051002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3051006">}</span>&nbsp;<span class="keyword" id="3051008">else</span>&nbsp;<span class="op" id="3051013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3051018">NotFound</span><span class="op" id="3051026">(</span><span class="ident" id="3051027">w</span><span class="op" id="3051028">,</span>&nbsp;<span class="ident" id="3051030">r</span><span class="op" id="3051031">)</span><br>
<span class="lineno">1300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3051035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3051038">}</span><span class="op" id="3051039">)</span><br>
<span class="lineno"></span><span class="op" id="3051041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3051044">//&nbsp;Redirect&nbsp;replies&nbsp;to&nbsp;the&nbsp;request&nbsp;with&nbsp;a&nbsp;redirect&nbsp;to&nbsp;url,</span><br>
<span class="lineno">1305</span><span class="comment" id="3051103">//&nbsp;which&nbsp;may&nbsp;be&nbsp;a&nbsp;path&nbsp;relative&nbsp;to&nbsp;the&nbsp;request&nbsp;path.</span><br>
<span class="lineno"></span><span class="keyword" id="3051156">func</span>&nbsp;<span class="ident" id="3051161">Redirect</span><span class="op" id="3051169">(</span><span class="ident" id="3051170">w</span>&nbsp;<span class="ident" id="3051172">ResponseWriter</span><span class="op" id="3051186">,</span>&nbsp;<span class="ident" id="3051188">r</span>&nbsp;<span class="op" id="3051190">*</span><span class="ident" id="3051191">Request</span><span class="op" id="3051198">,</span>&nbsp;<span class="ident" id="3051200">urlStr</span>&nbsp;<span class="builtintype" id="3051207">string</span><span class="op" id="3051213">,</span>&nbsp;<span class="ident" id="3051215">code</span>&nbsp;<span class="builtintype" id="3051220">int</span><span class="op" id="3051223">)</span>&nbsp;<span class="op" id="3051225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3051228">if</span>&nbsp;<span class="ident" id="3051231">u</span><span class="op" id="3051232">,</span>&nbsp;<span class="ident" id="3051234">err</span>&nbsp;<span class="op" id="3051238">:=</span>&nbsp;<span class="ident" id="3051241">url</span><span class="op" id="3051244">.</span><span class="ident" id="3051245">Parse</span><span class="op" id="3051250">(</span><span class="ident" id="3051251">urlStr</span><span class="op" id="3051257">)</span><span class="op" id="3051258">;</span>&nbsp;<span class="ident" id="3051260">err</span>&nbsp;<span class="op" id="3051264">==</span>&nbsp;<span class="builtintype" id="3051267">nil</span>&nbsp;<span class="op" id="3051271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051275">//&nbsp;If&nbsp;url&nbsp;was&nbsp;relative,&nbsp;make&nbsp;absolute&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051318">//&nbsp;combining&nbsp;with&nbsp;request&nbsp;path.</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051352">//&nbsp;The&nbsp;browser&nbsp;would&nbsp;probably&nbsp;do&nbsp;this&nbsp;for&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051400">//&nbsp;but&nbsp;doing&nbsp;it&nbsp;ourselves&nbsp;is&nbsp;more&nbsp;reliable.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051447">//&nbsp;NOTE(rsc):&nbsp;RFC&nbsp;2616&nbsp;says&nbsp;that&nbsp;the&nbsp;Location</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051495">//&nbsp;line&nbsp;must&nbsp;be&nbsp;an&nbsp;absolute&nbsp;URI,&nbsp;like</span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051535">//&nbsp;&#34;http://www.google.com/redirect/&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051575">//&nbsp;not&nbsp;a&nbsp;path&nbsp;like&nbsp;&#34;/redirect/&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051610">//&nbsp;Unfortunately,&nbsp;we&nbsp;don&#39;t&nbsp;know&nbsp;what&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051652">//&nbsp;put&nbsp;in&nbsp;the&nbsp;host&nbsp;name&nbsp;section&nbsp;to&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051697">//&nbsp;client&nbsp;to&nbsp;connect&nbsp;to&nbsp;us&nbsp;again,&nbsp;so&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051745">//&nbsp;know&nbsp;the&nbsp;right&nbsp;absolute&nbsp;URI&nbsp;to&nbsp;send&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051792">//&nbsp;Because&nbsp;of&nbsp;this&nbsp;problem,&nbsp;no&nbsp;one&nbsp;pays&nbsp;attention</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051844">//&nbsp;to&nbsp;the&nbsp;RFC;&nbsp;they&nbsp;all&nbsp;send&nbsp;back&nbsp;just&nbsp;a&nbsp;new&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3051897">//&nbsp;So&nbsp;do&nbsp;we.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3051912">oldpath</span>&nbsp;<span class="op" id="3051920">:=</span>&nbsp;<span class="ident" id="3051923">r</span><span class="op" id="3051924">.</span><span class="ident" id="3051925">URL</span><span class="op" id="3051928">.</span><span class="ident" id="3051929">Path</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3051936">if</span>&nbsp;<span class="ident" id="3051939">oldpath</span>&nbsp;<span class="op" id="3051947">==</span>&nbsp;<span class="string" id="3051950">&#34;&#34;</span>&nbsp;<span class="op" id="3051953">{</span>&nbsp;<span class="comment" id="3051955">//&nbsp;should&nbsp;not&nbsp;happen,&nbsp;but&nbsp;avoid&nbsp;a&nbsp;crash&nbsp;if&nbsp;it&nbsp;does</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052009">oldpath</span>&nbsp;<span class="op" id="3052017">=</span>&nbsp;<span class="string" id="3052019">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052029">if</span>&nbsp;<span class="ident" id="3052032">u</span><span class="op" id="3052033">.</span><span class="ident" id="3052034">Scheme</span>&nbsp;<span class="op" id="3052041">==</span>&nbsp;<span class="string" id="3052044">&#34;&#34;</span>&nbsp;<span class="op" id="3052047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052052">//&nbsp;no&nbsp;leading&nbsp;http://server</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052083">if</span>&nbsp;<span class="ident" id="3052086">urlStr</span>&nbsp;<span class="op" id="3052093">==</span>&nbsp;<span class="string" id="3052096">&#34;&#34;</span>&nbsp;<span class="op" id="3052099">||</span>&nbsp;<span class="ident" id="3052102">urlStr</span><span class="op" id="3052108">[</span><span class="num" id="3052109">0</span><span class="op" id="3052110">]</span>&nbsp;<span class="op" id="3052112">!=</span>&nbsp;<span class="string" id="3052115">&#39;/&#39;</span>&nbsp;<span class="op" id="3052119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052125">//&nbsp;make&nbsp;relative&nbsp;path&nbsp;absolute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052160">olddir</span><span class="op" id="3052166">,</span>&nbsp;<span class="ident" id="3052168">_</span>&nbsp;<span class="op" id="3052170">:=</span>&nbsp;<span class="ident" id="3052173">path</span><span class="op" id="3052177">.</span><span class="ident" id="3052178">Split</span><span class="op" id="3052183">(</span><span class="ident" id="3052184">oldpath</span><span class="op" id="3052191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052197">urlStr</span>&nbsp;<span class="op" id="3052204">=</span>&nbsp;<span class="ident" id="3052206">olddir</span>&nbsp;<span class="op" id="3052213">+</span>&nbsp;<span class="ident" id="3052215">urlStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052225">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052231">var</span>&nbsp;<span class="ident" id="3052235">query</span>&nbsp;<span class="builtintype" id="3052241">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052251">if</span>&nbsp;<span class="ident" id="3052254">i</span>&nbsp;<span class="op" id="3052256">:=</span>&nbsp;<span class="ident" id="3052259">strings</span><span class="op" id="3052266">.</span><span class="ident" id="3052267">Index</span><span class="op" id="3052272">(</span><span class="ident" id="3052273">urlStr</span><span class="op" id="3052279">,</span>&nbsp;<span class="string" id="3052281">&#34;?&#34;</span><span class="op" id="3052284">)</span><span class="op" id="3052285">;</span>&nbsp;<span class="ident" id="3052287">i</span>&nbsp;<span class="op" id="3052289">!=</span>&nbsp;<span class="op" id="3052292">-</span><span class="num" id="3052293">1</span>&nbsp;<span class="op" id="3052295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052301">urlStr</span><span class="op" id="3052307">,</span>&nbsp;<span class="ident" id="3052309">query</span>&nbsp;<span class="op" id="3052315">=</span>&nbsp;<span class="ident" id="3052317">urlStr</span><span class="op" id="3052323">[</span><span class="op" id="3052324">:</span><span class="ident" id="3052325">i</span><span class="op" id="3052326">]</span><span class="op" id="3052327">,</span>&nbsp;<span class="ident" id="3052329">urlStr</span><span class="op" id="3052335">[</span><span class="ident" id="3052336">i</span><span class="op" id="3052337">:</span><span class="op" id="3052338">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052343">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052349">//&nbsp;clean&nbsp;up&nbsp;but&nbsp;preserve&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052392">trailing</span>&nbsp;<span class="op" id="3052401">:=</span>&nbsp;<span class="ident" id="3052404">strings</span><span class="op" id="3052411">.</span><span class="ident" id="3052412">HasSuffix</span><span class="op" id="3052421">(</span><span class="ident" id="3052422">urlStr</span><span class="op" id="3052428">,</span>&nbsp;<span class="string" id="3052430">&#34;/&#34;</span><span class="op" id="3052433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052438">urlStr</span>&nbsp;<span class="op" id="3052445">=</span>&nbsp;<span class="ident" id="3052447">path</span><span class="op" id="3052451">.</span><span class="ident" id="3052452">Clean</span><span class="op" id="3052457">(</span><span class="ident" id="3052458">urlStr</span><span class="op" id="3052464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052469">if</span>&nbsp;<span class="ident" id="3052472">trailing</span>&nbsp;<span class="op" id="3052481">&amp;&amp;</span>&nbsp;<span class="op" id="3052484">!</span><span class="ident" id="3052485">strings</span><span class="op" id="3052492">.</span><span class="ident" id="3052493">HasSuffix</span><span class="op" id="3052502">(</span><span class="ident" id="3052503">urlStr</span><span class="op" id="3052509">,</span>&nbsp;<span class="string" id="3052511">&#34;/&#34;</span><span class="op" id="3052514">)</span>&nbsp;<span class="op" id="3052516">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052522">urlStr</span>&nbsp;<span class="op" id="3052529">+=</span>&nbsp;<span class="string" id="3052532">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052544">urlStr</span>&nbsp;<span class="op" id="3052551">+=</span>&nbsp;<span class="ident" id="3052554">query</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052565">}</span><br>
<span class="lineno">1350</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052569">w</span><span class="op" id="3052570">.</span><span class="ident" id="3052571">Header</span><span class="op" id="3052577">(</span><span class="op" id="3052578">)</span><span class="op" id="3052579">.</span><span class="ident" id="3052580">Set</span><span class="op" id="3052583">(</span><span class="string" id="3052584">&#34;Location&#34;</span><span class="op" id="3052594">,</span>&nbsp;<span class="ident" id="3052596">urlStr</span><span class="op" id="3052602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052605">w</span><span class="op" id="3052606">.</span><span class="ident" id="3052607">WriteHeader</span><span class="op" id="3052618">(</span><span class="ident" id="3052619">code</span><span class="op" id="3052623">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052627">//&nbsp;RFC2616&nbsp;recommends&nbsp;that&nbsp;a&nbsp;short&nbsp;note&nbsp;&#34;SHOULD&#34;&nbsp;be&nbsp;included&nbsp;in&nbsp;the</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052696">//&nbsp;response&nbsp;because&nbsp;older&nbsp;user&nbsp;agents&nbsp;may&nbsp;not&nbsp;understand&nbsp;301/307.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3052763">//&nbsp;Shouldn&#39;t&nbsp;send&nbsp;the&nbsp;response&nbsp;for&nbsp;POST&nbsp;or&nbsp;HEAD;&nbsp;that&nbsp;leaves&nbsp;GET.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3052830">if</span>&nbsp;<span class="ident" id="3052833">r</span><span class="op" id="3052834">.</span><span class="ident" id="3052835">Method</span>&nbsp;<span class="op" id="3052842">==</span>&nbsp;<span class="string" id="3052845">&#34;GET&#34;</span>&nbsp;<span class="op" id="3052851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052855">note</span>&nbsp;<span class="op" id="3052860">:=</span>&nbsp;<span class="string" id="3052863">&#34;&lt;a&nbsp;href=\&#34;&#34;</span>&nbsp;<span class="op" id="3052876">+</span>&nbsp;<span class="ident" id="3052878">htmlEscape</span><span class="op" id="3052888">(</span><span class="ident" id="3052889">urlStr</span><span class="op" id="3052895">)</span>&nbsp;<span class="op" id="3052897">+</span>&nbsp;<span class="string" id="3052899">&#34;\&#34;&gt;&#34;</span>&nbsp;<span class="op" id="3052905">+</span>&nbsp;<span class="ident" id="3052907">statusText</span><span class="op" id="3052917">[</span><span class="ident" id="3052918">code</span><span class="op" id="3052922">]</span>&nbsp;<span class="op" id="3052924">+</span>&nbsp;<span class="string" id="3052926">&#34;&lt;/a&gt;.\n&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3052938">fmt</span><span class="op" id="3052941">.</span><span class="ident" id="3052942">Fprintln</span><span class="op" id="3052950">(</span><span class="ident" id="3052951">w</span><span class="op" id="3052952">,</span>&nbsp;<span class="ident" id="3052954">note</span><span class="op" id="3052958">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3052961">}</span><br>
<span class="lineno"></span><span class="op" id="3052963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3052966">var</span>&nbsp;<span class="ident" id="3052970">htmlReplacer</span>&nbsp;<span class="op" id="3052983">=</span>&nbsp;<span class="ident" id="3052985">strings</span><span class="op" id="3052992">.</span><span class="ident" id="3052993">NewReplacer</span><span class="op" id="3053004">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3053007">&#34;&amp;&#34;</span><span class="op" id="3053010">,</span>&nbsp;<span class="string" id="3053012">&#34;&amp;amp;&#34;</span><span class="op" id="3053019">,</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3053022">&#34;&lt;&#34;</span><span class="op" id="3053025">,</span>&nbsp;<span class="string" id="3053027">&#34;&amp;lt;&#34;</span><span class="op" id="3053033">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3053036">&#34;&gt;&#34;</span><span class="op" id="3053039">,</span>&nbsp;<span class="string" id="3053041">&#34;&amp;gt;&#34;</span><span class="op" id="3053047">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3053050">//&nbsp;&#34;&amp;#34;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;quot;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3053088">`&#34;`</span><span class="op" id="3053091">,</span>&nbsp;<span class="string" id="3053093">&#34;&amp;#34;&#34;</span><span class="op" id="3053100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3053103">//&nbsp;&#34;&amp;#39;&#34;&nbsp;is&nbsp;shorter&nbsp;than&nbsp;&#34;&amp;apos;&#34;&nbsp;and&nbsp;apos&nbsp;was&nbsp;not&nbsp;in&nbsp;HTML&nbsp;until&nbsp;HTML5.</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3053178">&#34;&#39;&#34;</span><span class="op" id="3053181">,</span>&nbsp;<span class="string" id="3053183">&#34;&amp;#39;&#34;</span><span class="op" id="3053190">,</span><br>
<span class="lineno"></span><span class="op" id="3053192">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3053195">func</span>&nbsp;<span class="ident" id="3053200">htmlEscape</span><span class="op" id="3053210">(</span><span class="ident" id="3053211">s</span>&nbsp;<span class="builtintype" id="3053213">string</span><span class="op" id="3053219">)</span>&nbsp;<span class="builtintype" id="3053221">string</span>&nbsp;<span class="op" id="3053228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3053231">return</span>&nbsp;<span class="ident" id="3053238">htmlReplacer</span><span class="op" id="3053250">.</span><span class="ident" id="3053251">Replace</span><span class="op" id="3053258">(</span><span class="ident" id="3053259">s</span><span class="op" id="3053260">)</span><br>
<span class="lineno">1375</span><span class="op" id="3053262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3053265">//&nbsp;Redirect&nbsp;to&nbsp;a&nbsp;fixed&nbsp;URL</span><br>
<span class="lineno"></span><span class="keyword" id="3053292">type</span>&nbsp;<span class="ident" id="3053297">redirectHandler</span>&nbsp;<span class="keyword" id="3053313">struct</span>&nbsp;<span class="op" id="3053320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3053323">url</span>&nbsp;&nbsp;<span class="builtintype" id="3053328">string</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3053336">code</span>&nbsp;<span class="builtintype" id="3053341">int</span><br>
<span class="lineno"></span><span class="op" id="3053345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3053348">func</span>&nbsp;<span class="op" id="3053353">(</span><span class="ident" id="3053354">rh</span>&nbsp;<span class="op" id="3053357">*</span><span class="ident" id="3053358">redirectHandler</span><span class="op" id="3053373">)</span>&nbsp;<span class="ident" id="3053375">ServeHTTP</span><span class="op" id="3053384">(</span><span class="ident" id="3053385">w</span>&nbsp;<span class="ident" id="3053387">ResponseWriter</span><span class="op" id="3053401">,</span>&nbsp;<span class="ident" id="3053403">r</span>&nbsp;<span class="op" id="3053405">*</span><span class="ident" id="3053406">Request</span><span class="op" id="3053413">)</span>&nbsp;<span class="op" id="3053415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3053418">Redirect</span><span class="op" id="3053426">(</span><span class="ident" id="3053427">w</span><span class="op" id="3053428">,</span>&nbsp;<span class="ident" id="3053430">r</span><span class="op" id="3053431">,</span>&nbsp;<span class="ident" id="3053433">rh</span><span class="op" id="3053435">.</span><span class="ident" id="3053436">url</span><span class="op" id="3053439">,</span>&nbsp;<span class="ident" id="3053441">rh</span><span class="op" id="3053443">.</span><span class="ident" id="3053444">code</span><span class="op" id="3053448">)</span><br>
<span class="lineno">1385</span><span class="op" id="3053450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3053453">//&nbsp;RedirectHandler&nbsp;returns&nbsp;a&nbsp;request&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno"></span><span class="comment" id="3053513">//&nbsp;each&nbsp;request&nbsp;it&nbsp;receives&nbsp;to&nbsp;the&nbsp;given&nbsp;url&nbsp;using&nbsp;the&nbsp;given</span><br>
<span class="lineno"></span><span class="comment" id="3053574">//&nbsp;status&nbsp;code.</span><br>
<span class="lineno">1390</span><span class="keyword" id="3053590">func</span>&nbsp;<span class="ident" id="3053595">RedirectHandler</span><span class="op" id="3053610">(</span><span class="ident" id="3053611">url</span>&nbsp;<span class="builtintype" id="3053615">string</span><span class="op" id="3053621">,</span>&nbsp;<span class="ident" id="3053623">code</span>&nbsp;<span class="builtintype" id="3053628">int</span><span class="op" id="3053631">)</span>&nbsp;<span class="ident" id="3053633">Handler</span>&nbsp;<span class="op" id="3053641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3053644">return</span>&nbsp;<span class="op" id="3053651">&amp;</span><span class="ident" id="3053652">redirectHandler</span><span class="op" id="3053667">{</span><span class="ident" id="3053668">url</span><span class="op" id="3053671">,</span>&nbsp;<span class="ident" id="3053673">code</span><span class="op" id="3053677">}</span><br>
<span class="lineno"></span><span class="op" id="3053679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3053682">//&nbsp;ServeMux&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;request&nbsp;multiplexer.</span><br>
<span class="lineno">1395</span><span class="comment" id="3053726">//&nbsp;It&nbsp;matches&nbsp;the&nbsp;URL&nbsp;of&nbsp;each&nbsp;incoming&nbsp;request&nbsp;against&nbsp;a&nbsp;list&nbsp;of&nbsp;registered</span><br>
<span class="lineno"></span><span class="comment" id="3053802">//&nbsp;patterns&nbsp;and&nbsp;calls&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;pattern&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3053857">//&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;URL.</span><br>
<span class="lineno"></span><span class="comment" id="3053890">//</span><br>
<span class="lineno"></span><span class="comment" id="3053893">//&nbsp;Patterns&nbsp;name&nbsp;fixed,&nbsp;rooted&nbsp;paths,&nbsp;like&nbsp;&#34;/favicon.ico&#34;,</span><br>
<span class="lineno">1400</span><span class="comment" id="3053952">//&nbsp;or&nbsp;rooted&nbsp;subtrees,&nbsp;like&nbsp;&#34;/images/&#34;&nbsp;(note&nbsp;the&nbsp;trailing&nbsp;slash).</span><br>
<span class="lineno"></span><span class="comment" id="3054018">//&nbsp;Longer&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over&nbsp;shorter&nbsp;ones,&nbsp;so&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3054080">//&nbsp;if&nbsp;there&nbsp;are&nbsp;handlers&nbsp;registered&nbsp;for&nbsp;both&nbsp;&#34;/images/&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3054136">//&nbsp;and&nbsp;&#34;/images/thumbnails/&#34;,&nbsp;the&nbsp;latter&nbsp;handler&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3054193">//&nbsp;called&nbsp;for&nbsp;paths&nbsp;beginning&nbsp;&#34;/images/thumbnails/&#34;&nbsp;and&nbsp;the</span><br>
<span class="lineno">1405</span><span class="comment" id="3054253">//&nbsp;former&nbsp;will&nbsp;receive&nbsp;requests&nbsp;for&nbsp;any&nbsp;other&nbsp;paths&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3054312">//&nbsp;&#34;/images/&#34;&nbsp;subtree.</span><br>
<span class="lineno"></span><span class="comment" id="3054335">//</span><br>
<span class="lineno"></span><span class="comment" id="3054338">//&nbsp;Note&nbsp;that&nbsp;since&nbsp;a&nbsp;pattern&nbsp;ending&nbsp;in&nbsp;a&nbsp;slash&nbsp;names&nbsp;a&nbsp;rooted&nbsp;subtree,</span><br>
<span class="lineno"></span><span class="comment" id="3054409">//&nbsp;the&nbsp;pattern&nbsp;&#34;/&#34;&nbsp;matches&nbsp;all&nbsp;paths&nbsp;not&nbsp;matched&nbsp;by&nbsp;other&nbsp;registered</span><br>
<span class="lineno">1410</span><span class="comment" id="3054478">//&nbsp;patterns,&nbsp;not&nbsp;just&nbsp;the&nbsp;URL&nbsp;with&nbsp;Path&nbsp;==&nbsp;&#34;/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3054526">//</span><br>
<span class="lineno"></span><span class="comment" id="3054529">//&nbsp;Patterns&nbsp;may&nbsp;optionally&nbsp;begin&nbsp;with&nbsp;a&nbsp;host&nbsp;name,&nbsp;restricting&nbsp;matches&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3054603">//&nbsp;URLs&nbsp;on&nbsp;that&nbsp;host&nbsp;only.&nbsp;&nbsp;Host-specific&nbsp;patterns&nbsp;take&nbsp;precedence&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3054675">//&nbsp;general&nbsp;patterns,&nbsp;so&nbsp;that&nbsp;a&nbsp;handler&nbsp;might&nbsp;register&nbsp;for&nbsp;the&nbsp;two&nbsp;patterns</span><br>
<span class="lineno">1415</span><span class="comment" id="3054750">//&nbsp;&#34;/codesearch&#34;&nbsp;and&nbsp;&#34;codesearch.google.com/&#34;&nbsp;without&nbsp;also&nbsp;taking&nbsp;over</span><br>
<span class="lineno"></span><span class="comment" id="3054821">//&nbsp;requests&nbsp;for&nbsp;&#34;http://www.google.com/&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3054863">//</span><br>
<span class="lineno"></span><span class="comment" id="3054866">//&nbsp;ServeMux&nbsp;also&nbsp;takes&nbsp;care&nbsp;of&nbsp;sanitizing&nbsp;the&nbsp;URL&nbsp;request&nbsp;path,</span><br>
<span class="lineno"></span><span class="comment" id="3054930">//&nbsp;redirecting&nbsp;any&nbsp;request&nbsp;containing&nbsp;.&nbsp;or&nbsp;..&nbsp;elements&nbsp;to&nbsp;an</span><br>
<span class="lineno">1420</span><span class="comment" id="3054991">//&nbsp;equivalent&nbsp;.-&nbsp;and&nbsp;..-free&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3055025">type</span>&nbsp;<span class="ident" id="3055030">ServeMux</span>&nbsp;<span class="keyword" id="3055039">struct</span>&nbsp;<span class="op" id="3055046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055049">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055055">sync</span><span class="op" id="3055059">.</span><span class="ident" id="3055060">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055069">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055075">map</span><span class="op" id="3055078">[</span><span class="builtintype" id="3055079">string</span><span class="op" id="3055085">]</span><span class="ident" id="3055086">muxEntry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055096">hosts</span>&nbsp;<span class="builtintype" id="3055102">bool</span>&nbsp;<span class="comment" id="3055107">//&nbsp;whether&nbsp;any&nbsp;patterns&nbsp;contain&nbsp;hostnames</span><br>
<span class="lineno">1425</span><span class="op" id="3055149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3055152">type</span>&nbsp;<span class="ident" id="3055157">muxEntry</span>&nbsp;<span class="keyword" id="3055166">struct</span>&nbsp;<span class="op" id="3055173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055176">explicit</span>&nbsp;<span class="builtintype" id="3055185">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055191">h</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055200">Handler</span><br>
<span class="lineno">1430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055209">pattern</span>&nbsp;&nbsp;<span class="builtintype" id="3055218">string</span><br>
<span class="lineno"></span><span class="op" id="3055225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055228">//&nbsp;NewServeMux&nbsp;allocates&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="3055281">func</span>&nbsp;<span class="ident" id="3055286">NewServeMux</span><span class="op" id="3055297">(</span><span class="op" id="3055298">)</span>&nbsp;<span class="op" id="3055300">*</span><span class="ident" id="3055301">ServeMux</span>&nbsp;<span class="op" id="3055310">{</span>&nbsp;<span class="keyword" id="3055312">return</span>&nbsp;<span class="op" id="3055319">&amp;</span><span class="ident" id="3055320">ServeMux</span><span class="op" id="3055328">{</span><span class="ident" id="3055329">m</span><span class="op" id="3055330">:</span>&nbsp;<span class="builtinfunc" id="3055332">make</span><span class="op" id="3055336">(</span><span class="keyword" id="3055337">map</span><span class="op" id="3055340">[</span><span class="builtintype" id="3055341">string</span><span class="op" id="3055347">]</span><span class="ident" id="3055348">muxEntry</span><span class="op" id="3055356">)</span><span class="op" id="3055357">}</span>&nbsp;<span class="op" id="3055359">}</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span><span class="comment" id="3055362">//&nbsp;DefaultServeMux&nbsp;is&nbsp;the&nbsp;default&nbsp;ServeMux&nbsp;used&nbsp;by&nbsp;Serve.</span><br>
<span class="lineno"></span><span class="keyword" id="3055420">var</span>&nbsp;<span class="ident" id="3055424">DefaultServeMux</span>&nbsp;<span class="op" id="3055440">=</span>&nbsp;<span class="ident" id="3055442">NewServeMux</span><span class="op" id="3055453">(</span><span class="op" id="3055454">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055457">//&nbsp;Does&nbsp;path&nbsp;match&nbsp;pattern?</span><br>
<span class="lineno">1440</span><span class="keyword" id="3055485">func</span>&nbsp;<span class="ident" id="3055490">pathMatch</span><span class="op" id="3055499">(</span><span class="ident" id="3055500">pattern</span><span class="op" id="3055507">,</span>&nbsp;<span class="ident" id="3055509">path</span>&nbsp;<span class="builtintype" id="3055514">string</span><span class="op" id="3055520">)</span>&nbsp;<span class="builtintype" id="3055522">bool</span>&nbsp;<span class="op" id="3055527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055530">if</span>&nbsp;<span class="builtinfunc" id="3055533">len</span><span class="op" id="3055536">(</span><span class="ident" id="3055537">pattern</span><span class="op" id="3055544">)</span>&nbsp;<span class="op" id="3055546">==</span>&nbsp;<span class="num" id="3055549">0</span>&nbsp;<span class="op" id="3055551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3055555">//&nbsp;should&nbsp;not&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055578">return</span>&nbsp;<span class="builtintype" id="3055585">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3055592">}</span><br>
<span class="lineno">1445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055595">n</span>&nbsp;<span class="op" id="3055597">:=</span>&nbsp;<span class="builtinfunc" id="3055600">len</span><span class="op" id="3055603">(</span><span class="ident" id="3055604">pattern</span><span class="op" id="3055611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055614">if</span>&nbsp;<span class="ident" id="3055617">pattern</span><span class="op" id="3055624">[</span><span class="ident" id="3055625">n</span><span class="op" id="3055626">-</span><span class="num" id="3055627">1</span><span class="op" id="3055628">]</span>&nbsp;<span class="op" id="3055630">!=</span>&nbsp;<span class="string" id="3055633">&#39;/&#39;</span>&nbsp;<span class="op" id="3055637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055641">return</span>&nbsp;<span class="ident" id="3055648">pattern</span>&nbsp;<span class="op" id="3055656">==</span>&nbsp;<span class="ident" id="3055659">path</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3055665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055668">return</span>&nbsp;<span class="builtinfunc" id="3055675">len</span><span class="op" id="3055678">(</span><span class="ident" id="3055679">path</span><span class="op" id="3055683">)</span>&nbsp;<span class="op" id="3055685">&gt;=</span>&nbsp;<span class="ident" id="3055688">n</span>&nbsp;<span class="op" id="3055690">&amp;&amp;</span>&nbsp;<span class="ident" id="3055693">path</span><span class="op" id="3055697">[</span><span class="num" id="3055698">0</span><span class="op" id="3055699">:</span><span class="ident" id="3055700">n</span><span class="op" id="3055701">]</span>&nbsp;<span class="op" id="3055703">==</span>&nbsp;<span class="ident" id="3055706">pattern</span><br>
<span class="lineno">1450</span><span class="op" id="3055714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055717">//&nbsp;Return&nbsp;the&nbsp;canonical&nbsp;path&nbsp;for&nbsp;p,&nbsp;eliminating&nbsp;.&nbsp;and&nbsp;..&nbsp;elements.</span><br>
<span class="lineno"></span><span class="keyword" id="3055784">func</span>&nbsp;<span class="ident" id="3055789">cleanPath</span><span class="op" id="3055798">(</span><span class="ident" id="3055799">p</span>&nbsp;<span class="builtintype" id="3055801">string</span><span class="op" id="3055807">)</span>&nbsp;<span class="builtintype" id="3055809">string</span>&nbsp;<span class="op" id="3055816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055819">if</span>&nbsp;<span class="ident" id="3055822">p</span>&nbsp;<span class="op" id="3055824">==</span>&nbsp;<span class="string" id="3055827">&#34;&#34;</span>&nbsp;<span class="op" id="3055830">{</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055834">return</span>&nbsp;<span class="string" id="3055841">&#34;/&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3055846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3055849">if</span>&nbsp;<span class="ident" id="3055852">p</span><span class="op" id="3055853">[</span><span class="num" id="3055854">0</span><span class="op" id="3055855">]</span>&nbsp;<span class="op" id="3055857">!=</span>&nbsp;<span class="string" id="3055860">&#39;/&#39;</span>&nbsp;<span class="op" id="3055864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055868">p</span>&nbsp;<span class="op" id="3055870">=</span>&nbsp;<span class="string" id="3055872">&#34;/&#34;</span>&nbsp;<span class="op" id="3055876">+</span>&nbsp;<span class="ident" id="3055878">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3055881">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055884">np</span>&nbsp;<span class="op" id="3055887">:=</span>&nbsp;<span class="ident" id="3055890">path</span><span class="op" id="3055894">.</span><span class="ident" id="3055895">Clean</span><span class="op" id="3055900">(</span><span class="ident" id="3055901">p</span><span class="op" id="3055902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3055905">//&nbsp;path.Clean&nbsp;removes&nbsp;trailing&nbsp;slash&nbsp;except&nbsp;for&nbsp;root;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3055960">//&nbsp;put&nbsp;the&nbsp;trailing&nbsp;slash&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056006">if</span>&nbsp;<span class="ident" id="3056009">p</span><span class="op" id="3056010">[</span><span class="builtinfunc" id="3056011">len</span><span class="op" id="3056014">(</span><span class="ident" id="3056015">p</span><span class="op" id="3056016">)</span><span class="op" id="3056017">-</span><span class="num" id="3056018">1</span><span class="op" id="3056019">]</span>&nbsp;<span class="op" id="3056021">==</span>&nbsp;<span class="string" id="3056024">&#39;/&#39;</span>&nbsp;<span class="op" id="3056028">&amp;&amp;</span>&nbsp;<span class="ident" id="3056031">np</span>&nbsp;<span class="op" id="3056034">!=</span>&nbsp;<span class="string" id="3056037">&#34;/&#34;</span>&nbsp;<span class="op" id="3056041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056045">np</span>&nbsp;<span class="op" id="3056048">+=</span>&nbsp;<span class="string" id="3056051">&#34;/&#34;</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3056056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056059">return</span>&nbsp;<span class="ident" id="3056066">np</span><br>
<span class="lineno"></span><span class="op" id="3056069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3056072">//&nbsp;Find&nbsp;a&nbsp;handler&nbsp;on&nbsp;a&nbsp;handler&nbsp;map&nbsp;given&nbsp;a&nbsp;path&nbsp;string</span><br>
<span class="lineno">1470</span><span class="comment" id="3056127">//&nbsp;Most-specific&nbsp;(longest)&nbsp;pattern&nbsp;wins</span><br>
<span class="lineno"></span><span class="keyword" id="3056167">func</span>&nbsp;<span class="op" id="3056172">(</span><span class="ident" id="3056173">mux</span>&nbsp;<span class="op" id="3056177">*</span><span class="ident" id="3056178">ServeMux</span><span class="op" id="3056186">)</span>&nbsp;<span class="ident" id="3056188">match</span><span class="op" id="3056193">(</span><span class="ident" id="3056194">path</span>&nbsp;<span class="builtintype" id="3056199">string</span><span class="op" id="3056205">)</span>&nbsp;<span class="op" id="3056207">(</span><span class="ident" id="3056208">h</span>&nbsp;<span class="ident" id="3056210">Handler</span><span class="op" id="3056217">,</span>&nbsp;<span class="ident" id="3056219">pattern</span>&nbsp;<span class="builtintype" id="3056227">string</span><span class="op" id="3056233">)</span>&nbsp;<span class="op" id="3056235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056238">var</span>&nbsp;<span class="ident" id="3056242">n</span>&nbsp;<span class="op" id="3056244">=</span>&nbsp;<span class="num" id="3056246">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056249">for</span>&nbsp;<span class="ident" id="3056253">k</span><span class="op" id="3056254">,</span>&nbsp;<span class="ident" id="3056256">v</span>&nbsp;<span class="op" id="3056258">:=</span>&nbsp;<span class="keyword" id="3056261">range</span>&nbsp;<span class="ident" id="3056267">mux</span><span class="op" id="3056270">.</span><span class="ident" id="3056271">m</span>&nbsp;<span class="op" id="3056273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056277">if</span>&nbsp;<span class="op" id="3056280">!</span><span class="ident" id="3056281">pathMatch</span><span class="op" id="3056290">(</span><span class="ident" id="3056291">k</span><span class="op" id="3056292">,</span>&nbsp;<span class="ident" id="3056294">path</span><span class="op" id="3056298">)</span>&nbsp;<span class="op" id="3056300">{</span><br>
<span class="lineno">1475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056305">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3056316">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056320">if</span>&nbsp;<span class="ident" id="3056323">h</span>&nbsp;<span class="op" id="3056325">==</span>&nbsp;<span class="builtintype" id="3056328">nil</span>&nbsp;<span class="op" id="3056332">||</span>&nbsp;<span class="builtinfunc" id="3056335">len</span><span class="op" id="3056338">(</span><span class="ident" id="3056339">k</span><span class="op" id="3056340">)</span>&nbsp;<span class="op" id="3056342">&gt;</span>&nbsp;<span class="ident" id="3056344">n</span>&nbsp;<span class="op" id="3056346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056351">n</span>&nbsp;<span class="op" id="3056353">=</span>&nbsp;<span class="builtinfunc" id="3056355">len</span><span class="op" id="3056358">(</span><span class="ident" id="3056359">k</span><span class="op" id="3056360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056365">h</span>&nbsp;<span class="op" id="3056367">=</span>&nbsp;<span class="ident" id="3056369">v</span><span class="op" id="3056370">.</span><span class="ident" id="3056371">h</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056376">pattern</span>&nbsp;<span class="op" id="3056384">=</span>&nbsp;<span class="ident" id="3056386">v</span><span class="op" id="3056387">.</span><span class="ident" id="3056388">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3056398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3056401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3056404">return</span><br>
<span class="lineno"></span><span class="op" id="3056411">}</span><br>
<span class="lineno">1485</span><br>
<span class="lineno"></span><span class="comment" id="3056414">//&nbsp;Handler&nbsp;returns&nbsp;the&nbsp;handler&nbsp;to&nbsp;use&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3056475">//&nbsp;consulting&nbsp;r.Method,&nbsp;r.Host,&nbsp;and&nbsp;r.URL.Path.&nbsp;It&nbsp;always&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3056541">//&nbsp;a&nbsp;non-nil&nbsp;handler.&nbsp;If&nbsp;the&nbsp;path&nbsp;is&nbsp;not&nbsp;in&nbsp;its&nbsp;canonical&nbsp;form,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3056609">//&nbsp;handler&nbsp;will&nbsp;be&nbsp;an&nbsp;internally-generated&nbsp;handler&nbsp;that&nbsp;redirects</span><br>
<span class="lineno">1490</span><span class="comment" id="3056675">//&nbsp;to&nbsp;the&nbsp;canonical&nbsp;path.</span><br>
<span class="lineno"></span><span class="comment" id="3056701">//</span><br>
<span class="lineno"></span><span class="comment" id="3056704">//&nbsp;Handler&nbsp;also&nbsp;returns&nbsp;the&nbsp;registered&nbsp;pattern&nbsp;that&nbsp;matches&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3056768">//&nbsp;request&nbsp;or,&nbsp;in&nbsp;the&nbsp;case&nbsp;of&nbsp;internally-generated&nbsp;redirects,</span><br>
<span class="lineno"></span><span class="comment" id="3056830">//&nbsp;the&nbsp;pattern&nbsp;that&nbsp;will&nbsp;match&nbsp;after&nbsp;following&nbsp;the&nbsp;redirect.</span><br>
<span class="lineno">1495</span><span class="comment" id="3056891">//</span><br>
<span class="lineno"></span><span class="comment" id="3056894">//&nbsp;If&nbsp;there&nbsp;is&nbsp;no&nbsp;registered&nbsp;handler&nbsp;that&nbsp;applies&nbsp;to&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3056960">//&nbsp;Handler&nbsp;returns&nbsp;a&nbsp;``page&nbsp;not&nbsp;found&#39;&#39;&nbsp;handler&nbsp;and&nbsp;an&nbsp;empty&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3057030">func</span>&nbsp;<span class="op" id="3057035">(</span><span class="ident" id="3057036">mux</span>&nbsp;<span class="op" id="3057040">*</span><span class="ident" id="3057041">ServeMux</span><span class="op" id="3057049">)</span>&nbsp;<span class="ident" id="3057051">Handler</span><span class="op" id="3057058">(</span><span class="ident" id="3057059">r</span>&nbsp;<span class="op" id="3057061">*</span><span class="ident" id="3057062">Request</span><span class="op" id="3057069">)</span>&nbsp;<span class="op" id="3057071">(</span><span class="ident" id="3057072">h</span>&nbsp;<span class="ident" id="3057074">Handler</span><span class="op" id="3057081">,</span>&nbsp;<span class="ident" id="3057083">pattern</span>&nbsp;<span class="builtintype" id="3057091">string</span><span class="op" id="3057097">)</span>&nbsp;<span class="op" id="3057099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057102">if</span>&nbsp;<span class="ident" id="3057105">r</span><span class="op" id="3057106">.</span><span class="ident" id="3057107">Method</span>&nbsp;<span class="op" id="3057114">!=</span>&nbsp;<span class="string" id="3057117">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="3057127">{</span><br>
<span class="lineno">1500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057131">if</span>&nbsp;<span class="ident" id="3057134">p</span>&nbsp;<span class="op" id="3057136">:=</span>&nbsp;<span class="ident" id="3057139">cleanPath</span><span class="op" id="3057148">(</span><span class="ident" id="3057149">r</span><span class="op" id="3057150">.</span><span class="ident" id="3057151">URL</span><span class="op" id="3057154">.</span><span class="ident" id="3057155">Path</span><span class="op" id="3057159">)</span><span class="op" id="3057160">;</span>&nbsp;<span class="ident" id="3057162">p</span>&nbsp;<span class="op" id="3057164">!=</span>&nbsp;<span class="ident" id="3057167">r</span><span class="op" id="3057168">.</span><span class="ident" id="3057169">URL</span><span class="op" id="3057172">.</span><span class="ident" id="3057173">Path</span>&nbsp;<span class="op" id="3057178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057183">_</span><span class="op" id="3057184">,</span>&nbsp;<span class="ident" id="3057186">pattern</span>&nbsp;<span class="op" id="3057194">=</span>&nbsp;<span class="ident" id="3057196">mux</span><span class="op" id="3057199">.</span><span class="ident" id="3057200">handler</span><span class="op" id="3057207">(</span><span class="ident" id="3057208">r</span><span class="op" id="3057209">.</span><span class="ident" id="3057210">Host</span><span class="op" id="3057214">,</span>&nbsp;<span class="ident" id="3057216">p</span><span class="op" id="3057217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057222">url</span>&nbsp;<span class="op" id="3057226">:=</span>&nbsp;<span class="op" id="3057229">*</span><span class="ident" id="3057230">r</span><span class="op" id="3057231">.</span><span class="ident" id="3057232">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057239">url</span><span class="op" id="3057242">.</span><span class="ident" id="3057243">Path</span>&nbsp;<span class="op" id="3057248">=</span>&nbsp;<span class="ident" id="3057250">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057255">return</span>&nbsp;<span class="ident" id="3057262">RedirectHandler</span><span class="op" id="3057277">(</span><span class="ident" id="3057278">url</span><span class="op" id="3057281">.</span><span class="ident" id="3057282">String</span><span class="op" id="3057288">(</span><span class="op" id="3057289">)</span><span class="op" id="3057290">,</span>&nbsp;<span class="ident" id="3057292">StatusMovedPermanently</span><span class="op" id="3057314">)</span><span class="op" id="3057315">,</span>&nbsp;<span class="ident" id="3057317">pattern</span><br>
<span class="lineno">1505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057330">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057334">return</span>&nbsp;<span class="ident" id="3057341">mux</span><span class="op" id="3057344">.</span><span class="ident" id="3057345">handler</span><span class="op" id="3057352">(</span><span class="ident" id="3057353">r</span><span class="op" id="3057354">.</span><span class="ident" id="3057355">Host</span><span class="op" id="3057359">,</span>&nbsp;<span class="ident" id="3057361">r</span><span class="op" id="3057362">.</span><span class="ident" id="3057363">URL</span><span class="op" id="3057366">.</span><span class="ident" id="3057367">Path</span><span class="op" id="3057371">)</span><br>
<span class="lineno"></span><span class="op" id="3057373">}</span><br>
<span class="lineno">1510</span><br>
<span class="lineno"></span><span class="comment" id="3057376">//&nbsp;handler&nbsp;is&nbsp;the&nbsp;main&nbsp;implementation&nbsp;of&nbsp;Handler.</span><br>
<span class="lineno"></span><span class="comment" id="3057426">//&nbsp;The&nbsp;path&nbsp;is&nbsp;known&nbsp;to&nbsp;be&nbsp;in&nbsp;canonical&nbsp;form,&nbsp;except&nbsp;for&nbsp;CONNECT&nbsp;methods.</span><br>
<span class="lineno"></span><span class="keyword" id="3057500">func</span>&nbsp;<span class="op" id="3057505">(</span><span class="ident" id="3057506">mux</span>&nbsp;<span class="op" id="3057510">*</span><span class="ident" id="3057511">ServeMux</span><span class="op" id="3057519">)</span>&nbsp;<span class="ident" id="3057521">handler</span><span class="op" id="3057528">(</span><span class="ident" id="3057529">host</span><span class="op" id="3057533">,</span>&nbsp;<span class="ident" id="3057535">path</span>&nbsp;<span class="builtintype" id="3057540">string</span><span class="op" id="3057546">)</span>&nbsp;<span class="op" id="3057548">(</span><span class="ident" id="3057549">h</span>&nbsp;<span class="ident" id="3057551">Handler</span><span class="op" id="3057558">,</span>&nbsp;<span class="ident" id="3057560">pattern</span>&nbsp;<span class="builtintype" id="3057568">string</span><span class="op" id="3057574">)</span>&nbsp;<span class="op" id="3057576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057579">mux</span><span class="op" id="3057582">.</span><span class="ident" id="3057583">mu</span><span class="op" id="3057585">.</span><span class="ident" id="3057586">RLock</span><span class="op" id="3057591">(</span><span class="op" id="3057592">)</span><br>
<span class="lineno">1515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057595">defer</span>&nbsp;<span class="ident" id="3057601">mux</span><span class="op" id="3057604">.</span><span class="ident" id="3057605">mu</span><span class="op" id="3057607">.</span><span class="ident" id="3057608">RUnlock</span><span class="op" id="3057615">(</span><span class="op" id="3057616">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3057620">//&nbsp;Host-specific&nbsp;pattern&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;generic&nbsp;ones</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057681">if</span>&nbsp;<span class="ident" id="3057684">mux</span><span class="op" id="3057687">.</span><span class="ident" id="3057688">hosts</span>&nbsp;<span class="op" id="3057694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057698">h</span><span class="op" id="3057699">,</span>&nbsp;<span class="ident" id="3057701">pattern</span>&nbsp;<span class="op" id="3057709">=</span>&nbsp;<span class="ident" id="3057711">mux</span><span class="op" id="3057714">.</span><span class="ident" id="3057715">match</span><span class="op" id="3057720">(</span><span class="ident" id="3057721">host</span>&nbsp;<span class="op" id="3057726">+</span>&nbsp;<span class="ident" id="3057728">path</span><span class="op" id="3057732">)</span><br>
<span class="lineno">1520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057738">if</span>&nbsp;<span class="ident" id="3057741">h</span>&nbsp;<span class="op" id="3057743">==</span>&nbsp;<span class="builtintype" id="3057746">nil</span>&nbsp;<span class="op" id="3057750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057754">h</span><span class="op" id="3057755">,</span>&nbsp;<span class="ident" id="3057757">pattern</span>&nbsp;<span class="op" id="3057765">=</span>&nbsp;<span class="ident" id="3057767">mux</span><span class="op" id="3057770">.</span><span class="ident" id="3057771">match</span><span class="op" id="3057776">(</span><span class="ident" id="3057777">path</span><span class="op" id="3057781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057787">if</span>&nbsp;<span class="ident" id="3057790">h</span>&nbsp;<span class="op" id="3057792">==</span>&nbsp;<span class="builtintype" id="3057795">nil</span>&nbsp;<span class="op" id="3057799">{</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057803">h</span><span class="op" id="3057804">,</span>&nbsp;<span class="ident" id="3057806">pattern</span>&nbsp;<span class="op" id="3057814">=</span>&nbsp;<span class="ident" id="3057816">NotFoundHandler</span><span class="op" id="3057831">(</span><span class="op" id="3057832">)</span><span class="op" id="3057833">,</span>&nbsp;<span class="string" id="3057835">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057842">return</span><br>
<span class="lineno"></span><span class="op" id="3057849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1530</span><span class="comment" id="3057852">//&nbsp;ServeHTTP&nbsp;dispatches&nbsp;the&nbsp;request&nbsp;to&nbsp;the&nbsp;handler&nbsp;whose</span><br>
<span class="lineno"></span><span class="comment" id="3057909">//&nbsp;pattern&nbsp;most&nbsp;closely&nbsp;matches&nbsp;the&nbsp;request&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3057958">func</span>&nbsp;<span class="op" id="3057963">(</span><span class="ident" id="3057964">mux</span>&nbsp;<span class="op" id="3057968">*</span><span class="ident" id="3057969">ServeMux</span><span class="op" id="3057977">)</span>&nbsp;<span class="ident" id="3057979">ServeHTTP</span><span class="op" id="3057988">(</span><span class="ident" id="3057989">w</span>&nbsp;<span class="ident" id="3057991">ResponseWriter</span><span class="op" id="3058005">,</span>&nbsp;<span class="ident" id="3058007">r</span>&nbsp;<span class="op" id="3058009">*</span><span class="ident" id="3058010">Request</span><span class="op" id="3058017">)</span>&nbsp;<span class="op" id="3058019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058022">if</span>&nbsp;<span class="ident" id="3058025">r</span><span class="op" id="3058026">.</span><span class="ident" id="3058027">RequestURI</span>&nbsp;<span class="op" id="3058038">==</span>&nbsp;<span class="string" id="3058041">&#34;*&#34;</span>&nbsp;<span class="op" id="3058045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058049">if</span>&nbsp;<span class="ident" id="3058052">r</span><span class="op" id="3058053">.</span><span class="ident" id="3058054">ProtoAtLeast</span><span class="op" id="3058066">(</span><span class="num" id="3058067">1</span><span class="op" id="3058068">,</span>&nbsp;<span class="num" id="3058070">1</span><span class="op" id="3058071">)</span>&nbsp;<span class="op" id="3058073">{</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058078">w</span><span class="op" id="3058079">.</span><span class="ident" id="3058080">Header</span><span class="op" id="3058086">(</span><span class="op" id="3058087">)</span><span class="op" id="3058088">.</span><span class="ident" id="3058089">Set</span><span class="op" id="3058092">(</span><span class="string" id="3058093">&#34;Connection&#34;</span><span class="op" id="3058105">,</span>&nbsp;<span class="string" id="3058107">&#34;close&#34;</span><span class="op" id="3058114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058122">w</span><span class="op" id="3058123">.</span><span class="ident" id="3058124">WriteHeader</span><span class="op" id="3058135">(</span><span class="ident" id="3058136">StatusBadRequest</span><span class="op" id="3058152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058156">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058164">}</span><br>
<span class="lineno">1540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058167">h</span><span class="op" id="3058168">,</span>&nbsp;<span class="ident" id="3058170">_</span>&nbsp;<span class="op" id="3058172">:=</span>&nbsp;<span class="ident" id="3058175">mux</span><span class="op" id="3058178">.</span><span class="ident" id="3058179">Handler</span><span class="op" id="3058186">(</span><span class="ident" id="3058187">r</span><span class="op" id="3058188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058191">h</span><span class="op" id="3058192">.</span><span class="ident" id="3058193">ServeHTTP</span><span class="op" id="3058202">(</span><span class="ident" id="3058203">w</span><span class="op" id="3058204">,</span>&nbsp;<span class="ident" id="3058206">r</span><span class="op" id="3058207">)</span><br>
<span class="lineno"></span><span class="op" id="3058209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3058212">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno">1545</span><span class="comment" id="3058267">//&nbsp;If&nbsp;a&nbsp;handler&nbsp;already&nbsp;exists&nbsp;for&nbsp;pattern,&nbsp;Handle&nbsp;panics.</span><br>
<span class="lineno"></span><span class="keyword" id="3058326">func</span>&nbsp;<span class="op" id="3058331">(</span><span class="ident" id="3058332">mux</span>&nbsp;<span class="op" id="3058336">*</span><span class="ident" id="3058337">ServeMux</span><span class="op" id="3058345">)</span>&nbsp;<span class="ident" id="3058347">Handle</span><span class="op" id="3058353">(</span><span class="ident" id="3058354">pattern</span>&nbsp;<span class="builtintype" id="3058362">string</span><span class="op" id="3058368">,</span>&nbsp;<span class="ident" id="3058370">handler</span>&nbsp;<span class="ident" id="3058378">Handler</span><span class="op" id="3058385">)</span>&nbsp;<span class="op" id="3058387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058390">mux</span><span class="op" id="3058393">.</span><span class="ident" id="3058394">mu</span><span class="op" id="3058396">.</span><span class="ident" id="3058397">Lock</span><span class="op" id="3058401">(</span><span class="op" id="3058402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058405">defer</span>&nbsp;<span class="ident" id="3058411">mux</span><span class="op" id="3058414">.</span><span class="ident" id="3058415">mu</span><span class="op" id="3058417">.</span><span class="ident" id="3058418">Unlock</span><span class="op" id="3058424">(</span><span class="op" id="3058425">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058429">if</span>&nbsp;<span class="ident" id="3058432">pattern</span>&nbsp;<span class="op" id="3058440">==</span>&nbsp;<span class="string" id="3058443">&#34;&#34;</span>&nbsp;<span class="op" id="3058446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058450">panic</span><span class="op" id="3058455">(</span><span class="string" id="3058456">&#34;http:&nbsp;invalid&nbsp;pattern&nbsp;&#34;</span>&nbsp;<span class="op" id="3058481">+</span>&nbsp;<span class="ident" id="3058483">pattern</span><span class="op" id="3058490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058496">if</span>&nbsp;<span class="ident" id="3058499">handler</span>&nbsp;<span class="op" id="3058507">==</span>&nbsp;<span class="builtintype" id="3058510">nil</span>&nbsp;<span class="op" id="3058514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058518">panic</span><span class="op" id="3058523">(</span><span class="string" id="3058524">&#34;http:&nbsp;nil&nbsp;handler&#34;</span><span class="op" id="3058543">)</span><br>
<span class="lineno">1555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058549">if</span>&nbsp;<span class="ident" id="3058552">mux</span><span class="op" id="3058555">.</span><span class="ident" id="3058556">m</span><span class="op" id="3058557">[</span><span class="ident" id="3058558">pattern</span><span class="op" id="3058565">]</span><span class="op" id="3058566">.</span><span class="ident" id="3058567">explicit</span>&nbsp;<span class="op" id="3058576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058580">panic</span><span class="op" id="3058585">(</span><span class="string" id="3058586">&#34;http:&nbsp;multiple&nbsp;registrations&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="3058622">+</span>&nbsp;<span class="ident" id="3058624">pattern</span><span class="op" id="3058631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058638">mux</span><span class="op" id="3058641">.</span><span class="ident" id="3058642">m</span><span class="op" id="3058643">[</span><span class="ident" id="3058644">pattern</span><span class="op" id="3058651">]</span>&nbsp;<span class="op" id="3058653">=</span>&nbsp;<span class="ident" id="3058655">muxEntry</span><span class="op" id="3058663">{</span><span class="ident" id="3058664">explicit</span><span class="op" id="3058672">:</span>&nbsp;<span class="builtintype" id="3058674">true</span><span class="op" id="3058678">,</span>&nbsp;<span class="ident" id="3058680">h</span><span class="op" id="3058681">:</span>&nbsp;<span class="ident" id="3058683">handler</span><span class="op" id="3058690">,</span>&nbsp;<span class="ident" id="3058692">pattern</span><span class="op" id="3058699">:</span>&nbsp;<span class="ident" id="3058701">pattern</span><span class="op" id="3058708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058712">if</span>&nbsp;<span class="ident" id="3058715">pattern</span><span class="op" id="3058722">[</span><span class="num" id="3058723">0</span><span class="op" id="3058724">]</span>&nbsp;<span class="op" id="3058726">!=</span>&nbsp;<span class="string" id="3058729">&#39;/&#39;</span>&nbsp;<span class="op" id="3058733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058737">mux</span><span class="op" id="3058740">.</span><span class="ident" id="3058741">hosts</span>&nbsp;<span class="op" id="3058747">=</span>&nbsp;<span class="builtintype" id="3058749">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058755">}</span><br>
<span class="lineno">1565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058759">//&nbsp;Helpful&nbsp;behavior:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058781">//&nbsp;If&nbsp;pattern&nbsp;is&nbsp;/tree/,&nbsp;insert&nbsp;an&nbsp;implicit&nbsp;permanent&nbsp;redirect&nbsp;for&nbsp;/tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058856">//&nbsp;It&nbsp;can&nbsp;be&nbsp;overridden&nbsp;by&nbsp;an&nbsp;explicit&nbsp;registration.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058910">n</span>&nbsp;<span class="op" id="3058912">:=</span>&nbsp;<span class="builtinfunc" id="3058915">len</span><span class="op" id="3058918">(</span><span class="ident" id="3058919">pattern</span><span class="op" id="3058926">)</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058929">if</span>&nbsp;<span class="ident" id="3058932">n</span>&nbsp;<span class="op" id="3058934">&gt;</span>&nbsp;<span class="num" id="3058936">0</span>&nbsp;<span class="op" id="3058938">&amp;&amp;</span>&nbsp;<span class="ident" id="3058941">pattern</span><span class="op" id="3058948">[</span><span class="ident" id="3058949">n</span><span class="op" id="3058950">-</span><span class="num" id="3058951">1</span><span class="op" id="3058952">]</span>&nbsp;<span class="op" id="3058954">==</span>&nbsp;<span class="string" id="3058957">&#39;/&#39;</span>&nbsp;<span class="op" id="3058961">&amp;&amp;</span>&nbsp;<span class="op" id="3058964">!</span><span class="ident" id="3058965">mux</span><span class="op" id="3058968">.</span><span class="ident" id="3058969">m</span><span class="op" id="3058970">[</span><span class="ident" id="3058971">pattern</span><span class="op" id="3058978">[</span><span class="num" id="3058979">0</span><span class="op" id="3058980">:</span><span class="ident" id="3058981">n</span><span class="op" id="3058982">-</span><span class="num" id="3058983">1</span><span class="op" id="3058984">]</span><span class="op" id="3058985">]</span><span class="op" id="3058986">.</span><span class="ident" id="3058987">explicit</span>&nbsp;<span class="op" id="3058996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059000">//&nbsp;If&nbsp;pattern&nbsp;contains&nbsp;a&nbsp;host&nbsp;name,&nbsp;strip&nbsp;it&nbsp;and&nbsp;use&nbsp;remaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059065">//&nbsp;path&nbsp;for&nbsp;redirect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059089">path</span>&nbsp;<span class="op" id="3059094">:=</span>&nbsp;<span class="ident" id="3059097">pattern</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059107">if</span>&nbsp;<span class="ident" id="3059110">pattern</span><span class="op" id="3059117">[</span><span class="num" id="3059118">0</span><span class="op" id="3059119">]</span>&nbsp;<span class="op" id="3059121">!=</span>&nbsp;<span class="string" id="3059124">&#39;/&#39;</span>&nbsp;<span class="op" id="3059128">{</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059133">//&nbsp;In&nbsp;pattern,&nbsp;at&nbsp;least&nbsp;the&nbsp;last&nbsp;character&nbsp;is&nbsp;a&nbsp;&#39;/&#39;,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059192">//&nbsp;strings.Index&nbsp;can&#39;t&nbsp;be&nbsp;-1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059225">path</span>&nbsp;<span class="op" id="3059230">=</span>&nbsp;<span class="ident" id="3059232">pattern</span><span class="op" id="3059239">[</span><span class="ident" id="3059240">strings</span><span class="op" id="3059247">.</span><span class="ident" id="3059248">Index</span><span class="op" id="3059253">(</span><span class="ident" id="3059254">pattern</span><span class="op" id="3059261">,</span>&nbsp;<span class="string" id="3059263">&#34;/&#34;</span><span class="op" id="3059266">)</span><span class="op" id="3059267">:</span><span class="op" id="3059268">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059276">mux</span><span class="op" id="3059279">.</span><span class="ident" id="3059280">m</span><span class="op" id="3059281">[</span><span class="ident" id="3059282">pattern</span><span class="op" id="3059289">[</span><span class="num" id="3059290">0</span><span class="op" id="3059291">:</span><span class="ident" id="3059292">n</span><span class="op" id="3059293">-</span><span class="num" id="3059294">1</span><span class="op" id="3059295">]</span><span class="op" id="3059296">]</span>&nbsp;<span class="op" id="3059298">=</span>&nbsp;<span class="ident" id="3059300">muxEntry</span><span class="op" id="3059308">{</span><span class="ident" id="3059309">h</span><span class="op" id="3059310">:</span>&nbsp;<span class="ident" id="3059312">RedirectHandler</span><span class="op" id="3059327">(</span><span class="ident" id="3059328">path</span><span class="op" id="3059332">,</span>&nbsp;<span class="ident" id="3059334">StatusMovedPermanently</span><span class="op" id="3059356">)</span><span class="op" id="3059357">,</span>&nbsp;<span class="ident" id="3059359">pattern</span><span class="op" id="3059366">:</span>&nbsp;<span class="ident" id="3059368">pattern</span><span class="op" id="3059375">}</span><br>
<span class="lineno">1580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059378">}</span><br>
<span class="lineno"></span><span class="op" id="3059380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3059383">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern.</span><br>
<span class="lineno"></span><span class="keyword" id="3059451">func</span>&nbsp;<span class="op" id="3059456">(</span><span class="ident" id="3059457">mux</span>&nbsp;<span class="op" id="3059461">*</span><span class="ident" id="3059462">ServeMux</span><span class="op" id="3059470">)</span>&nbsp;<span class="ident" id="3059472">HandleFunc</span><span class="op" id="3059482">(</span><span class="ident" id="3059483">pattern</span>&nbsp;<span class="builtintype" id="3059491">string</span><span class="op" id="3059497">,</span>&nbsp;<span class="ident" id="3059499">handler</span>&nbsp;<span class="keyword" id="3059507">func</span><span class="op" id="3059511">(</span><span class="ident" id="3059512">ResponseWriter</span><span class="op" id="3059526">,</span>&nbsp;<span class="op" id="3059528">*</span><span class="ident" id="3059529">Request</span><span class="op" id="3059536">)</span><span class="op" id="3059537">)</span>&nbsp;<span class="op" id="3059539">{</span><br>
<span class="lineno">1585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059542">mux</span><span class="op" id="3059545">.</span><span class="ident" id="3059546">Handle</span><span class="op" id="3059552">(</span><span class="ident" id="3059553">pattern</span><span class="op" id="3059560">,</span>&nbsp;<span class="ident" id="3059562">HandlerFunc</span><span class="op" id="3059573">(</span><span class="ident" id="3059574">handler</span><span class="op" id="3059581">)</span><span class="op" id="3059582">)</span><br>
<span class="lineno"></span><span class="op" id="3059584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3059587">//&nbsp;Handle&nbsp;registers&nbsp;the&nbsp;handler&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3059641">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1590</span><span class="comment" id="3059668">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3059737">func</span>&nbsp;<span class="ident" id="3059742">Handle</span><span class="op" id="3059748">(</span><span class="ident" id="3059749">pattern</span>&nbsp;<span class="builtintype" id="3059757">string</span><span class="op" id="3059763">,</span>&nbsp;<span class="ident" id="3059765">handler</span>&nbsp;<span class="ident" id="3059773">Handler</span><span class="op" id="3059780">)</span>&nbsp;<span class="op" id="3059782">{</span>&nbsp;<span class="ident" id="3059784">DefaultServeMux</span><span class="op" id="3059799">.</span><span class="ident" id="3059800">Handle</span><span class="op" id="3059806">(</span><span class="ident" id="3059807">pattern</span><span class="op" id="3059814">,</span>&nbsp;<span class="ident" id="3059816">handler</span><span class="op" id="3059823">)</span>&nbsp;<span class="op" id="3059825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3059828">//&nbsp;HandleFunc&nbsp;registers&nbsp;the&nbsp;handler&nbsp;function&nbsp;for&nbsp;the&nbsp;given&nbsp;pattern</span><br>
<span class="lineno"></span><span class="comment" id="3059895">//&nbsp;in&nbsp;the&nbsp;DefaultServeMux.</span><br>
<span class="lineno">1595</span><span class="comment" id="3059922">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;ServeMux&nbsp;explains&nbsp;how&nbsp;patterns&nbsp;are&nbsp;matched.</span><br>
<span class="lineno"></span><span class="keyword" id="3059991">func</span>&nbsp;<span class="ident" id="3059996">HandleFunc</span><span class="op" id="3060006">(</span><span class="ident" id="3060007">pattern</span>&nbsp;<span class="builtintype" id="3060015">string</span><span class="op" id="3060021">,</span>&nbsp;<span class="ident" id="3060023">handler</span>&nbsp;<span class="keyword" id="3060031">func</span><span class="op" id="3060035">(</span><span class="ident" id="3060036">ResponseWriter</span><span class="op" id="3060050">,</span>&nbsp;<span class="op" id="3060052">*</span><span class="ident" id="3060053">Request</span><span class="op" id="3060060">)</span><span class="op" id="3060061">)</span>&nbsp;<span class="op" id="3060063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060066">DefaultServeMux</span><span class="op" id="3060081">.</span><span class="ident" id="3060082">HandleFunc</span><span class="op" id="3060092">(</span><span class="ident" id="3060093">pattern</span><span class="op" id="3060100">,</span>&nbsp;<span class="ident" id="3060102">handler</span><span class="op" id="3060109">)</span><br>
<span class="lineno"></span><span class="op" id="3060111">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3060114">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;HTTP&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,</span><br>
<span class="lineno"></span><span class="comment" id="3060176">//&nbsp;creating&nbsp;a&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3060246">//&nbsp;read&nbsp;requests&nbsp;and&nbsp;then&nbsp;call&nbsp;handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="3060303">//&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3060375">func</span>&nbsp;<span class="ident" id="3060380">Serve</span><span class="op" id="3060385">(</span><span class="ident" id="3060386">l</span>&nbsp;<span class="ident" id="3060388">net</span><span class="op" id="3060391">.</span><span class="ident" id="3060392">Listener</span><span class="op" id="3060400">,</span>&nbsp;<span class="ident" id="3060402">handler</span>&nbsp;<span class="ident" id="3060410">Handler</span><span class="op" id="3060417">)</span>&nbsp;<span class="builtintype" id="3060419">error</span>&nbsp;<span class="op" id="3060425">{</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060428">srv</span>&nbsp;<span class="op" id="3060432">:=</span>&nbsp;<span class="op" id="3060435">&amp;</span><span class="ident" id="3060436">Server</span><span class="op" id="3060442">{</span><span class="ident" id="3060443">Handler</span><span class="op" id="3060450">:</span>&nbsp;<span class="ident" id="3060452">handler</span><span class="op" id="3060459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3060462">return</span>&nbsp;<span class="ident" id="3060469">srv</span><span class="op" id="3060472">.</span><span class="ident" id="3060473">Serve</span><span class="op" id="3060478">(</span><span class="ident" id="3060479">l</span><span class="op" id="3060480">)</span><br>
<span class="lineno"></span><span class="op" id="3060482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3060485">//&nbsp;A&nbsp;Server&nbsp;defines&nbsp;parameters&nbsp;for&nbsp;running&nbsp;an&nbsp;HTTP&nbsp;server.</span><br>
<span class="lineno">1610</span><span class="comment" id="3060544">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;Server&nbsp;is&nbsp;a&nbsp;valid&nbsp;configuration.</span><br>
<span class="lineno"></span><span class="keyword" id="3060599">type</span>&nbsp;<span class="ident" id="3060604">Server</span>&nbsp;<span class="keyword" id="3060611">struct</span>&nbsp;<span class="op" id="3060618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060621">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3060636">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3060650">//&nbsp;TCP&nbsp;address&nbsp;to&nbsp;listen&nbsp;on,&nbsp;&#34;:http&#34;&nbsp;if&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060697">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060712">Handler</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3060726">//&nbsp;handler&nbsp;to&nbsp;invoke,&nbsp;http.DefaultServeMux&nbsp;if&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060777">ReadTimeout</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060792">time</span><span class="op" id="3060796">.</span><span class="ident" id="3060797">Duration</span>&nbsp;<span class="comment" id="3060806">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;read&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060865">WriteTimeout</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3060880">time</span><span class="op" id="3060884">.</span><span class="ident" id="3060885">Duration</span>&nbsp;<span class="comment" id="3060894">//&nbsp;maximum&nbsp;duration&nbsp;before&nbsp;timing&nbsp;out&nbsp;write&nbsp;of&nbsp;the&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3060955">MaxHeaderBytes</span>&nbsp;<span class="builtintype" id="3060970">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3060984">//&nbsp;maximum&nbsp;size&nbsp;of&nbsp;request&nbsp;headers,&nbsp;DefaultMaxHeaderBytes&nbsp;if&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3061048">TLSConfig</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3061063">*</span><span class="ident" id="3061064">tls</span><span class="op" id="3061067">.</span><span class="ident" id="3061068">Config</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3061077">//&nbsp;optional&nbsp;TLS&nbsp;config,&nbsp;used&nbsp;by&nbsp;ListenAndServeTLS</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061129">//&nbsp;TLSNextProto&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;take&nbsp;over</span><br>
<span class="lineno">1620</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061191">//&nbsp;ownership&nbsp;of&nbsp;the&nbsp;provided&nbsp;TLS&nbsp;connection&nbsp;when&nbsp;an&nbsp;NPN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061248">//&nbsp;protocol&nbsp;upgrade&nbsp;has&nbsp;occurred.&nbsp;&nbsp;The&nbsp;map&nbsp;key&nbsp;is&nbsp;the&nbsp;protocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061312">//&nbsp;name&nbsp;negotiated.&nbsp;The&nbsp;Handler&nbsp;argument&nbsp;should&nbsp;be&nbsp;used&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061372">//&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;and&nbsp;will&nbsp;initialize&nbsp;the&nbsp;Request&#39;s&nbsp;TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061435">//&nbsp;and&nbsp;RemoteAddr&nbsp;if&nbsp;not&nbsp;already&nbsp;set.&nbsp;&nbsp;The&nbsp;connection&nbsp;is</span><br>
<span class="lineno">1625</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061493">//&nbsp;automatically&nbsp;closed&nbsp;when&nbsp;the&nbsp;function&nbsp;returns.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3061545">TLSNextProto</span>&nbsp;<span class="keyword" id="3061558">map</span><span class="op" id="3061561">[</span><span class="builtintype" id="3061562">string</span><span class="op" id="3061568">]</span><span class="keyword" id="3061569">func</span><span class="op" id="3061573">(</span><span class="op" id="3061574">*</span><span class="ident" id="3061575">Server</span><span class="op" id="3061581">,</span>&nbsp;<span class="op" id="3061583">*</span><span class="ident" id="3061584">tls</span><span class="op" id="3061587">.</span><span class="ident" id="3061588">Conn</span><span class="op" id="3061592">,</span>&nbsp;<span class="ident" id="3061594">Handler</span><span class="op" id="3061601">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061605">//&nbsp;ConnState&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;callback&nbsp;function&nbsp;that&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061667">//&nbsp;called&nbsp;when&nbsp;a&nbsp;client&nbsp;connection&nbsp;changes&nbsp;state.&nbsp;See&nbsp;the</span><br>
<span class="lineno">1630</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061726">//&nbsp;ConnState&nbsp;type&nbsp;and&nbsp;associated&nbsp;constants&nbsp;for&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3061783">ConnState</span>&nbsp;<span class="keyword" id="3061793">func</span><span class="op" id="3061797">(</span><span class="ident" id="3061798">net</span><span class="op" id="3061801">.</span><span class="ident" id="3061802">Conn</span><span class="op" id="3061806">,</span>&nbsp;<span class="ident" id="3061808">ConnState</span><span class="op" id="3061817">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061821">//&nbsp;ErrorLog&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;logger&nbsp;for&nbsp;errors&nbsp;accepting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061884">//&nbsp;connections&nbsp;and&nbsp;unexpected&nbsp;behavior&nbsp;from&nbsp;handlers.</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061939">//&nbsp;If&nbsp;nil,&nbsp;logging&nbsp;goes&nbsp;to&nbsp;os.Stderr&nbsp;via&nbsp;the&nbsp;log&nbsp;package&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3061999">//&nbsp;standard&nbsp;logger.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3062020">ErrorLog</span>&nbsp;<span class="op" id="3062029">*</span><span class="ident" id="3062030">log</span><span class="op" id="3062033">.</span><span class="ident" id="3062034">Logger</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3062043">disableKeepAlives</span>&nbsp;<span class="builtintype" id="3062061">int32</span>&nbsp;<span class="comment" id="3062067">//&nbsp;accessed&nbsp;atomically.</span><br>
<span class="lineno">1640</span><span class="op" id="3062091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3062094">//&nbsp;A&nbsp;ConnState&nbsp;represents&nbsp;the&nbsp;state&nbsp;of&nbsp;a&nbsp;client&nbsp;connection&nbsp;to&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="comment" id="3062166">//&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;the&nbsp;optional&nbsp;Server.ConnState&nbsp;hook.</span><br>
<span class="lineno"></span><span class="keyword" id="3062218">type</span>&nbsp;<span class="ident" id="3062223">ConnState</span>&nbsp;<span class="builtintype" id="3062233">int</span><br>
<span class="lineno">1645</span><br>
<span class="lineno"></span><span class="keyword" id="3062238">const</span>&nbsp;<span class="op" id="3062244">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062247">//&nbsp;StateNew&nbsp;represents&nbsp;a&nbsp;new&nbsp;connection&nbsp;that&nbsp;is&nbsp;expected&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062308">//&nbsp;send&nbsp;a&nbsp;request&nbsp;immediately.&nbsp;Connections&nbsp;begin&nbsp;at&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062366">//&nbsp;state&nbsp;and&nbsp;then&nbsp;transition&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062421">//&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3062438">StateNew</span>&nbsp;<span class="ident" id="3062447">ConnState</span>&nbsp;<span class="op" id="3062457">=</span>&nbsp;<span class="ident" id="3062459">iota</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062466">//&nbsp;StateActive&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;read&nbsp;1&nbsp;or&nbsp;more</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062530">//&nbsp;bytes&nbsp;of&nbsp;a&nbsp;request.&nbsp;The&nbsp;Server.ConnState&nbsp;hook&nbsp;for</span><br>
<span class="lineno">1655</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062584">//&nbsp;StateActive&nbsp;fires&nbsp;before&nbsp;the&nbsp;request&nbsp;has&nbsp;entered&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062647">//&nbsp;and&nbsp;doesn&#39;t&nbsp;fire&nbsp;again&nbsp;until&nbsp;the&nbsp;request&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062701">//&nbsp;handled.&nbsp;After&nbsp;the&nbsp;request&nbsp;is&nbsp;handled,&nbsp;the&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062754">//&nbsp;transitions&nbsp;to&nbsp;StateClosed,&nbsp;StateHijacked,&nbsp;or&nbsp;StateIdle.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3062815">StateActive</span><br>
<span class="lineno">1660</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062829">//&nbsp;StateIdle&nbsp;represents&nbsp;a&nbsp;connection&nbsp;that&nbsp;has&nbsp;finished</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062885">//&nbsp;handling&nbsp;a&nbsp;request&nbsp;and&nbsp;is&nbsp;in&nbsp;the&nbsp;keep-alive&nbsp;state,&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3062948">//&nbsp;for&nbsp;a&nbsp;new&nbsp;request.&nbsp;Connections&nbsp;transition&nbsp;from&nbsp;StateIdle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063009">//&nbsp;to&nbsp;either&nbsp;StateActive&nbsp;or&nbsp;StateClosed.</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063051">StateIdle</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063063">//&nbsp;StateHijacked&nbsp;represents&nbsp;a&nbsp;hijacked&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063115">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063184">StateHijacked</span><br>
<span class="lineno">1670</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063200">//&nbsp;StateClosed&nbsp;represents&nbsp;a&nbsp;closed&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063248">//&nbsp;This&nbsp;is&nbsp;a&nbsp;terminal&nbsp;state.&nbsp;Hijacked&nbsp;connections&nbsp;do&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3063306">//&nbsp;transition&nbsp;to&nbsp;StateClosed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063337">StateClosed</span><br>
<span class="lineno">1675</span><span class="op" id="3063349">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3063352">var</span>&nbsp;<span class="ident" id="3063356">stateName</span>&nbsp;<span class="op" id="3063366">=</span>&nbsp;<span class="keyword" id="3063368">map</span><span class="op" id="3063371">[</span><span class="ident" id="3063372">ConnState</span><span class="op" id="3063381">]</span><span class="builtintype" id="3063382">string</span><span class="op" id="3063388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063391">StateNew</span><span class="op" id="3063399">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063406">&#34;new&#34;</span><span class="op" id="3063411">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063414">StateActive</span><span class="op" id="3063425">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3063429">&#34;active&#34;</span><span class="op" id="3063437">,</span><br>
<span class="lineno">1680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063440">StateIdle</span><span class="op" id="3063449">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3063455">&#34;idle&#34;</span><span class="op" id="3063461">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063464">StateHijacked</span><span class="op" id="3063477">:</span>&nbsp;<span class="string" id="3063479">&#34;hijacked&#34;</span><span class="op" id="3063489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063492">StateClosed</span><span class="op" id="3063503">:</span>&nbsp;&nbsp;&nbsp;<span class="string" id="3063507">&#34;closed&#34;</span><span class="op" id="3063515">,</span><br>
<span class="lineno"></span><span class="op" id="3063517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1685</span><span class="keyword" id="3063520">func</span>&nbsp;<span class="op" id="3063525">(</span><span class="ident" id="3063526">c</span>&nbsp;<span class="ident" id="3063528">ConnState</span><span class="op" id="3063537">)</span>&nbsp;<span class="ident" id="3063539">String</span><span class="op" id="3063545">(</span><span class="op" id="3063546">)</span>&nbsp;<span class="builtintype" id="3063548">string</span>&nbsp;<span class="op" id="3063555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3063558">return</span>&nbsp;<span class="ident" id="3063565">stateName</span><span class="op" id="3063574">[</span><span class="ident" id="3063575">c</span><span class="op" id="3063576">]</span><br>
<span class="lineno"></span><span class="op" id="3063578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3063581">//&nbsp;serverHandler&nbsp;delegates&nbsp;to&nbsp;either&nbsp;the&nbsp;server&#39;s&nbsp;Handler&nbsp;or</span><br>
<span class="lineno">1690</span><span class="comment" id="3063642">//&nbsp;DefaultServeMux&nbsp;and&nbsp;also&nbsp;handles&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3063700">type</span>&nbsp;<span class="ident" id="3063705">serverHandler</span>&nbsp;<span class="keyword" id="3063719">struct</span>&nbsp;<span class="op" id="3063726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063729">srv</span>&nbsp;<span class="op" id="3063733">*</span><span class="ident" id="3063734">Server</span><br>
<span class="lineno"></span><span class="op" id="3063741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1695</span><span class="keyword" id="3063744">func</span>&nbsp;<span class="op" id="3063749">(</span><span class="ident" id="3063750">sh</span>&nbsp;<span class="ident" id="3063753">serverHandler</span><span class="op" id="3063766">)</span>&nbsp;<span class="ident" id="3063768">ServeHTTP</span><span class="op" id="3063777">(</span><span class="ident" id="3063778">rw</span>&nbsp;<span class="ident" id="3063781">ResponseWriter</span><span class="op" id="3063795">,</span>&nbsp;<span class="ident" id="3063797">req</span>&nbsp;<span class="op" id="3063801">*</span><span class="ident" id="3063802">Request</span><span class="op" id="3063809">)</span>&nbsp;<span class="op" id="3063811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063814">handler</span>&nbsp;<span class="op" id="3063822">:=</span>&nbsp;<span class="ident" id="3063825">sh</span><span class="op" id="3063827">.</span><span class="ident" id="3063828">srv</span><span class="op" id="3063831">.</span><span class="ident" id="3063832">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3063841">if</span>&nbsp;<span class="ident" id="3063844">handler</span>&nbsp;<span class="op" id="3063852">==</span>&nbsp;<span class="builtintype" id="3063855">nil</span>&nbsp;<span class="op" id="3063859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063863">handler</span>&nbsp;<span class="op" id="3063871">=</span>&nbsp;<span class="ident" id="3063873">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3063890">}</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3063893">if</span>&nbsp;<span class="ident" id="3063896">req</span><span class="op" id="3063899">.</span><span class="ident" id="3063900">RequestURI</span>&nbsp;<span class="op" id="3063911">==</span>&nbsp;<span class="string" id="3063914">&#34;*&#34;</span>&nbsp;<span class="op" id="3063918">&amp;&amp;</span>&nbsp;<span class="ident" id="3063921">req</span><span class="op" id="3063924">.</span><span class="ident" id="3063925">Method</span>&nbsp;<span class="op" id="3063932">==</span>&nbsp;<span class="string" id="3063935">&#34;OPTIONS&#34;</span>&nbsp;<span class="op" id="3063945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063949">handler</span>&nbsp;<span class="op" id="3063957">=</span>&nbsp;<span class="ident" id="3063959">globalOptionsHandler</span><span class="op" id="3063979">{</span><span class="op" id="3063980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3063983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3063986">handler</span><span class="op" id="3063993">.</span><span class="ident" id="3063994">ServeHTTP</span><span class="op" id="3064003">(</span><span class="ident" id="3064004">rw</span><span class="op" id="3064006">,</span>&nbsp;<span class="ident" id="3064008">req</span><span class="op" id="3064011">)</span><br>
<span class="lineno"></span><span class="op" id="3064013">}</span><br>
<span class="lineno">1705</span><br>
<span class="lineno"></span><span class="comment" id="3064016">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3064087">//&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;If</span><br>
<span class="lineno"></span><span class="comment" id="3064150">//&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:http&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3064189">func</span>&nbsp;<span class="op" id="3064194">(</span><span class="ident" id="3064195">srv</span>&nbsp;<span class="op" id="3064199">*</span><span class="ident" id="3064200">Server</span><span class="op" id="3064206">)</span>&nbsp;<span class="ident" id="3064208">ListenAndServe</span><span class="op" id="3064222">(</span><span class="op" id="3064223">)</span>&nbsp;<span class="builtintype" id="3064225">error</span>&nbsp;<span class="op" id="3064231">{</span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064234">addr</span>&nbsp;<span class="op" id="3064239">:=</span>&nbsp;<span class="ident" id="3064242">srv</span><span class="op" id="3064245">.</span><span class="ident" id="3064246">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064252">if</span>&nbsp;<span class="ident" id="3064255">addr</span>&nbsp;<span class="op" id="3064260">==</span>&nbsp;<span class="string" id="3064263">&#34;&#34;</span>&nbsp;<span class="op" id="3064266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064270">addr</span>&nbsp;<span class="op" id="3064275">=</span>&nbsp;<span class="string" id="3064277">&#34;:http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064289">ln</span><span class="op" id="3064291">,</span>&nbsp;<span class="ident" id="3064293">err</span>&nbsp;<span class="op" id="3064297">:=</span>&nbsp;<span class="ident" id="3064300">net</span><span class="op" id="3064303">.</span><span class="ident" id="3064304">Listen</span><span class="op" id="3064310">(</span><span class="string" id="3064311">&#34;tcp&#34;</span><span class="op" id="3064316">,</span>&nbsp;<span class="ident" id="3064318">addr</span><span class="op" id="3064322">)</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064325">if</span>&nbsp;<span class="ident" id="3064328">err</span>&nbsp;<span class="op" id="3064332">!=</span>&nbsp;<span class="builtintype" id="3064335">nil</span>&nbsp;<span class="op" id="3064339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064343">return</span>&nbsp;<span class="ident" id="3064350">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064358">return</span>&nbsp;<span class="ident" id="3064365">srv</span><span class="op" id="3064368">.</span><span class="ident" id="3064369">Serve</span><span class="op" id="3064374">(</span><span class="ident" id="3064375">tcpKeepAliveListener</span><span class="op" id="3064395">{</span><span class="ident" id="3064396">ln</span><span class="op" id="3064398">.</span><span class="op" id="3064399">(</span><span class="op" id="3064400">*</span><span class="ident" id="3064401">net</span><span class="op" id="3064404">.</span><span class="ident" id="3064405">TCPListener</span><span class="op" id="3064416">)</span><span class="op" id="3064417">}</span><span class="op" id="3064418">)</span><br>
<span class="lineno"></span><span class="op" id="3064420">}</span><br>
<span class="lineno">1720</span><br>
<span class="lineno"></span><span class="comment" id="3064423">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;connections&nbsp;on&nbsp;the&nbsp;Listener&nbsp;l,&nbsp;creating&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3064491">//&nbsp;new&nbsp;service&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;&nbsp;The&nbsp;service&nbsp;goroutines&nbsp;read&nbsp;requests&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3064568">//&nbsp;then&nbsp;call&nbsp;srv.Handler&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3064611">func</span>&nbsp;<span class="op" id="3064616">(</span><span class="ident" id="3064617">srv</span>&nbsp;<span class="op" id="3064621">*</span><span class="ident" id="3064622">Server</span><span class="op" id="3064628">)</span>&nbsp;<span class="ident" id="3064630">Serve</span><span class="op" id="3064635">(</span><span class="ident" id="3064636">l</span>&nbsp;<span class="ident" id="3064638">net</span><span class="op" id="3064641">.</span><span class="ident" id="3064642">Listener</span><span class="op" id="3064650">)</span>&nbsp;<span class="builtintype" id="3064652">error</span>&nbsp;<span class="op" id="3064658">{</span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064661">defer</span>&nbsp;<span class="ident" id="3064667">l</span><span class="op" id="3064668">.</span><span class="ident" id="3064669">Close</span><span class="op" id="3064674">(</span><span class="op" id="3064675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064678">var</span>&nbsp;<span class="ident" id="3064682">tempDelay</span>&nbsp;<span class="ident" id="3064692">time</span><span class="op" id="3064696">.</span><span class="ident" id="3064697">Duration</span>&nbsp;<span class="comment" id="3064706">//&nbsp;how&nbsp;long&nbsp;to&nbsp;sleep&nbsp;on&nbsp;accept&nbsp;failure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064746">for</span>&nbsp;<span class="op" id="3064750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064754">rw</span><span class="op" id="3064756">,</span>&nbsp;<span class="ident" id="3064758">e</span>&nbsp;<span class="op" id="3064760">:=</span>&nbsp;<span class="ident" id="3064763">l</span><span class="op" id="3064764">.</span><span class="ident" id="3064765">Accept</span><span class="op" id="3064771">(</span><span class="op" id="3064772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064776">if</span>&nbsp;<span class="ident" id="3064779">e</span>&nbsp;<span class="op" id="3064781">!=</span>&nbsp;<span class="builtintype" id="3064784">nil</span>&nbsp;<span class="op" id="3064788">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064793">if</span>&nbsp;<span class="ident" id="3064796">ne</span><span class="op" id="3064798">,</span>&nbsp;<span class="ident" id="3064800">ok</span>&nbsp;<span class="op" id="3064803">:=</span>&nbsp;<span class="ident" id="3064806">e</span><span class="op" id="3064807">.</span><span class="op" id="3064808">(</span><span class="ident" id="3064809">net</span><span class="op" id="3064812">.</span><span class="ident" id="3064813">Error</span><span class="op" id="3064818">)</span><span class="op" id="3064819">;</span>&nbsp;<span class="ident" id="3064821">ok</span>&nbsp;<span class="op" id="3064824">&amp;&amp;</span>&nbsp;<span class="ident" id="3064827">ne</span><span class="op" id="3064829">.</span><span class="ident" id="3064830">Temporary</span><span class="op" id="3064839">(</span><span class="op" id="3064840">)</span>&nbsp;<span class="op" id="3064842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064848">if</span>&nbsp;<span class="ident" id="3064851">tempDelay</span>&nbsp;<span class="op" id="3064861">==</span>&nbsp;<span class="num" id="3064864">0</span>&nbsp;<span class="op" id="3064866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064873">tempDelay</span>&nbsp;<span class="op" id="3064883">=</span>&nbsp;<span class="num" id="3064885">5</span>&nbsp;<span class="op" id="3064887">*</span>&nbsp;<span class="ident" id="3064889">time</span><span class="op" id="3064893">.</span><span class="ident" id="3064894">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064910">}</span>&nbsp;<span class="keyword" id="3064912">else</span>&nbsp;<span class="op" id="3064917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064924">tempDelay</span>&nbsp;<span class="op" id="3064934">*=</span>&nbsp;<span class="num" id="3064937">2</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3064943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3064949">if</span>&nbsp;<span class="ident" id="3064952">max</span>&nbsp;<span class="op" id="3064956">:=</span>&nbsp;<span class="num" id="3064959">1</span>&nbsp;<span class="op" id="3064961">*</span>&nbsp;<span class="ident" id="3064963">time</span><span class="op" id="3064967">.</span><span class="ident" id="3064968">Second</span><span class="op" id="3064974">;</span>&nbsp;<span class="ident" id="3064976">tempDelay</span>&nbsp;<span class="op" id="3064986">&gt;</span>&nbsp;<span class="ident" id="3064988">max</span>&nbsp;<span class="op" id="3064992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3064999">tempDelay</span>&nbsp;<span class="op" id="3065009">=</span>&nbsp;<span class="ident" id="3065011">max</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065025">srv</span><span class="op" id="3065028">.</span><span class="ident" id="3065029">logf</span><span class="op" id="3065033">(</span><span class="string" id="3065034">&#34;http:&nbsp;Accept&nbsp;error:&nbsp;%v;&nbsp;retrying&nbsp;in&nbsp;%v&#34;</span><span class="op" id="3065074">,</span>&nbsp;<span class="ident" id="3065076">e</span><span class="op" id="3065077">,</span>&nbsp;<span class="ident" id="3065079">tempDelay</span><span class="op" id="3065088">)</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065094">time</span><span class="op" id="3065098">.</span><span class="ident" id="3065099">Sleep</span><span class="op" id="3065104">(</span><span class="ident" id="3065105">tempDelay</span><span class="op" id="3065114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065120">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065137">return</span>&nbsp;<span class="ident" id="3065144">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065148">}</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065152">tempDelay</span>&nbsp;<span class="op" id="3065162">=</span>&nbsp;<span class="num" id="3065164">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065168">c</span><span class="op" id="3065169">,</span>&nbsp;<span class="ident" id="3065171">err</span>&nbsp;<span class="op" id="3065175">:=</span>&nbsp;<span class="ident" id="3065178">srv</span><span class="op" id="3065181">.</span><span class="ident" id="3065182">newConn</span><span class="op" id="3065189">(</span><span class="ident" id="3065190">rw</span><span class="op" id="3065192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065196">if</span>&nbsp;<span class="ident" id="3065199">err</span>&nbsp;<span class="op" id="3065203">!=</span>&nbsp;<span class="builtintype" id="3065206">nil</span>&nbsp;<span class="op" id="3065210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065215">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065226">}</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065230">c</span><span class="op" id="3065231">.</span><span class="ident" id="3065232">setState</span><span class="op" id="3065240">(</span><span class="ident" id="3065241">c</span><span class="op" id="3065242">.</span><span class="ident" id="3065243">rwc</span><span class="op" id="3065246">,</span>&nbsp;<span class="ident" id="3065248">StateNew</span><span class="op" id="3065256">)</span>&nbsp;<span class="comment" id="3065258">//&nbsp;before&nbsp;Serve&nbsp;can&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065287">go</span>&nbsp;<span class="ident" id="3065290">c</span><span class="op" id="3065291">.</span><span class="ident" id="3065292">serve</span><span class="op" id="3065297">(</span><span class="op" id="3065298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065301">}</span><br>
<span class="lineno"></span><span class="op" id="3065303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1755</span><span class="keyword" id="3065306">func</span>&nbsp;<span class="op" id="3065311">(</span><span class="ident" id="3065312">s</span>&nbsp;<span class="op" id="3065314">*</span><span class="ident" id="3065315">Server</span><span class="op" id="3065321">)</span>&nbsp;<span class="ident" id="3065323">doKeepAlives</span><span class="op" id="3065335">(</span><span class="op" id="3065336">)</span>&nbsp;<span class="builtintype" id="3065338">bool</span>&nbsp;<span class="op" id="3065343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065346">return</span>&nbsp;<span class="ident" id="3065353">atomic</span><span class="op" id="3065359">.</span><span class="ident" id="3065360">LoadInt32</span><span class="op" id="3065369">(</span><span class="op" id="3065370">&amp;</span><span class="ident" id="3065371">s</span><span class="op" id="3065372">.</span><span class="ident" id="3065373">disableKeepAlives</span><span class="op" id="3065390">)</span>&nbsp;<span class="op" id="3065392">==</span>&nbsp;<span class="num" id="3065395">0</span><br>
<span class="lineno"></span><span class="op" id="3065397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3065400">//&nbsp;SetKeepAlivesEnabled&nbsp;controls&nbsp;whether&nbsp;HTTP&nbsp;keep-alives&nbsp;are&nbsp;enabled.</span><br>
<span class="lineno">1760</span><span class="comment" id="3065471">//&nbsp;By&nbsp;default,&nbsp;keep-alives&nbsp;are&nbsp;always&nbsp;enabled.&nbsp;Only&nbsp;very</span><br>
<span class="lineno"></span><span class="comment" id="3065528">//&nbsp;resource-constrained&nbsp;environments&nbsp;or&nbsp;servers&nbsp;in&nbsp;the&nbsp;process&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3065594">//&nbsp;shutting&nbsp;down&nbsp;should&nbsp;disable&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="3065632">func</span>&nbsp;<span class="op" id="3065637">(</span><span class="ident" id="3065638">s</span>&nbsp;<span class="op" id="3065640">*</span><span class="ident" id="3065641">Server</span><span class="op" id="3065647">)</span>&nbsp;<span class="ident" id="3065649">SetKeepAlivesEnabled</span><span class="op" id="3065669">(</span><span class="ident" id="3065670">v</span>&nbsp;<span class="builtintype" id="3065672">bool</span><span class="op" id="3065676">)</span>&nbsp;<span class="op" id="3065678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065681">if</span>&nbsp;<span class="ident" id="3065684">v</span>&nbsp;<span class="op" id="3065686">{</span><br>
<span class="lineno">1765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065690">atomic</span><span class="op" id="3065696">.</span><span class="ident" id="3065697">StoreInt32</span><span class="op" id="3065707">(</span><span class="op" id="3065708">&amp;</span><span class="ident" id="3065709">s</span><span class="op" id="3065710">.</span><span class="ident" id="3065711">disableKeepAlives</span><span class="op" id="3065728">,</span>&nbsp;<span class="num" id="3065730">0</span><span class="op" id="3065731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065734">}</span>&nbsp;<span class="keyword" id="3065736">else</span>&nbsp;<span class="op" id="3065741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065745">atomic</span><span class="op" id="3065751">.</span><span class="ident" id="3065752">StoreInt32</span><span class="op" id="3065762">(</span><span class="op" id="3065763">&amp;</span><span class="ident" id="3065764">s</span><span class="op" id="3065765">.</span><span class="ident" id="3065766">disableKeepAlives</span><span class="op" id="3065783">,</span>&nbsp;<span class="num" id="3065785">1</span><span class="op" id="3065786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065789">}</span><br>
<span class="lineno"></span><span class="op" id="3065791">}</span><br>
<span class="lineno">1770</span><br>
<span class="lineno"></span><span class="keyword" id="3065794">func</span>&nbsp;<span class="op" id="3065799">(</span><span class="ident" id="3065800">s</span>&nbsp;<span class="op" id="3065802">*</span><span class="ident" id="3065803">Server</span><span class="op" id="3065809">)</span>&nbsp;<span class="ident" id="3065811">logf</span><span class="op" id="3065815">(</span><span class="ident" id="3065816">format</span>&nbsp;<span class="builtintype" id="3065823">string</span><span class="op" id="3065829">,</span>&nbsp;<span class="ident" id="3065831">args</span>&nbsp;<span class="op" id="3065836">...</span><span class="keyword" id="3065839">interface</span><span class="op" id="3065848">{</span><span class="op" id="3065849">}</span><span class="op" id="3065850">)</span>&nbsp;<span class="op" id="3065852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3065855">if</span>&nbsp;<span class="ident" id="3065858">s</span><span class="op" id="3065859">.</span><span class="ident" id="3065860">ErrorLog</span>&nbsp;<span class="op" id="3065869">!=</span>&nbsp;<span class="builtintype" id="3065872">nil</span>&nbsp;<span class="op" id="3065876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065880">s</span><span class="op" id="3065881">.</span><span class="ident" id="3065882">ErrorLog</span><span class="op" id="3065890">.</span><span class="ident" id="3065891">Printf</span><span class="op" id="3065897">(</span><span class="ident" id="3065898">format</span><span class="op" id="3065904">,</span>&nbsp;<span class="ident" id="3065906">args</span><span class="op" id="3065910">...</span><span class="op" id="3065913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065916">}</span>&nbsp;<span class="keyword" id="3065918">else</span>&nbsp;<span class="op" id="3065923">{</span><br>
<span class="lineno">1775</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3065927">log</span><span class="op" id="3065930">.</span><span class="ident" id="3065931">Printf</span><span class="op" id="3065937">(</span><span class="ident" id="3065938">format</span><span class="op" id="3065944">,</span>&nbsp;<span class="ident" id="3065946">args</span><span class="op" id="3065950">...</span><span class="op" id="3065953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3065956">}</span><br>
<span class="lineno"></span><span class="op" id="3065958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3065961">//&nbsp;ListenAndServe&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;addr</span><br>
<span class="lineno">1780</span><span class="comment" id="3066019">//&nbsp;and&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;with&nbsp;handler&nbsp;to&nbsp;handle&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="3066075">//&nbsp;on&nbsp;incoming&nbsp;connections.&nbsp;&nbsp;Handler&nbsp;is&nbsp;typically&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3066130">//&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3066176">//</span><br>
<span class="lineno"></span><span class="comment" id="3066179">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno">1785</span><span class="comment" id="3066211">//</span><br>
<span class="lineno"></span><span class="comment" id="3066214">//&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;main</span><br>
<span class="lineno"></span><span class="comment" id="3066230">//</span><br>
<span class="lineno"></span><span class="comment" id="3066233">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno"></span><span class="comment" id="3066245">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;io&#34;</span><br>
<span class="lineno">1790</span><span class="comment" id="3066254">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3066269">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3066279">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3066284">//</span><br>
<span class="lineno"></span><span class="comment" id="3066287">//&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;hello&nbsp;world,&nbsp;the&nbsp;web&nbsp;server</span><br>
<span class="lineno">1795</span><span class="comment" id="3066321">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;HelloServer(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3066385">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io.WriteString(w,&nbsp;&#34;hello,&nbsp;world!\n&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3066426">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3066431">//</span><br>
<span class="lineno"></span><span class="comment" id="3066434">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1800</span><span class="comment" id="3066451">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/hello&#34;,&nbsp;HelloServer)</span><br>
<span class="lineno"></span><span class="comment" id="3066494">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServe(&#34;:12345&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3066540">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3066560">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;ListenAndServe:&nbsp;&#34;,&nbsp;err)</span><br>
<span class="lineno"></span><span class="comment" id="3066600">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">1805</span><span class="comment" id="3066606">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="keyword" id="3066611">func</span>&nbsp;<span class="ident" id="3066616">ListenAndServe</span><span class="op" id="3066630">(</span><span class="ident" id="3066631">addr</span>&nbsp;<span class="builtintype" id="3066636">string</span><span class="op" id="3066642">,</span>&nbsp;<span class="ident" id="3066644">handler</span>&nbsp;<span class="ident" id="3066652">Handler</span><span class="op" id="3066659">)</span>&nbsp;<span class="builtintype" id="3066661">error</span>&nbsp;<span class="op" id="3066667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3066670">server</span>&nbsp;<span class="op" id="3066677">:=</span>&nbsp;<span class="op" id="3066680">&amp;</span><span class="ident" id="3066681">Server</span><span class="op" id="3066687">{</span><span class="ident" id="3066688">Addr</span><span class="op" id="3066692">:</span>&nbsp;<span class="ident" id="3066694">addr</span><span class="op" id="3066698">,</span>&nbsp;<span class="ident" id="3066700">Handler</span><span class="op" id="3066707">:</span>&nbsp;<span class="ident" id="3066709">handler</span><span class="op" id="3066716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3066719">return</span>&nbsp;<span class="ident" id="3066726">server</span><span class="op" id="3066732">.</span><span class="ident" id="3066733">ListenAndServe</span><span class="op" id="3066747">(</span><span class="op" id="3066748">)</span><br>
<span class="lineno"></span><span class="op" id="3066750">}</span><br>
<span class="lineno">1810</span><br>
<span class="lineno"></span><span class="comment" id="3066753">//&nbsp;ListenAndServeTLS&nbsp;acts&nbsp;identically&nbsp;to&nbsp;ListenAndServe,&nbsp;except&nbsp;that&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3066825">//&nbsp;expects&nbsp;HTTPS&nbsp;connections.&nbsp;Additionally,&nbsp;files&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3066904">//&nbsp;matching&nbsp;private&nbsp;key&nbsp;for&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate</span><br>
<span class="lineno"></span><span class="comment" id="3066980">//&nbsp;is&nbsp;signed&nbsp;by&nbsp;a&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1815</span><span class="comment" id="3067062">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3067127">//</span><br>
<span class="lineno"></span><span class="comment" id="3067130">//&nbsp;A&nbsp;trivial&nbsp;example&nbsp;server&nbsp;is:</span><br>
<span class="lineno"></span><span class="comment" id="3067162">//</span><br>
<span class="lineno"></span><span class="comment" id="3067165">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;(</span><br>
<span class="lineno">1820</span><span class="comment" id="3067177">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;log&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3067187">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;net/http&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3067202">//&nbsp;&nbsp;&nbsp;&nbsp;)</span><br>
<span class="lineno"></span><span class="comment" id="3067207">//</span><br>
<span class="lineno"></span><span class="comment" id="3067210">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;handler(w&nbsp;http.ResponseWriter,&nbsp;req&nbsp;*http.Request)&nbsp;{</span><br>
<span class="lineno">1825</span><span class="comment" id="3067270">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Header().Set(&#34;Content-Type&#34;,&nbsp;&#34;text/plain&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3067319">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;w.Write([]byte(&#34;This&nbsp;is&nbsp;an&nbsp;example&nbsp;server.\n&#34;))</span><br>
<span class="lineno"></span><span class="comment" id="3067371">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3067376">//</span><br>
<span class="lineno"></span><span class="comment" id="3067379">//&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;main()&nbsp;{</span><br>
<span class="lineno">1830</span><span class="comment" id="3067396">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http.HandleFunc(&#34;/&#34;,&nbsp;handler)</span><br>
<span class="lineno"></span><span class="comment" id="3067430">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Printf(&#34;About&nbsp;to&nbsp;listen&nbsp;on&nbsp;10443.&nbsp;Go&nbsp;to&nbsp;https://127.0.0.1:10443/&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3067505">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;:=&nbsp;http.ListenAndServeTLS(&#34;:10443&#34;,&nbsp;&#34;cert.pem&#34;,&nbsp;&#34;key.pem&#34;,&nbsp;nil)</span><br>
<span class="lineno"></span><span class="comment" id="3067577">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3067597">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(err)</span><br>
<span class="lineno">1835</span><span class="comment" id="3067617">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3067623">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3067628">//</span><br>
<span class="lineno"></span><span class="comment" id="3067631">//&nbsp;One&nbsp;can&nbsp;use&nbsp;generate_cert.go&nbsp;in&nbsp;crypto/tls&nbsp;to&nbsp;generate&nbsp;cert.pem&nbsp;and&nbsp;key.pem.</span><br>
<span class="lineno"></span><span class="keyword" id="3067711">func</span>&nbsp;<span class="ident" id="3067716">ListenAndServeTLS</span><span class="op" id="3067733">(</span><span class="ident" id="3067734">addr</span>&nbsp;<span class="builtintype" id="3067739">string</span><span class="op" id="3067745">,</span>&nbsp;<span class="ident" id="3067747">certFile</span>&nbsp;<span class="builtintype" id="3067756">string</span><span class="op" id="3067762">,</span>&nbsp;<span class="ident" id="3067764">keyFile</span>&nbsp;<span class="builtintype" id="3067772">string</span><span class="op" id="3067778">,</span>&nbsp;<span class="ident" id="3067780">handler</span>&nbsp;<span class="ident" id="3067788">Handler</span><span class="op" id="3067795">)</span>&nbsp;<span class="builtintype" id="3067797">error</span>&nbsp;<span class="op" id="3067803">{</span><br>
<span class="lineno">1840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3067806">server</span>&nbsp;<span class="op" id="3067813">:=</span>&nbsp;<span class="op" id="3067816">&amp;</span><span class="ident" id="3067817">Server</span><span class="op" id="3067823">{</span><span class="ident" id="3067824">Addr</span><span class="op" id="3067828">:</span>&nbsp;<span class="ident" id="3067830">addr</span><span class="op" id="3067834">,</span>&nbsp;<span class="ident" id="3067836">Handler</span><span class="op" id="3067843">:</span>&nbsp;<span class="ident" id="3067845">handler</span><span class="op" id="3067852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3067855">return</span>&nbsp;<span class="ident" id="3067862">server</span><span class="op" id="3067868">.</span><span class="ident" id="3067869">ListenAndServeTLS</span><span class="op" id="3067886">(</span><span class="ident" id="3067887">certFile</span><span class="op" id="3067895">,</span>&nbsp;<span class="ident" id="3067897">keyFile</span><span class="op" id="3067904">)</span><br>
<span class="lineno"></span><span class="op" id="3067906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3067909">//&nbsp;ListenAndServeTLS&nbsp;listens&nbsp;on&nbsp;the&nbsp;TCP&nbsp;network&nbsp;address&nbsp;srv.Addr&nbsp;and</span><br>
<span class="lineno">1845</span><span class="comment" id="3067978">//&nbsp;then&nbsp;calls&nbsp;Serve&nbsp;to&nbsp;handle&nbsp;requests&nbsp;on&nbsp;incoming&nbsp;TLS&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="3068046">//</span><br>
<span class="lineno"></span><span class="comment" id="3068049">//&nbsp;Filenames&nbsp;containing&nbsp;a&nbsp;certificate&nbsp;and&nbsp;matching&nbsp;private&nbsp;key&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3068116">//&nbsp;the&nbsp;server&nbsp;must&nbsp;be&nbsp;provided.&nbsp;If&nbsp;the&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3068182">//&nbsp;certificate&nbsp;authority,&nbsp;the&nbsp;certFile&nbsp;should&nbsp;be&nbsp;the&nbsp;concatenation</span><br>
<span class="lineno">1850</span><span class="comment" id="3068249">//&nbsp;of&nbsp;the&nbsp;server&#39;s&nbsp;certificate&nbsp;followed&nbsp;by&nbsp;the&nbsp;CA&#39;s&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="comment" id="3068314">//</span><br>
<span class="lineno"></span><span class="comment" id="3068317">//&nbsp;If&nbsp;srv.Addr&nbsp;is&nbsp;blank,&nbsp;&#34;:https&#34;&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3068360">func</span>&nbsp;<span class="op" id="3068365">(</span><span class="ident" id="3068366">srv</span>&nbsp;<span class="op" id="3068370">*</span><span class="ident" id="3068371">Server</span><span class="op" id="3068377">)</span>&nbsp;<span class="ident" id="3068379">ListenAndServeTLS</span><span class="op" id="3068396">(</span><span class="ident" id="3068397">certFile</span><span class="op" id="3068405">,</span>&nbsp;<span class="ident" id="3068407">keyFile</span>&nbsp;<span class="builtintype" id="3068415">string</span><span class="op" id="3068421">)</span>&nbsp;<span class="builtintype" id="3068423">error</span>&nbsp;<span class="op" id="3068429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068432">addr</span>&nbsp;<span class="op" id="3068437">:=</span>&nbsp;<span class="ident" id="3068440">srv</span><span class="op" id="3068443">.</span><span class="ident" id="3068444">Addr</span><br>
<span class="lineno">1855</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068450">if</span>&nbsp;<span class="ident" id="3068453">addr</span>&nbsp;<span class="op" id="3068458">==</span>&nbsp;<span class="string" id="3068461">&#34;&#34;</span>&nbsp;<span class="op" id="3068464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068468">addr</span>&nbsp;<span class="op" id="3068473">=</span>&nbsp;<span class="string" id="3068475">&#34;:https&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068488">config</span>&nbsp;<span class="op" id="3068495">:=</span>&nbsp;<span class="op" id="3068498">&amp;</span><span class="ident" id="3068499">tls</span><span class="op" id="3068502">.</span><span class="ident" id="3068503">Config</span><span class="op" id="3068509">{</span><span class="op" id="3068510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068513">if</span>&nbsp;<span class="ident" id="3068516">srv</span><span class="op" id="3068519">.</span><span class="ident" id="3068520">TLSConfig</span>&nbsp;<span class="op" id="3068530">!=</span>&nbsp;<span class="builtintype" id="3068533">nil</span>&nbsp;<span class="op" id="3068537">{</span><br>
<span class="lineno">1860</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068541">*</span><span class="ident" id="3068542">config</span>&nbsp;<span class="op" id="3068549">=</span>&nbsp;<span class="op" id="3068551">*</span><span class="ident" id="3068552">srv</span><span class="op" id="3068555">.</span><span class="ident" id="3068556">TLSConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068570">if</span>&nbsp;<span class="ident" id="3068573">config</span><span class="op" id="3068579">.</span><span class="ident" id="3068580">NextProtos</span>&nbsp;<span class="op" id="3068591">==</span>&nbsp;<span class="builtintype" id="3068594">nil</span>&nbsp;<span class="op" id="3068598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068602">config</span><span class="op" id="3068608">.</span><span class="ident" id="3068609">NextProtos</span>&nbsp;<span class="op" id="3068620">=</span>&nbsp;<span class="op" id="3068622">[</span><span class="op" id="3068623">]</span><span class="builtintype" id="3068624">string</span><span class="op" id="3068630">{</span><span class="string" id="3068631">&#34;http/1.1&#34;</span><span class="op" id="3068641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068644">}</span><br>
<span class="lineno">1865</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068648">var</span>&nbsp;<span class="ident" id="3068652">err</span>&nbsp;<span class="builtintype" id="3068656">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068663">config</span><span class="op" id="3068669">.</span><span class="ident" id="3068670">Certificates</span>&nbsp;<span class="op" id="3068683">=</span>&nbsp;<span class="builtinfunc" id="3068685">make</span><span class="op" id="3068689">(</span><span class="op" id="3068690">[</span><span class="op" id="3068691">]</span><span class="ident" id="3068692">tls</span><span class="op" id="3068695">.</span><span class="ident" id="3068696">Certificate</span><span class="op" id="3068707">,</span>&nbsp;<span class="num" id="3068709">1</span><span class="op" id="3068710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068713">config</span><span class="op" id="3068719">.</span><span class="ident" id="3068720">Certificates</span><span class="op" id="3068732">[</span><span class="num" id="3068733">0</span><span class="op" id="3068734">]</span><span class="op" id="3068735">,</span>&nbsp;<span class="ident" id="3068737">err</span>&nbsp;<span class="op" id="3068741">=</span>&nbsp;<span class="ident" id="3068743">tls</span><span class="op" id="3068746">.</span><span class="ident" id="3068747">LoadX509KeyPair</span><span class="op" id="3068762">(</span><span class="ident" id="3068763">certFile</span><span class="op" id="3068771">,</span>&nbsp;<span class="ident" id="3068773">keyFile</span><span class="op" id="3068780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068783">if</span>&nbsp;<span class="ident" id="3068786">err</span>&nbsp;<span class="op" id="3068790">!=</span>&nbsp;<span class="builtintype" id="3068793">nil</span>&nbsp;<span class="op" id="3068797">{</span><br>
<span class="lineno">1870</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068801">return</span>&nbsp;<span class="ident" id="3068808">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068817">ln</span><span class="op" id="3068819">,</span>&nbsp;<span class="ident" id="3068821">err</span>&nbsp;<span class="op" id="3068825">:=</span>&nbsp;<span class="ident" id="3068828">net</span><span class="op" id="3068831">.</span><span class="ident" id="3068832">Listen</span><span class="op" id="3068838">(</span><span class="string" id="3068839">&#34;tcp&#34;</span><span class="op" id="3068844">,</span>&nbsp;<span class="ident" id="3068846">addr</span><span class="op" id="3068850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068853">if</span>&nbsp;<span class="ident" id="3068856">err</span>&nbsp;<span class="op" id="3068860">!=</span>&nbsp;<span class="builtintype" id="3068863">nil</span>&nbsp;<span class="op" id="3068867">{</span><br>
<span class="lineno">1875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068871">return</span>&nbsp;<span class="ident" id="3068878">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3068883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3068887">tlsListener</span>&nbsp;<span class="op" id="3068899">:=</span>&nbsp;<span class="ident" id="3068902">tls</span><span class="op" id="3068905">.</span><span class="ident" id="3068906">NewListener</span><span class="op" id="3068917">(</span><span class="ident" id="3068918">tcpKeepAliveListener</span><span class="op" id="3068938">{</span><span class="ident" id="3068939">ln</span><span class="op" id="3068941">.</span><span class="op" id="3068942">(</span><span class="op" id="3068943">*</span><span class="ident" id="3068944">net</span><span class="op" id="3068947">.</span><span class="ident" id="3068948">TCPListener</span><span class="op" id="3068959">)</span><span class="op" id="3068960">}</span><span class="op" id="3068961">,</span>&nbsp;<span class="ident" id="3068963">config</span><span class="op" id="3068969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3068972">return</span>&nbsp;<span class="ident" id="3068979">srv</span><span class="op" id="3068982">.</span><span class="ident" id="3068983">Serve</span><span class="op" id="3068988">(</span><span class="ident" id="3068989">tlsListener</span><span class="op" id="3069000">)</span><br>
<span class="lineno">1880</span><span class="op" id="3069002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3069005">//&nbsp;TimeoutHandler&nbsp;returns&nbsp;a&nbsp;Handler&nbsp;that&nbsp;runs&nbsp;h&nbsp;with&nbsp;the&nbsp;given&nbsp;time&nbsp;limit.</span><br>
<span class="lineno"></span><span class="comment" id="3069080">//</span><br>
<span class="lineno"></span><span class="comment" id="3069083">//&nbsp;The&nbsp;new&nbsp;Handler&nbsp;calls&nbsp;h.ServeHTTP&nbsp;to&nbsp;handle&nbsp;each&nbsp;request,&nbsp;but&nbsp;if&nbsp;a</span><br>
<span class="lineno">1885</span><span class="comment" id="3069153">//&nbsp;call&nbsp;runs&nbsp;for&nbsp;longer&nbsp;than&nbsp;its&nbsp;time&nbsp;limit,&nbsp;the&nbsp;handler&nbsp;responds&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="3069224">//&nbsp;a&nbsp;503&nbsp;Service&nbsp;Unavailable&nbsp;error&nbsp;and&nbsp;the&nbsp;given&nbsp;message&nbsp;in&nbsp;its&nbsp;body.</span><br>
<span class="lineno"></span><span class="comment" id="3069294">//&nbsp;(If&nbsp;msg&nbsp;is&nbsp;empty,&nbsp;a&nbsp;suitable&nbsp;default&nbsp;message&nbsp;will&nbsp;be&nbsp;sent.)</span><br>
<span class="lineno"></span><span class="comment" id="3069357">//&nbsp;After&nbsp;such&nbsp;a&nbsp;timeout,&nbsp;writes&nbsp;by&nbsp;h&nbsp;to&nbsp;its&nbsp;ResponseWriter&nbsp;will&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3069428">//&nbsp;ErrHandlerTimeout.</span><br>
<span class="lineno">1890</span><span class="keyword" id="3069450">func</span>&nbsp;<span class="ident" id="3069455">TimeoutHandler</span><span class="op" id="3069469">(</span><span class="ident" id="3069470">h</span>&nbsp;<span class="ident" id="3069472">Handler</span><span class="op" id="3069479">,</span>&nbsp;<span class="ident" id="3069481">dt</span>&nbsp;<span class="ident" id="3069484">time</span><span class="op" id="3069488">.</span><span class="ident" id="3069489">Duration</span><span class="op" id="3069497">,</span>&nbsp;<span class="ident" id="3069499">msg</span>&nbsp;<span class="builtintype" id="3069503">string</span><span class="op" id="3069509">)</span>&nbsp;<span class="ident" id="3069511">Handler</span>&nbsp;<span class="op" id="3069519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069522">f</span>&nbsp;<span class="op" id="3069524">:=</span>&nbsp;<span class="keyword" id="3069527">func</span><span class="op" id="3069531">(</span><span class="op" id="3069532">)</span>&nbsp;<span class="op" id="3069534">&lt;-</span><span class="keyword" id="3069536">chan</span>&nbsp;<span class="ident" id="3069541">time</span><span class="op" id="3069545">.</span><span class="ident" id="3069546">Time</span>&nbsp;<span class="op" id="3069551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069555">return</span>&nbsp;<span class="ident" id="3069562">time</span><span class="op" id="3069566">.</span><span class="ident" id="3069567">After</span><span class="op" id="3069572">(</span><span class="ident" id="3069573">dt</span><span class="op" id="3069575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069581">return</span>&nbsp;<span class="op" id="3069588">&amp;</span><span class="ident" id="3069589">timeoutHandler</span><span class="op" id="3069603">{</span><span class="ident" id="3069604">h</span><span class="op" id="3069605">,</span>&nbsp;<span class="ident" id="3069607">f</span><span class="op" id="3069608">,</span>&nbsp;<span class="ident" id="3069610">msg</span><span class="op" id="3069613">}</span><br>
<span class="lineno">1895</span><span class="op" id="3069615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3069618">//&nbsp;ErrHandlerTimeout&nbsp;is&nbsp;returned&nbsp;on&nbsp;ResponseWriter&nbsp;Write&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3069681">//&nbsp;in&nbsp;handlers&nbsp;which&nbsp;have&nbsp;timed&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3069718">var</span>&nbsp;<span class="ident" id="3069722">ErrHandlerTimeout</span>&nbsp;<span class="op" id="3069740">=</span>&nbsp;<span class="ident" id="3069742">errors</span><span class="op" id="3069748">.</span><span class="ident" id="3069749">New</span><span class="op" id="3069752">(</span><span class="string" id="3069753">&#34;http:&nbsp;Handler&nbsp;timeout&#34;</span><span class="op" id="3069776">)</span><br>
<span class="lineno">1900</span><br>
<span class="lineno"></span><span class="keyword" id="3069779">type</span>&nbsp;<span class="ident" id="3069784">timeoutHandler</span>&nbsp;<span class="keyword" id="3069799">struct</span>&nbsp;<span class="op" id="3069806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069809">handler</span>&nbsp;<span class="ident" id="3069817">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069826">timeout</span>&nbsp;<span class="keyword" id="3069834">func</span><span class="op" id="3069838">(</span><span class="op" id="3069839">)</span>&nbsp;<span class="op" id="3069841">&lt;-</span><span class="keyword" id="3069843">chan</span>&nbsp;<span class="ident" id="3069848">time</span><span class="op" id="3069852">.</span><span class="ident" id="3069853">Time</span>&nbsp;<span class="comment" id="3069858">//&nbsp;returns&nbsp;channel&nbsp;producing&nbsp;a&nbsp;timeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3069898">body</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3069906">string</span><br>
<span class="lineno">1905</span><span class="op" id="3069913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3069916">func</span>&nbsp;<span class="op" id="3069921">(</span><span class="ident" id="3069922">h</span>&nbsp;<span class="op" id="3069924">*</span><span class="ident" id="3069925">timeoutHandler</span><span class="op" id="3069939">)</span>&nbsp;<span class="ident" id="3069941">errorBody</span><span class="op" id="3069950">(</span><span class="op" id="3069951">)</span>&nbsp;<span class="builtintype" id="3069953">string</span>&nbsp;<span class="op" id="3069960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069963">if</span>&nbsp;<span class="ident" id="3069966">h</span><span class="op" id="3069967">.</span><span class="ident" id="3069968">body</span>&nbsp;<span class="op" id="3069973">!=</span>&nbsp;<span class="string" id="3069976">&#34;&#34;</span>&nbsp;<span class="op" id="3069979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3069983">return</span>&nbsp;<span class="ident" id="3069990">h</span><span class="op" id="3069991">.</span><span class="ident" id="3069992">body</span><br>
<span class="lineno">1910</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3069998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070001">return</span>&nbsp;<span class="string" id="3070008">&#34;&lt;html&gt;&lt;head&gt;&lt;title&gt;Timeout&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Timeout&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3070088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070091">func</span>&nbsp;<span class="op" id="3070096">(</span><span class="ident" id="3070097">h</span>&nbsp;<span class="op" id="3070099">*</span><span class="ident" id="3070100">timeoutHandler</span><span class="op" id="3070114">)</span>&nbsp;<span class="ident" id="3070116">ServeHTTP</span><span class="op" id="3070125">(</span><span class="ident" id="3070126">w</span>&nbsp;<span class="ident" id="3070128">ResponseWriter</span><span class="op" id="3070142">,</span>&nbsp;<span class="ident" id="3070144">r</span>&nbsp;<span class="op" id="3070146">*</span><span class="ident" id="3070147">Request</span><span class="op" id="3070154">)</span>&nbsp;<span class="op" id="3070156">{</span><br>
<span class="lineno">1915</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070159">done</span>&nbsp;<span class="op" id="3070164">:=</span>&nbsp;<span class="builtinfunc" id="3070167">make</span><span class="op" id="3070171">(</span><span class="keyword" id="3070172">chan</span>&nbsp;<span class="builtintype" id="3070177">bool</span><span class="op" id="3070181">,</span>&nbsp;<span class="num" id="3070183">1</span><span class="op" id="3070184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070187">tw</span>&nbsp;<span class="op" id="3070190">:=</span>&nbsp;<span class="op" id="3070193">&amp;</span><span class="ident" id="3070194">timeoutWriter</span><span class="op" id="3070207">{</span><span class="ident" id="3070208">w</span><span class="op" id="3070209">:</span>&nbsp;<span class="ident" id="3070211">w</span><span class="op" id="3070212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070215">go</span>&nbsp;<span class="keyword" id="3070218">func</span><span class="op" id="3070222">(</span><span class="op" id="3070223">)</span>&nbsp;<span class="op" id="3070225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070229">h</span><span class="op" id="3070230">.</span><span class="ident" id="3070231">handler</span><span class="op" id="3070238">.</span><span class="ident" id="3070239">ServeHTTP</span><span class="op" id="3070248">(</span><span class="ident" id="3070249">tw</span><span class="op" id="3070251">,</span>&nbsp;<span class="ident" id="3070253">r</span><span class="op" id="3070254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070258">done</span>&nbsp;<span class="op" id="3070263">&lt;-</span>&nbsp;<span class="builtintype" id="3070266">true</span><br>
<span class="lineno">1920</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070272">}</span><span class="op" id="3070273">(</span><span class="op" id="3070274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070277">select</span>&nbsp;<span class="op" id="3070284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070287">case</span>&nbsp;<span class="op" id="3070292">&lt;-</span><span class="ident" id="3070294">done</span><span class="op" id="3070298">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070302">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070310">case</span>&nbsp;<span class="op" id="3070315">&lt;-</span><span class="ident" id="3070317">h</span><span class="op" id="3070318">.</span><span class="ident" id="3070319">timeout</span><span class="op" id="3070326">(</span><span class="op" id="3070327">)</span><span class="op" id="3070328">:</span><br>
<span class="lineno">1925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070332">tw</span><span class="op" id="3070334">.</span><span class="ident" id="3070335">mu</span><span class="op" id="3070337">.</span><span class="ident" id="3070338">Lock</span><span class="op" id="3070342">(</span><span class="op" id="3070343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070347">defer</span>&nbsp;<span class="ident" id="3070353">tw</span><span class="op" id="3070355">.</span><span class="ident" id="3070356">mu</span><span class="op" id="3070358">.</span><span class="ident" id="3070359">Unlock</span><span class="op" id="3070365">(</span><span class="op" id="3070366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070370">if</span>&nbsp;<span class="op" id="3070373">!</span><span class="ident" id="3070374">tw</span><span class="op" id="3070376">.</span><span class="ident" id="3070377">wroteHeader</span>&nbsp;<span class="op" id="3070389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070394">tw</span><span class="op" id="3070396">.</span><span class="ident" id="3070397">w</span><span class="op" id="3070398">.</span><span class="ident" id="3070399">WriteHeader</span><span class="op" id="3070410">(</span><span class="ident" id="3070411">StatusServiceUnavailable</span><span class="op" id="3070435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070440">tw</span><span class="op" id="3070442">.</span><span class="ident" id="3070443">w</span><span class="op" id="3070444">.</span><span class="ident" id="3070445">Write</span><span class="op" id="3070450">(</span><span class="op" id="3070451">[</span><span class="op" id="3070452">]</span><span class="builtintype" id="3070453">byte</span><span class="op" id="3070457">(</span><span class="ident" id="3070458">h</span><span class="op" id="3070459">.</span><span class="ident" id="3070460">errorBody</span><span class="op" id="3070469">(</span><span class="op" id="3070470">)</span><span class="op" id="3070471">)</span><span class="op" id="3070472">)</span><br>
<span class="lineno">1930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070480">tw</span><span class="op" id="3070482">.</span><span class="ident" id="3070483">timedOut</span>&nbsp;<span class="op" id="3070492">=</span>&nbsp;<span class="builtintype" id="3070494">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070500">}</span><br>
<span class="lineno"></span><span class="op" id="3070502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1935</span><span class="keyword" id="3070505">type</span>&nbsp;<span class="ident" id="3070510">timeoutWriter</span>&nbsp;<span class="keyword" id="3070524">struct</span>&nbsp;<span class="op" id="3070531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070534">w</span>&nbsp;<span class="ident" id="3070536">ResponseWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070553">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070565">sync</span><span class="op" id="3070569">.</span><span class="ident" id="3070570">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070577">timedOut</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3070589">bool</span><br>
<span class="lineno">1940</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070595">wroteHeader</span>&nbsp;<span class="builtintype" id="3070607">bool</span><br>
<span class="lineno"></span><span class="op" id="3070612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070615">func</span>&nbsp;<span class="op" id="3070620">(</span><span class="ident" id="3070621">tw</span>&nbsp;<span class="op" id="3070624">*</span><span class="ident" id="3070625">timeoutWriter</span><span class="op" id="3070638">)</span>&nbsp;<span class="ident" id="3070640">Header</span><span class="op" id="3070646">(</span><span class="op" id="3070647">)</span>&nbsp;<span class="ident" id="3070649">Header</span>&nbsp;<span class="op" id="3070656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070659">return</span>&nbsp;<span class="ident" id="3070666">tw</span><span class="op" id="3070668">.</span><span class="ident" id="3070669">w</span><span class="op" id="3070670">.</span><span class="ident" id="3070671">Header</span><span class="op" id="3070677">(</span><span class="op" id="3070678">)</span><br>
<span class="lineno">1945</span><span class="op" id="3070680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070683">func</span>&nbsp;<span class="op" id="3070688">(</span><span class="ident" id="3070689">tw</span>&nbsp;<span class="op" id="3070692">*</span><span class="ident" id="3070693">timeoutWriter</span><span class="op" id="3070706">)</span>&nbsp;<span class="ident" id="3070708">Write</span><span class="op" id="3070713">(</span><span class="ident" id="3070714">p</span>&nbsp;<span class="op" id="3070716">[</span><span class="op" id="3070717">]</span><span class="builtintype" id="3070718">byte</span><span class="op" id="3070722">)</span>&nbsp;<span class="op" id="3070724">(</span><span class="builtintype" id="3070725">int</span><span class="op" id="3070728">,</span>&nbsp;<span class="builtintype" id="3070730">error</span><span class="op" id="3070735">)</span>&nbsp;<span class="op" id="3070737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070740">tw</span><span class="op" id="3070742">.</span><span class="ident" id="3070743">mu</span><span class="op" id="3070745">.</span><span class="ident" id="3070746">Lock</span><span class="op" id="3070750">(</span><span class="op" id="3070751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070754">defer</span>&nbsp;<span class="ident" id="3070760">tw</span><span class="op" id="3070762">.</span><span class="ident" id="3070763">mu</span><span class="op" id="3070765">.</span><span class="ident" id="3070766">Unlock</span><span class="op" id="3070772">(</span><span class="op" id="3070773">)</span><br>
<span class="lineno">1950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070776">tw</span><span class="op" id="3070778">.</span><span class="ident" id="3070779">wroteHeader</span>&nbsp;<span class="op" id="3070791">=</span>&nbsp;<span class="builtintype" id="3070793">true</span>&nbsp;<span class="comment" id="3070798">//&nbsp;implicitly&nbsp;at&nbsp;least</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070822">if</span>&nbsp;<span class="ident" id="3070825">tw</span><span class="op" id="3070827">.</span><span class="ident" id="3070828">timedOut</span>&nbsp;<span class="op" id="3070837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070841">return</span>&nbsp;<span class="num" id="3070848">0</span><span class="op" id="3070849">,</span>&nbsp;<span class="ident" id="3070851">ErrHandlerTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3070870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070873">return</span>&nbsp;<span class="ident" id="3070880">tw</span><span class="op" id="3070882">.</span><span class="ident" id="3070883">w</span><span class="op" id="3070884">.</span><span class="ident" id="3070885">Write</span><span class="op" id="3070890">(</span><span class="ident" id="3070891">p</span><span class="op" id="3070892">)</span><br>
<span class="lineno">1955</span><span class="op" id="3070894">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3070897">func</span>&nbsp;<span class="op" id="3070902">(</span><span class="ident" id="3070903">tw</span>&nbsp;<span class="op" id="3070906">*</span><span class="ident" id="3070907">timeoutWriter</span><span class="op" id="3070920">)</span>&nbsp;<span class="ident" id="3070922">WriteHeader</span><span class="op" id="3070933">(</span><span class="ident" id="3070934">code</span>&nbsp;<span class="builtintype" id="3070939">int</span><span class="op" id="3070942">)</span>&nbsp;<span class="op" id="3070944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3070947">tw</span><span class="op" id="3070949">.</span><span class="ident" id="3070950">mu</span><span class="op" id="3070952">.</span><span class="ident" id="3070953">Lock</span><span class="op" id="3070957">(</span><span class="op" id="3070958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070961">defer</span>&nbsp;<span class="ident" id="3070967">tw</span><span class="op" id="3070969">.</span><span class="ident" id="3070970">mu</span><span class="op" id="3070972">.</span><span class="ident" id="3070973">Unlock</span><span class="op" id="3070979">(</span><span class="op" id="3070980">)</span><br>
<span class="lineno">1960</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3070983">if</span>&nbsp;<span class="ident" id="3070986">tw</span><span class="op" id="3070988">.</span><span class="ident" id="3070989">timedOut</span>&nbsp;<span class="op" id="3070998">||</span>&nbsp;<span class="ident" id="3071001">tw</span><span class="op" id="3071003">.</span><span class="ident" id="3071004">wroteHeader</span>&nbsp;<span class="op" id="3071016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071020">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071031">tw</span><span class="op" id="3071033">.</span><span class="ident" id="3071034">wroteHeader</span>&nbsp;<span class="op" id="3071046">=</span>&nbsp;<span class="builtintype" id="3071048">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071054">tw</span><span class="op" id="3071056">.</span><span class="ident" id="3071057">w</span><span class="op" id="3071058">.</span><span class="ident" id="3071059">WriteHeader</span><span class="op" id="3071070">(</span><span class="ident" id="3071071">code</span><span class="op" id="3071075">)</span><br>
<span class="lineno">1965</span><span class="op" id="3071077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3071080">//&nbsp;tcpKeepAliveListener&nbsp;sets&nbsp;TCP&nbsp;keep-alive&nbsp;timeouts&nbsp;on&nbsp;accepted</span><br>
<span class="lineno"></span><span class="comment" id="3071145">//&nbsp;connections.&nbsp;It&#39;s&nbsp;used&nbsp;by&nbsp;ListenAndServe&nbsp;and&nbsp;ListenAndServeTLS&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3071214">//&nbsp;dead&nbsp;TCP&nbsp;connections&nbsp;(e.g.&nbsp;closing&nbsp;laptop&nbsp;mid-download)&nbsp;eventually</span><br>
<span class="lineno">1970</span><span class="comment" id="3071284">//&nbsp;go&nbsp;away.</span><br>
<span class="lineno"></span><span class="keyword" id="3071296">type</span>&nbsp;<span class="ident" id="3071301">tcpKeepAliveListener</span>&nbsp;<span class="keyword" id="3071322">struct</span>&nbsp;<span class="op" id="3071329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071332">*</span><span class="ident" id="3071333">net</span><span class="op" id="3071336">.</span><span class="ident" id="3071337">TCPListener</span><br>
<span class="lineno"></span><span class="op" id="3071349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1975</span><span class="keyword" id="3071352">func</span>&nbsp;<span class="op" id="3071357">(</span><span class="ident" id="3071358">ln</span>&nbsp;<span class="ident" id="3071361">tcpKeepAliveListener</span><span class="op" id="3071381">)</span>&nbsp;<span class="ident" id="3071383">Accept</span><span class="op" id="3071389">(</span><span class="op" id="3071390">)</span>&nbsp;<span class="op" id="3071392">(</span><span class="ident" id="3071393">c</span>&nbsp;<span class="ident" id="3071395">net</span><span class="op" id="3071398">.</span><span class="ident" id="3071399">Conn</span><span class="op" id="3071403">,</span>&nbsp;<span class="ident" id="3071405">err</span>&nbsp;<span class="builtintype" id="3071409">error</span><span class="op" id="3071414">)</span>&nbsp;<span class="op" id="3071416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071419">tc</span><span class="op" id="3071421">,</span>&nbsp;<span class="ident" id="3071423">err</span>&nbsp;<span class="op" id="3071427">:=</span>&nbsp;<span class="ident" id="3071430">ln</span><span class="op" id="3071432">.</span><span class="ident" id="3071433">AcceptTCP</span><span class="op" id="3071442">(</span><span class="op" id="3071443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071446">if</span>&nbsp;<span class="ident" id="3071449">err</span>&nbsp;<span class="op" id="3071453">!=</span>&nbsp;<span class="builtintype" id="3071456">nil</span>&nbsp;<span class="op" id="3071460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071464">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3071472">}</span><br>
<span class="lineno">1980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071475">tc</span><span class="op" id="3071477">.</span><span class="ident" id="3071478">SetKeepAlive</span><span class="op" id="3071490">(</span><span class="builtintype" id="3071491">true</span><span class="op" id="3071495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071498">tc</span><span class="op" id="3071500">.</span><span class="ident" id="3071501">SetKeepAlivePeriod</span><span class="op" id="3071519">(</span><span class="num" id="3071520">3</span>&nbsp;<span class="op" id="3071522">*</span>&nbsp;<span class="ident" id="3071524">time</span><span class="op" id="3071528">.</span><span class="ident" id="3071529">Minute</span><span class="op" id="3071535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071538">return</span>&nbsp;<span class="ident" id="3071545">tc</span><span class="op" id="3071547">,</span>&nbsp;<span class="builtintype" id="3071549">nil</span><br>
<span class="lineno"></span><span class="op" id="3071553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1985</span><span class="comment" id="3071556">//&nbsp;globalOptionsHandler&nbsp;responds&nbsp;to&nbsp;&#34;OPTIONS&nbsp;*&#34;&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3071614">type</span>&nbsp;<span class="ident" id="3071619">globalOptionsHandler</span>&nbsp;<span class="keyword" id="3071640">struct</span><span class="op" id="3071646">{</span><span class="op" id="3071647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3071650">func</span>&nbsp;<span class="op" id="3071655">(</span><span class="ident" id="3071656">globalOptionsHandler</span><span class="op" id="3071676">)</span>&nbsp;<span class="ident" id="3071678">ServeHTTP</span><span class="op" id="3071687">(</span><span class="ident" id="3071688">w</span>&nbsp;<span class="ident" id="3071690">ResponseWriter</span><span class="op" id="3071704">,</span>&nbsp;<span class="ident" id="3071706">r</span>&nbsp;<span class="op" id="3071708">*</span><span class="ident" id="3071709">Request</span><span class="op" id="3071716">)</span>&nbsp;<span class="op" id="3071718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3071721">w</span><span class="op" id="3071722">.</span><span class="ident" id="3071723">Header</span><span class="op" id="3071729">(</span><span class="op" id="3071730">)</span><span class="op" id="3071731">.</span><span class="ident" id="3071732">Set</span><span class="op" id="3071735">(</span><span class="string" id="3071736">&#34;Content-Length&#34;</span><span class="op" id="3071752">,</span>&nbsp;<span class="string" id="3071754">&#34;0&#34;</span><span class="op" id="3071757">)</span><br>
<span class="lineno">1990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3071760">if</span>&nbsp;<span class="ident" id="3071763">r</span><span class="op" id="3071764">.</span><span class="ident" id="3071765">ContentLength</span>&nbsp;<span class="op" id="3071779">!=</span>&nbsp;<span class="num" id="3071782">0</span>&nbsp;<span class="op" id="3071784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3071788">//&nbsp;Read&nbsp;up&nbsp;to&nbsp;4KB&nbsp;of&nbsp;OPTIONS&nbsp;body&nbsp;(as&nbsp;mentioned&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3071845">//&nbsp;spec&nbsp;as&nbsp;being&nbsp;reserved&nbsp;for&nbsp;future&nbsp;use),&nbsp;but&nbsp;anything</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3071903">//&nbsp;over&nbsp;that&nbsp;is&nbsp;considered&nbsp;a&nbsp;waste&nbsp;of&nbsp;server&nbsp;resources</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3071960">//&nbsp;(or&nbsp;an&nbsp;attack)&nbsp;and&nbsp;we&nbsp;abort&nbsp;and&nbsp;close&nbsp;the&nbsp;connection,</span><br>
<span class="lineno">1995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3072019">//&nbsp;courtesy&nbsp;of&nbsp;MaxBytesReader&#39;s&nbsp;EOF&nbsp;behavior.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072067">mb</span>&nbsp;<span class="op" id="3072070">:=</span>&nbsp;<span class="ident" id="3072073">MaxBytesReader</span><span class="op" id="3072087">(</span><span class="ident" id="3072088">w</span><span class="op" id="3072089">,</span>&nbsp;<span class="ident" id="3072091">r</span><span class="op" id="3072092">.</span><span class="ident" id="3072093">Body</span><span class="op" id="3072097">,</span>&nbsp;<span class="num" id="3072099">4</span><span class="op" id="3072100">&lt;&lt;</span><span class="num" id="3072102">10</span><span class="op" id="3072104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072108">io</span><span class="op" id="3072110">.</span><span class="ident" id="3072111">Copy</span><span class="op" id="3072115">(</span><span class="ident" id="3072116">ioutil</span><span class="op" id="3072122">.</span><span class="ident" id="3072123">Discard</span><span class="op" id="3072130">,</span>&nbsp;<span class="ident" id="3072132">mb</span><span class="op" id="3072134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072137">}</span><br>
<span class="lineno"></span><span class="op" id="3072139">}</span><br>
<span class="lineno">2000</span><br>
<span class="lineno"></span><span class="keyword" id="3072142">type</span>&nbsp;<span class="ident" id="3072147">eofReaderWithWriteTo</span>&nbsp;<span class="keyword" id="3072168">struct</span><span class="op" id="3072174">{</span><span class="op" id="3072175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3072178">func</span>&nbsp;<span class="op" id="3072183">(</span><span class="ident" id="3072184">eofReaderWithWriteTo</span><span class="op" id="3072204">)</span>&nbsp;<span class="ident" id="3072206">WriteTo</span><span class="op" id="3072213">(</span><span class="ident" id="3072214">io</span><span class="op" id="3072216">.</span><span class="ident" id="3072217">Writer</span><span class="op" id="3072223">)</span>&nbsp;<span class="op" id="3072225">(</span><span class="ident" id="3072226">int64</span><span class="op" id="3072231">,</span>&nbsp;<span class="builtintype" id="3072233">error</span><span class="op" id="3072238">)</span>&nbsp;<span class="op" id="3072240">{</span>&nbsp;<span class="keyword" id="3072242">return</span>&nbsp;<span class="num" id="3072249">0</span><span class="op" id="3072250">,</span>&nbsp;<span class="builtintype" id="3072252">nil</span>&nbsp;<span class="op" id="3072256">}</span><br>
<span class="lineno"></span><span class="keyword" id="3072258">func</span>&nbsp;<span class="op" id="3072263">(</span><span class="ident" id="3072264">eofReaderWithWriteTo</span><span class="op" id="3072284">)</span>&nbsp;<span class="ident" id="3072286">Read</span><span class="op" id="3072290">(</span><span class="op" id="3072291">[</span><span class="op" id="3072292">]</span><span class="builtintype" id="3072293">byte</span><span class="op" id="3072297">)</span>&nbsp;<span class="op" id="3072299">(</span><span class="builtintype" id="3072300">int</span><span class="op" id="3072303">,</span>&nbsp;<span class="builtintype" id="3072305">error</span><span class="op" id="3072310">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3072320">{</span>&nbsp;<span class="keyword" id="3072322">return</span>&nbsp;<span class="num" id="3072329">0</span><span class="op" id="3072330">,</span>&nbsp;<span class="ident" id="3072332">io</span><span class="op" id="3072334">.</span><span class="ident" id="3072335">EOF</span>&nbsp;<span class="op" id="3072339">}</span><br>
<span class="lineno">2005</span><br>
<span class="lineno"></span><span class="comment" id="3072342">//&nbsp;eofReader&nbsp;is&nbsp;a&nbsp;non-nil&nbsp;io.ReadCloser&nbsp;that&nbsp;always&nbsp;returns&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="comment" id="3072407">//&nbsp;It&nbsp;has&nbsp;a&nbsp;WriteTo&nbsp;method&nbsp;so&nbsp;io.Copy&nbsp;won&#39;t&nbsp;need&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3072466">var</span>&nbsp;<span class="ident" id="3072470">eofReader</span>&nbsp;<span class="op" id="3072480">=</span>&nbsp;<span class="op" id="3072482">&amp;</span><span class="keyword" id="3072483">struct</span>&nbsp;<span class="op" id="3072490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072493">eofReaderWithWriteTo</span><br>
<span class="lineno">2010</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072515">io</span><span class="op" id="3072517">.</span><span class="ident" id="3072518">Closer</span><br>
<span class="lineno"></span><span class="op" id="3072525">}</span><span class="op" id="3072526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072529">eofReaderWithWriteTo</span><span class="op" id="3072549">{</span><span class="op" id="3072550">}</span><span class="op" id="3072551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072554">ioutil</span><span class="op" id="3072560">.</span><span class="ident" id="3072561">NopCloser</span><span class="op" id="3072570">(</span><span class="builtintype" id="3072571">nil</span><span class="op" id="3072574">)</span><span class="op" id="3072575">,</span><br>
<span class="lineno"></span><span class="op" id="3072577">}</span><br>
<span class="lineno">2015</span><br>
<span class="lineno"></span><span class="comment" id="3072580">//&nbsp;Verify&nbsp;that&nbsp;an&nbsp;io.Copy&nbsp;from&nbsp;an&nbsp;eofReader&nbsp;won&#39;t&nbsp;require&nbsp;a&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3072648">var</span>&nbsp;<span class="ident" id="3072652">_</span>&nbsp;<span class="ident" id="3072654">io</span><span class="op" id="3072656">.</span><span class="ident" id="3072657">WriterTo</span>&nbsp;<span class="op" id="3072666">=</span>&nbsp;<span class="ident" id="3072668">eofReader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3072679">//&nbsp;initNPNRequest&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;that&nbsp;initializes&nbsp;certain</span><br>
<span class="lineno">2020</span><span class="comment" id="3072741">//&nbsp;uninitialized&nbsp;fields&nbsp;in&nbsp;its&nbsp;*Request.&nbsp;Such&nbsp;partially-initialized</span><br>
<span class="lineno"></span><span class="comment" id="3072809">//&nbsp;Requests&nbsp;come&nbsp;from&nbsp;NPN&nbsp;protocol&nbsp;handlers.</span><br>
<span class="lineno"></span><span class="keyword" id="3072854">type</span>&nbsp;<span class="ident" id="3072859">initNPNRequest</span>&nbsp;<span class="keyword" id="3072874">struct</span>&nbsp;<span class="op" id="3072881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072884">c</span>&nbsp;<span class="op" id="3072886">*</span><span class="ident" id="3072887">tls</span><span class="op" id="3072890">.</span><span class="ident" id="3072891">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3072897">h</span>&nbsp;<span class="ident" id="3072899">serverHandler</span><br>
<span class="lineno">2025</span><span class="op" id="3072913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3072916">func</span>&nbsp;<span class="op" id="3072921">(</span><span class="ident" id="3072922">h</span>&nbsp;<span class="ident" id="3072924">initNPNRequest</span><span class="op" id="3072938">)</span>&nbsp;<span class="ident" id="3072940">ServeHTTP</span><span class="op" id="3072949">(</span><span class="ident" id="3072950">rw</span>&nbsp;<span class="ident" id="3072953">ResponseWriter</span><span class="op" id="3072967">,</span>&nbsp;<span class="ident" id="3072969">req</span>&nbsp;<span class="op" id="3072973">*</span><span class="ident" id="3072974">Request</span><span class="op" id="3072981">)</span>&nbsp;<span class="op" id="3072983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3072986">if</span>&nbsp;<span class="ident" id="3072989">req</span><span class="op" id="3072992">.</span><span class="ident" id="3072993">TLS</span>&nbsp;<span class="op" id="3072997">==</span>&nbsp;<span class="builtintype" id="3073000">nil</span>&nbsp;<span class="op" id="3073004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073008">req</span><span class="op" id="3073011">.</span><span class="ident" id="3073012">TLS</span>&nbsp;<span class="op" id="3073016">=</span>&nbsp;<span class="op" id="3073018">&amp;</span><span class="ident" id="3073019">tls</span><span class="op" id="3073022">.</span><span class="ident" id="3073023">ConnectionState</span><span class="op" id="3073038">{</span><span class="op" id="3073039">}</span><br>
<span class="lineno">2030</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073043">*</span><span class="ident" id="3073044">req</span><span class="op" id="3073047">.</span><span class="ident" id="3073048">TLS</span>&nbsp;<span class="op" id="3073052">=</span>&nbsp;<span class="ident" id="3073054">h</span><span class="op" id="3073055">.</span><span class="ident" id="3073056">c</span><span class="op" id="3073057">.</span><span class="ident" id="3073058">ConnectionState</span><span class="op" id="3073073">(</span><span class="op" id="3073074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073080">if</span>&nbsp;<span class="ident" id="3073083">req</span><span class="op" id="3073086">.</span><span class="ident" id="3073087">Body</span>&nbsp;<span class="op" id="3073092">==</span>&nbsp;<span class="builtintype" id="3073095">nil</span>&nbsp;<span class="op" id="3073099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073103">req</span><span class="op" id="3073106">.</span><span class="ident" id="3073107">Body</span>&nbsp;<span class="op" id="3073112">=</span>&nbsp;<span class="ident" id="3073114">eofReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073125">}</span><br>
<span class="lineno">2035</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073128">if</span>&nbsp;<span class="ident" id="3073131">req</span><span class="op" id="3073134">.</span><span class="ident" id="3073135">RemoteAddr</span>&nbsp;<span class="op" id="3073146">==</span>&nbsp;<span class="string" id="3073149">&#34;&#34;</span>&nbsp;<span class="op" id="3073152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073156">req</span><span class="op" id="3073159">.</span><span class="ident" id="3073160">RemoteAddr</span>&nbsp;<span class="op" id="3073171">=</span>&nbsp;<span class="ident" id="3073173">h</span><span class="op" id="3073174">.</span><span class="ident" id="3073175">c</span><span class="op" id="3073176">.</span><span class="ident" id="3073177">RemoteAddr</span><span class="op" id="3073187">(</span><span class="op" id="3073188">)</span><span class="op" id="3073189">.</span><span class="ident" id="3073190">String</span><span class="op" id="3073196">(</span><span class="op" id="3073197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073203">h</span><span class="op" id="3073204">.</span><span class="ident" id="3073205">h</span><span class="op" id="3073206">.</span><span class="ident" id="3073207">ServeHTTP</span><span class="op" id="3073216">(</span><span class="ident" id="3073217">rw</span><span class="op" id="3073219">,</span>&nbsp;<span class="ident" id="3073221">req</span><span class="op" id="3073224">)</span><br>
<span class="lineno"></span><span class="op" id="3073226">}</span><br>
<span class="lineno">2040</span><br>
<span class="lineno"></span><span class="comment" id="3073229">//&nbsp;loggingConn&nbsp;is&nbsp;used&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="keyword" id="3073267">type</span>&nbsp;<span class="ident" id="3073272">loggingConn</span>&nbsp;<span class="keyword" id="3073284">struct</span>&nbsp;<span class="op" id="3073291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073294">name</span>&nbsp;<span class="builtintype" id="3073299">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073307">net</span><span class="op" id="3073310">.</span><span class="ident" id="3073311">Conn</span><br>
<span class="lineno">2045</span><span class="op" id="3073316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3073319">var</span>&nbsp;<span class="op" id="3073323">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073326">uniqNameMu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3073339">sync</span><span class="op" id="3073343">.</span><span class="ident" id="3073344">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073351">uniqNameNext</span>&nbsp;<span class="op" id="3073364">=</span>&nbsp;<span class="builtinfunc" id="3073366">make</span><span class="op" id="3073370">(</span><span class="keyword" id="3073371">map</span><span class="op" id="3073374">[</span><span class="builtintype" id="3073375">string</span><span class="op" id="3073381">]</span><span class="builtintype" id="3073382">int</span><span class="op" id="3073385">)</span><br>
<span class="lineno">2050</span><span class="op" id="3073387">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3073390">func</span>&nbsp;<span class="ident" id="3073395">newLoggingConn</span><span class="op" id="3073409">(</span><span class="ident" id="3073410">baseName</span>&nbsp;<span class="builtintype" id="3073419">string</span><span class="op" id="3073425">,</span>&nbsp;<span class="ident" id="3073427">c</span>&nbsp;<span class="ident" id="3073429">net</span><span class="op" id="3073432">.</span><span class="ident" id="3073433">Conn</span><span class="op" id="3073437">)</span>&nbsp;<span class="ident" id="3073439">net</span><span class="op" id="3073442">.</span><span class="ident" id="3073443">Conn</span>&nbsp;<span class="op" id="3073448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073451">uniqNameMu</span><span class="op" id="3073461">.</span><span class="ident" id="3073462">Lock</span><span class="op" id="3073466">(</span><span class="op" id="3073467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073470">defer</span>&nbsp;<span class="ident" id="3073476">uniqNameMu</span><span class="op" id="3073486">.</span><span class="ident" id="3073487">Unlock</span><span class="op" id="3073493">(</span><span class="op" id="3073494">)</span><br>
<span class="lineno">2055</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073497">uniqNameNext</span><span class="op" id="3073509">[</span><span class="ident" id="3073510">baseName</span><span class="op" id="3073518">]</span><span class="op" id="3073519">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073523">return</span>&nbsp;<span class="op" id="3073530">&amp;</span><span class="ident" id="3073531">loggingConn</span><span class="op" id="3073542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073546">name</span><span class="op" id="3073550">:</span>&nbsp;<span class="ident" id="3073552">fmt</span><span class="op" id="3073555">.</span><span class="ident" id="3073556">Sprintf</span><span class="op" id="3073563">(</span><span class="string" id="3073564">&#34;%s-%d&#34;</span><span class="op" id="3073571">,</span>&nbsp;<span class="ident" id="3073573">baseName</span><span class="op" id="3073581">,</span>&nbsp;<span class="ident" id="3073583">uniqNameNext</span><span class="op" id="3073595">[</span><span class="ident" id="3073596">baseName</span><span class="op" id="3073604">]</span><span class="op" id="3073605">)</span><span class="op" id="3073606">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073610">Conn</span><span class="op" id="3073614">:</span>&nbsp;<span class="ident" id="3073616">c</span><span class="op" id="3073617">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3073620">}</span><br>
<span class="lineno">2060</span><span class="op" id="3073622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3073625">func</span>&nbsp;<span class="op" id="3073630">(</span><span class="ident" id="3073631">c</span>&nbsp;<span class="op" id="3073633">*</span><span class="ident" id="3073634">loggingConn</span><span class="op" id="3073645">)</span>&nbsp;<span class="ident" id="3073647">Write</span><span class="op" id="3073652">(</span><span class="ident" id="3073653">p</span>&nbsp;<span class="op" id="3073655">[</span><span class="op" id="3073656">]</span><span class="builtintype" id="3073657">byte</span><span class="op" id="3073661">)</span>&nbsp;<span class="op" id="3073663">(</span><span class="ident" id="3073664">n</span>&nbsp;<span class="builtintype" id="3073666">int</span><span class="op" id="3073669">,</span>&nbsp;<span class="ident" id="3073671">err</span>&nbsp;<span class="builtintype" id="3073675">error</span><span class="op" id="3073680">)</span>&nbsp;<span class="op" id="3073682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073685">log</span><span class="op" id="3073688">.</span><span class="ident" id="3073689">Printf</span><span class="op" id="3073695">(</span><span class="string" id="3073696">&#34;%s.Write(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3073717">,</span>&nbsp;<span class="ident" id="3073719">c</span><span class="op" id="3073720">.</span><span class="ident" id="3073721">name</span><span class="op" id="3073725">,</span>&nbsp;<span class="builtinfunc" id="3073727">len</span><span class="op" id="3073730">(</span><span class="ident" id="3073731">p</span><span class="op" id="3073732">)</span><span class="op" id="3073733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073736">n</span><span class="op" id="3073737">,</span>&nbsp;<span class="ident" id="3073739">err</span>&nbsp;<span class="op" id="3073743">=</span>&nbsp;<span class="ident" id="3073745">c</span><span class="op" id="3073746">.</span><span class="ident" id="3073747">Conn</span><span class="op" id="3073751">.</span><span class="ident" id="3073752">Write</span><span class="op" id="3073757">(</span><span class="ident" id="3073758">p</span><span class="op" id="3073759">)</span><br>
<span class="lineno">2065</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073762">log</span><span class="op" id="3073765">.</span><span class="ident" id="3073766">Printf</span><span class="op" id="3073772">(</span><span class="string" id="3073773">&#34;%s.Write(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3073796">,</span>&nbsp;<span class="ident" id="3073798">c</span><span class="op" id="3073799">.</span><span class="ident" id="3073800">name</span><span class="op" id="3073804">,</span>&nbsp;<span class="builtinfunc" id="3073806">len</span><span class="op" id="3073809">(</span><span class="ident" id="3073810">p</span><span class="op" id="3073811">)</span><span class="op" id="3073812">,</span>&nbsp;<span class="ident" id="3073814">n</span><span class="op" id="3073815">,</span>&nbsp;<span class="ident" id="3073817">err</span><span class="op" id="3073820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3073823">return</span><br>
<span class="lineno"></span><span class="op" id="3073830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3073833">func</span>&nbsp;<span class="op" id="3073838">(</span><span class="ident" id="3073839">c</span>&nbsp;<span class="op" id="3073841">*</span><span class="ident" id="3073842">loggingConn</span><span class="op" id="3073853">)</span>&nbsp;<span class="ident" id="3073855">Read</span><span class="op" id="3073859">(</span><span class="ident" id="3073860">p</span>&nbsp;<span class="op" id="3073862">[</span><span class="op" id="3073863">]</span><span class="builtintype" id="3073864">byte</span><span class="op" id="3073868">)</span>&nbsp;<span class="op" id="3073870">(</span><span class="ident" id="3073871">n</span>&nbsp;<span class="builtintype" id="3073873">int</span><span class="op" id="3073876">,</span>&nbsp;<span class="ident" id="3073878">err</span>&nbsp;<span class="builtintype" id="3073882">error</span><span class="op" id="3073887">)</span>&nbsp;<span class="op" id="3073889">{</span><br>
<span class="lineno">2070</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073892">log</span><span class="op" id="3073895">.</span><span class="ident" id="3073896">Printf</span><span class="op" id="3073902">(</span><span class="string" id="3073903">&#34;%s.Read(%d)&nbsp;=&nbsp;....&#34;</span><span class="op" id="3073923">,</span>&nbsp;<span class="ident" id="3073925">c</span><span class="op" id="3073926">.</span><span class="ident" id="3073927">name</span><span class="op" id="3073931">,</span>&nbsp;<span class="builtinfunc" id="3073933">len</span><span class="op" id="3073936">(</span><span class="ident" id="3073937">p</span><span class="op" id="3073938">)</span><span class="op" id="3073939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073942">n</span><span class="op" id="3073943">,</span>&nbsp;<span class="ident" id="3073945">err</span>&nbsp;<span class="op" id="3073949">=</span>&nbsp;<span class="ident" id="3073951">c</span><span class="op" id="3073952">.</span><span class="ident" id="3073953">Conn</span><span class="op" id="3073957">.</span><span class="ident" id="3073958">Read</span><span class="op" id="3073962">(</span><span class="ident" id="3073963">p</span><span class="op" id="3073964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3073967">log</span><span class="op" id="3073970">.</span><span class="ident" id="3073971">Printf</span><span class="op" id="3073977">(</span><span class="string" id="3073978">&#34;%s.Read(%d)&nbsp;=&nbsp;%d,&nbsp;%v&#34;</span><span class="op" id="3074000">,</span>&nbsp;<span class="ident" id="3074002">c</span><span class="op" id="3074003">.</span><span class="ident" id="3074004">name</span><span class="op" id="3074008">,</span>&nbsp;<span class="builtinfunc" id="3074010">len</span><span class="op" id="3074013">(</span><span class="ident" id="3074014">p</span><span class="op" id="3074015">)</span><span class="op" id="3074016">,</span>&nbsp;<span class="ident" id="3074018">n</span><span class="op" id="3074019">,</span>&nbsp;<span class="ident" id="3074021">err</span><span class="op" id="3074024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074027">return</span><br>
<span class="lineno"></span><span class="op" id="3074034">}</span><br>
<span class="lineno">2075</span><br>
<span class="lineno"></span><span class="keyword" id="3074037">func</span>&nbsp;<span class="op" id="3074042">(</span><span class="ident" id="3074043">c</span>&nbsp;<span class="op" id="3074045">*</span><span class="ident" id="3074046">loggingConn</span><span class="op" id="3074057">)</span>&nbsp;<span class="ident" id="3074059">Close</span><span class="op" id="3074064">(</span><span class="op" id="3074065">)</span>&nbsp;<span class="op" id="3074067">(</span><span class="ident" id="3074068">err</span>&nbsp;<span class="builtintype" id="3074072">error</span><span class="op" id="3074077">)</span>&nbsp;<span class="op" id="3074079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074082">log</span><span class="op" id="3074085">.</span><span class="ident" id="3074086">Printf</span><span class="op" id="3074092">(</span><span class="string" id="3074093">&#34;%s.Close()&nbsp;=&nbsp;...&#34;</span><span class="op" id="3074111">,</span>&nbsp;<span class="ident" id="3074113">c</span><span class="op" id="3074114">.</span><span class="ident" id="3074115">name</span><span class="op" id="3074119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074122">err</span>&nbsp;<span class="op" id="3074126">=</span>&nbsp;<span class="ident" id="3074128">c</span><span class="op" id="3074129">.</span><span class="ident" id="3074130">Conn</span><span class="op" id="3074134">.</span><span class="ident" id="3074135">Close</span><span class="op" id="3074140">(</span><span class="op" id="3074141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074144">log</span><span class="op" id="3074147">.</span><span class="ident" id="3074148">Printf</span><span class="op" id="3074154">(</span><span class="string" id="3074155">&#34;%s.Close()&nbsp;=&nbsp;%v&#34;</span><span class="op" id="3074172">,</span>&nbsp;<span class="ident" id="3074174">c</span><span class="op" id="3074175">.</span><span class="ident" id="3074176">name</span><span class="op" id="3074180">,</span>&nbsp;<span class="ident" id="3074182">err</span><span class="op" id="3074185">)</span><br>
<span class="lineno">2080</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074188">return</span><br>
<span class="lineno"></span><span class="op" id="3074195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3074198">//&nbsp;checkConnErrorWriter&nbsp;writes&nbsp;to&nbsp;c.rwc&nbsp;and&nbsp;records&nbsp;any&nbsp;write&nbsp;errors&nbsp;to&nbsp;c.werr.</span><br>
<span class="lineno"></span><span class="comment" id="3074278">//&nbsp;It&nbsp;only&nbsp;contains&nbsp;one&nbsp;field&nbsp;(and&nbsp;a&nbsp;pointer&nbsp;field&nbsp;at&nbsp;that),&nbsp;so&nbsp;it</span><br>
<span class="lineno">2085</span><span class="comment" id="3074345">//&nbsp;fits&nbsp;in&nbsp;an&nbsp;interface&nbsp;value&nbsp;without&nbsp;an&nbsp;extra&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3074404">type</span>&nbsp;<span class="ident" id="3074409">checkConnErrorWriter</span>&nbsp;<span class="keyword" id="3074430">struct</span>&nbsp;<span class="op" id="3074437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074440">c</span>&nbsp;<span class="op" id="3074442">*</span><span class="ident" id="3074443">conn</span><br>
<span class="lineno"></span><span class="op" id="3074448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">2090</span><span class="keyword" id="3074451">func</span>&nbsp;<span class="op" id="3074456">(</span><span class="ident" id="3074457">w</span>&nbsp;<span class="ident" id="3074459">checkConnErrorWriter</span><span class="op" id="3074479">)</span>&nbsp;<span class="ident" id="3074481">Write</span><span class="op" id="3074486">(</span><span class="ident" id="3074487">p</span>&nbsp;<span class="op" id="3074489">[</span><span class="op" id="3074490">]</span><span class="builtintype" id="3074491">byte</span><span class="op" id="3074495">)</span>&nbsp;<span class="op" id="3074497">(</span><span class="ident" id="3074498">n</span>&nbsp;<span class="builtintype" id="3074500">int</span><span class="op" id="3074503">,</span>&nbsp;<span class="ident" id="3074505">err</span>&nbsp;<span class="builtintype" id="3074509">error</span><span class="op" id="3074514">)</span>&nbsp;<span class="op" id="3074516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074519">n</span><span class="op" id="3074520">,</span>&nbsp;<span class="ident" id="3074522">err</span>&nbsp;<span class="op" id="3074526">=</span>&nbsp;<span class="ident" id="3074528">w</span><span class="op" id="3074529">.</span><span class="ident" id="3074530">c</span><span class="op" id="3074531">.</span><span class="ident" id="3074532">w</span><span class="op" id="3074533">.</span><span class="ident" id="3074534">Write</span><span class="op" id="3074539">(</span><span class="ident" id="3074540">p</span><span class="op" id="3074541">)</span>&nbsp;<span class="comment" id="3074543">//&nbsp;c.w&nbsp;==&nbsp;c.rwc,&nbsp;except&nbsp;after&nbsp;a&nbsp;hijack,&nbsp;when&nbsp;rwc&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074601">if</span>&nbsp;<span class="ident" id="3074604">err</span>&nbsp;<span class="op" id="3074608">!=</span>&nbsp;<span class="builtintype" id="3074611">nil</span>&nbsp;<span class="op" id="3074615">&amp;&amp;</span>&nbsp;<span class="ident" id="3074618">w</span><span class="op" id="3074619">.</span><span class="ident" id="3074620">c</span><span class="op" id="3074621">.</span><span class="ident" id="3074622">werr</span>&nbsp;<span class="op" id="3074627">==</span>&nbsp;<span class="builtintype" id="3074630">nil</span>&nbsp;<span class="op" id="3074634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3074638">w</span><span class="op" id="3074639">.</span><span class="ident" id="3074640">c</span><span class="op" id="3074641">.</span><span class="ident" id="3074642">werr</span>&nbsp;<span class="op" id="3074647">=</span>&nbsp;<span class="ident" id="3074649">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3074654">}</span><br>
<span class="lineno">2095</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3074657">return</span><br>
<span class="lineno"></span><span class="op" id="3074664">}</span>
</div>
</body>
</html>
