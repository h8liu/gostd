<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">skipServerTest</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">unixsotype</span><span class="op">,</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">,</span>&nbsp;<span class="ident">linuxOnly</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;linux&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;nacl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;windows&#34;</span><span class="op">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;unix&#34;&nbsp;sockets&nbsp;are&nbsp;not&nbsp;supported&nbsp;on&nbsp;Windows&nbsp;and&nbsp;Plan&nbsp;9.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">unixsotype</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">unixsotype</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">linuxOnly</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">addr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ipv6</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ipv4map</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv4map</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">streamConnServerTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">snet</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;server&nbsp;side</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">saddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cnet</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;client&nbsp;side</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">caddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipv6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;underlying&nbsp;AF_INET6&nbsp;socket</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipv4map</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;IPv6&nbsp;IPv4-mapping&nbsp;functionality</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;empty&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">linuxOnly</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;abstract&nbsp;unix&nbsp;domain&nbsp;socket,&nbsp;a&nbsp;Linux-ism</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:127.0.0.1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest2/net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest2/net.local&#34;</span><span class="op">,</span>&nbsp;<span class="ident">linuxOnly</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestStreamConnServer</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">streamConnServerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">skipServerTest</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span><span class="op">,</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv6</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv4map</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">linuxOnly</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">runStreamConnServer</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">,</span>&nbsp;<span class="ident">listening</span><span class="op">,</span>&nbsp;<span class="ident">done</span><span class="op">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">taddr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">listening</span>&nbsp;<span class="comment">//&nbsp;wait&nbsp;for&nbsp;server&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">cnet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">SplitHostPort</span><span class="op">(</span><span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;SplitHostPort(%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">taddr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runStreamConnClient</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">cnet</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">empty</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">done</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;sure&nbsp;server&nbsp;stopped</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unix&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">130</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">seqpacketConnServerTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">saddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;server&nbsp;address</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">caddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;client&nbsp;address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;empty&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">linuxOnly</span>&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;abstract&nbsp;unix&nbsp;domain&nbsp;socket,&nbsp;a&nbsp;Linux-ism</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest4/net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest4/net.local&#34;</span><span class="op">,</span>&nbsp;<span class="ident">linuxOnly</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestSeqpacketConnServer</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;darwin&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;nacl&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;openbsd&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;windows&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;freebsd&#34;</span><span class="op">:</span>&nbsp;<span class="comment">//&nbsp;FreeBSD&nbsp;8&nbsp;doesn&#39;t&nbsp;support&nbsp;unixpacket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">seqpacketConnServerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="string">&#34;linux&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">linuxOnly</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">runStreamConnServer</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">,</span>&nbsp;<span class="ident">listening</span><span class="op">,</span>&nbsp;<span class="ident">done</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">taddr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">listening</span>&nbsp;<span class="comment">//&nbsp;wait&nbsp;for&nbsp;server&nbsp;to&nbsp;start</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runStreamConnClient</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">empty</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">done</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;sure&nbsp;server&nbsp;stopped</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">175</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runStreamConnServer</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">listening</span>&nbsp;<span class="keyword">chan</span><span class="op">&lt;-</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="keyword">chan</span><span class="op">&lt;-</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="builtinfunc">close</span><span class="op">(</span><span class="ident">done</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;Listen(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Addr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">echo</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">rw</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadWriter</span><span class="op">,</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="keyword">chan</span><span class="op">&lt;-</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1024</span><span class="op">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">rw</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="builtintype">string</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;END&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rw</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">close</span><span class="op">(</span><span class="ident">done</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="ident">run</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Accept</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Logf</span><span class="op">(</span><span class="string">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">echodone</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">echo</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">echodone</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">echodone</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;sure&nbsp;echo&nbsp;stopped</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword">func</span>&nbsp;<span class="ident">runStreamConnClient</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">isEmpty</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Dial(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">SetReadDeadline</span><span class="op">(</span><span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="num">1</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Second</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">wb</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isEmpty</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;StreamConnClient&nbsp;by&nbsp;Dial\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Write&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1024</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">rb</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Read&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Send&nbsp;explicit&nbsp;ending&nbsp;for&nbsp;unixpacket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Older&nbsp;Linux&nbsp;kernels&nbsp;do&nbsp;not&nbsp;stop&nbsp;reads&nbsp;on&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixpacket&#34;</span><span class="op">:</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;END&#34;</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Do&nbsp;not&nbsp;test&nbsp;empty&nbsp;datagrams&nbsp;by&nbsp;default.</span><br>
<span class="lineno">245</span><span class="comment">//&nbsp;It&nbsp;causes&nbsp;unexplained&nbsp;timeouts&nbsp;on&nbsp;some&nbsp;systems,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;including&nbsp;Snow&nbsp;Leopard.&nbsp;&nbsp;I&nbsp;think&nbsp;that&nbsp;the&nbsp;kernel</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;doesn&#39;t&nbsp;quite&nbsp;expect&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">testDatagram</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">flag</span><span class="op">.</span><span class="ident">Bool</span><span class="op">(</span><span class="string">&#34;datagram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">,</span>&nbsp;<span class="string">&#34;whether&nbsp;to&nbsp;test&nbsp;udp&nbsp;and&nbsp;unixgram&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="keyword">var</span>&nbsp;<span class="ident">datagramPacketConnServerTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">snet</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;server&nbsp;side</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">saddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cnet</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;client&nbsp;side</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">caddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipv6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;underlying&nbsp;AF_INET6&nbsp;socket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipv4map</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;IPv6&nbsp;IPv4-mapping&nbsp;functionality</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">dial</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;Dial&nbsp;or&nbsp;DialUnix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">empty</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;empty&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">linuxOnly</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;abstract&nbsp;unix&nbsp;domain&nbsp;socket,&nbsp;a&nbsp;Linux-ism</span><br>
<span class="lineno">260</span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv4map</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:127.0.0.1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="ident">testUnixAddr</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">dial</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">empty</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">snet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">saddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest6/net&#34;</span><span class="op">,</span>&nbsp;<span class="ident">cnet</span><span class="op">:</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">caddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;@gotest6/net.local&#34;</span><span class="op">,</span>&nbsp;<span class="ident">linuxOnly</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">310</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestDatagramPacketConnServer</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testDatagram</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">datagramPacketConnServerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">skipServerTest</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span><span class="op">,</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv6</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv4map</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">linuxOnly</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">chan</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">go</span>&nbsp;<span class="ident">runDatagramPacketConnServer</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">,</span>&nbsp;<span class="ident">listening</span><span class="op">,</span>&nbsp;<span class="ident">done</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">taddr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&lt;-</span><span class="ident">listening</span>&nbsp;<span class="comment">//&nbsp;wait&nbsp;for&nbsp;server&nbsp;to&nbsp;start</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">cnet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">SplitHostPort</span><span class="op">(</span><span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;SplitHostPort(%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">taddr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">dial</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runDatagramConnClient</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">cnet</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">empty</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">runDatagramPacketConnClient</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">cnet</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">empty</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">done</span>&nbsp;<span class="comment">//&nbsp;tell&nbsp;server&nbsp;to&nbsp;stop</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">&lt;-</span><span class="ident">done</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;sure&nbsp;server&nbsp;stopped</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">snet</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">saddr</span><span class="op">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">os</span><span class="op">.</span><span class="ident">Remove</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">caddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="keyword">func</span>&nbsp;<span class="ident">runDatagramPacketConnServer</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">listening</span>&nbsp;<span class="keyword">chan</span><span class="op">&lt;-</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="keyword">chan</span><span class="op">&lt;-</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;ListenPacket(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">listening</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">LocalAddr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">370</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1024</span><span class="op">)</span><br>
<span class="lineno"></span><span class="ident">run</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">SetReadDeadline</span><span class="op">(</span><span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="num">10</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Millisecond</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">ReadFrom</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nerr</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">err</span><span class="op">.</span><span class="op">(</span><span class="ident">Error</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">nerr</span><span class="op">.</span><span class="ident">Timeout</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">select</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="num">1</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">WriteTo</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">n</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;WriteTo(%v)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span>&nbsp;<span class="ident">run</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">&lt;-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span><span class="keyword">func</span>&nbsp;<span class="ident">runDatagramConnClient</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">isEmpty</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="ident">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Dial(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">DialUnix</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">UnixAddr</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">UnixAddr</span><span class="op">{</span><span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">Net</span><span class="op">:</span>&nbsp;<span class="ident">net</span><span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;DialUnix(%q,&nbsp;{%q,&nbsp;%q})&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">SetReadDeadline</span><span class="op">(</span><span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="num">1</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Second</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">wb</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isEmpty</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;DatagramConnClient&nbsp;by&nbsp;Dial\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">wb</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Write&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1024</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Read</span><span class="op">(</span><span class="ident">rb</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Read&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">425</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">runDatagramPacketConnClient</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">isEmpty</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ra</span>&nbsp;<span class="ident">Addr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ResolveUDPAddr</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ResolveUDPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;unixgram&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ResolveUnixAddr</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ResolveUxixAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">taddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ListenPacket(%q,&nbsp;%q)&nbsp;faild:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">SetReadDeadline</span><span class="op">(</span><span class="ident">time</span><span class="op">.</span><span class="ident">Now</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="num">1</span>&nbsp;<span class="op">*</span>&nbsp;<span class="ident">time</span><span class="op">.</span><span class="ident">Second</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">wb</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">isEmpty</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wb</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="string">&#34;DatagramPacketConnClient&nbsp;by&nbsp;ListenPacket\n&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">WriteTo</span><span class="op">(</span><span class="ident">wb</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;WriteTo(%v)&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ra</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rb</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1024</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">ReadFrom</span><span class="op">(</span><span class="ident">rb</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ReadFrom&nbsp;failed:&nbsp;%v,&nbsp;%v;&nbsp;want&nbsp;%v,&nbsp;&lt;nil&gt;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">wb</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
