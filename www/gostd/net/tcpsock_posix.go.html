<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html" class="current">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3850967">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3851023">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3851077">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3851128">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3851206">package</span>&nbsp;<span class="ident" id="3851214">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3851219">import</span>&nbsp;<span class="op" id="3851226">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3851229">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3851235">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3851241">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3851252">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3851259">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3851262">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3851338">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3851415">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3851491">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3851565">func</span>&nbsp;<span class="ident" id="3851570">sockaddrToTCP</span><span class="op" id="3851583">(</span><span class="ident" id="3851584">sa</span>&nbsp;<span class="ident" id="3851587">syscall</span><span class="op" id="3851594">.</span><span class="ident" id="3851595">Sockaddr</span><span class="op" id="3851603">)</span>&nbsp;<span class="ident" id="3851605">Addr</span>&nbsp;<span class="op" id="3851610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851613">switch</span>&nbsp;<span class="ident" id="3851620">sa</span>&nbsp;<span class="op" id="3851623">:=</span>&nbsp;<span class="ident" id="3851626">sa</span><span class="op" id="3851628">.</span><span class="op" id="3851629">(</span><span class="keyword" id="3851630">type</span><span class="op" id="3851634">)</span>&nbsp;<span class="op" id="3851636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851639">case</span>&nbsp;<span class="op" id="3851644">*</span><span class="ident" id="3851645">syscall</span><span class="op" id="3851652">.</span><span class="ident" id="3851653">SockaddrInet4</span><span class="op" id="3851666">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851670">return</span>&nbsp;<span class="op" id="3851677">&amp;</span><span class="ident" id="3851678">TCPAddr</span><span class="op" id="3851685">{</span><span class="ident" id="3851686">IP</span><span class="op" id="3851688">:</span>&nbsp;<span class="ident" id="3851690">sa</span><span class="op" id="3851692">.</span><span class="ident" id="3851693">Addr</span><span class="op" id="3851697">[</span><span class="num" id="3851698">0</span><span class="op" id="3851699">:</span><span class="op" id="3851700">]</span><span class="op" id="3851701">,</span>&nbsp;<span class="ident" id="3851703">Port</span><span class="op" id="3851707">:</span>&nbsp;<span class="ident" id="3851709">sa</span><span class="op" id="3851711">.</span><span class="ident" id="3851712">Port</span><span class="op" id="3851716">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851719">case</span>&nbsp;<span class="op" id="3851724">*</span><span class="ident" id="3851725">syscall</span><span class="op" id="3851732">.</span><span class="ident" id="3851733">SockaddrInet6</span><span class="op" id="3851746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851750">return</span>&nbsp;<span class="op" id="3851757">&amp;</span><span class="ident" id="3851758">TCPAddr</span><span class="op" id="3851765">{</span><span class="ident" id="3851766">IP</span><span class="op" id="3851768">:</span>&nbsp;<span class="ident" id="3851770">sa</span><span class="op" id="3851772">.</span><span class="ident" id="3851773">Addr</span><span class="op" id="3851777">[</span><span class="num" id="3851778">0</span><span class="op" id="3851779">:</span><span class="op" id="3851780">]</span><span class="op" id="3851781">,</span>&nbsp;<span class="ident" id="3851783">Port</span><span class="op" id="3851787">:</span>&nbsp;<span class="ident" id="3851789">sa</span><span class="op" id="3851791">.</span><span class="ident" id="3851792">Port</span><span class="op" id="3851796">,</span>&nbsp;<span class="ident" id="3851798">Zone</span><span class="op" id="3851802">:</span>&nbsp;<span class="ident" id="3851804">zoneToString</span><span class="op" id="3851816">(</span><span class="builtintype" id="3851817">int</span><span class="op" id="3851820">(</span><span class="ident" id="3851821">sa</span><span class="op" id="3851823">.</span><span class="ident" id="3851824">ZoneId</span><span class="op" id="3851830">)</span><span class="op" id="3851831">)</span><span class="op" id="3851832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851838">return</span>&nbsp;<span class="builtintype" id="3851845">nil</span><br>
<span class="lineno"></span><span class="op" id="3851849">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3851852">func</span>&nbsp;<span class="op" id="3851857">(</span><span class="ident" id="3851858">a</span>&nbsp;<span class="op" id="3851860">*</span><span class="ident" id="3851861">TCPAddr</span><span class="op" id="3851868">)</span>&nbsp;<span class="ident" id="3851870">family</span><span class="op" id="3851876">(</span><span class="op" id="3851877">)</span>&nbsp;<span class="builtintype" id="3851879">int</span>&nbsp;<span class="op" id="3851883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851886">if</span>&nbsp;<span class="ident" id="3851889">a</span>&nbsp;<span class="op" id="3851891">==</span>&nbsp;<span class="builtintype" id="3851894">nil</span>&nbsp;<span class="op" id="3851898">||</span>&nbsp;<span class="builtinfunc" id="3851901">len</span><span class="op" id="3851904">(</span><span class="ident" id="3851905">a</span><span class="op" id="3851906">.</span><span class="ident" id="3851907">IP</span><span class="op" id="3851909">)</span>&nbsp;<span class="op" id="3851911">&lt;=</span>&nbsp;<span class="ident" id="3851914">IPv4len</span>&nbsp;<span class="op" id="3851922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851926">return</span>&nbsp;<span class="ident" id="3851933">syscall</span><span class="op" id="3851940">.</span><span class="ident" id="3851941">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851950">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851953">if</span>&nbsp;<span class="ident" id="3851956">a</span><span class="op" id="3851957">.</span><span class="ident" id="3851958">IP</span><span class="op" id="3851960">.</span><span class="ident" id="3851961">To4</span><span class="op" id="3851964">(</span><span class="op" id="3851965">)</span>&nbsp;<span class="op" id="3851967">!=</span>&nbsp;<span class="builtintype" id="3851970">nil</span>&nbsp;<span class="op" id="3851974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851978">return</span>&nbsp;<span class="ident" id="3851985">syscall</span><span class="op" id="3851992">.</span><span class="ident" id="3851993">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852005">return</span>&nbsp;<span class="ident" id="3852012">syscall</span><span class="op" id="3852019">.</span><span class="ident" id="3852020">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3852029">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3852032">func</span>&nbsp;<span class="op" id="3852037">(</span><span class="ident" id="3852038">a</span>&nbsp;<span class="op" id="3852040">*</span><span class="ident" id="3852041">TCPAddr</span><span class="op" id="3852048">)</span>&nbsp;<span class="ident" id="3852050">isWildcard</span><span class="op" id="3852060">(</span><span class="op" id="3852061">)</span>&nbsp;<span class="builtintype" id="3852063">bool</span>&nbsp;<span class="op" id="3852068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852071">if</span>&nbsp;<span class="ident" id="3852074">a</span>&nbsp;<span class="op" id="3852076">==</span>&nbsp;<span class="builtintype" id="3852079">nil</span>&nbsp;<span class="op" id="3852083">||</span>&nbsp;<span class="ident" id="3852086">a</span><span class="op" id="3852087">.</span><span class="ident" id="3852088">IP</span>&nbsp;<span class="op" id="3852091">==</span>&nbsp;<span class="builtintype" id="3852094">nil</span>&nbsp;<span class="op" id="3852098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852102">return</span>&nbsp;<span class="builtintype" id="3852109">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852115">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852118">return</span>&nbsp;<span class="ident" id="3852125">a</span><span class="op" id="3852126">.</span><span class="ident" id="3852127">IP</span><span class="op" id="3852129">.</span><span class="ident" id="3852130">IsUnspecified</span><span class="op" id="3852143">(</span><span class="op" id="3852144">)</span><br>
<span class="lineno"></span><span class="op" id="3852146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3852149">func</span>&nbsp;<span class="op" id="3852154">(</span><span class="ident" id="3852155">a</span>&nbsp;<span class="op" id="3852157">*</span><span class="ident" id="3852158">TCPAddr</span><span class="op" id="3852165">)</span>&nbsp;<span class="ident" id="3852167">sockaddr</span><span class="op" id="3852175">(</span><span class="ident" id="3852176">family</span>&nbsp;<span class="builtintype" id="3852183">int</span><span class="op" id="3852186">)</span>&nbsp;<span class="op" id="3852188">(</span><span class="ident" id="3852189">syscall</span><span class="op" id="3852196">.</span><span class="ident" id="3852197">Sockaddr</span><span class="op" id="3852205">,</span>&nbsp;<span class="builtintype" id="3852207">error</span><span class="op" id="3852212">)</span>&nbsp;<span class="op" id="3852214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852217">if</span>&nbsp;<span class="ident" id="3852220">a</span>&nbsp;<span class="op" id="3852222">==</span>&nbsp;<span class="builtintype" id="3852225">nil</span>&nbsp;<span class="op" id="3852229">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852233">return</span>&nbsp;<span class="builtintype" id="3852240">nil</span><span class="op" id="3852243">,</span>&nbsp;<span class="builtintype" id="3852245">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852253">return</span>&nbsp;<span class="ident" id="3852260">ipToSockaddr</span><span class="op" id="3852272">(</span><span class="ident" id="3852273">family</span><span class="op" id="3852279">,</span>&nbsp;<span class="ident" id="3852281">a</span><span class="op" id="3852282">.</span><span class="ident" id="3852283">IP</span><span class="op" id="3852285">,</span>&nbsp;<span class="ident" id="3852287">a</span><span class="op" id="3852288">.</span><span class="ident" id="3852289">Port</span><span class="op" id="3852293">,</span>&nbsp;<span class="ident" id="3852295">a</span><span class="op" id="3852296">.</span><span class="ident" id="3852297">Zone</span><span class="op" id="3852301">)</span><br>
<span class="lineno"></span><span class="op" id="3852303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3852306">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3852376">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3852392">type</span>&nbsp;<span class="ident" id="3852397">TCPConn</span>&nbsp;<span class="keyword" id="3852405">struct</span>&nbsp;<span class="op" id="3852412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852415">conn</span><br>
<span class="lineno"></span><span class="op" id="3852420">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3852423">func</span>&nbsp;<span class="ident" id="3852428">newTCPConn</span><span class="op" id="3852438">(</span><span class="ident" id="3852439">fd</span>&nbsp;<span class="op" id="3852442">*</span><span class="ident" id="3852443">netFD</span><span class="op" id="3852448">)</span>&nbsp;<span class="op" id="3852450">*</span><span class="ident" id="3852451">TCPConn</span>&nbsp;<span class="op" id="3852459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852462">c</span>&nbsp;<span class="op" id="3852464">:=</span>&nbsp;<span class="op" id="3852467">&amp;</span><span class="ident" id="3852468">TCPConn</span><span class="op" id="3852475">{</span><span class="ident" id="3852476">conn</span><span class="op" id="3852480">{</span><span class="ident" id="3852481">fd</span><span class="op" id="3852483">}</span><span class="op" id="3852484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852487">c</span><span class="op" id="3852488">.</span><span class="ident" id="3852489">SetNoDelay</span><span class="op" id="3852499">(</span><span class="builtintype" id="3852500">true</span><span class="op" id="3852504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852507">return</span>&nbsp;<span class="ident" id="3852514">c</span><br>
<span class="lineno">65</span><span class="op" id="3852516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852519">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3852577">func</span>&nbsp;<span class="op" id="3852582">(</span><span class="ident" id="3852583">c</span>&nbsp;<span class="op" id="3852585">*</span><span class="ident" id="3852586">TCPConn</span><span class="op" id="3852593">)</span>&nbsp;<span class="ident" id="3852595">ReadFrom</span><span class="op" id="3852603">(</span><span class="ident" id="3852604">r</span>&nbsp;<span class="ident" id="3852606">io</span><span class="op" id="3852608">.</span><span class="ident" id="3852609">Reader</span><span class="op" id="3852615">)</span>&nbsp;<span class="op" id="3852617">(</span><span class="builtintype" id="3852618">int64</span><span class="op" id="3852623">,</span>&nbsp;<span class="builtintype" id="3852625">error</span><span class="op" id="3852630">)</span>&nbsp;<span class="op" id="3852632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852635">if</span>&nbsp;<span class="ident" id="3852638">n</span><span class="op" id="3852639">,</span>&nbsp;<span class="ident" id="3852641">err</span><span class="op" id="3852644">,</span>&nbsp;<span class="ident" id="3852646">handled</span>&nbsp;<span class="op" id="3852654">:=</span>&nbsp;<span class="ident" id="3852657">sendFile</span><span class="op" id="3852665">(</span><span class="ident" id="3852666">c</span><span class="op" id="3852667">.</span><span class="ident" id="3852668">fd</span><span class="op" id="3852670">,</span>&nbsp;<span class="ident" id="3852672">r</span><span class="op" id="3852673">)</span><span class="op" id="3852674">;</span>&nbsp;<span class="ident" id="3852676">handled</span>&nbsp;<span class="op" id="3852684">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852688">return</span>&nbsp;<span class="ident" id="3852695">n</span><span class="op" id="3852696">,</span>&nbsp;<span class="ident" id="3852698">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852706">return</span>&nbsp;<span class="ident" id="3852713">genericReadFrom</span><span class="op" id="3852728">(</span><span class="ident" id="3852729">c</span><span class="op" id="3852730">,</span>&nbsp;<span class="ident" id="3852732">r</span><span class="op" id="3852733">)</span><br>
<span class="lineno"></span><span class="op" id="3852735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3852738">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3852802">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3852841">func</span>&nbsp;<span class="op" id="3852846">(</span><span class="ident" id="3852847">c</span>&nbsp;<span class="op" id="3852849">*</span><span class="ident" id="3852850">TCPConn</span><span class="op" id="3852857">)</span>&nbsp;<span class="ident" id="3852859">CloseRead</span><span class="op" id="3852868">(</span><span class="op" id="3852869">)</span>&nbsp;<span class="builtintype" id="3852871">error</span>&nbsp;<span class="op" id="3852877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852880">if</span>&nbsp;<span class="op" id="3852883">!</span><span class="ident" id="3852884">c</span><span class="op" id="3852885">.</span><span class="ident" id="3852886">ok</span><span class="op" id="3852888">(</span><span class="op" id="3852889">)</span>&nbsp;<span class="op" id="3852891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852895">return</span>&nbsp;<span class="ident" id="3852902">syscall</span><span class="op" id="3852909">.</span><span class="ident" id="3852910">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852921">return</span>&nbsp;<span class="ident" id="3852928">c</span><span class="op" id="3852929">.</span><span class="ident" id="3852930">fd</span><span class="op" id="3852932">.</span><span class="ident" id="3852933">closeRead</span><span class="op" id="3852942">(</span><span class="op" id="3852943">)</span><br>
<span class="lineno"></span><span class="op" id="3852945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3852948">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3853013">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3853052">func</span>&nbsp;<span class="op" id="3853057">(</span><span class="ident" id="3853058">c</span>&nbsp;<span class="op" id="3853060">*</span><span class="ident" id="3853061">TCPConn</span><span class="op" id="3853068">)</span>&nbsp;<span class="ident" id="3853070">CloseWrite</span><span class="op" id="3853080">(</span><span class="op" id="3853081">)</span>&nbsp;<span class="builtintype" id="3853083">error</span>&nbsp;<span class="op" id="3853089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853092">if</span>&nbsp;<span class="op" id="3853095">!</span><span class="ident" id="3853096">c</span><span class="op" id="3853097">.</span><span class="ident" id="3853098">ok</span><span class="op" id="3853100">(</span><span class="op" id="3853101">)</span>&nbsp;<span class="op" id="3853103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853107">return</span>&nbsp;<span class="ident" id="3853114">syscall</span><span class="op" id="3853121">.</span><span class="ident" id="3853122">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853130">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853133">return</span>&nbsp;<span class="ident" id="3853140">c</span><span class="op" id="3853141">.</span><span class="ident" id="3853142">fd</span><span class="op" id="3853144">.</span><span class="ident" id="3853145">closeWrite</span><span class="op" id="3853155">(</span><span class="op" id="3853156">)</span><br>
<span class="lineno"></span><span class="op" id="3853158">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853161">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3853229">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3853283">//</span><br>
<span class="lineno"></span><span class="comment" id="3853286">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3853357">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3853384">//</span><br>
<span class="lineno"></span><span class="comment" id="3853387">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3853447">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3853471">//</span><br>
<span class="lineno"></span><span class="comment" id="3853474">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3853544">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3853615">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3853648">func</span>&nbsp;<span class="op" id="3853653">(</span><span class="ident" id="3853654">c</span>&nbsp;<span class="op" id="3853656">*</span><span class="ident" id="3853657">TCPConn</span><span class="op" id="3853664">)</span>&nbsp;<span class="ident" id="3853666">SetLinger</span><span class="op" id="3853675">(</span><span class="ident" id="3853676">sec</span>&nbsp;<span class="builtintype" id="3853680">int</span><span class="op" id="3853683">)</span>&nbsp;<span class="builtintype" id="3853685">error</span>&nbsp;<span class="op" id="3853691">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853694">if</span>&nbsp;<span class="op" id="3853697">!</span><span class="ident" id="3853698">c</span><span class="op" id="3853699">.</span><span class="ident" id="3853700">ok</span><span class="op" id="3853702">(</span><span class="op" id="3853703">)</span>&nbsp;<span class="op" id="3853705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853709">return</span>&nbsp;<span class="ident" id="3853716">syscall</span><span class="op" id="3853723">.</span><span class="ident" id="3853724">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853735">return</span>&nbsp;<span class="ident" id="3853742">setLinger</span><span class="op" id="3853751">(</span><span class="ident" id="3853752">c</span><span class="op" id="3853753">.</span><span class="ident" id="3853754">fd</span><span class="op" id="3853756">,</span>&nbsp;<span class="ident" id="3853758">sec</span><span class="op" id="3853761">)</span><br>
<span class="lineno">110</span><span class="op" id="3853763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3853766">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3853828">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3853869">func</span>&nbsp;<span class="op" id="3853874">(</span><span class="ident" id="3853875">c</span>&nbsp;<span class="op" id="3853877">*</span><span class="ident" id="3853878">TCPConn</span><span class="op" id="3853885">)</span>&nbsp;<span class="ident" id="3853887">SetKeepAlive</span><span class="op" id="3853899">(</span><span class="ident" id="3853900">keepalive</span>&nbsp;<span class="builtintype" id="3853910">bool</span><span class="op" id="3853914">)</span>&nbsp;<span class="builtintype" id="3853916">error</span>&nbsp;<span class="op" id="3853922">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853925">if</span>&nbsp;<span class="op" id="3853928">!</span><span class="ident" id="3853929">c</span><span class="op" id="3853930">.</span><span class="ident" id="3853931">ok</span><span class="op" id="3853933">(</span><span class="op" id="3853934">)</span>&nbsp;<span class="op" id="3853936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853940">return</span>&nbsp;<span class="ident" id="3853947">syscall</span><span class="op" id="3853954">.</span><span class="ident" id="3853955">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853966">return</span>&nbsp;<span class="ident" id="3853973">setKeepAlive</span><span class="op" id="3853985">(</span><span class="ident" id="3853986">c</span><span class="op" id="3853987">.</span><span class="ident" id="3853988">fd</span><span class="op" id="3853990">,</span>&nbsp;<span class="ident" id="3853992">keepalive</span><span class="op" id="3854001">)</span><br>
<span class="lineno"></span><span class="op" id="3854003">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3854006">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3854061">func</span>&nbsp;<span class="op" id="3854066">(</span><span class="ident" id="3854067">c</span>&nbsp;<span class="op" id="3854069">*</span><span class="ident" id="3854070">TCPConn</span><span class="op" id="3854077">)</span>&nbsp;<span class="ident" id="3854079">SetKeepAlivePeriod</span><span class="op" id="3854097">(</span><span class="ident" id="3854098">d</span>&nbsp;<span class="ident" id="3854100">time</span><span class="op" id="3854104">.</span><span class="ident" id="3854105">Duration</span><span class="op" id="3854113">)</span>&nbsp;<span class="builtintype" id="3854115">error</span>&nbsp;<span class="op" id="3854121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854124">if</span>&nbsp;<span class="op" id="3854127">!</span><span class="ident" id="3854128">c</span><span class="op" id="3854129">.</span><span class="ident" id="3854130">ok</span><span class="op" id="3854132">(</span><span class="op" id="3854133">)</span>&nbsp;<span class="op" id="3854135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854139">return</span>&nbsp;<span class="ident" id="3854146">syscall</span><span class="op" id="3854153">.</span><span class="ident" id="3854154">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854165">return</span>&nbsp;<span class="ident" id="3854172">setKeepAlivePeriod</span><span class="op" id="3854190">(</span><span class="ident" id="3854191">c</span><span class="op" id="3854192">.</span><span class="ident" id="3854193">fd</span><span class="op" id="3854195">,</span>&nbsp;<span class="ident" id="3854197">d</span><span class="op" id="3854198">)</span><br>
<span class="lineno"></span><span class="op" id="3854200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3854203">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3854268">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3854334">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3854403">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3854446">func</span>&nbsp;<span class="op" id="3854451">(</span><span class="ident" id="3854452">c</span>&nbsp;<span class="op" id="3854454">*</span><span class="ident" id="3854455">TCPConn</span><span class="op" id="3854462">)</span>&nbsp;<span class="ident" id="3854464">SetNoDelay</span><span class="op" id="3854474">(</span><span class="ident" id="3854475">noDelay</span>&nbsp;<span class="builtintype" id="3854483">bool</span><span class="op" id="3854487">)</span>&nbsp;<span class="builtintype" id="3854489">error</span>&nbsp;<span class="op" id="3854495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854498">if</span>&nbsp;<span class="op" id="3854501">!</span><span class="ident" id="3854502">c</span><span class="op" id="3854503">.</span><span class="ident" id="3854504">ok</span><span class="op" id="3854506">(</span><span class="op" id="3854507">)</span>&nbsp;<span class="op" id="3854509">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854513">return</span>&nbsp;<span class="ident" id="3854520">syscall</span><span class="op" id="3854527">.</span><span class="ident" id="3854528">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854539">return</span>&nbsp;<span class="ident" id="3854546">setNoDelay</span><span class="op" id="3854556">(</span><span class="ident" id="3854557">c</span><span class="op" id="3854558">.</span><span class="ident" id="3854559">fd</span><span class="op" id="3854561">,</span>&nbsp;<span class="ident" id="3854563">noDelay</span><span class="op" id="3854570">)</span><br>
<span class="lineno"></span><span class="op" id="3854572">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3854575">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3854643">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3854714">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3854763">func</span>&nbsp;<span class="ident" id="3854768">DialTCP</span><span class="op" id="3854775">(</span><span class="ident" id="3854776">net</span>&nbsp;<span class="builtintype" id="3854780">string</span><span class="op" id="3854786">,</span>&nbsp;<span class="ident" id="3854788">laddr</span><span class="op" id="3854793">,</span>&nbsp;<span class="ident" id="3854795">raddr</span>&nbsp;<span class="op" id="3854801">*</span><span class="ident" id="3854802">TCPAddr</span><span class="op" id="3854809">)</span>&nbsp;<span class="op" id="3854811">(</span><span class="op" id="3854812">*</span><span class="ident" id="3854813">TCPConn</span><span class="op" id="3854820">,</span>&nbsp;<span class="builtintype" id="3854822">error</span><span class="op" id="3854827">)</span>&nbsp;<span class="op" id="3854829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854832">switch</span>&nbsp;<span class="ident" id="3854839">net</span>&nbsp;<span class="op" id="3854843">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854846">case</span>&nbsp;<span class="string" id="3854851">&#34;tcp&#34;</span><span class="op" id="3854856">,</span>&nbsp;<span class="string" id="3854858">&#34;tcp4&#34;</span><span class="op" id="3854864">,</span>&nbsp;<span class="string" id="3854866">&#34;tcp6&#34;</span><span class="op" id="3854872">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854875">default</span><span class="op" id="3854882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854886">return</span>&nbsp;<span class="builtintype" id="3854893">nil</span><span class="op" id="3854896">,</span>&nbsp;<span class="op" id="3854898">&amp;</span><span class="ident" id="3854899">OpError</span><span class="op" id="3854906">{</span><span class="ident" id="3854907">Op</span><span class="op" id="3854909">:</span>&nbsp;<span class="string" id="3854911">&#34;dial&#34;</span><span class="op" id="3854917">,</span>&nbsp;<span class="ident" id="3854919">Net</span><span class="op" id="3854922">:</span>&nbsp;<span class="ident" id="3854924">net</span><span class="op" id="3854927">,</span>&nbsp;<span class="ident" id="3854929">Addr</span><span class="op" id="3854933">:</span>&nbsp;<span class="ident" id="3854935">raddr</span><span class="op" id="3854940">,</span>&nbsp;<span class="ident" id="3854942">Err</span><span class="op" id="3854945">:</span>&nbsp;<span class="ident" id="3854947">UnknownNetworkError</span><span class="op" id="3854966">(</span><span class="ident" id="3854967">net</span><span class="op" id="3854970">)</span><span class="op" id="3854971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3854974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854977">if</span>&nbsp;<span class="ident" id="3854980">raddr</span>&nbsp;<span class="op" id="3854986">==</span>&nbsp;<span class="builtintype" id="3854989">nil</span>&nbsp;<span class="op" id="3854993">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3854997">return</span>&nbsp;<span class="builtintype" id="3855004">nil</span><span class="op" id="3855007">,</span>&nbsp;<span class="op" id="3855009">&amp;</span><span class="ident" id="3855010">OpError</span><span class="op" id="3855017">{</span><span class="ident" id="3855018">Op</span><span class="op" id="3855020">:</span>&nbsp;<span class="string" id="3855022">&#34;dial&#34;</span><span class="op" id="3855028">,</span>&nbsp;<span class="ident" id="3855030">Net</span><span class="op" id="3855033">:</span>&nbsp;<span class="ident" id="3855035">net</span><span class="op" id="3855038">,</span>&nbsp;<span class="ident" id="3855040">Addr</span><span class="op" id="3855044">:</span>&nbsp;<span class="builtintype" id="3855046">nil</span><span class="op" id="3855049">,</span>&nbsp;<span class="ident" id="3855051">Err</span><span class="op" id="3855054">:</span>&nbsp;<span class="ident" id="3855056">errMissingAddress</span><span class="op" id="3855073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3855076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3855079">return</span>&nbsp;<span class="ident" id="3855086">dialTCP</span><span class="op" id="3855093">(</span><span class="ident" id="3855094">net</span><span class="op" id="3855097">,</span>&nbsp;<span class="ident" id="3855099">laddr</span><span class="op" id="3855104">,</span>&nbsp;<span class="ident" id="3855106">raddr</span><span class="op" id="3855111">,</span>&nbsp;<span class="ident" id="3855113">noDeadline</span><span class="op" id="3855123">)</span><br>
<span class="lineno"></span><span class="op" id="3855125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3855128">func</span>&nbsp;<span class="ident" id="3855133">dialTCP</span><span class="op" id="3855140">(</span><span class="ident" id="3855141">net</span>&nbsp;<span class="builtintype" id="3855145">string</span><span class="op" id="3855151">,</span>&nbsp;<span class="ident" id="3855153">laddr</span><span class="op" id="3855158">,</span>&nbsp;<span class="ident" id="3855160">raddr</span>&nbsp;<span class="op" id="3855166">*</span><span class="ident" id="3855167">TCPAddr</span><span class="op" id="3855174">,</span>&nbsp;<span class="ident" id="3855176">deadline</span>&nbsp;<span class="ident" id="3855185">time</span><span class="op" id="3855189">.</span><span class="ident" id="3855190">Time</span><span class="op" id="3855194">)</span>&nbsp;<span class="op" id="3855196">(</span><span class="op" id="3855197">*</span><span class="ident" id="3855198">TCPConn</span><span class="op" id="3855205">,</span>&nbsp;<span class="builtintype" id="3855207">error</span><span class="op" id="3855212">)</span>&nbsp;<span class="op" id="3855214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3855217">fd</span><span class="op" id="3855219">,</span>&nbsp;<span class="ident" id="3855221">err</span>&nbsp;<span class="op" id="3855225">:=</span>&nbsp;<span class="ident" id="3855228">internetSocket</span><span class="op" id="3855242">(</span><span class="ident" id="3855243">net</span><span class="op" id="3855246">,</span>&nbsp;<span class="ident" id="3855248">laddr</span><span class="op" id="3855253">,</span>&nbsp;<span class="ident" id="3855255">raddr</span><span class="op" id="3855260">,</span>&nbsp;<span class="ident" id="3855262">deadline</span><span class="op" id="3855270">,</span>&nbsp;<span class="ident" id="3855272">syscall</span><span class="op" id="3855279">.</span><span class="ident" id="3855280">SOCK_STREAM</span><span class="op" id="3855291">,</span>&nbsp;<span class="num" id="3855293">0</span><span class="op" id="3855294">,</span>&nbsp;<span class="string" id="3855296">&#34;dial&#34;</span><span class="op" id="3855302">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855306">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855380">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855448">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855523">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855596">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855669">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855741">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855814">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855896">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3855971">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856054">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856117">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856189">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856259">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856332">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856363">//&nbsp;&nbsp;&nbsp;&nbsp;http://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856396">//&nbsp;&nbsp;&nbsp;&nbsp;http://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856444">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856448">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856526">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856604">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856677">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856701">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3856705">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856773">for</span>&nbsp;<span class="ident" id="3856777">i</span>&nbsp;<span class="op" id="3856779">:=</span>&nbsp;<span class="num" id="3856782">0</span><span class="op" id="3856783">;</span>&nbsp;<span class="ident" id="3856785">i</span>&nbsp;<span class="op" id="3856787">&lt;</span>&nbsp;<span class="num" id="3856789">2</span>&nbsp;<span class="op" id="3856791">&amp;&amp;</span>&nbsp;<span class="op" id="3856794">(</span><span class="ident" id="3856795">laddr</span>&nbsp;<span class="op" id="3856801">==</span>&nbsp;<span class="builtintype" id="3856804">nil</span>&nbsp;<span class="op" id="3856808">||</span>&nbsp;<span class="ident" id="3856811">laddr</span><span class="op" id="3856816">.</span><span class="ident" id="3856817">Port</span>&nbsp;<span class="op" id="3856822">==</span>&nbsp;<span class="num" id="3856825">0</span><span class="op" id="3856826">)</span>&nbsp;<span class="op" id="3856828">&amp;&amp;</span>&nbsp;<span class="op" id="3856831">(</span><span class="ident" id="3856832">selfConnect</span><span class="op" id="3856843">(</span><span class="ident" id="3856844">fd</span><span class="op" id="3856846">,</span>&nbsp;<span class="ident" id="3856848">err</span><span class="op" id="3856851">)</span>&nbsp;<span class="op" id="3856853">||</span>&nbsp;<span class="ident" id="3856856">spuriousENOTAVAIL</span><span class="op" id="3856873">(</span><span class="ident" id="3856874">err</span><span class="op" id="3856877">)</span><span class="op" id="3856878">)</span><span class="op" id="3856879">;</span>&nbsp;<span class="ident" id="3856881">i</span><span class="op" id="3856882">++</span>&nbsp;<span class="op" id="3856885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3856889">if</span>&nbsp;<span class="ident" id="3856892">err</span>&nbsp;<span class="op" id="3856896">==</span>&nbsp;<span class="builtintype" id="3856899">nil</span>&nbsp;<span class="op" id="3856903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856908">fd</span><span class="op" id="3856910">.</span><span class="ident" id="3856911">Close</span><span class="op" id="3856916">(</span><span class="op" id="3856917">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3856921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3856925">fd</span><span class="op" id="3856927">,</span>&nbsp;<span class="ident" id="3856929">err</span>&nbsp;<span class="op" id="3856933">=</span>&nbsp;<span class="ident" id="3856935">internetSocket</span><span class="op" id="3856949">(</span><span class="ident" id="3856950">net</span><span class="op" id="3856953">,</span>&nbsp;<span class="ident" id="3856955">laddr</span><span class="op" id="3856960">,</span>&nbsp;<span class="ident" id="3856962">raddr</span><span class="op" id="3856967">,</span>&nbsp;<span class="ident" id="3856969">deadline</span><span class="op" id="3856977">,</span>&nbsp;<span class="ident" id="3856979">syscall</span><span class="op" id="3856986">.</span><span class="ident" id="3856987">SOCK_STREAM</span><span class="op" id="3856998">,</span>&nbsp;<span class="num" id="3857000">0</span><span class="op" id="3857001">,</span>&nbsp;<span class="string" id="3857003">&#34;dial&#34;</span><span class="op" id="3857009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857016">if</span>&nbsp;<span class="ident" id="3857019">err</span>&nbsp;<span class="op" id="3857023">!=</span>&nbsp;<span class="builtintype" id="3857026">nil</span>&nbsp;<span class="op" id="3857030">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857034">return</span>&nbsp;<span class="builtintype" id="3857041">nil</span><span class="op" id="3857044">,</span>&nbsp;<span class="op" id="3857046">&amp;</span><span class="ident" id="3857047">OpError</span><span class="op" id="3857054">{</span><span class="ident" id="3857055">Op</span><span class="op" id="3857057">:</span>&nbsp;<span class="string" id="3857059">&#34;dial&#34;</span><span class="op" id="3857065">,</span>&nbsp;<span class="ident" id="3857067">Net</span><span class="op" id="3857070">:</span>&nbsp;<span class="ident" id="3857072">net</span><span class="op" id="3857075">,</span>&nbsp;<span class="ident" id="3857077">Addr</span><span class="op" id="3857081">:</span>&nbsp;<span class="ident" id="3857083">raddr</span><span class="op" id="3857088">,</span>&nbsp;<span class="ident" id="3857090">Err</span><span class="op" id="3857093">:</span>&nbsp;<span class="ident" id="3857095">err</span><span class="op" id="3857098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857104">return</span>&nbsp;<span class="ident" id="3857111">newTCPConn</span><span class="op" id="3857121">(</span><span class="ident" id="3857122">fd</span><span class="op" id="3857124">)</span><span class="op" id="3857125">,</span>&nbsp;<span class="builtintype" id="3857127">nil</span><br>
<span class="lineno"></span><span class="op" id="3857131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3857134">func</span>&nbsp;<span class="ident" id="3857139">selfConnect</span><span class="op" id="3857150">(</span><span class="ident" id="3857151">fd</span>&nbsp;<span class="op" id="3857154">*</span><span class="ident" id="3857155">netFD</span><span class="op" id="3857160">,</span>&nbsp;<span class="ident" id="3857162">err</span>&nbsp;<span class="builtintype" id="3857166">error</span><span class="op" id="3857171">)</span>&nbsp;<span class="builtintype" id="3857173">bool</span>&nbsp;<span class="op" id="3857178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857181">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857248">if</span>&nbsp;<span class="ident" id="3857251">err</span>&nbsp;<span class="op" id="3857255">!=</span>&nbsp;<span class="builtintype" id="3857258">nil</span>&nbsp;<span class="op" id="3857262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857266">return</span>&nbsp;<span class="builtintype" id="3857273">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857280">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857284">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857357">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857426">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857496">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857569">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857636">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857705">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3857747">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857799">if</span>&nbsp;<span class="ident" id="3857802">fd</span><span class="op" id="3857804">.</span><span class="ident" id="3857805">laddr</span>&nbsp;<span class="op" id="3857811">==</span>&nbsp;<span class="builtintype" id="3857814">nil</span>&nbsp;<span class="op" id="3857818">||</span>&nbsp;<span class="ident" id="3857821">fd</span><span class="op" id="3857823">.</span><span class="ident" id="3857824">raddr</span>&nbsp;<span class="op" id="3857830">==</span>&nbsp;<span class="builtintype" id="3857833">nil</span>&nbsp;<span class="op" id="3857837">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857841">return</span>&nbsp;<span class="builtintype" id="3857848">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3857854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857857">l</span>&nbsp;<span class="op" id="3857859">:=</span>&nbsp;<span class="ident" id="3857862">fd</span><span class="op" id="3857864">.</span><span class="ident" id="3857865">laddr</span><span class="op" id="3857870">.</span><span class="op" id="3857871">(</span><span class="op" id="3857872">*</span><span class="ident" id="3857873">TCPAddr</span><span class="op" id="3857880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857883">r</span>&nbsp;<span class="op" id="3857885">:=</span>&nbsp;<span class="ident" id="3857888">fd</span><span class="op" id="3857890">.</span><span class="ident" id="3857891">raddr</span><span class="op" id="3857896">.</span><span class="op" id="3857897">(</span><span class="op" id="3857898">*</span><span class="ident" id="3857899">TCPAddr</span><span class="op" id="3857906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3857909">return</span>&nbsp;<span class="ident" id="3857916">l</span><span class="op" id="3857917">.</span><span class="ident" id="3857918">Port</span>&nbsp;<span class="op" id="3857923">==</span>&nbsp;<span class="ident" id="3857926">r</span><span class="op" id="3857927">.</span><span class="ident" id="3857928">Port</span>&nbsp;<span class="op" id="3857933">&amp;&amp;</span>&nbsp;<span class="ident" id="3857936">l</span><span class="op" id="3857937">.</span><span class="ident" id="3857938">IP</span><span class="op" id="3857940">.</span><span class="ident" id="3857941">Equal</span><span class="op" id="3857946">(</span><span class="ident" id="3857947">r</span><span class="op" id="3857948">.</span><span class="ident" id="3857949">IP</span><span class="op" id="3857951">)</span><br>
<span class="lineno">215</span><span class="op" id="3857953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3857956">func</span>&nbsp;<span class="ident" id="3857961">spuriousENOTAVAIL</span><span class="op" id="3857978">(</span><span class="ident" id="3857979">err</span>&nbsp;<span class="builtintype" id="3857983">error</span><span class="op" id="3857988">)</span>&nbsp;<span class="builtintype" id="3857990">bool</span>&nbsp;<span class="op" id="3857995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3857998">e</span><span class="op" id="3857999">,</span>&nbsp;<span class="ident" id="3858001">ok</span>&nbsp;<span class="op" id="3858004">:=</span>&nbsp;<span class="ident" id="3858007">err</span><span class="op" id="3858010">.</span><span class="op" id="3858011">(</span><span class="op" id="3858012">*</span><span class="ident" id="3858013">OpError</span><span class="op" id="3858020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858023">return</span>&nbsp;<span class="ident" id="3858030">ok</span>&nbsp;<span class="op" id="3858033">&amp;&amp;</span>&nbsp;<span class="ident" id="3858036">e</span><span class="op" id="3858037">.</span><span class="ident" id="3858038">Err</span>&nbsp;<span class="op" id="3858042">==</span>&nbsp;<span class="ident" id="3858045">syscall</span><span class="op" id="3858052">.</span><span class="ident" id="3858053">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3858067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858070">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3858138">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3858197">type</span>&nbsp;<span class="ident" id="3858202">TCPListener</span>&nbsp;<span class="keyword" id="3858214">struct</span>&nbsp;<span class="op" id="3858221">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858224">fd</span>&nbsp;<span class="op" id="3858227">*</span><span class="ident" id="3858228">netFD</span><br>
<span class="lineno"></span><span class="op" id="3858234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3858237">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3858301">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3858316">func</span>&nbsp;<span class="op" id="3858321">(</span><span class="ident" id="3858322">l</span>&nbsp;<span class="op" id="3858324">*</span><span class="ident" id="3858325">TCPListener</span><span class="op" id="3858336">)</span>&nbsp;<span class="ident" id="3858338">AcceptTCP</span><span class="op" id="3858347">(</span><span class="op" id="3858348">)</span>&nbsp;<span class="op" id="3858350">(</span><span class="op" id="3858351">*</span><span class="ident" id="3858352">TCPConn</span><span class="op" id="3858359">,</span>&nbsp;<span class="builtintype" id="3858361">error</span><span class="op" id="3858366">)</span>&nbsp;<span class="op" id="3858368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858371">if</span>&nbsp;<span class="ident" id="3858374">l</span>&nbsp;<span class="op" id="3858376">==</span>&nbsp;<span class="builtintype" id="3858379">nil</span>&nbsp;<span class="op" id="3858383">||</span>&nbsp;<span class="ident" id="3858386">l</span><span class="op" id="3858387">.</span><span class="ident" id="3858388">fd</span>&nbsp;<span class="op" id="3858391">==</span>&nbsp;<span class="builtintype" id="3858394">nil</span>&nbsp;<span class="op" id="3858398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858402">return</span>&nbsp;<span class="builtintype" id="3858409">nil</span><span class="op" id="3858412">,</span>&nbsp;<span class="ident" id="3858414">syscall</span><span class="op" id="3858421">.</span><span class="ident" id="3858422">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858433">fd</span><span class="op" id="3858435">,</span>&nbsp;<span class="ident" id="3858437">err</span>&nbsp;<span class="op" id="3858441">:=</span>&nbsp;<span class="ident" id="3858444">l</span><span class="op" id="3858445">.</span><span class="ident" id="3858446">fd</span><span class="op" id="3858448">.</span><span class="ident" id="3858449">accept</span><span class="op" id="3858455">(</span><span class="op" id="3858456">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858459">if</span>&nbsp;<span class="ident" id="3858462">err</span>&nbsp;<span class="op" id="3858466">!=</span>&nbsp;<span class="builtintype" id="3858469">nil</span>&nbsp;<span class="op" id="3858473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858477">return</span>&nbsp;<span class="builtintype" id="3858484">nil</span><span class="op" id="3858487">,</span>&nbsp;<span class="ident" id="3858489">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858497">return</span>&nbsp;<span class="ident" id="3858504">newTCPConn</span><span class="op" id="3858514">(</span><span class="ident" id="3858515">fd</span><span class="op" id="3858517">)</span><span class="op" id="3858518">,</span>&nbsp;<span class="builtintype" id="3858520">nil</span><br>
<span class="lineno"></span><span class="op" id="3858524">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3858527">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3858596">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3858651">func</span>&nbsp;<span class="op" id="3858656">(</span><span class="ident" id="3858657">l</span>&nbsp;<span class="op" id="3858659">*</span><span class="ident" id="3858660">TCPListener</span><span class="op" id="3858671">)</span>&nbsp;<span class="ident" id="3858673">Accept</span><span class="op" id="3858679">(</span><span class="op" id="3858680">)</span>&nbsp;<span class="op" id="3858682">(</span><span class="ident" id="3858683">Conn</span><span class="op" id="3858687">,</span>&nbsp;<span class="builtintype" id="3858689">error</span><span class="op" id="3858694">)</span>&nbsp;<span class="op" id="3858696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3858699">c</span><span class="op" id="3858700">,</span>&nbsp;<span class="ident" id="3858702">err</span>&nbsp;<span class="op" id="3858706">:=</span>&nbsp;<span class="ident" id="3858709">l</span><span class="op" id="3858710">.</span><span class="ident" id="3858711">AcceptTCP</span><span class="op" id="3858720">(</span><span class="op" id="3858721">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858724">if</span>&nbsp;<span class="ident" id="3858727">err</span>&nbsp;<span class="op" id="3858731">!=</span>&nbsp;<span class="builtintype" id="3858734">nil</span>&nbsp;<span class="op" id="3858738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858742">return</span>&nbsp;<span class="builtintype" id="3858749">nil</span><span class="op" id="3858752">,</span>&nbsp;<span class="ident" id="3858754">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858762">return</span>&nbsp;<span class="ident" id="3858769">c</span><span class="op" id="3858770">,</span>&nbsp;<span class="builtintype" id="3858772">nil</span><br>
<span class="lineno"></span><span class="op" id="3858776">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3858779">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3858824">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3858872">func</span>&nbsp;<span class="op" id="3858877">(</span><span class="ident" id="3858878">l</span>&nbsp;<span class="op" id="3858880">*</span><span class="ident" id="3858881">TCPListener</span><span class="op" id="3858892">)</span>&nbsp;<span class="ident" id="3858894">Close</span><span class="op" id="3858899">(</span><span class="op" id="3858900">)</span>&nbsp;<span class="builtintype" id="3858902">error</span>&nbsp;<span class="op" id="3858908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858911">if</span>&nbsp;<span class="ident" id="3858914">l</span>&nbsp;<span class="op" id="3858916">==</span>&nbsp;<span class="builtintype" id="3858919">nil</span>&nbsp;<span class="op" id="3858923">||</span>&nbsp;<span class="ident" id="3858926">l</span><span class="op" id="3858927">.</span><span class="ident" id="3858928">fd</span>&nbsp;<span class="op" id="3858931">==</span>&nbsp;<span class="builtintype" id="3858934">nil</span>&nbsp;<span class="op" id="3858938">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858942">return</span>&nbsp;<span class="ident" id="3858949">syscall</span><span class="op" id="3858956">.</span><span class="ident" id="3858957">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3858965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3858968">return</span>&nbsp;<span class="ident" id="3858975">l</span><span class="op" id="3858976">.</span><span class="ident" id="3858977">fd</span><span class="op" id="3858979">.</span><span class="ident" id="3858980">Close</span><span class="op" id="3858985">(</span><span class="op" id="3858986">)</span><br>
<span class="lineno"></span><span class="op" id="3858988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3858991">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3859051">func</span>&nbsp;<span class="op" id="3859056">(</span><span class="ident" id="3859057">l</span>&nbsp;<span class="op" id="3859059">*</span><span class="ident" id="3859060">TCPListener</span><span class="op" id="3859071">)</span>&nbsp;<span class="ident" id="3859073">Addr</span><span class="op" id="3859077">(</span><span class="op" id="3859078">)</span>&nbsp;<span class="ident" id="3859080">Addr</span>&nbsp;<span class="op" id="3859085">{</span>&nbsp;<span class="keyword" id="3859087">return</span>&nbsp;<span class="ident" id="3859094">l</span><span class="op" id="3859095">.</span><span class="ident" id="3859096">fd</span><span class="op" id="3859098">.</span><span class="ident" id="3859099">laddr</span>&nbsp;<span class="op" id="3859105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3859108">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3859171">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3859215">func</span>&nbsp;<span class="op" id="3859220">(</span><span class="ident" id="3859221">l</span>&nbsp;<span class="op" id="3859223">*</span><span class="ident" id="3859224">TCPListener</span><span class="op" id="3859235">)</span>&nbsp;<span class="ident" id="3859237">SetDeadline</span><span class="op" id="3859248">(</span><span class="ident" id="3859249">t</span>&nbsp;<span class="ident" id="3859251">time</span><span class="op" id="3859255">.</span><span class="ident" id="3859256">Time</span><span class="op" id="3859260">)</span>&nbsp;<span class="builtintype" id="3859262">error</span>&nbsp;<span class="op" id="3859268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859271">if</span>&nbsp;<span class="ident" id="3859274">l</span>&nbsp;<span class="op" id="3859276">==</span>&nbsp;<span class="builtintype" id="3859279">nil</span>&nbsp;<span class="op" id="3859283">||</span>&nbsp;<span class="ident" id="3859286">l</span><span class="op" id="3859287">.</span><span class="ident" id="3859288">fd</span>&nbsp;<span class="op" id="3859291">==</span>&nbsp;<span class="builtintype" id="3859294">nil</span>&nbsp;<span class="op" id="3859298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859302">return</span>&nbsp;<span class="ident" id="3859309">syscall</span><span class="op" id="3859316">.</span><span class="ident" id="3859317">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3859328">return</span>&nbsp;<span class="ident" id="3859335">l</span><span class="op" id="3859336">.</span><span class="ident" id="3859337">fd</span><span class="op" id="3859339">.</span><span class="ident" id="3859340">setDeadline</span><span class="op" id="3859351">(</span><span class="ident" id="3859352">t</span><span class="op" id="3859353">)</span><br>
<span class="lineno">270</span><span class="op" id="3859355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3859358">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3859424">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3859494">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3859559">//</span><br>
<span class="lineno"></span><span class="comment" id="3859562">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3859626">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3859692">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3859756">func</span>&nbsp;<span class="op" id="3859761">(</span><span class="ident" id="3859762">l</span>&nbsp;<span class="op" id="3859764">*</span><span class="ident" id="3859765">TCPListener</span><span class="op" id="3859776">)</span>&nbsp;<span class="ident" id="3859778">File</span><span class="op" id="3859782">(</span><span class="op" id="3859783">)</span>&nbsp;<span class="op" id="3859785">(</span><span class="ident" id="3859786">f</span>&nbsp;<span class="op" id="3859788">*</span><span class="ident" id="3859789">os</span><span class="op" id="3859791">.</span><span class="ident" id="3859792">File</span><span class="op" id="3859796">,</span>&nbsp;<span class="ident" id="3859798">err</span>&nbsp;<span class="builtintype" id="3859802">error</span><span class="op" id="3859807">)</span>&nbsp;<span class="op" id="3859809">{</span>&nbsp;<span class="keyword" id="3859811">return</span>&nbsp;<span class="ident" id="3859818">l</span><span class="op" id="3859819">.</span><span class="ident" id="3859820">fd</span><span class="op" id="3859822">.</span><span class="ident" id="3859823">dup</span><span class="op" id="3859826">(</span><span class="op" id="3859827">)</span>&nbsp;<span class="op" id="3859829">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3859832">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3859898">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3859966">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3860037">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3860107">func</span>&nbsp;<span class="ident" id="3860112">ListenTCP</span><span class="op" id="3860121">(</span><span class="ident" id="3860122">net</span>&nbsp;<span class="builtintype" id="3860126">string</span><span class="op" id="3860132">,</span>&nbsp;<span class="ident" id="3860134">laddr</span>&nbsp;<span class="op" id="3860140">*</span><span class="ident" id="3860141">TCPAddr</span><span class="op" id="3860148">)</span>&nbsp;<span class="op" id="3860150">(</span><span class="op" id="3860151">*</span><span class="ident" id="3860152">TCPListener</span><span class="op" id="3860163">,</span>&nbsp;<span class="builtintype" id="3860165">error</span><span class="op" id="3860170">)</span>&nbsp;<span class="op" id="3860172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860175">switch</span>&nbsp;<span class="ident" id="3860182">net</span>&nbsp;<span class="op" id="3860186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860189">case</span>&nbsp;<span class="string" id="3860194">&#34;tcp&#34;</span><span class="op" id="3860199">,</span>&nbsp;<span class="string" id="3860201">&#34;tcp4&#34;</span><span class="op" id="3860207">,</span>&nbsp;<span class="string" id="3860209">&#34;tcp6&#34;</span><span class="op" id="3860215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860218">default</span><span class="op" id="3860225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860229">return</span>&nbsp;<span class="builtintype" id="3860236">nil</span><span class="op" id="3860239">,</span>&nbsp;<span class="op" id="3860241">&amp;</span><span class="ident" id="3860242">OpError</span><span class="op" id="3860249">{</span><span class="ident" id="3860250">Op</span><span class="op" id="3860252">:</span>&nbsp;<span class="string" id="3860254">&#34;listen&#34;</span><span class="op" id="3860262">,</span>&nbsp;<span class="ident" id="3860264">Net</span><span class="op" id="3860267">:</span>&nbsp;<span class="ident" id="3860269">net</span><span class="op" id="3860272">,</span>&nbsp;<span class="ident" id="3860274">Addr</span><span class="op" id="3860278">:</span>&nbsp;<span class="ident" id="3860280">laddr</span><span class="op" id="3860285">,</span>&nbsp;<span class="ident" id="3860287">Err</span><span class="op" id="3860290">:</span>&nbsp;<span class="ident" id="3860292">UnknownNetworkError</span><span class="op" id="3860311">(</span><span class="ident" id="3860312">net</span><span class="op" id="3860315">)</span><span class="op" id="3860316">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3860319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860322">if</span>&nbsp;<span class="ident" id="3860325">laddr</span>&nbsp;<span class="op" id="3860331">==</span>&nbsp;<span class="builtintype" id="3860334">nil</span>&nbsp;<span class="op" id="3860338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3860342">laddr</span>&nbsp;<span class="op" id="3860348">=</span>&nbsp;<span class="op" id="3860350">&amp;</span><span class="ident" id="3860351">TCPAddr</span><span class="op" id="3860358">{</span><span class="op" id="3860359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3860362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3860365">fd</span><span class="op" id="3860367">,</span>&nbsp;<span class="ident" id="3860369">err</span>&nbsp;<span class="op" id="3860373">:=</span>&nbsp;<span class="ident" id="3860376">internetSocket</span><span class="op" id="3860390">(</span><span class="ident" id="3860391">net</span><span class="op" id="3860394">,</span>&nbsp;<span class="ident" id="3860396">laddr</span><span class="op" id="3860401">,</span>&nbsp;<span class="builtintype" id="3860403">nil</span><span class="op" id="3860406">,</span>&nbsp;<span class="ident" id="3860408">noDeadline</span><span class="op" id="3860418">,</span>&nbsp;<span class="ident" id="3860420">syscall</span><span class="op" id="3860427">.</span><span class="ident" id="3860428">SOCK_STREAM</span><span class="op" id="3860439">,</span>&nbsp;<span class="num" id="3860441">0</span><span class="op" id="3860442">,</span>&nbsp;<span class="string" id="3860444">&#34;listen&#34;</span><span class="op" id="3860452">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860455">if</span>&nbsp;<span class="ident" id="3860458">err</span>&nbsp;<span class="op" id="3860462">!=</span>&nbsp;<span class="builtintype" id="3860465">nil</span>&nbsp;<span class="op" id="3860469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860473">return</span>&nbsp;<span class="builtintype" id="3860480">nil</span><span class="op" id="3860483">,</span>&nbsp;<span class="op" id="3860485">&amp;</span><span class="ident" id="3860486">OpError</span><span class="op" id="3860493">{</span><span class="ident" id="3860494">Op</span><span class="op" id="3860496">:</span>&nbsp;<span class="string" id="3860498">&#34;listen&#34;</span><span class="op" id="3860506">,</span>&nbsp;<span class="ident" id="3860508">Net</span><span class="op" id="3860511">:</span>&nbsp;<span class="ident" id="3860513">net</span><span class="op" id="3860516">,</span>&nbsp;<span class="ident" id="3860518">Addr</span><span class="op" id="3860522">:</span>&nbsp;<span class="ident" id="3860524">laddr</span><span class="op" id="3860529">,</span>&nbsp;<span class="ident" id="3860531">Err</span><span class="op" id="3860534">:</span>&nbsp;<span class="ident" id="3860536">err</span><span class="op" id="3860539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3860542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3860545">return</span>&nbsp;<span class="op" id="3860552">&amp;</span><span class="ident" id="3860553">TCPListener</span><span class="op" id="3860564">{</span><span class="ident" id="3860565">fd</span><span class="op" id="3860567">}</span><span class="op" id="3860568">,</span>&nbsp;<span class="builtintype" id="3860570">nil</span><br>
<span class="lineno"></span><span class="op" id="3860574">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
