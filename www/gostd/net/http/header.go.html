<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5051586">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5051642">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5051696">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5051747">package</span>&nbsp;<span class="ident" id="5051755">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5051761">import</span>&nbsp;<span class="op" id="5051768">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051771">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051777">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051794">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051802">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051813">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5051821">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="5051828">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="5051831">var</span>&nbsp;<span class="ident" id="5051835">raceEnabled</span>&nbsp;<span class="op" id="5051847">=</span>&nbsp;<span class="builtintype" id="5051849">false</span>&nbsp;<span class="comment" id="5051855">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5051874">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5051936">type</span>&nbsp;<span class="ident" id="5051941">Header</span>&nbsp;<span class="keyword" id="5051948">map</span><span class="op" id="5051951">[</span><span class="builtintype" id="5051952">string</span><span class="op" id="5051958">]</span><span class="op" id="5051959">[</span><span class="op" id="5051960">]</span><span class="builtintype" id="5051961">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="5051969">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="5052016">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5052074">func</span>&nbsp;<span class="op" id="5052079">(</span><span class="ident" id="5052080">h</span>&nbsp;<span class="ident" id="5052082">Header</span><span class="op" id="5052088">)</span>&nbsp;<span class="ident" id="5052090">Add</span><span class="op" id="5052093">(</span><span class="ident" id="5052094">key</span><span class="op" id="5052097">,</span>&nbsp;<span class="ident" id="5052099">value</span>&nbsp;<span class="builtintype" id="5052105">string</span><span class="op" id="5052111">)</span>&nbsp;<span class="op" id="5052113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052116">textproto</span><span class="op" id="5052125">.</span><span class="ident" id="5052126">MIMEHeader</span><span class="op" id="5052136">(</span><span class="ident" id="5052137">h</span><span class="op" id="5052138">)</span><span class="op" id="5052139">.</span><span class="ident" id="5052140">Add</span><span class="op" id="5052143">(</span><span class="ident" id="5052144">key</span><span class="op" id="5052147">,</span>&nbsp;<span class="ident" id="5052149">value</span><span class="op" id="5052154">)</span><br>
<span class="lineno">25</span><span class="op" id="5052156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5052159">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5052213">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="5052268">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="5052299">func</span>&nbsp;<span class="op" id="5052304">(</span><span class="ident" id="5052305">h</span>&nbsp;<span class="ident" id="5052307">Header</span><span class="op" id="5052313">)</span>&nbsp;<span class="ident" id="5052315">Set</span><span class="op" id="5052318">(</span><span class="ident" id="5052319">key</span><span class="op" id="5052322">,</span>&nbsp;<span class="ident" id="5052324">value</span>&nbsp;<span class="builtintype" id="5052330">string</span><span class="op" id="5052336">)</span>&nbsp;<span class="op" id="5052338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052341">textproto</span><span class="op" id="5052350">.</span><span class="ident" id="5052351">MIMEHeader</span><span class="op" id="5052361">(</span><span class="ident" id="5052362">h</span><span class="op" id="5052363">)</span><span class="op" id="5052364">.</span><span class="ident" id="5052365">Set</span><span class="op" id="5052368">(</span><span class="ident" id="5052369">key</span><span class="op" id="5052372">,</span>&nbsp;<span class="ident" id="5052374">value</span><span class="op" id="5052379">)</span><br>
<span class="lineno"></span><span class="op" id="5052381">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5052384">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="5052443">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="5052510">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5052573">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="5052601">func</span>&nbsp;<span class="op" id="5052606">(</span><span class="ident" id="5052607">h</span>&nbsp;<span class="ident" id="5052609">Header</span><span class="op" id="5052615">)</span>&nbsp;<span class="ident" id="5052617">Get</span><span class="op" id="5052620">(</span><span class="ident" id="5052621">key</span>&nbsp;<span class="builtintype" id="5052625">string</span><span class="op" id="5052631">)</span>&nbsp;<span class="builtintype" id="5052633">string</span>&nbsp;<span class="op" id="5052640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052643">return</span>&nbsp;<span class="ident" id="5052650">textproto</span><span class="op" id="5052659">.</span><span class="ident" id="5052660">MIMEHeader</span><span class="op" id="5052670">(</span><span class="ident" id="5052671">h</span><span class="op" id="5052672">)</span><span class="op" id="5052673">.</span><span class="ident" id="5052674">Get</span><span class="op" id="5052677">(</span><span class="ident" id="5052678">key</span><span class="op" id="5052681">)</span><br>
<span class="lineno">40</span><span class="op" id="5052683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5052686">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="5052758">func</span>&nbsp;<span class="op" id="5052763">(</span><span class="ident" id="5052764">h</span>&nbsp;<span class="ident" id="5052766">Header</span><span class="op" id="5052772">)</span>&nbsp;<span class="ident" id="5052774">get</span><span class="op" id="5052777">(</span><span class="ident" id="5052778">key</span>&nbsp;<span class="builtintype" id="5052782">string</span><span class="op" id="5052788">)</span>&nbsp;<span class="builtintype" id="5052790">string</span>&nbsp;<span class="op" id="5052797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052800">if</span>&nbsp;<span class="ident" id="5052803">v</span>&nbsp;<span class="op" id="5052805">:=</span>&nbsp;<span class="ident" id="5052808">h</span><span class="op" id="5052809">[</span><span class="ident" id="5052810">key</span><span class="op" id="5052813">]</span><span class="op" id="5052814">;</span>&nbsp;<span class="builtinfunc" id="5052816">len</span><span class="op" id="5052819">(</span><span class="ident" id="5052820">v</span><span class="op" id="5052821">)</span>&nbsp;<span class="op" id="5052823">&gt;</span>&nbsp;<span class="num" id="5052825">0</span>&nbsp;<span class="op" id="5052827">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052831">return</span>&nbsp;<span class="ident" id="5052838">v</span><span class="op" id="5052839">[</span><span class="num" id="5052840">0</span><span class="op" id="5052841">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5052844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5052847">return</span>&nbsp;<span class="string" id="5052854">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="5052857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5052860">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="5052907">func</span>&nbsp;<span class="op" id="5052912">(</span><span class="ident" id="5052913">h</span>&nbsp;<span class="ident" id="5052915">Header</span><span class="op" id="5052921">)</span>&nbsp;<span class="ident" id="5052923">Del</span><span class="op" id="5052926">(</span><span class="ident" id="5052927">key</span>&nbsp;<span class="builtintype" id="5052931">string</span><span class="op" id="5052937">)</span>&nbsp;<span class="op" id="5052939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5052942">textproto</span><span class="op" id="5052951">.</span><span class="ident" id="5052952">MIMEHeader</span><span class="op" id="5052962">(</span><span class="ident" id="5052963">h</span><span class="op" id="5052964">)</span><span class="op" id="5052965">.</span><span class="ident" id="5052966">Del</span><span class="op" id="5052969">(</span><span class="ident" id="5052970">key</span><span class="op" id="5052973">)</span><br>
<span class="lineno"></span><span class="op" id="5052975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5052978">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5053019">func</span>&nbsp;<span class="op" id="5053024">(</span><span class="ident" id="5053025">h</span>&nbsp;<span class="ident" id="5053027">Header</span><span class="op" id="5053033">)</span>&nbsp;<span class="ident" id="5053035">Write</span><span class="op" id="5053040">(</span><span class="ident" id="5053041">w</span>&nbsp;<span class="ident" id="5053043">io</span><span class="op" id="5053045">.</span><span class="ident" id="5053046">Writer</span><span class="op" id="5053052">)</span>&nbsp;<span class="builtintype" id="5053054">error</span>&nbsp;<span class="op" id="5053060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053063">return</span>&nbsp;<span class="ident" id="5053070">h</span><span class="op" id="5053071">.</span><span class="ident" id="5053072">WriteSubset</span><span class="op" id="5053083">(</span><span class="ident" id="5053084">w</span><span class="op" id="5053085">,</span>&nbsp;<span class="ident" id="5053087">nil</span><span class="op" id="5053090">)</span><br>
<span class="lineno"></span><span class="op" id="5053092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="5053095">func</span>&nbsp;<span class="op" id="5053100">(</span><span class="ident" id="5053101">h</span>&nbsp;<span class="ident" id="5053103">Header</span><span class="op" id="5053109">)</span>&nbsp;<span class="ident" id="5053111">clone</span><span class="op" id="5053116">(</span><span class="op" id="5053117">)</span>&nbsp;<span class="ident" id="5053119">Header</span>&nbsp;<span class="op" id="5053126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053129">h2</span>&nbsp;<span class="op" id="5053132">:=</span>&nbsp;<span class="builtinfunc" id="5053135">make</span><span class="op" id="5053139">(</span><span class="ident" id="5053140">Header</span><span class="op" id="5053146">,</span>&nbsp;<span class="builtinfunc" id="5053148">len</span><span class="op" id="5053151">(</span><span class="ident" id="5053152">h</span><span class="op" id="5053153">)</span><span class="op" id="5053154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053157">for</span>&nbsp;<span class="ident" id="5053161">k</span><span class="op" id="5053162">,</span>&nbsp;<span class="ident" id="5053164">vv</span>&nbsp;<span class="op" id="5053167">:=</span>&nbsp;<span class="keyword" id="5053170">range</span>&nbsp;<span class="ident" id="5053176">h</span>&nbsp;<span class="op" id="5053178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053182">vv2</span>&nbsp;<span class="op" id="5053186">:=</span>&nbsp;<span class="builtinfunc" id="5053189">make</span><span class="op" id="5053193">(</span><span class="op" id="5053194">[</span><span class="op" id="5053195">]</span><span class="builtintype" id="5053196">string</span><span class="op" id="5053202">,</span>&nbsp;<span class="builtinfunc" id="5053204">len</span><span class="op" id="5053207">(</span><span class="ident" id="5053208">vv</span><span class="op" id="5053210">)</span><span class="op" id="5053211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5053215">copy</span><span class="op" id="5053219">(</span><span class="ident" id="5053220">vv2</span><span class="op" id="5053223">,</span>&nbsp;<span class="ident" id="5053225">vv</span><span class="op" id="5053227">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053231">h2</span><span class="op" id="5053233">[</span><span class="ident" id="5053234">k</span><span class="op" id="5053235">]</span>&nbsp;<span class="op" id="5053237">=</span>&nbsp;<span class="ident" id="5053239">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5053244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053247">return</span>&nbsp;<span class="ident" id="5053254">h2</span><br>
<span class="lineno"></span><span class="op" id="5053257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="5053260">var</span>&nbsp;<span class="ident" id="5053264">timeFormats</span>&nbsp;<span class="op" id="5053276">=</span>&nbsp;<span class="op" id="5053278">[</span><span class="op" id="5053279">]</span><span class="builtintype" id="5053280">string</span><span class="op" id="5053286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053289">TimeFormat</span><span class="op" id="5053299">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053302">time</span><span class="op" id="5053306">.</span><span class="ident" id="5053307">RFC850</span><span class="op" id="5053313">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053316">time</span><span class="op" id="5053320">.</span><span class="ident" id="5053321">ANSIC</span><span class="op" id="5053326">,</span><br>
<span class="lineno"></span><span class="op" id="5053328">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="5053331">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="5053393">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="5053450">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="5053494">func</span>&nbsp;<span class="ident" id="5053499">ParseTime</span><span class="op" id="5053508">(</span><span class="ident" id="5053509">text</span>&nbsp;<span class="builtintype" id="5053514">string</span><span class="op" id="5053520">)</span>&nbsp;<span class="op" id="5053522">(</span><span class="ident" id="5053523">t</span>&nbsp;<span class="ident" id="5053525">time</span><span class="op" id="5053529">.</span><span class="ident" id="5053530">Time</span><span class="op" id="5053534">,</span>&nbsp;<span class="ident" id="5053536">err</span>&nbsp;<span class="builtintype" id="5053540">error</span><span class="op" id="5053545">)</span>&nbsp;<span class="op" id="5053547">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053550">for</span>&nbsp;<span class="ident" id="5053554">_</span><span class="op" id="5053555">,</span>&nbsp;<span class="ident" id="5053557">layout</span>&nbsp;<span class="op" id="5053564">:=</span>&nbsp;<span class="keyword" id="5053567">range</span>&nbsp;<span class="ident" id="5053573">timeFormats</span>&nbsp;<span class="op" id="5053585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053589">t</span><span class="op" id="5053590">,</span>&nbsp;<span class="ident" id="5053592">err</span>&nbsp;<span class="op" id="5053596">=</span>&nbsp;<span class="ident" id="5053598">time</span><span class="op" id="5053602">.</span><span class="ident" id="5053603">Parse</span><span class="op" id="5053608">(</span><span class="ident" id="5053609">layout</span><span class="op" id="5053615">,</span>&nbsp;<span class="ident" id="5053617">text</span><span class="op" id="5053621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053625">if</span>&nbsp;<span class="ident" id="5053628">err</span>&nbsp;<span class="op" id="5053632">==</span>&nbsp;<span class="ident" id="5053635">nil</span>&nbsp;<span class="op" id="5053639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053644">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5053653">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5053656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053659">return</span><br>
<span class="lineno"></span><span class="op" id="5053666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5053669">var</span>&nbsp;<span class="ident" id="5053673">headerNewlineToSpace</span>&nbsp;<span class="op" id="5053694">=</span>&nbsp;<span class="ident" id="5053696">strings</span><span class="op" id="5053703">.</span><span class="ident" id="5053704">NewReplacer</span><span class="op" id="5053715">(</span><span class="string" id="5053716">&#34;\n&#34;</span><span class="op" id="5053720">,</span>&nbsp;<span class="string" id="5053722">&#34;&nbsp;&#34;</span><span class="op" id="5053725">,</span>&nbsp;<span class="string" id="5053727">&#34;\r&#34;</span><span class="op" id="5053731">,</span>&nbsp;<span class="string" id="5053733">&#34;&nbsp;&#34;</span><span class="op" id="5053736">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="5053739">type</span>&nbsp;<span class="ident" id="5053744">writeStringer</span>&nbsp;<span class="keyword" id="5053758">interface</span>&nbsp;<span class="op" id="5053768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053771">WriteString</span><span class="op" id="5053782">(</span><span class="builtintype" id="5053783">string</span><span class="op" id="5053789">)</span>&nbsp;<span class="op" id="5053791">(</span><span class="builtintype" id="5053792">int</span><span class="op" id="5053795">,</span>&nbsp;<span class="builtintype" id="5053797">error</span><span class="op" id="5053802">)</span><br>
<span class="lineno"></span><span class="op" id="5053804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5053807">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5053859">type</span>&nbsp;<span class="ident" id="5053864">stringWriter</span>&nbsp;<span class="keyword" id="5053877">struct</span>&nbsp;<span class="op" id="5053884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5053887">w</span>&nbsp;<span class="ident" id="5053889">io</span><span class="op" id="5053891">.</span><span class="ident" id="5053892">Writer</span><br>
<span class="lineno"></span><span class="op" id="5053899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5053902">func</span>&nbsp;<span class="op" id="5053907">(</span><span class="ident" id="5053908">w</span>&nbsp;<span class="ident" id="5053910">stringWriter</span><span class="op" id="5053922">)</span>&nbsp;<span class="ident" id="5053924">WriteString</span><span class="op" id="5053935">(</span><span class="ident" id="5053936">s</span>&nbsp;<span class="builtintype" id="5053938">string</span><span class="op" id="5053944">)</span>&nbsp;<span class="op" id="5053946">(</span><span class="ident" id="5053947">n</span>&nbsp;<span class="builtintype" id="5053949">int</span><span class="op" id="5053952">,</span>&nbsp;<span class="ident" id="5053954">err</span>&nbsp;<span class="builtintype" id="5053958">error</span><span class="op" id="5053963">)</span>&nbsp;<span class="op" id="5053965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5053968">return</span>&nbsp;<span class="ident" id="5053975">w</span><span class="op" id="5053976">.</span><span class="ident" id="5053977">w</span><span class="op" id="5053978">.</span><span class="ident" id="5053979">Write</span><span class="op" id="5053984">(</span><span class="op" id="5053985">[</span><span class="op" id="5053986">]</span><span class="builtintype" id="5053987">byte</span><span class="op" id="5053991">(</span><span class="ident" id="5053992">s</span><span class="op" id="5053993">)</span><span class="op" id="5053994">)</span><br>
<span class="lineno"></span><span class="op" id="5053996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5053999">type</span>&nbsp;<span class="ident" id="5054004">keyValues</span>&nbsp;<span class="keyword" id="5054014">struct</span>&nbsp;<span class="op" id="5054021">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054024">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5054031">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054039">values</span>&nbsp;<span class="op" id="5054046">[</span><span class="op" id="5054047">]</span><span class="builtintype" id="5054048">string</span><br>
<span class="lineno"></span><span class="op" id="5054055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5054058">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="5054127">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="5054196">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="5054235">type</span>&nbsp;<span class="ident" id="5054240">headerSorter</span>&nbsp;<span class="keyword" id="5054253">struct</span>&nbsp;<span class="op" id="5054260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054263">kvs</span>&nbsp;<span class="op" id="5054267">[</span><span class="op" id="5054268">]</span><span class="ident" id="5054269">keyValues</span><br>
<span class="lineno"></span><span class="op" id="5054279">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="5054282">func</span>&nbsp;<span class="op" id="5054287">(</span><span class="ident" id="5054288">s</span>&nbsp;<span class="op" id="5054290">*</span><span class="ident" id="5054291">headerSorter</span><span class="op" id="5054303">)</span>&nbsp;<span class="ident" id="5054305">Len</span><span class="op" id="5054308">(</span><span class="op" id="5054309">)</span>&nbsp;<span class="builtintype" id="5054311">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5054325">{</span>&nbsp;<span class="keyword" id="5054327">return</span>&nbsp;<span class="builtinfunc" id="5054334">len</span><span class="op" id="5054337">(</span><span class="ident" id="5054338">s</span><span class="op" id="5054339">.</span><span class="ident" id="5054340">kvs</span><span class="op" id="5054343">)</span>&nbsp;<span class="op" id="5054345">}</span><br>
<span class="lineno"></span><span class="keyword" id="5054347">func</span>&nbsp;<span class="op" id="5054352">(</span><span class="ident" id="5054353">s</span>&nbsp;<span class="op" id="5054355">*</span><span class="ident" id="5054356">headerSorter</span><span class="op" id="5054368">)</span>&nbsp;<span class="ident" id="5054370">Swap</span><span class="op" id="5054374">(</span><span class="ident" id="5054375">i</span><span class="op" id="5054376">,</span>&nbsp;<span class="ident" id="5054378">j</span>&nbsp;<span class="builtintype" id="5054380">int</span><span class="op" id="5054383">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5054390">{</span>&nbsp;<span class="ident" id="5054392">s</span><span class="op" id="5054393">.</span><span class="ident" id="5054394">kvs</span><span class="op" id="5054397">[</span><span class="ident" id="5054398">i</span><span class="op" id="5054399">]</span><span class="op" id="5054400">,</span>&nbsp;<span class="ident" id="5054402">s</span><span class="op" id="5054403">.</span><span class="ident" id="5054404">kvs</span><span class="op" id="5054407">[</span><span class="ident" id="5054408">j</span><span class="op" id="5054409">]</span>&nbsp;<span class="op" id="5054411">=</span>&nbsp;<span class="ident" id="5054413">s</span><span class="op" id="5054414">.</span><span class="ident" id="5054415">kvs</span><span class="op" id="5054418">[</span><span class="ident" id="5054419">j</span><span class="op" id="5054420">]</span><span class="op" id="5054421">,</span>&nbsp;<span class="ident" id="5054423">s</span><span class="op" id="5054424">.</span><span class="ident" id="5054425">kvs</span><span class="op" id="5054428">[</span><span class="ident" id="5054429">i</span><span class="op" id="5054430">]</span>&nbsp;<span class="op" id="5054432">}</span><br>
<span class="lineno"></span><span class="keyword" id="5054434">func</span>&nbsp;<span class="op" id="5054439">(</span><span class="ident" id="5054440">s</span>&nbsp;<span class="op" id="5054442">*</span><span class="ident" id="5054443">headerSorter</span><span class="op" id="5054455">)</span>&nbsp;<span class="ident" id="5054457">Less</span><span class="op" id="5054461">(</span><span class="ident" id="5054462">i</span><span class="op" id="5054463">,</span>&nbsp;<span class="ident" id="5054465">j</span>&nbsp;<span class="builtintype" id="5054467">int</span><span class="op" id="5054470">)</span>&nbsp;<span class="builtintype" id="5054472">bool</span>&nbsp;<span class="op" id="5054477">{</span>&nbsp;<span class="keyword" id="5054479">return</span>&nbsp;<span class="ident" id="5054486">s</span><span class="op" id="5054487">.</span><span class="ident" id="5054488">kvs</span><span class="op" id="5054491">[</span><span class="ident" id="5054492">i</span><span class="op" id="5054493">]</span><span class="op" id="5054494">.</span><span class="ident" id="5054495">key</span>&nbsp;<span class="op" id="5054499">&lt;</span>&nbsp;<span class="ident" id="5054501">s</span><span class="op" id="5054502">.</span><span class="ident" id="5054503">kvs</span><span class="op" id="5054506">[</span><span class="ident" id="5054507">j</span><span class="op" id="5054508">]</span><span class="op" id="5054509">.</span><span class="ident" id="5054510">key</span>&nbsp;<span class="op" id="5054514">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="5054517">var</span>&nbsp;<span class="ident" id="5054521">headerSorterPool</span>&nbsp;<span class="op" id="5054538">=</span>&nbsp;<span class="ident" id="5054540">sync</span><span class="op" id="5054544">.</span><span class="ident" id="5054545">Pool</span><span class="op" id="5054549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054552">New</span><span class="op" id="5054555">:</span>&nbsp;<span class="keyword" id="5054557">func</span><span class="op" id="5054561">(</span><span class="op" id="5054562">)</span>&nbsp;<span class="keyword" id="5054564">interface</span><span class="op" id="5054573">{</span><span class="op" id="5054574">}</span>&nbsp;<span class="op" id="5054576">{</span>&nbsp;<span class="keyword" id="5054578">return</span>&nbsp;<span class="builtinfunc" id="5054585">new</span><span class="op" id="5054588">(</span><span class="ident" id="5054589">headerSorter</span><span class="op" id="5054601">)</span>&nbsp;<span class="op" id="5054603">}</span><span class="op" id="5054604">,</span><br>
<span class="lineno"></span><span class="op" id="5054606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5054609">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="5054672">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="5054743">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="5054775">func</span>&nbsp;<span class="op" id="5054780">(</span><span class="ident" id="5054781">h</span>&nbsp;<span class="ident" id="5054783">Header</span><span class="op" id="5054789">)</span>&nbsp;<span class="ident" id="5054791">sortedKeyValues</span><span class="op" id="5054806">(</span><span class="ident" id="5054807">exclude</span>&nbsp;<span class="keyword" id="5054815">map</span><span class="op" id="5054818">[</span><span class="builtintype" id="5054819">string</span><span class="op" id="5054825">]</span><span class="builtintype" id="5054826">bool</span><span class="op" id="5054830">)</span>&nbsp;<span class="op" id="5054832">(</span><span class="ident" id="5054833">kvs</span>&nbsp;<span class="op" id="5054837">[</span><span class="op" id="5054838">]</span><span class="ident" id="5054839">keyValues</span><span class="op" id="5054848">,</span>&nbsp;<span class="ident" id="5054850">hs</span>&nbsp;<span class="op" id="5054853">*</span><span class="ident" id="5054854">headerSorter</span><span class="op" id="5054866">)</span>&nbsp;<span class="op" id="5054868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054871">hs</span>&nbsp;<span class="op" id="5054874">=</span>&nbsp;<span class="ident" id="5054876">headerSorterPool</span><span class="op" id="5054892">.</span><span class="ident" id="5054893">Get</span><span class="op" id="5054896">(</span><span class="op" id="5054897">)</span><span class="op" id="5054898">.</span><span class="op" id="5054899">(</span><span class="op" id="5054900">*</span><span class="ident" id="5054901">headerSorter</span><span class="op" id="5054913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5054916">if</span>&nbsp;<span class="builtinfunc" id="5054919">cap</span><span class="op" id="5054922">(</span><span class="ident" id="5054923">hs</span><span class="op" id="5054925">.</span><span class="ident" id="5054926">kvs</span><span class="op" id="5054929">)</span>&nbsp;<span class="op" id="5054931">&lt;</span>&nbsp;<span class="builtinfunc" id="5054933">len</span><span class="op" id="5054936">(</span><span class="ident" id="5054937">h</span><span class="op" id="5054938">)</span>&nbsp;<span class="op" id="5054940">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054944">hs</span><span class="op" id="5054946">.</span><span class="ident" id="5054947">kvs</span>&nbsp;<span class="op" id="5054951">=</span>&nbsp;<span class="builtinfunc" id="5054953">make</span><span class="op" id="5054957">(</span><span class="op" id="5054958">[</span><span class="op" id="5054959">]</span><span class="ident" id="5054960">keyValues</span><span class="op" id="5054969">,</span>&nbsp;<span class="num" id="5054971">0</span><span class="op" id="5054972">,</span>&nbsp;<span class="builtinfunc" id="5054974">len</span><span class="op" id="5054977">(</span><span class="ident" id="5054978">h</span><span class="op" id="5054979">)</span><span class="op" id="5054980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5054983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5054986">kvs</span>&nbsp;<span class="op" id="5054990">=</span>&nbsp;<span class="ident" id="5054992">hs</span><span class="op" id="5054994">.</span><span class="ident" id="5054995">kvs</span><span class="op" id="5054998">[</span><span class="op" id="5054999">:</span><span class="num" id="5055000">0</span><span class="op" id="5055001">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055004">for</span>&nbsp;<span class="ident" id="5055008">k</span><span class="op" id="5055009">,</span>&nbsp;<span class="ident" id="5055011">vv</span>&nbsp;<span class="op" id="5055014">:=</span>&nbsp;<span class="keyword" id="5055017">range</span>&nbsp;<span class="ident" id="5055023">h</span>&nbsp;<span class="op" id="5055025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055029">if</span>&nbsp;<span class="op" id="5055032">!</span><span class="ident" id="5055033">exclude</span><span class="op" id="5055040">[</span><span class="ident" id="5055041">k</span><span class="op" id="5055042">]</span>&nbsp;<span class="op" id="5055044">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055049">kvs</span>&nbsp;<span class="op" id="5055053">=</span>&nbsp;<span class="builtinfunc" id="5055055">append</span><span class="op" id="5055061">(</span><span class="ident" id="5055062">kvs</span><span class="op" id="5055065">,</span>&nbsp;<span class="ident" id="5055067">keyValues</span><span class="op" id="5055076">{</span><span class="ident" id="5055077">k</span><span class="op" id="5055078">,</span>&nbsp;<span class="ident" id="5055080">vv</span><span class="op" id="5055082">}</span><span class="op" id="5055083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055093">hs</span><span class="op" id="5055095">.</span><span class="ident" id="5055096">kvs</span>&nbsp;<span class="op" id="5055100">=</span>&nbsp;<span class="ident" id="5055102">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055107">sort</span><span class="op" id="5055111">.</span><span class="ident" id="5055112">Sort</span><span class="op" id="5055116">(</span><span class="ident" id="5055117">hs</span><span class="op" id="5055119">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055122">return</span>&nbsp;<span class="ident" id="5055129">kvs</span><span class="op" id="5055132">,</span>&nbsp;<span class="ident" id="5055134">hs</span><br>
<span class="lineno"></span><span class="op" id="5055137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5055140">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="5055187">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="5055262">func</span>&nbsp;<span class="op" id="5055267">(</span><span class="ident" id="5055268">h</span>&nbsp;<span class="ident" id="5055270">Header</span><span class="op" id="5055276">)</span>&nbsp;<span class="ident" id="5055278">WriteSubset</span><span class="op" id="5055289">(</span><span class="ident" id="5055290">w</span>&nbsp;<span class="ident" id="5055292">io</span><span class="op" id="5055294">.</span><span class="ident" id="5055295">Writer</span><span class="op" id="5055301">,</span>&nbsp;<span class="ident" id="5055303">exclude</span>&nbsp;<span class="keyword" id="5055311">map</span><span class="op" id="5055314">[</span><span class="builtintype" id="5055315">string</span><span class="op" id="5055321">]</span><span class="builtintype" id="5055322">bool</span><span class="op" id="5055326">)</span>&nbsp;<span class="builtintype" id="5055328">error</span>&nbsp;<span class="op" id="5055334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055337">ws</span><span class="op" id="5055339">,</span>&nbsp;<span class="ident" id="5055341">ok</span>&nbsp;<span class="op" id="5055344">:=</span>&nbsp;<span class="ident" id="5055347">w</span><span class="op" id="5055348">.</span><span class="op" id="5055349">(</span><span class="ident" id="5055350">writeStringer</span><span class="op" id="5055363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055366">if</span>&nbsp;<span class="op" id="5055369">!</span><span class="ident" id="5055370">ok</span>&nbsp;<span class="op" id="5055373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055377">ws</span>&nbsp;<span class="op" id="5055380">=</span>&nbsp;<span class="ident" id="5055382">stringWriter</span><span class="op" id="5055394">{</span><span class="ident" id="5055395">w</span><span class="op" id="5055396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055399">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055402">kvs</span><span class="op" id="5055405">,</span>&nbsp;<span class="ident" id="5055407">sorter</span>&nbsp;<span class="op" id="5055414">:=</span>&nbsp;<span class="ident" id="5055417">h</span><span class="op" id="5055418">.</span><span class="ident" id="5055419">sortedKeyValues</span><span class="op" id="5055434">(</span><span class="ident" id="5055435">exclude</span><span class="op" id="5055442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055445">for</span>&nbsp;<span class="ident" id="5055449">_</span><span class="op" id="5055450">,</span>&nbsp;<span class="ident" id="5055452">kv</span>&nbsp;<span class="op" id="5055455">:=</span>&nbsp;<span class="keyword" id="5055458">range</span>&nbsp;<span class="ident" id="5055464">kvs</span>&nbsp;<span class="op" id="5055468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055472">for</span>&nbsp;<span class="ident" id="5055476">_</span><span class="op" id="5055477">,</span>&nbsp;<span class="ident" id="5055479">v</span>&nbsp;<span class="op" id="5055481">:=</span>&nbsp;<span class="keyword" id="5055484">range</span>&nbsp;<span class="ident" id="5055490">kv</span><span class="op" id="5055492">.</span><span class="ident" id="5055493">values</span>&nbsp;<span class="op" id="5055500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055505">v</span>&nbsp;<span class="op" id="5055507">=</span>&nbsp;<span class="ident" id="5055509">headerNewlineToSpace</span><span class="op" id="5055529">.</span><span class="ident" id="5055530">Replace</span><span class="op" id="5055537">(</span><span class="ident" id="5055538">v</span><span class="op" id="5055539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055544">v</span>&nbsp;<span class="op" id="5055546">=</span>&nbsp;<span class="ident" id="5055548">textproto</span><span class="op" id="5055557">.</span><span class="ident" id="5055558">TrimString</span><span class="op" id="5055568">(</span><span class="ident" id="5055569">v</span><span class="op" id="5055570">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055575">for</span>&nbsp;<span class="ident" id="5055579">_</span><span class="op" id="5055580">,</span>&nbsp;<span class="ident" id="5055582">s</span>&nbsp;<span class="op" id="5055584">:=</span>&nbsp;<span class="keyword" id="5055587">range</span>&nbsp;<span class="op" id="5055593">[</span><span class="op" id="5055594">]</span><span class="builtintype" id="5055595">string</span><span class="op" id="5055601">{</span><span class="ident" id="5055602">kv</span><span class="op" id="5055604">.</span><span class="ident" id="5055605">key</span><span class="op" id="5055608">,</span>&nbsp;<span class="string" id="5055610">&#34;:&nbsp;&#34;</span><span class="op" id="5055614">,</span>&nbsp;<span class="ident" id="5055616">v</span><span class="op" id="5055617">,</span>&nbsp;<span class="string" id="5055619">&#34;\r\n&#34;</span><span class="op" id="5055625">}</span>&nbsp;<span class="op" id="5055627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055633">if</span>&nbsp;<span class="ident" id="5055636">_</span><span class="op" id="5055637">,</span>&nbsp;<span class="ident" id="5055639">err</span>&nbsp;<span class="op" id="5055643">:=</span>&nbsp;<span class="ident" id="5055646">ws</span><span class="op" id="5055648">.</span><span class="ident" id="5055649">WriteString</span><span class="op" id="5055660">(</span><span class="ident" id="5055661">s</span><span class="op" id="5055662">)</span><span class="op" id="5055663">;</span>&nbsp;<span class="ident" id="5055665">err</span>&nbsp;<span class="op" id="5055669">!=</span>&nbsp;<span class="ident" id="5055672">nil</span>&nbsp;<span class="op" id="5055676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055683">return</span>&nbsp;<span class="ident" id="5055690">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055703">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5055710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5055713">headerSorterPool</span><span class="op" id="5055729">.</span><span class="ident" id="5055730">Put</span><span class="op" id="5055733">(</span><span class="ident" id="5055734">sorter</span><span class="op" id="5055740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5055743">return</span>&nbsp;<span class="ident" id="5055750">nil</span><br>
<span class="lineno"></span><span class="op" id="5055754">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5055757">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5055815">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5055873">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="5055932">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="5055990">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5056051">func</span>&nbsp;<span class="ident" id="5056056">CanonicalHeaderKey</span><span class="op" id="5056074">(</span><span class="ident" id="5056075">s</span>&nbsp;<span class="builtintype" id="5056077">string</span><span class="op" id="5056083">)</span>&nbsp;<span class="builtintype" id="5056085">string</span>&nbsp;<span class="op" id="5056092">{</span>&nbsp;<span class="keyword" id="5056094">return</span>&nbsp;<span class="ident" id="5056101">textproto</span><span class="op" id="5056110">.</span><span class="ident" id="5056111">CanonicalMIMEHeaderKey</span><span class="op" id="5056133">(</span><span class="ident" id="5056134">s</span><span class="op" id="5056135">)</span>&nbsp;<span class="op" id="5056137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5056140">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="5056196">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="5056249">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="5056281">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="5056311">func</span>&nbsp;<span class="ident" id="5056316">hasToken</span><span class="op" id="5056324">(</span><span class="ident" id="5056325">v</span><span class="op" id="5056326">,</span>&nbsp;<span class="ident" id="5056328">token</span>&nbsp;<span class="builtintype" id="5056334">string</span><span class="op" id="5056340">)</span>&nbsp;<span class="builtintype" id="5056342">bool</span>&nbsp;<span class="op" id="5056347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056350">if</span>&nbsp;<span class="builtinfunc" id="5056353">len</span><span class="op" id="5056356">(</span><span class="ident" id="5056357">token</span><span class="op" id="5056362">)</span>&nbsp;<span class="op" id="5056364">&gt;</span>&nbsp;<span class="builtinfunc" id="5056366">len</span><span class="op" id="5056369">(</span><span class="ident" id="5056370">v</span><span class="op" id="5056371">)</span>&nbsp;<span class="op" id="5056373">||</span>&nbsp;<span class="ident" id="5056376">token</span>&nbsp;<span class="op" id="5056382">==</span>&nbsp;<span class="string" id="5056385">&#34;&#34;</span>&nbsp;<span class="op" id="5056388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056392">return</span>&nbsp;<span class="builtintype" id="5056399">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056409">if</span>&nbsp;<span class="ident" id="5056412">v</span>&nbsp;<span class="op" id="5056414">==</span>&nbsp;<span class="ident" id="5056417">token</span>&nbsp;<span class="op" id="5056423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056427">return</span>&nbsp;<span class="builtintype" id="5056434">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056443">for</span>&nbsp;<span class="ident" id="5056447">sp</span>&nbsp;<span class="op" id="5056450">:=</span>&nbsp;<span class="num" id="5056453">0</span><span class="op" id="5056454">;</span>&nbsp;<span class="ident" id="5056456">sp</span>&nbsp;<span class="op" id="5056459">&lt;=</span>&nbsp;<span class="builtinfunc" id="5056462">len</span><span class="op" id="5056465">(</span><span class="ident" id="5056466">v</span><span class="op" id="5056467">)</span><span class="op" id="5056468">-</span><span class="builtinfunc" id="5056469">len</span><span class="op" id="5056472">(</span><span class="ident" id="5056473">token</span><span class="op" id="5056478">)</span><span class="op" id="5056479">;</span>&nbsp;<span class="ident" id="5056481">sp</span><span class="op" id="5056483">++</span>&nbsp;<span class="op" id="5056486">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056490">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056531">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056587">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056640">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056695">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056749">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056808">if</span>&nbsp;<span class="ident" id="5056811">b</span>&nbsp;<span class="op" id="5056813">:=</span>&nbsp;<span class="ident" id="5056816">v</span><span class="op" id="5056817">[</span><span class="ident" id="5056818">sp</span><span class="op" id="5056820">]</span><span class="op" id="5056821">;</span>&nbsp;<span class="ident" id="5056823">b</span>&nbsp;<span class="op" id="5056825">!=</span>&nbsp;<span class="ident" id="5056828">token</span><span class="op" id="5056833">[</span><span class="num" id="5056834">0</span><span class="op" id="5056835">]</span>&nbsp;<span class="op" id="5056837">&amp;&amp;</span>&nbsp;<span class="ident" id="5056840">b</span><span class="op" id="5056841">|</span><span class="num" id="5056842">0x20</span>&nbsp;<span class="op" id="5056847">!=</span>&nbsp;<span class="ident" id="5056850">token</span><span class="op" id="5056855">[</span><span class="num" id="5056856">0</span><span class="op" id="5056857">]</span>&nbsp;<span class="op" id="5056859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056864">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056879">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056935">if</span>&nbsp;<span class="ident" id="5056938">sp</span>&nbsp;<span class="op" id="5056941">&gt;</span>&nbsp;<span class="num" id="5056943">0</span>&nbsp;<span class="op" id="5056945">&amp;&amp;</span>&nbsp;<span class="op" id="5056948">!</span><span class="ident" id="5056949">isTokenBoundary</span><span class="op" id="5056964">(</span><span class="ident" id="5056965">v</span><span class="op" id="5056966">[</span><span class="ident" id="5056967">sp</span><span class="op" id="5056969">-</span><span class="num" id="5056970">1</span><span class="op" id="5056971">]</span><span class="op" id="5056972">)</span>&nbsp;<span class="op" id="5056974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5056979">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5056990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5056994">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057048">if</span>&nbsp;<span class="ident" id="5057051">endPos</span>&nbsp;<span class="op" id="5057058">:=</span>&nbsp;<span class="ident" id="5057061">sp</span>&nbsp;<span class="op" id="5057064">+</span>&nbsp;<span class="builtinfunc" id="5057066">len</span><span class="op" id="5057069">(</span><span class="ident" id="5057070">token</span><span class="op" id="5057075">)</span><span class="op" id="5057076">;</span>&nbsp;<span class="ident" id="5057078">endPos</span>&nbsp;<span class="op" id="5057085">!=</span>&nbsp;<span class="builtinfunc" id="5057088">len</span><span class="op" id="5057091">(</span><span class="ident" id="5057092">v</span><span class="op" id="5057093">)</span>&nbsp;<span class="op" id="5057095">&amp;&amp;</span>&nbsp;<span class="op" id="5057098">!</span><span class="ident" id="5057099">isTokenBoundary</span><span class="op" id="5057114">(</span><span class="ident" id="5057115">v</span><span class="op" id="5057116">[</span><span class="ident" id="5057117">endPos</span><span class="op" id="5057123">]</span><span class="op" id="5057124">)</span>&nbsp;<span class="op" id="5057126">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057131">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057146">if</span>&nbsp;<span class="ident" id="5057149">strings</span><span class="op" id="5057156">.</span><span class="ident" id="5057157">EqualFold</span><span class="op" id="5057166">(</span><span class="ident" id="5057167">v</span><span class="op" id="5057168">[</span><span class="ident" id="5057169">sp</span><span class="op" id="5057171">:</span><span class="ident" id="5057172">sp</span><span class="op" id="5057174">+</span><span class="builtinfunc" id="5057175">len</span><span class="op" id="5057178">(</span><span class="ident" id="5057179">token</span><span class="op" id="5057184">)</span><span class="op" id="5057185">]</span><span class="op" id="5057186">,</span>&nbsp;<span class="ident" id="5057188">token</span><span class="op" id="5057193">)</span>&nbsp;<span class="op" id="5057195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057200">return</span>&nbsp;<span class="builtintype" id="5057207">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057214">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5057217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057220">return</span>&nbsp;<span class="builtintype" id="5057227">false</span><br>
<span class="lineno"></span><span class="op" id="5057233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5057236">func</span>&nbsp;<span class="ident" id="5057241">isTokenBoundary</span><span class="op" id="5057256">(</span><span class="ident" id="5057257">b</span>&nbsp;<span class="builtintype" id="5057259">byte</span><span class="op" id="5057263">)</span>&nbsp;<span class="builtintype" id="5057265">bool</span>&nbsp;<span class="op" id="5057270">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5057273">return</span>&nbsp;<span class="ident" id="5057280">b</span>&nbsp;<span class="op" id="5057282">==</span>&nbsp;<span class="string" id="5057285">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5057289">||</span>&nbsp;<span class="ident" id="5057292">b</span>&nbsp;<span class="op" id="5057294">==</span>&nbsp;<span class="string" id="5057297">&#39;,&#39;</span>&nbsp;<span class="op" id="5057301">||</span>&nbsp;<span class="ident" id="5057304">b</span>&nbsp;<span class="op" id="5057306">==</span>&nbsp;<span class="string" id="5057309">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="5057314">}</span>
</div>
</body>
</html>
