<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>bufio</h2>
<ul>
<li><a href="/gostd/bufio/bufio.go.html">bufio.go</a></li>
<li><a href="/gostd/bufio/bufio_test.go.html">bufio_test.go</a></li>
<li><a href="/gostd/bufio/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/bufio/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/bufio/scan.go.html">scan.go</a></li>
<li><a href="/gostd/bufio/scan_test.go.html">scan_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2156447">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2156502">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2156556">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2156607">//&nbsp;Package&nbsp;bufio&nbsp;implements&nbsp;buffered&nbsp;I/O.&nbsp;&nbsp;It&nbsp;wraps&nbsp;an&nbsp;io.Reader&nbsp;or&nbsp;io.Writer</span><br>
<span class="lineno"></span><span class="comment" id="2156685">//&nbsp;object,&nbsp;creating&nbsp;another&nbsp;object&nbsp;(Reader&nbsp;or&nbsp;Writer)&nbsp;that&nbsp;also&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="2156760">//&nbsp;the&nbsp;interface&nbsp;but&nbsp;provides&nbsp;buffering&nbsp;and&nbsp;some&nbsp;help&nbsp;for&nbsp;textual&nbsp;I/O.</span><br>
<span class="lineno"></span><span class="keyword" id="2156831">package</span>&nbsp;<span class="ident" id="2156839">bufio</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="2156846">import</span>&nbsp;<span class="op" id="2156853">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2156856">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2156865">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2156875">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2156881">&#34;unicode/utf8&#34;</span><br>
<span class="lineno">15</span><span class="op" id="2156896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2156899">const</span>&nbsp;<span class="op" id="2156905">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2156908">defaultBufSize</span>&nbsp;<span class="op" id="2156923">=</span>&nbsp;<span class="num" id="2156925">4096</span><br>
<span class="lineno"></span><span class="op" id="2156930">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2156933">var</span>&nbsp;<span class="op" id="2156937">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2156940">ErrInvalidUnreadByte</span>&nbsp;<span class="op" id="2156961">=</span>&nbsp;<span class="ident" id="2156963">errors</span><span class="op" id="2156969">.</span><span class="ident" id="2156970">New</span><span class="op" id="2156973">(</span><span class="string" id="2156974">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadByte&#34;</span><span class="op" id="2157008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157011">ErrInvalidUnreadRune</span>&nbsp;<span class="op" id="2157032">=</span>&nbsp;<span class="ident" id="2157034">errors</span><span class="op" id="2157040">.</span><span class="ident" id="2157041">New</span><span class="op" id="2157044">(</span><span class="string" id="2157045">&#34;bufio:&nbsp;invalid&nbsp;use&nbsp;of&nbsp;UnreadRune&#34;</span><span class="op" id="2157079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157082">ErrBufferFull</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2157103">=</span>&nbsp;<span class="ident" id="2157105">errors</span><span class="op" id="2157111">.</span><span class="ident" id="2157112">New</span><span class="op" id="2157115">(</span><span class="string" id="2157116">&#34;bufio:&nbsp;buffer&nbsp;full&#34;</span><span class="op" id="2157136">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157139">ErrNegativeCount</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2157160">=</span>&nbsp;<span class="ident" id="2157162">errors</span><span class="op" id="2157168">.</span><span class="ident" id="2157169">New</span><span class="op" id="2157172">(</span><span class="string" id="2157173">&#34;bufio:&nbsp;negative&nbsp;count&#34;</span><span class="op" id="2157196">)</span><br>
<span class="lineno"></span><span class="op" id="2157198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2157201">//&nbsp;Buffered&nbsp;input.</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="2157221">//&nbsp;Reader&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Reader&nbsp;object.</span><br>
<span class="lineno"></span><span class="keyword" id="2157277">type</span>&nbsp;<span class="ident" id="2157282">Reader</span>&nbsp;<span class="keyword" id="2157289">struct</span>&nbsp;<span class="op" id="2157296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157299">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2157312">[</span><span class="op" id="2157313">]</span><span class="builtintype" id="2157314">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157320">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2157333">io</span><span class="op" id="2157335">.</span><span class="ident" id="2157336">Reader</span>&nbsp;<span class="comment" id="2157343">//&nbsp;reader&nbsp;provided&nbsp;by&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157377">r</span><span class="op" id="2157378">,</span>&nbsp;<span class="ident" id="2157380">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2157390">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2157400">//&nbsp;buf&nbsp;read&nbsp;and&nbsp;write&nbsp;positions</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157433">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2157446">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157453">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2157466">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157471">lastRuneSize</span>&nbsp;<span class="builtintype" id="2157484">int</span><br>
<span class="lineno"></span><span class="op" id="2157488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="2157491">const</span>&nbsp;<span class="ident" id="2157497">minReadBufferSize</span>&nbsp;<span class="op" id="2157515">=</span>&nbsp;<span class="num" id="2157517">16</span><br>
<span class="lineno"></span><span class="keyword" id="2157520">const</span>&nbsp;<span class="ident" id="2157526">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2157551">=</span>&nbsp;<span class="num" id="2157553">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2157558">//&nbsp;NewReaderSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="2157636">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Reader&nbsp;is&nbsp;already&nbsp;a&nbsp;Reader&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno">45</span><span class="comment" id="2157709">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Reader.</span><br>
<span class="lineno"></span><span class="keyword" id="2157752">func</span>&nbsp;<span class="ident" id="2157757">NewReaderSize</span><span class="op" id="2157770">(</span><span class="ident" id="2157771">rd</span>&nbsp;<span class="ident" id="2157774">io</span><span class="op" id="2157776">.</span><span class="ident" id="2157777">Reader</span><span class="op" id="2157783">,</span>&nbsp;<span class="ident" id="2157785">size</span>&nbsp;<span class="builtintype" id="2157790">int</span><span class="op" id="2157793">)</span>&nbsp;<span class="op" id="2157795">*</span><span class="ident" id="2157796">Reader</span>&nbsp;<span class="op" id="2157803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2157806">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Reader?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157834">b</span><span class="op" id="2157835">,</span>&nbsp;<span class="ident" id="2157837">ok</span>&nbsp;<span class="op" id="2157840">:=</span>&nbsp;<span class="ident" id="2157843">rd</span><span class="op" id="2157845">.</span><span class="op" id="2157846">(</span><span class="op" id="2157847">*</span><span class="ident" id="2157848">Reader</span><span class="op" id="2157854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2157857">if</span>&nbsp;<span class="ident" id="2157860">ok</span>&nbsp;<span class="op" id="2157863">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2157866">len</span><span class="op" id="2157869">(</span><span class="ident" id="2157870">b</span><span class="op" id="2157871">.</span><span class="ident" id="2157872">buf</span><span class="op" id="2157875">)</span>&nbsp;<span class="op" id="2157877">&gt;=</span>&nbsp;<span class="ident" id="2157880">size</span>&nbsp;<span class="op" id="2157885">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2157889">return</span>&nbsp;<span class="ident" id="2157896">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2157899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2157902">if</span>&nbsp;<span class="ident" id="2157905">size</span>&nbsp;<span class="op" id="2157910">&lt;</span>&nbsp;<span class="ident" id="2157912">minReadBufferSize</span>&nbsp;<span class="op" id="2157930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157934">size</span>&nbsp;<span class="op" id="2157939">=</span>&nbsp;<span class="ident" id="2157941">minReadBufferSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2157960">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157963">r</span>&nbsp;<span class="op" id="2157965">:=</span>&nbsp;<span class="builtinfunc" id="2157968">new</span><span class="op" id="2157971">(</span><span class="ident" id="2157972">Reader</span><span class="op" id="2157978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2157981">r</span><span class="op" id="2157982">.</span><span class="ident" id="2157983">reset</span><span class="op" id="2157988">(</span><span class="builtinfunc" id="2157989">make</span><span class="op" id="2157993">(</span><span class="op" id="2157994">[</span><span class="op" id="2157995">]</span><span class="builtintype" id="2157996">byte</span><span class="op" id="2158000">,</span>&nbsp;<span class="ident" id="2158002">size</span><span class="op" id="2158006">)</span><span class="op" id="2158007">,</span>&nbsp;<span class="ident" id="2158009">rd</span><span class="op" id="2158011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158014">return</span>&nbsp;<span class="ident" id="2158021">r</span><br>
<span class="lineno"></span><span class="op" id="2158023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="2158026">//&nbsp;NewReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;Reader&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="2158095">func</span>&nbsp;<span class="ident" id="2158100">NewReader</span><span class="op" id="2158109">(</span><span class="ident" id="2158110">rd</span>&nbsp;<span class="ident" id="2158113">io</span><span class="op" id="2158115">.</span><span class="ident" id="2158116">Reader</span><span class="op" id="2158122">)</span>&nbsp;<span class="op" id="2158124">*</span><span class="ident" id="2158125">Reader</span>&nbsp;<span class="op" id="2158132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158135">return</span>&nbsp;<span class="ident" id="2158142">NewReaderSize</span><span class="op" id="2158155">(</span><span class="ident" id="2158156">rd</span><span class="op" id="2158158">,</span>&nbsp;<span class="ident" id="2158160">defaultBufSize</span><span class="op" id="2158174">)</span><br>
<span class="lineno"></span><span class="op" id="2158176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2158179">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;buffered&nbsp;data,&nbsp;resets&nbsp;all&nbsp;state,&nbsp;and&nbsp;switches</span><br>
<span class="lineno"></span><span class="comment" id="2158247">//&nbsp;the&nbsp;buffered&nbsp;reader&nbsp;to&nbsp;read&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="2158286">func</span>&nbsp;<span class="op" id="2158291">(</span><span class="ident" id="2158292">b</span>&nbsp;<span class="op" id="2158294">*</span><span class="ident" id="2158295">Reader</span><span class="op" id="2158301">)</span>&nbsp;<span class="ident" id="2158303">Reset</span><span class="op" id="2158308">(</span><span class="ident" id="2158309">r</span>&nbsp;<span class="ident" id="2158311">io</span><span class="op" id="2158313">.</span><span class="ident" id="2158314">Reader</span><span class="op" id="2158320">)</span>&nbsp;<span class="op" id="2158322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158325">b</span><span class="op" id="2158326">.</span><span class="ident" id="2158327">reset</span><span class="op" id="2158332">(</span><span class="ident" id="2158333">b</span><span class="op" id="2158334">.</span><span class="ident" id="2158335">buf</span><span class="op" id="2158338">,</span>&nbsp;<span class="ident" id="2158340">r</span><span class="op" id="2158341">)</span><br>
<span class="lineno"></span><span class="op" id="2158343">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="2158346">func</span>&nbsp;<span class="op" id="2158351">(</span><span class="ident" id="2158352">b</span>&nbsp;<span class="op" id="2158354">*</span><span class="ident" id="2158355">Reader</span><span class="op" id="2158361">)</span>&nbsp;<span class="ident" id="2158363">reset</span><span class="op" id="2158368">(</span><span class="ident" id="2158369">buf</span>&nbsp;<span class="op" id="2158373">[</span><span class="op" id="2158374">]</span><span class="builtintype" id="2158375">byte</span><span class="op" id="2158379">,</span>&nbsp;<span class="ident" id="2158381">r</span>&nbsp;<span class="ident" id="2158383">io</span><span class="op" id="2158385">.</span><span class="ident" id="2158386">Reader</span><span class="op" id="2158392">)</span>&nbsp;<span class="op" id="2158394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2158397">*</span><span class="ident" id="2158398">b</span>&nbsp;<span class="op" id="2158400">=</span>&nbsp;<span class="ident" id="2158402">Reader</span><span class="op" id="2158408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158412">buf</span><span class="op" id="2158415">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2158426">buf</span><span class="op" id="2158429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158433">rd</span><span class="op" id="2158435">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2158447">r</span><span class="op" id="2158448">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158452">lastByte</span><span class="op" id="2158460">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2158466">-</span><span class="num" id="2158467">1</span><span class="op" id="2158468">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158472">lastRuneSize</span><span class="op" id="2158484">:</span>&nbsp;<span class="op" id="2158486">-</span><span class="num" id="2158487">1</span><span class="op" id="2158488">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2158491">}</span><br>
<span class="lineno"></span><span class="op" id="2158493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="2158496">var</span>&nbsp;<span class="ident" id="2158500">errNegativeRead</span>&nbsp;<span class="op" id="2158516">=</span>&nbsp;<span class="ident" id="2158518">errors</span><span class="op" id="2158524">.</span><span class="ident" id="2158525">New</span><span class="op" id="2158528">(</span><span class="string" id="2158529">&#34;bufio:&nbsp;reader&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Read&#34;</span><span class="op" id="2158578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2158581">//&nbsp;fill&nbsp;reads&nbsp;a&nbsp;new&nbsp;chunk&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2158624">func</span>&nbsp;<span class="op" id="2158629">(</span><span class="ident" id="2158630">b</span>&nbsp;<span class="op" id="2158632">*</span><span class="ident" id="2158633">Reader</span><span class="op" id="2158639">)</span>&nbsp;<span class="ident" id="2158641">fill</span><span class="op" id="2158645">(</span><span class="op" id="2158646">)</span>&nbsp;<span class="op" id="2158648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2158651">//&nbsp;Slide&nbsp;existing&nbsp;data&nbsp;to&nbsp;beginning.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158689">if</span>&nbsp;<span class="ident" id="2158692">b</span><span class="op" id="2158693">.</span><span class="ident" id="2158694">r</span>&nbsp;<span class="op" id="2158696">&gt;</span>&nbsp;<span class="num" id="2158698">0</span>&nbsp;<span class="op" id="2158700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2158704">copy</span><span class="op" id="2158708">(</span><span class="ident" id="2158709">b</span><span class="op" id="2158710">.</span><span class="ident" id="2158711">buf</span><span class="op" id="2158714">,</span>&nbsp;<span class="ident" id="2158716">b</span><span class="op" id="2158717">.</span><span class="ident" id="2158718">buf</span><span class="op" id="2158721">[</span><span class="ident" id="2158722">b</span><span class="op" id="2158723">.</span><span class="ident" id="2158724">r</span><span class="op" id="2158725">:</span><span class="ident" id="2158726">b</span><span class="op" id="2158727">.</span><span class="ident" id="2158728">w</span><span class="op" id="2158729">]</span><span class="op" id="2158730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158734">b</span><span class="op" id="2158735">.</span><span class="ident" id="2158736">w</span>&nbsp;<span class="op" id="2158738">-=</span>&nbsp;<span class="ident" id="2158741">b</span><span class="op" id="2158742">.</span><span class="ident" id="2158743">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158747">b</span><span class="op" id="2158748">.</span><span class="ident" id="2158749">r</span>&nbsp;<span class="op" id="2158751">=</span>&nbsp;<span class="num" id="2158753">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2158756">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158760">if</span>&nbsp;<span class="ident" id="2158763">b</span><span class="op" id="2158764">.</span><span class="ident" id="2158765">w</span>&nbsp;<span class="op" id="2158767">&gt;=</span>&nbsp;<span class="builtinfunc" id="2158770">len</span><span class="op" id="2158773">(</span><span class="ident" id="2158774">b</span><span class="op" id="2158775">.</span><span class="ident" id="2158776">buf</span><span class="op" id="2158779">)</span>&nbsp;<span class="op" id="2158781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2158785">panic</span><span class="op" id="2158790">(</span><span class="string" id="2158791">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;fill&nbsp;full&nbsp;buffer&#34;</span><span class="op" id="2158825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2158828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2158832">//&nbsp;Read&nbsp;new&nbsp;data:&nbsp;try&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158882">for</span>&nbsp;<span class="ident" id="2158886">i</span>&nbsp;<span class="op" id="2158888">:=</span>&nbsp;<span class="ident" id="2158891">maxConsecutiveEmptyReads</span><span class="op" id="2158915">;</span>&nbsp;<span class="ident" id="2158917">i</span>&nbsp;<span class="op" id="2158919">&gt;</span>&nbsp;<span class="num" id="2158921">0</span><span class="op" id="2158922">;</span>&nbsp;<span class="ident" id="2158924">i</span><span class="op" id="2158925">--</span>&nbsp;<span class="op" id="2158928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2158932">n</span><span class="op" id="2158933">,</span>&nbsp;<span class="ident" id="2158935">err</span>&nbsp;<span class="op" id="2158939">:=</span>&nbsp;<span class="ident" id="2158942">b</span><span class="op" id="2158943">.</span><span class="ident" id="2158944">rd</span><span class="op" id="2158946">.</span><span class="ident" id="2158947">Read</span><span class="op" id="2158951">(</span><span class="ident" id="2158952">b</span><span class="op" id="2158953">.</span><span class="ident" id="2158954">buf</span><span class="op" id="2158957">[</span><span class="ident" id="2158958">b</span><span class="op" id="2158959">.</span><span class="ident" id="2158960">w</span><span class="op" id="2158961">:</span><span class="op" id="2158962">]</span><span class="op" id="2158963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2158967">if</span>&nbsp;<span class="ident" id="2158970">n</span>&nbsp;<span class="op" id="2158972">&lt;</span>&nbsp;<span class="num" id="2158974">0</span>&nbsp;<span class="op" id="2158976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2158981">panic</span><span class="op" id="2158986">(</span><span class="ident" id="2158987">errNegativeRead</span><span class="op" id="2159002">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159010">b</span><span class="op" id="2159011">.</span><span class="ident" id="2159012">w</span>&nbsp;<span class="op" id="2159014">+=</span>&nbsp;<span class="ident" id="2159017">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159021">if</span>&nbsp;<span class="ident" id="2159024">err</span>&nbsp;<span class="op" id="2159028">!=</span>&nbsp;<span class="ident" id="2159031">nil</span>&nbsp;<span class="op" id="2159035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159040">b</span><span class="op" id="2159041">.</span><span class="ident" id="2159042">err</span>&nbsp;<span class="op" id="2159046">=</span>&nbsp;<span class="ident" id="2159048">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159055">return</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159068">if</span>&nbsp;<span class="ident" id="2159071">n</span>&nbsp;<span class="op" id="2159073">&gt;</span>&nbsp;<span class="num" id="2159075">0</span>&nbsp;<span class="op" id="2159077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159082">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159094">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159097">b</span><span class="op" id="2159098">.</span><span class="ident" id="2159099">err</span>&nbsp;<span class="op" id="2159103">=</span>&nbsp;<span class="ident" id="2159105">io</span><span class="op" id="2159107">.</span><span class="ident" id="2159108">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="2159122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2159125">func</span>&nbsp;<span class="op" id="2159130">(</span><span class="ident" id="2159131">b</span>&nbsp;<span class="op" id="2159133">*</span><span class="ident" id="2159134">Reader</span><span class="op" id="2159140">)</span>&nbsp;<span class="ident" id="2159142">readErr</span><span class="op" id="2159149">(</span><span class="op" id="2159150">)</span>&nbsp;<span class="builtintype" id="2159152">error</span>&nbsp;<span class="op" id="2159158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159161">err</span>&nbsp;<span class="op" id="2159165">:=</span>&nbsp;<span class="ident" id="2159168">b</span><span class="op" id="2159169">.</span><span class="ident" id="2159170">err</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159175">b</span><span class="op" id="2159176">.</span><span class="ident" id="2159177">err</span>&nbsp;<span class="op" id="2159181">=</span>&nbsp;<span class="ident" id="2159183">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159188">return</span>&nbsp;<span class="ident" id="2159195">err</span><br>
<span class="lineno"></span><span class="op" id="2159199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2159202">//&nbsp;Peek&nbsp;returns&nbsp;the&nbsp;next&nbsp;n&nbsp;bytes&nbsp;without&nbsp;advancing&nbsp;the&nbsp;reader.&nbsp;The&nbsp;bytes&nbsp;stop</span><br>
<span class="lineno">120</span><span class="comment" id="2159280">//&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read&nbsp;call.&nbsp;If&nbsp;Peek&nbsp;returns&nbsp;fewer&nbsp;than&nbsp;n&nbsp;bytes,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="2159357">//&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining&nbsp;why&nbsp;the&nbsp;read&nbsp;is&nbsp;short.&nbsp;The&nbsp;error&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="2159429">//&nbsp;ErrBufferFull&nbsp;if&nbsp;n&nbsp;is&nbsp;larger&nbsp;than&nbsp;b&#39;s&nbsp;buffer&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="2159483">func</span>&nbsp;<span class="op" id="2159488">(</span><span class="ident" id="2159489">b</span>&nbsp;<span class="op" id="2159491">*</span><span class="ident" id="2159492">Reader</span><span class="op" id="2159498">)</span>&nbsp;<span class="ident" id="2159500">Peek</span><span class="op" id="2159504">(</span><span class="ident" id="2159505">n</span>&nbsp;<span class="builtintype" id="2159507">int</span><span class="op" id="2159510">)</span>&nbsp;<span class="op" id="2159512">(</span><span class="op" id="2159513">[</span><span class="op" id="2159514">]</span><span class="builtintype" id="2159515">byte</span><span class="op" id="2159519">,</span>&nbsp;<span class="builtintype" id="2159521">error</span><span class="op" id="2159526">)</span>&nbsp;<span class="op" id="2159528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159531">if</span>&nbsp;<span class="ident" id="2159534">n</span>&nbsp;<span class="op" id="2159536">&lt;</span>&nbsp;<span class="num" id="2159538">0</span>&nbsp;<span class="op" id="2159540">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159544">return</span>&nbsp;<span class="ident" id="2159551">nil</span><span class="op" id="2159554">,</span>&nbsp;<span class="ident" id="2159556">ErrNegativeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159577">if</span>&nbsp;<span class="ident" id="2159580">n</span>&nbsp;<span class="op" id="2159582">&gt;</span>&nbsp;<span class="builtinfunc" id="2159584">len</span><span class="op" id="2159587">(</span><span class="ident" id="2159588">b</span><span class="op" id="2159589">.</span><span class="ident" id="2159590">buf</span><span class="op" id="2159593">)</span>&nbsp;<span class="op" id="2159595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159599">return</span>&nbsp;<span class="ident" id="2159606">nil</span><span class="op" id="2159609">,</span>&nbsp;<span class="ident" id="2159611">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159626">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2159629">//&nbsp;0&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;len(b.buf)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159654">for</span>&nbsp;<span class="ident" id="2159658">b</span><span class="op" id="2159659">.</span><span class="ident" id="2159660">w</span><span class="op" id="2159661">-</span><span class="ident" id="2159662">b</span><span class="op" id="2159663">.</span><span class="ident" id="2159664">r</span>&nbsp;<span class="op" id="2159666">&lt;</span>&nbsp;<span class="ident" id="2159668">n</span>&nbsp;<span class="op" id="2159670">&amp;&amp;</span>&nbsp;<span class="ident" id="2159673">b</span><span class="op" id="2159674">.</span><span class="ident" id="2159675">err</span>&nbsp;<span class="op" id="2159679">==</span>&nbsp;<span class="ident" id="2159682">nil</span>&nbsp;<span class="op" id="2159686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159690">b</span><span class="op" id="2159691">.</span><span class="ident" id="2159692">fill</span><span class="op" id="2159696">(</span><span class="op" id="2159697">)</span>&nbsp;<span class="comment" id="2159699">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(b.buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159750">var</span>&nbsp;<span class="ident" id="2159754">err</span>&nbsp;<span class="builtintype" id="2159758">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159765">if</span>&nbsp;<span class="ident" id="2159768">avail</span>&nbsp;<span class="op" id="2159774">:=</span>&nbsp;<span class="ident" id="2159777">b</span><span class="op" id="2159778">.</span><span class="ident" id="2159779">w</span>&nbsp;<span class="op" id="2159781">-</span>&nbsp;<span class="ident" id="2159783">b</span><span class="op" id="2159784">.</span><span class="ident" id="2159785">r</span><span class="op" id="2159786">;</span>&nbsp;<span class="ident" id="2159788">avail</span>&nbsp;<span class="op" id="2159794">&lt;</span>&nbsp;<span class="ident" id="2159796">n</span>&nbsp;<span class="op" id="2159798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2159802">//&nbsp;not&nbsp;enough&nbsp;data&nbsp;in&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159833">n</span>&nbsp;<span class="op" id="2159835">=</span>&nbsp;<span class="ident" id="2159837">avail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159845">err</span>&nbsp;<span class="op" id="2159849">=</span>&nbsp;<span class="ident" id="2159851">b</span><span class="op" id="2159852">.</span><span class="ident" id="2159853">readErr</span><span class="op" id="2159860">(</span><span class="op" id="2159861">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159865">if</span>&nbsp;<span class="ident" id="2159868">err</span>&nbsp;<span class="op" id="2159872">==</span>&nbsp;<span class="ident" id="2159875">nil</span>&nbsp;<span class="op" id="2159879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2159884">err</span>&nbsp;<span class="op" id="2159888">=</span>&nbsp;<span class="ident" id="2159890">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2159909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2159912">return</span>&nbsp;<span class="ident" id="2159919">b</span><span class="op" id="2159920">.</span><span class="ident" id="2159921">buf</span><span class="op" id="2159924">[</span><span class="ident" id="2159925">b</span><span class="op" id="2159926">.</span><span class="ident" id="2159927">r</span>&nbsp;<span class="op" id="2159929">:</span>&nbsp;<span class="ident" id="2159931">b</span><span class="op" id="2159932">.</span><span class="ident" id="2159933">r</span><span class="op" id="2159934">+</span><span class="ident" id="2159935">n</span><span class="op" id="2159936">]</span><span class="op" id="2159937">,</span>&nbsp;<span class="ident" id="2159939">err</span><br>
<span class="lineno">145</span><span class="op" id="2159943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2159946">//&nbsp;Read&nbsp;reads&nbsp;data&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="2159973">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;read&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="2160020">//&nbsp;It&nbsp;calls&nbsp;Read&nbsp;at&nbsp;most&nbsp;once&nbsp;on&nbsp;the&nbsp;underlying&nbsp;Reader,</span><br>
<span class="lineno">150</span><span class="comment" id="2160076">//&nbsp;hence&nbsp;n&nbsp;may&nbsp;be&nbsp;less&nbsp;than&nbsp;len(p).</span><br>
<span class="lineno"></span><span class="comment" id="2160112">//&nbsp;At&nbsp;EOF,&nbsp;the&nbsp;count&nbsp;will&nbsp;be&nbsp;zero&nbsp;and&nbsp;err&nbsp;will&nbsp;be&nbsp;io.EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="2160170">func</span>&nbsp;<span class="op" id="2160175">(</span><span class="ident" id="2160176">b</span>&nbsp;<span class="op" id="2160178">*</span><span class="ident" id="2160179">Reader</span><span class="op" id="2160185">)</span>&nbsp;<span class="ident" id="2160187">Read</span><span class="op" id="2160191">(</span><span class="ident" id="2160192">p</span>&nbsp;<span class="op" id="2160194">[</span><span class="op" id="2160195">]</span><span class="builtintype" id="2160196">byte</span><span class="op" id="2160200">)</span>&nbsp;<span class="op" id="2160202">(</span><span class="ident" id="2160203">n</span>&nbsp;<span class="builtintype" id="2160205">int</span><span class="op" id="2160208">,</span>&nbsp;<span class="ident" id="2160210">err</span>&nbsp;<span class="builtintype" id="2160214">error</span><span class="op" id="2160219">)</span>&nbsp;<span class="op" id="2160221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160224">n</span>&nbsp;<span class="op" id="2160226">=</span>&nbsp;<span class="builtinfunc" id="2160228">len</span><span class="op" id="2160231">(</span><span class="ident" id="2160232">p</span><span class="op" id="2160233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160236">if</span>&nbsp;<span class="ident" id="2160239">n</span>&nbsp;<span class="op" id="2160241">==</span>&nbsp;<span class="num" id="2160244">0</span>&nbsp;<span class="op" id="2160246">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160250">return</span>&nbsp;<span class="num" id="2160257">0</span><span class="op" id="2160258">,</span>&nbsp;<span class="ident" id="2160260">b</span><span class="op" id="2160261">.</span><span class="ident" id="2160262">readErr</span><span class="op" id="2160269">(</span><span class="op" id="2160270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160276">if</span>&nbsp;<span class="ident" id="2160279">b</span><span class="op" id="2160280">.</span><span class="ident" id="2160281">r</span>&nbsp;<span class="op" id="2160283">==</span>&nbsp;<span class="ident" id="2160286">b</span><span class="op" id="2160287">.</span><span class="ident" id="2160288">w</span>&nbsp;<span class="op" id="2160290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160294">if</span>&nbsp;<span class="ident" id="2160297">b</span><span class="op" id="2160298">.</span><span class="ident" id="2160299">err</span>&nbsp;<span class="op" id="2160303">!=</span>&nbsp;<span class="ident" id="2160306">nil</span>&nbsp;<span class="op" id="2160310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160315">return</span>&nbsp;<span class="num" id="2160322">0</span><span class="op" id="2160323">,</span>&nbsp;<span class="ident" id="2160325">b</span><span class="op" id="2160326">.</span><span class="ident" id="2160327">readErr</span><span class="op" id="2160334">(</span><span class="op" id="2160335">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160343">if</span>&nbsp;<span class="builtinfunc" id="2160346">len</span><span class="op" id="2160349">(</span><span class="ident" id="2160350">p</span><span class="op" id="2160351">)</span>&nbsp;<span class="op" id="2160353">&gt;=</span>&nbsp;<span class="builtinfunc" id="2160356">len</span><span class="op" id="2160359">(</span><span class="ident" id="2160360">b</span><span class="op" id="2160361">.</span><span class="ident" id="2160362">buf</span><span class="op" id="2160365">)</span>&nbsp;<span class="op" id="2160367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2160372">//&nbsp;Large&nbsp;read,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2160404">//&nbsp;Read&nbsp;directly&nbsp;into&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160446">n</span><span class="op" id="2160447">,</span>&nbsp;<span class="ident" id="2160449">b</span><span class="op" id="2160450">.</span><span class="ident" id="2160451">err</span>&nbsp;<span class="op" id="2160455">=</span>&nbsp;<span class="ident" id="2160457">b</span><span class="op" id="2160458">.</span><span class="ident" id="2160459">rd</span><span class="op" id="2160461">.</span><span class="ident" id="2160462">Read</span><span class="op" id="2160466">(</span><span class="ident" id="2160467">p</span><span class="op" id="2160468">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160473">if</span>&nbsp;<span class="ident" id="2160476">n</span>&nbsp;<span class="op" id="2160478">&lt;</span>&nbsp;<span class="num" id="2160480">0</span>&nbsp;<span class="op" id="2160482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2160488">panic</span><span class="op" id="2160493">(</span><span class="ident" id="2160494">errNegativeRead</span><span class="op" id="2160509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160519">if</span>&nbsp;<span class="ident" id="2160522">n</span>&nbsp;<span class="op" id="2160524">&gt;</span>&nbsp;<span class="num" id="2160526">0</span>&nbsp;<span class="op" id="2160528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160534">b</span><span class="op" id="2160535">.</span><span class="ident" id="2160536">lastByte</span>&nbsp;<span class="op" id="2160545">=</span>&nbsp;<span class="builtintype" id="2160547">int</span><span class="op" id="2160550">(</span><span class="ident" id="2160551">p</span><span class="op" id="2160552">[</span><span class="ident" id="2160553">n</span><span class="op" id="2160554">-</span><span class="num" id="2160555">1</span><span class="op" id="2160556">]</span><span class="op" id="2160557">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160563">b</span><span class="op" id="2160564">.</span><span class="ident" id="2160565">lastRuneSize</span>&nbsp;<span class="op" id="2160578">=</span>&nbsp;<span class="op" id="2160580">-</span><span class="num" id="2160581">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160591">return</span>&nbsp;<span class="ident" id="2160598">n</span><span class="op" id="2160599">,</span>&nbsp;<span class="ident" id="2160601">b</span><span class="op" id="2160602">.</span><span class="ident" id="2160603">readErr</span><span class="op" id="2160610">(</span><span class="op" id="2160611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160619">b</span><span class="op" id="2160620">.</span><span class="ident" id="2160621">fill</span><span class="op" id="2160625">(</span><span class="op" id="2160626">)</span>&nbsp;<span class="comment" id="2160628">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160649">if</span>&nbsp;<span class="ident" id="2160652">b</span><span class="op" id="2160653">.</span><span class="ident" id="2160654">r</span>&nbsp;<span class="op" id="2160656">==</span>&nbsp;<span class="ident" id="2160659">b</span><span class="op" id="2160660">.</span><span class="ident" id="2160661">w</span>&nbsp;<span class="op" id="2160663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160668">return</span>&nbsp;<span class="num" id="2160675">0</span><span class="op" id="2160676">,</span>&nbsp;<span class="ident" id="2160678">b</span><span class="op" id="2160679">.</span><span class="ident" id="2160680">readErr</span><span class="op" id="2160687">(</span><span class="op" id="2160688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2160695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2160699">//&nbsp;copy&nbsp;as&nbsp;much&nbsp;as&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160726">n</span>&nbsp;<span class="op" id="2160728">=</span>&nbsp;<span class="builtinfunc" id="2160730">copy</span><span class="op" id="2160734">(</span><span class="ident" id="2160735">p</span><span class="op" id="2160736">,</span>&nbsp;<span class="ident" id="2160738">b</span><span class="op" id="2160739">.</span><span class="ident" id="2160740">buf</span><span class="op" id="2160743">[</span><span class="ident" id="2160744">b</span><span class="op" id="2160745">.</span><span class="ident" id="2160746">r</span><span class="op" id="2160747">:</span><span class="ident" id="2160748">b</span><span class="op" id="2160749">.</span><span class="ident" id="2160750">w</span><span class="op" id="2160751">]</span><span class="op" id="2160752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160755">b</span><span class="op" id="2160756">.</span><span class="ident" id="2160757">r</span>&nbsp;<span class="op" id="2160759">+=</span>&nbsp;<span class="ident" id="2160762">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160765">b</span><span class="op" id="2160766">.</span><span class="ident" id="2160767">lastByte</span>&nbsp;<span class="op" id="2160776">=</span>&nbsp;<span class="builtintype" id="2160778">int</span><span class="op" id="2160781">(</span><span class="ident" id="2160782">b</span><span class="op" id="2160783">.</span><span class="ident" id="2160784">buf</span><span class="op" id="2160787">[</span><span class="ident" id="2160788">b</span><span class="op" id="2160789">.</span><span class="ident" id="2160790">r</span><span class="op" id="2160791">-</span><span class="num" id="2160792">1</span><span class="op" id="2160793">]</span><span class="op" id="2160794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160797">b</span><span class="op" id="2160798">.</span><span class="ident" id="2160799">lastRuneSize</span>&nbsp;<span class="op" id="2160812">=</span>&nbsp;<span class="op" id="2160814">-</span><span class="num" id="2160815">1</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160818">return</span>&nbsp;<span class="ident" id="2160825">n</span><span class="op" id="2160826">,</span>&nbsp;<span class="ident" id="2160828">nil</span><br>
<span class="lineno"></span><span class="op" id="2160832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2160835">//&nbsp;ReadByte&nbsp;reads&nbsp;and&nbsp;returns&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="comment" id="2160880">//&nbsp;If&nbsp;no&nbsp;byte&nbsp;is&nbsp;available,&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">190</span><span class="keyword" id="2160926">func</span>&nbsp;<span class="op" id="2160931">(</span><span class="ident" id="2160932">b</span>&nbsp;<span class="op" id="2160934">*</span><span class="ident" id="2160935">Reader</span><span class="op" id="2160941">)</span>&nbsp;<span class="ident" id="2160943">ReadByte</span><span class="op" id="2160951">(</span><span class="op" id="2160952">)</span>&nbsp;<span class="op" id="2160954">(</span><span class="ident" id="2160955">c</span>&nbsp;<span class="builtintype" id="2160957">byte</span><span class="op" id="2160961">,</span>&nbsp;<span class="ident" id="2160963">err</span>&nbsp;<span class="builtintype" id="2160967">error</span><span class="op" id="2160972">)</span>&nbsp;<span class="op" id="2160974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2160977">b</span><span class="op" id="2160978">.</span><span class="ident" id="2160979">lastRuneSize</span>&nbsp;<span class="op" id="2160992">=</span>&nbsp;<span class="op" id="2160994">-</span><span class="num" id="2160995">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2160998">for</span>&nbsp;<span class="ident" id="2161002">b</span><span class="op" id="2161003">.</span><span class="ident" id="2161004">r</span>&nbsp;<span class="op" id="2161006">==</span>&nbsp;<span class="ident" id="2161009">b</span><span class="op" id="2161010">.</span><span class="ident" id="2161011">w</span>&nbsp;<span class="op" id="2161013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161017">if</span>&nbsp;<span class="ident" id="2161020">b</span><span class="op" id="2161021">.</span><span class="ident" id="2161022">err</span>&nbsp;<span class="op" id="2161026">!=</span>&nbsp;<span class="ident" id="2161029">nil</span>&nbsp;<span class="op" id="2161033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161038">return</span>&nbsp;<span class="num" id="2161045">0</span><span class="op" id="2161046">,</span>&nbsp;<span class="ident" id="2161048">b</span><span class="op" id="2161049">.</span><span class="ident" id="2161050">readErr</span><span class="op" id="2161057">(</span><span class="op" id="2161058">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161066">b</span><span class="op" id="2161067">.</span><span class="ident" id="2161068">fill</span><span class="op" id="2161072">(</span><span class="op" id="2161073">)</span>&nbsp;<span class="comment" id="2161075">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161095">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161098">c</span>&nbsp;<span class="op" id="2161100">=</span>&nbsp;<span class="ident" id="2161102">b</span><span class="op" id="2161103">.</span><span class="ident" id="2161104">buf</span><span class="op" id="2161107">[</span><span class="ident" id="2161108">b</span><span class="op" id="2161109">.</span><span class="ident" id="2161110">r</span><span class="op" id="2161111">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161114">b</span><span class="op" id="2161115">.</span><span class="ident" id="2161116">r</span><span class="op" id="2161117">++</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161121">b</span><span class="op" id="2161122">.</span><span class="ident" id="2161123">lastByte</span>&nbsp;<span class="op" id="2161132">=</span>&nbsp;<span class="builtintype" id="2161134">int</span><span class="op" id="2161137">(</span><span class="ident" id="2161138">c</span><span class="op" id="2161139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161142">return</span>&nbsp;<span class="ident" id="2161149">c</span><span class="op" id="2161150">,</span>&nbsp;<span class="ident" id="2161152">nil</span><br>
<span class="lineno"></span><span class="op" id="2161156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2161159">//&nbsp;UnreadByte&nbsp;unreads&nbsp;the&nbsp;last&nbsp;byte.&nbsp;&nbsp;Only&nbsp;the&nbsp;most&nbsp;recently&nbsp;read&nbsp;byte&nbsp;can&nbsp;be&nbsp;unread.</span><br>
<span class="lineno">205</span><span class="keyword" id="2161245">func</span>&nbsp;<span class="op" id="2161250">(</span><span class="ident" id="2161251">b</span>&nbsp;<span class="op" id="2161253">*</span><span class="ident" id="2161254">Reader</span><span class="op" id="2161260">)</span>&nbsp;<span class="ident" id="2161262">UnreadByte</span><span class="op" id="2161272">(</span><span class="op" id="2161273">)</span>&nbsp;<span class="builtintype" id="2161275">error</span>&nbsp;<span class="op" id="2161281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161284">if</span>&nbsp;<span class="ident" id="2161287">b</span><span class="op" id="2161288">.</span><span class="ident" id="2161289">lastByte</span>&nbsp;<span class="op" id="2161298">&lt;</span>&nbsp;<span class="num" id="2161300">0</span>&nbsp;<span class="op" id="2161302">||</span>&nbsp;<span class="ident" id="2161305">b</span><span class="op" id="2161306">.</span><span class="ident" id="2161307">r</span>&nbsp;<span class="op" id="2161309">==</span>&nbsp;<span class="num" id="2161312">0</span>&nbsp;<span class="op" id="2161314">&amp;&amp;</span>&nbsp;<span class="ident" id="2161317">b</span><span class="op" id="2161318">.</span><span class="ident" id="2161319">w</span>&nbsp;<span class="op" id="2161321">&gt;</span>&nbsp;<span class="num" id="2161323">0</span>&nbsp;<span class="op" id="2161325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161329">return</span>&nbsp;<span class="ident" id="2161336">ErrInvalidUnreadByte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2161361">//&nbsp;b.r&nbsp;&gt;&nbsp;0&nbsp;||&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161385">if</span>&nbsp;<span class="ident" id="2161388">b</span><span class="op" id="2161389">.</span><span class="ident" id="2161390">r</span>&nbsp;<span class="op" id="2161392">&gt;</span>&nbsp;<span class="num" id="2161394">0</span>&nbsp;<span class="op" id="2161396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161400">b</span><span class="op" id="2161401">.</span><span class="ident" id="2161402">r</span><span class="op" id="2161403">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161407">}</span>&nbsp;<span class="keyword" id="2161409">else</span>&nbsp;<span class="op" id="2161414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2161418">//&nbsp;b.r&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;b.w&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161444">b</span><span class="op" id="2161445">.</span><span class="ident" id="2161446">w</span>&nbsp;<span class="op" id="2161448">=</span>&nbsp;<span class="num" id="2161450">1</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161456">b</span><span class="op" id="2161457">.</span><span class="ident" id="2161458">buf</span><span class="op" id="2161461">[</span><span class="ident" id="2161462">b</span><span class="op" id="2161463">.</span><span class="ident" id="2161464">r</span><span class="op" id="2161465">]</span>&nbsp;<span class="op" id="2161467">=</span>&nbsp;<span class="builtintype" id="2161469">byte</span><span class="op" id="2161473">(</span><span class="ident" id="2161474">b</span><span class="op" id="2161475">.</span><span class="ident" id="2161476">lastByte</span><span class="op" id="2161484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161487">b</span><span class="op" id="2161488">.</span><span class="ident" id="2161489">lastByte</span>&nbsp;<span class="op" id="2161498">=</span>&nbsp;<span class="op" id="2161500">-</span><span class="num" id="2161501">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161504">b</span><span class="op" id="2161505">.</span><span class="ident" id="2161506">lastRuneSize</span>&nbsp;<span class="op" id="2161519">=</span>&nbsp;<span class="op" id="2161521">-</span><span class="num" id="2161522">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161525">return</span>&nbsp;<span class="ident" id="2161532">nil</span><br>
<span class="lineno">220</span><span class="op" id="2161536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2161539">//&nbsp;ReadRune&nbsp;reads&nbsp;a&nbsp;single&nbsp;UTF-8&nbsp;encoded&nbsp;Unicode&nbsp;character&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2161614">//&nbsp;rune&nbsp;and&nbsp;its&nbsp;size&nbsp;in&nbsp;bytes.&nbsp;If&nbsp;the&nbsp;encoded&nbsp;rune&nbsp;is&nbsp;invalid,&nbsp;it&nbsp;consumes&nbsp;one&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="2161698">//&nbsp;and&nbsp;returns&nbsp;unicode.ReplacementChar&nbsp;(U+FFFD)&nbsp;with&nbsp;a&nbsp;size&nbsp;of&nbsp;1.</span><br>
<span class="lineno">225</span><span class="keyword" id="2161764">func</span>&nbsp;<span class="op" id="2161769">(</span><span class="ident" id="2161770">b</span>&nbsp;<span class="op" id="2161772">*</span><span class="ident" id="2161773">Reader</span><span class="op" id="2161779">)</span>&nbsp;<span class="ident" id="2161781">ReadRune</span><span class="op" id="2161789">(</span><span class="op" id="2161790">)</span>&nbsp;<span class="op" id="2161792">(</span><span class="ident" id="2161793">r</span>&nbsp;<span class="builtintype" id="2161795">rune</span><span class="op" id="2161799">,</span>&nbsp;<span class="ident" id="2161801">size</span>&nbsp;<span class="builtintype" id="2161806">int</span><span class="op" id="2161809">,</span>&nbsp;<span class="ident" id="2161811">err</span>&nbsp;<span class="builtintype" id="2161815">error</span><span class="op" id="2161820">)</span>&nbsp;<span class="op" id="2161822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2161825">for</span>&nbsp;<span class="ident" id="2161829">b</span><span class="op" id="2161830">.</span><span class="ident" id="2161831">r</span><span class="op" id="2161832">+</span><span class="ident" id="2161833">utf8</span><span class="op" id="2161837">.</span><span class="ident" id="2161838">UTFMax</span>&nbsp;<span class="op" id="2161845">&gt;</span>&nbsp;<span class="ident" id="2161847">b</span><span class="op" id="2161848">.</span><span class="ident" id="2161849">w</span>&nbsp;<span class="op" id="2161851">&amp;&amp;</span>&nbsp;<span class="op" id="2161854">!</span><span class="ident" id="2161855">utf8</span><span class="op" id="2161859">.</span><span class="ident" id="2161860">FullRune</span><span class="op" id="2161868">(</span><span class="ident" id="2161869">b</span><span class="op" id="2161870">.</span><span class="ident" id="2161871">buf</span><span class="op" id="2161874">[</span><span class="ident" id="2161875">b</span><span class="op" id="2161876">.</span><span class="ident" id="2161877">r</span><span class="op" id="2161878">:</span><span class="ident" id="2161879">b</span><span class="op" id="2161880">.</span><span class="ident" id="2161881">w</span><span class="op" id="2161882">]</span><span class="op" id="2161883">)</span>&nbsp;<span class="op" id="2161885">&amp;&amp;</span>&nbsp;<span class="ident" id="2161888">b</span><span class="op" id="2161889">.</span><span class="ident" id="2161890">err</span>&nbsp;<span class="op" id="2161894">==</span>&nbsp;<span class="ident" id="2161897">nil</span>&nbsp;<span class="op" id="2161901">&amp;&amp;</span>&nbsp;<span class="ident" id="2161904">b</span><span class="op" id="2161905">.</span><span class="ident" id="2161906">w</span><span class="op" id="2161907">-</span><span class="ident" id="2161908">b</span><span class="op" id="2161909">.</span><span class="ident" id="2161910">r</span>&nbsp;<span class="op" id="2161912">&lt;</span>&nbsp;<span class="builtinfunc" id="2161914">len</span><span class="op" id="2161917">(</span><span class="ident" id="2161918">b</span><span class="op" id="2161919">.</span><span class="ident" id="2161920">buf</span><span class="op" id="2161923">)</span>&nbsp;<span class="op" id="2161925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161929">b</span><span class="op" id="2161930">.</span><span class="ident" id="2161931">fill</span><span class="op" id="2161935">(</span><span class="op" id="2161936">)</span>&nbsp;<span class="comment" id="2161938">//&nbsp;b.w-b.r&nbsp;&lt;&nbsp;len(buf)&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2161983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2161986">b</span><span class="op" id="2161987">.</span><span class="ident" id="2161988">lastRuneSize</span>&nbsp;<span class="op" id="2162001">=</span>&nbsp;<span class="op" id="2162003">-</span><span class="num" id="2162004">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162007">if</span>&nbsp;<span class="ident" id="2162010">b</span><span class="op" id="2162011">.</span><span class="ident" id="2162012">r</span>&nbsp;<span class="op" id="2162014">==</span>&nbsp;<span class="ident" id="2162017">b</span><span class="op" id="2162018">.</span><span class="ident" id="2162019">w</span>&nbsp;<span class="op" id="2162021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162025">return</span>&nbsp;<span class="num" id="2162032">0</span><span class="op" id="2162033">,</span>&nbsp;<span class="num" id="2162035">0</span><span class="op" id="2162036">,</span>&nbsp;<span class="ident" id="2162038">b</span><span class="op" id="2162039">.</span><span class="ident" id="2162040">readErr</span><span class="op" id="2162047">(</span><span class="op" id="2162048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2162051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162054">r</span><span class="op" id="2162055">,</span>&nbsp;<span class="ident" id="2162057">size</span>&nbsp;<span class="op" id="2162062">=</span>&nbsp;<span class="builtintype" id="2162064">rune</span><span class="op" id="2162068">(</span><span class="ident" id="2162069">b</span><span class="op" id="2162070">.</span><span class="ident" id="2162071">buf</span><span class="op" id="2162074">[</span><span class="ident" id="2162075">b</span><span class="op" id="2162076">.</span><span class="ident" id="2162077">r</span><span class="op" id="2162078">]</span><span class="op" id="2162079">)</span><span class="op" id="2162080">,</span>&nbsp;<span class="num" id="2162082">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162085">if</span>&nbsp;<span class="ident" id="2162088">r</span>&nbsp;<span class="op" id="2162090">&gt;=</span>&nbsp;<span class="num" id="2162093">0x80</span>&nbsp;<span class="op" id="2162098">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162102">r</span><span class="op" id="2162103">,</span>&nbsp;<span class="ident" id="2162105">size</span>&nbsp;<span class="op" id="2162110">=</span>&nbsp;<span class="ident" id="2162112">utf8</span><span class="op" id="2162116">.</span><span class="ident" id="2162117">DecodeRune</span><span class="op" id="2162127">(</span><span class="ident" id="2162128">b</span><span class="op" id="2162129">.</span><span class="ident" id="2162130">buf</span><span class="op" id="2162133">[</span><span class="ident" id="2162134">b</span><span class="op" id="2162135">.</span><span class="ident" id="2162136">r</span><span class="op" id="2162137">:</span><span class="ident" id="2162138">b</span><span class="op" id="2162139">.</span><span class="ident" id="2162140">w</span><span class="op" id="2162141">]</span><span class="op" id="2162142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2162145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162148">b</span><span class="op" id="2162149">.</span><span class="ident" id="2162150">r</span>&nbsp;<span class="op" id="2162152">+=</span>&nbsp;<span class="ident" id="2162155">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162161">b</span><span class="op" id="2162162">.</span><span class="ident" id="2162163">lastByte</span>&nbsp;<span class="op" id="2162172">=</span>&nbsp;<span class="builtintype" id="2162174">int</span><span class="op" id="2162177">(</span><span class="ident" id="2162178">b</span><span class="op" id="2162179">.</span><span class="ident" id="2162180">buf</span><span class="op" id="2162183">[</span><span class="ident" id="2162184">b</span><span class="op" id="2162185">.</span><span class="ident" id="2162186">r</span><span class="op" id="2162187">-</span><span class="num" id="2162188">1</span><span class="op" id="2162189">]</span><span class="op" id="2162190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162193">b</span><span class="op" id="2162194">.</span><span class="ident" id="2162195">lastRuneSize</span>&nbsp;<span class="op" id="2162208">=</span>&nbsp;<span class="ident" id="2162210">size</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162216">return</span>&nbsp;<span class="ident" id="2162223">r</span><span class="op" id="2162224">,</span>&nbsp;<span class="ident" id="2162226">size</span><span class="op" id="2162230">,</span>&nbsp;<span class="ident" id="2162232">nil</span><br>
<span class="lineno"></span><span class="op" id="2162236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2162239">//&nbsp;UnreadRune&nbsp;unreads&nbsp;the&nbsp;last&nbsp;rune.&nbsp;&nbsp;If&nbsp;the&nbsp;most&nbsp;recent&nbsp;read&nbsp;operation&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="2162314">//&nbsp;the&nbsp;buffer&nbsp;was&nbsp;not&nbsp;a&nbsp;ReadRune,&nbsp;UnreadRune&nbsp;returns&nbsp;an&nbsp;error.&nbsp;&nbsp;(In&nbsp;this</span><br>
<span class="lineno">245</span><span class="comment" id="2162387">//&nbsp;regard&nbsp;it&nbsp;is&nbsp;stricter&nbsp;than&nbsp;UnreadByte,&nbsp;which&nbsp;will&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="2162461">//&nbsp;from&nbsp;any&nbsp;read&nbsp;operation.)</span><br>
<span class="lineno"></span><span class="keyword" id="2162490">func</span>&nbsp;<span class="op" id="2162495">(</span><span class="ident" id="2162496">b</span>&nbsp;<span class="op" id="2162498">*</span><span class="ident" id="2162499">Reader</span><span class="op" id="2162505">)</span>&nbsp;<span class="ident" id="2162507">UnreadRune</span><span class="op" id="2162517">(</span><span class="op" id="2162518">)</span>&nbsp;<span class="builtintype" id="2162520">error</span>&nbsp;<span class="op" id="2162526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162529">if</span>&nbsp;<span class="ident" id="2162532">b</span><span class="op" id="2162533">.</span><span class="ident" id="2162534">lastRuneSize</span>&nbsp;<span class="op" id="2162547">&lt;</span>&nbsp;<span class="num" id="2162549">0</span>&nbsp;<span class="op" id="2162551">||</span>&nbsp;<span class="ident" id="2162554">b</span><span class="op" id="2162555">.</span><span class="ident" id="2162556">r</span>&nbsp;<span class="op" id="2162558">&lt;</span>&nbsp;<span class="ident" id="2162560">b</span><span class="op" id="2162561">.</span><span class="ident" id="2162562">lastRuneSize</span>&nbsp;<span class="op" id="2162575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162579">return</span>&nbsp;<span class="ident" id="2162586">ErrInvalidUnreadRune</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2162608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162611">b</span><span class="op" id="2162612">.</span><span class="ident" id="2162613">r</span>&nbsp;<span class="op" id="2162615">-=</span>&nbsp;<span class="ident" id="2162618">b</span><span class="op" id="2162619">.</span><span class="ident" id="2162620">lastRuneSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162634">b</span><span class="op" id="2162635">.</span><span class="ident" id="2162636">lastByte</span>&nbsp;<span class="op" id="2162645">=</span>&nbsp;<span class="op" id="2162647">-</span><span class="num" id="2162648">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2162651">b</span><span class="op" id="2162652">.</span><span class="ident" id="2162653">lastRuneSize</span>&nbsp;<span class="op" id="2162666">=</span>&nbsp;<span class="op" id="2162668">-</span><span class="num" id="2162669">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2162672">return</span>&nbsp;<span class="ident" id="2162679">nil</span><br>
<span class="lineno">255</span><span class="op" id="2162683">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2162686">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;can&nbsp;be&nbsp;read&nbsp;from&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2162768">func</span>&nbsp;<span class="op" id="2162773">(</span><span class="ident" id="2162774">b</span>&nbsp;<span class="op" id="2162776">*</span><span class="ident" id="2162777">Reader</span><span class="op" id="2162783">)</span>&nbsp;<span class="ident" id="2162785">Buffered</span><span class="op" id="2162793">(</span><span class="op" id="2162794">)</span>&nbsp;<span class="builtintype" id="2162796">int</span>&nbsp;<span class="op" id="2162800">{</span>&nbsp;<span class="keyword" id="2162802">return</span>&nbsp;<span class="ident" id="2162809">b</span><span class="op" id="2162810">.</span><span class="ident" id="2162811">w</span>&nbsp;<span class="op" id="2162813">-</span>&nbsp;<span class="ident" id="2162815">b</span><span class="op" id="2162816">.</span><span class="ident" id="2162817">r</span>&nbsp;<span class="op" id="2162819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="2162822">//&nbsp;ReadSlice&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2162891">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;pointing&nbsp;at&nbsp;the&nbsp;bytes&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="2162949">//&nbsp;The&nbsp;bytes&nbsp;stop&nbsp;being&nbsp;valid&nbsp;at&nbsp;the&nbsp;next&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="2162997">//&nbsp;If&nbsp;ReadSlice&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2163061">//&nbsp;it&nbsp;returns&nbsp;all&nbsp;the&nbsp;data&nbsp;in&nbsp;the&nbsp;buffer&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">265</span><span class="comment" id="2163139">//&nbsp;ReadSlice&nbsp;fails&nbsp;with&nbsp;error&nbsp;ErrBufferFull&nbsp;if&nbsp;the&nbsp;buffer&nbsp;fills&nbsp;without&nbsp;a&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2163220">//&nbsp;Because&nbsp;the&nbsp;data&nbsp;returned&nbsp;from&nbsp;ReadSlice&nbsp;will&nbsp;be&nbsp;overwritten</span><br>
<span class="lineno"></span><span class="comment" id="2163284">//&nbsp;by&nbsp;the&nbsp;next&nbsp;I/O&nbsp;operation,&nbsp;most&nbsp;clients&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="2163338">//&nbsp;ReadBytes&nbsp;or&nbsp;ReadString&nbsp;instead.</span><br>
<span class="lineno"></span><span class="comment" id="2163374">//&nbsp;ReadSlice&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;line&nbsp;does&nbsp;not&nbsp;end&nbsp;in&nbsp;delim.</span><br>
<span class="lineno">270</span><span class="keyword" id="2163449">func</span>&nbsp;<span class="op" id="2163454">(</span><span class="ident" id="2163455">b</span>&nbsp;<span class="op" id="2163457">*</span><span class="ident" id="2163458">Reader</span><span class="op" id="2163464">)</span>&nbsp;<span class="ident" id="2163466">ReadSlice</span><span class="op" id="2163475">(</span><span class="ident" id="2163476">delim</span>&nbsp;<span class="builtintype" id="2163482">byte</span><span class="op" id="2163486">)</span>&nbsp;<span class="op" id="2163488">(</span><span class="ident" id="2163489">line</span>&nbsp;<span class="op" id="2163494">[</span><span class="op" id="2163495">]</span><span class="builtintype" id="2163496">byte</span><span class="op" id="2163500">,</span>&nbsp;<span class="ident" id="2163502">err</span>&nbsp;<span class="builtintype" id="2163506">error</span><span class="op" id="2163511">)</span>&nbsp;<span class="op" id="2163513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163516">for</span>&nbsp;<span class="op" id="2163520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2163524">//&nbsp;Search&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163544">if</span>&nbsp;<span class="ident" id="2163547">i</span>&nbsp;<span class="op" id="2163549">:=</span>&nbsp;<span class="ident" id="2163552">bytes</span><span class="op" id="2163557">.</span><span class="ident" id="2163558">IndexByte</span><span class="op" id="2163567">(</span><span class="ident" id="2163568">b</span><span class="op" id="2163569">.</span><span class="ident" id="2163570">buf</span><span class="op" id="2163573">[</span><span class="ident" id="2163574">b</span><span class="op" id="2163575">.</span><span class="ident" id="2163576">r</span><span class="op" id="2163577">:</span><span class="ident" id="2163578">b</span><span class="op" id="2163579">.</span><span class="ident" id="2163580">w</span><span class="op" id="2163581">]</span><span class="op" id="2163582">,</span>&nbsp;<span class="ident" id="2163584">delim</span><span class="op" id="2163589">)</span><span class="op" id="2163590">;</span>&nbsp;<span class="ident" id="2163592">i</span>&nbsp;<span class="op" id="2163594">&gt;=</span>&nbsp;<span class="num" id="2163597">0</span>&nbsp;<span class="op" id="2163599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163604">line</span>&nbsp;<span class="op" id="2163609">=</span>&nbsp;<span class="ident" id="2163611">b</span><span class="op" id="2163612">.</span><span class="ident" id="2163613">buf</span><span class="op" id="2163616">[</span><span class="ident" id="2163617">b</span><span class="op" id="2163618">.</span><span class="ident" id="2163619">r</span>&nbsp;<span class="op" id="2163621">:</span>&nbsp;<span class="ident" id="2163623">b</span><span class="op" id="2163624">.</span><span class="ident" id="2163625">r</span><span class="op" id="2163626">+</span><span class="ident" id="2163627">i</span><span class="op" id="2163628">+</span><span class="num" id="2163629">1</span><span class="op" id="2163630">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163635">b</span><span class="op" id="2163636">.</span><span class="ident" id="2163637">r</span>&nbsp;<span class="op" id="2163639">+=</span>&nbsp;<span class="ident" id="2163642">i</span>&nbsp;<span class="op" id="2163644">+</span>&nbsp;<span class="num" id="2163646">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163651">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2163659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2163664">//&nbsp;Pending&nbsp;error?</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163684">if</span>&nbsp;<span class="ident" id="2163687">b</span><span class="op" id="2163688">.</span><span class="ident" id="2163689">err</span>&nbsp;<span class="op" id="2163693">!=</span>&nbsp;<span class="ident" id="2163696">nil</span>&nbsp;<span class="op" id="2163700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163705">line</span>&nbsp;<span class="op" id="2163710">=</span>&nbsp;<span class="ident" id="2163712">b</span><span class="op" id="2163713">.</span><span class="ident" id="2163714">buf</span><span class="op" id="2163717">[</span><span class="ident" id="2163718">b</span><span class="op" id="2163719">.</span><span class="ident" id="2163720">r</span><span class="op" id="2163721">:</span><span class="ident" id="2163722">b</span><span class="op" id="2163723">.</span><span class="ident" id="2163724">w</span><span class="op" id="2163725">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163730">b</span><span class="op" id="2163731">.</span><span class="ident" id="2163732">r</span>&nbsp;<span class="op" id="2163734">=</span>&nbsp;<span class="ident" id="2163736">b</span><span class="op" id="2163737">.</span><span class="ident" id="2163738">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163743">err</span>&nbsp;<span class="op" id="2163747">=</span>&nbsp;<span class="ident" id="2163749">b</span><span class="op" id="2163750">.</span><span class="ident" id="2163751">readErr</span><span class="op" id="2163758">(</span><span class="op" id="2163759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163764">break</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2163772">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2163777">//&nbsp;Buffer&nbsp;full?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163795">if</span>&nbsp;<span class="ident" id="2163798">b</span><span class="op" id="2163799">.</span><span class="ident" id="2163800">Buffered</span><span class="op" id="2163808">(</span><span class="op" id="2163809">)</span>&nbsp;<span class="op" id="2163811">&gt;=</span>&nbsp;<span class="builtinfunc" id="2163814">len</span><span class="op" id="2163817">(</span><span class="ident" id="2163818">b</span><span class="op" id="2163819">.</span><span class="ident" id="2163820">buf</span><span class="op" id="2163823">)</span>&nbsp;<span class="op" id="2163825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163830">b</span><span class="op" id="2163831">.</span><span class="ident" id="2163832">r</span>&nbsp;<span class="op" id="2163834">=</span>&nbsp;<span class="ident" id="2163836">b</span><span class="op" id="2163837">.</span><span class="ident" id="2163838">w</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163843">line</span>&nbsp;<span class="op" id="2163848">=</span>&nbsp;<span class="ident" id="2163850">b</span><span class="op" id="2163851">.</span><span class="ident" id="2163852">buf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163859">err</span>&nbsp;<span class="op" id="2163863">=</span>&nbsp;<span class="ident" id="2163865">ErrBufferFull</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163882">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2163890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163895">b</span><span class="op" id="2163896">.</span><span class="ident" id="2163897">fill</span><span class="op" id="2163901">(</span><span class="op" id="2163902">)</span>&nbsp;<span class="comment" id="2163904">//&nbsp;buffer&nbsp;is&nbsp;not&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2163927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2163931">//&nbsp;Handle&nbsp;last&nbsp;byte,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2163961">if</span>&nbsp;<span class="ident" id="2163964">i</span>&nbsp;<span class="op" id="2163966">:=</span>&nbsp;<span class="builtinfunc" id="2163969">len</span><span class="op" id="2163972">(</span><span class="ident" id="2163973">line</span><span class="op" id="2163977">)</span>&nbsp;<span class="op" id="2163979">-</span>&nbsp;<span class="num" id="2163981">1</span><span class="op" id="2163982">;</span>&nbsp;<span class="ident" id="2163984">i</span>&nbsp;<span class="op" id="2163986">&gt;=</span>&nbsp;<span class="num" id="2163989">0</span>&nbsp;<span class="op" id="2163991">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2163995">b</span><span class="op" id="2163996">.</span><span class="ident" id="2163997">lastByte</span>&nbsp;<span class="op" id="2164006">=</span>&nbsp;<span class="builtintype" id="2164008">int</span><span class="op" id="2164011">(</span><span class="ident" id="2164012">line</span><span class="op" id="2164016">[</span><span class="ident" id="2164017">i</span><span class="op" id="2164018">]</span><span class="op" id="2164019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2164023">b</span><span class="op" id="2164024">.</span><span class="ident" id="2164025">lastRuneSize</span>&nbsp;<span class="op" id="2164038">=</span>&nbsp;<span class="op" id="2164040">-</span><span class="num" id="2164041">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2164044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2164048">return</span><br>
<span class="lineno">305</span><span class="op" id="2164055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2164058">//&nbsp;ReadLine&nbsp;is&nbsp;a&nbsp;low-level&nbsp;line-reading&nbsp;primitive.&nbsp;Most&nbsp;callers&nbsp;should&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="2164133">//&nbsp;ReadBytes(&#39;\n&#39;)&nbsp;or&nbsp;ReadString(&#39;\n&#39;)&nbsp;instead&nbsp;or&nbsp;use&nbsp;a&nbsp;Scanner.</span><br>
<span class="lineno"></span><span class="comment" id="2164198">//</span><br>
<span class="lineno">310</span><span class="comment" id="2164201">//&nbsp;ReadLine&nbsp;tries&nbsp;to&nbsp;return&nbsp;a&nbsp;single&nbsp;line,&nbsp;not&nbsp;including&nbsp;the&nbsp;end-of-line&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="comment" id="2164281">//&nbsp;If&nbsp;the&nbsp;line&nbsp;was&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;buffer&nbsp;then&nbsp;isPrefix&nbsp;is&nbsp;set&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2164353">//&nbsp;beginning&nbsp;of&nbsp;the&nbsp;line&nbsp;is&nbsp;returned.&nbsp;The&nbsp;rest&nbsp;of&nbsp;the&nbsp;line&nbsp;will&nbsp;be&nbsp;returned</span><br>
<span class="lineno"></span><span class="comment" id="2164429">//&nbsp;from&nbsp;future&nbsp;calls.&nbsp;isPrefix&nbsp;will&nbsp;be&nbsp;false&nbsp;when&nbsp;returning&nbsp;the&nbsp;last&nbsp;fragment</span><br>
<span class="lineno"></span><span class="comment" id="2164507">//&nbsp;of&nbsp;the&nbsp;line.&nbsp;The&nbsp;returned&nbsp;buffer&nbsp;is&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to</span><br>
<span class="lineno">315</span><span class="comment" id="2164580">//&nbsp;ReadLine.&nbsp;ReadLine&nbsp;either&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;line&nbsp;or&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,</span><br>
<span class="lineno"></span><span class="comment" id="2164656">//&nbsp;never&nbsp;both.</span><br>
<span class="lineno"></span><span class="comment" id="2164671">//</span><br>
<span class="lineno"></span><span class="comment" id="2164674">//&nbsp;The&nbsp;text&nbsp;returned&nbsp;from&nbsp;ReadLine&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;line&nbsp;end&nbsp;(&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;).</span><br>
<span class="lineno"></span><span class="comment" id="2164757">//&nbsp;No&nbsp;indication&nbsp;or&nbsp;error&nbsp;is&nbsp;given&nbsp;if&nbsp;the&nbsp;input&nbsp;ends&nbsp;without&nbsp;a&nbsp;final&nbsp;line&nbsp;end.</span><br>
<span class="lineno">320</span><span class="comment" id="2164836">//&nbsp;Calling&nbsp;UnreadByte&nbsp;after&nbsp;ReadLine&nbsp;will&nbsp;always&nbsp;unread&nbsp;the&nbsp;last&nbsp;byte&nbsp;read</span><br>
<span class="lineno"></span><span class="comment" id="2164911">//&nbsp;(possibly&nbsp;a&nbsp;character&nbsp;belonging&nbsp;to&nbsp;the&nbsp;line&nbsp;end)&nbsp;even&nbsp;if&nbsp;that&nbsp;byte&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="2164988">//&nbsp;part&nbsp;of&nbsp;the&nbsp;line&nbsp;returned&nbsp;by&nbsp;ReadLine.</span><br>
<span class="lineno"></span><span class="keyword" id="2165030">func</span>&nbsp;<span class="op" id="2165035">(</span><span class="ident" id="2165036">b</span>&nbsp;<span class="op" id="2165038">*</span><span class="ident" id="2165039">Reader</span><span class="op" id="2165045">)</span>&nbsp;<span class="ident" id="2165047">ReadLine</span><span class="op" id="2165055">(</span><span class="op" id="2165056">)</span>&nbsp;<span class="op" id="2165058">(</span><span class="ident" id="2165059">line</span>&nbsp;<span class="op" id="2165064">[</span><span class="op" id="2165065">]</span><span class="builtintype" id="2165066">byte</span><span class="op" id="2165070">,</span>&nbsp;<span class="ident" id="2165072">isPrefix</span>&nbsp;<span class="builtintype" id="2165081">bool</span><span class="op" id="2165085">,</span>&nbsp;<span class="ident" id="2165087">err</span>&nbsp;<span class="builtintype" id="2165091">error</span><span class="op" id="2165096">)</span>&nbsp;<span class="op" id="2165098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165101">line</span><span class="op" id="2165105">,</span>&nbsp;<span class="ident" id="2165107">err</span>&nbsp;<span class="op" id="2165111">=</span>&nbsp;<span class="ident" id="2165113">b</span><span class="op" id="2165114">.</span><span class="ident" id="2165115">ReadSlice</span><span class="op" id="2165124">(</span><span class="string" id="2165125">&#39;\n&#39;</span><span class="op" id="2165129">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165132">if</span>&nbsp;<span class="ident" id="2165135">err</span>&nbsp;<span class="op" id="2165139">==</span>&nbsp;<span class="ident" id="2165142">ErrBufferFull</span>&nbsp;<span class="op" id="2165156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2165160">//&nbsp;Handle&nbsp;the&nbsp;case&nbsp;where&nbsp;&#34;\r\n&#34;&nbsp;straddles&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165216">if</span>&nbsp;<span class="builtinfunc" id="2165219">len</span><span class="op" id="2165222">(</span><span class="ident" id="2165223">line</span><span class="op" id="2165227">)</span>&nbsp;<span class="op" id="2165229">&gt;</span>&nbsp;<span class="num" id="2165231">0</span>&nbsp;<span class="op" id="2165233">&amp;&amp;</span>&nbsp;<span class="ident" id="2165236">line</span><span class="op" id="2165240">[</span><span class="builtinfunc" id="2165241">len</span><span class="op" id="2165244">(</span><span class="ident" id="2165245">line</span><span class="op" id="2165249">)</span><span class="op" id="2165250">-</span><span class="num" id="2165251">1</span><span class="op" id="2165252">]</span>&nbsp;<span class="op" id="2165254">==</span>&nbsp;<span class="string" id="2165257">&#39;\r&#39;</span>&nbsp;<span class="op" id="2165262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2165267">//&nbsp;Put&nbsp;the&nbsp;&#39;\r&#39;&nbsp;back&nbsp;on&nbsp;buf&nbsp;and&nbsp;drop&nbsp;it&nbsp;from&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2165321">//&nbsp;Let&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;ReadLine&nbsp;check&nbsp;for&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165375">if</span>&nbsp;<span class="ident" id="2165378">b</span><span class="op" id="2165379">.</span><span class="ident" id="2165380">r</span>&nbsp;<span class="op" id="2165382">==</span>&nbsp;<span class="num" id="2165385">0</span>&nbsp;<span class="op" id="2165387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2165393">//&nbsp;should&nbsp;be&nbsp;unreachable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2165422">panic</span><span class="op" id="2165427">(</span><span class="string" id="2165428">&#34;bufio:&nbsp;tried&nbsp;to&nbsp;rewind&nbsp;past&nbsp;start&nbsp;of&nbsp;buffer&#34;</span><span class="op" id="2165473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165483">b</span><span class="op" id="2165484">.</span><span class="ident" id="2165485">r</span><span class="op" id="2165486">--</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165492">line</span>&nbsp;<span class="op" id="2165497">=</span>&nbsp;<span class="ident" id="2165499">line</span><span class="op" id="2165503">[</span><span class="op" id="2165504">:</span><span class="builtinfunc" id="2165505">len</span><span class="op" id="2165508">(</span><span class="ident" id="2165509">line</span><span class="op" id="2165513">)</span><span class="op" id="2165514">-</span><span class="num" id="2165515">1</span><span class="op" id="2165516">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165524">return</span>&nbsp;<span class="ident" id="2165531">line</span><span class="op" id="2165535">,</span>&nbsp;<span class="builtintype" id="2165537">true</span><span class="op" id="2165541">,</span>&nbsp;<span class="ident" id="2165543">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165552">if</span>&nbsp;<span class="builtinfunc" id="2165555">len</span><span class="op" id="2165558">(</span><span class="ident" id="2165559">line</span><span class="op" id="2165563">)</span>&nbsp;<span class="op" id="2165565">==</span>&nbsp;<span class="num" id="2165568">0</span>&nbsp;<span class="op" id="2165570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165574">if</span>&nbsp;<span class="ident" id="2165577">err</span>&nbsp;<span class="op" id="2165581">!=</span>&nbsp;<span class="ident" id="2165584">nil</span>&nbsp;<span class="op" id="2165588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165593">line</span>&nbsp;<span class="op" id="2165598">=</span>&nbsp;<span class="ident" id="2165600">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165610">return</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165621">err</span>&nbsp;<span class="op" id="2165625">=</span>&nbsp;<span class="ident" id="2165627">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165633">if</span>&nbsp;<span class="ident" id="2165636">line</span><span class="op" id="2165640">[</span><span class="builtinfunc" id="2165641">len</span><span class="op" id="2165644">(</span><span class="ident" id="2165645">line</span><span class="op" id="2165649">)</span><span class="op" id="2165650">-</span><span class="num" id="2165651">1</span><span class="op" id="2165652">]</span>&nbsp;<span class="op" id="2165654">==</span>&nbsp;<span class="string" id="2165657">&#39;\n&#39;</span>&nbsp;<span class="op" id="2165662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165666">drop</span>&nbsp;<span class="op" id="2165671">:=</span>&nbsp;<span class="num" id="2165674">1</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165678">if</span>&nbsp;<span class="builtinfunc" id="2165681">len</span><span class="op" id="2165684">(</span><span class="ident" id="2165685">line</span><span class="op" id="2165689">)</span>&nbsp;<span class="op" id="2165691">&gt;</span>&nbsp;<span class="num" id="2165693">1</span>&nbsp;<span class="op" id="2165695">&amp;&amp;</span>&nbsp;<span class="ident" id="2165698">line</span><span class="op" id="2165702">[</span><span class="builtinfunc" id="2165703">len</span><span class="op" id="2165706">(</span><span class="ident" id="2165707">line</span><span class="op" id="2165711">)</span><span class="op" id="2165712">-</span><span class="num" id="2165713">2</span><span class="op" id="2165714">]</span>&nbsp;<span class="op" id="2165716">==</span>&nbsp;<span class="string" id="2165719">&#39;\r&#39;</span>&nbsp;<span class="op" id="2165724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165729">drop</span>&nbsp;<span class="op" id="2165734">=</span>&nbsp;<span class="num" id="2165736">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2165744">line</span>&nbsp;<span class="op" id="2165749">=</span>&nbsp;<span class="ident" id="2165751">line</span><span class="op" id="2165755">[</span><span class="op" id="2165756">:</span><span class="builtinfunc" id="2165757">len</span><span class="op" id="2165760">(</span><span class="ident" id="2165761">line</span><span class="op" id="2165765">)</span><span class="op" id="2165766">-</span><span class="ident" id="2165767">drop</span><span class="op" id="2165771">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2165774">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2165777">return</span><br>
<span class="lineno"></span><span class="op" id="2165784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2165787">//&nbsp;ReadBytes&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2165856">//&nbsp;returning&nbsp;a&nbsp;slice&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno">360</span><span class="comment" id="2165932">//&nbsp;If&nbsp;ReadBytes&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2165996">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno"></span><span class="comment" id="2166078">//&nbsp;ReadBytes&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2166159">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2166169">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno">365</span><span class="keyword" id="2166223">func</span>&nbsp;<span class="op" id="2166228">(</span><span class="ident" id="2166229">b</span>&nbsp;<span class="op" id="2166231">*</span><span class="ident" id="2166232">Reader</span><span class="op" id="2166238">)</span>&nbsp;<span class="ident" id="2166240">ReadBytes</span><span class="op" id="2166249">(</span><span class="ident" id="2166250">delim</span>&nbsp;<span class="builtintype" id="2166256">byte</span><span class="op" id="2166260">)</span>&nbsp;<span class="op" id="2166262">(</span><span class="ident" id="2166263">line</span>&nbsp;<span class="op" id="2166268">[</span><span class="op" id="2166269">]</span><span class="builtintype" id="2166270">byte</span><span class="op" id="2166274">,</span>&nbsp;<span class="ident" id="2166276">err</span>&nbsp;<span class="builtintype" id="2166280">error</span><span class="op" id="2166285">)</span>&nbsp;<span class="op" id="2166287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2166290">//&nbsp;Use&nbsp;ReadSlice&nbsp;to&nbsp;look&nbsp;for&nbsp;array,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2166327">//&nbsp;accumulating&nbsp;full&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166358">var</span>&nbsp;<span class="ident" id="2166362">frag</span>&nbsp;<span class="op" id="2166367">[</span><span class="op" id="2166368">]</span><span class="builtintype" id="2166369">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166375">var</span>&nbsp;<span class="ident" id="2166379">full</span>&nbsp;<span class="op" id="2166384">[</span><span class="op" id="2166385">]</span><span class="op" id="2166386">[</span><span class="op" id="2166387">]</span><span class="builtintype" id="2166388">byte</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166394">err</span>&nbsp;<span class="op" id="2166398">=</span>&nbsp;<span class="ident" id="2166400">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166406">for</span>&nbsp;<span class="op" id="2166410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166414">var</span>&nbsp;<span class="ident" id="2166418">e</span>&nbsp;<span class="builtintype" id="2166420">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166428">frag</span><span class="op" id="2166432">,</span>&nbsp;<span class="ident" id="2166434">e</span>&nbsp;<span class="op" id="2166436">=</span>&nbsp;<span class="ident" id="2166438">b</span><span class="op" id="2166439">.</span><span class="ident" id="2166440">ReadSlice</span><span class="op" id="2166449">(</span><span class="ident" id="2166450">delim</span><span class="op" id="2166455">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166459">if</span>&nbsp;<span class="ident" id="2166462">e</span>&nbsp;<span class="op" id="2166464">==</span>&nbsp;<span class="ident" id="2166467">nil</span>&nbsp;<span class="op" id="2166471">{</span>&nbsp;<span class="comment" id="2166473">//&nbsp;got&nbsp;final&nbsp;fragment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166498">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2166506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166510">if</span>&nbsp;<span class="ident" id="2166513">e</span>&nbsp;<span class="op" id="2166515">!=</span>&nbsp;<span class="ident" id="2166518">ErrBufferFull</span>&nbsp;<span class="op" id="2166532">{</span>&nbsp;<span class="comment" id="2166534">//&nbsp;unexpected&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166557">err</span>&nbsp;<span class="op" id="2166561">=</span>&nbsp;<span class="ident" id="2166563">e</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166568">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2166576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2166581">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166613">buf</span>&nbsp;<span class="op" id="2166617">:=</span>&nbsp;<span class="builtinfunc" id="2166620">make</span><span class="op" id="2166624">(</span><span class="op" id="2166625">[</span><span class="op" id="2166626">]</span><span class="builtintype" id="2166627">byte</span><span class="op" id="2166631">,</span>&nbsp;<span class="builtinfunc" id="2166633">len</span><span class="op" id="2166636">(</span><span class="ident" id="2166637">frag</span><span class="op" id="2166641">)</span><span class="op" id="2166642">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2166646">copy</span><span class="op" id="2166650">(</span><span class="ident" id="2166651">buf</span><span class="op" id="2166654">,</span>&nbsp;<span class="ident" id="2166656">frag</span><span class="op" id="2166660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166664">full</span>&nbsp;<span class="op" id="2166669">=</span>&nbsp;<span class="builtinfunc" id="2166671">append</span><span class="op" id="2166677">(</span><span class="ident" id="2166678">full</span><span class="op" id="2166682">,</span>&nbsp;<span class="ident" id="2166684">buf</span><span class="op" id="2166687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2166690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2166694">//&nbsp;Allocate&nbsp;new&nbsp;buffer&nbsp;to&nbsp;hold&nbsp;the&nbsp;full&nbsp;pieces&nbsp;and&nbsp;the&nbsp;fragment.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166760">n</span>&nbsp;<span class="op" id="2166762">:=</span>&nbsp;<span class="num" id="2166765">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166768">for</span>&nbsp;<span class="ident" id="2166772">i</span>&nbsp;<span class="op" id="2166774">:=</span>&nbsp;<span class="keyword" id="2166777">range</span>&nbsp;<span class="ident" id="2166783">full</span>&nbsp;<span class="op" id="2166788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166792">n</span>&nbsp;<span class="op" id="2166794">+=</span>&nbsp;<span class="builtinfunc" id="2166797">len</span><span class="op" id="2166800">(</span><span class="ident" id="2166801">full</span><span class="op" id="2166805">[</span><span class="ident" id="2166806">i</span><span class="op" id="2166807">]</span><span class="op" id="2166808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2166811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166814">n</span>&nbsp;<span class="op" id="2166816">+=</span>&nbsp;<span class="builtinfunc" id="2166819">len</span><span class="op" id="2166822">(</span><span class="ident" id="2166823">frag</span><span class="op" id="2166827">)</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2166831">//&nbsp;Copy&nbsp;full&nbsp;pieces&nbsp;and&nbsp;fragment&nbsp;in.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166869">buf</span>&nbsp;<span class="op" id="2166873">:=</span>&nbsp;<span class="builtinfunc" id="2166876">make</span><span class="op" id="2166880">(</span><span class="op" id="2166881">[</span><span class="op" id="2166882">]</span><span class="builtintype" id="2166883">byte</span><span class="op" id="2166887">,</span>&nbsp;<span class="ident" id="2166889">n</span><span class="op" id="2166890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166893">n</span>&nbsp;<span class="op" id="2166895">=</span>&nbsp;<span class="num" id="2166897">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166900">for</span>&nbsp;<span class="ident" id="2166904">i</span>&nbsp;<span class="op" id="2166906">:=</span>&nbsp;<span class="keyword" id="2166909">range</span>&nbsp;<span class="ident" id="2166915">full</span>&nbsp;<span class="op" id="2166920">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2166924">n</span>&nbsp;<span class="op" id="2166926">+=</span>&nbsp;<span class="builtinfunc" id="2166929">copy</span><span class="op" id="2166933">(</span><span class="ident" id="2166934">buf</span><span class="op" id="2166937">[</span><span class="ident" id="2166938">n</span><span class="op" id="2166939">:</span><span class="op" id="2166940">]</span><span class="op" id="2166941">,</span>&nbsp;<span class="ident" id="2166943">full</span><span class="op" id="2166947">[</span><span class="ident" id="2166948">i</span><span class="op" id="2166949">]</span><span class="op" id="2166950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2166953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2166956">copy</span><span class="op" id="2166960">(</span><span class="ident" id="2166961">buf</span><span class="op" id="2166964">[</span><span class="ident" id="2166965">n</span><span class="op" id="2166966">:</span><span class="op" id="2166967">]</span><span class="op" id="2166968">,</span>&nbsp;<span class="ident" id="2166970">frag</span><span class="op" id="2166974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2166977">return</span>&nbsp;<span class="ident" id="2166984">buf</span><span class="op" id="2166987">,</span>&nbsp;<span class="ident" id="2166989">err</span><br>
<span class="lineno"></span><span class="op" id="2166993">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="comment" id="2166996">//&nbsp;ReadString&nbsp;reads&nbsp;until&nbsp;the&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;delim&nbsp;in&nbsp;the&nbsp;input,</span><br>
<span class="lineno"></span><span class="comment" id="2167066">//&nbsp;returning&nbsp;a&nbsp;string&nbsp;containing&nbsp;the&nbsp;data&nbsp;up&nbsp;to&nbsp;and&nbsp;including&nbsp;the&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="2167143">//&nbsp;If&nbsp;ReadString&nbsp;encounters&nbsp;an&nbsp;error&nbsp;before&nbsp;finding&nbsp;a&nbsp;delimiter,</span><br>
<span class="lineno"></span><span class="comment" id="2167208">//&nbsp;it&nbsp;returns&nbsp;the&nbsp;data&nbsp;read&nbsp;before&nbsp;the&nbsp;error&nbsp;and&nbsp;the&nbsp;error&nbsp;itself&nbsp;(often&nbsp;io.EOF).</span><br>
<span class="lineno">410</span><span class="comment" id="2167290">//&nbsp;ReadString&nbsp;returns&nbsp;err&nbsp;!=&nbsp;nil&nbsp;if&nbsp;and&nbsp;only&nbsp;if&nbsp;the&nbsp;returned&nbsp;data&nbsp;does&nbsp;not&nbsp;end&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="2167372">//&nbsp;delim.</span><br>
<span class="lineno"></span><span class="comment" id="2167382">//&nbsp;For&nbsp;simple&nbsp;uses,&nbsp;a&nbsp;Scanner&nbsp;may&nbsp;be&nbsp;more&nbsp;convenient.</span><br>
<span class="lineno"></span><span class="keyword" id="2167436">func</span>&nbsp;<span class="op" id="2167441">(</span><span class="ident" id="2167442">b</span>&nbsp;<span class="op" id="2167444">*</span><span class="ident" id="2167445">Reader</span><span class="op" id="2167451">)</span>&nbsp;<span class="ident" id="2167453">ReadString</span><span class="op" id="2167463">(</span><span class="ident" id="2167464">delim</span>&nbsp;<span class="builtintype" id="2167470">byte</span><span class="op" id="2167474">)</span>&nbsp;<span class="op" id="2167476">(</span><span class="ident" id="2167477">line</span>&nbsp;<span class="builtintype" id="2167482">string</span><span class="op" id="2167488">,</span>&nbsp;<span class="ident" id="2167490">err</span>&nbsp;<span class="builtintype" id="2167494">error</span><span class="op" id="2167499">)</span>&nbsp;<span class="op" id="2167501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167504">bytes</span><span class="op" id="2167509">,</span>&nbsp;<span class="ident" id="2167511">err</span>&nbsp;<span class="op" id="2167515">:=</span>&nbsp;<span class="ident" id="2167518">b</span><span class="op" id="2167519">.</span><span class="ident" id="2167520">ReadBytes</span><span class="op" id="2167529">(</span><span class="ident" id="2167530">delim</span><span class="op" id="2167535">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167538">line</span>&nbsp;<span class="op" id="2167543">=</span>&nbsp;<span class="builtintype" id="2167545">string</span><span class="op" id="2167551">(</span><span class="ident" id="2167552">bytes</span><span class="op" id="2167557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167560">return</span>&nbsp;<span class="ident" id="2167567">line</span><span class="op" id="2167571">,</span>&nbsp;<span class="ident" id="2167573">err</span><br>
<span class="lineno"></span><span class="op" id="2167577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2167580">//&nbsp;WriteTo&nbsp;implements&nbsp;io.WriterTo.</span><br>
<span class="lineno">420</span><span class="keyword" id="2167615">func</span>&nbsp;<span class="op" id="2167620">(</span><span class="ident" id="2167621">b</span>&nbsp;<span class="op" id="2167623">*</span><span class="ident" id="2167624">Reader</span><span class="op" id="2167630">)</span>&nbsp;<span class="ident" id="2167632">WriteTo</span><span class="op" id="2167639">(</span><span class="ident" id="2167640">w</span>&nbsp;<span class="ident" id="2167642">io</span><span class="op" id="2167644">.</span><span class="ident" id="2167645">Writer</span><span class="op" id="2167651">)</span>&nbsp;<span class="op" id="2167653">(</span><span class="ident" id="2167654">n</span>&nbsp;<span class="ident" id="2167656">int64</span><span class="op" id="2167661">,</span>&nbsp;<span class="ident" id="2167663">err</span>&nbsp;<span class="builtintype" id="2167667">error</span><span class="op" id="2167672">)</span>&nbsp;<span class="op" id="2167674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167677">n</span><span class="op" id="2167678">,</span>&nbsp;<span class="ident" id="2167680">err</span>&nbsp;<span class="op" id="2167684">=</span>&nbsp;<span class="ident" id="2167686">b</span><span class="op" id="2167687">.</span><span class="ident" id="2167688">writeBuf</span><span class="op" id="2167696">(</span><span class="ident" id="2167697">w</span><span class="op" id="2167698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167701">if</span>&nbsp;<span class="ident" id="2167704">err</span>&nbsp;<span class="op" id="2167708">!=</span>&nbsp;<span class="ident" id="2167711">nil</span>&nbsp;<span class="op" id="2167715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167719">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2167727">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167731">if</span>&nbsp;<span class="ident" id="2167734">r</span><span class="op" id="2167735">,</span>&nbsp;<span class="ident" id="2167737">ok</span>&nbsp;<span class="op" id="2167740">:=</span>&nbsp;<span class="ident" id="2167743">b</span><span class="op" id="2167744">.</span><span class="ident" id="2167745">rd</span><span class="op" id="2167747">.</span><span class="op" id="2167748">(</span><span class="ident" id="2167749">io</span><span class="op" id="2167751">.</span><span class="ident" id="2167752">WriterTo</span><span class="op" id="2167760">)</span><span class="op" id="2167761">;</span>&nbsp;<span class="ident" id="2167763">ok</span>&nbsp;<span class="op" id="2167766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167770">m</span><span class="op" id="2167771">,</span>&nbsp;<span class="ident" id="2167773">err</span>&nbsp;<span class="op" id="2167777">:=</span>&nbsp;<span class="ident" id="2167780">r</span><span class="op" id="2167781">.</span><span class="ident" id="2167782">WriteTo</span><span class="op" id="2167789">(</span><span class="ident" id="2167790">w</span><span class="op" id="2167791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167795">n</span>&nbsp;<span class="op" id="2167797">+=</span>&nbsp;<span class="ident" id="2167800">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167804">return</span>&nbsp;<span class="ident" id="2167811">n</span><span class="op" id="2167812">,</span>&nbsp;<span class="ident" id="2167814">err</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2167819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167823">if</span>&nbsp;<span class="ident" id="2167826">w</span><span class="op" id="2167827">,</span>&nbsp;<span class="ident" id="2167829">ok</span>&nbsp;<span class="op" id="2167832">:=</span>&nbsp;<span class="ident" id="2167835">w</span><span class="op" id="2167836">.</span><span class="op" id="2167837">(</span><span class="ident" id="2167838">io</span><span class="op" id="2167840">.</span><span class="ident" id="2167841">ReaderFrom</span><span class="op" id="2167851">)</span><span class="op" id="2167852">;</span>&nbsp;<span class="ident" id="2167854">ok</span>&nbsp;<span class="op" id="2167857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167861">m</span><span class="op" id="2167862">,</span>&nbsp;<span class="ident" id="2167864">err</span>&nbsp;<span class="op" id="2167868">:=</span>&nbsp;<span class="ident" id="2167871">w</span><span class="op" id="2167872">.</span><span class="ident" id="2167873">ReadFrom</span><span class="op" id="2167881">(</span><span class="ident" id="2167882">b</span><span class="op" id="2167883">.</span><span class="ident" id="2167884">rd</span><span class="op" id="2167886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167890">n</span>&nbsp;<span class="op" id="2167892">+=</span>&nbsp;<span class="ident" id="2167895">m</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167899">return</span>&nbsp;<span class="ident" id="2167906">n</span><span class="op" id="2167907">,</span>&nbsp;<span class="ident" id="2167909">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2167914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167918">if</span>&nbsp;<span class="ident" id="2167921">b</span><span class="op" id="2167922">.</span><span class="ident" id="2167923">w</span><span class="op" id="2167924">-</span><span class="ident" id="2167925">b</span><span class="op" id="2167926">.</span><span class="ident" id="2167927">r</span>&nbsp;<span class="op" id="2167929">&lt;</span>&nbsp;<span class="builtinfunc" id="2167931">len</span><span class="op" id="2167934">(</span><span class="ident" id="2167935">b</span><span class="op" id="2167936">.</span><span class="ident" id="2167937">buf</span><span class="op" id="2167940">)</span>&nbsp;<span class="op" id="2167942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2167946">b</span><span class="op" id="2167947">.</span><span class="ident" id="2167948">fill</span><span class="op" id="2167952">(</span><span class="op" id="2167953">)</span>&nbsp;<span class="comment" id="2167955">//&nbsp;buffer&nbsp;not&nbsp;full</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2167975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2167979">for</span>&nbsp;<span class="ident" id="2167983">b</span><span class="op" id="2167984">.</span><span class="ident" id="2167985">r</span>&nbsp;<span class="op" id="2167987">&lt;</span>&nbsp;<span class="ident" id="2167989">b</span><span class="op" id="2167990">.</span><span class="ident" id="2167991">w</span>&nbsp;<span class="op" id="2167993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2167997">//&nbsp;b.r&nbsp;&lt;&nbsp;b.w&nbsp;=&gt;&nbsp;buffer&nbsp;is&nbsp;not&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168035">m</span><span class="op" id="2168036">,</span>&nbsp;<span class="ident" id="2168038">err</span>&nbsp;<span class="op" id="2168042">:=</span>&nbsp;<span class="ident" id="2168045">b</span><span class="op" id="2168046">.</span><span class="ident" id="2168047">writeBuf</span><span class="op" id="2168055">(</span><span class="ident" id="2168056">w</span><span class="op" id="2168057">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168061">n</span>&nbsp;<span class="op" id="2168063">+=</span>&nbsp;<span class="ident" id="2168066">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168070">if</span>&nbsp;<span class="ident" id="2168073">err</span>&nbsp;<span class="op" id="2168077">!=</span>&nbsp;<span class="ident" id="2168080">nil</span>&nbsp;<span class="op" id="2168084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168089">return</span>&nbsp;<span class="ident" id="2168096">n</span><span class="op" id="2168097">,</span>&nbsp;<span class="ident" id="2168099">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2168105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168109">b</span><span class="op" id="2168110">.</span><span class="ident" id="2168111">fill</span><span class="op" id="2168115">(</span><span class="op" id="2168116">)</span>&nbsp;<span class="comment" id="2168118">//&nbsp;buffer&nbsp;is&nbsp;empty</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2168138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168142">if</span>&nbsp;<span class="ident" id="2168145">b</span><span class="op" id="2168146">.</span><span class="ident" id="2168147">err</span>&nbsp;<span class="op" id="2168151">==</span>&nbsp;<span class="ident" id="2168154">io</span><span class="op" id="2168156">.</span><span class="ident" id="2168157">EOF</span>&nbsp;<span class="op" id="2168161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168165">b</span><span class="op" id="2168166">.</span><span class="ident" id="2168167">err</span>&nbsp;<span class="op" id="2168171">=</span>&nbsp;<span class="ident" id="2168173">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2168178">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168182">return</span>&nbsp;<span class="ident" id="2168189">n</span><span class="op" id="2168190">,</span>&nbsp;<span class="ident" id="2168192">b</span><span class="op" id="2168193">.</span><span class="ident" id="2168194">readErr</span><span class="op" id="2168201">(</span><span class="op" id="2168202">)</span><br>
<span class="lineno"></span><span class="op" id="2168204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2168207">var</span>&nbsp;<span class="ident" id="2168211">errNegativeWrite</span>&nbsp;<span class="op" id="2168228">=</span>&nbsp;<span class="ident" id="2168230">errors</span><span class="op" id="2168236">.</span><span class="ident" id="2168237">New</span><span class="op" id="2168240">(</span><span class="string" id="2168241">&#34;bufio:&nbsp;writer&nbsp;returned&nbsp;negative&nbsp;count&nbsp;from&nbsp;Write&#34;</span><span class="op" id="2168291">)</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="comment" id="2168294">//&nbsp;writeBuf&nbsp;writes&nbsp;the&nbsp;Reader&#39;s&nbsp;buffer&nbsp;to&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2168348">func</span>&nbsp;<span class="op" id="2168353">(</span><span class="ident" id="2168354">b</span>&nbsp;<span class="op" id="2168356">*</span><span class="ident" id="2168357">Reader</span><span class="op" id="2168363">)</span>&nbsp;<span class="ident" id="2168365">writeBuf</span><span class="op" id="2168373">(</span><span class="ident" id="2168374">w</span>&nbsp;<span class="ident" id="2168376">io</span><span class="op" id="2168378">.</span><span class="ident" id="2168379">Writer</span><span class="op" id="2168385">)</span>&nbsp;<span class="op" id="2168387">(</span><span class="ident" id="2168388">int64</span><span class="op" id="2168393">,</span>&nbsp;<span class="builtintype" id="2168395">error</span><span class="op" id="2168400">)</span>&nbsp;<span class="op" id="2168402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168405">n</span><span class="op" id="2168406">,</span>&nbsp;<span class="ident" id="2168408">err</span>&nbsp;<span class="op" id="2168412">:=</span>&nbsp;<span class="ident" id="2168415">w</span><span class="op" id="2168416">.</span><span class="ident" id="2168417">Write</span><span class="op" id="2168422">(</span><span class="ident" id="2168423">b</span><span class="op" id="2168424">.</span><span class="ident" id="2168425">buf</span><span class="op" id="2168428">[</span><span class="ident" id="2168429">b</span><span class="op" id="2168430">.</span><span class="ident" id="2168431">r</span><span class="op" id="2168432">:</span><span class="ident" id="2168433">b</span><span class="op" id="2168434">.</span><span class="ident" id="2168435">w</span><span class="op" id="2168436">]</span><span class="op" id="2168437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168440">if</span>&nbsp;<span class="ident" id="2168443">n</span>&nbsp;<span class="op" id="2168445">&lt;</span>&nbsp;<span class="num" id="2168447">0</span>&nbsp;<span class="op" id="2168449">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2168453">panic</span><span class="op" id="2168458">(</span><span class="ident" id="2168459">errNegativeWrite</span><span class="op" id="2168475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2168478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168481">b</span><span class="op" id="2168482">.</span><span class="ident" id="2168483">r</span>&nbsp;<span class="op" id="2168485">+=</span>&nbsp;<span class="ident" id="2168488">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2168491">return</span>&nbsp;<span class="ident" id="2168498">int64</span><span class="op" id="2168503">(</span><span class="ident" id="2168504">n</span><span class="op" id="2168505">)</span><span class="op" id="2168506">,</span>&nbsp;<span class="ident" id="2168508">err</span><br>
<span class="lineno"></span><span class="op" id="2168512">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span><span class="comment" id="2168515">//&nbsp;buffered&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2168535">//&nbsp;Writer&nbsp;implements&nbsp;buffering&nbsp;for&nbsp;an&nbsp;io.Writer&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="2168591">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;writing&nbsp;to&nbsp;a&nbsp;Writer,&nbsp;no&nbsp;more&nbsp;data&nbsp;will&nbsp;be</span><br>
<span class="lineno">475</span><span class="comment" id="2168655">//&nbsp;accepted&nbsp;and&nbsp;all&nbsp;subsequent&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="2168716">//&nbsp;After&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;written,&nbsp;the&nbsp;client&nbsp;should&nbsp;call&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2168779">//&nbsp;Flush&nbsp;method&nbsp;to&nbsp;guarantee&nbsp;all&nbsp;data&nbsp;has&nbsp;been&nbsp;forwarded&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2168839">//&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2168868">type</span>&nbsp;<span class="ident" id="2168873">Writer</span>&nbsp;<span class="keyword" id="2168880">struct</span>&nbsp;<span class="op" id="2168887">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168890">err</span>&nbsp;<span class="builtintype" id="2168894">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168901">buf</span>&nbsp;<span class="op" id="2168905">[</span><span class="op" id="2168906">]</span><span class="builtintype" id="2168907">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168913">n</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2168917">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2168922">wr</span>&nbsp;&nbsp;<span class="ident" id="2168926">io</span><span class="op" id="2168928">.</span><span class="ident" id="2168929">Writer</span><br>
<span class="lineno"></span><span class="op" id="2168936">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="2168939">//&nbsp;NewWriterSize&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;at&nbsp;least&nbsp;the&nbsp;specified</span><br>
<span class="lineno"></span><span class="comment" id="2169017">//&nbsp;size.&nbsp;If&nbsp;the&nbsp;argument&nbsp;io.Writer&nbsp;is&nbsp;already&nbsp;a&nbsp;Writer&nbsp;with&nbsp;large&nbsp;enough</span><br>
<span class="lineno"></span><span class="comment" id="2169090">//&nbsp;size,&nbsp;it&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2169133">func</span>&nbsp;<span class="ident" id="2169138">NewWriterSize</span><span class="op" id="2169151">(</span><span class="ident" id="2169152">w</span>&nbsp;<span class="ident" id="2169154">io</span><span class="op" id="2169156">.</span><span class="ident" id="2169157">Writer</span><span class="op" id="2169163">,</span>&nbsp;<span class="ident" id="2169165">size</span>&nbsp;<span class="builtintype" id="2169170">int</span><span class="op" id="2169173">)</span>&nbsp;<span class="op" id="2169175">*</span><span class="ident" id="2169176">Writer</span>&nbsp;<span class="op" id="2169183">{</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2169186">//&nbsp;Is&nbsp;it&nbsp;already&nbsp;a&nbsp;Writer?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169214">b</span><span class="op" id="2169215">,</span>&nbsp;<span class="ident" id="2169217">ok</span>&nbsp;<span class="op" id="2169220">:=</span>&nbsp;<span class="ident" id="2169223">w</span><span class="op" id="2169224">.</span><span class="op" id="2169225">(</span><span class="op" id="2169226">*</span><span class="ident" id="2169227">Writer</span><span class="op" id="2169233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169236">if</span>&nbsp;<span class="ident" id="2169239">ok</span>&nbsp;<span class="op" id="2169242">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="2169245">len</span><span class="op" id="2169248">(</span><span class="ident" id="2169249">b</span><span class="op" id="2169250">.</span><span class="ident" id="2169251">buf</span><span class="op" id="2169254">)</span>&nbsp;<span class="op" id="2169256">&gt;=</span>&nbsp;<span class="ident" id="2169259">size</span>&nbsp;<span class="op" id="2169264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169268">return</span>&nbsp;<span class="ident" id="2169275">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2169278">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169281">if</span>&nbsp;<span class="ident" id="2169284">size</span>&nbsp;<span class="op" id="2169289">&lt;=</span>&nbsp;<span class="num" id="2169292">0</span>&nbsp;<span class="op" id="2169294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169298">size</span>&nbsp;<span class="op" id="2169303">=</span>&nbsp;<span class="ident" id="2169305">defaultBufSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2169321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169324">return</span>&nbsp;<span class="op" id="2169331">&amp;</span><span class="ident" id="2169332">Writer</span><span class="op" id="2169338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169342">buf</span><span class="op" id="2169345">:</span>&nbsp;<span class="builtinfunc" id="2169347">make</span><span class="op" id="2169351">(</span><span class="op" id="2169352">[</span><span class="op" id="2169353">]</span><span class="builtintype" id="2169354">byte</span><span class="op" id="2169358">,</span>&nbsp;<span class="ident" id="2169360">size</span><span class="op" id="2169364">)</span><span class="op" id="2169365">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169369">wr</span><span class="op" id="2169371">:</span>&nbsp;&nbsp;<span class="ident" id="2169374">w</span><span class="op" id="2169375">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2169378">}</span><br>
<span class="lineno"></span><span class="op" id="2169380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2169383">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;whose&nbsp;buffer&nbsp;has&nbsp;the&nbsp;default&nbsp;size.</span><br>
<span class="lineno">505</span><span class="keyword" id="2169452">func</span>&nbsp;<span class="ident" id="2169457">NewWriter</span><span class="op" id="2169466">(</span><span class="ident" id="2169467">w</span>&nbsp;<span class="ident" id="2169469">io</span><span class="op" id="2169471">.</span><span class="ident" id="2169472">Writer</span><span class="op" id="2169478">)</span>&nbsp;<span class="op" id="2169480">*</span><span class="ident" id="2169481">Writer</span>&nbsp;<span class="op" id="2169488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169491">return</span>&nbsp;<span class="ident" id="2169498">NewWriterSize</span><span class="op" id="2169511">(</span><span class="ident" id="2169512">w</span><span class="op" id="2169513">,</span>&nbsp;<span class="ident" id="2169515">defaultBufSize</span><span class="op" id="2169529">)</span><br>
<span class="lineno"></span><span class="op" id="2169531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2169534">//&nbsp;Reset&nbsp;discards&nbsp;any&nbsp;unflushed&nbsp;buffered&nbsp;data,&nbsp;clears&nbsp;any&nbsp;error,&nbsp;and</span><br>
<span class="lineno">510</span><span class="comment" id="2169603">//&nbsp;resets&nbsp;b&nbsp;to&nbsp;write&nbsp;its&nbsp;output&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="2169641">func</span>&nbsp;<span class="op" id="2169646">(</span><span class="ident" id="2169647">b</span>&nbsp;<span class="op" id="2169649">*</span><span class="ident" id="2169650">Writer</span><span class="op" id="2169656">)</span>&nbsp;<span class="ident" id="2169658">Reset</span><span class="op" id="2169663">(</span><span class="ident" id="2169664">w</span>&nbsp;<span class="ident" id="2169666">io</span><span class="op" id="2169668">.</span><span class="ident" id="2169669">Writer</span><span class="op" id="2169675">)</span>&nbsp;<span class="op" id="2169677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169680">b</span><span class="op" id="2169681">.</span><span class="ident" id="2169682">err</span>&nbsp;<span class="op" id="2169686">=</span>&nbsp;<span class="ident" id="2169688">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169693">b</span><span class="op" id="2169694">.</span><span class="ident" id="2169695">n</span>&nbsp;<span class="op" id="2169697">=</span>&nbsp;<span class="num" id="2169699">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169702">b</span><span class="op" id="2169703">.</span><span class="ident" id="2169704">wr</span>&nbsp;<span class="op" id="2169707">=</span>&nbsp;<span class="ident" id="2169709">w</span><br>
<span class="lineno">515</span><span class="op" id="2169711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2169714">//&nbsp;Flush&nbsp;writes&nbsp;any&nbsp;buffered&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2169777">func</span>&nbsp;<span class="op" id="2169782">(</span><span class="ident" id="2169783">b</span>&nbsp;<span class="op" id="2169785">*</span><span class="ident" id="2169786">Writer</span><span class="op" id="2169792">)</span>&nbsp;<span class="ident" id="2169794">Flush</span><span class="op" id="2169799">(</span><span class="op" id="2169800">)</span>&nbsp;<span class="builtintype" id="2169802">error</span>&nbsp;<span class="op" id="2169808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169811">err</span>&nbsp;<span class="op" id="2169815">:=</span>&nbsp;<span class="ident" id="2169818">b</span><span class="op" id="2169819">.</span><span class="ident" id="2169820">flush</span><span class="op" id="2169825">(</span><span class="op" id="2169826">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169829">return</span>&nbsp;<span class="ident" id="2169836">err</span><br>
<span class="lineno"></span><span class="op" id="2169840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2169843">func</span>&nbsp;<span class="op" id="2169848">(</span><span class="ident" id="2169849">b</span>&nbsp;<span class="op" id="2169851">*</span><span class="ident" id="2169852">Writer</span><span class="op" id="2169858">)</span>&nbsp;<span class="ident" id="2169860">flush</span><span class="op" id="2169865">(</span><span class="op" id="2169866">)</span>&nbsp;<span class="builtintype" id="2169868">error</span>&nbsp;<span class="op" id="2169874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169877">if</span>&nbsp;<span class="ident" id="2169880">b</span><span class="op" id="2169881">.</span><span class="ident" id="2169882">err</span>&nbsp;<span class="op" id="2169886">!=</span>&nbsp;<span class="ident" id="2169889">nil</span>&nbsp;<span class="op" id="2169893">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169897">return</span>&nbsp;<span class="ident" id="2169904">b</span><span class="op" id="2169905">.</span><span class="ident" id="2169906">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2169911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169914">if</span>&nbsp;<span class="ident" id="2169917">b</span><span class="op" id="2169918">.</span><span class="ident" id="2169919">n</span>&nbsp;<span class="op" id="2169921">==</span>&nbsp;<span class="num" id="2169924">0</span>&nbsp;<span class="op" id="2169926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169930">return</span>&nbsp;<span class="ident" id="2169937">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2169942">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2169945">n</span><span class="op" id="2169946">,</span>&nbsp;<span class="ident" id="2169948">err</span>&nbsp;<span class="op" id="2169952">:=</span>&nbsp;<span class="ident" id="2169955">b</span><span class="op" id="2169956">.</span><span class="ident" id="2169957">wr</span><span class="op" id="2169959">.</span><span class="ident" id="2169960">Write</span><span class="op" id="2169965">(</span><span class="ident" id="2169966">b</span><span class="op" id="2169967">.</span><span class="ident" id="2169968">buf</span><span class="op" id="2169971">[</span><span class="num" id="2169972">0</span><span class="op" id="2169973">:</span><span class="ident" id="2169974">b</span><span class="op" id="2169975">.</span><span class="ident" id="2169976">n</span><span class="op" id="2169977">]</span><span class="op" id="2169978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2169981">if</span>&nbsp;<span class="ident" id="2169984">n</span>&nbsp;<span class="op" id="2169986">&lt;</span>&nbsp;<span class="ident" id="2169988">b</span><span class="op" id="2169989">.</span><span class="ident" id="2169990">n</span>&nbsp;<span class="op" id="2169992">&amp;&amp;</span>&nbsp;<span class="ident" id="2169995">err</span>&nbsp;<span class="op" id="2169999">==</span>&nbsp;<span class="ident" id="2170002">nil</span>&nbsp;<span class="op" id="2170006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170010">err</span>&nbsp;<span class="op" id="2170014">=</span>&nbsp;<span class="ident" id="2170016">io</span><span class="op" id="2170018">.</span><span class="ident" id="2170019">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170037">if</span>&nbsp;<span class="ident" id="2170040">err</span>&nbsp;<span class="op" id="2170044">!=</span>&nbsp;<span class="ident" id="2170047">nil</span>&nbsp;<span class="op" id="2170051">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170055">if</span>&nbsp;<span class="ident" id="2170058">n</span>&nbsp;<span class="op" id="2170060">&gt;</span>&nbsp;<span class="num" id="2170062">0</span>&nbsp;<span class="op" id="2170064">&amp;&amp;</span>&nbsp;<span class="ident" id="2170067">n</span>&nbsp;<span class="op" id="2170069">&lt;</span>&nbsp;<span class="ident" id="2170071">b</span><span class="op" id="2170072">.</span><span class="ident" id="2170073">n</span>&nbsp;<span class="op" id="2170075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="2170080">copy</span><span class="op" id="2170084">(</span><span class="ident" id="2170085">b</span><span class="op" id="2170086">.</span><span class="ident" id="2170087">buf</span><span class="op" id="2170090">[</span><span class="num" id="2170091">0</span><span class="op" id="2170092">:</span><span class="ident" id="2170093">b</span><span class="op" id="2170094">.</span><span class="ident" id="2170095">n</span><span class="op" id="2170096">-</span><span class="ident" id="2170097">n</span><span class="op" id="2170098">]</span><span class="op" id="2170099">,</span>&nbsp;<span class="ident" id="2170101">b</span><span class="op" id="2170102">.</span><span class="ident" id="2170103">buf</span><span class="op" id="2170106">[</span><span class="ident" id="2170107">n</span><span class="op" id="2170108">:</span><span class="ident" id="2170109">b</span><span class="op" id="2170110">.</span><span class="ident" id="2170111">n</span><span class="op" id="2170112">]</span><span class="op" id="2170113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170121">b</span><span class="op" id="2170122">.</span><span class="ident" id="2170123">n</span>&nbsp;<span class="op" id="2170125">-=</span>&nbsp;<span class="ident" id="2170128">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170132">b</span><span class="op" id="2170133">.</span><span class="ident" id="2170134">err</span>&nbsp;<span class="op" id="2170138">=</span>&nbsp;<span class="ident" id="2170140">err</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170146">return</span>&nbsp;<span class="ident" id="2170153">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170161">b</span><span class="op" id="2170162">.</span><span class="ident" id="2170163">n</span>&nbsp;<span class="op" id="2170165">=</span>&nbsp;<span class="num" id="2170167">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170170">return</span>&nbsp;<span class="ident" id="2170177">nil</span><br>
<span class="lineno"></span><span class="op" id="2170181">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="2170184">//&nbsp;Available&nbsp;returns&nbsp;how&nbsp;many&nbsp;bytes&nbsp;are&nbsp;unused&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="2170246">func</span>&nbsp;<span class="op" id="2170251">(</span><span class="ident" id="2170252">b</span>&nbsp;<span class="op" id="2170254">*</span><span class="ident" id="2170255">Writer</span><span class="op" id="2170261">)</span>&nbsp;<span class="ident" id="2170263">Available</span><span class="op" id="2170272">(</span><span class="op" id="2170273">)</span>&nbsp;<span class="builtintype" id="2170275">int</span>&nbsp;<span class="op" id="2170279">{</span>&nbsp;<span class="keyword" id="2170281">return</span>&nbsp;<span class="builtinfunc" id="2170288">len</span><span class="op" id="2170291">(</span><span class="ident" id="2170292">b</span><span class="op" id="2170293">.</span><span class="ident" id="2170294">buf</span><span class="op" id="2170297">)</span>&nbsp;<span class="op" id="2170299">-</span>&nbsp;<span class="ident" id="2170301">b</span><span class="op" id="2170302">.</span><span class="ident" id="2170303">n</span>&nbsp;<span class="op" id="2170305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2170308">//&nbsp;Buffered&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;that&nbsp;have&nbsp;been&nbsp;written&nbsp;into&nbsp;the&nbsp;current&nbsp;buffer.</span><br>
<span class="lineno">550</span><span class="keyword" id="2170396">func</span>&nbsp;<span class="op" id="2170401">(</span><span class="ident" id="2170402">b</span>&nbsp;<span class="op" id="2170404">*</span><span class="ident" id="2170405">Writer</span><span class="op" id="2170411">)</span>&nbsp;<span class="ident" id="2170413">Buffered</span><span class="op" id="2170421">(</span><span class="op" id="2170422">)</span>&nbsp;<span class="builtintype" id="2170424">int</span>&nbsp;<span class="op" id="2170428">{</span>&nbsp;<span class="keyword" id="2170430">return</span>&nbsp;<span class="ident" id="2170437">b</span><span class="op" id="2170438">.</span><span class="ident" id="2170439">n</span>&nbsp;<span class="op" id="2170441">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2170444">//&nbsp;Write&nbsp;writes&nbsp;the&nbsp;contents&nbsp;of&nbsp;p&nbsp;into&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="2170495">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="2170538">//&nbsp;If&nbsp;nn&nbsp;&lt;&nbsp;len(p),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">555</span><span class="comment" id="2170593">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="2170620">func</span>&nbsp;<span class="op" id="2170625">(</span><span class="ident" id="2170626">b</span>&nbsp;<span class="op" id="2170628">*</span><span class="ident" id="2170629">Writer</span><span class="op" id="2170635">)</span>&nbsp;<span class="ident" id="2170637">Write</span><span class="op" id="2170642">(</span><span class="ident" id="2170643">p</span>&nbsp;<span class="op" id="2170645">[</span><span class="op" id="2170646">]</span><span class="builtintype" id="2170647">byte</span><span class="op" id="2170651">)</span>&nbsp;<span class="op" id="2170653">(</span><span class="ident" id="2170654">nn</span>&nbsp;<span class="builtintype" id="2170657">int</span><span class="op" id="2170660">,</span>&nbsp;<span class="ident" id="2170662">err</span>&nbsp;<span class="builtintype" id="2170666">error</span><span class="op" id="2170671">)</span>&nbsp;<span class="op" id="2170673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170676">for</span>&nbsp;<span class="builtinfunc" id="2170680">len</span><span class="op" id="2170683">(</span><span class="ident" id="2170684">p</span><span class="op" id="2170685">)</span>&nbsp;<span class="op" id="2170687">&gt;</span>&nbsp;<span class="ident" id="2170689">b</span><span class="op" id="2170690">.</span><span class="ident" id="2170691">Available</span><span class="op" id="2170700">(</span><span class="op" id="2170701">)</span>&nbsp;<span class="op" id="2170703">&amp;&amp;</span>&nbsp;<span class="ident" id="2170706">b</span><span class="op" id="2170707">.</span><span class="ident" id="2170708">err</span>&nbsp;<span class="op" id="2170712">==</span>&nbsp;<span class="ident" id="2170715">nil</span>&nbsp;<span class="op" id="2170719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170723">var</span>&nbsp;<span class="ident" id="2170727">n</span>&nbsp;<span class="builtintype" id="2170729">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170735">if</span>&nbsp;<span class="ident" id="2170738">b</span><span class="op" id="2170739">.</span><span class="ident" id="2170740">Buffered</span><span class="op" id="2170748">(</span><span class="op" id="2170749">)</span>&nbsp;<span class="op" id="2170751">==</span>&nbsp;<span class="num" id="2170754">0</span>&nbsp;<span class="op" id="2170756">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2170761">//&nbsp;Large&nbsp;write,&nbsp;empty&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2170794">//&nbsp;Write&nbsp;directly&nbsp;from&nbsp;p&nbsp;to&nbsp;avoid&nbsp;copy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170837">n</span><span class="op" id="2170838">,</span>&nbsp;<span class="ident" id="2170840">b</span><span class="op" id="2170841">.</span><span class="ident" id="2170842">err</span>&nbsp;<span class="op" id="2170846">=</span>&nbsp;<span class="ident" id="2170848">b</span><span class="op" id="2170849">.</span><span class="ident" id="2170850">wr</span><span class="op" id="2170852">.</span><span class="ident" id="2170853">Write</span><span class="op" id="2170858">(</span><span class="ident" id="2170859">p</span><span class="op" id="2170860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170864">}</span>&nbsp;<span class="keyword" id="2170866">else</span>&nbsp;<span class="op" id="2170871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170876">n</span>&nbsp;<span class="op" id="2170878">=</span>&nbsp;<span class="builtinfunc" id="2170880">copy</span><span class="op" id="2170884">(</span><span class="ident" id="2170885">b</span><span class="op" id="2170886">.</span><span class="ident" id="2170887">buf</span><span class="op" id="2170890">[</span><span class="ident" id="2170891">b</span><span class="op" id="2170892">.</span><span class="ident" id="2170893">n</span><span class="op" id="2170894">:</span><span class="op" id="2170895">]</span><span class="op" id="2170896">,</span>&nbsp;<span class="ident" id="2170898">p</span><span class="op" id="2170899">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170904">b</span><span class="op" id="2170905">.</span><span class="ident" id="2170906">n</span>&nbsp;<span class="op" id="2170908">+=</span>&nbsp;<span class="ident" id="2170911">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170916">b</span><span class="op" id="2170917">.</span><span class="ident" id="2170918">flush</span><span class="op" id="2170923">(</span><span class="op" id="2170924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170932">nn</span>&nbsp;<span class="op" id="2170935">+=</span>&nbsp;<span class="ident" id="2170938">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170942">p</span>&nbsp;<span class="op" id="2170944">=</span>&nbsp;<span class="ident" id="2170946">p</span><span class="op" id="2170947">[</span><span class="ident" id="2170948">n</span><span class="op" id="2170949">:</span><span class="op" id="2170950">]</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170956">if</span>&nbsp;<span class="ident" id="2170959">b</span><span class="op" id="2170960">.</span><span class="ident" id="2170961">err</span>&nbsp;<span class="op" id="2170965">!=</span>&nbsp;<span class="ident" id="2170968">nil</span>&nbsp;<span class="op" id="2170972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2170976">return</span>&nbsp;<span class="ident" id="2170983">nn</span><span class="op" id="2170985">,</span>&nbsp;<span class="ident" id="2170987">b</span><span class="op" id="2170988">.</span><span class="ident" id="2170989">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2170994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2170997">n</span>&nbsp;<span class="op" id="2170999">:=</span>&nbsp;<span class="builtinfunc" id="2171002">copy</span><span class="op" id="2171006">(</span><span class="ident" id="2171007">b</span><span class="op" id="2171008">.</span><span class="ident" id="2171009">buf</span><span class="op" id="2171012">[</span><span class="ident" id="2171013">b</span><span class="op" id="2171014">.</span><span class="ident" id="2171015">n</span><span class="op" id="2171016">:</span><span class="op" id="2171017">]</span><span class="op" id="2171018">,</span>&nbsp;<span class="ident" id="2171020">p</span><span class="op" id="2171021">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171024">b</span><span class="op" id="2171025">.</span><span class="ident" id="2171026">n</span>&nbsp;<span class="op" id="2171028">+=</span>&nbsp;<span class="ident" id="2171031">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171034">nn</span>&nbsp;<span class="op" id="2171037">+=</span>&nbsp;<span class="ident" id="2171040">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171043">return</span>&nbsp;<span class="ident" id="2171050">nn</span><span class="op" id="2171052">,</span>&nbsp;<span class="ident" id="2171054">nil</span><br>
<span class="lineno"></span><span class="op" id="2171058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span><span class="comment" id="2171061">//&nbsp;WriteByte&nbsp;writes&nbsp;a&nbsp;single&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="2171096">func</span>&nbsp;<span class="op" id="2171101">(</span><span class="ident" id="2171102">b</span>&nbsp;<span class="op" id="2171104">*</span><span class="ident" id="2171105">Writer</span><span class="op" id="2171111">)</span>&nbsp;<span class="ident" id="2171113">WriteByte</span><span class="op" id="2171122">(</span><span class="ident" id="2171123">c</span>&nbsp;<span class="builtintype" id="2171125">byte</span><span class="op" id="2171129">)</span>&nbsp;<span class="builtintype" id="2171131">error</span>&nbsp;<span class="op" id="2171137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171140">if</span>&nbsp;<span class="ident" id="2171143">b</span><span class="op" id="2171144">.</span><span class="ident" id="2171145">err</span>&nbsp;<span class="op" id="2171149">!=</span>&nbsp;<span class="ident" id="2171152">nil</span>&nbsp;<span class="op" id="2171156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171160">return</span>&nbsp;<span class="ident" id="2171167">b</span><span class="op" id="2171168">.</span><span class="ident" id="2171169">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171174">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171177">if</span>&nbsp;<span class="ident" id="2171180">b</span><span class="op" id="2171181">.</span><span class="ident" id="2171182">Available</span><span class="op" id="2171191">(</span><span class="op" id="2171192">)</span>&nbsp;<span class="op" id="2171194">&lt;=</span>&nbsp;<span class="num" id="2171197">0</span>&nbsp;<span class="op" id="2171199">&amp;&amp;</span>&nbsp;<span class="ident" id="2171202">b</span><span class="op" id="2171203">.</span><span class="ident" id="2171204">flush</span><span class="op" id="2171209">(</span><span class="op" id="2171210">)</span>&nbsp;<span class="op" id="2171212">!=</span>&nbsp;<span class="ident" id="2171215">nil</span>&nbsp;<span class="op" id="2171219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171223">return</span>&nbsp;<span class="ident" id="2171230">b</span><span class="op" id="2171231">.</span><span class="ident" id="2171232">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171240">b</span><span class="op" id="2171241">.</span><span class="ident" id="2171242">buf</span><span class="op" id="2171245">[</span><span class="ident" id="2171246">b</span><span class="op" id="2171247">.</span><span class="ident" id="2171248">n</span><span class="op" id="2171249">]</span>&nbsp;<span class="op" id="2171251">=</span>&nbsp;<span class="ident" id="2171253">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171256">b</span><span class="op" id="2171257">.</span><span class="ident" id="2171258">n</span><span class="op" id="2171259">++</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171263">return</span>&nbsp;<span class="ident" id="2171270">nil</span><br>
<span class="lineno"></span><span class="op" id="2171274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2171277">//&nbsp;WriteRune&nbsp;writes&nbsp;a&nbsp;single&nbsp;Unicode&nbsp;code&nbsp;point,&nbsp;returning</span><br>
<span class="lineno"></span><span class="comment" id="2171336">//&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written&nbsp;and&nbsp;any&nbsp;error.</span><br>
<span class="lineno">595</span><span class="keyword" id="2171382">func</span>&nbsp;<span class="op" id="2171387">(</span><span class="ident" id="2171388">b</span>&nbsp;<span class="op" id="2171390">*</span><span class="ident" id="2171391">Writer</span><span class="op" id="2171397">)</span>&nbsp;<span class="ident" id="2171399">WriteRune</span><span class="op" id="2171408">(</span><span class="ident" id="2171409">r</span>&nbsp;<span class="builtintype" id="2171411">rune</span><span class="op" id="2171415">)</span>&nbsp;<span class="op" id="2171417">(</span><span class="ident" id="2171418">size</span>&nbsp;<span class="builtintype" id="2171423">int</span><span class="op" id="2171426">,</span>&nbsp;<span class="ident" id="2171428">err</span>&nbsp;<span class="builtintype" id="2171432">error</span><span class="op" id="2171437">)</span>&nbsp;<span class="op" id="2171439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171442">if</span>&nbsp;<span class="ident" id="2171445">r</span>&nbsp;<span class="op" id="2171447">&lt;</span>&nbsp;<span class="ident" id="2171449">utf8</span><span class="op" id="2171453">.</span><span class="ident" id="2171454">RuneSelf</span>&nbsp;<span class="op" id="2171463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171467">err</span>&nbsp;<span class="op" id="2171471">=</span>&nbsp;<span class="ident" id="2171473">b</span><span class="op" id="2171474">.</span><span class="ident" id="2171475">WriteByte</span><span class="op" id="2171484">(</span><span class="builtintype" id="2171485">byte</span><span class="op" id="2171489">(</span><span class="ident" id="2171490">r</span><span class="op" id="2171491">)</span><span class="op" id="2171492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171496">if</span>&nbsp;<span class="ident" id="2171499">err</span>&nbsp;<span class="op" id="2171503">!=</span>&nbsp;<span class="ident" id="2171506">nil</span>&nbsp;<span class="op" id="2171510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171515">return</span>&nbsp;<span class="num" id="2171522">0</span><span class="op" id="2171523">,</span>&nbsp;<span class="ident" id="2171525">err</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171535">return</span>&nbsp;<span class="num" id="2171542">1</span><span class="op" id="2171543">,</span>&nbsp;<span class="ident" id="2171545">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171553">if</span>&nbsp;<span class="ident" id="2171556">b</span><span class="op" id="2171557">.</span><span class="ident" id="2171558">err</span>&nbsp;<span class="op" id="2171562">!=</span>&nbsp;<span class="ident" id="2171565">nil</span>&nbsp;<span class="op" id="2171569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171573">return</span>&nbsp;<span class="num" id="2171580">0</span><span class="op" id="2171581">,</span>&nbsp;<span class="ident" id="2171583">b</span><span class="op" id="2171584">.</span><span class="ident" id="2171585">err</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171593">n</span>&nbsp;<span class="op" id="2171595">:=</span>&nbsp;<span class="ident" id="2171598">b</span><span class="op" id="2171599">.</span><span class="ident" id="2171600">Available</span><span class="op" id="2171609">(</span><span class="op" id="2171610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171613">if</span>&nbsp;<span class="ident" id="2171616">n</span>&nbsp;<span class="op" id="2171618">&lt;</span>&nbsp;<span class="ident" id="2171620">utf8</span><span class="op" id="2171624">.</span><span class="ident" id="2171625">UTFMax</span>&nbsp;<span class="op" id="2171632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171636">if</span>&nbsp;<span class="ident" id="2171639">b</span><span class="op" id="2171640">.</span><span class="ident" id="2171641">flush</span><span class="op" id="2171646">(</span><span class="op" id="2171647">)</span><span class="op" id="2171648">;</span>&nbsp;<span class="ident" id="2171650">b</span><span class="op" id="2171651">.</span><span class="ident" id="2171652">err</span>&nbsp;<span class="op" id="2171656">!=</span>&nbsp;<span class="ident" id="2171659">nil</span>&nbsp;<span class="op" id="2171663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171668">return</span>&nbsp;<span class="num" id="2171675">0</span><span class="op" id="2171676">,</span>&nbsp;<span class="ident" id="2171678">b</span><span class="op" id="2171679">.</span><span class="ident" id="2171680">err</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171690">n</span>&nbsp;<span class="op" id="2171692">=</span>&nbsp;<span class="ident" id="2171694">b</span><span class="op" id="2171695">.</span><span class="ident" id="2171696">Available</span><span class="op" id="2171705">(</span><span class="op" id="2171706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171710">if</span>&nbsp;<span class="ident" id="2171713">n</span>&nbsp;<span class="op" id="2171715">&lt;</span>&nbsp;<span class="ident" id="2171717">utf8</span><span class="op" id="2171721">.</span><span class="ident" id="2171722">UTFMax</span>&nbsp;<span class="op" id="2171729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2171734">//&nbsp;Can&nbsp;only&nbsp;happen&nbsp;if&nbsp;buffer&nbsp;is&nbsp;silly&nbsp;small.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171782">return</span>&nbsp;<span class="ident" id="2171789">b</span><span class="op" id="2171790">.</span><span class="ident" id="2171791">WriteString</span><span class="op" id="2171802">(</span><span class="builtintype" id="2171803">string</span><span class="op" id="2171809">(</span><span class="ident" id="2171810">r</span><span class="op" id="2171811">)</span><span class="op" id="2171812">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2171819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171822">size</span>&nbsp;<span class="op" id="2171827">=</span>&nbsp;<span class="ident" id="2171829">utf8</span><span class="op" id="2171833">.</span><span class="ident" id="2171834">EncodeRune</span><span class="op" id="2171844">(</span><span class="ident" id="2171845">b</span><span class="op" id="2171846">.</span><span class="ident" id="2171847">buf</span><span class="op" id="2171850">[</span><span class="ident" id="2171851">b</span><span class="op" id="2171852">.</span><span class="ident" id="2171853">n</span><span class="op" id="2171854">:</span><span class="op" id="2171855">]</span><span class="op" id="2171856">,</span>&nbsp;<span class="ident" id="2171858">r</span><span class="op" id="2171859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2171862">b</span><span class="op" id="2171863">.</span><span class="ident" id="2171864">n</span>&nbsp;<span class="op" id="2171866">+=</span>&nbsp;<span class="ident" id="2171869">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2171875">return</span>&nbsp;<span class="ident" id="2171882">size</span><span class="op" id="2171886">,</span>&nbsp;<span class="ident" id="2171888">nil</span><br>
<span class="lineno">620</span><span class="op" id="2171892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2171895">//&nbsp;WriteString&nbsp;writes&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="comment" id="2171927">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="2171970">//&nbsp;If&nbsp;the&nbsp;count&nbsp;is&nbsp;less&nbsp;than&nbsp;len(s),&nbsp;it&nbsp;also&nbsp;returns&nbsp;an&nbsp;error&nbsp;explaining</span><br>
<span class="lineno">625</span><span class="comment" id="2172043">//&nbsp;why&nbsp;the&nbsp;write&nbsp;is&nbsp;short.</span><br>
<span class="lineno"></span><span class="keyword" id="2172070">func</span>&nbsp;<span class="op" id="2172075">(</span><span class="ident" id="2172076">b</span>&nbsp;<span class="op" id="2172078">*</span><span class="ident" id="2172079">Writer</span><span class="op" id="2172085">)</span>&nbsp;<span class="ident" id="2172087">WriteString</span><span class="op" id="2172098">(</span><span class="ident" id="2172099">s</span>&nbsp;<span class="builtintype" id="2172101">string</span><span class="op" id="2172107">)</span>&nbsp;<span class="op" id="2172109">(</span><span class="builtintype" id="2172110">int</span><span class="op" id="2172113">,</span>&nbsp;<span class="builtintype" id="2172115">error</span><span class="op" id="2172120">)</span>&nbsp;<span class="op" id="2172122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172125">nn</span>&nbsp;<span class="op" id="2172128">:=</span>&nbsp;<span class="num" id="2172131">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172134">for</span>&nbsp;<span class="builtinfunc" id="2172138">len</span><span class="op" id="2172141">(</span><span class="ident" id="2172142">s</span><span class="op" id="2172143">)</span>&nbsp;<span class="op" id="2172145">&gt;</span>&nbsp;<span class="ident" id="2172147">b</span><span class="op" id="2172148">.</span><span class="ident" id="2172149">Available</span><span class="op" id="2172158">(</span><span class="op" id="2172159">)</span>&nbsp;<span class="op" id="2172161">&amp;&amp;</span>&nbsp;<span class="ident" id="2172164">b</span><span class="op" id="2172165">.</span><span class="ident" id="2172166">err</span>&nbsp;<span class="op" id="2172170">==</span>&nbsp;<span class="ident" id="2172173">nil</span>&nbsp;<span class="op" id="2172177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172181">n</span>&nbsp;<span class="op" id="2172183">:=</span>&nbsp;<span class="builtinfunc" id="2172186">copy</span><span class="op" id="2172190">(</span><span class="ident" id="2172191">b</span><span class="op" id="2172192">.</span><span class="ident" id="2172193">buf</span><span class="op" id="2172196">[</span><span class="ident" id="2172197">b</span><span class="op" id="2172198">.</span><span class="ident" id="2172199">n</span><span class="op" id="2172200">:</span><span class="op" id="2172201">]</span><span class="op" id="2172202">,</span>&nbsp;<span class="ident" id="2172204">s</span><span class="op" id="2172205">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172209">b</span><span class="op" id="2172210">.</span><span class="ident" id="2172211">n</span>&nbsp;<span class="op" id="2172213">+=</span>&nbsp;<span class="ident" id="2172216">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172220">nn</span>&nbsp;<span class="op" id="2172223">+=</span>&nbsp;<span class="ident" id="2172226">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172230">s</span>&nbsp;<span class="op" id="2172232">=</span>&nbsp;<span class="ident" id="2172234">s</span><span class="op" id="2172235">[</span><span class="ident" id="2172236">n</span><span class="op" id="2172237">:</span><span class="op" id="2172238">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172242">b</span><span class="op" id="2172243">.</span><span class="ident" id="2172244">flush</span><span class="op" id="2172249">(</span><span class="op" id="2172250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172253">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172256">if</span>&nbsp;<span class="ident" id="2172259">b</span><span class="op" id="2172260">.</span><span class="ident" id="2172261">err</span>&nbsp;<span class="op" id="2172265">!=</span>&nbsp;<span class="ident" id="2172268">nil</span>&nbsp;<span class="op" id="2172272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172276">return</span>&nbsp;<span class="ident" id="2172283">nn</span><span class="op" id="2172285">,</span>&nbsp;<span class="ident" id="2172287">b</span><span class="op" id="2172288">.</span><span class="ident" id="2172289">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172297">n</span>&nbsp;<span class="op" id="2172299">:=</span>&nbsp;<span class="builtinfunc" id="2172302">copy</span><span class="op" id="2172306">(</span><span class="ident" id="2172307">b</span><span class="op" id="2172308">.</span><span class="ident" id="2172309">buf</span><span class="op" id="2172312">[</span><span class="ident" id="2172313">b</span><span class="op" id="2172314">.</span><span class="ident" id="2172315">n</span><span class="op" id="2172316">:</span><span class="op" id="2172317">]</span><span class="op" id="2172318">,</span>&nbsp;<span class="ident" id="2172320">s</span><span class="op" id="2172321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172324">b</span><span class="op" id="2172325">.</span><span class="ident" id="2172326">n</span>&nbsp;<span class="op" id="2172328">+=</span>&nbsp;<span class="ident" id="2172331">n</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172334">nn</span>&nbsp;<span class="op" id="2172337">+=</span>&nbsp;<span class="ident" id="2172340">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172343">return</span>&nbsp;<span class="ident" id="2172350">nn</span><span class="op" id="2172352">,</span>&nbsp;<span class="ident" id="2172354">nil</span><br>
<span class="lineno"></span><span class="op" id="2172358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2172361">//&nbsp;ReadFrom&nbsp;implements&nbsp;io.ReaderFrom.</span><br>
<span class="lineno">645</span><span class="keyword" id="2172399">func</span>&nbsp;<span class="op" id="2172404">(</span><span class="ident" id="2172405">b</span>&nbsp;<span class="op" id="2172407">*</span><span class="ident" id="2172408">Writer</span><span class="op" id="2172414">)</span>&nbsp;<span class="ident" id="2172416">ReadFrom</span><span class="op" id="2172424">(</span><span class="ident" id="2172425">r</span>&nbsp;<span class="ident" id="2172427">io</span><span class="op" id="2172429">.</span><span class="ident" id="2172430">Reader</span><span class="op" id="2172436">)</span>&nbsp;<span class="op" id="2172438">(</span><span class="ident" id="2172439">n</span>&nbsp;<span class="ident" id="2172441">int64</span><span class="op" id="2172446">,</span>&nbsp;<span class="ident" id="2172448">err</span>&nbsp;<span class="builtintype" id="2172452">error</span><span class="op" id="2172457">)</span>&nbsp;<span class="op" id="2172459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172462">if</span>&nbsp;<span class="ident" id="2172465">b</span><span class="op" id="2172466">.</span><span class="ident" id="2172467">Buffered</span><span class="op" id="2172475">(</span><span class="op" id="2172476">)</span>&nbsp;<span class="op" id="2172478">==</span>&nbsp;<span class="num" id="2172481">0</span>&nbsp;<span class="op" id="2172483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172487">if</span>&nbsp;<span class="ident" id="2172490">w</span><span class="op" id="2172491">,</span>&nbsp;<span class="ident" id="2172493">ok</span>&nbsp;<span class="op" id="2172496">:=</span>&nbsp;<span class="ident" id="2172499">b</span><span class="op" id="2172500">.</span><span class="ident" id="2172501">wr</span><span class="op" id="2172503">.</span><span class="op" id="2172504">(</span><span class="ident" id="2172505">io</span><span class="op" id="2172507">.</span><span class="ident" id="2172508">ReaderFrom</span><span class="op" id="2172518">)</span><span class="op" id="2172519">;</span>&nbsp;<span class="ident" id="2172521">ok</span>&nbsp;<span class="op" id="2172524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172529">return</span>&nbsp;<span class="ident" id="2172536">w</span><span class="op" id="2172537">.</span><span class="ident" id="2172538">ReadFrom</span><span class="op" id="2172546">(</span><span class="ident" id="2172547">r</span><span class="op" id="2172548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172552">}</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172558">var</span>&nbsp;<span class="ident" id="2172562">m</span>&nbsp;<span class="builtintype" id="2172564">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172569">for</span>&nbsp;<span class="op" id="2172573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172577">if</span>&nbsp;<span class="ident" id="2172580">b</span><span class="op" id="2172581">.</span><span class="ident" id="2172582">Available</span><span class="op" id="2172591">(</span><span class="op" id="2172592">)</span>&nbsp;<span class="op" id="2172594">==</span>&nbsp;<span class="num" id="2172597">0</span>&nbsp;<span class="op" id="2172599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172604">if</span>&nbsp;<span class="ident" id="2172607">err1</span>&nbsp;<span class="op" id="2172612">:=</span>&nbsp;<span class="ident" id="2172615">b</span><span class="op" id="2172616">.</span><span class="ident" id="2172617">flush</span><span class="op" id="2172622">(</span><span class="op" id="2172623">)</span><span class="op" id="2172624">;</span>&nbsp;<span class="ident" id="2172626">err1</span>&nbsp;<span class="op" id="2172631">!=</span>&nbsp;<span class="ident" id="2172634">nil</span>&nbsp;<span class="op" id="2172638">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172644">return</span>&nbsp;<span class="ident" id="2172651">n</span><span class="op" id="2172652">,</span>&nbsp;<span class="ident" id="2172654">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172670">nr</span>&nbsp;<span class="op" id="2172673">:=</span>&nbsp;<span class="num" id="2172676">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172680">for</span>&nbsp;<span class="ident" id="2172684">nr</span>&nbsp;<span class="op" id="2172687">&lt;</span>&nbsp;<span class="ident" id="2172689">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2172714">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172719">m</span><span class="op" id="2172720">,</span>&nbsp;<span class="ident" id="2172722">err</span>&nbsp;<span class="op" id="2172726">=</span>&nbsp;<span class="ident" id="2172728">r</span><span class="op" id="2172729">.</span><span class="ident" id="2172730">Read</span><span class="op" id="2172734">(</span><span class="ident" id="2172735">b</span><span class="op" id="2172736">.</span><span class="ident" id="2172737">buf</span><span class="op" id="2172740">[</span><span class="ident" id="2172741">b</span><span class="op" id="2172742">.</span><span class="ident" id="2172743">n</span><span class="op" id="2172744">:</span><span class="op" id="2172745">]</span><span class="op" id="2172746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172751">if</span>&nbsp;<span class="ident" id="2172754">m</span>&nbsp;<span class="op" id="2172756">!=</span>&nbsp;<span class="num" id="2172759">0</span>&nbsp;<span class="op" id="2172761">||</span>&nbsp;<span class="ident" id="2172764">err</span>&nbsp;<span class="op" id="2172768">!=</span>&nbsp;<span class="ident" id="2172771">nil</span>&nbsp;<span class="op" id="2172775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172781">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172795">nr</span><span class="op" id="2172797">++</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172802">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172806">if</span>&nbsp;<span class="ident" id="2172809">nr</span>&nbsp;<span class="op" id="2172812">==</span>&nbsp;<span class="ident" id="2172815">maxConsecutiveEmptyReads</span>&nbsp;<span class="op" id="2172840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172845">return</span>&nbsp;<span class="ident" id="2172852">n</span><span class="op" id="2172853">,</span>&nbsp;<span class="ident" id="2172855">io</span><span class="op" id="2172857">.</span><span class="ident" id="2172858">ErrNoProgress</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172878">b</span><span class="op" id="2172879">.</span><span class="ident" id="2172880">n</span>&nbsp;<span class="op" id="2172882">+=</span>&nbsp;<span class="ident" id="2172885">m</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2172889">n</span>&nbsp;<span class="op" id="2172891">+=</span>&nbsp;<span class="ident" id="2172894">int64</span><span class="op" id="2172899">(</span><span class="ident" id="2172900">m</span><span class="op" id="2172901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172905">if</span>&nbsp;<span class="ident" id="2172908">err</span>&nbsp;<span class="op" id="2172912">!=</span>&nbsp;<span class="ident" id="2172915">nil</span>&nbsp;<span class="op" id="2172919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172924">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2172935">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2172938">if</span>&nbsp;<span class="ident" id="2172941">err</span>&nbsp;<span class="op" id="2172945">==</span>&nbsp;<span class="ident" id="2172948">io</span><span class="op" id="2172950">.</span><span class="ident" id="2172951">EOF</span>&nbsp;<span class="op" id="2172955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2172959">//&nbsp;If&nbsp;we&nbsp;filled&nbsp;the&nbsp;buffer&nbsp;exactly,&nbsp;flush&nbsp;pre-emptively.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2173018">if</span>&nbsp;<span class="ident" id="2173021">b</span><span class="op" id="2173022">.</span><span class="ident" id="2173023">Available</span><span class="op" id="2173032">(</span><span class="op" id="2173033">)</span>&nbsp;<span class="op" id="2173035">==</span>&nbsp;<span class="num" id="2173038">0</span>&nbsp;<span class="op" id="2173040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2173045">err</span>&nbsp;<span class="op" id="2173049">=</span>&nbsp;<span class="ident" id="2173051">b</span><span class="op" id="2173052">.</span><span class="ident" id="2173053">flush</span><span class="op" id="2173058">(</span><span class="op" id="2173059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2173063">}</span>&nbsp;<span class="keyword" id="2173065">else</span>&nbsp;<span class="op" id="2173070">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2173075">err</span>&nbsp;<span class="op" id="2173079">=</span>&nbsp;<span class="ident" id="2173081">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2173087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2173090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2173093">return</span>&nbsp;<span class="ident" id="2173100">n</span><span class="op" id="2173101">,</span>&nbsp;<span class="ident" id="2173103">err</span><br>
<span class="lineno"></span><span class="op" id="2173107">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="comment" id="2173110">//&nbsp;buffered&nbsp;input&nbsp;and&nbsp;output</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2173140">//&nbsp;ReadWriter&nbsp;stores&nbsp;pointers&nbsp;to&nbsp;a&nbsp;Reader&nbsp;and&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="comment" id="2173196">//&nbsp;It&nbsp;implements&nbsp;io.ReadWriter.</span><br>
<span class="lineno">690</span><span class="keyword" id="2173228">type</span>&nbsp;<span class="ident" id="2173233">ReadWriter</span>&nbsp;<span class="keyword" id="2173244">struct</span>&nbsp;<span class="op" id="2173251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2173254">*</span><span class="ident" id="2173255">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2173263">*</span><span class="ident" id="2173264">Writer</span><br>
<span class="lineno"></span><span class="op" id="2173271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span><span class="comment" id="2173274">//&nbsp;NewReadWriter&nbsp;allocates&nbsp;a&nbsp;new&nbsp;ReadWriter&nbsp;that&nbsp;dispatches&nbsp;to&nbsp;r&nbsp;and&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="2173346">func</span>&nbsp;<span class="ident" id="2173351">NewReadWriter</span><span class="op" id="2173364">(</span><span class="ident" id="2173365">r</span>&nbsp;<span class="op" id="2173367">*</span><span class="ident" id="2173368">Reader</span><span class="op" id="2173374">,</span>&nbsp;<span class="ident" id="2173376">w</span>&nbsp;<span class="op" id="2173378">*</span><span class="ident" id="2173379">Writer</span><span class="op" id="2173385">)</span>&nbsp;<span class="op" id="2173387">*</span><span class="ident" id="2173388">ReadWriter</span>&nbsp;<span class="op" id="2173399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2173402">return</span>&nbsp;<span class="op" id="2173409">&amp;</span><span class="ident" id="2173410">ReadWriter</span><span class="op" id="2173420">{</span><span class="ident" id="2173421">r</span><span class="op" id="2173422">,</span>&nbsp;<span class="ident" id="2173424">w</span><span class="op" id="2173425">}</span><br>
<span class="lineno"></span><span class="op" id="2173427">}</span>
</div>
</body>
</html>
