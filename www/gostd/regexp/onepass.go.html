<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html" class="current">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5276956">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5277012">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5277066">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5277117">package</span>&nbsp;<span class="ident" id="5277125">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5277133">import</span>&nbsp;<span class="op" id="5277140">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277143">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277152">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277169">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5277177">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5277187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5277190">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5277222">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5277288">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5277360">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5277414">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5277462">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5277530">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5277598">type</span>&nbsp;<span class="ident" id="5277603">onePassProg</span>&nbsp;<span class="keyword" id="5277615">struct</span>&nbsp;<span class="op" id="5277622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277625">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5277632">[</span><span class="op" id="5277633">]</span><span class="ident" id="5277634">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277647">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5277654">int</span>&nbsp;<span class="comment" id="5277658">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277689">NumCap</span>&nbsp;<span class="builtintype" id="5277696">int</span>&nbsp;<span class="comment" id="5277700">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5277737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5277740">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5277823">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5277889">type</span>&nbsp;<span class="ident" id="5277894">onePassInst</span>&nbsp;<span class="keyword" id="5277906">struct</span>&nbsp;<span class="op" id="5277913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277916">syntax</span><span class="op" id="5277922">.</span><span class="ident" id="5277923">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5277929">Next</span>&nbsp;<span class="op" id="5277934">[</span><span class="op" id="5277935">]</span><span class="builtintype" id="5277936">uint32</span><br>
<span class="lineno"></span><span class="op" id="5277943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5277946">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5278013">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5278072">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5278141">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5278202">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5278220">func</span>&nbsp;<span class="ident" id="5278225">onePassPrefix</span><span class="op" id="5278238">(</span><span class="ident" id="5278239">p</span>&nbsp;<span class="op" id="5278241">*</span><span class="ident" id="5278242">syntax</span><span class="op" id="5278248">.</span><span class="ident" id="5278249">Prog</span><span class="op" id="5278253">)</span>&nbsp;<span class="op" id="5278255">(</span><span class="ident" id="5278256">prefix</span>&nbsp;<span class="builtintype" id="5278263">string</span><span class="op" id="5278269">,</span>&nbsp;<span class="ident" id="5278271">complete</span>&nbsp;<span class="builtintype" id="5278280">bool</span><span class="op" id="5278284">,</span>&nbsp;<span class="ident" id="5278286">pc</span>&nbsp;<span class="builtintype" id="5278289">uint32</span><span class="op" id="5278295">)</span>&nbsp;<span class="op" id="5278297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278300">i</span>&nbsp;<span class="op" id="5278302">:=</span>&nbsp;<span class="op" id="5278305">&amp;</span><span class="ident" id="5278306">p</span><span class="op" id="5278307">.</span><span class="ident" id="5278308">Inst</span><span class="op" id="5278312">[</span><span class="ident" id="5278313">p</span><span class="op" id="5278314">.</span><span class="ident" id="5278315">Start</span><span class="op" id="5278320">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278323">if</span>&nbsp;<span class="ident" id="5278326">i</span><span class="op" id="5278327">.</span><span class="ident" id="5278328">Op</span>&nbsp;<span class="op" id="5278331">!=</span>&nbsp;<span class="ident" id="5278334">syntax</span><span class="op" id="5278340">.</span><span class="ident" id="5278341">InstEmptyWidth</span>&nbsp;<span class="op" id="5278356">||</span>&nbsp;<span class="op" id="5278359">(</span><span class="ident" id="5278360">syntax</span><span class="op" id="5278366">.</span><span class="ident" id="5278367">EmptyOp</span><span class="op" id="5278374">(</span><span class="ident" id="5278375">i</span><span class="op" id="5278376">.</span><span class="ident" id="5278377">Arg</span><span class="op" id="5278380">)</span><span class="op" id="5278381">)</span><span class="op" id="5278382">&amp;</span><span class="ident" id="5278383">syntax</span><span class="op" id="5278389">.</span><span class="ident" id="5278390">EmptyBeginText</span>&nbsp;<span class="op" id="5278405">==</span>&nbsp;<span class="num" id="5278408">0</span>&nbsp;<span class="op" id="5278410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278414">return</span>&nbsp;<span class="string" id="5278421">&#34;&#34;</span><span class="op" id="5278423">,</span>&nbsp;<span class="ident" id="5278425">i</span><span class="op" id="5278426">.</span><span class="ident" id="5278427">Op</span>&nbsp;<span class="op" id="5278430">==</span>&nbsp;<span class="ident" id="5278433">syntax</span><span class="op" id="5278439">.</span><span class="ident" id="5278440">InstMatch</span><span class="op" id="5278449">,</span>&nbsp;<span class="builtintype" id="5278451">uint32</span><span class="op" id="5278457">(</span><span class="ident" id="5278458">p</span><span class="op" id="5278459">.</span><span class="ident" id="5278460">Start</span><span class="op" id="5278465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5278468">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278471">pc</span>&nbsp;<span class="op" id="5278474">=</span>&nbsp;<span class="ident" id="5278476">i</span><span class="op" id="5278477">.</span><span class="ident" id="5278478">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278483">i</span>&nbsp;<span class="op" id="5278485">=</span>&nbsp;<span class="op" id="5278487">&amp;</span><span class="ident" id="5278488">p</span><span class="op" id="5278489">.</span><span class="ident" id="5278490">Inst</span><span class="op" id="5278494">[</span><span class="ident" id="5278495">pc</span><span class="op" id="5278497">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278500">for</span>&nbsp;<span class="ident" id="5278504">i</span><span class="op" id="5278505">.</span><span class="ident" id="5278506">Op</span>&nbsp;<span class="op" id="5278509">==</span>&nbsp;<span class="ident" id="5278512">syntax</span><span class="op" id="5278518">.</span><span class="ident" id="5278519">InstNop</span>&nbsp;<span class="op" id="5278527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278531">pc</span>&nbsp;<span class="op" id="5278534">=</span>&nbsp;<span class="ident" id="5278536">i</span><span class="op" id="5278537">.</span><span class="ident" id="5278538">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278544">i</span>&nbsp;<span class="op" id="5278546">=</span>&nbsp;<span class="op" id="5278548">&amp;</span><span class="ident" id="5278549">p</span><span class="op" id="5278550">.</span><span class="ident" id="5278551">Inst</span><span class="op" id="5278555">[</span><span class="ident" id="5278556">pc</span><span class="op" id="5278558">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5278561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5278564">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278615">if</span>&nbsp;<span class="ident" id="5278618">iop</span><span class="op" id="5278621">(</span><span class="ident" id="5278622">i</span><span class="op" id="5278623">)</span>&nbsp;<span class="op" id="5278625">!=</span>&nbsp;<span class="ident" id="5278628">syntax</span><span class="op" id="5278634">.</span><span class="ident" id="5278635">InstRune</span>&nbsp;<span class="op" id="5278644">||</span>&nbsp;<span class="builtinfunc" id="5278647">len</span><span class="op" id="5278650">(</span><span class="ident" id="5278651">i</span><span class="op" id="5278652">.</span><span class="ident" id="5278653">Rune</span><span class="op" id="5278657">)</span>&nbsp;<span class="op" id="5278659">!=</span>&nbsp;<span class="num" id="5278662">1</span>&nbsp;<span class="op" id="5278664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278668">return</span>&nbsp;<span class="string" id="5278675">&#34;&#34;</span><span class="op" id="5278677">,</span>&nbsp;<span class="ident" id="5278679">i</span><span class="op" id="5278680">.</span><span class="ident" id="5278681">Op</span>&nbsp;<span class="op" id="5278684">==</span>&nbsp;<span class="ident" id="5278687">syntax</span><span class="op" id="5278693">.</span><span class="ident" id="5278694">InstMatch</span><span class="op" id="5278703">,</span>&nbsp;<span class="builtintype" id="5278705">uint32</span><span class="op" id="5278711">(</span><span class="ident" id="5278712">p</span><span class="op" id="5278713">.</span><span class="ident" id="5278714">Start</span><span class="op" id="5278719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5278722">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5278726">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278762">var</span>&nbsp;<span class="ident" id="5278766">buf</span>&nbsp;<span class="ident" id="5278770">bytes</span><span class="op" id="5278775">.</span><span class="ident" id="5278776">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278784">for</span>&nbsp;<span class="ident" id="5278788">iop</span><span class="op" id="5278791">(</span><span class="ident" id="5278792">i</span><span class="op" id="5278793">)</span>&nbsp;<span class="op" id="5278795">==</span>&nbsp;<span class="ident" id="5278798">syntax</span><span class="op" id="5278804">.</span><span class="ident" id="5278805">InstRune</span>&nbsp;<span class="op" id="5278814">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5278817">len</span><span class="op" id="5278820">(</span><span class="ident" id="5278821">i</span><span class="op" id="5278822">.</span><span class="ident" id="5278823">Rune</span><span class="op" id="5278827">)</span>&nbsp;<span class="op" id="5278829">==</span>&nbsp;<span class="num" id="5278832">1</span>&nbsp;<span class="op" id="5278834">&amp;&amp;</span>&nbsp;<span class="ident" id="5278837">syntax</span><span class="op" id="5278843">.</span><span class="ident" id="5278844">Flags</span><span class="op" id="5278849">(</span><span class="ident" id="5278850">i</span><span class="op" id="5278851">.</span><span class="ident" id="5278852">Arg</span><span class="op" id="5278855">)</span><span class="op" id="5278856">&amp;</span><span class="ident" id="5278857">syntax</span><span class="op" id="5278863">.</span><span class="ident" id="5278864">FoldCase</span>&nbsp;<span class="op" id="5278873">==</span>&nbsp;<span class="num" id="5278876">0</span>&nbsp;<span class="op" id="5278878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278882">buf</span><span class="op" id="5278885">.</span><span class="ident" id="5278886">WriteRune</span><span class="op" id="5278895">(</span><span class="ident" id="5278896">i</span><span class="op" id="5278897">.</span><span class="ident" id="5278898">Rune</span><span class="op" id="5278902">[</span><span class="num" id="5278903">0</span><span class="op" id="5278904">]</span><span class="op" id="5278905">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5278909">pc</span><span class="op" id="5278911">,</span>&nbsp;<span class="ident" id="5278913">i</span>&nbsp;<span class="op" id="5278915">=</span>&nbsp;<span class="ident" id="5278917">i</span><span class="op" id="5278918">.</span><span class="ident" id="5278919">Out</span><span class="op" id="5278922">,</span>&nbsp;<span class="op" id="5278924">&amp;</span><span class="ident" id="5278925">p</span><span class="op" id="5278926">.</span><span class="ident" id="5278927">Inst</span><span class="op" id="5278931">[</span><span class="ident" id="5278932">i</span><span class="op" id="5278933">.</span><span class="ident" id="5278934">Out</span><span class="op" id="5278937">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5278940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5278943">return</span>&nbsp;<span class="ident" id="5278950">buf</span><span class="op" id="5278953">.</span><span class="ident" id="5278954">String</span><span class="op" id="5278960">(</span><span class="op" id="5278961">)</span><span class="op" id="5278962">,</span>&nbsp;<span class="ident" id="5278964">i</span><span class="op" id="5278965">.</span><span class="ident" id="5278966">Op</span>&nbsp;<span class="op" id="5278969">==</span>&nbsp;<span class="ident" id="5278972">syntax</span><span class="op" id="5278978">.</span><span class="ident" id="5278979">InstEmptyWidth</span>&nbsp;<span class="op" id="5278994">&amp;&amp;</span>&nbsp;<span class="op" id="5278997">(</span><span class="ident" id="5278998">syntax</span><span class="op" id="5279004">.</span><span class="ident" id="5279005">EmptyOp</span><span class="op" id="5279012">(</span><span class="ident" id="5279013">i</span><span class="op" id="5279014">.</span><span class="ident" id="5279015">Arg</span><span class="op" id="5279018">)</span><span class="op" id="5279019">)</span><span class="op" id="5279020">&amp;</span><span class="ident" id="5279021">syntax</span><span class="op" id="5279027">.</span><span class="ident" id="5279028">EmptyBeginText</span>&nbsp;<span class="op" id="5279043">!=</span>&nbsp;<span class="num" id="5279046">0</span><span class="op" id="5279047">,</span>&nbsp;<span class="ident" id="5279049">pc</span><br>
<span class="lineno"></span><span class="op" id="5279052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5279055">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5279147">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5279244">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5279338">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5279423">func</span>&nbsp;<span class="ident" id="5279428">onePassNext</span><span class="op" id="5279439">(</span><span class="ident" id="5279440">i</span>&nbsp;<span class="op" id="5279442">*</span><span class="ident" id="5279443">onePassInst</span><span class="op" id="5279454">,</span>&nbsp;<span class="ident" id="5279456">r</span>&nbsp;<span class="builtintype" id="5279458">rune</span><span class="op" id="5279462">)</span>&nbsp;<span class="builtintype" id="5279464">uint32</span>&nbsp;<span class="op" id="5279471">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279474">next</span>&nbsp;<span class="op" id="5279479">:=</span>&nbsp;<span class="ident" id="5279482">i</span><span class="op" id="5279483">.</span><span class="ident" id="5279484">MatchRunePos</span><span class="op" id="5279496">(</span><span class="ident" id="5279497">r</span><span class="op" id="5279498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279501">if</span>&nbsp;<span class="ident" id="5279504">next</span>&nbsp;<span class="op" id="5279509">&gt;=</span>&nbsp;<span class="num" id="5279512">0</span>&nbsp;<span class="op" id="5279514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279518">return</span>&nbsp;<span class="ident" id="5279525">i</span><span class="op" id="5279526">.</span><span class="ident" id="5279527">Next</span><span class="op" id="5279531">[</span><span class="ident" id="5279532">next</span><span class="op" id="5279536">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279542">if</span>&nbsp;<span class="ident" id="5279545">i</span><span class="op" id="5279546">.</span><span class="ident" id="5279547">Op</span>&nbsp;<span class="op" id="5279550">==</span>&nbsp;<span class="ident" id="5279553">syntax</span><span class="op" id="5279559">.</span><span class="ident" id="5279560">InstAltMatch</span>&nbsp;<span class="op" id="5279573">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279577">return</span>&nbsp;<span class="ident" id="5279584">i</span><span class="op" id="5279585">.</span><span class="ident" id="5279586">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279594">return</span>&nbsp;<span class="num" id="5279601">0</span><br>
<span class="lineno"></span><span class="op" id="5279603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5279606">func</span>&nbsp;<span class="ident" id="5279611">iop</span><span class="op" id="5279614">(</span><span class="ident" id="5279615">i</span>&nbsp;<span class="op" id="5279617">*</span><span class="ident" id="5279618">syntax</span><span class="op" id="5279624">.</span><span class="ident" id="5279625">Inst</span><span class="op" id="5279629">)</span>&nbsp;<span class="ident" id="5279631">syntax</span><span class="op" id="5279637">.</span><span class="ident" id="5279638">InstOp</span>&nbsp;<span class="op" id="5279645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279648">op</span>&nbsp;<span class="op" id="5279651">:=</span>&nbsp;<span class="ident" id="5279654">i</span><span class="op" id="5279655">.</span><span class="ident" id="5279656">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279660">switch</span>&nbsp;<span class="ident" id="5279667">op</span>&nbsp;<span class="op" id="5279670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279673">case</span>&nbsp;<span class="ident" id="5279678">syntax</span><span class="op" id="5279684">.</span><span class="ident" id="5279685">InstRune1</span><span class="op" id="5279694">,</span>&nbsp;<span class="ident" id="5279696">syntax</span><span class="op" id="5279702">.</span><span class="ident" id="5279703">InstRuneAny</span><span class="op" id="5279714">,</span>&nbsp;<span class="ident" id="5279716">syntax</span><span class="op" id="5279722">.</span><span class="ident" id="5279723">InstRuneAnyNotNL</span><span class="op" id="5279739">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279743">op</span>&nbsp;<span class="op" id="5279746">=</span>&nbsp;<span class="ident" id="5279748">syntax</span><span class="op" id="5279754">.</span><span class="ident" id="5279755">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279768">return</span>&nbsp;<span class="ident" id="5279775">op</span><br>
<span class="lineno"></span><span class="op" id="5279778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5279781">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5279839">type</span>&nbsp;<span class="ident" id="5279844">queueOnePass</span>&nbsp;<span class="keyword" id="5279857">struct</span>&nbsp;<span class="op" id="5279864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279867">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279883">[</span><span class="op" id="5279884">]</span><span class="builtintype" id="5279885">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279893">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5279909">[</span><span class="op" id="5279910">]</span><span class="builtintype" id="5279911">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5279919">size</span><span class="op" id="5279923">,</span>&nbsp;<span class="ident" id="5279925">nextIndex</span>&nbsp;<span class="builtintype" id="5279935">uint32</span><br>
<span class="lineno"></span><span class="op" id="5279942">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5279945">func</span>&nbsp;<span class="op" id="5279950">(</span><span class="ident" id="5279951">q</span>&nbsp;<span class="op" id="5279953">*</span><span class="ident" id="5279954">queueOnePass</span><span class="op" id="5279966">)</span>&nbsp;<span class="ident" id="5279968">empty</span><span class="op" id="5279973">(</span><span class="op" id="5279974">)</span>&nbsp;<span class="builtintype" id="5279976">bool</span>&nbsp;<span class="op" id="5279981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5279984">return</span>&nbsp;<span class="ident" id="5279991">q</span><span class="op" id="5279992">.</span><span class="ident" id="5279993">nextIndex</span>&nbsp;<span class="op" id="5280003">&gt;=</span>&nbsp;<span class="ident" id="5280006">q</span><span class="op" id="5280007">.</span><span class="ident" id="5280008">size</span><br>
<span class="lineno"></span><span class="op" id="5280013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5280016">func</span>&nbsp;<span class="op" id="5280021">(</span><span class="ident" id="5280022">q</span>&nbsp;<span class="op" id="5280024">*</span><span class="ident" id="5280025">queueOnePass</span><span class="op" id="5280037">)</span>&nbsp;<span class="ident" id="5280039">next</span><span class="op" id="5280043">(</span><span class="op" id="5280044">)</span>&nbsp;<span class="op" id="5280046">(</span><span class="ident" id="5280047">n</span>&nbsp;<span class="builtintype" id="5280049">uint32</span><span class="op" id="5280055">)</span>&nbsp;<span class="op" id="5280057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280060">n</span>&nbsp;<span class="op" id="5280062">=</span>&nbsp;<span class="ident" id="5280064">q</span><span class="op" id="5280065">.</span><span class="ident" id="5280066">dense</span><span class="op" id="5280071">[</span><span class="ident" id="5280072">q</span><span class="op" id="5280073">.</span><span class="ident" id="5280074">nextIndex</span><span class="op" id="5280083">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280086">q</span><span class="op" id="5280087">.</span><span class="ident" id="5280088">nextIndex</span><span class="op" id="5280097">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280101">return</span><br>
<span class="lineno"></span><span class="op" id="5280108">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5280111">func</span>&nbsp;<span class="op" id="5280116">(</span><span class="ident" id="5280117">q</span>&nbsp;<span class="op" id="5280119">*</span><span class="ident" id="5280120">queueOnePass</span><span class="op" id="5280132">)</span>&nbsp;<span class="ident" id="5280134">clear</span><span class="op" id="5280139">(</span><span class="op" id="5280140">)</span>&nbsp;<span class="op" id="5280142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280145">q</span><span class="op" id="5280146">.</span><span class="ident" id="5280147">size</span>&nbsp;<span class="op" id="5280152">=</span>&nbsp;<span class="num" id="5280154">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280157">q</span><span class="op" id="5280158">.</span><span class="ident" id="5280159">nextIndex</span>&nbsp;<span class="op" id="5280169">=</span>&nbsp;<span class="num" id="5280171">0</span><br>
<span class="lineno"></span><span class="op" id="5280173">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5280176">func</span>&nbsp;<span class="op" id="5280181">(</span><span class="ident" id="5280182">q</span>&nbsp;<span class="op" id="5280184">*</span><span class="ident" id="5280185">queueOnePass</span><span class="op" id="5280197">)</span>&nbsp;<span class="ident" id="5280199">reset</span><span class="op" id="5280204">(</span><span class="op" id="5280205">)</span>&nbsp;<span class="op" id="5280207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280210">q</span><span class="op" id="5280211">.</span><span class="ident" id="5280212">nextIndex</span>&nbsp;<span class="op" id="5280222">=</span>&nbsp;<span class="num" id="5280224">0</span><br>
<span class="lineno"></span><span class="op" id="5280226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5280229">func</span>&nbsp;<span class="op" id="5280234">(</span><span class="ident" id="5280235">q</span>&nbsp;<span class="op" id="5280237">*</span><span class="ident" id="5280238">queueOnePass</span><span class="op" id="5280250">)</span>&nbsp;<span class="ident" id="5280252">contains</span><span class="op" id="5280260">(</span><span class="ident" id="5280261">u</span>&nbsp;<span class="builtintype" id="5280263">uint32</span><span class="op" id="5280269">)</span>&nbsp;<span class="builtintype" id="5280271">bool</span>&nbsp;<span class="op" id="5280276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280279">if</span>&nbsp;<span class="ident" id="5280282">u</span>&nbsp;<span class="op" id="5280284">&gt;=</span>&nbsp;<span class="builtintype" id="5280287">uint32</span><span class="op" id="5280293">(</span><span class="builtinfunc" id="5280294">len</span><span class="op" id="5280297">(</span><span class="ident" id="5280298">q</span><span class="op" id="5280299">.</span><span class="ident" id="5280300">sparse</span><span class="op" id="5280306">)</span><span class="op" id="5280307">)</span>&nbsp;<span class="op" id="5280309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280313">return</span>&nbsp;<span class="builtintype" id="5280320">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5280327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280330">return</span>&nbsp;<span class="ident" id="5280337">q</span><span class="op" id="5280338">.</span><span class="ident" id="5280339">sparse</span><span class="op" id="5280345">[</span><span class="ident" id="5280346">u</span><span class="op" id="5280347">]</span>&nbsp;<span class="op" id="5280349">&lt;</span>&nbsp;<span class="ident" id="5280351">q</span><span class="op" id="5280352">.</span><span class="ident" id="5280353">size</span>&nbsp;<span class="op" id="5280358">&amp;&amp;</span>&nbsp;<span class="ident" id="5280361">q</span><span class="op" id="5280362">.</span><span class="ident" id="5280363">dense</span><span class="op" id="5280368">[</span><span class="ident" id="5280369">q</span><span class="op" id="5280370">.</span><span class="ident" id="5280371">sparse</span><span class="op" id="5280377">[</span><span class="ident" id="5280378">u</span><span class="op" id="5280379">]</span><span class="op" id="5280380">]</span>&nbsp;<span class="op" id="5280382">==</span>&nbsp;<span class="ident" id="5280385">u</span><br>
<span class="lineno">120</span><span class="op" id="5280387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5280390">func</span>&nbsp;<span class="op" id="5280395">(</span><span class="ident" id="5280396">q</span>&nbsp;<span class="op" id="5280398">*</span><span class="ident" id="5280399">queueOnePass</span><span class="op" id="5280411">)</span>&nbsp;<span class="ident" id="5280413">insert</span><span class="op" id="5280419">(</span><span class="ident" id="5280420">u</span>&nbsp;<span class="builtintype" id="5280422">uint32</span><span class="op" id="5280428">)</span>&nbsp;<span class="op" id="5280430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280433">if</span>&nbsp;<span class="op" id="5280436">!</span><span class="ident" id="5280437">q</span><span class="op" id="5280438">.</span><span class="ident" id="5280439">contains</span><span class="op" id="5280447">(</span><span class="ident" id="5280448">u</span><span class="op" id="5280449">)</span>&nbsp;<span class="op" id="5280451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280455">q</span><span class="op" id="5280456">.</span><span class="ident" id="5280457">insertNew</span><span class="op" id="5280466">(</span><span class="ident" id="5280467">u</span><span class="op" id="5280468">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5280471">}</span><br>
<span class="lineno"></span><span class="op" id="5280473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5280476">func</span>&nbsp;<span class="op" id="5280481">(</span><span class="ident" id="5280482">q</span>&nbsp;<span class="op" id="5280484">*</span><span class="ident" id="5280485">queueOnePass</span><span class="op" id="5280497">)</span>&nbsp;<span class="ident" id="5280499">insertNew</span><span class="op" id="5280508">(</span><span class="ident" id="5280509">u</span>&nbsp;<span class="builtintype" id="5280511">uint32</span><span class="op" id="5280517">)</span>&nbsp;<span class="op" id="5280519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280522">if</span>&nbsp;<span class="ident" id="5280525">u</span>&nbsp;<span class="op" id="5280527">&gt;=</span>&nbsp;<span class="builtintype" id="5280530">uint32</span><span class="op" id="5280536">(</span><span class="builtinfunc" id="5280537">len</span><span class="op" id="5280540">(</span><span class="ident" id="5280541">q</span><span class="op" id="5280542">.</span><span class="ident" id="5280543">sparse</span><span class="op" id="5280549">)</span><span class="op" id="5280550">)</span>&nbsp;<span class="op" id="5280552">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280556">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5280564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280567">q</span><span class="op" id="5280568">.</span><span class="ident" id="5280569">sparse</span><span class="op" id="5280575">[</span><span class="ident" id="5280576">u</span><span class="op" id="5280577">]</span>&nbsp;<span class="op" id="5280579">=</span>&nbsp;<span class="ident" id="5280581">q</span><span class="op" id="5280582">.</span><span class="ident" id="5280583">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280589">q</span><span class="op" id="5280590">.</span><span class="ident" id="5280591">dense</span><span class="op" id="5280596">[</span><span class="ident" id="5280597">q</span><span class="op" id="5280598">.</span><span class="ident" id="5280599">size</span><span class="op" id="5280603">]</span>&nbsp;<span class="op" id="5280605">=</span>&nbsp;<span class="ident" id="5280607">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280610">q</span><span class="op" id="5280611">.</span><span class="ident" id="5280612">size</span><span class="op" id="5280616">++</span><br>
<span class="lineno">135</span><span class="op" id="5280619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5280622">func</span>&nbsp;<span class="ident" id="5280627">newQueue</span><span class="op" id="5280635">(</span><span class="ident" id="5280636">size</span>&nbsp;<span class="builtintype" id="5280641">int</span><span class="op" id="5280644">)</span>&nbsp;<span class="op" id="5280646">(</span><span class="ident" id="5280647">q</span>&nbsp;<span class="op" id="5280649">*</span><span class="ident" id="5280650">queueOnePass</span><span class="op" id="5280662">)</span>&nbsp;<span class="op" id="5280664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5280667">return</span>&nbsp;<span class="op" id="5280674">&amp;</span><span class="ident" id="5280675">queueOnePass</span><span class="op" id="5280687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280691">sparse</span><span class="op" id="5280697">:</span>&nbsp;<span class="builtinfunc" id="5280699">make</span><span class="op" id="5280703">(</span><span class="op" id="5280704">[</span><span class="op" id="5280705">]</span><span class="builtintype" id="5280706">uint32</span><span class="op" id="5280712">,</span>&nbsp;<span class="ident" id="5280714">size</span><span class="op" id="5280718">)</span><span class="op" id="5280719">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5280723">dense</span><span class="op" id="5280728">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5280731">make</span><span class="op" id="5280735">(</span><span class="op" id="5280736">[</span><span class="op" id="5280737">]</span><span class="builtintype" id="5280738">uint32</span><span class="op" id="5280744">,</span>&nbsp;<span class="ident" id="5280746">size</span><span class="op" id="5280750">)</span><span class="op" id="5280751">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5280754">}</span><br>
<span class="lineno"></span><span class="op" id="5280756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5280759">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5280845">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5280929">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5281014">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5281079">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5281165">const</span>&nbsp;<span class="ident" id="5281171">mergeFailed</span>&nbsp;<span class="op" id="5281183">=</span>&nbsp;<span class="builtintype" id="5281185">uint32</span><span class="op" id="5281191">(</span><span class="num" id="5281192">0xffffffff</span><span class="op" id="5281202">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5281205">var</span>&nbsp;<span class="op" id="5281209">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281212">noRune</span>&nbsp;<span class="op" id="5281219">=</span>&nbsp;<span class="op" id="5281221">[</span><span class="op" id="5281222">]</span><span class="builtintype" id="5281223">rune</span><span class="op" id="5281227">{</span><span class="op" id="5281228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281231">noNext</span>&nbsp;<span class="op" id="5281238">=</span>&nbsp;<span class="op" id="5281240">[</span><span class="op" id="5281241">]</span><span class="builtintype" id="5281242">uint32</span><span class="op" id="5281248">{</span><span class="ident" id="5281249">mergeFailed</span><span class="op" id="5281260">}</span><br>
<span class="lineno"></span><span class="op" id="5281262">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5281265">func</span>&nbsp;<span class="ident" id="5281270">mergeRuneSets</span><span class="op" id="5281283">(</span><span class="ident" id="5281284">leftRunes</span><span class="op" id="5281293">,</span>&nbsp;<span class="ident" id="5281295">rightRunes</span>&nbsp;<span class="op" id="5281306">*</span><span class="op" id="5281307">[</span><span class="op" id="5281308">]</span><span class="builtintype" id="5281309">rune</span><span class="op" id="5281313">,</span>&nbsp;<span class="ident" id="5281315">leftPC</span><span class="op" id="5281321">,</span>&nbsp;<span class="ident" id="5281323">rightPC</span>&nbsp;<span class="builtintype" id="5281331">uint32</span><span class="op" id="5281337">)</span>&nbsp;<span class="op" id="5281339">(</span><span class="op" id="5281340">[</span><span class="op" id="5281341">]</span><span class="builtintype" id="5281342">rune</span><span class="op" id="5281346">,</span>&nbsp;<span class="op" id="5281348">[</span><span class="op" id="5281349">]</span><span class="builtintype" id="5281350">uint32</span><span class="op" id="5281356">)</span>&nbsp;<span class="op" id="5281358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281361">leftLen</span>&nbsp;<span class="op" id="5281369">:=</span>&nbsp;<span class="builtinfunc" id="5281372">len</span><span class="op" id="5281375">(</span><span class="op" id="5281376">*</span><span class="ident" id="5281377">leftRunes</span><span class="op" id="5281386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281389">rightLen</span>&nbsp;<span class="op" id="5281398">:=</span>&nbsp;<span class="builtinfunc" id="5281401">len</span><span class="op" id="5281404">(</span><span class="op" id="5281405">*</span><span class="ident" id="5281406">rightRunes</span><span class="op" id="5281416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281419">if</span>&nbsp;<span class="ident" id="5281422">leftLen</span><span class="op" id="5281429">&amp;</span><span class="num" id="5281430">0x1</span>&nbsp;<span class="op" id="5281434">!=</span>&nbsp;<span class="num" id="5281437">0</span>&nbsp;<span class="op" id="5281439">||</span>&nbsp;<span class="ident" id="5281442">rightLen</span><span class="op" id="5281450">&amp;</span><span class="num" id="5281451">0x1</span>&nbsp;<span class="op" id="5281455">!=</span>&nbsp;<span class="num" id="5281458">0</span>&nbsp;<span class="op" id="5281460">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5281464">panic</span><span class="op" id="5281469">(</span><span class="string" id="5281470">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5281503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281509">var</span>&nbsp;<span class="op" id="5281513">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281517">lx</span><span class="op" id="5281519">,</span>&nbsp;<span class="ident" id="5281521">rx</span>&nbsp;<span class="builtintype" id="5281524">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281529">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281532">merged</span>&nbsp;<span class="op" id="5281539">:=</span>&nbsp;<span class="builtinfunc" id="5281542">make</span><span class="op" id="5281546">(</span><span class="op" id="5281547">[</span><span class="op" id="5281548">]</span><span class="builtintype" id="5281549">rune</span><span class="op" id="5281553">,</span>&nbsp;<span class="num" id="5281555">0</span><span class="op" id="5281556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281559">next</span>&nbsp;<span class="op" id="5281564">:=</span>&nbsp;<span class="builtinfunc" id="5281567">make</span><span class="op" id="5281571">(</span><span class="op" id="5281572">[</span><span class="op" id="5281573">]</span><span class="builtintype" id="5281574">uint32</span><span class="op" id="5281580">,</span>&nbsp;<span class="num" id="5281582">0</span><span class="op" id="5281583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281586">ok</span>&nbsp;<span class="op" id="5281589">:=</span>&nbsp;<span class="builtintype" id="5281592">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281598">defer</span>&nbsp;<span class="keyword" id="5281604">func</span><span class="op" id="5281608">(</span><span class="op" id="5281609">)</span>&nbsp;<span class="op" id="5281611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281615">if</span>&nbsp;<span class="op" id="5281618">!</span><span class="ident" id="5281619">ok</span>&nbsp;<span class="op" id="5281622">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281627">merged</span>&nbsp;<span class="op" id="5281634">=</span>&nbsp;<span class="builtintype" id="5281636">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281643">next</span>&nbsp;<span class="op" id="5281648">=</span>&nbsp;<span class="builtintype" id="5281650">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281659">}</span><span class="op" id="5281660">(</span><span class="op" id="5281661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281665">ix</span>&nbsp;<span class="op" id="5281668">:=</span>&nbsp;<span class="op" id="5281671">-</span><span class="num" id="5281672">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281675">extend</span>&nbsp;<span class="op" id="5281682">:=</span>&nbsp;<span class="keyword" id="5281685">func</span><span class="op" id="5281689">(</span><span class="ident" id="5281690">newLow</span>&nbsp;<span class="op" id="5281697">*</span><span class="builtintype" id="5281698">int</span><span class="op" id="5281701">,</span>&nbsp;<span class="ident" id="5281703">newArray</span>&nbsp;<span class="op" id="5281712">*</span><span class="op" id="5281713">[</span><span class="op" id="5281714">]</span><span class="builtintype" id="5281715">rune</span><span class="op" id="5281719">,</span>&nbsp;<span class="ident" id="5281721">pc</span>&nbsp;<span class="builtintype" id="5281724">uint32</span><span class="op" id="5281730">)</span>&nbsp;<span class="builtintype" id="5281732">bool</span>&nbsp;<span class="op" id="5281737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281741">if</span>&nbsp;<span class="ident" id="5281744">ix</span>&nbsp;<span class="op" id="5281747">&gt;</span>&nbsp;<span class="num" id="5281749">0</span>&nbsp;<span class="op" id="5281751">&amp;&amp;</span>&nbsp;<span class="op" id="5281754">(</span><span class="op" id="5281755">*</span><span class="ident" id="5281756">newArray</span><span class="op" id="5281764">)</span><span class="op" id="5281765">[</span><span class="op" id="5281766">*</span><span class="ident" id="5281767">newLow</span><span class="op" id="5281773">]</span>&nbsp;<span class="op" id="5281775">&lt;=</span>&nbsp;<span class="ident" id="5281778">merged</span><span class="op" id="5281784">[</span><span class="ident" id="5281785">ix</span><span class="op" id="5281787">]</span>&nbsp;<span class="op" id="5281789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281794">return</span>&nbsp;<span class="builtintype" id="5281801">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281809">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281813">merged</span>&nbsp;<span class="op" id="5281820">=</span>&nbsp;<span class="builtinfunc" id="5281822">append</span><span class="op" id="5281828">(</span><span class="ident" id="5281829">merged</span><span class="op" id="5281835">,</span>&nbsp;<span class="op" id="5281837">(</span><span class="op" id="5281838">*</span><span class="ident" id="5281839">newArray</span><span class="op" id="5281847">)</span><span class="op" id="5281848">[</span><span class="op" id="5281849">*</span><span class="ident" id="5281850">newLow</span><span class="op" id="5281856">]</span><span class="op" id="5281857">,</span>&nbsp;<span class="op" id="5281859">(</span><span class="op" id="5281860">*</span><span class="ident" id="5281861">newArray</span><span class="op" id="5281869">)</span><span class="op" id="5281870">[</span><span class="op" id="5281871">*</span><span class="ident" id="5281872">newLow</span><span class="op" id="5281878">+</span><span class="num" id="5281879">1</span><span class="op" id="5281880">]</span><span class="op" id="5281881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281885">*</span><span class="ident" id="5281886">newLow</span>&nbsp;<span class="op" id="5281893">+=</span>&nbsp;<span class="num" id="5281896">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281900">ix</span>&nbsp;<span class="op" id="5281903">+=</span>&nbsp;<span class="num" id="5281906">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5281910">next</span>&nbsp;<span class="op" id="5281915">=</span>&nbsp;<span class="builtinfunc" id="5281917">append</span><span class="op" id="5281923">(</span><span class="ident" id="5281924">next</span><span class="op" id="5281928">,</span>&nbsp;<span class="ident" id="5281930">pc</span><span class="op" id="5281932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281936">return</span>&nbsp;<span class="builtintype" id="5281943">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5281949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281953">for</span>&nbsp;<span class="ident" id="5281957">lx</span>&nbsp;<span class="op" id="5281960">&lt;</span>&nbsp;<span class="ident" id="5281962">leftLen</span>&nbsp;<span class="op" id="5281970">||</span>&nbsp;<span class="ident" id="5281973">rx</span>&nbsp;<span class="op" id="5281976">&lt;</span>&nbsp;<span class="ident" id="5281978">rightLen</span>&nbsp;<span class="op" id="5281987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5281991">switch</span>&nbsp;<span class="op" id="5281998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282002">case</span>&nbsp;<span class="ident" id="5282007">rx</span>&nbsp;<span class="op" id="5282010">&gt;=</span>&nbsp;<span class="ident" id="5282013">rightLen</span><span class="op" id="5282021">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282026">ok</span>&nbsp;<span class="op" id="5282029">=</span>&nbsp;<span class="ident" id="5282031">extend</span><span class="op" id="5282037">(</span><span class="op" id="5282038">&amp;</span><span class="ident" id="5282039">lx</span><span class="op" id="5282041">,</span>&nbsp;<span class="ident" id="5282043">leftRunes</span><span class="op" id="5282052">,</span>&nbsp;<span class="ident" id="5282054">leftPC</span><span class="op" id="5282060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282064">case</span>&nbsp;<span class="ident" id="5282069">lx</span>&nbsp;<span class="op" id="5282072">&gt;=</span>&nbsp;<span class="ident" id="5282075">leftLen</span><span class="op" id="5282082">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282087">ok</span>&nbsp;<span class="op" id="5282090">=</span>&nbsp;<span class="ident" id="5282092">extend</span><span class="op" id="5282098">(</span><span class="op" id="5282099">&amp;</span><span class="ident" id="5282100">rx</span><span class="op" id="5282102">,</span>&nbsp;<span class="ident" id="5282104">rightRunes</span><span class="op" id="5282114">,</span>&nbsp;<span class="ident" id="5282116">rightPC</span><span class="op" id="5282123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282127">case</span>&nbsp;<span class="op" id="5282132">(</span><span class="op" id="5282133">*</span><span class="ident" id="5282134">rightRunes</span><span class="op" id="5282144">)</span><span class="op" id="5282145">[</span><span class="ident" id="5282146">rx</span><span class="op" id="5282148">]</span>&nbsp;<span class="op" id="5282150">&lt;</span>&nbsp;<span class="op" id="5282152">(</span><span class="op" id="5282153">*</span><span class="ident" id="5282154">leftRunes</span><span class="op" id="5282163">)</span><span class="op" id="5282164">[</span><span class="ident" id="5282165">lx</span><span class="op" id="5282167">]</span><span class="op" id="5282168">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282173">ok</span>&nbsp;<span class="op" id="5282176">=</span>&nbsp;<span class="ident" id="5282178">extend</span><span class="op" id="5282184">(</span><span class="op" id="5282185">&amp;</span><span class="ident" id="5282186">rx</span><span class="op" id="5282188">,</span>&nbsp;<span class="ident" id="5282190">rightRunes</span><span class="op" id="5282200">,</span>&nbsp;<span class="ident" id="5282202">rightPC</span><span class="op" id="5282209">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282213">default</span><span class="op" id="5282220">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282225">ok</span>&nbsp;<span class="op" id="5282228">=</span>&nbsp;<span class="ident" id="5282230">extend</span><span class="op" id="5282236">(</span><span class="op" id="5282237">&amp;</span><span class="ident" id="5282238">lx</span><span class="op" id="5282240">,</span>&nbsp;<span class="ident" id="5282242">leftRunes</span><span class="op" id="5282251">,</span>&nbsp;<span class="ident" id="5282253">leftPC</span><span class="op" id="5282259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5282263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282267">if</span>&nbsp;<span class="op" id="5282270">!</span><span class="ident" id="5282271">ok</span>&nbsp;<span class="op" id="5282274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282279">return</span>&nbsp;<span class="ident" id="5282286">noRune</span><span class="op" id="5282292">,</span>&nbsp;<span class="ident" id="5282294">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5282303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5282306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282309">return</span>&nbsp;<span class="ident" id="5282316">merged</span><span class="op" id="5282322">,</span>&nbsp;<span class="ident" id="5282324">next</span><br>
<span class="lineno"></span><span class="op" id="5282329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5282332">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5282416">func</span>&nbsp;<span class="ident" id="5282421">cleanupOnePass</span><span class="op" id="5282435">(</span><span class="ident" id="5282436">prog</span>&nbsp;<span class="op" id="5282441">*</span><span class="ident" id="5282442">onePassProg</span><span class="op" id="5282453">,</span>&nbsp;<span class="ident" id="5282455">original</span>&nbsp;<span class="op" id="5282464">*</span><span class="ident" id="5282465">syntax</span><span class="op" id="5282471">.</span><span class="ident" id="5282472">Prog</span><span class="op" id="5282476">)</span>&nbsp;<span class="op" id="5282478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282481">for</span>&nbsp;<span class="ident" id="5282485">ix</span><span class="op" id="5282487">,</span>&nbsp;<span class="ident" id="5282489">instOriginal</span>&nbsp;<span class="op" id="5282502">:=</span>&nbsp;<span class="keyword" id="5282505">range</span>&nbsp;<span class="ident" id="5282511">original</span><span class="op" id="5282519">.</span><span class="ident" id="5282520">Inst</span>&nbsp;<span class="op" id="5282525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282529">switch</span>&nbsp;<span class="ident" id="5282536">instOriginal</span><span class="op" id="5282548">.</span><span class="ident" id="5282549">Op</span>&nbsp;<span class="op" id="5282552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282556">case</span>&nbsp;<span class="ident" id="5282561">syntax</span><span class="op" id="5282567">.</span><span class="ident" id="5282568">InstAlt</span><span class="op" id="5282575">,</span>&nbsp;<span class="ident" id="5282577">syntax</span><span class="op" id="5282583">.</span><span class="ident" id="5282584">InstAltMatch</span><span class="op" id="5282596">,</span>&nbsp;<span class="ident" id="5282598">syntax</span><span class="op" id="5282604">.</span><span class="ident" id="5282605">InstRune</span><span class="op" id="5282613">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282617">case</span>&nbsp;<span class="ident" id="5282622">syntax</span><span class="op" id="5282628">.</span><span class="ident" id="5282629">InstCapture</span><span class="op" id="5282640">,</span>&nbsp;<span class="ident" id="5282642">syntax</span><span class="op" id="5282648">.</span><span class="ident" id="5282649">InstEmptyWidth</span><span class="op" id="5282663">,</span>&nbsp;<span class="ident" id="5282665">syntax</span><span class="op" id="5282671">.</span><span class="ident" id="5282672">InstNop</span><span class="op" id="5282679">,</span>&nbsp;<span class="ident" id="5282681">syntax</span><span class="op" id="5282687">.</span><span class="ident" id="5282688">InstMatch</span><span class="op" id="5282697">,</span>&nbsp;<span class="ident" id="5282699">syntax</span><span class="op" id="5282705">.</span><span class="ident" id="5282706">InstFail</span><span class="op" id="5282714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282719">prog</span><span class="op" id="5282723">.</span><span class="ident" id="5282724">Inst</span><span class="op" id="5282728">[</span><span class="ident" id="5282729">ix</span><span class="op" id="5282731">]</span><span class="op" id="5282732">.</span><span class="ident" id="5282733">Next</span>&nbsp;<span class="op" id="5282738">=</span>&nbsp;<span class="builtintype" id="5282740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5282746">case</span>&nbsp;<span class="ident" id="5282751">syntax</span><span class="op" id="5282757">.</span><span class="ident" id="5282758">InstRune1</span><span class="op" id="5282767">,</span>&nbsp;<span class="ident" id="5282769">syntax</span><span class="op" id="5282775">.</span><span class="ident" id="5282776">InstRuneAny</span><span class="op" id="5282787">,</span>&nbsp;<span class="ident" id="5282789">syntax</span><span class="op" id="5282795">.</span><span class="ident" id="5282796">InstRuneAnyNotNL</span><span class="op" id="5282812">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282817">prog</span><span class="op" id="5282821">.</span><span class="ident" id="5282822">Inst</span><span class="op" id="5282826">[</span><span class="ident" id="5282827">ix</span><span class="op" id="5282829">]</span><span class="op" id="5282830">.</span><span class="ident" id="5282831">Next</span>&nbsp;<span class="op" id="5282836">=</span>&nbsp;<span class="builtintype" id="5282838">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5282845">prog</span><span class="op" id="5282849">.</span><span class="ident" id="5282850">Inst</span><span class="op" id="5282854">[</span><span class="ident" id="5282855">ix</span><span class="op" id="5282857">]</span>&nbsp;<span class="op" id="5282859">=</span>&nbsp;<span class="ident" id="5282861">onePassInst</span><span class="op" id="5282872">{</span><span class="ident" id="5282873">Inst</span><span class="op" id="5282877">:</span>&nbsp;<span class="ident" id="5282879">instOriginal</span><span class="op" id="5282891">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5282895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5282898">}</span><br>
<span class="lineno"></span><span class="op" id="5282900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5282903">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5282980">func</span>&nbsp;<span class="ident" id="5282985">onePassCopy</span><span class="op" id="5282996">(</span><span class="ident" id="5282997">prog</span>&nbsp;<span class="op" id="5283002">*</span><span class="ident" id="5283003">syntax</span><span class="op" id="5283009">.</span><span class="ident" id="5283010">Prog</span><span class="op" id="5283014">)</span>&nbsp;<span class="op" id="5283016">*</span><span class="ident" id="5283017">onePassProg</span>&nbsp;<span class="op" id="5283029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283032">p</span>&nbsp;<span class="op" id="5283034">:=</span>&nbsp;<span class="op" id="5283037">&amp;</span><span class="ident" id="5283038">onePassProg</span><span class="op" id="5283049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283053">Start</span><span class="op" id="5283058">:</span>&nbsp;&nbsp;<span class="ident" id="5283061">prog</span><span class="op" id="5283065">.</span><span class="ident" id="5283066">Start</span><span class="op" id="5283071">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283075">NumCap</span><span class="op" id="5283081">:</span>&nbsp;<span class="ident" id="5283083">prog</span><span class="op" id="5283087">.</span><span class="ident" id="5283088">NumCap</span><span class="op" id="5283094">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5283097">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283100">for</span>&nbsp;<span class="ident" id="5283104">_</span><span class="op" id="5283105">,</span>&nbsp;<span class="ident" id="5283107">inst</span>&nbsp;<span class="op" id="5283112">:=</span>&nbsp;<span class="keyword" id="5283115">range</span>&nbsp;<span class="ident" id="5283121">prog</span><span class="op" id="5283125">.</span><span class="ident" id="5283126">Inst</span>&nbsp;<span class="op" id="5283131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283135">p</span><span class="op" id="5283136">.</span><span class="ident" id="5283137">Inst</span>&nbsp;<span class="op" id="5283142">=</span>&nbsp;<span class="builtinfunc" id="5283144">append</span><span class="op" id="5283150">(</span><span class="ident" id="5283151">p</span><span class="op" id="5283152">.</span><span class="ident" id="5283153">Inst</span><span class="op" id="5283157">,</span>&nbsp;<span class="ident" id="5283159">onePassInst</span><span class="op" id="5283170">{</span><span class="ident" id="5283171">Inst</span><span class="op" id="5283175">:</span>&nbsp;<span class="ident" id="5283177">inst</span><span class="op" id="5283181">}</span><span class="op" id="5283182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5283185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283189">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283264">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283340">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283376">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283407">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283438">for</span>&nbsp;<span class="ident" id="5283442">pc</span>&nbsp;<span class="op" id="5283445">:=</span>&nbsp;<span class="keyword" id="5283448">range</span>&nbsp;<span class="ident" id="5283454">p</span><span class="op" id="5283455">.</span><span class="ident" id="5283456">Inst</span>&nbsp;<span class="op" id="5283461">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283465">switch</span>&nbsp;<span class="ident" id="5283472">p</span><span class="op" id="5283473">.</span><span class="ident" id="5283474">Inst</span><span class="op" id="5283478">[</span><span class="ident" id="5283479">pc</span><span class="op" id="5283481">]</span><span class="op" id="5283482">.</span><span class="ident" id="5283483">Op</span>&nbsp;<span class="op" id="5283486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283490">default</span><span class="op" id="5283497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283502">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283513">case</span>&nbsp;<span class="ident" id="5283518">syntax</span><span class="op" id="5283524">.</span><span class="ident" id="5283525">InstAlt</span><span class="op" id="5283532">,</span>&nbsp;<span class="ident" id="5283534">syntax</span><span class="op" id="5283540">.</span><span class="ident" id="5283541">InstAltMatch</span><span class="op" id="5283553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283558">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283576">p_A_Other</span>&nbsp;<span class="op" id="5283586">:=</span>&nbsp;<span class="op" id="5283589">&amp;</span><span class="ident" id="5283590">p</span><span class="op" id="5283591">.</span><span class="ident" id="5283592">Inst</span><span class="op" id="5283596">[</span><span class="ident" id="5283597">pc</span><span class="op" id="5283599">]</span><span class="op" id="5283600">.</span><span class="ident" id="5283601">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283608">p_A_Alt</span>&nbsp;<span class="op" id="5283616">:=</span>&nbsp;<span class="op" id="5283619">&amp;</span><span class="ident" id="5283620">p</span><span class="op" id="5283621">.</span><span class="ident" id="5283622">Inst</span><span class="op" id="5283626">[</span><span class="ident" id="5283627">pc</span><span class="op" id="5283629">]</span><span class="op" id="5283630">.</span><span class="ident" id="5283631">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283638">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283678">instAlt</span>&nbsp;<span class="op" id="5283686">:=</span>&nbsp;<span class="ident" id="5283689">p</span><span class="op" id="5283690">.</span><span class="ident" id="5283691">Inst</span><span class="op" id="5283695">[</span><span class="op" id="5283696">*</span><span class="ident" id="5283697">p_A_Alt</span><span class="op" id="5283704">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283709">if</span>&nbsp;<span class="op" id="5283712">!</span><span class="op" id="5283713">(</span><span class="ident" id="5283714">instAlt</span><span class="op" id="5283721">.</span><span class="ident" id="5283722">Op</span>&nbsp;<span class="op" id="5283725">==</span>&nbsp;<span class="ident" id="5283728">syntax</span><span class="op" id="5283734">.</span><span class="ident" id="5283735">InstAlt</span>&nbsp;<span class="op" id="5283743">||</span>&nbsp;<span class="ident" id="5283746">instAlt</span><span class="op" id="5283753">.</span><span class="ident" id="5283754">Op</span>&nbsp;<span class="op" id="5283757">==</span>&nbsp;<span class="ident" id="5283760">syntax</span><span class="op" id="5283766">.</span><span class="ident" id="5283767">InstAltMatch</span><span class="op" id="5283779">)</span>&nbsp;<span class="op" id="5283781">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283787">p_A_Alt</span><span class="op" id="5283794">,</span>&nbsp;<span class="ident" id="5283796">p_A_Other</span>&nbsp;<span class="op" id="5283806">=</span>&nbsp;<span class="ident" id="5283808">p_A_Other</span><span class="op" id="5283817">,</span>&nbsp;<span class="ident" id="5283819">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283831">instAlt</span>&nbsp;<span class="op" id="5283839">=</span>&nbsp;<span class="ident" id="5283841">p</span><span class="op" id="5283842">.</span><span class="ident" id="5283843">Inst</span><span class="op" id="5283847">[</span><span class="op" id="5283848">*</span><span class="ident" id="5283849">p_A_Alt</span><span class="op" id="5283856">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283862">if</span>&nbsp;<span class="op" id="5283865">!</span><span class="op" id="5283866">(</span><span class="ident" id="5283867">instAlt</span><span class="op" id="5283874">.</span><span class="ident" id="5283875">Op</span>&nbsp;<span class="op" id="5283878">==</span>&nbsp;<span class="ident" id="5283881">syntax</span><span class="op" id="5283887">.</span><span class="ident" id="5283888">InstAlt</span>&nbsp;<span class="op" id="5283896">||</span>&nbsp;<span class="ident" id="5283899">instAlt</span><span class="op" id="5283906">.</span><span class="ident" id="5283907">Op</span>&nbsp;<span class="op" id="5283910">==</span>&nbsp;<span class="ident" id="5283913">syntax</span><span class="op" id="5283919">.</span><span class="ident" id="5283920">InstAltMatch</span><span class="op" id="5283932">)</span>&nbsp;<span class="op" id="5283934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5283941">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5283954">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5283959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5283964">instOther</span>&nbsp;<span class="op" id="5283974">:=</span>&nbsp;<span class="ident" id="5283977">p</span><span class="op" id="5283978">.</span><span class="ident" id="5283979">Inst</span><span class="op" id="5283983">[</span><span class="op" id="5283984">*</span><span class="ident" id="5283985">p_A_Other</span><span class="op" id="5283994">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5283999">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284061">if</span>&nbsp;<span class="ident" id="5284064">instOther</span><span class="op" id="5284073">.</span><span class="ident" id="5284074">Op</span>&nbsp;<span class="op" id="5284077">==</span>&nbsp;<span class="ident" id="5284080">syntax</span><span class="op" id="5284086">.</span><span class="ident" id="5284087">InstAlt</span>&nbsp;<span class="op" id="5284095">||</span>&nbsp;<span class="ident" id="5284098">instOther</span><span class="op" id="5284107">.</span><span class="ident" id="5284108">Op</span>&nbsp;<span class="op" id="5284111">==</span>&nbsp;<span class="ident" id="5284114">syntax</span><span class="op" id="5284120">.</span><span class="ident" id="5284121">InstAltMatch</span>&nbsp;<span class="op" id="5284134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284140">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284163">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284180">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284215">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284248">p_B_Alt</span>&nbsp;<span class="op" id="5284256">:=</span>&nbsp;<span class="op" id="5284259">&amp;</span><span class="ident" id="5284260">p</span><span class="op" id="5284261">.</span><span class="ident" id="5284262">Inst</span><span class="op" id="5284266">[</span><span class="op" id="5284267">*</span><span class="ident" id="5284268">p_A_Alt</span><span class="op" id="5284275">]</span><span class="op" id="5284276">.</span><span class="ident" id="5284277">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284284">p_B_Other</span>&nbsp;<span class="op" id="5284294">:=</span>&nbsp;<span class="op" id="5284297">&amp;</span><span class="ident" id="5284298">p</span><span class="op" id="5284299">.</span><span class="ident" id="5284300">Inst</span><span class="op" id="5284304">[</span><span class="op" id="5284305">*</span><span class="ident" id="5284306">p_A_Alt</span><span class="op" id="5284313">]</span><span class="op" id="5284314">.</span><span class="ident" id="5284315">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284322">patch</span>&nbsp;<span class="op" id="5284328">:=</span>&nbsp;<span class="builtintype" id="5284331">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284340">if</span>&nbsp;<span class="ident" id="5284343">instAlt</span><span class="op" id="5284350">.</span><span class="ident" id="5284351">Out</span>&nbsp;<span class="op" id="5284355">==</span>&nbsp;<span class="builtintype" id="5284358">uint32</span><span class="op" id="5284364">(</span><span class="ident" id="5284365">pc</span><span class="op" id="5284367">)</span>&nbsp;<span class="op" id="5284369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284375">patch</span>&nbsp;<span class="op" id="5284381">=</span>&nbsp;<span class="builtintype" id="5284383">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284391">}</span>&nbsp;<span class="keyword" id="5284393">else</span>&nbsp;<span class="keyword" id="5284398">if</span>&nbsp;<span class="ident" id="5284401">instAlt</span><span class="op" id="5284408">.</span><span class="ident" id="5284409">Arg</span>&nbsp;<span class="op" id="5284413">==</span>&nbsp;<span class="builtintype" id="5284416">uint32</span><span class="op" id="5284422">(</span><span class="ident" id="5284423">pc</span><span class="op" id="5284425">)</span>&nbsp;<span class="op" id="5284427">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284433">patch</span>&nbsp;<span class="op" id="5284439">=</span>&nbsp;<span class="builtintype" id="5284441">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5284450">p_B_Alt</span><span class="op" id="5284457">,</span>&nbsp;<span class="ident" id="5284459">p_B_Other</span>&nbsp;<span class="op" id="5284469">=</span>&nbsp;<span class="ident" id="5284471">p_B_Other</span><span class="op" id="5284480">,</span>&nbsp;<span class="ident" id="5284482">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284498">if</span>&nbsp;<span class="ident" id="5284501">patch</span>&nbsp;<span class="op" id="5284507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284513">*</span><span class="ident" id="5284514">p_B_Alt</span>&nbsp;<span class="op" id="5284522">=</span>&nbsp;<span class="op" id="5284524">*</span><span class="ident" id="5284525">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284544">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5284584">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284617">if</span>&nbsp;<span class="op" id="5284620">*</span><span class="ident" id="5284621">p_A_Other</span>&nbsp;<span class="op" id="5284631">==</span>&nbsp;<span class="op" id="5284634">*</span><span class="ident" id="5284635">p_B_Alt</span>&nbsp;<span class="op" id="5284643">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284649">*</span><span class="ident" id="5284650">p_A_Alt</span>&nbsp;<span class="op" id="5284658">=</span>&nbsp;<span class="op" id="5284660">*</span><span class="ident" id="5284661">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5284684">return</span>&nbsp;<span class="ident" id="5284691">p</span><br>
<span class="lineno">280</span><span class="op" id="5284693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5284696">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5284761">type</span>&nbsp;<span class="ident" id="5284766">runeSlice</span>&nbsp;<span class="op" id="5284776">[</span><span class="op" id="5284777">]</span><span class="builtintype" id="5284778">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5284784">func</span>&nbsp;<span class="op" id="5284789">(</span><span class="ident" id="5284790">p</span>&nbsp;<span class="ident" id="5284792">runeSlice</span><span class="op" id="5284801">)</span>&nbsp;<span class="ident" id="5284803">Len</span><span class="op" id="5284806">(</span><span class="op" id="5284807">)</span>&nbsp;<span class="builtintype" id="5284809">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284823">{</span>&nbsp;<span class="keyword" id="5284825">return</span>&nbsp;<span class="builtinfunc" id="5284832">len</span><span class="op" id="5284835">(</span><span class="ident" id="5284836">p</span><span class="op" id="5284837">)</span>&nbsp;<span class="op" id="5284839">}</span><br>
<span class="lineno"></span><span class="keyword" id="5284841">func</span>&nbsp;<span class="op" id="5284846">(</span><span class="ident" id="5284847">p</span>&nbsp;<span class="ident" id="5284849">runeSlice</span><span class="op" id="5284858">)</span>&nbsp;<span class="ident" id="5284860">Less</span><span class="op" id="5284864">(</span><span class="ident" id="5284865">i</span><span class="op" id="5284866">,</span>&nbsp;<span class="ident" id="5284868">j</span>&nbsp;<span class="builtintype" id="5284870">int</span><span class="op" id="5284873">)</span>&nbsp;<span class="builtintype" id="5284875">bool</span>&nbsp;<span class="op" id="5284880">{</span>&nbsp;<span class="keyword" id="5284882">return</span>&nbsp;<span class="ident" id="5284889">p</span><span class="op" id="5284890">[</span><span class="ident" id="5284891">i</span><span class="op" id="5284892">]</span>&nbsp;<span class="op" id="5284894">&lt;</span>&nbsp;<span class="ident" id="5284896">p</span><span class="op" id="5284897">[</span><span class="ident" id="5284898">j</span><span class="op" id="5284899">]</span>&nbsp;<span class="op" id="5284901">}</span><br>
<span class="lineno"></span><span class="keyword" id="5284903">func</span>&nbsp;<span class="op" id="5284908">(</span><span class="ident" id="5284909">p</span>&nbsp;<span class="ident" id="5284911">runeSlice</span><span class="op" id="5284920">)</span>&nbsp;<span class="ident" id="5284922">Swap</span><span class="op" id="5284926">(</span><span class="ident" id="5284927">i</span><span class="op" id="5284928">,</span>&nbsp;<span class="ident" id="5284930">j</span>&nbsp;<span class="builtintype" id="5284932">int</span><span class="op" id="5284935">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5284942">{</span>&nbsp;<span class="ident" id="5284944">p</span><span class="op" id="5284945">[</span><span class="ident" id="5284946">i</span><span class="op" id="5284947">]</span><span class="op" id="5284948">,</span>&nbsp;<span class="ident" id="5284950">p</span><span class="op" id="5284951">[</span><span class="ident" id="5284952">j</span><span class="op" id="5284953">]</span>&nbsp;<span class="op" id="5284955">=</span>&nbsp;<span class="ident" id="5284957">p</span><span class="op" id="5284958">[</span><span class="ident" id="5284959">j</span><span class="op" id="5284960">]</span><span class="op" id="5284961">,</span>&nbsp;<span class="ident" id="5284963">p</span><span class="op" id="5284964">[</span><span class="ident" id="5284965">i</span><span class="op" id="5284966">]</span>&nbsp;<span class="op" id="5284968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5284971">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5285004">func</span>&nbsp;<span class="op" id="5285009">(</span><span class="ident" id="5285010">p</span>&nbsp;<span class="ident" id="5285012">runeSlice</span><span class="op" id="5285021">)</span>&nbsp;<span class="ident" id="5285023">Sort</span><span class="op" id="5285027">(</span><span class="op" id="5285028">)</span>&nbsp;<span class="op" id="5285030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285033">sort</span><span class="op" id="5285037">.</span><span class="ident" id="5285038">Sort</span><span class="op" id="5285042">(</span><span class="ident" id="5285043">p</span><span class="op" id="5285044">)</span><br>
<span class="lineno"></span><span class="op" id="5285046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5285049">var</span>&nbsp;<span class="ident" id="5285053">anyRuneNotNL</span>&nbsp;<span class="op" id="5285066">=</span>&nbsp;<span class="op" id="5285068">[</span><span class="op" id="5285069">]</span><span class="builtintype" id="5285070">rune</span><span class="op" id="5285074">{</span><span class="num" id="5285075">0</span><span class="op" id="5285076">,</span>&nbsp;<span class="string" id="5285078">&#39;\n&#39;</span>&nbsp;<span class="op" id="5285083">-</span>&nbsp;<span class="num" id="5285085">1</span><span class="op" id="5285086">,</span>&nbsp;<span class="string" id="5285088">&#39;\n&#39;</span>&nbsp;<span class="op" id="5285093">+</span>&nbsp;<span class="num" id="5285095">1</span><span class="op" id="5285096">,</span>&nbsp;<span class="ident" id="5285098">unicode</span><span class="op" id="5285105">.</span><span class="ident" id="5285106">MaxRune</span><span class="op" id="5285113">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5285115">var</span>&nbsp;<span class="ident" id="5285119">anyRune</span>&nbsp;<span class="op" id="5285127">=</span>&nbsp;<span class="op" id="5285129">[</span><span class="op" id="5285130">]</span><span class="builtintype" id="5285131">rune</span><span class="op" id="5285135">{</span><span class="num" id="5285136">0</span><span class="op" id="5285137">,</span>&nbsp;<span class="ident" id="5285139">unicode</span><span class="op" id="5285146">.</span><span class="ident" id="5285147">MaxRune</span><span class="op" id="5285154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5285157">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5285239">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5285320">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5285400">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5285475">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5285503">func</span>&nbsp;<span class="ident" id="5285508">makeOnePass</span><span class="op" id="5285519">(</span><span class="ident" id="5285520">p</span>&nbsp;<span class="op" id="5285522">*</span><span class="ident" id="5285523">onePassProg</span><span class="op" id="5285534">)</span>&nbsp;<span class="op" id="5285536">*</span><span class="ident" id="5285537">onePassProg</span>&nbsp;<span class="op" id="5285549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5285552">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285642">if</span>&nbsp;<span class="builtinfunc" id="5285645">len</span><span class="op" id="5285648">(</span><span class="ident" id="5285649">p</span><span class="op" id="5285650">.</span><span class="ident" id="5285651">Inst</span><span class="op" id="5285655">)</span>&nbsp;<span class="op" id="5285657">&gt;=</span>&nbsp;<span class="num" id="5285660">1000</span>&nbsp;<span class="op" id="5285665">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285669">return</span>&nbsp;<span class="ident" id="5285676">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5285688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285692">var</span>&nbsp;<span class="op" id="5285696">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285700">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5285713">=</span>&nbsp;<span class="ident" id="5285715">newQueue</span><span class="op" id="5285723">(</span><span class="builtinfunc" id="5285724">len</span><span class="op" id="5285727">(</span><span class="ident" id="5285728">p</span><span class="op" id="5285729">.</span><span class="ident" id="5285730">Inst</span><span class="op" id="5285734">)</span><span class="op" id="5285735">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285739">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5285752">=</span>&nbsp;<span class="ident" id="5285754">newQueue</span><span class="op" id="5285762">(</span><span class="builtinfunc" id="5285763">len</span><span class="op" id="5285766">(</span><span class="ident" id="5285767">p</span><span class="op" id="5285768">.</span><span class="ident" id="5285769">Inst</span><span class="op" id="5285773">)</span><span class="op" id="5285774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285778">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285791">func</span><span class="op" id="5285795">(</span><span class="builtintype" id="5285796">uint32</span><span class="op" id="5285802">,</span>&nbsp;<span class="op" id="5285804">*</span><span class="ident" id="5285805">queueOnePass</span><span class="op" id="5285817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285821">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285834">func</span><span class="op" id="5285838">(</span><span class="builtintype" id="5285839">uint32</span><span class="op" id="5285845">,</span>&nbsp;<span class="keyword" id="5285847">map</span><span class="op" id="5285850">[</span><span class="builtintype" id="5285851">uint32</span><span class="op" id="5285857">]</span><span class="builtintype" id="5285858">bool</span><span class="op" id="5285862">)</span>&nbsp;<span class="builtintype" id="5285864">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285871">onePassRunes</span>&nbsp;<span class="op" id="5285884">=</span>&nbsp;<span class="builtinfunc" id="5285886">make</span><span class="op" id="5285890">(</span><span class="op" id="5285891">[</span><span class="op" id="5285892">]</span><span class="op" id="5285893">[</span><span class="op" id="5285894">]</span><span class="builtintype" id="5285895">rune</span><span class="op" id="5285899">,</span>&nbsp;<span class="builtinfunc" id="5285901">len</span><span class="op" id="5285904">(</span><span class="ident" id="5285905">p</span><span class="op" id="5285906">.</span><span class="ident" id="5285907">Inst</span><span class="op" id="5285911">)</span><span class="op" id="5285912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5285915">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285918">build</span>&nbsp;<span class="op" id="5285924">=</span>&nbsp;<span class="keyword" id="5285926">func</span><span class="op" id="5285930">(</span><span class="ident" id="5285931">pc</span>&nbsp;<span class="builtintype" id="5285934">uint32</span><span class="op" id="5285940">,</span>&nbsp;<span class="ident" id="5285942">q</span>&nbsp;<span class="op" id="5285944">*</span><span class="ident" id="5285945">queueOnePass</span><span class="op" id="5285957">)</span>&nbsp;<span class="op" id="5285959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285963">if</span>&nbsp;<span class="ident" id="5285966">q</span><span class="op" id="5285967">.</span><span class="ident" id="5285968">contains</span><span class="op" id="5285976">(</span><span class="ident" id="5285977">pc</span><span class="op" id="5285979">)</span>&nbsp;<span class="op" id="5285981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5285986">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5285995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5285999">inst</span>&nbsp;<span class="op" id="5286004">:=</span>&nbsp;<span class="ident" id="5286007">p</span><span class="op" id="5286008">.</span><span class="ident" id="5286009">Inst</span><span class="op" id="5286013">[</span><span class="ident" id="5286014">pc</span><span class="op" id="5286016">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286020">switch</span>&nbsp;<span class="ident" id="5286027">inst</span><span class="op" id="5286031">.</span><span class="ident" id="5286032">Op</span>&nbsp;<span class="op" id="5286035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286039">case</span>&nbsp;<span class="ident" id="5286044">syntax</span><span class="op" id="5286050">.</span><span class="ident" id="5286051">InstAlt</span><span class="op" id="5286058">,</span>&nbsp;<span class="ident" id="5286060">syntax</span><span class="op" id="5286066">.</span><span class="ident" id="5286067">InstAltMatch</span><span class="op" id="5286079">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286084">q</span><span class="op" id="5286085">.</span><span class="ident" id="5286086">insert</span><span class="op" id="5286092">(</span><span class="ident" id="5286093">inst</span><span class="op" id="5286097">.</span><span class="ident" id="5286098">Out</span><span class="op" id="5286101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286106">build</span><span class="op" id="5286111">(</span><span class="ident" id="5286112">inst</span><span class="op" id="5286116">.</span><span class="ident" id="5286117">Out</span><span class="op" id="5286120">,</span>&nbsp;<span class="ident" id="5286122">q</span><span class="op" id="5286123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286128">q</span><span class="op" id="5286129">.</span><span class="ident" id="5286130">insert</span><span class="op" id="5286136">(</span><span class="ident" id="5286137">inst</span><span class="op" id="5286141">.</span><span class="ident" id="5286142">Arg</span><span class="op" id="5286145">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286149">case</span>&nbsp;<span class="ident" id="5286154">syntax</span><span class="op" id="5286160">.</span><span class="ident" id="5286161">InstMatch</span><span class="op" id="5286170">,</span>&nbsp;<span class="ident" id="5286172">syntax</span><span class="op" id="5286178">.</span><span class="ident" id="5286179">InstFail</span><span class="op" id="5286187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286191">default</span><span class="op" id="5286198">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286203">q</span><span class="op" id="5286204">.</span><span class="ident" id="5286205">insert</span><span class="op" id="5286211">(</span><span class="ident" id="5286212">inst</span><span class="op" id="5286216">.</span><span class="ident" id="5286217">Out</span><span class="op" id="5286220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286227">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286231">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286311">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286344">check</span>&nbsp;<span class="op" id="5286350">=</span>&nbsp;<span class="keyword" id="5286352">func</span><span class="op" id="5286356">(</span><span class="ident" id="5286357">pc</span>&nbsp;<span class="builtintype" id="5286360">uint32</span><span class="op" id="5286366">,</span>&nbsp;<span class="ident" id="5286368">m</span>&nbsp;<span class="keyword" id="5286370">map</span><span class="op" id="5286373">[</span><span class="builtintype" id="5286374">uint32</span><span class="op" id="5286380">]</span><span class="builtintype" id="5286381">bool</span><span class="op" id="5286385">)</span>&nbsp;<span class="op" id="5286387">(</span><span class="ident" id="5286388">ok</span>&nbsp;<span class="builtintype" id="5286391">bool</span><span class="op" id="5286395">)</span>&nbsp;<span class="op" id="5286397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286401">ok</span>&nbsp;<span class="op" id="5286404">=</span>&nbsp;<span class="builtintype" id="5286406">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286413">inst</span>&nbsp;<span class="op" id="5286418">:=</span>&nbsp;<span class="op" id="5286421">&amp;</span><span class="ident" id="5286422">p</span><span class="op" id="5286423">.</span><span class="ident" id="5286424">Inst</span><span class="op" id="5286428">[</span><span class="ident" id="5286429">pc</span><span class="op" id="5286431">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286435">if</span>&nbsp;<span class="ident" id="5286438">visitQueue</span><span class="op" id="5286448">.</span><span class="ident" id="5286449">contains</span><span class="op" id="5286457">(</span><span class="ident" id="5286458">pc</span><span class="op" id="5286460">)</span>&nbsp;<span class="op" id="5286462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286467">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286480">visitQueue</span><span class="op" id="5286490">.</span><span class="ident" id="5286491">insert</span><span class="op" id="5286497">(</span><span class="ident" id="5286498">pc</span><span class="op" id="5286500">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286504">switch</span>&nbsp;<span class="ident" id="5286511">inst</span><span class="op" id="5286515">.</span><span class="ident" id="5286516">Op</span>&nbsp;<span class="op" id="5286519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286523">case</span>&nbsp;<span class="ident" id="5286528">syntax</span><span class="op" id="5286534">.</span><span class="ident" id="5286535">InstAlt</span><span class="op" id="5286542">,</span>&nbsp;<span class="ident" id="5286544">syntax</span><span class="op" id="5286550">.</span><span class="ident" id="5286551">InstAltMatch</span><span class="op" id="5286563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286568">ok</span>&nbsp;<span class="op" id="5286571">=</span>&nbsp;<span class="ident" id="5286573">check</span><span class="op" id="5286578">(</span><span class="ident" id="5286579">inst</span><span class="op" id="5286583">.</span><span class="ident" id="5286584">Out</span><span class="op" id="5286587">,</span>&nbsp;<span class="ident" id="5286589">m</span><span class="op" id="5286590">)</span>&nbsp;<span class="op" id="5286592">&amp;&amp;</span>&nbsp;<span class="ident" id="5286595">check</span><span class="op" id="5286600">(</span><span class="ident" id="5286601">inst</span><span class="op" id="5286605">.</span><span class="ident" id="5286606">Arg</span><span class="op" id="5286609">,</span>&nbsp;<span class="ident" id="5286611">m</span><span class="op" id="5286612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286617">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286657">matchOut</span>&nbsp;<span class="op" id="5286666">:=</span>&nbsp;<span class="ident" id="5286669">m</span><span class="op" id="5286670">[</span><span class="ident" id="5286671">inst</span><span class="op" id="5286675">.</span><span class="ident" id="5286676">Out</span><span class="op" id="5286679">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286684">matchArg</span>&nbsp;<span class="op" id="5286693">:=</span>&nbsp;<span class="ident" id="5286696">m</span><span class="op" id="5286697">[</span><span class="ident" id="5286698">inst</span><span class="op" id="5286702">.</span><span class="ident" id="5286703">Arg</span><span class="op" id="5286706">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286711">if</span>&nbsp;<span class="ident" id="5286714">matchOut</span>&nbsp;<span class="op" id="5286723">&amp;&amp;</span>&nbsp;<span class="ident" id="5286726">matchArg</span>&nbsp;<span class="op" id="5286735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286741">ok</span>&nbsp;<span class="op" id="5286744">=</span>&nbsp;<span class="builtintype" id="5286746">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286756">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286765">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286770">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286808">if</span>&nbsp;<span class="ident" id="5286811">matchArg</span>&nbsp;<span class="op" id="5286820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286826">inst</span><span class="op" id="5286830">.</span><span class="ident" id="5286831">Out</span><span class="op" id="5286834">,</span>&nbsp;<span class="ident" id="5286836">inst</span><span class="op" id="5286840">.</span><span class="ident" id="5286841">Arg</span>&nbsp;<span class="op" id="5286845">=</span>&nbsp;<span class="ident" id="5286847">inst</span><span class="op" id="5286851">.</span><span class="ident" id="5286852">Arg</span><span class="op" id="5286855">,</span>&nbsp;<span class="ident" id="5286857">inst</span><span class="op" id="5286861">.</span><span class="ident" id="5286862">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286870">matchOut</span><span class="op" id="5286878">,</span>&nbsp;<span class="ident" id="5286880">matchArg</span>&nbsp;<span class="op" id="5286889">=</span>&nbsp;<span class="ident" id="5286891">matchArg</span><span class="op" id="5286899">,</span>&nbsp;<span class="ident" id="5286901">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286913">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5286918">if</span>&nbsp;<span class="ident" id="5286921">matchOut</span>&nbsp;<span class="op" id="5286930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286936">m</span><span class="op" id="5286937">[</span><span class="ident" id="5286938">pc</span><span class="op" id="5286940">]</span>&nbsp;<span class="op" id="5286942">=</span>&nbsp;<span class="builtintype" id="5286944">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5286953">inst</span><span class="op" id="5286957">.</span><span class="ident" id="5286958">Op</span>&nbsp;<span class="op" id="5286961">=</span>&nbsp;<span class="ident" id="5286963">syntax</span><span class="op" id="5286969">.</span><span class="ident" id="5286970">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5286986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5286992">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287054">onePassRunes</span><span class="op" id="5287066">[</span><span class="ident" id="5287067">pc</span><span class="op" id="5287069">]</span><span class="op" id="5287070">,</span>&nbsp;<span class="ident" id="5287072">inst</span><span class="op" id="5287076">.</span><span class="ident" id="5287077">Next</span>&nbsp;<span class="op" id="5287082">=</span>&nbsp;<span class="ident" id="5287084">mergeRuneSets</span><span class="op" id="5287097">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287103">&amp;</span><span class="ident" id="5287104">onePassRunes</span><span class="op" id="5287116">[</span><span class="ident" id="5287117">inst</span><span class="op" id="5287121">.</span><span class="ident" id="5287122">Out</span><span class="op" id="5287125">]</span><span class="op" id="5287126">,</span>&nbsp;<span class="op" id="5287128">&amp;</span><span class="ident" id="5287129">onePassRunes</span><span class="op" id="5287141">[</span><span class="ident" id="5287142">inst</span><span class="op" id="5287146">.</span><span class="ident" id="5287147">Arg</span><span class="op" id="5287150">]</span><span class="op" id="5287151">,</span>&nbsp;<span class="ident" id="5287153">inst</span><span class="op" id="5287157">.</span><span class="ident" id="5287158">Out</span><span class="op" id="5287161">,</span>&nbsp;<span class="ident" id="5287163">inst</span><span class="op" id="5287167">.</span><span class="ident" id="5287168">Arg</span><span class="op" id="5287171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287176">if</span>&nbsp;<span class="builtinfunc" id="5287179">len</span><span class="op" id="5287182">(</span><span class="ident" id="5287183">inst</span><span class="op" id="5287187">.</span><span class="ident" id="5287188">Next</span><span class="op" id="5287192">)</span>&nbsp;<span class="op" id="5287194">&gt;</span>&nbsp;<span class="num" id="5287196">0</span>&nbsp;<span class="op" id="5287198">&amp;&amp;</span>&nbsp;<span class="ident" id="5287201">inst</span><span class="op" id="5287205">.</span><span class="ident" id="5287206">Next</span><span class="op" id="5287210">[</span><span class="num" id="5287211">0</span><span class="op" id="5287212">]</span>&nbsp;<span class="op" id="5287214">==</span>&nbsp;<span class="ident" id="5287217">mergeFailed</span>&nbsp;<span class="op" id="5287229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287235">ok</span>&nbsp;<span class="op" id="5287238">=</span>&nbsp;<span class="builtintype" id="5287240">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287250">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287263">case</span>&nbsp;<span class="ident" id="5287268">syntax</span><span class="op" id="5287274">.</span><span class="ident" id="5287275">InstCapture</span><span class="op" id="5287286">,</span>&nbsp;<span class="ident" id="5287288">syntax</span><span class="op" id="5287294">.</span><span class="ident" id="5287295">InstNop</span><span class="op" id="5287302">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287307">ok</span>&nbsp;<span class="op" id="5287310">=</span>&nbsp;<span class="ident" id="5287312">check</span><span class="op" id="5287317">(</span><span class="ident" id="5287318">inst</span><span class="op" id="5287322">.</span><span class="ident" id="5287323">Out</span><span class="op" id="5287326">,</span>&nbsp;<span class="ident" id="5287328">m</span><span class="op" id="5287329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287334">m</span><span class="op" id="5287335">[</span><span class="ident" id="5287336">pc</span><span class="op" id="5287338">]</span>&nbsp;<span class="op" id="5287340">=</span>&nbsp;<span class="ident" id="5287342">m</span><span class="op" id="5287343">[</span><span class="ident" id="5287344">inst</span><span class="op" id="5287348">.</span><span class="ident" id="5287349">Out</span><span class="op" id="5287352">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5287357">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287410">onePassRunes</span><span class="op" id="5287422">[</span><span class="ident" id="5287423">pc</span><span class="op" id="5287425">]</span>&nbsp;<span class="op" id="5287427">=</span>&nbsp;<span class="builtinfunc" id="5287429">append</span><span class="op" id="5287435">(</span><span class="op" id="5287436">[</span><span class="op" id="5287437">]</span><span class="builtintype" id="5287438">rune</span><span class="op" id="5287442">{</span><span class="op" id="5287443">}</span><span class="op" id="5287444">,</span>&nbsp;<span class="ident" id="5287446">onePassRunes</span><span class="op" id="5287458">[</span><span class="ident" id="5287459">inst</span><span class="op" id="5287463">.</span><span class="ident" id="5287464">Out</span><span class="op" id="5287467">]</span><span class="op" id="5287468">...</span><span class="op" id="5287471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287476">inst</span><span class="op" id="5287480">.</span><span class="ident" id="5287481">Next</span>&nbsp;<span class="op" id="5287486">=</span>&nbsp;<span class="op" id="5287488">[</span><span class="op" id="5287489">]</span><span class="builtintype" id="5287490">uint32</span><span class="op" id="5287496">{</span><span class="op" id="5287497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287502">for</span>&nbsp;<span class="ident" id="5287506">i</span>&nbsp;<span class="op" id="5287508">:=</span>&nbsp;<span class="builtinfunc" id="5287511">len</span><span class="op" id="5287514">(</span><span class="ident" id="5287515">onePassRunes</span><span class="op" id="5287527">[</span><span class="ident" id="5287528">pc</span><span class="op" id="5287530">]</span><span class="op" id="5287531">)</span>&nbsp;<span class="op" id="5287533">/</span>&nbsp;<span class="num" id="5287535">2</span><span class="op" id="5287536">;</span>&nbsp;<span class="ident" id="5287538">i</span>&nbsp;<span class="op" id="5287540">&gt;=</span>&nbsp;<span class="num" id="5287543">0</span><span class="op" id="5287544">;</span>&nbsp;<span class="ident" id="5287546">i</span><span class="op" id="5287547">--</span>&nbsp;<span class="op" id="5287550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287556">inst</span><span class="op" id="5287560">.</span><span class="ident" id="5287561">Next</span>&nbsp;<span class="op" id="5287566">=</span>&nbsp;<span class="builtinfunc" id="5287568">append</span><span class="op" id="5287574">(</span><span class="ident" id="5287575">inst</span><span class="op" id="5287579">.</span><span class="ident" id="5287580">Next</span><span class="op" id="5287584">,</span>&nbsp;<span class="ident" id="5287586">inst</span><span class="op" id="5287590">.</span><span class="ident" id="5287591">Out</span><span class="op" id="5287594">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287603">case</span>&nbsp;<span class="ident" id="5287608">syntax</span><span class="op" id="5287614">.</span><span class="ident" id="5287615">InstEmptyWidth</span><span class="op" id="5287629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287634">ok</span>&nbsp;<span class="op" id="5287637">=</span>&nbsp;<span class="ident" id="5287639">check</span><span class="op" id="5287644">(</span><span class="ident" id="5287645">inst</span><span class="op" id="5287649">.</span><span class="ident" id="5287650">Out</span><span class="op" id="5287653">,</span>&nbsp;<span class="ident" id="5287655">m</span><span class="op" id="5287656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287661">m</span><span class="op" id="5287662">[</span><span class="ident" id="5287663">pc</span><span class="op" id="5287665">]</span>&nbsp;<span class="op" id="5287667">=</span>&nbsp;<span class="ident" id="5287669">m</span><span class="op" id="5287670">[</span><span class="ident" id="5287671">inst</span><span class="op" id="5287675">.</span><span class="ident" id="5287676">Out</span><span class="op" id="5287679">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287684">onePassRunes</span><span class="op" id="5287696">[</span><span class="ident" id="5287697">pc</span><span class="op" id="5287699">]</span>&nbsp;<span class="op" id="5287701">=</span>&nbsp;<span class="builtinfunc" id="5287703">append</span><span class="op" id="5287709">(</span><span class="op" id="5287710">[</span><span class="op" id="5287711">]</span><span class="builtintype" id="5287712">rune</span><span class="op" id="5287716">{</span><span class="op" id="5287717">}</span><span class="op" id="5287718">,</span>&nbsp;<span class="ident" id="5287720">onePassRunes</span><span class="op" id="5287732">[</span><span class="ident" id="5287733">inst</span><span class="op" id="5287737">.</span><span class="ident" id="5287738">Out</span><span class="op" id="5287741">]</span><span class="op" id="5287742">...</span><span class="op" id="5287745">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287750">inst</span><span class="op" id="5287754">.</span><span class="ident" id="5287755">Next</span>&nbsp;<span class="op" id="5287760">=</span>&nbsp;<span class="op" id="5287762">[</span><span class="op" id="5287763">]</span><span class="builtintype" id="5287764">uint32</span><span class="op" id="5287770">{</span><span class="op" id="5287771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287776">for</span>&nbsp;<span class="ident" id="5287780">i</span>&nbsp;<span class="op" id="5287782">:=</span>&nbsp;<span class="builtinfunc" id="5287785">len</span><span class="op" id="5287788">(</span><span class="ident" id="5287789">onePassRunes</span><span class="op" id="5287801">[</span><span class="ident" id="5287802">pc</span><span class="op" id="5287804">]</span><span class="op" id="5287805">)</span>&nbsp;<span class="op" id="5287807">/</span>&nbsp;<span class="num" id="5287809">2</span><span class="op" id="5287810">;</span>&nbsp;<span class="ident" id="5287812">i</span>&nbsp;<span class="op" id="5287814">&gt;=</span>&nbsp;<span class="num" id="5287817">0</span><span class="op" id="5287818">;</span>&nbsp;<span class="ident" id="5287820">i</span><span class="op" id="5287821">--</span>&nbsp;<span class="op" id="5287824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287830">inst</span><span class="op" id="5287834">.</span><span class="ident" id="5287835">Next</span>&nbsp;<span class="op" id="5287840">=</span>&nbsp;<span class="builtinfunc" id="5287842">append</span><span class="op" id="5287848">(</span><span class="ident" id="5287849">inst</span><span class="op" id="5287853">.</span><span class="ident" id="5287854">Next</span><span class="op" id="5287858">,</span>&nbsp;<span class="ident" id="5287860">inst</span><span class="op" id="5287864">.</span><span class="ident" id="5287865">Out</span><span class="op" id="5287868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5287873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287877">case</span>&nbsp;<span class="ident" id="5287882">syntax</span><span class="op" id="5287888">.</span><span class="ident" id="5287889">InstMatch</span><span class="op" id="5287898">,</span>&nbsp;<span class="ident" id="5287900">syntax</span><span class="op" id="5287906">.</span><span class="ident" id="5287907">InstFail</span><span class="op" id="5287915">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287920">m</span><span class="op" id="5287921">[</span><span class="ident" id="5287922">pc</span><span class="op" id="5287924">]</span>&nbsp;<span class="op" id="5287926">=</span>&nbsp;<span class="ident" id="5287928">inst</span><span class="op" id="5287932">.</span><span class="ident" id="5287933">Op</span>&nbsp;<span class="op" id="5287936">==</span>&nbsp;<span class="ident" id="5287939">syntax</span><span class="op" id="5287945">.</span><span class="ident" id="5287946">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287959">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5287967">case</span>&nbsp;<span class="ident" id="5287972">syntax</span><span class="op" id="5287978">.</span><span class="ident" id="5287979">InstRune</span><span class="op" id="5287987">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5287992">ok</span>&nbsp;<span class="op" id="5287995">=</span>&nbsp;<span class="ident" id="5287997">check</span><span class="op" id="5288002">(</span><span class="ident" id="5288003">inst</span><span class="op" id="5288007">.</span><span class="ident" id="5288008">Out</span><span class="op" id="5288011">,</span>&nbsp;<span class="ident" id="5288013">m</span><span class="op" id="5288014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288019">m</span><span class="op" id="5288020">[</span><span class="ident" id="5288021">pc</span><span class="op" id="5288023">]</span>&nbsp;<span class="op" id="5288025">=</span>&nbsp;<span class="builtintype" id="5288027">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288036">if</span>&nbsp;<span class="builtinfunc" id="5288039">len</span><span class="op" id="5288042">(</span><span class="ident" id="5288043">inst</span><span class="op" id="5288047">.</span><span class="ident" id="5288048">Next</span><span class="op" id="5288052">)</span>&nbsp;<span class="op" id="5288054">&gt;</span>&nbsp;<span class="num" id="5288056">0</span>&nbsp;<span class="op" id="5288058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288064">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288078">if</span>&nbsp;<span class="builtinfunc" id="5288081">len</span><span class="op" id="5288084">(</span><span class="ident" id="5288085">inst</span><span class="op" id="5288089">.</span><span class="ident" id="5288090">Rune</span><span class="op" id="5288094">)</span>&nbsp;<span class="op" id="5288096">==</span>&nbsp;<span class="num" id="5288099">0</span>&nbsp;<span class="op" id="5288101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288107">onePassRunes</span><span class="op" id="5288119">[</span><span class="ident" id="5288120">pc</span><span class="op" id="5288122">]</span>&nbsp;<span class="op" id="5288124">=</span>&nbsp;<span class="op" id="5288126">[</span><span class="op" id="5288127">]</span><span class="builtintype" id="5288128">rune</span><span class="op" id="5288132">{</span><span class="op" id="5288133">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288139">inst</span><span class="op" id="5288143">.</span><span class="ident" id="5288144">Next</span>&nbsp;<span class="op" id="5288149">=</span>&nbsp;<span class="op" id="5288151">[</span><span class="op" id="5288152">]</span><span class="builtintype" id="5288153">uint32</span><span class="op" id="5288159">{</span><span class="ident" id="5288160">inst</span><span class="op" id="5288164">.</span><span class="ident" id="5288165">Out</span><span class="op" id="5288168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288174">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288188">runes</span>&nbsp;<span class="op" id="5288194">:=</span>&nbsp;<span class="builtinfunc" id="5288197">make</span><span class="op" id="5288201">(</span><span class="op" id="5288202">[</span><span class="op" id="5288203">]</span><span class="builtintype" id="5288204">rune</span><span class="op" id="5288208">,</span>&nbsp;<span class="num" id="5288210">0</span><span class="op" id="5288211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288216">if</span>&nbsp;<span class="builtinfunc" id="5288219">len</span><span class="op" id="5288222">(</span><span class="ident" id="5288223">inst</span><span class="op" id="5288227">.</span><span class="ident" id="5288228">Rune</span><span class="op" id="5288232">)</span>&nbsp;<span class="op" id="5288234">==</span>&nbsp;<span class="num" id="5288237">1</span>&nbsp;<span class="op" id="5288239">&amp;&amp;</span>&nbsp;<span class="ident" id="5288242">syntax</span><span class="op" id="5288248">.</span><span class="ident" id="5288249">Flags</span><span class="op" id="5288254">(</span><span class="ident" id="5288255">inst</span><span class="op" id="5288259">.</span><span class="ident" id="5288260">Arg</span><span class="op" id="5288263">)</span><span class="op" id="5288264">&amp;</span><span class="ident" id="5288265">syntax</span><span class="op" id="5288271">.</span><span class="ident" id="5288272">FoldCase</span>&nbsp;<span class="op" id="5288281">!=</span>&nbsp;<span class="num" id="5288284">0</span>&nbsp;<span class="op" id="5288286">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288292">r0</span>&nbsp;<span class="op" id="5288295">:=</span>&nbsp;<span class="ident" id="5288298">inst</span><span class="op" id="5288302">.</span><span class="ident" id="5288303">Rune</span><span class="op" id="5288307">[</span><span class="num" id="5288308">0</span><span class="op" id="5288309">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288315">runes</span>&nbsp;<span class="op" id="5288321">=</span>&nbsp;<span class="builtinfunc" id="5288323">append</span><span class="op" id="5288329">(</span><span class="ident" id="5288330">runes</span><span class="op" id="5288335">,</span>&nbsp;<span class="ident" id="5288337">r0</span><span class="op" id="5288339">,</span>&nbsp;<span class="ident" id="5288341">r0</span><span class="op" id="5288343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288349">for</span>&nbsp;<span class="ident" id="5288353">r1</span>&nbsp;<span class="op" id="5288356">:=</span>&nbsp;<span class="ident" id="5288359">unicode</span><span class="op" id="5288366">.</span><span class="ident" id="5288367">SimpleFold</span><span class="op" id="5288377">(</span><span class="ident" id="5288378">r0</span><span class="op" id="5288380">)</span><span class="op" id="5288381">;</span>&nbsp;<span class="ident" id="5288383">r1</span>&nbsp;<span class="op" id="5288386">!=</span>&nbsp;<span class="ident" id="5288389">r0</span><span class="op" id="5288391">;</span>&nbsp;<span class="ident" id="5288393">r1</span>&nbsp;<span class="op" id="5288396">=</span>&nbsp;<span class="ident" id="5288398">unicode</span><span class="op" id="5288405">.</span><span class="ident" id="5288406">SimpleFold</span><span class="op" id="5288416">(</span><span class="ident" id="5288417">r1</span><span class="op" id="5288419">)</span>&nbsp;<span class="op" id="5288421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288428">runes</span>&nbsp;<span class="op" id="5288434">=</span>&nbsp;<span class="builtinfunc" id="5288436">append</span><span class="op" id="5288442">(</span><span class="ident" id="5288443">runes</span><span class="op" id="5288448">,</span>&nbsp;<span class="ident" id="5288450">r1</span><span class="op" id="5288452">,</span>&nbsp;<span class="ident" id="5288454">r1</span><span class="op" id="5288456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288462">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288468">sort</span><span class="op" id="5288472">.</span><span class="ident" id="5288473">Sort</span><span class="op" id="5288477">(</span><span class="ident" id="5288478">runeSlice</span><span class="op" id="5288487">(</span><span class="ident" id="5288488">runes</span><span class="op" id="5288493">)</span><span class="op" id="5288494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288499">}</span>&nbsp;<span class="keyword" id="5288501">else</span>&nbsp;<span class="op" id="5288506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288512">runes</span>&nbsp;<span class="op" id="5288518">=</span>&nbsp;<span class="builtinfunc" id="5288520">append</span><span class="op" id="5288526">(</span><span class="ident" id="5288527">runes</span><span class="op" id="5288532">,</span>&nbsp;<span class="ident" id="5288534">inst</span><span class="op" id="5288538">.</span><span class="ident" id="5288539">Rune</span><span class="op" id="5288543">...</span><span class="op" id="5288546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288556">onePassRunes</span><span class="op" id="5288568">[</span><span class="ident" id="5288569">pc</span><span class="op" id="5288571">]</span>&nbsp;<span class="op" id="5288573">=</span>&nbsp;<span class="ident" id="5288575">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288584">inst</span><span class="op" id="5288588">.</span><span class="ident" id="5288589">Next</span>&nbsp;<span class="op" id="5288594">=</span>&nbsp;<span class="op" id="5288596">[</span><span class="op" id="5288597">]</span><span class="builtintype" id="5288598">uint32</span><span class="op" id="5288604">{</span><span class="op" id="5288605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288610">for</span>&nbsp;<span class="ident" id="5288614">i</span>&nbsp;<span class="op" id="5288616">:=</span>&nbsp;<span class="builtinfunc" id="5288619">len</span><span class="op" id="5288622">(</span><span class="ident" id="5288623">onePassRunes</span><span class="op" id="5288635">[</span><span class="ident" id="5288636">pc</span><span class="op" id="5288638">]</span><span class="op" id="5288639">)</span>&nbsp;<span class="op" id="5288641">/</span>&nbsp;<span class="num" id="5288643">2</span><span class="op" id="5288644">;</span>&nbsp;<span class="ident" id="5288646">i</span>&nbsp;<span class="op" id="5288648">&gt;=</span>&nbsp;<span class="num" id="5288651">0</span><span class="op" id="5288652">;</span>&nbsp;<span class="ident" id="5288654">i</span><span class="op" id="5288655">--</span>&nbsp;<span class="op" id="5288658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288664">inst</span><span class="op" id="5288668">.</span><span class="ident" id="5288669">Next</span>&nbsp;<span class="op" id="5288674">=</span>&nbsp;<span class="builtinfunc" id="5288676">append</span><span class="op" id="5288682">(</span><span class="ident" id="5288683">inst</span><span class="op" id="5288687">.</span><span class="ident" id="5288688">Next</span><span class="op" id="5288692">,</span>&nbsp;<span class="ident" id="5288694">inst</span><span class="op" id="5288698">.</span><span class="ident" id="5288699">Out</span><span class="op" id="5288702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288712">inst</span><span class="op" id="5288716">.</span><span class="ident" id="5288717">Op</span>&nbsp;<span class="op" id="5288720">=</span>&nbsp;<span class="ident" id="5288722">syntax</span><span class="op" id="5288728">.</span><span class="ident" id="5288729">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288740">case</span>&nbsp;<span class="ident" id="5288745">syntax</span><span class="op" id="5288751">.</span><span class="ident" id="5288752">InstRune1</span><span class="op" id="5288761">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288766">ok</span>&nbsp;<span class="op" id="5288769">=</span>&nbsp;<span class="ident" id="5288771">check</span><span class="op" id="5288776">(</span><span class="ident" id="5288777">inst</span><span class="op" id="5288781">.</span><span class="ident" id="5288782">Out</span><span class="op" id="5288785">,</span>&nbsp;<span class="ident" id="5288787">m</span><span class="op" id="5288788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288793">m</span><span class="op" id="5288794">[</span><span class="ident" id="5288795">pc</span><span class="op" id="5288797">]</span>&nbsp;<span class="op" id="5288799">=</span>&nbsp;<span class="builtintype" id="5288801">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288810">if</span>&nbsp;<span class="builtinfunc" id="5288813">len</span><span class="op" id="5288816">(</span><span class="ident" id="5288817">inst</span><span class="op" id="5288821">.</span><span class="ident" id="5288822">Next</span><span class="op" id="5288826">)</span>&nbsp;<span class="op" id="5288828">&gt;</span>&nbsp;<span class="num" id="5288830">0</span>&nbsp;<span class="op" id="5288832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288838">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5288847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288852">runes</span>&nbsp;<span class="op" id="5288858">:=</span>&nbsp;<span class="op" id="5288861">[</span><span class="op" id="5288862">]</span><span class="builtintype" id="5288863">rune</span><span class="op" id="5288867">{</span><span class="op" id="5288868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5288873">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5288904">if</span>&nbsp;<span class="ident" id="5288907">syntax</span><span class="op" id="5288913">.</span><span class="ident" id="5288914">Flags</span><span class="op" id="5288919">(</span><span class="ident" id="5288920">inst</span><span class="op" id="5288924">.</span><span class="ident" id="5288925">Arg</span><span class="op" id="5288928">)</span><span class="op" id="5288929">&amp;</span><span class="ident" id="5288930">syntax</span><span class="op" id="5288936">.</span><span class="ident" id="5288937">FoldCase</span>&nbsp;<span class="op" id="5288946">!=</span>&nbsp;<span class="num" id="5288949">0</span>&nbsp;<span class="op" id="5288951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288957">r0</span>&nbsp;<span class="op" id="5288960">:=</span>&nbsp;<span class="ident" id="5288963">inst</span><span class="op" id="5288967">.</span><span class="ident" id="5288968">Rune</span><span class="op" id="5288972">[</span><span class="num" id="5288973">0</span><span class="op" id="5288974">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5288980">runes</span>&nbsp;<span class="op" id="5288986">=</span>&nbsp;<span class="builtinfunc" id="5288988">append</span><span class="op" id="5288994">(</span><span class="ident" id="5288995">runes</span><span class="op" id="5289000">,</span>&nbsp;<span class="ident" id="5289002">r0</span><span class="op" id="5289004">,</span>&nbsp;<span class="ident" id="5289006">r0</span><span class="op" id="5289008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289014">for</span>&nbsp;<span class="ident" id="5289018">r1</span>&nbsp;<span class="op" id="5289021">:=</span>&nbsp;<span class="ident" id="5289024">unicode</span><span class="op" id="5289031">.</span><span class="ident" id="5289032">SimpleFold</span><span class="op" id="5289042">(</span><span class="ident" id="5289043">r0</span><span class="op" id="5289045">)</span><span class="op" id="5289046">;</span>&nbsp;<span class="ident" id="5289048">r1</span>&nbsp;<span class="op" id="5289051">!=</span>&nbsp;<span class="ident" id="5289054">r0</span><span class="op" id="5289056">;</span>&nbsp;<span class="ident" id="5289058">r1</span>&nbsp;<span class="op" id="5289061">=</span>&nbsp;<span class="ident" id="5289063">unicode</span><span class="op" id="5289070">.</span><span class="ident" id="5289071">SimpleFold</span><span class="op" id="5289081">(</span><span class="ident" id="5289082">r1</span><span class="op" id="5289084">)</span>&nbsp;<span class="op" id="5289086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289093">runes</span>&nbsp;<span class="op" id="5289099">=</span>&nbsp;<span class="builtinfunc" id="5289101">append</span><span class="op" id="5289107">(</span><span class="ident" id="5289108">runes</span><span class="op" id="5289113">,</span>&nbsp;<span class="ident" id="5289115">r1</span><span class="op" id="5289117">,</span>&nbsp;<span class="ident" id="5289119">r1</span><span class="op" id="5289121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289133">sort</span><span class="op" id="5289137">.</span><span class="ident" id="5289138">Sort</span><span class="op" id="5289142">(</span><span class="ident" id="5289143">runeSlice</span><span class="op" id="5289152">(</span><span class="ident" id="5289153">runes</span><span class="op" id="5289158">)</span><span class="op" id="5289159">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289164">}</span>&nbsp;<span class="keyword" id="5289166">else</span>&nbsp;<span class="op" id="5289171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289177">runes</span>&nbsp;<span class="op" id="5289183">=</span>&nbsp;<span class="builtinfunc" id="5289185">append</span><span class="op" id="5289191">(</span><span class="ident" id="5289192">runes</span><span class="op" id="5289197">,</span>&nbsp;<span class="ident" id="5289199">inst</span><span class="op" id="5289203">.</span><span class="ident" id="5289204">Rune</span><span class="op" id="5289208">[</span><span class="num" id="5289209">0</span><span class="op" id="5289210">]</span><span class="op" id="5289211">,</span>&nbsp;<span class="ident" id="5289213">inst</span><span class="op" id="5289217">.</span><span class="ident" id="5289218">Rune</span><span class="op" id="5289222">[</span><span class="num" id="5289223">0</span><span class="op" id="5289224">]</span><span class="op" id="5289225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289235">onePassRunes</span><span class="op" id="5289247">[</span><span class="ident" id="5289248">pc</span><span class="op" id="5289250">]</span>&nbsp;<span class="op" id="5289252">=</span>&nbsp;<span class="ident" id="5289254">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289263">inst</span><span class="op" id="5289267">.</span><span class="ident" id="5289268">Next</span>&nbsp;<span class="op" id="5289273">=</span>&nbsp;<span class="op" id="5289275">[</span><span class="op" id="5289276">]</span><span class="builtintype" id="5289277">uint32</span><span class="op" id="5289283">{</span><span class="op" id="5289284">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289289">for</span>&nbsp;<span class="ident" id="5289293">i</span>&nbsp;<span class="op" id="5289295">:=</span>&nbsp;<span class="builtinfunc" id="5289298">len</span><span class="op" id="5289301">(</span><span class="ident" id="5289302">onePassRunes</span><span class="op" id="5289314">[</span><span class="ident" id="5289315">pc</span><span class="op" id="5289317">]</span><span class="op" id="5289318">)</span>&nbsp;<span class="op" id="5289320">/</span>&nbsp;<span class="num" id="5289322">2</span><span class="op" id="5289323">;</span>&nbsp;<span class="ident" id="5289325">i</span>&nbsp;<span class="op" id="5289327">&gt;=</span>&nbsp;<span class="num" id="5289330">0</span><span class="op" id="5289331">;</span>&nbsp;<span class="ident" id="5289333">i</span><span class="op" id="5289334">--</span>&nbsp;<span class="op" id="5289337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289343">inst</span><span class="op" id="5289347">.</span><span class="ident" id="5289348">Next</span>&nbsp;<span class="op" id="5289353">=</span>&nbsp;<span class="builtinfunc" id="5289355">append</span><span class="op" id="5289361">(</span><span class="ident" id="5289362">inst</span><span class="op" id="5289366">.</span><span class="ident" id="5289367">Next</span><span class="op" id="5289371">,</span>&nbsp;<span class="ident" id="5289373">inst</span><span class="op" id="5289377">.</span><span class="ident" id="5289378">Out</span><span class="op" id="5289381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289391">inst</span><span class="op" id="5289395">.</span><span class="ident" id="5289396">Op</span>&nbsp;<span class="op" id="5289399">=</span>&nbsp;<span class="ident" id="5289401">syntax</span><span class="op" id="5289407">.</span><span class="ident" id="5289408">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289419">case</span>&nbsp;<span class="ident" id="5289424">syntax</span><span class="op" id="5289430">.</span><span class="ident" id="5289431">InstRuneAny</span><span class="op" id="5289442">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289447">ok</span>&nbsp;<span class="op" id="5289450">=</span>&nbsp;<span class="ident" id="5289452">check</span><span class="op" id="5289457">(</span><span class="ident" id="5289458">inst</span><span class="op" id="5289462">.</span><span class="ident" id="5289463">Out</span><span class="op" id="5289466">,</span>&nbsp;<span class="ident" id="5289468">m</span><span class="op" id="5289469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289474">m</span><span class="op" id="5289475">[</span><span class="ident" id="5289476">pc</span><span class="op" id="5289478">]</span>&nbsp;<span class="op" id="5289480">=</span>&nbsp;<span class="builtintype" id="5289482">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289491">if</span>&nbsp;<span class="builtinfunc" id="5289494">len</span><span class="op" id="5289497">(</span><span class="ident" id="5289498">inst</span><span class="op" id="5289502">.</span><span class="ident" id="5289503">Next</span><span class="op" id="5289507">)</span>&nbsp;<span class="op" id="5289509">&gt;</span>&nbsp;<span class="num" id="5289511">0</span>&nbsp;<span class="op" id="5289513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289519">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289528">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289533">onePassRunes</span><span class="op" id="5289545">[</span><span class="ident" id="5289546">pc</span><span class="op" id="5289548">]</span>&nbsp;<span class="op" id="5289550">=</span>&nbsp;<span class="builtinfunc" id="5289552">append</span><span class="op" id="5289558">(</span><span class="op" id="5289559">[</span><span class="op" id="5289560">]</span><span class="builtintype" id="5289561">rune</span><span class="op" id="5289565">{</span><span class="op" id="5289566">}</span><span class="op" id="5289567">,</span>&nbsp;<span class="ident" id="5289569">anyRune</span><span class="op" id="5289576">...</span><span class="op" id="5289579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289584">inst</span><span class="op" id="5289588">.</span><span class="ident" id="5289589">Next</span>&nbsp;<span class="op" id="5289594">=</span>&nbsp;<span class="op" id="5289596">[</span><span class="op" id="5289597">]</span><span class="builtintype" id="5289598">uint32</span><span class="op" id="5289604">{</span><span class="ident" id="5289605">inst</span><span class="op" id="5289609">.</span><span class="ident" id="5289610">Out</span><span class="op" id="5289613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289617">case</span>&nbsp;<span class="ident" id="5289622">syntax</span><span class="op" id="5289628">.</span><span class="ident" id="5289629">InstRuneAnyNotNL</span><span class="op" id="5289645">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289650">ok</span>&nbsp;<span class="op" id="5289653">=</span>&nbsp;<span class="ident" id="5289655">check</span><span class="op" id="5289660">(</span><span class="ident" id="5289661">inst</span><span class="op" id="5289665">.</span><span class="ident" id="5289666">Out</span><span class="op" id="5289669">,</span>&nbsp;<span class="ident" id="5289671">m</span><span class="op" id="5289672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289677">m</span><span class="op" id="5289678">[</span><span class="ident" id="5289679">pc</span><span class="op" id="5289681">]</span>&nbsp;<span class="op" id="5289683">=</span>&nbsp;<span class="builtintype" id="5289685">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289694">if</span>&nbsp;<span class="builtinfunc" id="5289697">len</span><span class="op" id="5289700">(</span><span class="ident" id="5289701">inst</span><span class="op" id="5289705">.</span><span class="ident" id="5289706">Next</span><span class="op" id="5289710">)</span>&nbsp;<span class="op" id="5289712">&gt;</span>&nbsp;<span class="num" id="5289714">0</span>&nbsp;<span class="op" id="5289716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289722">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289736">onePassRunes</span><span class="op" id="5289748">[</span><span class="ident" id="5289749">pc</span><span class="op" id="5289751">]</span>&nbsp;<span class="op" id="5289753">=</span>&nbsp;<span class="builtinfunc" id="5289755">append</span><span class="op" id="5289761">(</span><span class="op" id="5289762">[</span><span class="op" id="5289763">]</span><span class="builtintype" id="5289764">rune</span><span class="op" id="5289768">{</span><span class="op" id="5289769">}</span><span class="op" id="5289770">,</span>&nbsp;<span class="ident" id="5289772">anyRuneNotNL</span><span class="op" id="5289784">...</span><span class="op" id="5289787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289792">inst</span><span class="op" id="5289796">.</span><span class="ident" id="5289797">Next</span>&nbsp;<span class="op" id="5289802">=</span>&nbsp;<span class="op" id="5289804">[</span><span class="op" id="5289805">]</span><span class="builtintype" id="5289806">uint32</span><span class="op" id="5289812">{</span><span class="op" id="5289813">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289818">for</span>&nbsp;<span class="ident" id="5289822">i</span>&nbsp;<span class="op" id="5289824">:=</span>&nbsp;<span class="builtinfunc" id="5289827">len</span><span class="op" id="5289830">(</span><span class="ident" id="5289831">onePassRunes</span><span class="op" id="5289843">[</span><span class="ident" id="5289844">pc</span><span class="op" id="5289846">]</span><span class="op" id="5289847">)</span>&nbsp;<span class="op" id="5289849">/</span>&nbsp;<span class="num" id="5289851">2</span><span class="op" id="5289852">;</span>&nbsp;<span class="ident" id="5289854">i</span>&nbsp;<span class="op" id="5289856">&gt;=</span>&nbsp;<span class="num" id="5289859">0</span><span class="op" id="5289860">;</span>&nbsp;<span class="ident" id="5289862">i</span><span class="op" id="5289863">--</span>&nbsp;<span class="op" id="5289866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289872">inst</span><span class="op" id="5289876">.</span><span class="ident" id="5289877">Next</span>&nbsp;<span class="op" id="5289882">=</span>&nbsp;<span class="builtinfunc" id="5289884">append</span><span class="op" id="5289890">(</span><span class="ident" id="5289891">inst</span><span class="op" id="5289895">.</span><span class="ident" id="5289896">Next</span><span class="op" id="5289900">,</span>&nbsp;<span class="ident" id="5289902">inst</span><span class="op" id="5289906">.</span><span class="ident" id="5289907">Out</span><span class="op" id="5289910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5289923">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5289931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289935">instQueue</span><span class="op" id="5289944">.</span><span class="ident" id="5289945">clear</span><span class="op" id="5289950">(</span><span class="op" id="5289951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289954">instQueue</span><span class="op" id="5289963">.</span><span class="ident" id="5289964">insert</span><span class="op" id="5289970">(</span><span class="builtintype" id="5289971">uint32</span><span class="op" id="5289977">(</span><span class="ident" id="5289978">p</span><span class="op" id="5289979">.</span><span class="ident" id="5289980">Start</span><span class="op" id="5289985">)</span><span class="op" id="5289986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5289989">m</span>&nbsp;<span class="op" id="5289991">:=</span>&nbsp;<span class="builtinfunc" id="5289994">make</span><span class="op" id="5289998">(</span><span class="keyword" id="5289999">map</span><span class="op" id="5290002">[</span><span class="builtintype" id="5290003">uint32</span><span class="op" id="5290009">]</span><span class="builtintype" id="5290010">bool</span><span class="op" id="5290014">,</span>&nbsp;<span class="builtinfunc" id="5290016">len</span><span class="op" id="5290019">(</span><span class="ident" id="5290020">p</span><span class="op" id="5290021">.</span><span class="ident" id="5290022">Inst</span><span class="op" id="5290026">)</span><span class="op" id="5290027">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290030">for</span>&nbsp;<span class="op" id="5290034">!</span><span class="ident" id="5290035">instQueue</span><span class="op" id="5290044">.</span><span class="ident" id="5290045">empty</span><span class="op" id="5290050">(</span><span class="op" id="5290051">)</span>&nbsp;<span class="op" id="5290053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290057">pc</span>&nbsp;<span class="op" id="5290060">:=</span>&nbsp;<span class="ident" id="5290063">instQueue</span><span class="op" id="5290072">.</span><span class="ident" id="5290073">next</span><span class="op" id="5290077">(</span><span class="op" id="5290078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290082">inst</span>&nbsp;<span class="op" id="5290087">:=</span>&nbsp;<span class="ident" id="5290090">p</span><span class="op" id="5290091">.</span><span class="ident" id="5290092">Inst</span><span class="op" id="5290096">[</span><span class="ident" id="5290097">pc</span><span class="op" id="5290099">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290103">visitQueue</span><span class="op" id="5290113">.</span><span class="ident" id="5290114">clear</span><span class="op" id="5290119">(</span><span class="op" id="5290120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290124">if</span>&nbsp;<span class="op" id="5290127">!</span><span class="ident" id="5290128">check</span><span class="op" id="5290133">(</span><span class="builtintype" id="5290134">uint32</span><span class="op" id="5290140">(</span><span class="ident" id="5290141">pc</span><span class="op" id="5290143">)</span><span class="op" id="5290144">,</span>&nbsp;<span class="ident" id="5290146">m</span><span class="op" id="5290147">)</span>&nbsp;<span class="op" id="5290149">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290154">p</span>&nbsp;<span class="op" id="5290156">=</span>&nbsp;<span class="ident" id="5290158">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290172">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290184">switch</span>&nbsp;<span class="ident" id="5290191">inst</span><span class="op" id="5290195">.</span><span class="ident" id="5290196">Op</span>&nbsp;<span class="op" id="5290199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290203">case</span>&nbsp;<span class="ident" id="5290208">syntax</span><span class="op" id="5290214">.</span><span class="ident" id="5290215">InstAlt</span><span class="op" id="5290222">,</span>&nbsp;<span class="ident" id="5290224">syntax</span><span class="op" id="5290230">.</span><span class="ident" id="5290231">InstAltMatch</span><span class="op" id="5290243">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290248">instQueue</span><span class="op" id="5290257">.</span><span class="ident" id="5290258">insert</span><span class="op" id="5290264">(</span><span class="ident" id="5290265">inst</span><span class="op" id="5290269">.</span><span class="ident" id="5290270">Out</span><span class="op" id="5290273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290278">instQueue</span><span class="op" id="5290287">.</span><span class="ident" id="5290288">insert</span><span class="op" id="5290294">(</span><span class="ident" id="5290295">inst</span><span class="op" id="5290299">.</span><span class="ident" id="5290300">Arg</span><span class="op" id="5290303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290307">case</span>&nbsp;<span class="ident" id="5290312">syntax</span><span class="op" id="5290318">.</span><span class="ident" id="5290319">InstCapture</span><span class="op" id="5290330">,</span>&nbsp;<span class="ident" id="5290332">syntax</span><span class="op" id="5290338">.</span><span class="ident" id="5290339">InstEmptyWidth</span><span class="op" id="5290353">,</span>&nbsp;<span class="ident" id="5290355">syntax</span><span class="op" id="5290361">.</span><span class="ident" id="5290362">InstNop</span><span class="op" id="5290369">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290374">instQueue</span><span class="op" id="5290383">.</span><span class="ident" id="5290384">insert</span><span class="op" id="5290390">(</span><span class="ident" id="5290391">inst</span><span class="op" id="5290395">.</span><span class="ident" id="5290396">Out</span><span class="op" id="5290399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290403">case</span>&nbsp;<span class="ident" id="5290408">syntax</span><span class="op" id="5290414">.</span><span class="ident" id="5290415">InstMatch</span><span class="op" id="5290424">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290428">case</span>&nbsp;<span class="ident" id="5290433">syntax</span><span class="op" id="5290439">.</span><span class="ident" id="5290440">InstFail</span><span class="op" id="5290448">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290452">case</span>&nbsp;<span class="ident" id="5290457">syntax</span><span class="op" id="5290463">.</span><span class="ident" id="5290464">InstRune</span><span class="op" id="5290472">,</span>&nbsp;<span class="ident" id="5290474">syntax</span><span class="op" id="5290480">.</span><span class="ident" id="5290481">InstRune1</span><span class="op" id="5290490">,</span>&nbsp;<span class="ident" id="5290492">syntax</span><span class="op" id="5290498">.</span><span class="ident" id="5290499">InstRuneAny</span><span class="op" id="5290510">,</span>&nbsp;<span class="ident" id="5290512">syntax</span><span class="op" id="5290518">.</span><span class="ident" id="5290519">InstRuneAnyNotNL</span><span class="op" id="5290535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290539">default</span><span class="op" id="5290546">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290553">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290556">if</span>&nbsp;<span class="ident" id="5290559">p</span>&nbsp;<span class="op" id="5290561">!=</span>&nbsp;<span class="ident" id="5290564">notOnePass</span>&nbsp;<span class="op" id="5290575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290579">for</span>&nbsp;<span class="ident" id="5290583">i</span>&nbsp;<span class="op" id="5290585">:=</span>&nbsp;<span class="keyword" id="5290588">range</span>&nbsp;<span class="ident" id="5290594">p</span><span class="op" id="5290595">.</span><span class="ident" id="5290596">Inst</span>&nbsp;<span class="op" id="5290601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290606">p</span><span class="op" id="5290607">.</span><span class="ident" id="5290608">Inst</span><span class="op" id="5290612">[</span><span class="ident" id="5290613">i</span><span class="op" id="5290614">]</span><span class="op" id="5290615">.</span><span class="ident" id="5290616">Rune</span>&nbsp;<span class="op" id="5290621">=</span>&nbsp;<span class="ident" id="5290623">onePassRunes</span><span class="op" id="5290635">[</span><span class="ident" id="5290636">i</span><span class="op" id="5290637">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290644">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290647">return</span>&nbsp;<span class="ident" id="5290654">p</span><br>
<span class="lineno"></span><span class="op" id="5290656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5290659">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5290727">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5290764">func</span>&nbsp;<span class="ident" id="5290769">walk</span><span class="op" id="5290773">(</span><span class="ident" id="5290774">prog</span>&nbsp;<span class="op" id="5290779">*</span><span class="ident" id="5290780">syntax</span><span class="op" id="5290786">.</span><span class="ident" id="5290787">Prog</span><span class="op" id="5290791">,</span>&nbsp;<span class="ident" id="5290793">funcs</span>&nbsp;<span class="op" id="5290799">...</span><span class="keyword" id="5290802">func</span><span class="op" id="5290806">(</span><span class="ident" id="5290807">ip</span><span class="op" id="5290809">,</span>&nbsp;<span class="ident" id="5290811">next</span>&nbsp;<span class="builtintype" id="5290816">uint32</span><span class="op" id="5290822">)</span><span class="op" id="5290823">)</span>&nbsp;<span class="op" id="5290825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290828">var</span>&nbsp;<span class="ident" id="5290832">walk1</span>&nbsp;<span class="keyword" id="5290838">func</span><span class="op" id="5290842">(</span><span class="builtintype" id="5290843">uint32</span><span class="op" id="5290849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290852">progQueue</span>&nbsp;<span class="op" id="5290862">:=</span>&nbsp;<span class="ident" id="5290865">newQueue</span><span class="op" id="5290873">(</span><span class="builtinfunc" id="5290874">len</span><span class="op" id="5290877">(</span><span class="ident" id="5290878">prog</span><span class="op" id="5290882">.</span><span class="ident" id="5290883">Inst</span><span class="op" id="5290887">)</span><span class="op" id="5290888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290891">walk1</span>&nbsp;<span class="op" id="5290897">=</span>&nbsp;<span class="keyword" id="5290899">func</span><span class="op" id="5290903">(</span><span class="ident" id="5290904">ip</span>&nbsp;<span class="builtintype" id="5290907">uint32</span><span class="op" id="5290913">)</span>&nbsp;<span class="op" id="5290915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290919">if</span>&nbsp;<span class="ident" id="5290922">progQueue</span><span class="op" id="5290931">.</span><span class="ident" id="5290932">contains</span><span class="op" id="5290940">(</span><span class="ident" id="5290941">ip</span><span class="op" id="5290943">)</span>&nbsp;<span class="op" id="5290945">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5290950">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5290959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290963">progQueue</span><span class="op" id="5290972">.</span><span class="ident" id="5290973">insert</span><span class="op" id="5290979">(</span><span class="ident" id="5290980">ip</span><span class="op" id="5290982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5290986">inst</span>&nbsp;<span class="op" id="5290991">:=</span>&nbsp;<span class="ident" id="5290994">prog</span><span class="op" id="5290998">.</span><span class="ident" id="5290999">Inst</span><span class="op" id="5291003">[</span><span class="ident" id="5291004">ip</span><span class="op" id="5291006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291010">switch</span>&nbsp;<span class="ident" id="5291017">inst</span><span class="op" id="5291021">.</span><span class="ident" id="5291022">Op</span>&nbsp;<span class="op" id="5291025">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291029">case</span>&nbsp;<span class="ident" id="5291034">syntax</span><span class="op" id="5291040">.</span><span class="ident" id="5291041">InstAlt</span><span class="op" id="5291048">,</span>&nbsp;<span class="ident" id="5291050">syntax</span><span class="op" id="5291056">.</span><span class="ident" id="5291057">InstAltMatch</span><span class="op" id="5291069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291074">for</span>&nbsp;<span class="ident" id="5291078">_</span><span class="op" id="5291079">,</span>&nbsp;<span class="ident" id="5291081">f</span>&nbsp;<span class="op" id="5291083">:=</span>&nbsp;<span class="keyword" id="5291086">range</span>&nbsp;<span class="ident" id="5291092">funcs</span>&nbsp;<span class="op" id="5291098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291104">f</span><span class="op" id="5291105">(</span><span class="ident" id="5291106">ip</span><span class="op" id="5291108">,</span>&nbsp;<span class="ident" id="5291110">inst</span><span class="op" id="5291114">.</span><span class="ident" id="5291115">Out</span><span class="op" id="5291118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291124">f</span><span class="op" id="5291125">(</span><span class="ident" id="5291126">ip</span><span class="op" id="5291128">,</span>&nbsp;<span class="ident" id="5291130">inst</span><span class="op" id="5291134">.</span><span class="ident" id="5291135">Arg</span><span class="op" id="5291138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291143">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291148">walk1</span><span class="op" id="5291153">(</span><span class="ident" id="5291154">inst</span><span class="op" id="5291158">.</span><span class="ident" id="5291159">Out</span><span class="op" id="5291162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291167">walk1</span><span class="op" id="5291172">(</span><span class="ident" id="5291173">inst</span><span class="op" id="5291177">.</span><span class="ident" id="5291178">Arg</span><span class="op" id="5291181">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291185">default</span><span class="op" id="5291192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291197">for</span>&nbsp;<span class="ident" id="5291201">_</span><span class="op" id="5291202">,</span>&nbsp;<span class="ident" id="5291204">f</span>&nbsp;<span class="op" id="5291206">:=</span>&nbsp;<span class="keyword" id="5291209">range</span>&nbsp;<span class="ident" id="5291215">funcs</span>&nbsp;<span class="op" id="5291221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291227">f</span><span class="op" id="5291228">(</span><span class="ident" id="5291229">ip</span><span class="op" id="5291231">,</span>&nbsp;<span class="ident" id="5291233">inst</span><span class="op" id="5291237">.</span><span class="ident" id="5291238">Out</span><span class="op" id="5291241">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291251">walk1</span><span class="op" id="5291256">(</span><span class="ident" id="5291257">inst</span><span class="op" id="5291261">.</span><span class="ident" id="5291262">Out</span><span class="op" id="5291265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291275">walk1</span><span class="op" id="5291280">(</span><span class="builtintype" id="5291281">uint32</span><span class="op" id="5291287">(</span><span class="ident" id="5291288">prog</span><span class="op" id="5291292">.</span><span class="ident" id="5291293">Start</span><span class="op" id="5291298">)</span><span class="op" id="5291299">)</span><br>
<span class="lineno">520</span><span class="op" id="5291301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5291304">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5291373">func</span>&nbsp;<span class="ident" id="5291378">find</span><span class="op" id="5291382">(</span><span class="ident" id="5291383">prog</span>&nbsp;<span class="op" id="5291388">*</span><span class="ident" id="5291389">syntax</span><span class="op" id="5291395">.</span><span class="ident" id="5291396">Prog</span><span class="op" id="5291400">,</span>&nbsp;<span class="ident" id="5291402">f</span>&nbsp;<span class="keyword" id="5291404">func</span><span class="op" id="5291408">(</span><span class="op" id="5291409">*</span><span class="ident" id="5291410">syntax</span><span class="op" id="5291416">.</span><span class="ident" id="5291417">Prog</span><span class="op" id="5291421">,</span>&nbsp;<span class="builtintype" id="5291423">int</span><span class="op" id="5291426">)</span>&nbsp;<span class="builtintype" id="5291428">bool</span><span class="op" id="5291432">)</span>&nbsp;<span class="op" id="5291434">(</span><span class="ident" id="5291435">matches</span>&nbsp;<span class="op" id="5291443">[</span><span class="op" id="5291444">]</span><span class="builtintype" id="5291445">uint32</span><span class="op" id="5291451">)</span>&nbsp;<span class="op" id="5291453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291456">matches</span>&nbsp;<span class="op" id="5291464">=</span>&nbsp;<span class="op" id="5291466">[</span><span class="op" id="5291467">]</span><span class="builtintype" id="5291468">uint32</span><span class="op" id="5291474">{</span><span class="op" id="5291475">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291479">for</span>&nbsp;<span class="ident" id="5291483">ip</span>&nbsp;<span class="op" id="5291486">:=</span>&nbsp;<span class="keyword" id="5291489">range</span>&nbsp;<span class="ident" id="5291495">prog</span><span class="op" id="5291499">.</span><span class="ident" id="5291500">Inst</span>&nbsp;<span class="op" id="5291505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291509">if</span>&nbsp;<span class="ident" id="5291512">f</span><span class="op" id="5291513">(</span><span class="ident" id="5291514">prog</span><span class="op" id="5291518">,</span>&nbsp;<span class="ident" id="5291520">ip</span><span class="op" id="5291522">)</span>&nbsp;<span class="op" id="5291524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5291529">matches</span>&nbsp;<span class="op" id="5291537">=</span>&nbsp;<span class="builtinfunc" id="5291539">append</span><span class="op" id="5291545">(</span><span class="ident" id="5291546">matches</span><span class="op" id="5291553">,</span>&nbsp;<span class="builtintype" id="5291555">uint32</span><span class="op" id="5291561">(</span><span class="ident" id="5291562">ip</span><span class="op" id="5291564">)</span><span class="op" id="5291565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291569">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5291572">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5291575">return</span><br>
<span class="lineno"></span><span class="op" id="5291582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5291585">var</span>&nbsp;<span class="ident" id="5291589">notOnePass</span>&nbsp;<span class="op" id="5291600">*</span><span class="ident" id="5291601">onePassProg</span>&nbsp;<span class="op" id="5291613">=</span>&nbsp;<span class="builtintype" id="5291615">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5291620">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5291717">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5291801">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5291887">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5291973">func</span>&nbsp;<span class="ident" id="5291978">compileOnePass</span><span class="op" id="5291992">(</span><span class="ident" id="5291993">prog</span>&nbsp;<span class="op" id="5291998">*</span><span class="ident" id="5291999">syntax</span><span class="op" id="5292005">.</span><span class="ident" id="5292006">Prog</span><span class="op" id="5292010">)</span>&nbsp;<span class="op" id="5292012">(</span><span class="ident" id="5292013">p</span>&nbsp;<span class="op" id="5292015">*</span><span class="ident" id="5292016">onePassProg</span><span class="op" id="5292027">)</span>&nbsp;<span class="op" id="5292029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292032">if</span>&nbsp;<span class="ident" id="5292035">prog</span><span class="op" id="5292039">.</span><span class="ident" id="5292040">Start</span>&nbsp;<span class="op" id="5292046">==</span>&nbsp;<span class="num" id="5292049">0</span>&nbsp;<span class="op" id="5292051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292055">return</span>&nbsp;<span class="ident" id="5292062">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5292077">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292108">if</span>&nbsp;<span class="ident" id="5292111">prog</span><span class="op" id="5292115">.</span><span class="ident" id="5292116">Inst</span><span class="op" id="5292120">[</span><span class="ident" id="5292121">prog</span><span class="op" id="5292125">.</span><span class="ident" id="5292126">Start</span><span class="op" id="5292131">]</span><span class="op" id="5292132">.</span><span class="ident" id="5292133">Op</span>&nbsp;<span class="op" id="5292136">!=</span>&nbsp;<span class="ident" id="5292139">syntax</span><span class="op" id="5292145">.</span><span class="ident" id="5292146">InstEmptyWidth</span>&nbsp;<span class="op" id="5292161">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5292166">syntax</span><span class="op" id="5292172">.</span><span class="ident" id="5292173">EmptyOp</span><span class="op" id="5292180">(</span><span class="ident" id="5292181">prog</span><span class="op" id="5292185">.</span><span class="ident" id="5292186">Inst</span><span class="op" id="5292190">[</span><span class="ident" id="5292191">prog</span><span class="op" id="5292195">.</span><span class="ident" id="5292196">Start</span><span class="op" id="5292201">]</span><span class="op" id="5292202">.</span><span class="ident" id="5292203">Arg</span><span class="op" id="5292206">)</span><span class="op" id="5292207">&amp;</span><span class="ident" id="5292208">syntax</span><span class="op" id="5292214">.</span><span class="ident" id="5292215">EmptyBeginText</span>&nbsp;<span class="op" id="5292230">!=</span>&nbsp;<span class="ident" id="5292233">syntax</span><span class="op" id="5292239">.</span><span class="ident" id="5292240">EmptyBeginText</span>&nbsp;<span class="op" id="5292255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292259">return</span>&nbsp;<span class="ident" id="5292266">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5292281">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292345">for</span>&nbsp;<span class="ident" id="5292349">_</span><span class="op" id="5292350">,</span>&nbsp;<span class="ident" id="5292352">inst</span>&nbsp;<span class="op" id="5292357">:=</span>&nbsp;<span class="keyword" id="5292360">range</span>&nbsp;<span class="ident" id="5292366">prog</span><span class="op" id="5292370">.</span><span class="ident" id="5292371">Inst</span>&nbsp;<span class="op" id="5292376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5292380">opOut</span>&nbsp;<span class="op" id="5292386">:=</span>&nbsp;<span class="ident" id="5292389">prog</span><span class="op" id="5292393">.</span><span class="ident" id="5292394">Inst</span><span class="op" id="5292398">[</span><span class="ident" id="5292399">inst</span><span class="op" id="5292403">.</span><span class="ident" id="5292404">Out</span><span class="op" id="5292407">]</span><span class="op" id="5292408">.</span><span class="ident" id="5292409">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292414">switch</span>&nbsp;<span class="ident" id="5292421">inst</span><span class="op" id="5292425">.</span><span class="ident" id="5292426">Op</span>&nbsp;<span class="op" id="5292429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292433">default</span><span class="op" id="5292440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292445">if</span>&nbsp;<span class="ident" id="5292448">opOut</span>&nbsp;<span class="op" id="5292454">==</span>&nbsp;<span class="ident" id="5292457">syntax</span><span class="op" id="5292463">.</span><span class="ident" id="5292464">InstMatch</span>&nbsp;<span class="op" id="5292474">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292480">return</span>&nbsp;<span class="ident" id="5292487">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292505">case</span>&nbsp;<span class="ident" id="5292510">syntax</span><span class="op" id="5292516">.</span><span class="ident" id="5292517">InstAlt</span><span class="op" id="5292524">,</span>&nbsp;<span class="ident" id="5292526">syntax</span><span class="op" id="5292532">.</span><span class="ident" id="5292533">InstAltMatch</span><span class="op" id="5292545">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292550">if</span>&nbsp;<span class="ident" id="5292553">opOut</span>&nbsp;<span class="op" id="5292559">==</span>&nbsp;<span class="ident" id="5292562">syntax</span><span class="op" id="5292568">.</span><span class="ident" id="5292569">InstMatch</span>&nbsp;<span class="op" id="5292579">||</span>&nbsp;<span class="ident" id="5292582">prog</span><span class="op" id="5292586">.</span><span class="ident" id="5292587">Inst</span><span class="op" id="5292591">[</span><span class="ident" id="5292592">inst</span><span class="op" id="5292596">.</span><span class="ident" id="5292597">Arg</span><span class="op" id="5292600">]</span><span class="op" id="5292601">.</span><span class="ident" id="5292602">Op</span>&nbsp;<span class="op" id="5292605">==</span>&nbsp;<span class="ident" id="5292608">syntax</span><span class="op" id="5292614">.</span><span class="ident" id="5292615">InstMatch</span>&nbsp;<span class="op" id="5292625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292631">return</span>&nbsp;<span class="ident" id="5292638">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292656">case</span>&nbsp;<span class="ident" id="5292661">syntax</span><span class="op" id="5292667">.</span><span class="ident" id="5292668">InstEmptyWidth</span><span class="op" id="5292682">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292687">if</span>&nbsp;<span class="ident" id="5292690">opOut</span>&nbsp;<span class="op" id="5292696">==</span>&nbsp;<span class="ident" id="5292699">syntax</span><span class="op" id="5292705">.</span><span class="ident" id="5292706">InstMatch</span>&nbsp;<span class="op" id="5292716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292722">if</span>&nbsp;<span class="ident" id="5292725">syntax</span><span class="op" id="5292731">.</span><span class="ident" id="5292732">EmptyOp</span><span class="op" id="5292739">(</span><span class="ident" id="5292740">inst</span><span class="op" id="5292744">.</span><span class="ident" id="5292745">Arg</span><span class="op" id="5292748">)</span><span class="op" id="5292749">&amp;</span><span class="ident" id="5292750">syntax</span><span class="op" id="5292756">.</span><span class="ident" id="5292757">EmptyEndText</span>&nbsp;<span class="op" id="5292770">==</span>&nbsp;<span class="ident" id="5292773">syntax</span><span class="op" id="5292779">.</span><span class="ident" id="5292780">EmptyEndText</span>&nbsp;<span class="op" id="5292793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292800">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5292819">return</span>&nbsp;<span class="ident" id="5292826">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5292847">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5292850">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5292909">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5292979">p</span>&nbsp;<span class="op" id="5292981">=</span>&nbsp;<span class="ident" id="5292983">onePassCopy</span><span class="op" id="5292994">(</span><span class="ident" id="5292995">prog</span><span class="op" id="5292999">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5293003">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5293066">p</span>&nbsp;<span class="op" id="5293068">=</span>&nbsp;<span class="ident" id="5293070">makeOnePass</span><span class="op" id="5293081">(</span><span class="ident" id="5293082">p</span><span class="op" id="5293083">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5293087">if</span>&nbsp;<span class="ident" id="5293090">p</span>&nbsp;<span class="op" id="5293092">!=</span>&nbsp;<span class="ident" id="5293095">notOnePass</span>&nbsp;<span class="op" id="5293106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5293110">cleanupOnePass</span><span class="op" id="5293124">(</span><span class="ident" id="5293125">p</span><span class="op" id="5293126">,</span>&nbsp;<span class="ident" id="5293128">prog</span><span class="op" id="5293132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5293135">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5293138">return</span>&nbsp;<span class="ident" id="5293145">p</span><br>
<span class="lineno"></span><span class="op" id="5293147">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
