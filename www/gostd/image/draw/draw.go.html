<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/draw</h2>
<ul>
<li><a href="/gostd/image/draw/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/image/draw/clip_test.go.html">clip_test.go</a></li>
<li><a href="/gostd/image/draw/draw.go.html" class="current">draw.go</a></li>
<li><a href="/gostd/image/draw/draw_test.go.html">draw_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5463179">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5463235">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5463289">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5463340">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5463394">//</span><br>
<span class="lineno"></span><span class="comment" id="5463397">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5463469">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5463519">package</span>&nbsp;<span class="ident" id="5463527">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5463533">import</span>&nbsp;<span class="op" id="5463540">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5463543">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5463552">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5463566">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5463569">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5463631">const</span>&nbsp;<span class="ident" id="5463637">m</span>&nbsp;<span class="op" id="5463639">=</span>&nbsp;<span class="num" id="5463641">1</span><span class="op" id="5463642">&lt;&lt;</span><span class="num" id="5463644">16</span>&nbsp;<span class="op" id="5463647">-</span>&nbsp;<span class="num" id="5463649">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5463652">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5463723">type</span>&nbsp;<span class="ident" id="5463728">Image</span>&nbsp;<span class="keyword" id="5463734">interface</span>&nbsp;<span class="op" id="5463744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463747">image</span><span class="op" id="5463752">.</span><span class="ident" id="5463753">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5463760">Set</span><span class="op" id="5463763">(</span><span class="ident" id="5463764">x</span><span class="op" id="5463765">,</span>&nbsp;<span class="ident" id="5463767">y</span>&nbsp;<span class="builtintype" id="5463769">int</span><span class="op" id="5463772">,</span>&nbsp;<span class="ident" id="5463774">c</span>&nbsp;<span class="ident" id="5463776">color</span><span class="op" id="5463781">.</span><span class="ident" id="5463782">Color</span><span class="op" id="5463787">)</span><br>
<span class="lineno"></span><span class="op" id="5463789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5463792">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5463838">type</span>&nbsp;<span class="ident" id="5463843">Quantizer</span>&nbsp;<span class="keyword" id="5463853">interface</span>&nbsp;<span class="op" id="5463863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463866">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5463937">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464004">Quantize</span><span class="op" id="5464012">(</span><span class="ident" id="5464013">p</span>&nbsp;<span class="ident" id="5464015">color</span><span class="op" id="5464020">.</span><span class="ident" id="5464021">Palette</span><span class="op" id="5464028">,</span>&nbsp;<span class="ident" id="5464030">m</span>&nbsp;<span class="ident" id="5464032">image</span><span class="op" id="5464037">.</span><span class="ident" id="5464038">Image</span><span class="op" id="5464043">)</span>&nbsp;<span class="ident" id="5464045">color</span><span class="op" id="5464050">.</span><span class="ident" id="5464051">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5464059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464062">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5464107">type</span>&nbsp;<span class="ident" id="5464112">Op</span>&nbsp;<span class="builtintype" id="5464115">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5464120">const</span>&nbsp;<span class="op" id="5464126">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464129">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464176">Over</span>&nbsp;<span class="ident" id="5464181">Op</span>&nbsp;<span class="op" id="5464184">=</span>&nbsp;<span class="ident" id="5464186">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464192">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464227">Src</span><br>
<span class="lineno">40</span><span class="op" id="5464231">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464234">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5464313">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5464320">func</span>&nbsp;<span class="op" id="5464325">(</span><span class="ident" id="5464326">op</span>&nbsp;<span class="ident" id="5464329">Op</span><span class="op" id="5464331">)</span>&nbsp;<span class="ident" id="5464333">Draw</span><span class="op" id="5464337">(</span><span class="ident" id="5464338">dst</span>&nbsp;<span class="ident" id="5464342">Image</span><span class="op" id="5464347">,</span>&nbsp;<span class="ident" id="5464349">r</span>&nbsp;<span class="ident" id="5464351">image</span><span class="op" id="5464356">.</span><span class="ident" id="5464357">Rectangle</span><span class="op" id="5464366">,</span>&nbsp;<span class="ident" id="5464368">src</span>&nbsp;<span class="ident" id="5464372">image</span><span class="op" id="5464377">.</span><span class="ident" id="5464378">Image</span><span class="op" id="5464383">,</span>&nbsp;<span class="ident" id="5464385">sp</span>&nbsp;<span class="ident" id="5464388">image</span><span class="op" id="5464393">.</span><span class="ident" id="5464394">Point</span><span class="op" id="5464399">)</span>&nbsp;<span class="op" id="5464401">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464404">DrawMask</span><span class="op" id="5464412">(</span><span class="ident" id="5464413">dst</span><span class="op" id="5464416">,</span>&nbsp;<span class="ident" id="5464418">r</span><span class="op" id="5464419">,</span>&nbsp;<span class="ident" id="5464421">src</span><span class="op" id="5464424">,</span>&nbsp;<span class="ident" id="5464426">sp</span><span class="op" id="5464428">,</span>&nbsp;<span class="ident" id="5464430">nil</span><span class="op" id="5464433">,</span>&nbsp;<span class="ident" id="5464435">image</span><span class="op" id="5464440">.</span><span class="ident" id="5464441">Point</span><span class="op" id="5464446">{</span><span class="op" id="5464447">}</span><span class="op" id="5464448">,</span>&nbsp;<span class="ident" id="5464450">op</span><span class="op" id="5464452">)</span><br>
<span class="lineno"></span><span class="op" id="5464454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5464457">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5464493">type</span>&nbsp;<span class="ident" id="5464498">Drawer</span>&nbsp;<span class="keyword" id="5464505">interface</span>&nbsp;<span class="op" id="5464515">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464518">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5464584">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464646">Draw</span><span class="op" id="5464650">(</span><span class="ident" id="5464651">dst</span>&nbsp;<span class="ident" id="5464655">Image</span><span class="op" id="5464660">,</span>&nbsp;<span class="ident" id="5464662">r</span>&nbsp;<span class="ident" id="5464664">image</span><span class="op" id="5464669">.</span><span class="ident" id="5464670">Rectangle</span><span class="op" id="5464679">,</span>&nbsp;<span class="ident" id="5464681">src</span>&nbsp;<span class="ident" id="5464685">image</span><span class="op" id="5464690">.</span><span class="ident" id="5464691">Image</span><span class="op" id="5464696">,</span>&nbsp;<span class="ident" id="5464698">sp</span>&nbsp;<span class="ident" id="5464701">image</span><span class="op" id="5464706">.</span><span class="ident" id="5464707">Point</span><span class="op" id="5464712">)</span><br>
<span class="lineno"></span><span class="op" id="5464714">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5464717">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5464793">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5464807">var</span>&nbsp;<span class="ident" id="5464811">FloydSteinberg</span>&nbsp;<span class="ident" id="5464826">Drawer</span>&nbsp;<span class="op" id="5464833">=</span>&nbsp;<span class="ident" id="5464835">floydSteinberg</span><span class="op" id="5464849">{</span><span class="op" id="5464850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5464853">type</span>&nbsp;<span class="ident" id="5464858">floydSteinberg</span>&nbsp;<span class="keyword" id="5464873">struct</span><span class="op" id="5464879">{</span><span class="op" id="5464880">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5464883">func</span>&nbsp;<span class="op" id="5464888">(</span><span class="ident" id="5464889">floydSteinberg</span><span class="op" id="5464903">)</span>&nbsp;<span class="ident" id="5464905">Draw</span><span class="op" id="5464909">(</span><span class="ident" id="5464910">dst</span>&nbsp;<span class="ident" id="5464914">Image</span><span class="op" id="5464919">,</span>&nbsp;<span class="ident" id="5464921">r</span>&nbsp;<span class="ident" id="5464923">image</span><span class="op" id="5464928">.</span><span class="ident" id="5464929">Rectangle</span><span class="op" id="5464938">,</span>&nbsp;<span class="ident" id="5464940">src</span>&nbsp;<span class="ident" id="5464944">image</span><span class="op" id="5464949">.</span><span class="ident" id="5464950">Image</span><span class="op" id="5464955">,</span>&nbsp;<span class="ident" id="5464957">sp</span>&nbsp;<span class="ident" id="5464960">image</span><span class="op" id="5464965">.</span><span class="ident" id="5464966">Point</span><span class="op" id="5464971">)</span>&nbsp;<span class="op" id="5464973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5464976">clip</span><span class="op" id="5464980">(</span><span class="ident" id="5464981">dst</span><span class="op" id="5464984">,</span>&nbsp;<span class="op" id="5464986">&amp;</span><span class="ident" id="5464987">r</span><span class="op" id="5464988">,</span>&nbsp;<span class="ident" id="5464990">src</span><span class="op" id="5464993">,</span>&nbsp;<span class="op" id="5464995">&amp;</span><span class="ident" id="5464996">sp</span><span class="op" id="5464998">,</span>&nbsp;<span class="ident" id="5465000">nil</span><span class="op" id="5465003">,</span>&nbsp;<span class="ident" id="5465005">nil</span><span class="op" id="5465008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465011">if</span>&nbsp;<span class="ident" id="5465014">r</span><span class="op" id="5465015">.</span><span class="ident" id="5465016">Empty</span><span class="op" id="5465021">(</span><span class="op" id="5465022">)</span>&nbsp;<span class="op" id="5465024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465028">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465039">drawPaletted</span><span class="op" id="5465051">(</span><span class="ident" id="5465052">dst</span><span class="op" id="5465055">,</span>&nbsp;<span class="ident" id="5465057">r</span><span class="op" id="5465058">,</span>&nbsp;<span class="ident" id="5465060">src</span><span class="op" id="5465063">,</span>&nbsp;<span class="ident" id="5465065">sp</span><span class="op" id="5465067">,</span>&nbsp;<span class="builtintype" id="5465069">true</span><span class="op" id="5465073">)</span><br>
<span class="lineno"></span><span class="op" id="5465075">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5465078">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5465150">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5465227">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5465270">func</span>&nbsp;<span class="ident" id="5465275">clip</span><span class="op" id="5465279">(</span><span class="ident" id="5465280">dst</span>&nbsp;<span class="ident" id="5465284">Image</span><span class="op" id="5465289">,</span>&nbsp;<span class="ident" id="5465291">r</span>&nbsp;<span class="op" id="5465293">*</span><span class="ident" id="5465294">image</span><span class="op" id="5465299">.</span><span class="ident" id="5465300">Rectangle</span><span class="op" id="5465309">,</span>&nbsp;<span class="ident" id="5465311">src</span>&nbsp;<span class="ident" id="5465315">image</span><span class="op" id="5465320">.</span><span class="ident" id="5465321">Image</span><span class="op" id="5465326">,</span>&nbsp;<span class="ident" id="5465328">sp</span>&nbsp;<span class="op" id="5465331">*</span><span class="ident" id="5465332">image</span><span class="op" id="5465337">.</span><span class="ident" id="5465338">Point</span><span class="op" id="5465343">,</span>&nbsp;<span class="ident" id="5465345">mask</span>&nbsp;<span class="ident" id="5465350">image</span><span class="op" id="5465355">.</span><span class="ident" id="5465356">Image</span><span class="op" id="5465361">,</span>&nbsp;<span class="ident" id="5465363">mp</span>&nbsp;<span class="op" id="5465366">*</span><span class="ident" id="5465367">image</span><span class="op" id="5465372">.</span><span class="ident" id="5465373">Point</span><span class="op" id="5465378">)</span>&nbsp;<span class="op" id="5465380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465383">orig</span>&nbsp;<span class="op" id="5465388">:=</span>&nbsp;<span class="ident" id="5465391">r</span><span class="op" id="5465392">.</span><span class="ident" id="5465393">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465398">*</span><span class="ident" id="5465399">r</span>&nbsp;<span class="op" id="5465401">=</span>&nbsp;<span class="ident" id="5465403">r</span><span class="op" id="5465404">.</span><span class="ident" id="5465405">Intersect</span><span class="op" id="5465414">(</span><span class="ident" id="5465415">dst</span><span class="op" id="5465418">.</span><span class="ident" id="5465419">Bounds</span><span class="op" id="5465425">(</span><span class="op" id="5465426">)</span><span class="op" id="5465427">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465430">*</span><span class="ident" id="5465431">r</span>&nbsp;<span class="op" id="5465433">=</span>&nbsp;<span class="ident" id="5465435">r</span><span class="op" id="5465436">.</span><span class="ident" id="5465437">Intersect</span><span class="op" id="5465446">(</span><span class="ident" id="5465447">src</span><span class="op" id="5465450">.</span><span class="ident" id="5465451">Bounds</span><span class="op" id="5465457">(</span><span class="op" id="5465458">)</span><span class="op" id="5465459">.</span><span class="ident" id="5465460">Add</span><span class="op" id="5465463">(</span><span class="ident" id="5465464">orig</span><span class="op" id="5465468">.</span><span class="ident" id="5465469">Sub</span><span class="op" id="5465472">(</span><span class="op" id="5465473">*</span><span class="ident" id="5465474">sp</span><span class="op" id="5465476">)</span><span class="op" id="5465477">)</span><span class="op" id="5465478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465481">if</span>&nbsp;<span class="ident" id="5465484">mask</span>&nbsp;<span class="op" id="5465489">!=</span>&nbsp;<span class="ident" id="5465492">nil</span>&nbsp;<span class="op" id="5465496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465500">*</span><span class="ident" id="5465501">r</span>&nbsp;<span class="op" id="5465503">=</span>&nbsp;<span class="ident" id="5465505">r</span><span class="op" id="5465506">.</span><span class="ident" id="5465507">Intersect</span><span class="op" id="5465516">(</span><span class="ident" id="5465517">mask</span><span class="op" id="5465521">.</span><span class="ident" id="5465522">Bounds</span><span class="op" id="5465528">(</span><span class="op" id="5465529">)</span><span class="op" id="5465530">.</span><span class="ident" id="5465531">Add</span><span class="op" id="5465534">(</span><span class="ident" id="5465535">orig</span><span class="op" id="5465539">.</span><span class="ident" id="5465540">Sub</span><span class="op" id="5465543">(</span><span class="op" id="5465544">*</span><span class="ident" id="5465545">mp</span><span class="op" id="5465547">)</span><span class="op" id="5465548">)</span><span class="op" id="5465549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465555">dx</span>&nbsp;<span class="op" id="5465558">:=</span>&nbsp;<span class="ident" id="5465561">r</span><span class="op" id="5465562">.</span><span class="ident" id="5465563">Min</span><span class="op" id="5465566">.</span><span class="ident" id="5465567">X</span>&nbsp;<span class="op" id="5465569">-</span>&nbsp;<span class="ident" id="5465571">orig</span><span class="op" id="5465575">.</span><span class="ident" id="5465576">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465579">dy</span>&nbsp;<span class="op" id="5465582">:=</span>&nbsp;<span class="ident" id="5465585">r</span><span class="op" id="5465586">.</span><span class="ident" id="5465587">Min</span><span class="op" id="5465590">.</span><span class="ident" id="5465591">Y</span>&nbsp;<span class="op" id="5465593">-</span>&nbsp;<span class="ident" id="5465595">orig</span><span class="op" id="5465599">.</span><span class="ident" id="5465600">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465603">if</span>&nbsp;<span class="ident" id="5465606">dx</span>&nbsp;<span class="op" id="5465609">==</span>&nbsp;<span class="num" id="5465612">0</span>&nbsp;<span class="op" id="5465614">&amp;&amp;</span>&nbsp;<span class="ident" id="5465617">dy</span>&nbsp;<span class="op" id="5465620">==</span>&nbsp;<span class="num" id="5465623">0</span>&nbsp;<span class="op" id="5465625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465629">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465640">(</span><span class="op" id="5465641">*</span><span class="ident" id="5465642">sp</span><span class="op" id="5465644">)</span><span class="op" id="5465645">.</span><span class="ident" id="5465646">X</span>&nbsp;<span class="op" id="5465648">+=</span>&nbsp;<span class="ident" id="5465651">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465655">(</span><span class="op" id="5465656">*</span><span class="ident" id="5465657">sp</span><span class="op" id="5465659">)</span><span class="op" id="5465660">.</span><span class="ident" id="5465661">Y</span>&nbsp;<span class="op" id="5465663">+=</span>&nbsp;<span class="ident" id="5465666">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465670">(</span><span class="op" id="5465671">*</span><span class="ident" id="5465672">mp</span><span class="op" id="5465674">)</span><span class="op" id="5465675">.</span><span class="ident" id="5465676">X</span>&nbsp;<span class="op" id="5465678">+=</span>&nbsp;<span class="ident" id="5465681">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465685">(</span><span class="op" id="5465686">*</span><span class="ident" id="5465687">mp</span><span class="op" id="5465689">)</span><span class="op" id="5465690">.</span><span class="ident" id="5465691">Y</span>&nbsp;<span class="op" id="5465693">+=</span>&nbsp;<span class="ident" id="5465696">dy</span><br>
<span class="lineno"></span><span class="op" id="5465699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5465702">func</span>&nbsp;<span class="ident" id="5465707">processBackward</span><span class="op" id="5465722">(</span><span class="ident" id="5465723">dst</span>&nbsp;<span class="ident" id="5465727">Image</span><span class="op" id="5465732">,</span>&nbsp;<span class="ident" id="5465734">r</span>&nbsp;<span class="ident" id="5465736">image</span><span class="op" id="5465741">.</span><span class="ident" id="5465742">Rectangle</span><span class="op" id="5465751">,</span>&nbsp;<span class="ident" id="5465753">src</span>&nbsp;<span class="ident" id="5465757">image</span><span class="op" id="5465762">.</span><span class="ident" id="5465763">Image</span><span class="op" id="5465768">,</span>&nbsp;<span class="ident" id="5465770">sp</span>&nbsp;<span class="ident" id="5465773">image</span><span class="op" id="5465778">.</span><span class="ident" id="5465779">Point</span><span class="op" id="5465784">)</span>&nbsp;<span class="builtintype" id="5465786">bool</span>&nbsp;<span class="op" id="5465791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5465794">return</span>&nbsp;<span class="ident" id="5465801">image</span><span class="op" id="5465806">.</span><span class="ident" id="5465807">Image</span><span class="op" id="5465812">(</span><span class="ident" id="5465813">dst</span><span class="op" id="5465816">)</span>&nbsp;<span class="op" id="5465818">==</span>&nbsp;<span class="ident" id="5465821">src</span>&nbsp;<span class="op" id="5465825">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5465830">r</span><span class="op" id="5465831">.</span><span class="ident" id="5465832">Overlaps</span><span class="op" id="5465840">(</span><span class="ident" id="5465841">r</span><span class="op" id="5465842">.</span><span class="ident" id="5465843">Add</span><span class="op" id="5465846">(</span><span class="ident" id="5465847">sp</span><span class="op" id="5465849">.</span><span class="ident" id="5465850">Sub</span><span class="op" id="5465853">(</span><span class="ident" id="5465854">r</span><span class="op" id="5465855">.</span><span class="ident" id="5465856">Min</span><span class="op" id="5465859">)</span><span class="op" id="5465860">)</span><span class="op" id="5465861">)</span>&nbsp;<span class="op" id="5465863">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5465868">(</span><span class="ident" id="5465869">sp</span><span class="op" id="5465871">.</span><span class="ident" id="5465872">Y</span>&nbsp;<span class="op" id="5465874">&lt;</span>&nbsp;<span class="ident" id="5465876">r</span><span class="op" id="5465877">.</span><span class="ident" id="5465878">Min</span><span class="op" id="5465881">.</span><span class="ident" id="5465882">Y</span>&nbsp;<span class="op" id="5465884">||</span>&nbsp;<span class="op" id="5465887">(</span><span class="ident" id="5465888">sp</span><span class="op" id="5465890">.</span><span class="ident" id="5465891">Y</span>&nbsp;<span class="op" id="5465893">==</span>&nbsp;<span class="ident" id="5465896">r</span><span class="op" id="5465897">.</span><span class="ident" id="5465898">Min</span><span class="op" id="5465901">.</span><span class="ident" id="5465902">Y</span>&nbsp;<span class="op" id="5465904">&amp;&amp;</span>&nbsp;<span class="ident" id="5465907">sp</span><span class="op" id="5465909">.</span><span class="ident" id="5465910">X</span>&nbsp;<span class="op" id="5465912">&lt;</span>&nbsp;<span class="ident" id="5465914">r</span><span class="op" id="5465915">.</span><span class="ident" id="5465916">Min</span><span class="op" id="5465919">.</span><span class="ident" id="5465920">X</span><span class="op" id="5465921">)</span><span class="op" id="5465922">)</span><br>
<span class="lineno"></span><span class="op" id="5465924">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5465927">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5465967">func</span>&nbsp;<span class="ident" id="5465972">Draw</span><span class="op" id="5465976">(</span><span class="ident" id="5465977">dst</span>&nbsp;<span class="ident" id="5465981">Image</span><span class="op" id="5465986">,</span>&nbsp;<span class="ident" id="5465988">r</span>&nbsp;<span class="ident" id="5465990">image</span><span class="op" id="5465995">.</span><span class="ident" id="5465996">Rectangle</span><span class="op" id="5466005">,</span>&nbsp;<span class="ident" id="5466007">src</span>&nbsp;<span class="ident" id="5466011">image</span><span class="op" id="5466016">.</span><span class="ident" id="5466017">Image</span><span class="op" id="5466022">,</span>&nbsp;<span class="ident" id="5466024">sp</span>&nbsp;<span class="ident" id="5466027">image</span><span class="op" id="5466032">.</span><span class="ident" id="5466033">Point</span><span class="op" id="5466038">,</span>&nbsp;<span class="ident" id="5466040">op</span>&nbsp;<span class="ident" id="5466043">Op</span><span class="op" id="5466045">)</span>&nbsp;<span class="op" id="5466047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466050">DrawMask</span><span class="op" id="5466058">(</span><span class="ident" id="5466059">dst</span><span class="op" id="5466062">,</span>&nbsp;<span class="ident" id="5466064">r</span><span class="op" id="5466065">,</span>&nbsp;<span class="ident" id="5466067">src</span><span class="op" id="5466070">,</span>&nbsp;<span class="ident" id="5466072">sp</span><span class="op" id="5466074">,</span>&nbsp;<span class="ident" id="5466076">nil</span><span class="op" id="5466079">,</span>&nbsp;<span class="ident" id="5466081">image</span><span class="op" id="5466086">.</span><span class="ident" id="5466087">Point</span><span class="op" id="5466092">{</span><span class="op" id="5466093">}</span><span class="op" id="5466094">,</span>&nbsp;<span class="ident" id="5466096">op</span><span class="op" id="5466098">)</span><br>
<span class="lineno"></span><span class="op" id="5466100">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5466103">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5466199">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5466288">func</span>&nbsp;<span class="ident" id="5466293">DrawMask</span><span class="op" id="5466301">(</span><span class="ident" id="5466302">dst</span>&nbsp;<span class="ident" id="5466306">Image</span><span class="op" id="5466311">,</span>&nbsp;<span class="ident" id="5466313">r</span>&nbsp;<span class="ident" id="5466315">image</span><span class="op" id="5466320">.</span><span class="ident" id="5466321">Rectangle</span><span class="op" id="5466330">,</span>&nbsp;<span class="ident" id="5466332">src</span>&nbsp;<span class="ident" id="5466336">image</span><span class="op" id="5466341">.</span><span class="ident" id="5466342">Image</span><span class="op" id="5466347">,</span>&nbsp;<span class="ident" id="5466349">sp</span>&nbsp;<span class="ident" id="5466352">image</span><span class="op" id="5466357">.</span><span class="ident" id="5466358">Point</span><span class="op" id="5466363">,</span>&nbsp;<span class="ident" id="5466365">mask</span>&nbsp;<span class="ident" id="5466370">image</span><span class="op" id="5466375">.</span><span class="ident" id="5466376">Image</span><span class="op" id="5466381">,</span>&nbsp;<span class="ident" id="5466383">mp</span>&nbsp;<span class="ident" id="5466386">image</span><span class="op" id="5466391">.</span><span class="ident" id="5466392">Point</span><span class="op" id="5466397">,</span>&nbsp;<span class="ident" id="5466399">op</span>&nbsp;<span class="ident" id="5466402">Op</span><span class="op" id="5466404">)</span>&nbsp;<span class="op" id="5466406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466409">clip</span><span class="op" id="5466413">(</span><span class="ident" id="5466414">dst</span><span class="op" id="5466417">,</span>&nbsp;<span class="op" id="5466419">&amp;</span><span class="ident" id="5466420">r</span><span class="op" id="5466421">,</span>&nbsp;<span class="ident" id="5466423">src</span><span class="op" id="5466426">,</span>&nbsp;<span class="op" id="5466428">&amp;</span><span class="ident" id="5466429">sp</span><span class="op" id="5466431">,</span>&nbsp;<span class="ident" id="5466433">mask</span><span class="op" id="5466437">,</span>&nbsp;<span class="op" id="5466439">&amp;</span><span class="ident" id="5466440">mp</span><span class="op" id="5466442">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466445">if</span>&nbsp;<span class="ident" id="5466448">r</span><span class="op" id="5466449">.</span><span class="ident" id="5466450">Empty</span><span class="op" id="5466455">(</span><span class="op" id="5466456">)</span>&nbsp;<span class="op" id="5466458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466462">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5466474">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466587">switch</span>&nbsp;<span class="ident" id="5466594">dst0</span>&nbsp;<span class="op" id="5466599">:=</span>&nbsp;<span class="ident" id="5466602">dst</span><span class="op" id="5466605">.</span><span class="op" id="5466606">(</span><span class="keyword" id="5466607">type</span><span class="op" id="5466611">)</span>&nbsp;<span class="op" id="5466613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466616">case</span>&nbsp;<span class="op" id="5466621">*</span><span class="ident" id="5466622">image</span><span class="op" id="5466627">.</span><span class="ident" id="5466628">RGBA</span><span class="op" id="5466632">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466636">if</span>&nbsp;<span class="ident" id="5466639">op</span>&nbsp;<span class="op" id="5466642">==</span>&nbsp;<span class="ident" id="5466645">Over</span>&nbsp;<span class="op" id="5466650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466655">if</span>&nbsp;<span class="ident" id="5466658">mask</span>&nbsp;<span class="op" id="5466663">==</span>&nbsp;<span class="ident" id="5466666">nil</span>&nbsp;<span class="op" id="5466670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466676">switch</span>&nbsp;<span class="ident" id="5466683">src0</span>&nbsp;<span class="op" id="5466688">:=</span>&nbsp;<span class="ident" id="5466691">src</span><span class="op" id="5466694">.</span><span class="op" id="5466695">(</span><span class="keyword" id="5466696">type</span><span class="op" id="5466700">)</span>&nbsp;<span class="op" id="5466702">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466708">case</span>&nbsp;<span class="op" id="5466713">*</span><span class="ident" id="5466714">image</span><span class="op" id="5466719">.</span><span class="ident" id="5466720">Uniform</span><span class="op" id="5466727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466734">drawFillOver</span><span class="op" id="5466746">(</span><span class="ident" id="5466747">dst0</span><span class="op" id="5466751">,</span>&nbsp;<span class="ident" id="5466753">r</span><span class="op" id="5466754">,</span>&nbsp;<span class="ident" id="5466756">src0</span><span class="op" id="5466760">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466767">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466778">case</span>&nbsp;<span class="op" id="5466783">*</span><span class="ident" id="5466784">image</span><span class="op" id="5466789">.</span><span class="ident" id="5466790">RGBA</span><span class="op" id="5466794">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466801">drawCopyOver</span><span class="op" id="5466813">(</span><span class="ident" id="5466814">dst0</span><span class="op" id="5466818">,</span>&nbsp;<span class="ident" id="5466820">r</span><span class="op" id="5466821">,</span>&nbsp;<span class="ident" id="5466823">src0</span><span class="op" id="5466827">,</span>&nbsp;<span class="ident" id="5466829">sp</span><span class="op" id="5466831">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466838">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466849">case</span>&nbsp;<span class="op" id="5466854">*</span><span class="ident" id="5466855">image</span><span class="op" id="5466860">.</span><span class="ident" id="5466861">NRGBA</span><span class="op" id="5466866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5466873">drawNRGBAOver</span><span class="op" id="5466886">(</span><span class="ident" id="5466887">dst0</span><span class="op" id="5466891">,</span>&nbsp;<span class="ident" id="5466893">r</span><span class="op" id="5466894">,</span>&nbsp;<span class="ident" id="5466896">src0</span><span class="op" id="5466900">,</span>&nbsp;<span class="ident" id="5466902">sp</span><span class="op" id="5466904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466911">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466922">case</span>&nbsp;<span class="op" id="5466927">*</span><span class="ident" id="5466928">image</span><span class="op" id="5466933">.</span><span class="ident" id="5466934">YCbCr</span><span class="op" id="5466939">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466946">if</span>&nbsp;<span class="ident" id="5466949">drawYCbCr</span><span class="op" id="5466958">(</span><span class="ident" id="5466959">dst0</span><span class="op" id="5466963">,</span>&nbsp;<span class="ident" id="5466965">r</span><span class="op" id="5466966">,</span>&nbsp;<span class="ident" id="5466968">src0</span><span class="op" id="5466972">,</span>&nbsp;<span class="ident" id="5466974">sp</span><span class="op" id="5466976">)</span>&nbsp;<span class="op" id="5466978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5466986">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5466998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467009">}</span>&nbsp;<span class="keyword" id="5467011">else</span>&nbsp;<span class="keyword" id="5467016">if</span>&nbsp;<span class="ident" id="5467019">mask0</span><span class="op" id="5467024">,</span>&nbsp;<span class="ident" id="5467026">ok</span>&nbsp;<span class="op" id="5467029">:=</span>&nbsp;<span class="ident" id="5467032">mask</span><span class="op" id="5467036">.</span><span class="op" id="5467037">(</span><span class="op" id="5467038">*</span><span class="ident" id="5467039">image</span><span class="op" id="5467044">.</span><span class="ident" id="5467045">Alpha</span><span class="op" id="5467050">)</span><span class="op" id="5467051">;</span>&nbsp;<span class="ident" id="5467053">ok</span>&nbsp;<span class="op" id="5467056">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467062">switch</span>&nbsp;<span class="ident" id="5467069">src0</span>&nbsp;<span class="op" id="5467074">:=</span>&nbsp;<span class="ident" id="5467077">src</span><span class="op" id="5467080">.</span><span class="op" id="5467081">(</span><span class="keyword" id="5467082">type</span><span class="op" id="5467086">)</span>&nbsp;<span class="op" id="5467088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467094">case</span>&nbsp;<span class="op" id="5467099">*</span><span class="ident" id="5467100">image</span><span class="op" id="5467105">.</span><span class="ident" id="5467106">Uniform</span><span class="op" id="5467113">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467120">drawGlyphOver</span><span class="op" id="5467133">(</span><span class="ident" id="5467134">dst0</span><span class="op" id="5467138">,</span>&nbsp;<span class="ident" id="5467140">r</span><span class="op" id="5467141">,</span>&nbsp;<span class="ident" id="5467143">src0</span><span class="op" id="5467147">,</span>&nbsp;<span class="ident" id="5467149">mask0</span><span class="op" id="5467154">,</span>&nbsp;<span class="ident" id="5467156">mp</span><span class="op" id="5467158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467165">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467176">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467185">}</span>&nbsp;<span class="keyword" id="5467187">else</span>&nbsp;<span class="op" id="5467192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467197">if</span>&nbsp;<span class="ident" id="5467200">mask</span>&nbsp;<span class="op" id="5467205">==</span>&nbsp;<span class="ident" id="5467208">nil</span>&nbsp;<span class="op" id="5467212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467218">switch</span>&nbsp;<span class="ident" id="5467225">src0</span>&nbsp;<span class="op" id="5467230">:=</span>&nbsp;<span class="ident" id="5467233">src</span><span class="op" id="5467236">.</span><span class="op" id="5467237">(</span><span class="keyword" id="5467238">type</span><span class="op" id="5467242">)</span>&nbsp;<span class="op" id="5467244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467250">case</span>&nbsp;<span class="op" id="5467255">*</span><span class="ident" id="5467256">image</span><span class="op" id="5467261">.</span><span class="ident" id="5467262">Uniform</span><span class="op" id="5467269">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467276">drawFillSrc</span><span class="op" id="5467287">(</span><span class="ident" id="5467288">dst0</span><span class="op" id="5467292">,</span>&nbsp;<span class="ident" id="5467294">r</span><span class="op" id="5467295">,</span>&nbsp;<span class="ident" id="5467297">src0</span><span class="op" id="5467301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467308">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467319">case</span>&nbsp;<span class="op" id="5467324">*</span><span class="ident" id="5467325">image</span><span class="op" id="5467330">.</span><span class="ident" id="5467331">RGBA</span><span class="op" id="5467335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467342">drawCopySrc</span><span class="op" id="5467353">(</span><span class="ident" id="5467354">dst0</span><span class="op" id="5467358">,</span>&nbsp;<span class="ident" id="5467360">r</span><span class="op" id="5467361">,</span>&nbsp;<span class="ident" id="5467363">src0</span><span class="op" id="5467367">,</span>&nbsp;<span class="ident" id="5467369">sp</span><span class="op" id="5467371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467378">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467389">case</span>&nbsp;<span class="op" id="5467394">*</span><span class="ident" id="5467395">image</span><span class="op" id="5467400">.</span><span class="ident" id="5467401">NRGBA</span><span class="op" id="5467406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467413">drawNRGBASrc</span><span class="op" id="5467425">(</span><span class="ident" id="5467426">dst0</span><span class="op" id="5467430">,</span>&nbsp;<span class="ident" id="5467432">r</span><span class="op" id="5467433">,</span>&nbsp;<span class="ident" id="5467435">src0</span><span class="op" id="5467439">,</span>&nbsp;<span class="ident" id="5467441">sp</span><span class="op" id="5467443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467450">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467461">case</span>&nbsp;<span class="op" id="5467466">*</span><span class="ident" id="5467467">image</span><span class="op" id="5467472">.</span><span class="ident" id="5467473">YCbCr</span><span class="op" id="5467478">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467485">if</span>&nbsp;<span class="ident" id="5467488">drawYCbCr</span><span class="op" id="5467497">(</span><span class="ident" id="5467498">dst0</span><span class="op" id="5467502">,</span>&nbsp;<span class="ident" id="5467504">r</span><span class="op" id="5467505">,</span>&nbsp;<span class="ident" id="5467507">src0</span><span class="op" id="5467511">,</span>&nbsp;<span class="ident" id="5467513">sp</span><span class="op" id="5467515">)</span>&nbsp;<span class="op" id="5467517">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467525">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467552">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467556">drawRGBA</span><span class="op" id="5467564">(</span><span class="ident" id="5467565">dst0</span><span class="op" id="5467569">,</span>&nbsp;<span class="ident" id="5467571">r</span><span class="op" id="5467572">,</span>&nbsp;<span class="ident" id="5467574">src</span><span class="op" id="5467577">,</span>&nbsp;<span class="ident" id="5467579">sp</span><span class="op" id="5467581">,</span>&nbsp;<span class="ident" id="5467583">mask</span><span class="op" id="5467587">,</span>&nbsp;<span class="ident" id="5467589">mp</span><span class="op" id="5467591">,</span>&nbsp;<span class="ident" id="5467593">op</span><span class="op" id="5467595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467599">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467607">case</span>&nbsp;<span class="op" id="5467612">*</span><span class="ident" id="5467613">image</span><span class="op" id="5467618">.</span><span class="ident" id="5467619">Paletted</span><span class="op" id="5467627">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467631">if</span>&nbsp;<span class="ident" id="5467634">op</span>&nbsp;<span class="op" id="5467637">==</span>&nbsp;<span class="ident" id="5467640">Src</span>&nbsp;<span class="op" id="5467644">&amp;&amp;</span>&nbsp;<span class="ident" id="5467647">mask</span>&nbsp;<span class="op" id="5467652">==</span>&nbsp;<span class="ident" id="5467655">nil</span>&nbsp;<span class="op" id="5467659">&amp;&amp;</span>&nbsp;<span class="op" id="5467662">!</span><span class="ident" id="5467663">processBackward</span><span class="op" id="5467678">(</span><span class="ident" id="5467679">dst</span><span class="op" id="5467682">,</span>&nbsp;<span class="ident" id="5467684">r</span><span class="op" id="5467685">,</span>&nbsp;<span class="ident" id="5467687">src</span><span class="op" id="5467690">,</span>&nbsp;<span class="ident" id="5467692">sp</span><span class="op" id="5467694">)</span>&nbsp;<span class="op" id="5467696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467701">drawPaletted</span><span class="op" id="5467713">(</span><span class="ident" id="5467714">dst0</span><span class="op" id="5467718">,</span>&nbsp;<span class="ident" id="5467720">r</span><span class="op" id="5467721">,</span>&nbsp;<span class="ident" id="5467723">src</span><span class="op" id="5467726">,</span>&nbsp;<span class="ident" id="5467728">sp</span><span class="op" id="5467730">,</span>&nbsp;<span class="builtintype" id="5467732">false</span><span class="op" id="5467737">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467748">x0</span><span class="op" id="5467750">,</span>&nbsp;<span class="ident" id="5467752">x1</span><span class="op" id="5467754">,</span>&nbsp;<span class="ident" id="5467756">dx</span>&nbsp;<span class="op" id="5467759">:=</span>&nbsp;<span class="ident" id="5467762">r</span><span class="op" id="5467763">.</span><span class="ident" id="5467764">Min</span><span class="op" id="5467767">.</span><span class="ident" id="5467768">X</span><span class="op" id="5467769">,</span>&nbsp;<span class="ident" id="5467771">r</span><span class="op" id="5467772">.</span><span class="ident" id="5467773">Max</span><span class="op" id="5467776">.</span><span class="ident" id="5467777">X</span><span class="op" id="5467778">,</span>&nbsp;<span class="num" id="5467780">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467783">y0</span><span class="op" id="5467785">,</span>&nbsp;<span class="ident" id="5467787">y1</span><span class="op" id="5467789">,</span>&nbsp;<span class="ident" id="5467791">dy</span>&nbsp;<span class="op" id="5467794">:=</span>&nbsp;<span class="ident" id="5467797">r</span><span class="op" id="5467798">.</span><span class="ident" id="5467799">Min</span><span class="op" id="5467802">.</span><span class="ident" id="5467803">Y</span><span class="op" id="5467804">,</span>&nbsp;<span class="ident" id="5467806">r</span><span class="op" id="5467807">.</span><span class="ident" id="5467808">Max</span><span class="op" id="5467811">.</span><span class="ident" id="5467812">Y</span><span class="op" id="5467813">,</span>&nbsp;<span class="num" id="5467815">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467818">if</span>&nbsp;<span class="ident" id="5467821">processBackward</span><span class="op" id="5467836">(</span><span class="ident" id="5467837">dst</span><span class="op" id="5467840">,</span>&nbsp;<span class="ident" id="5467842">r</span><span class="op" id="5467843">,</span>&nbsp;<span class="ident" id="5467845">src</span><span class="op" id="5467848">,</span>&nbsp;<span class="ident" id="5467850">sp</span><span class="op" id="5467852">)</span>&nbsp;<span class="op" id="5467854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467858">x0</span><span class="op" id="5467860">,</span>&nbsp;<span class="ident" id="5467862">x1</span><span class="op" id="5467864">,</span>&nbsp;<span class="ident" id="5467866">dx</span>&nbsp;<span class="op" id="5467869">=</span>&nbsp;<span class="ident" id="5467871">x1</span><span class="op" id="5467873">-</span><span class="num" id="5467874">1</span><span class="op" id="5467875">,</span>&nbsp;<span class="ident" id="5467877">x0</span><span class="op" id="5467879">-</span><span class="num" id="5467880">1</span><span class="op" id="5467881">,</span>&nbsp;<span class="op" id="5467883">-</span><span class="num" id="5467884">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467888">y0</span><span class="op" id="5467890">,</span>&nbsp;<span class="ident" id="5467892">y1</span><span class="op" id="5467894">,</span>&nbsp;<span class="ident" id="5467896">dy</span>&nbsp;<span class="op" id="5467899">=</span>&nbsp;<span class="ident" id="5467901">y1</span><span class="op" id="5467903">-</span><span class="num" id="5467904">1</span><span class="op" id="5467905">,</span>&nbsp;<span class="ident" id="5467907">y0</span><span class="op" id="5467909">-</span><span class="num" id="5467910">1</span><span class="op" id="5467911">,</span>&nbsp;<span class="op" id="5467913">-</span><span class="num" id="5467914">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5467917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467921">var</span>&nbsp;<span class="ident" id="5467925">out</span>&nbsp;<span class="ident" id="5467929">color</span><span class="op" id="5467934">.</span><span class="ident" id="5467935">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467943">sy</span>&nbsp;<span class="op" id="5467946">:=</span>&nbsp;<span class="ident" id="5467949">sp</span><span class="op" id="5467951">.</span><span class="ident" id="5467952">Y</span>&nbsp;<span class="op" id="5467954">+</span>&nbsp;<span class="ident" id="5467956">y0</span>&nbsp;<span class="op" id="5467959">-</span>&nbsp;<span class="ident" id="5467961">r</span><span class="op" id="5467962">.</span><span class="ident" id="5467963">Min</span><span class="op" id="5467966">.</span><span class="ident" id="5467967">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5467970">my</span>&nbsp;<span class="op" id="5467973">:=</span>&nbsp;<span class="ident" id="5467976">mp</span><span class="op" id="5467978">.</span><span class="ident" id="5467979">Y</span>&nbsp;<span class="op" id="5467981">+</span>&nbsp;<span class="ident" id="5467983">y0</span>&nbsp;<span class="op" id="5467986">-</span>&nbsp;<span class="ident" id="5467988">r</span><span class="op" id="5467989">.</span><span class="ident" id="5467990">Min</span><span class="op" id="5467993">.</span><span class="ident" id="5467994">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5467997">for</span>&nbsp;<span class="ident" id="5468001">y</span>&nbsp;<span class="op" id="5468003">:=</span>&nbsp;<span class="ident" id="5468006">y0</span><span class="op" id="5468008">;</span>&nbsp;<span class="ident" id="5468010">y</span>&nbsp;<span class="op" id="5468012">!=</span>&nbsp;<span class="ident" id="5468015">y1</span><span class="op" id="5468017">;</span>&nbsp;<span class="ident" id="5468019">y</span><span class="op" id="5468020">,</span>&nbsp;<span class="ident" id="5468022">sy</span><span class="op" id="5468024">,</span>&nbsp;<span class="ident" id="5468026">my</span>&nbsp;<span class="op" id="5468029">=</span>&nbsp;<span class="ident" id="5468031">y</span><span class="op" id="5468032">+</span><span class="ident" id="5468033">dy</span><span class="op" id="5468035">,</span>&nbsp;<span class="ident" id="5468037">sy</span><span class="op" id="5468039">+</span><span class="ident" id="5468040">dy</span><span class="op" id="5468042">,</span>&nbsp;<span class="ident" id="5468044">my</span><span class="op" id="5468046">+</span><span class="ident" id="5468047">dy</span>&nbsp;<span class="op" id="5468050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468054">sx</span>&nbsp;<span class="op" id="5468057">:=</span>&nbsp;<span class="ident" id="5468060">sp</span><span class="op" id="5468062">.</span><span class="ident" id="5468063">X</span>&nbsp;<span class="op" id="5468065">+</span>&nbsp;<span class="ident" id="5468067">x0</span>&nbsp;<span class="op" id="5468070">-</span>&nbsp;<span class="ident" id="5468072">r</span><span class="op" id="5468073">.</span><span class="ident" id="5468074">Min</span><span class="op" id="5468077">.</span><span class="ident" id="5468078">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468082">mx</span>&nbsp;<span class="op" id="5468085">:=</span>&nbsp;<span class="ident" id="5468088">mp</span><span class="op" id="5468090">.</span><span class="ident" id="5468091">X</span>&nbsp;<span class="op" id="5468093">+</span>&nbsp;<span class="ident" id="5468095">x0</span>&nbsp;<span class="op" id="5468098">-</span>&nbsp;<span class="ident" id="5468100">r</span><span class="op" id="5468101">.</span><span class="ident" id="5468102">Min</span><span class="op" id="5468105">.</span><span class="ident" id="5468106">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468110">for</span>&nbsp;<span class="ident" id="5468114">x</span>&nbsp;<span class="op" id="5468116">:=</span>&nbsp;<span class="ident" id="5468119">x0</span><span class="op" id="5468121">;</span>&nbsp;<span class="ident" id="5468123">x</span>&nbsp;<span class="op" id="5468125">!=</span>&nbsp;<span class="ident" id="5468128">x1</span><span class="op" id="5468130">;</span>&nbsp;<span class="ident" id="5468132">x</span><span class="op" id="5468133">,</span>&nbsp;<span class="ident" id="5468135">sx</span><span class="op" id="5468137">,</span>&nbsp;<span class="ident" id="5468139">mx</span>&nbsp;<span class="op" id="5468142">=</span>&nbsp;<span class="ident" id="5468144">x</span><span class="op" id="5468145">+</span><span class="ident" id="5468146">dx</span><span class="op" id="5468148">,</span>&nbsp;<span class="ident" id="5468150">sx</span><span class="op" id="5468152">+</span><span class="ident" id="5468153">dx</span><span class="op" id="5468155">,</span>&nbsp;<span class="ident" id="5468157">mx</span><span class="op" id="5468159">+</span><span class="ident" id="5468160">dx</span>&nbsp;<span class="op" id="5468163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468168">ma</span>&nbsp;<span class="op" id="5468171">:=</span>&nbsp;<span class="builtintype" id="5468174">uint32</span><span class="op" id="5468180">(</span><span class="ident" id="5468181">m</span><span class="op" id="5468182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468187">if</span>&nbsp;<span class="ident" id="5468190">mask</span>&nbsp;<span class="op" id="5468195">!=</span>&nbsp;<span class="ident" id="5468198">nil</span>&nbsp;<span class="op" id="5468202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468208">_</span><span class="op" id="5468209">,</span>&nbsp;<span class="ident" id="5468211">_</span><span class="op" id="5468212">,</span>&nbsp;<span class="ident" id="5468214">_</span><span class="op" id="5468215">,</span>&nbsp;<span class="ident" id="5468217">ma</span>&nbsp;<span class="op" id="5468220">=</span>&nbsp;<span class="ident" id="5468222">mask</span><span class="op" id="5468226">.</span><span class="ident" id="5468227">At</span><span class="op" id="5468229">(</span><span class="ident" id="5468230">mx</span><span class="op" id="5468232">,</span>&nbsp;<span class="ident" id="5468234">my</span><span class="op" id="5468236">)</span><span class="op" id="5468237">.</span><span class="ident" id="5468238">RGBA</span><span class="op" id="5468242">(</span><span class="op" id="5468243">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468253">switch</span>&nbsp;<span class="op" id="5468260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468265">case</span>&nbsp;<span class="ident" id="5468270">ma</span>&nbsp;<span class="op" id="5468273">==</span>&nbsp;<span class="num" id="5468276">0</span><span class="op" id="5468277">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468283">if</span>&nbsp;<span class="ident" id="5468286">op</span>&nbsp;<span class="op" id="5468289">==</span>&nbsp;<span class="ident" id="5468292">Over</span>&nbsp;<span class="op" id="5468297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5468304">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468318">}</span>&nbsp;<span class="keyword" id="5468320">else</span>&nbsp;<span class="op" id="5468325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468332">dst</span><span class="op" id="5468335">.</span><span class="ident" id="5468336">Set</span><span class="op" id="5468339">(</span><span class="ident" id="5468340">x</span><span class="op" id="5468341">,</span>&nbsp;<span class="ident" id="5468343">y</span><span class="op" id="5468344">,</span>&nbsp;<span class="ident" id="5468346">color</span><span class="op" id="5468351">.</span><span class="ident" id="5468352">Transparent</span><span class="op" id="5468363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468374">case</span>&nbsp;<span class="ident" id="5468379">ma</span>&nbsp;<span class="op" id="5468382">==</span>&nbsp;<span class="ident" id="5468385">m</span>&nbsp;<span class="op" id="5468387">&amp;&amp;</span>&nbsp;<span class="ident" id="5468390">op</span>&nbsp;<span class="op" id="5468393">==</span>&nbsp;<span class="ident" id="5468396">Src</span><span class="op" id="5468399">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468405">dst</span><span class="op" id="5468408">.</span><span class="ident" id="5468409">Set</span><span class="op" id="5468412">(</span><span class="ident" id="5468413">x</span><span class="op" id="5468414">,</span>&nbsp;<span class="ident" id="5468416">y</span><span class="op" id="5468417">,</span>&nbsp;<span class="ident" id="5468419">src</span><span class="op" id="5468422">.</span><span class="ident" id="5468423">At</span><span class="op" id="5468425">(</span><span class="ident" id="5468426">sx</span><span class="op" id="5468428">,</span>&nbsp;<span class="ident" id="5468430">sy</span><span class="op" id="5468432">)</span><span class="op" id="5468433">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468438">default</span><span class="op" id="5468445">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468451">sr</span><span class="op" id="5468453">,</span>&nbsp;<span class="ident" id="5468455">sg</span><span class="op" id="5468457">,</span>&nbsp;<span class="ident" id="5468459">sb</span><span class="op" id="5468461">,</span>&nbsp;<span class="ident" id="5468463">sa</span>&nbsp;<span class="op" id="5468466">:=</span>&nbsp;<span class="ident" id="5468469">src</span><span class="op" id="5468472">.</span><span class="ident" id="5468473">At</span><span class="op" id="5468475">(</span><span class="ident" id="5468476">sx</span><span class="op" id="5468478">,</span>&nbsp;<span class="ident" id="5468480">sy</span><span class="op" id="5468482">)</span><span class="op" id="5468483">.</span><span class="ident" id="5468484">RGBA</span><span class="op" id="5468488">(</span><span class="op" id="5468489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5468495">if</span>&nbsp;<span class="ident" id="5468498">op</span>&nbsp;<span class="op" id="5468501">==</span>&nbsp;<span class="ident" id="5468504">Over</span>&nbsp;<span class="op" id="5468509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468516">dr</span><span class="op" id="5468518">,</span>&nbsp;<span class="ident" id="5468520">dg</span><span class="op" id="5468522">,</span>&nbsp;<span class="ident" id="5468524">db</span><span class="op" id="5468526">,</span>&nbsp;<span class="ident" id="5468528">da</span>&nbsp;<span class="op" id="5468531">:=</span>&nbsp;<span class="ident" id="5468534">dst</span><span class="op" id="5468537">.</span><span class="ident" id="5468538">At</span><span class="op" id="5468540">(</span><span class="ident" id="5468541">x</span><span class="op" id="5468542">,</span>&nbsp;<span class="ident" id="5468544">y</span><span class="op" id="5468545">)</span><span class="op" id="5468546">.</span><span class="ident" id="5468547">RGBA</span><span class="op" id="5468551">(</span><span class="op" id="5468552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468559">a</span>&nbsp;<span class="op" id="5468561">:=</span>&nbsp;<span class="ident" id="5468564">m</span>&nbsp;<span class="op" id="5468566">-</span>&nbsp;<span class="op" id="5468568">(</span><span class="ident" id="5468569">sa</span>&nbsp;<span class="op" id="5468572">*</span>&nbsp;<span class="ident" id="5468574">ma</span>&nbsp;<span class="op" id="5468577">/</span>&nbsp;<span class="ident" id="5468579">m</span><span class="op" id="5468580">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468587">out</span><span class="op" id="5468590">.</span><span class="ident" id="5468591">R</span>&nbsp;<span class="op" id="5468593">=</span>&nbsp;<span class="builtintype" id="5468595">uint16</span><span class="op" id="5468601">(</span><span class="op" id="5468602">(</span><span class="ident" id="5468603">dr</span><span class="op" id="5468605">*</span><span class="ident" id="5468606">a</span>&nbsp;<span class="op" id="5468608">+</span>&nbsp;<span class="ident" id="5468610">sr</span><span class="op" id="5468612">*</span><span class="ident" id="5468613">ma</span><span class="op" id="5468615">)</span>&nbsp;<span class="op" id="5468617">/</span>&nbsp;<span class="ident" id="5468619">m</span><span class="op" id="5468620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468627">out</span><span class="op" id="5468630">.</span><span class="ident" id="5468631">G</span>&nbsp;<span class="op" id="5468633">=</span>&nbsp;<span class="builtintype" id="5468635">uint16</span><span class="op" id="5468641">(</span><span class="op" id="5468642">(</span><span class="ident" id="5468643">dg</span><span class="op" id="5468645">*</span><span class="ident" id="5468646">a</span>&nbsp;<span class="op" id="5468648">+</span>&nbsp;<span class="ident" id="5468650">sg</span><span class="op" id="5468652">*</span><span class="ident" id="5468653">ma</span><span class="op" id="5468655">)</span>&nbsp;<span class="op" id="5468657">/</span>&nbsp;<span class="ident" id="5468659">m</span><span class="op" id="5468660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468667">out</span><span class="op" id="5468670">.</span><span class="ident" id="5468671">B</span>&nbsp;<span class="op" id="5468673">=</span>&nbsp;<span class="builtintype" id="5468675">uint16</span><span class="op" id="5468681">(</span><span class="op" id="5468682">(</span><span class="ident" id="5468683">db</span><span class="op" id="5468685">*</span><span class="ident" id="5468686">a</span>&nbsp;<span class="op" id="5468688">+</span>&nbsp;<span class="ident" id="5468690">sb</span><span class="op" id="5468692">*</span><span class="ident" id="5468693">ma</span><span class="op" id="5468695">)</span>&nbsp;<span class="op" id="5468697">/</span>&nbsp;<span class="ident" id="5468699">m</span><span class="op" id="5468700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468707">out</span><span class="op" id="5468710">.</span><span class="ident" id="5468711">A</span>&nbsp;<span class="op" id="5468713">=</span>&nbsp;<span class="builtintype" id="5468715">uint16</span><span class="op" id="5468721">(</span><span class="op" id="5468722">(</span><span class="ident" id="5468723">da</span><span class="op" id="5468725">*</span><span class="ident" id="5468726">a</span>&nbsp;<span class="op" id="5468728">+</span>&nbsp;<span class="ident" id="5468730">sa</span><span class="op" id="5468732">*</span><span class="ident" id="5468733">ma</span><span class="op" id="5468735">)</span>&nbsp;<span class="op" id="5468737">/</span>&nbsp;<span class="ident" id="5468739">m</span><span class="op" id="5468740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468746">}</span>&nbsp;<span class="keyword" id="5468748">else</span>&nbsp;<span class="op" id="5468753">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468760">out</span><span class="op" id="5468763">.</span><span class="ident" id="5468764">R</span>&nbsp;<span class="op" id="5468766">=</span>&nbsp;<span class="builtintype" id="5468768">uint16</span><span class="op" id="5468774">(</span><span class="ident" id="5468775">sr</span>&nbsp;<span class="op" id="5468778">*</span>&nbsp;<span class="ident" id="5468780">ma</span>&nbsp;<span class="op" id="5468783">/</span>&nbsp;<span class="ident" id="5468785">m</span><span class="op" id="5468786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468793">out</span><span class="op" id="5468796">.</span><span class="ident" id="5468797">G</span>&nbsp;<span class="op" id="5468799">=</span>&nbsp;<span class="builtintype" id="5468801">uint16</span><span class="op" id="5468807">(</span><span class="ident" id="5468808">sg</span>&nbsp;<span class="op" id="5468811">*</span>&nbsp;<span class="ident" id="5468813">ma</span>&nbsp;<span class="op" id="5468816">/</span>&nbsp;<span class="ident" id="5468818">m</span><span class="op" id="5468819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468826">out</span><span class="op" id="5468829">.</span><span class="ident" id="5468830">B</span>&nbsp;<span class="op" id="5468832">=</span>&nbsp;<span class="builtintype" id="5468834">uint16</span><span class="op" id="5468840">(</span><span class="ident" id="5468841">sb</span>&nbsp;<span class="op" id="5468844">*</span>&nbsp;<span class="ident" id="5468846">ma</span>&nbsp;<span class="op" id="5468849">/</span>&nbsp;<span class="ident" id="5468851">m</span><span class="op" id="5468852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5468859">out</span><span class="op" id="5468862">.</span><span class="ident" id="5468863">A</span>&nbsp;<span class="op" id="5468865">=</span>&nbsp;<span class="builtintype" id="5468867">uint16</span><span class="op" id="5468873">(</span><span class="ident" id="5468874">sa</span>&nbsp;<span class="op" id="5468877">*</span>&nbsp;<span class="ident" id="5468879">ma</span>&nbsp;<span class="op" id="5468882">/</span>&nbsp;<span class="ident" id="5468884">m</span><span class="op" id="5468885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5468891">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5468897">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5468958">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469023">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469086">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469147">dst</span><span class="op" id="5469150">.</span><span class="ident" id="5469151">Set</span><span class="op" id="5469154">(</span><span class="ident" id="5469155">x</span><span class="op" id="5469156">,</span>&nbsp;<span class="ident" id="5469158">y</span><span class="op" id="5469159">,</span>&nbsp;<span class="op" id="5469161">&amp;</span><span class="ident" id="5469162">out</span><span class="op" id="5469165">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469177">}</span><br>
<span class="lineno"></span><span class="op" id="5469179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5469182">func</span>&nbsp;<span class="ident" id="5469187">drawFillOver</span><span class="op" id="5469199">(</span><span class="ident" id="5469200">dst</span>&nbsp;<span class="op" id="5469204">*</span><span class="ident" id="5469205">image</span><span class="op" id="5469210">.</span><span class="ident" id="5469211">RGBA</span><span class="op" id="5469215">,</span>&nbsp;<span class="ident" id="5469217">r</span>&nbsp;<span class="ident" id="5469219">image</span><span class="op" id="5469224">.</span><span class="ident" id="5469225">Rectangle</span><span class="op" id="5469234">,</span>&nbsp;<span class="ident" id="5469236">src</span>&nbsp;<span class="op" id="5469240">*</span><span class="ident" id="5469241">image</span><span class="op" id="5469246">.</span><span class="ident" id="5469247">Uniform</span><span class="op" id="5469254">)</span>&nbsp;<span class="op" id="5469256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469259">sr</span><span class="op" id="5469261">,</span>&nbsp;<span class="ident" id="5469263">sg</span><span class="op" id="5469265">,</span>&nbsp;<span class="ident" id="5469267">sb</span><span class="op" id="5469269">,</span>&nbsp;<span class="ident" id="5469271">sa</span>&nbsp;<span class="op" id="5469274">:=</span>&nbsp;<span class="ident" id="5469277">src</span><span class="op" id="5469280">.</span><span class="ident" id="5469281">RGBA</span><span class="op" id="5469285">(</span><span class="op" id="5469286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469289">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469347">a</span>&nbsp;<span class="op" id="5469349">:=</span>&nbsp;<span class="op" id="5469352">(</span><span class="ident" id="5469353">m</span>&nbsp;<span class="op" id="5469355">-</span>&nbsp;<span class="ident" id="5469357">sa</span><span class="op" id="5469359">)</span>&nbsp;<span class="op" id="5469361">*</span>&nbsp;<span class="num" id="5469363">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469370">i0</span>&nbsp;<span class="op" id="5469373">:=</span>&nbsp;<span class="ident" id="5469376">dst</span><span class="op" id="5469379">.</span><span class="ident" id="5469380">PixOffset</span><span class="op" id="5469389">(</span><span class="ident" id="5469390">r</span><span class="op" id="5469391">.</span><span class="ident" id="5469392">Min</span><span class="op" id="5469395">.</span><span class="ident" id="5469396">X</span><span class="op" id="5469397">,</span>&nbsp;<span class="ident" id="5469399">r</span><span class="op" id="5469400">.</span><span class="ident" id="5469401">Min</span><span class="op" id="5469404">.</span><span class="ident" id="5469405">Y</span><span class="op" id="5469406">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469409">i1</span>&nbsp;<span class="op" id="5469412">:=</span>&nbsp;<span class="ident" id="5469415">i0</span>&nbsp;<span class="op" id="5469418">+</span>&nbsp;<span class="ident" id="5469420">r</span><span class="op" id="5469421">.</span><span class="ident" id="5469422">Dx</span><span class="op" id="5469424">(</span><span class="op" id="5469425">)</span><span class="op" id="5469426">*</span><span class="num" id="5469427">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469430">for</span>&nbsp;<span class="ident" id="5469434">y</span>&nbsp;<span class="op" id="5469436">:=</span>&nbsp;<span class="ident" id="5469439">r</span><span class="op" id="5469440">.</span><span class="ident" id="5469441">Min</span><span class="op" id="5469444">.</span><span class="ident" id="5469445">Y</span><span class="op" id="5469446">;</span>&nbsp;<span class="ident" id="5469448">y</span>&nbsp;<span class="op" id="5469450">!=</span>&nbsp;<span class="ident" id="5469453">r</span><span class="op" id="5469454">.</span><span class="ident" id="5469455">Max</span><span class="op" id="5469458">.</span><span class="ident" id="5469459">Y</span><span class="op" id="5469460">;</span>&nbsp;<span class="ident" id="5469462">y</span><span class="op" id="5469463">++</span>&nbsp;<span class="op" id="5469466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5469470">for</span>&nbsp;<span class="ident" id="5469474">i</span>&nbsp;<span class="op" id="5469476">:=</span>&nbsp;<span class="ident" id="5469479">i0</span><span class="op" id="5469481">;</span>&nbsp;<span class="ident" id="5469483">i</span>&nbsp;<span class="op" id="5469485">&lt;</span>&nbsp;<span class="ident" id="5469487">i1</span><span class="op" id="5469489">;</span>&nbsp;<span class="ident" id="5469491">i</span>&nbsp;<span class="op" id="5469493">+=</span>&nbsp;<span class="num" id="5469496">4</span>&nbsp;<span class="op" id="5469498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469503">dr</span>&nbsp;<span class="op" id="5469506">:=</span>&nbsp;<span class="builtintype" id="5469509">uint32</span><span class="op" id="5469515">(</span><span class="ident" id="5469516">dst</span><span class="op" id="5469519">.</span><span class="ident" id="5469520">Pix</span><span class="op" id="5469523">[</span><span class="ident" id="5469524">i</span><span class="op" id="5469525">+</span><span class="num" id="5469526">0</span><span class="op" id="5469527">]</span><span class="op" id="5469528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469533">dg</span>&nbsp;<span class="op" id="5469536">:=</span>&nbsp;<span class="builtintype" id="5469539">uint32</span><span class="op" id="5469545">(</span><span class="ident" id="5469546">dst</span><span class="op" id="5469549">.</span><span class="ident" id="5469550">Pix</span><span class="op" id="5469553">[</span><span class="ident" id="5469554">i</span><span class="op" id="5469555">+</span><span class="num" id="5469556">1</span><span class="op" id="5469557">]</span><span class="op" id="5469558">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469563">db</span>&nbsp;<span class="op" id="5469566">:=</span>&nbsp;<span class="builtintype" id="5469569">uint32</span><span class="op" id="5469575">(</span><span class="ident" id="5469576">dst</span><span class="op" id="5469579">.</span><span class="ident" id="5469580">Pix</span><span class="op" id="5469583">[</span><span class="ident" id="5469584">i</span><span class="op" id="5469585">+</span><span class="num" id="5469586">2</span><span class="op" id="5469587">]</span><span class="op" id="5469588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469593">da</span>&nbsp;<span class="op" id="5469596">:=</span>&nbsp;<span class="builtintype" id="5469599">uint32</span><span class="op" id="5469605">(</span><span class="ident" id="5469606">dst</span><span class="op" id="5469609">.</span><span class="ident" id="5469610">Pix</span><span class="op" id="5469613">[</span><span class="ident" id="5469614">i</span><span class="op" id="5469615">+</span><span class="num" id="5469616">3</span><span class="op" id="5469617">]</span><span class="op" id="5469618">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469624">dst</span><span class="op" id="5469627">.</span><span class="ident" id="5469628">Pix</span><span class="op" id="5469631">[</span><span class="ident" id="5469632">i</span><span class="op" id="5469633">+</span><span class="num" id="5469634">0</span><span class="op" id="5469635">]</span>&nbsp;<span class="op" id="5469637">=</span>&nbsp;<span class="builtintype" id="5469639">uint8</span><span class="op" id="5469644">(</span><span class="op" id="5469645">(</span><span class="ident" id="5469646">dr</span><span class="op" id="5469648">*</span><span class="ident" id="5469649">a</span><span class="op" id="5469650">/</span><span class="ident" id="5469651">m</span>&nbsp;<span class="op" id="5469653">+</span>&nbsp;<span class="ident" id="5469655">sr</span><span class="op" id="5469657">)</span>&nbsp;<span class="op" id="5469659">&gt;&gt;</span>&nbsp;<span class="num" id="5469662">8</span><span class="op" id="5469663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469668">dst</span><span class="op" id="5469671">.</span><span class="ident" id="5469672">Pix</span><span class="op" id="5469675">[</span><span class="ident" id="5469676">i</span><span class="op" id="5469677">+</span><span class="num" id="5469678">1</span><span class="op" id="5469679">]</span>&nbsp;<span class="op" id="5469681">=</span>&nbsp;<span class="builtintype" id="5469683">uint8</span><span class="op" id="5469688">(</span><span class="op" id="5469689">(</span><span class="ident" id="5469690">dg</span><span class="op" id="5469692">*</span><span class="ident" id="5469693">a</span><span class="op" id="5469694">/</span><span class="ident" id="5469695">m</span>&nbsp;<span class="op" id="5469697">+</span>&nbsp;<span class="ident" id="5469699">sg</span><span class="op" id="5469701">)</span>&nbsp;<span class="op" id="5469703">&gt;&gt;</span>&nbsp;<span class="num" id="5469706">8</span><span class="op" id="5469707">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469712">dst</span><span class="op" id="5469715">.</span><span class="ident" id="5469716">Pix</span><span class="op" id="5469719">[</span><span class="ident" id="5469720">i</span><span class="op" id="5469721">+</span><span class="num" id="5469722">2</span><span class="op" id="5469723">]</span>&nbsp;<span class="op" id="5469725">=</span>&nbsp;<span class="builtintype" id="5469727">uint8</span><span class="op" id="5469732">(</span><span class="op" id="5469733">(</span><span class="ident" id="5469734">db</span><span class="op" id="5469736">*</span><span class="ident" id="5469737">a</span><span class="op" id="5469738">/</span><span class="ident" id="5469739">m</span>&nbsp;<span class="op" id="5469741">+</span>&nbsp;<span class="ident" id="5469743">sb</span><span class="op" id="5469745">)</span>&nbsp;<span class="op" id="5469747">&gt;&gt;</span>&nbsp;<span class="num" id="5469750">8</span><span class="op" id="5469751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469756">dst</span><span class="op" id="5469759">.</span><span class="ident" id="5469760">Pix</span><span class="op" id="5469763">[</span><span class="ident" id="5469764">i</span><span class="op" id="5469765">+</span><span class="num" id="5469766">3</span><span class="op" id="5469767">]</span>&nbsp;<span class="op" id="5469769">=</span>&nbsp;<span class="builtintype" id="5469771">uint8</span><span class="op" id="5469776">(</span><span class="op" id="5469777">(</span><span class="ident" id="5469778">da</span><span class="op" id="5469780">*</span><span class="ident" id="5469781">a</span><span class="op" id="5469782">/</span><span class="ident" id="5469783">m</span>&nbsp;<span class="op" id="5469785">+</span>&nbsp;<span class="ident" id="5469787">sa</span><span class="op" id="5469789">)</span>&nbsp;<span class="op" id="5469791">&gt;&gt;</span>&nbsp;<span class="num" id="5469794">8</span><span class="op" id="5469795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469803">i0</span>&nbsp;<span class="op" id="5469806">+=</span>&nbsp;<span class="ident" id="5469809">dst</span><span class="op" id="5469812">.</span><span class="ident" id="5469813">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469822">i1</span>&nbsp;<span class="op" id="5469825">+=</span>&nbsp;<span class="ident" id="5469828">dst</span><span class="op" id="5469831">.</span><span class="ident" id="5469832">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5469840">}</span><br>
<span class="lineno"></span><span class="op" id="5469842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5469845">func</span>&nbsp;<span class="ident" id="5469850">drawFillSrc</span><span class="op" id="5469861">(</span><span class="ident" id="5469862">dst</span>&nbsp;<span class="op" id="5469866">*</span><span class="ident" id="5469867">image</span><span class="op" id="5469872">.</span><span class="ident" id="5469873">RGBA</span><span class="op" id="5469877">,</span>&nbsp;<span class="ident" id="5469879">r</span>&nbsp;<span class="ident" id="5469881">image</span><span class="op" id="5469886">.</span><span class="ident" id="5469887">Rectangle</span><span class="op" id="5469896">,</span>&nbsp;<span class="ident" id="5469898">src</span>&nbsp;<span class="op" id="5469902">*</span><span class="ident" id="5469903">image</span><span class="op" id="5469908">.</span><span class="ident" id="5469909">Uniform</span><span class="op" id="5469916">)</span>&nbsp;<span class="op" id="5469918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5469921">sr</span><span class="op" id="5469923">,</span>&nbsp;<span class="ident" id="5469925">sg</span><span class="op" id="5469927">,</span>&nbsp;<span class="ident" id="5469929">sb</span><span class="op" id="5469931">,</span>&nbsp;<span class="ident" id="5469933">sa</span>&nbsp;<span class="op" id="5469936">:=</span>&nbsp;<span class="ident" id="5469939">src</span><span class="op" id="5469942">.</span><span class="ident" id="5469943">RGBA</span><span class="op" id="5469947">(</span><span class="op" id="5469948">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5469951">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470053">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470157">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470228">i0</span>&nbsp;<span class="op" id="5470231">:=</span>&nbsp;<span class="ident" id="5470234">dst</span><span class="op" id="5470237">.</span><span class="ident" id="5470238">PixOffset</span><span class="op" id="5470247">(</span><span class="ident" id="5470248">r</span><span class="op" id="5470249">.</span><span class="ident" id="5470250">Min</span><span class="op" id="5470253">.</span><span class="ident" id="5470254">X</span><span class="op" id="5470255">,</span>&nbsp;<span class="ident" id="5470257">r</span><span class="op" id="5470258">.</span><span class="ident" id="5470259">Min</span><span class="op" id="5470262">.</span><span class="ident" id="5470263">Y</span><span class="op" id="5470264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470267">i1</span>&nbsp;<span class="op" id="5470270">:=</span>&nbsp;<span class="ident" id="5470273">i0</span>&nbsp;<span class="op" id="5470276">+</span>&nbsp;<span class="ident" id="5470278">r</span><span class="op" id="5470279">.</span><span class="ident" id="5470280">Dx</span><span class="op" id="5470282">(</span><span class="op" id="5470283">)</span><span class="op" id="5470284">*</span><span class="num" id="5470285">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470288">for</span>&nbsp;<span class="ident" id="5470292">i</span>&nbsp;<span class="op" id="5470294">:=</span>&nbsp;<span class="ident" id="5470297">i0</span><span class="op" id="5470299">;</span>&nbsp;<span class="ident" id="5470301">i</span>&nbsp;<span class="op" id="5470303">&lt;</span>&nbsp;<span class="ident" id="5470305">i1</span><span class="op" id="5470307">;</span>&nbsp;<span class="ident" id="5470309">i</span>&nbsp;<span class="op" id="5470311">+=</span>&nbsp;<span class="num" id="5470314">4</span>&nbsp;<span class="op" id="5470316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470320">dst</span><span class="op" id="5470323">.</span><span class="ident" id="5470324">Pix</span><span class="op" id="5470327">[</span><span class="ident" id="5470328">i</span><span class="op" id="5470329">+</span><span class="num" id="5470330">0</span><span class="op" id="5470331">]</span>&nbsp;<span class="op" id="5470333">=</span>&nbsp;<span class="builtintype" id="5470335">uint8</span><span class="op" id="5470340">(</span><span class="ident" id="5470341">sr</span>&nbsp;<span class="op" id="5470344">&gt;&gt;</span>&nbsp;<span class="num" id="5470347">8</span><span class="op" id="5470348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470352">dst</span><span class="op" id="5470355">.</span><span class="ident" id="5470356">Pix</span><span class="op" id="5470359">[</span><span class="ident" id="5470360">i</span><span class="op" id="5470361">+</span><span class="num" id="5470362">1</span><span class="op" id="5470363">]</span>&nbsp;<span class="op" id="5470365">=</span>&nbsp;<span class="builtintype" id="5470367">uint8</span><span class="op" id="5470372">(</span><span class="ident" id="5470373">sg</span>&nbsp;<span class="op" id="5470376">&gt;&gt;</span>&nbsp;<span class="num" id="5470379">8</span><span class="op" id="5470380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470384">dst</span><span class="op" id="5470387">.</span><span class="ident" id="5470388">Pix</span><span class="op" id="5470391">[</span><span class="ident" id="5470392">i</span><span class="op" id="5470393">+</span><span class="num" id="5470394">2</span><span class="op" id="5470395">]</span>&nbsp;<span class="op" id="5470397">=</span>&nbsp;<span class="builtintype" id="5470399">uint8</span><span class="op" id="5470404">(</span><span class="ident" id="5470405">sb</span>&nbsp;<span class="op" id="5470408">&gt;&gt;</span>&nbsp;<span class="num" id="5470411">8</span><span class="op" id="5470412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470416">dst</span><span class="op" id="5470419">.</span><span class="ident" id="5470420">Pix</span><span class="op" id="5470423">[</span><span class="ident" id="5470424">i</span><span class="op" id="5470425">+</span><span class="num" id="5470426">3</span><span class="op" id="5470427">]</span>&nbsp;<span class="op" id="5470429">=</span>&nbsp;<span class="builtintype" id="5470431">uint8</span><span class="op" id="5470436">(</span><span class="ident" id="5470437">sa</span>&nbsp;<span class="op" id="5470440">&gt;&gt;</span>&nbsp;<span class="num" id="5470443">8</span><span class="op" id="5470444">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470450">firstRow</span>&nbsp;<span class="op" id="5470459">:=</span>&nbsp;<span class="ident" id="5470462">dst</span><span class="op" id="5470465">.</span><span class="ident" id="5470466">Pix</span><span class="op" id="5470469">[</span><span class="ident" id="5470470">i0</span><span class="op" id="5470472">:</span><span class="ident" id="5470473">i1</span><span class="op" id="5470475">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470478">for</span>&nbsp;<span class="ident" id="5470482">y</span>&nbsp;<span class="op" id="5470484">:=</span>&nbsp;<span class="ident" id="5470487">r</span><span class="op" id="5470488">.</span><span class="ident" id="5470489">Min</span><span class="op" id="5470492">.</span><span class="ident" id="5470493">Y</span>&nbsp;<span class="op" id="5470495">+</span>&nbsp;<span class="num" id="5470497">1</span><span class="op" id="5470498">;</span>&nbsp;<span class="ident" id="5470500">y</span>&nbsp;<span class="op" id="5470502">&lt;</span>&nbsp;<span class="ident" id="5470504">r</span><span class="op" id="5470505">.</span><span class="ident" id="5470506">Max</span><span class="op" id="5470509">.</span><span class="ident" id="5470510">Y</span><span class="op" id="5470511">;</span>&nbsp;<span class="ident" id="5470513">y</span><span class="op" id="5470514">++</span>&nbsp;<span class="op" id="5470517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470521">i0</span>&nbsp;<span class="op" id="5470524">+=</span>&nbsp;<span class="ident" id="5470527">dst</span><span class="op" id="5470530">.</span><span class="ident" id="5470531">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470540">i1</span>&nbsp;<span class="op" id="5470543">+=</span>&nbsp;<span class="ident" id="5470546">dst</span><span class="op" id="5470549">.</span><span class="ident" id="5470550">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5470559">copy</span><span class="op" id="5470563">(</span><span class="ident" id="5470564">dst</span><span class="op" id="5470567">.</span><span class="ident" id="5470568">Pix</span><span class="op" id="5470571">[</span><span class="ident" id="5470572">i0</span><span class="op" id="5470574">:</span><span class="ident" id="5470575">i1</span><span class="op" id="5470577">]</span><span class="op" id="5470578">,</span>&nbsp;<span class="ident" id="5470580">firstRow</span><span class="op" id="5470588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470591">}</span><br>
<span class="lineno"></span><span class="op" id="5470593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5470596">func</span>&nbsp;<span class="ident" id="5470601">drawCopyOver</span><span class="op" id="5470613">(</span><span class="ident" id="5470614">dst</span>&nbsp;<span class="op" id="5470618">*</span><span class="ident" id="5470619">image</span><span class="op" id="5470624">.</span><span class="ident" id="5470625">RGBA</span><span class="op" id="5470629">,</span>&nbsp;<span class="ident" id="5470631">r</span>&nbsp;<span class="ident" id="5470633">image</span><span class="op" id="5470638">.</span><span class="ident" id="5470639">Rectangle</span><span class="op" id="5470648">,</span>&nbsp;<span class="ident" id="5470650">src</span>&nbsp;<span class="op" id="5470654">*</span><span class="ident" id="5470655">image</span><span class="op" id="5470660">.</span><span class="ident" id="5470661">RGBA</span><span class="op" id="5470665">,</span>&nbsp;<span class="ident" id="5470667">sp</span>&nbsp;<span class="ident" id="5470670">image</span><span class="op" id="5470675">.</span><span class="ident" id="5470676">Point</span><span class="op" id="5470681">)</span>&nbsp;<span class="op" id="5470683">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470686">dx</span><span class="op" id="5470688">,</span>&nbsp;<span class="ident" id="5470690">dy</span>&nbsp;<span class="op" id="5470693">:=</span>&nbsp;<span class="ident" id="5470696">r</span><span class="op" id="5470697">.</span><span class="ident" id="5470698">Dx</span><span class="op" id="5470700">(</span><span class="op" id="5470701">)</span><span class="op" id="5470702">,</span>&nbsp;<span class="ident" id="5470704">r</span><span class="op" id="5470705">.</span><span class="ident" id="5470706">Dy</span><span class="op" id="5470708">(</span><span class="op" id="5470709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470712">d0</span>&nbsp;<span class="op" id="5470715">:=</span>&nbsp;<span class="ident" id="5470718">dst</span><span class="op" id="5470721">.</span><span class="ident" id="5470722">PixOffset</span><span class="op" id="5470731">(</span><span class="ident" id="5470732">r</span><span class="op" id="5470733">.</span><span class="ident" id="5470734">Min</span><span class="op" id="5470737">.</span><span class="ident" id="5470738">X</span><span class="op" id="5470739">,</span>&nbsp;<span class="ident" id="5470741">r</span><span class="op" id="5470742">.</span><span class="ident" id="5470743">Min</span><span class="op" id="5470746">.</span><span class="ident" id="5470747">Y</span><span class="op" id="5470748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470751">s0</span>&nbsp;<span class="op" id="5470754">:=</span>&nbsp;<span class="ident" id="5470757">src</span><span class="op" id="5470760">.</span><span class="ident" id="5470761">PixOffset</span><span class="op" id="5470770">(</span><span class="ident" id="5470771">sp</span><span class="op" id="5470773">.</span><span class="ident" id="5470774">X</span><span class="op" id="5470775">,</span>&nbsp;<span class="ident" id="5470777">sp</span><span class="op" id="5470779">.</span><span class="ident" id="5470780">Y</span><span class="op" id="5470781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470784">var</span>&nbsp;<span class="op" id="5470788">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470792">ddelta</span><span class="op" id="5470798">,</span>&nbsp;<span class="ident" id="5470800">sdelta</span>&nbsp;<span class="builtintype" id="5470807">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470813">i0</span><span class="op" id="5470815">,</span>&nbsp;<span class="ident" id="5470817">i1</span><span class="op" id="5470819">,</span>&nbsp;<span class="ident" id="5470821">idelta</span>&nbsp;<span class="builtintype" id="5470828">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5470836">if</span>&nbsp;<span class="ident" id="5470839">r</span><span class="op" id="5470840">.</span><span class="ident" id="5470841">Min</span><span class="op" id="5470844">.</span><span class="ident" id="5470845">Y</span>&nbsp;<span class="op" id="5470847">&lt;</span>&nbsp;<span class="ident" id="5470849">sp</span><span class="op" id="5470851">.</span><span class="ident" id="5470852">Y</span>&nbsp;<span class="op" id="5470854">||</span>&nbsp;<span class="ident" id="5470857">r</span><span class="op" id="5470858">.</span><span class="ident" id="5470859">Min</span><span class="op" id="5470862">.</span><span class="ident" id="5470863">Y</span>&nbsp;<span class="op" id="5470865">==</span>&nbsp;<span class="ident" id="5470868">sp</span><span class="op" id="5470870">.</span><span class="ident" id="5470871">Y</span>&nbsp;<span class="op" id="5470873">&amp;&amp;</span>&nbsp;<span class="ident" id="5470876">r</span><span class="op" id="5470877">.</span><span class="ident" id="5470878">Min</span><span class="op" id="5470881">.</span><span class="ident" id="5470882">X</span>&nbsp;<span class="op" id="5470884">&lt;=</span>&nbsp;<span class="ident" id="5470887">sp</span><span class="op" id="5470889">.</span><span class="ident" id="5470890">X</span>&nbsp;<span class="op" id="5470892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470896">ddelta</span>&nbsp;<span class="op" id="5470903">=</span>&nbsp;<span class="ident" id="5470905">dst</span><span class="op" id="5470908">.</span><span class="ident" id="5470909">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470918">sdelta</span>&nbsp;<span class="op" id="5470925">=</span>&nbsp;<span class="ident" id="5470927">src</span><span class="op" id="5470930">.</span><span class="ident" id="5470931">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5470940">i0</span><span class="op" id="5470942">,</span>&nbsp;<span class="ident" id="5470944">i1</span><span class="op" id="5470946">,</span>&nbsp;<span class="ident" id="5470948">idelta</span>&nbsp;<span class="op" id="5470955">=</span>&nbsp;<span class="num" id="5470957">0</span><span class="op" id="5470958">,</span>&nbsp;<span class="ident" id="5470960">dx</span><span class="op" id="5470962">*</span><span class="num" id="5470963">4</span><span class="op" id="5470964">,</span>&nbsp;<span class="op" id="5470966">+</span><span class="num" id="5470967">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5470970">}</span>&nbsp;<span class="keyword" id="5470972">else</span>&nbsp;<span class="op" id="5470977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5470981">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5471089">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471189">d0</span>&nbsp;<span class="op" id="5471192">+=</span>&nbsp;<span class="op" id="5471195">(</span><span class="ident" id="5471196">dy</span>&nbsp;<span class="op" id="5471199">-</span>&nbsp;<span class="num" id="5471201">1</span><span class="op" id="5471202">)</span>&nbsp;<span class="op" id="5471204">*</span>&nbsp;<span class="ident" id="5471206">dst</span><span class="op" id="5471209">.</span><span class="ident" id="5471210">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471219">s0</span>&nbsp;<span class="op" id="5471222">+=</span>&nbsp;<span class="op" id="5471225">(</span><span class="ident" id="5471226">dy</span>&nbsp;<span class="op" id="5471229">-</span>&nbsp;<span class="num" id="5471231">1</span><span class="op" id="5471232">)</span>&nbsp;<span class="op" id="5471234">*</span>&nbsp;<span class="ident" id="5471236">src</span><span class="op" id="5471239">.</span><span class="ident" id="5471240">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471249">ddelta</span>&nbsp;<span class="op" id="5471256">=</span>&nbsp;<span class="op" id="5471258">-</span><span class="ident" id="5471259">dst</span><span class="op" id="5471262">.</span><span class="ident" id="5471263">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471272">sdelta</span>&nbsp;<span class="op" id="5471279">=</span>&nbsp;<span class="op" id="5471281">-</span><span class="ident" id="5471282">src</span><span class="op" id="5471285">.</span><span class="ident" id="5471286">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471295">i0</span><span class="op" id="5471297">,</span>&nbsp;<span class="ident" id="5471299">i1</span><span class="op" id="5471301">,</span>&nbsp;<span class="ident" id="5471303">idelta</span>&nbsp;<span class="op" id="5471310">=</span>&nbsp;<span class="op" id="5471312">(</span><span class="ident" id="5471313">dx</span><span class="op" id="5471315">-</span><span class="num" id="5471316">1</span><span class="op" id="5471317">)</span><span class="op" id="5471318">*</span><span class="num" id="5471319">4</span><span class="op" id="5471320">,</span>&nbsp;<span class="op" id="5471322">-</span><span class="num" id="5471323">4</span><span class="op" id="5471324">,</span>&nbsp;<span class="op" id="5471326">-</span><span class="num" id="5471327">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5471330">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471333">for</span>&nbsp;<span class="op" id="5471337">;</span>&nbsp;<span class="ident" id="5471339">dy</span>&nbsp;<span class="op" id="5471342">&gt;</span>&nbsp;<span class="num" id="5471344">0</span><span class="op" id="5471345">;</span>&nbsp;<span class="ident" id="5471347">dy</span><span class="op" id="5471349">--</span>&nbsp;<span class="op" id="5471352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471356">dpix</span>&nbsp;<span class="op" id="5471361">:=</span>&nbsp;<span class="ident" id="5471364">dst</span><span class="op" id="5471367">.</span><span class="ident" id="5471368">Pix</span><span class="op" id="5471371">[</span><span class="ident" id="5471372">d0</span><span class="op" id="5471374">:</span><span class="op" id="5471375">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471379">spix</span>&nbsp;<span class="op" id="5471384">:=</span>&nbsp;<span class="ident" id="5471387">src</span><span class="op" id="5471390">.</span><span class="ident" id="5471391">Pix</span><span class="op" id="5471394">[</span><span class="ident" id="5471395">s0</span><span class="op" id="5471397">:</span><span class="op" id="5471398">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5471402">for</span>&nbsp;<span class="ident" id="5471406">i</span>&nbsp;<span class="op" id="5471408">:=</span>&nbsp;<span class="ident" id="5471411">i0</span><span class="op" id="5471413">;</span>&nbsp;<span class="ident" id="5471415">i</span>&nbsp;<span class="op" id="5471417">!=</span>&nbsp;<span class="ident" id="5471420">i1</span><span class="op" id="5471422">;</span>&nbsp;<span class="ident" id="5471424">i</span>&nbsp;<span class="op" id="5471426">+=</span>&nbsp;<span class="ident" id="5471429">idelta</span>&nbsp;<span class="op" id="5471436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471441">sr</span>&nbsp;<span class="op" id="5471444">:=</span>&nbsp;<span class="builtintype" id="5471447">uint32</span><span class="op" id="5471453">(</span><span class="ident" id="5471454">spix</span><span class="op" id="5471458">[</span><span class="ident" id="5471459">i</span><span class="op" id="5471460">+</span><span class="num" id="5471461">0</span><span class="op" id="5471462">]</span><span class="op" id="5471463">)</span>&nbsp;<span class="op" id="5471465">*</span>&nbsp;<span class="num" id="5471467">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471476">sg</span>&nbsp;<span class="op" id="5471479">:=</span>&nbsp;<span class="builtintype" id="5471482">uint32</span><span class="op" id="5471488">(</span><span class="ident" id="5471489">spix</span><span class="op" id="5471493">[</span><span class="ident" id="5471494">i</span><span class="op" id="5471495">+</span><span class="num" id="5471496">1</span><span class="op" id="5471497">]</span><span class="op" id="5471498">)</span>&nbsp;<span class="op" id="5471500">*</span>&nbsp;<span class="num" id="5471502">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471511">sb</span>&nbsp;<span class="op" id="5471514">:=</span>&nbsp;<span class="builtintype" id="5471517">uint32</span><span class="op" id="5471523">(</span><span class="ident" id="5471524">spix</span><span class="op" id="5471528">[</span><span class="ident" id="5471529">i</span><span class="op" id="5471530">+</span><span class="num" id="5471531">2</span><span class="op" id="5471532">]</span><span class="op" id="5471533">)</span>&nbsp;<span class="op" id="5471535">*</span>&nbsp;<span class="num" id="5471537">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471546">sa</span>&nbsp;<span class="op" id="5471549">:=</span>&nbsp;<span class="builtintype" id="5471552">uint32</span><span class="op" id="5471558">(</span><span class="ident" id="5471559">spix</span><span class="op" id="5471563">[</span><span class="ident" id="5471564">i</span><span class="op" id="5471565">+</span><span class="num" id="5471566">3</span><span class="op" id="5471567">]</span><span class="op" id="5471568">)</span>&nbsp;<span class="op" id="5471570">*</span>&nbsp;<span class="num" id="5471572">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471582">dr</span>&nbsp;<span class="op" id="5471585">:=</span>&nbsp;<span class="builtintype" id="5471588">uint32</span><span class="op" id="5471594">(</span><span class="ident" id="5471595">dpix</span><span class="op" id="5471599">[</span><span class="ident" id="5471600">i</span><span class="op" id="5471601">+</span><span class="num" id="5471602">0</span><span class="op" id="5471603">]</span><span class="op" id="5471604">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471609">dg</span>&nbsp;<span class="op" id="5471612">:=</span>&nbsp;<span class="builtintype" id="5471615">uint32</span><span class="op" id="5471621">(</span><span class="ident" id="5471622">dpix</span><span class="op" id="5471626">[</span><span class="ident" id="5471627">i</span><span class="op" id="5471628">+</span><span class="num" id="5471629">1</span><span class="op" id="5471630">]</span><span class="op" id="5471631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471636">db</span>&nbsp;<span class="op" id="5471639">:=</span>&nbsp;<span class="builtintype" id="5471642">uint32</span><span class="op" id="5471648">(</span><span class="ident" id="5471649">dpix</span><span class="op" id="5471653">[</span><span class="ident" id="5471654">i</span><span class="op" id="5471655">+</span><span class="num" id="5471656">2</span><span class="op" id="5471657">]</span><span class="op" id="5471658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471663">da</span>&nbsp;<span class="op" id="5471666">:=</span>&nbsp;<span class="builtintype" id="5471669">uint32</span><span class="op" id="5471675">(</span><span class="ident" id="5471676">dpix</span><span class="op" id="5471680">[</span><span class="ident" id="5471681">i</span><span class="op" id="5471682">+</span><span class="num" id="5471683">3</span><span class="op" id="5471684">]</span><span class="op" id="5471685">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5471691">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471751">a</span>&nbsp;<span class="op" id="5471753">:=</span>&nbsp;<span class="op" id="5471756">(</span><span class="ident" id="5471757">m</span>&nbsp;<span class="op" id="5471759">-</span>&nbsp;<span class="ident" id="5471761">sa</span><span class="op" id="5471763">)</span>&nbsp;<span class="op" id="5471765">*</span>&nbsp;<span class="num" id="5471767">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471777">dpix</span><span class="op" id="5471781">[</span><span class="ident" id="5471782">i</span><span class="op" id="5471783">+</span><span class="num" id="5471784">0</span><span class="op" id="5471785">]</span>&nbsp;<span class="op" id="5471787">=</span>&nbsp;<span class="builtintype" id="5471789">uint8</span><span class="op" id="5471794">(</span><span class="op" id="5471795">(</span><span class="ident" id="5471796">dr</span><span class="op" id="5471798">*</span><span class="ident" id="5471799">a</span><span class="op" id="5471800">/</span><span class="ident" id="5471801">m</span>&nbsp;<span class="op" id="5471803">+</span>&nbsp;<span class="ident" id="5471805">sr</span><span class="op" id="5471807">)</span>&nbsp;<span class="op" id="5471809">&gt;&gt;</span>&nbsp;<span class="num" id="5471812">8</span><span class="op" id="5471813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471818">dpix</span><span class="op" id="5471822">[</span><span class="ident" id="5471823">i</span><span class="op" id="5471824">+</span><span class="num" id="5471825">1</span><span class="op" id="5471826">]</span>&nbsp;<span class="op" id="5471828">=</span>&nbsp;<span class="builtintype" id="5471830">uint8</span><span class="op" id="5471835">(</span><span class="op" id="5471836">(</span><span class="ident" id="5471837">dg</span><span class="op" id="5471839">*</span><span class="ident" id="5471840">a</span><span class="op" id="5471841">/</span><span class="ident" id="5471842">m</span>&nbsp;<span class="op" id="5471844">+</span>&nbsp;<span class="ident" id="5471846">sg</span><span class="op" id="5471848">)</span>&nbsp;<span class="op" id="5471850">&gt;&gt;</span>&nbsp;<span class="num" id="5471853">8</span><span class="op" id="5471854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471859">dpix</span><span class="op" id="5471863">[</span><span class="ident" id="5471864">i</span><span class="op" id="5471865">+</span><span class="num" id="5471866">2</span><span class="op" id="5471867">]</span>&nbsp;<span class="op" id="5471869">=</span>&nbsp;<span class="builtintype" id="5471871">uint8</span><span class="op" id="5471876">(</span><span class="op" id="5471877">(</span><span class="ident" id="5471878">db</span><span class="op" id="5471880">*</span><span class="ident" id="5471881">a</span><span class="op" id="5471882">/</span><span class="ident" id="5471883">m</span>&nbsp;<span class="op" id="5471885">+</span>&nbsp;<span class="ident" id="5471887">sb</span><span class="op" id="5471889">)</span>&nbsp;<span class="op" id="5471891">&gt;&gt;</span>&nbsp;<span class="num" id="5471894">8</span><span class="op" id="5471895">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471900">dpix</span><span class="op" id="5471904">[</span><span class="ident" id="5471905">i</span><span class="op" id="5471906">+</span><span class="num" id="5471907">3</span><span class="op" id="5471908">]</span>&nbsp;<span class="op" id="5471910">=</span>&nbsp;<span class="builtintype" id="5471912">uint8</span><span class="op" id="5471917">(</span><span class="op" id="5471918">(</span><span class="ident" id="5471919">da</span><span class="op" id="5471921">*</span><span class="ident" id="5471922">a</span><span class="op" id="5471923">/</span><span class="ident" id="5471924">m</span>&nbsp;<span class="op" id="5471926">+</span>&nbsp;<span class="ident" id="5471928">sa</span><span class="op" id="5471930">)</span>&nbsp;<span class="op" id="5471932">&gt;&gt;</span>&nbsp;<span class="num" id="5471935">8</span><span class="op" id="5471936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5471940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471944">d0</span>&nbsp;<span class="op" id="5471947">+=</span>&nbsp;<span class="ident" id="5471950">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5471959">s0</span>&nbsp;<span class="op" id="5471962">+=</span>&nbsp;<span class="ident" id="5471965">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5471973">}</span><br>
<span class="lineno">305</span><span class="op" id="5471975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5471978">func</span>&nbsp;<span class="ident" id="5471983">drawCopySrc</span><span class="op" id="5471994">(</span><span class="ident" id="5471995">dst</span>&nbsp;<span class="op" id="5471999">*</span><span class="ident" id="5472000">image</span><span class="op" id="5472005">.</span><span class="ident" id="5472006">RGBA</span><span class="op" id="5472010">,</span>&nbsp;<span class="ident" id="5472012">r</span>&nbsp;<span class="ident" id="5472014">image</span><span class="op" id="5472019">.</span><span class="ident" id="5472020">Rectangle</span><span class="op" id="5472029">,</span>&nbsp;<span class="ident" id="5472031">src</span>&nbsp;<span class="op" id="5472035">*</span><span class="ident" id="5472036">image</span><span class="op" id="5472041">.</span><span class="ident" id="5472042">RGBA</span><span class="op" id="5472046">,</span>&nbsp;<span class="ident" id="5472048">sp</span>&nbsp;<span class="ident" id="5472051">image</span><span class="op" id="5472056">.</span><span class="ident" id="5472057">Point</span><span class="op" id="5472062">)</span>&nbsp;<span class="op" id="5472064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472067">n</span><span class="op" id="5472068">,</span>&nbsp;<span class="ident" id="5472070">dy</span>&nbsp;<span class="op" id="5472073">:=</span>&nbsp;<span class="num" id="5472076">4</span><span class="op" id="5472077">*</span><span class="ident" id="5472078">r</span><span class="op" id="5472079">.</span><span class="ident" id="5472080">Dx</span><span class="op" id="5472082">(</span><span class="op" id="5472083">)</span><span class="op" id="5472084">,</span>&nbsp;<span class="ident" id="5472086">r</span><span class="op" id="5472087">.</span><span class="ident" id="5472088">Dy</span><span class="op" id="5472090">(</span><span class="op" id="5472091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472094">d0</span>&nbsp;<span class="op" id="5472097">:=</span>&nbsp;<span class="ident" id="5472100">dst</span><span class="op" id="5472103">.</span><span class="ident" id="5472104">PixOffset</span><span class="op" id="5472113">(</span><span class="ident" id="5472114">r</span><span class="op" id="5472115">.</span><span class="ident" id="5472116">Min</span><span class="op" id="5472119">.</span><span class="ident" id="5472120">X</span><span class="op" id="5472121">,</span>&nbsp;<span class="ident" id="5472123">r</span><span class="op" id="5472124">.</span><span class="ident" id="5472125">Min</span><span class="op" id="5472128">.</span><span class="ident" id="5472129">Y</span><span class="op" id="5472130">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472133">s0</span>&nbsp;<span class="op" id="5472136">:=</span>&nbsp;<span class="ident" id="5472139">src</span><span class="op" id="5472142">.</span><span class="ident" id="5472143">PixOffset</span><span class="op" id="5472152">(</span><span class="ident" id="5472153">sp</span><span class="op" id="5472155">.</span><span class="ident" id="5472156">X</span><span class="op" id="5472157">,</span>&nbsp;<span class="ident" id="5472159">sp</span><span class="op" id="5472161">.</span><span class="ident" id="5472162">Y</span><span class="op" id="5472163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472166">var</span>&nbsp;<span class="ident" id="5472170">ddelta</span><span class="op" id="5472176">,</span>&nbsp;<span class="ident" id="5472178">sdelta</span>&nbsp;<span class="builtintype" id="5472185">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472190">if</span>&nbsp;<span class="ident" id="5472193">r</span><span class="op" id="5472194">.</span><span class="ident" id="5472195">Min</span><span class="op" id="5472198">.</span><span class="ident" id="5472199">Y</span>&nbsp;<span class="op" id="5472201">&lt;=</span>&nbsp;<span class="ident" id="5472204">sp</span><span class="op" id="5472206">.</span><span class="ident" id="5472207">Y</span>&nbsp;<span class="op" id="5472209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472213">ddelta</span>&nbsp;<span class="op" id="5472220">=</span>&nbsp;<span class="ident" id="5472222">dst</span><span class="op" id="5472225">.</span><span class="ident" id="5472226">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472235">sdelta</span>&nbsp;<span class="op" id="5472242">=</span>&nbsp;<span class="ident" id="5472244">src</span><span class="op" id="5472247">.</span><span class="ident" id="5472248">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472256">}</span>&nbsp;<span class="keyword" id="5472258">else</span>&nbsp;<span class="op" id="5472263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5472267">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5472367">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5472463">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472559">d0</span>&nbsp;<span class="op" id="5472562">+=</span>&nbsp;<span class="op" id="5472565">(</span><span class="ident" id="5472566">dy</span>&nbsp;<span class="op" id="5472569">-</span>&nbsp;<span class="num" id="5472571">1</span><span class="op" id="5472572">)</span>&nbsp;<span class="op" id="5472574">*</span>&nbsp;<span class="ident" id="5472576">dst</span><span class="op" id="5472579">.</span><span class="ident" id="5472580">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472589">s0</span>&nbsp;<span class="op" id="5472592">+=</span>&nbsp;<span class="op" id="5472595">(</span><span class="ident" id="5472596">dy</span>&nbsp;<span class="op" id="5472599">-</span>&nbsp;<span class="num" id="5472601">1</span><span class="op" id="5472602">)</span>&nbsp;<span class="op" id="5472604">*</span>&nbsp;<span class="ident" id="5472606">src</span><span class="op" id="5472609">.</span><span class="ident" id="5472610">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472619">ddelta</span>&nbsp;<span class="op" id="5472626">=</span>&nbsp;<span class="op" id="5472628">-</span><span class="ident" id="5472629">dst</span><span class="op" id="5472632">.</span><span class="ident" id="5472633">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472642">sdelta</span>&nbsp;<span class="op" id="5472649">=</span>&nbsp;<span class="op" id="5472651">-</span><span class="ident" id="5472652">src</span><span class="op" id="5472655">.</span><span class="ident" id="5472656">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5472667">for</span>&nbsp;<span class="op" id="5472671">;</span>&nbsp;<span class="ident" id="5472673">dy</span>&nbsp;<span class="op" id="5472676">&gt;</span>&nbsp;<span class="num" id="5472678">0</span><span class="op" id="5472679">;</span>&nbsp;<span class="ident" id="5472681">dy</span><span class="op" id="5472683">--</span>&nbsp;<span class="op" id="5472686">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5472690">copy</span><span class="op" id="5472694">(</span><span class="ident" id="5472695">dst</span><span class="op" id="5472698">.</span><span class="ident" id="5472699">Pix</span><span class="op" id="5472702">[</span><span class="ident" id="5472703">d0</span><span class="op" id="5472705">:</span><span class="ident" id="5472706">d0</span><span class="op" id="5472708">+</span><span class="ident" id="5472709">n</span><span class="op" id="5472710">]</span><span class="op" id="5472711">,</span>&nbsp;<span class="ident" id="5472713">src</span><span class="op" id="5472716">.</span><span class="ident" id="5472717">Pix</span><span class="op" id="5472720">[</span><span class="ident" id="5472721">s0</span><span class="op" id="5472723">:</span><span class="ident" id="5472724">s0</span><span class="op" id="5472726">+</span><span class="ident" id="5472727">n</span><span class="op" id="5472728">]</span><span class="op" id="5472729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472733">d0</span>&nbsp;<span class="op" id="5472736">+=</span>&nbsp;<span class="ident" id="5472739">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472748">s0</span>&nbsp;<span class="op" id="5472751">+=</span>&nbsp;<span class="ident" id="5472754">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5472762">}</span><br>
<span class="lineno"></span><span class="op" id="5472764">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5472767">func</span>&nbsp;<span class="ident" id="5472772">drawNRGBAOver</span><span class="op" id="5472785">(</span><span class="ident" id="5472786">dst</span>&nbsp;<span class="op" id="5472790">*</span><span class="ident" id="5472791">image</span><span class="op" id="5472796">.</span><span class="ident" id="5472797">RGBA</span><span class="op" id="5472801">,</span>&nbsp;<span class="ident" id="5472803">r</span>&nbsp;<span class="ident" id="5472805">image</span><span class="op" id="5472810">.</span><span class="ident" id="5472811">Rectangle</span><span class="op" id="5472820">,</span>&nbsp;<span class="ident" id="5472822">src</span>&nbsp;<span class="op" id="5472826">*</span><span class="ident" id="5472827">image</span><span class="op" id="5472832">.</span><span class="ident" id="5472833">NRGBA</span><span class="op" id="5472838">,</span>&nbsp;<span class="ident" id="5472840">sp</span>&nbsp;<span class="ident" id="5472843">image</span><span class="op" id="5472848">.</span><span class="ident" id="5472849">Point</span><span class="op" id="5472854">)</span>&nbsp;<span class="op" id="5472856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472859">i0</span>&nbsp;<span class="op" id="5472862">:=</span>&nbsp;<span class="op" id="5472865">(</span><span class="ident" id="5472866">r</span><span class="op" id="5472867">.</span><span class="ident" id="5472868">Min</span><span class="op" id="5472871">.</span><span class="ident" id="5472872">X</span>&nbsp;<span class="op" id="5472874">-</span>&nbsp;<span class="ident" id="5472876">dst</span><span class="op" id="5472879">.</span><span class="ident" id="5472880">Rect</span><span class="op" id="5472884">.</span><span class="ident" id="5472885">Min</span><span class="op" id="5472888">.</span><span class="ident" id="5472889">X</span><span class="op" id="5472890">)</span>&nbsp;<span class="op" id="5472892">*</span>&nbsp;<span class="num" id="5472894">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472897">i1</span>&nbsp;<span class="op" id="5472900">:=</span>&nbsp;<span class="op" id="5472903">(</span><span class="ident" id="5472904">r</span><span class="op" id="5472905">.</span><span class="ident" id="5472906">Max</span><span class="op" id="5472909">.</span><span class="ident" id="5472910">X</span>&nbsp;<span class="op" id="5472912">-</span>&nbsp;<span class="ident" id="5472914">dst</span><span class="op" id="5472917">.</span><span class="ident" id="5472918">Rect</span><span class="op" id="5472922">.</span><span class="ident" id="5472923">Min</span><span class="op" id="5472926">.</span><span class="ident" id="5472927">X</span><span class="op" id="5472928">)</span>&nbsp;<span class="op" id="5472930">*</span>&nbsp;<span class="num" id="5472932">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472935">si0</span>&nbsp;<span class="op" id="5472939">:=</span>&nbsp;<span class="op" id="5472942">(</span><span class="ident" id="5472943">sp</span><span class="op" id="5472945">.</span><span class="ident" id="5472946">X</span>&nbsp;<span class="op" id="5472948">-</span>&nbsp;<span class="ident" id="5472950">src</span><span class="op" id="5472953">.</span><span class="ident" id="5472954">Rect</span><span class="op" id="5472958">.</span><span class="ident" id="5472959">Min</span><span class="op" id="5472962">.</span><span class="ident" id="5472963">X</span><span class="op" id="5472964">)</span>&nbsp;<span class="op" id="5472966">*</span>&nbsp;<span class="num" id="5472968">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5472971">yMax</span>&nbsp;<span class="op" id="5472976">:=</span>&nbsp;<span class="ident" id="5472979">r</span><span class="op" id="5472980">.</span><span class="ident" id="5472981">Max</span><span class="op" id="5472984">.</span><span class="ident" id="5472985">Y</span>&nbsp;<span class="op" id="5472987">-</span>&nbsp;<span class="ident" id="5472989">dst</span><span class="op" id="5472992">.</span><span class="ident" id="5472993">Rect</span><span class="op" id="5472997">.</span><span class="ident" id="5472998">Min</span><span class="op" id="5473001">.</span><span class="ident" id="5473002">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473006">y</span>&nbsp;<span class="op" id="5473008">:=</span>&nbsp;<span class="ident" id="5473011">r</span><span class="op" id="5473012">.</span><span class="ident" id="5473013">Min</span><span class="op" id="5473016">.</span><span class="ident" id="5473017">Y</span>&nbsp;<span class="op" id="5473019">-</span>&nbsp;<span class="ident" id="5473021">dst</span><span class="op" id="5473024">.</span><span class="ident" id="5473025">Rect</span><span class="op" id="5473029">.</span><span class="ident" id="5473030">Min</span><span class="op" id="5473033">.</span><span class="ident" id="5473034">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473037">sy</span>&nbsp;<span class="op" id="5473040">:=</span>&nbsp;<span class="ident" id="5473043">sp</span><span class="op" id="5473045">.</span><span class="ident" id="5473046">Y</span>&nbsp;<span class="op" id="5473048">-</span>&nbsp;<span class="ident" id="5473050">src</span><span class="op" id="5473053">.</span><span class="ident" id="5473054">Rect</span><span class="op" id="5473058">.</span><span class="ident" id="5473059">Min</span><span class="op" id="5473062">.</span><span class="ident" id="5473063">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5473066">for</span>&nbsp;<span class="op" id="5473070">;</span>&nbsp;<span class="ident" id="5473072">y</span>&nbsp;<span class="op" id="5473074">!=</span>&nbsp;<span class="ident" id="5473077">yMax</span><span class="op" id="5473081">;</span>&nbsp;<span class="ident" id="5473083">y</span><span class="op" id="5473084">,</span>&nbsp;<span class="ident" id="5473086">sy</span>&nbsp;<span class="op" id="5473089">=</span>&nbsp;<span class="ident" id="5473091">y</span><span class="op" id="5473092">+</span><span class="num" id="5473093">1</span><span class="op" id="5473094">,</span>&nbsp;<span class="ident" id="5473096">sy</span><span class="op" id="5473098">+</span><span class="num" id="5473099">1</span>&nbsp;<span class="op" id="5473101">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473105">dpix</span>&nbsp;<span class="op" id="5473110">:=</span>&nbsp;<span class="ident" id="5473113">dst</span><span class="op" id="5473116">.</span><span class="ident" id="5473117">Pix</span><span class="op" id="5473120">[</span><span class="ident" id="5473121">y</span><span class="op" id="5473122">*</span><span class="ident" id="5473123">dst</span><span class="op" id="5473126">.</span><span class="ident" id="5473127">Stride</span><span class="op" id="5473133">:</span><span class="op" id="5473134">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473138">spix</span>&nbsp;<span class="op" id="5473143">:=</span>&nbsp;<span class="ident" id="5473146">src</span><span class="op" id="5473149">.</span><span class="ident" id="5473150">Pix</span><span class="op" id="5473153">[</span><span class="ident" id="5473154">sy</span><span class="op" id="5473156">*</span><span class="ident" id="5473157">src</span><span class="op" id="5473160">.</span><span class="ident" id="5473161">Stride</span><span class="op" id="5473167">:</span><span class="op" id="5473168">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5473173">for</span>&nbsp;<span class="ident" id="5473177">i</span><span class="op" id="5473178">,</span>&nbsp;<span class="ident" id="5473180">si</span>&nbsp;<span class="op" id="5473183">:=</span>&nbsp;<span class="ident" id="5473186">i0</span><span class="op" id="5473188">,</span>&nbsp;<span class="ident" id="5473190">si0</span><span class="op" id="5473193">;</span>&nbsp;<span class="ident" id="5473195">i</span>&nbsp;<span class="op" id="5473197">&lt;</span>&nbsp;<span class="ident" id="5473199">i1</span><span class="op" id="5473201">;</span>&nbsp;<span class="ident" id="5473203">i</span><span class="op" id="5473204">,</span>&nbsp;<span class="ident" id="5473206">si</span>&nbsp;<span class="op" id="5473209">=</span>&nbsp;<span class="ident" id="5473211">i</span><span class="op" id="5473212">+</span><span class="num" id="5473213">4</span><span class="op" id="5473214">,</span>&nbsp;<span class="ident" id="5473216">si</span><span class="op" id="5473218">+</span><span class="num" id="5473219">4</span>&nbsp;<span class="op" id="5473221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5473226">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473294">sa</span>&nbsp;<span class="op" id="5473297">:=</span>&nbsp;<span class="builtintype" id="5473300">uint32</span><span class="op" id="5473306">(</span><span class="ident" id="5473307">spix</span><span class="op" id="5473311">[</span><span class="ident" id="5473312">si</span><span class="op" id="5473314">+</span><span class="num" id="5473315">3</span><span class="op" id="5473316">]</span><span class="op" id="5473317">)</span>&nbsp;<span class="op" id="5473319">*</span>&nbsp;<span class="num" id="5473321">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473330">sr</span>&nbsp;<span class="op" id="5473333">:=</span>&nbsp;<span class="builtintype" id="5473336">uint32</span><span class="op" id="5473342">(</span><span class="ident" id="5473343">spix</span><span class="op" id="5473347">[</span><span class="ident" id="5473348">si</span><span class="op" id="5473350">+</span><span class="num" id="5473351">0</span><span class="op" id="5473352">]</span><span class="op" id="5473353">)</span>&nbsp;<span class="op" id="5473355">*</span>&nbsp;<span class="ident" id="5473357">sa</span>&nbsp;<span class="op" id="5473360">/</span>&nbsp;<span class="num" id="5473362">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473370">sg</span>&nbsp;<span class="op" id="5473373">:=</span>&nbsp;<span class="builtintype" id="5473376">uint32</span><span class="op" id="5473382">(</span><span class="ident" id="5473383">spix</span><span class="op" id="5473387">[</span><span class="ident" id="5473388">si</span><span class="op" id="5473390">+</span><span class="num" id="5473391">1</span><span class="op" id="5473392">]</span><span class="op" id="5473393">)</span>&nbsp;<span class="op" id="5473395">*</span>&nbsp;<span class="ident" id="5473397">sa</span>&nbsp;<span class="op" id="5473400">/</span>&nbsp;<span class="num" id="5473402">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473410">sb</span>&nbsp;<span class="op" id="5473413">:=</span>&nbsp;<span class="builtintype" id="5473416">uint32</span><span class="op" id="5473422">(</span><span class="ident" id="5473423">spix</span><span class="op" id="5473427">[</span><span class="ident" id="5473428">si</span><span class="op" id="5473430">+</span><span class="num" id="5473431">2</span><span class="op" id="5473432">]</span><span class="op" id="5473433">)</span>&nbsp;<span class="op" id="5473435">*</span>&nbsp;<span class="ident" id="5473437">sa</span>&nbsp;<span class="op" id="5473440">/</span>&nbsp;<span class="num" id="5473442">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473451">dr</span>&nbsp;<span class="op" id="5473454">:=</span>&nbsp;<span class="builtintype" id="5473457">uint32</span><span class="op" id="5473463">(</span><span class="ident" id="5473464">dpix</span><span class="op" id="5473468">[</span><span class="ident" id="5473469">i</span><span class="op" id="5473470">+</span><span class="num" id="5473471">0</span><span class="op" id="5473472">]</span><span class="op" id="5473473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473478">dg</span>&nbsp;<span class="op" id="5473481">:=</span>&nbsp;<span class="builtintype" id="5473484">uint32</span><span class="op" id="5473490">(</span><span class="ident" id="5473491">dpix</span><span class="op" id="5473495">[</span><span class="ident" id="5473496">i</span><span class="op" id="5473497">+</span><span class="num" id="5473498">1</span><span class="op" id="5473499">]</span><span class="op" id="5473500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473505">db</span>&nbsp;<span class="op" id="5473508">:=</span>&nbsp;<span class="builtintype" id="5473511">uint32</span><span class="op" id="5473517">(</span><span class="ident" id="5473518">dpix</span><span class="op" id="5473522">[</span><span class="ident" id="5473523">i</span><span class="op" id="5473524">+</span><span class="num" id="5473525">2</span><span class="op" id="5473526">]</span><span class="op" id="5473527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473532">da</span>&nbsp;<span class="op" id="5473535">:=</span>&nbsp;<span class="builtintype" id="5473538">uint32</span><span class="op" id="5473544">(</span><span class="ident" id="5473545">dpix</span><span class="op" id="5473549">[</span><span class="ident" id="5473550">i</span><span class="op" id="5473551">+</span><span class="num" id="5473552">3</span><span class="op" id="5473553">]</span><span class="op" id="5473554">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5473560">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473620">a</span>&nbsp;<span class="op" id="5473622">:=</span>&nbsp;<span class="op" id="5473625">(</span><span class="ident" id="5473626">m</span>&nbsp;<span class="op" id="5473628">-</span>&nbsp;<span class="ident" id="5473630">sa</span><span class="op" id="5473632">)</span>&nbsp;<span class="op" id="5473634">*</span>&nbsp;<span class="num" id="5473636">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473646">dpix</span><span class="op" id="5473650">[</span><span class="ident" id="5473651">i</span><span class="op" id="5473652">+</span><span class="num" id="5473653">0</span><span class="op" id="5473654">]</span>&nbsp;<span class="op" id="5473656">=</span>&nbsp;<span class="builtintype" id="5473658">uint8</span><span class="op" id="5473663">(</span><span class="op" id="5473664">(</span><span class="ident" id="5473665">dr</span><span class="op" id="5473667">*</span><span class="ident" id="5473668">a</span><span class="op" id="5473669">/</span><span class="ident" id="5473670">m</span>&nbsp;<span class="op" id="5473672">+</span>&nbsp;<span class="ident" id="5473674">sr</span><span class="op" id="5473676">)</span>&nbsp;<span class="op" id="5473678">&gt;&gt;</span>&nbsp;<span class="num" id="5473681">8</span><span class="op" id="5473682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473687">dpix</span><span class="op" id="5473691">[</span><span class="ident" id="5473692">i</span><span class="op" id="5473693">+</span><span class="num" id="5473694">1</span><span class="op" id="5473695">]</span>&nbsp;<span class="op" id="5473697">=</span>&nbsp;<span class="builtintype" id="5473699">uint8</span><span class="op" id="5473704">(</span><span class="op" id="5473705">(</span><span class="ident" id="5473706">dg</span><span class="op" id="5473708">*</span><span class="ident" id="5473709">a</span><span class="op" id="5473710">/</span><span class="ident" id="5473711">m</span>&nbsp;<span class="op" id="5473713">+</span>&nbsp;<span class="ident" id="5473715">sg</span><span class="op" id="5473717">)</span>&nbsp;<span class="op" id="5473719">&gt;&gt;</span>&nbsp;<span class="num" id="5473722">8</span><span class="op" id="5473723">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473728">dpix</span><span class="op" id="5473732">[</span><span class="ident" id="5473733">i</span><span class="op" id="5473734">+</span><span class="num" id="5473735">2</span><span class="op" id="5473736">]</span>&nbsp;<span class="op" id="5473738">=</span>&nbsp;<span class="builtintype" id="5473740">uint8</span><span class="op" id="5473745">(</span><span class="op" id="5473746">(</span><span class="ident" id="5473747">db</span><span class="op" id="5473749">*</span><span class="ident" id="5473750">a</span><span class="op" id="5473751">/</span><span class="ident" id="5473752">m</span>&nbsp;<span class="op" id="5473754">+</span>&nbsp;<span class="ident" id="5473756">sb</span><span class="op" id="5473758">)</span>&nbsp;<span class="op" id="5473760">&gt;&gt;</span>&nbsp;<span class="num" id="5473763">8</span><span class="op" id="5473764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473769">dpix</span><span class="op" id="5473773">[</span><span class="ident" id="5473774">i</span><span class="op" id="5473775">+</span><span class="num" id="5473776">3</span><span class="op" id="5473777">]</span>&nbsp;<span class="op" id="5473779">=</span>&nbsp;<span class="builtintype" id="5473781">uint8</span><span class="op" id="5473786">(</span><span class="op" id="5473787">(</span><span class="ident" id="5473788">da</span><span class="op" id="5473790">*</span><span class="ident" id="5473791">a</span><span class="op" id="5473792">/</span><span class="ident" id="5473793">m</span>&nbsp;<span class="op" id="5473795">+</span>&nbsp;<span class="ident" id="5473797">sa</span><span class="op" id="5473799">)</span>&nbsp;<span class="op" id="5473801">&gt;&gt;</span>&nbsp;<span class="num" id="5473804">8</span><span class="op" id="5473805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5473809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5473812">}</span><br>
<span class="lineno"></span><span class="op" id="5473814">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5473817">func</span>&nbsp;<span class="ident" id="5473822">drawNRGBASrc</span><span class="op" id="5473834">(</span><span class="ident" id="5473835">dst</span>&nbsp;<span class="op" id="5473839">*</span><span class="ident" id="5473840">image</span><span class="op" id="5473845">.</span><span class="ident" id="5473846">RGBA</span><span class="op" id="5473850">,</span>&nbsp;<span class="ident" id="5473852">r</span>&nbsp;<span class="ident" id="5473854">image</span><span class="op" id="5473859">.</span><span class="ident" id="5473860">Rectangle</span><span class="op" id="5473869">,</span>&nbsp;<span class="ident" id="5473871">src</span>&nbsp;<span class="op" id="5473875">*</span><span class="ident" id="5473876">image</span><span class="op" id="5473881">.</span><span class="ident" id="5473882">NRGBA</span><span class="op" id="5473887">,</span>&nbsp;<span class="ident" id="5473889">sp</span>&nbsp;<span class="ident" id="5473892">image</span><span class="op" id="5473897">.</span><span class="ident" id="5473898">Point</span><span class="op" id="5473903">)</span>&nbsp;<span class="op" id="5473905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473908">i0</span>&nbsp;<span class="op" id="5473911">:=</span>&nbsp;<span class="op" id="5473914">(</span><span class="ident" id="5473915">r</span><span class="op" id="5473916">.</span><span class="ident" id="5473917">Min</span><span class="op" id="5473920">.</span><span class="ident" id="5473921">X</span>&nbsp;<span class="op" id="5473923">-</span>&nbsp;<span class="ident" id="5473925">dst</span><span class="op" id="5473928">.</span><span class="ident" id="5473929">Rect</span><span class="op" id="5473933">.</span><span class="ident" id="5473934">Min</span><span class="op" id="5473937">.</span><span class="ident" id="5473938">X</span><span class="op" id="5473939">)</span>&nbsp;<span class="op" id="5473941">*</span>&nbsp;<span class="num" id="5473943">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473946">i1</span>&nbsp;<span class="op" id="5473949">:=</span>&nbsp;<span class="op" id="5473952">(</span><span class="ident" id="5473953">r</span><span class="op" id="5473954">.</span><span class="ident" id="5473955">Max</span><span class="op" id="5473958">.</span><span class="ident" id="5473959">X</span>&nbsp;<span class="op" id="5473961">-</span>&nbsp;<span class="ident" id="5473963">dst</span><span class="op" id="5473966">.</span><span class="ident" id="5473967">Rect</span><span class="op" id="5473971">.</span><span class="ident" id="5473972">Min</span><span class="op" id="5473975">.</span><span class="ident" id="5473976">X</span><span class="op" id="5473977">)</span>&nbsp;<span class="op" id="5473979">*</span>&nbsp;<span class="num" id="5473981">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5473984">si0</span>&nbsp;<span class="op" id="5473988">:=</span>&nbsp;<span class="op" id="5473991">(</span><span class="ident" id="5473992">sp</span><span class="op" id="5473994">.</span><span class="ident" id="5473995">X</span>&nbsp;<span class="op" id="5473997">-</span>&nbsp;<span class="ident" id="5473999">src</span><span class="op" id="5474002">.</span><span class="ident" id="5474003">Rect</span><span class="op" id="5474007">.</span><span class="ident" id="5474008">Min</span><span class="op" id="5474011">.</span><span class="ident" id="5474012">X</span><span class="op" id="5474013">)</span>&nbsp;<span class="op" id="5474015">*</span>&nbsp;<span class="num" id="5474017">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474020">yMax</span>&nbsp;<span class="op" id="5474025">:=</span>&nbsp;<span class="ident" id="5474028">r</span><span class="op" id="5474029">.</span><span class="ident" id="5474030">Max</span><span class="op" id="5474033">.</span><span class="ident" id="5474034">Y</span>&nbsp;<span class="op" id="5474036">-</span>&nbsp;<span class="ident" id="5474038">dst</span><span class="op" id="5474041">.</span><span class="ident" id="5474042">Rect</span><span class="op" id="5474046">.</span><span class="ident" id="5474047">Min</span><span class="op" id="5474050">.</span><span class="ident" id="5474051">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474055">y</span>&nbsp;<span class="op" id="5474057">:=</span>&nbsp;<span class="ident" id="5474060">r</span><span class="op" id="5474061">.</span><span class="ident" id="5474062">Min</span><span class="op" id="5474065">.</span><span class="ident" id="5474066">Y</span>&nbsp;<span class="op" id="5474068">-</span>&nbsp;<span class="ident" id="5474070">dst</span><span class="op" id="5474073">.</span><span class="ident" id="5474074">Rect</span><span class="op" id="5474078">.</span><span class="ident" id="5474079">Min</span><span class="op" id="5474082">.</span><span class="ident" id="5474083">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474086">sy</span>&nbsp;<span class="op" id="5474089">:=</span>&nbsp;<span class="ident" id="5474092">sp</span><span class="op" id="5474094">.</span><span class="ident" id="5474095">Y</span>&nbsp;<span class="op" id="5474097">-</span>&nbsp;<span class="ident" id="5474099">src</span><span class="op" id="5474102">.</span><span class="ident" id="5474103">Rect</span><span class="op" id="5474107">.</span><span class="ident" id="5474108">Min</span><span class="op" id="5474111">.</span><span class="ident" id="5474112">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5474115">for</span>&nbsp;<span class="op" id="5474119">;</span>&nbsp;<span class="ident" id="5474121">y</span>&nbsp;<span class="op" id="5474123">!=</span>&nbsp;<span class="ident" id="5474126">yMax</span><span class="op" id="5474130">;</span>&nbsp;<span class="ident" id="5474132">y</span><span class="op" id="5474133">,</span>&nbsp;<span class="ident" id="5474135">sy</span>&nbsp;<span class="op" id="5474138">=</span>&nbsp;<span class="ident" id="5474140">y</span><span class="op" id="5474141">+</span><span class="num" id="5474142">1</span><span class="op" id="5474143">,</span>&nbsp;<span class="ident" id="5474145">sy</span><span class="op" id="5474147">+</span><span class="num" id="5474148">1</span>&nbsp;<span class="op" id="5474150">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474154">dpix</span>&nbsp;<span class="op" id="5474159">:=</span>&nbsp;<span class="ident" id="5474162">dst</span><span class="op" id="5474165">.</span><span class="ident" id="5474166">Pix</span><span class="op" id="5474169">[</span><span class="ident" id="5474170">y</span><span class="op" id="5474171">*</span><span class="ident" id="5474172">dst</span><span class="op" id="5474175">.</span><span class="ident" id="5474176">Stride</span><span class="op" id="5474182">:</span><span class="op" id="5474183">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474187">spix</span>&nbsp;<span class="op" id="5474192">:=</span>&nbsp;<span class="ident" id="5474195">src</span><span class="op" id="5474198">.</span><span class="ident" id="5474199">Pix</span><span class="op" id="5474202">[</span><span class="ident" id="5474203">sy</span><span class="op" id="5474205">*</span><span class="ident" id="5474206">src</span><span class="op" id="5474209">.</span><span class="ident" id="5474210">Stride</span><span class="op" id="5474216">:</span><span class="op" id="5474217">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5474222">for</span>&nbsp;<span class="ident" id="5474226">i</span><span class="op" id="5474227">,</span>&nbsp;<span class="ident" id="5474229">si</span>&nbsp;<span class="op" id="5474232">:=</span>&nbsp;<span class="ident" id="5474235">i0</span><span class="op" id="5474237">,</span>&nbsp;<span class="ident" id="5474239">si0</span><span class="op" id="5474242">;</span>&nbsp;<span class="ident" id="5474244">i</span>&nbsp;<span class="op" id="5474246">&lt;</span>&nbsp;<span class="ident" id="5474248">i1</span><span class="op" id="5474250">;</span>&nbsp;<span class="ident" id="5474252">i</span><span class="op" id="5474253">,</span>&nbsp;<span class="ident" id="5474255">si</span>&nbsp;<span class="op" id="5474258">=</span>&nbsp;<span class="ident" id="5474260">i</span><span class="op" id="5474261">+</span><span class="num" id="5474262">4</span><span class="op" id="5474263">,</span>&nbsp;<span class="ident" id="5474265">si</span><span class="op" id="5474267">+</span><span class="num" id="5474268">4</span>&nbsp;<span class="op" id="5474270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5474275">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474343">sa</span>&nbsp;<span class="op" id="5474346">:=</span>&nbsp;<span class="builtintype" id="5474349">uint32</span><span class="op" id="5474355">(</span><span class="ident" id="5474356">spix</span><span class="op" id="5474360">[</span><span class="ident" id="5474361">si</span><span class="op" id="5474363">+</span><span class="num" id="5474364">3</span><span class="op" id="5474365">]</span><span class="op" id="5474366">)</span>&nbsp;<span class="op" id="5474368">*</span>&nbsp;<span class="num" id="5474370">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474379">sr</span>&nbsp;<span class="op" id="5474382">:=</span>&nbsp;<span class="builtintype" id="5474385">uint32</span><span class="op" id="5474391">(</span><span class="ident" id="5474392">spix</span><span class="op" id="5474396">[</span><span class="ident" id="5474397">si</span><span class="op" id="5474399">+</span><span class="num" id="5474400">0</span><span class="op" id="5474401">]</span><span class="op" id="5474402">)</span>&nbsp;<span class="op" id="5474404">*</span>&nbsp;<span class="ident" id="5474406">sa</span>&nbsp;<span class="op" id="5474409">/</span>&nbsp;<span class="num" id="5474411">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474419">sg</span>&nbsp;<span class="op" id="5474422">:=</span>&nbsp;<span class="builtintype" id="5474425">uint32</span><span class="op" id="5474431">(</span><span class="ident" id="5474432">spix</span><span class="op" id="5474436">[</span><span class="ident" id="5474437">si</span><span class="op" id="5474439">+</span><span class="num" id="5474440">1</span><span class="op" id="5474441">]</span><span class="op" id="5474442">)</span>&nbsp;<span class="op" id="5474444">*</span>&nbsp;<span class="ident" id="5474446">sa</span>&nbsp;<span class="op" id="5474449">/</span>&nbsp;<span class="num" id="5474451">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474459">sb</span>&nbsp;<span class="op" id="5474462">:=</span>&nbsp;<span class="builtintype" id="5474465">uint32</span><span class="op" id="5474471">(</span><span class="ident" id="5474472">spix</span><span class="op" id="5474476">[</span><span class="ident" id="5474477">si</span><span class="op" id="5474479">+</span><span class="num" id="5474480">2</span><span class="op" id="5474481">]</span><span class="op" id="5474482">)</span>&nbsp;<span class="op" id="5474484">*</span>&nbsp;<span class="ident" id="5474486">sa</span>&nbsp;<span class="op" id="5474489">/</span>&nbsp;<span class="num" id="5474491">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474500">dpix</span><span class="op" id="5474504">[</span><span class="ident" id="5474505">i</span><span class="op" id="5474506">+</span><span class="num" id="5474507">0</span><span class="op" id="5474508">]</span>&nbsp;<span class="op" id="5474510">=</span>&nbsp;<span class="builtintype" id="5474512">uint8</span><span class="op" id="5474517">(</span><span class="ident" id="5474518">sr</span>&nbsp;<span class="op" id="5474521">&gt;&gt;</span>&nbsp;<span class="num" id="5474524">8</span><span class="op" id="5474525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474530">dpix</span><span class="op" id="5474534">[</span><span class="ident" id="5474535">i</span><span class="op" id="5474536">+</span><span class="num" id="5474537">1</span><span class="op" id="5474538">]</span>&nbsp;<span class="op" id="5474540">=</span>&nbsp;<span class="builtintype" id="5474542">uint8</span><span class="op" id="5474547">(</span><span class="ident" id="5474548">sg</span>&nbsp;<span class="op" id="5474551">&gt;&gt;</span>&nbsp;<span class="num" id="5474554">8</span><span class="op" id="5474555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474560">dpix</span><span class="op" id="5474564">[</span><span class="ident" id="5474565">i</span><span class="op" id="5474566">+</span><span class="num" id="5474567">2</span><span class="op" id="5474568">]</span>&nbsp;<span class="op" id="5474570">=</span>&nbsp;<span class="builtintype" id="5474572">uint8</span><span class="op" id="5474577">(</span><span class="ident" id="5474578">sb</span>&nbsp;<span class="op" id="5474581">&gt;&gt;</span>&nbsp;<span class="num" id="5474584">8</span><span class="op" id="5474585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474590">dpix</span><span class="op" id="5474594">[</span><span class="ident" id="5474595">i</span><span class="op" id="5474596">+</span><span class="num" id="5474597">3</span><span class="op" id="5474598">]</span>&nbsp;<span class="op" id="5474600">=</span>&nbsp;<span class="builtintype" id="5474602">uint8</span><span class="op" id="5474607">(</span><span class="ident" id="5474608">sa</span>&nbsp;<span class="op" id="5474611">&gt;&gt;</span>&nbsp;<span class="num" id="5474614">8</span><span class="op" id="5474615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5474619">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5474622">}</span><br>
<span class="lineno"></span><span class="op" id="5474624">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5474627">func</span>&nbsp;<span class="ident" id="5474632">drawYCbCr</span><span class="op" id="5474641">(</span><span class="ident" id="5474642">dst</span>&nbsp;<span class="op" id="5474646">*</span><span class="ident" id="5474647">image</span><span class="op" id="5474652">.</span><span class="ident" id="5474653">RGBA</span><span class="op" id="5474657">,</span>&nbsp;<span class="ident" id="5474659">r</span>&nbsp;<span class="ident" id="5474661">image</span><span class="op" id="5474666">.</span><span class="ident" id="5474667">Rectangle</span><span class="op" id="5474676">,</span>&nbsp;<span class="ident" id="5474678">src</span>&nbsp;<span class="op" id="5474682">*</span><span class="ident" id="5474683">image</span><span class="op" id="5474688">.</span><span class="ident" id="5474689">YCbCr</span><span class="op" id="5474694">,</span>&nbsp;<span class="ident" id="5474696">sp</span>&nbsp;<span class="ident" id="5474699">image</span><span class="op" id="5474704">.</span><span class="ident" id="5474705">Point</span><span class="op" id="5474710">)</span>&nbsp;<span class="op" id="5474712">(</span><span class="ident" id="5474713">ok</span>&nbsp;<span class="builtintype" id="5474716">bool</span><span class="op" id="5474720">)</span>&nbsp;<span class="op" id="5474722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5474725">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5474805">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474868">x0</span>&nbsp;<span class="op" id="5474871">:=</span>&nbsp;<span class="op" id="5474874">(</span><span class="ident" id="5474875">r</span><span class="op" id="5474876">.</span><span class="ident" id="5474877">Min</span><span class="op" id="5474880">.</span><span class="ident" id="5474881">X</span>&nbsp;<span class="op" id="5474883">-</span>&nbsp;<span class="ident" id="5474885">dst</span><span class="op" id="5474888">.</span><span class="ident" id="5474889">Rect</span><span class="op" id="5474893">.</span><span class="ident" id="5474894">Min</span><span class="op" id="5474897">.</span><span class="ident" id="5474898">X</span><span class="op" id="5474899">)</span>&nbsp;<span class="op" id="5474901">*</span>&nbsp;<span class="num" id="5474903">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474906">x1</span>&nbsp;<span class="op" id="5474909">:=</span>&nbsp;<span class="op" id="5474912">(</span><span class="ident" id="5474913">r</span><span class="op" id="5474914">.</span><span class="ident" id="5474915">Max</span><span class="op" id="5474918">.</span><span class="ident" id="5474919">X</span>&nbsp;<span class="op" id="5474921">-</span>&nbsp;<span class="ident" id="5474923">dst</span><span class="op" id="5474926">.</span><span class="ident" id="5474927">Rect</span><span class="op" id="5474931">.</span><span class="ident" id="5474932">Min</span><span class="op" id="5474935">.</span><span class="ident" id="5474936">X</span><span class="op" id="5474937">)</span>&nbsp;<span class="op" id="5474939">*</span>&nbsp;<span class="num" id="5474941">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474944">y0</span>&nbsp;<span class="op" id="5474947">:=</span>&nbsp;<span class="ident" id="5474950">r</span><span class="op" id="5474951">.</span><span class="ident" id="5474952">Min</span><span class="op" id="5474955">.</span><span class="ident" id="5474956">Y</span>&nbsp;<span class="op" id="5474958">-</span>&nbsp;<span class="ident" id="5474960">dst</span><span class="op" id="5474963">.</span><span class="ident" id="5474964">Rect</span><span class="op" id="5474968">.</span><span class="ident" id="5474969">Min</span><span class="op" id="5474972">.</span><span class="ident" id="5474973">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5474976">y1</span>&nbsp;<span class="op" id="5474979">:=</span>&nbsp;<span class="ident" id="5474982">r</span><span class="op" id="5474983">.</span><span class="ident" id="5474984">Max</span><span class="op" id="5474987">.</span><span class="ident" id="5474988">Y</span>&nbsp;<span class="op" id="5474990">-</span>&nbsp;<span class="ident" id="5474992">dst</span><span class="op" id="5474995">.</span><span class="ident" id="5474996">Rect</span><span class="op" id="5475000">.</span><span class="ident" id="5475001">Min</span><span class="op" id="5475004">.</span><span class="ident" id="5475005">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475008">switch</span>&nbsp;<span class="ident" id="5475015">src</span><span class="op" id="5475018">.</span><span class="ident" id="5475019">SubsampleRatio</span>&nbsp;<span class="op" id="5475034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475037">case</span>&nbsp;<span class="ident" id="5475042">image</span><span class="op" id="5475047">.</span><span class="ident" id="5475048">YCbCrSubsampleRatio444</span><span class="op" id="5475070">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475074">for</span>&nbsp;<span class="ident" id="5475078">y</span><span class="op" id="5475079">,</span>&nbsp;<span class="ident" id="5475081">sy</span>&nbsp;<span class="op" id="5475084">:=</span>&nbsp;<span class="ident" id="5475087">y0</span><span class="op" id="5475089">,</span>&nbsp;<span class="ident" id="5475091">sp</span><span class="op" id="5475093">.</span><span class="ident" id="5475094">Y</span><span class="op" id="5475095">;</span>&nbsp;<span class="ident" id="5475097">y</span>&nbsp;<span class="op" id="5475099">!=</span>&nbsp;<span class="ident" id="5475102">y1</span><span class="op" id="5475104">;</span>&nbsp;<span class="ident" id="5475106">y</span><span class="op" id="5475107">,</span>&nbsp;<span class="ident" id="5475109">sy</span>&nbsp;<span class="op" id="5475112">=</span>&nbsp;<span class="ident" id="5475114">y</span><span class="op" id="5475115">+</span><span class="num" id="5475116">1</span><span class="op" id="5475117">,</span>&nbsp;<span class="ident" id="5475119">sy</span><span class="op" id="5475121">+</span><span class="num" id="5475122">1</span>&nbsp;<span class="op" id="5475124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475129">dpix</span>&nbsp;<span class="op" id="5475134">:=</span>&nbsp;<span class="ident" id="5475137">dst</span><span class="op" id="5475140">.</span><span class="ident" id="5475141">Pix</span><span class="op" id="5475144">[</span><span class="ident" id="5475145">y</span><span class="op" id="5475146">*</span><span class="ident" id="5475147">dst</span><span class="op" id="5475150">.</span><span class="ident" id="5475151">Stride</span><span class="op" id="5475157">:</span><span class="op" id="5475158">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475163">yi</span>&nbsp;<span class="op" id="5475166">:=</span>&nbsp;<span class="op" id="5475169">(</span><span class="ident" id="5475170">sy</span><span class="op" id="5475172">-</span><span class="ident" id="5475173">src</span><span class="op" id="5475176">.</span><span class="ident" id="5475177">Rect</span><span class="op" id="5475181">.</span><span class="ident" id="5475182">Min</span><span class="op" id="5475185">.</span><span class="ident" id="5475186">Y</span><span class="op" id="5475187">)</span><span class="op" id="5475188">*</span><span class="ident" id="5475189">src</span><span class="op" id="5475192">.</span><span class="ident" id="5475193">YStride</span>&nbsp;<span class="op" id="5475201">+</span>&nbsp;<span class="op" id="5475203">(</span><span class="ident" id="5475204">sp</span><span class="op" id="5475206">.</span><span class="ident" id="5475207">X</span>&nbsp;<span class="op" id="5475209">-</span>&nbsp;<span class="ident" id="5475211">src</span><span class="op" id="5475214">.</span><span class="ident" id="5475215">Rect</span><span class="op" id="5475219">.</span><span class="ident" id="5475220">Min</span><span class="op" id="5475223">.</span><span class="ident" id="5475224">X</span><span class="op" id="5475225">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475230">ci</span>&nbsp;<span class="op" id="5475233">:=</span>&nbsp;<span class="op" id="5475236">(</span><span class="ident" id="5475237">sy</span><span class="op" id="5475239">-</span><span class="ident" id="5475240">src</span><span class="op" id="5475243">.</span><span class="ident" id="5475244">Rect</span><span class="op" id="5475248">.</span><span class="ident" id="5475249">Min</span><span class="op" id="5475252">.</span><span class="ident" id="5475253">Y</span><span class="op" id="5475254">)</span><span class="op" id="5475255">*</span><span class="ident" id="5475256">src</span><span class="op" id="5475259">.</span><span class="ident" id="5475260">CStride</span>&nbsp;<span class="op" id="5475268">+</span>&nbsp;<span class="op" id="5475270">(</span><span class="ident" id="5475271">sp</span><span class="op" id="5475273">.</span><span class="ident" id="5475274">X</span>&nbsp;<span class="op" id="5475276">-</span>&nbsp;<span class="ident" id="5475278">src</span><span class="op" id="5475281">.</span><span class="ident" id="5475282">Rect</span><span class="op" id="5475286">.</span><span class="ident" id="5475287">Min</span><span class="op" id="5475290">.</span><span class="ident" id="5475291">X</span><span class="op" id="5475292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475297">for</span>&nbsp;<span class="ident" id="5475301">x</span>&nbsp;<span class="op" id="5475303">:=</span>&nbsp;<span class="ident" id="5475306">x0</span><span class="op" id="5475308">;</span>&nbsp;<span class="ident" id="5475310">x</span>&nbsp;<span class="op" id="5475312">!=</span>&nbsp;<span class="ident" id="5475315">x1</span><span class="op" id="5475317">;</span>&nbsp;<span class="ident" id="5475319">x</span><span class="op" id="5475320">,</span>&nbsp;<span class="ident" id="5475322">yi</span><span class="op" id="5475324">,</span>&nbsp;<span class="ident" id="5475326">ci</span>&nbsp;<span class="op" id="5475329">=</span>&nbsp;<span class="ident" id="5475331">x</span><span class="op" id="5475332">+</span><span class="num" id="5475333">4</span><span class="op" id="5475334">,</span>&nbsp;<span class="ident" id="5475336">yi</span><span class="op" id="5475338">+</span><span class="num" id="5475339">1</span><span class="op" id="5475340">,</span>&nbsp;<span class="ident" id="5475342">ci</span><span class="op" id="5475344">+</span><span class="num" id="5475345">1</span>&nbsp;<span class="op" id="5475347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475353">rr</span><span class="op" id="5475355">,</span>&nbsp;<span class="ident" id="5475357">gg</span><span class="op" id="5475359">,</span>&nbsp;<span class="ident" id="5475361">bb</span>&nbsp;<span class="op" id="5475364">:=</span>&nbsp;<span class="ident" id="5475367">color</span><span class="op" id="5475372">.</span><span class="ident" id="5475373">YCbCrToRGB</span><span class="op" id="5475383">(</span><span class="ident" id="5475384">src</span><span class="op" id="5475387">.</span><span class="ident" id="5475388">Y</span><span class="op" id="5475389">[</span><span class="ident" id="5475390">yi</span><span class="op" id="5475392">]</span><span class="op" id="5475393">,</span>&nbsp;<span class="ident" id="5475395">src</span><span class="op" id="5475398">.</span><span class="ident" id="5475399">Cb</span><span class="op" id="5475401">[</span><span class="ident" id="5475402">ci</span><span class="op" id="5475404">]</span><span class="op" id="5475405">,</span>&nbsp;<span class="ident" id="5475407">src</span><span class="op" id="5475410">.</span><span class="ident" id="5475411">Cr</span><span class="op" id="5475413">[</span><span class="ident" id="5475414">ci</span><span class="op" id="5475416">]</span><span class="op" id="5475417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475423">dpix</span><span class="op" id="5475427">[</span><span class="ident" id="5475428">x</span><span class="op" id="5475429">+</span><span class="num" id="5475430">0</span><span class="op" id="5475431">]</span>&nbsp;<span class="op" id="5475433">=</span>&nbsp;<span class="ident" id="5475435">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475442">dpix</span><span class="op" id="5475446">[</span><span class="ident" id="5475447">x</span><span class="op" id="5475448">+</span><span class="num" id="5475449">1</span><span class="op" id="5475450">]</span>&nbsp;<span class="op" id="5475452">=</span>&nbsp;<span class="ident" id="5475454">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475461">dpix</span><span class="op" id="5475465">[</span><span class="ident" id="5475466">x</span><span class="op" id="5475467">+</span><span class="num" id="5475468">2</span><span class="op" id="5475469">]</span>&nbsp;<span class="op" id="5475471">=</span>&nbsp;<span class="ident" id="5475473">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475480">dpix</span><span class="op" id="5475484">[</span><span class="ident" id="5475485">x</span><span class="op" id="5475486">+</span><span class="num" id="5475487">3</span><span class="op" id="5475488">]</span>&nbsp;<span class="op" id="5475490">=</span>&nbsp;<span class="num" id="5475492">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5475499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5475503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475506">case</span>&nbsp;<span class="ident" id="5475511">image</span><span class="op" id="5475516">.</span><span class="ident" id="5475517">YCbCrSubsampleRatio422</span><span class="op" id="5475539">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475543">for</span>&nbsp;<span class="ident" id="5475547">y</span><span class="op" id="5475548">,</span>&nbsp;<span class="ident" id="5475550">sy</span>&nbsp;<span class="op" id="5475553">:=</span>&nbsp;<span class="ident" id="5475556">y0</span><span class="op" id="5475558">,</span>&nbsp;<span class="ident" id="5475560">sp</span><span class="op" id="5475562">.</span><span class="ident" id="5475563">Y</span><span class="op" id="5475564">;</span>&nbsp;<span class="ident" id="5475566">y</span>&nbsp;<span class="op" id="5475568">!=</span>&nbsp;<span class="ident" id="5475571">y1</span><span class="op" id="5475573">;</span>&nbsp;<span class="ident" id="5475575">y</span><span class="op" id="5475576">,</span>&nbsp;<span class="ident" id="5475578">sy</span>&nbsp;<span class="op" id="5475581">=</span>&nbsp;<span class="ident" id="5475583">y</span><span class="op" id="5475584">+</span><span class="num" id="5475585">1</span><span class="op" id="5475586">,</span>&nbsp;<span class="ident" id="5475588">sy</span><span class="op" id="5475590">+</span><span class="num" id="5475591">1</span>&nbsp;<span class="op" id="5475593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475598">dpix</span>&nbsp;<span class="op" id="5475603">:=</span>&nbsp;<span class="ident" id="5475606">dst</span><span class="op" id="5475609">.</span><span class="ident" id="5475610">Pix</span><span class="op" id="5475613">[</span><span class="ident" id="5475614">y</span><span class="op" id="5475615">*</span><span class="ident" id="5475616">dst</span><span class="op" id="5475619">.</span><span class="ident" id="5475620">Stride</span><span class="op" id="5475626">:</span><span class="op" id="5475627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475632">yi</span>&nbsp;<span class="op" id="5475635">:=</span>&nbsp;<span class="op" id="5475638">(</span><span class="ident" id="5475639">sy</span><span class="op" id="5475641">-</span><span class="ident" id="5475642">src</span><span class="op" id="5475645">.</span><span class="ident" id="5475646">Rect</span><span class="op" id="5475650">.</span><span class="ident" id="5475651">Min</span><span class="op" id="5475654">.</span><span class="ident" id="5475655">Y</span><span class="op" id="5475656">)</span><span class="op" id="5475657">*</span><span class="ident" id="5475658">src</span><span class="op" id="5475661">.</span><span class="ident" id="5475662">YStride</span>&nbsp;<span class="op" id="5475670">+</span>&nbsp;<span class="op" id="5475672">(</span><span class="ident" id="5475673">sp</span><span class="op" id="5475675">.</span><span class="ident" id="5475676">X</span>&nbsp;<span class="op" id="5475678">-</span>&nbsp;<span class="ident" id="5475680">src</span><span class="op" id="5475683">.</span><span class="ident" id="5475684">Rect</span><span class="op" id="5475688">.</span><span class="ident" id="5475689">Min</span><span class="op" id="5475692">.</span><span class="ident" id="5475693">X</span><span class="op" id="5475694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475699">ciBase</span>&nbsp;<span class="op" id="5475706">:=</span>&nbsp;<span class="op" id="5475709">(</span><span class="ident" id="5475710">sy</span><span class="op" id="5475712">-</span><span class="ident" id="5475713">src</span><span class="op" id="5475716">.</span><span class="ident" id="5475717">Rect</span><span class="op" id="5475721">.</span><span class="ident" id="5475722">Min</span><span class="op" id="5475725">.</span><span class="ident" id="5475726">Y</span><span class="op" id="5475727">)</span><span class="op" id="5475728">*</span><span class="ident" id="5475729">src</span><span class="op" id="5475732">.</span><span class="ident" id="5475733">CStride</span>&nbsp;<span class="op" id="5475741">-</span>&nbsp;<span class="ident" id="5475743">src</span><span class="op" id="5475746">.</span><span class="ident" id="5475747">Rect</span><span class="op" id="5475751">.</span><span class="ident" id="5475752">Min</span><span class="op" id="5475755">.</span><span class="ident" id="5475756">X</span><span class="op" id="5475757">/</span><span class="num" id="5475758">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5475763">for</span>&nbsp;<span class="ident" id="5475767">x</span><span class="op" id="5475768">,</span>&nbsp;<span class="ident" id="5475770">sx</span>&nbsp;<span class="op" id="5475773">:=</span>&nbsp;<span class="ident" id="5475776">x0</span><span class="op" id="5475778">,</span>&nbsp;<span class="ident" id="5475780">sp</span><span class="op" id="5475782">.</span><span class="ident" id="5475783">X</span><span class="op" id="5475784">;</span>&nbsp;<span class="ident" id="5475786">x</span>&nbsp;<span class="op" id="5475788">!=</span>&nbsp;<span class="ident" id="5475791">x1</span><span class="op" id="5475793">;</span>&nbsp;<span class="ident" id="5475795">x</span><span class="op" id="5475796">,</span>&nbsp;<span class="ident" id="5475798">sx</span><span class="op" id="5475800">,</span>&nbsp;<span class="ident" id="5475802">yi</span>&nbsp;<span class="op" id="5475805">=</span>&nbsp;<span class="ident" id="5475807">x</span><span class="op" id="5475808">+</span><span class="num" id="5475809">4</span><span class="op" id="5475810">,</span>&nbsp;<span class="ident" id="5475812">sx</span><span class="op" id="5475814">+</span><span class="num" id="5475815">1</span><span class="op" id="5475816">,</span>&nbsp;<span class="ident" id="5475818">yi</span><span class="op" id="5475820">+</span><span class="num" id="5475821">1</span>&nbsp;<span class="op" id="5475823">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475829">ci</span>&nbsp;<span class="op" id="5475832">:=</span>&nbsp;<span class="ident" id="5475835">ciBase</span>&nbsp;<span class="op" id="5475842">+</span>&nbsp;<span class="ident" id="5475844">sx</span><span class="op" id="5475846">/</span><span class="num" id="5475847">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475853">rr</span><span class="op" id="5475855">,</span>&nbsp;<span class="ident" id="5475857">gg</span><span class="op" id="5475859">,</span>&nbsp;<span class="ident" id="5475861">bb</span>&nbsp;<span class="op" id="5475864">:=</span>&nbsp;<span class="ident" id="5475867">color</span><span class="op" id="5475872">.</span><span class="ident" id="5475873">YCbCrToRGB</span><span class="op" id="5475883">(</span><span class="ident" id="5475884">src</span><span class="op" id="5475887">.</span><span class="ident" id="5475888">Y</span><span class="op" id="5475889">[</span><span class="ident" id="5475890">yi</span><span class="op" id="5475892">]</span><span class="op" id="5475893">,</span>&nbsp;<span class="ident" id="5475895">src</span><span class="op" id="5475898">.</span><span class="ident" id="5475899">Cb</span><span class="op" id="5475901">[</span><span class="ident" id="5475902">ci</span><span class="op" id="5475904">]</span><span class="op" id="5475905">,</span>&nbsp;<span class="ident" id="5475907">src</span><span class="op" id="5475910">.</span><span class="ident" id="5475911">Cr</span><span class="op" id="5475913">[</span><span class="ident" id="5475914">ci</span><span class="op" id="5475916">]</span><span class="op" id="5475917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475923">dpix</span><span class="op" id="5475927">[</span><span class="ident" id="5475928">x</span><span class="op" id="5475929">+</span><span class="num" id="5475930">0</span><span class="op" id="5475931">]</span>&nbsp;<span class="op" id="5475933">=</span>&nbsp;<span class="ident" id="5475935">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475942">dpix</span><span class="op" id="5475946">[</span><span class="ident" id="5475947">x</span><span class="op" id="5475948">+</span><span class="num" id="5475949">1</span><span class="op" id="5475950">]</span>&nbsp;<span class="op" id="5475952">=</span>&nbsp;<span class="ident" id="5475954">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475961">dpix</span><span class="op" id="5475965">[</span><span class="ident" id="5475966">x</span><span class="op" id="5475967">+</span><span class="num" id="5475968">2</span><span class="op" id="5475969">]</span>&nbsp;<span class="op" id="5475971">=</span>&nbsp;<span class="ident" id="5475973">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5475980">dpix</span><span class="op" id="5475984">[</span><span class="ident" id="5475985">x</span><span class="op" id="5475986">+</span><span class="num" id="5475987">3</span><span class="op" id="5475988">]</span>&nbsp;<span class="op" id="5475990">=</span>&nbsp;<span class="num" id="5475992">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5475999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5476003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476006">case</span>&nbsp;<span class="ident" id="5476011">image</span><span class="op" id="5476016">.</span><span class="ident" id="5476017">YCbCrSubsampleRatio420</span><span class="op" id="5476039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476043">for</span>&nbsp;<span class="ident" id="5476047">y</span><span class="op" id="5476048">,</span>&nbsp;<span class="ident" id="5476050">sy</span>&nbsp;<span class="op" id="5476053">:=</span>&nbsp;<span class="ident" id="5476056">y0</span><span class="op" id="5476058">,</span>&nbsp;<span class="ident" id="5476060">sp</span><span class="op" id="5476062">.</span><span class="ident" id="5476063">Y</span><span class="op" id="5476064">;</span>&nbsp;<span class="ident" id="5476066">y</span>&nbsp;<span class="op" id="5476068">!=</span>&nbsp;<span class="ident" id="5476071">y1</span><span class="op" id="5476073">;</span>&nbsp;<span class="ident" id="5476075">y</span><span class="op" id="5476076">,</span>&nbsp;<span class="ident" id="5476078">sy</span>&nbsp;<span class="op" id="5476081">=</span>&nbsp;<span class="ident" id="5476083">y</span><span class="op" id="5476084">+</span><span class="num" id="5476085">1</span><span class="op" id="5476086">,</span>&nbsp;<span class="ident" id="5476088">sy</span><span class="op" id="5476090">+</span><span class="num" id="5476091">1</span>&nbsp;<span class="op" id="5476093">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476098">dpix</span>&nbsp;<span class="op" id="5476103">:=</span>&nbsp;<span class="ident" id="5476106">dst</span><span class="op" id="5476109">.</span><span class="ident" id="5476110">Pix</span><span class="op" id="5476113">[</span><span class="ident" id="5476114">y</span><span class="op" id="5476115">*</span><span class="ident" id="5476116">dst</span><span class="op" id="5476119">.</span><span class="ident" id="5476120">Stride</span><span class="op" id="5476126">:</span><span class="op" id="5476127">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476132">yi</span>&nbsp;<span class="op" id="5476135">:=</span>&nbsp;<span class="op" id="5476138">(</span><span class="ident" id="5476139">sy</span><span class="op" id="5476141">-</span><span class="ident" id="5476142">src</span><span class="op" id="5476145">.</span><span class="ident" id="5476146">Rect</span><span class="op" id="5476150">.</span><span class="ident" id="5476151">Min</span><span class="op" id="5476154">.</span><span class="ident" id="5476155">Y</span><span class="op" id="5476156">)</span><span class="op" id="5476157">*</span><span class="ident" id="5476158">src</span><span class="op" id="5476161">.</span><span class="ident" id="5476162">YStride</span>&nbsp;<span class="op" id="5476170">+</span>&nbsp;<span class="op" id="5476172">(</span><span class="ident" id="5476173">sp</span><span class="op" id="5476175">.</span><span class="ident" id="5476176">X</span>&nbsp;<span class="op" id="5476178">-</span>&nbsp;<span class="ident" id="5476180">src</span><span class="op" id="5476183">.</span><span class="ident" id="5476184">Rect</span><span class="op" id="5476188">.</span><span class="ident" id="5476189">Min</span><span class="op" id="5476192">.</span><span class="ident" id="5476193">X</span><span class="op" id="5476194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476199">ciBase</span>&nbsp;<span class="op" id="5476206">:=</span>&nbsp;<span class="op" id="5476209">(</span><span class="ident" id="5476210">sy</span><span class="op" id="5476212">/</span><span class="num" id="5476213">2</span><span class="op" id="5476214">-</span><span class="ident" id="5476215">src</span><span class="op" id="5476218">.</span><span class="ident" id="5476219">Rect</span><span class="op" id="5476223">.</span><span class="ident" id="5476224">Min</span><span class="op" id="5476227">.</span><span class="ident" id="5476228">Y</span><span class="op" id="5476229">/</span><span class="num" id="5476230">2</span><span class="op" id="5476231">)</span><span class="op" id="5476232">*</span><span class="ident" id="5476233">src</span><span class="op" id="5476236">.</span><span class="ident" id="5476237">CStride</span>&nbsp;<span class="op" id="5476245">-</span>&nbsp;<span class="ident" id="5476247">src</span><span class="op" id="5476250">.</span><span class="ident" id="5476251">Rect</span><span class="op" id="5476255">.</span><span class="ident" id="5476256">Min</span><span class="op" id="5476259">.</span><span class="ident" id="5476260">X</span><span class="op" id="5476261">/</span><span class="num" id="5476262">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476267">for</span>&nbsp;<span class="ident" id="5476271">x</span><span class="op" id="5476272">,</span>&nbsp;<span class="ident" id="5476274">sx</span>&nbsp;<span class="op" id="5476277">:=</span>&nbsp;<span class="ident" id="5476280">x0</span><span class="op" id="5476282">,</span>&nbsp;<span class="ident" id="5476284">sp</span><span class="op" id="5476286">.</span><span class="ident" id="5476287">X</span><span class="op" id="5476288">;</span>&nbsp;<span class="ident" id="5476290">x</span>&nbsp;<span class="op" id="5476292">!=</span>&nbsp;<span class="ident" id="5476295">x1</span><span class="op" id="5476297">;</span>&nbsp;<span class="ident" id="5476299">x</span><span class="op" id="5476300">,</span>&nbsp;<span class="ident" id="5476302">sx</span><span class="op" id="5476304">,</span>&nbsp;<span class="ident" id="5476306">yi</span>&nbsp;<span class="op" id="5476309">=</span>&nbsp;<span class="ident" id="5476311">x</span><span class="op" id="5476312">+</span><span class="num" id="5476313">4</span><span class="op" id="5476314">,</span>&nbsp;<span class="ident" id="5476316">sx</span><span class="op" id="5476318">+</span><span class="num" id="5476319">1</span><span class="op" id="5476320">,</span>&nbsp;<span class="ident" id="5476322">yi</span><span class="op" id="5476324">+</span><span class="num" id="5476325">1</span>&nbsp;<span class="op" id="5476327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476333">ci</span>&nbsp;<span class="op" id="5476336">:=</span>&nbsp;<span class="ident" id="5476339">ciBase</span>&nbsp;<span class="op" id="5476346">+</span>&nbsp;<span class="ident" id="5476348">sx</span><span class="op" id="5476350">/</span><span class="num" id="5476351">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476357">rr</span><span class="op" id="5476359">,</span>&nbsp;<span class="ident" id="5476361">gg</span><span class="op" id="5476363">,</span>&nbsp;<span class="ident" id="5476365">bb</span>&nbsp;<span class="op" id="5476368">:=</span>&nbsp;<span class="ident" id="5476371">color</span><span class="op" id="5476376">.</span><span class="ident" id="5476377">YCbCrToRGB</span><span class="op" id="5476387">(</span><span class="ident" id="5476388">src</span><span class="op" id="5476391">.</span><span class="ident" id="5476392">Y</span><span class="op" id="5476393">[</span><span class="ident" id="5476394">yi</span><span class="op" id="5476396">]</span><span class="op" id="5476397">,</span>&nbsp;<span class="ident" id="5476399">src</span><span class="op" id="5476402">.</span><span class="ident" id="5476403">Cb</span><span class="op" id="5476405">[</span><span class="ident" id="5476406">ci</span><span class="op" id="5476408">]</span><span class="op" id="5476409">,</span>&nbsp;<span class="ident" id="5476411">src</span><span class="op" id="5476414">.</span><span class="ident" id="5476415">Cr</span><span class="op" id="5476417">[</span><span class="ident" id="5476418">ci</span><span class="op" id="5476420">]</span><span class="op" id="5476421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476427">dpix</span><span class="op" id="5476431">[</span><span class="ident" id="5476432">x</span><span class="op" id="5476433">+</span><span class="num" id="5476434">0</span><span class="op" id="5476435">]</span>&nbsp;<span class="op" id="5476437">=</span>&nbsp;<span class="ident" id="5476439">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476446">dpix</span><span class="op" id="5476450">[</span><span class="ident" id="5476451">x</span><span class="op" id="5476452">+</span><span class="num" id="5476453">1</span><span class="op" id="5476454">]</span>&nbsp;<span class="op" id="5476456">=</span>&nbsp;<span class="ident" id="5476458">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476465">dpix</span><span class="op" id="5476469">[</span><span class="ident" id="5476470">x</span><span class="op" id="5476471">+</span><span class="num" id="5476472">2</span><span class="op" id="5476473">]</span>&nbsp;<span class="op" id="5476475">=</span>&nbsp;<span class="ident" id="5476477">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476484">dpix</span><span class="op" id="5476488">[</span><span class="ident" id="5476489">x</span><span class="op" id="5476490">+</span><span class="num" id="5476491">3</span><span class="op" id="5476492">]</span>&nbsp;<span class="op" id="5476494">=</span>&nbsp;<span class="num" id="5476496">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5476503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5476507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476510">case</span>&nbsp;<span class="ident" id="5476515">image</span><span class="op" id="5476520">.</span><span class="ident" id="5476521">YCbCrSubsampleRatio440</span><span class="op" id="5476543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476547">for</span>&nbsp;<span class="ident" id="5476551">y</span><span class="op" id="5476552">,</span>&nbsp;<span class="ident" id="5476554">sy</span>&nbsp;<span class="op" id="5476557">:=</span>&nbsp;<span class="ident" id="5476560">y0</span><span class="op" id="5476562">,</span>&nbsp;<span class="ident" id="5476564">sp</span><span class="op" id="5476566">.</span><span class="ident" id="5476567">Y</span><span class="op" id="5476568">;</span>&nbsp;<span class="ident" id="5476570">y</span>&nbsp;<span class="op" id="5476572">!=</span>&nbsp;<span class="ident" id="5476575">y1</span><span class="op" id="5476577">;</span>&nbsp;<span class="ident" id="5476579">y</span><span class="op" id="5476580">,</span>&nbsp;<span class="ident" id="5476582">sy</span>&nbsp;<span class="op" id="5476585">=</span>&nbsp;<span class="ident" id="5476587">y</span><span class="op" id="5476588">+</span><span class="num" id="5476589">1</span><span class="op" id="5476590">,</span>&nbsp;<span class="ident" id="5476592">sy</span><span class="op" id="5476594">+</span><span class="num" id="5476595">1</span>&nbsp;<span class="op" id="5476597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476602">dpix</span>&nbsp;<span class="op" id="5476607">:=</span>&nbsp;<span class="ident" id="5476610">dst</span><span class="op" id="5476613">.</span><span class="ident" id="5476614">Pix</span><span class="op" id="5476617">[</span><span class="ident" id="5476618">y</span><span class="op" id="5476619">*</span><span class="ident" id="5476620">dst</span><span class="op" id="5476623">.</span><span class="ident" id="5476624">Stride</span><span class="op" id="5476630">:</span><span class="op" id="5476631">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476636">yi</span>&nbsp;<span class="op" id="5476639">:=</span>&nbsp;<span class="op" id="5476642">(</span><span class="ident" id="5476643">sy</span><span class="op" id="5476645">-</span><span class="ident" id="5476646">src</span><span class="op" id="5476649">.</span><span class="ident" id="5476650">Rect</span><span class="op" id="5476654">.</span><span class="ident" id="5476655">Min</span><span class="op" id="5476658">.</span><span class="ident" id="5476659">Y</span><span class="op" id="5476660">)</span><span class="op" id="5476661">*</span><span class="ident" id="5476662">src</span><span class="op" id="5476665">.</span><span class="ident" id="5476666">YStride</span>&nbsp;<span class="op" id="5476674">+</span>&nbsp;<span class="op" id="5476676">(</span><span class="ident" id="5476677">sp</span><span class="op" id="5476679">.</span><span class="ident" id="5476680">X</span>&nbsp;<span class="op" id="5476682">-</span>&nbsp;<span class="ident" id="5476684">src</span><span class="op" id="5476687">.</span><span class="ident" id="5476688">Rect</span><span class="op" id="5476692">.</span><span class="ident" id="5476693">Min</span><span class="op" id="5476696">.</span><span class="ident" id="5476697">X</span><span class="op" id="5476698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476703">ci</span>&nbsp;<span class="op" id="5476706">:=</span>&nbsp;<span class="op" id="5476709">(</span><span class="ident" id="5476710">sy</span><span class="op" id="5476712">/</span><span class="num" id="5476713">2</span><span class="op" id="5476714">-</span><span class="ident" id="5476715">src</span><span class="op" id="5476718">.</span><span class="ident" id="5476719">Rect</span><span class="op" id="5476723">.</span><span class="ident" id="5476724">Min</span><span class="op" id="5476727">.</span><span class="ident" id="5476728">Y</span><span class="op" id="5476729">/</span><span class="num" id="5476730">2</span><span class="op" id="5476731">)</span><span class="op" id="5476732">*</span><span class="ident" id="5476733">src</span><span class="op" id="5476736">.</span><span class="ident" id="5476737">CStride</span>&nbsp;<span class="op" id="5476745">+</span>&nbsp;<span class="op" id="5476747">(</span><span class="ident" id="5476748">sp</span><span class="op" id="5476750">.</span><span class="ident" id="5476751">X</span>&nbsp;<span class="op" id="5476753">-</span>&nbsp;<span class="ident" id="5476755">src</span><span class="op" id="5476758">.</span><span class="ident" id="5476759">Rect</span><span class="op" id="5476763">.</span><span class="ident" id="5476764">Min</span><span class="op" id="5476767">.</span><span class="ident" id="5476768">X</span><span class="op" id="5476769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476774">for</span>&nbsp;<span class="ident" id="5476778">x</span>&nbsp;<span class="op" id="5476780">:=</span>&nbsp;<span class="ident" id="5476783">x0</span><span class="op" id="5476785">;</span>&nbsp;<span class="ident" id="5476787">x</span>&nbsp;<span class="op" id="5476789">!=</span>&nbsp;<span class="ident" id="5476792">x1</span><span class="op" id="5476794">;</span>&nbsp;<span class="ident" id="5476796">x</span><span class="op" id="5476797">,</span>&nbsp;<span class="ident" id="5476799">yi</span><span class="op" id="5476801">,</span>&nbsp;<span class="ident" id="5476803">ci</span>&nbsp;<span class="op" id="5476806">=</span>&nbsp;<span class="ident" id="5476808">x</span><span class="op" id="5476809">+</span><span class="num" id="5476810">4</span><span class="op" id="5476811">,</span>&nbsp;<span class="ident" id="5476813">yi</span><span class="op" id="5476815">+</span><span class="num" id="5476816">1</span><span class="op" id="5476817">,</span>&nbsp;<span class="ident" id="5476819">ci</span><span class="op" id="5476821">+</span><span class="num" id="5476822">1</span>&nbsp;<span class="op" id="5476824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476830">rr</span><span class="op" id="5476832">,</span>&nbsp;<span class="ident" id="5476834">gg</span><span class="op" id="5476836">,</span>&nbsp;<span class="ident" id="5476838">bb</span>&nbsp;<span class="op" id="5476841">:=</span>&nbsp;<span class="ident" id="5476844">color</span><span class="op" id="5476849">.</span><span class="ident" id="5476850">YCbCrToRGB</span><span class="op" id="5476860">(</span><span class="ident" id="5476861">src</span><span class="op" id="5476864">.</span><span class="ident" id="5476865">Y</span><span class="op" id="5476866">[</span><span class="ident" id="5476867">yi</span><span class="op" id="5476869">]</span><span class="op" id="5476870">,</span>&nbsp;<span class="ident" id="5476872">src</span><span class="op" id="5476875">.</span><span class="ident" id="5476876">Cb</span><span class="op" id="5476878">[</span><span class="ident" id="5476879">ci</span><span class="op" id="5476881">]</span><span class="op" id="5476882">,</span>&nbsp;<span class="ident" id="5476884">src</span><span class="op" id="5476887">.</span><span class="ident" id="5476888">Cr</span><span class="op" id="5476890">[</span><span class="ident" id="5476891">ci</span><span class="op" id="5476893">]</span><span class="op" id="5476894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476900">dpix</span><span class="op" id="5476904">[</span><span class="ident" id="5476905">x</span><span class="op" id="5476906">+</span><span class="num" id="5476907">0</span><span class="op" id="5476908">]</span>&nbsp;<span class="op" id="5476910">=</span>&nbsp;<span class="ident" id="5476912">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476919">dpix</span><span class="op" id="5476923">[</span><span class="ident" id="5476924">x</span><span class="op" id="5476925">+</span><span class="num" id="5476926">1</span><span class="op" id="5476927">]</span>&nbsp;<span class="op" id="5476929">=</span>&nbsp;<span class="ident" id="5476931">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476938">dpix</span><span class="op" id="5476942">[</span><span class="ident" id="5476943">x</span><span class="op" id="5476944">+</span><span class="num" id="5476945">2</span><span class="op" id="5476946">]</span>&nbsp;<span class="op" id="5476948">=</span>&nbsp;<span class="ident" id="5476950">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5476957">dpix</span><span class="op" id="5476961">[</span><span class="ident" id="5476962">x</span><span class="op" id="5476963">+</span><span class="num" id="5476964">3</span><span class="op" id="5476965">]</span>&nbsp;<span class="op" id="5476967">=</span>&nbsp;<span class="num" id="5476969">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5476976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5476980">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476983">default</span><span class="op" id="5476990">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5476994">return</span>&nbsp;<span class="builtintype" id="5477001">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5477008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5477011">return</span>&nbsp;<span class="builtintype" id="5477018">true</span><br>
<span class="lineno"></span><span class="op" id="5477023">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5477026">func</span>&nbsp;<span class="ident" id="5477031">drawGlyphOver</span><span class="op" id="5477044">(</span><span class="ident" id="5477045">dst</span>&nbsp;<span class="op" id="5477049">*</span><span class="ident" id="5477050">image</span><span class="op" id="5477055">.</span><span class="ident" id="5477056">RGBA</span><span class="op" id="5477060">,</span>&nbsp;<span class="ident" id="5477062">r</span>&nbsp;<span class="ident" id="5477064">image</span><span class="op" id="5477069">.</span><span class="ident" id="5477070">Rectangle</span><span class="op" id="5477079">,</span>&nbsp;<span class="ident" id="5477081">src</span>&nbsp;<span class="op" id="5477085">*</span><span class="ident" id="5477086">image</span><span class="op" id="5477091">.</span><span class="ident" id="5477092">Uniform</span><span class="op" id="5477099">,</span>&nbsp;<span class="ident" id="5477101">mask</span>&nbsp;<span class="op" id="5477106">*</span><span class="ident" id="5477107">image</span><span class="op" id="5477112">.</span><span class="ident" id="5477113">Alpha</span><span class="op" id="5477118">,</span>&nbsp;<span class="ident" id="5477120">mp</span>&nbsp;<span class="ident" id="5477123">image</span><span class="op" id="5477128">.</span><span class="ident" id="5477129">Point</span><span class="op" id="5477134">)</span>&nbsp;<span class="op" id="5477136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477139">i0</span>&nbsp;<span class="op" id="5477142">:=</span>&nbsp;<span class="ident" id="5477145">dst</span><span class="op" id="5477148">.</span><span class="ident" id="5477149">PixOffset</span><span class="op" id="5477158">(</span><span class="ident" id="5477159">r</span><span class="op" id="5477160">.</span><span class="ident" id="5477161">Min</span><span class="op" id="5477164">.</span><span class="ident" id="5477165">X</span><span class="op" id="5477166">,</span>&nbsp;<span class="ident" id="5477168">r</span><span class="op" id="5477169">.</span><span class="ident" id="5477170">Min</span><span class="op" id="5477173">.</span><span class="ident" id="5477174">Y</span><span class="op" id="5477175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477178">i1</span>&nbsp;<span class="op" id="5477181">:=</span>&nbsp;<span class="ident" id="5477184">i0</span>&nbsp;<span class="op" id="5477187">+</span>&nbsp;<span class="ident" id="5477189">r</span><span class="op" id="5477190">.</span><span class="ident" id="5477191">Dx</span><span class="op" id="5477193">(</span><span class="op" id="5477194">)</span><span class="op" id="5477195">*</span><span class="num" id="5477196">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477199">mi0</span>&nbsp;<span class="op" id="5477203">:=</span>&nbsp;<span class="ident" id="5477206">mask</span><span class="op" id="5477210">.</span><span class="ident" id="5477211">PixOffset</span><span class="op" id="5477220">(</span><span class="ident" id="5477221">mp</span><span class="op" id="5477223">.</span><span class="ident" id="5477224">X</span><span class="op" id="5477225">,</span>&nbsp;<span class="ident" id="5477227">mp</span><span class="op" id="5477229">.</span><span class="ident" id="5477230">Y</span><span class="op" id="5477231">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477234">sr</span><span class="op" id="5477236">,</span>&nbsp;<span class="ident" id="5477238">sg</span><span class="op" id="5477240">,</span>&nbsp;<span class="ident" id="5477242">sb</span><span class="op" id="5477244">,</span>&nbsp;<span class="ident" id="5477246">sa</span>&nbsp;<span class="op" id="5477249">:=</span>&nbsp;<span class="ident" id="5477252">src</span><span class="op" id="5477255">.</span><span class="ident" id="5477256">RGBA</span><span class="op" id="5477260">(</span><span class="op" id="5477261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5477264">for</span>&nbsp;<span class="ident" id="5477268">y</span><span class="op" id="5477269">,</span>&nbsp;<span class="ident" id="5477271">my</span>&nbsp;<span class="op" id="5477274">:=</span>&nbsp;<span class="ident" id="5477277">r</span><span class="op" id="5477278">.</span><span class="ident" id="5477279">Min</span><span class="op" id="5477282">.</span><span class="ident" id="5477283">Y</span><span class="op" id="5477284">,</span>&nbsp;<span class="ident" id="5477286">mp</span><span class="op" id="5477288">.</span><span class="ident" id="5477289">Y</span><span class="op" id="5477290">;</span>&nbsp;<span class="ident" id="5477292">y</span>&nbsp;<span class="op" id="5477294">!=</span>&nbsp;<span class="ident" id="5477297">r</span><span class="op" id="5477298">.</span><span class="ident" id="5477299">Max</span><span class="op" id="5477302">.</span><span class="ident" id="5477303">Y</span><span class="op" id="5477304">;</span>&nbsp;<span class="ident" id="5477306">y</span><span class="op" id="5477307">,</span>&nbsp;<span class="ident" id="5477309">my</span>&nbsp;<span class="op" id="5477312">=</span>&nbsp;<span class="ident" id="5477314">y</span><span class="op" id="5477315">+</span><span class="num" id="5477316">1</span><span class="op" id="5477317">,</span>&nbsp;<span class="ident" id="5477319">my</span><span class="op" id="5477321">+</span><span class="num" id="5477322">1</span>&nbsp;<span class="op" id="5477324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5477328">for</span>&nbsp;<span class="ident" id="5477332">i</span><span class="op" id="5477333">,</span>&nbsp;<span class="ident" id="5477335">mi</span>&nbsp;<span class="op" id="5477338">:=</span>&nbsp;<span class="ident" id="5477341">i0</span><span class="op" id="5477343">,</span>&nbsp;<span class="ident" id="5477345">mi0</span><span class="op" id="5477348">;</span>&nbsp;<span class="ident" id="5477350">i</span>&nbsp;<span class="op" id="5477352">&lt;</span>&nbsp;<span class="ident" id="5477354">i1</span><span class="op" id="5477356">;</span>&nbsp;<span class="ident" id="5477358">i</span><span class="op" id="5477359">,</span>&nbsp;<span class="ident" id="5477361">mi</span>&nbsp;<span class="op" id="5477364">=</span>&nbsp;<span class="ident" id="5477366">i</span><span class="op" id="5477367">+</span><span class="num" id="5477368">4</span><span class="op" id="5477369">,</span>&nbsp;<span class="ident" id="5477371">mi</span><span class="op" id="5477373">+</span><span class="num" id="5477374">1</span>&nbsp;<span class="op" id="5477376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477381">ma</span>&nbsp;<span class="op" id="5477384">:=</span>&nbsp;<span class="builtintype" id="5477387">uint32</span><span class="op" id="5477393">(</span><span class="ident" id="5477394">mask</span><span class="op" id="5477398">.</span><span class="ident" id="5477399">Pix</span><span class="op" id="5477402">[</span><span class="ident" id="5477403">mi</span><span class="op" id="5477405">]</span><span class="op" id="5477406">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5477411">if</span>&nbsp;<span class="ident" id="5477414">ma</span>&nbsp;<span class="op" id="5477417">==</span>&nbsp;<span class="num" id="5477420">0</span>&nbsp;<span class="op" id="5477422">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5477428">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5477440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477445">ma</span>&nbsp;<span class="op" id="5477448">|=</span>&nbsp;<span class="ident" id="5477451">ma</span>&nbsp;<span class="op" id="5477454">&lt;&lt;</span>&nbsp;<span class="num" id="5477457">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477463">dr</span>&nbsp;<span class="op" id="5477466">:=</span>&nbsp;<span class="builtintype" id="5477469">uint32</span><span class="op" id="5477475">(</span><span class="ident" id="5477476">dst</span><span class="op" id="5477479">.</span><span class="ident" id="5477480">Pix</span><span class="op" id="5477483">[</span><span class="ident" id="5477484">i</span><span class="op" id="5477485">+</span><span class="num" id="5477486">0</span><span class="op" id="5477487">]</span><span class="op" id="5477488">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477493">dg</span>&nbsp;<span class="op" id="5477496">:=</span>&nbsp;<span class="builtintype" id="5477499">uint32</span><span class="op" id="5477505">(</span><span class="ident" id="5477506">dst</span><span class="op" id="5477509">.</span><span class="ident" id="5477510">Pix</span><span class="op" id="5477513">[</span><span class="ident" id="5477514">i</span><span class="op" id="5477515">+</span><span class="num" id="5477516">1</span><span class="op" id="5477517">]</span><span class="op" id="5477518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477523">db</span>&nbsp;<span class="op" id="5477526">:=</span>&nbsp;<span class="builtintype" id="5477529">uint32</span><span class="op" id="5477535">(</span><span class="ident" id="5477536">dst</span><span class="op" id="5477539">.</span><span class="ident" id="5477540">Pix</span><span class="op" id="5477543">[</span><span class="ident" id="5477544">i</span><span class="op" id="5477545">+</span><span class="num" id="5477546">2</span><span class="op" id="5477547">]</span><span class="op" id="5477548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477553">da</span>&nbsp;<span class="op" id="5477556">:=</span>&nbsp;<span class="builtintype" id="5477559">uint32</span><span class="op" id="5477565">(</span><span class="ident" id="5477566">dst</span><span class="op" id="5477569">.</span><span class="ident" id="5477570">Pix</span><span class="op" id="5477573">[</span><span class="ident" id="5477574">i</span><span class="op" id="5477575">+</span><span class="num" id="5477576">3</span><span class="op" id="5477577">]</span><span class="op" id="5477578">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5477584">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477644">a</span>&nbsp;<span class="op" id="5477646">:=</span>&nbsp;<span class="op" id="5477649">(</span><span class="ident" id="5477650">m</span>&nbsp;<span class="op" id="5477652">-</span>&nbsp;<span class="op" id="5477654">(</span><span class="ident" id="5477655">sa</span>&nbsp;<span class="op" id="5477658">*</span>&nbsp;<span class="ident" id="5477660">ma</span>&nbsp;<span class="op" id="5477663">/</span>&nbsp;<span class="ident" id="5477665">m</span><span class="op" id="5477666">)</span><span class="op" id="5477667">)</span>&nbsp;<span class="op" id="5477669">*</span>&nbsp;<span class="num" id="5477671">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477681">dst</span><span class="op" id="5477684">.</span><span class="ident" id="5477685">Pix</span><span class="op" id="5477688">[</span><span class="ident" id="5477689">i</span><span class="op" id="5477690">+</span><span class="num" id="5477691">0</span><span class="op" id="5477692">]</span>&nbsp;<span class="op" id="5477694">=</span>&nbsp;<span class="builtintype" id="5477696">uint8</span><span class="op" id="5477701">(</span><span class="op" id="5477702">(</span><span class="ident" id="5477703">dr</span><span class="op" id="5477705">*</span><span class="ident" id="5477706">a</span>&nbsp;<span class="op" id="5477708">+</span>&nbsp;<span class="ident" id="5477710">sr</span><span class="op" id="5477712">*</span><span class="ident" id="5477713">ma</span><span class="op" id="5477715">)</span>&nbsp;<span class="op" id="5477717">/</span>&nbsp;<span class="ident" id="5477719">m</span>&nbsp;<span class="op" id="5477721">&gt;&gt;</span>&nbsp;<span class="num" id="5477724">8</span><span class="op" id="5477725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477730">dst</span><span class="op" id="5477733">.</span><span class="ident" id="5477734">Pix</span><span class="op" id="5477737">[</span><span class="ident" id="5477738">i</span><span class="op" id="5477739">+</span><span class="num" id="5477740">1</span><span class="op" id="5477741">]</span>&nbsp;<span class="op" id="5477743">=</span>&nbsp;<span class="builtintype" id="5477745">uint8</span><span class="op" id="5477750">(</span><span class="op" id="5477751">(</span><span class="ident" id="5477752">dg</span><span class="op" id="5477754">*</span><span class="ident" id="5477755">a</span>&nbsp;<span class="op" id="5477757">+</span>&nbsp;<span class="ident" id="5477759">sg</span><span class="op" id="5477761">*</span><span class="ident" id="5477762">ma</span><span class="op" id="5477764">)</span>&nbsp;<span class="op" id="5477766">/</span>&nbsp;<span class="ident" id="5477768">m</span>&nbsp;<span class="op" id="5477770">&gt;&gt;</span>&nbsp;<span class="num" id="5477773">8</span><span class="op" id="5477774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477779">dst</span><span class="op" id="5477782">.</span><span class="ident" id="5477783">Pix</span><span class="op" id="5477786">[</span><span class="ident" id="5477787">i</span><span class="op" id="5477788">+</span><span class="num" id="5477789">2</span><span class="op" id="5477790">]</span>&nbsp;<span class="op" id="5477792">=</span>&nbsp;<span class="builtintype" id="5477794">uint8</span><span class="op" id="5477799">(</span><span class="op" id="5477800">(</span><span class="ident" id="5477801">db</span><span class="op" id="5477803">*</span><span class="ident" id="5477804">a</span>&nbsp;<span class="op" id="5477806">+</span>&nbsp;<span class="ident" id="5477808">sb</span><span class="op" id="5477810">*</span><span class="ident" id="5477811">ma</span><span class="op" id="5477813">)</span>&nbsp;<span class="op" id="5477815">/</span>&nbsp;<span class="ident" id="5477817">m</span>&nbsp;<span class="op" id="5477819">&gt;&gt;</span>&nbsp;<span class="num" id="5477822">8</span><span class="op" id="5477823">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477828">dst</span><span class="op" id="5477831">.</span><span class="ident" id="5477832">Pix</span><span class="op" id="5477835">[</span><span class="ident" id="5477836">i</span><span class="op" id="5477837">+</span><span class="num" id="5477838">3</span><span class="op" id="5477839">]</span>&nbsp;<span class="op" id="5477841">=</span>&nbsp;<span class="builtintype" id="5477843">uint8</span><span class="op" id="5477848">(</span><span class="op" id="5477849">(</span><span class="ident" id="5477850">da</span><span class="op" id="5477852">*</span><span class="ident" id="5477853">a</span>&nbsp;<span class="op" id="5477855">+</span>&nbsp;<span class="ident" id="5477857">sa</span><span class="op" id="5477859">*</span><span class="ident" id="5477860">ma</span><span class="op" id="5477862">)</span>&nbsp;<span class="op" id="5477864">/</span>&nbsp;<span class="ident" id="5477866">m</span>&nbsp;<span class="op" id="5477868">&gt;&gt;</span>&nbsp;<span class="num" id="5477871">8</span><span class="op" id="5477872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5477876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477880">i0</span>&nbsp;<span class="op" id="5477883">+=</span>&nbsp;<span class="ident" id="5477886">dst</span><span class="op" id="5477889">.</span><span class="ident" id="5477890">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477899">i1</span>&nbsp;<span class="op" id="5477902">+=</span>&nbsp;<span class="ident" id="5477905">dst</span><span class="op" id="5477908">.</span><span class="ident" id="5477909">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5477918">mi0</span>&nbsp;<span class="op" id="5477922">+=</span>&nbsp;<span class="ident" id="5477925">mask</span><span class="op" id="5477929">.</span><span class="ident" id="5477930">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5477938">}</span><br>
<span class="lineno"></span><span class="op" id="5477940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5477943">func</span>&nbsp;<span class="ident" id="5477948">drawRGBA</span><span class="op" id="5477956">(</span><span class="ident" id="5477957">dst</span>&nbsp;<span class="op" id="5477961">*</span><span class="ident" id="5477962">image</span><span class="op" id="5477967">.</span><span class="ident" id="5477968">RGBA</span><span class="op" id="5477972">,</span>&nbsp;<span class="ident" id="5477974">r</span>&nbsp;<span class="ident" id="5477976">image</span><span class="op" id="5477981">.</span><span class="ident" id="5477982">Rectangle</span><span class="op" id="5477991">,</span>&nbsp;<span class="ident" id="5477993">src</span>&nbsp;<span class="ident" id="5477997">image</span><span class="op" id="5478002">.</span><span class="ident" id="5478003">Image</span><span class="op" id="5478008">,</span>&nbsp;<span class="ident" id="5478010">sp</span>&nbsp;<span class="ident" id="5478013">image</span><span class="op" id="5478018">.</span><span class="ident" id="5478019">Point</span><span class="op" id="5478024">,</span>&nbsp;<span class="ident" id="5478026">mask</span>&nbsp;<span class="ident" id="5478031">image</span><span class="op" id="5478036">.</span><span class="ident" id="5478037">Image</span><span class="op" id="5478042">,</span>&nbsp;<span class="ident" id="5478044">mp</span>&nbsp;<span class="ident" id="5478047">image</span><span class="op" id="5478052">.</span><span class="ident" id="5478053">Point</span><span class="op" id="5478058">,</span>&nbsp;<span class="ident" id="5478060">op</span>&nbsp;<span class="ident" id="5478063">Op</span><span class="op" id="5478065">)</span>&nbsp;<span class="op" id="5478067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478070">x0</span><span class="op" id="5478072">,</span>&nbsp;<span class="ident" id="5478074">x1</span><span class="op" id="5478076">,</span>&nbsp;<span class="ident" id="5478078">dx</span>&nbsp;<span class="op" id="5478081">:=</span>&nbsp;<span class="ident" id="5478084">r</span><span class="op" id="5478085">.</span><span class="ident" id="5478086">Min</span><span class="op" id="5478089">.</span><span class="ident" id="5478090">X</span><span class="op" id="5478091">,</span>&nbsp;<span class="ident" id="5478093">r</span><span class="op" id="5478094">.</span><span class="ident" id="5478095">Max</span><span class="op" id="5478098">.</span><span class="ident" id="5478099">X</span><span class="op" id="5478100">,</span>&nbsp;<span class="num" id="5478102">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478105">y0</span><span class="op" id="5478107">,</span>&nbsp;<span class="ident" id="5478109">y1</span><span class="op" id="5478111">,</span>&nbsp;<span class="ident" id="5478113">dy</span>&nbsp;<span class="op" id="5478116">:=</span>&nbsp;<span class="ident" id="5478119">r</span><span class="op" id="5478120">.</span><span class="ident" id="5478121">Min</span><span class="op" id="5478124">.</span><span class="ident" id="5478125">Y</span><span class="op" id="5478126">,</span>&nbsp;<span class="ident" id="5478128">r</span><span class="op" id="5478129">.</span><span class="ident" id="5478130">Max</span><span class="op" id="5478133">.</span><span class="ident" id="5478134">Y</span><span class="op" id="5478135">,</span>&nbsp;<span class="num" id="5478137">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478140">if</span>&nbsp;<span class="ident" id="5478143">image</span><span class="op" id="5478148">.</span><span class="ident" id="5478149">Image</span><span class="op" id="5478154">(</span><span class="ident" id="5478155">dst</span><span class="op" id="5478158">)</span>&nbsp;<span class="op" id="5478160">==</span>&nbsp;<span class="ident" id="5478163">src</span>&nbsp;<span class="op" id="5478167">&amp;&amp;</span>&nbsp;<span class="ident" id="5478170">r</span><span class="op" id="5478171">.</span><span class="ident" id="5478172">Overlaps</span><span class="op" id="5478180">(</span><span class="ident" id="5478181">r</span><span class="op" id="5478182">.</span><span class="ident" id="5478183">Add</span><span class="op" id="5478186">(</span><span class="ident" id="5478187">sp</span><span class="op" id="5478189">.</span><span class="ident" id="5478190">Sub</span><span class="op" id="5478193">(</span><span class="ident" id="5478194">r</span><span class="op" id="5478195">.</span><span class="ident" id="5478196">Min</span><span class="op" id="5478199">)</span><span class="op" id="5478200">)</span><span class="op" id="5478201">)</span>&nbsp;<span class="op" id="5478203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478207">if</span>&nbsp;<span class="ident" id="5478210">sp</span><span class="op" id="5478212">.</span><span class="ident" id="5478213">Y</span>&nbsp;<span class="op" id="5478215">&lt;</span>&nbsp;<span class="ident" id="5478217">r</span><span class="op" id="5478218">.</span><span class="ident" id="5478219">Min</span><span class="op" id="5478222">.</span><span class="ident" id="5478223">Y</span>&nbsp;<span class="op" id="5478225">||</span>&nbsp;<span class="ident" id="5478228">sp</span><span class="op" id="5478230">.</span><span class="ident" id="5478231">Y</span>&nbsp;<span class="op" id="5478233">==</span>&nbsp;<span class="ident" id="5478236">r</span><span class="op" id="5478237">.</span><span class="ident" id="5478238">Min</span><span class="op" id="5478241">.</span><span class="ident" id="5478242">Y</span>&nbsp;<span class="op" id="5478244">&amp;&amp;</span>&nbsp;<span class="ident" id="5478247">sp</span><span class="op" id="5478249">.</span><span class="ident" id="5478250">X</span>&nbsp;<span class="op" id="5478252">&lt;</span>&nbsp;<span class="ident" id="5478254">r</span><span class="op" id="5478255">.</span><span class="ident" id="5478256">Min</span><span class="op" id="5478259">.</span><span class="ident" id="5478260">X</span>&nbsp;<span class="op" id="5478262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478267">x0</span><span class="op" id="5478269">,</span>&nbsp;<span class="ident" id="5478271">x1</span><span class="op" id="5478273">,</span>&nbsp;<span class="ident" id="5478275">dx</span>&nbsp;<span class="op" id="5478278">=</span>&nbsp;<span class="ident" id="5478280">x1</span><span class="op" id="5478282">-</span><span class="num" id="5478283">1</span><span class="op" id="5478284">,</span>&nbsp;<span class="ident" id="5478286">x0</span><span class="op" id="5478288">-</span><span class="num" id="5478289">1</span><span class="op" id="5478290">,</span>&nbsp;<span class="op" id="5478292">-</span><span class="num" id="5478293">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478298">y0</span><span class="op" id="5478300">,</span>&nbsp;<span class="ident" id="5478302">y1</span><span class="op" id="5478304">,</span>&nbsp;<span class="ident" id="5478306">dy</span>&nbsp;<span class="op" id="5478309">=</span>&nbsp;<span class="ident" id="5478311">y1</span><span class="op" id="5478313">-</span><span class="num" id="5478314">1</span><span class="op" id="5478315">,</span>&nbsp;<span class="ident" id="5478317">y0</span><span class="op" id="5478319">-</span><span class="num" id="5478320">1</span><span class="op" id="5478321">,</span>&nbsp;<span class="op" id="5478323">-</span><span class="num" id="5478324">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5478328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5478331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478335">sy</span>&nbsp;<span class="op" id="5478338">:=</span>&nbsp;<span class="ident" id="5478341">sp</span><span class="op" id="5478343">.</span><span class="ident" id="5478344">Y</span>&nbsp;<span class="op" id="5478346">+</span>&nbsp;<span class="ident" id="5478348">y0</span>&nbsp;<span class="op" id="5478351">-</span>&nbsp;<span class="ident" id="5478353">r</span><span class="op" id="5478354">.</span><span class="ident" id="5478355">Min</span><span class="op" id="5478358">.</span><span class="ident" id="5478359">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478362">my</span>&nbsp;<span class="op" id="5478365">:=</span>&nbsp;<span class="ident" id="5478368">mp</span><span class="op" id="5478370">.</span><span class="ident" id="5478371">Y</span>&nbsp;<span class="op" id="5478373">+</span>&nbsp;<span class="ident" id="5478375">y0</span>&nbsp;<span class="op" id="5478378">-</span>&nbsp;<span class="ident" id="5478380">r</span><span class="op" id="5478381">.</span><span class="ident" id="5478382">Min</span><span class="op" id="5478385">.</span><span class="ident" id="5478386">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478389">sx0</span>&nbsp;<span class="op" id="5478393">:=</span>&nbsp;<span class="ident" id="5478396">sp</span><span class="op" id="5478398">.</span><span class="ident" id="5478399">X</span>&nbsp;<span class="op" id="5478401">+</span>&nbsp;<span class="ident" id="5478403">x0</span>&nbsp;<span class="op" id="5478406">-</span>&nbsp;<span class="ident" id="5478408">r</span><span class="op" id="5478409">.</span><span class="ident" id="5478410">Min</span><span class="op" id="5478413">.</span><span class="ident" id="5478414">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478417">mx0</span>&nbsp;<span class="op" id="5478421">:=</span>&nbsp;<span class="ident" id="5478424">mp</span><span class="op" id="5478426">.</span><span class="ident" id="5478427">X</span>&nbsp;<span class="op" id="5478429">+</span>&nbsp;<span class="ident" id="5478431">x0</span>&nbsp;<span class="op" id="5478434">-</span>&nbsp;<span class="ident" id="5478436">r</span><span class="op" id="5478437">.</span><span class="ident" id="5478438">Min</span><span class="op" id="5478441">.</span><span class="ident" id="5478442">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478445">sx1</span>&nbsp;<span class="op" id="5478449">:=</span>&nbsp;<span class="ident" id="5478452">sx0</span>&nbsp;<span class="op" id="5478456">+</span>&nbsp;<span class="op" id="5478458">(</span><span class="ident" id="5478459">x1</span>&nbsp;<span class="op" id="5478462">-</span>&nbsp;<span class="ident" id="5478464">x0</span><span class="op" id="5478466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478469">i0</span>&nbsp;<span class="op" id="5478472">:=</span>&nbsp;<span class="ident" id="5478475">dst</span><span class="op" id="5478478">.</span><span class="ident" id="5478479">PixOffset</span><span class="op" id="5478488">(</span><span class="ident" id="5478489">x0</span><span class="op" id="5478491">,</span>&nbsp;<span class="ident" id="5478493">y0</span><span class="op" id="5478495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478498">di</span>&nbsp;<span class="op" id="5478501">:=</span>&nbsp;<span class="ident" id="5478504">dx</span>&nbsp;<span class="op" id="5478507">*</span>&nbsp;<span class="num" id="5478509">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478512">for</span>&nbsp;<span class="ident" id="5478516">y</span>&nbsp;<span class="op" id="5478518">:=</span>&nbsp;<span class="ident" id="5478521">y0</span><span class="op" id="5478523">;</span>&nbsp;<span class="ident" id="5478525">y</span>&nbsp;<span class="op" id="5478527">!=</span>&nbsp;<span class="ident" id="5478530">y1</span><span class="op" id="5478532">;</span>&nbsp;<span class="ident" id="5478534">y</span><span class="op" id="5478535">,</span>&nbsp;<span class="ident" id="5478537">sy</span><span class="op" id="5478539">,</span>&nbsp;<span class="ident" id="5478541">my</span>&nbsp;<span class="op" id="5478544">=</span>&nbsp;<span class="ident" id="5478546">y</span><span class="op" id="5478547">+</span><span class="ident" id="5478548">dy</span><span class="op" id="5478550">,</span>&nbsp;<span class="ident" id="5478552">sy</span><span class="op" id="5478554">+</span><span class="ident" id="5478555">dy</span><span class="op" id="5478557">,</span>&nbsp;<span class="ident" id="5478559">my</span><span class="op" id="5478561">+</span><span class="ident" id="5478562">dy</span>&nbsp;<span class="op" id="5478565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478569">for</span>&nbsp;<span class="ident" id="5478573">i</span><span class="op" id="5478574">,</span>&nbsp;<span class="ident" id="5478576">sx</span><span class="op" id="5478578">,</span>&nbsp;<span class="ident" id="5478580">mx</span>&nbsp;<span class="op" id="5478583">:=</span>&nbsp;<span class="ident" id="5478586">i0</span><span class="op" id="5478588">,</span>&nbsp;<span class="ident" id="5478590">sx0</span><span class="op" id="5478593">,</span>&nbsp;<span class="ident" id="5478595">mx0</span><span class="op" id="5478598">;</span>&nbsp;<span class="ident" id="5478600">sx</span>&nbsp;<span class="op" id="5478603">!=</span>&nbsp;<span class="ident" id="5478606">sx1</span><span class="op" id="5478609">;</span>&nbsp;<span class="ident" id="5478611">i</span><span class="op" id="5478612">,</span>&nbsp;<span class="ident" id="5478614">sx</span><span class="op" id="5478616">,</span>&nbsp;<span class="ident" id="5478618">mx</span>&nbsp;<span class="op" id="5478621">=</span>&nbsp;<span class="ident" id="5478623">i</span><span class="op" id="5478624">+</span><span class="ident" id="5478625">di</span><span class="op" id="5478627">,</span>&nbsp;<span class="ident" id="5478629">sx</span><span class="op" id="5478631">+</span><span class="ident" id="5478632">dx</span><span class="op" id="5478634">,</span>&nbsp;<span class="ident" id="5478636">mx</span><span class="op" id="5478638">+</span><span class="ident" id="5478639">dx</span>&nbsp;<span class="op" id="5478642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478647">ma</span>&nbsp;<span class="op" id="5478650">:=</span>&nbsp;<span class="builtintype" id="5478653">uint32</span><span class="op" id="5478659">(</span><span class="ident" id="5478660">m</span><span class="op" id="5478661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478666">if</span>&nbsp;<span class="ident" id="5478669">mask</span>&nbsp;<span class="op" id="5478674">!=</span>&nbsp;<span class="ident" id="5478677">nil</span>&nbsp;<span class="op" id="5478681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478687">_</span><span class="op" id="5478688">,</span>&nbsp;<span class="ident" id="5478690">_</span><span class="op" id="5478691">,</span>&nbsp;<span class="ident" id="5478693">_</span><span class="op" id="5478694">,</span>&nbsp;<span class="ident" id="5478696">ma</span>&nbsp;<span class="op" id="5478699">=</span>&nbsp;<span class="ident" id="5478701">mask</span><span class="op" id="5478705">.</span><span class="ident" id="5478706">At</span><span class="op" id="5478708">(</span><span class="ident" id="5478709">mx</span><span class="op" id="5478711">,</span>&nbsp;<span class="ident" id="5478713">my</span><span class="op" id="5478715">)</span><span class="op" id="5478716">.</span><span class="ident" id="5478717">RGBA</span><span class="op" id="5478721">(</span><span class="op" id="5478722">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5478727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478732">sr</span><span class="op" id="5478734">,</span>&nbsp;<span class="ident" id="5478736">sg</span><span class="op" id="5478738">,</span>&nbsp;<span class="ident" id="5478740">sb</span><span class="op" id="5478742">,</span>&nbsp;<span class="ident" id="5478744">sa</span>&nbsp;<span class="op" id="5478747">:=</span>&nbsp;<span class="ident" id="5478750">src</span><span class="op" id="5478753">.</span><span class="ident" id="5478754">At</span><span class="op" id="5478756">(</span><span class="ident" id="5478757">sx</span><span class="op" id="5478759">,</span>&nbsp;<span class="ident" id="5478761">sy</span><span class="op" id="5478763">)</span><span class="op" id="5478764">.</span><span class="ident" id="5478765">RGBA</span><span class="op" id="5478769">(</span><span class="op" id="5478770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5478775">if</span>&nbsp;<span class="ident" id="5478778">op</span>&nbsp;<span class="op" id="5478781">==</span>&nbsp;<span class="ident" id="5478784">Over</span>&nbsp;<span class="op" id="5478789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478795">dr</span>&nbsp;<span class="op" id="5478798">:=</span>&nbsp;<span class="builtintype" id="5478801">uint32</span><span class="op" id="5478807">(</span><span class="ident" id="5478808">dst</span><span class="op" id="5478811">.</span><span class="ident" id="5478812">Pix</span><span class="op" id="5478815">[</span><span class="ident" id="5478816">i</span><span class="op" id="5478817">+</span><span class="num" id="5478818">0</span><span class="op" id="5478819">]</span><span class="op" id="5478820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478826">dg</span>&nbsp;<span class="op" id="5478829">:=</span>&nbsp;<span class="builtintype" id="5478832">uint32</span><span class="op" id="5478838">(</span><span class="ident" id="5478839">dst</span><span class="op" id="5478842">.</span><span class="ident" id="5478843">Pix</span><span class="op" id="5478846">[</span><span class="ident" id="5478847">i</span><span class="op" id="5478848">+</span><span class="num" id="5478849">1</span><span class="op" id="5478850">]</span><span class="op" id="5478851">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478857">db</span>&nbsp;<span class="op" id="5478860">:=</span>&nbsp;<span class="builtintype" id="5478863">uint32</span><span class="op" id="5478869">(</span><span class="ident" id="5478870">dst</span><span class="op" id="5478873">.</span><span class="ident" id="5478874">Pix</span><span class="op" id="5478877">[</span><span class="ident" id="5478878">i</span><span class="op" id="5478879">+</span><span class="num" id="5478880">2</span><span class="op" id="5478881">]</span><span class="op" id="5478882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5478888">da</span>&nbsp;<span class="op" id="5478891">:=</span>&nbsp;<span class="builtintype" id="5478894">uint32</span><span class="op" id="5478900">(</span><span class="ident" id="5478901">dst</span><span class="op" id="5478904">.</span><span class="ident" id="5478905">Pix</span><span class="op" id="5478908">[</span><span class="ident" id="5478909">i</span><span class="op" id="5478910">+</span><span class="num" id="5478911">3</span><span class="op" id="5478912">]</span><span class="op" id="5478913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5478920">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479000">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479058">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479079">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479145">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479210">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479282">a</span>&nbsp;<span class="op" id="5479284">:=</span>&nbsp;<span class="op" id="5479287">(</span><span class="ident" id="5479288">m</span>&nbsp;<span class="op" id="5479290">-</span>&nbsp;<span class="op" id="5479292">(</span><span class="ident" id="5479293">sa</span>&nbsp;<span class="op" id="5479296">*</span>&nbsp;<span class="ident" id="5479298">ma</span>&nbsp;<span class="op" id="5479301">/</span>&nbsp;<span class="ident" id="5479303">m</span><span class="op" id="5479304">)</span><span class="op" id="5479305">)</span>&nbsp;<span class="op" id="5479307">*</span>&nbsp;<span class="num" id="5479309">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479320">dst</span><span class="op" id="5479323">.</span><span class="ident" id="5479324">Pix</span><span class="op" id="5479327">[</span><span class="ident" id="5479328">i</span><span class="op" id="5479329">+</span><span class="num" id="5479330">0</span><span class="op" id="5479331">]</span>&nbsp;<span class="op" id="5479333">=</span>&nbsp;<span class="builtintype" id="5479335">uint8</span><span class="op" id="5479340">(</span><span class="op" id="5479341">(</span><span class="ident" id="5479342">dr</span><span class="op" id="5479344">*</span><span class="ident" id="5479345">a</span>&nbsp;<span class="op" id="5479347">+</span>&nbsp;<span class="ident" id="5479349">sr</span><span class="op" id="5479351">*</span><span class="ident" id="5479352">ma</span><span class="op" id="5479354">)</span>&nbsp;<span class="op" id="5479356">/</span>&nbsp;<span class="ident" id="5479358">m</span>&nbsp;<span class="op" id="5479360">&gt;&gt;</span>&nbsp;<span class="num" id="5479363">8</span><span class="op" id="5479364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479370">dst</span><span class="op" id="5479373">.</span><span class="ident" id="5479374">Pix</span><span class="op" id="5479377">[</span><span class="ident" id="5479378">i</span><span class="op" id="5479379">+</span><span class="num" id="5479380">1</span><span class="op" id="5479381">]</span>&nbsp;<span class="op" id="5479383">=</span>&nbsp;<span class="builtintype" id="5479385">uint8</span><span class="op" id="5479390">(</span><span class="op" id="5479391">(</span><span class="ident" id="5479392">dg</span><span class="op" id="5479394">*</span><span class="ident" id="5479395">a</span>&nbsp;<span class="op" id="5479397">+</span>&nbsp;<span class="ident" id="5479399">sg</span><span class="op" id="5479401">*</span><span class="ident" id="5479402">ma</span><span class="op" id="5479404">)</span>&nbsp;<span class="op" id="5479406">/</span>&nbsp;<span class="ident" id="5479408">m</span>&nbsp;<span class="op" id="5479410">&gt;&gt;</span>&nbsp;<span class="num" id="5479413">8</span><span class="op" id="5479414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479420">dst</span><span class="op" id="5479423">.</span><span class="ident" id="5479424">Pix</span><span class="op" id="5479427">[</span><span class="ident" id="5479428">i</span><span class="op" id="5479429">+</span><span class="num" id="5479430">2</span><span class="op" id="5479431">]</span>&nbsp;<span class="op" id="5479433">=</span>&nbsp;<span class="builtintype" id="5479435">uint8</span><span class="op" id="5479440">(</span><span class="op" id="5479441">(</span><span class="ident" id="5479442">db</span><span class="op" id="5479444">*</span><span class="ident" id="5479445">a</span>&nbsp;<span class="op" id="5479447">+</span>&nbsp;<span class="ident" id="5479449">sb</span><span class="op" id="5479451">*</span><span class="ident" id="5479452">ma</span><span class="op" id="5479454">)</span>&nbsp;<span class="op" id="5479456">/</span>&nbsp;<span class="ident" id="5479458">m</span>&nbsp;<span class="op" id="5479460">&gt;&gt;</span>&nbsp;<span class="num" id="5479463">8</span><span class="op" id="5479464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479470">dst</span><span class="op" id="5479473">.</span><span class="ident" id="5479474">Pix</span><span class="op" id="5479477">[</span><span class="ident" id="5479478">i</span><span class="op" id="5479479">+</span><span class="num" id="5479480">3</span><span class="op" id="5479481">]</span>&nbsp;<span class="op" id="5479483">=</span>&nbsp;<span class="builtintype" id="5479485">uint8</span><span class="op" id="5479490">(</span><span class="op" id="5479491">(</span><span class="ident" id="5479492">da</span><span class="op" id="5479494">*</span><span class="ident" id="5479495">a</span>&nbsp;<span class="op" id="5479497">+</span>&nbsp;<span class="ident" id="5479499">sa</span><span class="op" id="5479501">*</span><span class="ident" id="5479502">ma</span><span class="op" id="5479504">)</span>&nbsp;<span class="op" id="5479506">/</span>&nbsp;<span class="ident" id="5479508">m</span>&nbsp;<span class="op" id="5479510">&gt;&gt;</span>&nbsp;<span class="num" id="5479513">8</span><span class="op" id="5479514">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479520">}</span>&nbsp;<span class="keyword" id="5479522">else</span>&nbsp;<span class="op" id="5479527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479533">dst</span><span class="op" id="5479536">.</span><span class="ident" id="5479537">Pix</span><span class="op" id="5479540">[</span><span class="ident" id="5479541">i</span><span class="op" id="5479542">+</span><span class="num" id="5479543">0</span><span class="op" id="5479544">]</span>&nbsp;<span class="op" id="5479546">=</span>&nbsp;<span class="builtintype" id="5479548">uint8</span><span class="op" id="5479553">(</span><span class="ident" id="5479554">sr</span>&nbsp;<span class="op" id="5479557">*</span>&nbsp;<span class="ident" id="5479559">ma</span>&nbsp;<span class="op" id="5479562">/</span>&nbsp;<span class="ident" id="5479564">m</span>&nbsp;<span class="op" id="5479566">&gt;&gt;</span>&nbsp;<span class="num" id="5479569">8</span><span class="op" id="5479570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479576">dst</span><span class="op" id="5479579">.</span><span class="ident" id="5479580">Pix</span><span class="op" id="5479583">[</span><span class="ident" id="5479584">i</span><span class="op" id="5479585">+</span><span class="num" id="5479586">1</span><span class="op" id="5479587">]</span>&nbsp;<span class="op" id="5479589">=</span>&nbsp;<span class="builtintype" id="5479591">uint8</span><span class="op" id="5479596">(</span><span class="ident" id="5479597">sg</span>&nbsp;<span class="op" id="5479600">*</span>&nbsp;<span class="ident" id="5479602">ma</span>&nbsp;<span class="op" id="5479605">/</span>&nbsp;<span class="ident" id="5479607">m</span>&nbsp;<span class="op" id="5479609">&gt;&gt;</span>&nbsp;<span class="num" id="5479612">8</span><span class="op" id="5479613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479619">dst</span><span class="op" id="5479622">.</span><span class="ident" id="5479623">Pix</span><span class="op" id="5479626">[</span><span class="ident" id="5479627">i</span><span class="op" id="5479628">+</span><span class="num" id="5479629">2</span><span class="op" id="5479630">]</span>&nbsp;<span class="op" id="5479632">=</span>&nbsp;<span class="builtintype" id="5479634">uint8</span><span class="op" id="5479639">(</span><span class="ident" id="5479640">sb</span>&nbsp;<span class="op" id="5479643">*</span>&nbsp;<span class="ident" id="5479645">ma</span>&nbsp;<span class="op" id="5479648">/</span>&nbsp;<span class="ident" id="5479650">m</span>&nbsp;<span class="op" id="5479652">&gt;&gt;</span>&nbsp;<span class="num" id="5479655">8</span><span class="op" id="5479656">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479662">dst</span><span class="op" id="5479665">.</span><span class="ident" id="5479666">Pix</span><span class="op" id="5479669">[</span><span class="ident" id="5479670">i</span><span class="op" id="5479671">+</span><span class="num" id="5479672">3</span><span class="op" id="5479673">]</span>&nbsp;<span class="op" id="5479675">=</span>&nbsp;<span class="builtintype" id="5479677">uint8</span><span class="op" id="5479682">(</span><span class="ident" id="5479683">sa</span>&nbsp;<span class="op" id="5479686">*</span>&nbsp;<span class="ident" id="5479688">ma</span>&nbsp;<span class="op" id="5479691">/</span>&nbsp;<span class="ident" id="5479693">m</span>&nbsp;<span class="op" id="5479695">&gt;&gt;</span>&nbsp;<span class="num" id="5479698">8</span><span class="op" id="5479699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5479712">i0</span>&nbsp;<span class="op" id="5479715">+=</span>&nbsp;<span class="ident" id="5479718">dy</span>&nbsp;<span class="op" id="5479721">*</span>&nbsp;<span class="ident" id="5479723">dst</span><span class="op" id="5479726">.</span><span class="ident" id="5479727">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479735">}</span><br>
<span class="lineno">545</span><span class="op" id="5479737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5479740">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5479787">func</span>&nbsp;<span class="ident" id="5479792">clamp</span><span class="op" id="5479797">(</span><span class="ident" id="5479798">i</span>&nbsp;<span class="builtintype" id="5479800">int32</span><span class="op" id="5479805">)</span>&nbsp;<span class="builtintype" id="5479807">int32</span>&nbsp;<span class="op" id="5479813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479816">if</span>&nbsp;<span class="ident" id="5479819">i</span>&nbsp;<span class="op" id="5479821">&lt;</span>&nbsp;<span class="num" id="5479823">0</span>&nbsp;<span class="op" id="5479825">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479829">return</span>&nbsp;<span class="num" id="5479836">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479842">if</span>&nbsp;<span class="ident" id="5479845">i</span>&nbsp;<span class="op" id="5479847">&gt;</span>&nbsp;<span class="num" id="5479849">0xffff</span>&nbsp;<span class="op" id="5479856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479860">return</span>&nbsp;<span class="num" id="5479867">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5479875">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5479878">return</span>&nbsp;<span class="ident" id="5479885">i</span><br>
<span class="lineno"></span><span class="op" id="5479887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5479890">func</span>&nbsp;<span class="ident" id="5479895">drawPaletted</span><span class="op" id="5479907">(</span><span class="ident" id="5479908">dst</span>&nbsp;<span class="ident" id="5479912">Image</span><span class="op" id="5479917">,</span>&nbsp;<span class="ident" id="5479919">r</span>&nbsp;<span class="ident" id="5479921">image</span><span class="op" id="5479926">.</span><span class="ident" id="5479927">Rectangle</span><span class="op" id="5479936">,</span>&nbsp;<span class="ident" id="5479938">src</span>&nbsp;<span class="ident" id="5479942">image</span><span class="op" id="5479947">.</span><span class="ident" id="5479948">Image</span><span class="op" id="5479953">,</span>&nbsp;<span class="ident" id="5479955">sp</span>&nbsp;<span class="ident" id="5479958">image</span><span class="op" id="5479963">.</span><span class="ident" id="5479964">Point</span><span class="op" id="5479969">,</span>&nbsp;<span class="ident" id="5479971">floydSteinberg</span>&nbsp;<span class="builtintype" id="5479986">bool</span><span class="op" id="5479990">)</span>&nbsp;<span class="op" id="5479992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5479995">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480062">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480127">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480190">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480260">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480331">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480402">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480448">palette</span><span class="op" id="5480455">,</span>&nbsp;<span class="ident" id="5480457">pix</span><span class="op" id="5480460">,</span>&nbsp;<span class="ident" id="5480462">stride</span>&nbsp;<span class="op" id="5480469">:=</span>&nbsp;<span class="op" id="5480472">[</span><span class="op" id="5480473">]</span><span class="op" id="5480474">[</span><span class="num" id="5480475">3</span><span class="op" id="5480476">]</span><span class="builtintype" id="5480477">int32</span><span class="op" id="5480482">(</span><span class="ident" id="5480483">nil</span><span class="op" id="5480486">)</span><span class="op" id="5480487">,</span>&nbsp;<span class="op" id="5480489">[</span><span class="op" id="5480490">]</span><span class="builtintype" id="5480491">byte</span><span class="op" id="5480495">(</span><span class="ident" id="5480496">nil</span><span class="op" id="5480499">)</span><span class="op" id="5480500">,</span>&nbsp;<span class="num" id="5480502">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480505">if</span>&nbsp;<span class="ident" id="5480508">p</span><span class="op" id="5480509">,</span>&nbsp;<span class="ident" id="5480511">ok</span>&nbsp;<span class="op" id="5480514">:=</span>&nbsp;<span class="ident" id="5480517">dst</span><span class="op" id="5480520">.</span><span class="op" id="5480521">(</span><span class="op" id="5480522">*</span><span class="ident" id="5480523">image</span><span class="op" id="5480528">.</span><span class="ident" id="5480529">Paletted</span><span class="op" id="5480537">)</span><span class="op" id="5480538">;</span>&nbsp;<span class="ident" id="5480540">ok</span>&nbsp;<span class="op" id="5480543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480547">palette</span>&nbsp;<span class="op" id="5480555">=</span>&nbsp;<span class="builtinfunc" id="5480557">make</span><span class="op" id="5480561">(</span><span class="op" id="5480562">[</span><span class="op" id="5480563">]</span><span class="op" id="5480564">[</span><span class="num" id="5480565">3</span><span class="op" id="5480566">]</span><span class="builtintype" id="5480567">int32</span><span class="op" id="5480572">,</span>&nbsp;<span class="builtinfunc" id="5480574">len</span><span class="op" id="5480577">(</span><span class="ident" id="5480578">p</span><span class="op" id="5480579">.</span><span class="ident" id="5480580">Palette</span><span class="op" id="5480587">)</span><span class="op" id="5480588">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5480592">for</span>&nbsp;<span class="ident" id="5480596">i</span><span class="op" id="5480597">,</span>&nbsp;<span class="ident" id="5480599">col</span>&nbsp;<span class="op" id="5480603">:=</span>&nbsp;<span class="keyword" id="5480606">range</span>&nbsp;<span class="ident" id="5480612">p</span><span class="op" id="5480613">.</span><span class="ident" id="5480614">Palette</span>&nbsp;<span class="op" id="5480622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480627">r</span><span class="op" id="5480628">,</span>&nbsp;<span class="ident" id="5480630">g</span><span class="op" id="5480631">,</span>&nbsp;<span class="ident" id="5480633">b</span><span class="op" id="5480634">,</span>&nbsp;<span class="ident" id="5480636">_</span>&nbsp;<span class="op" id="5480638">:=</span>&nbsp;<span class="ident" id="5480641">col</span><span class="op" id="5480644">.</span><span class="ident" id="5480645">RGBA</span><span class="op" id="5480649">(</span><span class="op" id="5480650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480655">palette</span><span class="op" id="5480662">[</span><span class="ident" id="5480663">i</span><span class="op" id="5480664">]</span><span class="op" id="5480665">[</span><span class="num" id="5480666">0</span><span class="op" id="5480667">]</span>&nbsp;<span class="op" id="5480669">=</span>&nbsp;<span class="builtintype" id="5480671">int32</span><span class="op" id="5480676">(</span><span class="ident" id="5480677">r</span><span class="op" id="5480678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480683">palette</span><span class="op" id="5480690">[</span><span class="ident" id="5480691">i</span><span class="op" id="5480692">]</span><span class="op" id="5480693">[</span><span class="num" id="5480694">1</span><span class="op" id="5480695">]</span>&nbsp;<span class="op" id="5480697">=</span>&nbsp;<span class="builtintype" id="5480699">int32</span><span class="op" id="5480704">(</span><span class="ident" id="5480705">g</span><span class="op" id="5480706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480711">palette</span><span class="op" id="5480718">[</span><span class="ident" id="5480719">i</span><span class="op" id="5480720">]</span><span class="op" id="5480721">[</span><span class="num" id="5480722">2</span><span class="op" id="5480723">]</span>&nbsp;<span class="op" id="5480725">=</span>&nbsp;<span class="builtintype" id="5480727">int32</span><span class="op" id="5480732">(</span><span class="ident" id="5480733">b</span><span class="op" id="5480734">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5480742">pix</span><span class="op" id="5480745">,</span>&nbsp;<span class="ident" id="5480747">stride</span>&nbsp;<span class="op" id="5480754">=</span>&nbsp;<span class="ident" id="5480756">p</span><span class="op" id="5480757">.</span><span class="ident" id="5480758">Pix</span><span class="op" id="5480761">[</span><span class="ident" id="5480762">p</span><span class="op" id="5480763">.</span><span class="ident" id="5480764">PixOffset</span><span class="op" id="5480773">(</span><span class="ident" id="5480774">r</span><span class="op" id="5480775">.</span><span class="ident" id="5480776">Min</span><span class="op" id="5480779">.</span><span class="ident" id="5480780">X</span><span class="op" id="5480781">,</span>&nbsp;<span class="ident" id="5480783">r</span><span class="op" id="5480784">.</span><span class="ident" id="5480785">Min</span><span class="op" id="5480788">.</span><span class="ident" id="5480789">Y</span><span class="op" id="5480790">)</span><span class="op" id="5480791">:</span><span class="op" id="5480792">]</span><span class="op" id="5480793">,</span>&nbsp;<span class="ident" id="5480795">p</span><span class="op" id="5480796">.</span><span class="ident" id="5480797">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5480805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480809">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480884">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5480959">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481015">var</span>&nbsp;<span class="ident" id="5481019">quantErrorCurr</span><span class="op" id="5481033">,</span>&nbsp;<span class="ident" id="5481035">quantErrorNext</span>&nbsp;<span class="op" id="5481050">[</span><span class="op" id="5481051">]</span><span class="op" id="5481052">[</span><span class="num" id="5481053">3</span><span class="op" id="5481054">]</span><span class="builtintype" id="5481055">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481062">if</span>&nbsp;<span class="ident" id="5481065">floydSteinberg</span>&nbsp;<span class="op" id="5481080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481084">quantErrorCurr</span>&nbsp;<span class="op" id="5481099">=</span>&nbsp;<span class="builtinfunc" id="5481101">make</span><span class="op" id="5481105">(</span><span class="op" id="5481106">[</span><span class="op" id="5481107">]</span><span class="op" id="5481108">[</span><span class="num" id="5481109">3</span><span class="op" id="5481110">]</span><span class="builtintype" id="5481111">int32</span><span class="op" id="5481116">,</span>&nbsp;<span class="ident" id="5481118">r</span><span class="op" id="5481119">.</span><span class="ident" id="5481120">Dx</span><span class="op" id="5481122">(</span><span class="op" id="5481123">)</span><span class="op" id="5481124">+</span><span class="num" id="5481125">2</span><span class="op" id="5481126">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481130">quantErrorNext</span>&nbsp;<span class="op" id="5481145">=</span>&nbsp;<span class="builtinfunc" id="5481147">make</span><span class="op" id="5481151">(</span><span class="op" id="5481152">[</span><span class="op" id="5481153">]</span><span class="op" id="5481154">[</span><span class="num" id="5481155">3</span><span class="op" id="5481156">]</span><span class="builtintype" id="5481157">int32</span><span class="op" id="5481162">,</span>&nbsp;<span class="ident" id="5481164">r</span><span class="op" id="5481165">.</span><span class="ident" id="5481166">Dx</span><span class="op" id="5481168">(</span><span class="op" id="5481169">)</span><span class="op" id="5481170">+</span><span class="num" id="5481171">2</span><span class="op" id="5481172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481179">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481212">out</span>&nbsp;<span class="op" id="5481216">:=</span>&nbsp;<span class="ident" id="5481219">color</span><span class="op" id="5481224">.</span><span class="ident" id="5481225">RGBA64</span><span class="op" id="5481231">{</span><span class="ident" id="5481232">A</span><span class="op" id="5481233">:</span>&nbsp;<span class="num" id="5481235">0xffff</span><span class="op" id="5481241">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481244">for</span>&nbsp;<span class="ident" id="5481248">y</span>&nbsp;<span class="op" id="5481250">:=</span>&nbsp;<span class="num" id="5481253">0</span><span class="op" id="5481254">;</span>&nbsp;<span class="ident" id="5481256">y</span>&nbsp;<span class="op" id="5481258">!=</span>&nbsp;<span class="ident" id="5481261">r</span><span class="op" id="5481262">.</span><span class="ident" id="5481263">Dy</span><span class="op" id="5481265">(</span><span class="op" id="5481266">)</span><span class="op" id="5481267">;</span>&nbsp;<span class="ident" id="5481269">y</span><span class="op" id="5481270">++</span>&nbsp;<span class="op" id="5481273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481277">for</span>&nbsp;<span class="ident" id="5481281">x</span>&nbsp;<span class="op" id="5481283">:=</span>&nbsp;<span class="num" id="5481286">0</span><span class="op" id="5481287">;</span>&nbsp;<span class="ident" id="5481289">x</span>&nbsp;<span class="op" id="5481291">!=</span>&nbsp;<span class="ident" id="5481294">r</span><span class="op" id="5481295">.</span><span class="ident" id="5481296">Dx</span><span class="op" id="5481298">(</span><span class="op" id="5481299">)</span><span class="op" id="5481300">;</span>&nbsp;<span class="ident" id="5481302">x</span><span class="op" id="5481303">++</span>&nbsp;<span class="op" id="5481306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481311">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481369">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481407">sr</span><span class="op" id="5481409">,</span>&nbsp;<span class="ident" id="5481411">sg</span><span class="op" id="5481413">,</span>&nbsp;<span class="ident" id="5481415">sb</span><span class="op" id="5481417">,</span>&nbsp;<span class="ident" id="5481419">_</span>&nbsp;<span class="op" id="5481421">:=</span>&nbsp;<span class="ident" id="5481424">src</span><span class="op" id="5481427">.</span><span class="ident" id="5481428">At</span><span class="op" id="5481430">(</span><span class="ident" id="5481431">sp</span><span class="op" id="5481433">.</span><span class="ident" id="5481434">X</span><span class="op" id="5481435">+</span><span class="ident" id="5481436">x</span><span class="op" id="5481437">,</span>&nbsp;<span class="ident" id="5481439">sp</span><span class="op" id="5481441">.</span><span class="ident" id="5481442">Y</span><span class="op" id="5481443">+</span><span class="ident" id="5481444">y</span><span class="op" id="5481445">)</span><span class="op" id="5481446">.</span><span class="ident" id="5481447">RGBA</span><span class="op" id="5481451">(</span><span class="op" id="5481452">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481457">er</span><span class="op" id="5481459">,</span>&nbsp;<span class="ident" id="5481461">eg</span><span class="op" id="5481463">,</span>&nbsp;<span class="ident" id="5481465">eb</span>&nbsp;<span class="op" id="5481468">:=</span>&nbsp;<span class="builtintype" id="5481471">int32</span><span class="op" id="5481476">(</span><span class="ident" id="5481477">sr</span><span class="op" id="5481479">)</span><span class="op" id="5481480">,</span>&nbsp;<span class="builtintype" id="5481482">int32</span><span class="op" id="5481487">(</span><span class="ident" id="5481488">sg</span><span class="op" id="5481490">)</span><span class="op" id="5481491">,</span>&nbsp;<span class="builtintype" id="5481493">int32</span><span class="op" id="5481498">(</span><span class="ident" id="5481499">sb</span><span class="op" id="5481501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481506">if</span>&nbsp;<span class="ident" id="5481509">floydSteinberg</span>&nbsp;<span class="op" id="5481524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481530">er</span>&nbsp;<span class="op" id="5481533">=</span>&nbsp;<span class="ident" id="5481535">clamp</span><span class="op" id="5481540">(</span><span class="ident" id="5481541">er</span>&nbsp;<span class="op" id="5481544">+</span>&nbsp;<span class="ident" id="5481546">quantErrorCurr</span><span class="op" id="5481560">[</span><span class="ident" id="5481561">x</span><span class="op" id="5481562">+</span><span class="num" id="5481563">1</span><span class="op" id="5481564">]</span><span class="op" id="5481565">[</span><span class="num" id="5481566">0</span><span class="op" id="5481567">]</span><span class="op" id="5481568">/</span><span class="num" id="5481569">16</span><span class="op" id="5481571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481577">eg</span>&nbsp;<span class="op" id="5481580">=</span>&nbsp;<span class="ident" id="5481582">clamp</span><span class="op" id="5481587">(</span><span class="ident" id="5481588">eg</span>&nbsp;<span class="op" id="5481591">+</span>&nbsp;<span class="ident" id="5481593">quantErrorCurr</span><span class="op" id="5481607">[</span><span class="ident" id="5481608">x</span><span class="op" id="5481609">+</span><span class="num" id="5481610">1</span><span class="op" id="5481611">]</span><span class="op" id="5481612">[</span><span class="num" id="5481613">1</span><span class="op" id="5481614">]</span><span class="op" id="5481615">/</span><span class="num" id="5481616">16</span><span class="op" id="5481618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481624">eb</span>&nbsp;<span class="op" id="5481627">=</span>&nbsp;<span class="ident" id="5481629">clamp</span><span class="op" id="5481634">(</span><span class="ident" id="5481635">eb</span>&nbsp;<span class="op" id="5481638">+</span>&nbsp;<span class="ident" id="5481640">quantErrorCurr</span><span class="op" id="5481654">[</span><span class="ident" id="5481655">x</span><span class="op" id="5481656">+</span><span class="num" id="5481657">1</span><span class="op" id="5481658">]</span><span class="op" id="5481659">[</span><span class="num" id="5481660">2</span><span class="op" id="5481661">]</span><span class="op" id="5481662">/</span><span class="num" id="5481663">16</span><span class="op" id="5481665">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5481670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5481676">if</span>&nbsp;<span class="ident" id="5481679">palette</span>&nbsp;<span class="op" id="5481687">!=</span>&nbsp;<span class="ident" id="5481690">nil</span>&nbsp;<span class="op" id="5481694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481700">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481768">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481836">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5481905">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5481957">bestIndex</span><span class="op" id="5481966">,</span>&nbsp;<span class="ident" id="5481968">bestSSD</span>&nbsp;<span class="op" id="5481976">:=</span>&nbsp;<span class="num" id="5481979">0</span><span class="op" id="5481980">,</span>&nbsp;<span class="builtintype" id="5481982">uint32</span><span class="op" id="5481988">(</span><span class="num" id="5481989">1</span><span class="op" id="5481990">&lt;&lt;</span><span class="num" id="5481992">32</span><span class="op" id="5481994">-</span><span class="num" id="5481995">1</span><span class="op" id="5481996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482002">for</span>&nbsp;<span class="ident" id="5482006">index</span><span class="op" id="5482011">,</span>&nbsp;<span class="ident" id="5482013">p</span>&nbsp;<span class="op" id="5482015">:=</span>&nbsp;<span class="keyword" id="5482018">range</span>&nbsp;<span class="ident" id="5482024">palette</span>&nbsp;<span class="op" id="5482032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482039">delta</span>&nbsp;<span class="op" id="5482045">:=</span>&nbsp;<span class="op" id="5482048">(</span><span class="ident" id="5482049">er</span>&nbsp;<span class="op" id="5482052">-</span>&nbsp;<span class="ident" id="5482054">p</span><span class="op" id="5482055">[</span><span class="num" id="5482056">0</span><span class="op" id="5482057">]</span><span class="op" id="5482058">)</span>&nbsp;<span class="op" id="5482060">&gt;&gt;</span>&nbsp;<span class="num" id="5482063">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482070">ssd</span>&nbsp;<span class="op" id="5482074">:=</span>&nbsp;<span class="builtintype" id="5482077">uint32</span><span class="op" id="5482083">(</span><span class="ident" id="5482084">delta</span>&nbsp;<span class="op" id="5482090">*</span>&nbsp;<span class="ident" id="5482092">delta</span><span class="op" id="5482097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482104">delta</span>&nbsp;<span class="op" id="5482110">=</span>&nbsp;<span class="op" id="5482112">(</span><span class="ident" id="5482113">eg</span>&nbsp;<span class="op" id="5482116">-</span>&nbsp;<span class="ident" id="5482118">p</span><span class="op" id="5482119">[</span><span class="num" id="5482120">1</span><span class="op" id="5482121">]</span><span class="op" id="5482122">)</span>&nbsp;<span class="op" id="5482124">&gt;&gt;</span>&nbsp;<span class="num" id="5482127">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482134">ssd</span>&nbsp;<span class="op" id="5482138">+=</span>&nbsp;<span class="builtintype" id="5482141">uint32</span><span class="op" id="5482147">(</span><span class="ident" id="5482148">delta</span>&nbsp;<span class="op" id="5482154">*</span>&nbsp;<span class="ident" id="5482156">delta</span><span class="op" id="5482161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482168">delta</span>&nbsp;<span class="op" id="5482174">=</span>&nbsp;<span class="op" id="5482176">(</span><span class="ident" id="5482177">eb</span>&nbsp;<span class="op" id="5482180">-</span>&nbsp;<span class="ident" id="5482182">p</span><span class="op" id="5482183">[</span><span class="num" id="5482184">2</span><span class="op" id="5482185">]</span><span class="op" id="5482186">)</span>&nbsp;<span class="op" id="5482188">&gt;&gt;</span>&nbsp;<span class="num" id="5482191">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482198">ssd</span>&nbsp;<span class="op" id="5482202">+=</span>&nbsp;<span class="builtintype" id="5482205">uint32</span><span class="op" id="5482211">(</span><span class="ident" id="5482212">delta</span>&nbsp;<span class="op" id="5482218">*</span>&nbsp;<span class="ident" id="5482220">delta</span><span class="op" id="5482225">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482232">if</span>&nbsp;<span class="ident" id="5482235">ssd</span>&nbsp;<span class="op" id="5482239">&lt;</span>&nbsp;<span class="ident" id="5482241">bestSSD</span>&nbsp;<span class="op" id="5482249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482257">bestIndex</span><span class="op" id="5482266">,</span>&nbsp;<span class="ident" id="5482268">bestSSD</span>&nbsp;<span class="op" id="5482276">=</span>&nbsp;<span class="ident" id="5482278">index</span><span class="op" id="5482283">,</span>&nbsp;<span class="ident" id="5482285">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482295">if</span>&nbsp;<span class="ident" id="5482298">ssd</span>&nbsp;<span class="op" id="5482302">==</span>&nbsp;<span class="num" id="5482305">0</span>&nbsp;<span class="op" id="5482307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482316">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482328">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482347">pix</span><span class="op" id="5482350">[</span><span class="ident" id="5482351">y</span><span class="op" id="5482352">*</span><span class="ident" id="5482353">stride</span><span class="op" id="5482359">+</span><span class="ident" id="5482360">x</span><span class="op" id="5482361">]</span>&nbsp;<span class="op" id="5482363">=</span>&nbsp;<span class="builtintype" id="5482365">byte</span><span class="op" id="5482369">(</span><span class="ident" id="5482370">bestIndex</span><span class="op" id="5482379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482386">if</span>&nbsp;<span class="op" id="5482389">!</span><span class="ident" id="5482390">floydSteinberg</span>&nbsp;<span class="op" id="5482405">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482412">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482431">er</span>&nbsp;<span class="op" id="5482434">-=</span>&nbsp;<span class="builtintype" id="5482437">int32</span><span class="op" id="5482442">(</span><span class="ident" id="5482443">palette</span><span class="op" id="5482450">[</span><span class="ident" id="5482451">bestIndex</span><span class="op" id="5482460">]</span><span class="op" id="5482461">[</span><span class="num" id="5482462">0</span><span class="op" id="5482463">]</span><span class="op" id="5482464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482470">eg</span>&nbsp;<span class="op" id="5482473">-=</span>&nbsp;<span class="builtintype" id="5482476">int32</span><span class="op" id="5482481">(</span><span class="ident" id="5482482">palette</span><span class="op" id="5482489">[</span><span class="ident" id="5482490">bestIndex</span><span class="op" id="5482499">]</span><span class="op" id="5482500">[</span><span class="num" id="5482501">1</span><span class="op" id="5482502">]</span><span class="op" id="5482503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482509">eb</span>&nbsp;<span class="op" id="5482512">-=</span>&nbsp;<span class="builtintype" id="5482515">int32</span><span class="op" id="5482520">(</span><span class="ident" id="5482521">palette</span><span class="op" id="5482528">[</span><span class="ident" id="5482529">bestIndex</span><span class="op" id="5482538">]</span><span class="op" id="5482539">[</span><span class="num" id="5482540">2</span><span class="op" id="5482541">]</span><span class="op" id="5482542">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482548">}</span>&nbsp;<span class="keyword" id="5482550">else</span>&nbsp;<span class="op" id="5482555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482561">out</span><span class="op" id="5482564">.</span><span class="ident" id="5482565">R</span>&nbsp;<span class="op" id="5482567">=</span>&nbsp;<span class="builtintype" id="5482569">uint16</span><span class="op" id="5482575">(</span><span class="ident" id="5482576">er</span><span class="op" id="5482578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482584">out</span><span class="op" id="5482587">.</span><span class="ident" id="5482588">G</span>&nbsp;<span class="op" id="5482590">=</span>&nbsp;<span class="builtintype" id="5482592">uint16</span><span class="op" id="5482598">(</span><span class="ident" id="5482599">eg</span><span class="op" id="5482601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482607">out</span><span class="op" id="5482610">.</span><span class="ident" id="5482611">B</span>&nbsp;<span class="op" id="5482613">=</span>&nbsp;<span class="builtintype" id="5482615">uint16</span><span class="op" id="5482621">(</span><span class="ident" id="5482622">eb</span><span class="op" id="5482624">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482630">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482691">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482756">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5482819">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482880">dst</span><span class="op" id="5482883">.</span><span class="ident" id="5482884">Set</span><span class="op" id="5482887">(</span><span class="ident" id="5482888">r</span><span class="op" id="5482889">.</span><span class="ident" id="5482890">Min</span><span class="op" id="5482893">.</span><span class="ident" id="5482894">X</span><span class="op" id="5482895">+</span><span class="ident" id="5482896">x</span><span class="op" id="5482897">,</span>&nbsp;<span class="ident" id="5482899">r</span><span class="op" id="5482900">.</span><span class="ident" id="5482901">Min</span><span class="op" id="5482904">.</span><span class="ident" id="5482905">Y</span><span class="op" id="5482906">+</span><span class="ident" id="5482907">y</span><span class="op" id="5482908">,</span>&nbsp;<span class="op" id="5482910">&amp;</span><span class="ident" id="5482911">out</span><span class="op" id="5482914">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482921">if</span>&nbsp;<span class="op" id="5482924">!</span><span class="ident" id="5482925">floydSteinberg</span>&nbsp;<span class="op" id="5482940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5482947">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5482960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5482966">sr</span><span class="op" id="5482968">,</span>&nbsp;<span class="ident" id="5482970">sg</span><span class="op" id="5482972">,</span>&nbsp;<span class="ident" id="5482974">sb</span><span class="op" id="5482976">,</span>&nbsp;<span class="ident" id="5482978">_</span>&nbsp;<span class="op" id="5482980">=</span>&nbsp;<span class="ident" id="5482982">dst</span><span class="op" id="5482985">.</span><span class="ident" id="5482986">At</span><span class="op" id="5482988">(</span><span class="ident" id="5482989">r</span><span class="op" id="5482990">.</span><span class="ident" id="5482991">Min</span><span class="op" id="5482994">.</span><span class="ident" id="5482995">X</span><span class="op" id="5482996">+</span><span class="ident" id="5482997">x</span><span class="op" id="5482998">,</span>&nbsp;<span class="ident" id="5483000">r</span><span class="op" id="5483001">.</span><span class="ident" id="5483002">Min</span><span class="op" id="5483005">.</span><span class="ident" id="5483006">Y</span><span class="op" id="5483007">+</span><span class="ident" id="5483008">y</span><span class="op" id="5483009">)</span><span class="op" id="5483010">.</span><span class="ident" id="5483011">RGBA</span><span class="op" id="5483015">(</span><span class="op" id="5483016">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483022">er</span>&nbsp;<span class="op" id="5483025">-=</span>&nbsp;<span class="builtintype" id="5483028">int32</span><span class="op" id="5483033">(</span><span class="ident" id="5483034">sr</span><span class="op" id="5483036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483042">eg</span>&nbsp;<span class="op" id="5483045">-=</span>&nbsp;<span class="builtintype" id="5483048">int32</span><span class="op" id="5483053">(</span><span class="ident" id="5483054">sg</span><span class="op" id="5483056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483062">eb</span>&nbsp;<span class="op" id="5483065">-=</span>&nbsp;<span class="builtintype" id="5483068">int32</span><span class="op" id="5483073">(</span><span class="ident" id="5483074">sb</span><span class="op" id="5483076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5483087">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483143">quantErrorNext</span><span class="op" id="5483157">[</span><span class="ident" id="5483158">x</span><span class="op" id="5483159">+</span><span class="num" id="5483160">0</span><span class="op" id="5483161">]</span><span class="op" id="5483162">[</span><span class="num" id="5483163">0</span><span class="op" id="5483164">]</span>&nbsp;<span class="op" id="5483166">+=</span>&nbsp;<span class="ident" id="5483169">er</span>&nbsp;<span class="op" id="5483172">*</span>&nbsp;<span class="num" id="5483174">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483179">quantErrorNext</span><span class="op" id="5483193">[</span><span class="ident" id="5483194">x</span><span class="op" id="5483195">+</span><span class="num" id="5483196">0</span><span class="op" id="5483197">]</span><span class="op" id="5483198">[</span><span class="num" id="5483199">1</span><span class="op" id="5483200">]</span>&nbsp;<span class="op" id="5483202">+=</span>&nbsp;<span class="ident" id="5483205">eg</span>&nbsp;<span class="op" id="5483208">*</span>&nbsp;<span class="num" id="5483210">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483215">quantErrorNext</span><span class="op" id="5483229">[</span><span class="ident" id="5483230">x</span><span class="op" id="5483231">+</span><span class="num" id="5483232">0</span><span class="op" id="5483233">]</span><span class="op" id="5483234">[</span><span class="num" id="5483235">2</span><span class="op" id="5483236">]</span>&nbsp;<span class="op" id="5483238">+=</span>&nbsp;<span class="ident" id="5483241">eb</span>&nbsp;<span class="op" id="5483244">*</span>&nbsp;<span class="num" id="5483246">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483251">quantErrorNext</span><span class="op" id="5483265">[</span><span class="ident" id="5483266">x</span><span class="op" id="5483267">+</span><span class="num" id="5483268">1</span><span class="op" id="5483269">]</span><span class="op" id="5483270">[</span><span class="num" id="5483271">0</span><span class="op" id="5483272">]</span>&nbsp;<span class="op" id="5483274">+=</span>&nbsp;<span class="ident" id="5483277">er</span>&nbsp;<span class="op" id="5483280">*</span>&nbsp;<span class="num" id="5483282">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483287">quantErrorNext</span><span class="op" id="5483301">[</span><span class="ident" id="5483302">x</span><span class="op" id="5483303">+</span><span class="num" id="5483304">1</span><span class="op" id="5483305">]</span><span class="op" id="5483306">[</span><span class="num" id="5483307">1</span><span class="op" id="5483308">]</span>&nbsp;<span class="op" id="5483310">+=</span>&nbsp;<span class="ident" id="5483313">eg</span>&nbsp;<span class="op" id="5483316">*</span>&nbsp;<span class="num" id="5483318">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483323">quantErrorNext</span><span class="op" id="5483337">[</span><span class="ident" id="5483338">x</span><span class="op" id="5483339">+</span><span class="num" id="5483340">1</span><span class="op" id="5483341">]</span><span class="op" id="5483342">[</span><span class="num" id="5483343">2</span><span class="op" id="5483344">]</span>&nbsp;<span class="op" id="5483346">+=</span>&nbsp;<span class="ident" id="5483349">eb</span>&nbsp;<span class="op" id="5483352">*</span>&nbsp;<span class="num" id="5483354">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483359">quantErrorNext</span><span class="op" id="5483373">[</span><span class="ident" id="5483374">x</span><span class="op" id="5483375">+</span><span class="num" id="5483376">2</span><span class="op" id="5483377">]</span><span class="op" id="5483378">[</span><span class="num" id="5483379">0</span><span class="op" id="5483380">]</span>&nbsp;<span class="op" id="5483382">+=</span>&nbsp;<span class="ident" id="5483385">er</span>&nbsp;<span class="op" id="5483388">*</span>&nbsp;<span class="num" id="5483390">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483395">quantErrorNext</span><span class="op" id="5483409">[</span><span class="ident" id="5483410">x</span><span class="op" id="5483411">+</span><span class="num" id="5483412">2</span><span class="op" id="5483413">]</span><span class="op" id="5483414">[</span><span class="num" id="5483415">1</span><span class="op" id="5483416">]</span>&nbsp;<span class="op" id="5483418">+=</span>&nbsp;<span class="ident" id="5483421">eg</span>&nbsp;<span class="op" id="5483424">*</span>&nbsp;<span class="num" id="5483426">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483431">quantErrorNext</span><span class="op" id="5483445">[</span><span class="ident" id="5483446">x</span><span class="op" id="5483447">+</span><span class="num" id="5483448">2</span><span class="op" id="5483449">]</span><span class="op" id="5483450">[</span><span class="num" id="5483451">2</span><span class="op" id="5483452">]</span>&nbsp;<span class="op" id="5483454">+=</span>&nbsp;<span class="ident" id="5483457">eb</span>&nbsp;<span class="op" id="5483460">*</span>&nbsp;<span class="num" id="5483462">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483467">quantErrorCurr</span><span class="op" id="5483481">[</span><span class="ident" id="5483482">x</span><span class="op" id="5483483">+</span><span class="num" id="5483484">2</span><span class="op" id="5483485">]</span><span class="op" id="5483486">[</span><span class="num" id="5483487">0</span><span class="op" id="5483488">]</span>&nbsp;<span class="op" id="5483490">+=</span>&nbsp;<span class="ident" id="5483493">er</span>&nbsp;<span class="op" id="5483496">*</span>&nbsp;<span class="num" id="5483498">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483503">quantErrorCurr</span><span class="op" id="5483517">[</span><span class="ident" id="5483518">x</span><span class="op" id="5483519">+</span><span class="num" id="5483520">2</span><span class="op" id="5483521">]</span><span class="op" id="5483522">[</span><span class="num" id="5483523">1</span><span class="op" id="5483524">]</span>&nbsp;<span class="op" id="5483526">+=</span>&nbsp;<span class="ident" id="5483529">eg</span>&nbsp;<span class="op" id="5483532">*</span>&nbsp;<span class="num" id="5483534">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483539">quantErrorCurr</span><span class="op" id="5483553">[</span><span class="ident" id="5483554">x</span><span class="op" id="5483555">+</span><span class="num" id="5483556">2</span><span class="op" id="5483557">]</span><span class="op" id="5483558">[</span><span class="num" id="5483559">2</span><span class="op" id="5483560">]</span>&nbsp;<span class="op" id="5483562">+=</span>&nbsp;<span class="ident" id="5483565">eb</span>&nbsp;<span class="op" id="5483568">*</span>&nbsp;<span class="num" id="5483570">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5483579">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483624">if</span>&nbsp;<span class="ident" id="5483627">floydSteinberg</span>&nbsp;<span class="op" id="5483642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483647">quantErrorCurr</span><span class="op" id="5483661">,</span>&nbsp;<span class="ident" id="5483663">quantErrorNext</span>&nbsp;<span class="op" id="5483678">=</span>&nbsp;<span class="ident" id="5483680">quantErrorNext</span><span class="op" id="5483694">,</span>&nbsp;<span class="ident" id="5483696">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5483714">for</span>&nbsp;<span class="ident" id="5483718">i</span>&nbsp;<span class="op" id="5483720">:=</span>&nbsp;<span class="keyword" id="5483723">range</span>&nbsp;<span class="ident" id="5483729">quantErrorNext</span>&nbsp;<span class="op" id="5483744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5483750">quantErrorNext</span><span class="op" id="5483764">[</span><span class="ident" id="5483765">i</span><span class="op" id="5483766">]</span>&nbsp;<span class="op" id="5483768">=</span>&nbsp;<span class="op" id="5483770">[</span><span class="num" id="5483771">3</span><span class="op" id="5483772">]</span><span class="builtintype" id="5483773">int32</span><span class="op" id="5483778">{</span><span class="op" id="5483779">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5483791">}</span><br>
<span class="lineno"></span><span class="op" id="5483793">}</span>
</div>
</body>
</html>
