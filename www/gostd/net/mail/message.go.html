<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5605437">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5605492">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5605546">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5605597">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5606004">package</span>&nbsp;<span class="ident" id="5606012">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5606018">import</span>&nbsp;<span class="op" id="5606025">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606028">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606037">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606046">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606065">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606075">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606082">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606088">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606101">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606108">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606125">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606136">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606147">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5606155">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5606165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5606168">var</span>&nbsp;<span class="ident" id="5606172">debug</span>&nbsp;<span class="op" id="5606178">=</span>&nbsp;<span class="ident" id="5606180">debugT</span><span class="op" id="5606186">(</span><span class="builtintype" id="5606187">false</span><span class="op" id="5606192">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="5606195">type</span>&nbsp;<span class="ident" id="5606200">debugT</span>&nbsp;<span class="builtintype" id="5606207">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5606213">func</span>&nbsp;<span class="op" id="5606218">(</span><span class="ident" id="5606219">d</span>&nbsp;<span class="ident" id="5606221">debugT</span><span class="op" id="5606227">)</span>&nbsp;<span class="ident" id="5606229">Printf</span><span class="op" id="5606235">(</span><span class="ident" id="5606236">format</span>&nbsp;<span class="builtintype" id="5606243">string</span><span class="op" id="5606249">,</span>&nbsp;<span class="ident" id="5606251">args</span>&nbsp;<span class="op" id="5606256">...</span><span class="keyword" id="5606259">interface</span><span class="op" id="5606268">{</span><span class="op" id="5606269">}</span><span class="op" id="5606270">)</span>&nbsp;<span class="op" id="5606272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606275">if</span>&nbsp;<span class="ident" id="5606278">d</span>&nbsp;<span class="op" id="5606280">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606284">log</span><span class="op" id="5606287">.</span><span class="ident" id="5606288">Printf</span><span class="op" id="5606294">(</span><span class="ident" id="5606295">format</span><span class="op" id="5606301">,</span>&nbsp;<span class="ident" id="5606303">args</span><span class="op" id="5606307">...</span><span class="op" id="5606310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606313">}</span><br>
<span class="lineno"></span><span class="op" id="5606315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5606318">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="5606365">type</span>&nbsp;<span class="ident" id="5606370">Message</span>&nbsp;<span class="keyword" id="5606378">struct</span>&nbsp;<span class="op" id="5606385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606388">Header</span>&nbsp;<span class="ident" id="5606395">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606403">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5606410">io</span><span class="op" id="5606412">.</span><span class="ident" id="5606413">Reader</span><br>
<span class="lineno"></span><span class="op" id="5606420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5606423">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5606462">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="5606535">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5606558">func</span>&nbsp;<span class="ident" id="5606563">ReadMessage</span><span class="op" id="5606574">(</span><span class="ident" id="5606575">r</span>&nbsp;<span class="ident" id="5606577">io</span><span class="op" id="5606579">.</span><span class="ident" id="5606580">Reader</span><span class="op" id="5606586">)</span>&nbsp;<span class="op" id="5606588">(</span><span class="ident" id="5606589">msg</span>&nbsp;<span class="op" id="5606593">*</span><span class="ident" id="5606594">Message</span><span class="op" id="5606601">,</span>&nbsp;<span class="ident" id="5606603">err</span>&nbsp;<span class="builtintype" id="5606607">error</span><span class="op" id="5606612">)</span>&nbsp;<span class="op" id="5606614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606617">tp</span>&nbsp;<span class="op" id="5606620">:=</span>&nbsp;<span class="ident" id="5606623">textproto</span><span class="op" id="5606632">.</span><span class="ident" id="5606633">NewReader</span><span class="op" id="5606642">(</span><span class="ident" id="5606643">bufio</span><span class="op" id="5606648">.</span><span class="ident" id="5606649">NewReader</span><span class="op" id="5606658">(</span><span class="ident" id="5606659">r</span><span class="op" id="5606660">)</span><span class="op" id="5606661">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606665">hdr</span><span class="op" id="5606668">,</span>&nbsp;<span class="ident" id="5606670">err</span>&nbsp;<span class="op" id="5606674">:=</span>&nbsp;<span class="ident" id="5606677">tp</span><span class="op" id="5606679">.</span><span class="ident" id="5606680">ReadMIMEHeader</span><span class="op" id="5606694">(</span><span class="op" id="5606695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606698">if</span>&nbsp;<span class="ident" id="5606701">err</span>&nbsp;<span class="op" id="5606705">!=</span>&nbsp;<span class="ident" id="5606708">nil</span>&nbsp;<span class="op" id="5606712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606716">return</span>&nbsp;<span class="ident" id="5606723">nil</span><span class="op" id="5606726">,</span>&nbsp;<span class="ident" id="5606728">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606733">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5606737">return</span>&nbsp;<span class="op" id="5606744">&amp;</span><span class="ident" id="5606745">Message</span><span class="op" id="5606752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606756">Header</span><span class="op" id="5606762">:</span>&nbsp;<span class="ident" id="5606764">Header</span><span class="op" id="5606770">(</span><span class="ident" id="5606771">hdr</span><span class="op" id="5606774">)</span><span class="op" id="5606775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606779">Body</span><span class="op" id="5606783">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5606787">tp</span><span class="op" id="5606789">.</span><span class="ident" id="5606790">R</span><span class="op" id="5606791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5606794">}</span><span class="op" id="5606795">,</span>&nbsp;<span class="ident" id="5606797">nil</span><br>
<span class="lineno">65</span><span class="op" id="5606801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5606804">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="5606851">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="5606880">var</span>&nbsp;<span class="ident" id="5606884">dateLayouts</span>&nbsp;<span class="op" id="5606896">[</span><span class="op" id="5606897">]</span><span class="builtintype" id="5606898">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5606906">func</span>&nbsp;<span class="ident" id="5606911">init</span><span class="op" id="5606915">(</span><span class="op" id="5606916">)</span>&nbsp;<span class="op" id="5606918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5606921">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5606975">dows</span>&nbsp;<span class="op" id="5606980">:=</span>&nbsp;<span class="op" id="5606983">[</span><span class="op" id="5606984">...</span><span class="op" id="5606987">]</span><span class="builtintype" id="5606988">string</span><span class="op" id="5606994">{</span><span class="string" id="5606995">&#34;&#34;</span><span class="op" id="5606997">,</span>&nbsp;<span class="string" id="5606999">&#34;Mon,&nbsp;&#34;</span><span class="op" id="5607006">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5607010">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607026">days</span>&nbsp;<span class="op" id="5607031">:=</span>&nbsp;<span class="op" id="5607034">[</span><span class="op" id="5607035">...</span><span class="op" id="5607038">]</span><span class="builtintype" id="5607039">string</span><span class="op" id="5607045">{</span><span class="string" id="5607046">&#34;2&#34;</span><span class="op" id="5607049">,</span>&nbsp;<span class="string" id="5607051">&#34;02&#34;</span><span class="op" id="5607055">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5607061">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607080">years</span>&nbsp;<span class="op" id="5607086">:=</span>&nbsp;<span class="op" id="5607089">[</span><span class="op" id="5607090">...</span><span class="op" id="5607093">]</span><span class="builtintype" id="5607094">string</span><span class="op" id="5607100">{</span><span class="string" id="5607101">&#34;2006&#34;</span><span class="op" id="5607107">,</span>&nbsp;<span class="string" id="5607109">&#34;06&#34;</span><span class="op" id="5607113">}</span>&nbsp;<span class="comment" id="5607115">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607144">seconds</span>&nbsp;<span class="op" id="5607152">:=</span>&nbsp;<span class="op" id="5607155">[</span><span class="op" id="5607156">...</span><span class="op" id="5607159">]</span><span class="builtintype" id="5607160">string</span><span class="op" id="5607166">{</span><span class="string" id="5607167">&#34;:05&#34;</span><span class="op" id="5607172">,</span>&nbsp;<span class="string" id="5607174">&#34;&#34;</span><span class="op" id="5607176">}</span>&nbsp;&nbsp;<span class="comment" id="5607179">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5607190">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607243">zones</span>&nbsp;<span class="op" id="5607249">:=</span>&nbsp;<span class="op" id="5607252">[</span><span class="op" id="5607253">...</span><span class="op" id="5607256">]</span><span class="builtintype" id="5607257">string</span><span class="op" id="5607263">{</span><span class="string" id="5607264">&#34;-0700&#34;</span><span class="op" id="5607271">,</span>&nbsp;<span class="string" id="5607273">&#34;MST&#34;</span><span class="op" id="5607278">,</span>&nbsp;<span class="string" id="5607280">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="5607293">}</span>&nbsp;<span class="comment" id="5607295">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607342">for</span>&nbsp;<span class="ident" id="5607346">_</span><span class="op" id="5607347">,</span>&nbsp;<span class="ident" id="5607349">dow</span>&nbsp;<span class="op" id="5607353">:=</span>&nbsp;<span class="keyword" id="5607356">range</span>&nbsp;<span class="ident" id="5607362">dows</span>&nbsp;<span class="op" id="5607367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607371">for</span>&nbsp;<span class="ident" id="5607375">_</span><span class="op" id="5607376">,</span>&nbsp;<span class="ident" id="5607378">day</span>&nbsp;<span class="op" id="5607382">:=</span>&nbsp;<span class="keyword" id="5607385">range</span>&nbsp;<span class="ident" id="5607391">days</span>&nbsp;<span class="op" id="5607396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607401">for</span>&nbsp;<span class="ident" id="5607405">_</span><span class="op" id="5607406">,</span>&nbsp;<span class="ident" id="5607408">year</span>&nbsp;<span class="op" id="5607413">:=</span>&nbsp;<span class="keyword" id="5607416">range</span>&nbsp;<span class="ident" id="5607422">years</span>&nbsp;<span class="op" id="5607428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607434">for</span>&nbsp;<span class="ident" id="5607438">_</span><span class="op" id="5607439">,</span>&nbsp;<span class="ident" id="5607441">second</span>&nbsp;<span class="op" id="5607448">:=</span>&nbsp;<span class="keyword" id="5607451">range</span>&nbsp;<span class="ident" id="5607457">seconds</span>&nbsp;<span class="op" id="5607465">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607472">for</span>&nbsp;<span class="ident" id="5607476">_</span><span class="op" id="5607477">,</span>&nbsp;<span class="ident" id="5607479">zone</span>&nbsp;<span class="op" id="5607484">:=</span>&nbsp;<span class="keyword" id="5607487">range</span>&nbsp;<span class="ident" id="5607493">zones</span>&nbsp;<span class="op" id="5607499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607507">s</span>&nbsp;<span class="op" id="5607509">:=</span>&nbsp;<span class="ident" id="5607512">dow</span>&nbsp;<span class="op" id="5607516">+</span>&nbsp;<span class="ident" id="5607518">day</span>&nbsp;<span class="op" id="5607522">+</span>&nbsp;<span class="string" id="5607524">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="5607532">+</span>&nbsp;<span class="ident" id="5607534">year</span>&nbsp;<span class="op" id="5607539">+</span>&nbsp;<span class="string" id="5607541">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="5607550">+</span>&nbsp;<span class="ident" id="5607552">second</span>&nbsp;<span class="op" id="5607559">+</span>&nbsp;<span class="string" id="5607561">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5607565">+</span>&nbsp;<span class="ident" id="5607567">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607578">dateLayouts</span>&nbsp;<span class="op" id="5607590">=</span>&nbsp;<span class="builtinfunc" id="5607592">append</span><span class="op" id="5607598">(</span><span class="ident" id="5607599">dateLayouts</span><span class="op" id="5607610">,</span>&nbsp;<span class="ident" id="5607612">s</span><span class="op" id="5607613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607626">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607631">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607638">}</span><br>
<span class="lineno"></span><span class="op" id="5607640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="5607643">func</span>&nbsp;<span class="ident" id="5607648">parseDate</span><span class="op" id="5607657">(</span><span class="ident" id="5607658">date</span>&nbsp;<span class="builtintype" id="5607663">string</span><span class="op" id="5607669">)</span>&nbsp;<span class="op" id="5607671">(</span><span class="ident" id="5607672">time</span><span class="op" id="5607676">.</span><span class="ident" id="5607677">Time</span><span class="op" id="5607681">,</span>&nbsp;<span class="builtintype" id="5607683">error</span><span class="op" id="5607688">)</span>&nbsp;<span class="op" id="5607690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607693">for</span>&nbsp;<span class="ident" id="5607697">_</span><span class="op" id="5607698">,</span>&nbsp;<span class="ident" id="5607700">layout</span>&nbsp;<span class="op" id="5607707">:=</span>&nbsp;<span class="keyword" id="5607710">range</span>&nbsp;<span class="ident" id="5607716">dateLayouts</span>&nbsp;<span class="op" id="5607728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5607732">t</span><span class="op" id="5607733">,</span>&nbsp;<span class="ident" id="5607735">err</span>&nbsp;<span class="op" id="5607739">:=</span>&nbsp;<span class="ident" id="5607742">time</span><span class="op" id="5607746">.</span><span class="ident" id="5607747">Parse</span><span class="op" id="5607752">(</span><span class="ident" id="5607753">layout</span><span class="op" id="5607759">,</span>&nbsp;<span class="ident" id="5607761">date</span><span class="op" id="5607765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607769">if</span>&nbsp;<span class="ident" id="5607772">err</span>&nbsp;<span class="op" id="5607776">==</span>&nbsp;<span class="ident" id="5607779">nil</span>&nbsp;<span class="op" id="5607783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607788">return</span>&nbsp;<span class="ident" id="5607795">t</span><span class="op" id="5607796">,</span>&nbsp;<span class="ident" id="5607798">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5607807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5607810">return</span>&nbsp;<span class="ident" id="5607817">time</span><span class="op" id="5607821">.</span><span class="ident" id="5607822">Time</span><span class="op" id="5607826">{</span><span class="op" id="5607827">}</span><span class="op" id="5607828">,</span>&nbsp;<span class="ident" id="5607830">errors</span><span class="op" id="5607836">.</span><span class="ident" id="5607837">New</span><span class="op" id="5607840">(</span><span class="string" id="5607841">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="5607875">)</span><br>
<span class="lineno"></span><span class="op" id="5607877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5607880">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5607949">type</span>&nbsp;<span class="ident" id="5607954">Header</span>&nbsp;<span class="keyword" id="5607961">map</span><span class="op" id="5607964">[</span><span class="builtintype" id="5607965">string</span><span class="op" id="5607971">]</span><span class="op" id="5607972">[</span><span class="op" id="5607973">]</span><span class="builtintype" id="5607974">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5607982">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="5608041">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="5608108">func</span>&nbsp;<span class="op" id="5608113">(</span><span class="ident" id="5608114">h</span>&nbsp;<span class="ident" id="5608116">Header</span><span class="op" id="5608122">)</span>&nbsp;<span class="ident" id="5608124">Get</span><span class="op" id="5608127">(</span><span class="ident" id="5608128">key</span>&nbsp;<span class="builtintype" id="5608132">string</span><span class="op" id="5608138">)</span>&nbsp;<span class="builtintype" id="5608140">string</span>&nbsp;<span class="op" id="5608147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608150">return</span>&nbsp;<span class="ident" id="5608157">textproto</span><span class="op" id="5608166">.</span><span class="ident" id="5608167">MIMEHeader</span><span class="op" id="5608177">(</span><span class="ident" id="5608178">h</span><span class="op" id="5608179">)</span><span class="op" id="5608180">.</span><span class="ident" id="5608181">Get</span><span class="op" id="5608184">(</span><span class="ident" id="5608185">key</span><span class="op" id="5608188">)</span><br>
<span class="lineno"></span><span class="op" id="5608190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5608193">var</span>&nbsp;<span class="ident" id="5608197">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="5608217">=</span>&nbsp;<span class="ident" id="5608219">errors</span><span class="op" id="5608225">.</span><span class="ident" id="5608226">New</span><span class="op" id="5608229">(</span><span class="string" id="5608230">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="5608259">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5608262">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="5608300">func</span>&nbsp;<span class="op" id="5608305">(</span><span class="ident" id="5608306">h</span>&nbsp;<span class="ident" id="5608308">Header</span><span class="op" id="5608314">)</span>&nbsp;<span class="ident" id="5608316">Date</span><span class="op" id="5608320">(</span><span class="op" id="5608321">)</span>&nbsp;<span class="op" id="5608323">(</span><span class="ident" id="5608324">time</span><span class="op" id="5608328">.</span><span class="ident" id="5608329">Time</span><span class="op" id="5608333">,</span>&nbsp;<span class="builtintype" id="5608335">error</span><span class="op" id="5608340">)</span>&nbsp;<span class="op" id="5608342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608345">hdr</span>&nbsp;<span class="op" id="5608349">:=</span>&nbsp;<span class="ident" id="5608352">h</span><span class="op" id="5608353">.</span><span class="ident" id="5608354">Get</span><span class="op" id="5608357">(</span><span class="string" id="5608358">&#34;Date&#34;</span><span class="op" id="5608364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608367">if</span>&nbsp;<span class="ident" id="5608370">hdr</span>&nbsp;<span class="op" id="5608374">==</span>&nbsp;<span class="string" id="5608377">&#34;&#34;</span>&nbsp;<span class="op" id="5608380">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608384">return</span>&nbsp;<span class="ident" id="5608391">time</span><span class="op" id="5608395">.</span><span class="ident" id="5608396">Time</span><span class="op" id="5608400">{</span><span class="op" id="5608401">}</span><span class="op" id="5608402">,</span>&nbsp;<span class="ident" id="5608404">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608428">return</span>&nbsp;<span class="ident" id="5608435">parseDate</span><span class="op" id="5608444">(</span><span class="ident" id="5608445">hdr</span><span class="op" id="5608448">)</span><br>
<span class="lineno"></span><span class="op" id="5608450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5608453">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5608522">func</span>&nbsp;<span class="op" id="5608527">(</span><span class="ident" id="5608528">h</span>&nbsp;<span class="ident" id="5608530">Header</span><span class="op" id="5608536">)</span>&nbsp;<span class="ident" id="5608538">AddressList</span><span class="op" id="5608549">(</span><span class="ident" id="5608550">key</span>&nbsp;<span class="builtintype" id="5608554">string</span><span class="op" id="5608560">)</span>&nbsp;<span class="op" id="5608562">(</span><span class="op" id="5608563">[</span><span class="op" id="5608564">]</span><span class="op" id="5608565">*</span><span class="ident" id="5608566">Address</span><span class="op" id="5608573">,</span>&nbsp;<span class="builtintype" id="5608575">error</span><span class="op" id="5608580">)</span>&nbsp;<span class="op" id="5608582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608585">hdr</span>&nbsp;<span class="op" id="5608589">:=</span>&nbsp;<span class="ident" id="5608592">h</span><span class="op" id="5608593">.</span><span class="ident" id="5608594">Get</span><span class="op" id="5608597">(</span><span class="ident" id="5608598">key</span><span class="op" id="5608601">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608604">if</span>&nbsp;<span class="ident" id="5608607">hdr</span>&nbsp;<span class="op" id="5608611">==</span>&nbsp;<span class="string" id="5608614">&#34;&#34;</span>&nbsp;<span class="op" id="5608617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608621">return</span>&nbsp;<span class="ident" id="5608628">nil</span><span class="op" id="5608631">,</span>&nbsp;<span class="ident" id="5608633">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5608654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5608657">return</span>&nbsp;<span class="ident" id="5608664">ParseAddressList</span><span class="op" id="5608680">(</span><span class="ident" id="5608681">hdr</span><span class="op" id="5608684">)</span><br>
<span class="lineno"></span><span class="op" id="5608686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5608689">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="5608734">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="5608802">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="5608865">type</span>&nbsp;<span class="ident" id="5608870">Address</span>&nbsp;<span class="keyword" id="5608878">struct</span>&nbsp;<span class="op" id="5608885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608888">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5608896">string</span>&nbsp;<span class="comment" id="5608903">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5608934">Address</span>&nbsp;<span class="builtintype" id="5608942">string</span>&nbsp;<span class="comment" id="5608949">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="5608964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5608967">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5609040">func</span>&nbsp;<span class="ident" id="5609045">ParseAddress</span><span class="op" id="5609057">(</span><span class="ident" id="5609058">address</span>&nbsp;<span class="builtintype" id="5609066">string</span><span class="op" id="5609072">)</span>&nbsp;<span class="op" id="5609074">(</span><span class="op" id="5609075">*</span><span class="ident" id="5609076">Address</span><span class="op" id="5609083">,</span>&nbsp;<span class="builtintype" id="5609085">error</span><span class="op" id="5609090">)</span>&nbsp;<span class="op" id="5609092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609095">return</span>&nbsp;<span class="ident" id="5609102">newAddrParser</span><span class="op" id="5609115">(</span><span class="ident" id="5609116">address</span><span class="op" id="5609123">)</span><span class="op" id="5609124">.</span><span class="ident" id="5609125">parseAddress</span><span class="op" id="5609137">(</span><span class="op" id="5609138">)</span><br>
<span class="lineno">145</span><span class="op" id="5609140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5609143">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5609211">func</span>&nbsp;<span class="ident" id="5609216">ParseAddressList</span><span class="op" id="5609232">(</span><span class="ident" id="5609233">list</span>&nbsp;<span class="builtintype" id="5609238">string</span><span class="op" id="5609244">)</span>&nbsp;<span class="op" id="5609246">(</span><span class="op" id="5609247">[</span><span class="op" id="5609248">]</span><span class="op" id="5609249">*</span><span class="ident" id="5609250">Address</span><span class="op" id="5609257">,</span>&nbsp;<span class="builtintype" id="5609259">error</span><span class="op" id="5609264">)</span>&nbsp;<span class="op" id="5609266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609269">return</span>&nbsp;<span class="ident" id="5609276">newAddrParser</span><span class="op" id="5609289">(</span><span class="ident" id="5609290">list</span><span class="op" id="5609294">)</span><span class="op" id="5609295">.</span><span class="ident" id="5609296">parseAddressList</span><span class="op" id="5609312">(</span><span class="op" id="5609313">)</span><br>
<span class="lineno">150</span><span class="op" id="5609315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5609318">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="5609377">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="5609432">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="5609484">func</span>&nbsp;<span class="op" id="5609489">(</span><span class="ident" id="5609490">a</span>&nbsp;<span class="op" id="5609492">*</span><span class="ident" id="5609493">Address</span><span class="op" id="5609500">)</span>&nbsp;<span class="ident" id="5609502">String</span><span class="op" id="5609508">(</span><span class="op" id="5609509">)</span>&nbsp;<span class="builtintype" id="5609511">string</span>&nbsp;<span class="op" id="5609518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609521">s</span>&nbsp;<span class="op" id="5609523">:=</span>&nbsp;<span class="string" id="5609526">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="5609530">+</span>&nbsp;<span class="ident" id="5609532">a</span><span class="op" id="5609533">.</span><span class="ident" id="5609534">Address</span>&nbsp;<span class="op" id="5609542">+</span>&nbsp;<span class="string" id="5609544">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609549">if</span>&nbsp;<span class="ident" id="5609552">a</span><span class="op" id="5609553">.</span><span class="ident" id="5609554">Name</span>&nbsp;<span class="op" id="5609559">==</span>&nbsp;<span class="string" id="5609562">&#34;&#34;</span>&nbsp;<span class="op" id="5609565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609569">return</span>&nbsp;<span class="ident" id="5609576">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5609579">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609582">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609644">allPrintable</span>&nbsp;<span class="op" id="5609657">:=</span>&nbsp;<span class="builtintype" id="5609660">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609666">for</span>&nbsp;<span class="ident" id="5609670">i</span>&nbsp;<span class="op" id="5609672">:=</span>&nbsp;<span class="num" id="5609675">0</span><span class="op" id="5609676">;</span>&nbsp;<span class="ident" id="5609678">i</span>&nbsp;<span class="op" id="5609680">&lt;</span>&nbsp;<span class="builtinfunc" id="5609682">len</span><span class="op" id="5609685">(</span><span class="ident" id="5609686">a</span><span class="op" id="5609687">.</span><span class="ident" id="5609688">Name</span><span class="op" id="5609692">)</span><span class="op" id="5609693">;</span>&nbsp;<span class="ident" id="5609695">i</span><span class="op" id="5609696">++</span>&nbsp;<span class="op" id="5609699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609703">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5609745">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609784">if</span>&nbsp;<span class="op" id="5609787">!</span><span class="ident" id="5609788">isVchar</span><span class="op" id="5609795">(</span><span class="ident" id="5609796">a</span><span class="op" id="5609797">.</span><span class="ident" id="5609798">Name</span><span class="op" id="5609802">[</span><span class="ident" id="5609803">i</span><span class="op" id="5609804">]</span><span class="op" id="5609805">)</span>&nbsp;<span class="op" id="5609807">&amp;&amp;</span>&nbsp;<span class="op" id="5609810">!</span><span class="ident" id="5609811">isWSP</span><span class="op" id="5609816">(</span><span class="ident" id="5609817">a</span><span class="op" id="5609818">.</span><span class="ident" id="5609819">Name</span><span class="op" id="5609823">[</span><span class="ident" id="5609824">i</span><span class="op" id="5609825">]</span><span class="op" id="5609826">)</span>&nbsp;<span class="op" id="5609828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609833">allPrintable</span>&nbsp;<span class="op" id="5609846">=</span>&nbsp;<span class="builtintype" id="5609848">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609857">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5609865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5609868">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609871">if</span>&nbsp;<span class="ident" id="5609874">allPrintable</span>&nbsp;<span class="op" id="5609887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5609891">b</span>&nbsp;<span class="op" id="5609893">:=</span>&nbsp;<span class="ident" id="5609896">bytes</span><span class="op" id="5609901">.</span><span class="ident" id="5609902">NewBufferString</span><span class="op" id="5609917">(</span><span class="string" id="5609918">`&#34;`</span><span class="op" id="5609921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609925">for</span>&nbsp;<span class="ident" id="5609929">i</span>&nbsp;<span class="op" id="5609931">:=</span>&nbsp;<span class="num" id="5609934">0</span><span class="op" id="5609935">;</span>&nbsp;<span class="ident" id="5609937">i</span>&nbsp;<span class="op" id="5609939">&lt;</span>&nbsp;<span class="builtinfunc" id="5609941">len</span><span class="op" id="5609944">(</span><span class="ident" id="5609945">a</span><span class="op" id="5609946">.</span><span class="ident" id="5609947">Name</span><span class="op" id="5609951">)</span><span class="op" id="5609952">;</span>&nbsp;<span class="ident" id="5609954">i</span><span class="op" id="5609955">++</span>&nbsp;<span class="op" id="5609958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5609963">if</span>&nbsp;<span class="op" id="5609966">!</span><span class="ident" id="5609967">isQtext</span><span class="op" id="5609974">(</span><span class="ident" id="5609975">a</span><span class="op" id="5609976">.</span><span class="ident" id="5609977">Name</span><span class="op" id="5609981">[</span><span class="ident" id="5609982">i</span><span class="op" id="5609983">]</span><span class="op" id="5609984">)</span>&nbsp;<span class="op" id="5609986">&amp;&amp;</span>&nbsp;<span class="op" id="5609989">!</span><span class="ident" id="5609990">isWSP</span><span class="op" id="5609995">(</span><span class="ident" id="5609996">a</span><span class="op" id="5609997">.</span><span class="ident" id="5609998">Name</span><span class="op" id="5610002">[</span><span class="ident" id="5610003">i</span><span class="op" id="5610004">]</span><span class="op" id="5610005">)</span>&nbsp;<span class="op" id="5610007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610013">b</span><span class="op" id="5610014">.</span><span class="ident" id="5610015">WriteByte</span><span class="op" id="5610024">(</span><span class="string" id="5610025">&#39;\\&#39;</span><span class="op" id="5610029">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610039">b</span><span class="op" id="5610040">.</span><span class="ident" id="5610041">WriteByte</span><span class="op" id="5610050">(</span><span class="ident" id="5610051">a</span><span class="op" id="5610052">.</span><span class="ident" id="5610053">Name</span><span class="op" id="5610057">[</span><span class="ident" id="5610058">i</span><span class="op" id="5610059">]</span><span class="op" id="5610060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610068">b</span><span class="op" id="5610069">.</span><span class="ident" id="5610070">WriteString</span><span class="op" id="5610081">(</span><span class="string" id="5610082">`&#34;&nbsp;`</span><span class="op" id="5610086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610090">b</span><span class="op" id="5610091">.</span><span class="ident" id="5610092">WriteString</span><span class="op" id="5610103">(</span><span class="ident" id="5610104">s</span><span class="op" id="5610105">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610109">return</span>&nbsp;<span class="ident" id="5610116">b</span><span class="op" id="5610117">.</span><span class="ident" id="5610118">String</span><span class="op" id="5610124">(</span><span class="op" id="5610125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5610132">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610155">b</span>&nbsp;<span class="op" id="5610157">:=</span>&nbsp;<span class="ident" id="5610160">bytes</span><span class="op" id="5610165">.</span><span class="ident" id="5610166">NewBufferString</span><span class="op" id="5610181">(</span><span class="string" id="5610182">&#34;=?utf-8?q?&#34;</span><span class="op" id="5610194">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610197">for</span>&nbsp;<span class="ident" id="5610201">i</span>&nbsp;<span class="op" id="5610203">:=</span>&nbsp;<span class="num" id="5610206">0</span><span class="op" id="5610207">;</span>&nbsp;<span class="ident" id="5610209">i</span>&nbsp;<span class="op" id="5610211">&lt;</span>&nbsp;<span class="builtinfunc" id="5610213">len</span><span class="op" id="5610216">(</span><span class="ident" id="5610217">a</span><span class="op" id="5610218">.</span><span class="ident" id="5610219">Name</span><span class="op" id="5610223">)</span><span class="op" id="5610224">;</span>&nbsp;<span class="ident" id="5610226">i</span><span class="op" id="5610227">++</span>&nbsp;<span class="op" id="5610230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610234">switch</span>&nbsp;<span class="ident" id="5610241">c</span>&nbsp;<span class="op" id="5610243">:=</span>&nbsp;<span class="ident" id="5610246">a</span><span class="op" id="5610247">.</span><span class="ident" id="5610248">Name</span><span class="op" id="5610252">[</span><span class="ident" id="5610253">i</span><span class="op" id="5610254">]</span><span class="op" id="5610255">;</span>&nbsp;<span class="op" id="5610257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610261">case</span>&nbsp;<span class="ident" id="5610266">c</span>&nbsp;<span class="op" id="5610268">==</span>&nbsp;<span class="string" id="5610271">&#39;&nbsp;&#39;</span><span class="op" id="5610274">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610279">b</span><span class="op" id="5610280">.</span><span class="ident" id="5610281">WriteByte</span><span class="op" id="5610290">(</span><span class="string" id="5610291">&#39;_&#39;</span><span class="op" id="5610294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610298">case</span>&nbsp;<span class="ident" id="5610303">isVchar</span><span class="op" id="5610310">(</span><span class="ident" id="5610311">c</span><span class="op" id="5610312">)</span>&nbsp;<span class="op" id="5610314">&amp;&amp;</span>&nbsp;<span class="ident" id="5610317">c</span>&nbsp;<span class="op" id="5610319">!=</span>&nbsp;<span class="string" id="5610322">&#39;=&#39;</span>&nbsp;<span class="op" id="5610326">&amp;&amp;</span>&nbsp;<span class="ident" id="5610329">c</span>&nbsp;<span class="op" id="5610331">!=</span>&nbsp;<span class="string" id="5610334">&#39;?&#39;</span>&nbsp;<span class="op" id="5610338">&amp;&amp;</span>&nbsp;<span class="ident" id="5610341">c</span>&nbsp;<span class="op" id="5610343">!=</span>&nbsp;<span class="string" id="5610346">&#39;_&#39;</span><span class="op" id="5610349">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610354">b</span><span class="op" id="5610355">.</span><span class="ident" id="5610356">WriteByte</span><span class="op" id="5610365">(</span><span class="ident" id="5610366">c</span><span class="op" id="5610367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610371">default</span><span class="op" id="5610378">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610383">fmt</span><span class="op" id="5610386">.</span><span class="ident" id="5610387">Fprintf</span><span class="op" id="5610394">(</span><span class="ident" id="5610395">b</span><span class="op" id="5610396">,</span>&nbsp;<span class="string" id="5610398">&#34;=%02X&#34;</span><span class="op" id="5610405">,</span>&nbsp;<span class="ident" id="5610407">c</span><span class="op" id="5610408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610412">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610415">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610418">b</span><span class="op" id="5610419">.</span><span class="ident" id="5610420">WriteString</span><span class="op" id="5610431">(</span><span class="string" id="5610432">&#34;?=&nbsp;&#34;</span><span class="op" id="5610437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610440">b</span><span class="op" id="5610441">.</span><span class="ident" id="5610442">WriteString</span><span class="op" id="5610453">(</span><span class="ident" id="5610454">s</span><span class="op" id="5610455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610458">return</span>&nbsp;<span class="ident" id="5610465">b</span><span class="op" id="5610466">.</span><span class="ident" id="5610467">String</span><span class="op" id="5610473">(</span><span class="op" id="5610474">)</span><br>
<span class="lineno"></span><span class="op" id="5610476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="5610479">type</span>&nbsp;<span class="ident" id="5610484">addrParser</span>&nbsp;<span class="op" id="5610495">[</span><span class="op" id="5610496">]</span><span class="builtintype" id="5610497">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5610503">func</span>&nbsp;<span class="ident" id="5610508">newAddrParser</span><span class="op" id="5610521">(</span><span class="ident" id="5610522">s</span>&nbsp;<span class="builtintype" id="5610524">string</span><span class="op" id="5610530">)</span>&nbsp;<span class="op" id="5610532">*</span><span class="ident" id="5610533">addrParser</span>&nbsp;<span class="op" id="5610544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610547">p</span>&nbsp;<span class="op" id="5610549">:=</span>&nbsp;<span class="ident" id="5610552">addrParser</span><span class="op" id="5610562">(</span><span class="ident" id="5610563">s</span><span class="op" id="5610564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610567">return</span>&nbsp;<span class="op" id="5610574">&amp;</span><span class="ident" id="5610575">p</span><br>
<span class="lineno">205</span><span class="op" id="5610577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5610580">func</span>&nbsp;<span class="op" id="5610585">(</span><span class="ident" id="5610586">p</span>&nbsp;<span class="op" id="5610588">*</span><span class="ident" id="5610589">addrParser</span><span class="op" id="5610599">)</span>&nbsp;<span class="ident" id="5610601">parseAddressList</span><span class="op" id="5610617">(</span><span class="op" id="5610618">)</span>&nbsp;<span class="op" id="5610620">(</span><span class="op" id="5610621">[</span><span class="op" id="5610622">]</span><span class="op" id="5610623">*</span><span class="ident" id="5610624">Address</span><span class="op" id="5610631">,</span>&nbsp;<span class="builtintype" id="5610633">error</span><span class="op" id="5610638">)</span>&nbsp;<span class="op" id="5610640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610643">var</span>&nbsp;<span class="ident" id="5610647">list</span>&nbsp;<span class="op" id="5610652">[</span><span class="op" id="5610653">]</span><span class="op" id="5610654">*</span><span class="ident" id="5610655">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610664">for</span>&nbsp;<span class="op" id="5610668">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610672">p</span><span class="op" id="5610673">.</span><span class="ident" id="5610674">skipSpace</span><span class="op" id="5610683">(</span><span class="op" id="5610684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610688">addr</span><span class="op" id="5610692">,</span>&nbsp;<span class="ident" id="5610694">err</span>&nbsp;<span class="op" id="5610698">:=</span>&nbsp;<span class="ident" id="5610701">p</span><span class="op" id="5610702">.</span><span class="ident" id="5610703">parseAddress</span><span class="op" id="5610715">(</span><span class="op" id="5610716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610720">if</span>&nbsp;<span class="ident" id="5610723">err</span>&nbsp;<span class="op" id="5610727">!=</span>&nbsp;<span class="ident" id="5610730">nil</span>&nbsp;<span class="op" id="5610734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610739">return</span>&nbsp;<span class="ident" id="5610746">nil</span><span class="op" id="5610749">,</span>&nbsp;<span class="ident" id="5610751">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610757">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610761">list</span>&nbsp;<span class="op" id="5610766">=</span>&nbsp;<span class="builtinfunc" id="5610768">append</span><span class="op" id="5610774">(</span><span class="ident" id="5610775">list</span><span class="op" id="5610779">,</span>&nbsp;<span class="ident" id="5610781">addr</span><span class="op" id="5610785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5610790">p</span><span class="op" id="5610791">.</span><span class="ident" id="5610792">skipSpace</span><span class="op" id="5610801">(</span><span class="op" id="5610802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610806">if</span>&nbsp;<span class="ident" id="5610809">p</span><span class="op" id="5610810">.</span><span class="ident" id="5610811">empty</span><span class="op" id="5610816">(</span><span class="op" id="5610817">)</span>&nbsp;<span class="op" id="5610819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610824">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610836">if</span>&nbsp;<span class="op" id="5610839">!</span><span class="ident" id="5610840">p</span><span class="op" id="5610841">.</span><span class="ident" id="5610842">consume</span><span class="op" id="5610849">(</span><span class="string" id="5610850">&#39;,&#39;</span><span class="op" id="5610853">)</span>&nbsp;<span class="op" id="5610855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610860">return</span>&nbsp;<span class="ident" id="5610867">nil</span><span class="op" id="5610870">,</span>&nbsp;<span class="ident" id="5610872">errors</span><span class="op" id="5610878">.</span><span class="ident" id="5610879">New</span><span class="op" id="5610882">(</span><span class="string" id="5610883">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="5610905">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5610912">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5610915">return</span>&nbsp;<span class="ident" id="5610922">list</span><span class="op" id="5610926">,</span>&nbsp;<span class="ident" id="5610928">nil</span><br>
<span class="lineno"></span><span class="op" id="5610932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5610935">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5611003">func</span>&nbsp;<span class="op" id="5611008">(</span><span class="ident" id="5611009">p</span>&nbsp;<span class="op" id="5611011">*</span><span class="ident" id="5611012">addrParser</span><span class="op" id="5611022">)</span>&nbsp;<span class="ident" id="5611024">parseAddress</span><span class="op" id="5611036">(</span><span class="op" id="5611037">)</span>&nbsp;<span class="op" id="5611039">(</span><span class="ident" id="5611040">addr</span>&nbsp;<span class="op" id="5611045">*</span><span class="ident" id="5611046">Address</span><span class="op" id="5611053">,</span>&nbsp;<span class="ident" id="5611055">err</span>&nbsp;<span class="builtintype" id="5611059">error</span><span class="op" id="5611064">)</span>&nbsp;<span class="op" id="5611066">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611069">debug</span><span class="op" id="5611074">.</span><span class="ident" id="5611075">Printf</span><span class="op" id="5611081">(</span><span class="string" id="5611082">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="5611100">,</span>&nbsp;<span class="op" id="5611102">*</span><span class="ident" id="5611103">p</span><span class="op" id="5611104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611107">p</span><span class="op" id="5611108">.</span><span class="ident" id="5611109">skipSpace</span><span class="op" id="5611118">(</span><span class="op" id="5611119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611122">if</span>&nbsp;<span class="ident" id="5611125">p</span><span class="op" id="5611126">.</span><span class="ident" id="5611127">empty</span><span class="op" id="5611132">(</span><span class="op" id="5611133">)</span>&nbsp;<span class="op" id="5611135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611139">return</span>&nbsp;<span class="ident" id="5611146">nil</span><span class="op" id="5611149">,</span>&nbsp;<span class="ident" id="5611151">errors</span><span class="op" id="5611157">.</span><span class="ident" id="5611158">New</span><span class="op" id="5611161">(</span><span class="string" id="5611162">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="5611180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611183">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611187">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611223">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611275">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611335">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611391">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611435">spec</span><span class="op" id="5611439">,</span>&nbsp;<span class="ident" id="5611441">err</span>&nbsp;<span class="op" id="5611445">:=</span>&nbsp;<span class="ident" id="5611448">p</span><span class="op" id="5611449">.</span><span class="ident" id="5611450">consumeAddrSpec</span><span class="op" id="5611465">(</span><span class="op" id="5611466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611469">if</span>&nbsp;<span class="ident" id="5611472">err</span>&nbsp;<span class="op" id="5611476">==</span>&nbsp;<span class="ident" id="5611479">nil</span>&nbsp;<span class="op" id="5611483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611487">return</span>&nbsp;<span class="op" id="5611494">&amp;</span><span class="ident" id="5611495">Address</span><span class="op" id="5611502">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611507">Address</span><span class="op" id="5611514">:</span>&nbsp;<span class="ident" id="5611516">spec</span><span class="op" id="5611520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611524">}</span><span class="op" id="5611525">,</span>&nbsp;<span class="ident" id="5611527">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611535">debug</span><span class="op" id="5611540">.</span><span class="ident" id="5611541">Printf</span><span class="op" id="5611547">(</span><span class="string" id="5611548">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="5611584">,</span>&nbsp;<span class="ident" id="5611586">err</span><span class="op" id="5611589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611592">debug</span><span class="op" id="5611597">.</span><span class="ident" id="5611598">Printf</span><span class="op" id="5611604">(</span><span class="string" id="5611605">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="5611636">,</span>&nbsp;<span class="op" id="5611638">*</span><span class="ident" id="5611639">p</span><span class="op" id="5611640">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611644">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611661">var</span>&nbsp;<span class="ident" id="5611665">displayName</span>&nbsp;<span class="builtintype" id="5611677">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611685">if</span>&nbsp;<span class="ident" id="5611688">p</span><span class="op" id="5611689">.</span><span class="ident" id="5611690">peek</span><span class="op" id="5611694">(</span><span class="op" id="5611695">)</span>&nbsp;<span class="op" id="5611697">!=</span>&nbsp;<span class="string" id="5611700">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5611704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611708">displayName</span><span class="op" id="5611719">,</span>&nbsp;<span class="ident" id="5611721">err</span>&nbsp;<span class="op" id="5611725">=</span>&nbsp;<span class="ident" id="5611727">p</span><span class="op" id="5611728">.</span><span class="ident" id="5611729">consumePhrase</span><span class="op" id="5611742">(</span><span class="op" id="5611743">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611747">if</span>&nbsp;<span class="ident" id="5611750">err</span>&nbsp;<span class="op" id="5611754">!=</span>&nbsp;<span class="ident" id="5611757">nil</span>&nbsp;<span class="op" id="5611761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611766">return</span>&nbsp;<span class="ident" id="5611773">nil</span><span class="op" id="5611776">,</span>&nbsp;<span class="ident" id="5611778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611790">debug</span><span class="op" id="5611795">.</span><span class="ident" id="5611796">Printf</span><span class="op" id="5611802">(</span><span class="string" id="5611803">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="5611833">,</span>&nbsp;<span class="ident" id="5611835">displayName</span><span class="op" id="5611846">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5611850">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611885">p</span><span class="op" id="5611886">.</span><span class="ident" id="5611887">skipSpace</span><span class="op" id="5611896">(</span><span class="op" id="5611897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611900">if</span>&nbsp;<span class="op" id="5611903">!</span><span class="ident" id="5611904">p</span><span class="op" id="5611905">.</span><span class="ident" id="5611906">consume</span><span class="op" id="5611913">(</span><span class="string" id="5611914">&#39;&lt;&#39;</span><span class="op" id="5611917">)</span>&nbsp;<span class="op" id="5611919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5611923">return</span>&nbsp;<span class="ident" id="5611930">nil</span><span class="op" id="5611933">,</span>&nbsp;<span class="ident" id="5611935">errors</span><span class="op" id="5611941">.</span><span class="ident" id="5611942">New</span><span class="op" id="5611945">(</span><span class="string" id="5611946">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="5611967">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5611970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5611973">spec</span><span class="op" id="5611977">,</span>&nbsp;<span class="ident" id="5611979">err</span>&nbsp;<span class="op" id="5611983">=</span>&nbsp;<span class="ident" id="5611985">p</span><span class="op" id="5611986">.</span><span class="ident" id="5611987">consumeAddrSpec</span><span class="op" id="5612002">(</span><span class="op" id="5612003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612006">if</span>&nbsp;<span class="ident" id="5612009">err</span>&nbsp;<span class="op" id="5612013">!=</span>&nbsp;<span class="ident" id="5612016">nil</span>&nbsp;<span class="op" id="5612020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612024">return</span>&nbsp;<span class="ident" id="5612031">nil</span><span class="op" id="5612034">,</span>&nbsp;<span class="ident" id="5612036">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612041">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612044">if</span>&nbsp;<span class="op" id="5612047">!</span><span class="ident" id="5612048">p</span><span class="op" id="5612049">.</span><span class="ident" id="5612050">consume</span><span class="op" id="5612057">(</span><span class="string" id="5612058">&#39;&gt;&#39;</span><span class="op" id="5612061">)</span>&nbsp;<span class="op" id="5612063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612067">return</span>&nbsp;<span class="ident" id="5612074">nil</span><span class="op" id="5612077">,</span>&nbsp;<span class="ident" id="5612079">errors</span><span class="op" id="5612085">.</span><span class="ident" id="5612086">New</span><span class="op" id="5612089">(</span><span class="string" id="5612090">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="5612117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612123">debug</span><span class="op" id="5612128">.</span><span class="ident" id="5612129">Printf</span><span class="op" id="5612135">(</span><span class="string" id="5612136">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="5612159">,</span>&nbsp;<span class="ident" id="5612161">spec</span><span class="op" id="5612165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612169">return</span>&nbsp;<span class="op" id="5612176">&amp;</span><span class="ident" id="5612177">Address</span><span class="op" id="5612184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612188">Name</span><span class="op" id="5612192">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5612197">displayName</span><span class="op" id="5612208">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612212">Address</span><span class="op" id="5612219">:</span>&nbsp;<span class="ident" id="5612221">spec</span><span class="op" id="5612225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612228">}</span><span class="op" id="5612229">,</span>&nbsp;<span class="ident" id="5612231">nil</span><br>
<span class="lineno"></span><span class="op" id="5612235">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5612238">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5612311">func</span>&nbsp;<span class="op" id="5612316">(</span><span class="ident" id="5612317">p</span>&nbsp;<span class="op" id="5612319">*</span><span class="ident" id="5612320">addrParser</span><span class="op" id="5612330">)</span>&nbsp;<span class="ident" id="5612332">consumeAddrSpec</span><span class="op" id="5612347">(</span><span class="op" id="5612348">)</span>&nbsp;<span class="op" id="5612350">(</span><span class="ident" id="5612351">spec</span>&nbsp;<span class="builtintype" id="5612356">string</span><span class="op" id="5612362">,</span>&nbsp;<span class="ident" id="5612364">err</span>&nbsp;<span class="builtintype" id="5612368">error</span><span class="op" id="5612373">)</span>&nbsp;<span class="op" id="5612375">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612378">debug</span><span class="op" id="5612383">.</span><span class="ident" id="5612384">Printf</span><span class="op" id="5612390">(</span><span class="string" id="5612391">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="5612412">,</span>&nbsp;<span class="op" id="5612414">*</span><span class="ident" id="5612415">p</span><span class="op" id="5612416">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612420">orig</span>&nbsp;<span class="op" id="5612425">:=</span>&nbsp;<span class="op" id="5612428">*</span><span class="ident" id="5612429">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612432">defer</span>&nbsp;<span class="keyword" id="5612438">func</span><span class="op" id="5612442">(</span><span class="op" id="5612443">)</span>&nbsp;<span class="op" id="5612445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612449">if</span>&nbsp;<span class="ident" id="5612452">err</span>&nbsp;<span class="op" id="5612456">!=</span>&nbsp;<span class="ident" id="5612459">nil</span>&nbsp;<span class="op" id="5612463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612468">*</span><span class="ident" id="5612469">p</span>&nbsp;<span class="op" id="5612471">=</span>&nbsp;<span class="ident" id="5612473">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612480">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612483">}</span><span class="op" id="5612484">(</span><span class="op" id="5612485">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5612489">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612531">var</span>&nbsp;<span class="ident" id="5612535">localPart</span>&nbsp;<span class="builtintype" id="5612545">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612553">p</span><span class="op" id="5612554">.</span><span class="ident" id="5612555">skipSpace</span><span class="op" id="5612564">(</span><span class="op" id="5612565">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612568">if</span>&nbsp;<span class="ident" id="5612571">p</span><span class="op" id="5612572">.</span><span class="ident" id="5612573">empty</span><span class="op" id="5612578">(</span><span class="op" id="5612579">)</span>&nbsp;<span class="op" id="5612581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612585">return</span>&nbsp;<span class="string" id="5612592">&#34;&#34;</span><span class="op" id="5612594">,</span>&nbsp;<span class="ident" id="5612596">errors</span><span class="op" id="5612602">.</span><span class="ident" id="5612603">New</span><span class="op" id="5612606">(</span><span class="string" id="5612607">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="5612627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612633">if</span>&nbsp;<span class="ident" id="5612636">p</span><span class="op" id="5612637">.</span><span class="ident" id="5612638">peek</span><span class="op" id="5612642">(</span><span class="op" id="5612643">)</span>&nbsp;<span class="op" id="5612645">==</span>&nbsp;<span class="string" id="5612648">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5612652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5612656">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612675">debug</span><span class="op" id="5612680">.</span><span class="ident" id="5612681">Printf</span><span class="op" id="5612687">(</span><span class="string" id="5612688">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="5612728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612732">localPart</span><span class="op" id="5612741">,</span>&nbsp;<span class="ident" id="5612743">err</span>&nbsp;<span class="op" id="5612747">=</span>&nbsp;<span class="ident" id="5612749">p</span><span class="op" id="5612750">.</span><span class="ident" id="5612751">consumeQuotedString</span><span class="op" id="5612770">(</span><span class="op" id="5612771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612774">}</span>&nbsp;<span class="keyword" id="5612776">else</span>&nbsp;<span class="op" id="5612781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5612785">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612799">debug</span><span class="op" id="5612804">.</span><span class="ident" id="5612805">Printf</span><span class="op" id="5612811">(</span><span class="string" id="5612812">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="5612847">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612851">localPart</span><span class="op" id="5612860">,</span>&nbsp;<span class="ident" id="5612862">err</span>&nbsp;<span class="op" id="5612866">=</span>&nbsp;<span class="ident" id="5612868">p</span><span class="op" id="5612869">.</span><span class="ident" id="5612870">consumeAtom</span><span class="op" id="5612881">(</span><span class="builtintype" id="5612882">true</span><span class="op" id="5612886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612892">if</span>&nbsp;<span class="ident" id="5612895">err</span>&nbsp;<span class="op" id="5612899">!=</span>&nbsp;<span class="ident" id="5612902">nil</span>&nbsp;<span class="op" id="5612906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5612910">debug</span><span class="op" id="5612915">.</span><span class="ident" id="5612916">Printf</span><span class="op" id="5612922">(</span><span class="string" id="5612923">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="5612952">,</span>&nbsp;<span class="ident" id="5612954">err</span><span class="op" id="5612957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612961">return</span>&nbsp;<span class="string" id="5612968">&#34;&#34;</span><span class="op" id="5612970">,</span>&nbsp;<span class="ident" id="5612972">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5612977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5612981">if</span>&nbsp;<span class="op" id="5612984">!</span><span class="ident" id="5612985">p</span><span class="op" id="5612986">.</span><span class="ident" id="5612987">consume</span><span class="op" id="5612994">(</span><span class="string" id="5612995">&#39;@&#39;</span><span class="op" id="5612998">)</span>&nbsp;<span class="op" id="5613000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613004">return</span>&nbsp;<span class="string" id="5613011">&#34;&#34;</span><span class="op" id="5613013">,</span>&nbsp;<span class="ident" id="5613015">errors</span><span class="op" id="5613021">.</span><span class="ident" id="5613022">New</span><span class="op" id="5613025">(</span><span class="string" id="5613026">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5613056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613059">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613063">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613102">var</span>&nbsp;<span class="ident" id="5613106">domain</span>&nbsp;<span class="builtintype" id="5613113">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613121">p</span><span class="op" id="5613122">.</span><span class="ident" id="5613123">skipSpace</span><span class="op" id="5613132">(</span><span class="op" id="5613133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613136">if</span>&nbsp;<span class="ident" id="5613139">p</span><span class="op" id="5613140">.</span><span class="ident" id="5613141">empty</span><span class="op" id="5613146">(</span><span class="op" id="5613147">)</span>&nbsp;<span class="op" id="5613149">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613153">return</span>&nbsp;<span class="string" id="5613160">&#34;&#34;</span><span class="op" id="5613162">,</span>&nbsp;<span class="ident" id="5613164">errors</span><span class="op" id="5613170">.</span><span class="ident" id="5613171">New</span><span class="op" id="5613174">(</span><span class="string" id="5613175">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5613205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613211">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613253">domain</span><span class="op" id="5613259">,</span>&nbsp;<span class="ident" id="5613261">err</span>&nbsp;<span class="op" id="5613265">=</span>&nbsp;<span class="ident" id="5613267">p</span><span class="op" id="5613268">.</span><span class="ident" id="5613269">consumeAtom</span><span class="op" id="5613280">(</span><span class="builtintype" id="5613281">true</span><span class="op" id="5613285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613288">if</span>&nbsp;<span class="ident" id="5613291">err</span>&nbsp;<span class="op" id="5613295">!=</span>&nbsp;<span class="ident" id="5613298">nil</span>&nbsp;<span class="op" id="5613302">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613306">return</span>&nbsp;<span class="string" id="5613313">&#34;&#34;</span><span class="op" id="5613315">,</span>&nbsp;<span class="ident" id="5613317">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613326">return</span>&nbsp;<span class="ident" id="5613333">localPart</span>&nbsp;<span class="op" id="5613343">+</span>&nbsp;<span class="string" id="5613345">&#34;@&#34;</span>&nbsp;<span class="op" id="5613349">+</span>&nbsp;<span class="ident" id="5613351">domain</span><span class="op" id="5613357">,</span>&nbsp;<span class="ident" id="5613359">nil</span><br>
<span class="lineno"></span><span class="op" id="5613363">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="5613366">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5613429">func</span>&nbsp;<span class="op" id="5613434">(</span><span class="ident" id="5613435">p</span>&nbsp;<span class="op" id="5613437">*</span><span class="ident" id="5613438">addrParser</span><span class="op" id="5613448">)</span>&nbsp;<span class="ident" id="5613450">consumePhrase</span><span class="op" id="5613463">(</span><span class="op" id="5613464">)</span>&nbsp;<span class="op" id="5613466">(</span><span class="ident" id="5613467">phrase</span>&nbsp;<span class="builtintype" id="5613474">string</span><span class="op" id="5613480">,</span>&nbsp;<span class="ident" id="5613482">err</span>&nbsp;<span class="builtintype" id="5613486">error</span><span class="op" id="5613491">)</span>&nbsp;<span class="op" id="5613493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613496">debug</span><span class="op" id="5613501">.</span><span class="ident" id="5613502">Printf</span><span class="op" id="5613508">(</span><span class="string" id="5613509">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="5613530">,</span>&nbsp;<span class="op" id="5613532">*</span><span class="ident" id="5613533">p</span><span class="op" id="5613534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613537">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613557">var</span>&nbsp;<span class="ident" id="5613561">words</span>&nbsp;<span class="op" id="5613567">[</span><span class="op" id="5613568">]</span><span class="builtintype" id="5613569">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613577">for</span>&nbsp;<span class="op" id="5613581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613585">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613618">var</span>&nbsp;<span class="ident" id="5613622">word</span>&nbsp;<span class="builtintype" id="5613627">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613636">p</span><span class="op" id="5613637">.</span><span class="ident" id="5613638">skipSpace</span><span class="op" id="5613647">(</span><span class="op" id="5613648">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613652">if</span>&nbsp;<span class="ident" id="5613655">p</span><span class="op" id="5613656">.</span><span class="ident" id="5613657">empty</span><span class="op" id="5613662">(</span><span class="op" id="5613663">)</span>&nbsp;<span class="op" id="5613665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613670">return</span>&nbsp;<span class="string" id="5613677">&#34;&#34;</span><span class="op" id="5613679">,</span>&nbsp;<span class="ident" id="5613681">errors</span><span class="op" id="5613687">.</span><span class="ident" id="5613688">New</span><span class="op" id="5613691">(</span><span class="string" id="5613692">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="5613714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5613722">if</span>&nbsp;<span class="ident" id="5613725">p</span><span class="op" id="5613726">.</span><span class="ident" id="5613727">peek</span><span class="op" id="5613731">(</span><span class="op" id="5613732">)</span>&nbsp;<span class="op" id="5613734">==</span>&nbsp;<span class="string" id="5613737">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5613741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613746">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613766">word</span><span class="op" id="5613770">,</span>&nbsp;<span class="ident" id="5613772">err</span>&nbsp;<span class="op" id="5613776">=</span>&nbsp;<span class="ident" id="5613778">p</span><span class="op" id="5613779">.</span><span class="ident" id="5613780">consumeQuotedString</span><span class="op" id="5613799">(</span><span class="op" id="5613800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613804">}</span>&nbsp;<span class="keyword" id="5613806">else</span>&nbsp;<span class="op" id="5613811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613816">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613827">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613887">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5613923">word</span><span class="op" id="5613927">,</span>&nbsp;<span class="ident" id="5613929">err</span>&nbsp;<span class="op" id="5613933">=</span>&nbsp;<span class="ident" id="5613935">p</span><span class="op" id="5613936">.</span><span class="ident" id="5613937">consumeAtom</span><span class="op" id="5613948">(</span><span class="builtintype" id="5613949">true</span><span class="op" id="5613953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5613957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5613962">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614041">if</span>&nbsp;<span class="ident" id="5614044">err</span>&nbsp;<span class="op" id="5614048">==</span>&nbsp;<span class="ident" id="5614051">nil</span>&nbsp;<span class="op" id="5614055">&amp;&amp;</span>&nbsp;<span class="ident" id="5614058">strings</span><span class="op" id="5614065">.</span><span class="ident" id="5614066">HasPrefix</span><span class="op" id="5614075">(</span><span class="ident" id="5614076">word</span><span class="op" id="5614080">,</span>&nbsp;<span class="string" id="5614082">&#34;=?&#34;</span><span class="op" id="5614086">)</span>&nbsp;<span class="op" id="5614088">&amp;&amp;</span>&nbsp;<span class="ident" id="5614091">strings</span><span class="op" id="5614098">.</span><span class="ident" id="5614099">HasSuffix</span><span class="op" id="5614108">(</span><span class="ident" id="5614109">word</span><span class="op" id="5614113">,</span>&nbsp;<span class="string" id="5614115">&#34;?=&#34;</span><span class="op" id="5614119">)</span>&nbsp;<span class="op" id="5614121">&amp;&amp;</span>&nbsp;<span class="ident" id="5614124">strings</span><span class="op" id="5614131">.</span><span class="ident" id="5614132">Count</span><span class="op" id="5614137">(</span><span class="ident" id="5614138">word</span><span class="op" id="5614142">,</span>&nbsp;<span class="string" id="5614144">&#34;?&#34;</span><span class="op" id="5614147">)</span>&nbsp;<span class="op" id="5614149">==</span>&nbsp;<span class="num" id="5614152">4</span>&nbsp;<span class="op" id="5614154">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614159">word</span><span class="op" id="5614163">,</span>&nbsp;<span class="ident" id="5614165">err</span>&nbsp;<span class="op" id="5614169">=</span>&nbsp;<span class="ident" id="5614171">decodeRFC2047Word</span><span class="op" id="5614188">(</span><span class="ident" id="5614189">word</span><span class="op" id="5614193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614202">if</span>&nbsp;<span class="ident" id="5614205">err</span>&nbsp;<span class="op" id="5614209">!=</span>&nbsp;<span class="ident" id="5614212">nil</span>&nbsp;<span class="op" id="5614216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614221">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614233">debug</span><span class="op" id="5614238">.</span><span class="ident" id="5614239">Printf</span><span class="op" id="5614245">(</span><span class="string" id="5614246">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="5614274">,</span>&nbsp;<span class="ident" id="5614276">word</span><span class="op" id="5614280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614284">words</span>&nbsp;<span class="op" id="5614290">=</span>&nbsp;<span class="builtinfunc" id="5614292">append</span><span class="op" id="5614298">(</span><span class="ident" id="5614299">words</span><span class="op" id="5614304">,</span>&nbsp;<span class="ident" id="5614306">word</span><span class="op" id="5614310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614316">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614366">if</span>&nbsp;<span class="ident" id="5614369">err</span>&nbsp;<span class="op" id="5614373">!=</span>&nbsp;<span class="ident" id="5614376">nil</span>&nbsp;<span class="op" id="5614380">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5614383">len</span><span class="op" id="5614386">(</span><span class="ident" id="5614387">words</span><span class="op" id="5614392">)</span>&nbsp;<span class="op" id="5614394">==</span>&nbsp;<span class="num" id="5614397">0</span>&nbsp;<span class="op" id="5614399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614403">debug</span><span class="op" id="5614408">.</span><span class="ident" id="5614409">Printf</span><span class="op" id="5614415">(</span><span class="string" id="5614416">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="5614444">,</span>&nbsp;<span class="ident" id="5614446">err</span><span class="op" id="5614449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614453">return</span>&nbsp;<span class="string" id="5614460">&#34;&#34;</span><span class="op" id="5614462">,</span>&nbsp;<span class="ident" id="5614464">fmt</span><span class="op" id="5614467">.</span><span class="ident" id="5614468">Errorf</span><span class="op" id="5614474">(</span><span class="string" id="5614475">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="5614509">,</span>&nbsp;<span class="ident" id="5614511">err</span><span class="op" id="5614514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614520">phrase</span>&nbsp;<span class="op" id="5614527">=</span>&nbsp;<span class="ident" id="5614529">strings</span><span class="op" id="5614536">.</span><span class="ident" id="5614537">Join</span><span class="op" id="5614541">(</span><span class="ident" id="5614542">words</span><span class="op" id="5614547">,</span>&nbsp;<span class="string" id="5614549">&#34;&nbsp;&#34;</span><span class="op" id="5614552">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614555">return</span>&nbsp;<span class="ident" id="5614562">phrase</span><span class="op" id="5614568">,</span>&nbsp;<span class="ident" id="5614570">nil</span><br>
<span class="lineno"></span><span class="op" id="5614574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5614577">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5614644">func</span>&nbsp;<span class="op" id="5614649">(</span><span class="ident" id="5614650">p</span>&nbsp;<span class="op" id="5614652">*</span><span class="ident" id="5614653">addrParser</span><span class="op" id="5614663">)</span>&nbsp;<span class="ident" id="5614665">consumeQuotedString</span><span class="op" id="5614684">(</span><span class="op" id="5614685">)</span>&nbsp;<span class="op" id="5614687">(</span><span class="ident" id="5614688">qs</span>&nbsp;<span class="builtintype" id="5614691">string</span><span class="op" id="5614697">,</span>&nbsp;<span class="ident" id="5614699">err</span>&nbsp;<span class="builtintype" id="5614703">error</span><span class="op" id="5614708">)</span>&nbsp;<span class="op" id="5614710">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5614713">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614743">i</span>&nbsp;<span class="op" id="5614745">:=</span>&nbsp;<span class="num" id="5614748">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5614751">qsb</span>&nbsp;<span class="op" id="5614755">:=</span>&nbsp;<span class="builtinfunc" id="5614758">make</span><span class="op" id="5614762">(</span><span class="op" id="5614763">[</span><span class="op" id="5614764">]</span><span class="builtintype" id="5614765">byte</span><span class="op" id="5614769">,</span>&nbsp;<span class="num" id="5614771">0</span><span class="op" id="5614772">,</span>&nbsp;<span class="num" id="5614774">10</span><span class="op" id="5614776">)</span><br>
<span class="lineno"></span><span class="ident" id="5614778">Loop</span><span class="op" id="5614782">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614785">for</span>&nbsp;<span class="op" id="5614789">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614793">if</span>&nbsp;<span class="ident" id="5614796">i</span>&nbsp;<span class="op" id="5614798">&gt;=</span>&nbsp;<span class="ident" id="5614801">p</span><span class="op" id="5614802">.</span><span class="builtinfunc" id="5614803">len</span><span class="op" id="5614806">(</span><span class="op" id="5614807">)</span>&nbsp;<span class="op" id="5614809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614814">return</span>&nbsp;<span class="string" id="5614821">&#34;&#34;</span><span class="op" id="5614823">,</span>&nbsp;<span class="ident" id="5614825">errors</span><span class="op" id="5614831">.</span><span class="ident" id="5614832">New</span><span class="op" id="5614835">(</span><span class="string" id="5614836">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5614866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5614870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614874">switch</span>&nbsp;<span class="ident" id="5614881">c</span>&nbsp;<span class="op" id="5614883">:=</span>&nbsp;<span class="op" id="5614886">(</span><span class="op" id="5614887">*</span><span class="ident" id="5614888">p</span><span class="op" id="5614889">)</span><span class="op" id="5614890">[</span><span class="ident" id="5614891">i</span><span class="op" id="5614892">]</span><span class="op" id="5614893">;</span>&nbsp;<span class="op" id="5614895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614899">case</span>&nbsp;<span class="ident" id="5614904">c</span>&nbsp;<span class="op" id="5614906">==</span>&nbsp;<span class="string" id="5614909">&#39;&#34;&#39;</span><span class="op" id="5614912">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614917">break</span>&nbsp;<span class="ident" id="5614923">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614930">case</span>&nbsp;<span class="ident" id="5614935">c</span>&nbsp;<span class="op" id="5614937">==</span>&nbsp;<span class="string" id="5614940">&#39;\\&#39;</span><span class="op" id="5614944">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614949">if</span>&nbsp;<span class="ident" id="5614952">i</span><span class="op" id="5614953">+</span><span class="num" id="5614954">1</span>&nbsp;<span class="op" id="5614956">==</span>&nbsp;<span class="ident" id="5614959">p</span><span class="op" id="5614960">.</span><span class="builtinfunc" id="5614961">len</span><span class="op" id="5614964">(</span><span class="op" id="5614965">)</span>&nbsp;<span class="op" id="5614967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5614973">return</span>&nbsp;<span class="string" id="5614980">&#34;&#34;</span><span class="op" id="5614982">,</span>&nbsp;<span class="ident" id="5614984">errors</span><span class="op" id="5614990">.</span><span class="ident" id="5614991">New</span><span class="op" id="5614994">(</span><span class="string" id="5614995">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5615025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615030">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615035">qsb</span>&nbsp;<span class="op" id="5615039">=</span>&nbsp;<span class="builtinfunc" id="5615041">append</span><span class="op" id="5615047">(</span><span class="ident" id="5615048">qsb</span><span class="op" id="5615051">,</span>&nbsp;<span class="op" id="5615053">(</span><span class="op" id="5615054">*</span><span class="ident" id="5615055">p</span><span class="op" id="5615056">)</span><span class="op" id="5615057">[</span><span class="ident" id="5615058">i</span><span class="op" id="5615059">+</span><span class="num" id="5615060">1</span><span class="op" id="5615061">]</span><span class="op" id="5615062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615067">i</span>&nbsp;<span class="op" id="5615069">+=</span>&nbsp;<span class="num" id="5615072">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615076">case</span>&nbsp;<span class="ident" id="5615081">isQtext</span><span class="op" id="5615088">(</span><span class="ident" id="5615089">c</span><span class="op" id="5615090">)</span><span class="op" id="5615091">,</span>&nbsp;<span class="ident" id="5615093">c</span>&nbsp;<span class="op" id="5615095">==</span>&nbsp;<span class="string" id="5615098">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5615102">||</span>&nbsp;<span class="ident" id="5615105">c</span>&nbsp;<span class="op" id="5615107">==</span>&nbsp;<span class="string" id="5615110">&#39;\t&#39;</span><span class="op" id="5615114">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615119">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5615174">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615214">qsb</span>&nbsp;<span class="op" id="5615218">=</span>&nbsp;<span class="builtinfunc" id="5615220">append</span><span class="op" id="5615226">(</span><span class="ident" id="5615227">qsb</span><span class="op" id="5615230">,</span>&nbsp;<span class="ident" id="5615232">c</span><span class="op" id="5615233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615238">i</span><span class="op" id="5615239">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615244">default</span><span class="op" id="5615251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615256">return</span>&nbsp;<span class="string" id="5615263">&#34;&#34;</span><span class="op" id="5615265">,</span>&nbsp;<span class="ident" id="5615267">fmt</span><span class="op" id="5615270">.</span><span class="ident" id="5615271">Errorf</span><span class="op" id="5615277">(</span><span class="string" id="5615278">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="5615320">,</span>&nbsp;<span class="ident" id="5615322">c</span><span class="op" id="5615323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615327">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615333">*</span><span class="ident" id="5615334">p</span>&nbsp;<span class="op" id="5615336">=</span>&nbsp;<span class="op" id="5615338">(</span><span class="op" id="5615339">*</span><span class="ident" id="5615340">p</span><span class="op" id="5615341">)</span><span class="op" id="5615342">[</span><span class="ident" id="5615343">i</span><span class="op" id="5615344">+</span><span class="num" id="5615345">1</span><span class="op" id="5615346">:</span><span class="op" id="5615347">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615350">return</span>&nbsp;<span class="builtintype" id="5615357">string</span><span class="op" id="5615363">(</span><span class="ident" id="5615364">qsb</span><span class="op" id="5615367">)</span><span class="op" id="5615368">,</span>&nbsp;<span class="ident" id="5615370">nil</span><br>
<span class="lineno"></span><span class="op" id="5615374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="5615377">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="5615435">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5615503">func</span>&nbsp;<span class="op" id="5615508">(</span><span class="ident" id="5615509">p</span>&nbsp;<span class="op" id="5615511">*</span><span class="ident" id="5615512">addrParser</span><span class="op" id="5615522">)</span>&nbsp;<span class="ident" id="5615524">consumeAtom</span><span class="op" id="5615535">(</span><span class="ident" id="5615536">dot</span>&nbsp;<span class="builtintype" id="5615540">bool</span><span class="op" id="5615544">)</span>&nbsp;<span class="op" id="5615546">(</span><span class="ident" id="5615547">atom</span>&nbsp;<span class="builtintype" id="5615552">string</span><span class="op" id="5615558">,</span>&nbsp;<span class="ident" id="5615560">err</span>&nbsp;<span class="builtintype" id="5615564">error</span><span class="op" id="5615569">)</span>&nbsp;<span class="op" id="5615571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615574">if</span>&nbsp;<span class="op" id="5615577">!</span><span class="ident" id="5615578">isAtext</span><span class="op" id="5615585">(</span><span class="ident" id="5615586">p</span><span class="op" id="5615587">.</span><span class="ident" id="5615588">peek</span><span class="op" id="5615592">(</span><span class="op" id="5615593">)</span><span class="op" id="5615594">,</span>&nbsp;<span class="builtintype" id="5615596">false</span><span class="op" id="5615601">)</span>&nbsp;<span class="op" id="5615603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615607">return</span>&nbsp;<span class="string" id="5615614">&#34;&#34;</span><span class="op" id="5615616">,</span>&nbsp;<span class="ident" id="5615618">errors</span><span class="op" id="5615624">.</span><span class="ident" id="5615625">New</span><span class="op" id="5615628">(</span><span class="string" id="5615629">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="5615651">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615657">i</span>&nbsp;<span class="op" id="5615659">:=</span>&nbsp;<span class="num" id="5615662">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615665">for</span>&nbsp;<span class="op" id="5615669">;</span>&nbsp;<span class="ident" id="5615671">i</span>&nbsp;<span class="op" id="5615673">&lt;</span>&nbsp;<span class="ident" id="5615675">p</span><span class="op" id="5615676">.</span><span class="builtinfunc" id="5615677">len</span><span class="op" id="5615680">(</span><span class="op" id="5615681">)</span>&nbsp;<span class="op" id="5615683">&amp;&amp;</span>&nbsp;<span class="ident" id="5615686">isAtext</span><span class="op" id="5615693">(</span><span class="op" id="5615694">(</span><span class="op" id="5615695">*</span><span class="ident" id="5615696">p</span><span class="op" id="5615697">)</span><span class="op" id="5615698">[</span><span class="ident" id="5615699">i</span><span class="op" id="5615700">]</span><span class="op" id="5615701">,</span>&nbsp;<span class="ident" id="5615703">dot</span><span class="op" id="5615706">)</span><span class="op" id="5615707">;</span>&nbsp;<span class="ident" id="5615709">i</span><span class="op" id="5615710">++</span>&nbsp;<span class="op" id="5615713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5615719">atom</span><span class="op" id="5615723">,</span>&nbsp;<span class="op" id="5615725">*</span><span class="ident" id="5615726">p</span>&nbsp;<span class="op" id="5615728">=</span>&nbsp;<span class="builtintype" id="5615730">string</span><span class="op" id="5615736">(</span><span class="op" id="5615737">(</span><span class="op" id="5615738">*</span><span class="ident" id="5615739">p</span><span class="op" id="5615740">)</span><span class="op" id="5615741">[</span><span class="op" id="5615742">:</span><span class="ident" id="5615743">i</span><span class="op" id="5615744">]</span><span class="op" id="5615745">)</span><span class="op" id="5615746">,</span>&nbsp;<span class="op" id="5615748">(</span><span class="op" id="5615749">*</span><span class="ident" id="5615750">p</span><span class="op" id="5615751">)</span><span class="op" id="5615752">[</span><span class="ident" id="5615753">i</span><span class="op" id="5615754">:</span><span class="op" id="5615755">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615758">return</span>&nbsp;<span class="ident" id="5615765">atom</span><span class="op" id="5615769">,</span>&nbsp;<span class="ident" id="5615771">nil</span><br>
<span class="lineno"></span><span class="op" id="5615775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5615778">func</span>&nbsp;<span class="op" id="5615783">(</span><span class="ident" id="5615784">p</span>&nbsp;<span class="op" id="5615786">*</span><span class="ident" id="5615787">addrParser</span><span class="op" id="5615797">)</span>&nbsp;<span class="ident" id="5615799">consume</span><span class="op" id="5615806">(</span><span class="ident" id="5615807">c</span>&nbsp;<span class="builtintype" id="5615809">byte</span><span class="op" id="5615813">)</span>&nbsp;<span class="builtintype" id="5615815">bool</span>&nbsp;<span class="op" id="5615820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615823">if</span>&nbsp;<span class="ident" id="5615826">p</span><span class="op" id="5615827">.</span><span class="ident" id="5615828">empty</span><span class="op" id="5615833">(</span><span class="op" id="5615834">)</span>&nbsp;<span class="op" id="5615836">||</span>&nbsp;<span class="ident" id="5615839">p</span><span class="op" id="5615840">.</span><span class="ident" id="5615841">peek</span><span class="op" id="5615845">(</span><span class="op" id="5615846">)</span>&nbsp;<span class="op" id="5615848">!=</span>&nbsp;<span class="ident" id="5615851">c</span>&nbsp;<span class="op" id="5615853">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615857">return</span>&nbsp;<span class="builtintype" id="5615864">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615874">*</span><span class="ident" id="5615875">p</span>&nbsp;<span class="op" id="5615877">=</span>&nbsp;<span class="op" id="5615879">(</span><span class="op" id="5615880">*</span><span class="ident" id="5615881">p</span><span class="op" id="5615882">)</span><span class="op" id="5615883">[</span><span class="num" id="5615884">1</span><span class="op" id="5615885">:</span><span class="op" id="5615886">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5615889">return</span>&nbsp;<span class="builtintype" id="5615896">true</span><br>
<span class="lineno"></span><span class="op" id="5615901">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="5615904">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="5615961">func</span>&nbsp;<span class="op" id="5615966">(</span><span class="ident" id="5615967">p</span>&nbsp;<span class="op" id="5615969">*</span><span class="ident" id="5615970">addrParser</span><span class="op" id="5615980">)</span>&nbsp;<span class="ident" id="5615982">skipSpace</span><span class="op" id="5615991">(</span><span class="op" id="5615992">)</span>&nbsp;<span class="op" id="5615994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5615997">*</span><span class="ident" id="5615998">p</span>&nbsp;<span class="op" id="5616000">=</span>&nbsp;<span class="ident" id="5616002">bytes</span><span class="op" id="5616007">.</span><span class="ident" id="5616008">TrimLeft</span><span class="op" id="5616016">(</span><span class="op" id="5616017">*</span><span class="ident" id="5616018">p</span><span class="op" id="5616019">,</span>&nbsp;<span class="string" id="5616021">&#34;&nbsp;\t&#34;</span><span class="op" id="5616026">)</span><br>
<span class="lineno"></span><span class="op" id="5616028">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5616031">func</span>&nbsp;<span class="op" id="5616036">(</span><span class="ident" id="5616037">p</span>&nbsp;<span class="op" id="5616039">*</span><span class="ident" id="5616040">addrParser</span><span class="op" id="5616050">)</span>&nbsp;<span class="ident" id="5616052">peek</span><span class="op" id="5616056">(</span><span class="op" id="5616057">)</span>&nbsp;<span class="builtintype" id="5616059">byte</span>&nbsp;<span class="op" id="5616064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616067">return</span>&nbsp;<span class="op" id="5616074">(</span><span class="op" id="5616075">*</span><span class="ident" id="5616076">p</span><span class="op" id="5616077">)</span><span class="op" id="5616078">[</span><span class="num" id="5616079">0</span><span class="op" id="5616080">]</span><br>
<span class="lineno"></span><span class="op" id="5616082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="5616085">func</span>&nbsp;<span class="op" id="5616090">(</span><span class="ident" id="5616091">p</span>&nbsp;<span class="op" id="5616093">*</span><span class="ident" id="5616094">addrParser</span><span class="op" id="5616104">)</span>&nbsp;<span class="ident" id="5616106">empty</span><span class="op" id="5616111">(</span><span class="op" id="5616112">)</span>&nbsp;<span class="builtintype" id="5616114">bool</span>&nbsp;<span class="op" id="5616119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616122">return</span>&nbsp;<span class="ident" id="5616129">p</span><span class="op" id="5616130">.</span><span class="builtinfunc" id="5616131">len</span><span class="op" id="5616134">(</span><span class="op" id="5616135">)</span>&nbsp;<span class="op" id="5616137">==</span>&nbsp;<span class="num" id="5616140">0</span><br>
<span class="lineno"></span><span class="op" id="5616142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5616145">func</span>&nbsp;<span class="op" id="5616150">(</span><span class="ident" id="5616151">p</span>&nbsp;<span class="op" id="5616153">*</span><span class="ident" id="5616154">addrParser</span><span class="op" id="5616164">)</span>&nbsp;<span class="builtinfunc" id="5616166">len</span><span class="op" id="5616169">(</span><span class="op" id="5616170">)</span>&nbsp;<span class="builtintype" id="5616172">int</span>&nbsp;<span class="op" id="5616176">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616179">return</span>&nbsp;<span class="builtinfunc" id="5616186">len</span><span class="op" id="5616189">(</span><span class="op" id="5616190">*</span><span class="ident" id="5616191">p</span><span class="op" id="5616192">)</span><br>
<span class="lineno"></span><span class="op" id="5616194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5616197">func</span>&nbsp;<span class="ident" id="5616202">decodeRFC2047Word</span><span class="op" id="5616219">(</span><span class="ident" id="5616220">s</span>&nbsp;<span class="builtintype" id="5616222">string</span><span class="op" id="5616228">)</span>&nbsp;<span class="op" id="5616230">(</span><span class="builtintype" id="5616231">string</span><span class="op" id="5616237">,</span>&nbsp;<span class="builtintype" id="5616239">error</span><span class="op" id="5616244">)</span>&nbsp;<span class="op" id="5616246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616249">fields</span>&nbsp;<span class="op" id="5616256">:=</span>&nbsp;<span class="ident" id="5616259">strings</span><span class="op" id="5616266">.</span><span class="ident" id="5616267">Split</span><span class="op" id="5616272">(</span><span class="ident" id="5616273">s</span><span class="op" id="5616274">,</span>&nbsp;<span class="string" id="5616276">&#34;?&#34;</span><span class="op" id="5616279">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616282">if</span>&nbsp;<span class="builtinfunc" id="5616285">len</span><span class="op" id="5616288">(</span><span class="ident" id="5616289">fields</span><span class="op" id="5616295">)</span>&nbsp;<span class="op" id="5616297">!=</span>&nbsp;<span class="num" id="5616300">5</span>&nbsp;<span class="op" id="5616302">||</span>&nbsp;<span class="ident" id="5616305">fields</span><span class="op" id="5616311">[</span><span class="num" id="5616312">0</span><span class="op" id="5616313">]</span>&nbsp;<span class="op" id="5616315">!=</span>&nbsp;<span class="string" id="5616318">&#34;=&#34;</span>&nbsp;<span class="op" id="5616322">||</span>&nbsp;<span class="ident" id="5616325">fields</span><span class="op" id="5616331">[</span><span class="num" id="5616332">4</span><span class="op" id="5616333">]</span>&nbsp;<span class="op" id="5616335">!=</span>&nbsp;<span class="string" id="5616338">&#34;=&#34;</span>&nbsp;<span class="op" id="5616342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616346">return</span>&nbsp;<span class="string" id="5616353">&#34;&#34;</span><span class="op" id="5616355">,</span>&nbsp;<span class="ident" id="5616357">errors</span><span class="op" id="5616363">.</span><span class="ident" id="5616364">New</span><span class="op" id="5616367">(</span><span class="string" id="5616368">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="5616398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616404">charset</span><span class="op" id="5616411">,</span>&nbsp;<span class="ident" id="5616413">enc</span>&nbsp;<span class="op" id="5616417">:=</span>&nbsp;<span class="ident" id="5616420">strings</span><span class="op" id="5616427">.</span><span class="ident" id="5616428">ToLower</span><span class="op" id="5616435">(</span><span class="ident" id="5616436">fields</span><span class="op" id="5616442">[</span><span class="num" id="5616443">1</span><span class="op" id="5616444">]</span><span class="op" id="5616445">)</span><span class="op" id="5616446">,</span>&nbsp;<span class="ident" id="5616448">strings</span><span class="op" id="5616455">.</span><span class="ident" id="5616456">ToLower</span><span class="op" id="5616463">(</span><span class="ident" id="5616464">fields</span><span class="op" id="5616470">[</span><span class="num" id="5616471">2</span><span class="op" id="5616472">]</span><span class="op" id="5616473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616476">if</span>&nbsp;<span class="ident" id="5616479">charset</span>&nbsp;<span class="op" id="5616487">!=</span>&nbsp;<span class="string" id="5616490">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="5616501">&amp;&amp;</span>&nbsp;<span class="ident" id="5616504">charset</span>&nbsp;<span class="op" id="5616512">!=</span>&nbsp;<span class="string" id="5616515">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="5616528">&amp;&amp;</span>&nbsp;<span class="ident" id="5616531">charset</span>&nbsp;<span class="op" id="5616539">!=</span>&nbsp;<span class="string" id="5616542">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="5616550">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616554">return</span>&nbsp;<span class="string" id="5616561">&#34;&#34;</span><span class="op" id="5616563">,</span>&nbsp;<span class="ident" id="5616565">fmt</span><span class="op" id="5616568">.</span><span class="ident" id="5616569">Errorf</span><span class="op" id="5616575">(</span><span class="string" id="5616576">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5616603">,</span>&nbsp;<span class="ident" id="5616605">charset</span><span class="op" id="5616612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616619">in</span>&nbsp;<span class="op" id="5616622">:=</span>&nbsp;<span class="ident" id="5616625">bytes</span><span class="op" id="5616630">.</span><span class="ident" id="5616631">NewBufferString</span><span class="op" id="5616646">(</span><span class="ident" id="5616647">fields</span><span class="op" id="5616653">[</span><span class="num" id="5616654">3</span><span class="op" id="5616655">]</span><span class="op" id="5616656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616659">var</span>&nbsp;<span class="ident" id="5616663">r</span>&nbsp;<span class="ident" id="5616665">io</span><span class="op" id="5616667">.</span><span class="ident" id="5616668">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616676">switch</span>&nbsp;<span class="ident" id="5616683">enc</span>&nbsp;<span class="op" id="5616687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616690">case</span>&nbsp;<span class="string" id="5616695">&#34;b&#34;</span><span class="op" id="5616698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616702">r</span>&nbsp;<span class="op" id="5616704">=</span>&nbsp;<span class="ident" id="5616706">base64</span><span class="op" id="5616712">.</span><span class="ident" id="5616713">NewDecoder</span><span class="op" id="5616723">(</span><span class="ident" id="5616724">base64</span><span class="op" id="5616730">.</span><span class="ident" id="5616731">StdEncoding</span><span class="op" id="5616742">,</span>&nbsp;<span class="ident" id="5616744">in</span><span class="op" id="5616746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616749">case</span>&nbsp;<span class="string" id="5616754">&#34;q&#34;</span><span class="op" id="5616757">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616761">r</span>&nbsp;<span class="op" id="5616763">=</span>&nbsp;<span class="ident" id="5616765">qDecoder</span><span class="op" id="5616773">{</span><span class="ident" id="5616774">r</span><span class="op" id="5616775">:</span>&nbsp;<span class="ident" id="5616777">in</span><span class="op" id="5616779">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616782">default</span><span class="op" id="5616789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616793">return</span>&nbsp;<span class="string" id="5616800">&#34;&#34;</span><span class="op" id="5616802">,</span>&nbsp;<span class="ident" id="5616804">fmt</span><span class="op" id="5616807">.</span><span class="ident" id="5616808">Errorf</span><span class="op" id="5616814">(</span><span class="string" id="5616815">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5616852">,</span>&nbsp;<span class="ident" id="5616854">enc</span><span class="op" id="5616857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616864">dec</span><span class="op" id="5616867">,</span>&nbsp;<span class="ident" id="5616869">err</span>&nbsp;<span class="op" id="5616873">:=</span>&nbsp;<span class="ident" id="5616876">ioutil</span><span class="op" id="5616882">.</span><span class="ident" id="5616883">ReadAll</span><span class="op" id="5616890">(</span><span class="ident" id="5616891">r</span><span class="op" id="5616892">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616895">if</span>&nbsp;<span class="ident" id="5616898">err</span>&nbsp;<span class="op" id="5616902">!=</span>&nbsp;<span class="ident" id="5616905">nil</span>&nbsp;<span class="op" id="5616909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616913">return</span>&nbsp;<span class="string" id="5616920">&#34;&#34;</span><span class="op" id="5616922">,</span>&nbsp;<span class="ident" id="5616924">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5616929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616933">switch</span>&nbsp;<span class="ident" id="5616940">charset</span>&nbsp;<span class="op" id="5616948">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616951">case</span>&nbsp;<span class="string" id="5616956">&#34;us-ascii&#34;</span><span class="op" id="5616966">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5616970">b</span>&nbsp;<span class="op" id="5616972">:=</span>&nbsp;<span class="builtinfunc" id="5616975">new</span><span class="op" id="5616978">(</span><span class="ident" id="5616979">bytes</span><span class="op" id="5616984">.</span><span class="ident" id="5616985">Buffer</span><span class="op" id="5616991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5616995">for</span>&nbsp;<span class="ident" id="5616999">_</span><span class="op" id="5617000">,</span>&nbsp;<span class="ident" id="5617002">c</span>&nbsp;<span class="op" id="5617004">:=</span>&nbsp;<span class="keyword" id="5617007">range</span>&nbsp;<span class="ident" id="5617013">dec</span>&nbsp;<span class="op" id="5617017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617022">if</span>&nbsp;<span class="ident" id="5617025">c</span>&nbsp;<span class="op" id="5617027">&gt;=</span>&nbsp;<span class="num" id="5617030">0x80</span>&nbsp;<span class="op" id="5617035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617041">b</span><span class="op" id="5617042">.</span><span class="ident" id="5617043">WriteRune</span><span class="op" id="5617052">(</span><span class="ident" id="5617053">unicode</span><span class="op" id="5617060">.</span><span class="ident" id="5617061">ReplacementChar</span><span class="op" id="5617076">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617081">}</span>&nbsp;<span class="keyword" id="5617083">else</span>&nbsp;<span class="op" id="5617088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617094">b</span><span class="op" id="5617095">.</span><span class="ident" id="5617096">WriteRune</span><span class="op" id="5617105">(</span><span class="builtintype" id="5617106">rune</span><span class="op" id="5617110">(</span><span class="ident" id="5617111">c</span><span class="op" id="5617112">)</span><span class="op" id="5617113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617126">return</span>&nbsp;<span class="ident" id="5617133">b</span><span class="op" id="5617134">.</span><span class="ident" id="5617135">String</span><span class="op" id="5617141">(</span><span class="op" id="5617142">)</span><span class="op" id="5617143">,</span>&nbsp;<span class="ident" id="5617145">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617150">case</span>&nbsp;<span class="string" id="5617155">&#34;iso-8859-1&#34;</span><span class="op" id="5617167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617171">b</span>&nbsp;<span class="op" id="5617173">:=</span>&nbsp;<span class="builtinfunc" id="5617176">new</span><span class="op" id="5617179">(</span><span class="ident" id="5617180">bytes</span><span class="op" id="5617185">.</span><span class="ident" id="5617186">Buffer</span><span class="op" id="5617192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617196">for</span>&nbsp;<span class="ident" id="5617200">_</span><span class="op" id="5617201">,</span>&nbsp;<span class="ident" id="5617203">c</span>&nbsp;<span class="op" id="5617205">:=</span>&nbsp;<span class="keyword" id="5617208">range</span>&nbsp;<span class="ident" id="5617214">dec</span>&nbsp;<span class="op" id="5617218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617223">b</span><span class="op" id="5617224">.</span><span class="ident" id="5617225">WriteRune</span><span class="op" id="5617234">(</span><span class="builtintype" id="5617235">rune</span><span class="op" id="5617239">(</span><span class="ident" id="5617240">c</span><span class="op" id="5617241">)</span><span class="op" id="5617242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617246">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617250">return</span>&nbsp;<span class="ident" id="5617257">b</span><span class="op" id="5617258">.</span><span class="ident" id="5617259">String</span><span class="op" id="5617265">(</span><span class="op" id="5617266">)</span><span class="op" id="5617267">,</span>&nbsp;<span class="ident" id="5617269">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617274">case</span>&nbsp;<span class="string" id="5617279">&#34;utf-8&#34;</span><span class="op" id="5617286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617290">return</span>&nbsp;<span class="builtintype" id="5617297">string</span><span class="op" id="5617303">(</span><span class="ident" id="5617304">dec</span><span class="op" id="5617307">)</span><span class="op" id="5617308">,</span>&nbsp;<span class="ident" id="5617310">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5617318">panic</span><span class="op" id="5617323">(</span><span class="string" id="5617324">&#34;unreachable&#34;</span><span class="op" id="5617337">)</span><br>
<span class="lineno">490</span><span class="op" id="5617339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617342">type</span>&nbsp;<span class="ident" id="5617347">qDecoder</span>&nbsp;<span class="keyword" id="5617356">struct</span>&nbsp;<span class="op" id="5617363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617366">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5617374">io</span><span class="op" id="5617376">.</span><span class="ident" id="5617377">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617385">scratch</span>&nbsp;<span class="op" id="5617393">[</span><span class="num" id="5617394">2</span><span class="op" id="5617395">]</span><span class="builtintype" id="5617396">byte</span><br>
<span class="lineno">495</span><span class="op" id="5617401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617404">func</span>&nbsp;<span class="op" id="5617409">(</span><span class="ident" id="5617410">qd</span>&nbsp;<span class="ident" id="5617413">qDecoder</span><span class="op" id="5617421">)</span>&nbsp;<span class="ident" id="5617423">Read</span><span class="op" id="5617427">(</span><span class="ident" id="5617428">p</span>&nbsp;<span class="op" id="5617430">[</span><span class="op" id="5617431">]</span><span class="builtintype" id="5617432">byte</span><span class="op" id="5617436">)</span>&nbsp;<span class="op" id="5617438">(</span><span class="ident" id="5617439">n</span>&nbsp;<span class="builtintype" id="5617441">int</span><span class="op" id="5617444">,</span>&nbsp;<span class="ident" id="5617446">err</span>&nbsp;<span class="builtintype" id="5617450">error</span><span class="op" id="5617455">)</span>&nbsp;<span class="op" id="5617457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5617460">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617508">if</span>&nbsp;<span class="builtinfunc" id="5617511">len</span><span class="op" id="5617514">(</span><span class="ident" id="5617515">p</span><span class="op" id="5617516">)</span>&nbsp;<span class="op" id="5617518">==</span>&nbsp;<span class="num" id="5617521">0</span>&nbsp;<span class="op" id="5617523">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617527">return</span>&nbsp;<span class="num" id="5617534">0</span><span class="op" id="5617535">,</span>&nbsp;<span class="ident" id="5617537">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617545">if</span>&nbsp;<span class="ident" id="5617548">_</span><span class="op" id="5617549">,</span>&nbsp;<span class="ident" id="5617551">err</span>&nbsp;<span class="op" id="5617555">:=</span>&nbsp;<span class="ident" id="5617558">qd</span><span class="op" id="5617560">.</span><span class="ident" id="5617561">r</span><span class="op" id="5617562">.</span><span class="ident" id="5617563">Read</span><span class="op" id="5617567">(</span><span class="ident" id="5617568">qd</span><span class="op" id="5617570">.</span><span class="ident" id="5617571">scratch</span><span class="op" id="5617578">[</span><span class="op" id="5617579">:</span><span class="num" id="5617580">1</span><span class="op" id="5617581">]</span><span class="op" id="5617582">)</span><span class="op" id="5617583">;</span>&nbsp;<span class="ident" id="5617585">err</span>&nbsp;<span class="op" id="5617589">!=</span>&nbsp;<span class="ident" id="5617592">nil</span>&nbsp;<span class="op" id="5617596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617600">return</span>&nbsp;<span class="num" id="5617607">0</span><span class="op" id="5617608">,</span>&nbsp;<span class="ident" id="5617610">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617615">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617618">switch</span>&nbsp;<span class="ident" id="5617625">c</span>&nbsp;<span class="op" id="5617627">:=</span>&nbsp;<span class="ident" id="5617630">qd</span><span class="op" id="5617632">.</span><span class="ident" id="5617633">scratch</span><span class="op" id="5617640">[</span><span class="num" id="5617641">0</span><span class="op" id="5617642">]</span><span class="op" id="5617643">;</span>&nbsp;<span class="op" id="5617645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617648">case</span>&nbsp;<span class="ident" id="5617653">c</span>&nbsp;<span class="op" id="5617655">==</span>&nbsp;<span class="string" id="5617658">&#39;=&#39;</span><span class="op" id="5617661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617665">if</span>&nbsp;<span class="ident" id="5617668">_</span><span class="op" id="5617669">,</span>&nbsp;<span class="ident" id="5617671">err</span>&nbsp;<span class="op" id="5617675">:=</span>&nbsp;<span class="ident" id="5617678">io</span><span class="op" id="5617680">.</span><span class="ident" id="5617681">ReadFull</span><span class="op" id="5617689">(</span><span class="ident" id="5617690">qd</span><span class="op" id="5617692">.</span><span class="ident" id="5617693">r</span><span class="op" id="5617694">,</span>&nbsp;<span class="ident" id="5617696">qd</span><span class="op" id="5617698">.</span><span class="ident" id="5617699">scratch</span><span class="op" id="5617706">[</span><span class="op" id="5617707">:</span><span class="num" id="5617708">2</span><span class="op" id="5617709">]</span><span class="op" id="5617710">)</span><span class="op" id="5617711">;</span>&nbsp;<span class="ident" id="5617713">err</span>&nbsp;<span class="op" id="5617717">!=</span>&nbsp;<span class="ident" id="5617720">nil</span>&nbsp;<span class="op" id="5617724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617729">return</span>&nbsp;<span class="num" id="5617736">0</span><span class="op" id="5617737">,</span>&nbsp;<span class="ident" id="5617739">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617745">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617749">x</span><span class="op" id="5617750">,</span>&nbsp;<span class="ident" id="5617752">err</span>&nbsp;<span class="op" id="5617756">:=</span>&nbsp;<span class="ident" id="5617759">strconv</span><span class="op" id="5617766">.</span><span class="ident" id="5617767">ParseInt</span><span class="op" id="5617775">(</span><span class="builtintype" id="5617776">string</span><span class="op" id="5617782">(</span><span class="ident" id="5617783">qd</span><span class="op" id="5617785">.</span><span class="ident" id="5617786">scratch</span><span class="op" id="5617793">[</span><span class="op" id="5617794">:</span><span class="num" id="5617795">2</span><span class="op" id="5617796">]</span><span class="op" id="5617797">)</span><span class="op" id="5617798">,</span>&nbsp;<span class="num" id="5617800">16</span><span class="op" id="5617802">,</span>&nbsp;<span class="num" id="5617804">64</span><span class="op" id="5617806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617810">if</span>&nbsp;<span class="ident" id="5617813">err</span>&nbsp;<span class="op" id="5617817">!=</span>&nbsp;<span class="ident" id="5617820">nil</span>&nbsp;<span class="op" id="5617824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617829">return</span>&nbsp;<span class="num" id="5617836">0</span><span class="op" id="5617837">,</span>&nbsp;<span class="ident" id="5617839">fmt</span><span class="op" id="5617842">.</span><span class="ident" id="5617843">Errorf</span><span class="op" id="5617849">(</span><span class="string" id="5617850">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="5617887">,</span>&nbsp;<span class="ident" id="5617889">qd</span><span class="op" id="5617891">.</span><span class="ident" id="5617892">scratch</span><span class="op" id="5617899">[</span><span class="op" id="5617900">:</span><span class="num" id="5617901">2</span><span class="op" id="5617902">]</span><span class="op" id="5617903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617911">p</span><span class="op" id="5617912">[</span><span class="num" id="5617913">0</span><span class="op" id="5617914">]</span>&nbsp;<span class="op" id="5617916">=</span>&nbsp;<span class="builtintype" id="5617918">byte</span><span class="op" id="5617922">(</span><span class="ident" id="5617923">x</span><span class="op" id="5617924">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617927">case</span>&nbsp;<span class="ident" id="5617932">c</span>&nbsp;<span class="op" id="5617934">==</span>&nbsp;<span class="string" id="5617937">&#39;_&#39;</span><span class="op" id="5617940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617944">p</span><span class="op" id="5617945">[</span><span class="num" id="5617946">0</span><span class="op" id="5617947">]</span>&nbsp;<span class="op" id="5617949">=</span>&nbsp;<span class="string" id="5617951">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617956">default</span><span class="op" id="5617963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5617967">p</span><span class="op" id="5617968">[</span><span class="num" id="5617969">0</span><span class="op" id="5617970">]</span>&nbsp;<span class="op" id="5617972">=</span>&nbsp;<span class="ident" id="5617974">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5617977">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5617980">return</span>&nbsp;<span class="num" id="5617987">1</span><span class="op" id="5617988">,</span>&nbsp;<span class="ident" id="5617990">nil</span><br>
<span class="lineno"></span><span class="op" id="5617994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5617997">var</span>&nbsp;<span class="ident" id="5618001">atextChars</span>&nbsp;<span class="op" id="5618012">=</span>&nbsp;<span class="op" id="5618014">[</span><span class="op" id="5618015">]</span><span class="builtintype" id="5618016">byte</span><span class="op" id="5618020">(</span><span class="string" id="5618021">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="5618050">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618053">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="5618082">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618085">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="5618098">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618101">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="5618122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618125">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5618186">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="5618225">func</span>&nbsp;<span class="ident" id="5618230">isAtext</span><span class="op" id="5618237">(</span><span class="ident" id="5618238">c</span>&nbsp;<span class="builtintype" id="5618240">byte</span><span class="op" id="5618244">,</span>&nbsp;<span class="ident" id="5618246">dot</span>&nbsp;<span class="builtintype" id="5618250">bool</span><span class="op" id="5618254">)</span>&nbsp;<span class="builtintype" id="5618256">bool</span>&nbsp;<span class="op" id="5618261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618264">if</span>&nbsp;<span class="ident" id="5618267">dot</span>&nbsp;<span class="op" id="5618271">&amp;&amp;</span>&nbsp;<span class="ident" id="5618274">c</span>&nbsp;<span class="op" id="5618276">==</span>&nbsp;<span class="string" id="5618279">&#39;.&#39;</span>&nbsp;<span class="op" id="5618283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618287">return</span>&nbsp;<span class="builtintype" id="5618294">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618303">return</span>&nbsp;<span class="ident" id="5618310">bytes</span><span class="op" id="5618315">.</span><span class="ident" id="5618316">IndexByte</span><span class="op" id="5618325">(</span><span class="ident" id="5618326">atextChars</span><span class="op" id="5618336">,</span>&nbsp;<span class="ident" id="5618338">c</span><span class="op" id="5618339">)</span>&nbsp;<span class="op" id="5618341">&gt;=</span>&nbsp;<span class="num" id="5618344">0</span><br>
<span class="lineno">535</span><span class="op" id="5618346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618349">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5618410">func</span>&nbsp;<span class="ident" id="5618415">isQtext</span><span class="op" id="5618422">(</span><span class="ident" id="5618423">c</span>&nbsp;<span class="builtintype" id="5618425">byte</span><span class="op" id="5618429">)</span>&nbsp;<span class="builtintype" id="5618431">bool</span>&nbsp;<span class="op" id="5618436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618439">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618493">if</span>&nbsp;<span class="ident" id="5618496">c</span>&nbsp;<span class="op" id="5618498">==</span>&nbsp;<span class="string" id="5618501">&#39;\\&#39;</span>&nbsp;<span class="op" id="5618506">||</span>&nbsp;<span class="ident" id="5618509">c</span>&nbsp;<span class="op" id="5618511">==</span>&nbsp;<span class="string" id="5618514">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5618518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618522">return</span>&nbsp;<span class="builtintype" id="5618529">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618539">return</span>&nbsp;<span class="string" id="5618546">&#39;!&#39;</span>&nbsp;<span class="op" id="5618550">&lt;=</span>&nbsp;<span class="ident" id="5618553">c</span>&nbsp;<span class="op" id="5618555">&amp;&amp;</span>&nbsp;<span class="ident" id="5618558">c</span>&nbsp;<span class="op" id="5618560">&lt;=</span>&nbsp;<span class="string" id="5618563">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="5618567">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="5618570">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5618631">func</span>&nbsp;<span class="ident" id="5618636">isVchar</span><span class="op" id="5618643">(</span><span class="ident" id="5618644">c</span>&nbsp;<span class="builtintype" id="5618646">byte</span><span class="op" id="5618650">)</span>&nbsp;<span class="builtintype" id="5618652">bool</span>&nbsp;<span class="op" id="5618657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618660">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618695">return</span>&nbsp;<span class="string" id="5618702">&#39;!&#39;</span>&nbsp;<span class="op" id="5618706">&lt;=</span>&nbsp;<span class="ident" id="5618709">c</span>&nbsp;<span class="op" id="5618711">&amp;&amp;</span>&nbsp;<span class="ident" id="5618714">c</span>&nbsp;<span class="op" id="5618716">&lt;=</span>&nbsp;<span class="string" id="5618719">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="5618723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618726">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="5618777">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="5618835">func</span>&nbsp;<span class="ident" id="5618840">isWSP</span><span class="op" id="5618845">(</span><span class="ident" id="5618846">c</span>&nbsp;<span class="builtintype" id="5618848">byte</span><span class="op" id="5618852">)</span>&nbsp;<span class="builtintype" id="5618854">bool</span>&nbsp;<span class="op" id="5618859">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618862">return</span>&nbsp;<span class="ident" id="5618869">c</span>&nbsp;<span class="op" id="5618871">==</span>&nbsp;<span class="string" id="5618874">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5618878">||</span>&nbsp;<span class="ident" id="5618881">c</span>&nbsp;<span class="op" id="5618883">==</span>&nbsp;<span class="string" id="5618886">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="5618891">}</span>
</div>
</body>
</html>
