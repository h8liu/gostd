<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html" class="current">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6866973">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6867028">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6867082">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6867133">package</span>&nbsp;<span class="ident" id="6867141">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6867146">import</span>&nbsp;<span class="op" id="6867153">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867156">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867179">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867189">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867196">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867202">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867209">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867217">&#34;strconv&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867228">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867239">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867247">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6867258">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6867265">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6867268">var</span>&nbsp;<span class="ident" id="6867272">_</span>&nbsp;<span class="op" id="6867274">=</span>&nbsp;<span class="ident" id="6867276">log</span><span class="op" id="6867279">.</span><span class="ident" id="6867280">Printf</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6867288">//&nbsp;fakeDriver&nbsp;is&nbsp;a&nbsp;fake&nbsp;database&nbsp;that&nbsp;implements&nbsp;Go&#39;s&nbsp;driver.Driver</span><br>
<span class="lineno"></span><span class="comment" id="6867356">//&nbsp;interface,&nbsp;just&nbsp;for&nbsp;testing.</span><br>
<span class="lineno">25</span><span class="comment" id="6867388">//</span><br>
<span class="lineno"></span><span class="comment" id="6867391">//&nbsp;It&nbsp;speaks&nbsp;a&nbsp;query&nbsp;language&nbsp;that&#39;s&nbsp;semantically&nbsp;similar&nbsp;to&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="6867456">//&nbsp;syntactically&nbsp;different&nbsp;and&nbsp;simpler&nbsp;than&nbsp;SQL.&nbsp;&nbsp;The&nbsp;syntax&nbsp;is&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="6867523">//&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="6867535">//</span><br>
<span class="lineno">30</span><span class="comment" id="6867538">//&nbsp;&nbsp;&nbsp;WIPE</span><br>
<span class="lineno"></span><span class="comment" id="6867548">//&nbsp;&nbsp;&nbsp;CREATE|&lt;tablename&gt;|&lt;col&gt;=&lt;type&gt;,&lt;col&gt;=&lt;type&gt;,...</span><br>
<span class="lineno"></span><span class="comment" id="6867602">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;types&nbsp;are:&nbsp;&#34;string&#34;,&nbsp;[u]int{8,16,32,64},&nbsp;&#34;bool&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6867663">//&nbsp;&nbsp;&nbsp;INSERT|&lt;tablename&gt;|col=val,col2=val2,col3=?</span><br>
<span class="lineno"></span><span class="comment" id="6867712">//&nbsp;&nbsp;&nbsp;SELECT|&lt;tablename&gt;|projectcol1,projectcol2|filtercol=?,filtercol2=?</span><br>
<span class="lineno">35</span><span class="comment" id="6867785">//</span><br>
<span class="lineno"></span><span class="comment" id="6867788">//&nbsp;When&nbsp;opening&nbsp;a&nbsp;fakeDriver&#39;s&nbsp;database,&nbsp;it&nbsp;starts&nbsp;empty&nbsp;with&nbsp;no</span><br>
<span class="lineno"></span><span class="comment" id="6867853">//&nbsp;tables.&nbsp;&nbsp;All&nbsp;tables&nbsp;and&nbsp;data&nbsp;are&nbsp;stored&nbsp;in&nbsp;memory&nbsp;only.</span><br>
<span class="lineno"></span><span class="keyword" id="6867912">type</span>&nbsp;<span class="ident" id="6867917">fakeDriver</span>&nbsp;<span class="keyword" id="6867928">struct</span>&nbsp;<span class="op" id="6867935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867938">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6867949">sync</span><span class="op" id="6867953">.</span><span class="ident" id="6867954">Mutex</span>&nbsp;<span class="comment" id="6867960">//&nbsp;guards&nbsp;3&nbsp;following&nbsp;fields</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6867990">openCount</span>&nbsp;&nbsp;<span class="builtintype" id="6868001">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6868012">//&nbsp;conn&nbsp;opens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868027">closeCount</span>&nbsp;<span class="builtintype" id="6868038">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6868049">//&nbsp;conn&nbsp;closes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868065">waitCh</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6868076">chan</span>&nbsp;<span class="keyword" id="6868081">struct</span><span class="op" id="6868087">{</span><span class="op" id="6868088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868091">waitingCh</span>&nbsp;&nbsp;<span class="keyword" id="6868102">chan</span>&nbsp;<span class="keyword" id="6868107">struct</span><span class="op" id="6868113">{</span><span class="op" id="6868114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868117">dbs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6868128">map</span><span class="op" id="6868131">[</span><span class="builtintype" id="6868132">string</span><span class="op" id="6868138">]</span><span class="op" id="6868139">*</span><span class="ident" id="6868140">fakeDB</span><br>
<span class="lineno">45</span><span class="op" id="6868147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6868150">type</span>&nbsp;<span class="ident" id="6868155">fakeDB</span>&nbsp;<span class="keyword" id="6868162">struct</span>&nbsp;<span class="op" id="6868169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868172">name</span>&nbsp;<span class="builtintype" id="6868177">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868186">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6868194">sync</span><span class="op" id="6868198">.</span><span class="ident" id="6868199">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868206">free</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6868214">[</span><span class="op" id="6868215">]</span><span class="op" id="6868216">*</span><span class="ident" id="6868217">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868227">tables</span>&nbsp;&nbsp;<span class="keyword" id="6868235">map</span><span class="op" id="6868238">[</span><span class="builtintype" id="6868239">string</span><span class="op" id="6868245">]</span><span class="op" id="6868246">*</span><span class="ident" id="6868247">table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868254">badConn</span>&nbsp;<span class="builtintype" id="6868262">bool</span><br>
<span class="lineno"></span><span class="op" id="6868267">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="6868270">type</span>&nbsp;<span class="ident" id="6868275">table</span>&nbsp;<span class="keyword" id="6868281">struct</span>&nbsp;<span class="op" id="6868288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868291">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6868299">sync</span><span class="op" id="6868303">.</span><span class="ident" id="6868304">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868311">colname</span>&nbsp;<span class="op" id="6868319">[</span><span class="op" id="6868320">]</span><span class="builtintype" id="6868321">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868329">coltype</span>&nbsp;<span class="op" id="6868337">[</span><span class="op" id="6868338">]</span><span class="builtintype" id="6868339">string</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868347">rows</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6868355">[</span><span class="op" id="6868356">]</span><span class="op" id="6868357">*</span><span class="ident" id="6868358">row</span><br>
<span class="lineno"></span><span class="op" id="6868362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6868365">func</span>&nbsp;<span class="op" id="6868370">(</span><span class="ident" id="6868371">t</span>&nbsp;<span class="op" id="6868373">*</span><span class="ident" id="6868374">table</span><span class="op" id="6868379">)</span>&nbsp;<span class="ident" id="6868381">columnIndex</span><span class="op" id="6868392">(</span><span class="ident" id="6868393">name</span>&nbsp;<span class="builtintype" id="6868398">string</span><span class="op" id="6868404">)</span>&nbsp;<span class="builtintype" id="6868406">int</span>&nbsp;<span class="op" id="6868410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868413">for</span>&nbsp;<span class="ident" id="6868417">n</span><span class="op" id="6868418">,</span>&nbsp;<span class="ident" id="6868420">nname</span>&nbsp;<span class="op" id="6868426">:=</span>&nbsp;<span class="keyword" id="6868429">range</span>&nbsp;<span class="ident" id="6868435">t</span><span class="op" id="6868436">.</span><span class="ident" id="6868437">colname</span>&nbsp;<span class="op" id="6868445">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868449">if</span>&nbsp;<span class="ident" id="6868452">name</span>&nbsp;<span class="op" id="6868457">==</span>&nbsp;<span class="ident" id="6868460">nname</span>&nbsp;<span class="op" id="6868466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868471">return</span>&nbsp;<span class="ident" id="6868478">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868488">return</span>&nbsp;<span class="op" id="6868495">-</span><span class="num" id="6868496">1</span><br>
<span class="lineno">70</span><span class="op" id="6868498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6868501">type</span>&nbsp;<span class="ident" id="6868506">row</span>&nbsp;<span class="keyword" id="6868510">struct</span>&nbsp;<span class="op" id="6868517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868520">cols</span>&nbsp;<span class="op" id="6868525">[</span><span class="op" id="6868526">]</span><span class="keyword" id="6868527">interface</span><span class="op" id="6868536">{</span><span class="op" id="6868537">}</span>&nbsp;<span class="comment" id="6868539">//&nbsp;must&nbsp;be&nbsp;same&nbsp;size&nbsp;as&nbsp;its&nbsp;table&nbsp;colname&nbsp;+&nbsp;coltype</span><br>
<span class="lineno"></span><span class="op" id="6868591">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="6868594">func</span>&nbsp;<span class="op" id="6868599">(</span><span class="ident" id="6868600">r</span>&nbsp;<span class="op" id="6868602">*</span><span class="ident" id="6868603">row</span><span class="op" id="6868606">)</span>&nbsp;<span class="ident" id="6868608">clone</span><span class="op" id="6868613">(</span><span class="op" id="6868614">)</span>&nbsp;<span class="op" id="6868616">*</span><span class="ident" id="6868617">row</span>&nbsp;<span class="op" id="6868621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868624">nrow</span>&nbsp;<span class="op" id="6868629">:=</span>&nbsp;<span class="op" id="6868632">&amp;</span><span class="ident" id="6868633">row</span><span class="op" id="6868636">{</span><span class="ident" id="6868637">cols</span><span class="op" id="6868641">:</span>&nbsp;<span class="builtinfunc" id="6868643">make</span><span class="op" id="6868647">(</span><span class="op" id="6868648">[</span><span class="op" id="6868649">]</span><span class="keyword" id="6868650">interface</span><span class="op" id="6868659">{</span><span class="op" id="6868660">}</span><span class="op" id="6868661">,</span>&nbsp;<span class="builtinfunc" id="6868663">len</span><span class="op" id="6868666">(</span><span class="ident" id="6868667">r</span><span class="op" id="6868668">.</span><span class="ident" id="6868669">cols</span><span class="op" id="6868673">)</span><span class="op" id="6868674">)</span><span class="op" id="6868675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6868678">copy</span><span class="op" id="6868682">(</span><span class="ident" id="6868683">nrow</span><span class="op" id="6868687">.</span><span class="ident" id="6868688">cols</span><span class="op" id="6868692">,</span>&nbsp;<span class="ident" id="6868694">r</span><span class="op" id="6868695">.</span><span class="ident" id="6868696">cols</span><span class="op" id="6868700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6868703">return</span>&nbsp;<span class="ident" id="6868710">nrow</span><br>
<span class="lineno">80</span><span class="op" id="6868715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6868718">type</span>&nbsp;<span class="ident" id="6868723">fakeConn</span>&nbsp;<span class="keyword" id="6868732">struct</span>&nbsp;<span class="op" id="6868739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868742">db</span>&nbsp;<span class="op" id="6868745">*</span><span class="ident" id="6868746">fakeDB</span>&nbsp;<span class="comment" id="6868753">//&nbsp;where&nbsp;to&nbsp;return&nbsp;ourselves&nbsp;to</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868787">currTx</span>&nbsp;<span class="op" id="6868794">*</span><span class="ident" id="6868795">fakeTx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6868804">//&nbsp;Stats&nbsp;for&nbsp;tests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868825">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6868837">sync</span><span class="op" id="6868841">.</span><span class="ident" id="6868842">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868849">stmtsMade</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6868861">int</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868866">stmtsClosed</span>&nbsp;<span class="builtintype" id="6868878">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868883">numPrepare</span>&nbsp;&nbsp;<span class="builtintype" id="6868895">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868900">bad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6868912">bool</span><br>
<span class="lineno"></span><span class="op" id="6868917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6868920">func</span>&nbsp;<span class="op" id="6868925">(</span><span class="ident" id="6868926">c</span>&nbsp;<span class="op" id="6868928">*</span><span class="ident" id="6868929">fakeConn</span><span class="op" id="6868937">)</span>&nbsp;<span class="ident" id="6868939">incrStat</span><span class="op" id="6868947">(</span><span class="ident" id="6868948">v</span>&nbsp;<span class="op" id="6868950">*</span><span class="builtintype" id="6868951">int</span><span class="op" id="6868954">)</span>&nbsp;<span class="op" id="6868956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868959">c</span><span class="op" id="6868960">.</span><span class="ident" id="6868961">mu</span><span class="op" id="6868963">.</span><span class="ident" id="6868964">Lock</span><span class="op" id="6868968">(</span><span class="op" id="6868969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6868972">*</span><span class="ident" id="6868973">v</span><span class="op" id="6868974">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6868978">c</span><span class="op" id="6868979">.</span><span class="ident" id="6868980">mu</span><span class="op" id="6868982">.</span><span class="ident" id="6868983">Unlock</span><span class="op" id="6868989">(</span><span class="op" id="6868990">)</span><br>
<span class="lineno"></span><span class="op" id="6868992">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="6868995">type</span>&nbsp;<span class="ident" id="6869000">fakeTx</span>&nbsp;<span class="keyword" id="6869007">struct</span>&nbsp;<span class="op" id="6869014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869017">c</span>&nbsp;<span class="op" id="6869019">*</span><span class="ident" id="6869020">fakeConn</span><br>
<span class="lineno"></span><span class="op" id="6869029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6869032">type</span>&nbsp;<span class="ident" id="6869037">fakeStmt</span>&nbsp;<span class="keyword" id="6869046">struct</span>&nbsp;<span class="op" id="6869053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869056">c</span>&nbsp;<span class="op" id="6869058">*</span><span class="ident" id="6869059">fakeConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869069">q</span>&nbsp;<span class="builtintype" id="6869071">string</span>&nbsp;<span class="comment" id="6869078">//&nbsp;just&nbsp;for&nbsp;debugging</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869102">cmd</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6869108">string</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869116">table</span>&nbsp;<span class="builtintype" id="6869122">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869131">closed</span>&nbsp;<span class="builtintype" id="6869138">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869145">colName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6869158">[</span><span class="op" id="6869159">]</span><span class="builtintype" id="6869160">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6869172">//&nbsp;used&nbsp;by&nbsp;CREATE,&nbsp;INSERT,&nbsp;SELECT&nbsp;(selected&nbsp;columns)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869226">colType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6869239">[</span><span class="op" id="6869240">]</span><span class="builtintype" id="6869241">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6869253">//&nbsp;used&nbsp;by&nbsp;CREATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869272">colValue</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6869285">[</span><span class="op" id="6869286">]</span><span class="keyword" id="6869287">interface</span><span class="op" id="6869296">{</span><span class="op" id="6869297">}</span>&nbsp;<span class="comment" id="6869299">//&nbsp;used&nbsp;by&nbsp;INSERT&nbsp;(mix&nbsp;of&nbsp;strings&nbsp;and&nbsp;&#34;?&#34;&nbsp;for&nbsp;bound&nbsp;params)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869360">placeholders</span>&nbsp;<span class="builtintype" id="6869373">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6869387">//&nbsp;used&nbsp;by&nbsp;INSERT/SELECT:&nbsp;number&nbsp;of&nbsp;?&nbsp;params</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869434">whereCol</span>&nbsp;<span class="op" id="6869443">[</span><span class="op" id="6869444">]</span><span class="builtintype" id="6869445">string</span>&nbsp;<span class="comment" id="6869452">//&nbsp;used&nbsp;by&nbsp;SELECT&nbsp;(all&nbsp;placeholders)</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869491">placeholderConverter</span>&nbsp;<span class="op" id="6869512">[</span><span class="op" id="6869513">]</span><span class="ident" id="6869514">driver</span><span class="op" id="6869520">.</span><span class="ident" id="6869521">ValueConverter</span>&nbsp;<span class="comment" id="6869536">//&nbsp;used&nbsp;by&nbsp;INSERT</span><br>
<span class="lineno"></span><span class="op" id="6869554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869557">var</span>&nbsp;<span class="ident" id="6869561">fdriver</span>&nbsp;<span class="ident" id="6869569">driver</span><span class="op" id="6869575">.</span><span class="ident" id="6869576">Driver</span>&nbsp;<span class="op" id="6869583">=</span>&nbsp;<span class="op" id="6869585">&amp;</span><span class="ident" id="6869586">fakeDriver</span><span class="op" id="6869596">{</span><span class="op" id="6869597">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="6869600">func</span>&nbsp;<span class="ident" id="6869605">init</span><span class="op" id="6869609">(</span><span class="op" id="6869610">)</span>&nbsp;<span class="op" id="6869612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869615">Register</span><span class="op" id="6869623">(</span><span class="string" id="6869624">&#34;test&#34;</span><span class="op" id="6869630">,</span>&nbsp;<span class="ident" id="6869632">fdriver</span><span class="op" id="6869639">)</span><br>
<span class="lineno"></span><span class="op" id="6869641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="keyword" id="6869644">func</span>&nbsp;<span class="ident" id="6869649">contains</span><span class="op" id="6869657">(</span><span class="ident" id="6869658">list</span>&nbsp;<span class="op" id="6869663">[</span><span class="op" id="6869664">]</span><span class="builtintype" id="6869665">string</span><span class="op" id="6869671">,</span>&nbsp;<span class="ident" id="6869673">y</span>&nbsp;<span class="builtintype" id="6869675">string</span><span class="op" id="6869681">)</span>&nbsp;<span class="builtintype" id="6869683">bool</span>&nbsp;<span class="op" id="6869688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869691">for</span>&nbsp;<span class="ident" id="6869695">_</span><span class="op" id="6869696">,</span>&nbsp;<span class="ident" id="6869698">x</span>&nbsp;<span class="op" id="6869700">:=</span>&nbsp;<span class="keyword" id="6869703">range</span>&nbsp;<span class="ident" id="6869709">list</span>&nbsp;<span class="op" id="6869714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869718">if</span>&nbsp;<span class="ident" id="6869721">x</span>&nbsp;<span class="op" id="6869723">==</span>&nbsp;<span class="ident" id="6869726">y</span>&nbsp;<span class="op" id="6869728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869733">return</span>&nbsp;<span class="builtintype" id="6869740">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869747">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6869750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869753">return</span>&nbsp;<span class="builtintype" id="6869760">false</span><br>
<span class="lineno"></span><span class="op" id="6869766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869769">type</span>&nbsp;<span class="ident" id="6869774">Dummy</span>&nbsp;<span class="keyword" id="6869780">struct</span>&nbsp;<span class="op" id="6869787">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869790">driver</span><span class="op" id="6869796">.</span><span class="ident" id="6869797">Driver</span><br>
<span class="lineno"></span><span class="op" id="6869804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6869807">func</span>&nbsp;<span class="ident" id="6869812">TestDrivers</span><span class="op" id="6869823">(</span><span class="ident" id="6869824">t</span>&nbsp;<span class="op" id="6869826">*</span><span class="ident" id="6869827">testing</span><span class="op" id="6869834">.</span><span class="ident" id="6869835">T</span><span class="op" id="6869836">)</span>&nbsp;<span class="op" id="6869838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869841">unregisterAllDrivers</span><span class="op" id="6869861">(</span><span class="op" id="6869862">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869865">Register</span><span class="op" id="6869873">(</span><span class="string" id="6869874">&#34;test&#34;</span><span class="op" id="6869880">,</span>&nbsp;<span class="ident" id="6869882">fdriver</span><span class="op" id="6869889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869892">Register</span><span class="op" id="6869900">(</span><span class="string" id="6869901">&#34;invalid&#34;</span><span class="op" id="6869910">,</span>&nbsp;<span class="ident" id="6869912">Dummy</span><span class="op" id="6869917">{</span><span class="op" id="6869918">}</span><span class="op" id="6869919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6869922">all</span>&nbsp;<span class="op" id="6869926">:=</span>&nbsp;<span class="ident" id="6869929">Drivers</span><span class="op" id="6869936">(</span><span class="op" id="6869937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6869940">if</span>&nbsp;<span class="builtinfunc" id="6869943">len</span><span class="op" id="6869946">(</span><span class="ident" id="6869947">all</span><span class="op" id="6869950">)</span>&nbsp;<span class="op" id="6869952">&lt;</span>&nbsp;<span class="num" id="6869954">2</span>&nbsp;<span class="op" id="6869956">||</span>&nbsp;<span class="op" id="6869959">!</span><span class="ident" id="6869960">sort</span><span class="op" id="6869964">.</span><span class="ident" id="6869965">StringsAreSorted</span><span class="op" id="6869981">(</span><span class="ident" id="6869982">all</span><span class="op" id="6869985">)</span>&nbsp;<span class="op" id="6869987">||</span>&nbsp;<span class="op" id="6869990">!</span><span class="ident" id="6869991">contains</span><span class="op" id="6869999">(</span><span class="ident" id="6870000">all</span><span class="op" id="6870003">,</span>&nbsp;<span class="string" id="6870005">&#34;test&#34;</span><span class="op" id="6870011">)</span>&nbsp;<span class="op" id="6870013">||</span>&nbsp;<span class="op" id="6870016">!</span><span class="ident" id="6870017">contains</span><span class="op" id="6870025">(</span><span class="ident" id="6870026">all</span><span class="op" id="6870029">,</span>&nbsp;<span class="string" id="6870031">&#34;invalid&#34;</span><span class="op" id="6870040">)</span>&nbsp;<span class="op" id="6870042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870046">t</span><span class="op" id="6870047">.</span><span class="ident" id="6870048">Fatalf</span><span class="op" id="6870054">(</span><span class="string" id="6870055">&#34;Drivers&nbsp;=&nbsp;%v,&nbsp;want&nbsp;sorted&nbsp;list&nbsp;with&nbsp;at&nbsp;least&nbsp;[invalid,&nbsp;test]&#34;</span><span class="op" id="6870117">,</span>&nbsp;<span class="ident" id="6870119">all</span><span class="op" id="6870122">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870125">}</span><br>
<span class="lineno"></span><span class="op" id="6870127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6870130">//&nbsp;Supports&nbsp;dsn&nbsp;forms:</span><br>
<span class="lineno"></span><span class="comment" id="6870153">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;</span><br>
<span class="lineno">155</span><span class="comment" id="6870168">//&nbsp;&nbsp;&nbsp;&nbsp;&lt;dbname&gt;;&lt;opts&gt;&nbsp;&nbsp;(only&nbsp;currently&nbsp;supported&nbsp;option&nbsp;is&nbsp;`badConn`,</span><br>
<span class="lineno"></span><span class="comment" id="6870238">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;causes&nbsp;driver.ErrBadConn&nbsp;to&nbsp;be&nbsp;returned&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6870311">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;every&nbsp;other&nbsp;conn.Begin())</span><br>
<span class="lineno"></span><span class="keyword" id="6870361">func</span>&nbsp;<span class="op" id="6870366">(</span><span class="ident" id="6870367">d</span>&nbsp;<span class="op" id="6870369">*</span><span class="ident" id="6870370">fakeDriver</span><span class="op" id="6870380">)</span>&nbsp;<span class="ident" id="6870382">Open</span><span class="op" id="6870386">(</span><span class="ident" id="6870387">dsn</span>&nbsp;<span class="builtintype" id="6870391">string</span><span class="op" id="6870397">)</span>&nbsp;<span class="op" id="6870399">(</span><span class="ident" id="6870400">driver</span><span class="op" id="6870406">.</span><span class="ident" id="6870407">Conn</span><span class="op" id="6870411">,</span>&nbsp;<span class="builtintype" id="6870413">error</span><span class="op" id="6870418">)</span>&nbsp;<span class="op" id="6870420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870423">parts</span>&nbsp;<span class="op" id="6870429">:=</span>&nbsp;<span class="ident" id="6870432">strings</span><span class="op" id="6870439">.</span><span class="ident" id="6870440">Split</span><span class="op" id="6870445">(</span><span class="ident" id="6870446">dsn</span><span class="op" id="6870449">,</span>&nbsp;<span class="string" id="6870451">&#34;;&#34;</span><span class="op" id="6870454">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870457">if</span>&nbsp;<span class="builtinfunc" id="6870460">len</span><span class="op" id="6870463">(</span><span class="ident" id="6870464">parts</span><span class="op" id="6870469">)</span>&nbsp;<span class="op" id="6870471">&lt;</span>&nbsp;<span class="num" id="6870473">1</span>&nbsp;<span class="op" id="6870475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870479">return</span>&nbsp;<span class="ident" id="6870486">nil</span><span class="op" id="6870489">,</span>&nbsp;<span class="ident" id="6870491">errors</span><span class="op" id="6870497">.</span><span class="ident" id="6870498">New</span><span class="op" id="6870501">(</span><span class="string" id="6870502">&#34;fakedb:&nbsp;no&nbsp;database&nbsp;name&#34;</span><span class="op" id="6870528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870534">name</span>&nbsp;<span class="op" id="6870539">:=</span>&nbsp;<span class="ident" id="6870542">parts</span><span class="op" id="6870547">[</span><span class="num" id="6870548">0</span><span class="op" id="6870549">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870553">db</span>&nbsp;<span class="op" id="6870556">:=</span>&nbsp;<span class="ident" id="6870559">d</span><span class="op" id="6870560">.</span><span class="ident" id="6870561">getDB</span><span class="op" id="6870566">(</span><span class="ident" id="6870567">name</span><span class="op" id="6870571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870575">d</span><span class="op" id="6870576">.</span><span class="ident" id="6870577">mu</span><span class="op" id="6870579">.</span><span class="ident" id="6870580">Lock</span><span class="op" id="6870584">(</span><span class="op" id="6870585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870588">d</span><span class="op" id="6870589">.</span><span class="ident" id="6870590">openCount</span><span class="op" id="6870599">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870603">d</span><span class="op" id="6870604">.</span><span class="ident" id="6870605">mu</span><span class="op" id="6870607">.</span><span class="ident" id="6870608">Unlock</span><span class="op" id="6870614">(</span><span class="op" id="6870615">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870618">conn</span>&nbsp;<span class="op" id="6870623">:=</span>&nbsp;<span class="op" id="6870626">&amp;</span><span class="ident" id="6870627">fakeConn</span><span class="op" id="6870635">{</span><span class="ident" id="6870636">db</span><span class="op" id="6870638">:</span>&nbsp;<span class="ident" id="6870640">db</span><span class="op" id="6870642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870646">if</span>&nbsp;<span class="builtinfunc" id="6870649">len</span><span class="op" id="6870652">(</span><span class="ident" id="6870653">parts</span><span class="op" id="6870658">)</span>&nbsp;<span class="op" id="6870660">&gt;=</span>&nbsp;<span class="num" id="6870663">2</span>&nbsp;<span class="op" id="6870665">&amp;&amp;</span>&nbsp;<span class="ident" id="6870668">parts</span><span class="op" id="6870673">[</span><span class="num" id="6870674">1</span><span class="op" id="6870675">]</span>&nbsp;<span class="op" id="6870677">==</span>&nbsp;<span class="string" id="6870680">&#34;badConn&#34;</span>&nbsp;<span class="op" id="6870690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870694">conn</span><span class="op" id="6870698">.</span><span class="ident" id="6870699">bad</span>&nbsp;<span class="op" id="6870703">=</span>&nbsp;<span class="builtintype" id="6870705">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870711">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870714">if</span>&nbsp;<span class="ident" id="6870717">d</span><span class="op" id="6870718">.</span><span class="ident" id="6870719">waitCh</span>&nbsp;<span class="op" id="6870726">!=</span>&nbsp;<span class="ident" id="6870729">nil</span>&nbsp;<span class="op" id="6870733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870737">d</span><span class="op" id="6870738">.</span><span class="ident" id="6870739">waitingCh</span>&nbsp;<span class="op" id="6870749">&lt;-</span>&nbsp;<span class="keyword" id="6870752">struct</span><span class="op" id="6870758">{</span><span class="op" id="6870759">}</span><span class="op" id="6870760">{</span><span class="op" id="6870761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870765">&lt;-</span><span class="ident" id="6870767">d</span><span class="op" id="6870768">.</span><span class="ident" id="6870769">waitCh</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870778">d</span><span class="op" id="6870779">.</span><span class="ident" id="6870780">waitCh</span>&nbsp;<span class="op" id="6870787">=</span>&nbsp;<span class="ident" id="6870789">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870795">d</span><span class="op" id="6870796">.</span><span class="ident" id="6870797">waitingCh</span>&nbsp;<span class="op" id="6870807">=</span>&nbsp;<span class="ident" id="6870809">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870817">return</span>&nbsp;<span class="ident" id="6870824">conn</span><span class="op" id="6870828">,</span>&nbsp;<span class="ident" id="6870830">nil</span><br>
<span class="lineno"></span><span class="op" id="6870834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6870837">func</span>&nbsp;<span class="op" id="6870842">(</span><span class="ident" id="6870843">d</span>&nbsp;<span class="op" id="6870845">*</span><span class="ident" id="6870846">fakeDriver</span><span class="op" id="6870856">)</span>&nbsp;<span class="ident" id="6870858">getDB</span><span class="op" id="6870863">(</span><span class="ident" id="6870864">name</span>&nbsp;<span class="builtintype" id="6870869">string</span><span class="op" id="6870875">)</span>&nbsp;<span class="op" id="6870877">*</span><span class="ident" id="6870878">fakeDB</span>&nbsp;<span class="op" id="6870885">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870888">d</span><span class="op" id="6870889">.</span><span class="ident" id="6870890">mu</span><span class="op" id="6870892">.</span><span class="ident" id="6870893">Lock</span><span class="op" id="6870897">(</span><span class="op" id="6870898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870901">defer</span>&nbsp;<span class="ident" id="6870907">d</span><span class="op" id="6870908">.</span><span class="ident" id="6870909">mu</span><span class="op" id="6870911">.</span><span class="ident" id="6870912">Unlock</span><span class="op" id="6870918">(</span><span class="op" id="6870919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6870922">if</span>&nbsp;<span class="ident" id="6870925">d</span><span class="op" id="6870926">.</span><span class="ident" id="6870927">dbs</span>&nbsp;<span class="op" id="6870931">==</span>&nbsp;<span class="ident" id="6870934">nil</span>&nbsp;<span class="op" id="6870938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870942">d</span><span class="op" id="6870943">.</span><span class="ident" id="6870944">dbs</span>&nbsp;<span class="op" id="6870948">=</span>&nbsp;<span class="builtinfunc" id="6870950">make</span><span class="op" id="6870954">(</span><span class="keyword" id="6870955">map</span><span class="op" id="6870958">[</span><span class="builtintype" id="6870959">string</span><span class="op" id="6870965">]</span><span class="op" id="6870966">*</span><span class="ident" id="6870967">fakeDB</span><span class="op" id="6870973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6870976">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6870979">db</span><span class="op" id="6870981">,</span>&nbsp;<span class="ident" id="6870983">ok</span>&nbsp;<span class="op" id="6870986">:=</span>&nbsp;<span class="ident" id="6870989">d</span><span class="op" id="6870990">.</span><span class="ident" id="6870991">dbs</span><span class="op" id="6870994">[</span><span class="ident" id="6870995">name</span><span class="op" id="6870999">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871002">if</span>&nbsp;<span class="op" id="6871005">!</span><span class="ident" id="6871006">ok</span>&nbsp;<span class="op" id="6871009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871013">db</span>&nbsp;<span class="op" id="6871016">=</span>&nbsp;<span class="op" id="6871018">&amp;</span><span class="ident" id="6871019">fakeDB</span><span class="op" id="6871025">{</span><span class="ident" id="6871026">name</span><span class="op" id="6871030">:</span>&nbsp;<span class="ident" id="6871032">name</span><span class="op" id="6871036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871040">d</span><span class="op" id="6871041">.</span><span class="ident" id="6871042">dbs</span><span class="op" id="6871045">[</span><span class="ident" id="6871046">name</span><span class="op" id="6871050">]</span>&nbsp;<span class="op" id="6871052">=</span>&nbsp;<span class="ident" id="6871054">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871058">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871061">return</span>&nbsp;<span class="ident" id="6871068">db</span><br>
<span class="lineno"></span><span class="op" id="6871071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871074">func</span>&nbsp;<span class="op" id="6871079">(</span><span class="ident" id="6871080">db</span>&nbsp;<span class="op" id="6871083">*</span><span class="ident" id="6871084">fakeDB</span><span class="op" id="6871090">)</span>&nbsp;<span class="ident" id="6871092">wipe</span><span class="op" id="6871096">(</span><span class="op" id="6871097">)</span>&nbsp;<span class="op" id="6871099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871102">db</span><span class="op" id="6871104">.</span><span class="ident" id="6871105">mu</span><span class="op" id="6871107">.</span><span class="ident" id="6871108">Lock</span><span class="op" id="6871112">(</span><span class="op" id="6871113">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871116">defer</span>&nbsp;<span class="ident" id="6871122">db</span><span class="op" id="6871124">.</span><span class="ident" id="6871125">mu</span><span class="op" id="6871127">.</span><span class="ident" id="6871128">Unlock</span><span class="op" id="6871134">(</span><span class="op" id="6871135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871138">db</span><span class="op" id="6871140">.</span><span class="ident" id="6871141">tables</span>&nbsp;<span class="op" id="6871148">=</span>&nbsp;<span class="ident" id="6871150">nil</span><br>
<span class="lineno"></span><span class="op" id="6871154">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6871157">func</span>&nbsp;<span class="op" id="6871162">(</span><span class="ident" id="6871163">db</span>&nbsp;<span class="op" id="6871166">*</span><span class="ident" id="6871167">fakeDB</span><span class="op" id="6871173">)</span>&nbsp;<span class="ident" id="6871175">createTable</span><span class="op" id="6871186">(</span><span class="ident" id="6871187">name</span>&nbsp;<span class="builtintype" id="6871192">string</span><span class="op" id="6871198">,</span>&nbsp;<span class="ident" id="6871200">columnNames</span><span class="op" id="6871211">,</span>&nbsp;<span class="ident" id="6871213">columnTypes</span>&nbsp;<span class="op" id="6871225">[</span><span class="op" id="6871226">]</span><span class="builtintype" id="6871227">string</span><span class="op" id="6871233">)</span>&nbsp;<span class="builtintype" id="6871235">error</span>&nbsp;<span class="op" id="6871241">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871244">db</span><span class="op" id="6871246">.</span><span class="ident" id="6871247">mu</span><span class="op" id="6871249">.</span><span class="ident" id="6871250">Lock</span><span class="op" id="6871254">(</span><span class="op" id="6871255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871258">defer</span>&nbsp;<span class="ident" id="6871264">db</span><span class="op" id="6871266">.</span><span class="ident" id="6871267">mu</span><span class="op" id="6871269">.</span><span class="ident" id="6871270">Unlock</span><span class="op" id="6871276">(</span><span class="op" id="6871277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871280">if</span>&nbsp;<span class="ident" id="6871283">db</span><span class="op" id="6871285">.</span><span class="ident" id="6871286">tables</span>&nbsp;<span class="op" id="6871293">==</span>&nbsp;<span class="ident" id="6871296">nil</span>&nbsp;<span class="op" id="6871300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871304">db</span><span class="op" id="6871306">.</span><span class="ident" id="6871307">tables</span>&nbsp;<span class="op" id="6871314">=</span>&nbsp;<span class="builtinfunc" id="6871316">make</span><span class="op" id="6871320">(</span><span class="keyword" id="6871321">map</span><span class="op" id="6871324">[</span><span class="builtintype" id="6871325">string</span><span class="op" id="6871331">]</span><span class="op" id="6871332">*</span><span class="ident" id="6871333">table</span><span class="op" id="6871338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871341">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871344">if</span>&nbsp;<span class="ident" id="6871347">_</span><span class="op" id="6871348">,</span>&nbsp;<span class="ident" id="6871350">exist</span>&nbsp;<span class="op" id="6871356">:=</span>&nbsp;<span class="ident" id="6871359">db</span><span class="op" id="6871361">.</span><span class="ident" id="6871362">tables</span><span class="op" id="6871368">[</span><span class="ident" id="6871369">name</span><span class="op" id="6871373">]</span><span class="op" id="6871374">;</span>&nbsp;<span class="ident" id="6871376">exist</span>&nbsp;<span class="op" id="6871382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871386">return</span>&nbsp;<span class="ident" id="6871393">fmt</span><span class="op" id="6871396">.</span><span class="ident" id="6871397">Errorf</span><span class="op" id="6871403">(</span><span class="string" id="6871404">&#34;table&nbsp;%q&nbsp;already&nbsp;exists&#34;</span><span class="op" id="6871429">,</span>&nbsp;<span class="ident" id="6871431">name</span><span class="op" id="6871435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871441">if</span>&nbsp;<span class="builtinfunc" id="6871444">len</span><span class="op" id="6871447">(</span><span class="ident" id="6871448">columnNames</span><span class="op" id="6871459">)</span>&nbsp;<span class="op" id="6871461">!=</span>&nbsp;<span class="builtinfunc" id="6871464">len</span><span class="op" id="6871467">(</span><span class="ident" id="6871468">columnTypes</span><span class="op" id="6871479">)</span>&nbsp;<span class="op" id="6871481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871485">return</span>&nbsp;<span class="ident" id="6871492">fmt</span><span class="op" id="6871495">.</span><span class="ident" id="6871496">Errorf</span><span class="op" id="6871502">(</span><span class="string" id="6871503">&#34;create&nbsp;table&nbsp;of&nbsp;%q&nbsp;len(names)&nbsp;!=&nbsp;len(types):&nbsp;%d&nbsp;vs&nbsp;%d&#34;</span><span class="op" id="6871558">,</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871563">name</span><span class="op" id="6871567">,</span>&nbsp;<span class="builtinfunc" id="6871569">len</span><span class="op" id="6871572">(</span><span class="ident" id="6871573">columnNames</span><span class="op" id="6871584">)</span><span class="op" id="6871585">,</span>&nbsp;<span class="builtinfunc" id="6871587">len</span><span class="op" id="6871590">(</span><span class="ident" id="6871591">columnTypes</span><span class="op" id="6871602">)</span><span class="op" id="6871603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871606">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871609">db</span><span class="op" id="6871611">.</span><span class="ident" id="6871612">tables</span><span class="op" id="6871618">[</span><span class="ident" id="6871619">name</span><span class="op" id="6871623">]</span>&nbsp;<span class="op" id="6871625">=</span>&nbsp;<span class="op" id="6871627">&amp;</span><span class="ident" id="6871628">table</span><span class="op" id="6871633">{</span><span class="ident" id="6871634">colname</span><span class="op" id="6871641">:</span>&nbsp;<span class="ident" id="6871643">columnNames</span><span class="op" id="6871654">,</span>&nbsp;<span class="ident" id="6871656">coltype</span><span class="op" id="6871663">:</span>&nbsp;<span class="ident" id="6871665">columnTypes</span><span class="op" id="6871676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871679">return</span>&nbsp;<span class="ident" id="6871686">nil</span><br>
<span class="lineno"></span><span class="op" id="6871690">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="6871693">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;db.mu&nbsp;lock&nbsp;held</span><br>
<span class="lineno"></span><span class="keyword" id="6871732">func</span>&nbsp;<span class="op" id="6871737">(</span><span class="ident" id="6871738">db</span>&nbsp;<span class="op" id="6871741">*</span><span class="ident" id="6871742">fakeDB</span><span class="op" id="6871748">)</span>&nbsp;<span class="ident" id="6871750">table</span><span class="op" id="6871755">(</span><span class="ident" id="6871756">table</span>&nbsp;<span class="builtintype" id="6871762">string</span><span class="op" id="6871768">)</span>&nbsp;<span class="op" id="6871770">(</span><span class="op" id="6871771">*</span><span class="ident" id="6871772">table</span><span class="op" id="6871777">,</span>&nbsp;<span class="builtintype" id="6871779">bool</span><span class="op" id="6871783">)</span>&nbsp;<span class="op" id="6871785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871788">if</span>&nbsp;<span class="ident" id="6871791">db</span><span class="op" id="6871793">.</span><span class="ident" id="6871794">tables</span>&nbsp;<span class="op" id="6871801">==</span>&nbsp;<span class="ident" id="6871804">nil</span>&nbsp;<span class="op" id="6871808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871812">return</span>&nbsp;<span class="ident" id="6871819">nil</span><span class="op" id="6871822">,</span>&nbsp;<span class="builtintype" id="6871824">false</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6871831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871834">t</span><span class="op" id="6871835">,</span>&nbsp;<span class="ident" id="6871837">ok</span>&nbsp;<span class="op" id="6871840">:=</span>&nbsp;<span class="ident" id="6871843">db</span><span class="op" id="6871845">.</span><span class="ident" id="6871846">tables</span><span class="op" id="6871852">[</span><span class="ident" id="6871853">table</span><span class="op" id="6871858">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871861">return</span>&nbsp;<span class="ident" id="6871868">t</span><span class="op" id="6871869">,</span>&nbsp;<span class="ident" id="6871871">ok</span><br>
<span class="lineno"></span><span class="op" id="6871874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="6871877">func</span>&nbsp;<span class="op" id="6871882">(</span><span class="ident" id="6871883">db</span>&nbsp;<span class="op" id="6871886">*</span><span class="ident" id="6871887">fakeDB</span><span class="op" id="6871893">)</span>&nbsp;<span class="ident" id="6871895">columnType</span><span class="op" id="6871905">(</span><span class="ident" id="6871906">table</span><span class="op" id="6871911">,</span>&nbsp;<span class="ident" id="6871913">column</span>&nbsp;<span class="builtintype" id="6871920">string</span><span class="op" id="6871926">)</span>&nbsp;<span class="op" id="6871928">(</span><span class="ident" id="6871929">typ</span>&nbsp;<span class="builtintype" id="6871933">string</span><span class="op" id="6871939">,</span>&nbsp;<span class="ident" id="6871941">ok</span>&nbsp;<span class="builtintype" id="6871944">bool</span><span class="op" id="6871948">)</span>&nbsp;<span class="op" id="6871950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871953">db</span><span class="op" id="6871955">.</span><span class="ident" id="6871956">mu</span><span class="op" id="6871958">.</span><span class="ident" id="6871959">Lock</span><span class="op" id="6871963">(</span><span class="op" id="6871964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6871967">defer</span>&nbsp;<span class="ident" id="6871973">db</span><span class="op" id="6871975">.</span><span class="ident" id="6871976">mu</span><span class="op" id="6871978">.</span><span class="ident" id="6871979">Unlock</span><span class="op" id="6871985">(</span><span class="op" id="6871986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6871989">t</span><span class="op" id="6871990">,</span>&nbsp;<span class="ident" id="6871992">ok</span>&nbsp;<span class="op" id="6871995">:=</span>&nbsp;<span class="ident" id="6871998">db</span><span class="op" id="6872000">.</span><span class="ident" id="6872001">table</span><span class="op" id="6872006">(</span><span class="ident" id="6872007">table</span><span class="op" id="6872012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872015">if</span>&nbsp;<span class="op" id="6872018">!</span><span class="ident" id="6872019">ok</span>&nbsp;<span class="op" id="6872022">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872026">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872037">for</span>&nbsp;<span class="ident" id="6872041">n</span><span class="op" id="6872042">,</span>&nbsp;<span class="ident" id="6872044">cname</span>&nbsp;<span class="op" id="6872050">:=</span>&nbsp;<span class="keyword" id="6872053">range</span>&nbsp;<span class="ident" id="6872059">t</span><span class="op" id="6872060">.</span><span class="ident" id="6872061">colname</span>&nbsp;<span class="op" id="6872069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872073">if</span>&nbsp;<span class="ident" id="6872076">cname</span>&nbsp;<span class="op" id="6872082">==</span>&nbsp;<span class="ident" id="6872085">column</span>&nbsp;<span class="op" id="6872092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872097">return</span>&nbsp;<span class="ident" id="6872104">t</span><span class="op" id="6872105">.</span><span class="ident" id="6872106">coltype</span><span class="op" id="6872113">[</span><span class="ident" id="6872114">n</span><span class="op" id="6872115">]</span><span class="op" id="6872116">,</span>&nbsp;<span class="builtintype" id="6872118">true</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872131">return</span>&nbsp;<span class="string" id="6872138">&#34;&#34;</span><span class="op" id="6872140">,</span>&nbsp;<span class="builtintype" id="6872142">false</span><br>
<span class="lineno"></span><span class="op" id="6872148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="keyword" id="6872151">func</span>&nbsp;<span class="op" id="6872156">(</span><span class="ident" id="6872157">c</span>&nbsp;<span class="op" id="6872159">*</span><span class="ident" id="6872160">fakeConn</span><span class="op" id="6872168">)</span>&nbsp;<span class="ident" id="6872170">isBad</span><span class="op" id="6872175">(</span><span class="op" id="6872176">)</span>&nbsp;<span class="builtintype" id="6872178">bool</span>&nbsp;<span class="op" id="6872183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6872186">//&nbsp;if&nbsp;not&nbsp;simulating&nbsp;bad&nbsp;conn,&nbsp;do&nbsp;nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872229">if</span>&nbsp;<span class="op" id="6872232">!</span><span class="ident" id="6872233">c</span><span class="op" id="6872234">.</span><span class="ident" id="6872235">bad</span>&nbsp;<span class="op" id="6872239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872243">return</span>&nbsp;<span class="builtintype" id="6872250">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872257">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6872260">//&nbsp;alternate&nbsp;between&nbsp;bad&nbsp;conn&nbsp;and&nbsp;not&nbsp;bad&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872308">c</span><span class="op" id="6872309">.</span><span class="ident" id="6872310">db</span><span class="op" id="6872312">.</span><span class="ident" id="6872313">badConn</span>&nbsp;<span class="op" id="6872321">=</span>&nbsp;<span class="op" id="6872323">!</span><span class="ident" id="6872324">c</span><span class="op" id="6872325">.</span><span class="ident" id="6872326">db</span><span class="op" id="6872328">.</span><span class="ident" id="6872329">badConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872338">return</span>&nbsp;<span class="ident" id="6872345">c</span><span class="op" id="6872346">.</span><span class="ident" id="6872347">db</span><span class="op" id="6872349">.</span><span class="ident" id="6872350">badConn</span><br>
<span class="lineno"></span><span class="op" id="6872358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="keyword" id="6872361">func</span>&nbsp;<span class="op" id="6872366">(</span><span class="ident" id="6872367">c</span>&nbsp;<span class="op" id="6872369">*</span><span class="ident" id="6872370">fakeConn</span><span class="op" id="6872378">)</span>&nbsp;<span class="ident" id="6872380">Begin</span><span class="op" id="6872385">(</span><span class="op" id="6872386">)</span>&nbsp;<span class="op" id="6872388">(</span><span class="ident" id="6872389">driver</span><span class="op" id="6872395">.</span><span class="ident" id="6872396">Tx</span><span class="op" id="6872398">,</span>&nbsp;<span class="builtintype" id="6872400">error</span><span class="op" id="6872405">)</span>&nbsp;<span class="op" id="6872407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872410">if</span>&nbsp;<span class="ident" id="6872413">c</span><span class="op" id="6872414">.</span><span class="ident" id="6872415">isBad</span><span class="op" id="6872420">(</span><span class="op" id="6872421">)</span>&nbsp;<span class="op" id="6872423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872427">return</span>&nbsp;<span class="ident" id="6872434">nil</span><span class="op" id="6872437">,</span>&nbsp;<span class="ident" id="6872439">driver</span><span class="op" id="6872445">.</span><span class="ident" id="6872446">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872461">if</span>&nbsp;<span class="ident" id="6872464">c</span><span class="op" id="6872465">.</span><span class="ident" id="6872466">currTx</span>&nbsp;<span class="op" id="6872473">!=</span>&nbsp;<span class="ident" id="6872476">nil</span>&nbsp;<span class="op" id="6872480">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872484">return</span>&nbsp;<span class="ident" id="6872491">nil</span><span class="op" id="6872494">,</span>&nbsp;<span class="ident" id="6872496">errors</span><span class="op" id="6872502">.</span><span class="ident" id="6872503">New</span><span class="op" id="6872506">(</span><span class="string" id="6872507">&#34;already&nbsp;in&nbsp;a&nbsp;transaction&#34;</span><span class="op" id="6872533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6872536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872539">c</span><span class="op" id="6872540">.</span><span class="ident" id="6872541">currTx</span>&nbsp;<span class="op" id="6872548">=</span>&nbsp;<span class="op" id="6872550">&amp;</span><span class="ident" id="6872551">fakeTx</span><span class="op" id="6872557">{</span><span class="ident" id="6872558">c</span><span class="op" id="6872559">:</span>&nbsp;<span class="ident" id="6872561">c</span><span class="op" id="6872562">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872565">return</span>&nbsp;<span class="ident" id="6872572">c</span><span class="op" id="6872573">.</span><span class="ident" id="6872574">currTx</span><span class="op" id="6872580">,</span>&nbsp;<span class="ident" id="6872582">nil</span><br>
<span class="lineno"></span><span class="op" id="6872586">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="6872589">var</span>&nbsp;<span class="ident" id="6872593">hookPostCloseConn</span>&nbsp;<span class="keyword" id="6872611">struct</span>&nbsp;<span class="op" id="6872618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872621">sync</span><span class="op" id="6872625">.</span><span class="ident" id="6872626">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872633">fn</span>&nbsp;<span class="keyword" id="6872636">func</span><span class="op" id="6872640">(</span><span class="op" id="6872641">*</span><span class="ident" id="6872642">fakeConn</span><span class="op" id="6872650">,</span>&nbsp;<span class="builtintype" id="6872652">error</span><span class="op" id="6872657">)</span><br>
<span class="lineno"></span><span class="op" id="6872659">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="keyword" id="6872662">func</span>&nbsp;<span class="ident" id="6872667">setHookpostCloseConn</span><span class="op" id="6872687">(</span><span class="ident" id="6872688">fn</span>&nbsp;<span class="keyword" id="6872691">func</span><span class="op" id="6872695">(</span><span class="op" id="6872696">*</span><span class="ident" id="6872697">fakeConn</span><span class="op" id="6872705">,</span>&nbsp;<span class="builtintype" id="6872707">error</span><span class="op" id="6872712">)</span><span class="op" id="6872713">)</span>&nbsp;<span class="op" id="6872715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872718">hookPostCloseConn</span><span class="op" id="6872735">.</span><span class="ident" id="6872736">Lock</span><span class="op" id="6872740">(</span><span class="op" id="6872741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6872744">defer</span>&nbsp;<span class="ident" id="6872750">hookPostCloseConn</span><span class="op" id="6872767">.</span><span class="ident" id="6872768">Unlock</span><span class="op" id="6872774">(</span><span class="op" id="6872775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6872778">hookPostCloseConn</span><span class="op" id="6872795">.</span><span class="ident" id="6872796">fn</span>&nbsp;<span class="op" id="6872799">=</span>&nbsp;<span class="ident" id="6872801">fn</span><br>
<span class="lineno">275</span><span class="op" id="6872804">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6872807">var</span>&nbsp;<span class="ident" id="6872811">testStrictClose</span>&nbsp;<span class="op" id="6872827">*</span><span class="ident" id="6872828">testing</span><span class="op" id="6872835">.</span><span class="ident" id="6872836">T</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6872839">//&nbsp;setStrictFakeConnClose&nbsp;sets&nbsp;the&nbsp;t&nbsp;to&nbsp;Errorf&nbsp;on&nbsp;when&nbsp;fakeConn.Close</span><br>
<span class="lineno">280</span><span class="comment" id="6872909">//&nbsp;fails&nbsp;to&nbsp;close.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;check&nbsp;is&nbsp;disabled.</span><br>
<span class="lineno"></span><span class="keyword" id="6872959">func</span>&nbsp;<span class="ident" id="6872964">setStrictFakeConnClose</span><span class="op" id="6872986">(</span><span class="ident" id="6872987">t</span>&nbsp;<span class="op" id="6872989">*</span><span class="ident" id="6872990">testing</span><span class="op" id="6872997">.</span><span class="ident" id="6872998">T</span><span class="op" id="6872999">)</span>&nbsp;<span class="op" id="6873001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873004">testStrictClose</span>&nbsp;<span class="op" id="6873020">=</span>&nbsp;<span class="ident" id="6873022">t</span><br>
<span class="lineno"></span><span class="op" id="6873024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6873027">func</span>&nbsp;<span class="op" id="6873032">(</span><span class="ident" id="6873033">c</span>&nbsp;<span class="op" id="6873035">*</span><span class="ident" id="6873036">fakeConn</span><span class="op" id="6873044">)</span>&nbsp;<span class="ident" id="6873046">Close</span><span class="op" id="6873051">(</span><span class="op" id="6873052">)</span>&nbsp;<span class="op" id="6873054">(</span><span class="ident" id="6873055">err</span>&nbsp;<span class="builtintype" id="6873059">error</span><span class="op" id="6873064">)</span>&nbsp;<span class="op" id="6873066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873069">drv</span>&nbsp;<span class="op" id="6873073">:=</span>&nbsp;<span class="ident" id="6873076">fdriver</span><span class="op" id="6873083">.</span><span class="op" id="6873084">(</span><span class="op" id="6873085">*</span><span class="ident" id="6873086">fakeDriver</span><span class="op" id="6873096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873099">defer</span>&nbsp;<span class="keyword" id="6873105">func</span><span class="op" id="6873109">(</span><span class="op" id="6873110">)</span>&nbsp;<span class="op" id="6873112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873116">if</span>&nbsp;<span class="ident" id="6873119">err</span>&nbsp;<span class="op" id="6873123">!=</span>&nbsp;<span class="ident" id="6873126">nil</span>&nbsp;<span class="op" id="6873130">&amp;&amp;</span>&nbsp;<span class="ident" id="6873133">testStrictClose</span>&nbsp;<span class="op" id="6873149">!=</span>&nbsp;<span class="ident" id="6873152">nil</span>&nbsp;<span class="op" id="6873156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873161">testStrictClose</span><span class="op" id="6873176">.</span><span class="ident" id="6873177">Errorf</span><span class="op" id="6873183">(</span><span class="string" id="6873184">&#34;failed&nbsp;to&nbsp;close&nbsp;a&nbsp;test&nbsp;fakeConn:&nbsp;%v&#34;</span><span class="op" id="6873221">,</span>&nbsp;<span class="ident" id="6873223">err</span><span class="op" id="6873226">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873234">hookPostCloseConn</span><span class="op" id="6873251">.</span><span class="ident" id="6873252">Lock</span><span class="op" id="6873256">(</span><span class="op" id="6873257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873261">fn</span>&nbsp;<span class="op" id="6873264">:=</span>&nbsp;<span class="ident" id="6873267">hookPostCloseConn</span><span class="op" id="6873284">.</span><span class="ident" id="6873285">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873290">hookPostCloseConn</span><span class="op" id="6873307">.</span><span class="ident" id="6873308">Unlock</span><span class="op" id="6873314">(</span><span class="op" id="6873315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873319">if</span>&nbsp;<span class="ident" id="6873322">fn</span>&nbsp;<span class="op" id="6873325">!=</span>&nbsp;<span class="ident" id="6873328">nil</span>&nbsp;<span class="op" id="6873332">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873337">fn</span><span class="op" id="6873339">(</span><span class="ident" id="6873340">c</span><span class="op" id="6873341">,</span>&nbsp;<span class="ident" id="6873343">err</span><span class="op" id="6873346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873354">if</span>&nbsp;<span class="ident" id="6873357">err</span>&nbsp;<span class="op" id="6873361">==</span>&nbsp;<span class="ident" id="6873364">nil</span>&nbsp;<span class="op" id="6873368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873373">drv</span><span class="op" id="6873376">.</span><span class="ident" id="6873377">mu</span><span class="op" id="6873379">.</span><span class="ident" id="6873380">Lock</span><span class="op" id="6873384">(</span><span class="op" id="6873385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873390">drv</span><span class="op" id="6873393">.</span><span class="ident" id="6873394">closeCount</span><span class="op" id="6873404">++</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873410">drv</span><span class="op" id="6873413">.</span><span class="ident" id="6873414">mu</span><span class="op" id="6873416">.</span><span class="ident" id="6873417">Unlock</span><span class="op" id="6873423">(</span><span class="op" id="6873424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873431">}</span><span class="op" id="6873432">(</span><span class="op" id="6873433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873436">if</span>&nbsp;<span class="ident" id="6873439">c</span><span class="op" id="6873440">.</span><span class="ident" id="6873441">currTx</span>&nbsp;<span class="op" id="6873448">!=</span>&nbsp;<span class="ident" id="6873451">nil</span>&nbsp;<span class="op" id="6873455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873459">return</span>&nbsp;<span class="ident" id="6873466">errors</span><span class="op" id="6873472">.</span><span class="ident" id="6873473">New</span><span class="op" id="6873476">(</span><span class="string" id="6873477">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;in&nbsp;a&nbsp;Transaction&#34;</span><span class="op" id="6873517">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873523">if</span>&nbsp;<span class="ident" id="6873526">c</span><span class="op" id="6873527">.</span><span class="ident" id="6873528">db</span>&nbsp;<span class="op" id="6873531">==</span>&nbsp;<span class="ident" id="6873534">nil</span>&nbsp;<span class="op" id="6873538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873542">return</span>&nbsp;<span class="ident" id="6873549">errors</span><span class="op" id="6873555">.</span><span class="ident" id="6873556">New</span><span class="op" id="6873559">(</span><span class="string" id="6873560">&#34;can&#39;t&nbsp;close&nbsp;fakeConn;&nbsp;already&nbsp;closed&#34;</span><span class="op" id="6873598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873604">if</span>&nbsp;<span class="ident" id="6873607">c</span><span class="op" id="6873608">.</span><span class="ident" id="6873609">stmtsMade</span>&nbsp;<span class="op" id="6873619">&gt;</span>&nbsp;<span class="ident" id="6873621">c</span><span class="op" id="6873622">.</span><span class="ident" id="6873623">stmtsClosed</span>&nbsp;<span class="op" id="6873635">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873639">return</span>&nbsp;<span class="ident" id="6873646">errors</span><span class="op" id="6873652">.</span><span class="ident" id="6873653">New</span><span class="op" id="6873656">(</span><span class="string" id="6873657">&#34;can&#39;t&nbsp;close;&nbsp;dangling&nbsp;statement(s)&#34;</span><span class="op" id="6873693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6873699">c</span><span class="op" id="6873700">.</span><span class="ident" id="6873701">db</span>&nbsp;<span class="op" id="6873704">=</span>&nbsp;<span class="ident" id="6873706">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873711">return</span>&nbsp;<span class="ident" id="6873718">nil</span><br>
<span class="lineno"></span><span class="op" id="6873722">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="6873725">func</span>&nbsp;<span class="ident" id="6873730">checkSubsetTypes</span><span class="op" id="6873746">(</span><span class="ident" id="6873747">args</span>&nbsp;<span class="op" id="6873752">[</span><span class="op" id="6873753">]</span><span class="ident" id="6873754">driver</span><span class="op" id="6873760">.</span><span class="ident" id="6873761">Value</span><span class="op" id="6873766">)</span>&nbsp;<span class="builtintype" id="6873768">error</span>&nbsp;<span class="op" id="6873774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873777">for</span>&nbsp;<span class="ident" id="6873781">n</span><span class="op" id="6873782">,</span>&nbsp;<span class="ident" id="6873784">arg</span>&nbsp;<span class="op" id="6873788">:=</span>&nbsp;<span class="keyword" id="6873791">range</span>&nbsp;<span class="ident" id="6873797">args</span>&nbsp;<span class="op" id="6873802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873806">switch</span>&nbsp;<span class="ident" id="6873813">arg</span><span class="op" id="6873816">.</span><span class="op" id="6873817">(</span><span class="keyword" id="6873818">type</span><span class="op" id="6873822">)</span>&nbsp;<span class="op" id="6873824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873828">case</span>&nbsp;<span class="ident" id="6873833">int64</span><span class="op" id="6873838">,</span>&nbsp;<span class="builtintype" id="6873840">float64</span><span class="op" id="6873847">,</span>&nbsp;<span class="builtintype" id="6873849">bool</span><span class="op" id="6873853">,</span>&nbsp;<span class="ident" id="6873855">nil</span><span class="op" id="6873858">,</span>&nbsp;<span class="op" id="6873860">[</span><span class="op" id="6873861">]</span><span class="builtintype" id="6873862">byte</span><span class="op" id="6873866">,</span>&nbsp;<span class="builtintype" id="6873868">string</span><span class="op" id="6873874">,</span>&nbsp;<span class="ident" id="6873876">time</span><span class="op" id="6873880">.</span><span class="ident" id="6873881">Time</span><span class="op" id="6873885">:</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873889">default</span><span class="op" id="6873896">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873901">return</span>&nbsp;<span class="ident" id="6873908">fmt</span><span class="op" id="6873911">.</span><span class="ident" id="6873912">Errorf</span><span class="op" id="6873918">(</span><span class="string" id="6873919">&#34;fakedb_test:&nbsp;invalid&nbsp;argument&nbsp;#%d:&nbsp;%v,&nbsp;type&nbsp;%T&#34;</span><span class="op" id="6873967">,</span>&nbsp;<span class="ident" id="6873969">n</span><span class="op" id="6873970">+</span><span class="num" id="6873971">1</span><span class="op" id="6873972">,</span>&nbsp;<span class="ident" id="6873974">arg</span><span class="op" id="6873977">,</span>&nbsp;<span class="ident" id="6873979">arg</span><span class="op" id="6873982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6873989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6873992">return</span>&nbsp;<span class="ident" id="6873999">nil</span><br>
<span class="lineno">325</span><span class="op" id="6874003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874006">func</span>&nbsp;<span class="op" id="6874011">(</span><span class="ident" id="6874012">c</span>&nbsp;<span class="op" id="6874014">*</span><span class="ident" id="6874015">fakeConn</span><span class="op" id="6874023">)</span>&nbsp;<span class="ident" id="6874025">Exec</span><span class="op" id="6874029">(</span><span class="ident" id="6874030">query</span>&nbsp;<span class="builtintype" id="6874036">string</span><span class="op" id="6874042">,</span>&nbsp;<span class="ident" id="6874044">args</span>&nbsp;<span class="op" id="6874049">[</span><span class="op" id="6874050">]</span><span class="ident" id="6874051">driver</span><span class="op" id="6874057">.</span><span class="ident" id="6874058">Value</span><span class="op" id="6874063">)</span>&nbsp;<span class="op" id="6874065">(</span><span class="ident" id="6874066">driver</span><span class="op" id="6874072">.</span><span class="ident" id="6874073">Result</span><span class="op" id="6874079">,</span>&nbsp;<span class="builtintype" id="6874081">error</span><span class="op" id="6874086">)</span>&nbsp;<span class="op" id="6874088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874091">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874152">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874213">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874272">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874299">err</span>&nbsp;<span class="op" id="6874303">:=</span>&nbsp;<span class="ident" id="6874306">checkSubsetTypes</span><span class="op" id="6874322">(</span><span class="ident" id="6874323">args</span><span class="op" id="6874327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874330">if</span>&nbsp;<span class="ident" id="6874333">err</span>&nbsp;<span class="op" id="6874337">!=</span>&nbsp;<span class="ident" id="6874340">nil</span>&nbsp;<span class="op" id="6874344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874348">return</span>&nbsp;<span class="ident" id="6874355">nil</span><span class="op" id="6874358">,</span>&nbsp;<span class="ident" id="6874360">err</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874368">return</span>&nbsp;<span class="ident" id="6874375">nil</span><span class="op" id="6874378">,</span>&nbsp;<span class="ident" id="6874380">driver</span><span class="op" id="6874386">.</span><span class="ident" id="6874387">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6874395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6874398">func</span>&nbsp;<span class="op" id="6874403">(</span><span class="ident" id="6874404">c</span>&nbsp;<span class="op" id="6874406">*</span><span class="ident" id="6874407">fakeConn</span><span class="op" id="6874415">)</span>&nbsp;<span class="ident" id="6874417">Query</span><span class="op" id="6874422">(</span><span class="ident" id="6874423">query</span>&nbsp;<span class="builtintype" id="6874429">string</span><span class="op" id="6874435">,</span>&nbsp;<span class="ident" id="6874437">args</span>&nbsp;<span class="op" id="6874442">[</span><span class="op" id="6874443">]</span><span class="ident" id="6874444">driver</span><span class="op" id="6874450">.</span><span class="ident" id="6874451">Value</span><span class="op" id="6874456">)</span>&nbsp;<span class="op" id="6874458">(</span><span class="ident" id="6874459">driver</span><span class="op" id="6874465">.</span><span class="ident" id="6874466">Rows</span><span class="op" id="6874470">,</span>&nbsp;<span class="builtintype" id="6874472">error</span><span class="op" id="6874477">)</span>&nbsp;<span class="op" id="6874479">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874482">//&nbsp;This&nbsp;is&nbsp;an&nbsp;optional&nbsp;interface,&nbsp;but&nbsp;it&#39;s&nbsp;implemented&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874543">//&nbsp;just&nbsp;to&nbsp;check&nbsp;that&nbsp;all&nbsp;the&nbsp;args&nbsp;are&nbsp;of&nbsp;the&nbsp;proper&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874604">//&nbsp;ErrSkip&nbsp;is&nbsp;returned&nbsp;so&nbsp;the&nbsp;caller&nbsp;acts&nbsp;as&nbsp;if&nbsp;we&nbsp;didn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6874663">//&nbsp;implement&nbsp;this&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6874690">err</span>&nbsp;<span class="op" id="6874694">:=</span>&nbsp;<span class="ident" id="6874697">checkSubsetTypes</span><span class="op" id="6874713">(</span><span class="ident" id="6874714">args</span><span class="op" id="6874718">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874721">if</span>&nbsp;<span class="ident" id="6874724">err</span>&nbsp;<span class="op" id="6874728">!=</span>&nbsp;<span class="ident" id="6874731">nil</span>&nbsp;<span class="op" id="6874735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874739">return</span>&nbsp;<span class="ident" id="6874746">nil</span><span class="op" id="6874749">,</span>&nbsp;<span class="ident" id="6874751">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6874756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874759">return</span>&nbsp;<span class="ident" id="6874766">nil</span><span class="op" id="6874769">,</span>&nbsp;<span class="ident" id="6874771">driver</span><span class="op" id="6874777">.</span><span class="ident" id="6874778">ErrSkip</span><br>
<span class="lineno"></span><span class="op" id="6874786">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="6874789">func</span>&nbsp;<span class="ident" id="6874794">errf</span><span class="op" id="6874798">(</span><span class="ident" id="6874799">msg</span>&nbsp;<span class="builtintype" id="6874803">string</span><span class="op" id="6874809">,</span>&nbsp;<span class="ident" id="6874811">args</span>&nbsp;<span class="op" id="6874816">...</span><span class="keyword" id="6874819">interface</span><span class="op" id="6874828">{</span><span class="op" id="6874829">}</span><span class="op" id="6874830">)</span>&nbsp;<span class="builtintype" id="6874832">error</span>&nbsp;<span class="op" id="6874838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6874841">return</span>&nbsp;<span class="ident" id="6874848">errors</span><span class="op" id="6874854">.</span><span class="ident" id="6874855">New</span><span class="op" id="6874858">(</span><span class="string" id="6874859">&#34;fakedb:&nbsp;&#34;</span>&nbsp;<span class="op" id="6874870">+</span>&nbsp;<span class="ident" id="6874872">fmt</span><span class="op" id="6874875">.</span><span class="ident" id="6874876">Sprintf</span><span class="op" id="6874883">(</span><span class="ident" id="6874884">msg</span><span class="op" id="6874887">,</span>&nbsp;<span class="ident" id="6874889">args</span><span class="op" id="6874893">...</span><span class="op" id="6874896">)</span><span class="op" id="6874897">)</span><br>
<span class="lineno"></span><span class="op" id="6874899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="6874902">//&nbsp;parts&nbsp;are&nbsp;table|selectCol1,selectCol2|whereCol=?,whereCol2=?</span><br>
<span class="lineno"></span><span class="comment" id="6874966">//&nbsp;(note&nbsp;that&nbsp;where&nbsp;columns&nbsp;must&nbsp;always&nbsp;contain&nbsp;?&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="6875023">//&nbsp;&nbsp;just&nbsp;a&nbsp;limitation&nbsp;for&nbsp;fakedb)</span><br>
<span class="lineno"></span><span class="keyword" id="6875057">func</span>&nbsp;<span class="op" id="6875062">(</span><span class="ident" id="6875063">c</span>&nbsp;<span class="op" id="6875065">*</span><span class="ident" id="6875066">fakeConn</span><span class="op" id="6875074">)</span>&nbsp;<span class="ident" id="6875076">prepareSelect</span><span class="op" id="6875089">(</span><span class="ident" id="6875090">stmt</span>&nbsp;<span class="op" id="6875095">*</span><span class="ident" id="6875096">fakeStmt</span><span class="op" id="6875104">,</span>&nbsp;<span class="ident" id="6875106">parts</span>&nbsp;<span class="op" id="6875112">[</span><span class="op" id="6875113">]</span><span class="builtintype" id="6875114">string</span><span class="op" id="6875120">)</span>&nbsp;<span class="op" id="6875122">(</span><span class="ident" id="6875123">driver</span><span class="op" id="6875129">.</span><span class="ident" id="6875130">Stmt</span><span class="op" id="6875134">,</span>&nbsp;<span class="builtintype" id="6875136">error</span><span class="op" id="6875141">)</span>&nbsp;<span class="op" id="6875143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875146">if</span>&nbsp;<span class="builtinfunc" id="6875149">len</span><span class="op" id="6875152">(</span><span class="ident" id="6875153">parts</span><span class="op" id="6875158">)</span>&nbsp;<span class="op" id="6875160">!=</span>&nbsp;<span class="num" id="6875163">3</span>&nbsp;<span class="op" id="6875165">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875169">stmt</span><span class="op" id="6875173">.</span><span class="ident" id="6875174">Close</span><span class="op" id="6875179">(</span><span class="op" id="6875180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875184">return</span>&nbsp;<span class="ident" id="6875191">nil</span><span class="op" id="6875194">,</span>&nbsp;<span class="ident" id="6875196">errf</span><span class="op" id="6875200">(</span><span class="string" id="6875201">&#34;invalid&nbsp;SELECT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;3&#34;</span><span class="op" id="6875246">,</span>&nbsp;<span class="builtinfunc" id="6875248">len</span><span class="op" id="6875251">(</span><span class="ident" id="6875252">parts</span><span class="op" id="6875257">)</span><span class="op" id="6875258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875264">stmt</span><span class="op" id="6875268">.</span><span class="ident" id="6875269">table</span>&nbsp;<span class="op" id="6875275">=</span>&nbsp;<span class="ident" id="6875277">parts</span><span class="op" id="6875282">[</span><span class="num" id="6875283">0</span><span class="op" id="6875284">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875287">stmt</span><span class="op" id="6875291">.</span><span class="ident" id="6875292">colName</span>&nbsp;<span class="op" id="6875300">=</span>&nbsp;<span class="ident" id="6875302">strings</span><span class="op" id="6875309">.</span><span class="ident" id="6875310">Split</span><span class="op" id="6875315">(</span><span class="ident" id="6875316">parts</span><span class="op" id="6875321">[</span><span class="num" id="6875322">1</span><span class="op" id="6875323">]</span><span class="op" id="6875324">,</span>&nbsp;<span class="string" id="6875326">&#34;,&#34;</span><span class="op" id="6875329">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875332">for</span>&nbsp;<span class="ident" id="6875336">n</span><span class="op" id="6875337">,</span>&nbsp;<span class="ident" id="6875339">colspec</span>&nbsp;<span class="op" id="6875347">:=</span>&nbsp;<span class="keyword" id="6875350">range</span>&nbsp;<span class="ident" id="6875356">strings</span><span class="op" id="6875363">.</span><span class="ident" id="6875364">Split</span><span class="op" id="6875369">(</span><span class="ident" id="6875370">parts</span><span class="op" id="6875375">[</span><span class="num" id="6875376">2</span><span class="op" id="6875377">]</span><span class="op" id="6875378">,</span>&nbsp;<span class="string" id="6875380">&#34;,&#34;</span><span class="op" id="6875383">)</span>&nbsp;<span class="op" id="6875385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875389">if</span>&nbsp;<span class="ident" id="6875392">colspec</span>&nbsp;<span class="op" id="6875400">==</span>&nbsp;<span class="string" id="6875403">&#34;&#34;</span>&nbsp;<span class="op" id="6875406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875411">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875426">nameVal</span>&nbsp;<span class="op" id="6875434">:=</span>&nbsp;<span class="ident" id="6875437">strings</span><span class="op" id="6875444">.</span><span class="ident" id="6875445">Split</span><span class="op" id="6875450">(</span><span class="ident" id="6875451">colspec</span><span class="op" id="6875458">,</span>&nbsp;<span class="string" id="6875460">&#34;=&#34;</span><span class="op" id="6875463">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875467">if</span>&nbsp;<span class="builtinfunc" id="6875470">len</span><span class="op" id="6875473">(</span><span class="ident" id="6875474">nameVal</span><span class="op" id="6875481">)</span>&nbsp;<span class="op" id="6875483">!=</span>&nbsp;<span class="num" id="6875486">2</span>&nbsp;<span class="op" id="6875488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875493">stmt</span><span class="op" id="6875497">.</span><span class="ident" id="6875498">Close</span><span class="op" id="6875503">(</span><span class="op" id="6875504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875509">return</span>&nbsp;<span class="ident" id="6875516">nil</span><span class="op" id="6875519">,</span>&nbsp;<span class="ident" id="6875521">errf</span><span class="op" id="6875525">(</span><span class="string" id="6875526">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6875587">,</span>&nbsp;<span class="ident" id="6875589">stmt</span><span class="op" id="6875593">.</span><span class="ident" id="6875594">table</span><span class="op" id="6875599">,</span>&nbsp;<span class="ident" id="6875601">colspec</span><span class="op" id="6875608">,</span>&nbsp;<span class="ident" id="6875610">n</span><span class="op" id="6875611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875619">column</span><span class="op" id="6875625">,</span>&nbsp;<span class="ident" id="6875627">value</span>&nbsp;<span class="op" id="6875633">:=</span>&nbsp;<span class="ident" id="6875636">nameVal</span><span class="op" id="6875643">[</span><span class="num" id="6875644">0</span><span class="op" id="6875645">]</span><span class="op" id="6875646">,</span>&nbsp;<span class="ident" id="6875648">nameVal</span><span class="op" id="6875655">[</span><span class="num" id="6875656">1</span><span class="op" id="6875657">]</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875661">_</span><span class="op" id="6875662">,</span>&nbsp;<span class="ident" id="6875664">ok</span>&nbsp;<span class="op" id="6875667">:=</span>&nbsp;<span class="ident" id="6875670">c</span><span class="op" id="6875671">.</span><span class="ident" id="6875672">db</span><span class="op" id="6875674">.</span><span class="ident" id="6875675">columnType</span><span class="op" id="6875685">(</span><span class="ident" id="6875686">stmt</span><span class="op" id="6875690">.</span><span class="ident" id="6875691">table</span><span class="op" id="6875696">,</span>&nbsp;<span class="ident" id="6875698">column</span><span class="op" id="6875704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875708">if</span>&nbsp;<span class="op" id="6875711">!</span><span class="ident" id="6875712">ok</span>&nbsp;<span class="op" id="6875715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875720">stmt</span><span class="op" id="6875724">.</span><span class="ident" id="6875725">Close</span><span class="op" id="6875730">(</span><span class="op" id="6875731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875736">return</span>&nbsp;<span class="ident" id="6875743">nil</span><span class="op" id="6875746">,</span>&nbsp;<span class="ident" id="6875748">errf</span><span class="op" id="6875752">(</span><span class="string" id="6875753">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6875807">,</span>&nbsp;<span class="ident" id="6875809">stmt</span><span class="op" id="6875813">.</span><span class="ident" id="6875814">table</span><span class="op" id="6875819">,</span>&nbsp;<span class="ident" id="6875821">column</span><span class="op" id="6875827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875831">}</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875835">if</span>&nbsp;<span class="ident" id="6875838">value</span>&nbsp;<span class="op" id="6875844">!=</span>&nbsp;<span class="string" id="6875847">&#34;?&#34;</span>&nbsp;<span class="op" id="6875851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875856">stmt</span><span class="op" id="6875860">.</span><span class="ident" id="6875861">Close</span><span class="op" id="6875866">(</span><span class="op" id="6875867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6875872">return</span>&nbsp;<span class="ident" id="6875879">nil</span><span class="op" id="6875882">,</span>&nbsp;<span class="ident" id="6875884">errf</span><span class="op" id="6875888">(</span><span class="string" id="6875889">&#34;SELECT&nbsp;on&nbsp;table&nbsp;%q&nbsp;has&nbsp;pre-bound&nbsp;value&nbsp;for&nbsp;where&nbsp;column&nbsp;%q;&nbsp;need&nbsp;a&nbsp;question&nbsp;mark&#34;</span><span class="op" id="6875971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6875977">stmt</span><span class="op" id="6875981">.</span><span class="ident" id="6875982">table</span><span class="op" id="6875987">,</span>&nbsp;<span class="ident" id="6875989">column</span><span class="op" id="6875995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6875999">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876003">stmt</span><span class="op" id="6876007">.</span><span class="ident" id="6876008">whereCol</span>&nbsp;<span class="op" id="6876017">=</span>&nbsp;<span class="builtinfunc" id="6876019">append</span><span class="op" id="6876025">(</span><span class="ident" id="6876026">stmt</span><span class="op" id="6876030">.</span><span class="ident" id="6876031">whereCol</span><span class="op" id="6876039">,</span>&nbsp;<span class="ident" id="6876041">column</span><span class="op" id="6876047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876051">stmt</span><span class="op" id="6876055">.</span><span class="ident" id="6876056">placeholders</span><span class="op" id="6876068">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876075">return</span>&nbsp;<span class="ident" id="6876082">stmt</span><span class="op" id="6876086">,</span>&nbsp;<span class="ident" id="6876088">nil</span><br>
<span class="lineno"></span><span class="op" id="6876092">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span><span class="comment" id="6876095">//&nbsp;parts&nbsp;are&nbsp;table|col=type,col2=type2</span><br>
<span class="lineno"></span><span class="keyword" id="6876134">func</span>&nbsp;<span class="op" id="6876139">(</span><span class="ident" id="6876140">c</span>&nbsp;<span class="op" id="6876142">*</span><span class="ident" id="6876143">fakeConn</span><span class="op" id="6876151">)</span>&nbsp;<span class="ident" id="6876153">prepareCreate</span><span class="op" id="6876166">(</span><span class="ident" id="6876167">stmt</span>&nbsp;<span class="op" id="6876172">*</span><span class="ident" id="6876173">fakeStmt</span><span class="op" id="6876181">,</span>&nbsp;<span class="ident" id="6876183">parts</span>&nbsp;<span class="op" id="6876189">[</span><span class="op" id="6876190">]</span><span class="builtintype" id="6876191">string</span><span class="op" id="6876197">)</span>&nbsp;<span class="op" id="6876199">(</span><span class="ident" id="6876200">driver</span><span class="op" id="6876206">.</span><span class="ident" id="6876207">Stmt</span><span class="op" id="6876211">,</span>&nbsp;<span class="builtintype" id="6876213">error</span><span class="op" id="6876218">)</span>&nbsp;<span class="op" id="6876220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876223">if</span>&nbsp;<span class="builtinfunc" id="6876226">len</span><span class="op" id="6876229">(</span><span class="ident" id="6876230">parts</span><span class="op" id="6876235">)</span>&nbsp;<span class="op" id="6876237">!=</span>&nbsp;<span class="num" id="6876240">2</span>&nbsp;<span class="op" id="6876242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876246">stmt</span><span class="op" id="6876250">.</span><span class="ident" id="6876251">Close</span><span class="op" id="6876256">(</span><span class="op" id="6876257">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876261">return</span>&nbsp;<span class="ident" id="6876268">nil</span><span class="op" id="6876271">,</span>&nbsp;<span class="ident" id="6876273">errf</span><span class="op" id="6876277">(</span><span class="string" id="6876278">&#34;invalid&nbsp;CREATE&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6876323">,</span>&nbsp;<span class="builtinfunc" id="6876325">len</span><span class="op" id="6876328">(</span><span class="ident" id="6876329">parts</span><span class="op" id="6876334">)</span><span class="op" id="6876335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876341">stmt</span><span class="op" id="6876345">.</span><span class="ident" id="6876346">table</span>&nbsp;<span class="op" id="6876352">=</span>&nbsp;<span class="ident" id="6876354">parts</span><span class="op" id="6876359">[</span><span class="num" id="6876360">0</span><span class="op" id="6876361">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876364">for</span>&nbsp;<span class="ident" id="6876368">n</span><span class="op" id="6876369">,</span>&nbsp;<span class="ident" id="6876371">colspec</span>&nbsp;<span class="op" id="6876379">:=</span>&nbsp;<span class="keyword" id="6876382">range</span>&nbsp;<span class="ident" id="6876388">strings</span><span class="op" id="6876395">.</span><span class="ident" id="6876396">Split</span><span class="op" id="6876401">(</span><span class="ident" id="6876402">parts</span><span class="op" id="6876407">[</span><span class="num" id="6876408">1</span><span class="op" id="6876409">]</span><span class="op" id="6876410">,</span>&nbsp;<span class="string" id="6876412">&#34;,&#34;</span><span class="op" id="6876415">)</span>&nbsp;<span class="op" id="6876417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876421">nameType</span>&nbsp;<span class="op" id="6876430">:=</span>&nbsp;<span class="ident" id="6876433">strings</span><span class="op" id="6876440">.</span><span class="ident" id="6876441">Split</span><span class="op" id="6876446">(</span><span class="ident" id="6876447">colspec</span><span class="op" id="6876454">,</span>&nbsp;<span class="string" id="6876456">&#34;=&#34;</span><span class="op" id="6876459">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876463">if</span>&nbsp;<span class="builtinfunc" id="6876466">len</span><span class="op" id="6876469">(</span><span class="ident" id="6876470">nameType</span><span class="op" id="6876478">)</span>&nbsp;<span class="op" id="6876480">!=</span>&nbsp;<span class="num" id="6876483">2</span>&nbsp;<span class="op" id="6876485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876490">stmt</span><span class="op" id="6876494">.</span><span class="ident" id="6876495">Close</span><span class="op" id="6876500">(</span><span class="op" id="6876501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876506">return</span>&nbsp;<span class="ident" id="6876513">nil</span><span class="op" id="6876516">,</span>&nbsp;<span class="ident" id="6876518">errf</span><span class="op" id="6876522">(</span><span class="string" id="6876523">&#34;CREATE&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6876581">,</span>&nbsp;<span class="ident" id="6876583">stmt</span><span class="op" id="6876587">.</span><span class="ident" id="6876588">table</span><span class="op" id="6876593">,</span>&nbsp;<span class="ident" id="6876595">colspec</span><span class="op" id="6876602">,</span>&nbsp;<span class="ident" id="6876604">n</span><span class="op" id="6876605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876613">stmt</span><span class="op" id="6876617">.</span><span class="ident" id="6876618">colName</span>&nbsp;<span class="op" id="6876626">=</span>&nbsp;<span class="builtinfunc" id="6876628">append</span><span class="op" id="6876634">(</span><span class="ident" id="6876635">stmt</span><span class="op" id="6876639">.</span><span class="ident" id="6876640">colName</span><span class="op" id="6876647">,</span>&nbsp;<span class="ident" id="6876649">nameType</span><span class="op" id="6876657">[</span><span class="num" id="6876658">0</span><span class="op" id="6876659">]</span><span class="op" id="6876660">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876664">stmt</span><span class="op" id="6876668">.</span><span class="ident" id="6876669">colType</span>&nbsp;<span class="op" id="6876677">=</span>&nbsp;<span class="builtinfunc" id="6876679">append</span><span class="op" id="6876685">(</span><span class="ident" id="6876686">stmt</span><span class="op" id="6876690">.</span><span class="ident" id="6876691">colType</span><span class="op" id="6876698">,</span>&nbsp;<span class="ident" id="6876700">nameType</span><span class="op" id="6876708">[</span><span class="num" id="6876709">1</span><span class="op" id="6876710">]</span><span class="op" id="6876711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876717">return</span>&nbsp;<span class="ident" id="6876724">stmt</span><span class="op" id="6876728">,</span>&nbsp;<span class="ident" id="6876730">nil</span><br>
<span class="lineno"></span><span class="op" id="6876734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="comment" id="6876737">//&nbsp;parts&nbsp;are&nbsp;table|col=?,col2=val</span><br>
<span class="lineno"></span><span class="keyword" id="6876771">func</span>&nbsp;<span class="op" id="6876776">(</span><span class="ident" id="6876777">c</span>&nbsp;<span class="op" id="6876779">*</span><span class="ident" id="6876780">fakeConn</span><span class="op" id="6876788">)</span>&nbsp;<span class="ident" id="6876790">prepareInsert</span><span class="op" id="6876803">(</span><span class="ident" id="6876804">stmt</span>&nbsp;<span class="op" id="6876809">*</span><span class="ident" id="6876810">fakeStmt</span><span class="op" id="6876818">,</span>&nbsp;<span class="ident" id="6876820">parts</span>&nbsp;<span class="op" id="6876826">[</span><span class="op" id="6876827">]</span><span class="builtintype" id="6876828">string</span><span class="op" id="6876834">)</span>&nbsp;<span class="op" id="6876836">(</span><span class="ident" id="6876837">driver</span><span class="op" id="6876843">.</span><span class="ident" id="6876844">Stmt</span><span class="op" id="6876848">,</span>&nbsp;<span class="builtintype" id="6876850">error</span><span class="op" id="6876855">)</span>&nbsp;<span class="op" id="6876857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876860">if</span>&nbsp;<span class="builtinfunc" id="6876863">len</span><span class="op" id="6876866">(</span><span class="ident" id="6876867">parts</span><span class="op" id="6876872">)</span>&nbsp;<span class="op" id="6876874">!=</span>&nbsp;<span class="num" id="6876877">2</span>&nbsp;<span class="op" id="6876879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876883">stmt</span><span class="op" id="6876887">.</span><span class="ident" id="6876888">Close</span><span class="op" id="6876893">(</span><span class="op" id="6876894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6876898">return</span>&nbsp;<span class="ident" id="6876905">nil</span><span class="op" id="6876908">,</span>&nbsp;<span class="ident" id="6876910">errf</span><span class="op" id="6876914">(</span><span class="string" id="6876915">&#34;invalid&nbsp;INSERT&nbsp;syntax&nbsp;with&nbsp;%d&nbsp;parts;&nbsp;want&nbsp;2&#34;</span><span class="op" id="6876960">,</span>&nbsp;<span class="builtinfunc" id="6876962">len</span><span class="op" id="6876965">(</span><span class="ident" id="6876966">parts</span><span class="op" id="6876971">)</span><span class="op" id="6876972">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6876975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6876978">stmt</span><span class="op" id="6876982">.</span><span class="ident" id="6876983">table</span>&nbsp;<span class="op" id="6876989">=</span>&nbsp;<span class="ident" id="6876991">parts</span><span class="op" id="6876996">[</span><span class="num" id="6876997">0</span><span class="op" id="6876998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877001">for</span>&nbsp;<span class="ident" id="6877005">n</span><span class="op" id="6877006">,</span>&nbsp;<span class="ident" id="6877008">colspec</span>&nbsp;<span class="op" id="6877016">:=</span>&nbsp;<span class="keyword" id="6877019">range</span>&nbsp;<span class="ident" id="6877025">strings</span><span class="op" id="6877032">.</span><span class="ident" id="6877033">Split</span><span class="op" id="6877038">(</span><span class="ident" id="6877039">parts</span><span class="op" id="6877044">[</span><span class="num" id="6877045">1</span><span class="op" id="6877046">]</span><span class="op" id="6877047">,</span>&nbsp;<span class="string" id="6877049">&#34;,&#34;</span><span class="op" id="6877052">)</span>&nbsp;<span class="op" id="6877054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877058">nameVal</span>&nbsp;<span class="op" id="6877066">:=</span>&nbsp;<span class="ident" id="6877069">strings</span><span class="op" id="6877076">.</span><span class="ident" id="6877077">Split</span><span class="op" id="6877082">(</span><span class="ident" id="6877083">colspec</span><span class="op" id="6877090">,</span>&nbsp;<span class="string" id="6877092">&#34;=&#34;</span><span class="op" id="6877095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877099">if</span>&nbsp;<span class="builtinfunc" id="6877102">len</span><span class="op" id="6877105">(</span><span class="ident" id="6877106">nameVal</span><span class="op" id="6877113">)</span>&nbsp;<span class="op" id="6877115">!=</span>&nbsp;<span class="num" id="6877118">2</span>&nbsp;<span class="op" id="6877120">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877125">stmt</span><span class="op" id="6877129">.</span><span class="ident" id="6877130">Close</span><span class="op" id="6877135">(</span><span class="op" id="6877136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877141">return</span>&nbsp;<span class="ident" id="6877148">nil</span><span class="op" id="6877151">,</span>&nbsp;<span class="ident" id="6877153">errf</span><span class="op" id="6877157">(</span><span class="string" id="6877158">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;has&nbsp;invalid&nbsp;column&nbsp;spec&nbsp;of&nbsp;%q&nbsp;(index&nbsp;%d)&#34;</span><span class="op" id="6877216">,</span>&nbsp;<span class="ident" id="6877218">stmt</span><span class="op" id="6877222">.</span><span class="ident" id="6877223">table</span><span class="op" id="6877228">,</span>&nbsp;<span class="ident" id="6877230">colspec</span><span class="op" id="6877237">,</span>&nbsp;<span class="ident" id="6877239">n</span><span class="op" id="6877240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877248">column</span><span class="op" id="6877254">,</span>&nbsp;<span class="ident" id="6877256">value</span>&nbsp;<span class="op" id="6877262">:=</span>&nbsp;<span class="ident" id="6877265">nameVal</span><span class="op" id="6877272">[</span><span class="num" id="6877273">0</span><span class="op" id="6877274">]</span><span class="op" id="6877275">,</span>&nbsp;<span class="ident" id="6877277">nameVal</span><span class="op" id="6877284">[</span><span class="num" id="6877285">1</span><span class="op" id="6877286">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877290">ctype</span><span class="op" id="6877295">,</span>&nbsp;<span class="ident" id="6877297">ok</span>&nbsp;<span class="op" id="6877300">:=</span>&nbsp;<span class="ident" id="6877303">c</span><span class="op" id="6877304">.</span><span class="ident" id="6877305">db</span><span class="op" id="6877307">.</span><span class="ident" id="6877308">columnType</span><span class="op" id="6877318">(</span><span class="ident" id="6877319">stmt</span><span class="op" id="6877323">.</span><span class="ident" id="6877324">table</span><span class="op" id="6877329">,</span>&nbsp;<span class="ident" id="6877331">column</span><span class="op" id="6877337">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877341">if</span>&nbsp;<span class="op" id="6877344">!</span><span class="ident" id="6877345">ok</span>&nbsp;<span class="op" id="6877348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877353">stmt</span><span class="op" id="6877357">.</span><span class="ident" id="6877358">Close</span><span class="op" id="6877363">(</span><span class="op" id="6877364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877369">return</span>&nbsp;<span class="ident" id="6877376">nil</span><span class="op" id="6877379">,</span>&nbsp;<span class="ident" id="6877381">errf</span><span class="op" id="6877385">(</span><span class="string" id="6877386">&#34;INSERT&nbsp;table&nbsp;%q&nbsp;references&nbsp;non-existent&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6877437">,</span>&nbsp;<span class="ident" id="6877439">stmt</span><span class="op" id="6877443">.</span><span class="ident" id="6877444">table</span><span class="op" id="6877449">,</span>&nbsp;<span class="ident" id="6877451">column</span><span class="op" id="6877457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877465">stmt</span><span class="op" id="6877469">.</span><span class="ident" id="6877470">colName</span>&nbsp;<span class="op" id="6877478">=</span>&nbsp;<span class="builtinfunc" id="6877480">append</span><span class="op" id="6877486">(</span><span class="ident" id="6877487">stmt</span><span class="op" id="6877491">.</span><span class="ident" id="6877492">colName</span><span class="op" id="6877499">,</span>&nbsp;<span class="ident" id="6877501">column</span><span class="op" id="6877507">)</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877512">if</span>&nbsp;<span class="ident" id="6877515">value</span>&nbsp;<span class="op" id="6877521">!=</span>&nbsp;<span class="string" id="6877524">&#34;?&#34;</span>&nbsp;<span class="op" id="6877528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877533">var</span>&nbsp;<span class="ident" id="6877537">subsetVal</span>&nbsp;<span class="keyword" id="6877547">interface</span><span class="op" id="6877556">{</span><span class="op" id="6877557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6877562">//&nbsp;Convert&nbsp;to&nbsp;driver&nbsp;subset&nbsp;type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877598">switch</span>&nbsp;<span class="ident" id="6877605">ctype</span>&nbsp;<span class="op" id="6877611">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877616">case</span>&nbsp;<span class="string" id="6877621">&#34;string&#34;</span><span class="op" id="6877629">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877635">subsetVal</span>&nbsp;<span class="op" id="6877645">=</span>&nbsp;<span class="op" id="6877647">[</span><span class="op" id="6877648">]</span><span class="builtintype" id="6877649">byte</span><span class="op" id="6877653">(</span><span class="ident" id="6877654">value</span><span class="op" id="6877659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877664">case</span>&nbsp;<span class="string" id="6877669">&#34;blob&#34;</span><span class="op" id="6877675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877681">subsetVal</span>&nbsp;<span class="op" id="6877691">=</span>&nbsp;<span class="op" id="6877693">[</span><span class="op" id="6877694">]</span><span class="builtintype" id="6877695">byte</span><span class="op" id="6877699">(</span><span class="ident" id="6877700">value</span><span class="op" id="6877705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877710">case</span>&nbsp;<span class="string" id="6877715">&#34;int32&#34;</span><span class="op" id="6877722">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877728">i</span><span class="op" id="6877729">,</span>&nbsp;<span class="ident" id="6877731">err</span>&nbsp;<span class="op" id="6877735">:=</span>&nbsp;<span class="ident" id="6877738">strconv</span><span class="op" id="6877745">.</span><span class="ident" id="6877746">Atoi</span><span class="op" id="6877750">(</span><span class="ident" id="6877751">value</span><span class="op" id="6877756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877762">if</span>&nbsp;<span class="ident" id="6877765">err</span>&nbsp;<span class="op" id="6877769">!=</span>&nbsp;<span class="ident" id="6877772">nil</span>&nbsp;<span class="op" id="6877776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877783">stmt</span><span class="op" id="6877787">.</span><span class="ident" id="6877788">Close</span><span class="op" id="6877793">(</span><span class="op" id="6877794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877801">return</span>&nbsp;<span class="ident" id="6877808">nil</span><span class="op" id="6877811">,</span>&nbsp;<span class="ident" id="6877813">errf</span><span class="op" id="6877817">(</span><span class="string" id="6877818">&#34;invalid&nbsp;conversion&nbsp;to&nbsp;int32&nbsp;from&nbsp;%q&#34;</span><span class="op" id="6877855">,</span>&nbsp;<span class="ident" id="6877857">value</span><span class="op" id="6877862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6877868">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877874">subsetVal</span>&nbsp;<span class="op" id="6877884">=</span>&nbsp;<span class="ident" id="6877886">int64</span><span class="op" id="6877891">(</span><span class="ident" id="6877892">i</span><span class="op" id="6877893">)</span>&nbsp;<span class="comment" id="6877895">//&nbsp;int64&nbsp;is&nbsp;a&nbsp;subset&nbsp;type,&nbsp;but&nbsp;not&nbsp;int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877939">default</span><span class="op" id="6877946">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6877952">stmt</span><span class="op" id="6877956">.</span><span class="ident" id="6877957">Close</span><span class="op" id="6877962">(</span><span class="op" id="6877963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6877969">return</span>&nbsp;<span class="ident" id="6877976">nil</span><span class="op" id="6877979">,</span>&nbsp;<span class="ident" id="6877981">errf</span><span class="op" id="6877985">(</span><span class="string" id="6877986">&#34;unsupported&nbsp;conversion&nbsp;for&nbsp;pre-bound&nbsp;parameter&nbsp;%q&nbsp;to&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6878048">,</span>&nbsp;<span class="ident" id="6878050">value</span><span class="op" id="6878055">,</span>&nbsp;<span class="ident" id="6878057">ctype</span><span class="op" id="6878062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878067">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878072">stmt</span><span class="op" id="6878076">.</span><span class="ident" id="6878077">colValue</span>&nbsp;<span class="op" id="6878086">=</span>&nbsp;<span class="builtinfunc" id="6878088">append</span><span class="op" id="6878094">(</span><span class="ident" id="6878095">stmt</span><span class="op" id="6878099">.</span><span class="ident" id="6878100">colValue</span><span class="op" id="6878108">,</span>&nbsp;<span class="ident" id="6878110">subsetVal</span><span class="op" id="6878119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878123">}</span>&nbsp;<span class="keyword" id="6878125">else</span>&nbsp;<span class="op" id="6878130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878135">stmt</span><span class="op" id="6878139">.</span><span class="ident" id="6878140">placeholders</span><span class="op" id="6878152">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878158">stmt</span><span class="op" id="6878162">.</span><span class="ident" id="6878163">placeholderConverter</span>&nbsp;<span class="op" id="6878184">=</span>&nbsp;<span class="builtinfunc" id="6878186">append</span><span class="op" id="6878192">(</span><span class="ident" id="6878193">stmt</span><span class="op" id="6878197">.</span><span class="ident" id="6878198">placeholderConverter</span><span class="op" id="6878218">,</span>&nbsp;<span class="ident" id="6878220">converterForType</span><span class="op" id="6878236">(</span><span class="ident" id="6878237">ctype</span><span class="op" id="6878242">)</span><span class="op" id="6878243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878248">stmt</span><span class="op" id="6878252">.</span><span class="ident" id="6878253">colValue</span>&nbsp;<span class="op" id="6878262">=</span>&nbsp;<span class="builtinfunc" id="6878264">append</span><span class="op" id="6878270">(</span><span class="ident" id="6878271">stmt</span><span class="op" id="6878275">.</span><span class="ident" id="6878276">colValue</span><span class="op" id="6878284">,</span>&nbsp;<span class="string" id="6878286">&#34;?&#34;</span><span class="op" id="6878289">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878299">return</span>&nbsp;<span class="ident" id="6878306">stmt</span><span class="op" id="6878310">,</span>&nbsp;<span class="ident" id="6878312">nil</span><br>
<span class="lineno"></span><span class="op" id="6878316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span><span class="comment" id="6878319">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6878358">var</span>&nbsp;<span class="ident" id="6878362">hookPrepareBadConn</span>&nbsp;<span class="keyword" id="6878381">func</span><span class="op" id="6878385">(</span><span class="op" id="6878386">)</span>&nbsp;<span class="builtintype" id="6878388">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6878394">func</span>&nbsp;<span class="op" id="6878399">(</span><span class="ident" id="6878400">c</span>&nbsp;<span class="op" id="6878402">*</span><span class="ident" id="6878403">fakeConn</span><span class="op" id="6878411">)</span>&nbsp;<span class="ident" id="6878413">Prepare</span><span class="op" id="6878420">(</span><span class="ident" id="6878421">query</span>&nbsp;<span class="builtintype" id="6878427">string</span><span class="op" id="6878433">)</span>&nbsp;<span class="op" id="6878435">(</span><span class="ident" id="6878436">driver</span><span class="op" id="6878442">.</span><span class="ident" id="6878443">Stmt</span><span class="op" id="6878447">,</span>&nbsp;<span class="builtintype" id="6878449">error</span><span class="op" id="6878454">)</span>&nbsp;<span class="op" id="6878456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878459">c</span><span class="op" id="6878460">.</span><span class="ident" id="6878461">numPrepare</span><span class="op" id="6878471">++</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878475">if</span>&nbsp;<span class="ident" id="6878478">c</span><span class="op" id="6878479">.</span><span class="ident" id="6878480">db</span>&nbsp;<span class="op" id="6878483">==</span>&nbsp;<span class="ident" id="6878486">nil</span>&nbsp;<span class="op" id="6878490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6878494">panic</span><span class="op" id="6878499">(</span><span class="string" id="6878500">&#34;nil&nbsp;c.db;&nbsp;conn&nbsp;=&nbsp;&#34;</span>&nbsp;<span class="op" id="6878520">+</span>&nbsp;<span class="ident" id="6878522">fmt</span><span class="op" id="6878525">.</span><span class="ident" id="6878526">Sprintf</span><span class="op" id="6878533">(</span><span class="string" id="6878534">&#34;%#v&#34;</span><span class="op" id="6878539">,</span>&nbsp;<span class="ident" id="6878541">c</span><span class="op" id="6878542">)</span><span class="op" id="6878543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878550">if</span>&nbsp;<span class="ident" id="6878553">hookPrepareBadConn</span>&nbsp;<span class="op" id="6878572">!=</span>&nbsp;<span class="ident" id="6878575">nil</span>&nbsp;<span class="op" id="6878579">&amp;&amp;</span>&nbsp;<span class="ident" id="6878582">hookPrepareBadConn</span><span class="op" id="6878600">(</span><span class="op" id="6878601">)</span>&nbsp;<span class="op" id="6878603">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878607">return</span>&nbsp;<span class="ident" id="6878614">nil</span><span class="op" id="6878617">,</span>&nbsp;<span class="ident" id="6878619">driver</span><span class="op" id="6878625">.</span><span class="ident" id="6878626">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878642">parts</span>&nbsp;<span class="op" id="6878648">:=</span>&nbsp;<span class="ident" id="6878651">strings</span><span class="op" id="6878658">.</span><span class="ident" id="6878659">Split</span><span class="op" id="6878664">(</span><span class="ident" id="6878665">query</span><span class="op" id="6878670">,</span>&nbsp;<span class="string" id="6878672">&#34;|&#34;</span><span class="op" id="6878675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878678">if</span>&nbsp;<span class="builtinfunc" id="6878681">len</span><span class="op" id="6878684">(</span><span class="ident" id="6878685">parts</span><span class="op" id="6878690">)</span>&nbsp;<span class="op" id="6878692">&lt;</span>&nbsp;<span class="num" id="6878694">1</span>&nbsp;<span class="op" id="6878696">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878700">return</span>&nbsp;<span class="ident" id="6878707">nil</span><span class="op" id="6878710">,</span>&nbsp;<span class="ident" id="6878712">errf</span><span class="op" id="6878716">(</span><span class="string" id="6878717">&#34;empty&nbsp;query&#34;</span><span class="op" id="6878730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6878733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878736">cmd</span>&nbsp;<span class="op" id="6878740">:=</span>&nbsp;<span class="ident" id="6878743">parts</span><span class="op" id="6878748">[</span><span class="num" id="6878749">0</span><span class="op" id="6878750">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878753">parts</span>&nbsp;<span class="op" id="6878759">=</span>&nbsp;<span class="ident" id="6878761">parts</span><span class="op" id="6878766">[</span><span class="num" id="6878767">1</span><span class="op" id="6878768">:</span><span class="op" id="6878769">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878772">stmt</span>&nbsp;<span class="op" id="6878777">:=</span>&nbsp;<span class="op" id="6878780">&amp;</span><span class="ident" id="6878781">fakeStmt</span><span class="op" id="6878789">{</span><span class="ident" id="6878790">q</span><span class="op" id="6878791">:</span>&nbsp;<span class="ident" id="6878793">query</span><span class="op" id="6878798">,</span>&nbsp;<span class="ident" id="6878800">c</span><span class="op" id="6878801">:</span>&nbsp;<span class="ident" id="6878803">c</span><span class="op" id="6878804">,</span>&nbsp;<span class="ident" id="6878806">cmd</span><span class="op" id="6878809">:</span>&nbsp;<span class="ident" id="6878811">cmd</span><span class="op" id="6878814">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6878817">c</span><span class="op" id="6878818">.</span><span class="ident" id="6878819">incrStat</span><span class="op" id="6878827">(</span><span class="op" id="6878828">&amp;</span><span class="ident" id="6878829">c</span><span class="op" id="6878830">.</span><span class="ident" id="6878831">stmtsMade</span><span class="op" id="6878840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878843">switch</span>&nbsp;<span class="ident" id="6878850">cmd</span>&nbsp;<span class="op" id="6878854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878857">case</span>&nbsp;<span class="string" id="6878862">&#34;WIPE&#34;</span><span class="op" id="6878868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6878872">//&nbsp;Nothing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878884">case</span>&nbsp;<span class="string" id="6878889">&#34;SELECT&#34;</span><span class="op" id="6878897">:</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878901">return</span>&nbsp;<span class="ident" id="6878908">c</span><span class="op" id="6878909">.</span><span class="ident" id="6878910">prepareSelect</span><span class="op" id="6878923">(</span><span class="ident" id="6878924">stmt</span><span class="op" id="6878928">,</span>&nbsp;<span class="ident" id="6878930">parts</span><span class="op" id="6878935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878938">case</span>&nbsp;<span class="string" id="6878943">&#34;CREATE&#34;</span><span class="op" id="6878951">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878955">return</span>&nbsp;<span class="ident" id="6878962">c</span><span class="op" id="6878963">.</span><span class="ident" id="6878964">prepareCreate</span><span class="op" id="6878977">(</span><span class="ident" id="6878978">stmt</span><span class="op" id="6878982">,</span>&nbsp;<span class="ident" id="6878984">parts</span><span class="op" id="6878989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6878992">case</span>&nbsp;<span class="string" id="6878997">&#34;INSERT&#34;</span><span class="op" id="6879005">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879009">return</span>&nbsp;<span class="ident" id="6879016">c</span><span class="op" id="6879017">.</span><span class="ident" id="6879018">prepareInsert</span><span class="op" id="6879031">(</span><span class="ident" id="6879032">stmt</span><span class="op" id="6879036">,</span>&nbsp;<span class="ident" id="6879038">parts</span><span class="op" id="6879043">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879046">case</span>&nbsp;<span class="string" id="6879051">&#34;NOSERT&#34;</span><span class="op" id="6879059">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6879063">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6879143">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879187">return</span>&nbsp;<span class="ident" id="6879194">c</span><span class="op" id="6879195">.</span><span class="ident" id="6879196">prepareInsert</span><span class="op" id="6879209">(</span><span class="ident" id="6879210">stmt</span><span class="op" id="6879214">,</span>&nbsp;<span class="ident" id="6879216">parts</span><span class="op" id="6879221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879224">default</span><span class="op" id="6879231">:</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879235">stmt</span><span class="op" id="6879239">.</span><span class="ident" id="6879240">Close</span><span class="op" id="6879245">(</span><span class="op" id="6879246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879250">return</span>&nbsp;<span class="ident" id="6879257">nil</span><span class="op" id="6879260">,</span>&nbsp;<span class="ident" id="6879262">errf</span><span class="op" id="6879266">(</span><span class="string" id="6879267">&#34;unsupported&nbsp;command&nbsp;type&nbsp;%q&#34;</span><span class="op" id="6879296">,</span>&nbsp;<span class="ident" id="6879298">cmd</span><span class="op" id="6879301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879307">return</span>&nbsp;<span class="ident" id="6879314">stmt</span><span class="op" id="6879318">,</span>&nbsp;<span class="ident" id="6879320">nil</span><br>
<span class="lineno"></span><span class="op" id="6879324">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="6879327">func</span>&nbsp;<span class="op" id="6879332">(</span><span class="ident" id="6879333">s</span>&nbsp;<span class="op" id="6879335">*</span><span class="ident" id="6879336">fakeStmt</span><span class="op" id="6879344">)</span>&nbsp;<span class="ident" id="6879346">ColumnConverter</span><span class="op" id="6879361">(</span><span class="ident" id="6879362">idx</span>&nbsp;<span class="builtintype" id="6879366">int</span><span class="op" id="6879369">)</span>&nbsp;<span class="ident" id="6879371">driver</span><span class="op" id="6879377">.</span><span class="ident" id="6879378">ValueConverter</span>&nbsp;<span class="op" id="6879393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879396">if</span>&nbsp;<span class="builtinfunc" id="6879399">len</span><span class="op" id="6879402">(</span><span class="ident" id="6879403">s</span><span class="op" id="6879404">.</span><span class="ident" id="6879405">placeholderConverter</span><span class="op" id="6879425">)</span>&nbsp;<span class="op" id="6879427">==</span>&nbsp;<span class="num" id="6879430">0</span>&nbsp;<span class="op" id="6879432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879436">return</span>&nbsp;<span class="ident" id="6879443">driver</span><span class="op" id="6879449">.</span><span class="ident" id="6879450">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879477">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879480">return</span>&nbsp;<span class="ident" id="6879487">s</span><span class="op" id="6879488">.</span><span class="ident" id="6879489">placeholderConverter</span><span class="op" id="6879509">[</span><span class="ident" id="6879510">idx</span><span class="op" id="6879513">]</span><br>
<span class="lineno"></span><span class="op" id="6879515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879518">func</span>&nbsp;<span class="op" id="6879523">(</span><span class="ident" id="6879524">s</span>&nbsp;<span class="op" id="6879526">*</span><span class="ident" id="6879527">fakeStmt</span><span class="op" id="6879535">)</span>&nbsp;<span class="ident" id="6879537">Close</span><span class="op" id="6879542">(</span><span class="op" id="6879543">)</span>&nbsp;<span class="builtintype" id="6879545">error</span>&nbsp;<span class="op" id="6879551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879554">if</span>&nbsp;<span class="ident" id="6879557">s</span><span class="op" id="6879558">.</span><span class="ident" id="6879559">c</span>&nbsp;<span class="op" id="6879561">==</span>&nbsp;<span class="ident" id="6879564">nil</span>&nbsp;<span class="op" id="6879568">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6879572">panic</span><span class="op" id="6879577">(</span><span class="string" id="6879578">&#34;nil&nbsp;conn&nbsp;in&nbsp;fakeStmt.Close&#34;</span><span class="op" id="6879606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879612">if</span>&nbsp;<span class="ident" id="6879615">s</span><span class="op" id="6879616">.</span><span class="ident" id="6879617">c</span><span class="op" id="6879618">.</span><span class="ident" id="6879619">db</span>&nbsp;<span class="op" id="6879622">==</span>&nbsp;<span class="ident" id="6879625">nil</span>&nbsp;<span class="op" id="6879629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6879633">panic</span><span class="op" id="6879638">(</span><span class="string" id="6879639">&#34;in&nbsp;fakeStmt.Close,&nbsp;conn&#39;s&nbsp;db&nbsp;is&nbsp;nil&nbsp;(already&nbsp;closed)&#34;</span><span class="op" id="6879693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879696">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879699">if</span>&nbsp;<span class="op" id="6879702">!</span><span class="ident" id="6879703">s</span><span class="op" id="6879704">.</span><span class="ident" id="6879705">closed</span>&nbsp;<span class="op" id="6879712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879716">s</span><span class="op" id="6879717">.</span><span class="ident" id="6879718">c</span><span class="op" id="6879719">.</span><span class="ident" id="6879720">incrStat</span><span class="op" id="6879728">(</span><span class="op" id="6879729">&amp;</span><span class="ident" id="6879730">s</span><span class="op" id="6879731">.</span><span class="ident" id="6879732">c</span><span class="op" id="6879733">.</span><span class="ident" id="6879734">stmtsClosed</span><span class="op" id="6879745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6879749">s</span><span class="op" id="6879750">.</span><span class="ident" id="6879751">closed</span>&nbsp;<span class="op" id="6879758">=</span>&nbsp;<span class="builtintype" id="6879760">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6879766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879769">return</span>&nbsp;<span class="ident" id="6879776">nil</span><br>
<span class="lineno">520</span><span class="op" id="6879780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879783">var</span>&nbsp;<span class="ident" id="6879787">errClosed</span>&nbsp;<span class="op" id="6879797">=</span>&nbsp;<span class="ident" id="6879799">errors</span><span class="op" id="6879805">.</span><span class="ident" id="6879806">New</span><span class="op" id="6879809">(</span><span class="string" id="6879810">&#34;fakedb:&nbsp;statement&nbsp;has&nbsp;been&nbsp;closed&#34;</span><span class="op" id="6879845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6879848">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno">525</span><span class="keyword" id="6879887">var</span>&nbsp;<span class="ident" id="6879891">hookExecBadConn</span>&nbsp;<span class="keyword" id="6879907">func</span><span class="op" id="6879911">(</span><span class="op" id="6879912">)</span>&nbsp;<span class="builtintype" id="6879914">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6879920">func</span>&nbsp;<span class="op" id="6879925">(</span><span class="ident" id="6879926">s</span>&nbsp;<span class="op" id="6879928">*</span><span class="ident" id="6879929">fakeStmt</span><span class="op" id="6879937">)</span>&nbsp;<span class="ident" id="6879939">Exec</span><span class="op" id="6879943">(</span><span class="ident" id="6879944">args</span>&nbsp;<span class="op" id="6879949">[</span><span class="op" id="6879950">]</span><span class="ident" id="6879951">driver</span><span class="op" id="6879957">.</span><span class="ident" id="6879958">Value</span><span class="op" id="6879963">)</span>&nbsp;<span class="op" id="6879965">(</span><span class="ident" id="6879966">driver</span><span class="op" id="6879972">.</span><span class="ident" id="6879973">Result</span><span class="op" id="6879979">,</span>&nbsp;<span class="builtintype" id="6879981">error</span><span class="op" id="6879986">)</span>&nbsp;<span class="op" id="6879988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6879991">if</span>&nbsp;<span class="ident" id="6879994">s</span><span class="op" id="6879995">.</span><span class="ident" id="6879996">closed</span>&nbsp;<span class="op" id="6880003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880007">return</span>&nbsp;<span class="ident" id="6880014">nil</span><span class="op" id="6880017">,</span>&nbsp;<span class="ident" id="6880019">errClosed</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880034">if</span>&nbsp;<span class="ident" id="6880037">hookExecBadConn</span>&nbsp;<span class="op" id="6880053">!=</span>&nbsp;<span class="ident" id="6880056">nil</span>&nbsp;<span class="op" id="6880060">&amp;&amp;</span>&nbsp;<span class="ident" id="6880063">hookExecBadConn</span><span class="op" id="6880078">(</span><span class="op" id="6880079">)</span>&nbsp;<span class="op" id="6880081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880085">return</span>&nbsp;<span class="ident" id="6880092">nil</span><span class="op" id="6880095">,</span>&nbsp;<span class="ident" id="6880097">driver</span><span class="op" id="6880103">.</span><span class="ident" id="6880104">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880116">}</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880120">err</span>&nbsp;<span class="op" id="6880124">:=</span>&nbsp;<span class="ident" id="6880127">checkSubsetTypes</span><span class="op" id="6880143">(</span><span class="ident" id="6880144">args</span><span class="op" id="6880148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880151">if</span>&nbsp;<span class="ident" id="6880154">err</span>&nbsp;<span class="op" id="6880158">!=</span>&nbsp;<span class="ident" id="6880161">nil</span>&nbsp;<span class="op" id="6880165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880169">return</span>&nbsp;<span class="ident" id="6880176">nil</span><span class="op" id="6880179">,</span>&nbsp;<span class="ident" id="6880181">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880186">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880190">db</span>&nbsp;<span class="op" id="6880193">:=</span>&nbsp;<span class="ident" id="6880196">s</span><span class="op" id="6880197">.</span><span class="ident" id="6880198">c</span><span class="op" id="6880199">.</span><span class="ident" id="6880200">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880204">switch</span>&nbsp;<span class="ident" id="6880211">s</span><span class="op" id="6880212">.</span><span class="ident" id="6880213">cmd</span>&nbsp;<span class="op" id="6880217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880220">case</span>&nbsp;<span class="string" id="6880225">&#34;WIPE&#34;</span><span class="op" id="6880231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880235">db</span><span class="op" id="6880237">.</span><span class="ident" id="6880238">wipe</span><span class="op" id="6880242">(</span><span class="op" id="6880243">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880247">return</span>&nbsp;<span class="ident" id="6880254">driver</span><span class="op" id="6880260">.</span><span class="ident" id="6880261">ResultNoRows</span><span class="op" id="6880273">,</span>&nbsp;<span class="ident" id="6880275">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880280">case</span>&nbsp;<span class="string" id="6880285">&#34;CREATE&#34;</span><span class="op" id="6880293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880297">if</span>&nbsp;<span class="ident" id="6880300">err</span>&nbsp;<span class="op" id="6880304">:=</span>&nbsp;<span class="ident" id="6880307">db</span><span class="op" id="6880309">.</span><span class="ident" id="6880310">createTable</span><span class="op" id="6880321">(</span><span class="ident" id="6880322">s</span><span class="op" id="6880323">.</span><span class="ident" id="6880324">table</span><span class="op" id="6880329">,</span>&nbsp;<span class="ident" id="6880331">s</span><span class="op" id="6880332">.</span><span class="ident" id="6880333">colName</span><span class="op" id="6880340">,</span>&nbsp;<span class="ident" id="6880342">s</span><span class="op" id="6880343">.</span><span class="ident" id="6880344">colType</span><span class="op" id="6880351">)</span><span class="op" id="6880352">;</span>&nbsp;<span class="ident" id="6880354">err</span>&nbsp;<span class="op" id="6880358">!=</span>&nbsp;<span class="ident" id="6880361">nil</span>&nbsp;<span class="op" id="6880365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880370">return</span>&nbsp;<span class="ident" id="6880377">nil</span><span class="op" id="6880380">,</span>&nbsp;<span class="ident" id="6880382">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880388">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880392">return</span>&nbsp;<span class="ident" id="6880399">driver</span><span class="op" id="6880405">.</span><span class="ident" id="6880406">ResultNoRows</span><span class="op" id="6880418">,</span>&nbsp;<span class="ident" id="6880420">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880425">case</span>&nbsp;<span class="string" id="6880430">&#34;INSERT&#34;</span><span class="op" id="6880438">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880442">return</span>&nbsp;<span class="ident" id="6880449">s</span><span class="op" id="6880450">.</span><span class="ident" id="6880451">execInsert</span><span class="op" id="6880461">(</span><span class="ident" id="6880462">args</span><span class="op" id="6880466">,</span>&nbsp;<span class="builtintype" id="6880468">true</span><span class="op" id="6880472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880475">case</span>&nbsp;<span class="string" id="6880480">&#34;NOSERT&#34;</span><span class="op" id="6880488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6880492">//&nbsp;Do&nbsp;all&nbsp;the&nbsp;prep-work&nbsp;like&nbsp;for&nbsp;an&nbsp;INSERT&nbsp;but&nbsp;don&#39;t&nbsp;actually&nbsp;insert&nbsp;the&nbsp;row.</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6880572">//&nbsp;Used&nbsp;for&nbsp;some&nbsp;of&nbsp;the&nbsp;concurrent&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880616">return</span>&nbsp;<span class="ident" id="6880623">s</span><span class="op" id="6880624">.</span><span class="ident" id="6880625">execInsert</span><span class="op" id="6880635">(</span><span class="ident" id="6880636">args</span><span class="op" id="6880640">,</span>&nbsp;<span class="builtintype" id="6880642">false</span><span class="op" id="6880647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6880650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6880653">fmt</span><span class="op" id="6880656">.</span><span class="ident" id="6880657">Printf</span><span class="op" id="6880663">(</span><span class="string" id="6880664">&#34;EXEC&nbsp;statement,&nbsp;cmd=%q:&nbsp;%#v\n&#34;</span><span class="op" id="6880695">,</span>&nbsp;<span class="ident" id="6880697">s</span><span class="op" id="6880698">.</span><span class="ident" id="6880699">cmd</span><span class="op" id="6880702">,</span>&nbsp;<span class="ident" id="6880704">s</span><span class="op" id="6880705">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6880708">return</span>&nbsp;<span class="ident" id="6880715">nil</span><span class="op" id="6880718">,</span>&nbsp;<span class="ident" id="6880720">fmt</span><span class="op" id="6880723">.</span><span class="ident" id="6880724">Errorf</span><span class="op" id="6880730">(</span><span class="string" id="6880731">&#34;unimplemented&nbsp;statement&nbsp;Exec&nbsp;command&nbsp;type&nbsp;of&nbsp;%q&#34;</span><span class="op" id="6880780">,</span>&nbsp;<span class="ident" id="6880782">s</span><span class="op" id="6880783">.</span><span class="ident" id="6880784">cmd</span><span class="op" id="6880787">)</span><br>
<span class="lineno">560</span><span class="op" id="6880789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6880792">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;true,&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span><span class="comment" id="6880844">//&nbsp;When&nbsp;doInsert&nbsp;is&nbsp;false&nbsp;do&nbsp;prep-work&nbsp;and&nbsp;error&nbsp;checking,&nbsp;but&nbsp;don&#39;t</span><br>
<span class="lineno"></span><span class="comment" id="6880913">//&nbsp;actually&nbsp;add&nbsp;the&nbsp;row&nbsp;to&nbsp;the&nbsp;table.</span><br>
<span class="lineno">565</span><span class="keyword" id="6880951">func</span>&nbsp;<span class="op" id="6880956">(</span><span class="ident" id="6880957">s</span>&nbsp;<span class="op" id="6880959">*</span><span class="ident" id="6880960">fakeStmt</span><span class="op" id="6880968">)</span>&nbsp;<span class="ident" id="6880970">execInsert</span><span class="op" id="6880980">(</span><span class="ident" id="6880981">args</span>&nbsp;<span class="op" id="6880986">[</span><span class="op" id="6880987">]</span><span class="ident" id="6880988">driver</span><span class="op" id="6880994">.</span><span class="ident" id="6880995">Value</span><span class="op" id="6881000">,</span>&nbsp;<span class="ident" id="6881002">doInsert</span>&nbsp;<span class="builtintype" id="6881011">bool</span><span class="op" id="6881015">)</span>&nbsp;<span class="op" id="6881017">(</span><span class="ident" id="6881018">driver</span><span class="op" id="6881024">.</span><span class="ident" id="6881025">Result</span><span class="op" id="6881031">,</span>&nbsp;<span class="builtintype" id="6881033">error</span><span class="op" id="6881038">)</span>&nbsp;<span class="op" id="6881040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881043">db</span>&nbsp;<span class="op" id="6881046">:=</span>&nbsp;<span class="ident" id="6881049">s</span><span class="op" id="6881050">.</span><span class="ident" id="6881051">c</span><span class="op" id="6881052">.</span><span class="ident" id="6881053">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881057">if</span>&nbsp;<span class="builtinfunc" id="6881060">len</span><span class="op" id="6881063">(</span><span class="ident" id="6881064">args</span><span class="op" id="6881068">)</span>&nbsp;<span class="op" id="6881070">!=</span>&nbsp;<span class="ident" id="6881073">s</span><span class="op" id="6881074">.</span><span class="ident" id="6881075">placeholders</span>&nbsp;<span class="op" id="6881088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6881092">panic</span><span class="op" id="6881097">(</span><span class="string" id="6881098">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6881156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881159">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881162">db</span><span class="op" id="6881164">.</span><span class="ident" id="6881165">mu</span><span class="op" id="6881167">.</span><span class="ident" id="6881168">Lock</span><span class="op" id="6881172">(</span><span class="op" id="6881173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881176">t</span><span class="op" id="6881177">,</span>&nbsp;<span class="ident" id="6881179">ok</span>&nbsp;<span class="op" id="6881182">:=</span>&nbsp;<span class="ident" id="6881185">db</span><span class="op" id="6881187">.</span><span class="ident" id="6881188">table</span><span class="op" id="6881193">(</span><span class="ident" id="6881194">s</span><span class="op" id="6881195">.</span><span class="ident" id="6881196">table</span><span class="op" id="6881201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881204">db</span><span class="op" id="6881206">.</span><span class="ident" id="6881207">mu</span><span class="op" id="6881209">.</span><span class="ident" id="6881210">Unlock</span><span class="op" id="6881216">(</span><span class="op" id="6881217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881220">if</span>&nbsp;<span class="op" id="6881223">!</span><span class="ident" id="6881224">ok</span>&nbsp;<span class="op" id="6881227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881231">return</span>&nbsp;<span class="ident" id="6881238">nil</span><span class="op" id="6881241">,</span>&nbsp;<span class="ident" id="6881243">fmt</span><span class="op" id="6881246">.</span><span class="ident" id="6881247">Errorf</span><span class="op" id="6881253">(</span><span class="string" id="6881254">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6881286">,</span>&nbsp;<span class="ident" id="6881288">s</span><span class="op" id="6881289">.</span><span class="ident" id="6881290">table</span><span class="op" id="6881295">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881302">t</span><span class="op" id="6881303">.</span><span class="ident" id="6881304">mu</span><span class="op" id="6881306">.</span><span class="ident" id="6881307">Lock</span><span class="op" id="6881311">(</span><span class="op" id="6881312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881315">defer</span>&nbsp;<span class="ident" id="6881321">t</span><span class="op" id="6881322">.</span><span class="ident" id="6881323">mu</span><span class="op" id="6881325">.</span><span class="ident" id="6881326">Unlock</span><span class="op" id="6881332">(</span><span class="op" id="6881333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881337">var</span>&nbsp;<span class="ident" id="6881341">cols</span>&nbsp;<span class="op" id="6881346">[</span><span class="op" id="6881347">]</span><span class="keyword" id="6881348">interface</span><span class="op" id="6881357">{</span><span class="op" id="6881358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881361">if</span>&nbsp;<span class="ident" id="6881364">doInsert</span>&nbsp;<span class="op" id="6881373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881377">cols</span>&nbsp;<span class="op" id="6881382">=</span>&nbsp;<span class="builtinfunc" id="6881384">make</span><span class="op" id="6881388">(</span><span class="op" id="6881389">[</span><span class="op" id="6881390">]</span><span class="keyword" id="6881391">interface</span><span class="op" id="6881400">{</span><span class="op" id="6881401">}</span><span class="op" id="6881402">,</span>&nbsp;<span class="builtinfunc" id="6881404">len</span><span class="op" id="6881407">(</span><span class="ident" id="6881408">t</span><span class="op" id="6881409">.</span><span class="ident" id="6881410">colname</span><span class="op" id="6881417">)</span><span class="op" id="6881418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881424">argPos</span>&nbsp;<span class="op" id="6881431">:=</span>&nbsp;<span class="num" id="6881434">0</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881437">for</span>&nbsp;<span class="ident" id="6881441">n</span><span class="op" id="6881442">,</span>&nbsp;<span class="ident" id="6881444">colname</span>&nbsp;<span class="op" id="6881452">:=</span>&nbsp;<span class="keyword" id="6881455">range</span>&nbsp;<span class="ident" id="6881461">s</span><span class="op" id="6881462">.</span><span class="ident" id="6881463">colName</span>&nbsp;<span class="op" id="6881471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881475">colidx</span>&nbsp;<span class="op" id="6881482">:=</span>&nbsp;<span class="ident" id="6881485">t</span><span class="op" id="6881486">.</span><span class="ident" id="6881487">columnIndex</span><span class="op" id="6881498">(</span><span class="ident" id="6881499">colname</span><span class="op" id="6881506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881510">if</span>&nbsp;<span class="ident" id="6881513">colidx</span>&nbsp;<span class="op" id="6881520">==</span>&nbsp;<span class="op" id="6881523">-</span><span class="num" id="6881524">1</span>&nbsp;<span class="op" id="6881526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881531">return</span>&nbsp;<span class="ident" id="6881538">nil</span><span class="op" id="6881541">,</span>&nbsp;<span class="ident" id="6881543">fmt</span><span class="op" id="6881546">.</span><span class="ident" id="6881547">Errorf</span><span class="op" id="6881553">(</span><span class="string" id="6881554">&#34;fakedb:&nbsp;column&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&nbsp;or&nbsp;dropped&nbsp;since&nbsp;prepared&nbsp;statement&nbsp;was&nbsp;created&#34;</span><span class="op" id="6881635">,</span>&nbsp;<span class="ident" id="6881637">colname</span><span class="op" id="6881644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881648">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881652">var</span>&nbsp;<span class="ident" id="6881656">val</span>&nbsp;<span class="keyword" id="6881660">interface</span><span class="op" id="6881669">{</span><span class="op" id="6881670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881674">if</span>&nbsp;<span class="ident" id="6881677">strvalue</span><span class="op" id="6881685">,</span>&nbsp;<span class="ident" id="6881687">ok</span>&nbsp;<span class="op" id="6881690">:=</span>&nbsp;<span class="ident" id="6881693">s</span><span class="op" id="6881694">.</span><span class="ident" id="6881695">colValue</span><span class="op" id="6881703">[</span><span class="ident" id="6881704">n</span><span class="op" id="6881705">]</span><span class="op" id="6881706">.</span><span class="op" id="6881707">(</span><span class="builtintype" id="6881708">string</span><span class="op" id="6881714">)</span><span class="op" id="6881715">;</span>&nbsp;<span class="ident" id="6881717">ok</span>&nbsp;<span class="op" id="6881720">&amp;&amp;</span>&nbsp;<span class="ident" id="6881723">strvalue</span>&nbsp;<span class="op" id="6881732">==</span>&nbsp;<span class="string" id="6881735">&#34;?&#34;</span>&nbsp;<span class="op" id="6881739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881744">val</span>&nbsp;<span class="op" id="6881748">=</span>&nbsp;<span class="ident" id="6881750">args</span><span class="op" id="6881754">[</span><span class="ident" id="6881755">argPos</span><span class="op" id="6881761">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881766">argPos</span><span class="op" id="6881772">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881777">}</span>&nbsp;<span class="keyword" id="6881779">else</span>&nbsp;<span class="op" id="6881784">{</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881789">val</span>&nbsp;<span class="op" id="6881793">=</span>&nbsp;<span class="ident" id="6881795">s</span><span class="op" id="6881796">.</span><span class="ident" id="6881797">colValue</span><span class="op" id="6881805">[</span><span class="ident" id="6881806">n</span><span class="op" id="6881807">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881815">if</span>&nbsp;<span class="ident" id="6881818">doInsert</span>&nbsp;<span class="op" id="6881827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881832">cols</span><span class="op" id="6881836">[</span><span class="ident" id="6881837">colidx</span><span class="op" id="6881843">]</span>&nbsp;<span class="op" id="6881845">=</span>&nbsp;<span class="ident" id="6881847">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881853">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881860">if</span>&nbsp;<span class="ident" id="6881863">doInsert</span>&nbsp;<span class="op" id="6881872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6881876">t</span><span class="op" id="6881877">.</span><span class="ident" id="6881878">rows</span>&nbsp;<span class="op" id="6881883">=</span>&nbsp;<span class="builtinfunc" id="6881885">append</span><span class="op" id="6881891">(</span><span class="ident" id="6881892">t</span><span class="op" id="6881893">.</span><span class="ident" id="6881894">rows</span><span class="op" id="6881898">,</span>&nbsp;<span class="op" id="6881900">&amp;</span><span class="ident" id="6881901">row</span><span class="op" id="6881904">{</span><span class="ident" id="6881905">cols</span><span class="op" id="6881909">:</span>&nbsp;<span class="ident" id="6881911">cols</span><span class="op" id="6881915">}</span><span class="op" id="6881916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6881919">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6881922">return</span>&nbsp;<span class="ident" id="6881929">driver</span><span class="op" id="6881935">.</span><span class="ident" id="6881936">RowsAffected</span><span class="op" id="6881948">(</span><span class="num" id="6881949">1</span><span class="op" id="6881950">)</span><span class="op" id="6881951">,</span>&nbsp;<span class="ident" id="6881953">nil</span><br>
<span class="lineno"></span><span class="op" id="6881957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6881960">//&nbsp;hook&nbsp;to&nbsp;simulate&nbsp;broken&nbsp;connections</span><br>
<span class="lineno"></span><span class="keyword" id="6881999">var</span>&nbsp;<span class="ident" id="6882003">hookQueryBadConn</span>&nbsp;<span class="keyword" id="6882020">func</span><span class="op" id="6882024">(</span><span class="op" id="6882025">)</span>&nbsp;<span class="builtintype" id="6882027">bool</span><br>
<span class="lineno">610</span><br>
<span class="lineno"></span><span class="keyword" id="6882033">func</span>&nbsp;<span class="op" id="6882038">(</span><span class="ident" id="6882039">s</span>&nbsp;<span class="op" id="6882041">*</span><span class="ident" id="6882042">fakeStmt</span><span class="op" id="6882050">)</span>&nbsp;<span class="ident" id="6882052">Query</span><span class="op" id="6882057">(</span><span class="ident" id="6882058">args</span>&nbsp;<span class="op" id="6882063">[</span><span class="op" id="6882064">]</span><span class="ident" id="6882065">driver</span><span class="op" id="6882071">.</span><span class="ident" id="6882072">Value</span><span class="op" id="6882077">)</span>&nbsp;<span class="op" id="6882079">(</span><span class="ident" id="6882080">driver</span><span class="op" id="6882086">.</span><span class="ident" id="6882087">Rows</span><span class="op" id="6882091">,</span>&nbsp;<span class="builtintype" id="6882093">error</span><span class="op" id="6882098">)</span>&nbsp;<span class="op" id="6882100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882103">if</span>&nbsp;<span class="ident" id="6882106">s</span><span class="op" id="6882107">.</span><span class="ident" id="6882108">closed</span>&nbsp;<span class="op" id="6882115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882119">return</span>&nbsp;<span class="ident" id="6882126">nil</span><span class="op" id="6882129">,</span>&nbsp;<span class="ident" id="6882131">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882142">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882146">if</span>&nbsp;<span class="ident" id="6882149">hookQueryBadConn</span>&nbsp;<span class="op" id="6882166">!=</span>&nbsp;<span class="ident" id="6882169">nil</span>&nbsp;<span class="op" id="6882173">&amp;&amp;</span>&nbsp;<span class="ident" id="6882176">hookQueryBadConn</span><span class="op" id="6882192">(</span><span class="op" id="6882193">)</span>&nbsp;<span class="op" id="6882195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882199">return</span>&nbsp;<span class="ident" id="6882206">nil</span><span class="op" id="6882209">,</span>&nbsp;<span class="ident" id="6882211">driver</span><span class="op" id="6882217">.</span><span class="ident" id="6882218">ErrBadConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882234">err</span>&nbsp;<span class="op" id="6882238">:=</span>&nbsp;<span class="ident" id="6882241">checkSubsetTypes</span><span class="op" id="6882257">(</span><span class="ident" id="6882258">args</span><span class="op" id="6882262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882265">if</span>&nbsp;<span class="ident" id="6882268">err</span>&nbsp;<span class="op" id="6882272">!=</span>&nbsp;<span class="ident" id="6882275">nil</span>&nbsp;<span class="op" id="6882279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882283">return</span>&nbsp;<span class="ident" id="6882290">nil</span><span class="op" id="6882293">,</span>&nbsp;<span class="ident" id="6882295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882304">db</span>&nbsp;<span class="op" id="6882307">:=</span>&nbsp;<span class="ident" id="6882310">s</span><span class="op" id="6882311">.</span><span class="ident" id="6882312">c</span><span class="op" id="6882313">.</span><span class="ident" id="6882314">db</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882318">if</span>&nbsp;<span class="builtinfunc" id="6882321">len</span><span class="op" id="6882324">(</span><span class="ident" id="6882325">args</span><span class="op" id="6882329">)</span>&nbsp;<span class="op" id="6882331">!=</span>&nbsp;<span class="ident" id="6882334">s</span><span class="op" id="6882335">.</span><span class="ident" id="6882336">placeholders</span>&nbsp;<span class="op" id="6882349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6882353">panic</span><span class="op" id="6882358">(</span><span class="string" id="6882359">&#34;error&nbsp;in&nbsp;pkg&nbsp;db;&nbsp;should&nbsp;only&nbsp;get&nbsp;here&nbsp;if&nbsp;size&nbsp;is&nbsp;correct&#34;</span><span class="op" id="6882417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882424">db</span><span class="op" id="6882426">.</span><span class="ident" id="6882427">mu</span><span class="op" id="6882429">.</span><span class="ident" id="6882430">Lock</span><span class="op" id="6882434">(</span><span class="op" id="6882435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882438">t</span><span class="op" id="6882439">,</span>&nbsp;<span class="ident" id="6882441">ok</span>&nbsp;<span class="op" id="6882444">:=</span>&nbsp;<span class="ident" id="6882447">db</span><span class="op" id="6882449">.</span><span class="ident" id="6882450">table</span><span class="op" id="6882455">(</span><span class="ident" id="6882456">s</span><span class="op" id="6882457">.</span><span class="ident" id="6882458">table</span><span class="op" id="6882463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882466">db</span><span class="op" id="6882468">.</span><span class="ident" id="6882469">mu</span><span class="op" id="6882471">.</span><span class="ident" id="6882472">Unlock</span><span class="op" id="6882478">(</span><span class="op" id="6882479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882482">if</span>&nbsp;<span class="op" id="6882485">!</span><span class="ident" id="6882486">ok</span>&nbsp;<span class="op" id="6882489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882493">return</span>&nbsp;<span class="ident" id="6882500">nil</span><span class="op" id="6882503">,</span>&nbsp;<span class="ident" id="6882505">fmt</span><span class="op" id="6882508">.</span><span class="ident" id="6882509">Errorf</span><span class="op" id="6882515">(</span><span class="string" id="6882516">&#34;fakedb:&nbsp;table&nbsp;%q&nbsp;doesn&#39;t&nbsp;exist&#34;</span><span class="op" id="6882548">,</span>&nbsp;<span class="ident" id="6882550">s</span><span class="op" id="6882551">.</span><span class="ident" id="6882552">table</span><span class="op" id="6882557">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882564">if</span>&nbsp;<span class="ident" id="6882567">s</span><span class="op" id="6882568">.</span><span class="ident" id="6882569">table</span>&nbsp;<span class="op" id="6882575">==</span>&nbsp;<span class="string" id="6882578">&#34;magicquery&#34;</span>&nbsp;<span class="op" id="6882591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882595">if</span>&nbsp;<span class="builtinfunc" id="6882598">len</span><span class="op" id="6882601">(</span><span class="ident" id="6882602">s</span><span class="op" id="6882603">.</span><span class="ident" id="6882604">whereCol</span><span class="op" id="6882612">)</span>&nbsp;<span class="op" id="6882614">==</span>&nbsp;<span class="num" id="6882617">2</span>&nbsp;<span class="op" id="6882619">&amp;&amp;</span>&nbsp;<span class="ident" id="6882622">s</span><span class="op" id="6882623">.</span><span class="ident" id="6882624">whereCol</span><span class="op" id="6882632">[</span><span class="num" id="6882633">0</span><span class="op" id="6882634">]</span>&nbsp;<span class="op" id="6882636">==</span>&nbsp;<span class="string" id="6882639">&#34;op&#34;</span>&nbsp;<span class="op" id="6882644">&amp;&amp;</span>&nbsp;<span class="ident" id="6882647">s</span><span class="op" id="6882648">.</span><span class="ident" id="6882649">whereCol</span><span class="op" id="6882657">[</span><span class="num" id="6882658">1</span><span class="op" id="6882659">]</span>&nbsp;<span class="op" id="6882661">==</span>&nbsp;<span class="string" id="6882664">&#34;millis&#34;</span>&nbsp;<span class="op" id="6882673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882678">if</span>&nbsp;<span class="ident" id="6882681">args</span><span class="op" id="6882685">[</span><span class="num" id="6882686">0</span><span class="op" id="6882687">]</span>&nbsp;<span class="op" id="6882689">==</span>&nbsp;<span class="string" id="6882692">&#34;sleep&#34;</span>&nbsp;<span class="op" id="6882700">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882706">time</span><span class="op" id="6882710">.</span><span class="ident" id="6882711">Sleep</span><span class="op" id="6882716">(</span><span class="ident" id="6882717">time</span><span class="op" id="6882721">.</span><span class="ident" id="6882722">Duration</span><span class="op" id="6882730">(</span><span class="ident" id="6882731">args</span><span class="op" id="6882735">[</span><span class="num" id="6882736">1</span><span class="op" id="6882737">]</span><span class="op" id="6882738">.</span><span class="op" id="6882739">(</span><span class="ident" id="6882740">int64</span><span class="op" id="6882745">)</span><span class="op" id="6882746">)</span>&nbsp;<span class="op" id="6882748">*</span>&nbsp;<span class="ident" id="6882750">time</span><span class="op" id="6882754">.</span><span class="ident" id="6882755">Millisecond</span><span class="op" id="6882766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6882778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882782">t</span><span class="op" id="6882783">.</span><span class="ident" id="6882784">mu</span><span class="op" id="6882786">.</span><span class="ident" id="6882787">Lock</span><span class="op" id="6882791">(</span><span class="op" id="6882792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882795">defer</span>&nbsp;<span class="ident" id="6882801">t</span><span class="op" id="6882802">.</span><span class="ident" id="6882803">mu</span><span class="op" id="6882805">.</span><span class="ident" id="6882806">Unlock</span><span class="op" id="6882812">(</span><span class="op" id="6882813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882817">colIdx</span>&nbsp;<span class="op" id="6882824">:=</span>&nbsp;<span class="builtinfunc" id="6882827">make</span><span class="op" id="6882831">(</span><span class="keyword" id="6882832">map</span><span class="op" id="6882835">[</span><span class="builtintype" id="6882836">string</span><span class="op" id="6882842">]</span><span class="builtintype" id="6882843">int</span><span class="op" id="6882846">)</span>&nbsp;<span class="comment" id="6882848">//&nbsp;select&nbsp;column&nbsp;name&nbsp;-&gt;&nbsp;column&nbsp;index&nbsp;in&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882896">for</span>&nbsp;<span class="ident" id="6882900">_</span><span class="op" id="6882901">,</span>&nbsp;<span class="ident" id="6882903">name</span>&nbsp;<span class="op" id="6882908">:=</span>&nbsp;<span class="keyword" id="6882911">range</span>&nbsp;<span class="ident" id="6882917">s</span><span class="op" id="6882918">.</span><span class="ident" id="6882919">colName</span>&nbsp;<span class="op" id="6882927">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6882931">idx</span>&nbsp;<span class="op" id="6882935">:=</span>&nbsp;<span class="ident" id="6882938">t</span><span class="op" id="6882939">.</span><span class="ident" id="6882940">columnIndex</span><span class="op" id="6882951">(</span><span class="ident" id="6882952">name</span><span class="op" id="6882956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882960">if</span>&nbsp;<span class="ident" id="6882963">idx</span>&nbsp;<span class="op" id="6882967">==</span>&nbsp;<span class="op" id="6882970">-</span><span class="num" id="6882971">1</span>&nbsp;<span class="op" id="6882973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6882978">return</span>&nbsp;<span class="ident" id="6882985">nil</span><span class="op" id="6882988">,</span>&nbsp;<span class="ident" id="6882990">fmt</span><span class="op" id="6882993">.</span><span class="ident" id="6882994">Errorf</span><span class="op" id="6883000">(</span><span class="string" id="6883001">&#34;fakedb:&nbsp;unknown&nbsp;column&nbsp;name&nbsp;%q&#34;</span><span class="op" id="6883033">,</span>&nbsp;<span class="ident" id="6883035">name</span><span class="op" id="6883039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883047">colIdx</span><span class="op" id="6883053">[</span><span class="ident" id="6883054">name</span><span class="op" id="6883058">]</span>&nbsp;<span class="op" id="6883060">=</span>&nbsp;<span class="ident" id="6883062">idx</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883071">mrows</span>&nbsp;<span class="op" id="6883077">:=</span>&nbsp;<span class="op" id="6883080">[</span><span class="op" id="6883081">]</span><span class="op" id="6883082">*</span><span class="ident" id="6883083">row</span><span class="op" id="6883086">{</span><span class="op" id="6883087">}</span><br>
<span class="lineno"></span><span class="ident" id="6883089">rows</span><span class="op" id="6883093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883096">for</span>&nbsp;<span class="ident" id="6883100">_</span><span class="op" id="6883101">,</span>&nbsp;<span class="ident" id="6883103">trow</span>&nbsp;<span class="op" id="6883108">:=</span>&nbsp;<span class="keyword" id="6883111">range</span>&nbsp;<span class="ident" id="6883117">t</span><span class="op" id="6883118">.</span><span class="ident" id="6883119">rows</span>&nbsp;<span class="op" id="6883124">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6883128">//&nbsp;Process&nbsp;the&nbsp;where&nbsp;clause,&nbsp;skipping&nbsp;non-match&nbsp;rows.&nbsp;This&nbsp;is&nbsp;lazy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6883197">//&nbsp;and&nbsp;just&nbsp;uses&nbsp;fmt.Sprintf(&#34;%v&#34;)&nbsp;to&nbsp;test&nbsp;equality.&nbsp;&nbsp;Good&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6883265">//&nbsp;for&nbsp;test&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883285">for</span>&nbsp;<span class="ident" id="6883289">widx</span><span class="op" id="6883293">,</span>&nbsp;<span class="ident" id="6883295">wcol</span>&nbsp;<span class="op" id="6883300">:=</span>&nbsp;<span class="keyword" id="6883303">range</span>&nbsp;<span class="ident" id="6883309">s</span><span class="op" id="6883310">.</span><span class="ident" id="6883311">whereCol</span>&nbsp;<span class="op" id="6883320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883325">idx</span>&nbsp;<span class="op" id="6883329">:=</span>&nbsp;<span class="ident" id="6883332">t</span><span class="op" id="6883333">.</span><span class="ident" id="6883334">columnIndex</span><span class="op" id="6883345">(</span><span class="ident" id="6883346">wcol</span><span class="op" id="6883350">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883355">if</span>&nbsp;<span class="ident" id="6883358">idx</span>&nbsp;<span class="op" id="6883362">==</span>&nbsp;<span class="op" id="6883365">-</span><span class="num" id="6883366">1</span>&nbsp;<span class="op" id="6883368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883374">return</span>&nbsp;<span class="ident" id="6883381">nil</span><span class="op" id="6883384">,</span>&nbsp;<span class="ident" id="6883386">fmt</span><span class="op" id="6883389">.</span><span class="ident" id="6883390">Errorf</span><span class="op" id="6883396">(</span><span class="string" id="6883397">&#34;db:&nbsp;invalid&nbsp;where&nbsp;clause&nbsp;column&nbsp;%q&#34;</span><span class="op" id="6883433">,</span>&nbsp;<span class="ident" id="6883435">wcol</span><span class="op" id="6883439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883444">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883449">tcol</span>&nbsp;<span class="op" id="6883454">:=</span>&nbsp;<span class="ident" id="6883457">trow</span><span class="op" id="6883461">.</span><span class="ident" id="6883462">cols</span><span class="op" id="6883466">[</span><span class="ident" id="6883467">idx</span><span class="op" id="6883470">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883475">if</span>&nbsp;<span class="ident" id="6883478">bs</span><span class="op" id="6883480">,</span>&nbsp;<span class="ident" id="6883482">ok</span>&nbsp;<span class="op" id="6883485">:=</span>&nbsp;<span class="ident" id="6883488">tcol</span><span class="op" id="6883492">.</span><span class="op" id="6883493">(</span><span class="op" id="6883494">[</span><span class="op" id="6883495">]</span><span class="builtintype" id="6883496">byte</span><span class="op" id="6883500">)</span><span class="op" id="6883501">;</span>&nbsp;<span class="ident" id="6883503">ok</span>&nbsp;<span class="op" id="6883506">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6883512">//&nbsp;lazy&nbsp;hack&nbsp;to&nbsp;avoid&nbsp;sprintf&nbsp;%v&nbsp;on&nbsp;a&nbsp;[]byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883561">tcol</span>&nbsp;<span class="op" id="6883566">=</span>&nbsp;<span class="builtintype" id="6883568">string</span><span class="op" id="6883574">(</span><span class="ident" id="6883575">bs</span><span class="op" id="6883577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883587">if</span>&nbsp;<span class="ident" id="6883590">fmt</span><span class="op" id="6883593">.</span><span class="ident" id="6883594">Sprintf</span><span class="op" id="6883601">(</span><span class="string" id="6883602">&#34;%v&#34;</span><span class="op" id="6883606">,</span>&nbsp;<span class="ident" id="6883608">tcol</span><span class="op" id="6883612">)</span>&nbsp;<span class="op" id="6883614">!=</span>&nbsp;<span class="ident" id="6883617">fmt</span><span class="op" id="6883620">.</span><span class="ident" id="6883621">Sprintf</span><span class="op" id="6883628">(</span><span class="string" id="6883629">&#34;%v&#34;</span><span class="op" id="6883633">,</span>&nbsp;<span class="ident" id="6883635">args</span><span class="op" id="6883639">[</span><span class="ident" id="6883640">widx</span><span class="op" id="6883644">]</span><span class="op" id="6883645">)</span>&nbsp;<span class="op" id="6883647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883653">continue</span>&nbsp;<span class="ident" id="6883662">rows</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883678">mrow</span>&nbsp;<span class="op" id="6883683">:=</span>&nbsp;<span class="op" id="6883686">&amp;</span><span class="ident" id="6883687">row</span><span class="op" id="6883690">{</span><span class="ident" id="6883691">cols</span><span class="op" id="6883695">:</span>&nbsp;<span class="builtinfunc" id="6883697">make</span><span class="op" id="6883701">(</span><span class="op" id="6883702">[</span><span class="op" id="6883703">]</span><span class="keyword" id="6883704">interface</span><span class="op" id="6883713">{</span><span class="op" id="6883714">}</span><span class="op" id="6883715">,</span>&nbsp;<span class="builtinfunc" id="6883717">len</span><span class="op" id="6883720">(</span><span class="ident" id="6883721">s</span><span class="op" id="6883722">.</span><span class="ident" id="6883723">colName</span><span class="op" id="6883730">)</span><span class="op" id="6883731">)</span><span class="op" id="6883732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883736">for</span>&nbsp;<span class="ident" id="6883740">seli</span><span class="op" id="6883744">,</span>&nbsp;<span class="ident" id="6883746">name</span>&nbsp;<span class="op" id="6883751">:=</span>&nbsp;<span class="keyword" id="6883754">range</span>&nbsp;<span class="ident" id="6883760">s</span><span class="op" id="6883761">.</span><span class="ident" id="6883762">colName</span>&nbsp;<span class="op" id="6883770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883775">mrow</span><span class="op" id="6883779">.</span><span class="ident" id="6883780">cols</span><span class="op" id="6883784">[</span><span class="ident" id="6883785">seli</span><span class="op" id="6883789">]</span>&nbsp;<span class="op" id="6883791">=</span>&nbsp;<span class="ident" id="6883793">trow</span><span class="op" id="6883797">.</span><span class="ident" id="6883798">cols</span><span class="op" id="6883802">[</span><span class="ident" id="6883803">colIdx</span><span class="op" id="6883809">[</span><span class="ident" id="6883810">name</span><span class="op" id="6883814">]</span><span class="op" id="6883815">]</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883823">mrows</span>&nbsp;<span class="op" id="6883829">=</span>&nbsp;<span class="builtinfunc" id="6883831">append</span><span class="op" id="6883837">(</span><span class="ident" id="6883838">mrows</span><span class="op" id="6883843">,</span>&nbsp;<span class="ident" id="6883845">mrow</span><span class="op" id="6883849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883856">cursor</span>&nbsp;<span class="op" id="6883863">:=</span>&nbsp;<span class="op" id="6883866">&amp;</span><span class="ident" id="6883867">rowsCursor</span><span class="op" id="6883877">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883881">pos</span><span class="op" id="6883884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6883889">-</span><span class="num" id="6883890">1</span><span class="op" id="6883891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883895">rows</span><span class="op" id="6883899">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6883903">mrows</span><span class="op" id="6883908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883912">cols</span><span class="op" id="6883916">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6883920">s</span><span class="op" id="6883921">.</span><span class="ident" id="6883922">colName</span><span class="op" id="6883929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6883933">errPos</span><span class="op" id="6883939">:</span>&nbsp;<span class="op" id="6883941">-</span><span class="num" id="6883942">1</span><span class="op" id="6883943">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6883946">}</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6883949">return</span>&nbsp;<span class="ident" id="6883956">cursor</span><span class="op" id="6883962">,</span>&nbsp;<span class="ident" id="6883964">nil</span><br>
<span class="lineno"></span><span class="op" id="6883968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6883971">func</span>&nbsp;<span class="op" id="6883976">(</span><span class="ident" id="6883977">s</span>&nbsp;<span class="op" id="6883979">*</span><span class="ident" id="6883980">fakeStmt</span><span class="op" id="6883988">)</span>&nbsp;<span class="ident" id="6883990">NumInput</span><span class="op" id="6883998">(</span><span class="op" id="6883999">)</span>&nbsp;<span class="builtintype" id="6884001">int</span>&nbsp;<span class="op" id="6884005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884008">return</span>&nbsp;<span class="ident" id="6884015">s</span><span class="op" id="6884016">.</span><span class="ident" id="6884017">placeholders</span><br>
<span class="lineno">695</span><span class="op" id="6884030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884033">func</span>&nbsp;<span class="op" id="6884038">(</span><span class="ident" id="6884039">tx</span>&nbsp;<span class="op" id="6884042">*</span><span class="ident" id="6884043">fakeTx</span><span class="op" id="6884049">)</span>&nbsp;<span class="ident" id="6884051">Commit</span><span class="op" id="6884057">(</span><span class="op" id="6884058">)</span>&nbsp;<span class="builtintype" id="6884060">error</span>&nbsp;<span class="op" id="6884066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884069">tx</span><span class="op" id="6884071">.</span><span class="ident" id="6884072">c</span><span class="op" id="6884073">.</span><span class="ident" id="6884074">currTx</span>&nbsp;<span class="op" id="6884081">=</span>&nbsp;<span class="ident" id="6884083">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884088">return</span>&nbsp;<span class="ident" id="6884095">nil</span><br>
<span class="lineno">700</span><span class="op" id="6884099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884102">func</span>&nbsp;<span class="op" id="6884107">(</span><span class="ident" id="6884108">tx</span>&nbsp;<span class="op" id="6884111">*</span><span class="ident" id="6884112">fakeTx</span><span class="op" id="6884118">)</span>&nbsp;<span class="ident" id="6884120">Rollback</span><span class="op" id="6884128">(</span><span class="op" id="6884129">)</span>&nbsp;<span class="builtintype" id="6884131">error</span>&nbsp;<span class="op" id="6884137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884140">tx</span><span class="op" id="6884142">.</span><span class="ident" id="6884143">c</span><span class="op" id="6884144">.</span><span class="ident" id="6884145">currTx</span>&nbsp;<span class="op" id="6884152">=</span>&nbsp;<span class="ident" id="6884154">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884159">return</span>&nbsp;<span class="ident" id="6884166">nil</span><br>
<span class="lineno">705</span><span class="op" id="6884170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884173">type</span>&nbsp;<span class="ident" id="6884178">rowsCursor</span>&nbsp;<span class="keyword" id="6884189">struct</span>&nbsp;<span class="op" id="6884196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884199">cols</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6884206">[</span><span class="op" id="6884207">]</span><span class="builtintype" id="6884208">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884216">pos</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6884223">int</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884228">rows</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6884235">[</span><span class="op" id="6884236">]</span><span class="op" id="6884237">*</span><span class="ident" id="6884238">row</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884243">closed</span>&nbsp;<span class="builtintype" id="6884250">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884257">//&nbsp;errPos&nbsp;and&nbsp;err&nbsp;are&nbsp;for&nbsp;making&nbsp;Next&nbsp;return&nbsp;early&nbsp;with&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884321">errPos</span>&nbsp;<span class="builtintype" id="6884328">int</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884333">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6884340">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884348">//&nbsp;a&nbsp;clone&nbsp;of&nbsp;slices&nbsp;to&nbsp;give&nbsp;out&nbsp;to&nbsp;clients,&nbsp;indexed&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884409">//&nbsp;the&nbsp;original&nbsp;slice&#39;s&nbsp;first&nbsp;byte&nbsp;address.&nbsp;&nbsp;we&nbsp;clone&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6884469">//&nbsp;just&nbsp;so&nbsp;we&#39;re&nbsp;able&nbsp;to&nbsp;corrupt&nbsp;them&nbsp;on&nbsp;close.</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884518">bytesClone</span>&nbsp;<span class="keyword" id="6884529">map</span><span class="op" id="6884532">[</span><span class="op" id="6884533">*</span><span class="builtintype" id="6884534">byte</span><span class="op" id="6884538">]</span><span class="op" id="6884539">[</span><span class="op" id="6884540">]</span><span class="builtintype" id="6884541">byte</span><br>
<span class="lineno"></span><span class="op" id="6884546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884549">func</span>&nbsp;<span class="op" id="6884554">(</span><span class="ident" id="6884555">rc</span>&nbsp;<span class="op" id="6884558">*</span><span class="ident" id="6884559">rowsCursor</span><span class="op" id="6884569">)</span>&nbsp;<span class="ident" id="6884571">Close</span><span class="op" id="6884576">(</span><span class="op" id="6884577">)</span>&nbsp;<span class="builtintype" id="6884579">error</span>&nbsp;<span class="op" id="6884585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884588">if</span>&nbsp;<span class="op" id="6884591">!</span><span class="ident" id="6884592">rc</span><span class="op" id="6884594">.</span><span class="ident" id="6884595">closed</span>&nbsp;<span class="op" id="6884602">{</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884606">for</span>&nbsp;<span class="ident" id="6884610">_</span><span class="op" id="6884611">,</span>&nbsp;<span class="ident" id="6884613">bs</span>&nbsp;<span class="op" id="6884616">:=</span>&nbsp;<span class="keyword" id="6884619">range</span>&nbsp;<span class="ident" id="6884625">rc</span><span class="op" id="6884627">.</span><span class="ident" id="6884628">bytesClone</span>&nbsp;<span class="op" id="6884639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884644">bs</span><span class="op" id="6884646">[</span><span class="num" id="6884647">0</span><span class="op" id="6884648">]</span>&nbsp;<span class="op" id="6884650">=</span>&nbsp;<span class="num" id="6884652">255</span>&nbsp;<span class="comment" id="6884656">//&nbsp;first&nbsp;byte&nbsp;corrupted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6884688">rc</span><span class="op" id="6884690">.</span><span class="ident" id="6884691">closed</span>&nbsp;<span class="op" id="6884698">=</span>&nbsp;<span class="builtintype" id="6884700">true</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884706">return</span>&nbsp;<span class="ident" id="6884713">nil</span><br>
<span class="lineno"></span><span class="op" id="6884717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884720">func</span>&nbsp;<span class="op" id="6884725">(</span><span class="ident" id="6884726">rc</span>&nbsp;<span class="op" id="6884729">*</span><span class="ident" id="6884730">rowsCursor</span><span class="op" id="6884740">)</span>&nbsp;<span class="ident" id="6884742">Columns</span><span class="op" id="6884749">(</span><span class="op" id="6884750">)</span>&nbsp;<span class="op" id="6884752">[</span><span class="op" id="6884753">]</span><span class="builtintype" id="6884754">string</span>&nbsp;<span class="op" id="6884761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884764">return</span>&nbsp;<span class="ident" id="6884771">rc</span><span class="op" id="6884773">.</span><span class="ident" id="6884774">cols</span><br>
<span class="lineno">735</span><span class="op" id="6884779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884782">var</span>&nbsp;<span class="ident" id="6884786">rowsCursorNextHook</span>&nbsp;<span class="keyword" id="6884805">func</span><span class="op" id="6884809">(</span><span class="ident" id="6884810">dest</span>&nbsp;<span class="op" id="6884815">[</span><span class="op" id="6884816">]</span><span class="ident" id="6884817">driver</span><span class="op" id="6884823">.</span><span class="ident" id="6884824">Value</span><span class="op" id="6884829">)</span>&nbsp;<span class="builtintype" id="6884831">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6884838">func</span>&nbsp;<span class="op" id="6884843">(</span><span class="ident" id="6884844">rc</span>&nbsp;<span class="op" id="6884847">*</span><span class="ident" id="6884848">rowsCursor</span><span class="op" id="6884858">)</span>&nbsp;<span class="ident" id="6884860">Next</span><span class="op" id="6884864">(</span><span class="ident" id="6884865">dest</span>&nbsp;<span class="op" id="6884870">[</span><span class="op" id="6884871">]</span><span class="ident" id="6884872">driver</span><span class="op" id="6884878">.</span><span class="ident" id="6884879">Value</span><span class="op" id="6884884">)</span>&nbsp;<span class="builtintype" id="6884886">error</span>&nbsp;<span class="op" id="6884892">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884895">if</span>&nbsp;<span class="ident" id="6884898">rowsCursorNextHook</span>&nbsp;<span class="op" id="6884917">!=</span>&nbsp;<span class="ident" id="6884920">nil</span>&nbsp;<span class="op" id="6884924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884928">return</span>&nbsp;<span class="ident" id="6884935">rowsCursorNextHook</span><span class="op" id="6884953">(</span><span class="ident" id="6884954">dest</span><span class="op" id="6884958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6884961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884965">if</span>&nbsp;<span class="ident" id="6884968">rc</span><span class="op" id="6884970">.</span><span class="ident" id="6884971">closed</span>&nbsp;<span class="op" id="6884978">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6884982">return</span>&nbsp;<span class="ident" id="6884989">errors</span><span class="op" id="6884995">.</span><span class="ident" id="6884996">New</span><span class="op" id="6884999">(</span><span class="string" id="6885000">&#34;fakedb:&nbsp;cursor&nbsp;is&nbsp;closed&#34;</span><span class="op" id="6885026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885032">rc</span><span class="op" id="6885034">.</span><span class="ident" id="6885035">pos</span><span class="op" id="6885038">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885042">if</span>&nbsp;<span class="ident" id="6885045">rc</span><span class="op" id="6885047">.</span><span class="ident" id="6885048">pos</span>&nbsp;<span class="op" id="6885052">==</span>&nbsp;<span class="ident" id="6885055">rc</span><span class="op" id="6885057">.</span><span class="ident" id="6885058">errPos</span>&nbsp;<span class="op" id="6885065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885069">return</span>&nbsp;<span class="ident" id="6885076">rc</span><span class="op" id="6885078">.</span><span class="ident" id="6885079">err</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885087">if</span>&nbsp;<span class="ident" id="6885090">rc</span><span class="op" id="6885092">.</span><span class="ident" id="6885093">pos</span>&nbsp;<span class="op" id="6885097">&gt;=</span>&nbsp;<span class="builtinfunc" id="6885100">len</span><span class="op" id="6885103">(</span><span class="ident" id="6885104">rc</span><span class="op" id="6885106">.</span><span class="ident" id="6885107">rows</span><span class="op" id="6885111">)</span>&nbsp;<span class="op" id="6885113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885117">return</span>&nbsp;<span class="ident" id="6885124">io</span><span class="op" id="6885126">.</span><span class="ident" id="6885127">EOF</span>&nbsp;<span class="comment" id="6885131">//&nbsp;per&nbsp;interface&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885157">for</span>&nbsp;<span class="ident" id="6885161">i</span><span class="op" id="6885162">,</span>&nbsp;<span class="ident" id="6885164">v</span>&nbsp;<span class="op" id="6885166">:=</span>&nbsp;<span class="keyword" id="6885169">range</span>&nbsp;<span class="ident" id="6885175">rc</span><span class="op" id="6885177">.</span><span class="ident" id="6885178">rows</span><span class="op" id="6885182">[</span><span class="ident" id="6885183">rc</span><span class="op" id="6885185">.</span><span class="ident" id="6885186">pos</span><span class="op" id="6885189">]</span><span class="op" id="6885190">.</span><span class="ident" id="6885191">cols</span>&nbsp;<span class="op" id="6885196">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885200">//&nbsp;TODO(bradfitz):&nbsp;convert&nbsp;to&nbsp;subset&nbsp;types?&nbsp;naah,&nbsp;I</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885254">//&nbsp;think&nbsp;the&nbsp;subset&nbsp;types&nbsp;should&nbsp;only&nbsp;be&nbsp;input&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885306">//&nbsp;driver,&nbsp;but&nbsp;the&nbsp;sql&nbsp;package&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885364">//&nbsp;a&nbsp;wider&nbsp;range&nbsp;of&nbsp;types&nbsp;coming&nbsp;out&nbsp;of&nbsp;drivers.&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885419">//&nbsp;for&nbsp;ease&nbsp;of&nbsp;drivers,&nbsp;and&nbsp;to&nbsp;prevent&nbsp;drivers&nbsp;from</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6885473">//&nbsp;messing&nbsp;up&nbsp;conversions&nbsp;or&nbsp;doing&nbsp;them&nbsp;differently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885528">dest</span><span class="op" id="6885532">[</span><span class="ident" id="6885533">i</span><span class="op" id="6885534">]</span>&nbsp;<span class="op" id="6885536">=</span>&nbsp;<span class="ident" id="6885538">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885543">if</span>&nbsp;<span class="ident" id="6885546">bs</span><span class="op" id="6885548">,</span>&nbsp;<span class="ident" id="6885550">ok</span>&nbsp;<span class="op" id="6885553">:=</span>&nbsp;<span class="ident" id="6885556">v</span><span class="op" id="6885557">.</span><span class="op" id="6885558">(</span><span class="op" id="6885559">[</span><span class="op" id="6885560">]</span><span class="builtintype" id="6885561">byte</span><span class="op" id="6885565">)</span><span class="op" id="6885566">;</span>&nbsp;<span class="ident" id="6885568">ok</span>&nbsp;<span class="op" id="6885571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885576">if</span>&nbsp;<span class="ident" id="6885579">rc</span><span class="op" id="6885581">.</span><span class="ident" id="6885582">bytesClone</span>&nbsp;<span class="op" id="6885593">==</span>&nbsp;<span class="ident" id="6885596">nil</span>&nbsp;<span class="op" id="6885600">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885606">rc</span><span class="op" id="6885608">.</span><span class="ident" id="6885609">bytesClone</span>&nbsp;<span class="op" id="6885620">=</span>&nbsp;<span class="builtinfunc" id="6885622">make</span><span class="op" id="6885626">(</span><span class="keyword" id="6885627">map</span><span class="op" id="6885630">[</span><span class="op" id="6885631">*</span><span class="builtintype" id="6885632">byte</span><span class="op" id="6885636">]</span><span class="op" id="6885637">[</span><span class="op" id="6885638">]</span><span class="builtintype" id="6885639">byte</span><span class="op" id="6885643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885653">clone</span><span class="op" id="6885658">,</span>&nbsp;<span class="ident" id="6885660">ok</span>&nbsp;<span class="op" id="6885663">:=</span>&nbsp;<span class="ident" id="6885666">rc</span><span class="op" id="6885668">.</span><span class="ident" id="6885669">bytesClone</span><span class="op" id="6885679">[</span><span class="op" id="6885680">&amp;</span><span class="ident" id="6885681">bs</span><span class="op" id="6885683">[</span><span class="num" id="6885684">0</span><span class="op" id="6885685">]</span><span class="op" id="6885686">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885691">if</span>&nbsp;<span class="op" id="6885694">!</span><span class="ident" id="6885695">ok</span>&nbsp;<span class="op" id="6885698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885704">clone</span>&nbsp;<span class="op" id="6885710">=</span>&nbsp;<span class="builtinfunc" id="6885712">make</span><span class="op" id="6885716">(</span><span class="op" id="6885717">[</span><span class="op" id="6885718">]</span><span class="builtintype" id="6885719">byte</span><span class="op" id="6885723">,</span>&nbsp;<span class="builtinfunc" id="6885725">len</span><span class="op" id="6885728">(</span><span class="ident" id="6885729">bs</span><span class="op" id="6885731">)</span><span class="op" id="6885732">)</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6885738">copy</span><span class="op" id="6885742">(</span><span class="ident" id="6885743">clone</span><span class="op" id="6885748">,</span>&nbsp;<span class="ident" id="6885750">bs</span><span class="op" id="6885752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885758">rc</span><span class="op" id="6885760">.</span><span class="ident" id="6885761">bytesClone</span><span class="op" id="6885771">[</span><span class="op" id="6885772">&amp;</span><span class="ident" id="6885773">bs</span><span class="op" id="6885775">[</span><span class="num" id="6885776">0</span><span class="op" id="6885777">]</span><span class="op" id="6885778">]</span>&nbsp;<span class="op" id="6885780">=</span>&nbsp;<span class="ident" id="6885782">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6885796">dest</span><span class="op" id="6885800">[</span><span class="ident" id="6885801">i</span><span class="op" id="6885802">]</span>&nbsp;<span class="op" id="6885804">=</span>&nbsp;<span class="ident" id="6885806">clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885814">}</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6885817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6885820">return</span>&nbsp;<span class="ident" id="6885827">nil</span><br>
<span class="lineno"></span><span class="op" id="6885831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6885834">//&nbsp;fakeDriverString&nbsp;is&nbsp;like&nbsp;driver.String,&nbsp;but&nbsp;indirects&nbsp;pointers&nbsp;like</span><br>
<span class="lineno">780</span><span class="comment" id="6885905">//&nbsp;DefaultValueConverter.</span><br>
<span class="lineno"></span><span class="comment" id="6885931">//</span><br>
<span class="lineno"></span><span class="comment" id="6885934">//&nbsp;This&nbsp;could&nbsp;be&nbsp;surprising&nbsp;behavior&nbsp;to&nbsp;retroactively&nbsp;apply&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6885997">//&nbsp;driver.String&nbsp;now&nbsp;that&nbsp;Go1&nbsp;is&nbsp;out,&nbsp;but&nbsp;this&nbsp;is&nbsp;convenient&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6886062">//&nbsp;our&nbsp;TestPointerParamsAndScans.</span><br>
<span class="lineno">785</span><span class="comment" id="6886096">//</span><br>
<span class="lineno"></span><span class="keyword" id="6886099">type</span>&nbsp;<span class="ident" id="6886104">fakeDriverString</span>&nbsp;<span class="keyword" id="6886121">struct</span><span class="op" id="6886127">{</span><span class="op" id="6886128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6886131">func</span>&nbsp;<span class="op" id="6886136">(</span><span class="ident" id="6886137">fakeDriverString</span><span class="op" id="6886153">)</span>&nbsp;<span class="ident" id="6886155">ConvertValue</span><span class="op" id="6886167">(</span><span class="ident" id="6886168">v</span>&nbsp;<span class="keyword" id="6886170">interface</span><span class="op" id="6886179">{</span><span class="op" id="6886180">}</span><span class="op" id="6886181">)</span>&nbsp;<span class="op" id="6886183">(</span><span class="ident" id="6886184">driver</span><span class="op" id="6886190">.</span><span class="ident" id="6886191">Value</span><span class="op" id="6886196">,</span>&nbsp;<span class="builtintype" id="6886198">error</span><span class="op" id="6886203">)</span>&nbsp;<span class="op" id="6886205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886208">switch</span>&nbsp;<span class="ident" id="6886215">c</span>&nbsp;<span class="op" id="6886217">:=</span>&nbsp;<span class="ident" id="6886220">v</span><span class="op" id="6886221">.</span><span class="op" id="6886222">(</span><span class="keyword" id="6886223">type</span><span class="op" id="6886227">)</span>&nbsp;<span class="op" id="6886229">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886232">case</span>&nbsp;<span class="builtintype" id="6886237">string</span><span class="op" id="6886243">,</span>&nbsp;<span class="op" id="6886245">[</span><span class="op" id="6886246">]</span><span class="builtintype" id="6886247">byte</span><span class="op" id="6886251">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886255">return</span>&nbsp;<span class="ident" id="6886262">v</span><span class="op" id="6886263">,</span>&nbsp;<span class="ident" id="6886265">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886270">case</span>&nbsp;<span class="op" id="6886275">*</span><span class="builtintype" id="6886276">string</span><span class="op" id="6886282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886286">if</span>&nbsp;<span class="ident" id="6886289">c</span>&nbsp;<span class="op" id="6886291">==</span>&nbsp;<span class="ident" id="6886294">nil</span>&nbsp;<span class="op" id="6886298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886303">return</span>&nbsp;<span class="ident" id="6886310">nil</span><span class="op" id="6886313">,</span>&nbsp;<span class="ident" id="6886315">nil</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886325">return</span>&nbsp;<span class="op" id="6886332">*</span><span class="ident" id="6886333">c</span><span class="op" id="6886334">,</span>&nbsp;<span class="ident" id="6886336">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6886341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886344">return</span>&nbsp;<span class="ident" id="6886351">fmt</span><span class="op" id="6886354">.</span><span class="ident" id="6886355">Sprintf</span><span class="op" id="6886362">(</span><span class="string" id="6886363">&#34;%v&#34;</span><span class="op" id="6886367">,</span>&nbsp;<span class="ident" id="6886369">v</span><span class="op" id="6886370">)</span><span class="op" id="6886371">,</span>&nbsp;<span class="ident" id="6886373">nil</span><br>
<span class="lineno"></span><span class="op" id="6886377">}</span><br>
<span class="lineno">800</span><br>
<span class="lineno"></span><span class="keyword" id="6886380">func</span>&nbsp;<span class="ident" id="6886385">converterForType</span><span class="op" id="6886401">(</span><span class="ident" id="6886402">typ</span>&nbsp;<span class="builtintype" id="6886406">string</span><span class="op" id="6886412">)</span>&nbsp;<span class="ident" id="6886414">driver</span><span class="op" id="6886420">.</span><span class="ident" id="6886421">ValueConverter</span>&nbsp;<span class="op" id="6886436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886439">switch</span>&nbsp;<span class="ident" id="6886446">typ</span>&nbsp;<span class="op" id="6886450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886453">case</span>&nbsp;<span class="string" id="6886458">&#34;bool&#34;</span><span class="op" id="6886464">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886468">return</span>&nbsp;<span class="ident" id="6886475">driver</span><span class="op" id="6886481">.</span><span class="ident" id="6886482">Bool</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886488">case</span>&nbsp;<span class="string" id="6886493">&#34;nullbool&#34;</span><span class="op" id="6886503">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886507">return</span>&nbsp;<span class="ident" id="6886514">driver</span><span class="op" id="6886520">.</span><span class="ident" id="6886521">Null</span><span class="op" id="6886525">{</span><span class="ident" id="6886526">Converter</span><span class="op" id="6886535">:</span>&nbsp;<span class="ident" id="6886537">driver</span><span class="op" id="6886543">.</span><span class="ident" id="6886544">Bool</span><span class="op" id="6886548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886551">case</span>&nbsp;<span class="string" id="6886556">&#34;int32&#34;</span><span class="op" id="6886563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886567">return</span>&nbsp;<span class="ident" id="6886574">driver</span><span class="op" id="6886580">.</span><span class="ident" id="6886581">Int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886588">case</span>&nbsp;<span class="string" id="6886593">&#34;string&#34;</span><span class="op" id="6886601">:</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886605">return</span>&nbsp;<span class="ident" id="6886612">driver</span><span class="op" id="6886618">.</span><span class="ident" id="6886619">NotNull</span><span class="op" id="6886626">{</span><span class="ident" id="6886627">Converter</span><span class="op" id="6886636">:</span>&nbsp;<span class="ident" id="6886638">fakeDriverString</span><span class="op" id="6886654">{</span><span class="op" id="6886655">}</span><span class="op" id="6886656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886659">case</span>&nbsp;<span class="string" id="6886664">&#34;nullstring&#34;</span><span class="op" id="6886676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886680">return</span>&nbsp;<span class="ident" id="6886687">driver</span><span class="op" id="6886693">.</span><span class="ident" id="6886694">Null</span><span class="op" id="6886698">{</span><span class="ident" id="6886699">Converter</span><span class="op" id="6886708">:</span>&nbsp;<span class="ident" id="6886710">fakeDriverString</span><span class="op" id="6886726">{</span><span class="op" id="6886727">}</span><span class="op" id="6886728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886731">case</span>&nbsp;<span class="string" id="6886736">&#34;int64&#34;</span><span class="op" id="6886743">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6886747">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886799">return</span>&nbsp;<span class="ident" id="6886806">driver</span><span class="op" id="6886812">.</span><span class="ident" id="6886813">NotNull</span><span class="op" id="6886820">{</span><span class="ident" id="6886821">Converter</span><span class="op" id="6886830">:</span>&nbsp;<span class="ident" id="6886832">driver</span><span class="op" id="6886838">.</span><span class="ident" id="6886839">DefaultParameterConverter</span><span class="op" id="6886864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886867">case</span>&nbsp;<span class="string" id="6886872">&#34;nullint64&#34;</span><span class="op" id="6886883">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6886887">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6886939">return</span>&nbsp;<span class="ident" id="6886946">driver</span><span class="op" id="6886952">.</span><span class="ident" id="6886953">Null</span><span class="op" id="6886957">{</span><span class="ident" id="6886958">Converter</span><span class="op" id="6886967">:</span>&nbsp;<span class="ident" id="6886969">driver</span><span class="op" id="6886975">.</span><span class="ident" id="6886976">DefaultParameterConverter</span><span class="op" id="6887001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887004">case</span>&nbsp;<span class="string" id="6887009">&#34;float64&#34;</span><span class="op" id="6887018">:</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6887022">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887074">return</span>&nbsp;<span class="ident" id="6887081">driver</span><span class="op" id="6887087">.</span><span class="ident" id="6887088">NotNull</span><span class="op" id="6887095">{</span><span class="ident" id="6887096">Converter</span><span class="op" id="6887105">:</span>&nbsp;<span class="ident" id="6887107">driver</span><span class="op" id="6887113">.</span><span class="ident" id="6887114">DefaultParameterConverter</span><span class="op" id="6887139">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887142">case</span>&nbsp;<span class="string" id="6887147">&#34;nullfloat64&#34;</span><span class="op" id="6887160">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6887164">//&nbsp;TODO(coopernurse):&nbsp;add&nbsp;type-specific&nbsp;converter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887216">return</span>&nbsp;<span class="ident" id="6887223">driver</span><span class="op" id="6887229">.</span><span class="ident" id="6887230">Null</span><span class="op" id="6887234">{</span><span class="ident" id="6887235">Converter</span><span class="op" id="6887244">:</span>&nbsp;<span class="ident" id="6887246">driver</span><span class="op" id="6887252">.</span><span class="ident" id="6887253">DefaultParameterConverter</span><span class="op" id="6887278">}</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887281">case</span>&nbsp;<span class="string" id="6887286">&#34;datetime&#34;</span><span class="op" id="6887296">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6887300">return</span>&nbsp;<span class="ident" id="6887307">driver</span><span class="op" id="6887313">.</span><span class="ident" id="6887314">DefaultParameterConverter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6887341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6887344">panic</span><span class="op" id="6887349">(</span><span class="string" id="6887350">&#34;invalid&nbsp;fakedb&nbsp;column&nbsp;type&nbsp;of&nbsp;&#34;</span>&nbsp;<span class="op" id="6887383">+</span>&nbsp;<span class="ident" id="6887385">typ</span><span class="op" id="6887388">)</span><br>
<span class="lineno"></span><span class="op" id="6887390">}</span>
</div>
</body>
</html>
