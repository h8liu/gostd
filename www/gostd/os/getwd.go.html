<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="2177550">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2177605">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2177659">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2177710">package</span>&nbsp;<span class="ident" id="2177718">os</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2177722">import</span>&nbsp;<span class="op" id="2177729">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2177732">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2177743">&#34;sync&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2177751">&#34;syscall&#34;</span><br>
<span class="lineno"></span><span class="op" id="2177761">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2177764">var</span>&nbsp;<span class="ident" id="2177768">getwdCache</span>&nbsp;<span class="keyword" id="2177779">struct</span>&nbsp;<span class="op" id="2177786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2177789">sync</span><span class="op" id="2177793">.</span><span class="ident" id="2177794">Mutex</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2177801">dir</span>&nbsp;<span class="builtintype" id="2177805">string</span><br>
<span class="lineno"></span><span class="op" id="2177812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2177815">//&nbsp;useSyscallwd&nbsp;determines&nbsp;whether&nbsp;to&nbsp;use&nbsp;the&nbsp;return&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="2177877">//&nbsp;syscall.Getwd&nbsp;based&nbsp;on&nbsp;its&nbsp;error.</span><br>
<span class="lineno">20</span><span class="keyword" id="2177914">var</span>&nbsp;<span class="ident" id="2177918">useSyscallwd</span>&nbsp;<span class="op" id="2177931">=</span>&nbsp;<span class="keyword" id="2177933">func</span><span class="op" id="2177937">(</span><span class="builtintype" id="2177938">error</span><span class="op" id="2177943">)</span>&nbsp;<span class="builtintype" id="2177945">bool</span>&nbsp;<span class="op" id="2177950">{</span>&nbsp;<span class="keyword" id="2177952">return</span>&nbsp;<span class="builtintype" id="2177959">true</span>&nbsp;<span class="op" id="2177964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2177967">//&nbsp;Getwd&nbsp;returns&nbsp;a&nbsp;rooted&nbsp;path&nbsp;name&nbsp;corresponding&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2178024">//&nbsp;current&nbsp;directory.&nbsp;&nbsp;If&nbsp;the&nbsp;current&nbsp;directory&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="2178079">//&nbsp;reached&nbsp;via&nbsp;multiple&nbsp;paths&nbsp;(due&nbsp;to&nbsp;symbolic&nbsp;links),</span><br>
<span class="lineno">25</span><span class="comment" id="2178134">//&nbsp;Getwd&nbsp;may&nbsp;return&nbsp;any&nbsp;one&nbsp;of&nbsp;them.</span><br>
<span class="lineno"></span><span class="keyword" id="2178171">func</span>&nbsp;<span class="ident" id="2178176">Getwd</span><span class="op" id="2178181">(</span><span class="op" id="2178182">)</span>&nbsp;<span class="op" id="2178184">(</span><span class="ident" id="2178185">dir</span>&nbsp;<span class="builtintype" id="2178189">string</span><span class="op" id="2178195">,</span>&nbsp;<span class="ident" id="2178197">err</span>&nbsp;<span class="builtintype" id="2178201">error</span><span class="op" id="2178206">)</span>&nbsp;<span class="op" id="2178208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178211">if</span>&nbsp;<span class="ident" id="2178214">runtime</span><span class="op" id="2178221">.</span><span class="ident" id="2178222">GOOS</span>&nbsp;<span class="op" id="2178227">==</span>&nbsp;<span class="string" id="2178230">&#34;windows&#34;</span>&nbsp;<span class="op" id="2178240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178244">return</span>&nbsp;<span class="ident" id="2178251">syscall</span><span class="op" id="2178258">.</span><span class="ident" id="2178259">Getwd</span><span class="op" id="2178264">(</span><span class="op" id="2178265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178268">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2178272">//&nbsp;Clumsy&nbsp;but&nbsp;widespread&nbsp;kludge:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2178306">//&nbsp;if&nbsp;$PWD&nbsp;is&nbsp;set&nbsp;and&nbsp;matches&nbsp;&#34;.&#34;,&nbsp;use&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178350">dot</span><span class="op" id="2178353">,</span>&nbsp;<span class="ident" id="2178355">err</span>&nbsp;<span class="op" id="2178359">:=</span>&nbsp;<span class="ident" id="2178362">Stat</span><span class="op" id="2178366">(</span><span class="string" id="2178367">&#34;.&#34;</span><span class="op" id="2178370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178373">if</span>&nbsp;<span class="ident" id="2178376">err</span>&nbsp;<span class="op" id="2178380">!=</span>&nbsp;<span class="ident" id="2178383">nil</span>&nbsp;<span class="op" id="2178387">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178391">return</span>&nbsp;<span class="string" id="2178398">&#34;&#34;</span><span class="op" id="2178400">,</span>&nbsp;<span class="ident" id="2178402">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178410">dir</span>&nbsp;<span class="op" id="2178414">=</span>&nbsp;<span class="ident" id="2178416">Getenv</span><span class="op" id="2178422">(</span><span class="string" id="2178423">&#34;PWD&#34;</span><span class="op" id="2178428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178431">if</span>&nbsp;<span class="builtinfunc" id="2178434">len</span><span class="op" id="2178437">(</span><span class="ident" id="2178438">dir</span><span class="op" id="2178441">)</span>&nbsp;<span class="op" id="2178443">&gt;</span>&nbsp;<span class="num" id="2178445">0</span>&nbsp;<span class="op" id="2178447">&amp;&amp;</span>&nbsp;<span class="ident" id="2178450">dir</span><span class="op" id="2178453">[</span><span class="num" id="2178454">0</span><span class="op" id="2178455">]</span>&nbsp;<span class="op" id="2178457">==</span>&nbsp;<span class="string" id="2178460">&#39;/&#39;</span>&nbsp;<span class="op" id="2178464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178468">d</span><span class="op" id="2178469">,</span>&nbsp;<span class="ident" id="2178471">err</span>&nbsp;<span class="op" id="2178475">:=</span>&nbsp;<span class="ident" id="2178478">Stat</span><span class="op" id="2178482">(</span><span class="ident" id="2178483">dir</span><span class="op" id="2178486">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178490">if</span>&nbsp;<span class="ident" id="2178493">err</span>&nbsp;<span class="op" id="2178497">==</span>&nbsp;<span class="ident" id="2178500">nil</span>&nbsp;<span class="op" id="2178504">&amp;&amp;</span>&nbsp;<span class="ident" id="2178507">SameFile</span><span class="op" id="2178515">(</span><span class="ident" id="2178516">dot</span><span class="op" id="2178519">,</span>&nbsp;<span class="ident" id="2178521">d</span><span class="op" id="2178522">)</span>&nbsp;<span class="op" id="2178524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178529">return</span>&nbsp;<span class="ident" id="2178536">dir</span><span class="op" id="2178539">,</span>&nbsp;<span class="ident" id="2178541">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2178554">//&nbsp;If&nbsp;the&nbsp;operating&nbsp;system&nbsp;provides&nbsp;a&nbsp;Getwd&nbsp;call,&nbsp;use&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2178613">//&nbsp;Otherwise,&nbsp;we&#39;re&nbsp;trying&nbsp;to&nbsp;find&nbsp;our&nbsp;way&nbsp;back&nbsp;to&nbsp;&#34;.&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178670">if</span>&nbsp;<span class="ident" id="2178673">syscall</span><span class="op" id="2178680">.</span><span class="ident" id="2178681">ImplementsGetwd</span>&nbsp;<span class="op" id="2178697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178701">s</span><span class="op" id="2178702">,</span>&nbsp;<span class="ident" id="2178704">e</span>&nbsp;<span class="op" id="2178706">:=</span>&nbsp;<span class="ident" id="2178709">syscall</span><span class="op" id="2178716">.</span><span class="ident" id="2178717">Getwd</span><span class="op" id="2178722">(</span><span class="op" id="2178723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178727">if</span>&nbsp;<span class="ident" id="2178730">useSyscallwd</span><span class="op" id="2178742">(</span><span class="ident" id="2178743">e</span><span class="op" id="2178744">)</span>&nbsp;<span class="op" id="2178746">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178751">return</span>&nbsp;<span class="ident" id="2178758">s</span><span class="op" id="2178759">,</span>&nbsp;<span class="ident" id="2178761">NewSyscallError</span><span class="op" id="2178776">(</span><span class="string" id="2178777">&#34;getwd&#34;</span><span class="op" id="2178784">,</span>&nbsp;<span class="ident" id="2178786">e</span><span class="op" id="2178787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2178794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2178798">//&nbsp;Apply&nbsp;same&nbsp;kludge&nbsp;but&nbsp;to&nbsp;cached&nbsp;dir&nbsp;instead&nbsp;of&nbsp;$PWD.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178855">getwdCache</span><span class="op" id="2178865">.</span><span class="ident" id="2178866">Lock</span><span class="op" id="2178870">(</span><span class="op" id="2178871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178874">dir</span>&nbsp;<span class="op" id="2178878">=</span>&nbsp;<span class="ident" id="2178880">getwdCache</span><span class="op" id="2178890">.</span><span class="ident" id="2178891">dir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178896">getwdCache</span><span class="op" id="2178906">.</span><span class="ident" id="2178907">Unlock</span><span class="op" id="2178913">(</span><span class="op" id="2178914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178917">if</span>&nbsp;<span class="builtinfunc" id="2178920">len</span><span class="op" id="2178923">(</span><span class="ident" id="2178924">dir</span><span class="op" id="2178927">)</span>&nbsp;<span class="op" id="2178929">&gt;</span>&nbsp;<span class="num" id="2178931">0</span>&nbsp;<span class="op" id="2178933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2178937">d</span><span class="op" id="2178938">,</span>&nbsp;<span class="ident" id="2178940">err</span>&nbsp;<span class="op" id="2178944">:=</span>&nbsp;<span class="ident" id="2178947">Stat</span><span class="op" id="2178951">(</span><span class="ident" id="2178952">dir</span><span class="op" id="2178955">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178959">if</span>&nbsp;<span class="ident" id="2178962">err</span>&nbsp;<span class="op" id="2178966">==</span>&nbsp;<span class="ident" id="2178969">nil</span>&nbsp;<span class="op" id="2178973">&amp;&amp;</span>&nbsp;<span class="ident" id="2178976">SameFile</span><span class="op" id="2178984">(</span><span class="ident" id="2178985">dot</span><span class="op" id="2178988">,</span>&nbsp;<span class="ident" id="2178990">d</span><span class="op" id="2178991">)</span>&nbsp;<span class="op" id="2178993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2178998">return</span>&nbsp;<span class="ident" id="2179005">dir</span><span class="op" id="2179008">,</span>&nbsp;<span class="ident" id="2179010">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179023">//&nbsp;Root&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;because&nbsp;it&nbsp;has&nbsp;no&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179075">//&nbsp;and&nbsp;ends&nbsp;in&nbsp;a&nbsp;slash.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179100">root</span><span class="op" id="2179104">,</span>&nbsp;<span class="ident" id="2179106">err</span>&nbsp;<span class="op" id="2179110">:=</span>&nbsp;<span class="ident" id="2179113">Stat</span><span class="op" id="2179117">(</span><span class="string" id="2179118">&#34;/&#34;</span><span class="op" id="2179121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179124">if</span>&nbsp;<span class="ident" id="2179127">err</span>&nbsp;<span class="op" id="2179131">!=</span>&nbsp;<span class="ident" id="2179134">nil</span>&nbsp;<span class="op" id="2179138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179142">//&nbsp;Can&#39;t&nbsp;stat&nbsp;root&nbsp;-&nbsp;no&nbsp;hope.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179174">return</span>&nbsp;<span class="string" id="2179181">&#34;&#34;</span><span class="op" id="2179183">,</span>&nbsp;<span class="ident" id="2179185">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179193">if</span>&nbsp;<span class="ident" id="2179196">SameFile</span><span class="op" id="2179204">(</span><span class="ident" id="2179205">root</span><span class="op" id="2179209">,</span>&nbsp;<span class="ident" id="2179211">dot</span><span class="op" id="2179214">)</span>&nbsp;<span class="op" id="2179216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179220">return</span>&nbsp;<span class="string" id="2179227">&#34;/&#34;</span><span class="op" id="2179230">,</span>&nbsp;<span class="ident" id="2179232">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179237">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179241">//&nbsp;General&nbsp;algorithm:&nbsp;find&nbsp;name&nbsp;in&nbsp;parent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179284">//&nbsp;and&nbsp;then&nbsp;find&nbsp;name&nbsp;of&nbsp;parent.&nbsp;&nbsp;Each&nbsp;iteration</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179334">//&nbsp;adds&nbsp;/name&nbsp;to&nbsp;the&nbsp;beginning&nbsp;of&nbsp;dir.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179374">dir</span>&nbsp;<span class="op" id="2179378">=</span>&nbsp;<span class="string" id="2179380">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179384">for</span>&nbsp;<span class="ident" id="2179388">parent</span>&nbsp;<span class="op" id="2179395">:=</span>&nbsp;<span class="string" id="2179398">&#34;..&#34;</span><span class="op" id="2179402">;</span>&nbsp;<span class="op" id="2179404">;</span>&nbsp;<span class="ident" id="2179406">parent</span>&nbsp;<span class="op" id="2179413">=</span>&nbsp;<span class="string" id="2179415">&#34;../&#34;</span>&nbsp;<span class="op" id="2179421">+</span>&nbsp;<span class="ident" id="2179423">parent</span>&nbsp;<span class="op" id="2179430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179434">if</span>&nbsp;<span class="builtinfunc" id="2179437">len</span><span class="op" id="2179440">(</span><span class="ident" id="2179441">parent</span><span class="op" id="2179447">)</span>&nbsp;<span class="op" id="2179449">&gt;=</span>&nbsp;<span class="num" id="2179452">1024</span>&nbsp;<span class="op" id="2179457">{</span>&nbsp;<span class="comment" id="2179459">//&nbsp;Sanity&nbsp;check</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179478">return</span>&nbsp;<span class="string" id="2179485">&#34;&#34;</span><span class="op" id="2179487">,</span>&nbsp;<span class="ident" id="2179489">syscall</span><span class="op" id="2179496">.</span><span class="ident" id="2179497">ENAMETOOLONG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179516">fd</span><span class="op" id="2179518">,</span>&nbsp;<span class="ident" id="2179520">err</span>&nbsp;<span class="op" id="2179524">:=</span>&nbsp;<span class="ident" id="2179527">Open</span><span class="op" id="2179531">(</span><span class="ident" id="2179532">parent</span><span class="op" id="2179538">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179542">if</span>&nbsp;<span class="ident" id="2179545">err</span>&nbsp;<span class="op" id="2179549">!=</span>&nbsp;<span class="ident" id="2179552">nil</span>&nbsp;<span class="op" id="2179556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179561">return</span>&nbsp;<span class="string" id="2179568">&#34;&#34;</span><span class="op" id="2179570">,</span>&nbsp;<span class="ident" id="2179572">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179583">for</span>&nbsp;<span class="op" id="2179587">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179592">names</span><span class="op" id="2179597">,</span>&nbsp;<span class="ident" id="2179599">err</span>&nbsp;<span class="op" id="2179603">:=</span>&nbsp;<span class="ident" id="2179606">fd</span><span class="op" id="2179608">.</span><span class="ident" id="2179609">Readdirnames</span><span class="op" id="2179621">(</span><span class="num" id="2179622">100</span><span class="op" id="2179625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179630">if</span>&nbsp;<span class="ident" id="2179633">err</span>&nbsp;<span class="op" id="2179637">!=</span>&nbsp;<span class="ident" id="2179640">nil</span>&nbsp;<span class="op" id="2179644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179650">fd</span><span class="op" id="2179652">.</span><span class="ident" id="2179653">Close</span><span class="op" id="2179658">(</span><span class="op" id="2179659">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179665">return</span>&nbsp;<span class="string" id="2179672">&#34;&#34;</span><span class="op" id="2179674">,</span>&nbsp;<span class="ident" id="2179676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179683">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179688">for</span>&nbsp;<span class="ident" id="2179692">_</span><span class="op" id="2179693">,</span>&nbsp;<span class="ident" id="2179695">name</span>&nbsp;<span class="op" id="2179700">:=</span>&nbsp;<span class="keyword" id="2179703">range</span>&nbsp;<span class="ident" id="2179709">names</span>&nbsp;<span class="op" id="2179715">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179721">d</span><span class="op" id="2179722">,</span>&nbsp;<span class="ident" id="2179724">_</span>&nbsp;<span class="op" id="2179726">:=</span>&nbsp;<span class="ident" id="2179729">Lstat</span><span class="op" id="2179734">(</span><span class="ident" id="2179735">parent</span>&nbsp;<span class="op" id="2179742">+</span>&nbsp;<span class="string" id="2179744">&#34;/&#34;</span>&nbsp;<span class="op" id="2179748">+</span>&nbsp;<span class="ident" id="2179750">name</span><span class="op" id="2179754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179760">if</span>&nbsp;<span class="ident" id="2179763">SameFile</span><span class="op" id="2179771">(</span><span class="ident" id="2179772">d</span><span class="op" id="2179773">,</span>&nbsp;<span class="ident" id="2179775">dot</span><span class="op" id="2179778">)</span>&nbsp;<span class="op" id="2179780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179787">dir</span>&nbsp;<span class="op" id="2179791">=</span>&nbsp;<span class="string" id="2179793">&#34;/&#34;</span>&nbsp;<span class="op" id="2179797">+</span>&nbsp;<span class="ident" id="2179799">name</span>&nbsp;<span class="op" id="2179804">+</span>&nbsp;<span class="ident" id="2179806">dir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179815">goto</span>&nbsp;<span class="ident" id="2179820">Found</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179843">Found</span><span class="op" id="2179848">:</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179852">pd</span><span class="op" id="2179854">,</span>&nbsp;<span class="ident" id="2179856">err</span>&nbsp;<span class="op" id="2179860">:=</span>&nbsp;<span class="ident" id="2179863">fd</span><span class="op" id="2179865">.</span><span class="ident" id="2179866">Stat</span><span class="op" id="2179870">(</span><span class="op" id="2179871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179875">if</span>&nbsp;<span class="ident" id="2179878">err</span>&nbsp;<span class="op" id="2179882">!=</span>&nbsp;<span class="ident" id="2179885">nil</span>&nbsp;<span class="op" id="2179889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179894">return</span>&nbsp;<span class="string" id="2179901">&#34;&#34;</span><span class="op" id="2179903">,</span>&nbsp;<span class="ident" id="2179905">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179915">fd</span><span class="op" id="2179917">.</span><span class="ident" id="2179918">Close</span><span class="op" id="2179923">(</span><span class="op" id="2179924">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179928">if</span>&nbsp;<span class="ident" id="2179931">SameFile</span><span class="op" id="2179939">(</span><span class="ident" id="2179940">pd</span><span class="op" id="2179942">,</span>&nbsp;<span class="ident" id="2179944">root</span><span class="op" id="2179948">)</span>&nbsp;<span class="op" id="2179950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2179955">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2179963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2179967">//&nbsp;Set&nbsp;up&nbsp;for&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2179995">dot</span>&nbsp;<span class="op" id="2179999">=</span>&nbsp;<span class="ident" id="2180001">pd</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2180005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2180009">//&nbsp;Save&nbsp;answer&nbsp;as&nbsp;hint&nbsp;to&nbsp;avoid&nbsp;the&nbsp;expensive&nbsp;path&nbsp;next&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2180072">getwdCache</span><span class="op" id="2180082">.</span><span class="ident" id="2180083">Lock</span><span class="op" id="2180087">(</span><span class="op" id="2180088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2180091">getwdCache</span><span class="op" id="2180101">.</span><span class="ident" id="2180102">dir</span>&nbsp;<span class="op" id="2180106">=</span>&nbsp;<span class="ident" id="2180108">dir</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2180113">getwdCache</span><span class="op" id="2180123">.</span><span class="ident" id="2180124">Unlock</span><span class="op" id="2180130">(</span><span class="op" id="2180131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2180135">return</span>&nbsp;<span class="ident" id="2180142">dir</span><span class="op" id="2180145">,</span>&nbsp;<span class="ident" id="2180147">nil</span><br>
<span class="lineno"></span><span class="op" id="2180151">}</span>
</div>
</body>
</html>
