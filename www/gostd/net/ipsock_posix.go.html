<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html" class="current">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3123639">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3123695">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3123749">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3123800">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3123878">//&nbsp;Internet&nbsp;protocol&nbsp;family&nbsp;sockets&nbsp;for&nbsp;POSIX</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3123925">package</span>&nbsp;<span class="ident" id="3123933">net</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3123938">import</span>&nbsp;<span class="op" id="3123945">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3123948">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3123959">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3123966">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3123969">func</span>&nbsp;<span class="ident" id="3123974">probeIPv4Stack</span><span class="op" id="3123988">(</span><span class="op" id="3123989">)</span>&nbsp;<span class="builtintype" id="3123991">bool</span>&nbsp;<span class="op" id="3123996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3123999">s</span><span class="op" id="3124000">,</span>&nbsp;<span class="ident" id="3124002">err</span>&nbsp;<span class="op" id="3124006">:=</span>&nbsp;<span class="ident" id="3124009">syscall</span><span class="op" id="3124016">.</span><span class="ident" id="3124017">Socket</span><span class="op" id="3124023">(</span><span class="ident" id="3124024">syscall</span><span class="op" id="3124031">.</span><span class="ident" id="3124032">AF_INET</span><span class="op" id="3124039">,</span>&nbsp;<span class="ident" id="3124041">syscall</span><span class="op" id="3124048">.</span><span class="ident" id="3124049">SOCK_STREAM</span><span class="op" id="3124060">,</span>&nbsp;<span class="ident" id="3124062">syscall</span><span class="op" id="3124069">.</span><span class="ident" id="3124070">IPPROTO_TCP</span><span class="op" id="3124081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124084">switch</span>&nbsp;<span class="ident" id="3124091">err</span>&nbsp;<span class="op" id="3124095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124098">case</span>&nbsp;<span class="ident" id="3124103">syscall</span><span class="op" id="3124110">.</span><span class="ident" id="3124111">EAFNOSUPPORT</span><span class="op" id="3124123">,</span>&nbsp;<span class="ident" id="3124125">syscall</span><span class="op" id="3124132">.</span><span class="ident" id="3124133">EPROTONOSUPPORT</span><span class="op" id="3124148">:</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124152">return</span>&nbsp;<span class="builtintype" id="3124159">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124166">case</span>&nbsp;<span class="ident" id="3124171">nil</span><span class="op" id="3124174">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3124178">closesocket</span><span class="op" id="3124189">(</span><span class="ident" id="3124190">s</span><span class="op" id="3124191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3124194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3124197">return</span>&nbsp;<span class="builtintype" id="3124204">true</span><br>
<span class="lineno">25</span><span class="op" id="3124209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3124212">//&nbsp;Should&nbsp;we&nbsp;try&nbsp;to&nbsp;use&nbsp;the&nbsp;IPv4&nbsp;socket&nbsp;interface&nbsp;if&nbsp;we&#39;re</span><br>
<span class="lineno"></span><span class="comment" id="3124271">//&nbsp;only&nbsp;dealing&nbsp;with&nbsp;IPv4&nbsp;sockets?&nbsp;&nbsp;As&nbsp;long&nbsp;as&nbsp;the&nbsp;host&nbsp;system</span><br>
<span class="lineno"></span><span class="comment" id="3124334">//&nbsp;understands&nbsp;IPv6,&nbsp;it&#39;s&nbsp;okay&nbsp;to&nbsp;pass&nbsp;IPv4&nbsp;addresses&nbsp;to&nbsp;the&nbsp;IPv6</span><br>
<span class="lineno">30</span><span class="comment" id="3124400">//&nbsp;interface.&nbsp;&nbsp;That&nbsp;simplifies&nbsp;our&nbsp;code&nbsp;and&nbsp;is&nbsp;most&nbsp;general.</span><br>
<span class="lineno"></span><span class="comment" id="3124461">//&nbsp;Unfortunately,&nbsp;we&nbsp;need&nbsp;to&nbsp;run&nbsp;on&nbsp;kernels&nbsp;built&nbsp;without&nbsp;IPv6</span><br>
<span class="lineno"></span><span class="comment" id="3124524">//&nbsp;support&nbsp;too.&nbsp;&nbsp;So&nbsp;probe&nbsp;the&nbsp;kernel&nbsp;to&nbsp;figure&nbsp;it&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3124579">//</span><br>
<span class="lineno"></span><span class="comment" id="3124582">//&nbsp;probeIPv6Stack&nbsp;probes&nbsp;both&nbsp;basic&nbsp;IPv6&nbsp;capability&nbsp;and&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno">35</span><span class="comment" id="3124649">//&nbsp;mapping&nbsp;capability&nbsp;which&nbsp;is&nbsp;controlled&nbsp;by&nbsp;IPV6_V6ONLY&nbsp;socket</span><br>
<span class="lineno"></span><span class="comment" id="3124713">//&nbsp;option&nbsp;and/or&nbsp;kernel&nbsp;state&nbsp;&#34;net.inet6.ip6.v6only&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3124767">//&nbsp;It&nbsp;returns&nbsp;two&nbsp;boolean&nbsp;values.&nbsp;&nbsp;If&nbsp;the&nbsp;first&nbsp;boolean&nbsp;value&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3124832">//&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;basic&nbsp;IPv6&nbsp;functionality.&nbsp;&nbsp;If&nbsp;the&nbsp;second</span><br>
<span class="lineno"></span><span class="comment" id="3124898">//&nbsp;boolean&nbsp;value&nbsp;is&nbsp;true,&nbsp;kernel&nbsp;supports&nbsp;IPv6&nbsp;IPv4-mapping.</span><br>
<span class="lineno">40</span><span class="keyword" id="3124959">func</span>&nbsp;<span class="ident" id="3124964">probeIPv6Stack</span><span class="op" id="3124978">(</span><span class="op" id="3124979">)</span>&nbsp;<span class="op" id="3124981">(</span><span class="ident" id="3124982">supportsIPv6</span><span class="op" id="3124994">,</span>&nbsp;<span class="ident" id="3124996">supportsIPv4map</span>&nbsp;<span class="builtintype" id="3125012">bool</span><span class="op" id="3125016">)</span>&nbsp;<span class="op" id="3125018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125021">var</span>&nbsp;<span class="ident" id="3125025">probes</span>&nbsp;<span class="op" id="3125032">=</span>&nbsp;<span class="op" id="3125034">[</span><span class="op" id="3125035">]</span><span class="keyword" id="3125036">struct</span>&nbsp;<span class="op" id="3125043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125047">laddr</span>&nbsp;<span class="ident" id="3125053">TCPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125063">value</span>&nbsp;<span class="builtintype" id="3125069">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125075">ok</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3125081">bool</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125087">}</span><span class="op" id="3125088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125092">//&nbsp;IPv6&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125127">{</span><span class="ident" id="3125128">laddr</span><span class="op" id="3125133">:</span>&nbsp;<span class="ident" id="3125135">TCPAddr</span><span class="op" id="3125142">{</span><span class="ident" id="3125143">IP</span><span class="op" id="3125145">:</span>&nbsp;<span class="ident" id="3125147">ParseIP</span><span class="op" id="3125154">(</span><span class="string" id="3125155">&#34;::1&#34;</span><span class="op" id="3125160">)</span><span class="op" id="3125161">}</span><span class="op" id="3125162">,</span>&nbsp;<span class="ident" id="3125164">value</span><span class="op" id="3125169">:</span>&nbsp;<span class="num" id="3125171">1</span><span class="op" id="3125172">}</span><span class="op" id="3125173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3125177">//&nbsp;IPv6&nbsp;IPv4-mapped&nbsp;address&nbsp;communication&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125232">{</span><span class="ident" id="3125233">laddr</span><span class="op" id="3125238">:</span>&nbsp;<span class="ident" id="3125240">TCPAddr</span><span class="op" id="3125247">{</span><span class="ident" id="3125248">IP</span><span class="op" id="3125250">:</span>&nbsp;<span class="ident" id="3125252">IPv4</span><span class="op" id="3125256">(</span><span class="num" id="3125257">127</span><span class="op" id="3125260">,</span>&nbsp;<span class="num" id="3125262">0</span><span class="op" id="3125263">,</span>&nbsp;<span class="num" id="3125265">0</span><span class="op" id="3125266">,</span>&nbsp;<span class="num" id="3125268">1</span><span class="op" id="3125269">)</span><span class="op" id="3125270">}</span><span class="op" id="3125271">,</span>&nbsp;<span class="ident" id="3125273">value</span><span class="op" id="3125278">:</span>&nbsp;<span class="num" id="3125280">0</span><span class="op" id="3125281">}</span><span class="op" id="3125282">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125289">for</span>&nbsp;<span class="ident" id="3125293">i</span>&nbsp;<span class="op" id="3125295">:=</span>&nbsp;<span class="keyword" id="3125298">range</span>&nbsp;<span class="ident" id="3125304">probes</span>&nbsp;<span class="op" id="3125311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125315">s</span><span class="op" id="3125316">,</span>&nbsp;<span class="ident" id="3125318">err</span>&nbsp;<span class="op" id="3125322">:=</span>&nbsp;<span class="ident" id="3125325">syscall</span><span class="op" id="3125332">.</span><span class="ident" id="3125333">Socket</span><span class="op" id="3125339">(</span><span class="ident" id="3125340">syscall</span><span class="op" id="3125347">.</span><span class="ident" id="3125348">AF_INET6</span><span class="op" id="3125356">,</span>&nbsp;<span class="ident" id="3125358">syscall</span><span class="op" id="3125365">.</span><span class="ident" id="3125366">SOCK_STREAM</span><span class="op" id="3125377">,</span>&nbsp;<span class="ident" id="3125379">syscall</span><span class="op" id="3125386">.</span><span class="ident" id="3125387">IPPROTO_TCP</span><span class="op" id="3125398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125402">if</span>&nbsp;<span class="ident" id="3125405">err</span>&nbsp;<span class="op" id="3125409">!=</span>&nbsp;<span class="ident" id="3125412">nil</span>&nbsp;<span class="op" id="3125416">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125421">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125436">defer</span>&nbsp;<span class="ident" id="3125442">closesocket</span><span class="op" id="3125453">(</span><span class="ident" id="3125454">s</span><span class="op" id="3125455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125459">syscall</span><span class="op" id="3125466">.</span><span class="ident" id="3125467">SetsockoptInt</span><span class="op" id="3125480">(</span><span class="ident" id="3125481">s</span><span class="op" id="3125482">,</span>&nbsp;<span class="ident" id="3125484">syscall</span><span class="op" id="3125491">.</span><span class="ident" id="3125492">IPPROTO_IPV6</span><span class="op" id="3125504">,</span>&nbsp;<span class="ident" id="3125506">syscall</span><span class="op" id="3125513">.</span><span class="ident" id="3125514">IPV6_V6ONLY</span><span class="op" id="3125525">,</span>&nbsp;<span class="ident" id="3125527">probes</span><span class="op" id="3125533">[</span><span class="ident" id="3125534">i</span><span class="op" id="3125535">]</span><span class="op" id="3125536">.</span><span class="ident" id="3125537">value</span><span class="op" id="3125542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125546">sa</span><span class="op" id="3125548">,</span>&nbsp;<span class="ident" id="3125550">err</span>&nbsp;<span class="op" id="3125554">:=</span>&nbsp;<span class="ident" id="3125557">probes</span><span class="op" id="3125563">[</span><span class="ident" id="3125564">i</span><span class="op" id="3125565">]</span><span class="op" id="3125566">.</span><span class="ident" id="3125567">laddr</span><span class="op" id="3125572">.</span><span class="ident" id="3125573">sockaddr</span><span class="op" id="3125581">(</span><span class="ident" id="3125582">syscall</span><span class="op" id="3125589">.</span><span class="ident" id="3125590">AF_INET6</span><span class="op" id="3125598">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125602">if</span>&nbsp;<span class="ident" id="3125605">err</span>&nbsp;<span class="op" id="3125609">!=</span>&nbsp;<span class="ident" id="3125612">nil</span>&nbsp;<span class="op" id="3125616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125621">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125636">if</span>&nbsp;<span class="ident" id="3125639">err</span>&nbsp;<span class="op" id="3125643">:=</span>&nbsp;<span class="ident" id="3125646">syscall</span><span class="op" id="3125653">.</span><span class="ident" id="3125654">Bind</span><span class="op" id="3125658">(</span><span class="ident" id="3125659">s</span><span class="op" id="3125660">,</span>&nbsp;<span class="ident" id="3125662">sa</span><span class="op" id="3125664">)</span><span class="op" id="3125665">;</span>&nbsp;<span class="ident" id="3125667">err</span>&nbsp;<span class="op" id="3125671">!=</span>&nbsp;<span class="ident" id="3125674">nil</span>&nbsp;<span class="op" id="3125678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125683">continue</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3125698">probes</span><span class="op" id="3125704">[</span><span class="ident" id="3125705">i</span><span class="op" id="3125706">]</span><span class="op" id="3125707">.</span><span class="ident" id="3125708">ok</span>&nbsp;<span class="op" id="3125711">=</span>&nbsp;<span class="builtintype" id="3125713">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3125719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3125723">return</span>&nbsp;<span class="ident" id="3125730">probes</span><span class="op" id="3125736">[</span><span class="num" id="3125737">0</span><span class="op" id="3125738">]</span><span class="op" id="3125739">.</span><span class="ident" id="3125740">ok</span><span class="op" id="3125742">,</span>&nbsp;<span class="ident" id="3125744">probes</span><span class="op" id="3125750">[</span><span class="num" id="3125751">1</span><span class="op" id="3125752">]</span><span class="op" id="3125753">.</span><span class="ident" id="3125754">ok</span><br>
<span class="lineno">70</span><span class="op" id="3125757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3125760">//&nbsp;favoriteAddrFamily&nbsp;returns&nbsp;the&nbsp;appropriate&nbsp;address&nbsp;family&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3125824">//&nbsp;the&nbsp;given&nbsp;net,&nbsp;laddr,&nbsp;raddr&nbsp;and&nbsp;mode.&nbsp;&nbsp;At&nbsp;first&nbsp;it&nbsp;figures</span><br>
<span class="lineno"></span><span class="comment" id="3125886">//&nbsp;address&nbsp;family&nbsp;out&nbsp;from&nbsp;the&nbsp;net.&nbsp;&nbsp;If&nbsp;mode&nbsp;indicates&nbsp;&#34;listen&#34;</span><br>
<span class="lineno">75</span><span class="comment" id="3125950">//&nbsp;and&nbsp;laddr&nbsp;is&nbsp;a&nbsp;wildcard,&nbsp;it&nbsp;assumes&nbsp;that&nbsp;the&nbsp;user&nbsp;wants&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3126012">//&nbsp;make&nbsp;a&nbsp;passive&nbsp;connection&nbsp;with&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;family,&nbsp;both</span><br>
<span class="lineno"></span><span class="comment" id="3126078">//&nbsp;AF_INET&nbsp;and&nbsp;AF_INET6,&nbsp;and&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;like&nbsp;following:</span><br>
<span class="lineno"></span><span class="comment" id="3126142">//</span><br>
<span class="lineno"></span><span class="comment" id="3126145">//&nbsp;&nbsp;&nbsp;&nbsp;1.&nbsp;A&nbsp;wild-wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;&#34;</span><br>
<span class="lineno">80</span><span class="comment" id="3126182">//&nbsp;&nbsp;&nbsp;&nbsp;If&nbsp;the&nbsp;platform&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping</span><br>
<span class="lineno"></span><span class="comment" id="3126242">//&nbsp;&nbsp;&nbsp;&nbsp;capabilities,&nbsp;we&nbsp;assume&nbsp;that&nbsp;the&nbsp;user&nbsp;want&nbsp;to&nbsp;listen&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3126301">//&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;wildcard&nbsp;address&nbsp;over&nbsp;an&nbsp;AF_INET6</span><br>
<span class="lineno"></span><span class="comment" id="3126357">//&nbsp;&nbsp;&nbsp;&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0.&nbsp;&nbsp;Otherwise&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv4</span><br>
<span class="lineno"></span><span class="comment" id="3126416">//&nbsp;&nbsp;&nbsp;&nbsp;wildcard&nbsp;address&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET&nbsp;socket.</span><br>
<span class="lineno">85</span><span class="comment" id="3126467">//</span><br>
<span class="lineno"></span><span class="comment" id="3126470">//&nbsp;&nbsp;&nbsp;&nbsp;2.&nbsp;A&nbsp;wild-ipv4wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3126518">//&nbsp;&nbsp;&nbsp;&nbsp;Same&nbsp;as&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3126532">//</span><br>
<span class="lineno"></span><span class="comment" id="3126535">//&nbsp;&nbsp;&nbsp;&nbsp;3.&nbsp;A&nbsp;wild-ipv6wild&nbsp;listen,&nbsp;&#34;tcp&#34;&nbsp;+&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno">90</span><span class="comment" id="3126580">//&nbsp;&nbsp;&nbsp;&nbsp;Almost&nbsp;same&nbsp;as&nbsp;1&nbsp;but&nbsp;we&nbsp;prefer&nbsp;an&nbsp;IPv6&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="3126639">//&nbsp;&nbsp;&nbsp;&nbsp;listen&nbsp;over&nbsp;an&nbsp;AF_INET6&nbsp;socket&nbsp;with&nbsp;IPV6_V6ONLY=0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3126697">//&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;platform&nbsp;supports&nbsp;IPv6&nbsp;capability&nbsp;but&nbsp;not&nbsp;IPv6&nbsp;IPv4-</span><br>
<span class="lineno"></span><span class="comment" id="3126757">//&nbsp;&nbsp;&nbsp;&nbsp;mapping&nbsp;capability.</span><br>
<span class="lineno"></span><span class="comment" id="3126780">//</span><br>
<span class="lineno">95</span><span class="comment" id="3126783">//&nbsp;&nbsp;&nbsp;&nbsp;4.&nbsp;A&nbsp;ipv4-ipv4wild&nbsp;listen,&nbsp;&#34;tcp4&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;0.0.0.0&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3126838">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv4&nbsp;(AF_INET)&nbsp;wildcard&nbsp;address&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3126891">//</span><br>
<span class="lineno"></span><span class="comment" id="3126894">//&nbsp;&nbsp;&nbsp;&nbsp;5.&nbsp;A&nbsp;ipv6-ipv6wild&nbsp;listen,&nbsp;&#34;tcp6&#34;&nbsp;+&nbsp;&#34;&#34;&nbsp;or&nbsp;&#34;[::]&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3126946">//&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;use&nbsp;an&nbsp;IPv6&nbsp;(AF_INET6,&nbsp;IPV6_V6ONLY=1)&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">100</span><span class="comment" id="3127007">//&nbsp;&nbsp;&nbsp;&nbsp;listen.</span><br>
<span class="lineno"></span><span class="comment" id="3127018">//</span><br>
<span class="lineno"></span><span class="comment" id="3127021">//&nbsp;Otherwise&nbsp;guess:&nbsp;if&nbsp;the&nbsp;addresses&nbsp;are&nbsp;IPv4&nbsp;then&nbsp;returns&nbsp;AF_INET,</span><br>
<span class="lineno"></span><span class="comment" id="3127089">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;AF_INET6.&nbsp;&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;boolean&nbsp;value&nbsp;what</span><br>
<span class="lineno"></span><span class="comment" id="3127156">//&nbsp;designates&nbsp;IPV6_V6ONLY&nbsp;option.</span><br>
<span class="lineno">105</span><span class="comment" id="3127190">//</span><br>
<span class="lineno"></span><span class="comment" id="3127193">//&nbsp;Note&nbsp;that&nbsp;OpenBSD&nbsp;allows&nbsp;neither&nbsp;&#34;net.inet6.ip6.v6only=1&#34;&nbsp;change</span><br>
<span class="lineno"></span><span class="comment" id="3127261">//&nbsp;nor&nbsp;IPPROTO_IPV6&nbsp;level&nbsp;IPV6_V6ONLY&nbsp;socket&nbsp;option&nbsp;setting.</span><br>
<span class="lineno"></span><span class="keyword" id="3127322">func</span>&nbsp;<span class="ident" id="3127327">favoriteAddrFamily</span><span class="op" id="3127345">(</span><span class="ident" id="3127346">net</span>&nbsp;<span class="builtintype" id="3127350">string</span><span class="op" id="3127356">,</span>&nbsp;<span class="ident" id="3127358">laddr</span><span class="op" id="3127363">,</span>&nbsp;<span class="ident" id="3127365">raddr</span>&nbsp;<span class="ident" id="3127371">sockaddr</span><span class="op" id="3127379">,</span>&nbsp;<span class="ident" id="3127381">mode</span>&nbsp;<span class="builtintype" id="3127386">string</span><span class="op" id="3127392">)</span>&nbsp;<span class="op" id="3127394">(</span><span class="ident" id="3127395">family</span>&nbsp;<span class="builtintype" id="3127402">int</span><span class="op" id="3127405">,</span>&nbsp;<span class="ident" id="3127407">ipv6only</span>&nbsp;<span class="builtintype" id="3127416">bool</span><span class="op" id="3127420">)</span>&nbsp;<span class="op" id="3127422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127425">switch</span>&nbsp;<span class="ident" id="3127432">net</span><span class="op" id="3127435">[</span><span class="builtinfunc" id="3127436">len</span><span class="op" id="3127439">(</span><span class="ident" id="3127440">net</span><span class="op" id="3127443">)</span><span class="op" id="3127444">-</span><span class="num" id="3127445">1</span><span class="op" id="3127446">]</span>&nbsp;<span class="op" id="3127448">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127451">case</span>&nbsp;<span class="string" id="3127456">&#39;4&#39;</span><span class="op" id="3127459">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127463">return</span>&nbsp;<span class="ident" id="3127470">syscall</span><span class="op" id="3127477">.</span><span class="ident" id="3127478">AF_INET</span><span class="op" id="3127485">,</span>&nbsp;<span class="builtintype" id="3127487">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127494">case</span>&nbsp;<span class="string" id="3127499">&#39;6&#39;</span><span class="op" id="3127502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127506">return</span>&nbsp;<span class="ident" id="3127513">syscall</span><span class="op" id="3127520">.</span><span class="ident" id="3127521">AF_INET6</span><span class="op" id="3127529">,</span>&nbsp;<span class="builtintype" id="3127531">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127537">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127541">if</span>&nbsp;<span class="ident" id="3127544">mode</span>&nbsp;<span class="op" id="3127549">==</span>&nbsp;<span class="string" id="3127552">&#34;listen&#34;</span>&nbsp;<span class="op" id="3127561">&amp;&amp;</span>&nbsp;<span class="op" id="3127564">(</span><span class="ident" id="3127565">laddr</span>&nbsp;<span class="op" id="3127571">==</span>&nbsp;<span class="ident" id="3127574">nil</span>&nbsp;<span class="op" id="3127578">||</span>&nbsp;<span class="ident" id="3127581">laddr</span><span class="op" id="3127586">.</span><span class="ident" id="3127587">isWildcard</span><span class="op" id="3127597">(</span><span class="op" id="3127598">)</span><span class="op" id="3127599">)</span>&nbsp;<span class="op" id="3127601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127605">if</span>&nbsp;<span class="ident" id="3127608">supportsIPv4map</span>&nbsp;<span class="op" id="3127624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127629">return</span>&nbsp;<span class="ident" id="3127636">syscall</span><span class="op" id="3127643">.</span><span class="ident" id="3127644">AF_INET6</span><span class="op" id="3127652">,</span>&nbsp;<span class="builtintype" id="3127654">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127662">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127666">if</span>&nbsp;<span class="ident" id="3127669">laddr</span>&nbsp;<span class="op" id="3127675">==</span>&nbsp;<span class="ident" id="3127678">nil</span>&nbsp;<span class="op" id="3127682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127687">return</span>&nbsp;<span class="ident" id="3127694">syscall</span><span class="op" id="3127701">.</span><span class="ident" id="3127702">AF_INET</span><span class="op" id="3127709">,</span>&nbsp;<span class="builtintype" id="3127711">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127723">return</span>&nbsp;<span class="ident" id="3127730">laddr</span><span class="op" id="3127735">.</span><span class="ident" id="3127736">family</span><span class="op" id="3127742">(</span><span class="op" id="3127743">)</span><span class="op" id="3127744">,</span>&nbsp;<span class="builtintype" id="3127746">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127753">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127757">if</span>&nbsp;<span class="op" id="3127760">(</span><span class="ident" id="3127761">laddr</span>&nbsp;<span class="op" id="3127767">==</span>&nbsp;<span class="ident" id="3127770">nil</span>&nbsp;<span class="op" id="3127774">||</span>&nbsp;<span class="ident" id="3127777">laddr</span><span class="op" id="3127782">.</span><span class="ident" id="3127783">family</span><span class="op" id="3127789">(</span><span class="op" id="3127790">)</span>&nbsp;<span class="op" id="3127792">==</span>&nbsp;<span class="ident" id="3127795">syscall</span><span class="op" id="3127802">.</span><span class="ident" id="3127803">AF_INET</span><span class="op" id="3127810">)</span>&nbsp;<span class="op" id="3127812">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127817">(</span><span class="ident" id="3127818">raddr</span>&nbsp;<span class="op" id="3127824">==</span>&nbsp;<span class="ident" id="3127827">nil</span>&nbsp;<span class="op" id="3127831">||</span>&nbsp;<span class="ident" id="3127834">raddr</span><span class="op" id="3127839">.</span><span class="ident" id="3127840">family</span><span class="op" id="3127846">(</span><span class="op" id="3127847">)</span>&nbsp;<span class="op" id="3127849">==</span>&nbsp;<span class="ident" id="3127852">syscall</span><span class="op" id="3127859">.</span><span class="ident" id="3127860">AF_INET</span><span class="op" id="3127867">)</span>&nbsp;<span class="op" id="3127869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127873">return</span>&nbsp;<span class="ident" id="3127880">syscall</span><span class="op" id="3127887">.</span><span class="ident" id="3127888">AF_INET</span><span class="op" id="3127895">,</span>&nbsp;<span class="builtintype" id="3127897">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3127904">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3127907">return</span>&nbsp;<span class="ident" id="3127914">syscall</span><span class="op" id="3127921">.</span><span class="ident" id="3127922">AF_INET6</span><span class="op" id="3127930">,</span>&nbsp;<span class="builtintype" id="3127932">false</span><br>
<span class="lineno"></span><span class="op" id="3127938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3127941">//&nbsp;Internet&nbsp;sockets&nbsp;(TCP,&nbsp;UDP,&nbsp;IP)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="3127977">func</span>&nbsp;<span class="ident" id="3127982">internetSocket</span><span class="op" id="3127996">(</span><span class="ident" id="3127997">net</span>&nbsp;<span class="builtintype" id="3128001">string</span><span class="op" id="3128007">,</span>&nbsp;<span class="ident" id="3128009">laddr</span><span class="op" id="3128014">,</span>&nbsp;<span class="ident" id="3128016">raddr</span>&nbsp;<span class="ident" id="3128022">sockaddr</span><span class="op" id="3128030">,</span>&nbsp;<span class="ident" id="3128032">deadline</span>&nbsp;<span class="ident" id="3128041">time</span><span class="op" id="3128045">.</span><span class="ident" id="3128046">Time</span><span class="op" id="3128050">,</span>&nbsp;<span class="ident" id="3128052">sotype</span><span class="op" id="3128058">,</span>&nbsp;<span class="ident" id="3128060">proto</span>&nbsp;<span class="builtintype" id="3128066">int</span><span class="op" id="3128069">,</span>&nbsp;<span class="ident" id="3128071">mode</span>&nbsp;<span class="builtintype" id="3128076">string</span><span class="op" id="3128082">)</span>&nbsp;<span class="op" id="3128084">(</span><span class="ident" id="3128085">fd</span>&nbsp;<span class="op" id="3128088">*</span><span class="ident" id="3128089">netFD</span><span class="op" id="3128094">,</span>&nbsp;<span class="ident" id="3128096">err</span>&nbsp;<span class="builtintype" id="3128100">error</span><span class="op" id="3128105">)</span>&nbsp;<span class="op" id="3128107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128110">family</span><span class="op" id="3128116">,</span>&nbsp;<span class="ident" id="3128118">ipv6only</span>&nbsp;<span class="op" id="3128127">:=</span>&nbsp;<span class="ident" id="3128130">favoriteAddrFamily</span><span class="op" id="3128148">(</span><span class="ident" id="3128149">net</span><span class="op" id="3128152">,</span>&nbsp;<span class="ident" id="3128154">laddr</span><span class="op" id="3128159">,</span>&nbsp;<span class="ident" id="3128161">raddr</span><span class="op" id="3128166">,</span>&nbsp;<span class="ident" id="3128168">mode</span><span class="op" id="3128172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128175">return</span>&nbsp;<span class="ident" id="3128182">socket</span><span class="op" id="3128188">(</span><span class="ident" id="3128189">net</span><span class="op" id="3128192">,</span>&nbsp;<span class="ident" id="3128194">family</span><span class="op" id="3128200">,</span>&nbsp;<span class="ident" id="3128202">sotype</span><span class="op" id="3128208">,</span>&nbsp;<span class="ident" id="3128210">proto</span><span class="op" id="3128215">,</span>&nbsp;<span class="ident" id="3128217">ipv6only</span><span class="op" id="3128225">,</span>&nbsp;<span class="ident" id="3128227">laddr</span><span class="op" id="3128232">,</span>&nbsp;<span class="ident" id="3128234">raddr</span><span class="op" id="3128239">,</span>&nbsp;<span class="ident" id="3128241">deadline</span><span class="op" id="3128249">)</span><br>
<span class="lineno"></span><span class="op" id="3128251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3128254">func</span>&nbsp;<span class="ident" id="3128259">ipToSockaddr</span><span class="op" id="3128271">(</span><span class="ident" id="3128272">family</span>&nbsp;<span class="builtintype" id="3128279">int</span><span class="op" id="3128282">,</span>&nbsp;<span class="ident" id="3128284">ip</span>&nbsp;<span class="ident" id="3128287">IP</span><span class="op" id="3128289">,</span>&nbsp;<span class="ident" id="3128291">port</span>&nbsp;<span class="builtintype" id="3128296">int</span><span class="op" id="3128299">,</span>&nbsp;<span class="ident" id="3128301">zone</span>&nbsp;<span class="builtintype" id="3128306">string</span><span class="op" id="3128312">)</span>&nbsp;<span class="op" id="3128314">(</span><span class="ident" id="3128315">syscall</span><span class="op" id="3128322">.</span><span class="ident" id="3128323">Sockaddr</span><span class="op" id="3128331">,</span>&nbsp;<span class="builtintype" id="3128333">error</span><span class="op" id="3128338">)</span>&nbsp;<span class="op" id="3128340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128343">switch</span>&nbsp;<span class="ident" id="3128350">family</span>&nbsp;<span class="op" id="3128357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128360">case</span>&nbsp;<span class="ident" id="3128365">syscall</span><span class="op" id="3128372">.</span><span class="ident" id="3128373">AF_INET</span><span class="op" id="3128380">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128384">if</span>&nbsp;<span class="builtinfunc" id="3128387">len</span><span class="op" id="3128390">(</span><span class="ident" id="3128391">ip</span><span class="op" id="3128393">)</span>&nbsp;<span class="op" id="3128395">==</span>&nbsp;<span class="num" id="3128398">0</span>&nbsp;<span class="op" id="3128400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128405">ip</span>&nbsp;<span class="op" id="3128408">=</span>&nbsp;<span class="ident" id="3128410">IPv4zero</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128425">if</span>&nbsp;<span class="ident" id="3128428">ip</span>&nbsp;<span class="op" id="3128431">=</span>&nbsp;<span class="ident" id="3128433">ip</span><span class="op" id="3128435">.</span><span class="ident" id="3128436">To4</span><span class="op" id="3128439">(</span><span class="op" id="3128440">)</span><span class="op" id="3128441">;</span>&nbsp;<span class="ident" id="3128443">ip</span>&nbsp;<span class="op" id="3128446">==</span>&nbsp;<span class="ident" id="3128449">nil</span>&nbsp;<span class="op" id="3128453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128458">return</span>&nbsp;<span class="ident" id="3128465">nil</span><span class="op" id="3128468">,</span>&nbsp;<span class="ident" id="3128470">InvalidAddrError</span><span class="op" id="3128486">(</span><span class="string" id="3128487">&#34;non-IPv4&nbsp;address&#34;</span><span class="op" id="3128505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128513">sa</span>&nbsp;<span class="op" id="3128516">:=</span>&nbsp;<span class="builtinfunc" id="3128519">new</span><span class="op" id="3128522">(</span><span class="ident" id="3128523">syscall</span><span class="op" id="3128530">.</span><span class="ident" id="3128531">SockaddrInet4</span><span class="op" id="3128544">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128548">for</span>&nbsp;<span class="ident" id="3128552">i</span>&nbsp;<span class="op" id="3128554">:=</span>&nbsp;<span class="num" id="3128557">0</span><span class="op" id="3128558">;</span>&nbsp;<span class="ident" id="3128560">i</span>&nbsp;<span class="op" id="3128562">&lt;</span>&nbsp;<span class="ident" id="3128564">IPv4len</span><span class="op" id="3128571">;</span>&nbsp;<span class="ident" id="3128573">i</span><span class="op" id="3128574">++</span>&nbsp;<span class="op" id="3128577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128582">sa</span><span class="op" id="3128584">.</span><span class="ident" id="3128585">Addr</span><span class="op" id="3128589">[</span><span class="ident" id="3128590">i</span><span class="op" id="3128591">]</span>&nbsp;<span class="op" id="3128593">=</span>&nbsp;<span class="ident" id="3128595">ip</span><span class="op" id="3128597">[</span><span class="ident" id="3128598">i</span><span class="op" id="3128599">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128603">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128607">sa</span><span class="op" id="3128609">.</span><span class="ident" id="3128610">Port</span>&nbsp;<span class="op" id="3128615">=</span>&nbsp;<span class="ident" id="3128617">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128624">return</span>&nbsp;<span class="ident" id="3128631">sa</span><span class="op" id="3128633">,</span>&nbsp;<span class="ident" id="3128635">nil</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128640">case</span>&nbsp;<span class="ident" id="3128645">syscall</span><span class="op" id="3128652">.</span><span class="ident" id="3128653">AF_INET6</span><span class="op" id="3128661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128665">if</span>&nbsp;<span class="builtinfunc" id="3128668">len</span><span class="op" id="3128671">(</span><span class="ident" id="3128672">ip</span><span class="op" id="3128674">)</span>&nbsp;<span class="op" id="3128676">==</span>&nbsp;<span class="num" id="3128679">0</span>&nbsp;<span class="op" id="3128681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128686">ip</span>&nbsp;<span class="op" id="3128689">=</span>&nbsp;<span class="ident" id="3128691">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128706">//&nbsp;IPv4&nbsp;callers&nbsp;use&nbsp;0.0.0.0&nbsp;to&nbsp;mean&nbsp;&#34;announce&nbsp;on&nbsp;any&nbsp;available&nbsp;address&#34;.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128781">//&nbsp;In&nbsp;IPv6&nbsp;mode,&nbsp;Linux&nbsp;treats&nbsp;that&nbsp;as&nbsp;meaning&nbsp;&#34;announce&nbsp;on&nbsp;0.0.0.0&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3128852">//&nbsp;which&nbsp;it&nbsp;refuses&nbsp;to&nbsp;do.&nbsp;&nbsp;Rewrite&nbsp;to&nbsp;the&nbsp;IPv6&nbsp;unspecified&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128923">if</span>&nbsp;<span class="ident" id="3128926">ip</span><span class="op" id="3128928">.</span><span class="ident" id="3128929">Equal</span><span class="op" id="3128934">(</span><span class="ident" id="3128935">IPv4zero</span><span class="op" id="3128943">)</span>&nbsp;<span class="op" id="3128945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3128950">ip</span>&nbsp;<span class="op" id="3128953">=</span>&nbsp;<span class="ident" id="3128955">IPv6zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3128966">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3128970">if</span>&nbsp;<span class="ident" id="3128973">ip</span>&nbsp;<span class="op" id="3128976">=</span>&nbsp;<span class="ident" id="3128978">ip</span><span class="op" id="3128980">.</span><span class="ident" id="3128981">To16</span><span class="op" id="3128985">(</span><span class="op" id="3128986">)</span><span class="op" id="3128987">;</span>&nbsp;<span class="ident" id="3128989">ip</span>&nbsp;<span class="op" id="3128992">==</span>&nbsp;<span class="ident" id="3128995">nil</span>&nbsp;<span class="op" id="3128999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129004">return</span>&nbsp;<span class="ident" id="3129011">nil</span><span class="op" id="3129014">,</span>&nbsp;<span class="ident" id="3129016">InvalidAddrError</span><span class="op" id="3129032">(</span><span class="string" id="3129033">&#34;non-IPv6&nbsp;address&#34;</span><span class="op" id="3129051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129059">sa</span>&nbsp;<span class="op" id="3129062">:=</span>&nbsp;<span class="builtinfunc" id="3129065">new</span><span class="op" id="3129068">(</span><span class="ident" id="3129069">syscall</span><span class="op" id="3129076">.</span><span class="ident" id="3129077">SockaddrInet6</span><span class="op" id="3129090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129094">for</span>&nbsp;<span class="ident" id="3129098">i</span>&nbsp;<span class="op" id="3129100">:=</span>&nbsp;<span class="num" id="3129103">0</span><span class="op" id="3129104">;</span>&nbsp;<span class="ident" id="3129106">i</span>&nbsp;<span class="op" id="3129108">&lt;</span>&nbsp;<span class="ident" id="3129110">IPv6len</span><span class="op" id="3129117">;</span>&nbsp;<span class="ident" id="3129119">i</span><span class="op" id="3129120">++</span>&nbsp;<span class="op" id="3129123">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129128">sa</span><span class="op" id="3129130">.</span><span class="ident" id="3129131">Addr</span><span class="op" id="3129135">[</span><span class="ident" id="3129136">i</span><span class="op" id="3129137">]</span>&nbsp;<span class="op" id="3129139">=</span>&nbsp;<span class="ident" id="3129141">ip</span><span class="op" id="3129143">[</span><span class="ident" id="3129144">i</span><span class="op" id="3129145">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129153">sa</span><span class="op" id="3129155">.</span><span class="ident" id="3129156">Port</span>&nbsp;<span class="op" id="3129161">=</span>&nbsp;<span class="ident" id="3129163">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3129170">sa</span><span class="op" id="3129172">.</span><span class="ident" id="3129173">ZoneId</span>&nbsp;<span class="op" id="3129180">=</span>&nbsp;<span class="builtintype" id="3129182">uint32</span><span class="op" id="3129188">(</span><span class="ident" id="3129189">zoneToInt</span><span class="op" id="3129198">(</span><span class="ident" id="3129199">zone</span><span class="op" id="3129203">)</span><span class="op" id="3129204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129208">return</span>&nbsp;<span class="ident" id="3129215">sa</span><span class="op" id="3129217">,</span>&nbsp;<span class="ident" id="3129219">nil</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3129224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3129227">return</span>&nbsp;<span class="ident" id="3129234">nil</span><span class="op" id="3129237">,</span>&nbsp;<span class="ident" id="3129239">InvalidAddrError</span><span class="op" id="3129255">(</span><span class="string" id="3129256">&#34;unexpected&nbsp;socket&nbsp;family&#34;</span><span class="op" id="3129282">)</span><br>
<span class="lineno"></span><span class="op" id="3129284">}</span>
</div>
</body>
</html>
