<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1404331">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1404386">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1404440">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1404491">package</span>&nbsp;<span class="ident" id="1404499">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1404508">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1404566">import</span>&nbsp;<span class="string" id="1404573">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1404583">const</span>&nbsp;<span class="op" id="1404589">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404592">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1404602">=</span>&nbsp;<span class="num" id="1404604">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404607">hchanSize</span>&nbsp;<span class="op" id="1404617">=</span>&nbsp;<span class="ident" id="1404619">unsafe</span><span class="op" id="1404625">.</span><span class="ident" id="1404626">Sizeof</span><span class="op" id="1404632">(</span><span class="ident" id="1404633">hchan</span><span class="op" id="1404638">{</span><span class="op" id="1404639">}</span><span class="op" id="1404640">)</span>&nbsp;<span class="op" id="1404642">+</span>&nbsp;<span class="builtintype" id="1404644">uintptr</span><span class="op" id="1404651">(</span><span class="op" id="1404652">-</span><span class="builtintype" id="1404653">int</span><span class="op" id="1404656">(</span><span class="ident" id="1404657">unsafe</span><span class="op" id="1404663">.</span><span class="ident" id="1404664">Sizeof</span><span class="op" id="1404670">(</span><span class="ident" id="1404671">hchan</span><span class="op" id="1404676">{</span><span class="op" id="1404677">}</span><span class="op" id="1404678">)</span><span class="op" id="1404679">)</span><span class="op" id="1404680">&amp;</span><span class="op" id="1404681">(</span><span class="ident" id="1404682">maxAlign</span><span class="op" id="1404690">-</span><span class="num" id="1404691">1</span><span class="op" id="1404692">)</span><span class="op" id="1404693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404696">debugChan</span>&nbsp;<span class="op" id="1404706">=</span>&nbsp;<span class="builtintype" id="1404708">false</span><br>
<span class="lineno">15</span><span class="op" id="1404714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1404717">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1404779">func</span>&nbsp;<span class="ident" id="1404784">makechan</span><span class="op" id="1404792">(</span><span class="ident" id="1404793">t</span>&nbsp;<span class="op" id="1404795">*</span><span class="ident" id="1404796">chantype</span><span class="op" id="1404804">,</span>&nbsp;<span class="ident" id="1404806">size</span>&nbsp;<span class="builtintype" id="1404811">int64</span><span class="op" id="1404816">)</span>&nbsp;<span class="op" id="1404818">*</span><span class="ident" id="1404819">hchan</span>&nbsp;<span class="op" id="1404825">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404828">elem</span>&nbsp;<span class="op" id="1404833">:=</span>&nbsp;<span class="ident" id="1404836">t</span><span class="op" id="1404837">.</span><span class="ident" id="1404838">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1404845">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404883">if</span>&nbsp;<span class="ident" id="1404886">elem</span><span class="op" id="1404890">.</span><span class="ident" id="1404891">size</span>&nbsp;<span class="op" id="1404896">&gt;=</span>&nbsp;<span class="num" id="1404899">1</span><span class="op" id="1404900">&lt;&lt;</span><span class="num" id="1404902">16</span>&nbsp;<span class="op" id="1404905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1404909">gothrow</span><span class="op" id="1404916">(</span><span class="string" id="1404917">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1404957">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1404960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1404963">if</span>&nbsp;<span class="ident" id="1404966">hchanSize</span><span class="op" id="1404975">%</span><span class="ident" id="1404976">maxAlign</span>&nbsp;<span class="op" id="1404985">!=</span>&nbsp;<span class="num" id="1404988">0</span>&nbsp;<span class="op" id="1404990">||</span>&nbsp;<span class="ident" id="1404993">elem</span><span class="op" id="1404997">.</span><span class="ident" id="1404998">align</span>&nbsp;<span class="op" id="1405004">&gt;</span>&nbsp;<span class="ident" id="1405006">maxAlign</span>&nbsp;<span class="op" id="1405015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405019">gothrow</span><span class="op" id="1405026">(</span><span class="string" id="1405027">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1405052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405058">if</span>&nbsp;<span class="ident" id="1405061">size</span>&nbsp;<span class="op" id="1405066">&lt;</span>&nbsp;<span class="num" id="1405068">0</span>&nbsp;<span class="op" id="1405070">||</span>&nbsp;<span class="builtintype" id="1405073">int64</span><span class="op" id="1405078">(</span><span class="builtintype" id="1405079">uintptr</span><span class="op" id="1405086">(</span><span class="ident" id="1405087">size</span><span class="op" id="1405091">)</span><span class="op" id="1405092">)</span>&nbsp;<span class="op" id="1405094">!=</span>&nbsp;<span class="ident" id="1405097">size</span>&nbsp;<span class="op" id="1405102">||</span>&nbsp;<span class="op" id="1405105">(</span><span class="ident" id="1405106">elem</span><span class="op" id="1405110">.</span><span class="ident" id="1405111">size</span>&nbsp;<span class="op" id="1405116">&gt;</span>&nbsp;<span class="num" id="1405118">0</span>&nbsp;<span class="op" id="1405120">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1405123">uintptr</span><span class="op" id="1405130">(</span><span class="ident" id="1405131">size</span><span class="op" id="1405135">)</span>&nbsp;<span class="op" id="1405137">&gt;</span>&nbsp;<span class="op" id="1405139">(</span><span class="ident" id="1405140">maxmem</span><span class="op" id="1405146">-</span><span class="ident" id="1405147">hchanSize</span><span class="op" id="1405156">)</span><span class="op" id="1405157">/</span><span class="builtintype" id="1405158">uintptr</span><span class="op" id="1405165">(</span><span class="ident" id="1405166">elem</span><span class="op" id="1405170">.</span><span class="ident" id="1405171">size</span><span class="op" id="1405175">)</span><span class="op" id="1405176">)</span>&nbsp;<span class="op" id="1405178">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1405182">panic</span><span class="op" id="1405187">(</span><span class="string" id="1405188">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1405217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405224">var</span>&nbsp;<span class="ident" id="1405228">c</span>&nbsp;<span class="op" id="1405230">*</span><span class="ident" id="1405231">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405238">if</span>&nbsp;<span class="ident" id="1405241">elem</span><span class="op" id="1405245">.</span><span class="ident" id="1405246">kind</span><span class="op" id="1405250">&amp;</span><span class="ident" id="1405251">kindNoPointers</span>&nbsp;<span class="op" id="1405266">!=</span>&nbsp;<span class="num" id="1405269">0</span>&nbsp;<span class="op" id="1405271">||</span>&nbsp;<span class="ident" id="1405274">size</span>&nbsp;<span class="op" id="1405279">==</span>&nbsp;<span class="num" id="1405282">0</span>&nbsp;<span class="op" id="1405284">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405288">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405322">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405392">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405458">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1405539">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405614">c</span>&nbsp;<span class="op" id="1405616">=</span>&nbsp;<span class="op" id="1405618">(</span><span class="op" id="1405619">*</span><span class="ident" id="1405620">hchan</span><span class="op" id="1405625">)</span><span class="op" id="1405626">(</span><span class="ident" id="1405627">mallocgc</span><span class="op" id="1405635">(</span><span class="ident" id="1405636">hchanSize</span><span class="op" id="1405645">+</span><span class="builtintype" id="1405646">uintptr</span><span class="op" id="1405653">(</span><span class="ident" id="1405654">size</span><span class="op" id="1405658">)</span><span class="op" id="1405659">*</span><span class="builtintype" id="1405660">uintptr</span><span class="op" id="1405667">(</span><span class="ident" id="1405668">elem</span><span class="op" id="1405672">.</span><span class="ident" id="1405673">size</span><span class="op" id="1405677">)</span><span class="op" id="1405678">,</span>&nbsp;<span class="builtintype" id="1405680">nil</span><span class="op" id="1405683">,</span>&nbsp;<span class="ident" id="1405685">flagNoScan</span><span class="op" id="1405695">)</span><span class="op" id="1405696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1405700">if</span>&nbsp;<span class="ident" id="1405703">size</span>&nbsp;<span class="op" id="1405708">&gt;</span>&nbsp;<span class="num" id="1405710">0</span>&nbsp;<span class="op" id="1405712">&amp;&amp;</span>&nbsp;<span class="ident" id="1405715">elem</span><span class="op" id="1405719">.</span><span class="ident" id="1405720">size</span>&nbsp;<span class="op" id="1405725">!=</span>&nbsp;<span class="num" id="1405728">0</span>&nbsp;<span class="op" id="1405730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405735">c</span><span class="op" id="1405736">.</span><span class="ident" id="1405737">buf</span>&nbsp;<span class="op" id="1405741">=</span>&nbsp;<span class="op" id="1405743">(</span><span class="op" id="1405744">*</span><span class="builtintype" id="1405745">uint8</span><span class="op" id="1405750">)</span><span class="op" id="1405751">(</span><span class="ident" id="1405752">add</span><span class="op" id="1405755">(</span><span class="ident" id="1405756">unsafe</span><span class="op" id="1405762">.</span><span class="ident" id="1405763">Pointer</span><span class="op" id="1405770">(</span><span class="ident" id="1405771">c</span><span class="op" id="1405772">)</span><span class="op" id="1405773">,</span>&nbsp;<span class="ident" id="1405775">hchanSize</span><span class="op" id="1405784">)</span><span class="op" id="1405785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405789">}</span>&nbsp;<span class="keyword" id="1405791">else</span>&nbsp;<span class="op" id="1405796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405801">c</span><span class="op" id="1405802">.</span><span class="ident" id="1405803">buf</span>&nbsp;<span class="op" id="1405807">=</span>&nbsp;<span class="op" id="1405809">(</span><span class="op" id="1405810">*</span><span class="builtintype" id="1405811">uint8</span><span class="op" id="1405816">)</span><span class="op" id="1405817">(</span><span class="ident" id="1405818">unsafe</span><span class="op" id="1405824">.</span><span class="ident" id="1405825">Pointer</span><span class="op" id="1405832">(</span><span class="ident" id="1405833">c</span><span class="op" id="1405834">)</span><span class="op" id="1405835">)</span>&nbsp;<span class="comment" id="1405837">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405898">}</span>&nbsp;<span class="keyword" id="1405900">else</span>&nbsp;<span class="op" id="1405905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405909">c</span>&nbsp;<span class="op" id="1405911">=</span>&nbsp;<span class="builtinfunc" id="1405913">new</span><span class="op" id="1405916">(</span><span class="ident" id="1405917">hchan</span><span class="op" id="1405922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405926">c</span><span class="op" id="1405927">.</span><span class="ident" id="1405928">buf</span>&nbsp;<span class="op" id="1405932">=</span>&nbsp;<span class="op" id="1405934">(</span><span class="op" id="1405935">*</span><span class="builtintype" id="1405936">uint8</span><span class="op" id="1405941">)</span><span class="op" id="1405942">(</span><span class="ident" id="1405943">newarray</span><span class="op" id="1405951">(</span><span class="ident" id="1405952">elem</span><span class="op" id="1405956">,</span>&nbsp;<span class="builtintype" id="1405958">uintptr</span><span class="op" id="1405965">(</span><span class="ident" id="1405966">size</span><span class="op" id="1405970">)</span><span class="op" id="1405971">)</span><span class="op" id="1405972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1405975">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1405978">c</span><span class="op" id="1405979">.</span><span class="ident" id="1405980">elemsize</span>&nbsp;<span class="op" id="1405989">=</span>&nbsp;<span class="builtintype" id="1405991">uint16</span><span class="op" id="1405997">(</span><span class="ident" id="1405998">elem</span><span class="op" id="1406002">.</span><span class="ident" id="1406003">size</span><span class="op" id="1406007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406010">c</span><span class="op" id="1406011">.</span><span class="ident" id="1406012">elemtype</span>&nbsp;<span class="op" id="1406021">=</span>&nbsp;<span class="ident" id="1406023">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406029">c</span><span class="op" id="1406030">.</span><span class="ident" id="1406031">dataqsiz</span>&nbsp;<span class="op" id="1406040">=</span>&nbsp;<span class="builtintype" id="1406042">uint</span><span class="op" id="1406046">(</span><span class="ident" id="1406047">size</span><span class="op" id="1406051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1406055">if</span>&nbsp;<span class="ident" id="1406058">debugChan</span>&nbsp;<span class="op" id="1406068">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1406072">print</span><span class="op" id="1406077">(</span><span class="string" id="1406078">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1406095">,</span>&nbsp;<span class="ident" id="1406097">c</span><span class="op" id="1406098">,</span>&nbsp;<span class="string" id="1406100">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1406113">,</span>&nbsp;<span class="ident" id="1406115">elem</span><span class="op" id="1406119">.</span><span class="ident" id="1406120">size</span><span class="op" id="1406124">,</span>&nbsp;<span class="string" id="1406126">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1406138">,</span>&nbsp;<span class="ident" id="1406140">elem</span><span class="op" id="1406144">.</span><span class="ident" id="1406145">alg</span><span class="op" id="1406148">,</span>&nbsp;<span class="string" id="1406150">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1406163">,</span>&nbsp;<span class="ident" id="1406165">size</span><span class="op" id="1406169">,</span>&nbsp;<span class="string" id="1406171">&#34;\n&#34;</span><span class="op" id="1406175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1406178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1406181">return</span>&nbsp;<span class="ident" id="1406188">c</span><br>
<span class="lineno"></span><span class="op" id="1406190">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1406193">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1406253">func</span>&nbsp;<span class="ident" id="1406258">chanbuf</span><span class="op" id="1406265">(</span><span class="ident" id="1406266">c</span>&nbsp;<span class="op" id="1406268">*</span><span class="ident" id="1406269">hchan</span><span class="op" id="1406274">,</span>&nbsp;<span class="ident" id="1406276">i</span>&nbsp;<span class="builtintype" id="1406278">uint</span><span class="op" id="1406282">)</span>&nbsp;<span class="ident" id="1406284">unsafe</span><span class="op" id="1406290">.</span><span class="ident" id="1406291">Pointer</span>&nbsp;<span class="op" id="1406299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1406302">return</span>&nbsp;<span class="ident" id="1406309">add</span><span class="op" id="1406312">(</span><span class="ident" id="1406313">unsafe</span><span class="op" id="1406319">.</span><span class="ident" id="1406320">Pointer</span><span class="op" id="1406327">(</span><span class="ident" id="1406328">c</span><span class="op" id="1406329">.</span><span class="ident" id="1406330">buf</span><span class="op" id="1406333">)</span><span class="op" id="1406334">,</span>&nbsp;<span class="builtintype" id="1406336">uintptr</span><span class="op" id="1406343">(</span><span class="ident" id="1406344">i</span><span class="op" id="1406345">)</span><span class="op" id="1406346">*</span><span class="builtintype" id="1406347">uintptr</span><span class="op" id="1406354">(</span><span class="ident" id="1406355">c</span><span class="op" id="1406356">.</span><span class="ident" id="1406357">elemsize</span><span class="op" id="1406365">)</span><span class="op" id="1406366">)</span><br>
<span class="lineno"></span><span class="op" id="1406368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1406371">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1406416">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1406429">func</span>&nbsp;<span class="ident" id="1406434">chansend1</span><span class="op" id="1406443">(</span><span class="ident" id="1406444">t</span>&nbsp;<span class="op" id="1406446">*</span><span class="ident" id="1406447">chantype</span><span class="op" id="1406455">,</span>&nbsp;<span class="ident" id="1406457">c</span>&nbsp;<span class="op" id="1406459">*</span><span class="ident" id="1406460">hchan</span><span class="op" id="1406465">,</span>&nbsp;<span class="ident" id="1406467">elem</span>&nbsp;<span class="ident" id="1406472">unsafe</span><span class="op" id="1406478">.</span><span class="ident" id="1406479">Pointer</span><span class="op" id="1406486">)</span>&nbsp;<span class="op" id="1406488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1406491">chansend</span><span class="op" id="1406499">(</span><span class="ident" id="1406500">t</span><span class="op" id="1406501">,</span>&nbsp;<span class="ident" id="1406503">c</span><span class="op" id="1406504">,</span>&nbsp;<span class="ident" id="1406506">elem</span><span class="op" id="1406510">,</span>&nbsp;<span class="builtintype" id="1406512">true</span><span class="op" id="1406516">,</span>&nbsp;<span class="ident" id="1406518">getcallerpc</span><span class="op" id="1406529">(</span><span class="ident" id="1406530">unsafe</span><span class="op" id="1406536">.</span><span class="ident" id="1406537">Pointer</span><span class="op" id="1406544">(</span><span class="op" id="1406545">&amp;</span><span class="ident" id="1406546">t</span><span class="op" id="1406547">)</span><span class="op" id="1406548">)</span><span class="op" id="1406549">)</span><br>
<span class="lineno"></span><span class="op" id="1406551">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1406554">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1406888">func</span>&nbsp;<span class="ident" id="1406893">chansend</span><span class="op" id="1406901">(</span><span class="ident" id="1406902">t</span>&nbsp;<span class="op" id="1406904">*</span><span class="ident" id="1406905">chantype</span><span class="op" id="1406913">,</span>&nbsp;<span class="ident" id="1406915">c</span>&nbsp;<span class="op" id="1406917">*</span><span class="ident" id="1406918">hchan</span><span class="op" id="1406923">,</span>&nbsp;<span class="ident" id="1406925">ep</span>&nbsp;<span class="ident" id="1406928">unsafe</span><span class="op" id="1406934">.</span><span class="ident" id="1406935">Pointer</span><span class="op" id="1406942">,</span>&nbsp;<span class="ident" id="1406944">block</span>&nbsp;<span class="builtintype" id="1406950">bool</span><span class="op" id="1406954">,</span>&nbsp;<span class="ident" id="1406956">callerpc</span>&nbsp;<span class="builtintype" id="1406965">uintptr</span><span class="op" id="1406972">)</span>&nbsp;<span class="builtintype" id="1406974">bool</span>&nbsp;<span class="op" id="1406979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1406982">if</span>&nbsp;<span class="ident" id="1406985">raceenabled</span>&nbsp;<span class="op" id="1406997">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407001">raceReadObjectPC</span><span class="op" id="1407017">(</span><span class="ident" id="1407018">t</span><span class="op" id="1407019">.</span><span class="ident" id="1407020">elem</span><span class="op" id="1407024">,</span>&nbsp;<span class="ident" id="1407026">ep</span><span class="op" id="1407028">,</span>&nbsp;<span class="ident" id="1407030">callerpc</span><span class="op" id="1407038">,</span>&nbsp;<span class="ident" id="1407040">funcPC</span><span class="op" id="1407046">(</span><span class="ident" id="1407047">chansend</span><span class="op" id="1407055">)</span><span class="op" id="1407056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1407059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407063">if</span>&nbsp;<span class="ident" id="1407066">c</span>&nbsp;<span class="op" id="1407068">==</span>&nbsp;<span class="builtintype" id="1407071">nil</span>&nbsp;<span class="op" id="1407075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407079">if</span>&nbsp;<span class="op" id="1407082">!</span><span class="ident" id="1407083">block</span>&nbsp;<span class="op" id="1407089">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407094">return</span>&nbsp;<span class="builtintype" id="1407101">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1407109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407113">gopark</span><span class="op" id="1407119">(</span><span class="builtintype" id="1407120">nil</span><span class="op" id="1407123">,</span>&nbsp;<span class="builtintype" id="1407125">nil</span><span class="op" id="1407128">,</span>&nbsp;<span class="string" id="1407130">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1407152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407156">gothrow</span><span class="op" id="1407163">(</span><span class="string" id="1407164">&#34;unreachable&#34;</span><span class="op" id="1407177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1407180">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407184">if</span>&nbsp;<span class="ident" id="1407187">debugChan</span>&nbsp;<span class="op" id="1407197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1407201">print</span><span class="op" id="1407206">(</span><span class="string" id="1407207">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1407224">,</span>&nbsp;<span class="ident" id="1407226">c</span><span class="op" id="1407227">,</span>&nbsp;<span class="string" id="1407229">&#34;\n&#34;</span><span class="op" id="1407233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1407236">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1407240">if</span>&nbsp;<span class="ident" id="1407243">raceenabled</span>&nbsp;<span class="op" id="1407255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1407259">racereadpc</span><span class="op" id="1407269">(</span><span class="ident" id="1407270">unsafe</span><span class="op" id="1407276">.</span><span class="ident" id="1407277">Pointer</span><span class="op" id="1407284">(</span><span class="ident" id="1407285">c</span><span class="op" id="1407286">)</span><span class="op" id="1407287">,</span>&nbsp;<span class="ident" id="1407289">callerpc</span><span class="op" id="1407297">,</span>&nbsp;<span class="ident" id="1407299">funcPC</span><span class="op" id="1407305">(</span><span class="ident" id="1407306">chansend</span><span class="op" id="1407314">)</span><span class="op" id="1407315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1407318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407322">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407405">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407409">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407492">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407574">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407662">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407737">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407826">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407907">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1407994">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408039">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408043">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408129">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1408213">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408269">if</span>&nbsp;<span class="op" id="1408272">!</span><span class="ident" id="1408273">block</span>&nbsp;<span class="op" id="1408279">&amp;&amp;</span>&nbsp;<span class="ident" id="1408282">c</span><span class="op" id="1408283">.</span><span class="ident" id="1408284">closed</span>&nbsp;<span class="op" id="1408291">==</span>&nbsp;<span class="num" id="1408294">0</span>&nbsp;<span class="op" id="1408296">&amp;&amp;</span>&nbsp;<span class="op" id="1408299">(</span><span class="op" id="1408300">(</span><span class="ident" id="1408301">c</span><span class="op" id="1408302">.</span><span class="ident" id="1408303">dataqsiz</span>&nbsp;<span class="op" id="1408312">==</span>&nbsp;<span class="num" id="1408315">0</span>&nbsp;<span class="op" id="1408317">&amp;&amp;</span>&nbsp;<span class="ident" id="1408320">c</span><span class="op" id="1408321">.</span><span class="ident" id="1408322">recvq</span><span class="op" id="1408327">.</span><span class="ident" id="1408328">first</span>&nbsp;<span class="op" id="1408334">==</span>&nbsp;<span class="builtintype" id="1408337">nil</span><span class="op" id="1408340">)</span>&nbsp;<span class="op" id="1408342">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408347">(</span><span class="ident" id="1408348">c</span><span class="op" id="1408349">.</span><span class="ident" id="1408350">dataqsiz</span>&nbsp;<span class="op" id="1408359">&gt;</span>&nbsp;<span class="num" id="1408361">0</span>&nbsp;<span class="op" id="1408363">&amp;&amp;</span>&nbsp;<span class="ident" id="1408366">c</span><span class="op" id="1408367">.</span><span class="ident" id="1408368">qcount</span>&nbsp;<span class="op" id="1408375">==</span>&nbsp;<span class="ident" id="1408378">c</span><span class="op" id="1408379">.</span><span class="ident" id="1408380">dataqsiz</span><span class="op" id="1408388">)</span><span class="op" id="1408389">)</span>&nbsp;<span class="op" id="1408391">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408395">return</span>&nbsp;<span class="builtintype" id="1408402">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408413">var</span>&nbsp;<span class="ident" id="1408417">t0</span>&nbsp;<span class="builtintype" id="1408420">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408427">if</span>&nbsp;<span class="ident" id="1408430">blockprofilerate</span>&nbsp;<span class="op" id="1408447">&gt;</span>&nbsp;<span class="num" id="1408449">0</span>&nbsp;<span class="op" id="1408451">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408455">t0</span>&nbsp;<span class="op" id="1408458">=</span>&nbsp;<span class="ident" id="1408460">cputicks</span><span class="op" id="1408468">(</span><span class="op" id="1408469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408476">lock</span><span class="op" id="1408480">(</span><span class="op" id="1408481">&amp;</span><span class="ident" id="1408482">c</span><span class="op" id="1408483">.</span><span class="ident" id="1408484">lock</span><span class="op" id="1408488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408491">if</span>&nbsp;<span class="ident" id="1408494">c</span><span class="op" id="1408495">.</span><span class="ident" id="1408496">closed</span>&nbsp;<span class="op" id="1408503">!=</span>&nbsp;<span class="num" id="1408506">0</span>&nbsp;<span class="op" id="1408508">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408512">unlock</span><span class="op" id="1408518">(</span><span class="op" id="1408519">&amp;</span><span class="ident" id="1408520">c</span><span class="op" id="1408521">.</span><span class="ident" id="1408522">lock</span><span class="op" id="1408526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1408530">panic</span><span class="op" id="1408535">(</span><span class="string" id="1408536">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1408560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408567">if</span>&nbsp;<span class="ident" id="1408570">c</span><span class="op" id="1408571">.</span><span class="ident" id="1408572">dataqsiz</span>&nbsp;<span class="op" id="1408581">==</span>&nbsp;<span class="num" id="1408584">0</span>&nbsp;<span class="op" id="1408586">{</span>&nbsp;<span class="comment" id="1408588">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408613">sg</span>&nbsp;<span class="op" id="1408616">:=</span>&nbsp;<span class="ident" id="1408619">c</span><span class="op" id="1408620">.</span><span class="ident" id="1408621">recvq</span><span class="op" id="1408626">.</span><span class="ident" id="1408627">dequeue</span><span class="op" id="1408634">(</span><span class="op" id="1408635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408639">if</span>&nbsp;<span class="ident" id="1408642">sg</span>&nbsp;<span class="op" id="1408645">!=</span>&nbsp;<span class="builtintype" id="1408648">nil</span>&nbsp;<span class="op" id="1408652">{</span>&nbsp;<span class="comment" id="1408654">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408685">if</span>&nbsp;<span class="ident" id="1408688">raceenabled</span>&nbsp;<span class="op" id="1408700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408706">racesync</span><span class="op" id="1408714">(</span><span class="ident" id="1408715">c</span><span class="op" id="1408716">,</span>&nbsp;<span class="ident" id="1408718">sg</span><span class="op" id="1408720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408725">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408730">unlock</span><span class="op" id="1408736">(</span><span class="op" id="1408737">&amp;</span><span class="ident" id="1408738">c</span><span class="op" id="1408739">.</span><span class="ident" id="1408740">lock</span><span class="op" id="1408744">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408750">recvg</span>&nbsp;<span class="op" id="1408756">:=</span>&nbsp;<span class="ident" id="1408759">sg</span><span class="op" id="1408761">.</span><span class="ident" id="1408762">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408767">if</span>&nbsp;<span class="ident" id="1408770">sg</span><span class="op" id="1408772">.</span><span class="ident" id="1408773">elem</span>&nbsp;<span class="op" id="1408778">!=</span>&nbsp;<span class="builtintype" id="1408781">nil</span>&nbsp;<span class="op" id="1408785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408791">memmove</span><span class="op" id="1408798">(</span><span class="ident" id="1408799">unsafe</span><span class="op" id="1408805">.</span><span class="ident" id="1408806">Pointer</span><span class="op" id="1408813">(</span><span class="ident" id="1408814">sg</span><span class="op" id="1408816">.</span><span class="ident" id="1408817">elem</span><span class="op" id="1408821">)</span><span class="op" id="1408822">,</span>&nbsp;<span class="ident" id="1408824">ep</span><span class="op" id="1408826">,</span>&nbsp;<span class="builtintype" id="1408828">uintptr</span><span class="op" id="1408835">(</span><span class="ident" id="1408836">c</span><span class="op" id="1408837">.</span><span class="ident" id="1408838">elemsize</span><span class="op" id="1408846">)</span><span class="op" id="1408847">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408853">sg</span><span class="op" id="1408855">.</span><span class="ident" id="1408856">elem</span>&nbsp;<span class="op" id="1408861">=</span>&nbsp;<span class="builtintype" id="1408863">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408875">recvg</span><span class="op" id="1408880">.</span><span class="ident" id="1408881">param</span>&nbsp;<span class="op" id="1408887">=</span>&nbsp;<span class="ident" id="1408889">unsafe</span><span class="op" id="1408895">.</span><span class="ident" id="1408896">Pointer</span><span class="op" id="1408903">(</span><span class="ident" id="1408904">sg</span><span class="op" id="1408906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408911">if</span>&nbsp;<span class="ident" id="1408914">sg</span><span class="op" id="1408916">.</span><span class="ident" id="1408917">releasetime</span>&nbsp;<span class="op" id="1408929">!=</span>&nbsp;<span class="num" id="1408932">0</span>&nbsp;<span class="op" id="1408934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408940">sg</span><span class="op" id="1408942">.</span><span class="ident" id="1408943">releasetime</span>&nbsp;<span class="op" id="1408955">=</span>&nbsp;<span class="ident" id="1408957">cputicks</span><span class="op" id="1408965">(</span><span class="op" id="1408966">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1408971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1408976">goready</span><span class="op" id="1408983">(</span><span class="ident" id="1408984">recvg</span><span class="op" id="1408989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1408994">return</span>&nbsp;<span class="builtintype" id="1409001">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409013">if</span>&nbsp;<span class="op" id="1409016">!</span><span class="ident" id="1409017">block</span>&nbsp;<span class="op" id="1409023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409028">unlock</span><span class="op" id="1409034">(</span><span class="op" id="1409035">&amp;</span><span class="ident" id="1409036">c</span><span class="op" id="1409037">.</span><span class="ident" id="1409038">lock</span><span class="op" id="1409042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409047">return</span>&nbsp;<span class="builtintype" id="1409054">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409067">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409118">gp</span>&nbsp;<span class="op" id="1409121">:=</span>&nbsp;<span class="ident" id="1409124">getg</span><span class="op" id="1409128">(</span><span class="op" id="1409129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409133">mysg</span>&nbsp;<span class="op" id="1409138">:=</span>&nbsp;<span class="ident" id="1409141">acquireSudog</span><span class="op" id="1409153">(</span><span class="op" id="1409154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409158">mysg</span><span class="op" id="1409162">.</span><span class="ident" id="1409163">releasetime</span>&nbsp;<span class="op" id="1409175">=</span>&nbsp;<span class="num" id="1409177">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409181">if</span>&nbsp;<span class="ident" id="1409184">t0</span>&nbsp;<span class="op" id="1409187">!=</span>&nbsp;<span class="num" id="1409190">0</span>&nbsp;<span class="op" id="1409192">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409197">mysg</span><span class="op" id="1409201">.</span><span class="ident" id="1409202">releasetime</span>&nbsp;<span class="op" id="1409214">=</span>&nbsp;<span class="op" id="1409216">-</span><span class="num" id="1409217">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409225">mysg</span><span class="op" id="1409229">.</span><span class="ident" id="1409230">elem</span>&nbsp;<span class="op" id="1409235">=</span>&nbsp;<span class="ident" id="1409237">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409242">mysg</span><span class="op" id="1409246">.</span><span class="ident" id="1409247">waitlink</span>&nbsp;<span class="op" id="1409256">=</span>&nbsp;<span class="builtintype" id="1409258">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409264">gp</span><span class="op" id="1409266">.</span><span class="ident" id="1409267">waiting</span>&nbsp;<span class="op" id="1409275">=</span>&nbsp;<span class="ident" id="1409277">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409284">mysg</span><span class="op" id="1409288">.</span><span class="ident" id="1409289">g</span>&nbsp;<span class="op" id="1409291">=</span>&nbsp;<span class="ident" id="1409293">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409298">mysg</span><span class="op" id="1409302">.</span><span class="ident" id="1409303">selectdone</span>&nbsp;<span class="op" id="1409314">=</span>&nbsp;<span class="builtintype" id="1409316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409322">gp</span><span class="op" id="1409324">.</span><span class="ident" id="1409325">param</span>&nbsp;<span class="op" id="1409331">=</span>&nbsp;<span class="builtintype" id="1409333">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409339">c</span><span class="op" id="1409340">.</span><span class="ident" id="1409341">sendq</span><span class="op" id="1409346">.</span><span class="ident" id="1409347">enqueue</span><span class="op" id="1409354">(</span><span class="ident" id="1409355">mysg</span><span class="op" id="1409359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409363">goparkunlock</span><span class="op" id="1409375">(</span><span class="op" id="1409376">&amp;</span><span class="ident" id="1409377">c</span><span class="op" id="1409378">.</span><span class="ident" id="1409379">lock</span><span class="op" id="1409383">,</span>&nbsp;<span class="string" id="1409385">&#34;chan&nbsp;send&#34;</span><span class="op" id="1409396">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409401">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409426">if</span>&nbsp;<span class="ident" id="1409429">mysg</span>&nbsp;<span class="op" id="1409434">!=</span>&nbsp;<span class="ident" id="1409437">gp</span><span class="op" id="1409439">.</span><span class="ident" id="1409440">waiting</span>&nbsp;<span class="op" id="1409448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409453">gothrow</span><span class="op" id="1409460">(</span><span class="string" id="1409461">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1409491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409495">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409499">gp</span><span class="op" id="1409501">.</span><span class="ident" id="1409502">waiting</span>&nbsp;<span class="op" id="1409510">=</span>&nbsp;<span class="builtintype" id="1409512">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409518">if</span>&nbsp;<span class="ident" id="1409521">gp</span><span class="op" id="1409523">.</span><span class="ident" id="1409524">param</span>&nbsp;<span class="op" id="1409530">==</span>&nbsp;<span class="builtintype" id="1409533">nil</span>&nbsp;<span class="op" id="1409537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409542">if</span>&nbsp;<span class="ident" id="1409545">c</span><span class="op" id="1409546">.</span><span class="ident" id="1409547">closed</span>&nbsp;<span class="op" id="1409554">==</span>&nbsp;<span class="num" id="1409557">0</span>&nbsp;<span class="op" id="1409559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409565">gothrow</span><span class="op" id="1409572">(</span><span class="string" id="1409573">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1409600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409605">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1409610">panic</span><span class="op" id="1409615">(</span><span class="string" id="1409616">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1409640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409648">gp</span><span class="op" id="1409650">.</span><span class="ident" id="1409651">param</span>&nbsp;<span class="op" id="1409657">=</span>&nbsp;<span class="builtintype" id="1409659">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409665">if</span>&nbsp;<span class="ident" id="1409668">mysg</span><span class="op" id="1409672">.</span><span class="ident" id="1409673">releasetime</span>&nbsp;<span class="op" id="1409685">&gt;</span>&nbsp;<span class="num" id="1409687">0</span>&nbsp;<span class="op" id="1409689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409694">blockevent</span><span class="op" id="1409704">(</span><span class="builtintype" id="1409705">int64</span><span class="op" id="1409710">(</span><span class="ident" id="1409711">mysg</span><span class="op" id="1409715">.</span><span class="ident" id="1409716">releasetime</span><span class="op" id="1409727">)</span><span class="op" id="1409728">-</span><span class="ident" id="1409729">t0</span><span class="op" id="1409731">,</span>&nbsp;<span class="num" id="1409733">2</span><span class="op" id="1409734">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409742">releaseSudog</span><span class="op" id="1409754">(</span><span class="ident" id="1409755">mysg</span><span class="op" id="1409759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409763">return</span>&nbsp;<span class="builtintype" id="1409770">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409780">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1409805">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409847">var</span>&nbsp;<span class="ident" id="1409851">t1</span>&nbsp;<span class="builtintype" id="1409854">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409861">for</span>&nbsp;<span class="ident" id="1409865">c</span><span class="op" id="1409866">.</span><span class="ident" id="1409867">qcount</span>&nbsp;<span class="op" id="1409874">&gt;=</span>&nbsp;<span class="ident" id="1409877">c</span><span class="op" id="1409878">.</span><span class="ident" id="1409879">dataqsiz</span>&nbsp;<span class="op" id="1409888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409892">if</span>&nbsp;<span class="op" id="1409895">!</span><span class="ident" id="1409896">block</span>&nbsp;<span class="op" id="1409902">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409907">unlock</span><span class="op" id="1409913">(</span><span class="op" id="1409914">&amp;</span><span class="ident" id="1409915">c</span><span class="op" id="1409916">.</span><span class="ident" id="1409917">lock</span><span class="op" id="1409921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1409926">return</span>&nbsp;<span class="builtintype" id="1409933">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1409941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409945">gp</span>&nbsp;<span class="op" id="1409948">:=</span>&nbsp;<span class="ident" id="1409951">getg</span><span class="op" id="1409955">(</span><span class="op" id="1409956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409960">mysg</span>&nbsp;<span class="op" id="1409965">:=</span>&nbsp;<span class="ident" id="1409968">acquireSudog</span><span class="op" id="1409980">(</span><span class="op" id="1409981">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1409985">mysg</span><span class="op" id="1409989">.</span><span class="ident" id="1409990">releasetime</span>&nbsp;<span class="op" id="1410002">=</span>&nbsp;<span class="num" id="1410004">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410008">if</span>&nbsp;<span class="ident" id="1410011">t0</span>&nbsp;<span class="op" id="1410014">!=</span>&nbsp;<span class="num" id="1410017">0</span>&nbsp;<span class="op" id="1410019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410024">mysg</span><span class="op" id="1410028">.</span><span class="ident" id="1410029">releasetime</span>&nbsp;<span class="op" id="1410041">=</span>&nbsp;<span class="op" id="1410043">-</span><span class="num" id="1410044">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410052">mysg</span><span class="op" id="1410056">.</span><span class="ident" id="1410057">g</span>&nbsp;<span class="op" id="1410059">=</span>&nbsp;<span class="ident" id="1410061">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410066">mysg</span><span class="op" id="1410070">.</span><span class="ident" id="1410071">elem</span>&nbsp;<span class="op" id="1410076">=</span>&nbsp;<span class="builtintype" id="1410078">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410084">mysg</span><span class="op" id="1410088">.</span><span class="ident" id="1410089">selectdone</span>&nbsp;<span class="op" id="1410100">=</span>&nbsp;<span class="builtintype" id="1410102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410108">c</span><span class="op" id="1410109">.</span><span class="ident" id="1410110">sendq</span><span class="op" id="1410115">.</span><span class="ident" id="1410116">enqueue</span><span class="op" id="1410123">(</span><span class="ident" id="1410124">mysg</span><span class="op" id="1410128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410132">goparkunlock</span><span class="op" id="1410144">(</span><span class="op" id="1410145">&amp;</span><span class="ident" id="1410146">c</span><span class="op" id="1410147">.</span><span class="ident" id="1410148">lock</span><span class="op" id="1410152">,</span>&nbsp;<span class="string" id="1410154">&#34;chan&nbsp;send&#34;</span><span class="op" id="1410165">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410170">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410206">if</span>&nbsp;<span class="ident" id="1410209">mysg</span><span class="op" id="1410213">.</span><span class="ident" id="1410214">releasetime</span>&nbsp;<span class="op" id="1410226">&gt;</span>&nbsp;<span class="num" id="1410228">0</span>&nbsp;<span class="op" id="1410230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410235">t1</span>&nbsp;<span class="op" id="1410238">=</span>&nbsp;<span class="ident" id="1410240">mysg</span><span class="op" id="1410244">.</span><span class="ident" id="1410245">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410263">releaseSudog</span><span class="op" id="1410275">(</span><span class="ident" id="1410276">mysg</span><span class="op" id="1410280">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410284">lock</span><span class="op" id="1410288">(</span><span class="op" id="1410289">&amp;</span><span class="ident" id="1410290">c</span><span class="op" id="1410291">.</span><span class="ident" id="1410292">lock</span><span class="op" id="1410296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410300">if</span>&nbsp;<span class="ident" id="1410303">c</span><span class="op" id="1410304">.</span><span class="ident" id="1410305">closed</span>&nbsp;<span class="op" id="1410312">!=</span>&nbsp;<span class="num" id="1410315">0</span>&nbsp;<span class="op" id="1410317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410322">unlock</span><span class="op" id="1410328">(</span><span class="op" id="1410329">&amp;</span><span class="ident" id="1410330">c</span><span class="op" id="1410331">.</span><span class="ident" id="1410332">lock</span><span class="op" id="1410336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1410341">panic</span><span class="op" id="1410346">(</span><span class="string" id="1410347">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1410371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410375">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410382">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410425">if</span>&nbsp;<span class="ident" id="1410428">raceenabled</span>&nbsp;<span class="op" id="1410440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410444">raceacquire</span><span class="op" id="1410455">(</span><span class="ident" id="1410456">chanbuf</span><span class="op" id="1410463">(</span><span class="ident" id="1410464">c</span><span class="op" id="1410465">,</span>&nbsp;<span class="ident" id="1410467">c</span><span class="op" id="1410468">.</span><span class="ident" id="1410469">sendx</span><span class="op" id="1410474">)</span><span class="op" id="1410475">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410479">racerelease</span><span class="op" id="1410490">(</span><span class="ident" id="1410491">chanbuf</span><span class="op" id="1410498">(</span><span class="ident" id="1410499">c</span><span class="op" id="1410500">,</span>&nbsp;<span class="ident" id="1410502">c</span><span class="op" id="1410503">.</span><span class="ident" id="1410504">sendx</span><span class="op" id="1410509">)</span><span class="op" id="1410510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410516">memmove</span><span class="op" id="1410523">(</span><span class="ident" id="1410524">chanbuf</span><span class="op" id="1410531">(</span><span class="ident" id="1410532">c</span><span class="op" id="1410533">,</span>&nbsp;<span class="ident" id="1410535">c</span><span class="op" id="1410536">.</span><span class="ident" id="1410537">sendx</span><span class="op" id="1410542">)</span><span class="op" id="1410543">,</span>&nbsp;<span class="ident" id="1410545">ep</span><span class="op" id="1410547">,</span>&nbsp;<span class="builtintype" id="1410549">uintptr</span><span class="op" id="1410556">(</span><span class="ident" id="1410557">c</span><span class="op" id="1410558">.</span><span class="ident" id="1410559">elemsize</span><span class="op" id="1410567">)</span><span class="op" id="1410568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410571">c</span><span class="op" id="1410572">.</span><span class="ident" id="1410573">sendx</span><span class="op" id="1410578">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410582">if</span>&nbsp;<span class="ident" id="1410585">c</span><span class="op" id="1410586">.</span><span class="ident" id="1410587">sendx</span>&nbsp;<span class="op" id="1410593">==</span>&nbsp;<span class="ident" id="1410596">c</span><span class="op" id="1410597">.</span><span class="ident" id="1410598">dataqsiz</span>&nbsp;<span class="op" id="1410607">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410611">c</span><span class="op" id="1410612">.</span><span class="ident" id="1410613">sendx</span>&nbsp;<span class="op" id="1410619">=</span>&nbsp;<span class="num" id="1410621">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410627">c</span><span class="op" id="1410628">.</span><span class="ident" id="1410629">qcount</span><span class="op" id="1410635">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1410640">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410671">sg</span>&nbsp;<span class="op" id="1410674">:=</span>&nbsp;<span class="ident" id="1410677">c</span><span class="op" id="1410678">.</span><span class="ident" id="1410679">recvq</span><span class="op" id="1410684">.</span><span class="ident" id="1410685">dequeue</span><span class="op" id="1410692">(</span><span class="op" id="1410693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410696">if</span>&nbsp;<span class="ident" id="1410699">sg</span>&nbsp;<span class="op" id="1410702">!=</span>&nbsp;<span class="builtintype" id="1410705">nil</span>&nbsp;<span class="op" id="1410709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410713">recvg</span>&nbsp;<span class="op" id="1410719">:=</span>&nbsp;<span class="ident" id="1410722">sg</span><span class="op" id="1410724">.</span><span class="ident" id="1410725">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410729">unlock</span><span class="op" id="1410735">(</span><span class="op" id="1410736">&amp;</span><span class="ident" id="1410737">c</span><span class="op" id="1410738">.</span><span class="ident" id="1410739">lock</span><span class="op" id="1410743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410747">if</span>&nbsp;<span class="ident" id="1410750">sg</span><span class="op" id="1410752">.</span><span class="ident" id="1410753">releasetime</span>&nbsp;<span class="op" id="1410765">!=</span>&nbsp;<span class="num" id="1410768">0</span>&nbsp;<span class="op" id="1410770">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410775">sg</span><span class="op" id="1410777">.</span><span class="ident" id="1410778">releasetime</span>&nbsp;<span class="op" id="1410790">=</span>&nbsp;<span class="ident" id="1410792">cputicks</span><span class="op" id="1410800">(</span><span class="op" id="1410801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410809">goready</span><span class="op" id="1410816">(</span><span class="ident" id="1410817">recvg</span><span class="op" id="1410822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410825">}</span>&nbsp;<span class="keyword" id="1410827">else</span>&nbsp;<span class="op" id="1410832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410836">unlock</span><span class="op" id="1410842">(</span><span class="op" id="1410843">&amp;</span><span class="ident" id="1410844">c</span><span class="op" id="1410845">.</span><span class="ident" id="1410846">lock</span><span class="op" id="1410850">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410856">if</span>&nbsp;<span class="ident" id="1410859">t1</span>&nbsp;<span class="op" id="1410862">&gt;</span>&nbsp;<span class="num" id="1410864">0</span>&nbsp;<span class="op" id="1410866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410870">blockevent</span><span class="op" id="1410880">(</span><span class="ident" id="1410881">t1</span><span class="op" id="1410883">-</span><span class="ident" id="1410884">t0</span><span class="op" id="1410886">,</span>&nbsp;<span class="num" id="1410888">2</span><span class="op" id="1410889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410895">return</span>&nbsp;<span class="builtintype" id="1410902">true</span><br>
<span class="lineno">255</span><span class="op" id="1410907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1410910">func</span>&nbsp;<span class="ident" id="1410915">closechan</span><span class="op" id="1410924">(</span><span class="ident" id="1410925">c</span>&nbsp;<span class="op" id="1410927">*</span><span class="ident" id="1410928">hchan</span><span class="op" id="1410933">)</span>&nbsp;<span class="op" id="1410935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1410938">if</span>&nbsp;<span class="ident" id="1410941">c</span>&nbsp;<span class="op" id="1410943">==</span>&nbsp;<span class="builtintype" id="1410946">nil</span>&nbsp;<span class="op" id="1410950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1410954">panic</span><span class="op" id="1410959">(</span><span class="string" id="1410960">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1410982">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1410985">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1410989">lock</span><span class="op" id="1410993">(</span><span class="op" id="1410994">&amp;</span><span class="ident" id="1410995">c</span><span class="op" id="1410996">.</span><span class="ident" id="1410997">lock</span><span class="op" id="1411001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411004">if</span>&nbsp;<span class="ident" id="1411007">c</span><span class="op" id="1411008">.</span><span class="ident" id="1411009">closed</span>&nbsp;<span class="op" id="1411016">!=</span>&nbsp;<span class="num" id="1411019">0</span>&nbsp;<span class="op" id="1411021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411025">unlock</span><span class="op" id="1411031">(</span><span class="op" id="1411032">&amp;</span><span class="ident" id="1411033">c</span><span class="op" id="1411034">.</span><span class="ident" id="1411035">lock</span><span class="op" id="1411039">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1411043">panic</span><span class="op" id="1411048">(</span><span class="string" id="1411049">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1411074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411077">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411081">if</span>&nbsp;<span class="ident" id="1411084">raceenabled</span>&nbsp;<span class="op" id="1411096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411100">callerpc</span>&nbsp;<span class="op" id="1411109">:=</span>&nbsp;<span class="ident" id="1411112">getcallerpc</span><span class="op" id="1411123">(</span><span class="ident" id="1411124">unsafe</span><span class="op" id="1411130">.</span><span class="ident" id="1411131">Pointer</span><span class="op" id="1411138">(</span><span class="op" id="1411139">&amp;</span><span class="ident" id="1411140">c</span><span class="op" id="1411141">)</span><span class="op" id="1411142">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411146">racewritepc</span><span class="op" id="1411157">(</span><span class="ident" id="1411158">unsafe</span><span class="op" id="1411164">.</span><span class="ident" id="1411165">Pointer</span><span class="op" id="1411172">(</span><span class="ident" id="1411173">c</span><span class="op" id="1411174">)</span><span class="op" id="1411175">,</span>&nbsp;<span class="ident" id="1411177">callerpc</span><span class="op" id="1411185">,</span>&nbsp;<span class="ident" id="1411187">funcPC</span><span class="op" id="1411193">(</span><span class="ident" id="1411194">closechan</span><span class="op" id="1411203">)</span><span class="op" id="1411204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411208">racerelease</span><span class="op" id="1411219">(</span><span class="ident" id="1411220">unsafe</span><span class="op" id="1411226">.</span><span class="ident" id="1411227">Pointer</span><span class="op" id="1411234">(</span><span class="ident" id="1411235">c</span><span class="op" id="1411236">)</span><span class="op" id="1411237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411244">c</span><span class="op" id="1411245">.</span><span class="ident" id="1411246">closed</span>&nbsp;<span class="op" id="1411253">=</span>&nbsp;<span class="num" id="1411255">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411259">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411283">for</span>&nbsp;<span class="op" id="1411287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411291">sg</span>&nbsp;<span class="op" id="1411294">:=</span>&nbsp;<span class="ident" id="1411297">c</span><span class="op" id="1411298">.</span><span class="ident" id="1411299">recvq</span><span class="op" id="1411304">.</span><span class="ident" id="1411305">dequeue</span><span class="op" id="1411312">(</span><span class="op" id="1411313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411317">if</span>&nbsp;<span class="ident" id="1411320">sg</span>&nbsp;<span class="op" id="1411323">==</span>&nbsp;<span class="builtintype" id="1411326">nil</span>&nbsp;<span class="op" id="1411330">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411335">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411347">gp</span>&nbsp;<span class="op" id="1411350">:=</span>&nbsp;<span class="ident" id="1411353">sg</span><span class="op" id="1411355">.</span><span class="ident" id="1411356">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411360">sg</span><span class="op" id="1411362">.</span><span class="ident" id="1411363">elem</span>&nbsp;<span class="op" id="1411368">=</span>&nbsp;<span class="builtintype" id="1411370">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411376">gp</span><span class="op" id="1411378">.</span><span class="ident" id="1411379">param</span>&nbsp;<span class="op" id="1411385">=</span>&nbsp;<span class="builtintype" id="1411387">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411393">if</span>&nbsp;<span class="ident" id="1411396">sg</span><span class="op" id="1411398">.</span><span class="ident" id="1411399">releasetime</span>&nbsp;<span class="op" id="1411411">!=</span>&nbsp;<span class="num" id="1411414">0</span>&nbsp;<span class="op" id="1411416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411421">sg</span><span class="op" id="1411423">.</span><span class="ident" id="1411424">releasetime</span>&nbsp;<span class="op" id="1411436">=</span>&nbsp;<span class="ident" id="1411438">cputicks</span><span class="op" id="1411446">(</span><span class="op" id="1411447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411455">goready</span><span class="op" id="1411462">(</span><span class="ident" id="1411463">gp</span><span class="op" id="1411465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411468">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1411472">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411496">for</span>&nbsp;<span class="op" id="1411500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411504">sg</span>&nbsp;<span class="op" id="1411507">:=</span>&nbsp;<span class="ident" id="1411510">c</span><span class="op" id="1411511">.</span><span class="ident" id="1411512">sendq</span><span class="op" id="1411517">.</span><span class="ident" id="1411518">dequeue</span><span class="op" id="1411525">(</span><span class="op" id="1411526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411530">if</span>&nbsp;<span class="ident" id="1411533">sg</span>&nbsp;<span class="op" id="1411536">==</span>&nbsp;<span class="builtintype" id="1411539">nil</span>&nbsp;<span class="op" id="1411543">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411548">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411560">gp</span>&nbsp;<span class="op" id="1411563">:=</span>&nbsp;<span class="ident" id="1411566">sg</span><span class="op" id="1411568">.</span><span class="ident" id="1411569">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411573">sg</span><span class="op" id="1411575">.</span><span class="ident" id="1411576">elem</span>&nbsp;<span class="op" id="1411581">=</span>&nbsp;<span class="builtintype" id="1411583">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411589">gp</span><span class="op" id="1411591">.</span><span class="ident" id="1411592">param</span>&nbsp;<span class="op" id="1411598">=</span>&nbsp;<span class="builtintype" id="1411600">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411606">if</span>&nbsp;<span class="ident" id="1411609">sg</span><span class="op" id="1411611">.</span><span class="ident" id="1411612">releasetime</span>&nbsp;<span class="op" id="1411624">!=</span>&nbsp;<span class="num" id="1411627">0</span>&nbsp;<span class="op" id="1411629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411634">sg</span><span class="op" id="1411636">.</span><span class="ident" id="1411637">releasetime</span>&nbsp;<span class="op" id="1411649">=</span>&nbsp;<span class="ident" id="1411651">cputicks</span><span class="op" id="1411659">(</span><span class="op" id="1411660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411668">goready</span><span class="op" id="1411675">(</span><span class="ident" id="1411676">gp</span><span class="op" id="1411678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1411681">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411684">unlock</span><span class="op" id="1411690">(</span><span class="op" id="1411691">&amp;</span><span class="ident" id="1411692">c</span><span class="op" id="1411693">.</span><span class="ident" id="1411694">lock</span><span class="op" id="1411698">)</span><br>
<span class="lineno"></span><span class="op" id="1411700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1411703">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1411747">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1411760">func</span>&nbsp;<span class="ident" id="1411765">chanrecv1</span><span class="op" id="1411774">(</span><span class="ident" id="1411775">t</span>&nbsp;<span class="op" id="1411777">*</span><span class="ident" id="1411778">chantype</span><span class="op" id="1411786">,</span>&nbsp;<span class="ident" id="1411788">c</span>&nbsp;<span class="op" id="1411790">*</span><span class="ident" id="1411791">hchan</span><span class="op" id="1411796">,</span>&nbsp;<span class="ident" id="1411798">elem</span>&nbsp;<span class="ident" id="1411803">unsafe</span><span class="op" id="1411809">.</span><span class="ident" id="1411810">Pointer</span><span class="op" id="1411817">)</span>&nbsp;<span class="op" id="1411819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411822">chanrecv</span><span class="op" id="1411830">(</span><span class="ident" id="1411831">t</span><span class="op" id="1411832">,</span>&nbsp;<span class="ident" id="1411834">c</span><span class="op" id="1411835">,</span>&nbsp;<span class="ident" id="1411837">elem</span><span class="op" id="1411841">,</span>&nbsp;<span class="builtintype" id="1411843">true</span><span class="op" id="1411847">)</span><br>
<span class="lineno"></span><span class="op" id="1411849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1411852">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1411865">func</span>&nbsp;<span class="ident" id="1411870">chanrecv2</span><span class="op" id="1411879">(</span><span class="ident" id="1411880">t</span>&nbsp;<span class="op" id="1411882">*</span><span class="ident" id="1411883">chantype</span><span class="op" id="1411891">,</span>&nbsp;<span class="ident" id="1411893">c</span>&nbsp;<span class="op" id="1411895">*</span><span class="ident" id="1411896">hchan</span><span class="op" id="1411901">,</span>&nbsp;<span class="ident" id="1411903">elem</span>&nbsp;<span class="ident" id="1411908">unsafe</span><span class="op" id="1411914">.</span><span class="ident" id="1411915">Pointer</span><span class="op" id="1411922">)</span>&nbsp;<span class="op" id="1411924">(</span><span class="ident" id="1411925">received</span>&nbsp;<span class="builtintype" id="1411934">bool</span><span class="op" id="1411938">)</span>&nbsp;<span class="op" id="1411940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1411943">_</span><span class="op" id="1411944">,</span>&nbsp;<span class="ident" id="1411946">received</span>&nbsp;<span class="op" id="1411955">=</span>&nbsp;<span class="ident" id="1411957">chanrecv</span><span class="op" id="1411965">(</span><span class="ident" id="1411966">t</span><span class="op" id="1411967">,</span>&nbsp;<span class="ident" id="1411969">c</span><span class="op" id="1411970">,</span>&nbsp;<span class="ident" id="1411972">elem</span><span class="op" id="1411976">,</span>&nbsp;<span class="builtintype" id="1411978">true</span><span class="op" id="1411982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1411985">return</span><br>
<span class="lineno"></span><span class="op" id="1411992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1411995">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1412065">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1412123">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1412199">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1412266">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1412335">func</span>&nbsp;<span class="ident" id="1412340">chanrecv</span><span class="op" id="1412348">(</span><span class="ident" id="1412349">t</span>&nbsp;<span class="op" id="1412351">*</span><span class="ident" id="1412352">chantype</span><span class="op" id="1412360">,</span>&nbsp;<span class="ident" id="1412362">c</span>&nbsp;<span class="op" id="1412364">*</span><span class="ident" id="1412365">hchan</span><span class="op" id="1412370">,</span>&nbsp;<span class="ident" id="1412372">ep</span>&nbsp;<span class="ident" id="1412375">unsafe</span><span class="op" id="1412381">.</span><span class="ident" id="1412382">Pointer</span><span class="op" id="1412389">,</span>&nbsp;<span class="ident" id="1412391">block</span>&nbsp;<span class="builtintype" id="1412397">bool</span><span class="op" id="1412401">)</span>&nbsp;<span class="op" id="1412403">(</span><span class="ident" id="1412404">selected</span><span class="op" id="1412412">,</span>&nbsp;<span class="ident" id="1412414">received</span>&nbsp;<span class="builtintype" id="1412423">bool</span><span class="op" id="1412427">)</span>&nbsp;<span class="op" id="1412429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412432">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412504">if</span>&nbsp;<span class="ident" id="1412507">debugChan</span>&nbsp;<span class="op" id="1412517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1412521">print</span><span class="op" id="1412526">(</span><span class="string" id="1412527">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1412544">,</span>&nbsp;<span class="ident" id="1412546">c</span><span class="op" id="1412547">,</span>&nbsp;<span class="string" id="1412549">&#34;\n&#34;</span><span class="op" id="1412553">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412560">if</span>&nbsp;<span class="ident" id="1412563">c</span>&nbsp;<span class="op" id="1412565">==</span>&nbsp;<span class="builtintype" id="1412568">nil</span>&nbsp;<span class="op" id="1412572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412576">if</span>&nbsp;<span class="op" id="1412579">!</span><span class="ident" id="1412580">block</span>&nbsp;<span class="op" id="1412586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1412591">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412604">gopark</span><span class="op" id="1412610">(</span><span class="builtintype" id="1412611">nil</span><span class="op" id="1412614">,</span>&nbsp;<span class="builtintype" id="1412616">nil</span><span class="op" id="1412619">,</span>&nbsp;<span class="string" id="1412621">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1412646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1412650">gothrow</span><span class="op" id="1412657">(</span><span class="string" id="1412658">&#34;unreachable&#34;</span><span class="op" id="1412671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1412674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412678">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412761">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412765">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412850">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412932">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1412992">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413071">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413149">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413227">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413275">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413279">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1413363">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413412">if</span>&nbsp;<span class="op" id="1413415">!</span><span class="ident" id="1413416">block</span>&nbsp;<span class="op" id="1413422">&amp;&amp;</span>&nbsp;<span class="op" id="1413425">(</span><span class="ident" id="1413426">c</span><span class="op" id="1413427">.</span><span class="ident" id="1413428">dataqsiz</span>&nbsp;<span class="op" id="1413437">==</span>&nbsp;<span class="num" id="1413440">0</span>&nbsp;<span class="op" id="1413442">&amp;&amp;</span>&nbsp;<span class="ident" id="1413445">c</span><span class="op" id="1413446">.</span><span class="ident" id="1413447">sendq</span><span class="op" id="1413452">.</span><span class="ident" id="1413453">first</span>&nbsp;<span class="op" id="1413459">==</span>&nbsp;<span class="builtintype" id="1413462">nil</span>&nbsp;<span class="op" id="1413466">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413471">c</span><span class="op" id="1413472">.</span><span class="ident" id="1413473">dataqsiz</span>&nbsp;<span class="op" id="1413482">&gt;</span>&nbsp;<span class="num" id="1413484">0</span>&nbsp;<span class="op" id="1413486">&amp;&amp;</span>&nbsp;<span class="ident" id="1413489">atomicloaduint</span><span class="op" id="1413503">(</span><span class="op" id="1413504">&amp;</span><span class="ident" id="1413505">c</span><span class="op" id="1413506">.</span><span class="ident" id="1413507">qcount</span><span class="op" id="1413513">)</span>&nbsp;<span class="op" id="1413515">==</span>&nbsp;<span class="num" id="1413518">0</span><span class="op" id="1413519">)</span>&nbsp;<span class="op" id="1413521">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413526">atomicload</span><span class="op" id="1413536">(</span><span class="op" id="1413537">&amp;</span><span class="ident" id="1413538">c</span><span class="op" id="1413539">.</span><span class="ident" id="1413540">closed</span><span class="op" id="1413546">)</span>&nbsp;<span class="op" id="1413548">==</span>&nbsp;<span class="num" id="1413551">0</span>&nbsp;<span class="op" id="1413553">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413557">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1413565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413569">var</span>&nbsp;<span class="ident" id="1413573">t0</span>&nbsp;<span class="builtintype" id="1413576">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413583">if</span>&nbsp;<span class="ident" id="1413586">blockprofilerate</span>&nbsp;<span class="op" id="1413603">&gt;</span>&nbsp;<span class="num" id="1413605">0</span>&nbsp;<span class="op" id="1413607">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413611">t0</span>&nbsp;<span class="op" id="1413614">=</span>&nbsp;<span class="ident" id="1413616">cputicks</span><span class="op" id="1413624">(</span><span class="op" id="1413625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1413628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413632">lock</span><span class="op" id="1413636">(</span><span class="op" id="1413637">&amp;</span><span class="ident" id="1413638">c</span><span class="op" id="1413639">.</span><span class="ident" id="1413640">lock</span><span class="op" id="1413644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413647">if</span>&nbsp;<span class="ident" id="1413650">c</span><span class="op" id="1413651">.</span><span class="ident" id="1413652">dataqsiz</span>&nbsp;<span class="op" id="1413661">==</span>&nbsp;<span class="num" id="1413664">0</span>&nbsp;<span class="op" id="1413666">{</span>&nbsp;<span class="comment" id="1413668">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413693">if</span>&nbsp;<span class="ident" id="1413696">c</span><span class="op" id="1413697">.</span><span class="ident" id="1413698">closed</span>&nbsp;<span class="op" id="1413705">!=</span>&nbsp;<span class="num" id="1413708">0</span>&nbsp;<span class="op" id="1413710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413715">return</span>&nbsp;<span class="ident" id="1413722">recvclosed</span><span class="op" id="1413732">(</span><span class="ident" id="1413733">c</span><span class="op" id="1413734">,</span>&nbsp;<span class="ident" id="1413736">ep</span><span class="op" id="1413738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1413742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413747">sg</span>&nbsp;<span class="op" id="1413750">:=</span>&nbsp;<span class="ident" id="1413753">c</span><span class="op" id="1413754">.</span><span class="ident" id="1413755">sendq</span><span class="op" id="1413760">.</span><span class="ident" id="1413761">dequeue</span><span class="op" id="1413768">(</span><span class="op" id="1413769">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413773">if</span>&nbsp;<span class="ident" id="1413776">sg</span>&nbsp;<span class="op" id="1413779">!=</span>&nbsp;<span class="builtintype" id="1413782">nil</span>&nbsp;<span class="op" id="1413786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413791">if</span>&nbsp;<span class="ident" id="1413794">raceenabled</span>&nbsp;<span class="op" id="1413806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413812">racesync</span><span class="op" id="1413820">(</span><span class="ident" id="1413821">c</span><span class="op" id="1413822">,</span>&nbsp;<span class="ident" id="1413824">sg</span><span class="op" id="1413826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1413831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413836">unlock</span><span class="op" id="1413842">(</span><span class="op" id="1413843">&amp;</span><span class="ident" id="1413844">c</span><span class="op" id="1413845">.</span><span class="ident" id="1413846">lock</span><span class="op" id="1413850">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413856">if</span>&nbsp;<span class="ident" id="1413859">ep</span>&nbsp;<span class="op" id="1413862">!=</span>&nbsp;<span class="builtintype" id="1413865">nil</span>&nbsp;<span class="op" id="1413869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413875">memmove</span><span class="op" id="1413882">(</span><span class="ident" id="1413883">ep</span><span class="op" id="1413885">,</span>&nbsp;<span class="ident" id="1413887">sg</span><span class="op" id="1413889">.</span><span class="ident" id="1413890">elem</span><span class="op" id="1413894">,</span>&nbsp;<span class="builtintype" id="1413896">uintptr</span><span class="op" id="1413903">(</span><span class="ident" id="1413904">c</span><span class="op" id="1413905">.</span><span class="ident" id="1413906">elemsize</span><span class="op" id="1413914">)</span><span class="op" id="1413915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1413920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413925">sg</span><span class="op" id="1413927">.</span><span class="ident" id="1413928">elem</span>&nbsp;<span class="op" id="1413933">=</span>&nbsp;<span class="builtintype" id="1413935">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413942">gp</span>&nbsp;<span class="op" id="1413945">:=</span>&nbsp;<span class="ident" id="1413948">sg</span><span class="op" id="1413950">.</span><span class="ident" id="1413951">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1413956">gp</span><span class="op" id="1413958">.</span><span class="ident" id="1413959">param</span>&nbsp;<span class="op" id="1413965">=</span>&nbsp;<span class="ident" id="1413967">unsafe</span><span class="op" id="1413973">.</span><span class="ident" id="1413974">Pointer</span><span class="op" id="1413981">(</span><span class="ident" id="1413982">sg</span><span class="op" id="1413984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1413989">if</span>&nbsp;<span class="ident" id="1413992">sg</span><span class="op" id="1413994">.</span><span class="ident" id="1413995">releasetime</span>&nbsp;<span class="op" id="1414007">!=</span>&nbsp;<span class="num" id="1414010">0</span>&nbsp;<span class="op" id="1414012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414018">sg</span><span class="op" id="1414020">.</span><span class="ident" id="1414021">releasetime</span>&nbsp;<span class="op" id="1414033">=</span>&nbsp;<span class="ident" id="1414035">cputicks</span><span class="op" id="1414043">(</span><span class="op" id="1414044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414049">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414054">goready</span><span class="op" id="1414061">(</span><span class="ident" id="1414062">gp</span><span class="op" id="1414064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414069">selected</span>&nbsp;<span class="op" id="1414078">=</span>&nbsp;<span class="builtintype" id="1414080">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414088">received</span>&nbsp;<span class="op" id="1414097">=</span>&nbsp;<span class="builtintype" id="1414099">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414107">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414116">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414121">if</span>&nbsp;<span class="op" id="1414124">!</span><span class="ident" id="1414125">block</span>&nbsp;<span class="op" id="1414131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414136">unlock</span><span class="op" id="1414142">(</span><span class="op" id="1414143">&amp;</span><span class="ident" id="1414144">c</span><span class="op" id="1414145">.</span><span class="ident" id="1414146">lock</span><span class="op" id="1414150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414155">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414164">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414169">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414218">gp</span>&nbsp;<span class="op" id="1414221">:=</span>&nbsp;<span class="ident" id="1414224">getg</span><span class="op" id="1414228">(</span><span class="op" id="1414229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414233">mysg</span>&nbsp;<span class="op" id="1414238">:=</span>&nbsp;<span class="ident" id="1414241">acquireSudog</span><span class="op" id="1414253">(</span><span class="op" id="1414254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414258">mysg</span><span class="op" id="1414262">.</span><span class="ident" id="1414263">releasetime</span>&nbsp;<span class="op" id="1414275">=</span>&nbsp;<span class="num" id="1414277">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414281">if</span>&nbsp;<span class="ident" id="1414284">t0</span>&nbsp;<span class="op" id="1414287">!=</span>&nbsp;<span class="num" id="1414290">0</span>&nbsp;<span class="op" id="1414292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414297">mysg</span><span class="op" id="1414301">.</span><span class="ident" id="1414302">releasetime</span>&nbsp;<span class="op" id="1414314">=</span>&nbsp;<span class="op" id="1414316">-</span><span class="num" id="1414317">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414325">mysg</span><span class="op" id="1414329">.</span><span class="ident" id="1414330">elem</span>&nbsp;<span class="op" id="1414335">=</span>&nbsp;<span class="ident" id="1414337">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414342">mysg</span><span class="op" id="1414346">.</span><span class="ident" id="1414347">waitlink</span>&nbsp;<span class="op" id="1414356">=</span>&nbsp;<span class="builtintype" id="1414358">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414364">gp</span><span class="op" id="1414366">.</span><span class="ident" id="1414367">waiting</span>&nbsp;<span class="op" id="1414375">=</span>&nbsp;<span class="ident" id="1414377">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414384">mysg</span><span class="op" id="1414388">.</span><span class="ident" id="1414389">g</span>&nbsp;<span class="op" id="1414391">=</span>&nbsp;<span class="ident" id="1414393">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414398">mysg</span><span class="op" id="1414402">.</span><span class="ident" id="1414403">selectdone</span>&nbsp;<span class="op" id="1414414">=</span>&nbsp;<span class="builtintype" id="1414416">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414422">gp</span><span class="op" id="1414424">.</span><span class="ident" id="1414425">param</span>&nbsp;<span class="op" id="1414431">=</span>&nbsp;<span class="builtintype" id="1414433">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414439">c</span><span class="op" id="1414440">.</span><span class="ident" id="1414441">recvq</span><span class="op" id="1414446">.</span><span class="ident" id="1414447">enqueue</span><span class="op" id="1414454">(</span><span class="ident" id="1414455">mysg</span><span class="op" id="1414459">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414463">goparkunlock</span><span class="op" id="1414475">(</span><span class="op" id="1414476">&amp;</span><span class="ident" id="1414477">c</span><span class="op" id="1414478">.</span><span class="ident" id="1414479">lock</span><span class="op" id="1414483">,</span>&nbsp;<span class="string" id="1414485">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1414499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414504">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414528">if</span>&nbsp;<span class="ident" id="1414531">mysg</span>&nbsp;<span class="op" id="1414536">!=</span>&nbsp;<span class="ident" id="1414539">gp</span><span class="op" id="1414541">.</span><span class="ident" id="1414542">waiting</span>&nbsp;<span class="op" id="1414550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414555">gothrow</span><span class="op" id="1414562">(</span><span class="string" id="1414563">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1414593">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414601">gp</span><span class="op" id="1414603">.</span><span class="ident" id="1414604">waiting</span>&nbsp;<span class="op" id="1414612">=</span>&nbsp;<span class="builtintype" id="1414614">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414620">if</span>&nbsp;<span class="ident" id="1414623">mysg</span><span class="op" id="1414627">.</span><span class="ident" id="1414628">releasetime</span>&nbsp;<span class="op" id="1414640">&gt;</span>&nbsp;<span class="num" id="1414642">0</span>&nbsp;<span class="op" id="1414644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414649">blockevent</span><span class="op" id="1414659">(</span><span class="ident" id="1414660">mysg</span><span class="op" id="1414664">.</span><span class="ident" id="1414665">releasetime</span><span class="op" id="1414676">-</span><span class="ident" id="1414677">t0</span><span class="op" id="1414679">,</span>&nbsp;<span class="num" id="1414681">2</span><span class="op" id="1414682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414686">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414690">haveData</span>&nbsp;<span class="op" id="1414699">:=</span>&nbsp;<span class="ident" id="1414702">gp</span><span class="op" id="1414704">.</span><span class="ident" id="1414705">param</span>&nbsp;<span class="op" id="1414711">!=</span>&nbsp;<span class="builtintype" id="1414714">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414720">gp</span><span class="op" id="1414722">.</span><span class="ident" id="1414723">param</span>&nbsp;<span class="op" id="1414729">=</span>&nbsp;<span class="builtintype" id="1414731">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414737">releaseSudog</span><span class="op" id="1414749">(</span><span class="ident" id="1414750">mysg</span><span class="op" id="1414754">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414759">if</span>&nbsp;<span class="ident" id="1414762">haveData</span>&nbsp;<span class="op" id="1414771">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414776">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414834">selected</span>&nbsp;<span class="op" id="1414843">=</span>&nbsp;<span class="builtintype" id="1414845">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414853">received</span>&nbsp;<span class="op" id="1414862">=</span>&nbsp;<span class="builtintype" id="1414864">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414872">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414881">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414886">lock</span><span class="op" id="1414890">(</span><span class="op" id="1414891">&amp;</span><span class="ident" id="1414892">c</span><span class="op" id="1414893">.</span><span class="ident" id="1414894">lock</span><span class="op" id="1414898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414902">if</span>&nbsp;<span class="ident" id="1414905">c</span><span class="op" id="1414906">.</span><span class="ident" id="1414907">closed</span>&nbsp;<span class="op" id="1414914">==</span>&nbsp;<span class="num" id="1414917">0</span>&nbsp;<span class="op" id="1414919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414924">gothrow</span><span class="op" id="1414931">(</span><span class="string" id="1414932">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1414959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414963">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414967">return</span>&nbsp;<span class="ident" id="1414974">recvclosed</span><span class="op" id="1414984">(</span><span class="ident" id="1414985">c</span><span class="op" id="1414986">,</span>&nbsp;<span class="ident" id="1414988">ep</span><span class="op" id="1414990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414997">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415022">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415055">var</span>&nbsp;<span class="ident" id="1415059">t1</span>&nbsp;<span class="builtintype" id="1415062">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415069">for</span>&nbsp;<span class="ident" id="1415073">c</span><span class="op" id="1415074">.</span><span class="ident" id="1415075">qcount</span>&nbsp;<span class="op" id="1415082">&lt;=</span>&nbsp;<span class="num" id="1415085">0</span>&nbsp;<span class="op" id="1415087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415091">if</span>&nbsp;<span class="ident" id="1415094">c</span><span class="op" id="1415095">.</span><span class="ident" id="1415096">closed</span>&nbsp;<span class="op" id="1415103">!=</span>&nbsp;<span class="num" id="1415106">0</span>&nbsp;<span class="op" id="1415108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415113">selected</span><span class="op" id="1415121">,</span>&nbsp;<span class="ident" id="1415123">received</span>&nbsp;<span class="op" id="1415132">=</span>&nbsp;<span class="ident" id="1415134">recvclosed</span><span class="op" id="1415144">(</span><span class="ident" id="1415145">c</span><span class="op" id="1415146">,</span>&nbsp;<span class="ident" id="1415148">ep</span><span class="op" id="1415150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415155">if</span>&nbsp;<span class="ident" id="1415158">t1</span>&nbsp;<span class="op" id="1415161">&gt;</span>&nbsp;<span class="num" id="1415163">0</span>&nbsp;<span class="op" id="1415165">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415171">blockevent</span><span class="op" id="1415181">(</span><span class="ident" id="1415182">t1</span><span class="op" id="1415184">-</span><span class="ident" id="1415185">t0</span><span class="op" id="1415187">,</span>&nbsp;<span class="num" id="1415189">2</span><span class="op" id="1415190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415195">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415200">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415214">if</span>&nbsp;<span class="op" id="1415217">!</span><span class="ident" id="1415218">block</span>&nbsp;<span class="op" id="1415224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415229">unlock</span><span class="op" id="1415235">(</span><span class="op" id="1415236">&amp;</span><span class="ident" id="1415237">c</span><span class="op" id="1415238">.</span><span class="ident" id="1415239">lock</span><span class="op" id="1415243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415248">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415262">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415303">gp</span>&nbsp;<span class="op" id="1415306">:=</span>&nbsp;<span class="ident" id="1415309">getg</span><span class="op" id="1415313">(</span><span class="op" id="1415314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415318">mysg</span>&nbsp;<span class="op" id="1415323">:=</span>&nbsp;<span class="ident" id="1415326">acquireSudog</span><span class="op" id="1415338">(</span><span class="op" id="1415339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415343">mysg</span><span class="op" id="1415347">.</span><span class="ident" id="1415348">releasetime</span>&nbsp;<span class="op" id="1415360">=</span>&nbsp;<span class="num" id="1415362">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415366">if</span>&nbsp;<span class="ident" id="1415369">t0</span>&nbsp;<span class="op" id="1415372">!=</span>&nbsp;<span class="num" id="1415375">0</span>&nbsp;<span class="op" id="1415377">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415382">mysg</span><span class="op" id="1415386">.</span><span class="ident" id="1415387">releasetime</span>&nbsp;<span class="op" id="1415399">=</span>&nbsp;<span class="op" id="1415401">-</span><span class="num" id="1415402">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415410">mysg</span><span class="op" id="1415414">.</span><span class="ident" id="1415415">elem</span>&nbsp;<span class="op" id="1415420">=</span>&nbsp;<span class="builtintype" id="1415422">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415428">mysg</span><span class="op" id="1415432">.</span><span class="ident" id="1415433">g</span>&nbsp;<span class="op" id="1415435">=</span>&nbsp;<span class="ident" id="1415437">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415442">mysg</span><span class="op" id="1415446">.</span><span class="ident" id="1415447">selectdone</span>&nbsp;<span class="op" id="1415458">=</span>&nbsp;<span class="builtintype" id="1415460">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415467">c</span><span class="op" id="1415468">.</span><span class="ident" id="1415469">recvq</span><span class="op" id="1415474">.</span><span class="ident" id="1415475">enqueue</span><span class="op" id="1415482">(</span><span class="ident" id="1415483">mysg</span><span class="op" id="1415487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415491">goparkunlock</span><span class="op" id="1415503">(</span><span class="op" id="1415504">&amp;</span><span class="ident" id="1415505">c</span><span class="op" id="1415506">.</span><span class="ident" id="1415507">lock</span><span class="op" id="1415511">,</span>&nbsp;<span class="string" id="1415513">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1415527">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415532">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415568">if</span>&nbsp;<span class="ident" id="1415571">mysg</span><span class="op" id="1415575">.</span><span class="ident" id="1415576">releasetime</span>&nbsp;<span class="op" id="1415588">&gt;</span>&nbsp;<span class="num" id="1415590">0</span>&nbsp;<span class="op" id="1415592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415597">t1</span>&nbsp;<span class="op" id="1415600">=</span>&nbsp;<span class="ident" id="1415602">mysg</span><span class="op" id="1415606">.</span><span class="ident" id="1415607">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415625">releaseSudog</span><span class="op" id="1415637">(</span><span class="ident" id="1415638">mysg</span><span class="op" id="1415642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415646">lock</span><span class="op" id="1415650">(</span><span class="op" id="1415651">&amp;</span><span class="ident" id="1415652">c</span><span class="op" id="1415653">.</span><span class="ident" id="1415654">lock</span><span class="op" id="1415658">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415665">if</span>&nbsp;<span class="ident" id="1415668">raceenabled</span>&nbsp;<span class="op" id="1415680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415684">raceacquire</span><span class="op" id="1415695">(</span><span class="ident" id="1415696">chanbuf</span><span class="op" id="1415703">(</span><span class="ident" id="1415704">c</span><span class="op" id="1415705">,</span>&nbsp;<span class="ident" id="1415707">c</span><span class="op" id="1415708">.</span><span class="ident" id="1415709">recvx</span><span class="op" id="1415714">)</span><span class="op" id="1415715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415719">racerelease</span><span class="op" id="1415730">(</span><span class="ident" id="1415731">chanbuf</span><span class="op" id="1415738">(</span><span class="ident" id="1415739">c</span><span class="op" id="1415740">,</span>&nbsp;<span class="ident" id="1415742">c</span><span class="op" id="1415743">.</span><span class="ident" id="1415744">recvx</span><span class="op" id="1415749">)</span><span class="op" id="1415750">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415756">if</span>&nbsp;<span class="ident" id="1415759">ep</span>&nbsp;<span class="op" id="1415762">!=</span>&nbsp;<span class="builtintype" id="1415765">nil</span>&nbsp;<span class="op" id="1415769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415773">memmove</span><span class="op" id="1415780">(</span><span class="ident" id="1415781">ep</span><span class="op" id="1415783">,</span>&nbsp;<span class="ident" id="1415785">chanbuf</span><span class="op" id="1415792">(</span><span class="ident" id="1415793">c</span><span class="op" id="1415794">,</span>&nbsp;<span class="ident" id="1415796">c</span><span class="op" id="1415797">.</span><span class="ident" id="1415798">recvx</span><span class="op" id="1415803">)</span><span class="op" id="1415804">,</span>&nbsp;<span class="builtintype" id="1415806">uintptr</span><span class="op" id="1415813">(</span><span class="ident" id="1415814">c</span><span class="op" id="1415815">.</span><span class="ident" id="1415816">elemsize</span><span class="op" id="1415824">)</span><span class="op" id="1415825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415831">memclr</span><span class="op" id="1415837">(</span><span class="ident" id="1415838">chanbuf</span><span class="op" id="1415845">(</span><span class="ident" id="1415846">c</span><span class="op" id="1415847">,</span>&nbsp;<span class="ident" id="1415849">c</span><span class="op" id="1415850">.</span><span class="ident" id="1415851">recvx</span><span class="op" id="1415856">)</span><span class="op" id="1415857">,</span>&nbsp;<span class="builtintype" id="1415859">uintptr</span><span class="op" id="1415866">(</span><span class="ident" id="1415867">c</span><span class="op" id="1415868">.</span><span class="ident" id="1415869">elemsize</span><span class="op" id="1415877">)</span><span class="op" id="1415878">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415882">c</span><span class="op" id="1415883">.</span><span class="ident" id="1415884">recvx</span><span class="op" id="1415889">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415893">if</span>&nbsp;<span class="ident" id="1415896">c</span><span class="op" id="1415897">.</span><span class="ident" id="1415898">recvx</span>&nbsp;<span class="op" id="1415904">==</span>&nbsp;<span class="ident" id="1415907">c</span><span class="op" id="1415908">.</span><span class="ident" id="1415909">dataqsiz</span>&nbsp;<span class="op" id="1415918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415922">c</span><span class="op" id="1415923">.</span><span class="ident" id="1415924">recvx</span>&nbsp;<span class="op" id="1415930">=</span>&nbsp;<span class="num" id="1415932">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415935">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415938">c</span><span class="op" id="1415939">.</span><span class="ident" id="1415940">qcount</span><span class="op" id="1415946">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415951">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415993">sg</span>&nbsp;<span class="op" id="1415996">:=</span>&nbsp;<span class="ident" id="1415999">c</span><span class="op" id="1416000">.</span><span class="ident" id="1416001">sendq</span><span class="op" id="1416006">.</span><span class="ident" id="1416007">dequeue</span><span class="op" id="1416014">(</span><span class="op" id="1416015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416018">if</span>&nbsp;<span class="ident" id="1416021">sg</span>&nbsp;<span class="op" id="1416024">!=</span>&nbsp;<span class="builtintype" id="1416027">nil</span>&nbsp;<span class="op" id="1416031">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416035">gp</span>&nbsp;<span class="op" id="1416038">:=</span>&nbsp;<span class="ident" id="1416041">sg</span><span class="op" id="1416043">.</span><span class="ident" id="1416044">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416048">unlock</span><span class="op" id="1416054">(</span><span class="op" id="1416055">&amp;</span><span class="ident" id="1416056">c</span><span class="op" id="1416057">.</span><span class="ident" id="1416058">lock</span><span class="op" id="1416062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416066">if</span>&nbsp;<span class="ident" id="1416069">sg</span><span class="op" id="1416071">.</span><span class="ident" id="1416072">releasetime</span>&nbsp;<span class="op" id="1416084">!=</span>&nbsp;<span class="num" id="1416087">0</span>&nbsp;<span class="op" id="1416089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416094">sg</span><span class="op" id="1416096">.</span><span class="ident" id="1416097">releasetime</span>&nbsp;<span class="op" id="1416109">=</span>&nbsp;<span class="ident" id="1416111">cputicks</span><span class="op" id="1416119">(</span><span class="op" id="1416120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416124">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416128">goready</span><span class="op" id="1416135">(</span><span class="ident" id="1416136">gp</span><span class="op" id="1416138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416141">}</span>&nbsp;<span class="keyword" id="1416143">else</span>&nbsp;<span class="op" id="1416148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416152">unlock</span><span class="op" id="1416158">(</span><span class="op" id="1416159">&amp;</span><span class="ident" id="1416160">c</span><span class="op" id="1416161">.</span><span class="ident" id="1416162">lock</span><span class="op" id="1416166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416173">if</span>&nbsp;<span class="ident" id="1416176">t1</span>&nbsp;<span class="op" id="1416179">&gt;</span>&nbsp;<span class="num" id="1416181">0</span>&nbsp;<span class="op" id="1416183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416187">blockevent</span><span class="op" id="1416197">(</span><span class="ident" id="1416198">t1</span><span class="op" id="1416200">-</span><span class="ident" id="1416201">t0</span><span class="op" id="1416203">,</span>&nbsp;<span class="num" id="1416205">2</span><span class="op" id="1416206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416212">selected</span>&nbsp;<span class="op" id="1416221">=</span>&nbsp;<span class="builtintype" id="1416223">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416229">received</span>&nbsp;<span class="op" id="1416238">=</span>&nbsp;<span class="builtintype" id="1416240">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416246">return</span><br>
<span class="lineno"></span><span class="op" id="1416253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1416256">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1416322">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1416372">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1416434">func</span>&nbsp;<span class="ident" id="1416439">recvclosed</span><span class="op" id="1416449">(</span><span class="ident" id="1416450">c</span>&nbsp;<span class="op" id="1416452">*</span><span class="ident" id="1416453">hchan</span><span class="op" id="1416458">,</span>&nbsp;<span class="ident" id="1416460">ep</span>&nbsp;<span class="ident" id="1416463">unsafe</span><span class="op" id="1416469">.</span><span class="ident" id="1416470">Pointer</span><span class="op" id="1416477">)</span>&nbsp;<span class="op" id="1416479">(</span><span class="ident" id="1416480">selected</span><span class="op" id="1416488">,</span>&nbsp;<span class="ident" id="1416490">recevied</span>&nbsp;<span class="builtintype" id="1416499">bool</span><span class="op" id="1416503">)</span>&nbsp;<span class="op" id="1416505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416508">if</span>&nbsp;<span class="ident" id="1416511">raceenabled</span>&nbsp;<span class="op" id="1416523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416527">raceacquire</span><span class="op" id="1416538">(</span><span class="ident" id="1416539">unsafe</span><span class="op" id="1416545">.</span><span class="ident" id="1416546">Pointer</span><span class="op" id="1416553">(</span><span class="ident" id="1416554">c</span><span class="op" id="1416555">)</span><span class="op" id="1416556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416559">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416562">unlock</span><span class="op" id="1416568">(</span><span class="op" id="1416569">&amp;</span><span class="ident" id="1416570">c</span><span class="op" id="1416571">.</span><span class="ident" id="1416572">lock</span><span class="op" id="1416576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416579">if</span>&nbsp;<span class="ident" id="1416582">ep</span>&nbsp;<span class="op" id="1416585">!=</span>&nbsp;<span class="builtintype" id="1416588">nil</span>&nbsp;<span class="op" id="1416592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416596">memclr</span><span class="op" id="1416602">(</span><span class="ident" id="1416603">ep</span><span class="op" id="1416605">,</span>&nbsp;<span class="builtintype" id="1416607">uintptr</span><span class="op" id="1416614">(</span><span class="ident" id="1416615">c</span><span class="op" id="1416616">.</span><span class="ident" id="1416617">elemsize</span><span class="op" id="1416625">)</span><span class="op" id="1416626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416632">return</span>&nbsp;<span class="builtintype" id="1416639">true</span><span class="op" id="1416643">,</span>&nbsp;<span class="builtintype" id="1416645">false</span><br>
<span class="lineno">525</span><span class="op" id="1416651">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1416654">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1416677">//</span><br>
<span class="lineno"></span><span class="comment" id="1416680">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1416692">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1416708">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1416720">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1416732">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1416744">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno">535</span><span class="comment" id="1416749">//</span><br>
<span class="lineno"></span><span class="comment" id="1416752">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1416758">//</span><br>
<span class="lineno"></span><span class="comment" id="1416761">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1416788">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1416800">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1416812">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1416824">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1416829">//</span><br>
<span class="lineno"></span><span class="keyword" id="1416832">func</span>&nbsp;<span class="ident" id="1416837">selectnbsend</span><span class="op" id="1416849">(</span><span class="ident" id="1416850">t</span>&nbsp;<span class="op" id="1416852">*</span><span class="ident" id="1416853">chantype</span><span class="op" id="1416861">,</span>&nbsp;<span class="ident" id="1416863">c</span>&nbsp;<span class="op" id="1416865">*</span><span class="ident" id="1416866">hchan</span><span class="op" id="1416871">,</span>&nbsp;<span class="ident" id="1416873">elem</span>&nbsp;<span class="ident" id="1416878">unsafe</span><span class="op" id="1416884">.</span><span class="ident" id="1416885">Pointer</span><span class="op" id="1416892">)</span>&nbsp;<span class="op" id="1416894">(</span><span class="ident" id="1416895">selected</span>&nbsp;<span class="builtintype" id="1416904">bool</span><span class="op" id="1416908">)</span>&nbsp;<span class="op" id="1416910">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416913">return</span>&nbsp;<span class="ident" id="1416920">chansend</span><span class="op" id="1416928">(</span><span class="ident" id="1416929">t</span><span class="op" id="1416930">,</span>&nbsp;<span class="ident" id="1416932">c</span><span class="op" id="1416933">,</span>&nbsp;<span class="ident" id="1416935">elem</span><span class="op" id="1416939">,</span>&nbsp;<span class="builtintype" id="1416941">false</span><span class="op" id="1416946">,</span>&nbsp;<span class="ident" id="1416948">getcallerpc</span><span class="op" id="1416959">(</span><span class="ident" id="1416960">unsafe</span><span class="op" id="1416966">.</span><span class="ident" id="1416967">Pointer</span><span class="op" id="1416974">(</span><span class="op" id="1416975">&amp;</span><span class="ident" id="1416976">t</span><span class="op" id="1416977">)</span><span class="op" id="1416978">)</span><span class="op" id="1416979">)</span><br>
<span class="lineno"></span><span class="op" id="1416981">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1416984">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1417007">//</span><br>
<span class="lineno">550</span><span class="comment" id="1417010">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1417022">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1417039">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1417051">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1417063">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1417075">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1417080">//</span><br>
<span class="lineno"></span><span class="comment" id="1417083">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1417089">//</span><br>
<span class="lineno"></span><span class="comment" id="1417092">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1417120">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1417132">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1417144">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1417156">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1417161">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1417164">func</span>&nbsp;<span class="ident" id="1417169">selectnbrecv</span><span class="op" id="1417181">(</span><span class="ident" id="1417182">t</span>&nbsp;<span class="op" id="1417184">*</span><span class="ident" id="1417185">chantype</span><span class="op" id="1417193">,</span>&nbsp;<span class="ident" id="1417195">elem</span>&nbsp;<span class="ident" id="1417200">unsafe</span><span class="op" id="1417206">.</span><span class="ident" id="1417207">Pointer</span><span class="op" id="1417214">,</span>&nbsp;<span class="ident" id="1417216">c</span>&nbsp;<span class="op" id="1417218">*</span><span class="ident" id="1417219">hchan</span><span class="op" id="1417224">)</span>&nbsp;<span class="op" id="1417226">(</span><span class="ident" id="1417227">selected</span>&nbsp;<span class="builtintype" id="1417236">bool</span><span class="op" id="1417240">)</span>&nbsp;<span class="op" id="1417242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417245">selected</span><span class="op" id="1417253">,</span>&nbsp;<span class="ident" id="1417255">_</span>&nbsp;<span class="op" id="1417257">=</span>&nbsp;<span class="ident" id="1417259">chanrecv</span><span class="op" id="1417267">(</span><span class="ident" id="1417268">t</span><span class="op" id="1417269">,</span>&nbsp;<span class="ident" id="1417271">c</span><span class="op" id="1417272">,</span>&nbsp;<span class="ident" id="1417274">elem</span><span class="op" id="1417278">,</span>&nbsp;<span class="builtintype" id="1417280">false</span><span class="op" id="1417285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417288">return</span><br>
<span class="lineno"></span><span class="op" id="1417295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1417298">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1417321">//</span><br>
<span class="lineno"></span><span class="comment" id="1417324">//&nbsp;&nbsp;&nbsp;&nbsp;select&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1417336">//&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1417357">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1417369">//&nbsp;&nbsp;&nbsp;&nbsp;default:</span><br>
<span class="lineno"></span><span class="comment" id="1417381">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1417393">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1417398">//</span><br>
<span class="lineno"></span><span class="comment" id="1417401">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1417407">//</span><br>
<span class="lineno"></span><span class="comment" id="1417410">//&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1417456">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1417468">//&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1417480">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1417492">//&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="1417497">//</span><br>
<span class="lineno"></span><span class="keyword" id="1417500">func</span>&nbsp;<span class="ident" id="1417505">selectnbrecv2</span><span class="op" id="1417518">(</span><span class="ident" id="1417519">t</span>&nbsp;<span class="op" id="1417521">*</span><span class="ident" id="1417522">chantype</span><span class="op" id="1417530">,</span>&nbsp;<span class="ident" id="1417532">elem</span>&nbsp;<span class="ident" id="1417537">unsafe</span><span class="op" id="1417543">.</span><span class="ident" id="1417544">Pointer</span><span class="op" id="1417551">,</span>&nbsp;<span class="ident" id="1417553">received</span>&nbsp;<span class="op" id="1417562">*</span><span class="builtintype" id="1417563">bool</span><span class="op" id="1417567">,</span>&nbsp;<span class="ident" id="1417569">c</span>&nbsp;<span class="op" id="1417571">*</span><span class="ident" id="1417572">hchan</span><span class="op" id="1417577">)</span>&nbsp;<span class="op" id="1417579">(</span><span class="ident" id="1417580">selected</span>&nbsp;<span class="builtintype" id="1417589">bool</span><span class="op" id="1417593">)</span>&nbsp;<span class="op" id="1417595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417598">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417676">selected</span><span class="op" id="1417684">,</span>&nbsp;<span class="op" id="1417686">*</span><span class="ident" id="1417687">received</span>&nbsp;<span class="op" id="1417696">=</span>&nbsp;<span class="ident" id="1417698">chanrecv</span><span class="op" id="1417706">(</span><span class="ident" id="1417707">t</span><span class="op" id="1417708">,</span>&nbsp;<span class="ident" id="1417710">c</span><span class="op" id="1417711">,</span>&nbsp;<span class="ident" id="1417713">elem</span><span class="op" id="1417717">,</span>&nbsp;<span class="builtintype" id="1417719">false</span><span class="op" id="1417724">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417727">return</span><br>
<span class="lineno"></span><span class="op" id="1417734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1417737">func</span>&nbsp;<span class="ident" id="1417742">reflect_chansend</span><span class="op" id="1417758">(</span><span class="ident" id="1417759">t</span>&nbsp;<span class="op" id="1417761">*</span><span class="ident" id="1417762">chantype</span><span class="op" id="1417770">,</span>&nbsp;<span class="ident" id="1417772">c</span>&nbsp;<span class="op" id="1417774">*</span><span class="ident" id="1417775">hchan</span><span class="op" id="1417780">,</span>&nbsp;<span class="ident" id="1417782">elem</span>&nbsp;<span class="ident" id="1417787">unsafe</span><span class="op" id="1417793">.</span><span class="ident" id="1417794">Pointer</span><span class="op" id="1417801">,</span>&nbsp;<span class="ident" id="1417803">nb</span>&nbsp;<span class="builtintype" id="1417806">bool</span><span class="op" id="1417810">)</span>&nbsp;<span class="op" id="1417812">(</span><span class="ident" id="1417813">selected</span>&nbsp;<span class="builtintype" id="1417822">bool</span><span class="op" id="1417826">)</span>&nbsp;<span class="op" id="1417828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417831">return</span>&nbsp;<span class="ident" id="1417838">chansend</span><span class="op" id="1417846">(</span><span class="ident" id="1417847">t</span><span class="op" id="1417848">,</span>&nbsp;<span class="ident" id="1417850">c</span><span class="op" id="1417851">,</span>&nbsp;<span class="ident" id="1417853">elem</span><span class="op" id="1417857">,</span>&nbsp;<span class="op" id="1417859">!</span><span class="ident" id="1417860">nb</span><span class="op" id="1417862">,</span>&nbsp;<span class="ident" id="1417864">getcallerpc</span><span class="op" id="1417875">(</span><span class="ident" id="1417876">unsafe</span><span class="op" id="1417882">.</span><span class="ident" id="1417883">Pointer</span><span class="op" id="1417890">(</span><span class="op" id="1417891">&amp;</span><span class="ident" id="1417892">t</span><span class="op" id="1417893">)</span><span class="op" id="1417894">)</span><span class="op" id="1417895">)</span><br>
<span class="lineno">595</span><span class="op" id="1417897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1417900">func</span>&nbsp;<span class="ident" id="1417905">reflect_chanrecv</span><span class="op" id="1417921">(</span><span class="ident" id="1417922">t</span>&nbsp;<span class="op" id="1417924">*</span><span class="ident" id="1417925">chantype</span><span class="op" id="1417933">,</span>&nbsp;<span class="ident" id="1417935">c</span>&nbsp;<span class="op" id="1417937">*</span><span class="ident" id="1417938">hchan</span><span class="op" id="1417943">,</span>&nbsp;<span class="ident" id="1417945">nb</span>&nbsp;<span class="builtintype" id="1417948">bool</span><span class="op" id="1417952">,</span>&nbsp;<span class="ident" id="1417954">elem</span>&nbsp;<span class="ident" id="1417959">unsafe</span><span class="op" id="1417965">.</span><span class="ident" id="1417966">Pointer</span><span class="op" id="1417973">)</span>&nbsp;<span class="op" id="1417975">(</span><span class="ident" id="1417976">selected</span>&nbsp;<span class="builtintype" id="1417985">bool</span><span class="op" id="1417989">,</span>&nbsp;<span class="ident" id="1417991">received</span>&nbsp;<span class="builtintype" id="1418000">bool</span><span class="op" id="1418004">)</span>&nbsp;<span class="op" id="1418006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418009">return</span>&nbsp;<span class="ident" id="1418016">chanrecv</span><span class="op" id="1418024">(</span><span class="ident" id="1418025">t</span><span class="op" id="1418026">,</span>&nbsp;<span class="ident" id="1418028">c</span><span class="op" id="1418029">,</span>&nbsp;<span class="ident" id="1418031">elem</span><span class="op" id="1418035">,</span>&nbsp;<span class="op" id="1418037">!</span><span class="ident" id="1418038">nb</span><span class="op" id="1418040">)</span><br>
<span class="lineno"></span><span class="op" id="1418042">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1418045">func</span>&nbsp;<span class="ident" id="1418050">reflect_chanlen</span><span class="op" id="1418065">(</span><span class="ident" id="1418066">c</span>&nbsp;<span class="op" id="1418068">*</span><span class="ident" id="1418069">hchan</span><span class="op" id="1418074">)</span>&nbsp;<span class="builtintype" id="1418076">int</span>&nbsp;<span class="op" id="1418080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418083">if</span>&nbsp;<span class="ident" id="1418086">c</span>&nbsp;<span class="op" id="1418088">==</span>&nbsp;<span class="builtintype" id="1418091">nil</span>&nbsp;<span class="op" id="1418095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418099">return</span>&nbsp;<span class="num" id="1418106">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418109">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418112">return</span>&nbsp;<span class="builtintype" id="1418119">int</span><span class="op" id="1418122">(</span><span class="ident" id="1418123">c</span><span class="op" id="1418124">.</span><span class="ident" id="1418125">qcount</span><span class="op" id="1418131">)</span><br>
<span class="lineno"></span><span class="op" id="1418133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418136">func</span>&nbsp;<span class="ident" id="1418141">reflect_chancap</span><span class="op" id="1418156">(</span><span class="ident" id="1418157">c</span>&nbsp;<span class="op" id="1418159">*</span><span class="ident" id="1418160">hchan</span><span class="op" id="1418165">)</span>&nbsp;<span class="builtintype" id="1418167">int</span>&nbsp;<span class="op" id="1418171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418174">if</span>&nbsp;<span class="ident" id="1418177">c</span>&nbsp;<span class="op" id="1418179">==</span>&nbsp;<span class="builtintype" id="1418182">nil</span>&nbsp;<span class="op" id="1418186">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418190">return</span>&nbsp;<span class="num" id="1418197">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418203">return</span>&nbsp;<span class="builtintype" id="1418210">int</span><span class="op" id="1418213">(</span><span class="ident" id="1418214">c</span><span class="op" id="1418215">.</span><span class="ident" id="1418216">dataqsiz</span><span class="op" id="1418224">)</span><br>
<span class="lineno"></span><span class="op" id="1418226">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1418229">func</span>&nbsp;<span class="op" id="1418234">(</span><span class="ident" id="1418235">q</span>&nbsp;<span class="op" id="1418237">*</span><span class="ident" id="1418238">waitq</span><span class="op" id="1418243">)</span>&nbsp;<span class="ident" id="1418245">enqueue</span><span class="op" id="1418252">(</span><span class="ident" id="1418253">sgp</span>&nbsp;<span class="op" id="1418257">*</span><span class="ident" id="1418258">sudog</span><span class="op" id="1418263">)</span>&nbsp;<span class="op" id="1418265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418268">sgp</span><span class="op" id="1418271">.</span><span class="ident" id="1418272">next</span>&nbsp;<span class="op" id="1418277">=</span>&nbsp;<span class="builtintype" id="1418279">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418284">if</span>&nbsp;<span class="ident" id="1418287">q</span><span class="op" id="1418288">.</span><span class="ident" id="1418289">first</span>&nbsp;<span class="op" id="1418295">==</span>&nbsp;<span class="builtintype" id="1418298">nil</span>&nbsp;<span class="op" id="1418302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418306">q</span><span class="op" id="1418307">.</span><span class="ident" id="1418308">first</span>&nbsp;<span class="op" id="1418314">=</span>&nbsp;<span class="ident" id="1418316">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418322">q</span><span class="op" id="1418323">.</span><span class="ident" id="1418324">last</span>&nbsp;<span class="op" id="1418329">=</span>&nbsp;<span class="ident" id="1418331">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418337">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418348">q</span><span class="op" id="1418349">.</span><span class="ident" id="1418350">last</span><span class="op" id="1418354">.</span><span class="ident" id="1418355">next</span>&nbsp;<span class="op" id="1418360">=</span>&nbsp;<span class="ident" id="1418362">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418367">q</span><span class="op" id="1418368">.</span><span class="ident" id="1418369">last</span>&nbsp;<span class="op" id="1418374">=</span>&nbsp;<span class="ident" id="1418376">sgp</span><br>
<span class="lineno"></span><span class="op" id="1418380">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1418383">func</span>&nbsp;<span class="op" id="1418388">(</span><span class="ident" id="1418389">q</span>&nbsp;<span class="op" id="1418391">*</span><span class="ident" id="1418392">waitq</span><span class="op" id="1418397">)</span>&nbsp;<span class="ident" id="1418399">dequeue</span><span class="op" id="1418406">(</span><span class="op" id="1418407">)</span>&nbsp;<span class="op" id="1418409">*</span><span class="ident" id="1418410">sudog</span>&nbsp;<span class="op" id="1418416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418419">for</span>&nbsp;<span class="op" id="1418423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418427">sgp</span>&nbsp;<span class="op" id="1418431">:=</span>&nbsp;<span class="ident" id="1418434">q</span><span class="op" id="1418435">.</span><span class="ident" id="1418436">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418444">if</span>&nbsp;<span class="ident" id="1418447">sgp</span>&nbsp;<span class="op" id="1418451">==</span>&nbsp;<span class="builtintype" id="1418454">nil</span>&nbsp;<span class="op" id="1418458">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418463">return</span>&nbsp;<span class="builtintype" id="1418470">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418480">q</span><span class="op" id="1418481">.</span><span class="ident" id="1418482">first</span>&nbsp;<span class="op" id="1418488">=</span>&nbsp;<span class="ident" id="1418490">sgp</span><span class="op" id="1418493">.</span><span class="ident" id="1418494">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418501">sgp</span><span class="op" id="1418504">.</span><span class="ident" id="1418505">next</span>&nbsp;<span class="op" id="1418510">=</span>&nbsp;<span class="builtintype" id="1418512">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418518">if</span>&nbsp;<span class="ident" id="1418521">q</span><span class="op" id="1418522">.</span><span class="ident" id="1418523">last</span>&nbsp;<span class="op" id="1418528">==</span>&nbsp;<span class="ident" id="1418531">sgp</span>&nbsp;<span class="op" id="1418535">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418540">q</span><span class="op" id="1418541">.</span><span class="ident" id="1418542">last</span>&nbsp;<span class="op" id="1418547">=</span>&nbsp;<span class="builtintype" id="1418549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418560">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418632">if</span>&nbsp;<span class="ident" id="1418635">sgp</span><span class="op" id="1418638">.</span><span class="ident" id="1418639">selectdone</span>&nbsp;<span class="op" id="1418650">!=</span>&nbsp;<span class="builtintype" id="1418653">nil</span>&nbsp;<span class="op" id="1418657">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418662">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418694">if</span>&nbsp;<span class="op" id="1418697">*</span><span class="ident" id="1418698">sgp</span><span class="op" id="1418701">.</span><span class="ident" id="1418702">selectdone</span>&nbsp;<span class="op" id="1418713">!=</span>&nbsp;<span class="num" id="1418716">0</span>&nbsp;<span class="op" id="1418718">||</span>&nbsp;<span class="op" id="1418721">!</span><span class="ident" id="1418722">cas</span><span class="op" id="1418725">(</span><span class="ident" id="1418726">sgp</span><span class="op" id="1418729">.</span><span class="ident" id="1418730">selectdone</span><span class="op" id="1418740">,</span>&nbsp;<span class="num" id="1418742">0</span><span class="op" id="1418743">,</span>&nbsp;<span class="num" id="1418745">1</span><span class="op" id="1418746">)</span>&nbsp;<span class="op" id="1418748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418754">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418770">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418775">return</span>&nbsp;<span class="ident" id="1418782">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418787">}</span><br>
<span class="lineno"></span><span class="op" id="1418789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1418792">func</span>&nbsp;<span class="ident" id="1418797">racesync</span><span class="op" id="1418805">(</span><span class="ident" id="1418806">c</span>&nbsp;<span class="op" id="1418808">*</span><span class="ident" id="1418809">hchan</span><span class="op" id="1418814">,</span>&nbsp;<span class="ident" id="1418816">sg</span>&nbsp;<span class="op" id="1418819">*</span><span class="ident" id="1418820">sudog</span><span class="op" id="1418825">)</span>&nbsp;<span class="op" id="1418827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418830">racerelease</span><span class="op" id="1418841">(</span><span class="ident" id="1418842">chanbuf</span><span class="op" id="1418849">(</span><span class="ident" id="1418850">c</span><span class="op" id="1418851">,</span>&nbsp;<span class="num" id="1418853">0</span><span class="op" id="1418854">)</span><span class="op" id="1418855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418858">raceacquireg</span><span class="op" id="1418870">(</span><span class="ident" id="1418871">sg</span><span class="op" id="1418873">.</span><span class="ident" id="1418874">g</span><span class="op" id="1418875">,</span>&nbsp;<span class="ident" id="1418877">chanbuf</span><span class="op" id="1418884">(</span><span class="ident" id="1418885">c</span><span class="op" id="1418886">,</span>&nbsp;<span class="num" id="1418888">0</span><span class="op" id="1418889">)</span><span class="op" id="1418890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418893">racereleaseg</span><span class="op" id="1418905">(</span><span class="ident" id="1418906">sg</span><span class="op" id="1418908">.</span><span class="ident" id="1418909">g</span><span class="op" id="1418910">,</span>&nbsp;<span class="ident" id="1418912">chanbuf</span><span class="op" id="1418919">(</span><span class="ident" id="1418920">c</span><span class="op" id="1418921">,</span>&nbsp;<span class="num" id="1418923">0</span><span class="op" id="1418924">)</span><span class="op" id="1418925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418928">raceacquire</span><span class="op" id="1418939">(</span><span class="ident" id="1418940">chanbuf</span><span class="op" id="1418947">(</span><span class="ident" id="1418948">c</span><span class="op" id="1418949">,</span>&nbsp;<span class="num" id="1418951">0</span><span class="op" id="1418952">)</span><span class="op" id="1418953">)</span><br>
<span class="lineno">655</span><span class="op" id="1418955">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
