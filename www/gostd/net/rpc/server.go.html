<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4706532">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4706587">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4706641">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4706692">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="4710521">package</span>&nbsp;<span class="ident" id="4710529">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4710534">import</span>&nbsp;<span class="op" id="4710541">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710544">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710553">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710569">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710579">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710585">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710592">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710599">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710611">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710622">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710633">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710641">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4710652">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4710667">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4710670">const</span>&nbsp;<span class="op" id="4710676">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4710679">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710711">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4710728">=</span>&nbsp;<span class="string" id="4710730">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710742">DefaultDebugPath</span>&nbsp;<span class="op" id="4710759">=</span>&nbsp;<span class="string" id="4710761">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="4710774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4710777">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="4710845">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="4710914">var</span>&nbsp;<span class="ident" id="4710918">typeOfError</span>&nbsp;<span class="op" id="4710930">=</span>&nbsp;<span class="ident" id="4710932">reflect</span><span class="op" id="4710939">.</span><span class="ident" id="4710940">TypeOf</span><span class="op" id="4710946">(</span><span class="op" id="4710947">(</span><span class="op" id="4710948">*</span><span class="builtintype" id="4710949">error</span><span class="op" id="4710954">)</span><span class="op" id="4710955">(</span><span class="ident" id="4710956">nil</span><span class="op" id="4710959">)</span><span class="op" id="4710960">)</span><span class="op" id="4710961">.</span><span class="ident" id="4710962">Elem</span><span class="op" id="4710966">(</span><span class="op" id="4710967">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4710970">type</span>&nbsp;<span class="ident" id="4710975">methodType</span>&nbsp;<span class="keyword" id="4710986">struct</span>&nbsp;<span class="op" id="4710993">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4710996">sync</span><span class="op" id="4711000">.</span><span class="ident" id="4711001">Mutex</span>&nbsp;<span class="comment" id="4711007">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711029">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4711040">reflect</span><span class="op" id="4711047">.</span><span class="ident" id="4711048">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711056">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4711067">reflect</span><span class="op" id="4711074">.</span><span class="ident" id="4711075">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711081">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="4711092">reflect</span><span class="op" id="4711099">.</span><span class="ident" id="4711100">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711106">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4711117">uint</span><br>
<span class="lineno">155</span><span class="op" id="4711122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4711125">type</span>&nbsp;<span class="ident" id="4711130">service</span>&nbsp;<span class="keyword" id="4711138">struct</span>&nbsp;<span class="op" id="4711145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711148">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4711155">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4711178">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711198">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4711205">reflect</span><span class="op" id="4711212">.</span><span class="ident" id="4711213">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4711228">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711268">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4711275">reflect</span><span class="op" id="4711282">.</span><span class="ident" id="4711283">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4711298">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711323">method</span>&nbsp;<span class="keyword" id="4711330">map</span><span class="op" id="4711333">[</span><span class="builtintype" id="4711334">string</span><span class="op" id="4711340">]</span><span class="op" id="4711341">*</span><span class="ident" id="4711342">methodType</span>&nbsp;<span class="comment" id="4711353">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="4711375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4711378">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="4711455">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="4711525">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4711545">type</span>&nbsp;<span class="ident" id="4711550">Request</span>&nbsp;<span class="keyword" id="4711558">struct</span>&nbsp;<span class="op" id="4711565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711568">ServiceMethod</span>&nbsp;<span class="builtintype" id="4711582">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4711591">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711620">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4711634">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4711643">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711680">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4711694">*</span><span class="ident" id="4711695">Request</span>&nbsp;<span class="comment" id="4711703">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4711730">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4711733">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="4711813">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="4711883">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="4711903">type</span>&nbsp;<span class="ident" id="4711908">Response</span>&nbsp;<span class="keyword" id="4711917">struct</span>&nbsp;<span class="op" id="4711924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711927">ServiceMethod</span>&nbsp;<span class="builtintype" id="4711941">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4711951">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4711982">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4711996">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4712006">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712037">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4712051">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4712061">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712080">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4712094">*</span><span class="ident" id="4712095">Response</span>&nbsp;<span class="comment" id="4712104">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="4712131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4712134">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4712170">type</span>&nbsp;<span class="ident" id="4712175">Server</span>&nbsp;<span class="keyword" id="4712182">struct</span>&nbsp;<span class="op" id="4712189">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712192">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4712203">sync</span><span class="op" id="4712207">.</span><span class="ident" id="4712208">RWMutex</span>&nbsp;<span class="comment" id="4712216">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712244">serviceMap</span>&nbsp;<span class="keyword" id="4712255">map</span><span class="op" id="4712258">[</span><span class="builtintype" id="4712259">string</span><span class="op" id="4712265">]</span><span class="op" id="4712266">*</span><span class="ident" id="4712267">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712276">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4712287">sync</span><span class="op" id="4712291">.</span><span class="ident" id="4712292">Mutex</span>&nbsp;<span class="comment" id="4712298">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712319">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4712330">*</span><span class="ident" id="4712331">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712340">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4712351">sync</span><span class="op" id="4712355">.</span><span class="ident" id="4712356">Mutex</span>&nbsp;<span class="comment" id="4712362">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712384">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4712395">*</span><span class="ident" id="4712396">Response</span><br>
<span class="lineno"></span><span class="op" id="4712405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4712408">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4712443">func</span>&nbsp;<span class="ident" id="4712448">NewServer</span><span class="op" id="4712457">(</span><span class="op" id="4712458">)</span>&nbsp;<span class="op" id="4712460">*</span><span class="ident" id="4712461">Server</span>&nbsp;<span class="op" id="4712468">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4712471">return</span>&nbsp;<span class="op" id="4712478">&amp;</span><span class="ident" id="4712479">Server</span><span class="op" id="4712485">{</span><span class="ident" id="4712486">serviceMap</span><span class="op" id="4712496">:</span>&nbsp;<span class="builtinfunc" id="4712498">make</span><span class="op" id="4712502">(</span><span class="keyword" id="4712503">map</span><span class="op" id="4712506">[</span><span class="builtintype" id="4712507">string</span><span class="op" id="4712513">]</span><span class="op" id="4712514">*</span><span class="ident" id="4712515">service</span><span class="op" id="4712522">)</span><span class="op" id="4712523">}</span><br>
<span class="lineno"></span><span class="op" id="4712525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4712528">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="4712581">var</span>&nbsp;<span class="ident" id="4712585">DefaultServer</span>&nbsp;<span class="op" id="4712599">=</span>&nbsp;<span class="ident" id="4712601">NewServer</span><span class="op" id="4712610">(</span><span class="op" id="4712611">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4712614">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="4712658">func</span>&nbsp;<span class="ident" id="4712663">isExported</span><span class="op" id="4712673">(</span><span class="ident" id="4712674">name</span>&nbsp;<span class="builtintype" id="4712679">string</span><span class="op" id="4712685">)</span>&nbsp;<span class="builtintype" id="4712687">bool</span>&nbsp;<span class="op" id="4712692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4712695">rune</span><span class="op" id="4712699">,</span>&nbsp;<span class="ident" id="4712701">_</span>&nbsp;<span class="op" id="4712703">:=</span>&nbsp;<span class="ident" id="4712706">utf8</span><span class="op" id="4712710">.</span><span class="ident" id="4712711">DecodeRuneInString</span><span class="op" id="4712729">(</span><span class="ident" id="4712730">name</span><span class="op" id="4712734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4712737">return</span>&nbsp;<span class="ident" id="4712744">unicode</span><span class="op" id="4712751">.</span><span class="ident" id="4712752">IsUpper</span><span class="op" id="4712759">(</span><span class="builtintype" id="4712760">rune</span><span class="op" id="4712764">)</span><br>
<span class="lineno">205</span><span class="op" id="4712766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4712769">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="4712808">func</span>&nbsp;<span class="ident" id="4712813">isExportedOrBuiltinType</span><span class="op" id="4712836">(</span><span class="ident" id="4712837">t</span>&nbsp;<span class="ident" id="4712839">reflect</span><span class="op" id="4712846">.</span><span class="ident" id="4712847">Type</span><span class="op" id="4712851">)</span>&nbsp;<span class="builtintype" id="4712853">bool</span>&nbsp;<span class="op" id="4712858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4712861">for</span>&nbsp;<span class="ident" id="4712865">t</span><span class="op" id="4712866">.</span><span class="ident" id="4712867">Kind</span><span class="op" id="4712871">(</span><span class="op" id="4712872">)</span>&nbsp;<span class="op" id="4712874">==</span>&nbsp;<span class="ident" id="4712877">reflect</span><span class="op" id="4712884">.</span><span class="ident" id="4712885">Ptr</span>&nbsp;<span class="op" id="4712889">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4712893">t</span>&nbsp;<span class="op" id="4712895">=</span>&nbsp;<span class="ident" id="4712897">t</span><span class="op" id="4712898">.</span><span class="ident" id="4712899">Elem</span><span class="op" id="4712903">(</span><span class="op" id="4712904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4712907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4712910">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4712967">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4713014">return</span>&nbsp;<span class="ident" id="4713021">isExported</span><span class="op" id="4713031">(</span><span class="ident" id="4713032">t</span><span class="op" id="4713033">.</span><span class="ident" id="4713034">Name</span><span class="op" id="4713038">(</span><span class="op" id="4713039">)</span><span class="op" id="4713040">)</span>&nbsp;<span class="op" id="4713042">||</span>&nbsp;<span class="ident" id="4713045">t</span><span class="op" id="4713046">.</span><span class="ident" id="4713047">PkgPath</span><span class="op" id="4713054">(</span><span class="op" id="4713055">)</span>&nbsp;<span class="op" id="4713057">==</span>&nbsp;<span class="string" id="4713060">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="4713063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4713066">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4713128">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="4713185">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="4713206">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4713248">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="4713286">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4713323">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4713393">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="4713459">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="4713536">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4713583">func</span>&nbsp;<span class="op" id="4713588">(</span><span class="ident" id="4713589">server</span>&nbsp;<span class="op" id="4713596">*</span><span class="ident" id="4713597">Server</span><span class="op" id="4713603">)</span>&nbsp;<span class="ident" id="4713605">Register</span><span class="op" id="4713613">(</span><span class="ident" id="4713614">rcvr</span>&nbsp;<span class="keyword" id="4713619">interface</span><span class="op" id="4713628">{</span><span class="op" id="4713629">}</span><span class="op" id="4713630">)</span>&nbsp;<span class="builtintype" id="4713632">error</span>&nbsp;<span class="op" id="4713638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4713641">return</span>&nbsp;<span class="ident" id="4713648">server</span><span class="op" id="4713654">.</span><span class="ident" id="4713655">register</span><span class="op" id="4713663">(</span><span class="ident" id="4713664">rcvr</span><span class="op" id="4713668">,</span>&nbsp;<span class="string" id="4713670">&#34;&#34;</span><span class="op" id="4713672">,</span>&nbsp;<span class="builtintype" id="4713674">false</span><span class="op" id="4713679">)</span><br>
<span class="lineno"></span><span class="op" id="4713681">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4713684">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4713757">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4713801">func</span>&nbsp;<span class="op" id="4713806">(</span><span class="ident" id="4713807">server</span>&nbsp;<span class="op" id="4713814">*</span><span class="ident" id="4713815">Server</span><span class="op" id="4713821">)</span>&nbsp;<span class="ident" id="4713823">RegisterName</span><span class="op" id="4713835">(</span><span class="ident" id="4713836">name</span>&nbsp;<span class="builtintype" id="4713841">string</span><span class="op" id="4713847">,</span>&nbsp;<span class="ident" id="4713849">rcvr</span>&nbsp;<span class="keyword" id="4713854">interface</span><span class="op" id="4713863">{</span><span class="op" id="4713864">}</span><span class="op" id="4713865">)</span>&nbsp;<span class="builtintype" id="4713867">error</span>&nbsp;<span class="op" id="4713873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4713876">return</span>&nbsp;<span class="ident" id="4713883">server</span><span class="op" id="4713889">.</span><span class="ident" id="4713890">register</span><span class="op" id="4713898">(</span><span class="ident" id="4713899">rcvr</span><span class="op" id="4713903">,</span>&nbsp;<span class="ident" id="4713905">name</span><span class="op" id="4713909">,</span>&nbsp;<span class="builtintype" id="4713911">true</span><span class="op" id="4713915">)</span><br>
<span class="lineno">235</span><span class="op" id="4713917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4713920">func</span>&nbsp;<span class="op" id="4713925">(</span><span class="ident" id="4713926">server</span>&nbsp;<span class="op" id="4713933">*</span><span class="ident" id="4713934">Server</span><span class="op" id="4713940">)</span>&nbsp;<span class="ident" id="4713942">register</span><span class="op" id="4713950">(</span><span class="ident" id="4713951">rcvr</span>&nbsp;<span class="keyword" id="4713956">interface</span><span class="op" id="4713965">{</span><span class="op" id="4713966">}</span><span class="op" id="4713967">,</span>&nbsp;<span class="ident" id="4713969">name</span>&nbsp;<span class="builtintype" id="4713974">string</span><span class="op" id="4713980">,</span>&nbsp;<span class="ident" id="4713982">useName</span>&nbsp;<span class="builtintype" id="4713990">bool</span><span class="op" id="4713994">)</span>&nbsp;<span class="builtintype" id="4713996">error</span>&nbsp;<span class="op" id="4714002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714005">server</span><span class="op" id="4714011">.</span><span class="ident" id="4714012">mu</span><span class="op" id="4714014">.</span><span class="ident" id="4714015">Lock</span><span class="op" id="4714019">(</span><span class="op" id="4714020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714023">defer</span>&nbsp;<span class="ident" id="4714029">server</span><span class="op" id="4714035">.</span><span class="ident" id="4714036">mu</span><span class="op" id="4714038">.</span><span class="ident" id="4714039">Unlock</span><span class="op" id="4714045">(</span><span class="op" id="4714046">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714049">if</span>&nbsp;<span class="ident" id="4714052">server</span><span class="op" id="4714058">.</span><span class="ident" id="4714059">serviceMap</span>&nbsp;<span class="op" id="4714070">==</span>&nbsp;<span class="ident" id="4714073">nil</span>&nbsp;<span class="op" id="4714077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714081">server</span><span class="op" id="4714087">.</span><span class="ident" id="4714088">serviceMap</span>&nbsp;<span class="op" id="4714099">=</span>&nbsp;<span class="builtinfunc" id="4714101">make</span><span class="op" id="4714105">(</span><span class="keyword" id="4714106">map</span><span class="op" id="4714109">[</span><span class="builtintype" id="4714110">string</span><span class="op" id="4714116">]</span><span class="op" id="4714117">*</span><span class="ident" id="4714118">service</span><span class="op" id="4714125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4714128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714131">s</span>&nbsp;<span class="op" id="4714133">:=</span>&nbsp;<span class="builtinfunc" id="4714136">new</span><span class="op" id="4714139">(</span><span class="ident" id="4714140">service</span><span class="op" id="4714147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714150">s</span><span class="op" id="4714151">.</span><span class="ident" id="4714152">typ</span>&nbsp;<span class="op" id="4714156">=</span>&nbsp;<span class="ident" id="4714158">reflect</span><span class="op" id="4714165">.</span><span class="ident" id="4714166">TypeOf</span><span class="op" id="4714172">(</span><span class="ident" id="4714173">rcvr</span><span class="op" id="4714177">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714180">s</span><span class="op" id="4714181">.</span><span class="ident" id="4714182">rcvr</span>&nbsp;<span class="op" id="4714187">=</span>&nbsp;<span class="ident" id="4714189">reflect</span><span class="op" id="4714196">.</span><span class="ident" id="4714197">ValueOf</span><span class="op" id="4714204">(</span><span class="ident" id="4714205">rcvr</span><span class="op" id="4714209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714212">sname</span>&nbsp;<span class="op" id="4714218">:=</span>&nbsp;<span class="ident" id="4714221">reflect</span><span class="op" id="4714228">.</span><span class="ident" id="4714229">Indirect</span><span class="op" id="4714237">(</span><span class="ident" id="4714238">s</span><span class="op" id="4714239">.</span><span class="ident" id="4714240">rcvr</span><span class="op" id="4714244">)</span><span class="op" id="4714245">.</span><span class="ident" id="4714246">Type</span><span class="op" id="4714250">(</span><span class="op" id="4714251">)</span><span class="op" id="4714252">.</span><span class="ident" id="4714253">Name</span><span class="op" id="4714257">(</span><span class="op" id="4714258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714261">if</span>&nbsp;<span class="ident" id="4714264">useName</span>&nbsp;<span class="op" id="4714272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714276">sname</span>&nbsp;<span class="op" id="4714282">=</span>&nbsp;<span class="ident" id="4714284">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4714290">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714293">if</span>&nbsp;<span class="ident" id="4714296">sname</span>&nbsp;<span class="op" id="4714302">==</span>&nbsp;<span class="string" id="4714305">&#34;&#34;</span>&nbsp;<span class="op" id="4714308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714312">s</span>&nbsp;<span class="op" id="4714314">:=</span>&nbsp;<span class="string" id="4714317">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4714359">+</span>&nbsp;<span class="ident" id="4714361">s</span><span class="op" id="4714362">.</span><span class="ident" id="4714363">typ</span><span class="op" id="4714366">.</span><span class="ident" id="4714367">String</span><span class="op" id="4714373">(</span><span class="op" id="4714374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714378">log</span><span class="op" id="4714381">.</span><span class="ident" id="4714382">Print</span><span class="op" id="4714387">(</span><span class="ident" id="4714388">s</span><span class="op" id="4714389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714393">return</span>&nbsp;<span class="ident" id="4714400">errors</span><span class="op" id="4714406">.</span><span class="ident" id="4714407">New</span><span class="op" id="4714410">(</span><span class="ident" id="4714411">s</span><span class="op" id="4714412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4714415">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714418">if</span>&nbsp;<span class="op" id="4714421">!</span><span class="ident" id="4714422">isExported</span><span class="op" id="4714432">(</span><span class="ident" id="4714433">sname</span><span class="op" id="4714438">)</span>&nbsp;<span class="op" id="4714440">&amp;&amp;</span>&nbsp;<span class="op" id="4714443">!</span><span class="ident" id="4714444">useName</span>&nbsp;<span class="op" id="4714452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714456">s</span>&nbsp;<span class="op" id="4714458">:=</span>&nbsp;<span class="string" id="4714461">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4714483">+</span>&nbsp;<span class="ident" id="4714485">sname</span>&nbsp;<span class="op" id="4714491">+</span>&nbsp;<span class="string" id="4714493">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714514">log</span><span class="op" id="4714517">.</span><span class="ident" id="4714518">Print</span><span class="op" id="4714523">(</span><span class="ident" id="4714524">s</span><span class="op" id="4714525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714529">return</span>&nbsp;<span class="ident" id="4714536">errors</span><span class="op" id="4714542">.</span><span class="ident" id="4714543">New</span><span class="op" id="4714546">(</span><span class="ident" id="4714547">s</span><span class="op" id="4714548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4714551">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714554">if</span>&nbsp;<span class="ident" id="4714557">_</span><span class="op" id="4714558">,</span>&nbsp;<span class="ident" id="4714560">present</span>&nbsp;<span class="op" id="4714568">:=</span>&nbsp;<span class="ident" id="4714571">server</span><span class="op" id="4714577">.</span><span class="ident" id="4714578">serviceMap</span><span class="op" id="4714588">[</span><span class="ident" id="4714589">sname</span><span class="op" id="4714594">]</span><span class="op" id="4714595">;</span>&nbsp;<span class="ident" id="4714597">present</span>&nbsp;<span class="op" id="4714605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714609">return</span>&nbsp;<span class="ident" id="4714616">errors</span><span class="op" id="4714622">.</span><span class="ident" id="4714623">New</span><span class="op" id="4714626">(</span><span class="string" id="4714627">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="4714660">+</span>&nbsp;<span class="ident" id="4714662">sname</span><span class="op" id="4714667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4714670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714673">s</span><span class="op" id="4714674">.</span><span class="ident" id="4714675">name</span>&nbsp;<span class="op" id="4714680">=</span>&nbsp;<span class="ident" id="4714682">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4714690">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714714">s</span><span class="op" id="4714715">.</span><span class="ident" id="4714716">method</span>&nbsp;<span class="op" id="4714723">=</span>&nbsp;<span class="ident" id="4714725">suitableMethods</span><span class="op" id="4714740">(</span><span class="ident" id="4714741">s</span><span class="op" id="4714742">.</span><span class="ident" id="4714743">typ</span><span class="op" id="4714746">,</span>&nbsp;<span class="builtintype" id="4714748">true</span><span class="op" id="4714752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714756">if</span>&nbsp;<span class="builtinfunc" id="4714759">len</span><span class="op" id="4714762">(</span><span class="ident" id="4714763">s</span><span class="op" id="4714764">.</span><span class="ident" id="4714765">method</span><span class="op" id="4714771">)</span>&nbsp;<span class="op" id="4714773">==</span>&nbsp;<span class="num" id="4714776">0</span>&nbsp;<span class="op" id="4714778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714782">str</span>&nbsp;<span class="op" id="4714786">:=</span>&nbsp;<span class="string" id="4714789">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4714795">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714856">method</span>&nbsp;<span class="op" id="4714863">:=</span>&nbsp;<span class="ident" id="4714866">suitableMethods</span><span class="op" id="4714881">(</span><span class="ident" id="4714882">reflect</span><span class="op" id="4714889">.</span><span class="ident" id="4714890">PtrTo</span><span class="op" id="4714895">(</span><span class="ident" id="4714896">s</span><span class="op" id="4714897">.</span><span class="ident" id="4714898">typ</span><span class="op" id="4714901">)</span><span class="op" id="4714902">,</span>&nbsp;<span class="builtintype" id="4714904">false</span><span class="op" id="4714909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4714913">if</span>&nbsp;<span class="builtinfunc" id="4714916">len</span><span class="op" id="4714919">(</span><span class="ident" id="4714920">method</span><span class="op" id="4714926">)</span>&nbsp;<span class="op" id="4714928">!=</span>&nbsp;<span class="num" id="4714931">0</span>&nbsp;<span class="op" id="4714933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4714938">str</span>&nbsp;<span class="op" id="4714942">=</span>&nbsp;<span class="string" id="4714944">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4714966">+</span>&nbsp;<span class="ident" id="4714968">sname</span>&nbsp;<span class="op" id="4714974">+</span>&nbsp;<span class="string" id="4714976">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715067">}</span>&nbsp;<span class="keyword" id="4715069">else</span>&nbsp;<span class="op" id="4715074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715079">str</span>&nbsp;<span class="op" id="4715083">=</span>&nbsp;<span class="string" id="4715085">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="4715107">+</span>&nbsp;<span class="ident" id="4715109">sname</span>&nbsp;<span class="op" id="4715115">+</span>&nbsp;<span class="string" id="4715117">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715167">log</span><span class="op" id="4715170">.</span><span class="ident" id="4715171">Print</span><span class="op" id="4715176">(</span><span class="ident" id="4715177">str</span><span class="op" id="4715180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715184">return</span>&nbsp;<span class="ident" id="4715191">errors</span><span class="op" id="4715197">.</span><span class="ident" id="4715198">New</span><span class="op" id="4715201">(</span><span class="ident" id="4715202">str</span><span class="op" id="4715205">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715211">server</span><span class="op" id="4715217">.</span><span class="ident" id="4715218">serviceMap</span><span class="op" id="4715228">[</span><span class="ident" id="4715229">s</span><span class="op" id="4715230">.</span><span class="ident" id="4715231">name</span><span class="op" id="4715235">]</span>&nbsp;<span class="op" id="4715237">=</span>&nbsp;<span class="ident" id="4715239">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715242">return</span>&nbsp;<span class="ident" id="4715249">nil</span><br>
<span class="lineno"></span><span class="op" id="4715253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="4715256">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="4715327">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="4715368">func</span>&nbsp;<span class="ident" id="4715373">suitableMethods</span><span class="op" id="4715388">(</span><span class="ident" id="4715389">typ</span>&nbsp;<span class="ident" id="4715393">reflect</span><span class="op" id="4715400">.</span><span class="ident" id="4715401">Type</span><span class="op" id="4715405">,</span>&nbsp;<span class="ident" id="4715407">reportErr</span>&nbsp;<span class="builtintype" id="4715417">bool</span><span class="op" id="4715421">)</span>&nbsp;<span class="keyword" id="4715423">map</span><span class="op" id="4715426">[</span><span class="builtintype" id="4715427">string</span><span class="op" id="4715433">]</span><span class="op" id="4715434">*</span><span class="ident" id="4715435">methodType</span>&nbsp;<span class="op" id="4715446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715449">methods</span>&nbsp;<span class="op" id="4715457">:=</span>&nbsp;<span class="builtinfunc" id="4715460">make</span><span class="op" id="4715464">(</span><span class="keyword" id="4715465">map</span><span class="op" id="4715468">[</span><span class="builtintype" id="4715469">string</span><span class="op" id="4715475">]</span><span class="op" id="4715476">*</span><span class="ident" id="4715477">methodType</span><span class="op" id="4715487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715490">for</span>&nbsp;<span class="ident" id="4715494">m</span>&nbsp;<span class="op" id="4715496">:=</span>&nbsp;<span class="num" id="4715499">0</span><span class="op" id="4715500">;</span>&nbsp;<span class="ident" id="4715502">m</span>&nbsp;<span class="op" id="4715504">&lt;</span>&nbsp;<span class="ident" id="4715506">typ</span><span class="op" id="4715509">.</span><span class="ident" id="4715510">NumMethod</span><span class="op" id="4715519">(</span><span class="op" id="4715520">)</span><span class="op" id="4715521">;</span>&nbsp;<span class="ident" id="4715523">m</span><span class="op" id="4715524">++</span>&nbsp;<span class="op" id="4715527">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715531">method</span>&nbsp;<span class="op" id="4715538">:=</span>&nbsp;<span class="ident" id="4715541">typ</span><span class="op" id="4715544">.</span><span class="ident" id="4715545">Method</span><span class="op" id="4715551">(</span><span class="ident" id="4715552">m</span><span class="op" id="4715553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715557">mtype</span>&nbsp;<span class="op" id="4715563">:=</span>&nbsp;<span class="ident" id="4715566">method</span><span class="op" id="4715572">.</span><span class="ident" id="4715573">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715580">mname</span>&nbsp;<span class="op" id="4715586">:=</span>&nbsp;<span class="ident" id="4715589">method</span><span class="op" id="4715595">.</span><span class="ident" id="4715596">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4715603">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715633">if</span>&nbsp;<span class="ident" id="4715636">method</span><span class="op" id="4715642">.</span><span class="ident" id="4715643">PkgPath</span>&nbsp;<span class="op" id="4715651">!=</span>&nbsp;<span class="string" id="4715654">&#34;&#34;</span>&nbsp;<span class="op" id="4715657">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715662">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4715677">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715731">if</span>&nbsp;<span class="ident" id="4715734">mtype</span><span class="op" id="4715739">.</span><span class="ident" id="4715740">NumIn</span><span class="op" id="4715745">(</span><span class="op" id="4715746">)</span>&nbsp;<span class="op" id="4715748">!=</span>&nbsp;<span class="num" id="4715751">3</span>&nbsp;<span class="op" id="4715753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715758">if</span>&nbsp;<span class="ident" id="4715761">reportErr</span>&nbsp;<span class="op" id="4715771">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715777">log</span><span class="op" id="4715780">.</span><span class="ident" id="4715781">Println</span><span class="op" id="4715788">(</span><span class="string" id="4715789">&#34;method&#34;</span><span class="op" id="4715797">,</span>&nbsp;<span class="ident" id="4715799">mname</span><span class="op" id="4715804">,</span>&nbsp;<span class="string" id="4715806">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="4715832">,</span>&nbsp;<span class="ident" id="4715834">mtype</span><span class="op" id="4715839">.</span><span class="ident" id="4715840">NumIn</span><span class="op" id="4715845">(</span><span class="op" id="4715846">)</span><span class="op" id="4715847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715857">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4715868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4715872">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715910">argType</span>&nbsp;<span class="op" id="4715918">:=</span>&nbsp;<span class="ident" id="4715921">mtype</span><span class="op" id="4715926">.</span><span class="ident" id="4715927">In</span><span class="op" id="4715929">(</span><span class="num" id="4715930">1</span><span class="op" id="4715931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715935">if</span>&nbsp;<span class="op" id="4715938">!</span><span class="ident" id="4715939">isExportedOrBuiltinType</span><span class="op" id="4715962">(</span><span class="ident" id="4715963">argType</span><span class="op" id="4715970">)</span>&nbsp;<span class="op" id="4715972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4715977">if</span>&nbsp;<span class="ident" id="4715980">reportErr</span>&nbsp;<span class="op" id="4715990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4715996">log</span><span class="op" id="4715999">.</span><span class="ident" id="4716000">Println</span><span class="op" id="4716007">(</span><span class="ident" id="4716008">mname</span><span class="op" id="4716013">,</span>&nbsp;<span class="string" id="4716015">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4716044">,</span>&nbsp;<span class="ident" id="4716046">argType</span><span class="op" id="4716053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716058">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716063">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716078">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716113">replyType</span>&nbsp;<span class="op" id="4716123">:=</span>&nbsp;<span class="ident" id="4716126">mtype</span><span class="op" id="4716131">.</span><span class="ident" id="4716132">In</span><span class="op" id="4716134">(</span><span class="num" id="4716135">2</span><span class="op" id="4716136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716140">if</span>&nbsp;<span class="ident" id="4716143">replyType</span><span class="op" id="4716152">.</span><span class="ident" id="4716153">Kind</span><span class="op" id="4716157">(</span><span class="op" id="4716158">)</span>&nbsp;<span class="op" id="4716160">!=</span>&nbsp;<span class="ident" id="4716163">reflect</span><span class="op" id="4716170">.</span><span class="ident" id="4716171">Ptr</span>&nbsp;<span class="op" id="4716175">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716180">if</span>&nbsp;<span class="ident" id="4716183">reportErr</span>&nbsp;<span class="op" id="4716193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716199">log</span><span class="op" id="4716202">.</span><span class="ident" id="4716203">Println</span><span class="op" id="4716210">(</span><span class="string" id="4716211">&#34;method&#34;</span><span class="op" id="4716219">,</span>&nbsp;<span class="ident" id="4716221">mname</span><span class="op" id="4716226">,</span>&nbsp;<span class="string" id="4716228">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="4716255">,</span>&nbsp;<span class="ident" id="4716257">replyType</span><span class="op" id="4716266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716276">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716287">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716291">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716325">if</span>&nbsp;<span class="op" id="4716328">!</span><span class="ident" id="4716329">isExportedOrBuiltinType</span><span class="op" id="4716352">(</span><span class="ident" id="4716353">replyType</span><span class="op" id="4716362">)</span>&nbsp;<span class="op" id="4716364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716369">if</span>&nbsp;<span class="ident" id="4716372">reportErr</span>&nbsp;<span class="op" id="4716382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716388">log</span><span class="op" id="4716391">.</span><span class="ident" id="4716392">Println</span><span class="op" id="4716399">(</span><span class="string" id="4716400">&#34;method&#34;</span><span class="op" id="4716408">,</span>&nbsp;<span class="ident" id="4716410">mname</span><span class="op" id="4716415">,</span>&nbsp;<span class="string" id="4716417">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="4716443">,</span>&nbsp;<span class="ident" id="4716445">replyType</span><span class="op" id="4716454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716459">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716464">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716479">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716506">if</span>&nbsp;<span class="ident" id="4716509">mtype</span><span class="op" id="4716514">.</span><span class="ident" id="4716515">NumOut</span><span class="op" id="4716521">(</span><span class="op" id="4716522">)</span>&nbsp;<span class="op" id="4716524">!=</span>&nbsp;<span class="num" id="4716527">1</span>&nbsp;<span class="op" id="4716529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716534">if</span>&nbsp;<span class="ident" id="4716537">reportErr</span>&nbsp;<span class="op" id="4716547">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716553">log</span><span class="op" id="4716556">.</span><span class="ident" id="4716557">Println</span><span class="op" id="4716564">(</span><span class="string" id="4716565">&#34;method&#34;</span><span class="op" id="4716573">,</span>&nbsp;<span class="ident" id="4716575">mname</span><span class="op" id="4716580">,</span>&nbsp;<span class="string" id="4716582">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="4716609">,</span>&nbsp;<span class="ident" id="4716611">mtype</span><span class="op" id="4716616">.</span><span class="ident" id="4716617">NumOut</span><span class="op" id="4716623">(</span><span class="op" id="4716624">)</span><span class="op" id="4716625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716635">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4716650">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716700">if</span>&nbsp;<span class="ident" id="4716703">returnType</span>&nbsp;<span class="op" id="4716714">:=</span>&nbsp;<span class="ident" id="4716717">mtype</span><span class="op" id="4716722">.</span><span class="ident" id="4716723">Out</span><span class="op" id="4716726">(</span><span class="num" id="4716727">0</span><span class="op" id="4716728">)</span><span class="op" id="4716729">;</span>&nbsp;<span class="ident" id="4716731">returnType</span>&nbsp;<span class="op" id="4716742">!=</span>&nbsp;<span class="ident" id="4716745">typeOfError</span>&nbsp;<span class="op" id="4716757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716762">if</span>&nbsp;<span class="ident" id="4716765">reportErr</span>&nbsp;<span class="op" id="4716775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716781">log</span><span class="op" id="4716784">.</span><span class="ident" id="4716785">Println</span><span class="op" id="4716792">(</span><span class="string" id="4716793">&#34;method&#34;</span><span class="op" id="4716801">,</span>&nbsp;<span class="ident" id="4716803">mname</span><span class="op" id="4716808">,</span>&nbsp;<span class="string" id="4716810">&#34;returns&#34;</span><span class="op" id="4716819">,</span>&nbsp;<span class="ident" id="4716821">returnType</span><span class="op" id="4716831">.</span><span class="ident" id="4716832">String</span><span class="op" id="4716838">(</span><span class="op" id="4716839">)</span><span class="op" id="4716840">,</span>&nbsp;<span class="string" id="4716842">&#34;not&nbsp;error&#34;</span><span class="op" id="4716853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716863">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4716878">methods</span><span class="op" id="4716885">[</span><span class="ident" id="4716886">mname</span><span class="op" id="4716891">]</span>&nbsp;<span class="op" id="4716893">=</span>&nbsp;<span class="op" id="4716895">&amp;</span><span class="ident" id="4716896">methodType</span><span class="op" id="4716906">{</span><span class="ident" id="4716907">method</span><span class="op" id="4716913">:</span>&nbsp;<span class="ident" id="4716915">method</span><span class="op" id="4716921">,</span>&nbsp;<span class="ident" id="4716923">ArgType</span><span class="op" id="4716930">:</span>&nbsp;<span class="ident" id="4716932">argType</span><span class="op" id="4716939">,</span>&nbsp;<span class="ident" id="4716941">ReplyType</span><span class="op" id="4716950">:</span>&nbsp;<span class="ident" id="4716952">replyType</span><span class="op" id="4716961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4716964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4716967">return</span>&nbsp;<span class="ident" id="4716974">methods</span><br>
<span class="lineno"></span><span class="op" id="4716982">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="4716985">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="4717066">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="4717151">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="4717189">var</span>&nbsp;<span class="ident" id="4717193">invalidRequest</span>&nbsp;<span class="op" id="4717208">=</span>&nbsp;<span class="keyword" id="4717210">struct</span><span class="op" id="4717216">{</span><span class="op" id="4717217">}</span><span class="op" id="4717218">{</span><span class="op" id="4717219">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="4717222">func</span>&nbsp;<span class="op" id="4717227">(</span><span class="ident" id="4717228">server</span>&nbsp;<span class="op" id="4717235">*</span><span class="ident" id="4717236">Server</span><span class="op" id="4717242">)</span>&nbsp;<span class="ident" id="4717244">sendResponse</span><span class="op" id="4717256">(</span><span class="ident" id="4717257">sending</span>&nbsp;<span class="op" id="4717265">*</span><span class="ident" id="4717266">sync</span><span class="op" id="4717270">.</span><span class="ident" id="4717271">Mutex</span><span class="op" id="4717276">,</span>&nbsp;<span class="ident" id="4717278">req</span>&nbsp;<span class="op" id="4717282">*</span><span class="ident" id="4717283">Request</span><span class="op" id="4717290">,</span>&nbsp;<span class="ident" id="4717292">reply</span>&nbsp;<span class="keyword" id="4717298">interface</span><span class="op" id="4717307">{</span><span class="op" id="4717308">}</span><span class="op" id="4717309">,</span>&nbsp;<span class="ident" id="4717311">codec</span>&nbsp;<span class="ident" id="4717317">ServerCodec</span><span class="op" id="4717328">,</span>&nbsp;<span class="ident" id="4717330">errmsg</span>&nbsp;<span class="builtintype" id="4717337">string</span><span class="op" id="4717343">)</span>&nbsp;<span class="op" id="4717345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717348">resp</span>&nbsp;<span class="op" id="4717353">:=</span>&nbsp;<span class="ident" id="4717356">server</span><span class="op" id="4717362">.</span><span class="ident" id="4717363">getResponse</span><span class="op" id="4717374">(</span><span class="op" id="4717375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4717378">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717409">resp</span><span class="op" id="4717413">.</span><span class="ident" id="4717414">ServiceMethod</span>&nbsp;<span class="op" id="4717428">=</span>&nbsp;<span class="ident" id="4717430">req</span><span class="op" id="4717433">.</span><span class="ident" id="4717434">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717449">if</span>&nbsp;<span class="ident" id="4717452">errmsg</span>&nbsp;<span class="op" id="4717459">!=</span>&nbsp;<span class="string" id="4717462">&#34;&#34;</span>&nbsp;<span class="op" id="4717465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717469">resp</span><span class="op" id="4717473">.</span><span class="ident" id="4717474">Error</span>&nbsp;<span class="op" id="4717480">=</span>&nbsp;<span class="ident" id="4717482">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717491">reply</span>&nbsp;<span class="op" id="4717497">=</span>&nbsp;<span class="ident" id="4717499">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717518">resp</span><span class="op" id="4717522">.</span><span class="ident" id="4717523">Seq</span>&nbsp;<span class="op" id="4717527">=</span>&nbsp;<span class="ident" id="4717529">req</span><span class="op" id="4717532">.</span><span class="ident" id="4717533">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717538">sending</span><span class="op" id="4717545">.</span><span class="ident" id="4717546">Lock</span><span class="op" id="4717550">(</span><span class="op" id="4717551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717554">err</span>&nbsp;<span class="op" id="4717558">:=</span>&nbsp;<span class="ident" id="4717561">codec</span><span class="op" id="4717566">.</span><span class="ident" id="4717567">WriteResponse</span><span class="op" id="4717580">(</span><span class="ident" id="4717581">resp</span><span class="op" id="4717585">,</span>&nbsp;<span class="ident" id="4717587">reply</span><span class="op" id="4717592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717595">if</span>&nbsp;<span class="ident" id="4717598">debugLog</span>&nbsp;<span class="op" id="4717607">&amp;&amp;</span>&nbsp;<span class="ident" id="4717610">err</span>&nbsp;<span class="op" id="4717614">!=</span>&nbsp;<span class="ident" id="4717617">nil</span>&nbsp;<span class="op" id="4717621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717625">log</span><span class="op" id="4717628">.</span><span class="ident" id="4717629">Println</span><span class="op" id="4717636">(</span><span class="string" id="4717637">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="4717661">,</span>&nbsp;<span class="ident" id="4717663">err</span><span class="op" id="4717666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4717669">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717672">sending</span><span class="op" id="4717679">.</span><span class="ident" id="4717680">Unlock</span><span class="op" id="4717686">(</span><span class="op" id="4717687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717690">server</span><span class="op" id="4717696">.</span><span class="ident" id="4717697">freeResponse</span><span class="op" id="4717709">(</span><span class="ident" id="4717710">resp</span><span class="op" id="4717714">)</span><br>
<span class="lineno"></span><span class="op" id="4717716">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4717719">func</span>&nbsp;<span class="op" id="4717724">(</span><span class="ident" id="4717725">m</span>&nbsp;<span class="op" id="4717727">*</span><span class="ident" id="4717728">methodType</span><span class="op" id="4717738">)</span>&nbsp;<span class="ident" id="4717740">NumCalls</span><span class="op" id="4717748">(</span><span class="op" id="4717749">)</span>&nbsp;<span class="op" id="4717751">(</span><span class="ident" id="4717752">n</span>&nbsp;<span class="builtintype" id="4717754">uint</span><span class="op" id="4717758">)</span>&nbsp;<span class="op" id="4717760">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717763">m</span><span class="op" id="4717764">.</span><span class="ident" id="4717765">Lock</span><span class="op" id="4717769">(</span><span class="op" id="4717770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717773">n</span>&nbsp;<span class="op" id="4717775">=</span>&nbsp;<span class="ident" id="4717777">m</span><span class="op" id="4717778">.</span><span class="ident" id="4717779">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717789">m</span><span class="op" id="4717790">.</span><span class="ident" id="4717791">Unlock</span><span class="op" id="4717797">(</span><span class="op" id="4717798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4717801">return</span>&nbsp;<span class="ident" id="4717808">n</span><br>
<span class="lineno"></span><span class="op" id="4717810">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="4717813">func</span>&nbsp;<span class="op" id="4717818">(</span><span class="ident" id="4717819">s</span>&nbsp;<span class="op" id="4717821">*</span><span class="ident" id="4717822">service</span><span class="op" id="4717829">)</span>&nbsp;<span class="ident" id="4717831">call</span><span class="op" id="4717835">(</span><span class="ident" id="4717836">server</span>&nbsp;<span class="op" id="4717843">*</span><span class="ident" id="4717844">Server</span><span class="op" id="4717850">,</span>&nbsp;<span class="ident" id="4717852">sending</span>&nbsp;<span class="op" id="4717860">*</span><span class="ident" id="4717861">sync</span><span class="op" id="4717865">.</span><span class="ident" id="4717866">Mutex</span><span class="op" id="4717871">,</span>&nbsp;<span class="ident" id="4717873">mtype</span>&nbsp;<span class="op" id="4717879">*</span><span class="ident" id="4717880">methodType</span><span class="op" id="4717890">,</span>&nbsp;<span class="ident" id="4717892">req</span>&nbsp;<span class="op" id="4717896">*</span><span class="ident" id="4717897">Request</span><span class="op" id="4717904">,</span>&nbsp;<span class="ident" id="4717906">argv</span><span class="op" id="4717910">,</span>&nbsp;<span class="ident" id="4717912">replyv</span>&nbsp;<span class="ident" id="4717919">reflect</span><span class="op" id="4717926">.</span><span class="ident" id="4717927">Value</span><span class="op" id="4717932">,</span>&nbsp;<span class="ident" id="4717934">codec</span>&nbsp;<span class="ident" id="4717940">ServerCodec</span><span class="op" id="4717951">)</span>&nbsp;<span class="op" id="4717953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717956">mtype</span><span class="op" id="4717961">.</span><span class="ident" id="4717962">Lock</span><span class="op" id="4717966">(</span><span class="op" id="4717967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717970">mtype</span><span class="op" id="4717975">.</span><span class="ident" id="4717976">numCalls</span><span class="op" id="4717984">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4717988">mtype</span><span class="op" id="4717993">.</span><span class="ident" id="4717994">Unlock</span><span class="op" id="4718000">(</span><span class="op" id="4718001">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718004">function</span>&nbsp;<span class="op" id="4718013">:=</span>&nbsp;<span class="ident" id="4718016">mtype</span><span class="op" id="4718021">.</span><span class="ident" id="4718022">method</span><span class="op" id="4718028">.</span><span class="ident" id="4718029">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718035">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718095">returnValues</span>&nbsp;<span class="op" id="4718108">:=</span>&nbsp;<span class="ident" id="4718111">function</span><span class="op" id="4718119">.</span><span class="ident" id="4718120">Call</span><span class="op" id="4718124">(</span><span class="op" id="4718125">[</span><span class="op" id="4718126">]</span><span class="ident" id="4718127">reflect</span><span class="op" id="4718134">.</span><span class="ident" id="4718135">Value</span><span class="op" id="4718140">{</span><span class="ident" id="4718141">s</span><span class="op" id="4718142">.</span><span class="ident" id="4718143">rcvr</span><span class="op" id="4718147">,</span>&nbsp;<span class="ident" id="4718149">argv</span><span class="op" id="4718153">,</span>&nbsp;<span class="ident" id="4718155">replyv</span><span class="op" id="4718161">}</span><span class="op" id="4718162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718165">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718214">errInter</span>&nbsp;<span class="op" id="4718223">:=</span>&nbsp;<span class="ident" id="4718226">returnValues</span><span class="op" id="4718238">[</span><span class="num" id="4718239">0</span><span class="op" id="4718240">]</span><span class="op" id="4718241">.</span><span class="ident" id="4718242">Interface</span><span class="op" id="4718251">(</span><span class="op" id="4718252">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718255">errmsg</span>&nbsp;<span class="op" id="4718262">:=</span>&nbsp;<span class="string" id="4718265">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718269">if</span>&nbsp;<span class="ident" id="4718272">errInter</span>&nbsp;<span class="op" id="4718281">!=</span>&nbsp;<span class="ident" id="4718284">nil</span>&nbsp;<span class="op" id="4718288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718292">errmsg</span>&nbsp;<span class="op" id="4718299">=</span>&nbsp;<span class="ident" id="4718301">errInter</span><span class="op" id="4718309">.</span><span class="op" id="4718310">(</span><span class="builtintype" id="4718311">error</span><span class="op" id="4718316">)</span><span class="op" id="4718317">.</span><span class="ident" id="4718318">Error</span><span class="op" id="4718323">(</span><span class="op" id="4718324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4718327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718330">server</span><span class="op" id="4718336">.</span><span class="ident" id="4718337">sendResponse</span><span class="op" id="4718349">(</span><span class="ident" id="4718350">sending</span><span class="op" id="4718357">,</span>&nbsp;<span class="ident" id="4718359">req</span><span class="op" id="4718362">,</span>&nbsp;<span class="ident" id="4718364">replyv</span><span class="op" id="4718370">.</span><span class="ident" id="4718371">Interface</span><span class="op" id="4718380">(</span><span class="op" id="4718381">)</span><span class="op" id="4718382">,</span>&nbsp;<span class="ident" id="4718384">codec</span><span class="op" id="4718389">,</span>&nbsp;<span class="ident" id="4718391">errmsg</span><span class="op" id="4718397">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718400">server</span><span class="op" id="4718406">.</span><span class="ident" id="4718407">freeRequest</span><span class="op" id="4718418">(</span><span class="ident" id="4718419">req</span><span class="op" id="4718422">)</span><br>
<span class="lineno"></span><span class="op" id="4718424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4718427">type</span>&nbsp;<span class="ident" id="4718432">gobServerCodec</span>&nbsp;<span class="keyword" id="4718447">struct</span>&nbsp;<span class="op" id="4718454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718457">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4718464">io</span><span class="op" id="4718466">.</span><span class="ident" id="4718467">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718484">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4718491">*</span><span class="ident" id="4718492">gob</span><span class="op" id="4718495">.</span><span class="ident" id="4718496">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718505">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4718512">*</span><span class="ident" id="4718513">gob</span><span class="op" id="4718516">.</span><span class="ident" id="4718517">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718526">encBuf</span>&nbsp;<span class="op" id="4718533">*</span><span class="ident" id="4718534">bufio</span><span class="op" id="4718539">.</span><span class="ident" id="4718540">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4718548">closed</span>&nbsp;<span class="builtintype" id="4718555">bool</span><br>
<span class="lineno"></span><span class="op" id="4718560">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="4718563">func</span>&nbsp;<span class="op" id="4718568">(</span><span class="ident" id="4718569">c</span>&nbsp;<span class="op" id="4718571">*</span><span class="ident" id="4718572">gobServerCodec</span><span class="op" id="4718586">)</span>&nbsp;<span class="ident" id="4718588">ReadRequestHeader</span><span class="op" id="4718605">(</span><span class="ident" id="4718606">r</span>&nbsp;<span class="op" id="4718608">*</span><span class="ident" id="4718609">Request</span><span class="op" id="4718616">)</span>&nbsp;<span class="builtintype" id="4718618">error</span>&nbsp;<span class="op" id="4718624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718627">return</span>&nbsp;<span class="ident" id="4718634">c</span><span class="op" id="4718635">.</span><span class="ident" id="4718636">dec</span><span class="op" id="4718639">.</span><span class="ident" id="4718640">Decode</span><span class="op" id="4718646">(</span><span class="ident" id="4718647">r</span><span class="op" id="4718648">)</span><br>
<span class="lineno"></span><span class="op" id="4718650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="4718653">func</span>&nbsp;<span class="op" id="4718658">(</span><span class="ident" id="4718659">c</span>&nbsp;<span class="op" id="4718661">*</span><span class="ident" id="4718662">gobServerCodec</span><span class="op" id="4718676">)</span>&nbsp;<span class="ident" id="4718678">ReadRequestBody</span><span class="op" id="4718693">(</span><span class="ident" id="4718694">body</span>&nbsp;<span class="keyword" id="4718699">interface</span><span class="op" id="4718708">{</span><span class="op" id="4718709">}</span><span class="op" id="4718710">)</span>&nbsp;<span class="builtintype" id="4718712">error</span>&nbsp;<span class="op" id="4718718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718721">return</span>&nbsp;<span class="ident" id="4718728">c</span><span class="op" id="4718729">.</span><span class="ident" id="4718730">dec</span><span class="op" id="4718733">.</span><span class="ident" id="4718734">Decode</span><span class="op" id="4718740">(</span><span class="ident" id="4718741">body</span><span class="op" id="4718745">)</span><br>
<span class="lineno"></span><span class="op" id="4718747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4718750">func</span>&nbsp;<span class="op" id="4718755">(</span><span class="ident" id="4718756">c</span>&nbsp;<span class="op" id="4718758">*</span><span class="ident" id="4718759">gobServerCodec</span><span class="op" id="4718773">)</span>&nbsp;<span class="ident" id="4718775">WriteResponse</span><span class="op" id="4718788">(</span><span class="ident" id="4718789">r</span>&nbsp;<span class="op" id="4718791">*</span><span class="ident" id="4718792">Response</span><span class="op" id="4718800">,</span>&nbsp;<span class="ident" id="4718802">body</span>&nbsp;<span class="keyword" id="4718807">interface</span><span class="op" id="4718816">{</span><span class="op" id="4718817">}</span><span class="op" id="4718818">)</span>&nbsp;<span class="op" id="4718820">(</span><span class="ident" id="4718821">err</span>&nbsp;<span class="builtintype" id="4718825">error</span><span class="op" id="4718830">)</span>&nbsp;<span class="op" id="4718832">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718835">if</span>&nbsp;<span class="ident" id="4718838">err</span>&nbsp;<span class="op" id="4718842">=</span>&nbsp;<span class="ident" id="4718844">c</span><span class="op" id="4718845">.</span><span class="ident" id="4718846">enc</span><span class="op" id="4718849">.</span><span class="ident" id="4718850">Encode</span><span class="op" id="4718856">(</span><span class="ident" id="4718857">r</span><span class="op" id="4718858">)</span><span class="op" id="4718859">;</span>&nbsp;<span class="ident" id="4718861">err</span>&nbsp;<span class="op" id="4718865">!=</span>&nbsp;<span class="ident" id="4718868">nil</span>&nbsp;<span class="op" id="4718872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4718876">if</span>&nbsp;<span class="ident" id="4718879">c</span><span class="op" id="4718880">.</span><span class="ident" id="4718881">encBuf</span><span class="op" id="4718887">.</span><span class="ident" id="4718888">Flush</span><span class="op" id="4718893">(</span><span class="op" id="4718894">)</span>&nbsp;<span class="op" id="4718896">==</span>&nbsp;<span class="ident" id="4718899">nil</span>&nbsp;<span class="op" id="4718903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718908">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4718980">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719052">log</span><span class="op" id="4719055">.</span><span class="ident" id="4719056">Println</span><span class="op" id="4719063">(</span><span class="string" id="4719064">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="4719099">,</span>&nbsp;<span class="ident" id="4719101">err</span><span class="op" id="4719104">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719109">c</span><span class="op" id="4719110">.</span><span class="ident" id="4719111">Close</span><span class="op" id="4719116">(</span><span class="op" id="4719117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719136">if</span>&nbsp;<span class="ident" id="4719139">err</span>&nbsp;<span class="op" id="4719143">=</span>&nbsp;<span class="ident" id="4719145">c</span><span class="op" id="4719146">.</span><span class="ident" id="4719147">enc</span><span class="op" id="4719150">.</span><span class="ident" id="4719151">Encode</span><span class="op" id="4719157">(</span><span class="ident" id="4719158">body</span><span class="op" id="4719162">)</span><span class="op" id="4719163">;</span>&nbsp;<span class="ident" id="4719165">err</span>&nbsp;<span class="op" id="4719169">!=</span>&nbsp;<span class="ident" id="4719172">nil</span>&nbsp;<span class="op" id="4719176">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719180">if</span>&nbsp;<span class="ident" id="4719183">c</span><span class="op" id="4719184">.</span><span class="ident" id="4719185">encBuf</span><span class="op" id="4719191">.</span><span class="ident" id="4719192">Flush</span><span class="op" id="4719197">(</span><span class="op" id="4719198">)</span>&nbsp;<span class="op" id="4719200">==</span>&nbsp;<span class="ident" id="4719203">nil</span>&nbsp;<span class="op" id="4719207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719212">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719287">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719359">log</span><span class="op" id="4719362">.</span><span class="ident" id="4719363">Println</span><span class="op" id="4719370">(</span><span class="string" id="4719371">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="4719402">,</span>&nbsp;<span class="ident" id="4719404">err</span><span class="op" id="4719407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719412">c</span><span class="op" id="4719413">.</span><span class="ident" id="4719414">Close</span><span class="op" id="4719419">(</span><span class="op" id="4719420">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719428">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719439">return</span>&nbsp;<span class="ident" id="4719446">c</span><span class="op" id="4719447">.</span><span class="ident" id="4719448">encBuf</span><span class="op" id="4719454">.</span><span class="ident" id="4719455">Flush</span><span class="op" id="4719460">(</span><span class="op" id="4719461">)</span><br>
<span class="lineno"></span><span class="op" id="4719463">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="4719466">func</span>&nbsp;<span class="op" id="4719471">(</span><span class="ident" id="4719472">c</span>&nbsp;<span class="op" id="4719474">*</span><span class="ident" id="4719475">gobServerCodec</span><span class="op" id="4719489">)</span>&nbsp;<span class="ident" id="4719491">Close</span><span class="op" id="4719496">(</span><span class="op" id="4719497">)</span>&nbsp;<span class="builtintype" id="4719499">error</span>&nbsp;<span class="op" id="4719505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719508">if</span>&nbsp;<span class="ident" id="4719511">c</span><span class="op" id="4719512">.</span><span class="ident" id="4719513">closed</span>&nbsp;<span class="op" id="4719520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4719524">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719596">return</span>&nbsp;<span class="ident" id="4719603">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4719608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4719611">c</span><span class="op" id="4719612">.</span><span class="ident" id="4719613">closed</span>&nbsp;<span class="op" id="4719620">=</span>&nbsp;<span class="builtintype" id="4719622">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4719628">return</span>&nbsp;<span class="ident" id="4719635">c</span><span class="op" id="4719636">.</span><span class="ident" id="4719637">rwc</span><span class="op" id="4719640">.</span><span class="ident" id="4719641">Close</span><span class="op" id="4719646">(</span><span class="op" id="4719647">)</span><br>
<span class="lineno"></span><span class="op" id="4719649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="4719652">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4719705">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4719776">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="4719837">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4719900">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="4719959">func</span>&nbsp;<span class="op" id="4719964">(</span><span class="ident" id="4719965">server</span>&nbsp;<span class="op" id="4719972">*</span><span class="ident" id="4719973">Server</span><span class="op" id="4719979">)</span>&nbsp;<span class="ident" id="4719981">ServeConn</span><span class="op" id="4719990">(</span><span class="ident" id="4719991">conn</span>&nbsp;<span class="ident" id="4719996">io</span><span class="op" id="4719998">.</span><span class="ident" id="4719999">ReadWriteCloser</span><span class="op" id="4720014">)</span>&nbsp;<span class="op" id="4720016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720019">buf</span>&nbsp;<span class="op" id="4720023">:=</span>&nbsp;<span class="ident" id="4720026">bufio</span><span class="op" id="4720031">.</span><span class="ident" id="4720032">NewWriter</span><span class="op" id="4720041">(</span><span class="ident" id="4720042">conn</span><span class="op" id="4720046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720049">srv</span>&nbsp;<span class="op" id="4720053">:=</span>&nbsp;<span class="op" id="4720056">&amp;</span><span class="ident" id="4720057">gobServerCodec</span><span class="op" id="4720071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720075">rwc</span><span class="op" id="4720078">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4720083">conn</span><span class="op" id="4720087">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720091">dec</span><span class="op" id="4720094">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4720099">gob</span><span class="op" id="4720102">.</span><span class="ident" id="4720103">NewDecoder</span><span class="op" id="4720113">(</span><span class="ident" id="4720114">conn</span><span class="op" id="4720118">)</span><span class="op" id="4720119">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720123">enc</span><span class="op" id="4720126">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4720131">gob</span><span class="op" id="4720134">.</span><span class="ident" id="4720135">NewEncoder</span><span class="op" id="4720145">(</span><span class="ident" id="4720146">buf</span><span class="op" id="4720149">)</span><span class="op" id="4720150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720154">encBuf</span><span class="op" id="4720160">:</span>&nbsp;<span class="ident" id="4720162">buf</span><span class="op" id="4720165">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720171">server</span><span class="op" id="4720177">.</span><span class="ident" id="4720178">ServeCodec</span><span class="op" id="4720188">(</span><span class="ident" id="4720189">srv</span><span class="op" id="4720192">)</span><br>
<span class="lineno"></span><span class="op" id="4720194">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="4720197">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4720261">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4720302">func</span>&nbsp;<span class="op" id="4720307">(</span><span class="ident" id="4720308">server</span>&nbsp;<span class="op" id="4720315">*</span><span class="ident" id="4720316">Server</span><span class="op" id="4720322">)</span>&nbsp;<span class="ident" id="4720324">ServeCodec</span><span class="op" id="4720334">(</span><span class="ident" id="4720335">codec</span>&nbsp;<span class="ident" id="4720341">ServerCodec</span><span class="op" id="4720352">)</span>&nbsp;<span class="op" id="4720354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720357">sending</span>&nbsp;<span class="op" id="4720365">:=</span>&nbsp;<span class="builtinfunc" id="4720368">new</span><span class="op" id="4720371">(</span><span class="ident" id="4720372">sync</span><span class="op" id="4720376">.</span><span class="ident" id="4720377">Mutex</span><span class="op" id="4720382">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720385">for</span>&nbsp;<span class="op" id="4720389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720393">service</span><span class="op" id="4720400">,</span>&nbsp;<span class="ident" id="4720402">mtype</span><span class="op" id="4720407">,</span>&nbsp;<span class="ident" id="4720409">req</span><span class="op" id="4720412">,</span>&nbsp;<span class="ident" id="4720414">argv</span><span class="op" id="4720418">,</span>&nbsp;<span class="ident" id="4720420">replyv</span><span class="op" id="4720426">,</span>&nbsp;<span class="ident" id="4720428">keepReading</span><span class="op" id="4720439">,</span>&nbsp;<span class="ident" id="4720441">err</span>&nbsp;<span class="op" id="4720445">:=</span>&nbsp;<span class="ident" id="4720448">server</span><span class="op" id="4720454">.</span><span class="ident" id="4720455">readRequest</span><span class="op" id="4720466">(</span><span class="ident" id="4720467">codec</span><span class="op" id="4720472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720476">if</span>&nbsp;<span class="ident" id="4720479">err</span>&nbsp;<span class="op" id="4720483">!=</span>&nbsp;<span class="ident" id="4720486">nil</span>&nbsp;<span class="op" id="4720490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720495">if</span>&nbsp;<span class="ident" id="4720498">debugLog</span>&nbsp;<span class="op" id="4720507">&amp;&amp;</span>&nbsp;<span class="ident" id="4720510">err</span>&nbsp;<span class="op" id="4720514">!=</span>&nbsp;<span class="ident" id="4720517">io</span><span class="op" id="4720519">.</span><span class="ident" id="4720520">EOF</span>&nbsp;<span class="op" id="4720524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720530">log</span><span class="op" id="4720533">.</span><span class="ident" id="4720534">Println</span><span class="op" id="4720541">(</span><span class="string" id="4720542">&#34;rpc:&#34;</span><span class="op" id="4720548">,</span>&nbsp;<span class="ident" id="4720550">err</span><span class="op" id="4720553">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720563">if</span>&nbsp;<span class="op" id="4720566">!</span><span class="ident" id="4720567">keepReading</span>&nbsp;<span class="op" id="4720579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720585">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4720599">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720662">if</span>&nbsp;<span class="ident" id="4720665">req</span>&nbsp;<span class="op" id="4720669">!=</span>&nbsp;<span class="ident" id="4720672">nil</span>&nbsp;<span class="op" id="4720676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720682">server</span><span class="op" id="4720688">.</span><span class="ident" id="4720689">sendResponse</span><span class="op" id="4720701">(</span><span class="ident" id="4720702">sending</span><span class="op" id="4720709">,</span>&nbsp;<span class="ident" id="4720711">req</span><span class="op" id="4720714">,</span>&nbsp;<span class="ident" id="4720716">invalidRequest</span><span class="op" id="4720730">,</span>&nbsp;<span class="ident" id="4720732">codec</span><span class="op" id="4720737">,</span>&nbsp;<span class="ident" id="4720739">err</span><span class="op" id="4720742">.</span><span class="ident" id="4720743">Error</span><span class="op" id="4720748">(</span><span class="op" id="4720749">)</span><span class="op" id="4720750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720756">server</span><span class="op" id="4720762">.</span><span class="ident" id="4720763">freeRequest</span><span class="op" id="4720774">(</span><span class="ident" id="4720775">req</span><span class="op" id="4720778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720788">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4720803">go</span>&nbsp;<span class="ident" id="4720806">service</span><span class="op" id="4720813">.</span><span class="ident" id="4720814">call</span><span class="op" id="4720818">(</span><span class="ident" id="4720819">server</span><span class="op" id="4720825">,</span>&nbsp;<span class="ident" id="4720827">sending</span><span class="op" id="4720834">,</span>&nbsp;<span class="ident" id="4720836">mtype</span><span class="op" id="4720841">,</span>&nbsp;<span class="ident" id="4720843">req</span><span class="op" id="4720846">,</span>&nbsp;<span class="ident" id="4720848">argv</span><span class="op" id="4720852">,</span>&nbsp;<span class="ident" id="4720854">replyv</span><span class="op" id="4720860">,</span>&nbsp;<span class="ident" id="4720862">codec</span><span class="op" id="4720867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4720870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4720873">codec</span><span class="op" id="4720878">.</span><span class="ident" id="4720879">Close</span><span class="op" id="4720884">(</span><span class="op" id="4720885">)</span><br>
<span class="lineno"></span><span class="op" id="4720887">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="4720890">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4720968">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="4721016">func</span>&nbsp;<span class="op" id="4721021">(</span><span class="ident" id="4721022">server</span>&nbsp;<span class="op" id="4721029">*</span><span class="ident" id="4721030">Server</span><span class="op" id="4721036">)</span>&nbsp;<span class="ident" id="4721038">ServeRequest</span><span class="op" id="4721050">(</span><span class="ident" id="4721051">codec</span>&nbsp;<span class="ident" id="4721057">ServerCodec</span><span class="op" id="4721068">)</span>&nbsp;<span class="builtintype" id="4721070">error</span>&nbsp;<span class="op" id="4721076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721079">sending</span>&nbsp;<span class="op" id="4721087">:=</span>&nbsp;<span class="builtinfunc" id="4721090">new</span><span class="op" id="4721093">(</span><span class="ident" id="4721094">sync</span><span class="op" id="4721098">.</span><span class="ident" id="4721099">Mutex</span><span class="op" id="4721104">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721107">service</span><span class="op" id="4721114">,</span>&nbsp;<span class="ident" id="4721116">mtype</span><span class="op" id="4721121">,</span>&nbsp;<span class="ident" id="4721123">req</span><span class="op" id="4721126">,</span>&nbsp;<span class="ident" id="4721128">argv</span><span class="op" id="4721132">,</span>&nbsp;<span class="ident" id="4721134">replyv</span><span class="op" id="4721140">,</span>&nbsp;<span class="ident" id="4721142">keepReading</span><span class="op" id="4721153">,</span>&nbsp;<span class="ident" id="4721155">err</span>&nbsp;<span class="op" id="4721159">:=</span>&nbsp;<span class="ident" id="4721162">server</span><span class="op" id="4721168">.</span><span class="ident" id="4721169">readRequest</span><span class="op" id="4721180">(</span><span class="ident" id="4721181">codec</span><span class="op" id="4721186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721189">if</span>&nbsp;<span class="ident" id="4721192">err</span>&nbsp;<span class="op" id="4721196">!=</span>&nbsp;<span class="ident" id="4721199">nil</span>&nbsp;<span class="op" id="4721203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721207">if</span>&nbsp;<span class="op" id="4721210">!</span><span class="ident" id="4721211">keepReading</span>&nbsp;<span class="op" id="4721223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721228">return</span>&nbsp;<span class="ident" id="4721235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721241">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4721245">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721307">if</span>&nbsp;<span class="ident" id="4721310">req</span>&nbsp;<span class="op" id="4721314">!=</span>&nbsp;<span class="ident" id="4721317">nil</span>&nbsp;<span class="op" id="4721321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721326">server</span><span class="op" id="4721332">.</span><span class="ident" id="4721333">sendResponse</span><span class="op" id="4721345">(</span><span class="ident" id="4721346">sending</span><span class="op" id="4721353">,</span>&nbsp;<span class="ident" id="4721355">req</span><span class="op" id="4721358">,</span>&nbsp;<span class="ident" id="4721360">invalidRequest</span><span class="op" id="4721374">,</span>&nbsp;<span class="ident" id="4721376">codec</span><span class="op" id="4721381">,</span>&nbsp;<span class="ident" id="4721383">err</span><span class="op" id="4721386">.</span><span class="ident" id="4721387">Error</span><span class="op" id="4721392">(</span><span class="op" id="4721393">)</span><span class="op" id="4721394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721399">server</span><span class="op" id="4721405">.</span><span class="ident" id="4721406">freeRequest</span><span class="op" id="4721417">(</span><span class="ident" id="4721418">req</span><span class="op" id="4721421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721425">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721429">return</span>&nbsp;<span class="ident" id="4721436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721444">service</span><span class="op" id="4721451">.</span><span class="ident" id="4721452">call</span><span class="op" id="4721456">(</span><span class="ident" id="4721457">server</span><span class="op" id="4721463">,</span>&nbsp;<span class="ident" id="4721465">sending</span><span class="op" id="4721472">,</span>&nbsp;<span class="ident" id="4721474">mtype</span><span class="op" id="4721479">,</span>&nbsp;<span class="ident" id="4721481">req</span><span class="op" id="4721484">,</span>&nbsp;<span class="ident" id="4721486">argv</span><span class="op" id="4721490">,</span>&nbsp;<span class="ident" id="4721492">replyv</span><span class="op" id="4721498">,</span>&nbsp;<span class="ident" id="4721500">codec</span><span class="op" id="4721505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721508">return</span>&nbsp;<span class="ident" id="4721515">nil</span><br>
<span class="lineno"></span><span class="op" id="4721519">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="4721522">func</span>&nbsp;<span class="op" id="4721527">(</span><span class="ident" id="4721528">server</span>&nbsp;<span class="op" id="4721535">*</span><span class="ident" id="4721536">Server</span><span class="op" id="4721542">)</span>&nbsp;<span class="ident" id="4721544">getRequest</span><span class="op" id="4721554">(</span><span class="op" id="4721555">)</span>&nbsp;<span class="op" id="4721557">*</span><span class="ident" id="4721558">Request</span>&nbsp;<span class="op" id="4721566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721569">server</span><span class="op" id="4721575">.</span><span class="ident" id="4721576">reqLock</span><span class="op" id="4721583">.</span><span class="ident" id="4721584">Lock</span><span class="op" id="4721588">(</span><span class="op" id="4721589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721592">req</span>&nbsp;<span class="op" id="4721596">:=</span>&nbsp;<span class="ident" id="4721599">server</span><span class="op" id="4721605">.</span><span class="ident" id="4721606">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721615">if</span>&nbsp;<span class="ident" id="4721618">req</span>&nbsp;<span class="op" id="4721622">==</span>&nbsp;<span class="ident" id="4721625">nil</span>&nbsp;<span class="op" id="4721629">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721633">req</span>&nbsp;<span class="op" id="4721637">=</span>&nbsp;<span class="builtinfunc" id="4721639">new</span><span class="op" id="4721642">(</span><span class="ident" id="4721643">Request</span><span class="op" id="4721650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721653">}</span>&nbsp;<span class="keyword" id="4721655">else</span>&nbsp;<span class="op" id="4721660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721664">server</span><span class="op" id="4721670">.</span><span class="ident" id="4721671">freeReq</span>&nbsp;<span class="op" id="4721679">=</span>&nbsp;<span class="ident" id="4721681">req</span><span class="op" id="4721684">.</span><span class="ident" id="4721685">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721692">*</span><span class="ident" id="4721693">req</span>&nbsp;<span class="op" id="4721697">=</span>&nbsp;<span class="ident" id="4721699">Request</span><span class="op" id="4721706">{</span><span class="op" id="4721707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4721710">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721713">server</span><span class="op" id="4721719">.</span><span class="ident" id="4721720">reqLock</span><span class="op" id="4721727">.</span><span class="ident" id="4721728">Unlock</span><span class="op" id="4721734">(</span><span class="op" id="4721735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4721738">return</span>&nbsp;<span class="ident" id="4721745">req</span><br>
<span class="lineno"></span><span class="op" id="4721749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4721752">func</span>&nbsp;<span class="op" id="4721757">(</span><span class="ident" id="4721758">server</span>&nbsp;<span class="op" id="4721765">*</span><span class="ident" id="4721766">Server</span><span class="op" id="4721772">)</span>&nbsp;<span class="ident" id="4721774">freeRequest</span><span class="op" id="4721785">(</span><span class="ident" id="4721786">req</span>&nbsp;<span class="op" id="4721790">*</span><span class="ident" id="4721791">Request</span><span class="op" id="4721798">)</span>&nbsp;<span class="op" id="4721800">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721803">server</span><span class="op" id="4721809">.</span><span class="ident" id="4721810">reqLock</span><span class="op" id="4721817">.</span><span class="ident" id="4721818">Lock</span><span class="op" id="4721822">(</span><span class="op" id="4721823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721826">req</span><span class="op" id="4721829">.</span><span class="ident" id="4721830">next</span>&nbsp;<span class="op" id="4721835">=</span>&nbsp;<span class="ident" id="4721837">server</span><span class="op" id="4721843">.</span><span class="ident" id="4721844">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721853">server</span><span class="op" id="4721859">.</span><span class="ident" id="4721860">freeReq</span>&nbsp;<span class="op" id="4721868">=</span>&nbsp;<span class="ident" id="4721870">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721875">server</span><span class="op" id="4721881">.</span><span class="ident" id="4721882">reqLock</span><span class="op" id="4721889">.</span><span class="ident" id="4721890">Unlock</span><span class="op" id="4721896">(</span><span class="op" id="4721897">)</span><br>
<span class="lineno"></span><span class="op" id="4721899">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="4721902">func</span>&nbsp;<span class="op" id="4721907">(</span><span class="ident" id="4721908">server</span>&nbsp;<span class="op" id="4721915">*</span><span class="ident" id="4721916">Server</span><span class="op" id="4721922">)</span>&nbsp;<span class="ident" id="4721924">getResponse</span><span class="op" id="4721935">(</span><span class="op" id="4721936">)</span>&nbsp;<span class="op" id="4721938">*</span><span class="ident" id="4721939">Response</span>&nbsp;<span class="op" id="4721948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721951">server</span><span class="op" id="4721957">.</span><span class="ident" id="4721958">respLock</span><span class="op" id="4721966">.</span><span class="ident" id="4721967">Lock</span><span class="op" id="4721971">(</span><span class="op" id="4721972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4721975">resp</span>&nbsp;<span class="op" id="4721980">:=</span>&nbsp;<span class="ident" id="4721983">server</span><span class="op" id="4721989">.</span><span class="ident" id="4721990">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722000">if</span>&nbsp;<span class="ident" id="4722003">resp</span>&nbsp;<span class="op" id="4722008">==</span>&nbsp;<span class="ident" id="4722011">nil</span>&nbsp;<span class="op" id="4722015">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722019">resp</span>&nbsp;<span class="op" id="4722024">=</span>&nbsp;<span class="builtinfunc" id="4722026">new</span><span class="op" id="4722029">(</span><span class="ident" id="4722030">Response</span><span class="op" id="4722038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722041">}</span>&nbsp;<span class="keyword" id="4722043">else</span>&nbsp;<span class="op" id="4722048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722052">server</span><span class="op" id="4722058">.</span><span class="ident" id="4722059">freeResp</span>&nbsp;<span class="op" id="4722068">=</span>&nbsp;<span class="ident" id="4722070">resp</span><span class="op" id="4722074">.</span><span class="ident" id="4722075">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722082">*</span><span class="ident" id="4722083">resp</span>&nbsp;<span class="op" id="4722088">=</span>&nbsp;<span class="ident" id="4722090">Response</span><span class="op" id="4722098">{</span><span class="op" id="4722099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722102">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722105">server</span><span class="op" id="4722111">.</span><span class="ident" id="4722112">respLock</span><span class="op" id="4722120">.</span><span class="ident" id="4722121">Unlock</span><span class="op" id="4722127">(</span><span class="op" id="4722128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722131">return</span>&nbsp;<span class="ident" id="4722138">resp</span><br>
<span class="lineno"></span><span class="op" id="4722143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4722146">func</span>&nbsp;<span class="op" id="4722151">(</span><span class="ident" id="4722152">server</span>&nbsp;<span class="op" id="4722159">*</span><span class="ident" id="4722160">Server</span><span class="op" id="4722166">)</span>&nbsp;<span class="ident" id="4722168">freeResponse</span><span class="op" id="4722180">(</span><span class="ident" id="4722181">resp</span>&nbsp;<span class="op" id="4722186">*</span><span class="ident" id="4722187">Response</span><span class="op" id="4722195">)</span>&nbsp;<span class="op" id="4722197">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722200">server</span><span class="op" id="4722206">.</span><span class="ident" id="4722207">respLock</span><span class="op" id="4722215">.</span><span class="ident" id="4722216">Lock</span><span class="op" id="4722220">(</span><span class="op" id="4722221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722224">resp</span><span class="op" id="4722228">.</span><span class="ident" id="4722229">next</span>&nbsp;<span class="op" id="4722234">=</span>&nbsp;<span class="ident" id="4722236">server</span><span class="op" id="4722242">.</span><span class="ident" id="4722243">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722253">server</span><span class="op" id="4722259">.</span><span class="ident" id="4722260">freeResp</span>&nbsp;<span class="op" id="4722269">=</span>&nbsp;<span class="ident" id="4722271">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722277">server</span><span class="op" id="4722283">.</span><span class="ident" id="4722284">respLock</span><span class="op" id="4722292">.</span><span class="ident" id="4722293">Unlock</span><span class="op" id="4722299">(</span><span class="op" id="4722300">)</span><br>
<span class="lineno"></span><span class="op" id="4722302">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="4722305">func</span>&nbsp;<span class="op" id="4722310">(</span><span class="ident" id="4722311">server</span>&nbsp;<span class="op" id="4722318">*</span><span class="ident" id="4722319">Server</span><span class="op" id="4722325">)</span>&nbsp;<span class="ident" id="4722327">readRequest</span><span class="op" id="4722338">(</span><span class="ident" id="4722339">codec</span>&nbsp;<span class="ident" id="4722345">ServerCodec</span><span class="op" id="4722356">)</span>&nbsp;<span class="op" id="4722358">(</span><span class="ident" id="4722359">service</span>&nbsp;<span class="op" id="4722367">*</span><span class="ident" id="4722368">service</span><span class="op" id="4722375">,</span>&nbsp;<span class="ident" id="4722377">mtype</span>&nbsp;<span class="op" id="4722383">*</span><span class="ident" id="4722384">methodType</span><span class="op" id="4722394">,</span>&nbsp;<span class="ident" id="4722396">req</span>&nbsp;<span class="op" id="4722400">*</span><span class="ident" id="4722401">Request</span><span class="op" id="4722408">,</span>&nbsp;<span class="ident" id="4722410">argv</span><span class="op" id="4722414">,</span>&nbsp;<span class="ident" id="4722416">replyv</span>&nbsp;<span class="ident" id="4722423">reflect</span><span class="op" id="4722430">.</span><span class="ident" id="4722431">Value</span><span class="op" id="4722436">,</span>&nbsp;<span class="ident" id="4722438">keepReading</span>&nbsp;<span class="builtintype" id="4722450">bool</span><span class="op" id="4722454">,</span>&nbsp;<span class="ident" id="4722456">err</span>&nbsp;<span class="builtintype" id="4722460">error</span><span class="op" id="4722465">)</span>&nbsp;<span class="op" id="4722467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722470">service</span><span class="op" id="4722477">,</span>&nbsp;<span class="ident" id="4722479">mtype</span><span class="op" id="4722484">,</span>&nbsp;<span class="ident" id="4722486">req</span><span class="op" id="4722489">,</span>&nbsp;<span class="ident" id="4722491">keepReading</span><span class="op" id="4722502">,</span>&nbsp;<span class="ident" id="4722504">err</span>&nbsp;<span class="op" id="4722508">=</span>&nbsp;<span class="ident" id="4722510">server</span><span class="op" id="4722516">.</span><span class="ident" id="4722517">readRequestHeader</span><span class="op" id="4722534">(</span><span class="ident" id="4722535">codec</span><span class="op" id="4722540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722543">if</span>&nbsp;<span class="ident" id="4722546">err</span>&nbsp;<span class="op" id="4722550">!=</span>&nbsp;<span class="ident" id="4722553">nil</span>&nbsp;<span class="op" id="4722557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722561">if</span>&nbsp;<span class="op" id="4722564">!</span><span class="ident" id="4722565">keepReading</span>&nbsp;<span class="op" id="4722577">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722582">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722595">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722613">codec</span><span class="op" id="4722618">.</span><span class="ident" id="4722619">ReadRequestBody</span><span class="op" id="4722634">(</span><span class="ident" id="4722635">nil</span><span class="op" id="4722638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722642">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722650">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722654">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722685">argIsValue</span>&nbsp;<span class="op" id="4722696">:=</span>&nbsp;<span class="builtintype" id="4722699">false</span>&nbsp;<span class="comment" id="4722705">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722751">if</span>&nbsp;<span class="ident" id="4722754">mtype</span><span class="op" id="4722759">.</span><span class="ident" id="4722760">ArgType</span><span class="op" id="4722767">.</span><span class="ident" id="4722768">Kind</span><span class="op" id="4722772">(</span><span class="op" id="4722773">)</span>&nbsp;<span class="op" id="4722775">==</span>&nbsp;<span class="ident" id="4722778">reflect</span><span class="op" id="4722785">.</span><span class="ident" id="4722786">Ptr</span>&nbsp;<span class="op" id="4722790">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722794">argv</span>&nbsp;<span class="op" id="4722799">=</span>&nbsp;<span class="ident" id="4722801">reflect</span><span class="op" id="4722808">.</span><span class="ident" id="4722809">New</span><span class="op" id="4722812">(</span><span class="ident" id="4722813">mtype</span><span class="op" id="4722818">.</span><span class="ident" id="4722819">ArgType</span><span class="op" id="4722826">.</span><span class="ident" id="4722827">Elem</span><span class="op" id="4722831">(</span><span class="op" id="4722832">)</span><span class="op" id="4722833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722836">}</span>&nbsp;<span class="keyword" id="4722838">else</span>&nbsp;<span class="op" id="4722843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722847">argv</span>&nbsp;<span class="op" id="4722852">=</span>&nbsp;<span class="ident" id="4722854">reflect</span><span class="op" id="4722861">.</span><span class="ident" id="4722862">New</span><span class="op" id="4722865">(</span><span class="ident" id="4722866">mtype</span><span class="op" id="4722871">.</span><span class="ident" id="4722872">ArgType</span><span class="op" id="4722879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4722883">argIsValue</span>&nbsp;<span class="op" id="4722894">=</span>&nbsp;<span class="builtintype" id="4722896">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4722902">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4722905">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4722946">if</span>&nbsp;<span class="ident" id="4722949">err</span>&nbsp;<span class="op" id="4722953">=</span>&nbsp;<span class="ident" id="4722955">codec</span><span class="op" id="4722960">.</span><span class="ident" id="4722961">ReadRequestBody</span><span class="op" id="4722976">(</span><span class="ident" id="4722977">argv</span><span class="op" id="4722981">.</span><span class="ident" id="4722982">Interface</span><span class="op" id="4722991">(</span><span class="op" id="4722992">)</span><span class="op" id="4722993">)</span><span class="op" id="4722994">;</span>&nbsp;<span class="ident" id="4722996">err</span>&nbsp;<span class="op" id="4723000">!=</span>&nbsp;<span class="ident" id="4723003">nil</span>&nbsp;<span class="op" id="4723007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723011">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723022">if</span>&nbsp;<span class="ident" id="4723025">argIsValue</span>&nbsp;<span class="op" id="4723036">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723040">argv</span>&nbsp;<span class="op" id="4723045">=</span>&nbsp;<span class="ident" id="4723047">argv</span><span class="op" id="4723051">.</span><span class="ident" id="4723052">Elem</span><span class="op" id="4723056">(</span><span class="op" id="4723057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723064">replyv</span>&nbsp;<span class="op" id="4723071">=</span>&nbsp;<span class="ident" id="4723073">reflect</span><span class="op" id="4723080">.</span><span class="ident" id="4723081">New</span><span class="op" id="4723084">(</span><span class="ident" id="4723085">mtype</span><span class="op" id="4723090">.</span><span class="ident" id="4723091">ReplyType</span><span class="op" id="4723100">.</span><span class="ident" id="4723101">Elem</span><span class="op" id="4723105">(</span><span class="op" id="4723106">)</span><span class="op" id="4723107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723110">return</span><br>
<span class="lineno">570</span><span class="op" id="4723117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4723120">func</span>&nbsp;<span class="op" id="4723125">(</span><span class="ident" id="4723126">server</span>&nbsp;<span class="op" id="4723133">*</span><span class="ident" id="4723134">Server</span><span class="op" id="4723140">)</span>&nbsp;<span class="ident" id="4723142">readRequestHeader</span><span class="op" id="4723159">(</span><span class="ident" id="4723160">codec</span>&nbsp;<span class="ident" id="4723166">ServerCodec</span><span class="op" id="4723177">)</span>&nbsp;<span class="op" id="4723179">(</span><span class="ident" id="4723180">service</span>&nbsp;<span class="op" id="4723188">*</span><span class="ident" id="4723189">service</span><span class="op" id="4723196">,</span>&nbsp;<span class="ident" id="4723198">mtype</span>&nbsp;<span class="op" id="4723204">*</span><span class="ident" id="4723205">methodType</span><span class="op" id="4723215">,</span>&nbsp;<span class="ident" id="4723217">req</span>&nbsp;<span class="op" id="4723221">*</span><span class="ident" id="4723222">Request</span><span class="op" id="4723229">,</span>&nbsp;<span class="ident" id="4723231">keepReading</span>&nbsp;<span class="builtintype" id="4723243">bool</span><span class="op" id="4723247">,</span>&nbsp;<span class="ident" id="4723249">err</span>&nbsp;<span class="builtintype" id="4723253">error</span><span class="op" id="4723258">)</span>&nbsp;<span class="op" id="4723260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723263">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723292">req</span>&nbsp;<span class="op" id="4723296">=</span>&nbsp;<span class="ident" id="4723298">server</span><span class="op" id="4723304">.</span><span class="ident" id="4723305">getRequest</span><span class="op" id="4723315">(</span><span class="op" id="4723316">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723319">err</span>&nbsp;<span class="op" id="4723323">=</span>&nbsp;<span class="ident" id="4723325">codec</span><span class="op" id="4723330">.</span><span class="ident" id="4723331">ReadRequestHeader</span><span class="op" id="4723348">(</span><span class="ident" id="4723349">req</span><span class="op" id="4723352">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723355">if</span>&nbsp;<span class="ident" id="4723358">err</span>&nbsp;<span class="op" id="4723362">!=</span>&nbsp;<span class="ident" id="4723365">nil</span>&nbsp;<span class="op" id="4723369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723373">req</span>&nbsp;<span class="op" id="4723377">=</span>&nbsp;<span class="ident" id="4723379">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723385">if</span>&nbsp;<span class="ident" id="4723388">err</span>&nbsp;<span class="op" id="4723392">==</span>&nbsp;<span class="ident" id="4723395">io</span><span class="op" id="4723397">.</span><span class="ident" id="4723398">EOF</span>&nbsp;<span class="op" id="4723402">||</span>&nbsp;<span class="ident" id="4723405">err</span>&nbsp;<span class="op" id="4723409">==</span>&nbsp;<span class="ident" id="4723412">io</span><span class="op" id="4723414">.</span><span class="ident" id="4723415">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="4723432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723437">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723450">err</span>&nbsp;<span class="op" id="4723454">=</span>&nbsp;<span class="ident" id="4723456">errors</span><span class="op" id="4723462">.</span><span class="ident" id="4723463">New</span><span class="op" id="4723466">(</span><span class="string" id="4723467">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="4723505">+</span>&nbsp;<span class="ident" id="4723507">err</span><span class="op" id="4723510">.</span><span class="ident" id="4723511">Error</span><span class="op" id="4723516">(</span><span class="op" id="4723517">)</span><span class="op" id="4723518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723522">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723534">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723596">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723654">keepReading</span>&nbsp;<span class="op" id="4723666">=</span>&nbsp;<span class="builtintype" id="4723668">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723675">dot</span>&nbsp;<span class="op" id="4723679">:=</span>&nbsp;<span class="ident" id="4723682">strings</span><span class="op" id="4723689">.</span><span class="ident" id="4723690">LastIndex</span><span class="op" id="4723699">(</span><span class="ident" id="4723700">req</span><span class="op" id="4723703">.</span><span class="ident" id="4723704">ServiceMethod</span><span class="op" id="4723717">,</span>&nbsp;<span class="string" id="4723719">&#34;.&#34;</span><span class="op" id="4723722">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723725">if</span>&nbsp;<span class="ident" id="4723728">dot</span>&nbsp;<span class="op" id="4723732">&lt;</span>&nbsp;<span class="num" id="4723734">0</span>&nbsp;<span class="op" id="4723736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723740">err</span>&nbsp;<span class="op" id="4723744">=</span>&nbsp;<span class="ident" id="4723746">errors</span><span class="op" id="4723752">.</span><span class="ident" id="4723753">New</span><span class="op" id="4723756">(</span><span class="string" id="4723757">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="4723800">+</span>&nbsp;<span class="ident" id="4723802">req</span><span class="op" id="4723805">.</span><span class="ident" id="4723806">ServiceMethod</span><span class="op" id="4723819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4723823">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4723831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723834">serviceName</span>&nbsp;<span class="op" id="4723846">:=</span>&nbsp;<span class="ident" id="4723849">req</span><span class="op" id="4723852">.</span><span class="ident" id="4723853">ServiceMethod</span><span class="op" id="4723866">[</span><span class="op" id="4723867">:</span><span class="ident" id="4723868">dot</span><span class="op" id="4723871">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723874">methodName</span>&nbsp;<span class="op" id="4723885">:=</span>&nbsp;<span class="ident" id="4723888">req</span><span class="op" id="4723891">.</span><span class="ident" id="4723892">ServiceMethod</span><span class="op" id="4723905">[</span><span class="ident" id="4723906">dot</span><span class="op" id="4723909">+</span><span class="num" id="4723910">1</span><span class="op" id="4723911">:</span><span class="op" id="4723912">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4723916">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723941">server</span><span class="op" id="4723947">.</span><span class="ident" id="4723948">mu</span><span class="op" id="4723950">.</span><span class="ident" id="4723951">RLock</span><span class="op" id="4723956">(</span><span class="op" id="4723957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4723960">service</span>&nbsp;<span class="op" id="4723968">=</span>&nbsp;<span class="ident" id="4723970">server</span><span class="op" id="4723976">.</span><span class="ident" id="4723977">serviceMap</span><span class="op" id="4723987">[</span><span class="ident" id="4723988">serviceName</span><span class="op" id="4723999">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724002">server</span><span class="op" id="4724008">.</span><span class="ident" id="4724009">mu</span><span class="op" id="4724011">.</span><span class="ident" id="4724012">RUnlock</span><span class="op" id="4724019">(</span><span class="op" id="4724020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724023">if</span>&nbsp;<span class="ident" id="4724026">service</span>&nbsp;<span class="op" id="4724034">==</span>&nbsp;<span class="ident" id="4724037">nil</span>&nbsp;<span class="op" id="4724041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724045">err</span>&nbsp;<span class="op" id="4724049">=</span>&nbsp;<span class="ident" id="4724051">errors</span><span class="op" id="4724057">.</span><span class="ident" id="4724058">New</span><span class="op" id="4724061">(</span><span class="string" id="4724062">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="4724089">+</span>&nbsp;<span class="ident" id="4724091">req</span><span class="op" id="4724094">.</span><span class="ident" id="4724095">ServiceMethod</span><span class="op" id="4724108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724112">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724120">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724123">mtype</span>&nbsp;<span class="op" id="4724129">=</span>&nbsp;<span class="ident" id="4724131">service</span><span class="op" id="4724138">.</span><span class="ident" id="4724139">method</span><span class="op" id="4724145">[</span><span class="ident" id="4724146">methodName</span><span class="op" id="4724156">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724159">if</span>&nbsp;<span class="ident" id="4724162">mtype</span>&nbsp;<span class="op" id="4724168">==</span>&nbsp;<span class="ident" id="4724171">nil</span>&nbsp;<span class="op" id="4724175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724179">err</span>&nbsp;<span class="op" id="4724183">=</span>&nbsp;<span class="ident" id="4724185">errors</span><span class="op" id="4724191">.</span><span class="ident" id="4724192">New</span><span class="op" id="4724195">(</span><span class="string" id="4724196">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="4724222">+</span>&nbsp;<span class="ident" id="4724224">req</span><span class="op" id="4724227">.</span><span class="ident" id="4724228">ServiceMethod</span><span class="op" id="4724241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724247">return</span><br>
<span class="lineno">610</span><span class="op" id="4724254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4724257">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4724323">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="4724393">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="4724426">func</span>&nbsp;<span class="op" id="4724431">(</span><span class="ident" id="4724432">server</span>&nbsp;<span class="op" id="4724439">*</span><span class="ident" id="4724440">Server</span><span class="op" id="4724446">)</span>&nbsp;<span class="ident" id="4724448">Accept</span><span class="op" id="4724454">(</span><span class="ident" id="4724455">lis</span>&nbsp;<span class="ident" id="4724459">net</span><span class="op" id="4724462">.</span><span class="ident" id="4724463">Listener</span><span class="op" id="4724471">)</span>&nbsp;<span class="op" id="4724473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724476">for</span>&nbsp;<span class="op" id="4724480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724484">conn</span><span class="op" id="4724488">,</span>&nbsp;<span class="ident" id="4724490">err</span>&nbsp;<span class="op" id="4724494">:=</span>&nbsp;<span class="ident" id="4724497">lis</span><span class="op" id="4724500">.</span><span class="ident" id="4724501">Accept</span><span class="op" id="4724507">(</span><span class="op" id="4724508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724512">if</span>&nbsp;<span class="ident" id="4724515">err</span>&nbsp;<span class="op" id="4724519">!=</span>&nbsp;<span class="ident" id="4724522">nil</span>&nbsp;<span class="op" id="4724526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4724531">log</span><span class="op" id="4724534">.</span><span class="ident" id="4724535">Fatal</span><span class="op" id="4724540">(</span><span class="string" id="4724541">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="4724561">,</span>&nbsp;<span class="ident" id="4724563">err</span><span class="op" id="4724566">.</span><span class="ident" id="4724567">Error</span><span class="op" id="4724572">(</span><span class="op" id="4724573">)</span><span class="op" id="4724574">)</span>&nbsp;<span class="comment" id="4724576">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724600">go</span>&nbsp;<span class="ident" id="4724603">server</span><span class="op" id="4724609">.</span><span class="ident" id="4724610">ServeConn</span><span class="op" id="4724619">(</span><span class="ident" id="4724620">conn</span><span class="op" id="4724624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4724627">}</span><br>
<span class="lineno"></span><span class="op" id="4724629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="4724632">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="4724699">func</span>&nbsp;<span class="ident" id="4724704">Register</span><span class="op" id="4724712">(</span><span class="ident" id="4724713">rcvr</span>&nbsp;<span class="keyword" id="4724718">interface</span><span class="op" id="4724727">{</span><span class="op" id="4724728">}</span><span class="op" id="4724729">)</span>&nbsp;<span class="builtintype" id="4724731">error</span>&nbsp;<span class="op" id="4724737">{</span>&nbsp;<span class="keyword" id="4724739">return</span>&nbsp;<span class="ident" id="4724746">DefaultServer</span><span class="op" id="4724759">.</span><span class="ident" id="4724760">Register</span><span class="op" id="4724768">(</span><span class="ident" id="4724769">rcvr</span><span class="op" id="4724773">)</span>&nbsp;<span class="op" id="4724775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4724778">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="4724851">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="4724895">func</span>&nbsp;<span class="ident" id="4724900">RegisterName</span><span class="op" id="4724912">(</span><span class="ident" id="4724913">name</span>&nbsp;<span class="builtintype" id="4724918">string</span><span class="op" id="4724924">,</span>&nbsp;<span class="ident" id="4724926">rcvr</span>&nbsp;<span class="keyword" id="4724931">interface</span><span class="op" id="4724940">{</span><span class="op" id="4724941">}</span><span class="op" id="4724942">)</span>&nbsp;<span class="builtintype" id="4724944">error</span>&nbsp;<span class="op" id="4724950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4724953">return</span>&nbsp;<span class="ident" id="4724960">DefaultServer</span><span class="op" id="4724973">.</span><span class="ident" id="4724974">RegisterName</span><span class="op" id="4724986">(</span><span class="ident" id="4724987">name</span><span class="op" id="4724991">,</span>&nbsp;<span class="ident" id="4724993">rcvr</span><span class="op" id="4724997">)</span><br>
<span class="lineno"></span><span class="op" id="4724999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4725002">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="4725069">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="4725125">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="4725192">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4725263">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4725336">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="4725392">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="4725463">type</span>&nbsp;<span class="ident" id="4725468">ServerCodec</span>&nbsp;<span class="keyword" id="4725480">interface</span>&nbsp;<span class="op" id="4725490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725493">ReadRequestHeader</span><span class="op" id="4725510">(</span><span class="op" id="4725511">*</span><span class="ident" id="4725512">Request</span><span class="op" id="4725519">)</span>&nbsp;<span class="builtintype" id="4725521">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725528">ReadRequestBody</span><span class="op" id="4725543">(</span><span class="keyword" id="4725544">interface</span><span class="op" id="4725553">{</span><span class="op" id="4725554">}</span><span class="op" id="4725555">)</span>&nbsp;<span class="builtintype" id="4725557">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4725564">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725638">WriteResponse</span><span class="op" id="4725651">(</span><span class="op" id="4725652">*</span><span class="ident" id="4725653">Response</span><span class="op" id="4725661">,</span>&nbsp;<span class="keyword" id="4725663">interface</span><span class="op" id="4725672">{</span><span class="op" id="4725673">}</span><span class="op" id="4725674">)</span>&nbsp;<span class="builtintype" id="4725676">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4725684">Close</span><span class="op" id="4725689">(</span><span class="op" id="4725690">)</span>&nbsp;<span class="builtintype" id="4725692">error</span><br>
<span class="lineno"></span><span class="op" id="4725698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="4725701">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4725761">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="4725832">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="4725893">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4725956">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="4726015">func</span>&nbsp;<span class="ident" id="4726020">ServeConn</span><span class="op" id="4726029">(</span><span class="ident" id="4726030">conn</span>&nbsp;<span class="ident" id="4726035">io</span><span class="op" id="4726037">.</span><span class="ident" id="4726038">ReadWriteCloser</span><span class="op" id="4726053">)</span>&nbsp;<span class="op" id="4726055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726058">DefaultServer</span><span class="op" id="4726071">.</span><span class="ident" id="4726072">ServeConn</span><span class="op" id="4726081">(</span><span class="ident" id="4726082">conn</span><span class="op" id="4726086">)</span><br>
<span class="lineno"></span><span class="op" id="4726088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4726091">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="4726155">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="4726196">func</span>&nbsp;<span class="ident" id="4726201">ServeCodec</span><span class="op" id="4726211">(</span><span class="ident" id="4726212">codec</span>&nbsp;<span class="ident" id="4726218">ServerCodec</span><span class="op" id="4726229">)</span>&nbsp;<span class="op" id="4726231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4726234">DefaultServer</span><span class="op" id="4726247">.</span><span class="ident" id="4726248">ServeCodec</span><span class="op" id="4726258">(</span><span class="ident" id="4726259">codec</span><span class="op" id="4726264">)</span><br>
<span class="lineno"></span><span class="op" id="4726266">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="4726269">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="4726347">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="4726395">func</span>&nbsp;<span class="ident" id="4726400">ServeRequest</span><span class="op" id="4726412">(</span><span class="ident" id="4726413">codec</span>&nbsp;<span class="ident" id="4726419">ServerCodec</span><span class="op" id="4726430">)</span>&nbsp;<span class="builtintype" id="4726432">error</span>&nbsp;<span class="op" id="4726438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726441">return</span>&nbsp;<span class="ident" id="4726448">DefaultServer</span><span class="op" id="4726461">.</span><span class="ident" id="4726462">ServeRequest</span><span class="op" id="4726474">(</span><span class="ident" id="4726475">codec</span><span class="op" id="4726480">)</span><br>
<span class="lineno"></span><span class="op" id="4726482">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="4726485">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="4726551">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4726601">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4726670">func</span>&nbsp;<span class="ident" id="4726675">Accept</span><span class="op" id="4726681">(</span><span class="ident" id="4726682">lis</span>&nbsp;<span class="ident" id="4726686">net</span><span class="op" id="4726689">.</span><span class="ident" id="4726690">Listener</span><span class="op" id="4726698">)</span>&nbsp;<span class="op" id="4726700">{</span>&nbsp;<span class="ident" id="4726702">DefaultServer</span><span class="op" id="4726715">.</span><span class="ident" id="4726716">Accept</span><span class="op" id="4726722">(</span><span class="ident" id="4726723">lis</span><span class="op" id="4726726">)</span>&nbsp;<span class="op" id="4726728">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="4726731">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="4726792">var</span>&nbsp;<span class="ident" id="4726796">connected</span>&nbsp;<span class="op" id="4726806">=</span>&nbsp;<span class="string" id="4726808">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4726835">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="4726902">func</span>&nbsp;<span class="op" id="4726907">(</span><span class="ident" id="4726908">server</span>&nbsp;<span class="op" id="4726915">*</span><span class="ident" id="4726916">Server</span><span class="op" id="4726922">)</span>&nbsp;<span class="ident" id="4726924">ServeHTTP</span><span class="op" id="4726933">(</span><span class="ident" id="4726934">w</span>&nbsp;<span class="ident" id="4726936">http</span><span class="op" id="4726940">.</span><span class="ident" id="4726941">ResponseWriter</span><span class="op" id="4726955">,</span>&nbsp;<span class="ident" id="4726957">req</span>&nbsp;<span class="op" id="4726961">*</span><span class="ident" id="4726962">http</span><span class="op" id="4726966">.</span><span class="ident" id="4726967">Request</span><span class="op" id="4726974">)</span>&nbsp;<span class="op" id="4726976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4726979">if</span>&nbsp;<span class="ident" id="4726982">req</span><span class="op" id="4726985">.</span><span class="ident" id="4726986">Method</span>&nbsp;<span class="op" id="4726993">!=</span>&nbsp;<span class="string" id="4726996">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="4727006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727010">w</span><span class="op" id="4727011">.</span><span class="ident" id="4727012">Header</span><span class="op" id="4727018">(</span><span class="op" id="4727019">)</span><span class="op" id="4727020">.</span><span class="ident" id="4727021">Set</span><span class="op" id="4727024">(</span><span class="string" id="4727025">&#34;Content-Type&#34;</span><span class="op" id="4727039">,</span>&nbsp;<span class="string" id="4727041">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="4727068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727072">w</span><span class="op" id="4727073">.</span><span class="ident" id="4727074">WriteHeader</span><span class="op" id="4727085">(</span><span class="ident" id="4727086">http</span><span class="op" id="4727090">.</span><span class="ident" id="4727091">StatusMethodNotAllowed</span><span class="op" id="4727113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727117">io</span><span class="op" id="4727119">.</span><span class="ident" id="4727120">WriteString</span><span class="op" id="4727131">(</span><span class="ident" id="4727132">w</span><span class="op" id="4727133">,</span>&nbsp;<span class="string" id="4727135">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="4727155">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727159">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727170">conn</span><span class="op" id="4727174">,</span>&nbsp;<span class="ident" id="4727176">_</span><span class="op" id="4727177">,</span>&nbsp;<span class="ident" id="4727179">err</span>&nbsp;<span class="op" id="4727183">:=</span>&nbsp;<span class="ident" id="4727186">w</span><span class="op" id="4727187">.</span><span class="op" id="4727188">(</span><span class="ident" id="4727189">http</span><span class="op" id="4727193">.</span><span class="ident" id="4727194">Hijacker</span><span class="op" id="4727202">)</span><span class="op" id="4727203">.</span><span class="ident" id="4727204">Hijack</span><span class="op" id="4727210">(</span><span class="op" id="4727211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727214">if</span>&nbsp;<span class="ident" id="4727217">err</span>&nbsp;<span class="op" id="4727221">!=</span>&nbsp;<span class="ident" id="4727224">nil</span>&nbsp;<span class="op" id="4727228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727232">log</span><span class="op" id="4727235">.</span><span class="ident" id="4727236">Print</span><span class="op" id="4727241">(</span><span class="string" id="4727242">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="4727258">,</span>&nbsp;<span class="ident" id="4727260">req</span><span class="op" id="4727263">.</span><span class="ident" id="4727264">RemoteAddr</span><span class="op" id="4727274">,</span>&nbsp;<span class="string" id="4727276">&#34;:&nbsp;&#34;</span><span class="op" id="4727280">,</span>&nbsp;<span class="ident" id="4727282">err</span><span class="op" id="4727285">.</span><span class="ident" id="4727286">Error</span><span class="op" id="4727291">(</span><span class="op" id="4727292">)</span><span class="op" id="4727293">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4727297">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4727305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727308">io</span><span class="op" id="4727310">.</span><span class="ident" id="4727311">WriteString</span><span class="op" id="4727322">(</span><span class="ident" id="4727323">conn</span><span class="op" id="4727327">,</span>&nbsp;<span class="string" id="4727329">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="4727340">+</span><span class="ident" id="4727341">connected</span><span class="op" id="4727350">+</span><span class="string" id="4727351">&#34;\n\n&#34;</span><span class="op" id="4727357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727360">server</span><span class="op" id="4727366">.</span><span class="ident" id="4727367">ServeConn</span><span class="op" id="4727376">(</span><span class="ident" id="4727377">conn</span><span class="op" id="4727381">)</span><br>
<span class="lineno"></span><span class="op" id="4727383">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="4727386">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="4727455">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="4727496">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4727574">func</span>&nbsp;<span class="op" id="4727579">(</span><span class="ident" id="4727580">server</span>&nbsp;<span class="op" id="4727587">*</span><span class="ident" id="4727588">Server</span><span class="op" id="4727594">)</span>&nbsp;<span class="ident" id="4727596">HandleHTTP</span><span class="op" id="4727606">(</span><span class="ident" id="4727607">rpcPath</span><span class="op" id="4727614">,</span>&nbsp;<span class="ident" id="4727616">debugPath</span>&nbsp;<span class="builtintype" id="4727626">string</span><span class="op" id="4727632">)</span>&nbsp;<span class="op" id="4727634">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727637">http</span><span class="op" id="4727641">.</span><span class="ident" id="4727642">Handle</span><span class="op" id="4727648">(</span><span class="ident" id="4727649">rpcPath</span><span class="op" id="4727656">,</span>&nbsp;<span class="ident" id="4727658">server</span><span class="op" id="4727664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727667">http</span><span class="op" id="4727671">.</span><span class="ident" id="4727672">Handle</span><span class="op" id="4727678">(</span><span class="ident" id="4727679">debugPath</span><span class="op" id="4727688">,</span>&nbsp;<span class="ident" id="4727690">debugHTTP</span><span class="op" id="4727699">{</span><span class="ident" id="4727700">server</span><span class="op" id="4727706">}</span><span class="op" id="4727707">)</span><br>
<span class="lineno"></span><span class="op" id="4727709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4727712">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="4727786">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="4727852">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="4727930">func</span>&nbsp;<span class="ident" id="4727935">HandleHTTP</span><span class="op" id="4727945">(</span><span class="op" id="4727946">)</span>&nbsp;<span class="op" id="4727948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4727951">DefaultServer</span><span class="op" id="4727964">.</span><span class="ident" id="4727965">HandleHTTP</span><span class="op" id="4727975">(</span><span class="ident" id="4727976">DefaultRPCPath</span><span class="op" id="4727990">,</span>&nbsp;<span class="ident" id="4727992">DefaultDebugPath</span><span class="op" id="4728008">)</span><br>
<span class="lineno"></span><span class="op" id="4728010">}</span>
</div>
</body>
</html>
