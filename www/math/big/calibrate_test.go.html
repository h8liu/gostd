<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8462446">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8462501">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8462555">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8462606">//&nbsp;This&nbsp;file&nbsp;prints&nbsp;execution&nbsp;times&nbsp;for&nbsp;the&nbsp;Mul&nbsp;benchmark</span><br>
<span class="lineno"></span><span class="comment" id="8462664">//&nbsp;given&nbsp;different&nbsp;Karatsuba&nbsp;thresholds.&nbsp;The&nbsp;result&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="8462723">//&nbsp;used&nbsp;to&nbsp;manually&nbsp;fine-tune&nbsp;the&nbsp;threshold&nbsp;constant.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="8462781">//&nbsp;results&nbsp;are&nbsp;somewhat&nbsp;fragile;&nbsp;use&nbsp;repeated&nbsp;runs&nbsp;to&nbsp;get</span><br>
<span class="lineno"></span><span class="comment" id="8462839">//&nbsp;a&nbsp;clear&nbsp;picture.</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="8462860">//&nbsp;Usage:&nbsp;go&nbsp;test&nbsp;-run=TestCalibrate&nbsp;-calibrate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8462909">package</span>&nbsp;<span class="ident" id="8462917">big</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="8462922">import</span>&nbsp;<span class="op" id="8462929">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8462932">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8462940">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8462947">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8462958">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="8462965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8462968">var</span>&nbsp;<span class="ident" id="8462972">calibrate</span>&nbsp;<span class="op" id="8462982">=</span>&nbsp;<span class="ident" id="8462984">flag</span><span class="op" id="8462988">.</span><span class="ident" id="8462989">Bool</span><span class="op" id="8462993">(</span><span class="string" id="8462994">&#34;calibrate&#34;</span><span class="op" id="8463005">,</span>&nbsp;<span class="ident" id="8463007">false</span><span class="op" id="8463012">,</span>&nbsp;<span class="string" id="8463014">&#34;run&nbsp;calibration&nbsp;test&#34;</span><span class="op" id="8463036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8463039">func</span>&nbsp;<span class="ident" id="8463044">karatsubaLoad</span><span class="op" id="8463057">(</span><span class="ident" id="8463058">b</span>&nbsp;<span class="op" id="8463060">*</span><span class="ident" id="8463061">testing</span><span class="op" id="8463068">.</span><span class="ident" id="8463069">B</span><span class="op" id="8463070">)</span>&nbsp;<span class="op" id="8463072">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463075">BenchmarkMul</span><span class="op" id="8463087">(</span><span class="ident" id="8463088">b</span><span class="op" id="8463089">)</span><br>
<span class="lineno"></span><span class="op" id="8463091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="8463094">//&nbsp;measureKaratsuba&nbsp;returns&nbsp;the&nbsp;time&nbsp;to&nbsp;run&nbsp;a&nbsp;Karatsuba-relevant&nbsp;benchmark</span><br>
<span class="lineno"></span><span class="comment" id="8463169">//&nbsp;given&nbsp;Karatsuba&nbsp;threshold&nbsp;th.</span><br>
<span class="lineno">30</span><span class="keyword" id="8463202">func</span>&nbsp;<span class="ident" id="8463207">measureKaratsuba</span><span class="op" id="8463223">(</span><span class="ident" id="8463224">th</span>&nbsp;<span class="builtintype" id="8463227">int</span><span class="op" id="8463230">)</span>&nbsp;<span class="ident" id="8463232">time</span><span class="op" id="8463236">.</span><span class="ident" id="8463237">Duration</span>&nbsp;<span class="op" id="8463246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463249">th</span><span class="op" id="8463251">,</span>&nbsp;<span class="ident" id="8463253">karatsubaThreshold</span>&nbsp;<span class="op" id="8463272">=</span>&nbsp;<span class="ident" id="8463274">karatsubaThreshold</span><span class="op" id="8463292">,</span>&nbsp;<span class="ident" id="8463294">th</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463298">res</span>&nbsp;<span class="op" id="8463302">:=</span>&nbsp;<span class="ident" id="8463305">testing</span><span class="op" id="8463312">.</span><span class="ident" id="8463313">Benchmark</span><span class="op" id="8463322">(</span><span class="ident" id="8463323">karatsubaLoad</span><span class="op" id="8463336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463339">karatsubaThreshold</span>&nbsp;<span class="op" id="8463358">=</span>&nbsp;<span class="ident" id="8463360">th</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8463364">return</span>&nbsp;<span class="ident" id="8463371">time</span><span class="op" id="8463375">.</span><span class="ident" id="8463376">Duration</span><span class="op" id="8463384">(</span><span class="ident" id="8463385">res</span><span class="op" id="8463388">.</span><span class="ident" id="8463389">NsPerOp</span><span class="op" id="8463396">(</span><span class="op" id="8463397">)</span><span class="op" id="8463398">)</span><br>
<span class="lineno">35</span><span class="op" id="8463400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8463403">func</span>&nbsp;<span class="ident" id="8463408">computeThresholds</span><span class="op" id="8463425">(</span><span class="op" id="8463426">)</span>&nbsp;<span class="op" id="8463428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463431">fmt</span><span class="op" id="8463434">.</span><span class="ident" id="8463435">Printf</span><span class="op" id="8463441">(</span><span class="string" id="8463442">&#34;Multiplication&nbsp;times&nbsp;for&nbsp;varying&nbsp;Karatsuba&nbsp;thresholds\n&#34;</span><span class="op" id="8463499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463502">fmt</span><span class="op" id="8463505">.</span><span class="ident" id="8463506">Printf</span><span class="op" id="8463512">(</span><span class="string" id="8463513">&#34;(run&nbsp;repeatedly&nbsp;for&nbsp;good&nbsp;results)\n&#34;</span><span class="op" id="8463550">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8463554">//&nbsp;determine&nbsp;Tk,&nbsp;the&nbsp;work&nbsp;load&nbsp;execution&nbsp;time&nbsp;using&nbsp;basic&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463628">Tb</span>&nbsp;<span class="op" id="8463631">:=</span>&nbsp;<span class="ident" id="8463634">measureKaratsuba</span><span class="op" id="8463650">(</span><span class="num" id="8463651">1e9</span><span class="op" id="8463654">)</span>&nbsp;<span class="comment" id="8463656">//&nbsp;th&nbsp;==&nbsp;1e9&nbsp;=&gt;&nbsp;Karatsuba&nbsp;multiplication&nbsp;disabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463707">fmt</span><span class="op" id="8463710">.</span><span class="ident" id="8463711">Printf</span><span class="op" id="8463717">(</span><span class="string" id="8463718">&#34;Tb&nbsp;=&nbsp;%10s\n&#34;</span><span class="op" id="8463731">,</span>&nbsp;<span class="ident" id="8463733">Tb</span><span class="op" id="8463735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8463739">//&nbsp;thresholds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463754">th</span>&nbsp;<span class="op" id="8463757">:=</span>&nbsp;<span class="num" id="8463760">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463763">th1</span>&nbsp;<span class="op" id="8463767">:=</span>&nbsp;<span class="op" id="8463770">-</span><span class="num" id="8463771">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463774">th2</span>&nbsp;<span class="op" id="8463778">:=</span>&nbsp;<span class="op" id="8463781">-</span><span class="num" id="8463782">1</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8463786">var</span>&nbsp;<span class="ident" id="8463790">deltaOld</span>&nbsp;<span class="ident" id="8463799">time</span><span class="op" id="8463803">.</span><span class="ident" id="8463804">Duration</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8463814">for</span>&nbsp;<span class="ident" id="8463818">count</span>&nbsp;<span class="op" id="8463824">:=</span>&nbsp;<span class="op" id="8463827">-</span><span class="num" id="8463828">1</span><span class="op" id="8463829">;</span>&nbsp;<span class="ident" id="8463831">count</span>&nbsp;<span class="op" id="8463837">!=</span>&nbsp;<span class="num" id="8463840">0</span>&nbsp;<span class="op" id="8463842">&amp;&amp;</span>&nbsp;<span class="ident" id="8463845">th</span>&nbsp;<span class="op" id="8463848">&lt;</span>&nbsp;<span class="num" id="8463850">128</span><span class="op" id="8463853">;</span>&nbsp;<span class="ident" id="8463855">count</span><span class="op" id="8463860">--</span>&nbsp;<span class="op" id="8463863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8463867">//&nbsp;determine&nbsp;Tk,&nbsp;the&nbsp;work&nbsp;load&nbsp;execution&nbsp;time&nbsp;using&nbsp;Karatsuba&nbsp;multiplication</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8463946">Tk</span>&nbsp;<span class="op" id="8463949">:=</span>&nbsp;<span class="ident" id="8463952">measureKaratsuba</span><span class="op" id="8463968">(</span><span class="ident" id="8463969">th</span><span class="op" id="8463971">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8463976">//&nbsp;improvement&nbsp;over&nbsp;Tb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464001">delta</span>&nbsp;<span class="op" id="8464007">:=</span>&nbsp;<span class="op" id="8464010">(</span><span class="ident" id="8464011">Tb</span>&nbsp;<span class="op" id="8464014">-</span>&nbsp;<span class="ident" id="8464016">Tk</span><span class="op" id="8464018">)</span>&nbsp;<span class="op" id="8464020">*</span>&nbsp;<span class="num" id="8464022">100</span>&nbsp;<span class="op" id="8464026">/</span>&nbsp;<span class="ident" id="8464028">Tb</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464034">fmt</span><span class="op" id="8464037">.</span><span class="ident" id="8464038">Printf</span><span class="op" id="8464044">(</span><span class="string" id="8464045">&#34;th&nbsp;=&nbsp;%3d&nbsp;&nbsp;Tk&nbsp;=&nbsp;%10s&nbsp;&nbsp;%4d%%&#34;</span><span class="op" id="8464073">,</span>&nbsp;<span class="ident" id="8464075">th</span><span class="op" id="8464077">,</span>&nbsp;<span class="ident" id="8464079">Tk</span><span class="op" id="8464081">,</span>&nbsp;<span class="ident" id="8464083">delta</span><span class="op" id="8464088">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8464093">//&nbsp;determine&nbsp;break-even&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8464125">if</span>&nbsp;<span class="ident" id="8464128">Tk</span>&nbsp;<span class="op" id="8464131">&lt;</span>&nbsp;<span class="ident" id="8464133">Tb</span>&nbsp;<span class="op" id="8464136">&amp;&amp;</span>&nbsp;<span class="ident" id="8464139">th1</span>&nbsp;<span class="op" id="8464143">&lt;</span>&nbsp;<span class="num" id="8464145">0</span>&nbsp;<span class="op" id="8464147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464152">th1</span>&nbsp;<span class="op" id="8464156">=</span>&nbsp;<span class="ident" id="8464158">th</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464164">fmt</span><span class="op" id="8464167">.</span><span class="ident" id="8464168">Print</span><span class="op" id="8464173">(</span><span class="string" id="8464174">&#34;&nbsp;&nbsp;break-even&nbsp;point&#34;</span><span class="op" id="8464194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8464198">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8464203">//&nbsp;determine&nbsp;diminishing&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8464237">if</span>&nbsp;<span class="num" id="8464240">0</span>&nbsp;<span class="op" id="8464242">&lt;</span>&nbsp;<span class="ident" id="8464244">delta</span>&nbsp;<span class="op" id="8464250">&amp;&amp;</span>&nbsp;<span class="ident" id="8464253">delta</span>&nbsp;<span class="op" id="8464259">&lt;</span>&nbsp;<span class="ident" id="8464261">deltaOld</span>&nbsp;<span class="op" id="8464270">&amp;&amp;</span>&nbsp;<span class="ident" id="8464273">th2</span>&nbsp;<span class="op" id="8464277">&lt;</span>&nbsp;<span class="num" id="8464279">0</span>&nbsp;<span class="op" id="8464281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464286">th2</span>&nbsp;<span class="op" id="8464290">=</span>&nbsp;<span class="ident" id="8464292">th</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464298">fmt</span><span class="op" id="8464301">.</span><span class="ident" id="8464302">Print</span><span class="op" id="8464307">(</span><span class="string" id="8464308">&#34;&nbsp;&nbsp;diminishing&nbsp;return&#34;</span><span class="op" id="8464330">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8464334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464338">deltaOld</span>&nbsp;<span class="op" id="8464347">=</span>&nbsp;<span class="ident" id="8464349">delta</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464358">fmt</span><span class="op" id="8464361">.</span><span class="ident" id="8464362">Println</span><span class="op" id="8464369">(</span><span class="op" id="8464370">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8464375">//&nbsp;trigger&nbsp;counter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8464396">if</span>&nbsp;<span class="ident" id="8464399">th1</span>&nbsp;<span class="op" id="8464403">&gt;=</span>&nbsp;<span class="num" id="8464406">0</span>&nbsp;<span class="op" id="8464408">&amp;&amp;</span>&nbsp;<span class="ident" id="8464411">th2</span>&nbsp;<span class="op" id="8464415">&gt;=</span>&nbsp;<span class="num" id="8464418">0</span>&nbsp;<span class="op" id="8464420">&amp;&amp;</span>&nbsp;<span class="ident" id="8464423">count</span>&nbsp;<span class="op" id="8464429">&lt;</span>&nbsp;<span class="num" id="8464431">0</span>&nbsp;<span class="op" id="8464433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464438">count</span>&nbsp;<span class="op" id="8464444">=</span>&nbsp;<span class="num" id="8464446">10</span>&nbsp;<span class="comment" id="8464449">//&nbsp;this&nbsp;many&nbsp;extra&nbsp;measurements&nbsp;after&nbsp;we&nbsp;got&nbsp;both&nbsp;thresholds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8464512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464517">th</span><span class="op" id="8464519">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8464523">}</span><br>
<span class="lineno"></span><span class="op" id="8464525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8464528">func</span>&nbsp;<span class="ident" id="8464533">TestCalibrate</span><span class="op" id="8464546">(</span><span class="ident" id="8464547">t</span>&nbsp;<span class="op" id="8464549">*</span><span class="ident" id="8464550">testing</span><span class="op" id="8464557">.</span><span class="ident" id="8464558">T</span><span class="op" id="8464559">)</span>&nbsp;<span class="op" id="8464561">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8464564">if</span>&nbsp;<span class="op" id="8464567">*</span><span class="ident" id="8464568">calibrate</span>&nbsp;<span class="op" id="8464578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8464582">computeThresholds</span><span class="op" id="8464599">(</span><span class="op" id="8464600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8464603">}</span><br>
<span class="lineno"></span><span class="op" id="8464605">}</span>
</div>
</body>
</html>
