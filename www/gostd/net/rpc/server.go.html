<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5377135">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5377190">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5377244">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5377295">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspPackage&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspnetwork&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspas&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspmethods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspobjects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspOnly&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspother&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspIn&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbspwhere&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThese&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbspsecond&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspsees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspwill&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptypically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplistener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbspNewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspboth&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspClient&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspcall,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspparameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsplaunches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspstructure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbspUnless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsptransport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspHere&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsppackage&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspA,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspQuo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsptype&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfunc&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreturn&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspThe&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsparith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsprpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspl,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspAt&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspclient,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbspThen&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspargs&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspvar&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsperr&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsplog.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspfmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspor<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspquotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspdivCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspreplyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbspA&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbspclient.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5381124">package</span>&nbsp;<span class="ident" id="5381132">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381137">import</span>&nbsp;<span class="op" id="5381144">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381147">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381156">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381172">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381182">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381188">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381195">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381202">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381214">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381225">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381236">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381244">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5381255">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5381270">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381273">const</span>&nbsp;<span class="op" id="5381279">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381282">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381314">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5381331">=</span>&nbsp;<span class="string" id="5381333">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381345">DefaultDebugPath</span>&nbsp;<span class="op" id="5381362">=</span>&nbsp;<span class="string" id="5381364">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5381377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5381380">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5381448">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5381517">var</span>&nbsp;<span class="ident" id="5381521">typeOfError</span>&nbsp;<span class="op" id="5381533">=</span>&nbsp;<span class="ident" id="5381535">reflect</span><span class="op" id="5381542">.</span><span class="ident" id="5381543">TypeOf</span><span class="op" id="5381549">(</span><span class="op" id="5381550">(</span><span class="op" id="5381551">*</span><span class="builtintype" id="5381552">error</span><span class="op" id="5381557">)</span><span class="op" id="5381558">(</span><span class="ident" id="5381559">nil</span><span class="op" id="5381562">)</span><span class="op" id="5381563">)</span><span class="op" id="5381564">.</span><span class="ident" id="5381565">Elem</span><span class="op" id="5381569">(</span><span class="op" id="5381570">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381573">type</span>&nbsp;<span class="ident" id="5381578">methodType</span>&nbsp;<span class="keyword" id="5381589">struct</span>&nbsp;<span class="op" id="5381596">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381599">sync</span><span class="op" id="5381603">.</span><span class="ident" id="5381604">Mutex</span>&nbsp;<span class="comment" id="5381610">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381632">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381643">reflect</span><span class="op" id="5381650">.</span><span class="ident" id="5381651">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381659">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381670">reflect</span><span class="op" id="5381677">.</span><span class="ident" id="5381678">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381684">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5381695">reflect</span><span class="op" id="5381702">.</span><span class="ident" id="5381703">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381709">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5381720">uint</span><br>
<span class="lineno">155</span><span class="op" id="5381725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381728">type</span>&nbsp;<span class="ident" id="5381733">service</span>&nbsp;<span class="keyword" id="5381741">struct</span>&nbsp;<span class="op" id="5381748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381751">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5381758">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381781">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381801">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5381808">reflect</span><span class="op" id="5381815">.</span><span class="ident" id="5381816">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381831">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381871">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5381878">reflect</span><span class="op" id="5381885">.</span><span class="ident" id="5381886">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5381901">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381926">method</span>&nbsp;<span class="keyword" id="5381933">map</span><span class="op" id="5381936">[</span><span class="builtintype" id="5381937">string</span><span class="op" id="5381943">]</span><span class="op" id="5381944">*</span><span class="ident" id="5381945">methodType</span>&nbsp;<span class="comment" id="5381956">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5381978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5381981">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5382058">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5382128">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5382148">type</span>&nbsp;<span class="ident" id="5382153">Request</span>&nbsp;<span class="keyword" id="5382161">struct</span>&nbsp;<span class="op" id="5382168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382171">ServiceMethod</span>&nbsp;<span class="builtintype" id="5382185">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5382194">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382223">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382237">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5382246">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382283">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5382297">*</span><span class="ident" id="5382298">Request</span>&nbsp;<span class="comment" id="5382306">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5382333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5382336">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5382416">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5382486">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5382506">type</span>&nbsp;<span class="ident" id="5382511">Response</span>&nbsp;<span class="keyword" id="5382520">struct</span>&nbsp;<span class="op" id="5382527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382530">ServiceMethod</span>&nbsp;<span class="builtintype" id="5382544">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5382554">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382585">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382599">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5382609">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382640">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5382654">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5382664">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382683">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5382697">*</span><span class="ident" id="5382698">Response</span>&nbsp;<span class="comment" id="5382707">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5382734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5382737">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5382773">type</span>&nbsp;<span class="ident" id="5382778">Server</span>&nbsp;<span class="keyword" id="5382785">struct</span>&nbsp;<span class="op" id="5382792">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382795">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382806">sync</span><span class="op" id="5382810">.</span><span class="ident" id="5382811">RWMutex</span>&nbsp;<span class="comment" id="5382819">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382847">serviceMap</span>&nbsp;<span class="keyword" id="5382858">map</span><span class="op" id="5382861">[</span><span class="builtintype" id="5382862">string</span><span class="op" id="5382868">]</span><span class="op" id="5382869">*</span><span class="ident" id="5382870">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382879">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5382890">sync</span><span class="op" id="5382894">.</span><span class="ident" id="5382895">Mutex</span>&nbsp;<span class="comment" id="5382901">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382922">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5382933">*</span><span class="ident" id="5382934">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382943">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5382954">sync</span><span class="op" id="5382958">.</span><span class="ident" id="5382959">Mutex</span>&nbsp;<span class="comment" id="5382965">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382987">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5382998">*</span><span class="ident" id="5382999">Response</span><br>
<span class="lineno"></span><span class="op" id="5383008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5383011">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5383046">func</span>&nbsp;<span class="ident" id="5383051">NewServer</span><span class="op" id="5383060">(</span><span class="op" id="5383061">)</span>&nbsp;<span class="op" id="5383063">*</span><span class="ident" id="5383064">Server</span>&nbsp;<span class="op" id="5383071">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383074">return</span>&nbsp;<span class="op" id="5383081">&amp;</span><span class="ident" id="5383082">Server</span><span class="op" id="5383088">{</span><span class="ident" id="5383089">serviceMap</span><span class="op" id="5383099">:</span>&nbsp;<span class="builtinfunc" id="5383101">make</span><span class="op" id="5383105">(</span><span class="keyword" id="5383106">map</span><span class="op" id="5383109">[</span><span class="builtintype" id="5383110">string</span><span class="op" id="5383116">]</span><span class="op" id="5383117">*</span><span class="ident" id="5383118">service</span><span class="op" id="5383125">)</span><span class="op" id="5383126">}</span><br>
<span class="lineno"></span><span class="op" id="5383128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5383131">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5383184">var</span>&nbsp;<span class="ident" id="5383188">DefaultServer</span>&nbsp;<span class="op" id="5383202">=</span>&nbsp;<span class="ident" id="5383204">NewServer</span><span class="op" id="5383213">(</span><span class="op" id="5383214">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5383217">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5383261">func</span>&nbsp;<span class="ident" id="5383266">isExported</span><span class="op" id="5383276">(</span><span class="ident" id="5383277">name</span>&nbsp;<span class="builtintype" id="5383282">string</span><span class="op" id="5383288">)</span>&nbsp;<span class="builtintype" id="5383290">bool</span>&nbsp;<span class="op" id="5383295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="5383298">rune</span><span class="op" id="5383302">,</span>&nbsp;<span class="ident" id="5383304">_</span>&nbsp;<span class="op" id="5383306">:=</span>&nbsp;<span class="ident" id="5383309">utf8</span><span class="op" id="5383313">.</span><span class="ident" id="5383314">DecodeRuneInString</span><span class="op" id="5383332">(</span><span class="ident" id="5383333">name</span><span class="op" id="5383337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383340">return</span>&nbsp;<span class="ident" id="5383347">unicode</span><span class="op" id="5383354">.</span><span class="ident" id="5383355">IsUpper</span><span class="op" id="5383362">(</span><span class="builtintype" id="5383363">rune</span><span class="op" id="5383367">)</span><br>
<span class="lineno">205</span><span class="op" id="5383369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5383372">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5383411">func</span>&nbsp;<span class="ident" id="5383416">isExportedOrBuiltinType</span><span class="op" id="5383439">(</span><span class="ident" id="5383440">t</span>&nbsp;<span class="ident" id="5383442">reflect</span><span class="op" id="5383449">.</span><span class="ident" id="5383450">Type</span><span class="op" id="5383454">)</span>&nbsp;<span class="builtintype" id="5383456">bool</span>&nbsp;<span class="op" id="5383461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383464">for</span>&nbsp;<span class="ident" id="5383468">t</span><span class="op" id="5383469">.</span><span class="ident" id="5383470">Kind</span><span class="op" id="5383474">(</span><span class="op" id="5383475">)</span>&nbsp;<span class="op" id="5383477">==</span>&nbsp;<span class="ident" id="5383480">reflect</span><span class="op" id="5383487">.</span><span class="ident" id="5383488">Ptr</span>&nbsp;<span class="op" id="5383492">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383496">t</span>&nbsp;<span class="op" id="5383498">=</span>&nbsp;<span class="ident" id="5383500">t</span><span class="op" id="5383501">.</span><span class="ident" id="5383502">Elem</span><span class="op" id="5383506">(</span><span class="op" id="5383507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383513">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383570">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383617">return</span>&nbsp;<span class="ident" id="5383624">isExported</span><span class="op" id="5383634">(</span><span class="ident" id="5383635">t</span><span class="op" id="5383636">.</span><span class="ident" id="5383637">Name</span><span class="op" id="5383641">(</span><span class="op" id="5383642">)</span><span class="op" id="5383643">)</span>&nbsp;<span class="op" id="5383645">||</span>&nbsp;<span class="ident" id="5383648">t</span><span class="op" id="5383649">.</span><span class="ident" id="5383650">PkgPath</span><span class="op" id="5383657">(</span><span class="op" id="5383658">)</span>&nbsp;<span class="op" id="5383660">==</span>&nbsp;<span class="string" id="5383663">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5383666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5383669">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5383731">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5383788">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5383809">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5383851">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5383889">//&nbsp;&nbsp;&nbsp;&nbsp-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5383926">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5383996">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5384062">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5384139">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5384186">func</span>&nbsp;<span class="op" id="5384191">(</span><span class="ident" id="5384192">server</span>&nbsp;<span class="op" id="5384199">*</span><span class="ident" id="5384200">Server</span><span class="op" id="5384206">)</span>&nbsp;<span class="ident" id="5384208">Register</span><span class="op" id="5384216">(</span><span class="ident" id="5384217">rcvr</span>&nbsp;<span class="keyword" id="5384222">interface</span><span class="op" id="5384231">{</span><span class="op" id="5384232">}</span><span class="op" id="5384233">)</span>&nbsp;<span class="builtintype" id="5384235">error</span>&nbsp;<span class="op" id="5384241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384244">return</span>&nbsp;<span class="ident" id="5384251">server</span><span class="op" id="5384257">.</span><span class="ident" id="5384258">register</span><span class="op" id="5384266">(</span><span class="ident" id="5384267">rcvr</span><span class="op" id="5384271">,</span>&nbsp;<span class="string" id="5384273">&#34;&#34;</span><span class="op" id="5384275">,</span>&nbsp;<span class="builtintype" id="5384277">false</span><span class="op" id="5384282">)</span><br>
<span class="lineno"></span><span class="op" id="5384284">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5384287">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5384360">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5384404">func</span>&nbsp;<span class="op" id="5384409">(</span><span class="ident" id="5384410">server</span>&nbsp;<span class="op" id="5384417">*</span><span class="ident" id="5384418">Server</span><span class="op" id="5384424">)</span>&nbsp;<span class="ident" id="5384426">RegisterName</span><span class="op" id="5384438">(</span><span class="ident" id="5384439">name</span>&nbsp;<span class="builtintype" id="5384444">string</span><span class="op" id="5384450">,</span>&nbsp;<span class="ident" id="5384452">rcvr</span>&nbsp;<span class="keyword" id="5384457">interface</span><span class="op" id="5384466">{</span><span class="op" id="5384467">}</span><span class="op" id="5384468">)</span>&nbsp;<span class="builtintype" id="5384470">error</span>&nbsp;<span class="op" id="5384476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384479">return</span>&nbsp;<span class="ident" id="5384486">server</span><span class="op" id="5384492">.</span><span class="ident" id="5384493">register</span><span class="op" id="5384501">(</span><span class="ident" id="5384502">rcvr</span><span class="op" id="5384506">,</span>&nbsp;<span class="ident" id="5384508">name</span><span class="op" id="5384512">,</span>&nbsp;<span class="builtintype" id="5384514">true</span><span class="op" id="5384518">)</span><br>
<span class="lineno">235</span><span class="op" id="5384520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5384523">func</span>&nbsp;<span class="op" id="5384528">(</span><span class="ident" id="5384529">server</span>&nbsp;<span class="op" id="5384536">*</span><span class="ident" id="5384537">Server</span><span class="op" id="5384543">)</span>&nbsp;<span class="ident" id="5384545">register</span><span class="op" id="5384553">(</span><span class="ident" id="5384554">rcvr</span>&nbsp;<span class="keyword" id="5384559">interface</span><span class="op" id="5384568">{</span><span class="op" id="5384569">}</span><span class="op" id="5384570">,</span>&nbsp;<span class="ident" id="5384572">name</span>&nbsp;<span class="builtintype" id="5384577">string</span><span class="op" id="5384583">,</span>&nbsp;<span class="ident" id="5384585">useName</span>&nbsp;<span class="builtintype" id="5384593">bool</span><span class="op" id="5384597">)</span>&nbsp;<span class="builtintype" id="5384599">error</span>&nbsp;<span class="op" id="5384605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384608">server</span><span class="op" id="5384614">.</span><span class="ident" id="5384615">mu</span><span class="op" id="5384617">.</span><span class="ident" id="5384618">Lock</span><span class="op" id="5384622">(</span><span class="op" id="5384623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384626">defer</span>&nbsp;<span class="ident" id="5384632">server</span><span class="op" id="5384638">.</span><span class="ident" id="5384639">mu</span><span class="op" id="5384641">.</span><span class="ident" id="5384642">Unlock</span><span class="op" id="5384648">(</span><span class="op" id="5384649">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384652">if</span>&nbsp;<span class="ident" id="5384655">server</span><span class="op" id="5384661">.</span><span class="ident" id="5384662">serviceMap</span>&nbsp;<span class="op" id="5384673">==</span>&nbsp;<span class="ident" id="5384676">nil</span>&nbsp;<span class="op" id="5384680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384684">server</span><span class="op" id="5384690">.</span><span class="ident" id="5384691">serviceMap</span>&nbsp;<span class="op" id="5384702">=</span>&nbsp;<span class="builtinfunc" id="5384704">make</span><span class="op" id="5384708">(</span><span class="keyword" id="5384709">map</span><span class="op" id="5384712">[</span><span class="builtintype" id="5384713">string</span><span class="op" id="5384719">]</span><span class="op" id="5384720">*</span><span class="ident" id="5384721">service</span><span class="op" id="5384728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384734">s</span>&nbsp;<span class="op" id="5384736">:=</span>&nbsp;<span class="builtinfunc" id="5384739">new</span><span class="op" id="5384742">(</span><span class="ident" id="5384743">service</span><span class="op" id="5384750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384753">s</span><span class="op" id="5384754">.</span><span class="ident" id="5384755">typ</span>&nbsp;<span class="op" id="5384759">=</span>&nbsp;<span class="ident" id="5384761">reflect</span><span class="op" id="5384768">.</span><span class="ident" id="5384769">TypeOf</span><span class="op" id="5384775">(</span><span class="ident" id="5384776">rcvr</span><span class="op" id="5384780">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384783">s</span><span class="op" id="5384784">.</span><span class="ident" id="5384785">rcvr</span>&nbsp;<span class="op" id="5384790">=</span>&nbsp;<span class="ident" id="5384792">reflect</span><span class="op" id="5384799">.</span><span class="ident" id="5384800">ValueOf</span><span class="op" id="5384807">(</span><span class="ident" id="5384808">rcvr</span><span class="op" id="5384812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384815">sname</span>&nbsp;<span class="op" id="5384821">:=</span>&nbsp;<span class="ident" id="5384824">reflect</span><span class="op" id="5384831">.</span><span class="ident" id="5384832">Indirect</span><span class="op" id="5384840">(</span><span class="ident" id="5384841">s</span><span class="op" id="5384842">.</span><span class="ident" id="5384843">rcvr</span><span class="op" id="5384847">)</span><span class="op" id="5384848">.</span><span class="ident" id="5384849">Type</span><span class="op" id="5384853">(</span><span class="op" id="5384854">)</span><span class="op" id="5384855">.</span><span class="ident" id="5384856">Name</span><span class="op" id="5384860">(</span><span class="op" id="5384861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384864">if</span>&nbsp;<span class="ident" id="5384867">useName</span>&nbsp;<span class="op" id="5384875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384879">sname</span>&nbsp;<span class="op" id="5384885">=</span>&nbsp;<span class="ident" id="5384887">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384893">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384896">if</span>&nbsp;<span class="ident" id="5384899">sname</span>&nbsp;<span class="op" id="5384905">==</span>&nbsp;<span class="string" id="5384908">&#34;&#34;</span>&nbsp;<span class="op" id="5384911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384915">s</span>&nbsp;<span class="op" id="5384917">:=</span>&nbsp;<span class="string" id="5384920">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5384962">+</span>&nbsp;<span class="ident" id="5384964">s</span><span class="op" id="5384965">.</span><span class="ident" id="5384966">typ</span><span class="op" id="5384969">.</span><span class="ident" id="5384970">String</span><span class="op" id="5384976">(</span><span class="op" id="5384977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384981">log</span><span class="op" id="5384984">.</span><span class="ident" id="5384985">Print</span><span class="op" id="5384990">(</span><span class="ident" id="5384991">s</span><span class="op" id="5384992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384996">return</span>&nbsp;<span class="ident" id="5385003">errors</span><span class="op" id="5385009">.</span><span class="ident" id="5385010">New</span><span class="op" id="5385013">(</span><span class="ident" id="5385014">s</span><span class="op" id="5385015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385018">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385021">if</span>&nbsp;<span class="op" id="5385024">!</span><span class="ident" id="5385025">isExported</span><span class="op" id="5385035">(</span><span class="ident" id="5385036">sname</span><span class="op" id="5385041">)</span>&nbsp;<span class="op" id="5385043">&amp;&amp;</span>&nbsp;<span class="op" id="5385046">!</span><span class="ident" id="5385047">useName</span>&nbsp;<span class="op" id="5385055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385059">s</span>&nbsp;<span class="op" id="5385061">:=</span>&nbsp;<span class="string" id="5385064">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5385086">+</span>&nbsp;<span class="ident" id="5385088">sname</span>&nbsp;<span class="op" id="5385094">+</span>&nbsp;<span class="string" id="5385096">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385117">log</span><span class="op" id="5385120">.</span><span class="ident" id="5385121">Print</span><span class="op" id="5385126">(</span><span class="ident" id="5385127">s</span><span class="op" id="5385128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385132">return</span>&nbsp;<span class="ident" id="5385139">errors</span><span class="op" id="5385145">.</span><span class="ident" id="5385146">New</span><span class="op" id="5385149">(</span><span class="ident" id="5385150">s</span><span class="op" id="5385151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385154">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385157">if</span>&nbsp;<span class="ident" id="5385160">_</span><span class="op" id="5385161">,</span>&nbsp;<span class="ident" id="5385163">present</span>&nbsp;<span class="op" id="5385171">:=</span>&nbsp;<span class="ident" id="5385174">server</span><span class="op" id="5385180">.</span><span class="ident" id="5385181">serviceMap</span><span class="op" id="5385191">[</span><span class="ident" id="5385192">sname</span><span class="op" id="5385197">]</span><span class="op" id="5385198">;</span>&nbsp;<span class="ident" id="5385200">present</span>&nbsp;<span class="op" id="5385208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385212">return</span>&nbsp;<span class="ident" id="5385219">errors</span><span class="op" id="5385225">.</span><span class="ident" id="5385226">New</span><span class="op" id="5385229">(</span><span class="string" id="5385230">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5385263">+</span>&nbsp;<span class="ident" id="5385265">sname</span><span class="op" id="5385270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385276">s</span><span class="op" id="5385277">.</span><span class="ident" id="5385278">name</span>&nbsp;<span class="op" id="5385283">=</span>&nbsp;<span class="ident" id="5385285">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385293">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385317">s</span><span class="op" id="5385318">.</span><span class="ident" id="5385319">method</span>&nbsp;<span class="op" id="5385326">=</span>&nbsp;<span class="ident" id="5385328">suitableMethods</span><span class="op" id="5385343">(</span><span class="ident" id="5385344">s</span><span class="op" id="5385345">.</span><span class="ident" id="5385346">typ</span><span class="op" id="5385349">,</span>&nbsp;<span class="builtintype" id="5385351">true</span><span class="op" id="5385355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385359">if</span>&nbsp;<span class="builtinfunc" id="5385362">len</span><span class="op" id="5385365">(</span><span class="ident" id="5385366">s</span><span class="op" id="5385367">.</span><span class="ident" id="5385368">method</span><span class="op" id="5385374">)</span>&nbsp;<span class="op" id="5385376">==</span>&nbsp;<span class="num" id="5385379">0</span>&nbsp;<span class="op" id="5385381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385385">str</span>&nbsp;<span class="op" id="5385389">:=</span>&nbsp;<span class="string" id="5385392">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385398">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385459">method</span>&nbsp;<span class="op" id="5385466">:=</span>&nbsp;<span class="ident" id="5385469">suitableMethods</span><span class="op" id="5385484">(</span><span class="ident" id="5385485">reflect</span><span class="op" id="5385492">.</span><span class="ident" id="5385493">PtrTo</span><span class="op" id="5385498">(</span><span class="ident" id="5385499">s</span><span class="op" id="5385500">.</span><span class="ident" id="5385501">typ</span><span class="op" id="5385504">)</span><span class="op" id="5385505">,</span>&nbsp;<span class="builtintype" id="5385507">false</span><span class="op" id="5385512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385516">if</span>&nbsp;<span class="builtinfunc" id="5385519">len</span><span class="op" id="5385522">(</span><span class="ident" id="5385523">method</span><span class="op" id="5385529">)</span>&nbsp;<span class="op" id="5385531">!=</span>&nbsp;<span class="num" id="5385534">0</span>&nbsp;<span class="op" id="5385536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385541">str</span>&nbsp;<span class="op" id="5385545">=</span>&nbsp;<span class="string" id="5385547">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5385569">+</span>&nbsp;<span class="ident" id="5385571">sname</span>&nbsp;<span class="op" id="5385577">+</span>&nbsp;<span class="string" id="5385579">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385670">}</span>&nbsp;<span class="keyword" id="5385672">else</span>&nbsp;<span class="op" id="5385677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385682">str</span>&nbsp;<span class="op" id="5385686">=</span>&nbsp;<span class="string" id="5385688">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5385710">+</span>&nbsp;<span class="ident" id="5385712">sname</span>&nbsp;<span class="op" id="5385718">+</span>&nbsp;<span class="string" id="5385720">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385770">log</span><span class="op" id="5385773">.</span><span class="ident" id="5385774">Print</span><span class="op" id="5385779">(</span><span class="ident" id="5385780">str</span><span class="op" id="5385783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385787">return</span>&nbsp;<span class="ident" id="5385794">errors</span><span class="op" id="5385800">.</span><span class="ident" id="5385801">New</span><span class="op" id="5385804">(</span><span class="ident" id="5385805">str</span><span class="op" id="5385808">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385814">server</span><span class="op" id="5385820">.</span><span class="ident" id="5385821">serviceMap</span><span class="op" id="5385831">[</span><span class="ident" id="5385832">s</span><span class="op" id="5385833">.</span><span class="ident" id="5385834">name</span><span class="op" id="5385838">]</span>&nbsp;<span class="op" id="5385840">=</span>&nbsp;<span class="ident" id="5385842">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385845">return</span>&nbsp;<span class="ident" id="5385852">nil</span><br>
<span class="lineno"></span><span class="op" id="5385856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5385859">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5385930">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5385971">func</span>&nbsp;<span class="ident" id="5385976">suitableMethods</span><span class="op" id="5385991">(</span><span class="ident" id="5385992">typ</span>&nbsp;<span class="ident" id="5385996">reflect</span><span class="op" id="5386003">.</span><span class="ident" id="5386004">Type</span><span class="op" id="5386008">,</span>&nbsp;<span class="ident" id="5386010">reportErr</span>&nbsp;<span class="builtintype" id="5386020">bool</span><span class="op" id="5386024">)</span>&nbsp;<span class="keyword" id="5386026">map</span><span class="op" id="5386029">[</span><span class="builtintype" id="5386030">string</span><span class="op" id="5386036">]</span><span class="op" id="5386037">*</span><span class="ident" id="5386038">methodType</span>&nbsp;<span class="op" id="5386049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386052">methods</span>&nbsp;<span class="op" id="5386060">:=</span>&nbsp;<span class="builtinfunc" id="5386063">make</span><span class="op" id="5386067">(</span><span class="keyword" id="5386068">map</span><span class="op" id="5386071">[</span><span class="builtintype" id="5386072">string</span><span class="op" id="5386078">]</span><span class="op" id="5386079">*</span><span class="ident" id="5386080">methodType</span><span class="op" id="5386090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386093">for</span>&nbsp;<span class="ident" id="5386097">m</span>&nbsp;<span class="op" id="5386099">:=</span>&nbsp;<span class="num" id="5386102">0</span><span class="op" id="5386103">;</span>&nbsp;<span class="ident" id="5386105">m</span>&nbsp;<span class="op" id="5386107">&lt;</span>&nbsp;<span class="ident" id="5386109">typ</span><span class="op" id="5386112">.</span><span class="ident" id="5386113">NumMethod</span><span class="op" id="5386122">(</span><span class="op" id="5386123">)</span><span class="op" id="5386124">;</span>&nbsp;<span class="ident" id="5386126">m</span><span class="op" id="5386127">++</span>&nbsp;<span class="op" id="5386130">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386134">method</span>&nbsp;<span class="op" id="5386141">:=</span>&nbsp;<span class="ident" id="5386144">typ</span><span class="op" id="5386147">.</span><span class="ident" id="5386148">Method</span><span class="op" id="5386154">(</span><span class="ident" id="5386155">m</span><span class="op" id="5386156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386160">mtype</span>&nbsp;<span class="op" id="5386166">:=</span>&nbsp;<span class="ident" id="5386169">method</span><span class="op" id="5386175">.</span><span class="ident" id="5386176">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386183">mname</span>&nbsp;<span class="op" id="5386189">:=</span>&nbsp;<span class="ident" id="5386192">method</span><span class="op" id="5386198">.</span><span class="ident" id="5386199">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386206">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386236">if</span>&nbsp;<span class="ident" id="5386239">method</span><span class="op" id="5386245">.</span><span class="ident" id="5386246">PkgPath</span>&nbsp;<span class="op" id="5386254">!=</span>&nbsp;<span class="string" id="5386257">&#34;&#34;</span>&nbsp;<span class="op" id="5386260">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386265">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386280">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386334">if</span>&nbsp;<span class="ident" id="5386337">mtype</span><span class="op" id="5386342">.</span><span class="ident" id="5386343">NumIn</span><span class="op" id="5386348">(</span><span class="op" id="5386349">)</span>&nbsp;<span class="op" id="5386351">!=</span>&nbsp;<span class="num" id="5386354">3</span>&nbsp;<span class="op" id="5386356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386361">if</span>&nbsp;<span class="ident" id="5386364">reportErr</span>&nbsp;<span class="op" id="5386374">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386380">log</span><span class="op" id="5386383">.</span><span class="ident" id="5386384">Println</span><span class="op" id="5386391">(</span><span class="string" id="5386392">&#34;method&#34;</span><span class="op" id="5386400">,</span>&nbsp;<span class="ident" id="5386402">mname</span><span class="op" id="5386407">,</span>&nbsp;<span class="string" id="5386409">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5386435">,</span>&nbsp;<span class="ident" id="5386437">mtype</span><span class="op" id="5386442">.</span><span class="ident" id="5386443">NumIn</span><span class="op" id="5386448">(</span><span class="op" id="5386449">)</span><span class="op" id="5386450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386460">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386475">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386513">argType</span>&nbsp;<span class="op" id="5386521">:=</span>&nbsp;<span class="ident" id="5386524">mtype</span><span class="op" id="5386529">.</span><span class="ident" id="5386530">In</span><span class="op" id="5386532">(</span><span class="num" id="5386533">1</span><span class="op" id="5386534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386538">if</span>&nbsp;<span class="op" id="5386541">!</span><span class="ident" id="5386542">isExportedOrBuiltinType</span><span class="op" id="5386565">(</span><span class="ident" id="5386566">argType</span><span class="op" id="5386573">)</span>&nbsp;<span class="op" id="5386575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386580">if</span>&nbsp;<span class="ident" id="5386583">reportErr</span>&nbsp;<span class="op" id="5386593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386599">log</span><span class="op" id="5386602">.</span><span class="ident" id="5386603">Println</span><span class="op" id="5386610">(</span><span class="ident" id="5386611">mname</span><span class="op" id="5386616">,</span>&nbsp;<span class="string" id="5386618">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5386647">,</span>&nbsp;<span class="ident" id="5386649">argType</span><span class="op" id="5386656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386661">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386666">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386681">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386716">replyType</span>&nbsp;<span class="op" id="5386726">:=</span>&nbsp;<span class="ident" id="5386729">mtype</span><span class="op" id="5386734">.</span><span class="ident" id="5386735">In</span><span class="op" id="5386737">(</span><span class="num" id="5386738">2</span><span class="op" id="5386739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386743">if</span>&nbsp;<span class="ident" id="5386746">replyType</span><span class="op" id="5386755">.</span><span class="ident" id="5386756">Kind</span><span class="op" id="5386760">(</span><span class="op" id="5386761">)</span>&nbsp;<span class="op" id="5386763">!=</span>&nbsp;<span class="ident" id="5386766">reflect</span><span class="op" id="5386773">.</span><span class="ident" id="5386774">Ptr</span>&nbsp;<span class="op" id="5386778">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386783">if</span>&nbsp;<span class="ident" id="5386786">reportErr</span>&nbsp;<span class="op" id="5386796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386802">log</span><span class="op" id="5386805">.</span><span class="ident" id="5386806">Println</span><span class="op" id="5386813">(</span><span class="string" id="5386814">&#34;method&#34;</span><span class="op" id="5386822">,</span>&nbsp;<span class="ident" id="5386824">mname</span><span class="op" id="5386829">,</span>&nbsp;<span class="string" id="5386831">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5386858">,</span>&nbsp;<span class="ident" id="5386860">replyType</span><span class="op" id="5386869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386879">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5386890">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5386894">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386928">if</span>&nbsp;<span class="op" id="5386931">!</span><span class="ident" id="5386932">isExportedOrBuiltinType</span><span class="op" id="5386955">(</span><span class="ident" id="5386956">replyType</span><span class="op" id="5386965">)</span>&nbsp;<span class="op" id="5386967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5386972">if</span>&nbsp;<span class="ident" id="5386975">reportErr</span>&nbsp;<span class="op" id="5386985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5386991">log</span><span class="op" id="5386994">.</span><span class="ident" id="5386995">Println</span><span class="op" id="5387002">(</span><span class="string" id="5387003">&#34;method&#34;</span><span class="op" id="5387011">,</span>&nbsp;<span class="ident" id="5387013">mname</span><span class="op" id="5387018">,</span>&nbsp;<span class="string" id="5387020">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5387046">,</span>&nbsp;<span class="ident" id="5387048">replyType</span><span class="op" id="5387057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387062">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387067">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387082">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387109">if</span>&nbsp;<span class="ident" id="5387112">mtype</span><span class="op" id="5387117">.</span><span class="ident" id="5387118">NumOut</span><span class="op" id="5387124">(</span><span class="op" id="5387125">)</span>&nbsp;<span class="op" id="5387127">!=</span>&nbsp;<span class="num" id="5387130">1</span>&nbsp;<span class="op" id="5387132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387137">if</span>&nbsp;<span class="ident" id="5387140">reportErr</span>&nbsp;<span class="op" id="5387150">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387156">log</span><span class="op" id="5387159">.</span><span class="ident" id="5387160">Println</span><span class="op" id="5387167">(</span><span class="string" id="5387168">&#34;method&#34;</span><span class="op" id="5387176">,</span>&nbsp;<span class="ident" id="5387178">mname</span><span class="op" id="5387183">,</span>&nbsp;<span class="string" id="5387185">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5387212">,</span>&nbsp;<span class="ident" id="5387214">mtype</span><span class="op" id="5387219">.</span><span class="ident" id="5387220">NumOut</span><span class="op" id="5387226">(</span><span class="op" id="5387227">)</span><span class="op" id="5387228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387238">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387253">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387303">if</span>&nbsp;<span class="ident" id="5387306">returnType</span>&nbsp;<span class="op" id="5387317">:=</span>&nbsp;<span class="ident" id="5387320">mtype</span><span class="op" id="5387325">.</span><span class="ident" id="5387326">Out</span><span class="op" id="5387329">(</span><span class="num" id="5387330">0</span><span class="op" id="5387331">)</span><span class="op" id="5387332">;</span>&nbsp;<span class="ident" id="5387334">returnType</span>&nbsp;<span class="op" id="5387345">!=</span>&nbsp;<span class="ident" id="5387348">typeOfError</span>&nbsp;<span class="op" id="5387360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387365">if</span>&nbsp;<span class="ident" id="5387368">reportErr</span>&nbsp;<span class="op" id="5387378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387384">log</span><span class="op" id="5387387">.</span><span class="ident" id="5387388">Println</span><span class="op" id="5387395">(</span><span class="string" id="5387396">&#34;method&#34;</span><span class="op" id="5387404">,</span>&nbsp;<span class="ident" id="5387406">mname</span><span class="op" id="5387411">,</span>&nbsp;<span class="string" id="5387413">&#34;returns&#34;</span><span class="op" id="5387422">,</span>&nbsp;<span class="ident" id="5387424">returnType</span><span class="op" id="5387434">.</span><span class="ident" id="5387435">String</span><span class="op" id="5387441">(</span><span class="op" id="5387442">)</span><span class="op" id="5387443">,</span>&nbsp;<span class="string" id="5387445">&#34;not&nbsp;error&#34;</span><span class="op" id="5387456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387466">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387481">methods</span><span class="op" id="5387488">[</span><span class="ident" id="5387489">mname</span><span class="op" id="5387494">]</span>&nbsp;<span class="op" id="5387496">=</span>&nbsp;<span class="op" id="5387498">&amp;</span><span class="ident" id="5387499">methodType</span><span class="op" id="5387509">{</span><span class="ident" id="5387510">method</span><span class="op" id="5387516">:</span>&nbsp;<span class="ident" id="5387518">method</span><span class="op" id="5387524">,</span>&nbsp;<span class="ident" id="5387526">ArgType</span><span class="op" id="5387533">:</span>&nbsp;<span class="ident" id="5387535">argType</span><span class="op" id="5387542">,</span>&nbsp;<span class="ident" id="5387544">ReplyType</span><span class="op" id="5387553">:</span>&nbsp;<span class="ident" id="5387555">replyType</span><span class="op" id="5387564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5387567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5387570">return</span>&nbsp;<span class="ident" id="5387577">methods</span><br>
<span class="lineno"></span><span class="op" id="5387585">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5387588">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5387669">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5387754">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5387792">var</span>&nbsp;<span class="ident" id="5387796">invalidRequest</span>&nbsp;<span class="op" id="5387811">=</span>&nbsp;<span class="keyword" id="5387813">struct</span><span class="op" id="5387819">{</span><span class="op" id="5387820">}</span><span class="op" id="5387821">{</span><span class="op" id="5387822">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5387825">func</span>&nbsp;<span class="op" id="5387830">(</span><span class="ident" id="5387831">server</span>&nbsp;<span class="op" id="5387838">*</span><span class="ident" id="5387839">Server</span><span class="op" id="5387845">)</span>&nbsp;<span class="ident" id="5387847">sendResponse</span><span class="op" id="5387859">(</span><span class="ident" id="5387860">sending</span>&nbsp;<span class="op" id="5387868">*</span><span class="ident" id="5387869">sync</span><span class="op" id="5387873">.</span><span class="ident" id="5387874">Mutex</span><span class="op" id="5387879">,</span>&nbsp;<span class="ident" id="5387881">req</span>&nbsp;<span class="op" id="5387885">*</span><span class="ident" id="5387886">Request</span><span class="op" id="5387893">,</span>&nbsp;<span class="ident" id="5387895">reply</span>&nbsp;<span class="keyword" id="5387901">interface</span><span class="op" id="5387910">{</span><span class="op" id="5387911">}</span><span class="op" id="5387912">,</span>&nbsp;<span class="ident" id="5387914">codec</span>&nbsp;<span class="ident" id="5387920">ServerCodec</span><span class="op" id="5387931">,</span>&nbsp;<span class="ident" id="5387933">errmsg</span>&nbsp;<span class="builtintype" id="5387940">string</span><span class="op" id="5387946">)</span>&nbsp;<span class="op" id="5387948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5387951">resp</span>&nbsp;<span class="op" id="5387956">:=</span>&nbsp;<span class="ident" id="5387959">server</span><span class="op" id="5387965">.</span><span class="ident" id="5387966">getResponse</span><span class="op" id="5387977">(</span><span class="op" id="5387978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5387981">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388012">resp</span><span class="op" id="5388016">.</span><span class="ident" id="5388017">ServiceMethod</span>&nbsp;<span class="op" id="5388031">=</span>&nbsp;<span class="ident" id="5388033">req</span><span class="op" id="5388036">.</span><span class="ident" id="5388037">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388052">if</span>&nbsp;<span class="ident" id="5388055">errmsg</span>&nbsp;<span class="op" id="5388062">!=</span>&nbsp;<span class="string" id="5388065">&#34;&#34;</span>&nbsp;<span class="op" id="5388068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388072">resp</span><span class="op" id="5388076">.</span><span class="ident" id="5388077">Error</span>&nbsp;<span class="op" id="5388083">=</span>&nbsp;<span class="ident" id="5388085">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388094">reply</span>&nbsp;<span class="op" id="5388100">=</span>&nbsp;<span class="ident" id="5388102">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388121">resp</span><span class="op" id="5388125">.</span><span class="ident" id="5388126">Seq</span>&nbsp;<span class="op" id="5388130">=</span>&nbsp;<span class="ident" id="5388132">req</span><span class="op" id="5388135">.</span><span class="ident" id="5388136">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388141">sending</span><span class="op" id="5388148">.</span><span class="ident" id="5388149">Lock</span><span class="op" id="5388153">(</span><span class="op" id="5388154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388157">err</span>&nbsp;<span class="op" id="5388161">:=</span>&nbsp;<span class="ident" id="5388164">codec</span><span class="op" id="5388169">.</span><span class="ident" id="5388170">WriteResponse</span><span class="op" id="5388183">(</span><span class="ident" id="5388184">resp</span><span class="op" id="5388188">,</span>&nbsp;<span class="ident" id="5388190">reply</span><span class="op" id="5388195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388198">if</span>&nbsp;<span class="ident" id="5388201">debugLog</span>&nbsp;<span class="op" id="5388210">&amp;&amp;</span>&nbsp;<span class="ident" id="5388213">err</span>&nbsp;<span class="op" id="5388217">!=</span>&nbsp;<span class="ident" id="5388220">nil</span>&nbsp;<span class="op" id="5388224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388228">log</span><span class="op" id="5388231">.</span><span class="ident" id="5388232">Println</span><span class="op" id="5388239">(</span><span class="string" id="5388240">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5388264">,</span>&nbsp;<span class="ident" id="5388266">err</span><span class="op" id="5388269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388272">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388275">sending</span><span class="op" id="5388282">.</span><span class="ident" id="5388283">Unlock</span><span class="op" id="5388289">(</span><span class="op" id="5388290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388293">server</span><span class="op" id="5388299">.</span><span class="ident" id="5388300">freeResponse</span><span class="op" id="5388312">(</span><span class="ident" id="5388313">resp</span><span class="op" id="5388317">)</span><br>
<span class="lineno"></span><span class="op" id="5388319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5388322">func</span>&nbsp;<span class="op" id="5388327">(</span><span class="ident" id="5388328">m</span>&nbsp;<span class="op" id="5388330">*</span><span class="ident" id="5388331">methodType</span><span class="op" id="5388341">)</span>&nbsp;<span class="ident" id="5388343">NumCalls</span><span class="op" id="5388351">(</span><span class="op" id="5388352">)</span>&nbsp;<span class="op" id="5388354">(</span><span class="ident" id="5388355">n</span>&nbsp;<span class="builtintype" id="5388357">uint</span><span class="op" id="5388361">)</span>&nbsp;<span class="op" id="5388363">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388366">m</span><span class="op" id="5388367">.</span><span class="ident" id="5388368">Lock</span><span class="op" id="5388372">(</span><span class="op" id="5388373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388376">n</span>&nbsp;<span class="op" id="5388378">=</span>&nbsp;<span class="ident" id="5388380">m</span><span class="op" id="5388381">.</span><span class="ident" id="5388382">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388392">m</span><span class="op" id="5388393">.</span><span class="ident" id="5388394">Unlock</span><span class="op" id="5388400">(</span><span class="op" id="5388401">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388404">return</span>&nbsp;<span class="ident" id="5388411">n</span><br>
<span class="lineno"></span><span class="op" id="5388413">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5388416">func</span>&nbsp;<span class="op" id="5388421">(</span><span class="ident" id="5388422">s</span>&nbsp;<span class="op" id="5388424">*</span><span class="ident" id="5388425">service</span><span class="op" id="5388432">)</span>&nbsp;<span class="ident" id="5388434">call</span><span class="op" id="5388438">(</span><span class="ident" id="5388439">server</span>&nbsp;<span class="op" id="5388446">*</span><span class="ident" id="5388447">Server</span><span class="op" id="5388453">,</span>&nbsp;<span class="ident" id="5388455">sending</span>&nbsp;<span class="op" id="5388463">*</span><span class="ident" id="5388464">sync</span><span class="op" id="5388468">.</span><span class="ident" id="5388469">Mutex</span><span class="op" id="5388474">,</span>&nbsp;<span class="ident" id="5388476">mtype</span>&nbsp;<span class="op" id="5388482">*</span><span class="ident" id="5388483">methodType</span><span class="op" id="5388493">,</span>&nbsp;<span class="ident" id="5388495">req</span>&nbsp;<span class="op" id="5388499">*</span><span class="ident" id="5388500">Request</span><span class="op" id="5388507">,</span>&nbsp;<span class="ident" id="5388509">argv</span><span class="op" id="5388513">,</span>&nbsp;<span class="ident" id="5388515">replyv</span>&nbsp;<span class="ident" id="5388522">reflect</span><span class="op" id="5388529">.</span><span class="ident" id="5388530">Value</span><span class="op" id="5388535">,</span>&nbsp;<span class="ident" id="5388537">codec</span>&nbsp;<span class="ident" id="5388543">ServerCodec</span><span class="op" id="5388554">)</span>&nbsp;<span class="op" id="5388556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388559">mtype</span><span class="op" id="5388564">.</span><span class="ident" id="5388565">Lock</span><span class="op" id="5388569">(</span><span class="op" id="5388570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388573">mtype</span><span class="op" id="5388578">.</span><span class="ident" id="5388579">numCalls</span><span class="op" id="5388587">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388591">mtype</span><span class="op" id="5388596">.</span><span class="ident" id="5388597">Unlock</span><span class="op" id="5388603">(</span><span class="op" id="5388604">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388607">function</span>&nbsp;<span class="op" id="5388616">:=</span>&nbsp;<span class="ident" id="5388619">mtype</span><span class="op" id="5388624">.</span><span class="ident" id="5388625">method</span><span class="op" id="5388631">.</span><span class="ident" id="5388632">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388638">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388698">returnValues</span>&nbsp;<span class="op" id="5388711">:=</span>&nbsp;<span class="ident" id="5388714">function</span><span class="op" id="5388722">.</span><span class="ident" id="5388723">Call</span><span class="op" id="5388727">(</span><span class="op" id="5388728">[</span><span class="op" id="5388729">]</span><span class="ident" id="5388730">reflect</span><span class="op" id="5388737">.</span><span class="ident" id="5388738">Value</span><span class="op" id="5388743">{</span><span class="ident" id="5388744">s</span><span class="op" id="5388745">.</span><span class="ident" id="5388746">rcvr</span><span class="op" id="5388750">,</span>&nbsp;<span class="ident" id="5388752">argv</span><span class="op" id="5388756">,</span>&nbsp;<span class="ident" id="5388758">replyv</span><span class="op" id="5388764">}</span><span class="op" id="5388765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5388768">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388817">errInter</span>&nbsp;<span class="op" id="5388826">:=</span>&nbsp;<span class="ident" id="5388829">returnValues</span><span class="op" id="5388841">[</span><span class="num" id="5388842">0</span><span class="op" id="5388843">]</span><span class="op" id="5388844">.</span><span class="ident" id="5388845">Interface</span><span class="op" id="5388854">(</span><span class="op" id="5388855">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388858">errmsg</span>&nbsp;<span class="op" id="5388865">:=</span>&nbsp;<span class="string" id="5388868">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5388872">if</span>&nbsp;<span class="ident" id="5388875">errInter</span>&nbsp;<span class="op" id="5388884">!=</span>&nbsp;<span class="ident" id="5388887">nil</span>&nbsp;<span class="op" id="5388891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388895">errmsg</span>&nbsp;<span class="op" id="5388902">=</span>&nbsp;<span class="ident" id="5388904">errInter</span><span class="op" id="5388912">.</span><span class="op" id="5388913">(</span><span class="builtintype" id="5388914">error</span><span class="op" id="5388919">)</span><span class="op" id="5388920">.</span><span class="ident" id="5388921">Error</span><span class="op" id="5388926">(</span><span class="op" id="5388927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5388930">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5388933">server</span><span class="op" id="5388939">.</span><span class="ident" id="5388940">sendResponse</span><span class="op" id="5388952">(</span><span class="ident" id="5388953">sending</span><span class="op" id="5388960">,</span>&nbsp;<span class="ident" id="5388962">req</span><span class="op" id="5388965">,</span>&nbsp;<span class="ident" id="5388967">replyv</span><span class="op" id="5388973">.</span><span class="ident" id="5388974">Interface</span><span class="op" id="5388983">(</span><span class="op" id="5388984">)</span><span class="op" id="5388985">,</span>&nbsp;<span class="ident" id="5388987">codec</span><span class="op" id="5388992">,</span>&nbsp;<span class="ident" id="5388994">errmsg</span><span class="op" id="5389000">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389003">server</span><span class="op" id="5389009">.</span><span class="ident" id="5389010">freeRequest</span><span class="op" id="5389021">(</span><span class="ident" id="5389022">req</span><span class="op" id="5389025">)</span><br>
<span class="lineno"></span><span class="op" id="5389027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5389030">type</span>&nbsp;<span class="ident" id="5389035">gobServerCodec</span>&nbsp;<span class="keyword" id="5389050">struct</span>&nbsp;<span class="op" id="5389057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389060">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5389067">io</span><span class="op" id="5389069">.</span><span class="ident" id="5389070">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389087">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5389094">*</span><span class="ident" id="5389095">gob</span><span class="op" id="5389098">.</span><span class="ident" id="5389099">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389108">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5389115">*</span><span class="ident" id="5389116">gob</span><span class="op" id="5389119">.</span><span class="ident" id="5389120">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389129">encBuf</span>&nbsp;<span class="op" id="5389136">*</span><span class="ident" id="5389137">bufio</span><span class="op" id="5389142">.</span><span class="ident" id="5389143">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389151">closed</span>&nbsp;<span class="builtintype" id="5389158">bool</span><br>
<span class="lineno"></span><span class="op" id="5389163">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5389166">func</span>&nbsp;<span class="op" id="5389171">(</span><span class="ident" id="5389172">c</span>&nbsp;<span class="op" id="5389174">*</span><span class="ident" id="5389175">gobServerCodec</span><span class="op" id="5389189">)</span>&nbsp;<span class="ident" id="5389191">ReadRequestHeader</span><span class="op" id="5389208">(</span><span class="ident" id="5389209">r</span>&nbsp;<span class="op" id="5389211">*</span><span class="ident" id="5389212">Request</span><span class="op" id="5389219">)</span>&nbsp;<span class="builtintype" id="5389221">error</span>&nbsp;<span class="op" id="5389227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389230">return</span>&nbsp;<span class="ident" id="5389237">c</span><span class="op" id="5389238">.</span><span class="ident" id="5389239">dec</span><span class="op" id="5389242">.</span><span class="ident" id="5389243">Decode</span><span class="op" id="5389249">(</span><span class="ident" id="5389250">r</span><span class="op" id="5389251">)</span><br>
<span class="lineno"></span><span class="op" id="5389253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5389256">func</span>&nbsp;<span class="op" id="5389261">(</span><span class="ident" id="5389262">c</span>&nbsp;<span class="op" id="5389264">*</span><span class="ident" id="5389265">gobServerCodec</span><span class="op" id="5389279">)</span>&nbsp;<span class="ident" id="5389281">ReadRequestBody</span><span class="op" id="5389296">(</span><span class="ident" id="5389297">body</span>&nbsp;<span class="keyword" id="5389302">interface</span><span class="op" id="5389311">{</span><span class="op" id="5389312">}</span><span class="op" id="5389313">)</span>&nbsp;<span class="builtintype" id="5389315">error</span>&nbsp;<span class="op" id="5389321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389324">return</span>&nbsp;<span class="ident" id="5389331">c</span><span class="op" id="5389332">.</span><span class="ident" id="5389333">dec</span><span class="op" id="5389336">.</span><span class="ident" id="5389337">Decode</span><span class="op" id="5389343">(</span><span class="ident" id="5389344">body</span><span class="op" id="5389348">)</span><br>
<span class="lineno"></span><span class="op" id="5389350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5389353">func</span>&nbsp;<span class="op" id="5389358">(</span><span class="ident" id="5389359">c</span>&nbsp;<span class="op" id="5389361">*</span><span class="ident" id="5389362">gobServerCodec</span><span class="op" id="5389376">)</span>&nbsp;<span class="ident" id="5389378">WriteResponse</span><span class="op" id="5389391">(</span><span class="ident" id="5389392">r</span>&nbsp;<span class="op" id="5389394">*</span><span class="ident" id="5389395">Response</span><span class="op" id="5389403">,</span>&nbsp;<span class="ident" id="5389405">body</span>&nbsp;<span class="keyword" id="5389410">interface</span><span class="op" id="5389419">{</span><span class="op" id="5389420">}</span><span class="op" id="5389421">)</span>&nbsp;<span class="op" id="5389423">(</span><span class="ident" id="5389424">err</span>&nbsp;<span class="builtintype" id="5389428">error</span><span class="op" id="5389433">)</span>&nbsp;<span class="op" id="5389435">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389438">if</span>&nbsp;<span class="ident" id="5389441">err</span>&nbsp;<span class="op" id="5389445">=</span>&nbsp;<span class="ident" id="5389447">c</span><span class="op" id="5389448">.</span><span class="ident" id="5389449">enc</span><span class="op" id="5389452">.</span><span class="ident" id="5389453">Encode</span><span class="op" id="5389459">(</span><span class="ident" id="5389460">r</span><span class="op" id="5389461">)</span><span class="op" id="5389462">;</span>&nbsp;<span class="ident" id="5389464">err</span>&nbsp;<span class="op" id="5389468">!=</span>&nbsp;<span class="ident" id="5389471">nil</span>&nbsp;<span class="op" id="5389475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389479">if</span>&nbsp;<span class="ident" id="5389482">c</span><span class="op" id="5389483">.</span><span class="ident" id="5389484">encBuf</span><span class="op" id="5389490">.</span><span class="ident" id="5389491">Flush</span><span class="op" id="5389496">(</span><span class="op" id="5389497">)</span>&nbsp;<span class="op" id="5389499">==</span>&nbsp;<span class="ident" id="5389502">nil</span>&nbsp;<span class="op" id="5389506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389511">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389583">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389655">log</span><span class="op" id="5389658">.</span><span class="ident" id="5389659">Println</span><span class="op" id="5389666">(</span><span class="string" id="5389667">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5389702">,</span>&nbsp;<span class="ident" id="5389704">err</span><span class="op" id="5389707">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389712">c</span><span class="op" id="5389713">.</span><span class="ident" id="5389714">Close</span><span class="op" id="5389719">(</span><span class="op" id="5389720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389724">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389728">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5389736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389739">if</span>&nbsp;<span class="ident" id="5389742">err</span>&nbsp;<span class="op" id="5389746">=</span>&nbsp;<span class="ident" id="5389748">c</span><span class="op" id="5389749">.</span><span class="ident" id="5389750">enc</span><span class="op" id="5389753">.</span><span class="ident" id="5389754">Encode</span><span class="op" id="5389760">(</span><span class="ident" id="5389761">body</span><span class="op" id="5389765">)</span><span class="op" id="5389766">;</span>&nbsp;<span class="ident" id="5389768">err</span>&nbsp;<span class="op" id="5389772">!=</span>&nbsp;<span class="ident" id="5389775">nil</span>&nbsp;<span class="op" id="5389779">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5389783">if</span>&nbsp;<span class="ident" id="5389786">c</span><span class="op" id="5389787">.</span><span class="ident" id="5389788">encBuf</span><span class="op" id="5389794">.</span><span class="ident" id="5389795">Flush</span><span class="op" id="5389800">(</span><span class="op" id="5389801">)</span>&nbsp;<span class="op" id="5389803">==</span>&nbsp;<span class="ident" id="5389806">nil</span>&nbsp;<span class="op" id="5389810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389815">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5389890">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5389962">log</span><span class="op" id="5389965">.</span><span class="ident" id="5389966">Println</span><span class="op" id="5389973">(</span><span class="string" id="5389974">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5390005">,</span>&nbsp;<span class="ident" id="5390007">err</span><span class="op" id="5390010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390015">c</span><span class="op" id="5390016">.</span><span class="ident" id="5390017">Close</span><span class="op" id="5390022">(</span><span class="op" id="5390023">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5390027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390031">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5390039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390042">return</span>&nbsp;<span class="ident" id="5390049">c</span><span class="op" id="5390050">.</span><span class="ident" id="5390051">encBuf</span><span class="op" id="5390057">.</span><span class="ident" id="5390058">Flush</span><span class="op" id="5390063">(</span><span class="op" id="5390064">)</span><br>
<span class="lineno"></span><span class="op" id="5390066">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5390069">func</span>&nbsp;<span class="op" id="5390074">(</span><span class="ident" id="5390075">c</span>&nbsp;<span class="op" id="5390077">*</span><span class="ident" id="5390078">gobServerCodec</span><span class="op" id="5390092">)</span>&nbsp;<span class="ident" id="5390094">Close</span><span class="op" id="5390099">(</span><span class="op" id="5390100">)</span>&nbsp;<span class="builtintype" id="5390102">error</span>&nbsp;<span class="op" id="5390108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390111">if</span>&nbsp;<span class="ident" id="5390114">c</span><span class="op" id="5390115">.</span><span class="ident" id="5390116">closed</span>&nbsp;<span class="op" id="5390123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5390127">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390199">return</span>&nbsp;<span class="ident" id="5390206">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5390211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390214">c</span><span class="op" id="5390215">.</span><span class="ident" id="5390216">closed</span>&nbsp;<span class="op" id="5390223">=</span>&nbsp;<span class="builtintype" id="5390225">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390231">return</span>&nbsp;<span class="ident" id="5390238">c</span><span class="op" id="5390239">.</span><span class="ident" id="5390240">rwc</span><span class="op" id="5390243">.</span><span class="ident" id="5390244">Close</span><span class="op" id="5390249">(</span><span class="op" id="5390250">)</span><br>
<span class="lineno"></span><span class="op" id="5390252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5390255">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5390308">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5390379">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5390440">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5390503">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5390562">func</span>&nbsp;<span class="op" id="5390567">(</span><span class="ident" id="5390568">server</span>&nbsp;<span class="op" id="5390575">*</span><span class="ident" id="5390576">Server</span><span class="op" id="5390582">)</span>&nbsp;<span class="ident" id="5390584">ServeConn</span><span class="op" id="5390593">(</span><span class="ident" id="5390594">conn</span>&nbsp;<span class="ident" id="5390599">io</span><span class="op" id="5390601">.</span><span class="ident" id="5390602">ReadWriteCloser</span><span class="op" id="5390617">)</span>&nbsp;<span class="op" id="5390619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390622">buf</span>&nbsp;<span class="op" id="5390626">:=</span>&nbsp;<span class="ident" id="5390629">bufio</span><span class="op" id="5390634">.</span><span class="ident" id="5390635">NewWriter</span><span class="op" id="5390644">(</span><span class="ident" id="5390645">conn</span><span class="op" id="5390649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390652">srv</span>&nbsp;<span class="op" id="5390656">:=</span>&nbsp;<span class="op" id="5390659">&amp;</span><span class="ident" id="5390660">gobServerCodec</span><span class="op" id="5390674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390678">rwc</span><span class="op" id="5390681">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5390686">conn</span><span class="op" id="5390690">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390694">dec</span><span class="op" id="5390697">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5390702">gob</span><span class="op" id="5390705">.</span><span class="ident" id="5390706">NewDecoder</span><span class="op" id="5390716">(</span><span class="ident" id="5390717">conn</span><span class="op" id="5390721">)</span><span class="op" id="5390722">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390726">enc</span><span class="op" id="5390729">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5390734">gob</span><span class="op" id="5390737">.</span><span class="ident" id="5390738">NewEncoder</span><span class="op" id="5390748">(</span><span class="ident" id="5390749">buf</span><span class="op" id="5390752">)</span><span class="op" id="5390753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390757">encBuf</span><span class="op" id="5390763">:</span>&nbsp;<span class="ident" id="5390765">buf</span><span class="op" id="5390768">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5390771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390774">server</span><span class="op" id="5390780">.</span><span class="ident" id="5390781">ServeCodec</span><span class="op" id="5390791">(</span><span class="ident" id="5390792">srv</span><span class="op" id="5390795">)</span><br>
<span class="lineno"></span><span class="op" id="5390797">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5390800">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5390864">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5390905">func</span>&nbsp;<span class="op" id="5390910">(</span><span class="ident" id="5390911">server</span>&nbsp;<span class="op" id="5390918">*</span><span class="ident" id="5390919">Server</span><span class="op" id="5390925">)</span>&nbsp;<span class="ident" id="5390927">ServeCodec</span><span class="op" id="5390937">(</span><span class="ident" id="5390938">codec</span>&nbsp;<span class="ident" id="5390944">ServerCodec</span><span class="op" id="5390955">)</span>&nbsp;<span class="op" id="5390957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390960">sending</span>&nbsp;<span class="op" id="5390968">:=</span>&nbsp;<span class="builtinfunc" id="5390971">new</span><span class="op" id="5390974">(</span><span class="ident" id="5390975">sync</span><span class="op" id="5390979">.</span><span class="ident" id="5390980">Mutex</span><span class="op" id="5390985">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5390988">for</span>&nbsp;<span class="op" id="5390992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5390996">service</span><span class="op" id="5391003">,</span>&nbsp;<span class="ident" id="5391005">mtype</span><span class="op" id="5391010">,</span>&nbsp;<span class="ident" id="5391012">req</span><span class="op" id="5391015">,</span>&nbsp;<span class="ident" id="5391017">argv</span><span class="op" id="5391021">,</span>&nbsp;<span class="ident" id="5391023">replyv</span><span class="op" id="5391029">,</span>&nbsp;<span class="ident" id="5391031">keepReading</span><span class="op" id="5391042">,</span>&nbsp;<span class="ident" id="5391044">err</span>&nbsp;<span class="op" id="5391048">:=</span>&nbsp;<span class="ident" id="5391051">server</span><span class="op" id="5391057">.</span><span class="ident" id="5391058">readRequest</span><span class="op" id="5391069">(</span><span class="ident" id="5391070">codec</span><span class="op" id="5391075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391079">if</span>&nbsp;<span class="ident" id="5391082">err</span>&nbsp;<span class="op" id="5391086">!=</span>&nbsp;<span class="ident" id="5391089">nil</span>&nbsp;<span class="op" id="5391093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391098">if</span>&nbsp;<span class="ident" id="5391101">debugLog</span>&nbsp;<span class="op" id="5391110">&amp;&amp;</span>&nbsp;<span class="ident" id="5391113">err</span>&nbsp;<span class="op" id="5391117">!=</span>&nbsp;<span class="ident" id="5391120">io</span><span class="op" id="5391122">.</span><span class="ident" id="5391123">EOF</span>&nbsp;<span class="op" id="5391127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391133">log</span><span class="op" id="5391136">.</span><span class="ident" id="5391137">Println</span><span class="op" id="5391144">(</span><span class="string" id="5391145">&#34;rpc:&#34;</span><span class="op" id="5391151">,</span>&nbsp;<span class="ident" id="5391153">err</span><span class="op" id="5391156">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391166">if</span>&nbsp;<span class="op" id="5391169">!</span><span class="ident" id="5391170">keepReading</span>&nbsp;<span class="op" id="5391182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391188">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391202">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391265">if</span>&nbsp;<span class="ident" id="5391268">req</span>&nbsp;<span class="op" id="5391272">!=</span>&nbsp;<span class="ident" id="5391275">nil</span>&nbsp;<span class="op" id="5391279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391285">server</span><span class="op" id="5391291">.</span><span class="ident" id="5391292">sendResponse</span><span class="op" id="5391304">(</span><span class="ident" id="5391305">sending</span><span class="op" id="5391312">,</span>&nbsp;<span class="ident" id="5391314">req</span><span class="op" id="5391317">,</span>&nbsp;<span class="ident" id="5391319">invalidRequest</span><span class="op" id="5391333">,</span>&nbsp;<span class="ident" id="5391335">codec</span><span class="op" id="5391340">,</span>&nbsp;<span class="ident" id="5391342">err</span><span class="op" id="5391345">.</span><span class="ident" id="5391346">Error</span><span class="op" id="5391351">(</span><span class="op" id="5391352">)</span><span class="op" id="5391353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391359">server</span><span class="op" id="5391365">.</span><span class="ident" id="5391366">freeRequest</span><span class="op" id="5391377">(</span><span class="ident" id="5391378">req</span><span class="op" id="5391381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391391">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391406">go</span>&nbsp;<span class="ident" id="5391409">service</span><span class="op" id="5391416">.</span><span class="ident" id="5391417">call</span><span class="op" id="5391421">(</span><span class="ident" id="5391422">server</span><span class="op" id="5391428">,</span>&nbsp;<span class="ident" id="5391430">sending</span><span class="op" id="5391437">,</span>&nbsp;<span class="ident" id="5391439">mtype</span><span class="op" id="5391444">,</span>&nbsp;<span class="ident" id="5391446">req</span><span class="op" id="5391449">,</span>&nbsp;<span class="ident" id="5391451">argv</span><span class="op" id="5391455">,</span>&nbsp;<span class="ident" id="5391457">replyv</span><span class="op" id="5391463">,</span>&nbsp;<span class="ident" id="5391465">codec</span><span class="op" id="5391470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391476">codec</span><span class="op" id="5391481">.</span><span class="ident" id="5391482">Close</span><span class="op" id="5391487">(</span><span class="op" id="5391488">)</span><br>
<span class="lineno"></span><span class="op" id="5391490">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5391493">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5391571">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5391619">func</span>&nbsp;<span class="op" id="5391624">(</span><span class="ident" id="5391625">server</span>&nbsp;<span class="op" id="5391632">*</span><span class="ident" id="5391633">Server</span><span class="op" id="5391639">)</span>&nbsp;<span class="ident" id="5391641">ServeRequest</span><span class="op" id="5391653">(</span><span class="ident" id="5391654">codec</span>&nbsp;<span class="ident" id="5391660">ServerCodec</span><span class="op" id="5391671">)</span>&nbsp;<span class="builtintype" id="5391673">error</span>&nbsp;<span class="op" id="5391679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391682">sending</span>&nbsp;<span class="op" id="5391690">:=</span>&nbsp;<span class="builtinfunc" id="5391693">new</span><span class="op" id="5391696">(</span><span class="ident" id="5391697">sync</span><span class="op" id="5391701">.</span><span class="ident" id="5391702">Mutex</span><span class="op" id="5391707">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391710">service</span><span class="op" id="5391717">,</span>&nbsp;<span class="ident" id="5391719">mtype</span><span class="op" id="5391724">,</span>&nbsp;<span class="ident" id="5391726">req</span><span class="op" id="5391729">,</span>&nbsp;<span class="ident" id="5391731">argv</span><span class="op" id="5391735">,</span>&nbsp;<span class="ident" id="5391737">replyv</span><span class="op" id="5391743">,</span>&nbsp;<span class="ident" id="5391745">keepReading</span><span class="op" id="5391756">,</span>&nbsp;<span class="ident" id="5391758">err</span>&nbsp;<span class="op" id="5391762">:=</span>&nbsp;<span class="ident" id="5391765">server</span><span class="op" id="5391771">.</span><span class="ident" id="5391772">readRequest</span><span class="op" id="5391783">(</span><span class="ident" id="5391784">codec</span><span class="op" id="5391789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391792">if</span>&nbsp;<span class="ident" id="5391795">err</span>&nbsp;<span class="op" id="5391799">!=</span>&nbsp;<span class="ident" id="5391802">nil</span>&nbsp;<span class="op" id="5391806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391810">if</span>&nbsp;<span class="op" id="5391813">!</span><span class="ident" id="5391814">keepReading</span>&nbsp;<span class="op" id="5391826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391831">return</span>&nbsp;<span class="ident" id="5391838">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5391844">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5391848">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5391910">if</span>&nbsp;<span class="ident" id="5391913">req</span>&nbsp;<span class="op" id="5391917">!=</span>&nbsp;<span class="ident" id="5391920">nil</span>&nbsp;<span class="op" id="5391924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5391929">server</span><span class="op" id="5391935">.</span><span class="ident" id="5391936">sendResponse</span><span class="op" id="5391948">(</span><span class="ident" id="5391949">sending</span><span class="op" id="5391956">,</span>&nbsp;<span class="ident" id="5391958">req</span><span class="op" id="5391961">,</span>&nbsp;<span class="ident" id="5391963">invalidRequest</span><span class="op" id="5391977">,</span>&nbsp;<span class="ident" id="5391979">codec</span><span class="op" id="5391984">,</span>&nbsp;<span class="ident" id="5391986">err</span><span class="op" id="5391989">.</span><span class="ident" id="5391990">Error</span><span class="op" id="5391995">(</span><span class="op" id="5391996">)</span><span class="op" id="5391997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392002">server</span><span class="op" id="5392008">.</span><span class="ident" id="5392009">freeRequest</span><span class="op" id="5392020">(</span><span class="ident" id="5392021">req</span><span class="op" id="5392024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392028">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392032">return</span>&nbsp;<span class="ident" id="5392039">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392047">service</span><span class="op" id="5392054">.</span><span class="ident" id="5392055">call</span><span class="op" id="5392059">(</span><span class="ident" id="5392060">server</span><span class="op" id="5392066">,</span>&nbsp;<span class="ident" id="5392068">sending</span><span class="op" id="5392075">,</span>&nbsp;<span class="ident" id="5392077">mtype</span><span class="op" id="5392082">,</span>&nbsp;<span class="ident" id="5392084">req</span><span class="op" id="5392087">,</span>&nbsp;<span class="ident" id="5392089">argv</span><span class="op" id="5392093">,</span>&nbsp;<span class="ident" id="5392095">replyv</span><span class="op" id="5392101">,</span>&nbsp;<span class="ident" id="5392103">codec</span><span class="op" id="5392108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392111">return</span>&nbsp;<span class="ident" id="5392118">nil</span><br>
<span class="lineno"></span><span class="op" id="5392122">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5392125">func</span>&nbsp;<span class="op" id="5392130">(</span><span class="ident" id="5392131">server</span>&nbsp;<span class="op" id="5392138">*</span><span class="ident" id="5392139">Server</span><span class="op" id="5392145">)</span>&nbsp;<span class="ident" id="5392147">getRequest</span><span class="op" id="5392157">(</span><span class="op" id="5392158">)</span>&nbsp;<span class="op" id="5392160">*</span><span class="ident" id="5392161">Request</span>&nbsp;<span class="op" id="5392169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392172">server</span><span class="op" id="5392178">.</span><span class="ident" id="5392179">reqLock</span><span class="op" id="5392186">.</span><span class="ident" id="5392187">Lock</span><span class="op" id="5392191">(</span><span class="op" id="5392192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392195">req</span>&nbsp;<span class="op" id="5392199">:=</span>&nbsp;<span class="ident" id="5392202">server</span><span class="op" id="5392208">.</span><span class="ident" id="5392209">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392218">if</span>&nbsp;<span class="ident" id="5392221">req</span>&nbsp;<span class="op" id="5392225">==</span>&nbsp;<span class="ident" id="5392228">nil</span>&nbsp;<span class="op" id="5392232">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392236">req</span>&nbsp;<span class="op" id="5392240">=</span>&nbsp;<span class="builtinfunc" id="5392242">new</span><span class="op" id="5392245">(</span><span class="ident" id="5392246">Request</span><span class="op" id="5392253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392256">}</span>&nbsp;<span class="keyword" id="5392258">else</span>&nbsp;<span class="op" id="5392263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392267">server</span><span class="op" id="5392273">.</span><span class="ident" id="5392274">freeReq</span>&nbsp;<span class="op" id="5392282">=</span>&nbsp;<span class="ident" id="5392284">req</span><span class="op" id="5392287">.</span><span class="ident" id="5392288">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392295">*</span><span class="ident" id="5392296">req</span>&nbsp;<span class="op" id="5392300">=</span>&nbsp;<span class="ident" id="5392302">Request</span><span class="op" id="5392309">{</span><span class="op" id="5392310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392313">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392316">server</span><span class="op" id="5392322">.</span><span class="ident" id="5392323">reqLock</span><span class="op" id="5392330">.</span><span class="ident" id="5392331">Unlock</span><span class="op" id="5392337">(</span><span class="op" id="5392338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392341">return</span>&nbsp;<span class="ident" id="5392348">req</span><br>
<span class="lineno"></span><span class="op" id="5392352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5392355">func</span>&nbsp;<span class="op" id="5392360">(</span><span class="ident" id="5392361">server</span>&nbsp;<span class="op" id="5392368">*</span><span class="ident" id="5392369">Server</span><span class="op" id="5392375">)</span>&nbsp;<span class="ident" id="5392377">freeRequest</span><span class="op" id="5392388">(</span><span class="ident" id="5392389">req</span>&nbsp;<span class="op" id="5392393">*</span><span class="ident" id="5392394">Request</span><span class="op" id="5392401">)</span>&nbsp;<span class="op" id="5392403">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392406">server</span><span class="op" id="5392412">.</span><span class="ident" id="5392413">reqLock</span><span class="op" id="5392420">.</span><span class="ident" id="5392421">Lock</span><span class="op" id="5392425">(</span><span class="op" id="5392426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392429">req</span><span class="op" id="5392432">.</span><span class="ident" id="5392433">next</span>&nbsp;<span class="op" id="5392438">=</span>&nbsp;<span class="ident" id="5392440">server</span><span class="op" id="5392446">.</span><span class="ident" id="5392447">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392456">server</span><span class="op" id="5392462">.</span><span class="ident" id="5392463">freeReq</span>&nbsp;<span class="op" id="5392471">=</span>&nbsp;<span class="ident" id="5392473">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392478">server</span><span class="op" id="5392484">.</span><span class="ident" id="5392485">reqLock</span><span class="op" id="5392492">.</span><span class="ident" id="5392493">Unlock</span><span class="op" id="5392499">(</span><span class="op" id="5392500">)</span><br>
<span class="lineno"></span><span class="op" id="5392502">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5392505">func</span>&nbsp;<span class="op" id="5392510">(</span><span class="ident" id="5392511">server</span>&nbsp;<span class="op" id="5392518">*</span><span class="ident" id="5392519">Server</span><span class="op" id="5392525">)</span>&nbsp;<span class="ident" id="5392527">getResponse</span><span class="op" id="5392538">(</span><span class="op" id="5392539">)</span>&nbsp;<span class="op" id="5392541">*</span><span class="ident" id="5392542">Response</span>&nbsp;<span class="op" id="5392551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392554">server</span><span class="op" id="5392560">.</span><span class="ident" id="5392561">respLock</span><span class="op" id="5392569">.</span><span class="ident" id="5392570">Lock</span><span class="op" id="5392574">(</span><span class="op" id="5392575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392578">resp</span>&nbsp;<span class="op" id="5392583">:=</span>&nbsp;<span class="ident" id="5392586">server</span><span class="op" id="5392592">.</span><span class="ident" id="5392593">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392603">if</span>&nbsp;<span class="ident" id="5392606">resp</span>&nbsp;<span class="op" id="5392611">==</span>&nbsp;<span class="ident" id="5392614">nil</span>&nbsp;<span class="op" id="5392618">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392622">resp</span>&nbsp;<span class="op" id="5392627">=</span>&nbsp;<span class="builtinfunc" id="5392629">new</span><span class="op" id="5392632">(</span><span class="ident" id="5392633">Response</span><span class="op" id="5392641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392644">}</span>&nbsp;<span class="keyword" id="5392646">else</span>&nbsp;<span class="op" id="5392651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392655">server</span><span class="op" id="5392661">.</span><span class="ident" id="5392662">freeResp</span>&nbsp;<span class="op" id="5392671">=</span>&nbsp;<span class="ident" id="5392673">resp</span><span class="op" id="5392677">.</span><span class="ident" id="5392678">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392685">*</span><span class="ident" id="5392686">resp</span>&nbsp;<span class="op" id="5392691">=</span>&nbsp;<span class="ident" id="5392693">Response</span><span class="op" id="5392701">{</span><span class="op" id="5392702">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5392705">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392708">server</span><span class="op" id="5392714">.</span><span class="ident" id="5392715">respLock</span><span class="op" id="5392723">.</span><span class="ident" id="5392724">Unlock</span><span class="op" id="5392730">(</span><span class="op" id="5392731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5392734">return</span>&nbsp;<span class="ident" id="5392741">resp</span><br>
<span class="lineno"></span><span class="op" id="5392746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5392749">func</span>&nbsp;<span class="op" id="5392754">(</span><span class="ident" id="5392755">server</span>&nbsp;<span class="op" id="5392762">*</span><span class="ident" id="5392763">Server</span><span class="op" id="5392769">)</span>&nbsp;<span class="ident" id="5392771">freeResponse</span><span class="op" id="5392783">(</span><span class="ident" id="5392784">resp</span>&nbsp;<span class="op" id="5392789">*</span><span class="ident" id="5392790">Response</span><span class="op" id="5392798">)</span>&nbsp;<span class="op" id="5392800">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392803">server</span><span class="op" id="5392809">.</span><span class="ident" id="5392810">respLock</span><span class="op" id="5392818">.</span><span class="ident" id="5392819">Lock</span><span class="op" id="5392823">(</span><span class="op" id="5392824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392827">resp</span><span class="op" id="5392831">.</span><span class="ident" id="5392832">next</span>&nbsp;<span class="op" id="5392837">=</span>&nbsp;<span class="ident" id="5392839">server</span><span class="op" id="5392845">.</span><span class="ident" id="5392846">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392856">server</span><span class="op" id="5392862">.</span><span class="ident" id="5392863">freeResp</span>&nbsp;<span class="op" id="5392872">=</span>&nbsp;<span class="ident" id="5392874">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5392880">server</span><span class="op" id="5392886">.</span><span class="ident" id="5392887">respLock</span><span class="op" id="5392895">.</span><span class="ident" id="5392896">Unlock</span><span class="op" id="5392902">(</span><span class="op" id="5392903">)</span><br>
<span class="lineno"></span><span class="op" id="5392905">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5392908">func</span>&nbsp;<span class="op" id="5392913">(</span><span class="ident" id="5392914">server</span>&nbsp;<span class="op" id="5392921">*</span><span class="ident" id="5392922">Server</span><span class="op" id="5392928">)</span>&nbsp;<span class="ident" id="5392930">readRequest</span><span class="op" id="5392941">(</span><span class="ident" id="5392942">codec</span>&nbsp;<span class="ident" id="5392948">ServerCodec</span><span class="op" id="5392959">)</span>&nbsp;<span class="op" id="5392961">(</span><span class="ident" id="5392962">service</span>&nbsp;<span class="op" id="5392970">*</span><span class="ident" id="5392971">service</span><span class="op" id="5392978">,</span>&nbsp;<span class="ident" id="5392980">mtype</span>&nbsp;<span class="op" id="5392986">*</span><span class="ident" id="5392987">methodType</span><span class="op" id="5392997">,</span>&nbsp;<span class="ident" id="5392999">req</span>&nbsp;<span class="op" id="5393003">*</span><span class="ident" id="5393004">Request</span><span class="op" id="5393011">,</span>&nbsp;<span class="ident" id="5393013">argv</span><span class="op" id="5393017">,</span>&nbsp;<span class="ident" id="5393019">replyv</span>&nbsp;<span class="ident" id="5393026">reflect</span><span class="op" id="5393033">.</span><span class="ident" id="5393034">Value</span><span class="op" id="5393039">,</span>&nbsp;<span class="ident" id="5393041">keepReading</span>&nbsp;<span class="builtintype" id="5393053">bool</span><span class="op" id="5393057">,</span>&nbsp;<span class="ident" id="5393059">err</span>&nbsp;<span class="builtintype" id="5393063">error</span><span class="op" id="5393068">)</span>&nbsp;<span class="op" id="5393070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393073">service</span><span class="op" id="5393080">,</span>&nbsp;<span class="ident" id="5393082">mtype</span><span class="op" id="5393087">,</span>&nbsp;<span class="ident" id="5393089">req</span><span class="op" id="5393092">,</span>&nbsp;<span class="ident" id="5393094">keepReading</span><span class="op" id="5393105">,</span>&nbsp;<span class="ident" id="5393107">err</span>&nbsp;<span class="op" id="5393111">=</span>&nbsp;<span class="ident" id="5393113">server</span><span class="op" id="5393119">.</span><span class="ident" id="5393120">readRequestHeader</span><span class="op" id="5393137">(</span><span class="ident" id="5393138">codec</span><span class="op" id="5393143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393146">if</span>&nbsp;<span class="ident" id="5393149">err</span>&nbsp;<span class="op" id="5393153">!=</span>&nbsp;<span class="ident" id="5393156">nil</span>&nbsp;<span class="op" id="5393160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393164">if</span>&nbsp;<span class="op" id="5393167">!</span><span class="ident" id="5393168">keepReading</span>&nbsp;<span class="op" id="5393180">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393185">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5393198">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393216">codec</span><span class="op" id="5393221">.</span><span class="ident" id="5393222">ReadRequestBody</span><span class="op" id="5393237">(</span><span class="ident" id="5393238">nil</span><span class="op" id="5393241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393245">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5393257">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393288">argIsValue</span>&nbsp;<span class="op" id="5393299">:=</span>&nbsp;<span class="builtintype" id="5393302">false</span>&nbsp;<span class="comment" id="5393308">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393354">if</span>&nbsp;<span class="ident" id="5393357">mtype</span><span class="op" id="5393362">.</span><span class="ident" id="5393363">ArgType</span><span class="op" id="5393370">.</span><span class="ident" id="5393371">Kind</span><span class="op" id="5393375">(</span><span class="op" id="5393376">)</span>&nbsp;<span class="op" id="5393378">==</span>&nbsp;<span class="ident" id="5393381">reflect</span><span class="op" id="5393388">.</span><span class="ident" id="5393389">Ptr</span>&nbsp;<span class="op" id="5393393">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393397">argv</span>&nbsp;<span class="op" id="5393402">=</span>&nbsp;<span class="ident" id="5393404">reflect</span><span class="op" id="5393411">.</span><span class="ident" id="5393412">New</span><span class="op" id="5393415">(</span><span class="ident" id="5393416">mtype</span><span class="op" id="5393421">.</span><span class="ident" id="5393422">ArgType</span><span class="op" id="5393429">.</span><span class="ident" id="5393430">Elem</span><span class="op" id="5393434">(</span><span class="op" id="5393435">)</span><span class="op" id="5393436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393439">}</span>&nbsp;<span class="keyword" id="5393441">else</span>&nbsp;<span class="op" id="5393446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393450">argv</span>&nbsp;<span class="op" id="5393455">=</span>&nbsp;<span class="ident" id="5393457">reflect</span><span class="op" id="5393464">.</span><span class="ident" id="5393465">New</span><span class="op" id="5393468">(</span><span class="ident" id="5393469">mtype</span><span class="op" id="5393474">.</span><span class="ident" id="5393475">ArgType</span><span class="op" id="5393482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393486">argIsValue</span>&nbsp;<span class="op" id="5393497">=</span>&nbsp;<span class="builtintype" id="5393499">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393505">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5393508">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393549">if</span>&nbsp;<span class="ident" id="5393552">err</span>&nbsp;<span class="op" id="5393556">=</span>&nbsp;<span class="ident" id="5393558">codec</span><span class="op" id="5393563">.</span><span class="ident" id="5393564">ReadRequestBody</span><span class="op" id="5393579">(</span><span class="ident" id="5393580">argv</span><span class="op" id="5393584">.</span><span class="ident" id="5393585">Interface</span><span class="op" id="5393594">(</span><span class="op" id="5393595">)</span><span class="op" id="5393596">)</span><span class="op" id="5393597">;</span>&nbsp;<span class="ident" id="5393599">err</span>&nbsp;<span class="op" id="5393603">!=</span>&nbsp;<span class="ident" id="5393606">nil</span>&nbsp;<span class="op" id="5393610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393614">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393625">if</span>&nbsp;<span class="ident" id="5393628">argIsValue</span>&nbsp;<span class="op" id="5393639">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393643">argv</span>&nbsp;<span class="op" id="5393648">=</span>&nbsp;<span class="ident" id="5393650">argv</span><span class="op" id="5393654">.</span><span class="ident" id="5393655">Elem</span><span class="op" id="5393659">(</span><span class="op" id="5393660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5393663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393667">replyv</span>&nbsp;<span class="op" id="5393674">=</span>&nbsp;<span class="ident" id="5393676">reflect</span><span class="op" id="5393683">.</span><span class="ident" id="5393684">New</span><span class="op" id="5393687">(</span><span class="ident" id="5393688">mtype</span><span class="op" id="5393693">.</span><span class="ident" id="5393694">ReplyType</span><span class="op" id="5393703">.</span><span class="ident" id="5393704">Elem</span><span class="op" id="5393708">(</span><span class="op" id="5393709">)</span><span class="op" id="5393710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393713">return</span><br>
<span class="lineno">570</span><span class="op" id="5393720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5393723">func</span>&nbsp;<span class="op" id="5393728">(</span><span class="ident" id="5393729">server</span>&nbsp;<span class="op" id="5393736">*</span><span class="ident" id="5393737">Server</span><span class="op" id="5393743">)</span>&nbsp;<span class="ident" id="5393745">readRequestHeader</span><span class="op" id="5393762">(</span><span class="ident" id="5393763">codec</span>&nbsp;<span class="ident" id="5393769">ServerCodec</span><span class="op" id="5393780">)</span>&nbsp;<span class="op" id="5393782">(</span><span class="ident" id="5393783">service</span>&nbsp;<span class="op" id="5393791">*</span><span class="ident" id="5393792">service</span><span class="op" id="5393799">,</span>&nbsp;<span class="ident" id="5393801">mtype</span>&nbsp;<span class="op" id="5393807">*</span><span class="ident" id="5393808">methodType</span><span class="op" id="5393818">,</span>&nbsp;<span class="ident" id="5393820">req</span>&nbsp;<span class="op" id="5393824">*</span><span class="ident" id="5393825">Request</span><span class="op" id="5393832">,</span>&nbsp;<span class="ident" id="5393834">keepReading</span>&nbsp;<span class="builtintype" id="5393846">bool</span><span class="op" id="5393850">,</span>&nbsp;<span class="ident" id="5393852">err</span>&nbsp;<span class="builtintype" id="5393856">error</span><span class="op" id="5393861">)</span>&nbsp;<span class="op" id="5393863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5393866">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393895">req</span>&nbsp;<span class="op" id="5393899">=</span>&nbsp;<span class="ident" id="5393901">server</span><span class="op" id="5393907">.</span><span class="ident" id="5393908">getRequest</span><span class="op" id="5393918">(</span><span class="op" id="5393919">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393922">err</span>&nbsp;<span class="op" id="5393926">=</span>&nbsp;<span class="ident" id="5393928">codec</span><span class="op" id="5393933">.</span><span class="ident" id="5393934">ReadRequestHeader</span><span class="op" id="5393951">(</span><span class="ident" id="5393952">req</span><span class="op" id="5393955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393958">if</span>&nbsp;<span class="ident" id="5393961">err</span>&nbsp;<span class="op" id="5393965">!=</span>&nbsp;<span class="ident" id="5393968">nil</span>&nbsp;<span class="op" id="5393972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5393976">req</span>&nbsp;<span class="op" id="5393980">=</span>&nbsp;<span class="ident" id="5393982">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5393988">if</span>&nbsp;<span class="ident" id="5393991">err</span>&nbsp;<span class="op" id="5393995">==</span>&nbsp;<span class="ident" id="5393998">io</span><span class="op" id="5394000">.</span><span class="ident" id="5394001">EOF</span>&nbsp;<span class="op" id="5394005">||</span>&nbsp;<span class="ident" id="5394008">err</span>&nbsp;<span class="op" id="5394012">==</span>&nbsp;<span class="ident" id="5394015">io</span><span class="op" id="5394017">.</span><span class="ident" id="5394018">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5394035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394040">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394053">err</span>&nbsp;<span class="op" id="5394057">=</span>&nbsp;<span class="ident" id="5394059">errors</span><span class="op" id="5394065">.</span><span class="ident" id="5394066">New</span><span class="op" id="5394069">(</span><span class="string" id="5394070">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5394108">+</span>&nbsp;<span class="ident" id="5394110">err</span><span class="op" id="5394113">.</span><span class="ident" id="5394114">Error</span><span class="op" id="5394119">(</span><span class="op" id="5394120">)</span><span class="op" id="5394121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394133">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394137">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394199">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394257">keepReading</span>&nbsp;<span class="op" id="5394269">=</span>&nbsp;<span class="builtintype" id="5394271">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394278">dot</span>&nbsp;<span class="op" id="5394282">:=</span>&nbsp;<span class="ident" id="5394285">strings</span><span class="op" id="5394292">.</span><span class="ident" id="5394293">LastIndex</span><span class="op" id="5394302">(</span><span class="ident" id="5394303">req</span><span class="op" id="5394306">.</span><span class="ident" id="5394307">ServiceMethod</span><span class="op" id="5394320">,</span>&nbsp;<span class="string" id="5394322">&#34;.&#34;</span><span class="op" id="5394325">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394328">if</span>&nbsp;<span class="ident" id="5394331">dot</span>&nbsp;<span class="op" id="5394335">&lt;</span>&nbsp;<span class="num" id="5394337">0</span>&nbsp;<span class="op" id="5394339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394343">err</span>&nbsp;<span class="op" id="5394347">=</span>&nbsp;<span class="ident" id="5394349">errors</span><span class="op" id="5394355">.</span><span class="ident" id="5394356">New</span><span class="op" id="5394359">(</span><span class="string" id="5394360">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5394403">+</span>&nbsp;<span class="ident" id="5394405">req</span><span class="op" id="5394408">.</span><span class="ident" id="5394409">ServiceMethod</span><span class="op" id="5394422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394426">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394437">serviceName</span>&nbsp;<span class="op" id="5394449">:=</span>&nbsp;<span class="ident" id="5394452">req</span><span class="op" id="5394455">.</span><span class="ident" id="5394456">ServiceMethod</span><span class="op" id="5394469">[</span><span class="op" id="5394470">:</span><span class="ident" id="5394471">dot</span><span class="op" id="5394474">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394477">methodName</span>&nbsp;<span class="op" id="5394488">:=</span>&nbsp;<span class="ident" id="5394491">req</span><span class="op" id="5394494">.</span><span class="ident" id="5394495">ServiceMethod</span><span class="op" id="5394508">[</span><span class="ident" id="5394509">dot</span><span class="op" id="5394512">+</span><span class="num" id="5394513">1</span><span class="op" id="5394514">:</span><span class="op" id="5394515">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5394519">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394544">server</span><span class="op" id="5394550">.</span><span class="ident" id="5394551">mu</span><span class="op" id="5394553">.</span><span class="ident" id="5394554">RLock</span><span class="op" id="5394559">(</span><span class="op" id="5394560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394563">service</span>&nbsp;<span class="op" id="5394571">=</span>&nbsp;<span class="ident" id="5394573">server</span><span class="op" id="5394579">.</span><span class="ident" id="5394580">serviceMap</span><span class="op" id="5394590">[</span><span class="ident" id="5394591">serviceName</span><span class="op" id="5394602">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394605">server</span><span class="op" id="5394611">.</span><span class="ident" id="5394612">mu</span><span class="op" id="5394614">.</span><span class="ident" id="5394615">RUnlock</span><span class="op" id="5394622">(</span><span class="op" id="5394623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394626">if</span>&nbsp;<span class="ident" id="5394629">service</span>&nbsp;<span class="op" id="5394637">==</span>&nbsp;<span class="ident" id="5394640">nil</span>&nbsp;<span class="op" id="5394644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394648">err</span>&nbsp;<span class="op" id="5394652">=</span>&nbsp;<span class="ident" id="5394654">errors</span><span class="op" id="5394660">.</span><span class="ident" id="5394661">New</span><span class="op" id="5394664">(</span><span class="string" id="5394665">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5394692">+</span>&nbsp;<span class="ident" id="5394694">req</span><span class="op" id="5394697">.</span><span class="ident" id="5394698">ServiceMethod</span><span class="op" id="5394711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394715">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394723">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394726">mtype</span>&nbsp;<span class="op" id="5394732">=</span>&nbsp;<span class="ident" id="5394734">service</span><span class="op" id="5394741">.</span><span class="ident" id="5394742">method</span><span class="op" id="5394748">[</span><span class="ident" id="5394749">methodName</span><span class="op" id="5394759">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394762">if</span>&nbsp;<span class="ident" id="5394765">mtype</span>&nbsp;<span class="op" id="5394771">==</span>&nbsp;<span class="ident" id="5394774">nil</span>&nbsp;<span class="op" id="5394778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5394782">err</span>&nbsp;<span class="op" id="5394786">=</span>&nbsp;<span class="ident" id="5394788">errors</span><span class="op" id="5394794">.</span><span class="ident" id="5394795">New</span><span class="op" id="5394798">(</span><span class="string" id="5394799">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5394825">+</span>&nbsp;<span class="ident" id="5394827">req</span><span class="op" id="5394830">.</span><span class="ident" id="5394831">ServiceMethod</span><span class="op" id="5394844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5394847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5394850">return</span><br>
<span class="lineno">610</span><span class="op" id="5394857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5394860">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5394926">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5394996">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5395029">func</span>&nbsp;<span class="op" id="5395034">(</span><span class="ident" id="5395035">server</span>&nbsp;<span class="op" id="5395042">*</span><span class="ident" id="5395043">Server</span><span class="op" id="5395049">)</span>&nbsp;<span class="ident" id="5395051">Accept</span><span class="op" id="5395057">(</span><span class="ident" id="5395058">lis</span>&nbsp;<span class="ident" id="5395062">net</span><span class="op" id="5395065">.</span><span class="ident" id="5395066">Listener</span><span class="op" id="5395074">)</span>&nbsp;<span class="op" id="5395076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395079">for</span>&nbsp;<span class="op" id="5395083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395087">conn</span><span class="op" id="5395091">,</span>&nbsp;<span class="ident" id="5395093">err</span>&nbsp;<span class="op" id="5395097">:=</span>&nbsp;<span class="ident" id="5395100">lis</span><span class="op" id="5395103">.</span><span class="ident" id="5395104">Accept</span><span class="op" id="5395110">(</span><span class="op" id="5395111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395115">if</span>&nbsp;<span class="ident" id="5395118">err</span>&nbsp;<span class="op" id="5395122">!=</span>&nbsp;<span class="ident" id="5395125">nil</span>&nbsp;<span class="op" id="5395129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5395134">log</span><span class="op" id="5395137">.</span><span class="ident" id="5395138">Fatal</span><span class="op" id="5395143">(</span><span class="string" id="5395144">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5395164">,</span>&nbsp;<span class="ident" id="5395166">err</span><span class="op" id="5395169">.</span><span class="ident" id="5395170">Error</span><span class="op" id="5395175">(</span><span class="op" id="5395176">)</span><span class="op" id="5395177">)</span>&nbsp;<span class="comment" id="5395179">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5395199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395203">go</span>&nbsp;<span class="ident" id="5395206">server</span><span class="op" id="5395212">.</span><span class="ident" id="5395213">ServeConn</span><span class="op" id="5395222">(</span><span class="ident" id="5395223">conn</span><span class="op" id="5395227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5395230">}</span><br>
<span class="lineno"></span><span class="op" id="5395232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5395235">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5395302">func</span>&nbsp;<span class="ident" id="5395307">Register</span><span class="op" id="5395315">(</span><span class="ident" id="5395316">rcvr</span>&nbsp;<span class="keyword" id="5395321">interface</span><span class="op" id="5395330">{</span><span class="op" id="5395331">}</span><span class="op" id="5395332">)</span>&nbsp;<span class="builtintype" id="5395334">error</span>&nbsp;<span class="op" id="5395340">{</span>&nbsp;<span class="keyword" id="5395342">return</span>&nbsp;<span class="ident" id="5395349">DefaultServer</span><span class="op" id="5395362">.</span><span class="ident" id="5395363">Register</span><span class="op" id="5395371">(</span><span class="ident" id="5395372">rcvr</span><span class="op" id="5395376">)</span>&nbsp;<span class="op" id="5395378">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5395381">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5395454">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5395498">func</span>&nbsp;<span class="ident" id="5395503">RegisterName</span><span class="op" id="5395515">(</span><span class="ident" id="5395516">name</span>&nbsp;<span class="builtintype" id="5395521">string</span><span class="op" id="5395527">,</span>&nbsp;<span class="ident" id="5395529">rcvr</span>&nbsp;<span class="keyword" id="5395534">interface</span><span class="op" id="5395543">{</span><span class="op" id="5395544">}</span><span class="op" id="5395545">)</span>&nbsp;<span class="builtintype" id="5395547">error</span>&nbsp;<span class="op" id="5395553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5395556">return</span>&nbsp;<span class="ident" id="5395563">DefaultServer</span><span class="op" id="5395576">.</span><span class="ident" id="5395577">RegisterName</span><span class="op" id="5395589">(</span><span class="ident" id="5395590">name</span><span class="op" id="5395594">,</span>&nbsp;<span class="ident" id="5395596">rcvr</span><span class="op" id="5395600">)</span><br>
<span class="lineno"></span><span class="op" id="5395602">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5395605">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5395672">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5395728">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5395795">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5395866">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5395939">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5395995">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5396066">type</span>&nbsp;<span class="ident" id="5396071">ServerCodec</span>&nbsp;<span class="keyword" id="5396083">interface</span>&nbsp;<span class="op" id="5396093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396096">ReadRequestHeader</span><span class="op" id="5396113">(</span><span class="op" id="5396114">*</span><span class="ident" id="5396115">Request</span><span class="op" id="5396122">)</span>&nbsp;<span class="builtintype" id="5396124">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396131">ReadRequestBody</span><span class="op" id="5396146">(</span><span class="keyword" id="5396147">interface</span><span class="op" id="5396156">{</span><span class="op" id="5396157">}</span><span class="op" id="5396158">)</span>&nbsp;<span class="builtintype" id="5396160">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5396167">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396241">WriteResponse</span><span class="op" id="5396254">(</span><span class="op" id="5396255">*</span><span class="ident" id="5396256">Response</span><span class="op" id="5396264">,</span>&nbsp;<span class="keyword" id="5396266">interface</span><span class="op" id="5396275">{</span><span class="op" id="5396276">}</span><span class="op" id="5396277">)</span>&nbsp;<span class="builtintype" id="5396279">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396287">Close</span><span class="op" id="5396292">(</span><span class="op" id="5396293">)</span>&nbsp;<span class="builtintype" id="5396295">error</span><br>
<span class="lineno"></span><span class="op" id="5396301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5396304">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5396364">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5396435">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5396496">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5396559">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5396618">func</span>&nbsp;<span class="ident" id="5396623">ServeConn</span><span class="op" id="5396632">(</span><span class="ident" id="5396633">conn</span>&nbsp;<span class="ident" id="5396638">io</span><span class="op" id="5396640">.</span><span class="ident" id="5396641">ReadWriteCloser</span><span class="op" id="5396656">)</span>&nbsp;<span class="op" id="5396658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396661">DefaultServer</span><span class="op" id="5396674">.</span><span class="ident" id="5396675">ServeConn</span><span class="op" id="5396684">(</span><span class="ident" id="5396685">conn</span><span class="op" id="5396689">)</span><br>
<span class="lineno"></span><span class="op" id="5396691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5396694">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5396758">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5396799">func</span>&nbsp;<span class="ident" id="5396804">ServeCodec</span><span class="op" id="5396814">(</span><span class="ident" id="5396815">codec</span>&nbsp;<span class="ident" id="5396821">ServerCodec</span><span class="op" id="5396832">)</span>&nbsp;<span class="op" id="5396834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5396837">DefaultServer</span><span class="op" id="5396850">.</span><span class="ident" id="5396851">ServeCodec</span><span class="op" id="5396861">(</span><span class="ident" id="5396862">codec</span><span class="op" id="5396867">)</span><br>
<span class="lineno"></span><span class="op" id="5396869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5396872">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5396950">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5396998">func</span>&nbsp;<span class="ident" id="5397003">ServeRequest</span><span class="op" id="5397015">(</span><span class="ident" id="5397016">codec</span>&nbsp;<span class="ident" id="5397022">ServerCodec</span><span class="op" id="5397033">)</span>&nbsp;<span class="builtintype" id="5397035">error</span>&nbsp;<span class="op" id="5397041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397044">return</span>&nbsp;<span class="ident" id="5397051">DefaultServer</span><span class="op" id="5397064">.</span><span class="ident" id="5397065">ServeRequest</span><span class="op" id="5397077">(</span><span class="ident" id="5397078">codec</span><span class="op" id="5397083">)</span><br>
<span class="lineno"></span><span class="op" id="5397085">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5397088">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5397154">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5397204">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5397273">func</span>&nbsp;<span class="ident" id="5397278">Accept</span><span class="op" id="5397284">(</span><span class="ident" id="5397285">lis</span>&nbsp;<span class="ident" id="5397289">net</span><span class="op" id="5397292">.</span><span class="ident" id="5397293">Listener</span><span class="op" id="5397301">)</span>&nbsp;<span class="op" id="5397303">{</span>&nbsp;<span class="ident" id="5397305">DefaultServer</span><span class="op" id="5397318">.</span><span class="ident" id="5397319">Accept</span><span class="op" id="5397325">(</span><span class="ident" id="5397326">lis</span><span class="op" id="5397329">)</span>&nbsp;<span class="op" id="5397331">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5397334">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5397395">var</span>&nbsp;<span class="ident" id="5397399">connected</span>&nbsp;<span class="op" id="5397409">=</span>&nbsp;<span class="string" id="5397411">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5397438">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5397505">func</span>&nbsp;<span class="op" id="5397510">(</span><span class="ident" id="5397511">server</span>&nbsp;<span class="op" id="5397518">*</span><span class="ident" id="5397519">Server</span><span class="op" id="5397525">)</span>&nbsp;<span class="ident" id="5397527">ServeHTTP</span><span class="op" id="5397536">(</span><span class="ident" id="5397537">w</span>&nbsp;<span class="ident" id="5397539">http</span><span class="op" id="5397543">.</span><span class="ident" id="5397544">ResponseWriter</span><span class="op" id="5397558">,</span>&nbsp;<span class="ident" id="5397560">req</span>&nbsp;<span class="op" id="5397564">*</span><span class="ident" id="5397565">http</span><span class="op" id="5397569">.</span><span class="ident" id="5397570">Request</span><span class="op" id="5397577">)</span>&nbsp;<span class="op" id="5397579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397582">if</span>&nbsp;<span class="ident" id="5397585">req</span><span class="op" id="5397588">.</span><span class="ident" id="5397589">Method</span>&nbsp;<span class="op" id="5397596">!=</span>&nbsp;<span class="string" id="5397599">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5397609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397613">w</span><span class="op" id="5397614">.</span><span class="ident" id="5397615">Header</span><span class="op" id="5397621">(</span><span class="op" id="5397622">)</span><span class="op" id="5397623">.</span><span class="ident" id="5397624">Set</span><span class="op" id="5397627">(</span><span class="string" id="5397628">&#34;Content-Type&#34;</span><span class="op" id="5397642">,</span>&nbsp;<span class="string" id="5397644">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5397671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397675">w</span><span class="op" id="5397676">.</span><span class="ident" id="5397677">WriteHeader</span><span class="op" id="5397688">(</span><span class="ident" id="5397689">http</span><span class="op" id="5397693">.</span><span class="ident" id="5397694">StatusMethodNotAllowed</span><span class="op" id="5397716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397720">io</span><span class="op" id="5397722">.</span><span class="ident" id="5397723">WriteString</span><span class="op" id="5397734">(</span><span class="ident" id="5397735">w</span><span class="op" id="5397736">,</span>&nbsp;<span class="string" id="5397738">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5397758">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397762">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397773">conn</span><span class="op" id="5397777">,</span>&nbsp;<span class="ident" id="5397779">_</span><span class="op" id="5397780">,</span>&nbsp;<span class="ident" id="5397782">err</span>&nbsp;<span class="op" id="5397786">:=</span>&nbsp;<span class="ident" id="5397789">w</span><span class="op" id="5397790">.</span><span class="op" id="5397791">(</span><span class="ident" id="5397792">http</span><span class="op" id="5397796">.</span><span class="ident" id="5397797">Hijacker</span><span class="op" id="5397805">)</span><span class="op" id="5397806">.</span><span class="ident" id="5397807">Hijack</span><span class="op" id="5397813">(</span><span class="op" id="5397814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397817">if</span>&nbsp;<span class="ident" id="5397820">err</span>&nbsp;<span class="op" id="5397824">!=</span>&nbsp;<span class="ident" id="5397827">nil</span>&nbsp;<span class="op" id="5397831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397835">log</span><span class="op" id="5397838">.</span><span class="ident" id="5397839">Print</span><span class="op" id="5397844">(</span><span class="string" id="5397845">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5397861">,</span>&nbsp;<span class="ident" id="5397863">req</span><span class="op" id="5397866">.</span><span class="ident" id="5397867">RemoteAddr</span><span class="op" id="5397877">,</span>&nbsp;<span class="string" id="5397879">&#34;:&nbsp;&#34;</span><span class="op" id="5397883">,</span>&nbsp;<span class="ident" id="5397885">err</span><span class="op" id="5397888">.</span><span class="ident" id="5397889">Error</span><span class="op" id="5397894">(</span><span class="op" id="5397895">)</span><span class="op" id="5397896">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5397900">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5397908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397911">io</span><span class="op" id="5397913">.</span><span class="ident" id="5397914">WriteString</span><span class="op" id="5397925">(</span><span class="ident" id="5397926">conn</span><span class="op" id="5397930">,</span>&nbsp;<span class="string" id="5397932">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5397943">+</span><span class="ident" id="5397944">connected</span><span class="op" id="5397953">+</span><span class="string" id="5397954">&#34;\n\n&#34;</span><span class="op" id="5397960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5397963">server</span><span class="op" id="5397969">.</span><span class="ident" id="5397970">ServeConn</span><span class="op" id="5397979">(</span><span class="ident" id="5397980">conn</span><span class="op" id="5397984">)</span><br>
<span class="lineno"></span><span class="op" id="5397986">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5397989">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5398058">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5398099">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5398177">func</span>&nbsp;<span class="op" id="5398182">(</span><span class="ident" id="5398183">server</span>&nbsp;<span class="op" id="5398190">*</span><span class="ident" id="5398191">Server</span><span class="op" id="5398197">)</span>&nbsp;<span class="ident" id="5398199">HandleHTTP</span><span class="op" id="5398209">(</span><span class="ident" id="5398210">rpcPath</span><span class="op" id="5398217">,</span>&nbsp;<span class="ident" id="5398219">debugPath</span>&nbsp;<span class="builtintype" id="5398229">string</span><span class="op" id="5398235">)</span>&nbsp;<span class="op" id="5398237">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398240">http</span><span class="op" id="5398244">.</span><span class="ident" id="5398245">Handle</span><span class="op" id="5398251">(</span><span class="ident" id="5398252">rpcPath</span><span class="op" id="5398259">,</span>&nbsp;<span class="ident" id="5398261">server</span><span class="op" id="5398267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398270">http</span><span class="op" id="5398274">.</span><span class="ident" id="5398275">Handle</span><span class="op" id="5398281">(</span><span class="ident" id="5398282">debugPath</span><span class="op" id="5398291">,</span>&nbsp;<span class="ident" id="5398293">debugHTTP</span><span class="op" id="5398302">{</span><span class="ident" id="5398303">server</span><span class="op" id="5398309">}</span><span class="op" id="5398310">)</span><br>
<span class="lineno"></span><span class="op" id="5398312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5398315">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5398389">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5398455">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5398533">func</span>&nbsp;<span class="ident" id="5398538">HandleHTTP</span><span class="op" id="5398548">(</span><span class="op" id="5398549">)</span>&nbsp;<span class="op" id="5398551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5398554">DefaultServer</span><span class="op" id="5398567">.</span><span class="ident" id="5398568">HandleHTTP</span><span class="op" id="5398578">(</span><span class="ident" id="5398579">DefaultRPCPath</span><span class="op" id="5398593">,</span>&nbsp;<span class="ident" id="5398595">DefaultDebugPath</span><span class="op" id="5398611">)</span><br>
<span class="lineno"></span><span class="op" id="5398613">}</span>
</div>
</body>
</html>
