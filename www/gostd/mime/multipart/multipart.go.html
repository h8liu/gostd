<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5063682">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5063737">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5063791">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="5063841">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="5063845">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5064038">package</span>&nbsp;<span class="ident" id="5064046">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5064057">import</span>&nbsp;<span class="op" id="5064064">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064067">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064076">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064085">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064092">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064098">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064111">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5064119">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="5064135">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="5064138">var</span>&nbsp;<span class="ident" id="5064142">emptyParams</span>&nbsp;<span class="op" id="5064154">=</span>&nbsp;<span class="builtinfunc" id="5064156">make</span><span class="op" id="5064160">(</span><span class="keyword" id="5064161">map</span><span class="op" id="5064164">[</span><span class="builtintype" id="5064165">string</span><span class="op" id="5064171">]</span><span class="builtintype" id="5064172">string</span><span class="op" id="5064178">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5064181">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="5064237">type</span>&nbsp;<span class="ident" id="5064242">Part</span>&nbsp;<span class="keyword" id="5064247">struct</span>&nbsp;<span class="op" id="5064254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064257">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064322">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064384">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064437">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064441">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064506">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064568">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064631">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064654">Header</span>&nbsp;<span class="ident" id="5064661">textproto</span><span class="op" id="5064670">.</span><span class="ident" id="5064671">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064684">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064694">*</span><span class="ident" id="5064695">bytes</span><span class="op" id="5064700">.</span><span class="ident" id="5064701">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064709">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5064719">*</span><span class="ident" id="5064720">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064728">bytesRead</span>&nbsp;<span class="builtintype" id="5064738">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064744">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5064762">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064770">dispositionParams</span>&nbsp;<span class="keyword" id="5064788">map</span><span class="op" id="5064791">[</span><span class="builtintype" id="5064792">string</span><span class="op" id="5064798">]</span><span class="builtintype" id="5064799">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064808">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064869">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5064916">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5064946">r</span>&nbsp;<span class="ident" id="5064948">io</span><span class="op" id="5064950">.</span><span class="ident" id="5064951">Reader</span><br>
<span class="lineno">50</span><span class="op" id="5064958">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5064961">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="5065031">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="5065095">func</span>&nbsp;<span class="op" id="5065100">(</span><span class="ident" id="5065101">p</span>&nbsp;<span class="op" id="5065103">*</span><span class="ident" id="5065104">Part</span><span class="op" id="5065108">)</span>&nbsp;<span class="ident" id="5065110">FormName</span><span class="op" id="5065118">(</span><span class="op" id="5065119">)</span>&nbsp;<span class="builtintype" id="5065121">string</span>&nbsp;<span class="op" id="5065128">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065131">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5065193">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065234">if</span>&nbsp;<span class="ident" id="5065237">p</span><span class="op" id="5065238">.</span><span class="ident" id="5065239">dispositionParams</span>&nbsp;<span class="op" id="5065257">==</span>&nbsp;<span class="ident" id="5065260">nil</span>&nbsp;<span class="op" id="5065264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065268">p</span><span class="op" id="5065269">.</span><span class="ident" id="5065270">parseContentDisposition</span><span class="op" id="5065293">(</span><span class="op" id="5065294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065297">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065300">if</span>&nbsp;<span class="ident" id="5065303">p</span><span class="op" id="5065304">.</span><span class="ident" id="5065305">disposition</span>&nbsp;<span class="op" id="5065317">!=</span>&nbsp;<span class="string" id="5065320">&#34;form-data&#34;</span>&nbsp;<span class="op" id="5065332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065336">return</span>&nbsp;<span class="string" id="5065343">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065350">return</span>&nbsp;<span class="ident" id="5065357">p</span><span class="op" id="5065358">.</span><span class="ident" id="5065359">dispositionParams</span><span class="op" id="5065376">[</span><span class="string" id="5065377">&#34;name&#34;</span><span class="op" id="5065383">]</span><br>
<span class="lineno"></span><span class="op" id="5065385">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="5065388">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="5065445">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5065476">func</span>&nbsp;<span class="op" id="5065481">(</span><span class="ident" id="5065482">p</span>&nbsp;<span class="op" id="5065484">*</span><span class="ident" id="5065485">Part</span><span class="op" id="5065489">)</span>&nbsp;<span class="ident" id="5065491">FileName</span><span class="op" id="5065499">(</span><span class="op" id="5065500">)</span>&nbsp;<span class="builtintype" id="5065502">string</span>&nbsp;<span class="op" id="5065509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065512">if</span>&nbsp;<span class="ident" id="5065515">p</span><span class="op" id="5065516">.</span><span class="ident" id="5065517">dispositionParams</span>&nbsp;<span class="op" id="5065535">==</span>&nbsp;<span class="ident" id="5065538">nil</span>&nbsp;<span class="op" id="5065542">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065546">p</span><span class="op" id="5065547">.</span><span class="ident" id="5065548">parseContentDisposition</span><span class="op" id="5065571">(</span><span class="op" id="5065572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065578">return</span>&nbsp;<span class="ident" id="5065585">p</span><span class="op" id="5065586">.</span><span class="ident" id="5065587">dispositionParams</span><span class="op" id="5065604">[</span><span class="string" id="5065605">&#34;filename&#34;</span><span class="op" id="5065615">]</span><br>
<span class="lineno"></span><span class="op" id="5065617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="5065620">func</span>&nbsp;<span class="op" id="5065625">(</span><span class="ident" id="5065626">p</span>&nbsp;<span class="op" id="5065628">*</span><span class="ident" id="5065629">Part</span><span class="op" id="5065633">)</span>&nbsp;<span class="ident" id="5065635">parseContentDisposition</span><span class="op" id="5065658">(</span><span class="op" id="5065659">)</span>&nbsp;<span class="op" id="5065661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065664">v</span>&nbsp;<span class="op" id="5065666">:=</span>&nbsp;<span class="ident" id="5065669">p</span><span class="op" id="5065670">.</span><span class="ident" id="5065671">Header</span><span class="op" id="5065677">.</span><span class="ident" id="5065678">Get</span><span class="op" id="5065681">(</span><span class="string" id="5065682">&#34;Content-Disposition&#34;</span><span class="op" id="5065703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065706">var</span>&nbsp;<span class="ident" id="5065710">err</span>&nbsp;<span class="builtintype" id="5065714">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065721">p</span><span class="op" id="5065722">.</span><span class="ident" id="5065723">disposition</span><span class="op" id="5065734">,</span>&nbsp;<span class="ident" id="5065736">p</span><span class="op" id="5065737">.</span><span class="ident" id="5065738">dispositionParams</span><span class="op" id="5065755">,</span>&nbsp;<span class="ident" id="5065757">err</span>&nbsp;<span class="op" id="5065761">=</span>&nbsp;<span class="ident" id="5065763">mime</span><span class="op" id="5065767">.</span><span class="ident" id="5065768">ParseMediaType</span><span class="op" id="5065782">(</span><span class="ident" id="5065783">v</span><span class="op" id="5065784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5065787">if</span>&nbsp;<span class="ident" id="5065790">err</span>&nbsp;<span class="op" id="5065794">!=</span>&nbsp;<span class="ident" id="5065797">nil</span>&nbsp;<span class="op" id="5065801">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5065805">p</span><span class="op" id="5065806">.</span><span class="ident" id="5065807">dispositionParams</span>&nbsp;<span class="op" id="5065825">=</span>&nbsp;<span class="ident" id="5065827">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5065840">}</span><br>
<span class="lineno"></span><span class="op" id="5065842">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5065845">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="5065914">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="5065938">//</span><br>
<span class="lineno"></span><span class="comment" id="5065941">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5066010">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5066077">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="5066100">func</span>&nbsp;<span class="ident" id="5066105">NewReader</span><span class="op" id="5066114">(</span><span class="ident" id="5066115">r</span>&nbsp;<span class="ident" id="5066117">io</span><span class="op" id="5066119">.</span><span class="ident" id="5066120">Reader</span><span class="op" id="5066126">,</span>&nbsp;<span class="ident" id="5066128">boundary</span>&nbsp;<span class="builtintype" id="5066137">string</span><span class="op" id="5066143">)</span>&nbsp;<span class="op" id="5066145">*</span><span class="ident" id="5066146">Reader</span>&nbsp;<span class="op" id="5066153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066156">b</span>&nbsp;<span class="op" id="5066158">:=</span>&nbsp;<span class="op" id="5066161">[</span><span class="op" id="5066162">]</span><span class="builtintype" id="5066163">byte</span><span class="op" id="5066167">(</span><span class="string" id="5066168">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="5066177">+</span>&nbsp;<span class="ident" id="5066179">boundary</span>&nbsp;<span class="op" id="5066188">+</span>&nbsp;<span class="string" id="5066190">&#34;--&#34;</span><span class="op" id="5066194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066197">return</span>&nbsp;<span class="op" id="5066204">&amp;</span><span class="ident" id="5066205">Reader</span><span class="op" id="5066211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066215">bufReader</span><span class="op" id="5066224">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066233">bufio</span><span class="op" id="5066238">.</span><span class="ident" id="5066239">NewReader</span><span class="op" id="5066248">(</span><span class="ident" id="5066249">r</span><span class="op" id="5066250">)</span><span class="op" id="5066251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066255">nl</span><span class="op" id="5066257">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066273">b</span><span class="op" id="5066274">[</span><span class="op" id="5066275">:</span><span class="num" id="5066276">2</span><span class="op" id="5066277">]</span><span class="op" id="5066278">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066282">nlDashBoundary</span><span class="op" id="5066296">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5066300">b</span><span class="op" id="5066301">[</span><span class="op" id="5066302">:</span><span class="builtinfunc" id="5066303">len</span><span class="op" id="5066306">(</span><span class="ident" id="5066307">b</span><span class="op" id="5066308">)</span><span class="op" id="5066309">-</span><span class="num" id="5066310">2</span><span class="op" id="5066311">]</span><span class="op" id="5066312">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066316">dashBoundaryDash</span><span class="op" id="5066332">:</span>&nbsp;<span class="ident" id="5066334">b</span><span class="op" id="5066335">[</span><span class="num" id="5066336">2</span><span class="op" id="5066337">:</span><span class="op" id="5066338">]</span><span class="op" id="5066339">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066343">dashBoundary</span><span class="op" id="5066355">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066361">b</span><span class="op" id="5066362">[</span><span class="num" id="5066363">2</span>&nbsp;<span class="op" id="5066365">:</span>&nbsp;<span class="builtinfunc" id="5066367">len</span><span class="op" id="5066370">(</span><span class="ident" id="5066371">b</span><span class="op" id="5066372">)</span><span class="op" id="5066373">-</span><span class="num" id="5066374">2</span><span class="op" id="5066375">]</span><span class="op" id="5066376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066379">}</span><br>
<span class="lineno"></span><span class="op" id="5066381">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="5066384">func</span>&nbsp;<span class="ident" id="5066389">newPart</span><span class="op" id="5066396">(</span><span class="ident" id="5066397">mr</span>&nbsp;<span class="op" id="5066400">*</span><span class="ident" id="5066401">Reader</span><span class="op" id="5066407">)</span>&nbsp;<span class="op" id="5066409">(</span><span class="op" id="5066410">*</span><span class="ident" id="5066411">Part</span><span class="op" id="5066415">,</span>&nbsp;<span class="builtintype" id="5066417">error</span><span class="op" id="5066422">)</span>&nbsp;<span class="op" id="5066424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066427">bp</span>&nbsp;<span class="op" id="5066430">:=</span>&nbsp;<span class="op" id="5066433">&amp;</span><span class="ident" id="5066434">Part</span><span class="op" id="5066438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066442">Header</span><span class="op" id="5066448">:</span>&nbsp;<span class="builtinfunc" id="5066450">make</span><span class="op" id="5066454">(</span><span class="keyword" id="5066455">map</span><span class="op" id="5066458">[</span><span class="builtintype" id="5066459">string</span><span class="op" id="5066465">]</span><span class="op" id="5066466">[</span><span class="op" id="5066467">]</span><span class="builtintype" id="5066468">string</span><span class="op" id="5066474">)</span><span class="op" id="5066475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066479">mr</span><span class="op" id="5066481">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5066487">mr</span><span class="op" id="5066489">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066493">buffer</span><span class="op" id="5066499">:</span>&nbsp;<span class="builtinfunc" id="5066501">new</span><span class="op" id="5066504">(</span><span class="ident" id="5066505">bytes</span><span class="op" id="5066510">.</span><span class="ident" id="5066511">Buffer</span><span class="op" id="5066517">)</span><span class="op" id="5066518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066524">if</span>&nbsp;<span class="ident" id="5066527">err</span>&nbsp;<span class="op" id="5066531">:=</span>&nbsp;<span class="ident" id="5066534">bp</span><span class="op" id="5066536">.</span><span class="ident" id="5066537">populateHeaders</span><span class="op" id="5066552">(</span><span class="op" id="5066553">)</span><span class="op" id="5066554">;</span>&nbsp;<span class="ident" id="5066556">err</span>&nbsp;<span class="op" id="5066560">!=</span>&nbsp;<span class="ident" id="5066563">nil</span>&nbsp;<span class="op" id="5066567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066571">return</span>&nbsp;<span class="ident" id="5066578">nil</span><span class="op" id="5066581">,</span>&nbsp;<span class="ident" id="5066583">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066588">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066591">bp</span><span class="op" id="5066593">.</span><span class="ident" id="5066594">r</span>&nbsp;<span class="op" id="5066596">=</span>&nbsp;<span class="ident" id="5066598">partReader</span><span class="op" id="5066608">{</span><span class="ident" id="5066609">bp</span><span class="op" id="5066611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066614">const</span>&nbsp;<span class="ident" id="5066620">cte</span>&nbsp;<span class="op" id="5066624">=</span>&nbsp;<span class="string" id="5066626">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066655">if</span>&nbsp;<span class="ident" id="5066658">bp</span><span class="op" id="5066660">.</span><span class="ident" id="5066661">Header</span><span class="op" id="5066667">.</span><span class="ident" id="5066668">Get</span><span class="op" id="5066671">(</span><span class="ident" id="5066672">cte</span><span class="op" id="5066675">)</span>&nbsp;<span class="op" id="5066677">==</span>&nbsp;<span class="string" id="5066680">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="5066699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066703">bp</span><span class="op" id="5066705">.</span><span class="ident" id="5066706">Header</span><span class="op" id="5066712">.</span><span class="ident" id="5066713">Del</span><span class="op" id="5066716">(</span><span class="ident" id="5066717">cte</span><span class="op" id="5066720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066724">bp</span><span class="op" id="5066726">.</span><span class="ident" id="5066727">r</span>&nbsp;<span class="op" id="5066729">=</span>&nbsp;<span class="ident" id="5066731">newQuotedPrintableReader</span><span class="op" id="5066755">(</span><span class="ident" id="5066756">bp</span><span class="op" id="5066758">.</span><span class="ident" id="5066759">r</span><span class="op" id="5066760">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066763">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066766">return</span>&nbsp;<span class="ident" id="5066773">bp</span><span class="op" id="5066775">,</span>&nbsp;<span class="ident" id="5066777">nil</span><br>
<span class="lineno"></span><span class="op" id="5066781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5066784">func</span>&nbsp;<span class="op" id="5066789">(</span><span class="ident" id="5066790">bp</span>&nbsp;<span class="op" id="5066793">*</span><span class="ident" id="5066794">Part</span><span class="op" id="5066798">)</span>&nbsp;<span class="ident" id="5066800">populateHeaders</span><span class="op" id="5066815">(</span><span class="op" id="5066816">)</span>&nbsp;<span class="builtintype" id="5066818">error</span>&nbsp;<span class="op" id="5066824">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066827">r</span>&nbsp;<span class="op" id="5066829">:=</span>&nbsp;<span class="ident" id="5066832">textproto</span><span class="op" id="5066841">.</span><span class="ident" id="5066842">NewReader</span><span class="op" id="5066851">(</span><span class="ident" id="5066852">bp</span><span class="op" id="5066854">.</span><span class="ident" id="5066855">mr</span><span class="op" id="5066857">.</span><span class="ident" id="5066858">bufReader</span><span class="op" id="5066867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066870">header</span><span class="op" id="5066876">,</span>&nbsp;<span class="ident" id="5066878">err</span>&nbsp;<span class="op" id="5066882">:=</span>&nbsp;<span class="ident" id="5066885">r</span><span class="op" id="5066886">.</span><span class="ident" id="5066887">ReadMIMEHeader</span><span class="op" id="5066901">(</span><span class="op" id="5066902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066905">if</span>&nbsp;<span class="ident" id="5066908">err</span>&nbsp;<span class="op" id="5066912">==</span>&nbsp;<span class="ident" id="5066915">nil</span>&nbsp;<span class="op" id="5066919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5066923">bp</span><span class="op" id="5066925">.</span><span class="ident" id="5066926">Header</span>&nbsp;<span class="op" id="5066933">=</span>&nbsp;<span class="ident" id="5066935">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5066943">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5066946">return</span>&nbsp;<span class="ident" id="5066953">err</span><br>
<span class="lineno"></span><span class="op" id="5066957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5066960">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5067027">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="5067057">func</span>&nbsp;<span class="op" id="5067062">(</span><span class="ident" id="5067063">p</span>&nbsp;<span class="op" id="5067065">*</span><span class="ident" id="5067066">Part</span><span class="op" id="5067070">)</span>&nbsp;<span class="ident" id="5067072">Read</span><span class="op" id="5067076">(</span><span class="ident" id="5067077">d</span>&nbsp;<span class="op" id="5067079">[</span><span class="op" id="5067080">]</span><span class="builtintype" id="5067081">byte</span><span class="op" id="5067085">)</span>&nbsp;<span class="op" id="5067087">(</span><span class="ident" id="5067088">n</span>&nbsp;<span class="builtintype" id="5067090">int</span><span class="op" id="5067093">,</span>&nbsp;<span class="ident" id="5067095">err</span>&nbsp;<span class="builtintype" id="5067099">error</span><span class="op" id="5067104">)</span>&nbsp;<span class="op" id="5067106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067109">return</span>&nbsp;<span class="ident" id="5067116">p</span><span class="op" id="5067117">.</span><span class="ident" id="5067118">r</span><span class="op" id="5067119">.</span><span class="ident" id="5067120">Read</span><span class="op" id="5067124">(</span><span class="ident" id="5067125">d</span><span class="op" id="5067126">)</span><br>
<span class="lineno"></span><span class="op" id="5067128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5067131">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="5067205">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="5067269">type</span>&nbsp;<span class="ident" id="5067274">partReader</span>&nbsp;<span class="keyword" id="5067285">struct</span>&nbsp;<span class="op" id="5067292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067295">p</span>&nbsp;<span class="op" id="5067297">*</span><span class="ident" id="5067298">Part</span><br>
<span class="lineno"></span><span class="op" id="5067303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="5067306">func</span>&nbsp;<span class="op" id="5067311">(</span><span class="ident" id="5067312">pr</span>&nbsp;<span class="ident" id="5067315">partReader</span><span class="op" id="5067325">)</span>&nbsp;<span class="ident" id="5067327">Read</span><span class="op" id="5067331">(</span><span class="ident" id="5067332">d</span>&nbsp;<span class="op" id="5067334">[</span><span class="op" id="5067335">]</span><span class="builtintype" id="5067336">byte</span><span class="op" id="5067340">)</span>&nbsp;<span class="op" id="5067342">(</span><span class="ident" id="5067343">n</span>&nbsp;<span class="builtintype" id="5067345">int</span><span class="op" id="5067348">,</span>&nbsp;<span class="ident" id="5067350">err</span>&nbsp;<span class="builtintype" id="5067354">error</span><span class="op" id="5067359">)</span>&nbsp;<span class="op" id="5067361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067364">p</span>&nbsp;<span class="op" id="5067366">:=</span>&nbsp;<span class="ident" id="5067369">pr</span><span class="op" id="5067371">.</span><span class="ident" id="5067372">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067375">defer</span>&nbsp;<span class="keyword" id="5067381">func</span><span class="op" id="5067385">(</span><span class="op" id="5067386">)</span>&nbsp;<span class="op" id="5067388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067392">p</span><span class="op" id="5067393">.</span><span class="ident" id="5067394">bytesRead</span>&nbsp;<span class="op" id="5067404">+=</span>&nbsp;<span class="ident" id="5067407">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067410">}</span><span class="op" id="5067411">(</span><span class="op" id="5067412">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067415">if</span>&nbsp;<span class="ident" id="5067418">p</span><span class="op" id="5067419">.</span><span class="ident" id="5067420">buffer</span><span class="op" id="5067426">.</span><span class="ident" id="5067427">Len</span><span class="op" id="5067430">(</span><span class="op" id="5067431">)</span>&nbsp;<span class="op" id="5067433">&gt;=</span>&nbsp;<span class="builtinfunc" id="5067436">len</span><span class="op" id="5067439">(</span><span class="ident" id="5067440">d</span><span class="op" id="5067441">)</span>&nbsp;<span class="op" id="5067443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067447">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067507">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067568">return</span>&nbsp;<span class="ident" id="5067575">p</span><span class="op" id="5067576">.</span><span class="ident" id="5067577">buffer</span><span class="op" id="5067583">.</span><span class="ident" id="5067584">Read</span><span class="op" id="5067588">(</span><span class="ident" id="5067589">d</span><span class="op" id="5067590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5067593">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5067596">peek</span><span class="op" id="5067600">,</span>&nbsp;<span class="ident" id="5067602">err</span>&nbsp;<span class="op" id="5067606">:=</span>&nbsp;<span class="ident" id="5067609">p</span><span class="op" id="5067610">.</span><span class="ident" id="5067611">mr</span><span class="op" id="5067613">.</span><span class="ident" id="5067614">bufReader</span><span class="op" id="5067623">.</span><span class="ident" id="5067624">Peek</span><span class="op" id="5067628">(</span><span class="num" id="5067629">4096</span><span class="op" id="5067633">)</span>&nbsp;<span class="comment" id="5067635">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067681">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067741">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067804">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067864">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5067924">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5067949">if</span>&nbsp;<span class="ident" id="5067952">p</span><span class="op" id="5067953">.</span><span class="ident" id="5067954">bytesRead</span>&nbsp;<span class="op" id="5067964">==</span>&nbsp;<span class="num" id="5067967">0</span>&nbsp;<span class="op" id="5067969">&amp;&amp;</span>&nbsp;<span class="ident" id="5067972">p</span><span class="op" id="5067973">.</span><span class="ident" id="5067974">mr</span><span class="op" id="5067976">.</span><span class="ident" id="5067977">peekBufferIsEmptyPart</span><span class="op" id="5067998">(</span><span class="ident" id="5067999">peek</span><span class="op" id="5068003">)</span>&nbsp;<span class="op" id="5068005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068009">return</span>&nbsp;<span class="num" id="5068016">0</span><span class="op" id="5068017">,</span>&nbsp;<span class="ident" id="5068019">io</span><span class="op" id="5068021">.</span><span class="ident" id="5068022">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068027">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068030">unexpectedEOF</span>&nbsp;<span class="op" id="5068044">:=</span>&nbsp;<span class="ident" id="5068047">err</span>&nbsp;<span class="op" id="5068051">==</span>&nbsp;<span class="ident" id="5068054">io</span><span class="op" id="5068056">.</span><span class="ident" id="5068057">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068062">if</span>&nbsp;<span class="ident" id="5068065">err</span>&nbsp;<span class="op" id="5068069">!=</span>&nbsp;<span class="ident" id="5068072">nil</span>&nbsp;<span class="op" id="5068076">&amp;&amp;</span>&nbsp;<span class="op" id="5068079">!</span><span class="ident" id="5068080">unexpectedEOF</span>&nbsp;<span class="op" id="5068094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068098">return</span>&nbsp;<span class="num" id="5068105">0</span><span class="op" id="5068106">,</span>&nbsp;<span class="ident" id="5068108">fmt</span><span class="op" id="5068111">.</span><span class="ident" id="5068112">Errorf</span><span class="op" id="5068118">(</span><span class="string" id="5068119">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="5068145">,</span>&nbsp;<span class="ident" id="5068147">err</span><span class="op" id="5068150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068156">if</span>&nbsp;<span class="ident" id="5068159">peek</span>&nbsp;<span class="op" id="5068164">==</span>&nbsp;<span class="ident" id="5068167">nil</span>&nbsp;<span class="op" id="5068171">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5068175">panic</span><span class="op" id="5068180">(</span><span class="string" id="5068181">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="5068195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068202">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068261">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068325">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068384">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068396">nCopy</span>&nbsp;<span class="op" id="5068402">:=</span>&nbsp;<span class="num" id="5068405">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068408">foundBoundary</span>&nbsp;<span class="op" id="5068422">:=</span>&nbsp;<span class="builtintype" id="5068425">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068432">if</span>&nbsp;<span class="ident" id="5068435">idx</span>&nbsp;<span class="op" id="5068439">:=</span>&nbsp;<span class="ident" id="5068442">bytes</span><span class="op" id="5068447">.</span><span class="ident" id="5068448">Index</span><span class="op" id="5068453">(</span><span class="ident" id="5068454">peek</span><span class="op" id="5068458">,</span>&nbsp;<span class="ident" id="5068460">p</span><span class="op" id="5068461">.</span><span class="ident" id="5068462">mr</span><span class="op" id="5068464">.</span><span class="ident" id="5068465">nlDashBoundary</span><span class="op" id="5068479">)</span><span class="op" id="5068480">;</span>&nbsp;<span class="ident" id="5068482">idx</span>&nbsp;<span class="op" id="5068486">!=</span>&nbsp;<span class="op" id="5068489">-</span><span class="num" id="5068490">1</span>&nbsp;<span class="op" id="5068492">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068496">nCopy</span>&nbsp;<span class="op" id="5068502">=</span>&nbsp;<span class="ident" id="5068504">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068510">foundBoundary</span>&nbsp;<span class="op" id="5068524">=</span>&nbsp;<span class="builtintype" id="5068526">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068532">}</span>&nbsp;<span class="keyword" id="5068534">else</span>&nbsp;<span class="keyword" id="5068539">if</span>&nbsp;<span class="ident" id="5068542">safeCount</span>&nbsp;<span class="op" id="5068552">:=</span>&nbsp;<span class="builtinfunc" id="5068555">len</span><span class="op" id="5068558">(</span><span class="ident" id="5068559">peek</span><span class="op" id="5068563">)</span>&nbsp;<span class="op" id="5068565">-</span>&nbsp;<span class="builtinfunc" id="5068567">len</span><span class="op" id="5068570">(</span><span class="ident" id="5068571">p</span><span class="op" id="5068572">.</span><span class="ident" id="5068573">mr</span><span class="op" id="5068575">.</span><span class="ident" id="5068576">nlDashBoundary</span><span class="op" id="5068590">)</span><span class="op" id="5068591">;</span>&nbsp;<span class="ident" id="5068593">safeCount</span>&nbsp;<span class="op" id="5068603">&gt;</span>&nbsp;<span class="num" id="5068605">0</span>&nbsp;<span class="op" id="5068607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068611">nCopy</span>&nbsp;<span class="op" id="5068617">=</span>&nbsp;<span class="ident" id="5068619">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068630">}</span>&nbsp;<span class="keyword" id="5068632">else</span>&nbsp;<span class="keyword" id="5068637">if</span>&nbsp;<span class="ident" id="5068640">unexpectedEOF</span>&nbsp;<span class="op" id="5068654">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068658">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068712">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5068769">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068812">return</span>&nbsp;<span class="num" id="5068819">0</span><span class="op" id="5068820">,</span>&nbsp;<span class="ident" id="5068822">io</span><span class="op" id="5068824">.</span><span class="ident" id="5068825">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068843">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068846">if</span>&nbsp;<span class="ident" id="5068849">nCopy</span>&nbsp;<span class="op" id="5068855">&gt;</span>&nbsp;<span class="num" id="5068857">0</span>&nbsp;<span class="op" id="5068859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068863">if</span>&nbsp;<span class="ident" id="5068866">_</span><span class="op" id="5068867">,</span>&nbsp;<span class="ident" id="5068869">err</span>&nbsp;<span class="op" id="5068873">:=</span>&nbsp;<span class="ident" id="5068876">io</span><span class="op" id="5068878">.</span><span class="ident" id="5068879">CopyN</span><span class="op" id="5068884">(</span><span class="ident" id="5068885">p</span><span class="op" id="5068886">.</span><span class="ident" id="5068887">buffer</span><span class="op" id="5068893">,</span>&nbsp;<span class="ident" id="5068895">p</span><span class="op" id="5068896">.</span><span class="ident" id="5068897">mr</span><span class="op" id="5068899">.</span><span class="ident" id="5068900">bufReader</span><span class="op" id="5068909">,</span>&nbsp;<span class="ident" id="5068911">int64</span><span class="op" id="5068916">(</span><span class="ident" id="5068917">nCopy</span><span class="op" id="5068922">)</span><span class="op" id="5068923">)</span><span class="op" id="5068924">;</span>&nbsp;<span class="ident" id="5068926">err</span>&nbsp;<span class="op" id="5068930">!=</span>&nbsp;<span class="ident" id="5068933">nil</span>&nbsp;<span class="op" id="5068937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068942">return</span>&nbsp;<span class="num" id="5068949">0</span><span class="op" id="5068950">,</span>&nbsp;<span class="ident" id="5068952">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5068961">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5068964">n</span><span class="op" id="5068965">,</span>&nbsp;<span class="ident" id="5068967">err</span>&nbsp;<span class="op" id="5068971">=</span>&nbsp;<span class="ident" id="5068973">p</span><span class="op" id="5068974">.</span><span class="ident" id="5068975">buffer</span><span class="op" id="5068981">.</span><span class="ident" id="5068982">Read</span><span class="op" id="5068986">(</span><span class="ident" id="5068987">d</span><span class="op" id="5068988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5068991">if</span>&nbsp;<span class="ident" id="5068994">err</span>&nbsp;<span class="op" id="5068998">==</span>&nbsp;<span class="ident" id="5069001">io</span><span class="op" id="5069003">.</span><span class="ident" id="5069004">EOF</span>&nbsp;<span class="op" id="5069008">&amp;&amp;</span>&nbsp;<span class="op" id="5069011">!</span><span class="ident" id="5069012">foundBoundary</span>&nbsp;<span class="op" id="5069026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069030">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5069087">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069143">err</span>&nbsp;<span class="op" id="5069147">=</span>&nbsp;<span class="ident" id="5069149">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069157">return</span><br>
<span class="lineno"></span><span class="op" id="5069164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5069167">func</span>&nbsp;<span class="op" id="5069172">(</span><span class="ident" id="5069173">p</span>&nbsp;<span class="op" id="5069175">*</span><span class="ident" id="5069176">Part</span><span class="op" id="5069180">)</span>&nbsp;<span class="ident" id="5069182">Close</span><span class="op" id="5069187">(</span><span class="op" id="5069188">)</span>&nbsp;<span class="builtintype" id="5069190">error</span>&nbsp;<span class="op" id="5069196">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069199">io</span><span class="op" id="5069201">.</span><span class="ident" id="5069202">Copy</span><span class="op" id="5069206">(</span><span class="ident" id="5069207">ioutil</span><span class="op" id="5069213">.</span><span class="ident" id="5069214">Discard</span><span class="op" id="5069221">,</span>&nbsp;<span class="ident" id="5069223">p</span><span class="op" id="5069224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069227">return</span>&nbsp;<span class="ident" id="5069234">nil</span><br>
<span class="lineno"></span><span class="op" id="5069238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069241">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="5069303">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="5069372">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="5069392">type</span>&nbsp;<span class="ident" id="5069397">Reader</span>&nbsp;<span class="keyword" id="5069404">struct</span>&nbsp;<span class="op" id="5069411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069414">bufReader</span>&nbsp;<span class="op" id="5069424">*</span><span class="ident" id="5069425">bufio</span><span class="op" id="5069430">.</span><span class="ident" id="5069431">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069440">currentPart</span>&nbsp;<span class="op" id="5069452">*</span><span class="ident" id="5069453">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069459">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5069471">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069477">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069494">[</span><span class="op" id="5069495">]</span><span class="builtintype" id="5069496">byte</span>&nbsp;<span class="comment" id="5069501">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069559">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5069576">[</span><span class="op" id="5069577">]</span><span class="builtintype" id="5069578">byte</span>&nbsp;<span class="comment" id="5069583">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069605">dashBoundaryDash</span>&nbsp;<span class="op" id="5069622">[</span><span class="op" id="5069623">]</span><span class="builtintype" id="5069624">byte</span>&nbsp;<span class="comment" id="5069629">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069648">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5069665">[</span><span class="op" id="5069666">]</span><span class="builtintype" id="5069667">byte</span>&nbsp;<span class="comment" id="5069672">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="5069688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5069691">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="5069755">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5069818">func</span>&nbsp;<span class="op" id="5069823">(</span><span class="ident" id="5069824">r</span>&nbsp;<span class="op" id="5069826">*</span><span class="ident" id="5069827">Reader</span><span class="op" id="5069833">)</span>&nbsp;<span class="ident" id="5069835">NextPart</span><span class="op" id="5069843">(</span><span class="op" id="5069844">)</span>&nbsp;<span class="op" id="5069846">(</span><span class="op" id="5069847">*</span><span class="ident" id="5069848">Part</span><span class="op" id="5069852">,</span>&nbsp;<span class="builtintype" id="5069854">error</span><span class="op" id="5069859">)</span>&nbsp;<span class="op" id="5069861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069864">if</span>&nbsp;<span class="ident" id="5069867">r</span><span class="op" id="5069868">.</span><span class="ident" id="5069869">currentPart</span>&nbsp;<span class="op" id="5069881">!=</span>&nbsp;<span class="ident" id="5069884">nil</span>&nbsp;<span class="op" id="5069888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069892">r</span><span class="op" id="5069893">.</span><span class="ident" id="5069894">currentPart</span><span class="op" id="5069905">.</span><span class="ident" id="5069906">Close</span><span class="op" id="5069911">(</span><span class="op" id="5069912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5069915">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069919">expectNewPart</span>&nbsp;<span class="op" id="5069933">:=</span>&nbsp;<span class="builtintype" id="5069936">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069943">for</span>&nbsp;<span class="op" id="5069947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5069951">line</span><span class="op" id="5069955">,</span>&nbsp;<span class="ident" id="5069957">err</span>&nbsp;<span class="op" id="5069961">:=</span>&nbsp;<span class="ident" id="5069964">r</span><span class="op" id="5069965">.</span><span class="ident" id="5069966">bufReader</span><span class="op" id="5069975">.</span><span class="ident" id="5069976">ReadSlice</span><span class="op" id="5069985">(</span><span class="string" id="5069986">&#39;\n&#39;</span><span class="op" id="5069990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5069994">if</span>&nbsp;<span class="ident" id="5069997">err</span>&nbsp;<span class="op" id="5070001">==</span>&nbsp;<span class="ident" id="5070004">io</span><span class="op" id="5070006">.</span><span class="ident" id="5070007">EOF</span>&nbsp;<span class="op" id="5070011">&amp;&amp;</span>&nbsp;<span class="ident" id="5070014">r</span><span class="op" id="5070015">.</span><span class="ident" id="5070016">isFinalBoundary</span><span class="op" id="5070031">(</span><span class="ident" id="5070032">line</span><span class="op" id="5070036">)</span>&nbsp;<span class="op" id="5070038">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070043">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070098">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070152">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070209">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070268">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070293">return</span>&nbsp;<span class="ident" id="5070300">nil</span><span class="op" id="5070303">,</span>&nbsp;<span class="ident" id="5070305">io</span><span class="op" id="5070307">.</span><span class="ident" id="5070308">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070318">if</span>&nbsp;<span class="ident" id="5070321">err</span>&nbsp;<span class="op" id="5070325">!=</span>&nbsp;<span class="ident" id="5070328">nil</span>&nbsp;<span class="op" id="5070332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070337">return</span>&nbsp;<span class="ident" id="5070344">nil</span><span class="op" id="5070347">,</span>&nbsp;<span class="ident" id="5070349">fmt</span><span class="op" id="5070352">.</span><span class="ident" id="5070353">Errorf</span><span class="op" id="5070359">(</span><span class="string" id="5070360">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="5070385">,</span>&nbsp;<span class="ident" id="5070387">err</span><span class="op" id="5070390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070394">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070399">if</span>&nbsp;<span class="ident" id="5070402">r</span><span class="op" id="5070403">.</span><span class="ident" id="5070404">isBoundaryDelimiterLine</span><span class="op" id="5070427">(</span><span class="ident" id="5070428">line</span><span class="op" id="5070432">)</span>&nbsp;<span class="op" id="5070434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070439">r</span><span class="op" id="5070440">.</span><span class="ident" id="5070441">partsRead</span><span class="op" id="5070450">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070456">bp</span><span class="op" id="5070458">,</span>&nbsp;<span class="ident" id="5070460">err</span>&nbsp;<span class="op" id="5070464">:=</span>&nbsp;<span class="ident" id="5070467">newPart</span><span class="op" id="5070474">(</span><span class="ident" id="5070475">r</span><span class="op" id="5070476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070481">if</span>&nbsp;<span class="ident" id="5070484">err</span>&nbsp;<span class="op" id="5070488">!=</span>&nbsp;<span class="ident" id="5070491">nil</span>&nbsp;<span class="op" id="5070495">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070501">return</span>&nbsp;<span class="ident" id="5070508">nil</span><span class="op" id="5070511">,</span>&nbsp;<span class="ident" id="5070513">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5070525">r</span><span class="op" id="5070526">.</span><span class="ident" id="5070527">currentPart</span>&nbsp;<span class="op" id="5070539">=</span>&nbsp;<span class="ident" id="5070541">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070547">return</span>&nbsp;<span class="ident" id="5070554">bp</span><span class="op" id="5070556">,</span>&nbsp;<span class="ident" id="5070558">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070564">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070569">if</span>&nbsp;<span class="ident" id="5070572">r</span><span class="op" id="5070573">.</span><span class="ident" id="5070574">isFinalBoundary</span><span class="op" id="5070589">(</span><span class="ident" id="5070590">line</span><span class="op" id="5070594">)</span>&nbsp;<span class="op" id="5070596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070601">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070620">return</span>&nbsp;<span class="ident" id="5070627">nil</span><span class="op" id="5070630">,</span>&nbsp;<span class="ident" id="5070632">io</span><span class="op" id="5070634">.</span><span class="ident" id="5070635">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070641">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070646">if</span>&nbsp;<span class="ident" id="5070649">expectNewPart</span>&nbsp;<span class="op" id="5070663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070668">return</span>&nbsp;<span class="ident" id="5070675">nil</span><span class="op" id="5070678">,</span>&nbsp;<span class="ident" id="5070680">fmt</span><span class="op" id="5070683">.</span><span class="ident" id="5070684">Errorf</span><span class="op" id="5070690">(</span><span class="string" id="5070691">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="5070737">,</span>&nbsp;<span class="builtintype" id="5070739">string</span><span class="op" id="5070745">(</span><span class="ident" id="5070746">line</span><span class="op" id="5070750">)</span><span class="op" id="5070751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070755">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070760">if</span>&nbsp;<span class="ident" id="5070763">r</span><span class="op" id="5070764">.</span><span class="ident" id="5070765">partsRead</span>&nbsp;<span class="op" id="5070775">==</span>&nbsp;<span class="num" id="5070778">0</span>&nbsp;<span class="op" id="5070780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070785">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5070801">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5070812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070817">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070871">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070927">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5070982">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071001">if</span>&nbsp;<span class="ident" id="5071004">bytes</span><span class="op" id="5071009">.</span><span class="ident" id="5071010">Equal</span><span class="op" id="5071015">(</span><span class="ident" id="5071016">line</span><span class="op" id="5071020">,</span>&nbsp;<span class="ident" id="5071022">r</span><span class="op" id="5071023">.</span><span class="ident" id="5071024">nl</span><span class="op" id="5071026">)</span>&nbsp;<span class="op" id="5071028">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071033">expectNewPart</span>&nbsp;<span class="op" id="5071047">=</span>&nbsp;<span class="builtintype" id="5071049">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071057">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071073">return</span>&nbsp;<span class="ident" id="5071080">nil</span><span class="op" id="5071083">,</span>&nbsp;<span class="ident" id="5071085">fmt</span><span class="op" id="5071088">.</span><span class="ident" id="5071089">Errorf</span><span class="op" id="5071095">(</span><span class="string" id="5071096">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="5071138">,</span>&nbsp;<span class="ident" id="5071140">line</span><span class="op" id="5071144">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071147">}</span><br>
<span class="lineno"></span><span class="op" id="5071149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5071152">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="5071219">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="5071258">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="5071302">func</span>&nbsp;<span class="op" id="5071307">(</span><span class="ident" id="5071308">mr</span>&nbsp;<span class="op" id="5071311">*</span><span class="ident" id="5071312">Reader</span><span class="op" id="5071318">)</span>&nbsp;<span class="ident" id="5071320">isFinalBoundary</span><span class="op" id="5071335">(</span><span class="ident" id="5071336">line</span>&nbsp;<span class="op" id="5071341">[</span><span class="op" id="5071342">]</span><span class="builtintype" id="5071343">byte</span><span class="op" id="5071347">)</span>&nbsp;<span class="builtintype" id="5071349">bool</span>&nbsp;<span class="op" id="5071354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071357">if</span>&nbsp;<span class="op" id="5071360">!</span><span class="ident" id="5071361">bytes</span><span class="op" id="5071366">.</span><span class="ident" id="5071367">HasPrefix</span><span class="op" id="5071376">(</span><span class="ident" id="5071377">line</span><span class="op" id="5071381">,</span>&nbsp;<span class="ident" id="5071383">mr</span><span class="op" id="5071385">.</span><span class="ident" id="5071386">dashBoundaryDash</span><span class="op" id="5071402">)</span>&nbsp;<span class="op" id="5071404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071408">return</span>&nbsp;<span class="builtintype" id="5071415">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5071422">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071425">rest</span>&nbsp;<span class="op" id="5071430">:=</span>&nbsp;<span class="ident" id="5071433">line</span><span class="op" id="5071437">[</span><span class="builtinfunc" id="5071438">len</span><span class="op" id="5071441">(</span><span class="ident" id="5071442">mr</span><span class="op" id="5071444">.</span><span class="ident" id="5071445">dashBoundaryDash</span><span class="op" id="5071461">)</span><span class="op" id="5071462">:</span><span class="op" id="5071463">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5071466">rest</span>&nbsp;<span class="op" id="5071471">=</span>&nbsp;<span class="ident" id="5071473">skipLWSPChar</span><span class="op" id="5071485">(</span><span class="ident" id="5071486">rest</span><span class="op" id="5071490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071493">return</span>&nbsp;<span class="builtinfunc" id="5071500">len</span><span class="op" id="5071503">(</span><span class="ident" id="5071504">rest</span><span class="op" id="5071508">)</span>&nbsp;<span class="op" id="5071510">==</span>&nbsp;<span class="num" id="5071513">0</span>&nbsp;<span class="op" id="5071515">||</span>&nbsp;<span class="ident" id="5071518">bytes</span><span class="op" id="5071523">.</span><span class="ident" id="5071524">Equal</span><span class="op" id="5071529">(</span><span class="ident" id="5071530">rest</span><span class="op" id="5071534">,</span>&nbsp;<span class="ident" id="5071536">mr</span><span class="op" id="5071538">.</span><span class="ident" id="5071539">nl</span><span class="op" id="5071541">)</span><br>
<span class="lineno"></span><span class="op" id="5071543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="5071546">func</span>&nbsp;<span class="op" id="5071551">(</span><span class="ident" id="5071552">mr</span>&nbsp;<span class="op" id="5071555">*</span><span class="ident" id="5071556">Reader</span><span class="op" id="5071562">)</span>&nbsp;<span class="ident" id="5071564">isBoundaryDelimiterLine</span><span class="op" id="5071587">(</span><span class="ident" id="5071588">line</span>&nbsp;<span class="op" id="5071593">[</span><span class="op" id="5071594">]</span><span class="builtintype" id="5071595">byte</span><span class="op" id="5071599">)</span>&nbsp;<span class="op" id="5071601">(</span><span class="ident" id="5071602">ret</span>&nbsp;<span class="builtintype" id="5071606">bool</span><span class="op" id="5071610">)</span>&nbsp;<span class="op" id="5071612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071615">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071666">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071726">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071783">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071842">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5071906">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071948">if</span>&nbsp;<span class="op" id="5071951">!</span><span class="ident" id="5071952">bytes</span><span class="op" id="5071957">.</span><span class="ident" id="5071958">HasPrefix</span><span class="op" id="5071967">(</span><span class="ident" id="5071968">line</span><span class="op" id="5071972">,</span>&nbsp;<span class="ident" id="5071974">mr</span><span class="op" id="5071976">.</span><span class="ident" id="5071977">dashBoundary</span><span class="op" id="5071989">)</span>&nbsp;<span class="op" id="5071991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5071995">return</span>&nbsp;<span class="builtintype" id="5072002">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072009">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072012">rest</span>&nbsp;<span class="op" id="5072017">:=</span>&nbsp;<span class="ident" id="5072020">line</span><span class="op" id="5072024">[</span><span class="builtinfunc" id="5072025">len</span><span class="op" id="5072028">(</span><span class="ident" id="5072029">mr</span><span class="op" id="5072031">.</span><span class="ident" id="5072032">dashBoundary</span><span class="op" id="5072044">)</span><span class="op" id="5072045">:</span><span class="op" id="5072046">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072049">rest</span>&nbsp;<span class="op" id="5072054">=</span>&nbsp;<span class="ident" id="5072056">skipLWSPChar</span><span class="op" id="5072068">(</span><span class="ident" id="5072069">rest</span><span class="op" id="5072073">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072077">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072147">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5072218">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072246">if</span>&nbsp;<span class="ident" id="5072249">mr</span><span class="op" id="5072251">.</span><span class="ident" id="5072252">partsRead</span>&nbsp;<span class="op" id="5072262">==</span>&nbsp;<span class="num" id="5072265">0</span>&nbsp;<span class="op" id="5072267">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5072270">len</span><span class="op" id="5072273">(</span><span class="ident" id="5072274">rest</span><span class="op" id="5072278">)</span>&nbsp;<span class="op" id="5072280">==</span>&nbsp;<span class="num" id="5072283">1</span>&nbsp;<span class="op" id="5072285">&amp;&amp;</span>&nbsp;<span class="ident" id="5072288">rest</span><span class="op" id="5072292">[</span><span class="num" id="5072293">0</span><span class="op" id="5072294">]</span>&nbsp;<span class="op" id="5072296">==</span>&nbsp;<span class="string" id="5072299">&#39;\n&#39;</span>&nbsp;<span class="op" id="5072304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072308">mr</span><span class="op" id="5072310">.</span><span class="ident" id="5072311">nl</span>&nbsp;<span class="op" id="5072314">=</span>&nbsp;<span class="ident" id="5072316">mr</span><span class="op" id="5072318">.</span><span class="ident" id="5072319">nl</span><span class="op" id="5072321">[</span><span class="num" id="5072322">1</span><span class="op" id="5072323">:</span><span class="op" id="5072324">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5072328">mr</span><span class="op" id="5072330">.</span><span class="ident" id="5072331">nlDashBoundary</span>&nbsp;<span class="op" id="5072346">=</span>&nbsp;<span class="ident" id="5072348">mr</span><span class="op" id="5072350">.</span><span class="ident" id="5072351">nlDashBoundary</span><span class="op" id="5072365">[</span><span class="num" id="5072366">1</span><span class="op" id="5072367">:</span><span class="op" id="5072368">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5072371">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5072374">return</span>&nbsp;<span class="ident" id="5072381">bytes</span><span class="op" id="5072386">.</span><span class="ident" id="5072387">Equal</span><span class="op" id="5072392">(</span><span class="ident" id="5072393">rest</span><span class="op" id="5072397">,</span>&nbsp;<span class="ident" id="5072399">mr</span><span class="op" id="5072401">.</span><span class="ident" id="5072402">nl</span><span class="op" id="5072404">)</span><br>
<span class="lineno"></span><span class="op" id="5072406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5072409">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="5072474">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="5072541">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="5072612">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="5072677">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="5072689">//</span><br>
<span class="lineno"></span><span class="comment" id="5072692">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="5072762">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="5072830">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5072898">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5072942">func</span>&nbsp;<span class="op" id="5072947">(</span><span class="ident" id="5072948">mr</span>&nbsp;<span class="op" id="5072951">*</span><span class="ident" id="5072952">Reader</span><span class="op" id="5072958">)</span>&nbsp;<span class="ident" id="5072960">peekBufferIsEmptyPart</span><span class="op" id="5072981">(</span><span class="ident" id="5072982">peek</span>&nbsp;<span class="op" id="5072987">[</span><span class="op" id="5072988">]</span><span class="builtintype" id="5072989">byte</span><span class="op" id="5072993">)</span>&nbsp;<span class="builtintype" id="5072995">bool</span>&nbsp;<span class="op" id="5073000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5073003">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5073026">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073088">if</span>&nbsp;<span class="ident" id="5073091">bytes</span><span class="op" id="5073096">.</span><span class="ident" id="5073097">HasPrefix</span><span class="op" id="5073106">(</span><span class="ident" id="5073107">peek</span><span class="op" id="5073111">,</span>&nbsp;<span class="ident" id="5073113">mr</span><span class="op" id="5073115">.</span><span class="ident" id="5073116">dashBoundaryDash</span><span class="op" id="5073132">)</span>&nbsp;<span class="op" id="5073134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073138">rest</span>&nbsp;<span class="op" id="5073143">:=</span>&nbsp;<span class="ident" id="5073146">peek</span><span class="op" id="5073150">[</span><span class="builtinfunc" id="5073151">len</span><span class="op" id="5073154">(</span><span class="ident" id="5073155">mr</span><span class="op" id="5073157">.</span><span class="ident" id="5073158">dashBoundaryDash</span><span class="op" id="5073174">)</span><span class="op" id="5073175">:</span><span class="op" id="5073176">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073180">rest</span>&nbsp;<span class="op" id="5073185">=</span>&nbsp;<span class="ident" id="5073187">skipLWSPChar</span><span class="op" id="5073199">(</span><span class="ident" id="5073200">rest</span><span class="op" id="5073204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073208">return</span>&nbsp;<span class="ident" id="5073215">bytes</span><span class="op" id="5073220">.</span><span class="ident" id="5073221">HasPrefix</span><span class="op" id="5073230">(</span><span class="ident" id="5073231">rest</span><span class="op" id="5073235">,</span>&nbsp;<span class="ident" id="5073237">mr</span><span class="op" id="5073239">.</span><span class="ident" id="5073240">nl</span><span class="op" id="5073242">)</span>&nbsp;<span class="op" id="5073244">||</span>&nbsp;<span class="builtinfunc" id="5073247">len</span><span class="op" id="5073250">(</span><span class="ident" id="5073251">rest</span><span class="op" id="5073255">)</span>&nbsp;<span class="op" id="5073257">==</span>&nbsp;<span class="num" id="5073260">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073266">if</span>&nbsp;<span class="op" id="5073269">!</span><span class="ident" id="5073270">bytes</span><span class="op" id="5073275">.</span><span class="ident" id="5073276">HasPrefix</span><span class="op" id="5073285">(</span><span class="ident" id="5073286">peek</span><span class="op" id="5073290">,</span>&nbsp;<span class="ident" id="5073292">mr</span><span class="op" id="5073294">.</span><span class="ident" id="5073295">dashBoundary</span><span class="op" id="5073307">)</span>&nbsp;<span class="op" id="5073309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073313">return</span>&nbsp;<span class="builtintype" id="5073320">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5073330">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073375">rest</span>&nbsp;<span class="op" id="5073380">:=</span>&nbsp;<span class="ident" id="5073383">peek</span><span class="op" id="5073387">[</span><span class="builtinfunc" id="5073388">len</span><span class="op" id="5073391">(</span><span class="ident" id="5073392">mr</span><span class="op" id="5073394">.</span><span class="ident" id="5073395">dashBoundary</span><span class="op" id="5073407">)</span><span class="op" id="5073408">:</span><span class="op" id="5073409">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073412">rest</span>&nbsp;<span class="op" id="5073417">=</span>&nbsp;<span class="ident" id="5073419">skipLWSPChar</span><span class="op" id="5073431">(</span><span class="ident" id="5073432">rest</span><span class="op" id="5073436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073439">return</span>&nbsp;<span class="ident" id="5073446">bytes</span><span class="op" id="5073451">.</span><span class="ident" id="5073452">HasPrefix</span><span class="op" id="5073461">(</span><span class="ident" id="5073462">rest</span><span class="op" id="5073466">,</span>&nbsp;<span class="ident" id="5073468">mr</span><span class="op" id="5073470">.</span><span class="ident" id="5073471">nl</span><span class="op" id="5073473">)</span><br>
<span class="lineno"></span><span class="op" id="5073475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="5073478">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="5073542">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="5073562">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="5073593">func</span>&nbsp;<span class="ident" id="5073598">skipLWSPChar</span><span class="op" id="5073610">(</span><span class="ident" id="5073611">b</span>&nbsp;<span class="op" id="5073613">[</span><span class="op" id="5073614">]</span><span class="builtintype" id="5073615">byte</span><span class="op" id="5073619">)</span>&nbsp;<span class="op" id="5073621">[</span><span class="op" id="5073622">]</span><span class="builtintype" id="5073623">byte</span>&nbsp;<span class="op" id="5073628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073631">for</span>&nbsp;<span class="builtinfunc" id="5073635">len</span><span class="op" id="5073638">(</span><span class="ident" id="5073639">b</span><span class="op" id="5073640">)</span>&nbsp;<span class="op" id="5073642">&gt;</span>&nbsp;<span class="num" id="5073644">0</span>&nbsp;<span class="op" id="5073646">&amp;&amp;</span>&nbsp;<span class="op" id="5073649">(</span><span class="ident" id="5073650">b</span><span class="op" id="5073651">[</span><span class="num" id="5073652">0</span><span class="op" id="5073653">]</span>&nbsp;<span class="op" id="5073655">==</span>&nbsp;<span class="string" id="5073658">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5073662">||</span>&nbsp;<span class="ident" id="5073665">b</span><span class="op" id="5073666">[</span><span class="num" id="5073667">0</span><span class="op" id="5073668">]</span>&nbsp;<span class="op" id="5073670">==</span>&nbsp;<span class="string" id="5073673">&#39;\t&#39;</span><span class="op" id="5073677">)</span>&nbsp;<span class="op" id="5073679">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5073683">b</span>&nbsp;<span class="op" id="5073685">=</span>&nbsp;<span class="ident" id="5073687">b</span><span class="op" id="5073688">[</span><span class="num" id="5073689">1</span><span class="op" id="5073690">:</span><span class="op" id="5073691">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5073694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5073697">return</span>&nbsp;<span class="ident" id="5073704">b</span><br>
<span class="lineno"></span><span class="op" id="5073706">}</span>
</div>
</body>
</html>
