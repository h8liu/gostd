<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html" class="current">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6152833">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6152888">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6152942">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6152993">package</span>&nbsp;<span class="ident" id="6153001">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6153011">import</span>&nbsp;<span class="op" id="6153018">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153021">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153030">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153040">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153046">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153053">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153065">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6153082">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6153089">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6153092">var</span>&nbsp;<span class="op" id="6153096">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6153099">ErrPersistEOF</span>&nbsp;<span class="op" id="6153113">=</span>&nbsp;<span class="op" id="6153115">&amp;</span><span class="ident" id="6153116">http</span><span class="op" id="6153120">.</span><span class="ident" id="6153121">ProtocolError</span><span class="op" id="6153134">{</span><span class="ident" id="6153135">ErrorString</span><span class="op" id="6153146">:</span>&nbsp;<span class="string" id="6153148">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6153178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6153181">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6153195">=</span>&nbsp;<span class="op" id="6153197">&amp;</span><span class="ident" id="6153198">http</span><span class="op" id="6153202">.</span><span class="ident" id="6153203">ProtocolError</span><span class="op" id="6153216">{</span><span class="ident" id="6153217">ErrorString</span><span class="op" id="6153228">:</span>&nbsp;<span class="string" id="6153230">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6153257">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6153260">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6153274">=</span>&nbsp;<span class="op" id="6153276">&amp;</span><span class="ident" id="6153277">http</span><span class="op" id="6153281">.</span><span class="ident" id="6153282">ProtocolError</span><span class="op" id="6153295">{</span><span class="ident" id="6153296">ErrorString</span><span class="op" id="6153307">:</span>&nbsp;<span class="string" id="6153309">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6153325">}</span><br>
<span class="lineno"></span><span class="op" id="6153327">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6153330">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6153388">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6153453">var</span>&nbsp;<span class="ident" id="6153457">errClosed</span>&nbsp;<span class="op" id="6153467">=</span>&nbsp;<span class="ident" id="6153469">errors</span><span class="op" id="6153475">.</span><span class="ident" id="6153476">New</span><span class="op" id="6153479">(</span><span class="string" id="6153480">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6153516">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6153519">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6153589">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6153663">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6153732">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6153807">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6153882">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6153916">//</span><br>
<span class="lineno"></span><span class="comment" id="6153919">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6153994">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6154022">type</span>&nbsp;<span class="ident" id="6154027">ServerConn</span>&nbsp;<span class="keyword" id="6154038">struct</span>&nbsp;<span class="op" id="6154045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154048">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6154064">sync</span><span class="op" id="6154068">.</span><span class="ident" id="6154069">Mutex</span>&nbsp;<span class="comment" id="6154075">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154120">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6154136">net</span><span class="op" id="6154139">.</span><span class="ident" id="6154140">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154146">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6154162">*</span><span class="ident" id="6154163">bufio</span><span class="op" id="6154168">.</span><span class="ident" id="6154169">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154177">re</span><span class="op" id="6154179">,</span>&nbsp;<span class="ident" id="6154181">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6154193">error</span>&nbsp;<span class="comment" id="6154199">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154221">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6154237">io</span><span class="op" id="6154239">.</span><span class="ident" id="6154240">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154252">nread</span><span class="op" id="6154257">,</span>&nbsp;<span class="ident" id="6154259">nwritten</span>&nbsp;<span class="builtintype" id="6154268">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154273">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6154289">map</span><span class="op" id="6154292">[</span><span class="op" id="6154293">*</span><span class="ident" id="6154294">http</span><span class="op" id="6154298">.</span><span class="ident" id="6154299">Request</span><span class="op" id="6154306">]</span><span class="builtintype" id="6154307">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154314">pipe</span>&nbsp;<span class="ident" id="6154319">textproto</span><span class="op" id="6154328">.</span><span class="ident" id="6154329">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6154338">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6154341">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6154418">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6154466">//</span><br>
<span class="lineno"></span><span class="comment" id="6154469">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6154544">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6154572">func</span>&nbsp;<span class="ident" id="6154577">NewServerConn</span><span class="op" id="6154590">(</span><span class="ident" id="6154591">c</span>&nbsp;<span class="ident" id="6154593">net</span><span class="op" id="6154596">.</span><span class="ident" id="6154597">Conn</span><span class="op" id="6154601">,</span>&nbsp;<span class="ident" id="6154603">r</span>&nbsp;<span class="op" id="6154605">*</span><span class="ident" id="6154606">bufio</span><span class="op" id="6154611">.</span><span class="ident" id="6154612">Reader</span><span class="op" id="6154618">)</span>&nbsp;<span class="op" id="6154620">*</span><span class="ident" id="6154621">ServerConn</span>&nbsp;<span class="op" id="6154632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6154635">if</span>&nbsp;<span class="ident" id="6154638">r</span>&nbsp;<span class="op" id="6154640">==</span>&nbsp;<span class="ident" id="6154643">nil</span>&nbsp;<span class="op" id="6154647">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6154651">r</span>&nbsp;<span class="op" id="6154653">=</span>&nbsp;<span class="ident" id="6154655">bufio</span><span class="op" id="6154660">.</span><span class="ident" id="6154661">NewReader</span><span class="op" id="6154670">(</span><span class="ident" id="6154671">c</span><span class="op" id="6154672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6154675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6154678">return</span>&nbsp;<span class="op" id="6154685">&amp;</span><span class="ident" id="6154686">ServerConn</span><span class="op" id="6154696">{</span><span class="ident" id="6154697">c</span><span class="op" id="6154698">:</span>&nbsp;<span class="ident" id="6154700">c</span><span class="op" id="6154701">,</span>&nbsp;<span class="ident" id="6154703">r</span><span class="op" id="6154704">:</span>&nbsp;<span class="ident" id="6154706">r</span><span class="op" id="6154707">,</span>&nbsp;<span class="ident" id="6154709">pipereq</span><span class="op" id="6154716">:</span>&nbsp;<span class="builtinfunc" id="6154718">make</span><span class="op" id="6154722">(</span><span class="keyword" id="6154723">map</span><span class="op" id="6154726">[</span><span class="op" id="6154727">*</span><span class="ident" id="6154728">http</span><span class="op" id="6154732">.</span><span class="ident" id="6154733">Request</span><span class="op" id="6154740">]</span><span class="builtintype" id="6154741">uint</span><span class="op" id="6154745">)</span><span class="op" id="6154746">}</span><br>
<span class="lineno"></span><span class="op" id="6154748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6154751">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6154831">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6154907">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6154984">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6155046">func</span>&nbsp;<span class="op" id="6155051">(</span><span class="ident" id="6155052">sc</span>&nbsp;<span class="op" id="6155055">*</span><span class="ident" id="6155056">ServerConn</span><span class="op" id="6155066">)</span>&nbsp;<span class="ident" id="6155068">Hijack</span><span class="op" id="6155074">(</span><span class="op" id="6155075">)</span>&nbsp;<span class="op" id="6155077">(</span><span class="ident" id="6155078">c</span>&nbsp;<span class="ident" id="6155080">net</span><span class="op" id="6155083">.</span><span class="ident" id="6155084">Conn</span><span class="op" id="6155088">,</span>&nbsp;<span class="ident" id="6155090">r</span>&nbsp;<span class="op" id="6155092">*</span><span class="ident" id="6155093">bufio</span><span class="op" id="6155098">.</span><span class="ident" id="6155099">Reader</span><span class="op" id="6155105">)</span>&nbsp;<span class="op" id="6155107">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155110">sc</span><span class="op" id="6155112">.</span><span class="ident" id="6155113">lk</span><span class="op" id="6155115">.</span><span class="ident" id="6155116">Lock</span><span class="op" id="6155120">(</span><span class="op" id="6155121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155124">defer</span>&nbsp;<span class="ident" id="6155130">sc</span><span class="op" id="6155132">.</span><span class="ident" id="6155133">lk</span><span class="op" id="6155135">.</span><span class="ident" id="6155136">Unlock</span><span class="op" id="6155142">(</span><span class="op" id="6155143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155146">c</span>&nbsp;<span class="op" id="6155148">=</span>&nbsp;<span class="ident" id="6155150">sc</span><span class="op" id="6155152">.</span><span class="ident" id="6155153">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155156">r</span>&nbsp;<span class="op" id="6155158">=</span>&nbsp;<span class="ident" id="6155160">sc</span><span class="op" id="6155162">.</span><span class="ident" id="6155163">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155166">sc</span><span class="op" id="6155168">.</span><span class="ident" id="6155169">c</span>&nbsp;<span class="op" id="6155171">=</span>&nbsp;<span class="ident" id="6155173">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155178">sc</span><span class="op" id="6155180">.</span><span class="ident" id="6155181">r</span>&nbsp;<span class="op" id="6155183">=</span>&nbsp;<span class="ident" id="6155185">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155190">return</span><br>
<span class="lineno"></span><span class="op" id="6155197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6155200">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6155269">func</span>&nbsp;<span class="op" id="6155274">(</span><span class="ident" id="6155275">sc</span>&nbsp;<span class="op" id="6155278">*</span><span class="ident" id="6155279">ServerConn</span><span class="op" id="6155289">)</span>&nbsp;<span class="ident" id="6155291">Close</span><span class="op" id="6155296">(</span><span class="op" id="6155297">)</span>&nbsp;<span class="builtintype" id="6155299">error</span>&nbsp;<span class="op" id="6155305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155308">c</span><span class="op" id="6155309">,</span>&nbsp;<span class="ident" id="6155311">_</span>&nbsp;<span class="op" id="6155313">:=</span>&nbsp;<span class="ident" id="6155316">sc</span><span class="op" id="6155318">.</span><span class="ident" id="6155319">Hijack</span><span class="op" id="6155325">(</span><span class="op" id="6155326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155329">if</span>&nbsp;<span class="ident" id="6155332">c</span>&nbsp;<span class="op" id="6155334">!=</span>&nbsp;<span class="ident" id="6155337">nil</span>&nbsp;<span class="op" id="6155341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155345">return</span>&nbsp;<span class="ident" id="6155352">c</span><span class="op" id="6155353">.</span><span class="ident" id="6155354">Close</span><span class="op" id="6155359">(</span><span class="op" id="6155360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6155363">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155366">return</span>&nbsp;<span class="ident" id="6155373">nil</span><br>
<span class="lineno"></span><span class="op" id="6155377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6155380">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6155458">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6155537">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6155614">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6155639">func</span>&nbsp;<span class="op" id="6155644">(</span><span class="ident" id="6155645">sc</span>&nbsp;<span class="op" id="6155648">*</span><span class="ident" id="6155649">ServerConn</span><span class="op" id="6155659">)</span>&nbsp;<span class="ident" id="6155661">Read</span><span class="op" id="6155665">(</span><span class="op" id="6155666">)</span>&nbsp;<span class="op" id="6155668">(</span><span class="ident" id="6155669">req</span>&nbsp;<span class="op" id="6155673">*</span><span class="ident" id="6155674">http</span><span class="op" id="6155678">.</span><span class="ident" id="6155679">Request</span><span class="op" id="6155686">,</span>&nbsp;<span class="ident" id="6155688">err</span>&nbsp;<span class="builtintype" id="6155692">error</span><span class="op" id="6155697">)</span>&nbsp;<span class="op" id="6155699">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6155703">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155752">id</span>&nbsp;<span class="op" id="6155755">:=</span>&nbsp;<span class="ident" id="6155758">sc</span><span class="op" id="6155760">.</span><span class="ident" id="6155761">pipe</span><span class="op" id="6155765">.</span><span class="ident" id="6155766">Next</span><span class="op" id="6155770">(</span><span class="op" id="6155771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155774">sc</span><span class="op" id="6155776">.</span><span class="ident" id="6155777">pipe</span><span class="op" id="6155781">.</span><span class="ident" id="6155782">StartRequest</span><span class="op" id="6155794">(</span><span class="ident" id="6155795">id</span><span class="op" id="6155797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155800">defer</span>&nbsp;<span class="keyword" id="6155806">func</span><span class="op" id="6155810">(</span><span class="op" id="6155811">)</span>&nbsp;<span class="op" id="6155813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155817">sc</span><span class="op" id="6155819">.</span><span class="ident" id="6155820">pipe</span><span class="op" id="6155824">.</span><span class="ident" id="6155825">EndRequest</span><span class="op" id="6155835">(</span><span class="ident" id="6155836">id</span><span class="op" id="6155838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6155842">if</span>&nbsp;<span class="ident" id="6155845">req</span>&nbsp;<span class="op" id="6155849">==</span>&nbsp;<span class="ident" id="6155852">nil</span>&nbsp;<span class="op" id="6155856">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155861">sc</span><span class="op" id="6155863">.</span><span class="ident" id="6155864">pipe</span><span class="op" id="6155868">.</span><span class="ident" id="6155869">StartResponse</span><span class="op" id="6155882">(</span><span class="ident" id="6155883">id</span><span class="op" id="6155885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155890">sc</span><span class="op" id="6155892">.</span><span class="ident" id="6155893">pipe</span><span class="op" id="6155897">.</span><span class="ident" id="6155898">EndResponse</span><span class="op" id="6155909">(</span><span class="ident" id="6155910">id</span><span class="op" id="6155912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6155916">}</span>&nbsp;<span class="keyword" id="6155918">else</span>&nbsp;<span class="op" id="6155923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6155928">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155975">sc</span><span class="op" id="6155977">.</span><span class="ident" id="6155978">lk</span><span class="op" id="6155980">.</span><span class="ident" id="6155981">Lock</span><span class="op" id="6155985">(</span><span class="op" id="6155986">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6155991">sc</span><span class="op" id="6155993">.</span><span class="ident" id="6155994">pipereq</span><span class="op" id="6156001">[</span><span class="ident" id="6156002">req</span><span class="op" id="6156005">]</span>&nbsp;<span class="op" id="6156007">=</span>&nbsp;<span class="ident" id="6156009">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156015">sc</span><span class="op" id="6156017">.</span><span class="ident" id="6156018">lk</span><span class="op" id="6156020">.</span><span class="ident" id="6156021">Unlock</span><span class="op" id="6156027">(</span><span class="op" id="6156028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156035">}</span><span class="op" id="6156036">(</span><span class="op" id="6156037">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156041">sc</span><span class="op" id="6156043">.</span><span class="ident" id="6156044">lk</span><span class="op" id="6156046">.</span><span class="ident" id="6156047">Lock</span><span class="op" id="6156051">(</span><span class="op" id="6156052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156055">if</span>&nbsp;<span class="ident" id="6156058">sc</span><span class="op" id="6156060">.</span><span class="ident" id="6156061">we</span>&nbsp;<span class="op" id="6156064">!=</span>&nbsp;<span class="ident" id="6156067">nil</span>&nbsp;<span class="op" id="6156071">{</span>&nbsp;<span class="comment" id="6156073">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156128">defer</span>&nbsp;<span class="ident" id="6156134">sc</span><span class="op" id="6156136">.</span><span class="ident" id="6156137">lk</span><span class="op" id="6156139">.</span><span class="ident" id="6156140">Unlock</span><span class="op" id="6156146">(</span><span class="op" id="6156147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156151">return</span>&nbsp;<span class="ident" id="6156158">nil</span><span class="op" id="6156161">,</span>&nbsp;<span class="ident" id="6156163">sc</span><span class="op" id="6156165">.</span><span class="ident" id="6156166">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156170">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156173">if</span>&nbsp;<span class="ident" id="6156176">sc</span><span class="op" id="6156178">.</span><span class="ident" id="6156179">re</span>&nbsp;<span class="op" id="6156182">!=</span>&nbsp;<span class="ident" id="6156185">nil</span>&nbsp;<span class="op" id="6156189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156193">defer</span>&nbsp;<span class="ident" id="6156199">sc</span><span class="op" id="6156201">.</span><span class="ident" id="6156202">lk</span><span class="op" id="6156204">.</span><span class="ident" id="6156205">Unlock</span><span class="op" id="6156211">(</span><span class="op" id="6156212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156216">return</span>&nbsp;<span class="ident" id="6156223">nil</span><span class="op" id="6156226">,</span>&nbsp;<span class="ident" id="6156228">sc</span><span class="op" id="6156230">.</span><span class="ident" id="6156231">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156238">if</span>&nbsp;<span class="ident" id="6156241">sc</span><span class="op" id="6156243">.</span><span class="ident" id="6156244">r</span>&nbsp;<span class="op" id="6156246">==</span>&nbsp;<span class="ident" id="6156249">nil</span>&nbsp;<span class="op" id="6156253">{</span>&nbsp;<span class="comment" id="6156255">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156302">defer</span>&nbsp;<span class="ident" id="6156308">sc</span><span class="op" id="6156310">.</span><span class="ident" id="6156311">lk</span><span class="op" id="6156313">.</span><span class="ident" id="6156314">Unlock</span><span class="op" id="6156320">(</span><span class="op" id="6156321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156325">return</span>&nbsp;<span class="ident" id="6156332">nil</span><span class="op" id="6156335">,</span>&nbsp;<span class="ident" id="6156337">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156351">r</span>&nbsp;<span class="op" id="6156353">:=</span>&nbsp;<span class="ident" id="6156356">sc</span><span class="op" id="6156358">.</span><span class="ident" id="6156359">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156362">lastbody</span>&nbsp;<span class="op" id="6156371">:=</span>&nbsp;<span class="ident" id="6156374">sc</span><span class="op" id="6156376">.</span><span class="ident" id="6156377">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156387">sc</span><span class="op" id="6156389">.</span><span class="ident" id="6156390">lastbody</span>&nbsp;<span class="op" id="6156399">=</span>&nbsp;<span class="ident" id="6156401">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156406">sc</span><span class="op" id="6156408">.</span><span class="ident" id="6156409">lk</span><span class="op" id="6156411">.</span><span class="ident" id="6156412">Unlock</span><span class="op" id="6156418">(</span><span class="op" id="6156419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156423">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156499">if</span>&nbsp;<span class="ident" id="6156502">lastbody</span>&nbsp;<span class="op" id="6156511">!=</span>&nbsp;<span class="ident" id="6156514">nil</span>&nbsp;<span class="op" id="6156518">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156522">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156588">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156646">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156661">err</span>&nbsp;<span class="op" id="6156665">=</span>&nbsp;<span class="ident" id="6156667">lastbody</span><span class="op" id="6156675">.</span><span class="ident" id="6156676">Close</span><span class="op" id="6156681">(</span><span class="op" id="6156682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156686">if</span>&nbsp;<span class="ident" id="6156689">err</span>&nbsp;<span class="op" id="6156693">!=</span>&nbsp;<span class="ident" id="6156696">nil</span>&nbsp;<span class="op" id="6156700">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156705">sc</span><span class="op" id="6156707">.</span><span class="ident" id="6156708">lk</span><span class="op" id="6156710">.</span><span class="ident" id="6156711">Lock</span><span class="op" id="6156715">(</span><span class="op" id="6156716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156721">defer</span>&nbsp;<span class="ident" id="6156727">sc</span><span class="op" id="6156729">.</span><span class="ident" id="6156730">lk</span><span class="op" id="6156732">.</span><span class="ident" id="6156733">Unlock</span><span class="op" id="6156739">(</span><span class="op" id="6156740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156745">sc</span><span class="op" id="6156747">.</span><span class="ident" id="6156748">re</span>&nbsp;<span class="op" id="6156751">=</span>&nbsp;<span class="ident" id="6156753">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156760">return</span>&nbsp;<span class="ident" id="6156767">nil</span><span class="op" id="6156770">,</span>&nbsp;<span class="ident" id="6156772">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156778">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6156781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156785">req</span><span class="op" id="6156788">,</span>&nbsp;<span class="ident" id="6156790">err</span>&nbsp;<span class="op" id="6156794">=</span>&nbsp;<span class="ident" id="6156796">http</span><span class="op" id="6156800">.</span><span class="ident" id="6156801">ReadRequest</span><span class="op" id="6156812">(</span><span class="ident" id="6156813">r</span><span class="op" id="6156814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6156817">sc</span><span class="op" id="6156819">.</span><span class="ident" id="6156820">lk</span><span class="op" id="6156822">.</span><span class="ident" id="6156823">Lock</span><span class="op" id="6156827">(</span><span class="op" id="6156828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156831">defer</span>&nbsp;<span class="ident" id="6156837">sc</span><span class="op" id="6156839">.</span><span class="ident" id="6156840">lk</span><span class="op" id="6156842">.</span><span class="ident" id="6156843">Unlock</span><span class="op" id="6156849">(</span><span class="op" id="6156850">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156853">if</span>&nbsp;<span class="ident" id="6156856">err</span>&nbsp;<span class="op" id="6156860">!=</span>&nbsp;<span class="ident" id="6156863">nil</span>&nbsp;<span class="op" id="6156867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6156871">if</span>&nbsp;<span class="ident" id="6156874">err</span>&nbsp;<span class="op" id="6156878">==</span>&nbsp;<span class="ident" id="6156881">io</span><span class="op" id="6156883">.</span><span class="ident" id="6156884">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6156901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156906">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6156961">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6157019">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157048">sc</span><span class="op" id="6157050">.</span><span class="ident" id="6157051">re</span>&nbsp;<span class="op" id="6157054">=</span>&nbsp;<span class="ident" id="6157056">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157073">return</span>&nbsp;<span class="ident" id="6157080">nil</span><span class="op" id="6157083">,</span>&nbsp;<span class="ident" id="6157085">sc</span><span class="op" id="6157087">.</span><span class="ident" id="6157088">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6157093">}</span>&nbsp;<span class="keyword" id="6157095">else</span>&nbsp;<span class="op" id="6157100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157105">sc</span><span class="op" id="6157107">.</span><span class="ident" id="6157108">re</span>&nbsp;<span class="op" id="6157111">=</span>&nbsp;<span class="ident" id="6157113">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157120">return</span>&nbsp;<span class="ident" id="6157127">req</span><span class="op" id="6157130">,</span>&nbsp;<span class="ident" id="6157132">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6157138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6157141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157144">sc</span><span class="op" id="6157146">.</span><span class="ident" id="6157147">lastbody</span>&nbsp;<span class="op" id="6157156">=</span>&nbsp;<span class="ident" id="6157158">req</span><span class="op" id="6157161">.</span><span class="ident" id="6157162">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157168">sc</span><span class="op" id="6157170">.</span><span class="ident" id="6157171">nread</span><span class="op" id="6157176">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157180">if</span>&nbsp;<span class="ident" id="6157183">req</span><span class="op" id="6157186">.</span><span class="ident" id="6157187">Close</span>&nbsp;<span class="op" id="6157193">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157197">sc</span><span class="op" id="6157199">.</span><span class="ident" id="6157200">re</span>&nbsp;<span class="op" id="6157203">=</span>&nbsp;<span class="ident" id="6157205">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157221">return</span>&nbsp;<span class="ident" id="6157228">req</span><span class="op" id="6157231">,</span>&nbsp;<span class="ident" id="6157233">sc</span><span class="op" id="6157235">.</span><span class="ident" id="6157236">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6157240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157243">return</span>&nbsp;<span class="ident" id="6157250">req</span><span class="op" id="6157253">,</span>&nbsp;<span class="ident" id="6157255">err</span><br>
<span class="lineno"></span><span class="op" id="6157259">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6157262">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6157315">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6157361">func</span>&nbsp;<span class="op" id="6157366">(</span><span class="ident" id="6157367">sc</span>&nbsp;<span class="op" id="6157370">*</span><span class="ident" id="6157371">ServerConn</span><span class="op" id="6157381">)</span>&nbsp;<span class="ident" id="6157383">Pending</span><span class="op" id="6157390">(</span><span class="op" id="6157391">)</span>&nbsp;<span class="builtintype" id="6157393">int</span>&nbsp;<span class="op" id="6157397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157400">sc</span><span class="op" id="6157402">.</span><span class="ident" id="6157403">lk</span><span class="op" id="6157405">.</span><span class="ident" id="6157406">Lock</span><span class="op" id="6157410">(</span><span class="op" id="6157411">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157414">defer</span>&nbsp;<span class="ident" id="6157420">sc</span><span class="op" id="6157422">.</span><span class="ident" id="6157423">lk</span><span class="op" id="6157425">.</span><span class="ident" id="6157426">Unlock</span><span class="op" id="6157432">(</span><span class="op" id="6157433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157436">return</span>&nbsp;<span class="ident" id="6157443">sc</span><span class="op" id="6157445">.</span><span class="ident" id="6157446">nread</span>&nbsp;<span class="op" id="6157452">-</span>&nbsp;<span class="ident" id="6157454">sc</span><span class="op" id="6157456">.</span><span class="ident" id="6157457">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6157466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6157469">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6157554">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6157632">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6157708">func</span>&nbsp;<span class="op" id="6157713">(</span><span class="ident" id="6157714">sc</span>&nbsp;<span class="op" id="6157717">*</span><span class="ident" id="6157718">ServerConn</span><span class="op" id="6157728">)</span>&nbsp;<span class="ident" id="6157730">Write</span><span class="op" id="6157735">(</span><span class="ident" id="6157736">req</span>&nbsp;<span class="op" id="6157740">*</span><span class="ident" id="6157741">http</span><span class="op" id="6157745">.</span><span class="ident" id="6157746">Request</span><span class="op" id="6157753">,</span>&nbsp;<span class="ident" id="6157755">resp</span>&nbsp;<span class="op" id="6157760">*</span><span class="ident" id="6157761">http</span><span class="op" id="6157765">.</span><span class="ident" id="6157766">Response</span><span class="op" id="6157774">)</span>&nbsp;<span class="builtintype" id="6157776">error</span>&nbsp;<span class="op" id="6157782">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6157786">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157845">sc</span><span class="op" id="6157847">.</span><span class="ident" id="6157848">lk</span><span class="op" id="6157850">.</span><span class="ident" id="6157851">Lock</span><span class="op" id="6157855">(</span><span class="op" id="6157856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157859">id</span><span class="op" id="6157861">,</span>&nbsp;<span class="ident" id="6157863">ok</span>&nbsp;<span class="op" id="6157866">:=</span>&nbsp;<span class="ident" id="6157869">sc</span><span class="op" id="6157871">.</span><span class="ident" id="6157872">pipereq</span><span class="op" id="6157879">[</span><span class="ident" id="6157880">req</span><span class="op" id="6157883">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6157886">delete</span><span class="op" id="6157892">(</span><span class="ident" id="6157893">sc</span><span class="op" id="6157895">.</span><span class="ident" id="6157896">pipereq</span><span class="op" id="6157903">,</span>&nbsp;<span class="ident" id="6157905">req</span><span class="op" id="6157908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157911">if</span>&nbsp;<span class="op" id="6157914">!</span><span class="ident" id="6157915">ok</span>&nbsp;<span class="op" id="6157918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157922">sc</span><span class="op" id="6157924">.</span><span class="ident" id="6157925">lk</span><span class="op" id="6157927">.</span><span class="ident" id="6157928">Unlock</span><span class="op" id="6157934">(</span><span class="op" id="6157935">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6157939">return</span>&nbsp;<span class="ident" id="6157946">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6157959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6157962">sc</span><span class="op" id="6157964">.</span><span class="ident" id="6157965">lk</span><span class="op" id="6157967">.</span><span class="ident" id="6157968">Unlock</span><span class="op" id="6157974">(</span><span class="op" id="6157975">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6157979">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158005">sc</span><span class="op" id="6158007">.</span><span class="ident" id="6158008">pipe</span><span class="op" id="6158012">.</span><span class="ident" id="6158013">StartResponse</span><span class="op" id="6158026">(</span><span class="ident" id="6158027">id</span><span class="op" id="6158029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158032">defer</span>&nbsp;<span class="ident" id="6158038">sc</span><span class="op" id="6158040">.</span><span class="ident" id="6158041">pipe</span><span class="op" id="6158045">.</span><span class="ident" id="6158046">EndResponse</span><span class="op" id="6158057">(</span><span class="ident" id="6158058">id</span><span class="op" id="6158060">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158064">sc</span><span class="op" id="6158066">.</span><span class="ident" id="6158067">lk</span><span class="op" id="6158069">.</span><span class="ident" id="6158070">Lock</span><span class="op" id="6158074">(</span><span class="op" id="6158075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158078">if</span>&nbsp;<span class="ident" id="6158081">sc</span><span class="op" id="6158083">.</span><span class="ident" id="6158084">we</span>&nbsp;<span class="op" id="6158087">!=</span>&nbsp;<span class="ident" id="6158090">nil</span>&nbsp;<span class="op" id="6158094">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158098">defer</span>&nbsp;<span class="ident" id="6158104">sc</span><span class="op" id="6158106">.</span><span class="ident" id="6158107">lk</span><span class="op" id="6158109">.</span><span class="ident" id="6158110">Unlock</span><span class="op" id="6158116">(</span><span class="op" id="6158117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158121">return</span>&nbsp;<span class="ident" id="6158128">sc</span><span class="op" id="6158130">.</span><span class="ident" id="6158131">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6158135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158138">if</span>&nbsp;<span class="ident" id="6158141">sc</span><span class="op" id="6158143">.</span><span class="ident" id="6158144">c</span>&nbsp;<span class="op" id="6158146">==</span>&nbsp;<span class="ident" id="6158149">nil</span>&nbsp;<span class="op" id="6158153">{</span>&nbsp;<span class="comment" id="6158155">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158202">defer</span>&nbsp;<span class="ident" id="6158208">sc</span><span class="op" id="6158210">.</span><span class="ident" id="6158211">lk</span><span class="op" id="6158213">.</span><span class="ident" id="6158214">Unlock</span><span class="op" id="6158220">(</span><span class="op" id="6158221">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158225">return</span>&nbsp;<span class="ident" id="6158232">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6158243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158246">c</span>&nbsp;<span class="op" id="6158248">:=</span>&nbsp;<span class="ident" id="6158251">sc</span><span class="op" id="6158253">.</span><span class="ident" id="6158254">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158257">if</span>&nbsp;<span class="ident" id="6158260">sc</span><span class="op" id="6158262">.</span><span class="ident" id="6158263">nread</span>&nbsp;<span class="op" id="6158269">&lt;=</span>&nbsp;<span class="ident" id="6158272">sc</span><span class="op" id="6158274">.</span><span class="ident" id="6158275">nwritten</span>&nbsp;<span class="op" id="6158284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158288">defer</span>&nbsp;<span class="ident" id="6158294">sc</span><span class="op" id="6158296">.</span><span class="ident" id="6158297">lk</span><span class="op" id="6158299">.</span><span class="ident" id="6158300">Unlock</span><span class="op" id="6158306">(</span><span class="op" id="6158307">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158311">return</span>&nbsp;<span class="ident" id="6158318">errors</span><span class="op" id="6158324">.</span><span class="ident" id="6158325">New</span><span class="op" id="6158328">(</span><span class="string" id="6158329">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6158356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6158359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158362">if</span>&nbsp;<span class="ident" id="6158365">resp</span><span class="op" id="6158369">.</span><span class="ident" id="6158370">Close</span>&nbsp;<span class="op" id="6158376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6158380">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6158442">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6158505">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158528">sc</span><span class="op" id="6158530">.</span><span class="ident" id="6158531">re</span>&nbsp;<span class="op" id="6158534">=</span>&nbsp;<span class="ident" id="6158536">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6158551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158554">sc</span><span class="op" id="6158556">.</span><span class="ident" id="6158557">lk</span><span class="op" id="6158559">.</span><span class="ident" id="6158560">Unlock</span><span class="op" id="6158566">(</span><span class="op" id="6158567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158571">err</span>&nbsp;<span class="op" id="6158575">:=</span>&nbsp;<span class="ident" id="6158578">resp</span><span class="op" id="6158582">.</span><span class="ident" id="6158583">Write</span><span class="op" id="6158588">(</span><span class="ident" id="6158589">c</span><span class="op" id="6158590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158593">sc</span><span class="op" id="6158595">.</span><span class="ident" id="6158596">lk</span><span class="op" id="6158598">.</span><span class="ident" id="6158599">Lock</span><span class="op" id="6158603">(</span><span class="op" id="6158604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158607">defer</span>&nbsp;<span class="ident" id="6158613">sc</span><span class="op" id="6158615">.</span><span class="ident" id="6158616">lk</span><span class="op" id="6158618">.</span><span class="ident" id="6158619">Unlock</span><span class="op" id="6158625">(</span><span class="op" id="6158626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158629">if</span>&nbsp;<span class="ident" id="6158632">err</span>&nbsp;<span class="op" id="6158636">!=</span>&nbsp;<span class="ident" id="6158639">nil</span>&nbsp;<span class="op" id="6158643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158647">sc</span><span class="op" id="6158649">.</span><span class="ident" id="6158650">we</span>&nbsp;<span class="op" id="6158653">=</span>&nbsp;<span class="ident" id="6158655">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158661">return</span>&nbsp;<span class="ident" id="6158668">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6158673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6158676">sc</span><span class="op" id="6158678">.</span><span class="ident" id="6158679">nwritten</span><span class="op" id="6158687">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6158692">return</span>&nbsp;<span class="ident" id="6158699">nil</span><br>
<span class="lineno">220</span><span class="op" id="6158703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6158706">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6158776">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6158845">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6158900">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6158974">//</span><br>
<span class="lineno"></span><span class="comment" id="6158977">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6159045">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6159093">type</span>&nbsp;<span class="ident" id="6159098">ClientConn</span>&nbsp;<span class="keyword" id="6159109">struct</span>&nbsp;<span class="op" id="6159116">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159119">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159135">sync</span><span class="op" id="6159139">.</span><span class="ident" id="6159140">Mutex</span>&nbsp;<span class="comment" id="6159146">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159191">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159207">net</span><span class="op" id="6159210">.</span><span class="ident" id="6159211">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159217">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6159233">*</span><span class="ident" id="6159234">bufio</span><span class="op" id="6159239">.</span><span class="ident" id="6159240">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159248">re</span><span class="op" id="6159250">,</span>&nbsp;<span class="ident" id="6159252">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6159264">error</span>&nbsp;<span class="comment" id="6159270">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159292">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159308">io</span><span class="op" id="6159310">.</span><span class="ident" id="6159311">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159323">nread</span><span class="op" id="6159328">,</span>&nbsp;<span class="ident" id="6159330">nwritten</span>&nbsp;<span class="builtintype" id="6159339">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159344">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6159360">map</span><span class="op" id="6159363">[</span><span class="op" id="6159364">*</span><span class="ident" id="6159365">http</span><span class="op" id="6159369">.</span><span class="ident" id="6159370">Request</span><span class="op" id="6159377">]</span><span class="builtintype" id="6159378">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159385">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159394">textproto</span><span class="op" id="6159403">.</span><span class="ident" id="6159404">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159414">writeReq</span>&nbsp;<span class="keyword" id="6159423">func</span><span class="op" id="6159427">(</span><span class="op" id="6159428">*</span><span class="ident" id="6159429">http</span><span class="op" id="6159433">.</span><span class="ident" id="6159434">Request</span><span class="op" id="6159441">,</span>&nbsp;<span class="ident" id="6159443">io</span><span class="op" id="6159445">.</span><span class="ident" id="6159446">Writer</span><span class="op" id="6159452">)</span>&nbsp;<span class="builtintype" id="6159454">error</span><br>
<span class="lineno">240</span><span class="op" id="6159460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6159463">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6159541">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6159589">//</span><br>
<span class="lineno">245</span><span class="comment" id="6159592">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6159662">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6159700">func</span>&nbsp;<span class="ident" id="6159705">NewClientConn</span><span class="op" id="6159718">(</span><span class="ident" id="6159719">c</span>&nbsp;<span class="ident" id="6159721">net</span><span class="op" id="6159724">.</span><span class="ident" id="6159725">Conn</span><span class="op" id="6159729">,</span>&nbsp;<span class="ident" id="6159731">r</span>&nbsp;<span class="op" id="6159733">*</span><span class="ident" id="6159734">bufio</span><span class="op" id="6159739">.</span><span class="ident" id="6159740">Reader</span><span class="op" id="6159746">)</span>&nbsp;<span class="op" id="6159748">*</span><span class="ident" id="6159749">ClientConn</span>&nbsp;<span class="op" id="6159760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6159763">if</span>&nbsp;<span class="ident" id="6159766">r</span>&nbsp;<span class="op" id="6159768">==</span>&nbsp;<span class="ident" id="6159771">nil</span>&nbsp;<span class="op" id="6159775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159779">r</span>&nbsp;<span class="op" id="6159781">=</span>&nbsp;<span class="ident" id="6159783">bufio</span><span class="op" id="6159788">.</span><span class="ident" id="6159789">NewReader</span><span class="op" id="6159798">(</span><span class="ident" id="6159799">c</span><span class="op" id="6159800">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6159803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6159806">return</span>&nbsp;<span class="op" id="6159813">&amp;</span><span class="ident" id="6159814">ClientConn</span><span class="op" id="6159824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159828">c</span><span class="op" id="6159829">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159838">c</span><span class="op" id="6159839">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159843">r</span><span class="op" id="6159844">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6159853">r</span><span class="op" id="6159854">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159858">pipereq</span><span class="op" id="6159865">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6159868">make</span><span class="op" id="6159872">(</span><span class="keyword" id="6159873">map</span><span class="op" id="6159876">[</span><span class="op" id="6159877">*</span><span class="ident" id="6159878">http</span><span class="op" id="6159882">.</span><span class="ident" id="6159883">Request</span><span class="op" id="6159890">]</span><span class="builtintype" id="6159891">uint</span><span class="op" id="6159895">)</span><span class="op" id="6159896">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6159900">writeReq</span><span class="op" id="6159908">:</span>&nbsp;<span class="op" id="6159910">(</span><span class="op" id="6159911">*</span><span class="ident" id="6159912">http</span><span class="op" id="6159916">.</span><span class="ident" id="6159917">Request</span><span class="op" id="6159924">)</span><span class="op" id="6159925">.</span><span class="ident" id="6159926">Write</span><span class="op" id="6159931">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6159934">}</span><br>
<span class="lineno"></span><span class="op" id="6159936">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6159939">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6160006">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6160044">//</span><br>
<span class="lineno"></span><span class="comment" id="6160047">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6160108">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6160154">func</span>&nbsp;<span class="ident" id="6160159">NewProxyClientConn</span><span class="op" id="6160177">(</span><span class="ident" id="6160178">c</span>&nbsp;<span class="ident" id="6160180">net</span><span class="op" id="6160183">.</span><span class="ident" id="6160184">Conn</span><span class="op" id="6160188">,</span>&nbsp;<span class="ident" id="6160190">r</span>&nbsp;<span class="op" id="6160192">*</span><span class="ident" id="6160193">bufio</span><span class="op" id="6160198">.</span><span class="ident" id="6160199">Reader</span><span class="op" id="6160205">)</span>&nbsp;<span class="op" id="6160207">*</span><span class="ident" id="6160208">ClientConn</span>&nbsp;<span class="op" id="6160219">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160222">cc</span>&nbsp;<span class="op" id="6160225">:=</span>&nbsp;<span class="ident" id="6160228">NewClientConn</span><span class="op" id="6160241">(</span><span class="ident" id="6160242">c</span><span class="op" id="6160243">,</span>&nbsp;<span class="ident" id="6160245">r</span><span class="op" id="6160246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160249">cc</span><span class="op" id="6160251">.</span><span class="ident" id="6160252">writeReq</span>&nbsp;<span class="op" id="6160261">=</span>&nbsp;<span class="op" id="6160263">(</span><span class="op" id="6160264">*</span><span class="ident" id="6160265">http</span><span class="op" id="6160269">.</span><span class="ident" id="6160270">Request</span><span class="op" id="6160277">)</span><span class="op" id="6160278">.</span><span class="ident" id="6160279">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160291">return</span>&nbsp;<span class="ident" id="6160298">cc</span><br>
<span class="lineno"></span><span class="op" id="6160301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6160304">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6160384">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6160460">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6160534">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6160612">func</span>&nbsp;<span class="op" id="6160617">(</span><span class="ident" id="6160618">cc</span>&nbsp;<span class="op" id="6160621">*</span><span class="ident" id="6160622">ClientConn</span><span class="op" id="6160632">)</span>&nbsp;<span class="ident" id="6160634">Hijack</span><span class="op" id="6160640">(</span><span class="op" id="6160641">)</span>&nbsp;<span class="op" id="6160643">(</span><span class="ident" id="6160644">c</span>&nbsp;<span class="ident" id="6160646">net</span><span class="op" id="6160649">.</span><span class="ident" id="6160650">Conn</span><span class="op" id="6160654">,</span>&nbsp;<span class="ident" id="6160656">r</span>&nbsp;<span class="op" id="6160658">*</span><span class="ident" id="6160659">bufio</span><span class="op" id="6160664">.</span><span class="ident" id="6160665">Reader</span><span class="op" id="6160671">)</span>&nbsp;<span class="op" id="6160673">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160676">cc</span><span class="op" id="6160678">.</span><span class="ident" id="6160679">lk</span><span class="op" id="6160681">.</span><span class="ident" id="6160682">Lock</span><span class="op" id="6160686">(</span><span class="op" id="6160687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160690">defer</span>&nbsp;<span class="ident" id="6160696">cc</span><span class="op" id="6160698">.</span><span class="ident" id="6160699">lk</span><span class="op" id="6160701">.</span><span class="ident" id="6160702">Unlock</span><span class="op" id="6160708">(</span><span class="op" id="6160709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160712">c</span>&nbsp;<span class="op" id="6160714">=</span>&nbsp;<span class="ident" id="6160716">cc</span><span class="op" id="6160718">.</span><span class="ident" id="6160719">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160722">r</span>&nbsp;<span class="op" id="6160724">=</span>&nbsp;<span class="ident" id="6160726">cc</span><span class="op" id="6160728">.</span><span class="ident" id="6160729">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160732">cc</span><span class="op" id="6160734">.</span><span class="ident" id="6160735">c</span>&nbsp;<span class="op" id="6160737">=</span>&nbsp;<span class="ident" id="6160739">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160744">cc</span><span class="op" id="6160746">.</span><span class="ident" id="6160747">r</span>&nbsp;<span class="op" id="6160749">=</span>&nbsp;<span class="ident" id="6160751">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160756">return</span><br>
<span class="lineno"></span><span class="op" id="6160763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6160766">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6160835">func</span>&nbsp;<span class="op" id="6160840">(</span><span class="ident" id="6160841">cc</span>&nbsp;<span class="op" id="6160844">*</span><span class="ident" id="6160845">ClientConn</span><span class="op" id="6160855">)</span>&nbsp;<span class="ident" id="6160857">Close</span><span class="op" id="6160862">(</span><span class="op" id="6160863">)</span>&nbsp;<span class="builtintype" id="6160865">error</span>&nbsp;<span class="op" id="6160871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6160874">c</span><span class="op" id="6160875">,</span>&nbsp;<span class="ident" id="6160877">_</span>&nbsp;<span class="op" id="6160879">:=</span>&nbsp;<span class="ident" id="6160882">cc</span><span class="op" id="6160884">.</span><span class="ident" id="6160885">Hijack</span><span class="op" id="6160891">(</span><span class="op" id="6160892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160895">if</span>&nbsp;<span class="ident" id="6160898">c</span>&nbsp;<span class="op" id="6160900">!=</span>&nbsp;<span class="ident" id="6160903">nil</span>&nbsp;<span class="op" id="6160907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160911">return</span>&nbsp;<span class="ident" id="6160918">c</span><span class="op" id="6160919">.</span><span class="ident" id="6160920">Close</span><span class="op" id="6160925">(</span><span class="op" id="6160926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6160929">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6160932">return</span>&nbsp;<span class="ident" id="6160939">nil</span><br>
<span class="lineno"></span><span class="op" id="6160943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6160946">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6161026">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6161103">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6161183">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6161258">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6161335">func</span>&nbsp;<span class="op" id="6161340">(</span><span class="ident" id="6161341">cc</span>&nbsp;<span class="op" id="6161344">*</span><span class="ident" id="6161345">ClientConn</span><span class="op" id="6161355">)</span>&nbsp;<span class="ident" id="6161357">Write</span><span class="op" id="6161362">(</span><span class="ident" id="6161363">req</span>&nbsp;<span class="op" id="6161367">*</span><span class="ident" id="6161368">http</span><span class="op" id="6161372">.</span><span class="ident" id="6161373">Request</span><span class="op" id="6161380">)</span>&nbsp;<span class="op" id="6161382">(</span><span class="ident" id="6161383">err</span>&nbsp;<span class="builtintype" id="6161387">error</span><span class="op" id="6161392">)</span>&nbsp;<span class="op" id="6161394">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6161398">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161437">id</span>&nbsp;<span class="op" id="6161440">:=</span>&nbsp;<span class="ident" id="6161443">cc</span><span class="op" id="6161445">.</span><span class="ident" id="6161446">pipe</span><span class="op" id="6161450">.</span><span class="ident" id="6161451">Next</span><span class="op" id="6161455">(</span><span class="op" id="6161456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161459">cc</span><span class="op" id="6161461">.</span><span class="ident" id="6161462">pipe</span><span class="op" id="6161466">.</span><span class="ident" id="6161467">StartRequest</span><span class="op" id="6161479">(</span><span class="ident" id="6161480">id</span><span class="op" id="6161482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161485">defer</span>&nbsp;<span class="keyword" id="6161491">func</span><span class="op" id="6161495">(</span><span class="op" id="6161496">)</span>&nbsp;<span class="op" id="6161498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161502">cc</span><span class="op" id="6161504">.</span><span class="ident" id="6161505">pipe</span><span class="op" id="6161509">.</span><span class="ident" id="6161510">EndRequest</span><span class="op" id="6161520">(</span><span class="ident" id="6161521">id</span><span class="op" id="6161523">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161527">if</span>&nbsp;<span class="ident" id="6161530">err</span>&nbsp;<span class="op" id="6161534">!=</span>&nbsp;<span class="ident" id="6161537">nil</span>&nbsp;<span class="op" id="6161541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161546">cc</span><span class="op" id="6161548">.</span><span class="ident" id="6161549">pipe</span><span class="op" id="6161553">.</span><span class="ident" id="6161554">StartResponse</span><span class="op" id="6161567">(</span><span class="ident" id="6161568">id</span><span class="op" id="6161570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161575">cc</span><span class="op" id="6161577">.</span><span class="ident" id="6161578">pipe</span><span class="op" id="6161582">.</span><span class="ident" id="6161583">EndResponse</span><span class="op" id="6161594">(</span><span class="ident" id="6161595">id</span><span class="op" id="6161597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6161601">}</span>&nbsp;<span class="keyword" id="6161603">else</span>&nbsp;<span class="op" id="6161608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6161613">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161660">cc</span><span class="op" id="6161662">.</span><span class="ident" id="6161663">lk</span><span class="op" id="6161665">.</span><span class="ident" id="6161666">Lock</span><span class="op" id="6161670">(</span><span class="op" id="6161671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161676">cc</span><span class="op" id="6161678">.</span><span class="ident" id="6161679">pipereq</span><span class="op" id="6161686">[</span><span class="ident" id="6161687">req</span><span class="op" id="6161690">]</span>&nbsp;<span class="op" id="6161692">=</span>&nbsp;<span class="ident" id="6161694">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161700">cc</span><span class="op" id="6161702">.</span><span class="ident" id="6161703">lk</span><span class="op" id="6161705">.</span><span class="ident" id="6161706">Unlock</span><span class="op" id="6161712">(</span><span class="op" id="6161713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6161717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6161720">}</span><span class="op" id="6161721">(</span><span class="op" id="6161722">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6161726">cc</span><span class="op" id="6161728">.</span><span class="ident" id="6161729">lk</span><span class="op" id="6161731">.</span><span class="ident" id="6161732">Lock</span><span class="op" id="6161736">(</span><span class="op" id="6161737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161740">if</span>&nbsp;<span class="ident" id="6161743">cc</span><span class="op" id="6161745">.</span><span class="ident" id="6161746">re</span>&nbsp;<span class="op" id="6161749">!=</span>&nbsp;<span class="ident" id="6161752">nil</span>&nbsp;<span class="op" id="6161756">{</span>&nbsp;<span class="comment" id="6161758">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161810">defer</span>&nbsp;<span class="ident" id="6161816">cc</span><span class="op" id="6161818">.</span><span class="ident" id="6161819">lk</span><span class="op" id="6161821">.</span><span class="ident" id="6161822">Unlock</span><span class="op" id="6161828">(</span><span class="op" id="6161829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161833">return</span>&nbsp;<span class="ident" id="6161840">cc</span><span class="op" id="6161842">.</span><span class="ident" id="6161843">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6161847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161850">if</span>&nbsp;<span class="ident" id="6161853">cc</span><span class="op" id="6161855">.</span><span class="ident" id="6161856">we</span>&nbsp;<span class="op" id="6161859">!=</span>&nbsp;<span class="ident" id="6161862">nil</span>&nbsp;<span class="op" id="6161866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161870">defer</span>&nbsp;<span class="ident" id="6161876">cc</span><span class="op" id="6161878">.</span><span class="ident" id="6161879">lk</span><span class="op" id="6161881">.</span><span class="ident" id="6161882">Unlock</span><span class="op" id="6161888">(</span><span class="op" id="6161889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161893">return</span>&nbsp;<span class="ident" id="6161900">cc</span><span class="op" id="6161902">.</span><span class="ident" id="6161903">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6161907">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161910">if</span>&nbsp;<span class="ident" id="6161913">cc</span><span class="op" id="6161915">.</span><span class="ident" id="6161916">c</span>&nbsp;<span class="op" id="6161918">==</span>&nbsp;<span class="ident" id="6161921">nil</span>&nbsp;<span class="op" id="6161925">{</span>&nbsp;<span class="comment" id="6161927">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161974">defer</span>&nbsp;<span class="ident" id="6161980">cc</span><span class="op" id="6161982">.</span><span class="ident" id="6161983">lk</span><span class="op" id="6161985">.</span><span class="ident" id="6161986">Unlock</span><span class="op" id="6161992">(</span><span class="op" id="6161993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6161997">return</span>&nbsp;<span class="ident" id="6162004">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6162015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162018">c</span>&nbsp;<span class="op" id="6162020">:=</span>&nbsp;<span class="ident" id="6162023">cc</span><span class="op" id="6162025">.</span><span class="ident" id="6162026">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162029">if</span>&nbsp;<span class="ident" id="6162032">req</span><span class="op" id="6162035">.</span><span class="ident" id="6162036">Close</span>&nbsp;<span class="op" id="6162042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6162046">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6162107">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162148">cc</span><span class="op" id="6162150">.</span><span class="ident" id="6162151">we</span>&nbsp;<span class="op" id="6162154">=</span>&nbsp;<span class="ident" id="6162156">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6162171">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162174">cc</span><span class="op" id="6162176">.</span><span class="ident" id="6162177">lk</span><span class="op" id="6162179">.</span><span class="ident" id="6162180">Unlock</span><span class="op" id="6162186">(</span><span class="op" id="6162187">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162191">err</span>&nbsp;<span class="op" id="6162195">=</span>&nbsp;<span class="ident" id="6162197">cc</span><span class="op" id="6162199">.</span><span class="ident" id="6162200">writeReq</span><span class="op" id="6162208">(</span><span class="ident" id="6162209">req</span><span class="op" id="6162212">,</span>&nbsp;<span class="ident" id="6162214">c</span><span class="op" id="6162215">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162218">cc</span><span class="op" id="6162220">.</span><span class="ident" id="6162221">lk</span><span class="op" id="6162223">.</span><span class="ident" id="6162224">Lock</span><span class="op" id="6162228">(</span><span class="op" id="6162229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162232">defer</span>&nbsp;<span class="ident" id="6162238">cc</span><span class="op" id="6162240">.</span><span class="ident" id="6162241">lk</span><span class="op" id="6162243">.</span><span class="ident" id="6162244">Unlock</span><span class="op" id="6162250">(</span><span class="op" id="6162251">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162254">if</span>&nbsp;<span class="ident" id="6162257">err</span>&nbsp;<span class="op" id="6162261">!=</span>&nbsp;<span class="ident" id="6162264">nil</span>&nbsp;<span class="op" id="6162268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162272">cc</span><span class="op" id="6162274">.</span><span class="ident" id="6162275">we</span>&nbsp;<span class="op" id="6162278">=</span>&nbsp;<span class="ident" id="6162280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162286">return</span>&nbsp;<span class="ident" id="6162293">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6162298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162301">cc</span><span class="op" id="6162303">.</span><span class="ident" id="6162304">nwritten</span><span class="op" id="6162312">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162317">return</span>&nbsp;<span class="ident" id="6162324">nil</span><br>
<span class="lineno"></span><span class="op" id="6162328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6162331">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6162384">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6162426">func</span>&nbsp;<span class="op" id="6162431">(</span><span class="ident" id="6162432">cc</span>&nbsp;<span class="op" id="6162435">*</span><span class="ident" id="6162436">ClientConn</span><span class="op" id="6162446">)</span>&nbsp;<span class="ident" id="6162448">Pending</span><span class="op" id="6162455">(</span><span class="op" id="6162456">)</span>&nbsp;<span class="builtintype" id="6162458">int</span>&nbsp;<span class="op" id="6162462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162465">cc</span><span class="op" id="6162467">.</span><span class="ident" id="6162468">lk</span><span class="op" id="6162470">.</span><span class="ident" id="6162471">Lock</span><span class="op" id="6162475">(</span><span class="op" id="6162476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162479">defer</span>&nbsp;<span class="ident" id="6162485">cc</span><span class="op" id="6162487">.</span><span class="ident" id="6162488">lk</span><span class="op" id="6162490">.</span><span class="ident" id="6162491">Unlock</span><span class="op" id="6162497">(</span><span class="op" id="6162498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6162501">return</span>&nbsp;<span class="ident" id="6162508">cc</span><span class="op" id="6162510">.</span><span class="ident" id="6162511">nwritten</span>&nbsp;<span class="op" id="6162520">-</span>&nbsp;<span class="ident" id="6162522">cc</span><span class="op" id="6162524">.</span><span class="ident" id="6162525">nread</span><br>
<span class="lineno">355</span><span class="op" id="6162531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6162534">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6162607">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6162679">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6162751">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6162806">func</span>&nbsp;<span class="op" id="6162811">(</span><span class="ident" id="6162812">cc</span>&nbsp;<span class="op" id="6162815">*</span><span class="ident" id="6162816">ClientConn</span><span class="op" id="6162826">)</span>&nbsp;<span class="ident" id="6162828">Read</span><span class="op" id="6162832">(</span><span class="ident" id="6162833">req</span>&nbsp;<span class="op" id="6162837">*</span><span class="ident" id="6162838">http</span><span class="op" id="6162842">.</span><span class="ident" id="6162843">Request</span><span class="op" id="6162850">)</span>&nbsp;<span class="op" id="6162852">(</span><span class="ident" id="6162853">resp</span>&nbsp;<span class="op" id="6162858">*</span><span class="ident" id="6162859">http</span><span class="op" id="6162863">.</span><span class="ident" id="6162864">Response</span><span class="op" id="6162872">,</span>&nbsp;<span class="ident" id="6162874">err</span>&nbsp;<span class="builtintype" id="6162878">error</span><span class="op" id="6162883">)</span>&nbsp;<span class="op" id="6162885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6162888">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162947">cc</span><span class="op" id="6162949">.</span><span class="ident" id="6162950">lk</span><span class="op" id="6162952">.</span><span class="ident" id="6162953">Lock</span><span class="op" id="6162957">(</span><span class="op" id="6162958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6162961">id</span><span class="op" id="6162963">,</span>&nbsp;<span class="ident" id="6162965">ok</span>&nbsp;<span class="op" id="6162968">:=</span>&nbsp;<span class="ident" id="6162971">cc</span><span class="op" id="6162973">.</span><span class="ident" id="6162974">pipereq</span><span class="op" id="6162981">[</span><span class="ident" id="6162982">req</span><span class="op" id="6162985">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6162988">delete</span><span class="op" id="6162994">(</span><span class="ident" id="6162995">cc</span><span class="op" id="6162997">.</span><span class="ident" id="6162998">pipereq</span><span class="op" id="6163005">,</span>&nbsp;<span class="ident" id="6163007">req</span><span class="op" id="6163010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163013">if</span>&nbsp;<span class="op" id="6163016">!</span><span class="ident" id="6163017">ok</span>&nbsp;<span class="op" id="6163020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163024">cc</span><span class="op" id="6163026">.</span><span class="ident" id="6163027">lk</span><span class="op" id="6163029">.</span><span class="ident" id="6163030">Unlock</span><span class="op" id="6163036">(</span><span class="op" id="6163037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163041">return</span>&nbsp;<span class="ident" id="6163048">nil</span><span class="op" id="6163051">,</span>&nbsp;<span class="ident" id="6163053">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163066">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163069">cc</span><span class="op" id="6163071">.</span><span class="ident" id="6163072">lk</span><span class="op" id="6163074">.</span><span class="ident" id="6163075">Unlock</span><span class="op" id="6163081">(</span><span class="op" id="6163082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6163086">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163112">cc</span><span class="op" id="6163114">.</span><span class="ident" id="6163115">pipe</span><span class="op" id="6163119">.</span><span class="ident" id="6163120">StartResponse</span><span class="op" id="6163133">(</span><span class="ident" id="6163134">id</span><span class="op" id="6163136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163139">defer</span>&nbsp;<span class="ident" id="6163145">cc</span><span class="op" id="6163147">.</span><span class="ident" id="6163148">pipe</span><span class="op" id="6163152">.</span><span class="ident" id="6163153">EndResponse</span><span class="op" id="6163164">(</span><span class="ident" id="6163165">id</span><span class="op" id="6163167">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163171">cc</span><span class="op" id="6163173">.</span><span class="ident" id="6163174">lk</span><span class="op" id="6163176">.</span><span class="ident" id="6163177">Lock</span><span class="op" id="6163181">(</span><span class="op" id="6163182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163185">if</span>&nbsp;<span class="ident" id="6163188">cc</span><span class="op" id="6163190">.</span><span class="ident" id="6163191">re</span>&nbsp;<span class="op" id="6163194">!=</span>&nbsp;<span class="ident" id="6163197">nil</span>&nbsp;<span class="op" id="6163201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163205">defer</span>&nbsp;<span class="ident" id="6163211">cc</span><span class="op" id="6163213">.</span><span class="ident" id="6163214">lk</span><span class="op" id="6163216">.</span><span class="ident" id="6163217">Unlock</span><span class="op" id="6163223">(</span><span class="op" id="6163224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163228">return</span>&nbsp;<span class="ident" id="6163235">nil</span><span class="op" id="6163238">,</span>&nbsp;<span class="ident" id="6163240">cc</span><span class="op" id="6163242">.</span><span class="ident" id="6163243">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163250">if</span>&nbsp;<span class="ident" id="6163253">cc</span><span class="op" id="6163255">.</span><span class="ident" id="6163256">r</span>&nbsp;<span class="op" id="6163258">==</span>&nbsp;<span class="ident" id="6163261">nil</span>&nbsp;<span class="op" id="6163265">{</span>&nbsp;<span class="comment" id="6163267">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163314">defer</span>&nbsp;<span class="ident" id="6163320">cc</span><span class="op" id="6163322">.</span><span class="ident" id="6163323">lk</span><span class="op" id="6163325">.</span><span class="ident" id="6163326">Unlock</span><span class="op" id="6163332">(</span><span class="op" id="6163333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163337">return</span>&nbsp;<span class="ident" id="6163344">nil</span><span class="op" id="6163347">,</span>&nbsp;<span class="ident" id="6163349">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163360">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163363">r</span>&nbsp;<span class="op" id="6163365">:=</span>&nbsp;<span class="ident" id="6163368">cc</span><span class="op" id="6163370">.</span><span class="ident" id="6163371">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163374">lastbody</span>&nbsp;<span class="op" id="6163383">:=</span>&nbsp;<span class="ident" id="6163386">cc</span><span class="op" id="6163388">.</span><span class="ident" id="6163389">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163399">cc</span><span class="op" id="6163401">.</span><span class="ident" id="6163402">lastbody</span>&nbsp;<span class="op" id="6163411">=</span>&nbsp;<span class="ident" id="6163413">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163418">cc</span><span class="op" id="6163420">.</span><span class="ident" id="6163421">lk</span><span class="op" id="6163423">.</span><span class="ident" id="6163424">Unlock</span><span class="op" id="6163430">(</span><span class="op" id="6163431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6163435">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163511">if</span>&nbsp;<span class="ident" id="6163514">lastbody</span>&nbsp;<span class="op" id="6163523">!=</span>&nbsp;<span class="ident" id="6163526">nil</span>&nbsp;<span class="op" id="6163530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6163534">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6163600">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6163658">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163673">err</span>&nbsp;<span class="op" id="6163677">=</span>&nbsp;<span class="ident" id="6163679">lastbody</span><span class="op" id="6163687">.</span><span class="ident" id="6163688">Close</span><span class="op" id="6163693">(</span><span class="op" id="6163694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163698">if</span>&nbsp;<span class="ident" id="6163701">err</span>&nbsp;<span class="op" id="6163705">!=</span>&nbsp;<span class="ident" id="6163708">nil</span>&nbsp;<span class="op" id="6163712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163717">cc</span><span class="op" id="6163719">.</span><span class="ident" id="6163720">lk</span><span class="op" id="6163722">.</span><span class="ident" id="6163723">Lock</span><span class="op" id="6163727">(</span><span class="op" id="6163728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163733">defer</span>&nbsp;<span class="ident" id="6163739">cc</span><span class="op" id="6163741">.</span><span class="ident" id="6163742">lk</span><span class="op" id="6163744">.</span><span class="ident" id="6163745">Unlock</span><span class="op" id="6163751">(</span><span class="op" id="6163752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163757">cc</span><span class="op" id="6163759">.</span><span class="ident" id="6163760">re</span>&nbsp;<span class="op" id="6163763">=</span>&nbsp;<span class="ident" id="6163765">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163772">return</span>&nbsp;<span class="ident" id="6163779">nil</span><span class="op" id="6163782">,</span>&nbsp;<span class="ident" id="6163784">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163790">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163797">resp</span><span class="op" id="6163801">,</span>&nbsp;<span class="ident" id="6163803">err</span>&nbsp;<span class="op" id="6163807">=</span>&nbsp;<span class="ident" id="6163809">http</span><span class="op" id="6163813">.</span><span class="ident" id="6163814">ReadResponse</span><span class="op" id="6163826">(</span><span class="ident" id="6163827">r</span><span class="op" id="6163828">,</span>&nbsp;<span class="ident" id="6163830">req</span><span class="op" id="6163833">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163836">cc</span><span class="op" id="6163838">.</span><span class="ident" id="6163839">lk</span><span class="op" id="6163841">.</span><span class="ident" id="6163842">Lock</span><span class="op" id="6163846">(</span><span class="op" id="6163847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163850">defer</span>&nbsp;<span class="ident" id="6163856">cc</span><span class="op" id="6163858">.</span><span class="ident" id="6163859">lk</span><span class="op" id="6163861">.</span><span class="ident" id="6163862">Unlock</span><span class="op" id="6163868">(</span><span class="op" id="6163869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163872">if</span>&nbsp;<span class="ident" id="6163875">err</span>&nbsp;<span class="op" id="6163879">!=</span>&nbsp;<span class="ident" id="6163882">nil</span>&nbsp;<span class="op" id="6163886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163890">cc</span><span class="op" id="6163892">.</span><span class="ident" id="6163893">re</span>&nbsp;<span class="op" id="6163896">=</span>&nbsp;<span class="ident" id="6163898">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163904">return</span>&nbsp;<span class="ident" id="6163911">resp</span><span class="op" id="6163915">,</span>&nbsp;<span class="ident" id="6163917">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6163922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163925">cc</span><span class="op" id="6163927">.</span><span class="ident" id="6163928">lastbody</span>&nbsp;<span class="op" id="6163937">=</span>&nbsp;<span class="ident" id="6163939">resp</span><span class="op" id="6163943">.</span><span class="ident" id="6163944">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163951">cc</span><span class="op" id="6163953">.</span><span class="ident" id="6163954">nread</span><span class="op" id="6163959">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6163964">if</span>&nbsp;<span class="ident" id="6163967">resp</span><span class="op" id="6163971">.</span><span class="ident" id="6163972">Close</span>&nbsp;<span class="op" id="6163978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6163982">cc</span><span class="op" id="6163984">.</span><span class="ident" id="6163985">re</span>&nbsp;<span class="op" id="6163988">=</span>&nbsp;<span class="ident" id="6163990">ErrPersistEOF</span>&nbsp;<span class="comment" id="6164004">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6164038">return</span>&nbsp;<span class="ident" id="6164045">resp</span><span class="op" id="6164049">,</span>&nbsp;<span class="ident" id="6164051">cc</span><span class="op" id="6164053">.</span><span class="ident" id="6164054">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6164058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6164061">return</span>&nbsp;<span class="ident" id="6164068">resp</span><span class="op" id="6164072">,</span>&nbsp;<span class="ident" id="6164074">err</span><br>
<span class="lineno">420</span><span class="op" id="6164078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6164081">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6164153">func</span>&nbsp;<span class="op" id="6164158">(</span><span class="ident" id="6164159">cc</span>&nbsp;<span class="op" id="6164162">*</span><span class="ident" id="6164163">ClientConn</span><span class="op" id="6164173">)</span>&nbsp;<span class="ident" id="6164175">Do</span><span class="op" id="6164177">(</span><span class="ident" id="6164178">req</span>&nbsp;<span class="op" id="6164182">*</span><span class="ident" id="6164183">http</span><span class="op" id="6164187">.</span><span class="ident" id="6164188">Request</span><span class="op" id="6164195">)</span>&nbsp;<span class="op" id="6164197">(</span><span class="ident" id="6164198">resp</span>&nbsp;<span class="op" id="6164203">*</span><span class="ident" id="6164204">http</span><span class="op" id="6164208">.</span><span class="ident" id="6164209">Response</span><span class="op" id="6164217">,</span>&nbsp;<span class="ident" id="6164219">err</span>&nbsp;<span class="builtintype" id="6164223">error</span><span class="op" id="6164228">)</span>&nbsp;<span class="op" id="6164230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6164233">err</span>&nbsp;<span class="op" id="6164237">=</span>&nbsp;<span class="ident" id="6164239">cc</span><span class="op" id="6164241">.</span><span class="ident" id="6164242">Write</span><span class="op" id="6164247">(</span><span class="ident" id="6164248">req</span><span class="op" id="6164251">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6164254">if</span>&nbsp;<span class="ident" id="6164257">err</span>&nbsp;<span class="op" id="6164261">!=</span>&nbsp;<span class="ident" id="6164264">nil</span>&nbsp;<span class="op" id="6164268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6164272">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6164280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6164283">return</span>&nbsp;<span class="ident" id="6164290">cc</span><span class="op" id="6164292">.</span><span class="ident" id="6164293">Read</span><span class="op" id="6164297">(</span><span class="ident" id="6164298">req</span><span class="op" id="6164301">)</span><br>
<span class="lineno"></span><span class="op" id="6164303">}</span>
</div>
</body>
</html>
