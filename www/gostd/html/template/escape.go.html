<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>html/template</h2>
<ul>
<li><a href="/gostd/html/template/attr.go.html">attr.go</a></li>
<li><a href="/gostd/html/template/clone_test.go.html">clone_test.go</a></li>
<li><a href="/gostd/html/template/content.go.html">content.go</a></li>
<li><a href="/gostd/html/template/content_test.go.html">content_test.go</a></li>
<li><a href="/gostd/html/template/context.go.html">context.go</a></li>
<li><a href="/gostd/html/template/css.go.html">css.go</a></li>
<li><a href="/gostd/html/template/css_test.go.html">css_test.go</a></li>
<li><a href="/gostd/html/template/doc.go.html">doc.go</a></li>
<li><a href="/gostd/html/template/error.go.html">error.go</a></li>
<li><a href="/gostd/html/template/escape.go.html">escape.go</a></li>
<li><a href="/gostd/html/template/escape_test.go.html">escape_test.go</a></li>
<li><a href="/gostd/html/template/html.go.html">html.go</a></li>
<li><a href="/gostd/html/template/html_test.go.html">html_test.go</a></li>
<li><a href="/gostd/html/template/js.go.html">js.go</a></li>
<li><a href="/gostd/html/template/js_test.go.html">js_test.go</a></li>
<li><a href="/gostd/html/template/template.go.html">template.go</a></li>
<li><a href="/gostd/html/template/transition.go.html">transition.go</a></li>
<li><a href="/gostd/html/template/url.go.html">url.go</a></li>
<li><a href="/gostd/html/template/url_test.go.html">url_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5143283">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5143338">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5143392">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5143443">package</span>&nbsp;<span class="ident" id="5143451">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5143461">import</span>&nbsp;<span class="op" id="5143468">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143471">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143480">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143487">&#34;html&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143495">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143501">&#34;text/template&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5143518">&#34;text/template/parse&#34;</span><br>
<span class="lineno"></span><span class="op" id="5143540">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5143543">//&nbsp;escapeTemplate&nbsp;rewrites&nbsp;the&nbsp;named&nbsp;template,&nbsp;which&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5143604">//&nbsp;associated&nbsp;with&nbsp;t,&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;output&nbsp;of&nbsp;any&nbsp;of&nbsp;the&nbsp;named</span><br>
<span class="lineno"></span><span class="comment" id="5143675">//&nbsp;templates&nbsp;is&nbsp;properly&nbsp;escaped.&nbsp;&nbsp;If&nbsp;no&nbsp;error&nbsp;is&nbsp;returned,&nbsp;then&nbsp;the&nbsp;named&nbsp;templates&nbsp;have</span><br>
<span class="lineno"></span><span class="comment" id="5143765">//&nbsp;been&nbsp;modified.&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;named&nbsp;templates&nbsp;have&nbsp;been&nbsp;rendered</span><br>
<span class="lineno">20</span><span class="comment" id="5143833">//&nbsp;unusable.</span><br>
<span class="lineno"></span><span class="keyword" id="5143846">func</span>&nbsp;<span class="ident" id="5143851">escapeTemplate</span><span class="op" id="5143865">(</span><span class="ident" id="5143866">tmpl</span>&nbsp;<span class="op" id="5143871">*</span><span class="ident" id="5143872">Template</span><span class="op" id="5143880">,</span>&nbsp;<span class="ident" id="5143882">node</span>&nbsp;<span class="ident" id="5143887">parse</span><span class="op" id="5143892">.</span><span class="ident" id="5143893">Node</span><span class="op" id="5143897">,</span>&nbsp;<span class="ident" id="5143899">name</span>&nbsp;<span class="builtintype" id="5143904">string</span><span class="op" id="5143910">)</span>&nbsp;<span class="builtintype" id="5143912">error</span>&nbsp;<span class="op" id="5143918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143921">e</span>&nbsp;<span class="op" id="5143923">:=</span>&nbsp;<span class="ident" id="5143926">newEscaper</span><span class="op" id="5143936">(</span><span class="ident" id="5143937">tmpl</span><span class="op" id="5143941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5143944">c</span><span class="op" id="5143945">,</span>&nbsp;<span class="ident" id="5143947">_</span>&nbsp;<span class="op" id="5143949">:=</span>&nbsp;<span class="ident" id="5143952">e</span><span class="op" id="5143953">.</span><span class="ident" id="5143954">escapeTree</span><span class="op" id="5143964">(</span><span class="ident" id="5143965">context</span><span class="op" id="5143972">{</span><span class="op" id="5143973">}</span><span class="op" id="5143974">,</span>&nbsp;<span class="ident" id="5143976">node</span><span class="op" id="5143980">,</span>&nbsp;<span class="ident" id="5143982">name</span><span class="op" id="5143986">,</span>&nbsp;<span class="num" id="5143988">0</span><span class="op" id="5143989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5143992">var</span>&nbsp;<span class="ident" id="5143996">err</span>&nbsp;<span class="builtintype" id="5144000">error</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144007">if</span>&nbsp;<span class="ident" id="5144010">c</span><span class="op" id="5144011">.</span><span class="ident" id="5144012">err</span>&nbsp;<span class="op" id="5144016">!=</span>&nbsp;<span class="ident" id="5144019">nil</span>&nbsp;<span class="op" id="5144023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144027">err</span><span class="op" id="5144030">,</span>&nbsp;<span class="ident" id="5144032">c</span><span class="op" id="5144033">.</span><span class="ident" id="5144034">err</span><span class="op" id="5144037">.</span><span class="ident" id="5144038">Name</span>&nbsp;<span class="op" id="5144043">=</span>&nbsp;<span class="ident" id="5144045">c</span><span class="op" id="5144046">.</span><span class="ident" id="5144047">err</span><span class="op" id="5144050">,</span>&nbsp;<span class="ident" id="5144052">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5144058">}</span>&nbsp;<span class="keyword" id="5144060">else</span>&nbsp;<span class="keyword" id="5144065">if</span>&nbsp;<span class="ident" id="5144068">c</span><span class="op" id="5144069">.</span><span class="ident" id="5144070">state</span>&nbsp;<span class="op" id="5144076">!=</span>&nbsp;<span class="ident" id="5144079">stateText</span>&nbsp;<span class="op" id="5144089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144093">err</span>&nbsp;<span class="op" id="5144097">=</span>&nbsp;<span class="op" id="5144099">&amp;</span><span class="ident" id="5144100">Error</span><span class="op" id="5144105">{</span><span class="ident" id="5144106">ErrEndContext</span><span class="op" id="5144119">,</span>&nbsp;<span class="ident" id="5144121">nil</span><span class="op" id="5144124">,</span>&nbsp;<span class="ident" id="5144126">name</span><span class="op" id="5144130">,</span>&nbsp;<span class="num" id="5144132">0</span><span class="op" id="5144133">,</span>&nbsp;<span class="ident" id="5144135">fmt</span><span class="op" id="5144138">.</span><span class="ident" id="5144139">Sprintf</span><span class="op" id="5144146">(</span><span class="string" id="5144147">&#34;ends&nbsp;in&nbsp;a&nbsp;non-text&nbsp;context:&nbsp;%v&#34;</span><span class="op" id="5144179">,</span>&nbsp;<span class="ident" id="5144181">c</span><span class="op" id="5144182">)</span><span class="op" id="5144183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5144186">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144189">if</span>&nbsp;<span class="ident" id="5144192">err</span>&nbsp;<span class="op" id="5144196">!=</span>&nbsp;<span class="ident" id="5144199">nil</span>&nbsp;<span class="op" id="5144203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5144207">//&nbsp;Prevent&nbsp;execution&nbsp;of&nbsp;unsafe&nbsp;templates.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144251">if</span>&nbsp;<span class="ident" id="5144254">t</span>&nbsp;<span class="op" id="5144256">:=</span>&nbsp;<span class="ident" id="5144259">tmpl</span><span class="op" id="5144263">.</span><span class="ident" id="5144264">set</span><span class="op" id="5144267">[</span><span class="ident" id="5144268">name</span><span class="op" id="5144272">]</span><span class="op" id="5144273">;</span>&nbsp;<span class="ident" id="5144275">t</span>&nbsp;<span class="op" id="5144277">!=</span>&nbsp;<span class="ident" id="5144280">nil</span>&nbsp;<span class="op" id="5144284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144289">t</span><span class="op" id="5144290">.</span><span class="ident" id="5144291">escapeErr</span>&nbsp;<span class="op" id="5144301">=</span>&nbsp;<span class="ident" id="5144303">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144310">t</span><span class="op" id="5144311">.</span><span class="ident" id="5144312">text</span><span class="op" id="5144316">.</span><span class="ident" id="5144317">Tree</span>&nbsp;<span class="op" id="5144322">=</span>&nbsp;<span class="ident" id="5144324">nil</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144331">t</span><span class="op" id="5144332">.</span><span class="ident" id="5144333">Tree</span>&nbsp;<span class="op" id="5144338">=</span>&nbsp;<span class="ident" id="5144340">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5144346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144350">return</span>&nbsp;<span class="ident" id="5144357">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5144362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144365">e</span><span class="op" id="5144366">.</span><span class="ident" id="5144367">commit</span><span class="op" id="5144373">(</span><span class="op" id="5144374">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144377">if</span>&nbsp;<span class="ident" id="5144380">t</span>&nbsp;<span class="op" id="5144382">:=</span>&nbsp;<span class="ident" id="5144385">tmpl</span><span class="op" id="5144389">.</span><span class="ident" id="5144390">set</span><span class="op" id="5144393">[</span><span class="ident" id="5144394">name</span><span class="op" id="5144398">]</span><span class="op" id="5144399">;</span>&nbsp;<span class="ident" id="5144401">t</span>&nbsp;<span class="op" id="5144403">!=</span>&nbsp;<span class="ident" id="5144406">nil</span>&nbsp;<span class="op" id="5144410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144414">t</span><span class="op" id="5144415">.</span><span class="ident" id="5144416">escapeErr</span>&nbsp;<span class="op" id="5144426">=</span>&nbsp;<span class="ident" id="5144428">escapeOK</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5144439">t</span><span class="op" id="5144440">.</span><span class="ident" id="5144441">Tree</span>&nbsp;<span class="op" id="5144446">=</span>&nbsp;<span class="ident" id="5144448">t</span><span class="op" id="5144449">.</span><span class="ident" id="5144450">text</span><span class="op" id="5144454">.</span><span class="ident" id="5144455">Tree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5144461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5144464">return</span>&nbsp;<span class="ident" id="5144471">nil</span><br>
<span class="lineno">45</span><span class="op" id="5144475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5144478">//&nbsp;funcMap&nbsp;maps&nbsp;command&nbsp;names&nbsp;to&nbsp;functions&nbsp;that&nbsp;render&nbsp;their&nbsp;inputs&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5144552">var</span>&nbsp;<span class="ident" id="5144556">funcMap</span>&nbsp;<span class="op" id="5144564">=</span>&nbsp;<span class="ident" id="5144566">template</span><span class="op" id="5144574">.</span><span class="ident" id="5144575">FuncMap</span><span class="op" id="5144582">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144585">&#34;html_template_attrescaper&#34;</span><span class="op" id="5144612">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5144618">attrEscaper</span><span class="op" id="5144629">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144632">&#34;html_template_commentescaper&#34;</span><span class="op" id="5144662">:</span>&nbsp;&nbsp;<span class="ident" id="5144665">commentEscaper</span><span class="op" id="5144679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144682">&#34;html_template_cssescaper&#34;</span><span class="op" id="5144708">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5144715">cssEscaper</span><span class="op" id="5144725">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144728">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5144758">:</span>&nbsp;&nbsp;<span class="ident" id="5144761">cssValueFilter</span><span class="op" id="5144775">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144778">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5144808">:</span>&nbsp;&nbsp;<span class="ident" id="5144811">htmlNameFilter</span><span class="op" id="5144825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144828">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5144855">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5144861">htmlEscaper</span><span class="op" id="5144872">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144875">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5144906">:</span>&nbsp;<span class="ident" id="5144908">jsRegexpEscaper</span><span class="op" id="5144923">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144926">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5144954">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5144959">jsStrEscaper</span><span class="op" id="5144971">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5144974">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5145002">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5145007">jsValEscaper</span><span class="op" id="5145019">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145022">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5145052">:</span>&nbsp;&nbsp;<span class="ident" id="5145055">htmlNospaceEscaper</span><span class="op" id="5145073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145076">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5145105">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5145109">rcdataEscaper</span><span class="op" id="5145122">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145125">&#34;html_template_urlescaper&#34;</span><span class="op" id="5145151">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5145158">urlEscaper</span><span class="op" id="5145168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145171">&#34;html_template_urlfilter&#34;</span><span class="op" id="5145196">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5145204">urlFilter</span><span class="op" id="5145213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145216">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5145245">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5145249">urlNormalizer</span><span class="op" id="5145262">,</span><br>
<span class="lineno"></span><span class="op" id="5145264">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5145267">//&nbsp;equivEscapers&nbsp;matches&nbsp;contextual&nbsp;escapers&nbsp;to&nbsp;equivalent&nbsp;template&nbsp;builtins.</span><br>
<span class="lineno"></span><span class="keyword" id="5145345">var</span>&nbsp;<span class="ident" id="5145349">equivEscapers</span>&nbsp;<span class="op" id="5145363">=</span>&nbsp;<span class="keyword" id="5145365">map</span><span class="op" id="5145368">[</span><span class="builtintype" id="5145369">string</span><span class="op" id="5145375">]</span><span class="builtintype" id="5145376">string</span><span class="op" id="5145382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145385">&#34;html_template_attrescaper&#34;</span><span class="op" id="5145412">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5145417">&#34;html&#34;</span><span class="op" id="5145423">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145426">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5145453">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5145458">&#34;html&#34;</span><span class="op" id="5145464">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145467">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5145497">:</span>&nbsp;<span class="string" id="5145499">&#34;html&#34;</span><span class="op" id="5145505">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145508">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5145537">:</span>&nbsp;&nbsp;<span class="string" id="5145540">&#34;html&#34;</span><span class="op" id="5145546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145549">&#34;html_template_urlescaper&#34;</span><span class="op" id="5145575">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5145581">&#34;urlquery&#34;</span><span class="op" id="5145591">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5145594">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5145623">:</span>&nbsp;&nbsp;<span class="string" id="5145626">&#34;urlquery&#34;</span><span class="op" id="5145636">,</span><br>
<span class="lineno"></span><span class="op" id="5145638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="5145641">//&nbsp;escaper&nbsp;collects&nbsp;type&nbsp;inferences&nbsp;about&nbsp;templates&nbsp;and&nbsp;changes&nbsp;needed&nbsp;to&nbsp;make</span><br>
<span class="lineno"></span><span class="comment" id="5145720">//&nbsp;templates&nbsp;injection&nbsp;safe.</span><br>
<span class="lineno"></span><span class="keyword" id="5145749">type</span>&nbsp;<span class="ident" id="5145754">escaper</span>&nbsp;<span class="keyword" id="5145762">struct</span>&nbsp;<span class="op" id="5145769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145772">tmpl</span>&nbsp;<span class="op" id="5145777">*</span><span class="ident" id="5145778">Template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5145788">//&nbsp;output[templateName]&nbsp;is&nbsp;the&nbsp;output&nbsp;context&nbsp;for&nbsp;a&nbsp;templateName&nbsp;that</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5145859">//&nbsp;has&nbsp;been&nbsp;mangled&nbsp;to&nbsp;include&nbsp;its&nbsp;input&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5145910">output</span>&nbsp;<span class="keyword" id="5145917">map</span><span class="op" id="5145920">[</span><span class="builtintype" id="5145921">string</span><span class="op" id="5145927">]</span><span class="ident" id="5145928">context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5145937">//&nbsp;derived[c.mangle(name)]&nbsp;maps&nbsp;to&nbsp;a&nbsp;template&nbsp;derived&nbsp;from&nbsp;the&nbsp;template</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5146010">//&nbsp;named&nbsp;name&nbsp;templateName&nbsp;for&nbsp;the&nbsp;start&nbsp;context&nbsp;c.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146063">derived</span>&nbsp;<span class="keyword" id="5146071">map</span><span class="op" id="5146074">[</span><span class="builtintype" id="5146075">string</span><span class="op" id="5146081">]</span><span class="op" id="5146082">*</span><span class="ident" id="5146083">template</span><span class="op" id="5146091">.</span><span class="ident" id="5146092">Template</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5146102">//&nbsp;called[templateName]&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;called&nbsp;mangled&nbsp;template&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146170">called</span>&nbsp;<span class="keyword" id="5146177">map</span><span class="op" id="5146180">[</span><span class="builtintype" id="5146181">string</span><span class="op" id="5146187">]</span><span class="builtintype" id="5146188">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5146194">//&nbsp;xxxNodeEdits&nbsp;are&nbsp;the&nbsp;accumulated&nbsp;edits&nbsp;to&nbsp;apply&nbsp;during&nbsp;commit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5146261">//&nbsp;Such&nbsp;edits&nbsp;are&nbsp;not&nbsp;applied&nbsp;immediately&nbsp;in&nbsp;case&nbsp;a&nbsp;template&nbsp;set</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5146327">//&nbsp;executes&nbsp;a&nbsp;given&nbsp;template&nbsp;in&nbsp;different&nbsp;escaping&nbsp;contexts.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146389">actionNodeEdits</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="5146407">map</span><span class="op" id="5146410">[</span><span class="op" id="5146411">*</span><span class="ident" id="5146412">parse</span><span class="op" id="5146417">.</span><span class="ident" id="5146418">ActionNode</span><span class="op" id="5146428">]</span><span class="op" id="5146429">[</span><span class="op" id="5146430">]</span><span class="builtintype" id="5146431">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146439">templateNodeEdits</span>&nbsp;<span class="keyword" id="5146457">map</span><span class="op" id="5146460">[</span><span class="op" id="5146461">*</span><span class="ident" id="5146462">parse</span><span class="op" id="5146467">.</span><span class="ident" id="5146468">TemplateNode</span><span class="op" id="5146480">]</span><span class="builtintype" id="5146481">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146489">textNodeEdits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5146507">map</span><span class="op" id="5146510">[</span><span class="op" id="5146511">*</span><span class="ident" id="5146512">parse</span><span class="op" id="5146517">.</span><span class="ident" id="5146518">TextNode</span><span class="op" id="5146526">]</span><span class="op" id="5146527">[</span><span class="op" id="5146528">]</span><span class="builtintype" id="5146529">byte</span><br>
<span class="lineno"></span><span class="op" id="5146534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="5146537">//&nbsp;newEscaper&nbsp;creates&nbsp;a&nbsp;blank&nbsp;escaper&nbsp;for&nbsp;the&nbsp;given&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5146594">func</span>&nbsp;<span class="ident" id="5146599">newEscaper</span><span class="op" id="5146609">(</span><span class="ident" id="5146610">t</span>&nbsp;<span class="op" id="5146612">*</span><span class="ident" id="5146613">Template</span><span class="op" id="5146621">)</span>&nbsp;<span class="op" id="5146623">*</span><span class="ident" id="5146624">escaper</span>&nbsp;<span class="op" id="5146632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146635">return</span>&nbsp;<span class="op" id="5146642">&amp;</span><span class="ident" id="5146643">escaper</span><span class="op" id="5146650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5146654">t</span><span class="op" id="5146655">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146659">map</span><span class="op" id="5146662">[</span><span class="builtintype" id="5146663">string</span><span class="op" id="5146669">]</span><span class="ident" id="5146670">context</span><span class="op" id="5146677">{</span><span class="op" id="5146678">}</span><span class="op" id="5146679">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146683">map</span><span class="op" id="5146686">[</span><span class="builtintype" id="5146687">string</span><span class="op" id="5146693">]</span><span class="op" id="5146694">*</span><span class="ident" id="5146695">template</span><span class="op" id="5146703">.</span><span class="ident" id="5146704">Template</span><span class="op" id="5146712">{</span><span class="op" id="5146713">}</span><span class="op" id="5146714">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146718">map</span><span class="op" id="5146721">[</span><span class="builtintype" id="5146722">string</span><span class="op" id="5146728">]</span><span class="builtintype" id="5146729">bool</span><span class="op" id="5146733">{</span><span class="op" id="5146734">}</span><span class="op" id="5146735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146739">map</span><span class="op" id="5146742">[</span><span class="op" id="5146743">*</span><span class="ident" id="5146744">parse</span><span class="op" id="5146749">.</span><span class="ident" id="5146750">ActionNode</span><span class="op" id="5146760">]</span><span class="op" id="5146761">[</span><span class="op" id="5146762">]</span><span class="builtintype" id="5146763">string</span><span class="op" id="5146769">{</span><span class="op" id="5146770">}</span><span class="op" id="5146771">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146775">map</span><span class="op" id="5146778">[</span><span class="op" id="5146779">*</span><span class="ident" id="5146780">parse</span><span class="op" id="5146785">.</span><span class="ident" id="5146786">TemplateNode</span><span class="op" id="5146798">]</span><span class="builtintype" id="5146799">string</span><span class="op" id="5146805">{</span><span class="op" id="5146806">}</span><span class="op" id="5146807">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5146811">map</span><span class="op" id="5146814">[</span><span class="op" id="5146815">*</span><span class="ident" id="5146816">parse</span><span class="op" id="5146821">.</span><span class="ident" id="5146822">TextNode</span><span class="op" id="5146830">]</span><span class="op" id="5146831">[</span><span class="op" id="5146832">]</span><span class="builtintype" id="5146833">byte</span><span class="op" id="5146837">{</span><span class="op" id="5146838">}</span><span class="op" id="5146839">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5146842">}</span><br>
<span class="lineno"></span><span class="op" id="5146844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5146847">//&nbsp;filterFailsafe&nbsp;is&nbsp;an&nbsp;innocuous&nbsp;word&nbsp;that&nbsp;is&nbsp;emitted&nbsp;in&nbsp;place&nbsp;of&nbsp;unsafe&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="5146928">//&nbsp;by&nbsp;sanitizer&nbsp;functions.&nbsp;It&nbsp;is&nbsp;not&nbsp;a&nbsp;keyword&nbsp;in&nbsp;any&nbsp;programming&nbsp;language,</span><br>
<span class="lineno">110</span><span class="comment" id="5147004">//&nbsp;contains&nbsp;no&nbsp;special&nbsp;characters,&nbsp;is&nbsp;not&nbsp;empty,&nbsp;and&nbsp;when&nbsp;it&nbsp;appears&nbsp;in&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5147083">//&nbsp;it&nbsp;is&nbsp;distinct&nbsp;enough&nbsp;that&nbsp;a&nbsp;developer&nbsp;can&nbsp;find&nbsp;the&nbsp;source&nbsp;of&nbsp;the&nbsp;problem</span><br>
<span class="lineno"></span><span class="comment" id="5147160">//&nbsp;via&nbsp;a&nbsp;search&nbsp;engine.</span><br>
<span class="lineno"></span><span class="keyword" id="5147184">const</span>&nbsp;<span class="ident" id="5147190">filterFailsafe</span>&nbsp;<span class="op" id="5147205">=</span>&nbsp;<span class="string" id="5147207">&#34;ZgotmplZ&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment" id="5147219">//&nbsp;escape&nbsp;escapes&nbsp;a&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5147254">func</span>&nbsp;<span class="op" id="5147259">(</span><span class="ident" id="5147260">e</span>&nbsp;<span class="op" id="5147262">*</span><span class="ident" id="5147263">escaper</span><span class="op" id="5147270">)</span>&nbsp;<span class="ident" id="5147272">escape</span><span class="op" id="5147278">(</span><span class="ident" id="5147279">c</span>&nbsp;<span class="ident" id="5147281">context</span><span class="op" id="5147288">,</span>&nbsp;<span class="ident" id="5147290">n</span>&nbsp;<span class="ident" id="5147292">parse</span><span class="op" id="5147297">.</span><span class="ident" id="5147298">Node</span><span class="op" id="5147302">)</span>&nbsp;<span class="ident" id="5147304">context</span>&nbsp;<span class="op" id="5147312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147315">switch</span>&nbsp;<span class="ident" id="5147322">n</span>&nbsp;<span class="op" id="5147324">:=</span>&nbsp;<span class="ident" id="5147327">n</span><span class="op" id="5147328">.</span><span class="op" id="5147329">(</span><span class="keyword" id="5147330">type</span><span class="op" id="5147334">)</span>&nbsp;<span class="op" id="5147336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147339">case</span>&nbsp;<span class="op" id="5147344">*</span><span class="ident" id="5147345">parse</span><span class="op" id="5147350">.</span><span class="ident" id="5147351">ActionNode</span><span class="op" id="5147361">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147365">return</span>&nbsp;<span class="ident" id="5147372">e</span><span class="op" id="5147373">.</span><span class="ident" id="5147374">escapeAction</span><span class="op" id="5147386">(</span><span class="ident" id="5147387">c</span><span class="op" id="5147388">,</span>&nbsp;<span class="ident" id="5147390">n</span><span class="op" id="5147391">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147394">case</span>&nbsp;<span class="op" id="5147399">*</span><span class="ident" id="5147400">parse</span><span class="op" id="5147405">.</span><span class="ident" id="5147406">IfNode</span><span class="op" id="5147412">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147416">return</span>&nbsp;<span class="ident" id="5147423">e</span><span class="op" id="5147424">.</span><span class="ident" id="5147425">escapeBranch</span><span class="op" id="5147437">(</span><span class="ident" id="5147438">c</span><span class="op" id="5147439">,</span>&nbsp;<span class="op" id="5147441">&amp;</span><span class="ident" id="5147442">n</span><span class="op" id="5147443">.</span><span class="ident" id="5147444">BranchNode</span><span class="op" id="5147454">,</span>&nbsp;<span class="string" id="5147456">&#34;if&#34;</span><span class="op" id="5147460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147463">case</span>&nbsp;<span class="op" id="5147468">*</span><span class="ident" id="5147469">parse</span><span class="op" id="5147474">.</span><span class="ident" id="5147475">ListNode</span><span class="op" id="5147483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147487">return</span>&nbsp;<span class="ident" id="5147494">e</span><span class="op" id="5147495">.</span><span class="ident" id="5147496">escapeList</span><span class="op" id="5147506">(</span><span class="ident" id="5147507">c</span><span class="op" id="5147508">,</span>&nbsp;<span class="ident" id="5147510">n</span><span class="op" id="5147511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147514">case</span>&nbsp;<span class="op" id="5147519">*</span><span class="ident" id="5147520">parse</span><span class="op" id="5147525">.</span><span class="ident" id="5147526">RangeNode</span><span class="op" id="5147535">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147539">return</span>&nbsp;<span class="ident" id="5147546">e</span><span class="op" id="5147547">.</span><span class="ident" id="5147548">escapeBranch</span><span class="op" id="5147560">(</span><span class="ident" id="5147561">c</span><span class="op" id="5147562">,</span>&nbsp;<span class="op" id="5147564">&amp;</span><span class="ident" id="5147565">n</span><span class="op" id="5147566">.</span><span class="ident" id="5147567">BranchNode</span><span class="op" id="5147577">,</span>&nbsp;<span class="string" id="5147579">&#34;range&#34;</span><span class="op" id="5147586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147589">case</span>&nbsp;<span class="op" id="5147594">*</span><span class="ident" id="5147595">parse</span><span class="op" id="5147600">.</span><span class="ident" id="5147601">TemplateNode</span><span class="op" id="5147613">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147617">return</span>&nbsp;<span class="ident" id="5147624">e</span><span class="op" id="5147625">.</span><span class="ident" id="5147626">escapeTemplate</span><span class="op" id="5147640">(</span><span class="ident" id="5147641">c</span><span class="op" id="5147642">,</span>&nbsp;<span class="ident" id="5147644">n</span><span class="op" id="5147645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147648">case</span>&nbsp;<span class="op" id="5147653">*</span><span class="ident" id="5147654">parse</span><span class="op" id="5147659">.</span><span class="ident" id="5147660">TextNode</span><span class="op" id="5147668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147672">return</span>&nbsp;<span class="ident" id="5147679">e</span><span class="op" id="5147680">.</span><span class="ident" id="5147681">escapeText</span><span class="op" id="5147691">(</span><span class="ident" id="5147692">c</span><span class="op" id="5147693">,</span>&nbsp;<span class="ident" id="5147695">n</span><span class="op" id="5147696">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147699">case</span>&nbsp;<span class="op" id="5147704">*</span><span class="ident" id="5147705">parse</span><span class="op" id="5147710">.</span><span class="ident" id="5147711">WithNode</span><span class="op" id="5147719">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147723">return</span>&nbsp;<span class="ident" id="5147730">e</span><span class="op" id="5147731">.</span><span class="ident" id="5147732">escapeBranch</span><span class="op" id="5147744">(</span><span class="ident" id="5147745">c</span><span class="op" id="5147746">,</span>&nbsp;<span class="op" id="5147748">&amp;</span><span class="ident" id="5147749">n</span><span class="op" id="5147750">.</span><span class="ident" id="5147751">BranchNode</span><span class="op" id="5147761">,</span>&nbsp;<span class="string" id="5147763">&#34;with&#34;</span><span class="op" id="5147769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5147772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5147775">panic</span><span class="op" id="5147780">(</span><span class="string" id="5147781">&#34;escaping&nbsp;&#34;</span>&nbsp;<span class="op" id="5147793">+</span>&nbsp;<span class="ident" id="5147795">n</span><span class="op" id="5147796">.</span><span class="ident" id="5147797">String</span><span class="op" id="5147803">(</span><span class="op" id="5147804">)</span>&nbsp;<span class="op" id="5147806">+</span>&nbsp;<span class="string" id="5147808">&#34;&nbsp;is&nbsp;unimplemented&#34;</span><span class="op" id="5147827">)</span><br>
<span class="lineno"></span><span class="op" id="5147829">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="comment" id="5147832">//&nbsp;escapeAction&nbsp;escapes&nbsp;an&nbsp;action&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5147881">func</span>&nbsp;<span class="op" id="5147886">(</span><span class="ident" id="5147887">e</span>&nbsp;<span class="op" id="5147889">*</span><span class="ident" id="5147890">escaper</span><span class="op" id="5147897">)</span>&nbsp;<span class="ident" id="5147899">escapeAction</span><span class="op" id="5147911">(</span><span class="ident" id="5147912">c</span>&nbsp;<span class="ident" id="5147914">context</span><span class="op" id="5147921">,</span>&nbsp;<span class="ident" id="5147923">n</span>&nbsp;<span class="op" id="5147925">*</span><span class="ident" id="5147926">parse</span><span class="op" id="5147931">.</span><span class="ident" id="5147932">ActionNode</span><span class="op" id="5147942">)</span>&nbsp;<span class="ident" id="5147944">context</span>&nbsp;<span class="op" id="5147952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5147955">if</span>&nbsp;<span class="builtinfunc" id="5147958">len</span><span class="op" id="5147961">(</span><span class="ident" id="5147962">n</span><span class="op" id="5147963">.</span><span class="ident" id="5147964">Pipe</span><span class="op" id="5147968">.</span><span class="ident" id="5147969">Decl</span><span class="op" id="5147973">)</span>&nbsp;<span class="op" id="5147975">!=</span>&nbsp;<span class="num" id="5147978">0</span>&nbsp;<span class="op" id="5147980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5147984">//&nbsp;A&nbsp;local&nbsp;variable&nbsp;assignment,&nbsp;not&nbsp;an&nbsp;interpolation.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148040">return</span>&nbsp;<span class="ident" id="5148047">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148053">c</span>&nbsp;<span class="op" id="5148055">=</span>&nbsp;<span class="ident" id="5148057">nudge</span><span class="op" id="5148062">(</span><span class="ident" id="5148063">c</span><span class="op" id="5148064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148067">s</span>&nbsp;<span class="op" id="5148069">:=</span>&nbsp;<span class="builtinfunc" id="5148072">make</span><span class="op" id="5148076">(</span><span class="op" id="5148077">[</span><span class="op" id="5148078">]</span><span class="builtintype" id="5148079">string</span><span class="op" id="5148085">,</span>&nbsp;<span class="num" id="5148087">0</span><span class="op" id="5148088">,</span>&nbsp;<span class="num" id="5148090">3</span><span class="op" id="5148091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148094">switch</span>&nbsp;<span class="ident" id="5148101">c</span><span class="op" id="5148102">.</span><span class="ident" id="5148103">state</span>&nbsp;<span class="op" id="5148109">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148112">case</span>&nbsp;<span class="ident" id="5148117">stateError</span><span class="op" id="5148127">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148131">return</span>&nbsp;<span class="ident" id="5148138">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148141">case</span>&nbsp;<span class="ident" id="5148146">stateURL</span><span class="op" id="5148154">,</span>&nbsp;<span class="ident" id="5148156">stateCSSDqStr</span><span class="op" id="5148169">,</span>&nbsp;<span class="ident" id="5148171">stateCSSSqStr</span><span class="op" id="5148184">,</span>&nbsp;<span class="ident" id="5148186">stateCSSDqURL</span><span class="op" id="5148199">,</span>&nbsp;<span class="ident" id="5148201">stateCSSSqURL</span><span class="op" id="5148214">,</span>&nbsp;<span class="ident" id="5148216">stateCSSURL</span><span class="op" id="5148227">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148231">switch</span>&nbsp;<span class="ident" id="5148238">c</span><span class="op" id="5148239">.</span><span class="ident" id="5148240">urlPart</span>&nbsp;<span class="op" id="5148248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148252">case</span>&nbsp;<span class="ident" id="5148257">urlPartNone</span><span class="op" id="5148268">:</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148273">s</span>&nbsp;<span class="op" id="5148275">=</span>&nbsp;<span class="builtinfunc" id="5148277">append</span><span class="op" id="5148283">(</span><span class="ident" id="5148284">s</span><span class="op" id="5148285">,</span>&nbsp;<span class="string" id="5148287">&#34;html_template_urlfilter&#34;</span><span class="op" id="5148312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148317">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148331">case</span>&nbsp;<span class="ident" id="5148336">urlPartPreQuery</span><span class="op" id="5148351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148356">switch</span>&nbsp;<span class="ident" id="5148363">c</span><span class="op" id="5148364">.</span><span class="ident" id="5148365">state</span>&nbsp;<span class="op" id="5148371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148376">case</span>&nbsp;<span class="ident" id="5148381">stateCSSDqStr</span><span class="op" id="5148394">,</span>&nbsp;<span class="ident" id="5148396">stateCSSSqStr</span><span class="op" id="5148409">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148415">s</span>&nbsp;<span class="op" id="5148417">=</span>&nbsp;<span class="builtinfunc" id="5148419">append</span><span class="op" id="5148425">(</span><span class="ident" id="5148426">s</span><span class="op" id="5148427">,</span>&nbsp;<span class="string" id="5148429">&#34;html_template_cssescaper&#34;</span><span class="op" id="5148455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148460">default</span><span class="op" id="5148467">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148473">s</span>&nbsp;<span class="op" id="5148475">=</span>&nbsp;<span class="builtinfunc" id="5148477">append</span><span class="op" id="5148483">(</span><span class="ident" id="5148484">s</span><span class="op" id="5148485">,</span>&nbsp;<span class="string" id="5148487">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5148516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148525">case</span>&nbsp;<span class="ident" id="5148530">urlPartQueryOrFrag</span><span class="op" id="5148548">:</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148553">s</span>&nbsp;<span class="op" id="5148555">=</span>&nbsp;<span class="builtinfunc" id="5148557">append</span><span class="op" id="5148563">(</span><span class="ident" id="5148564">s</span><span class="op" id="5148565">,</span>&nbsp;<span class="string" id="5148567">&#34;html_template_urlescaper&#34;</span><span class="op" id="5148593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148597">case</span>&nbsp;<span class="ident" id="5148602">urlPartUnknown</span><span class="op" id="5148616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148621">return</span>&nbsp;<span class="ident" id="5148628">context</span><span class="op" id="5148635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148641">state</span><span class="op" id="5148646">:</span>&nbsp;<span class="ident" id="5148648">stateError</span><span class="op" id="5148658">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148664">err</span><span class="op" id="5148667">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5148671">errorf</span><span class="op" id="5148677">(</span><span class="ident" id="5148678">ErrAmbigContext</span><span class="op" id="5148693">,</span>&nbsp;<span class="ident" id="5148695">n</span><span class="op" id="5148696">,</span>&nbsp;<span class="ident" id="5148698">n</span><span class="op" id="5148699">.</span><span class="ident" id="5148700">Line</span><span class="op" id="5148704">,</span>&nbsp;<span class="string" id="5148706">&#34;%s&nbsp;appears&nbsp;in&nbsp;an&nbsp;ambiguous&nbsp;URL&nbsp;context&#34;</span><span class="op" id="5148746">,</span>&nbsp;<span class="ident" id="5148748">n</span><span class="op" id="5148749">)</span><span class="op" id="5148750">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148759">default</span><span class="op" id="5148766">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5148771">panic</span><span class="op" id="5148776">(</span><span class="ident" id="5148777">c</span><span class="op" id="5148778">.</span><span class="ident" id="5148779">urlPart</span><span class="op" id="5148786">.</span><span class="ident" id="5148787">String</span><span class="op" id="5148793">(</span><span class="op" id="5148794">)</span><span class="op" id="5148795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5148799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148802">case</span>&nbsp;<span class="ident" id="5148807">stateJS</span><span class="op" id="5148814">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148818">s</span>&nbsp;<span class="op" id="5148820">=</span>&nbsp;<span class="builtinfunc" id="5148822">append</span><span class="op" id="5148828">(</span><span class="ident" id="5148829">s</span><span class="op" id="5148830">,</span>&nbsp;<span class="string" id="5148832">&#34;html_template_jsvalescaper&#34;</span><span class="op" id="5148860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5148864">//&nbsp;A&nbsp;slash&nbsp;after&nbsp;a&nbsp;value&nbsp;starts&nbsp;a&nbsp;div&nbsp;operator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148914">c</span><span class="op" id="5148915">.</span><span class="ident" id="5148916">jsCtx</span>&nbsp;<span class="op" id="5148922">=</span>&nbsp;<span class="ident" id="5148924">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5148936">case</span>&nbsp;<span class="ident" id="5148941">stateJSDqStr</span><span class="op" id="5148953">,</span>&nbsp;<span class="ident" id="5148955">stateJSSqStr</span><span class="op" id="5148967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5148971">s</span>&nbsp;<span class="op" id="5148973">=</span>&nbsp;<span class="builtinfunc" id="5148975">append</span><span class="op" id="5148981">(</span><span class="ident" id="5148982">s</span><span class="op" id="5148983">,</span>&nbsp;<span class="string" id="5148985">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5149013">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149016">case</span>&nbsp;<span class="ident" id="5149021">stateJSRegexp</span><span class="op" id="5149034">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149038">s</span>&nbsp;<span class="op" id="5149040">=</span>&nbsp;<span class="builtinfunc" id="5149042">append</span><span class="op" id="5149048">(</span><span class="ident" id="5149049">s</span><span class="op" id="5149050">,</span>&nbsp;<span class="string" id="5149052">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5149083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149086">case</span>&nbsp;<span class="ident" id="5149091">stateCSS</span><span class="op" id="5149099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149103">s</span>&nbsp;<span class="op" id="5149105">=</span>&nbsp;<span class="builtinfunc" id="5149107">append</span><span class="op" id="5149113">(</span><span class="ident" id="5149114">s</span><span class="op" id="5149115">,</span>&nbsp;<span class="string" id="5149117">&#34;html_template_cssvaluefilter&#34;</span><span class="op" id="5149147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149150">case</span>&nbsp;<span class="ident" id="5149155">stateText</span><span class="op" id="5149164">:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149168">s</span>&nbsp;<span class="op" id="5149170">=</span>&nbsp;<span class="builtinfunc" id="5149172">append</span><span class="op" id="5149178">(</span><span class="ident" id="5149179">s</span><span class="op" id="5149180">,</span>&nbsp;<span class="string" id="5149182">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5149209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149212">case</span>&nbsp;<span class="ident" id="5149217">stateRCDATA</span><span class="op" id="5149228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149232">s</span>&nbsp;<span class="op" id="5149234">=</span>&nbsp;<span class="builtinfunc" id="5149236">append</span><span class="op" id="5149242">(</span><span class="ident" id="5149243">s</span><span class="op" id="5149244">,</span>&nbsp;<span class="string" id="5149246">&#34;html_template_rcdataescaper&#34;</span><span class="op" id="5149275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149278">case</span>&nbsp;<span class="ident" id="5149283">stateAttr</span><span class="op" id="5149292">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149296">//&nbsp;Handled&nbsp;below&nbsp;in&nbsp;delim&nbsp;check.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149330">case</span>&nbsp;<span class="ident" id="5149335">stateAttrName</span><span class="op" id="5149348">,</span>&nbsp;<span class="ident" id="5149350">stateTag</span><span class="op" id="5149358">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149362">c</span><span class="op" id="5149363">.</span><span class="ident" id="5149364">state</span>&nbsp;<span class="op" id="5149370">=</span>&nbsp;<span class="ident" id="5149372">stateAttrName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149388">s</span>&nbsp;<span class="op" id="5149390">=</span>&nbsp;<span class="builtinfunc" id="5149392">append</span><span class="op" id="5149398">(</span><span class="ident" id="5149399">s</span><span class="op" id="5149400">,</span>&nbsp;<span class="string" id="5149402">&#34;html_template_htmlnamefilter&#34;</span><span class="op" id="5149432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149435">default</span><span class="op" id="5149442">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149446">if</span>&nbsp;<span class="ident" id="5149449">isComment</span><span class="op" id="5149458">(</span><span class="ident" id="5149459">c</span><span class="op" id="5149460">.</span><span class="ident" id="5149461">state</span><span class="op" id="5149466">)</span>&nbsp;<span class="op" id="5149468">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149473">s</span>&nbsp;<span class="op" id="5149475">=</span>&nbsp;<span class="builtinfunc" id="5149477">append</span><span class="op" id="5149483">(</span><span class="ident" id="5149484">s</span><span class="op" id="5149485">,</span>&nbsp;<span class="string" id="5149487">&#34;html_template_commentescaper&#34;</span><span class="op" id="5149517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149521">}</span>&nbsp;<span class="keyword" id="5149523">else</span>&nbsp;<span class="op" id="5149528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5149533">panic</span><span class="op" id="5149538">(</span><span class="string" id="5149539">&#34;unexpected&nbsp;state&nbsp;&#34;</span>&nbsp;<span class="op" id="5149559">+</span>&nbsp;<span class="ident" id="5149561">c</span><span class="op" id="5149562">.</span><span class="ident" id="5149563">state</span><span class="op" id="5149568">.</span><span class="ident" id="5149569">String</span><span class="op" id="5149575">(</span><span class="op" id="5149576">)</span><span class="op" id="5149577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149584">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149587">switch</span>&nbsp;<span class="ident" id="5149594">c</span><span class="op" id="5149595">.</span><span class="ident" id="5149596">delim</span>&nbsp;<span class="op" id="5149602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149605">case</span>&nbsp;<span class="ident" id="5149610">delimNone</span><span class="op" id="5149619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5149623">//&nbsp;No&nbsp;extra-escaping&nbsp;needed&nbsp;for&nbsp;raw&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149674">case</span>&nbsp;<span class="ident" id="5149679">delimSpaceOrTagEnd</span><span class="op" id="5149697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149701">s</span>&nbsp;<span class="op" id="5149703">=</span>&nbsp;<span class="builtinfunc" id="5149705">append</span><span class="op" id="5149711">(</span><span class="ident" id="5149712">s</span><span class="op" id="5149713">,</span>&nbsp;<span class="string" id="5149715">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5149745">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149748">default</span><span class="op" id="5149755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149759">s</span>&nbsp;<span class="op" id="5149761">=</span>&nbsp;<span class="builtinfunc" id="5149763">append</span><span class="op" id="5149769">(</span><span class="ident" id="5149770">s</span><span class="op" id="5149771">,</span>&nbsp;<span class="string" id="5149773">&#34;html_template_attrescaper&#34;</span><span class="op" id="5149800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5149803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5149806">e</span><span class="op" id="5149807">.</span><span class="ident" id="5149808">editActionNode</span><span class="op" id="5149822">(</span><span class="ident" id="5149823">n</span><span class="op" id="5149824">,</span>&nbsp;<span class="ident" id="5149826">s</span><span class="op" id="5149827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5149830">return</span>&nbsp;<span class="ident" id="5149837">c</span><br>
<span class="lineno">205</span><span class="op" id="5149839">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5149842">//&nbsp;allIdents&nbsp;returns&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;identifiers&nbsp;under&nbsp;the&nbsp;Ident&nbsp;field&nbsp;of&nbsp;the&nbsp;node,</span><br>
<span class="lineno"></span><span class="comment" id="5149927">//&nbsp;which&nbsp;might&nbsp;be&nbsp;a&nbsp;singleton&nbsp;(Identifier)&nbsp;or&nbsp;a&nbsp;slice&nbsp;(Field).</span><br>
<span class="lineno"></span><span class="keyword" id="5149990">func</span>&nbsp;<span class="ident" id="5149995">allIdents</span><span class="op" id="5150004">(</span><span class="ident" id="5150005">node</span>&nbsp;<span class="ident" id="5150010">parse</span><span class="op" id="5150015">.</span><span class="ident" id="5150016">Node</span><span class="op" id="5150020">)</span>&nbsp;<span class="op" id="5150022">[</span><span class="op" id="5150023">]</span><span class="builtintype" id="5150024">string</span>&nbsp;<span class="op" id="5150031">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150034">switch</span>&nbsp;<span class="ident" id="5150041">node</span>&nbsp;<span class="op" id="5150046">:=</span>&nbsp;<span class="ident" id="5150049">node</span><span class="op" id="5150053">.</span><span class="op" id="5150054">(</span><span class="keyword" id="5150055">type</span><span class="op" id="5150059">)</span>&nbsp;<span class="op" id="5150061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150064">case</span>&nbsp;<span class="op" id="5150069">*</span><span class="ident" id="5150070">parse</span><span class="op" id="5150075">.</span><span class="ident" id="5150076">IdentifierNode</span><span class="op" id="5150090">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150094">return</span>&nbsp;<span class="op" id="5150101">[</span><span class="op" id="5150102">]</span><span class="builtintype" id="5150103">string</span><span class="op" id="5150109">{</span><span class="ident" id="5150110">node</span><span class="op" id="5150114">.</span><span class="ident" id="5150115">Ident</span><span class="op" id="5150120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150123">case</span>&nbsp;<span class="op" id="5150128">*</span><span class="ident" id="5150129">parse</span><span class="op" id="5150134">.</span><span class="ident" id="5150135">FieldNode</span><span class="op" id="5150144">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150148">return</span>&nbsp;<span class="ident" id="5150155">node</span><span class="op" id="5150159">.</span><span class="ident" id="5150160">Ident</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5150170">panic</span><span class="op" id="5150175">(</span><span class="string" id="5150176">&#34;unidentified&nbsp;node&nbsp;type&nbsp;in&nbsp;allIdents&#34;</span><span class="op" id="5150213">)</span><br>
<span class="lineno"></span><span class="op" id="5150215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5150218">//&nbsp;ensurePipelineContains&nbsp;ensures&nbsp;that&nbsp;the&nbsp;pipeline&nbsp;has&nbsp;commands&nbsp;with</span><br>
<span class="lineno">220</span><span class="comment" id="5150288">//&nbsp;the&nbsp;identifiers&nbsp;in&nbsp;s&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="comment" id="5150322">//&nbsp;If&nbsp;the&nbsp;pipeline&nbsp;already&nbsp;has&nbsp;some&nbsp;of&nbsp;the&nbsp;sanitizers,&nbsp;do&nbsp;not&nbsp;interfere.</span><br>
<span class="lineno"></span><span class="comment" id="5150395">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;p&nbsp;is&nbsp;(.X&nbsp;|&nbsp;html)&nbsp;and&nbsp;s&nbsp;is&nbsp;[&#34;escapeJSVal&#34;,&nbsp;&#34;html&#34;]&nbsp;then&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="5150472">//&nbsp;has&nbsp;one&nbsp;matching,&nbsp;&#34;html&#34;,&nbsp;and&nbsp;one&nbsp;to&nbsp;insert,&nbsp;&#34;escapeJSVal&#34;,&nbsp;to&nbsp;produce</span><br>
<span class="lineno"></span><span class="comment" id="5150546">//&nbsp;(.X&nbsp;|&nbsp;escapeJSVal&nbsp;|&nbsp;html).</span><br>
<span class="lineno">225</span><span class="keyword" id="5150576">func</span>&nbsp;<span class="ident" id="5150581">ensurePipelineContains</span><span class="op" id="5150603">(</span><span class="ident" id="5150604">p</span>&nbsp;<span class="op" id="5150606">*</span><span class="ident" id="5150607">parse</span><span class="op" id="5150612">.</span><span class="ident" id="5150613">PipeNode</span><span class="op" id="5150621">,</span>&nbsp;<span class="ident" id="5150623">s</span>&nbsp;<span class="op" id="5150625">[</span><span class="op" id="5150626">]</span><span class="builtintype" id="5150627">string</span><span class="op" id="5150633">)</span>&nbsp;<span class="op" id="5150635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150638">if</span>&nbsp;<span class="builtinfunc" id="5150641">len</span><span class="op" id="5150644">(</span><span class="ident" id="5150645">s</span><span class="op" id="5150646">)</span>&nbsp;<span class="op" id="5150648">==</span>&nbsp;<span class="num" id="5150651">0</span>&nbsp;<span class="op" id="5150653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150657">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150665">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150668">n</span>&nbsp;<span class="op" id="5150670">:=</span>&nbsp;<span class="builtinfunc" id="5150673">len</span><span class="op" id="5150676">(</span><span class="ident" id="5150677">p</span><span class="op" id="5150678">.</span><span class="ident" id="5150679">Cmds</span><span class="op" id="5150683">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5150686">//&nbsp;Find&nbsp;the&nbsp;identifiers&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;chain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150744">idents</span>&nbsp;<span class="op" id="5150751">:=</span>&nbsp;<span class="ident" id="5150754">p</span><span class="op" id="5150755">.</span><span class="ident" id="5150756">Cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150762">for</span>&nbsp;<span class="ident" id="5150766">i</span>&nbsp;<span class="op" id="5150768">:=</span>&nbsp;<span class="ident" id="5150771">n</span>&nbsp;<span class="op" id="5150773">-</span>&nbsp;<span class="num" id="5150775">1</span><span class="op" id="5150776">;</span>&nbsp;<span class="ident" id="5150778">i</span>&nbsp;<span class="op" id="5150780">&gt;=</span>&nbsp;<span class="num" id="5150783">0</span><span class="op" id="5150784">;</span>&nbsp;<span class="ident" id="5150786">i</span><span class="op" id="5150787">--</span>&nbsp;<span class="op" id="5150790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150794">if</span>&nbsp;<span class="ident" id="5150797">cmd</span>&nbsp;<span class="op" id="5150801">:=</span>&nbsp;<span class="ident" id="5150804">p</span><span class="op" id="5150805">.</span><span class="ident" id="5150806">Cmds</span><span class="op" id="5150810">[</span><span class="ident" id="5150811">i</span><span class="op" id="5150812">]</span><span class="op" id="5150813">;</span>&nbsp;<span class="builtinfunc" id="5150815">len</span><span class="op" id="5150818">(</span><span class="ident" id="5150819">cmd</span><span class="op" id="5150822">.</span><span class="ident" id="5150823">Args</span><span class="op" id="5150827">)</span>&nbsp;<span class="op" id="5150829">!=</span>&nbsp;<span class="num" id="5150832">0</span>&nbsp;<span class="op" id="5150834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150839">if</span>&nbsp;<span class="ident" id="5150842">_</span><span class="op" id="5150843">,</span>&nbsp;<span class="ident" id="5150845">ok</span>&nbsp;<span class="op" id="5150848">:=</span>&nbsp;<span class="ident" id="5150851">cmd</span><span class="op" id="5150854">.</span><span class="ident" id="5150855">Args</span><span class="op" id="5150859">[</span><span class="num" id="5150860">0</span><span class="op" id="5150861">]</span><span class="op" id="5150862">.</span><span class="op" id="5150863">(</span><span class="op" id="5150864">*</span><span class="ident" id="5150865">parse</span><span class="op" id="5150870">.</span><span class="ident" id="5150871">IdentifierNode</span><span class="op" id="5150885">)</span><span class="op" id="5150886">;</span>&nbsp;<span class="ident" id="5150888">ok</span>&nbsp;<span class="op" id="5150891">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150897">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150909">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150917">idents</span>&nbsp;<span class="op" id="5150924">=</span>&nbsp;<span class="ident" id="5150926">p</span><span class="op" id="5150927">.</span><span class="ident" id="5150928">Cmds</span><span class="op" id="5150932">[</span><span class="ident" id="5150933">i</span><span class="op" id="5150934">+</span><span class="num" id="5150935">1</span><span class="op" id="5150936">:</span><span class="op" id="5150937">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5150940">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5150943">dups</span>&nbsp;<span class="op" id="5150948">:=</span>&nbsp;<span class="num" id="5150951">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150954">for</span>&nbsp;<span class="ident" id="5150958">_</span><span class="op" id="5150959">,</span>&nbsp;<span class="ident" id="5150961">idNode</span>&nbsp;<span class="op" id="5150968">:=</span>&nbsp;<span class="keyword" id="5150971">range</span>&nbsp;<span class="ident" id="5150977">idents</span>&nbsp;<span class="op" id="5150984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5150988">for</span>&nbsp;<span class="ident" id="5150992">_</span><span class="op" id="5150993">,</span>&nbsp;<span class="ident" id="5150995">ident</span>&nbsp;<span class="op" id="5151001">:=</span>&nbsp;<span class="keyword" id="5151004">range</span>&nbsp;<span class="ident" id="5151010">allIdents</span><span class="op" id="5151019">(</span><span class="ident" id="5151020">idNode</span><span class="op" id="5151026">.</span><span class="ident" id="5151027">Args</span><span class="op" id="5151031">[</span><span class="num" id="5151032">0</span><span class="op" id="5151033">]</span><span class="op" id="5151034">)</span>&nbsp;<span class="op" id="5151036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151041">if</span>&nbsp;<span class="ident" id="5151044">escFnsEq</span><span class="op" id="5151052">(</span><span class="ident" id="5151053">s</span><span class="op" id="5151054">[</span><span class="ident" id="5151055">dups</span><span class="op" id="5151059">]</span><span class="op" id="5151060">,</span>&nbsp;<span class="ident" id="5151062">ident</span><span class="op" id="5151067">)</span>&nbsp;<span class="op" id="5151069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151075">dups</span><span class="op" id="5151079">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151086">if</span>&nbsp;<span class="ident" id="5151089">dups</span>&nbsp;<span class="op" id="5151094">==</span>&nbsp;<span class="builtinfunc" id="5151097">len</span><span class="op" id="5151100">(</span><span class="ident" id="5151101">s</span><span class="op" id="5151102">)</span>&nbsp;<span class="op" id="5151104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151111">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151131">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151137">newCmds</span>&nbsp;<span class="op" id="5151145">:=</span>&nbsp;<span class="builtinfunc" id="5151148">make</span><span class="op" id="5151152">(</span><span class="op" id="5151153">[</span><span class="op" id="5151154">]</span><span class="op" id="5151155">*</span><span class="ident" id="5151156">parse</span><span class="op" id="5151161">.</span><span class="ident" id="5151162">CommandNode</span><span class="op" id="5151173">,</span>&nbsp;<span class="ident" id="5151175">n</span><span class="op" id="5151176">-</span><span class="builtinfunc" id="5151177">len</span><span class="op" id="5151180">(</span><span class="ident" id="5151181">idents</span><span class="op" id="5151187">)</span><span class="op" id="5151188">,</span>&nbsp;<span class="ident" id="5151190">n</span><span class="op" id="5151191">+</span><span class="builtinfunc" id="5151192">len</span><span class="op" id="5151195">(</span><span class="ident" id="5151196">s</span><span class="op" id="5151197">)</span><span class="op" id="5151198">-</span><span class="ident" id="5151199">dups</span><span class="op" id="5151203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5151206">copy</span><span class="op" id="5151210">(</span><span class="ident" id="5151211">newCmds</span><span class="op" id="5151218">,</span>&nbsp;<span class="ident" id="5151220">p</span><span class="op" id="5151221">.</span><span class="ident" id="5151222">Cmds</span><span class="op" id="5151226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5151229">//&nbsp;Merge&nbsp;existing&nbsp;identifier&nbsp;commands&nbsp;with&nbsp;the&nbsp;sanitizers&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151296">for</span>&nbsp;<span class="ident" id="5151300">_</span><span class="op" id="5151301">,</span>&nbsp;<span class="ident" id="5151303">idNode</span>&nbsp;<span class="op" id="5151310">:=</span>&nbsp;<span class="keyword" id="5151313">range</span>&nbsp;<span class="ident" id="5151319">idents</span>&nbsp;<span class="op" id="5151326">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151330">pos</span>&nbsp;<span class="op" id="5151334">:=</span>&nbsp;<span class="ident" id="5151337">idNode</span><span class="op" id="5151343">.</span><span class="ident" id="5151344">Args</span><span class="op" id="5151348">[</span><span class="num" id="5151349">0</span><span class="op" id="5151350">]</span><span class="op" id="5151351">.</span><span class="ident" id="5151352">Position</span><span class="op" id="5151360">(</span><span class="op" id="5151361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151365">for</span>&nbsp;<span class="ident" id="5151369">_</span><span class="op" id="5151370">,</span>&nbsp;<span class="ident" id="5151372">ident</span>&nbsp;<span class="op" id="5151378">:=</span>&nbsp;<span class="keyword" id="5151381">range</span>&nbsp;<span class="ident" id="5151387">allIdents</span><span class="op" id="5151396">(</span><span class="ident" id="5151397">idNode</span><span class="op" id="5151403">.</span><span class="ident" id="5151404">Args</span><span class="op" id="5151408">[</span><span class="num" id="5151409">0</span><span class="op" id="5151410">]</span><span class="op" id="5151411">)</span>&nbsp;<span class="op" id="5151413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151418">i</span>&nbsp;<span class="op" id="5151420">:=</span>&nbsp;<span class="ident" id="5151423">indexOfStr</span><span class="op" id="5151433">(</span><span class="ident" id="5151434">ident</span><span class="op" id="5151439">,</span>&nbsp;<span class="ident" id="5151441">s</span><span class="op" id="5151442">,</span>&nbsp;<span class="ident" id="5151444">escFnsEq</span><span class="op" id="5151452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151457">if</span>&nbsp;<span class="ident" id="5151460">i</span>&nbsp;<span class="op" id="5151462">!=</span>&nbsp;<span class="op" id="5151465">-</span><span class="num" id="5151466">1</span>&nbsp;<span class="op" id="5151468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151474">for</span>&nbsp;<span class="ident" id="5151478">_</span><span class="op" id="5151479">,</span>&nbsp;<span class="ident" id="5151481">name</span>&nbsp;<span class="op" id="5151486">:=</span>&nbsp;<span class="keyword" id="5151489">range</span>&nbsp;<span class="ident" id="5151495">s</span><span class="op" id="5151496">[</span><span class="op" id="5151497">:</span><span class="ident" id="5151498">i</span><span class="op" id="5151499">]</span>&nbsp;<span class="op" id="5151501">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151508">newCmds</span>&nbsp;<span class="op" id="5151516">=</span>&nbsp;<span class="ident" id="5151518">appendCmd</span><span class="op" id="5151527">(</span><span class="ident" id="5151528">newCmds</span><span class="op" id="5151535">,</span>&nbsp;<span class="ident" id="5151537">newIdentCmd</span><span class="op" id="5151548">(</span><span class="ident" id="5151549">name</span><span class="op" id="5151553">,</span>&nbsp;<span class="ident" id="5151555">pos</span><span class="op" id="5151558">)</span><span class="op" id="5151559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151571">s</span>&nbsp;<span class="op" id="5151573">=</span>&nbsp;<span class="ident" id="5151575">s</span><span class="op" id="5151576">[</span><span class="ident" id="5151577">i</span><span class="op" id="5151578">+</span><span class="num" id="5151579">1</span><span class="op" id="5151580">:</span><span class="op" id="5151581">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151590">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151594">newCmds</span>&nbsp;<span class="op" id="5151602">=</span>&nbsp;<span class="ident" id="5151604">appendCmd</span><span class="op" id="5151613">(</span><span class="ident" id="5151614">newCmds</span><span class="op" id="5151621">,</span>&nbsp;<span class="ident" id="5151623">idNode</span><span class="op" id="5151629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5151635">//&nbsp;Create&nbsp;any&nbsp;remaining&nbsp;sanitizers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5151672">for</span>&nbsp;<span class="ident" id="5151676">_</span><span class="op" id="5151677">,</span>&nbsp;<span class="ident" id="5151679">name</span>&nbsp;<span class="op" id="5151684">:=</span>&nbsp;<span class="keyword" id="5151687">range</span>&nbsp;<span class="ident" id="5151693">s</span>&nbsp;<span class="op" id="5151695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151699">newCmds</span>&nbsp;<span class="op" id="5151707">=</span>&nbsp;<span class="ident" id="5151709">appendCmd</span><span class="op" id="5151718">(</span><span class="ident" id="5151719">newCmds</span><span class="op" id="5151726">,</span>&nbsp;<span class="ident" id="5151728">newIdentCmd</span><span class="op" id="5151739">(</span><span class="ident" id="5151740">name</span><span class="op" id="5151744">,</span>&nbsp;<span class="ident" id="5151746">p</span><span class="op" id="5151747">.</span><span class="ident" id="5151748">Position</span><span class="op" id="5151756">(</span><span class="op" id="5151757">)</span><span class="op" id="5151758">)</span><span class="op" id="5151759">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5151762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5151765">p</span><span class="op" id="5151766">.</span><span class="ident" id="5151767">Cmds</span>&nbsp;<span class="op" id="5151772">=</span>&nbsp;<span class="ident" id="5151774">newCmds</span><br>
<span class="lineno"></span><span class="op" id="5151782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5151785">//&nbsp;redundantFuncs[a][b]&nbsp;implies&nbsp;that&nbsp;funcMap[b](funcMap[a](x))&nbsp;==&nbsp;funcMap[a](x)</span><br>
<span class="lineno">275</span><span class="comment" id="5151865">//&nbsp;for&nbsp;all&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword" id="5151879">var</span>&nbsp;<span class="ident" id="5151883">redundantFuncs</span>&nbsp;<span class="op" id="5151898">=</span>&nbsp;<span class="keyword" id="5151900">map</span><span class="op" id="5151903">[</span><span class="builtintype" id="5151904">string</span><span class="op" id="5151910">]</span><span class="keyword" id="5151911">map</span><span class="op" id="5151914">[</span><span class="builtintype" id="5151915">string</span><span class="op" id="5151921">]</span><span class="builtintype" id="5151922">bool</span><span class="op" id="5151926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5151929">&#34;html_template_commentescaper&#34;</span><span class="op" id="5151959">:</span>&nbsp;<span class="op" id="5151961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5151965">&#34;html_template_attrescaper&#34;</span><span class="op" id="5151992">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5151997">true</span><span class="op" id="5152001">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152005">&#34;html_template_nospaceescaper&#34;</span><span class="op" id="5152035">:</span>&nbsp;<span class="builtintype" id="5152037">true</span><span class="op" id="5152041">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152045">&#34;html_template_htmlescaper&#34;</span><span class="op" id="5152072">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5152077">true</span><span class="op" id="5152081">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152084">}</span><span class="op" id="5152085">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152088">&#34;html_template_cssescaper&#34;</span><span class="op" id="5152114">:</span>&nbsp;<span class="op" id="5152116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152120">&#34;html_template_attrescaper&#34;</span><span class="op" id="5152147">:</span>&nbsp;<span class="builtintype" id="5152149">true</span><span class="op" id="5152153">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152156">}</span><span class="op" id="5152157">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152160">&#34;html_template_jsregexpescaper&#34;</span><span class="op" id="5152191">:</span>&nbsp;<span class="op" id="5152193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152197">&#34;html_template_attrescaper&#34;</span><span class="op" id="5152224">:</span>&nbsp;<span class="builtintype" id="5152226">true</span><span class="op" id="5152230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152233">}</span><span class="op" id="5152234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152237">&#34;html_template_jsstrescaper&#34;</span><span class="op" id="5152265">:</span>&nbsp;<span class="op" id="5152267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152271">&#34;html_template_attrescaper&#34;</span><span class="op" id="5152298">:</span>&nbsp;<span class="builtintype" id="5152300">true</span><span class="op" id="5152304">,</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152307">}</span><span class="op" id="5152308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152311">&#34;html_template_urlescaper&#34;</span><span class="op" id="5152337">:</span>&nbsp;<span class="op" id="5152339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5152343">&#34;html_template_urlnormalizer&#34;</span><span class="op" id="5152372">:</span>&nbsp;<span class="builtintype" id="5152374">true</span><span class="op" id="5152378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152381">}</span><span class="op" id="5152382">,</span><br>
<span class="lineno"></span><span class="op" id="5152384">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span><span class="comment" id="5152387">//&nbsp;appendCmd&nbsp;appends&nbsp;the&nbsp;given&nbsp;command&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;command&nbsp;pipeline</span><br>
<span class="lineno"></span><span class="comment" id="5152461">//&nbsp;unless&nbsp;it&nbsp;is&nbsp;redundant&nbsp;with&nbsp;the&nbsp;last&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="5152510">func</span>&nbsp;<span class="ident" id="5152515">appendCmd</span><span class="op" id="5152524">(</span><span class="ident" id="5152525">cmds</span>&nbsp;<span class="op" id="5152530">[</span><span class="op" id="5152531">]</span><span class="op" id="5152532">*</span><span class="ident" id="5152533">parse</span><span class="op" id="5152538">.</span><span class="ident" id="5152539">CommandNode</span><span class="op" id="5152550">,</span>&nbsp;<span class="ident" id="5152552">cmd</span>&nbsp;<span class="op" id="5152556">*</span><span class="ident" id="5152557">parse</span><span class="op" id="5152562">.</span><span class="ident" id="5152563">CommandNode</span><span class="op" id="5152574">)</span>&nbsp;<span class="op" id="5152576">[</span><span class="op" id="5152577">]</span><span class="op" id="5152578">*</span><span class="ident" id="5152579">parse</span><span class="op" id="5152584">.</span><span class="ident" id="5152585">CommandNode</span>&nbsp;<span class="op" id="5152597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152600">if</span>&nbsp;<span class="ident" id="5152603">n</span>&nbsp;<span class="op" id="5152605">:=</span>&nbsp;<span class="builtinfunc" id="5152608">len</span><span class="op" id="5152611">(</span><span class="ident" id="5152612">cmds</span><span class="op" id="5152616">)</span><span class="op" id="5152617">;</span>&nbsp;<span class="ident" id="5152619">n</span>&nbsp;<span class="op" id="5152621">!=</span>&nbsp;<span class="num" id="5152624">0</span>&nbsp;<span class="op" id="5152626">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152630">last</span><span class="op" id="5152634">,</span>&nbsp;<span class="ident" id="5152636">ok</span>&nbsp;<span class="op" id="5152639">:=</span>&nbsp;<span class="ident" id="5152642">cmds</span><span class="op" id="5152646">[</span><span class="ident" id="5152647">n</span><span class="op" id="5152648">-</span><span class="num" id="5152649">1</span><span class="op" id="5152650">]</span><span class="op" id="5152651">.</span><span class="ident" id="5152652">Args</span><span class="op" id="5152656">[</span><span class="num" id="5152657">0</span><span class="op" id="5152658">]</span><span class="op" id="5152659">.</span><span class="op" id="5152660">(</span><span class="op" id="5152661">*</span><span class="ident" id="5152662">parse</span><span class="op" id="5152667">.</span><span class="ident" id="5152668">IdentifierNode</span><span class="op" id="5152682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5152686">next</span><span class="op" id="5152690">,</span>&nbsp;<span class="ident" id="5152692">_</span>&nbsp;<span class="op" id="5152694">:=</span>&nbsp;<span class="ident" id="5152697">cmd</span><span class="op" id="5152700">.</span><span class="ident" id="5152701">Args</span><span class="op" id="5152705">[</span><span class="num" id="5152706">0</span><span class="op" id="5152707">]</span><span class="op" id="5152708">.</span><span class="op" id="5152709">(</span><span class="op" id="5152710">*</span><span class="ident" id="5152711">parse</span><span class="op" id="5152716">.</span><span class="ident" id="5152717">IdentifierNode</span><span class="op" id="5152731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152735">if</span>&nbsp;<span class="ident" id="5152738">ok</span>&nbsp;<span class="op" id="5152741">&amp;&amp;</span>&nbsp;<span class="ident" id="5152744">redundantFuncs</span><span class="op" id="5152758">[</span><span class="ident" id="5152759">last</span><span class="op" id="5152763">.</span><span class="ident" id="5152764">Ident</span><span class="op" id="5152769">]</span><span class="op" id="5152770">[</span><span class="ident" id="5152771">next</span><span class="op" id="5152775">.</span><span class="ident" id="5152776">Ident</span><span class="op" id="5152781">]</span>&nbsp;<span class="op" id="5152783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152788">return</span>&nbsp;<span class="ident" id="5152795">cmds</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152802">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5152805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152808">return</span>&nbsp;<span class="builtinfunc" id="5152815">append</span><span class="op" id="5152821">(</span><span class="ident" id="5152822">cmds</span><span class="op" id="5152826">,</span>&nbsp;<span class="ident" id="5152828">cmd</span><span class="op" id="5152831">)</span><br>
<span class="lineno"></span><span class="op" id="5152833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5152836">//&nbsp;indexOfStr&nbsp;is&nbsp;the&nbsp;first&nbsp;i&nbsp;such&nbsp;that&nbsp;eq(s,&nbsp;strs[i])&nbsp;or&nbsp;-1&nbsp;if&nbsp;s&nbsp;was&nbsp;not&nbsp;found.</span><br>
<span class="lineno">310</span><span class="keyword" id="5152916">func</span>&nbsp;<span class="ident" id="5152921">indexOfStr</span><span class="op" id="5152931">(</span><span class="ident" id="5152932">s</span>&nbsp;<span class="builtintype" id="5152934">string</span><span class="op" id="5152940">,</span>&nbsp;<span class="ident" id="5152942">strs</span>&nbsp;<span class="op" id="5152947">[</span><span class="op" id="5152948">]</span><span class="builtintype" id="5152949">string</span><span class="op" id="5152955">,</span>&nbsp;<span class="ident" id="5152957">eq</span>&nbsp;<span class="keyword" id="5152960">func</span><span class="op" id="5152964">(</span><span class="ident" id="5152965">a</span><span class="op" id="5152966">,</span>&nbsp;<span class="ident" id="5152968">b</span>&nbsp;<span class="builtintype" id="5152970">string</span><span class="op" id="5152976">)</span>&nbsp;<span class="builtintype" id="5152978">bool</span><span class="op" id="5152982">)</span>&nbsp;<span class="builtintype" id="5152984">int</span>&nbsp;<span class="op" id="5152988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5152991">for</span>&nbsp;<span class="ident" id="5152995">i</span><span class="op" id="5152996">,</span>&nbsp;<span class="ident" id="5152998">t</span>&nbsp;<span class="op" id="5153000">:=</span>&nbsp;<span class="keyword" id="5153003">range</span>&nbsp;<span class="ident" id="5153009">strs</span>&nbsp;<span class="op" id="5153014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153018">if</span>&nbsp;<span class="ident" id="5153021">eq</span><span class="op" id="5153023">(</span><span class="ident" id="5153024">s</span><span class="op" id="5153025">,</span>&nbsp;<span class="ident" id="5153027">t</span><span class="op" id="5153028">)</span>&nbsp;<span class="op" id="5153030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153035">return</span>&nbsp;<span class="ident" id="5153042">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153046">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153052">return</span>&nbsp;<span class="op" id="5153059">-</span><span class="num" id="5153060">1</span><br>
<span class="lineno"></span><span class="op" id="5153062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5153065">//&nbsp;escFnsEq&nbsp;reports&nbsp;whether&nbsp;the&nbsp;two&nbsp;escaping&nbsp;functions&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno">320</span><span class="keyword" id="5153136">func</span>&nbsp;<span class="ident" id="5153141">escFnsEq</span><span class="op" id="5153149">(</span><span class="ident" id="5153150">a</span><span class="op" id="5153151">,</span>&nbsp;<span class="ident" id="5153153">b</span>&nbsp;<span class="builtintype" id="5153155">string</span><span class="op" id="5153161">)</span>&nbsp;<span class="builtintype" id="5153163">bool</span>&nbsp;<span class="op" id="5153168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153171">if</span>&nbsp;<span class="ident" id="5153174">e</span>&nbsp;<span class="op" id="5153176">:=</span>&nbsp;<span class="ident" id="5153179">equivEscapers</span><span class="op" id="5153192">[</span><span class="ident" id="5153193">a</span><span class="op" id="5153194">]</span><span class="op" id="5153195">;</span>&nbsp;<span class="ident" id="5153197">e</span>&nbsp;<span class="op" id="5153199">!=</span>&nbsp;<span class="string" id="5153202">&#34;&#34;</span>&nbsp;<span class="op" id="5153205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153209">a</span>&nbsp;<span class="op" id="5153211">=</span>&nbsp;<span class="ident" id="5153213">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153219">if</span>&nbsp;<span class="ident" id="5153222">e</span>&nbsp;<span class="op" id="5153224">:=</span>&nbsp;<span class="ident" id="5153227">equivEscapers</span><span class="op" id="5153240">[</span><span class="ident" id="5153241">b</span><span class="op" id="5153242">]</span><span class="op" id="5153243">;</span>&nbsp;<span class="ident" id="5153245">e</span>&nbsp;<span class="op" id="5153247">!=</span>&nbsp;<span class="string" id="5153250">&#34;&#34;</span>&nbsp;<span class="op" id="5153253">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153257">b</span>&nbsp;<span class="op" id="5153259">=</span>&nbsp;<span class="ident" id="5153261">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153264">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153267">return</span>&nbsp;<span class="ident" id="5153274">a</span>&nbsp;<span class="op" id="5153276">==</span>&nbsp;<span class="ident" id="5153279">b</span><br>
<span class="lineno"></span><span class="op" id="5153281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span><span class="comment" id="5153284">//&nbsp;newIdentCmd&nbsp;produces&nbsp;a&nbsp;command&nbsp;containing&nbsp;a&nbsp;single&nbsp;identifier&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5153355">func</span>&nbsp;<span class="ident" id="5153360">newIdentCmd</span><span class="op" id="5153371">(</span><span class="ident" id="5153372">identifier</span>&nbsp;<span class="builtintype" id="5153383">string</span><span class="op" id="5153389">,</span>&nbsp;<span class="ident" id="5153391">pos</span>&nbsp;<span class="ident" id="5153395">parse</span><span class="op" id="5153400">.</span><span class="ident" id="5153401">Pos</span><span class="op" id="5153404">)</span>&nbsp;<span class="op" id="5153406">*</span><span class="ident" id="5153407">parse</span><span class="op" id="5153412">.</span><span class="ident" id="5153413">CommandNode</span>&nbsp;<span class="op" id="5153425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5153428">return</span>&nbsp;<span class="op" id="5153435">&amp;</span><span class="ident" id="5153436">parse</span><span class="op" id="5153441">.</span><span class="ident" id="5153442">CommandNode</span><span class="op" id="5153453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153457">NodeType</span><span class="op" id="5153465">:</span>&nbsp;<span class="ident" id="5153467">parse</span><span class="op" id="5153472">.</span><span class="ident" id="5153473">NodeCommand</span><span class="op" id="5153484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5153488">Args</span><span class="op" id="5153492">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153498">[</span><span class="op" id="5153499">]</span><span class="ident" id="5153500">parse</span><span class="op" id="5153505">.</span><span class="ident" id="5153506">Node</span><span class="op" id="5153510">{</span><span class="ident" id="5153511">parse</span><span class="op" id="5153516">.</span><span class="ident" id="5153517">NewIdentifier</span><span class="op" id="5153530">(</span><span class="ident" id="5153531">identifier</span><span class="op" id="5153541">)</span><span class="op" id="5153542">.</span><span class="ident" id="5153543">SetTree</span><span class="op" id="5153550">(</span><span class="ident" id="5153551">nil</span><span class="op" id="5153554">)</span><span class="op" id="5153555">.</span><span class="ident" id="5153556">SetPos</span><span class="op" id="5153562">(</span><span class="ident" id="5153563">pos</span><span class="op" id="5153566">)</span><span class="op" id="5153567">}</span><span class="op" id="5153568">,</span>&nbsp;<span class="comment" id="5153570">//&nbsp;TODO:&nbsp;SetTree.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5153589">}</span><br>
<span class="lineno"></span><span class="op" id="5153591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5153594">//&nbsp;nudge&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;would&nbsp;result&nbsp;from&nbsp;following&nbsp;empty&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5153669">//&nbsp;transitions&nbsp;from&nbsp;the&nbsp;input&nbsp;context.</span><br>
<span class="lineno">340</span><span class="comment" id="5153708">//&nbsp;For&nbsp;example,&nbsp;parsing:</span><br>
<span class="lineno"></span><span class="comment" id="5153733">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=`</span><br>
<span class="lineno"></span><span class="comment" id="5153751">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateBeforeValue,&nbsp;attrURL},&nbsp;but&nbsp;parsing&nbsp;one&nbsp;extra&nbsp;rune:</span><br>
<span class="lineno"></span><span class="comment" id="5153830">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`&lt;a&nbsp;href=x`</span><br>
<span class="lineno"></span><span class="comment" id="5153849">//&nbsp;will&nbsp;end&nbsp;in&nbsp;context{stateURL,&nbsp;delimSpaceOrTagEnd,&nbsp;...}.</span><br>
<span class="lineno">345</span><span class="comment" id="5153908">//&nbsp;There&nbsp;are&nbsp;two&nbsp;transitions&nbsp;that&nbsp;happen&nbsp;when&nbsp;the&nbsp;&#39;x&#39;&nbsp;is&nbsp;seen:</span><br>
<span class="lineno"></span><span class="comment" id="5153971">//&nbsp;(1)&nbsp;Transition&nbsp;from&nbsp;a&nbsp;before-value&nbsp;state&nbsp;to&nbsp;a&nbsp;start-of-value&nbsp;state&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="5154049">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consuming&nbsp;any&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5154081">//&nbsp;(2)&nbsp;Consume&nbsp;&#39;x&#39;&nbsp;and&nbsp;transition&nbsp;past&nbsp;the&nbsp;first&nbsp;value&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5154147">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;nudging&nbsp;produces&nbsp;the&nbsp;context&nbsp;after&nbsp;(1)&nbsp;happens.</span><br>
<span class="lineno">350</span><span class="keyword" id="5154212">func</span>&nbsp;<span class="ident" id="5154217">nudge</span><span class="op" id="5154222">(</span><span class="ident" id="5154223">c</span>&nbsp;<span class="ident" id="5154225">context</span><span class="op" id="5154232">)</span>&nbsp;<span class="ident" id="5154234">context</span>&nbsp;<span class="op" id="5154242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154245">switch</span>&nbsp;<span class="ident" id="5154252">c</span><span class="op" id="5154253">.</span><span class="ident" id="5154254">state</span>&nbsp;<span class="op" id="5154260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154263">case</span>&nbsp;<span class="ident" id="5154268">stateTag</span><span class="op" id="5154276">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5154280">//&nbsp;In&nbsp;`&lt;foo&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;should&nbsp;emit&nbsp;an&nbsp;attribute.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154339">c</span><span class="op" id="5154340">.</span><span class="ident" id="5154341">state</span>&nbsp;<span class="op" id="5154347">=</span>&nbsp;<span class="ident" id="5154349">stateAttrName</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154364">case</span>&nbsp;<span class="ident" id="5154369">stateBeforeValue</span><span class="op" id="5154385">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5154389">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar={{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;undelimited&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154451">c</span><span class="op" id="5154452">.</span><span class="ident" id="5154453">state</span><span class="op" id="5154458">,</span>&nbsp;<span class="ident" id="5154460">c</span><span class="op" id="5154461">.</span><span class="ident" id="5154462">delim</span><span class="op" id="5154467">,</span>&nbsp;<span class="ident" id="5154469">c</span><span class="op" id="5154470">.</span><span class="ident" id="5154471">attr</span>&nbsp;<span class="op" id="5154476">=</span>&nbsp;<span class="ident" id="5154478">attrStartStates</span><span class="op" id="5154493">[</span><span class="ident" id="5154494">c</span><span class="op" id="5154495">.</span><span class="ident" id="5154496">attr</span><span class="op" id="5154500">]</span><span class="op" id="5154501">,</span>&nbsp;<span class="ident" id="5154503">delimSpaceOrTagEnd</span><span class="op" id="5154521">,</span>&nbsp;<span class="ident" id="5154523">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154533">case</span>&nbsp;<span class="ident" id="5154538">stateAfterName</span><span class="op" id="5154552">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5154556">//&nbsp;In&nbsp;`&lt;foo&nbsp;bar&nbsp;{{.}}`,&nbsp;the&nbsp;action&nbsp;is&nbsp;an&nbsp;attribute&nbsp;name.</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5154615">c</span><span class="op" id="5154616">.</span><span class="ident" id="5154617">state</span><span class="op" id="5154622">,</span>&nbsp;<span class="ident" id="5154624">c</span><span class="op" id="5154625">.</span><span class="ident" id="5154626">attr</span>&nbsp;<span class="op" id="5154631">=</span>&nbsp;<span class="ident" id="5154633">stateAttrName</span><span class="op" id="5154646">,</span>&nbsp;<span class="ident" id="5154648">attrNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154661">return</span>&nbsp;<span class="ident" id="5154668">c</span><br>
<span class="lineno"></span><span class="op" id="5154670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment" id="5154673">//&nbsp;join&nbsp;joins&nbsp;the&nbsp;two&nbsp;contexts&nbsp;of&nbsp;a&nbsp;branch&nbsp;template&nbsp;node.&nbsp;The&nbsp;result&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="5154748">//&nbsp;error&nbsp;context&nbsp;if&nbsp;either&nbsp;of&nbsp;the&nbsp;input&nbsp;contexts&nbsp;are&nbsp;error&nbsp;contexts,&nbsp;or&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5154827">//&nbsp;the&nbsp;input&nbsp;contexts&nbsp;differ.</span><br>
<span class="lineno"></span><span class="keyword" id="5154857">func</span>&nbsp;<span class="ident" id="5154862">join</span><span class="op" id="5154866">(</span><span class="ident" id="5154867">a</span><span class="op" id="5154868">,</span>&nbsp;<span class="ident" id="5154870">b</span>&nbsp;<span class="ident" id="5154872">context</span><span class="op" id="5154879">,</span>&nbsp;<span class="ident" id="5154881">node</span>&nbsp;<span class="ident" id="5154886">parse</span><span class="op" id="5154891">.</span><span class="ident" id="5154892">Node</span><span class="op" id="5154896">,</span>&nbsp;<span class="ident" id="5154898">nodeName</span>&nbsp;<span class="builtintype" id="5154907">string</span><span class="op" id="5154913">)</span>&nbsp;<span class="ident" id="5154915">context</span>&nbsp;<span class="op" id="5154923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154926">if</span>&nbsp;<span class="ident" id="5154929">a</span><span class="op" id="5154930">.</span><span class="ident" id="5154931">state</span>&nbsp;<span class="op" id="5154937">==</span>&nbsp;<span class="ident" id="5154940">stateError</span>&nbsp;<span class="op" id="5154951">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154955">return</span>&nbsp;<span class="ident" id="5154962">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5154965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154968">if</span>&nbsp;<span class="ident" id="5154971">b</span><span class="op" id="5154972">.</span><span class="ident" id="5154973">state</span>&nbsp;<span class="op" id="5154979">==</span>&nbsp;<span class="ident" id="5154982">stateError</span>&nbsp;<span class="op" id="5154993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5154997">return</span>&nbsp;<span class="ident" id="5155004">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155007">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155010">if</span>&nbsp;<span class="ident" id="5155013">a</span><span class="op" id="5155014">.</span><span class="ident" id="5155015">eq</span><span class="op" id="5155017">(</span><span class="ident" id="5155018">b</span><span class="op" id="5155019">)</span>&nbsp;<span class="op" id="5155021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155025">return</span>&nbsp;<span class="ident" id="5155032">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155039">c</span>&nbsp;<span class="op" id="5155041">:=</span>&nbsp;<span class="ident" id="5155044">a</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155047">c</span><span class="op" id="5155048">.</span><span class="ident" id="5155049">urlPart</span>&nbsp;<span class="op" id="5155057">=</span>&nbsp;<span class="ident" id="5155059">b</span><span class="op" id="5155060">.</span><span class="ident" id="5155061">urlPart</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155070">if</span>&nbsp;<span class="ident" id="5155073">c</span><span class="op" id="5155074">.</span><span class="ident" id="5155075">eq</span><span class="op" id="5155077">(</span><span class="ident" id="5155078">b</span><span class="op" id="5155079">)</span>&nbsp;<span class="op" id="5155081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155085">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;urlPart.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155127">c</span><span class="op" id="5155128">.</span><span class="ident" id="5155129">urlPart</span>&nbsp;<span class="op" id="5155137">=</span>&nbsp;<span class="ident" id="5155139">urlPartUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155156">return</span>&nbsp;<span class="ident" id="5155163">c</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155166">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155170">c</span>&nbsp;<span class="op" id="5155172">=</span>&nbsp;<span class="ident" id="5155174">a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155177">c</span><span class="op" id="5155178">.</span><span class="ident" id="5155179">jsCtx</span>&nbsp;<span class="op" id="5155185">=</span>&nbsp;<span class="ident" id="5155187">b</span><span class="op" id="5155188">.</span><span class="ident" id="5155189">jsCtx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155196">if</span>&nbsp;<span class="ident" id="5155199">c</span><span class="op" id="5155200">.</span><span class="ident" id="5155201">eq</span><span class="op" id="5155203">(</span><span class="ident" id="5155204">b</span><span class="op" id="5155205">)</span>&nbsp;<span class="op" id="5155207">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155211">//&nbsp;The&nbsp;contexts&nbsp;differ&nbsp;only&nbsp;by&nbsp;jsCtx.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155251">c</span><span class="op" id="5155252">.</span><span class="ident" id="5155253">jsCtx</span>&nbsp;<span class="op" id="5155259">=</span>&nbsp;<span class="ident" id="5155261">jsCtxUnknown</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155276">return</span>&nbsp;<span class="ident" id="5155283">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155290">//&nbsp;Allow&nbsp;a&nbsp;nudged&nbsp;context&nbsp;to&nbsp;join&nbsp;with&nbsp;an&nbsp;unnudged&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155347">//&nbsp;This&nbsp;means&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155367">//&nbsp;&nbsp;&nbsp;&lt;p&nbsp;title={{if&nbsp;.C}}{{.}}{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155404">//&nbsp;ends&nbsp;in&nbsp;an&nbsp;unquoted&nbsp;value&nbsp;state&nbsp;even&nbsp;though&nbsp;the&nbsp;else&nbsp;branch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5155468">//&nbsp;ends&nbsp;in&nbsp;stateBeforeValue.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155498">if</span>&nbsp;<span class="ident" id="5155501">c</span><span class="op" id="5155502">,</span>&nbsp;<span class="ident" id="5155504">d</span>&nbsp;<span class="op" id="5155506">:=</span>&nbsp;<span class="ident" id="5155509">nudge</span><span class="op" id="5155514">(</span><span class="ident" id="5155515">a</span><span class="op" id="5155516">)</span><span class="op" id="5155517">,</span>&nbsp;<span class="ident" id="5155519">nudge</span><span class="op" id="5155524">(</span><span class="ident" id="5155525">b</span><span class="op" id="5155526">)</span><span class="op" id="5155527">;</span>&nbsp;<span class="op" id="5155529">!</span><span class="op" id="5155530">(</span><span class="ident" id="5155531">c</span><span class="op" id="5155532">.</span><span class="ident" id="5155533">eq</span><span class="op" id="5155535">(</span><span class="ident" id="5155536">a</span><span class="op" id="5155537">)</span>&nbsp;<span class="op" id="5155539">&amp;&amp;</span>&nbsp;<span class="ident" id="5155542">d</span><span class="op" id="5155543">.</span><span class="ident" id="5155544">eq</span><span class="op" id="5155546">(</span><span class="ident" id="5155547">b</span><span class="op" id="5155548">)</span><span class="op" id="5155549">)</span>&nbsp;<span class="op" id="5155551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155555">if</span>&nbsp;<span class="ident" id="5155558">e</span>&nbsp;<span class="op" id="5155560">:=</span>&nbsp;<span class="ident" id="5155563">join</span><span class="op" id="5155567">(</span><span class="ident" id="5155568">c</span><span class="op" id="5155569">,</span>&nbsp;<span class="ident" id="5155571">d</span><span class="op" id="5155572">,</span>&nbsp;<span class="ident" id="5155574">node</span><span class="op" id="5155578">,</span>&nbsp;<span class="ident" id="5155580">nodeName</span><span class="op" id="5155588">)</span><span class="op" id="5155589">;</span>&nbsp;<span class="ident" id="5155591">e</span><span class="op" id="5155592">.</span><span class="ident" id="5155593">state</span>&nbsp;<span class="op" id="5155599">!=</span>&nbsp;<span class="ident" id="5155602">stateError</span>&nbsp;<span class="op" id="5155613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155618">return</span>&nbsp;<span class="ident" id="5155625">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155632">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155636">return</span>&nbsp;<span class="ident" id="5155643">context</span><span class="op" id="5155650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155654">state</span><span class="op" id="5155659">:</span>&nbsp;<span class="ident" id="5155661">stateError</span><span class="op" id="5155671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155675">err</span><span class="op" id="5155678">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5155682">errorf</span><span class="op" id="5155688">(</span><span class="ident" id="5155689">ErrBranchEnd</span><span class="op" id="5155701">,</span>&nbsp;<span class="ident" id="5155703">node</span><span class="op" id="5155707">,</span>&nbsp;<span class="num" id="5155709">0</span><span class="op" id="5155710">,</span>&nbsp;<span class="string" id="5155712">&#34;{{%s}}&nbsp;branches&nbsp;end&nbsp;in&nbsp;different&nbsp;contexts:&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="5155763">,</span>&nbsp;<span class="ident" id="5155765">nodeName</span><span class="op" id="5155773">,</span>&nbsp;<span class="ident" id="5155775">a</span><span class="op" id="5155776">,</span>&nbsp;<span class="ident" id="5155778">b</span><span class="op" id="5155779">)</span><span class="op" id="5155780">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5155783">}</span><br>
<span class="lineno">410</span><span class="op" id="5155785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5155788">//&nbsp;escapeBranch&nbsp;escapes&nbsp;a&nbsp;branch&nbsp;template&nbsp;node:&nbsp;&#34;if&#34;,&nbsp;&#34;range&#34;&nbsp;and&nbsp;&#34;with&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="5155862">func</span>&nbsp;<span class="op" id="5155867">(</span><span class="ident" id="5155868">e</span>&nbsp;<span class="op" id="5155870">*</span><span class="ident" id="5155871">escaper</span><span class="op" id="5155878">)</span>&nbsp;<span class="ident" id="5155880">escapeBranch</span><span class="op" id="5155892">(</span><span class="ident" id="5155893">c</span>&nbsp;<span class="ident" id="5155895">context</span><span class="op" id="5155902">,</span>&nbsp;<span class="ident" id="5155904">n</span>&nbsp;<span class="op" id="5155906">*</span><span class="ident" id="5155907">parse</span><span class="op" id="5155912">.</span><span class="ident" id="5155913">BranchNode</span><span class="op" id="5155923">,</span>&nbsp;<span class="ident" id="5155925">nodeName</span>&nbsp;<span class="builtintype" id="5155934">string</span><span class="op" id="5155940">)</span>&nbsp;<span class="ident" id="5155942">context</span>&nbsp;<span class="op" id="5155950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5155953">c0</span>&nbsp;<span class="op" id="5155956">:=</span>&nbsp;<span class="ident" id="5155959">e</span><span class="op" id="5155960">.</span><span class="ident" id="5155961">escapeList</span><span class="op" id="5155971">(</span><span class="ident" id="5155972">c</span><span class="op" id="5155973">,</span>&nbsp;<span class="ident" id="5155975">n</span><span class="op" id="5155976">.</span><span class="ident" id="5155977">List</span><span class="op" id="5155981">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5155984">if</span>&nbsp;<span class="ident" id="5155987">nodeName</span>&nbsp;<span class="op" id="5155996">==</span>&nbsp;<span class="string" id="5155999">&#34;range&#34;</span>&nbsp;<span class="op" id="5156007">&amp;&amp;</span>&nbsp;<span class="ident" id="5156010">c0</span><span class="op" id="5156012">.</span><span class="ident" id="5156013">state</span>&nbsp;<span class="op" id="5156019">!=</span>&nbsp;<span class="ident" id="5156022">stateError</span>&nbsp;<span class="op" id="5156033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156037">//&nbsp;The&nbsp;&#34;true&#34;&nbsp;branch&nbsp;of&nbsp;a&nbsp;&#34;range&#34;&nbsp;node&nbsp;can&nbsp;execute&nbsp;multiple&nbsp;times.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156106">//&nbsp;We&nbsp;check&nbsp;that&nbsp;executing&nbsp;n.List&nbsp;once&nbsp;results&nbsp;in&nbsp;the&nbsp;same&nbsp;context</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156175">//&nbsp;as&nbsp;executing&nbsp;n.List&nbsp;twice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156207">c1</span><span class="op" id="5156209">,</span>&nbsp;<span class="ident" id="5156211">_</span>&nbsp;<span class="op" id="5156213">:=</span>&nbsp;<span class="ident" id="5156216">e</span><span class="op" id="5156217">.</span><span class="ident" id="5156218">escapeListConditionally</span><span class="op" id="5156241">(</span><span class="ident" id="5156242">c0</span><span class="op" id="5156244">,</span>&nbsp;<span class="ident" id="5156246">n</span><span class="op" id="5156247">.</span><span class="ident" id="5156248">List</span><span class="op" id="5156252">,</span>&nbsp;<span class="ident" id="5156254">nil</span><span class="op" id="5156257">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156261">c0</span>&nbsp;<span class="op" id="5156264">=</span>&nbsp;<span class="ident" id="5156266">join</span><span class="op" id="5156270">(</span><span class="ident" id="5156271">c0</span><span class="op" id="5156273">,</span>&nbsp;<span class="ident" id="5156275">c1</span><span class="op" id="5156277">,</span>&nbsp;<span class="ident" id="5156279">n</span><span class="op" id="5156280">,</span>&nbsp;<span class="ident" id="5156282">nodeName</span><span class="op" id="5156290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156294">if</span>&nbsp;<span class="ident" id="5156297">c0</span><span class="op" id="5156299">.</span><span class="ident" id="5156300">state</span>&nbsp;<span class="op" id="5156306">==</span>&nbsp;<span class="ident" id="5156309">stateError</span>&nbsp;<span class="op" id="5156320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156325">//&nbsp;Make&nbsp;clear&nbsp;that&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;on&nbsp;loop&nbsp;re-entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156382">//&nbsp;since&nbsp;developers&nbsp;tend&nbsp;to&nbsp;overlook&nbsp;that&nbsp;branch&nbsp;when</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5156439">//&nbsp;debugging&nbsp;templates.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156466">c0</span><span class="op" id="5156468">.</span><span class="ident" id="5156469">err</span><span class="op" id="5156472">.</span><span class="ident" id="5156473">Line</span>&nbsp;<span class="op" id="5156478">=</span>&nbsp;<span class="ident" id="5156480">n</span><span class="op" id="5156481">.</span><span class="ident" id="5156482">Line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156490">c0</span><span class="op" id="5156492">.</span><span class="ident" id="5156493">err</span><span class="op" id="5156496">.</span><span class="ident" id="5156497">Description</span>&nbsp;<span class="op" id="5156509">=</span>&nbsp;<span class="string" id="5156511">&#34;on&nbsp;range&nbsp;loop&nbsp;re-entry:&nbsp;&#34;</span>&nbsp;<span class="op" id="5156538">+</span>&nbsp;<span class="ident" id="5156540">c0</span><span class="op" id="5156542">.</span><span class="ident" id="5156543">err</span><span class="op" id="5156546">.</span><span class="ident" id="5156547">Description</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156562">return</span>&nbsp;<span class="ident" id="5156569">c0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156577">}</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156580">c1</span>&nbsp;<span class="op" id="5156583">:=</span>&nbsp;<span class="ident" id="5156586">e</span><span class="op" id="5156587">.</span><span class="ident" id="5156588">escapeList</span><span class="op" id="5156598">(</span><span class="ident" id="5156599">c</span><span class="op" id="5156600">,</span>&nbsp;<span class="ident" id="5156602">n</span><span class="op" id="5156603">.</span><span class="ident" id="5156604">ElseList</span><span class="op" id="5156612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156615">return</span>&nbsp;<span class="ident" id="5156622">join</span><span class="op" id="5156626">(</span><span class="ident" id="5156627">c0</span><span class="op" id="5156629">,</span>&nbsp;<span class="ident" id="5156631">c1</span><span class="op" id="5156633">,</span>&nbsp;<span class="ident" id="5156635">n</span><span class="op" id="5156636">,</span>&nbsp;<span class="ident" id="5156638">nodeName</span><span class="op" id="5156646">)</span><br>
<span class="lineno"></span><span class="op" id="5156648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5156651">//&nbsp;escapeList&nbsp;escapes&nbsp;a&nbsp;list&nbsp;template&nbsp;node.</span><br>
<span class="lineno">435</span><span class="keyword" id="5156695">func</span>&nbsp;<span class="op" id="5156700">(</span><span class="ident" id="5156701">e</span>&nbsp;<span class="op" id="5156703">*</span><span class="ident" id="5156704">escaper</span><span class="op" id="5156711">)</span>&nbsp;<span class="ident" id="5156713">escapeList</span><span class="op" id="5156723">(</span><span class="ident" id="5156724">c</span>&nbsp;<span class="ident" id="5156726">context</span><span class="op" id="5156733">,</span>&nbsp;<span class="ident" id="5156735">n</span>&nbsp;<span class="op" id="5156737">*</span><span class="ident" id="5156738">parse</span><span class="op" id="5156743">.</span><span class="ident" id="5156744">ListNode</span><span class="op" id="5156752">)</span>&nbsp;<span class="ident" id="5156754">context</span>&nbsp;<span class="op" id="5156762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156765">if</span>&nbsp;<span class="ident" id="5156768">n</span>&nbsp;<span class="op" id="5156770">==</span>&nbsp;<span class="ident" id="5156773">nil</span>&nbsp;<span class="op" id="5156777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156781">return</span>&nbsp;<span class="ident" id="5156788">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156794">for</span>&nbsp;<span class="ident" id="5156798">_</span><span class="op" id="5156799">,</span>&nbsp;<span class="ident" id="5156801">m</span>&nbsp;<span class="op" id="5156803">:=</span>&nbsp;<span class="keyword" id="5156806">range</span>&nbsp;<span class="ident" id="5156812">n</span><span class="op" id="5156813">.</span><span class="ident" id="5156814">Nodes</span>&nbsp;<span class="op" id="5156820">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5156824">c</span>&nbsp;<span class="op" id="5156826">=</span>&nbsp;<span class="ident" id="5156828">e</span><span class="op" id="5156829">.</span><span class="ident" id="5156830">escape</span><span class="op" id="5156836">(</span><span class="ident" id="5156837">c</span><span class="op" id="5156838">,</span>&nbsp;<span class="ident" id="5156840">m</span><span class="op" id="5156841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5156844">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5156847">return</span>&nbsp;<span class="ident" id="5156854">c</span><br>
<span class="lineno"></span><span class="op" id="5156856">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="5156859">//&nbsp;escapeListConditionally&nbsp;escapes&nbsp;a&nbsp;list&nbsp;node&nbsp;but&nbsp;only&nbsp;preserves&nbsp;edits&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="5156935">//&nbsp;inferences&nbsp;in&nbsp;e&nbsp;if&nbsp;the&nbsp;inferences&nbsp;and&nbsp;output&nbsp;context&nbsp;satisfy&nbsp;filter.</span><br>
<span class="lineno"></span><span class="comment" id="5157007">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;an&nbsp;output&nbsp;context,&nbsp;and&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;filter</span><br>
<span class="lineno"></span><span class="comment" id="5157087">//&nbsp;which&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;whether&nbsp;e&nbsp;was&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="5157134">func</span>&nbsp;<span class="op" id="5157139">(</span><span class="ident" id="5157140">e</span>&nbsp;<span class="op" id="5157142">*</span><span class="ident" id="5157143">escaper</span><span class="op" id="5157150">)</span>&nbsp;<span class="ident" id="5157152">escapeListConditionally</span><span class="op" id="5157175">(</span><span class="ident" id="5157176">c</span>&nbsp;<span class="ident" id="5157178">context</span><span class="op" id="5157185">,</span>&nbsp;<span class="ident" id="5157187">n</span>&nbsp;<span class="op" id="5157189">*</span><span class="ident" id="5157190">parse</span><span class="op" id="5157195">.</span><span class="ident" id="5157196">ListNode</span><span class="op" id="5157204">,</span>&nbsp;<span class="ident" id="5157206">filter</span>&nbsp;<span class="keyword" id="5157213">func</span><span class="op" id="5157217">(</span><span class="op" id="5157218">*</span><span class="ident" id="5157219">escaper</span><span class="op" id="5157226">,</span>&nbsp;<span class="ident" id="5157228">context</span><span class="op" id="5157235">)</span>&nbsp;<span class="builtintype" id="5157237">bool</span><span class="op" id="5157241">)</span>&nbsp;<span class="op" id="5157243">(</span><span class="ident" id="5157244">context</span><span class="op" id="5157251">,</span>&nbsp;<span class="builtintype" id="5157253">bool</span><span class="op" id="5157257">)</span>&nbsp;<span class="op" id="5157259">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157262">e1</span>&nbsp;<span class="op" id="5157265">:=</span>&nbsp;<span class="ident" id="5157268">newEscaper</span><span class="op" id="5157278">(</span><span class="ident" id="5157279">e</span><span class="op" id="5157280">.</span><span class="ident" id="5157281">tmpl</span><span class="op" id="5157285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5157288">//&nbsp;Make&nbsp;type&nbsp;inferences&nbsp;available&nbsp;to&nbsp;f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157329">for</span>&nbsp;<span class="ident" id="5157333">k</span><span class="op" id="5157334">,</span>&nbsp;<span class="ident" id="5157336">v</span>&nbsp;<span class="op" id="5157338">:=</span>&nbsp;<span class="keyword" id="5157341">range</span>&nbsp;<span class="ident" id="5157347">e</span><span class="op" id="5157348">.</span><span class="ident" id="5157349">output</span>&nbsp;<span class="op" id="5157356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157360">e1</span><span class="op" id="5157362">.</span><span class="ident" id="5157363">output</span><span class="op" id="5157369">[</span><span class="ident" id="5157370">k</span><span class="op" id="5157371">]</span>&nbsp;<span class="op" id="5157373">=</span>&nbsp;<span class="ident" id="5157375">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157378">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157381">c</span>&nbsp;<span class="op" id="5157383">=</span>&nbsp;<span class="ident" id="5157385">e1</span><span class="op" id="5157387">.</span><span class="ident" id="5157388">escapeList</span><span class="op" id="5157398">(</span><span class="ident" id="5157399">c</span><span class="op" id="5157400">,</span>&nbsp;<span class="ident" id="5157402">n</span><span class="op" id="5157403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157406">ok</span>&nbsp;<span class="op" id="5157409">:=</span>&nbsp;<span class="ident" id="5157412">filter</span>&nbsp;<span class="op" id="5157419">!=</span>&nbsp;<span class="ident" id="5157422">nil</span>&nbsp;<span class="op" id="5157426">&amp;&amp;</span>&nbsp;<span class="ident" id="5157429">filter</span><span class="op" id="5157435">(</span><span class="ident" id="5157436">e1</span><span class="op" id="5157438">,</span>&nbsp;<span class="ident" id="5157440">c</span><span class="op" id="5157441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157444">if</span>&nbsp;<span class="ident" id="5157447">ok</span>&nbsp;<span class="op" id="5157450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5157454">//&nbsp;Copy&nbsp;inferences&nbsp;and&nbsp;edits&nbsp;from&nbsp;e1&nbsp;back&nbsp;into&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157506">for</span>&nbsp;<span class="ident" id="5157510">k</span><span class="op" id="5157511">,</span>&nbsp;<span class="ident" id="5157513">v</span>&nbsp;<span class="op" id="5157515">:=</span>&nbsp;<span class="keyword" id="5157518">range</span>&nbsp;<span class="ident" id="5157524">e1</span><span class="op" id="5157526">.</span><span class="ident" id="5157527">output</span>&nbsp;<span class="op" id="5157534">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157539">e</span><span class="op" id="5157540">.</span><span class="ident" id="5157541">output</span><span class="op" id="5157547">[</span><span class="ident" id="5157548">k</span><span class="op" id="5157549">]</span>&nbsp;<span class="op" id="5157551">=</span>&nbsp;<span class="ident" id="5157553">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157561">for</span>&nbsp;<span class="ident" id="5157565">k</span><span class="op" id="5157566">,</span>&nbsp;<span class="ident" id="5157568">v</span>&nbsp;<span class="op" id="5157570">:=</span>&nbsp;<span class="keyword" id="5157573">range</span>&nbsp;<span class="ident" id="5157579">e1</span><span class="op" id="5157581">.</span><span class="ident" id="5157582">derived</span>&nbsp;<span class="op" id="5157590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157595">e</span><span class="op" id="5157596">.</span><span class="ident" id="5157597">derived</span><span class="op" id="5157604">[</span><span class="ident" id="5157605">k</span><span class="op" id="5157606">]</span>&nbsp;<span class="op" id="5157608">=</span>&nbsp;<span class="ident" id="5157610">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157614">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157618">for</span>&nbsp;<span class="ident" id="5157622">k</span><span class="op" id="5157623">,</span>&nbsp;<span class="ident" id="5157625">v</span>&nbsp;<span class="op" id="5157627">:=</span>&nbsp;<span class="keyword" id="5157630">range</span>&nbsp;<span class="ident" id="5157636">e1</span><span class="op" id="5157638">.</span><span class="ident" id="5157639">called</span>&nbsp;<span class="op" id="5157646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157651">e</span><span class="op" id="5157652">.</span><span class="ident" id="5157653">called</span><span class="op" id="5157659">[</span><span class="ident" id="5157660">k</span><span class="op" id="5157661">]</span>&nbsp;<span class="op" id="5157663">=</span>&nbsp;<span class="ident" id="5157665">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157673">for</span>&nbsp;<span class="ident" id="5157677">k</span><span class="op" id="5157678">,</span>&nbsp;<span class="ident" id="5157680">v</span>&nbsp;<span class="op" id="5157682">:=</span>&nbsp;<span class="keyword" id="5157685">range</span>&nbsp;<span class="ident" id="5157691">e1</span><span class="op" id="5157693">.</span><span class="ident" id="5157694">actionNodeEdits</span>&nbsp;<span class="op" id="5157710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157715">e</span><span class="op" id="5157716">.</span><span class="ident" id="5157717">editActionNode</span><span class="op" id="5157731">(</span><span class="ident" id="5157732">k</span><span class="op" id="5157733">,</span>&nbsp;<span class="ident" id="5157735">v</span><span class="op" id="5157736">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157744">for</span>&nbsp;<span class="ident" id="5157748">k</span><span class="op" id="5157749">,</span>&nbsp;<span class="ident" id="5157751">v</span>&nbsp;<span class="op" id="5157753">:=</span>&nbsp;<span class="keyword" id="5157756">range</span>&nbsp;<span class="ident" id="5157762">e1</span><span class="op" id="5157764">.</span><span class="ident" id="5157765">templateNodeEdits</span>&nbsp;<span class="op" id="5157783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157788">e</span><span class="op" id="5157789">.</span><span class="ident" id="5157790">editTemplateNode</span><span class="op" id="5157806">(</span><span class="ident" id="5157807">k</span><span class="op" id="5157808">,</span>&nbsp;<span class="ident" id="5157810">v</span><span class="op" id="5157811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157819">for</span>&nbsp;<span class="ident" id="5157823">k</span><span class="op" id="5157824">,</span>&nbsp;<span class="ident" id="5157826">v</span>&nbsp;<span class="op" id="5157828">:=</span>&nbsp;<span class="keyword" id="5157831">range</span>&nbsp;<span class="ident" id="5157837">e1</span><span class="op" id="5157839">.</span><span class="ident" id="5157840">textNodeEdits</span>&nbsp;<span class="op" id="5157854">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5157859">e</span><span class="op" id="5157860">.</span><span class="ident" id="5157861">editTextNode</span><span class="op" id="5157873">(</span><span class="ident" id="5157874">k</span><span class="op" id="5157875">,</span>&nbsp;<span class="ident" id="5157877">v</span><span class="op" id="5157878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5157885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5157888">return</span>&nbsp;<span class="ident" id="5157895">c</span><span class="op" id="5157896">,</span>&nbsp;<span class="ident" id="5157898">ok</span><br>
<span class="lineno"></span><span class="op" id="5157901">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5157904">//&nbsp;escapeTemplate&nbsp;escapes&nbsp;a&nbsp;{{template}}&nbsp;call&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5157956">func</span>&nbsp;<span class="op" id="5157961">(</span><span class="ident" id="5157962">e</span>&nbsp;<span class="op" id="5157964">*</span><span class="ident" id="5157965">escaper</span><span class="op" id="5157972">)</span>&nbsp;<span class="ident" id="5157974">escapeTemplate</span><span class="op" id="5157988">(</span><span class="ident" id="5157989">c</span>&nbsp;<span class="ident" id="5157991">context</span><span class="op" id="5157998">,</span>&nbsp;<span class="ident" id="5158000">n</span>&nbsp;<span class="op" id="5158002">*</span><span class="ident" id="5158003">parse</span><span class="op" id="5158008">.</span><span class="ident" id="5158009">TemplateNode</span><span class="op" id="5158021">)</span>&nbsp;<span class="ident" id="5158023">context</span>&nbsp;<span class="op" id="5158031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158034">c</span><span class="op" id="5158035">,</span>&nbsp;<span class="ident" id="5158037">name</span>&nbsp;<span class="op" id="5158042">:=</span>&nbsp;<span class="ident" id="5158045">e</span><span class="op" id="5158046">.</span><span class="ident" id="5158047">escapeTree</span><span class="op" id="5158057">(</span><span class="ident" id="5158058">c</span><span class="op" id="5158059">,</span>&nbsp;<span class="ident" id="5158061">n</span><span class="op" id="5158062">,</span>&nbsp;<span class="ident" id="5158064">n</span><span class="op" id="5158065">.</span><span class="ident" id="5158066">Name</span><span class="op" id="5158070">,</span>&nbsp;<span class="ident" id="5158072">n</span><span class="op" id="5158073">.</span><span class="ident" id="5158074">Line</span><span class="op" id="5158078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158081">if</span>&nbsp;<span class="ident" id="5158084">name</span>&nbsp;<span class="op" id="5158089">!=</span>&nbsp;<span class="ident" id="5158092">n</span><span class="op" id="5158093">.</span><span class="ident" id="5158094">Name</span>&nbsp;<span class="op" id="5158099">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158103">e</span><span class="op" id="5158104">.</span><span class="ident" id="5158105">editTemplateNode</span><span class="op" id="5158121">(</span><span class="ident" id="5158122">n</span><span class="op" id="5158123">,</span>&nbsp;<span class="ident" id="5158125">name</span><span class="op" id="5158129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158135">return</span>&nbsp;<span class="ident" id="5158142">c</span><br>
<span class="lineno"></span><span class="op" id="5158144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">490</span><span class="comment" id="5158147">//&nbsp;escapeTree&nbsp;escapes&nbsp;the&nbsp;named&nbsp;template&nbsp;starting&nbsp;in&nbsp;the&nbsp;given&nbsp;context&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5158221">//&nbsp;necessary&nbsp;and&nbsp;returns&nbsp;its&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span><span class="keyword" id="5158266">func</span>&nbsp;<span class="op" id="5158271">(</span><span class="ident" id="5158272">e</span>&nbsp;<span class="op" id="5158274">*</span><span class="ident" id="5158275">escaper</span><span class="op" id="5158282">)</span>&nbsp;<span class="ident" id="5158284">escapeTree</span><span class="op" id="5158294">(</span><span class="ident" id="5158295">c</span>&nbsp;<span class="ident" id="5158297">context</span><span class="op" id="5158304">,</span>&nbsp;<span class="ident" id="5158306">node</span>&nbsp;<span class="ident" id="5158311">parse</span><span class="op" id="5158316">.</span><span class="ident" id="5158317">Node</span><span class="op" id="5158321">,</span>&nbsp;<span class="ident" id="5158323">name</span>&nbsp;<span class="builtintype" id="5158328">string</span><span class="op" id="5158334">,</span>&nbsp;<span class="ident" id="5158336">line</span>&nbsp;<span class="builtintype" id="5158341">int</span><span class="op" id="5158344">)</span>&nbsp;<span class="op" id="5158346">(</span><span class="ident" id="5158347">context</span><span class="op" id="5158354">,</span>&nbsp;<span class="builtintype" id="5158356">string</span><span class="op" id="5158362">)</span>&nbsp;<span class="op" id="5158364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158367">//&nbsp;Mangle&nbsp;the&nbsp;template&nbsp;name&nbsp;with&nbsp;the&nbsp;input&nbsp;context&nbsp;to&nbsp;produce&nbsp;a&nbsp;reliable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158441">//&nbsp;identifier.</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158457">dname</span>&nbsp;<span class="op" id="5158463">:=</span>&nbsp;<span class="ident" id="5158466">c</span><span class="op" id="5158467">.</span><span class="ident" id="5158468">mangle</span><span class="op" id="5158474">(</span><span class="ident" id="5158475">name</span><span class="op" id="5158479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158482">e</span><span class="op" id="5158483">.</span><span class="ident" id="5158484">called</span><span class="op" id="5158490">[</span><span class="ident" id="5158491">dname</span><span class="op" id="5158496">]</span>&nbsp;<span class="op" id="5158498">=</span>&nbsp;<span class="builtintype" id="5158500">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158506">if</span>&nbsp;<span class="ident" id="5158509">out</span><span class="op" id="5158512">,</span>&nbsp;<span class="ident" id="5158514">ok</span>&nbsp;<span class="op" id="5158517">:=</span>&nbsp;<span class="ident" id="5158520">e</span><span class="op" id="5158521">.</span><span class="ident" id="5158522">output</span><span class="op" id="5158528">[</span><span class="ident" id="5158529">dname</span><span class="op" id="5158534">]</span><span class="op" id="5158535">;</span>&nbsp;<span class="ident" id="5158537">ok</span>&nbsp;<span class="op" id="5158540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158544">//&nbsp;Already&nbsp;escaped.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158566">return</span>&nbsp;<span class="ident" id="5158573">out</span><span class="op" id="5158576">,</span>&nbsp;<span class="ident" id="5158578">dname</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158588">t</span>&nbsp;<span class="op" id="5158590">:=</span>&nbsp;<span class="ident" id="5158593">e</span><span class="op" id="5158594">.</span><span class="ident" id="5158595">template</span><span class="op" id="5158603">(</span><span class="ident" id="5158604">name</span><span class="op" id="5158608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158611">if</span>&nbsp;<span class="ident" id="5158614">t</span>&nbsp;<span class="op" id="5158616">==</span>&nbsp;<span class="ident" id="5158619">nil</span>&nbsp;<span class="op" id="5158623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158627">//&nbsp;Two&nbsp;cases:&nbsp;The&nbsp;template&nbsp;exists&nbsp;but&nbsp;is&nbsp;empty,&nbsp;or&nbsp;has&nbsp;never&nbsp;been&nbsp;mentioned&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5158708">//&nbsp;all.&nbsp;Distinguish&nbsp;the&nbsp;cases&nbsp;in&nbsp;the&nbsp;error&nbsp;messages.</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158763">if</span>&nbsp;<span class="ident" id="5158766">e</span><span class="op" id="5158767">.</span><span class="ident" id="5158768">tmpl</span><span class="op" id="5158772">.</span><span class="ident" id="5158773">set</span><span class="op" id="5158776">[</span><span class="ident" id="5158777">name</span><span class="op" id="5158781">]</span>&nbsp;<span class="op" id="5158783">!=</span>&nbsp;<span class="ident" id="5158786">nil</span>&nbsp;<span class="op" id="5158790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158795">return</span>&nbsp;<span class="ident" id="5158802">context</span><span class="op" id="5158809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158815">state</span><span class="op" id="5158820">:</span>&nbsp;<span class="ident" id="5158822">stateError</span><span class="op" id="5158832">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158838">err</span><span class="op" id="5158841">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5158845">errorf</span><span class="op" id="5158851">(</span><span class="ident" id="5158852">ErrNoSuchTemplate</span><span class="op" id="5158869">,</span>&nbsp;<span class="ident" id="5158871">node</span><span class="op" id="5158875">,</span>&nbsp;<span class="ident" id="5158877">line</span><span class="op" id="5158881">,</span>&nbsp;<span class="string" id="5158883">&#34;%q&nbsp;is&nbsp;an&nbsp;incomplete&nbsp;or&nbsp;empty&nbsp;template&#34;</span><span class="op" id="5158922">,</span>&nbsp;<span class="ident" id="5158924">name</span><span class="op" id="5158928">)</span><span class="op" id="5158929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158934">}</span><span class="op" id="5158935">,</span>&nbsp;<span class="ident" id="5158937">dname</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5158945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5158949">return</span>&nbsp;<span class="ident" id="5158956">context</span><span class="op" id="5158963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158968">state</span><span class="op" id="5158973">:</span>&nbsp;<span class="ident" id="5158975">stateError</span><span class="op" id="5158985">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5158990">err</span><span class="op" id="5158993">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5158997">errorf</span><span class="op" id="5159003">(</span><span class="ident" id="5159004">ErrNoSuchTemplate</span><span class="op" id="5159021">,</span>&nbsp;<span class="ident" id="5159023">node</span><span class="op" id="5159027">,</span>&nbsp;<span class="ident" id="5159029">line</span><span class="op" id="5159033">,</span>&nbsp;<span class="string" id="5159035">&#34;no&nbsp;such&nbsp;template&nbsp;%q&#34;</span><span class="op" id="5159056">,</span>&nbsp;<span class="ident" id="5159058">name</span><span class="op" id="5159062">)</span><span class="op" id="5159063">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159067">}</span><span class="op" id="5159068">,</span>&nbsp;<span class="ident" id="5159070">dname</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159080">if</span>&nbsp;<span class="ident" id="5159083">dname</span>&nbsp;<span class="op" id="5159089">!=</span>&nbsp;<span class="ident" id="5159092">name</span>&nbsp;<span class="op" id="5159097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5159101">//&nbsp;Use&nbsp;any&nbsp;template&nbsp;derived&nbsp;during&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;escapeTemplate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5159172">//&nbsp;with&nbsp;different&nbsp;top&nbsp;level&nbsp;templates,&nbsp;or&nbsp;clone&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159236">dt</span>&nbsp;<span class="op" id="5159239">:=</span>&nbsp;<span class="ident" id="5159242">e</span><span class="op" id="5159243">.</span><span class="ident" id="5159244">template</span><span class="op" id="5159252">(</span><span class="ident" id="5159253">dname</span><span class="op" id="5159258">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159262">if</span>&nbsp;<span class="ident" id="5159265">dt</span>&nbsp;<span class="op" id="5159268">==</span>&nbsp;<span class="ident" id="5159271">nil</span>&nbsp;<span class="op" id="5159275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159280">dt</span>&nbsp;<span class="op" id="5159283">=</span>&nbsp;<span class="ident" id="5159285">template</span><span class="op" id="5159293">.</span><span class="ident" id="5159294">New</span><span class="op" id="5159297">(</span><span class="ident" id="5159298">dname</span><span class="op" id="5159303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159308">dt</span><span class="op" id="5159310">.</span><span class="ident" id="5159311">Tree</span>&nbsp;<span class="op" id="5159316">=</span>&nbsp;<span class="op" id="5159318">&amp;</span><span class="ident" id="5159319">parse</span><span class="op" id="5159324">.</span><span class="ident" id="5159325">Tree</span><span class="op" id="5159329">{</span><span class="ident" id="5159330">Name</span><span class="op" id="5159334">:</span>&nbsp;<span class="ident" id="5159336">dname</span><span class="op" id="5159341">,</span>&nbsp;<span class="ident" id="5159343">Root</span><span class="op" id="5159347">:</span>&nbsp;<span class="ident" id="5159349">t</span><span class="op" id="5159350">.</span><span class="ident" id="5159351">Root</span><span class="op" id="5159355">.</span><span class="ident" id="5159356">CopyList</span><span class="op" id="5159364">(</span><span class="op" id="5159365">)</span><span class="op" id="5159366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159371">e</span><span class="op" id="5159372">.</span><span class="ident" id="5159373">derived</span><span class="op" id="5159380">[</span><span class="ident" id="5159381">dname</span><span class="op" id="5159386">]</span>&nbsp;<span class="op" id="5159388">=</span>&nbsp;<span class="ident" id="5159390">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159395">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159399">t</span>&nbsp;<span class="op" id="5159401">=</span>&nbsp;<span class="ident" id="5159403">dt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159410">return</span>&nbsp;<span class="ident" id="5159417">e</span><span class="op" id="5159418">.</span><span class="ident" id="5159419">computeOutCtx</span><span class="op" id="5159432">(</span><span class="ident" id="5159433">c</span><span class="op" id="5159434">,</span>&nbsp;<span class="ident" id="5159436">t</span><span class="op" id="5159437">)</span><span class="op" id="5159438">,</span>&nbsp;<span class="ident" id="5159440">dname</span><br>
<span class="lineno"></span><span class="op" id="5159446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span><span class="comment" id="5159449">//&nbsp;computeOutCtx&nbsp;takes&nbsp;a&nbsp;template&nbsp;and&nbsp;its&nbsp;start&nbsp;context&nbsp;and&nbsp;computes&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5159529">//&nbsp;context&nbsp;while&nbsp;storing&nbsp;any&nbsp;inferences&nbsp;in&nbsp;e.</span><br>
<span class="lineno"></span><span class="keyword" id="5159575">func</span>&nbsp;<span class="op" id="5159580">(</span><span class="ident" id="5159581">e</span>&nbsp;<span class="op" id="5159583">*</span><span class="ident" id="5159584">escaper</span><span class="op" id="5159591">)</span>&nbsp;<span class="ident" id="5159593">computeOutCtx</span><span class="op" id="5159606">(</span><span class="ident" id="5159607">c</span>&nbsp;<span class="ident" id="5159609">context</span><span class="op" id="5159616">,</span>&nbsp;<span class="ident" id="5159618">t</span>&nbsp;<span class="op" id="5159620">*</span><span class="ident" id="5159621">template</span><span class="op" id="5159629">.</span><span class="ident" id="5159630">Template</span><span class="op" id="5159638">)</span>&nbsp;<span class="ident" id="5159640">context</span>&nbsp;<span class="op" id="5159648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5159651">//&nbsp;Propagate&nbsp;context&nbsp;over&nbsp;the&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159688">c1</span><span class="op" id="5159690">,</span>&nbsp;<span class="ident" id="5159692">ok</span>&nbsp;<span class="op" id="5159695">:=</span>&nbsp;<span class="ident" id="5159698">e</span><span class="op" id="5159699">.</span><span class="ident" id="5159700">escapeTemplateBody</span><span class="op" id="5159718">(</span><span class="ident" id="5159719">c</span><span class="op" id="5159720">,</span>&nbsp;<span class="ident" id="5159722">t</span><span class="op" id="5159723">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159726">if</span>&nbsp;<span class="op" id="5159729">!</span><span class="ident" id="5159730">ok</span>&nbsp;<span class="op" id="5159733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5159737">//&nbsp;Look&nbsp;for&nbsp;a&nbsp;fixed&nbsp;point&nbsp;by&nbsp;assuming&nbsp;c1&nbsp;as&nbsp;the&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159803">if</span>&nbsp;<span class="ident" id="5159806">c2</span><span class="op" id="5159808">,</span>&nbsp;<span class="ident" id="5159810">ok2</span>&nbsp;<span class="op" id="5159814">:=</span>&nbsp;<span class="ident" id="5159817">e</span><span class="op" id="5159818">.</span><span class="ident" id="5159819">escapeTemplateBody</span><span class="op" id="5159837">(</span><span class="ident" id="5159838">c1</span><span class="op" id="5159840">,</span>&nbsp;<span class="ident" id="5159842">t</span><span class="op" id="5159843">)</span><span class="op" id="5159844">;</span>&nbsp;<span class="ident" id="5159846">ok2</span>&nbsp;<span class="op" id="5159850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5159855">c1</span><span class="op" id="5159857">,</span>&nbsp;<span class="ident" id="5159859">ok</span>&nbsp;<span class="op" id="5159862">=</span>&nbsp;<span class="ident" id="5159864">c2</span><span class="op" id="5159866">,</span>&nbsp;<span class="builtintype" id="5159868">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159875">}</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5159879">//&nbsp;Use&nbsp;c1&nbsp;as&nbsp;the&nbsp;error&nbsp;context&nbsp;if&nbsp;neither&nbsp;assumption&nbsp;worked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5159941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159944">if</span>&nbsp;<span class="op" id="5159947">!</span><span class="ident" id="5159948">ok</span>&nbsp;<span class="op" id="5159951">&amp;&amp;</span>&nbsp;<span class="ident" id="5159954">c1</span><span class="op" id="5159956">.</span><span class="ident" id="5159957">state</span>&nbsp;<span class="op" id="5159963">!=</span>&nbsp;<span class="ident" id="5159966">stateError</span>&nbsp;<span class="op" id="5159977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5159981">return</span>&nbsp;<span class="ident" id="5159988">context</span><span class="op" id="5159995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160000">state</span><span class="op" id="5160005">:</span>&nbsp;<span class="ident" id="5160007">stateError</span><span class="op" id="5160017">,</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160022">err</span><span class="op" id="5160025">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5160029">errorf</span><span class="op" id="5160035">(</span><span class="ident" id="5160036">ErrOutputContext</span><span class="op" id="5160052">,</span>&nbsp;<span class="ident" id="5160054">t</span><span class="op" id="5160055">.</span><span class="ident" id="5160056">Tree</span><span class="op" id="5160060">.</span><span class="ident" id="5160061">Root</span><span class="op" id="5160065">,</span>&nbsp;<span class="num" id="5160067">0</span><span class="op" id="5160068">,</span>&nbsp;<span class="string" id="5160070">&#34;cannot&nbsp;compute&nbsp;output&nbsp;context&nbsp;for&nbsp;template&nbsp;%s&#34;</span><span class="op" id="5160117">,</span>&nbsp;<span class="ident" id="5160119">t</span><span class="op" id="5160120">.</span><span class="ident" id="5160121">Name</span><span class="op" id="5160125">(</span><span class="op" id="5160126">)</span><span class="op" id="5160127">)</span><span class="op" id="5160128">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160138">return</span>&nbsp;<span class="ident" id="5160145">c1</span><br>
<span class="lineno"></span><span class="op" id="5160148">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="comment" id="5160151">//&nbsp;escapeTemplateBody&nbsp;escapes&nbsp;the&nbsp;given&nbsp;template&nbsp;assuming&nbsp;the&nbsp;given&nbsp;output</span><br>
<span class="lineno"></span><span class="comment" id="5160226">//&nbsp;context,&nbsp;and&nbsp;returns&nbsp;the&nbsp;best&nbsp;guess&nbsp;at&nbsp;the&nbsp;output&nbsp;context&nbsp;and&nbsp;whether&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5160303">//&nbsp;assumption&nbsp;was&nbsp;correct.</span><br>
<span class="lineno"></span><span class="keyword" id="5160330">func</span>&nbsp;<span class="op" id="5160335">(</span><span class="ident" id="5160336">e</span>&nbsp;<span class="op" id="5160338">*</span><span class="ident" id="5160339">escaper</span><span class="op" id="5160346">)</span>&nbsp;<span class="ident" id="5160348">escapeTemplateBody</span><span class="op" id="5160366">(</span><span class="ident" id="5160367">c</span>&nbsp;<span class="ident" id="5160369">context</span><span class="op" id="5160376">,</span>&nbsp;<span class="ident" id="5160378">t</span>&nbsp;<span class="op" id="5160380">*</span><span class="ident" id="5160381">template</span><span class="op" id="5160389">.</span><span class="ident" id="5160390">Template</span><span class="op" id="5160398">)</span>&nbsp;<span class="op" id="5160400">(</span><span class="ident" id="5160401">context</span><span class="op" id="5160408">,</span>&nbsp;<span class="builtintype" id="5160410">bool</span><span class="op" id="5160414">)</span>&nbsp;<span class="op" id="5160416">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5160419">filter</span>&nbsp;<span class="op" id="5160426">:=</span>&nbsp;<span class="keyword" id="5160429">func</span><span class="op" id="5160433">(</span><span class="ident" id="5160434">e1</span>&nbsp;<span class="op" id="5160437">*</span><span class="ident" id="5160438">escaper</span><span class="op" id="5160445">,</span>&nbsp;<span class="ident" id="5160447">c1</span>&nbsp;<span class="ident" id="5160450">context</span><span class="op" id="5160457">)</span>&nbsp;<span class="builtintype" id="5160459">bool</span>&nbsp;<span class="op" id="5160464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160468">if</span>&nbsp;<span class="ident" id="5160471">c1</span><span class="op" id="5160473">.</span><span class="ident" id="5160474">state</span>&nbsp;<span class="op" id="5160480">==</span>&nbsp;<span class="ident" id="5160483">stateError</span>&nbsp;<span class="op" id="5160494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160499">//&nbsp;Do&nbsp;not&nbsp;update&nbsp;the&nbsp;input&nbsp;escaper,&nbsp;e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160541">return</span>&nbsp;<span class="builtintype" id="5160548">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160556">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160560">if</span>&nbsp;<span class="op" id="5160563">!</span><span class="ident" id="5160564">e1</span><span class="op" id="5160566">.</span><span class="ident" id="5160567">called</span><span class="op" id="5160573">[</span><span class="ident" id="5160574">t</span><span class="op" id="5160575">.</span><span class="ident" id="5160576">Name</span><span class="op" id="5160580">(</span><span class="op" id="5160581">)</span><span class="op" id="5160582">]</span>&nbsp;<span class="op" id="5160584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160589">//&nbsp;If&nbsp;t&nbsp;is&nbsp;not&nbsp;recursively&nbsp;called,&nbsp;then&nbsp;c1&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160641">//&nbsp;accurate&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160672">return</span>&nbsp;<span class="builtintype" id="5160679">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160686">}</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160690">//&nbsp;c1&nbsp;is&nbsp;accurate&nbsp;if&nbsp;it&nbsp;matches&nbsp;our&nbsp;assumed&nbsp;output&nbsp;context.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5160752">return</span>&nbsp;<span class="ident" id="5160759">c</span><span class="op" id="5160760">.</span><span class="ident" id="5160761">eq</span><span class="op" id="5160763">(</span><span class="ident" id="5160764">c1</span><span class="op" id="5160766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5160769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160772">//&nbsp;We&nbsp;need&nbsp;to&nbsp;assume&nbsp;an&nbsp;output&nbsp;context&nbsp;so&nbsp;that&nbsp;recursive&nbsp;template&nbsp;calls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160845">//&nbsp;take&nbsp;the&nbsp;fast&nbsp;path&nbsp;out&nbsp;of&nbsp;escapeTree&nbsp;instead&nbsp;of&nbsp;infinitely&nbsp;recursing.</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160919">//&nbsp;Naively&nbsp;assuming&nbsp;that&nbsp;the&nbsp;input&nbsp;context&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5160989">//&nbsp;works&nbsp;&gt;90%&nbsp;of&nbsp;the&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161017">e</span><span class="op" id="5161018">.</span><span class="ident" id="5161019">output</span><span class="op" id="5161025">[</span><span class="ident" id="5161026">t</span><span class="op" id="5161027">.</span><span class="ident" id="5161028">Name</span><span class="op" id="5161032">(</span><span class="op" id="5161033">)</span><span class="op" id="5161034">]</span>&nbsp;<span class="op" id="5161036">=</span>&nbsp;<span class="ident" id="5161038">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161041">return</span>&nbsp;<span class="ident" id="5161048">e</span><span class="op" id="5161049">.</span><span class="ident" id="5161050">escapeListConditionally</span><span class="op" id="5161073">(</span><span class="ident" id="5161074">c</span><span class="op" id="5161075">,</span>&nbsp;<span class="ident" id="5161077">t</span><span class="op" id="5161078">.</span><span class="ident" id="5161079">Tree</span><span class="op" id="5161083">.</span><span class="ident" id="5161084">Root</span><span class="op" id="5161088">,</span>&nbsp;<span class="ident" id="5161090">filter</span><span class="op" id="5161096">)</span><br>
<span class="lineno"></span><span class="op" id="5161098">}</span><br>
<span class="lineno">575</span><br>
<span class="lineno"></span><span class="comment" id="5161101">//&nbsp;delimEnds&nbsp;maps&nbsp;each&nbsp;delim&nbsp;to&nbsp;a&nbsp;string&nbsp;of&nbsp;characters&nbsp;that&nbsp;terminate&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="5161175">var</span>&nbsp;<span class="ident" id="5161179">delimEnds</span>&nbsp;<span class="op" id="5161189">=</span>&nbsp;<span class="op" id="5161191">[</span><span class="op" id="5161192">...</span><span class="op" id="5161195">]</span><span class="builtintype" id="5161196">string</span><span class="op" id="5161202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161205">delimDoubleQuote</span><span class="op" id="5161221">:</span>&nbsp;<span class="string" id="5161223">`&#34;`</span><span class="op" id="5161226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161229">delimSingleQuote</span><span class="op" id="5161245">:</span>&nbsp;<span class="string" id="5161247">&#34;&#39;&#34;</span><span class="op" id="5161250">,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161253">//&nbsp;Determined&nbsp;empirically&nbsp;by&nbsp;running&nbsp;the&nbsp;below&nbsp;in&nbsp;various&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161322">//&nbsp;var&nbsp;div&nbsp;=&nbsp;document.createElement(&#34;DIV&#34;);</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161367">//&nbsp;for&nbsp;(var&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161407">//&nbsp;&nbsp;&nbsp;div.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=x&#34;&nbsp;+&nbsp;String.fromCharCode(i)&nbsp;+&nbsp;&#34;-bar&gt;&#34;;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161481">//&nbsp;&nbsp;&nbsp;if&nbsp;(div.getElementsByTagName(&#34;SPAN&#34;)[0].title.indexOf(&#34;bar&#34;)&nbsp;&lt;&nbsp;0)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161553">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;document.write(&#34;&lt;p&gt;U+&#34;&nbsp;+&nbsp;i.toString(16));</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5161603">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161609">delimSpaceOrTagEnd</span><span class="op" id="5161627">:</span>&nbsp;<span class="string" id="5161629">&#34;&nbsp;\t\n\f\r&gt;&#34;</span><span class="op" id="5161641">,</span><br>
<span class="lineno"></span><span class="op" id="5161643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="keyword" id="5161646">var</span>&nbsp;<span class="ident" id="5161650">doctypeBytes</span>&nbsp;<span class="op" id="5161663">=</span>&nbsp;<span class="op" id="5161665">[</span><span class="op" id="5161666">]</span><span class="builtintype" id="5161667">byte</span><span class="op" id="5161671">(</span><span class="string" id="5161672">&#34;&lt;!DOCTYPE&#34;</span><span class="op" id="5161683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5161686">//&nbsp;escapeText&nbsp;escapes&nbsp;a&nbsp;text&nbsp;template&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword" id="5161730">func</span>&nbsp;<span class="op" id="5161735">(</span><span class="ident" id="5161736">e</span>&nbsp;<span class="op" id="5161738">*</span><span class="ident" id="5161739">escaper</span><span class="op" id="5161746">)</span>&nbsp;<span class="ident" id="5161748">escapeText</span><span class="op" id="5161758">(</span><span class="ident" id="5161759">c</span>&nbsp;<span class="ident" id="5161761">context</span><span class="op" id="5161768">,</span>&nbsp;<span class="ident" id="5161770">n</span>&nbsp;<span class="op" id="5161772">*</span><span class="ident" id="5161773">parse</span><span class="op" id="5161778">.</span><span class="ident" id="5161779">TextNode</span><span class="op" id="5161787">)</span>&nbsp;<span class="ident" id="5161789">context</span>&nbsp;<span class="op" id="5161797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161800">s</span><span class="op" id="5161801">,</span>&nbsp;<span class="ident" id="5161803">written</span><span class="op" id="5161810">,</span>&nbsp;<span class="ident" id="5161812">i</span><span class="op" id="5161813">,</span>&nbsp;<span class="ident" id="5161815">b</span>&nbsp;<span class="op" id="5161817">:=</span>&nbsp;<span class="ident" id="5161820">n</span><span class="op" id="5161821">.</span><span class="ident" id="5161822">Text</span><span class="op" id="5161826">,</span>&nbsp;<span class="num" id="5161828">0</span><span class="op" id="5161829">,</span>&nbsp;<span class="num" id="5161831">0</span><span class="op" id="5161832">,</span>&nbsp;<span class="builtinfunc" id="5161834">new</span><span class="op" id="5161837">(</span><span class="ident" id="5161838">bytes</span><span class="op" id="5161843">.</span><span class="ident" id="5161844">Buffer</span><span class="op" id="5161850">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161853">for</span>&nbsp;<span class="ident" id="5161857">i</span>&nbsp;<span class="op" id="5161859">!=</span>&nbsp;<span class="builtinfunc" id="5161862">len</span><span class="op" id="5161865">(</span><span class="ident" id="5161866">s</span><span class="op" id="5161867">)</span>&nbsp;<span class="op" id="5161869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161873">c1</span><span class="op" id="5161875">,</span>&nbsp;<span class="ident" id="5161877">nread</span>&nbsp;<span class="op" id="5161883">:=</span>&nbsp;<span class="ident" id="5161886">contextAfterText</span><span class="op" id="5161902">(</span><span class="ident" id="5161903">c</span><span class="op" id="5161904">,</span>&nbsp;<span class="ident" id="5161906">s</span><span class="op" id="5161907">[</span><span class="ident" id="5161908">i</span><span class="op" id="5161909">:</span><span class="op" id="5161910">]</span><span class="op" id="5161911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161915">i1</span>&nbsp;<span class="op" id="5161918">:=</span>&nbsp;<span class="ident" id="5161921">i</span>&nbsp;<span class="op" id="5161923">+</span>&nbsp;<span class="ident" id="5161925">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5161933">if</span>&nbsp;<span class="ident" id="5161936">c</span><span class="op" id="5161937">.</span><span class="ident" id="5161938">state</span>&nbsp;<span class="op" id="5161944">==</span>&nbsp;<span class="ident" id="5161947">stateText</span>&nbsp;<span class="op" id="5161957">||</span>&nbsp;<span class="ident" id="5161960">c</span><span class="op" id="5161961">.</span><span class="ident" id="5161962">state</span>&nbsp;<span class="op" id="5161968">==</span>&nbsp;<span class="ident" id="5161971">stateRCDATA</span>&nbsp;<span class="op" id="5161983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5161988">end</span>&nbsp;<span class="op" id="5161992">:=</span>&nbsp;<span class="ident" id="5161995">i1</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162001">if</span>&nbsp;<span class="ident" id="5162004">c1</span><span class="op" id="5162006">.</span><span class="ident" id="5162007">state</span>&nbsp;<span class="op" id="5162013">!=</span>&nbsp;<span class="ident" id="5162016">c</span><span class="op" id="5162017">.</span><span class="ident" id="5162018">state</span>&nbsp;<span class="op" id="5162024">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162030">for</span>&nbsp;<span class="ident" id="5162034">j</span>&nbsp;<span class="op" id="5162036">:=</span>&nbsp;<span class="ident" id="5162039">end</span>&nbsp;<span class="op" id="5162043">-</span>&nbsp;<span class="num" id="5162045">1</span><span class="op" id="5162046">;</span>&nbsp;<span class="ident" id="5162048">j</span>&nbsp;<span class="op" id="5162050">&gt;=</span>&nbsp;<span class="ident" id="5162053">i</span><span class="op" id="5162054">;</span>&nbsp;<span class="ident" id="5162056">j</span><span class="op" id="5162057">--</span>&nbsp;<span class="op" id="5162060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162067">if</span>&nbsp;<span class="ident" id="5162070">s</span><span class="op" id="5162071">[</span><span class="ident" id="5162072">j</span><span class="op" id="5162073">]</span>&nbsp;<span class="op" id="5162075">==</span>&nbsp;<span class="string" id="5162078">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5162082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162090">end</span>&nbsp;<span class="op" id="5162094">=</span>&nbsp;<span class="ident" id="5162096">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162104">break</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162131">for</span>&nbsp;<span class="ident" id="5162135">j</span>&nbsp;<span class="op" id="5162137">:=</span>&nbsp;<span class="ident" id="5162140">i</span><span class="op" id="5162141">;</span>&nbsp;<span class="ident" id="5162143">j</span>&nbsp;<span class="op" id="5162145">&lt;</span>&nbsp;<span class="ident" id="5162147">end</span><span class="op" id="5162150">;</span>&nbsp;<span class="ident" id="5162152">j</span><span class="op" id="5162153">++</span>&nbsp;<span class="op" id="5162156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162162">if</span>&nbsp;<span class="ident" id="5162165">s</span><span class="op" id="5162166">[</span><span class="ident" id="5162167">j</span><span class="op" id="5162168">]</span>&nbsp;<span class="op" id="5162170">==</span>&nbsp;<span class="string" id="5162173">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5162177">&amp;&amp;</span>&nbsp;<span class="op" id="5162180">!</span><span class="ident" id="5162181">bytes</span><span class="op" id="5162186">.</span><span class="ident" id="5162187">HasPrefix</span><span class="op" id="5162196">(</span><span class="ident" id="5162197">bytes</span><span class="op" id="5162202">.</span><span class="ident" id="5162203">ToUpper</span><span class="op" id="5162210">(</span><span class="ident" id="5162211">s</span><span class="op" id="5162212">[</span><span class="ident" id="5162213">j</span><span class="op" id="5162214">:</span><span class="op" id="5162215">]</span><span class="op" id="5162216">)</span><span class="op" id="5162217">,</span>&nbsp;<span class="ident" id="5162219">doctypeBytes</span><span class="op" id="5162231">)</span>&nbsp;<span class="op" id="5162233">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162240">b</span><span class="op" id="5162241">.</span><span class="ident" id="5162242">Write</span><span class="op" id="5162247">(</span><span class="ident" id="5162248">s</span><span class="op" id="5162249">[</span><span class="ident" id="5162250">written</span><span class="op" id="5162257">:</span><span class="ident" id="5162258">j</span><span class="op" id="5162259">]</span><span class="op" id="5162260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162267">b</span><span class="op" id="5162268">.</span><span class="ident" id="5162269">WriteString</span><span class="op" id="5162280">(</span><span class="string" id="5162281">&#34;&amp;lt;&#34;</span><span class="op" id="5162287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162294">written</span>&nbsp;<span class="op" id="5162302">=</span>&nbsp;<span class="ident" id="5162304">j</span>&nbsp;<span class="op" id="5162306">+</span>&nbsp;<span class="num" id="5162308">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162319">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162323">}</span>&nbsp;<span class="keyword" id="5162325">else</span>&nbsp;<span class="keyword" id="5162330">if</span>&nbsp;<span class="ident" id="5162333">isComment</span><span class="op" id="5162342">(</span><span class="ident" id="5162343">c</span><span class="op" id="5162344">.</span><span class="ident" id="5162345">state</span><span class="op" id="5162350">)</span>&nbsp;<span class="op" id="5162352">&amp;&amp;</span>&nbsp;<span class="ident" id="5162355">c</span><span class="op" id="5162356">.</span><span class="ident" id="5162357">delim</span>&nbsp;<span class="op" id="5162363">==</span>&nbsp;<span class="ident" id="5162366">delimNone</span>&nbsp;<span class="op" id="5162376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162381">switch</span>&nbsp;<span class="ident" id="5162388">c</span><span class="op" id="5162389">.</span><span class="ident" id="5162390">state</span>&nbsp;<span class="op" id="5162396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162401">case</span>&nbsp;<span class="ident" id="5162406">stateJSBlockCmt</span><span class="op" id="5162421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162427">//&nbsp;http://es5.github.com/#x7.4:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162463">//&nbsp;&#34;Comments&nbsp;behave&nbsp;like&nbsp;white&nbsp;space&nbsp;and&nbsp;are</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162512">//&nbsp;discarded&nbsp;except&nbsp;that,&nbsp;if&nbsp;a&nbsp;MultiLineComment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162564">//&nbsp;contains&nbsp;a&nbsp;line&nbsp;terminator&nbsp;character,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162614">//&nbsp;the&nbsp;entire&nbsp;comment&nbsp;is&nbsp;considered&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162662">//&nbsp;LineTerminator&nbsp;for&nbsp;purposes&nbsp;of&nbsp;parsing&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5162711">//&nbsp;the&nbsp;syntactic&nbsp;grammar.&#34;</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162742">if</span>&nbsp;<span class="ident" id="5162745">bytes</span><span class="op" id="5162750">.</span><span class="ident" id="5162751">IndexAny</span><span class="op" id="5162759">(</span><span class="ident" id="5162760">s</span><span class="op" id="5162761">[</span><span class="ident" id="5162762">written</span><span class="op" id="5162769">:</span><span class="ident" id="5162770">i1</span><span class="op" id="5162772">]</span><span class="op" id="5162773">,</span>&nbsp;<span class="string" id="5162775">&#34;\n\r\u2028\u2029&#34;</span><span class="op" id="5162793">)</span>&nbsp;<span class="op" id="5162795">!=</span>&nbsp;<span class="op" id="5162798">-</span><span class="num" id="5162799">1</span>&nbsp;<span class="op" id="5162801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162808">b</span><span class="op" id="5162809">.</span><span class="ident" id="5162810">WriteByte</span><span class="op" id="5162819">(</span><span class="string" id="5162820">&#39;\n&#39;</span><span class="op" id="5162824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162830">}</span>&nbsp;<span class="keyword" id="5162832">else</span>&nbsp;<span class="op" id="5162837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162844">b</span><span class="op" id="5162845">.</span><span class="ident" id="5162846">WriteByte</span><span class="op" id="5162855">(</span><span class="string" id="5162856">&#39;&nbsp;&#39;</span><span class="op" id="5162859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162865">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162870">case</span>&nbsp;<span class="ident" id="5162875">stateCSSBlockCmt</span><span class="op" id="5162891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162897">b</span><span class="op" id="5162898">.</span><span class="ident" id="5162899">WriteByte</span><span class="op" id="5162908">(</span><span class="string" id="5162909">&#39;&nbsp;&#39;</span><span class="op" id="5162912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5162922">written</span>&nbsp;<span class="op" id="5162930">=</span>&nbsp;<span class="ident" id="5162932">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5162937">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5162941">if</span>&nbsp;<span class="ident" id="5162944">c</span><span class="op" id="5162945">.</span><span class="ident" id="5162946">state</span>&nbsp;<span class="op" id="5162952">!=</span>&nbsp;<span class="ident" id="5162955">c1</span><span class="op" id="5162957">.</span><span class="ident" id="5162958">state</span>&nbsp;<span class="op" id="5162964">&amp;&amp;</span>&nbsp;<span class="ident" id="5162967">isComment</span><span class="op" id="5162976">(</span><span class="ident" id="5162977">c1</span><span class="op" id="5162979">.</span><span class="ident" id="5162980">state</span><span class="op" id="5162985">)</span>&nbsp;<span class="op" id="5162987">&amp;&amp;</span>&nbsp;<span class="ident" id="5162990">c1</span><span class="op" id="5162992">.</span><span class="ident" id="5162993">delim</span>&nbsp;<span class="op" id="5162999">==</span>&nbsp;<span class="ident" id="5163002">delimNone</span>&nbsp;<span class="op" id="5163012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163017">//&nbsp;Preserve&nbsp;the&nbsp;portion&nbsp;between&nbsp;written&nbsp;and&nbsp;the&nbsp;comment&nbsp;start.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163083">cs</span>&nbsp;<span class="op" id="5163086">:=</span>&nbsp;<span class="ident" id="5163089">i1</span>&nbsp;<span class="op" id="5163092">-</span>&nbsp;<span class="num" id="5163094">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163099">if</span>&nbsp;<span class="ident" id="5163102">c1</span><span class="op" id="5163104">.</span><span class="ident" id="5163105">state</span>&nbsp;<span class="op" id="5163111">==</span>&nbsp;<span class="ident" id="5163114">stateHTMLCmt</span>&nbsp;<span class="op" id="5163127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163133">//&nbsp;&#34;&lt;!--&#34;&nbsp;instead&nbsp;of&nbsp;&#34;/*&#34;&nbsp;or&nbsp;&#34;//&#34;</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163171">cs</span>&nbsp;<span class="op" id="5163174">-=</span>&nbsp;<span class="num" id="5163177">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163182">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163187">b</span><span class="op" id="5163188">.</span><span class="ident" id="5163189">Write</span><span class="op" id="5163194">(</span><span class="ident" id="5163195">s</span><span class="op" id="5163196">[</span><span class="ident" id="5163197">written</span><span class="op" id="5163204">:</span><span class="ident" id="5163205">cs</span><span class="op" id="5163207">]</span><span class="op" id="5163208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163213">written</span>&nbsp;<span class="op" id="5163221">=</span>&nbsp;<span class="ident" id="5163223">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163228">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163232">if</span>&nbsp;<span class="ident" id="5163235">i</span>&nbsp;<span class="op" id="5163237">==</span>&nbsp;<span class="ident" id="5163240">i1</span>&nbsp;<span class="op" id="5163243">&amp;&amp;</span>&nbsp;<span class="ident" id="5163246">c</span><span class="op" id="5163247">.</span><span class="ident" id="5163248">state</span>&nbsp;<span class="op" id="5163254">==</span>&nbsp;<span class="ident" id="5163257">c1</span><span class="op" id="5163259">.</span><span class="ident" id="5163260">state</span>&nbsp;<span class="op" id="5163266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5163271">panic</span><span class="op" id="5163276">(</span><span class="ident" id="5163277">fmt</span><span class="op" id="5163280">.</span><span class="ident" id="5163281">Sprintf</span><span class="op" id="5163288">(</span><span class="string" id="5163289">&#34;infinite&nbsp;loop&nbsp;from&nbsp;%v&nbsp;to&nbsp;%v&nbsp;on&nbsp;%q..%q&#34;</span><span class="op" id="5163328">,</span>&nbsp;<span class="ident" id="5163330">c</span><span class="op" id="5163331">,</span>&nbsp;<span class="ident" id="5163333">c1</span><span class="op" id="5163335">,</span>&nbsp;<span class="ident" id="5163337">s</span><span class="op" id="5163338">[</span><span class="op" id="5163339">:</span><span class="ident" id="5163340">i</span><span class="op" id="5163341">]</span><span class="op" id="5163342">,</span>&nbsp;<span class="ident" id="5163344">s</span><span class="op" id="5163345">[</span><span class="ident" id="5163346">i</span><span class="op" id="5163347">:</span><span class="op" id="5163348">]</span><span class="op" id="5163349">)</span><span class="op" id="5163350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163358">c</span><span class="op" id="5163359">,</span>&nbsp;<span class="ident" id="5163361">i</span>&nbsp;<span class="op" id="5163363">=</span>&nbsp;<span class="ident" id="5163365">c1</span><span class="op" id="5163367">,</span>&nbsp;<span class="ident" id="5163369">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163373">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163377">if</span>&nbsp;<span class="ident" id="5163380">written</span>&nbsp;<span class="op" id="5163388">!=</span>&nbsp;<span class="num" id="5163391">0</span>&nbsp;<span class="op" id="5163393">&amp;&amp;</span>&nbsp;<span class="ident" id="5163396">c</span><span class="op" id="5163397">.</span><span class="ident" id="5163398">state</span>&nbsp;<span class="op" id="5163404">!=</span>&nbsp;<span class="ident" id="5163407">stateError</span>&nbsp;<span class="op" id="5163418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163422">if</span>&nbsp;<span class="op" id="5163425">!</span><span class="ident" id="5163426">isComment</span><span class="op" id="5163435">(</span><span class="ident" id="5163436">c</span><span class="op" id="5163437">.</span><span class="ident" id="5163438">state</span><span class="op" id="5163443">)</span>&nbsp;<span class="op" id="5163445">||</span>&nbsp;<span class="ident" id="5163448">c</span><span class="op" id="5163449">.</span><span class="ident" id="5163450">delim</span>&nbsp;<span class="op" id="5163456">!=</span>&nbsp;<span class="ident" id="5163459">delimNone</span>&nbsp;<span class="op" id="5163469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163474">b</span><span class="op" id="5163475">.</span><span class="ident" id="5163476">Write</span><span class="op" id="5163481">(</span><span class="ident" id="5163482">n</span><span class="op" id="5163483">.</span><span class="ident" id="5163484">Text</span><span class="op" id="5163488">[</span><span class="ident" id="5163489">written</span><span class="op" id="5163496">:</span><span class="op" id="5163497">]</span><span class="op" id="5163498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163502">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163506">e</span><span class="op" id="5163507">.</span><span class="ident" id="5163508">editTextNode</span><span class="op" id="5163520">(</span><span class="ident" id="5163521">n</span><span class="op" id="5163522">,</span>&nbsp;<span class="ident" id="5163524">b</span><span class="op" id="5163525">.</span><span class="ident" id="5163526">Bytes</span><span class="op" id="5163531">(</span><span class="op" id="5163532">)</span><span class="op" id="5163533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163539">return</span>&nbsp;<span class="ident" id="5163546">c</span><br>
<span class="lineno"></span><span class="op" id="5163548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment" id="5163551">//&nbsp;contextAfterText&nbsp;starts&nbsp;in&nbsp;context&nbsp;c,&nbsp;consumes&nbsp;some&nbsp;tokens&nbsp;from&nbsp;the&nbsp;front&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5163631">//&nbsp;s,&nbsp;then&nbsp;returns&nbsp;the&nbsp;context&nbsp;after&nbsp;those&nbsp;tokens&nbsp;and&nbsp;the&nbsp;unprocessed&nbsp;suffix.</span><br>
<span class="lineno"></span><span class="keyword" id="5163709">func</span>&nbsp;<span class="ident" id="5163714">contextAfterText</span><span class="op" id="5163730">(</span><span class="ident" id="5163731">c</span>&nbsp;<span class="ident" id="5163733">context</span><span class="op" id="5163740">,</span>&nbsp;<span class="ident" id="5163742">s</span>&nbsp;<span class="op" id="5163744">[</span><span class="op" id="5163745">]</span><span class="builtintype" id="5163746">byte</span><span class="op" id="5163750">)</span>&nbsp;<span class="op" id="5163752">(</span><span class="ident" id="5163753">context</span><span class="op" id="5163760">,</span>&nbsp;<span class="builtintype" id="5163762">int</span><span class="op" id="5163765">)</span>&nbsp;<span class="op" id="5163767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163770">if</span>&nbsp;<span class="ident" id="5163773">c</span><span class="op" id="5163774">.</span><span class="ident" id="5163775">delim</span>&nbsp;<span class="op" id="5163781">==</span>&nbsp;<span class="ident" id="5163784">delimNone</span>&nbsp;<span class="op" id="5163794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5163798">c1</span><span class="op" id="5163800">,</span>&nbsp;<span class="ident" id="5163802">i</span>&nbsp;<span class="op" id="5163804">:=</span>&nbsp;<span class="ident" id="5163807">tSpecialTagEnd</span><span class="op" id="5163821">(</span><span class="ident" id="5163822">c</span><span class="op" id="5163823">,</span>&nbsp;<span class="ident" id="5163825">s</span><span class="op" id="5163826">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163830">if</span>&nbsp;<span class="ident" id="5163833">i</span>&nbsp;<span class="op" id="5163835">==</span>&nbsp;<span class="num" id="5163838">0</span>&nbsp;<span class="op" id="5163840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163845">//&nbsp;A&nbsp;special&nbsp;end&nbsp;tag&nbsp;(`&lt;/script&gt;`)&nbsp;has&nbsp;been&nbsp;seen&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163901">//&nbsp;all&nbsp;content&nbsp;preceding&nbsp;it&nbsp;has&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5163951">return</span>&nbsp;<span class="ident" id="5163958">c1</span><span class="op" id="5163960">,</span>&nbsp;<span class="num" id="5163962">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5163966">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5163970">//&nbsp;Consider&nbsp;all&nbsp;content&nbsp;up&nbsp;to&nbsp;any&nbsp;end&nbsp;tag.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164015">return</span>&nbsp;<span class="ident" id="5164022">transitionFunc</span><span class="op" id="5164036">[</span><span class="ident" id="5164037">c</span><span class="op" id="5164038">.</span><span class="ident" id="5164039">state</span><span class="op" id="5164044">]</span><span class="op" id="5164045">(</span><span class="ident" id="5164046">c</span><span class="op" id="5164047">,</span>&nbsp;<span class="ident" id="5164049">s</span><span class="op" id="5164050">[</span><span class="op" id="5164051">:</span><span class="ident" id="5164052">i</span><span class="op" id="5164053">]</span><span class="op" id="5164054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164061">i</span>&nbsp;<span class="op" id="5164063">:=</span>&nbsp;<span class="ident" id="5164066">bytes</span><span class="op" id="5164071">.</span><span class="ident" id="5164072">IndexAny</span><span class="op" id="5164080">(</span><span class="ident" id="5164081">s</span><span class="op" id="5164082">,</span>&nbsp;<span class="ident" id="5164084">delimEnds</span><span class="op" id="5164093">[</span><span class="ident" id="5164094">c</span><span class="op" id="5164095">.</span><span class="ident" id="5164096">delim</span><span class="op" id="5164101">]</span><span class="op" id="5164102">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164105">if</span>&nbsp;<span class="ident" id="5164108">i</span>&nbsp;<span class="op" id="5164110">==</span>&nbsp;<span class="op" id="5164113">-</span><span class="num" id="5164114">1</span>&nbsp;<span class="op" id="5164116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164120">i</span>&nbsp;<span class="op" id="5164122">=</span>&nbsp;<span class="builtinfunc" id="5164124">len</span><span class="op" id="5164127">(</span><span class="ident" id="5164128">s</span><span class="op" id="5164129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164135">if</span>&nbsp;<span class="ident" id="5164138">c</span><span class="op" id="5164139">.</span><span class="ident" id="5164140">delim</span>&nbsp;<span class="op" id="5164146">==</span>&nbsp;<span class="ident" id="5164149">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5164168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164172">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164249">//&nbsp;lists&nbsp;the&nbsp;runes&nbsp;below&nbsp;as&nbsp;error&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164297">//&nbsp;Error&nbsp;out&nbsp;because&nbsp;HTML&nbsp;parsers&nbsp;may&nbsp;differ&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164355">//&nbsp;&#34;&lt;a&nbsp;id=&nbsp;onclick=f(&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;id&#39;s&nbsp;or&nbsp;onclick&#39;s&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164421">//&nbsp;&#34;&lt;a&nbsp;class=`foo&nbsp;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ends&nbsp;inside&nbsp;a&nbsp;value,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164471">//&nbsp;&#34;&lt;a&nbsp;style=font:&#39;Arial&#39;&#34;&nbsp;needs&nbsp;open-quote&nbsp;fixup.</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164524">//&nbsp;IE&nbsp;treats&nbsp;&#39;`&#39;&nbsp;as&nbsp;a&nbsp;quotation&nbsp;character.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164569">if</span>&nbsp;<span class="ident" id="5164572">j</span>&nbsp;<span class="op" id="5164574">:=</span>&nbsp;<span class="ident" id="5164577">bytes</span><span class="op" id="5164582">.</span><span class="ident" id="5164583">IndexAny</span><span class="op" id="5164591">(</span><span class="ident" id="5164592">s</span><span class="op" id="5164593">[</span><span class="op" id="5164594">:</span><span class="ident" id="5164595">i</span><span class="op" id="5164596">]</span><span class="op" id="5164597">,</span>&nbsp;<span class="string" id="5164599">&#34;\&#34;&#39;&lt;=`&#34;</span><span class="op" id="5164607">)</span><span class="op" id="5164608">;</span>&nbsp;<span class="ident" id="5164610">j</span>&nbsp;<span class="op" id="5164612">&gt;=</span>&nbsp;<span class="num" id="5164615">0</span>&nbsp;<span class="op" id="5164617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164622">return</span>&nbsp;<span class="ident" id="5164629">context</span><span class="op" id="5164636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164642">state</span><span class="op" id="5164647">:</span>&nbsp;<span class="ident" id="5164649">stateError</span><span class="op" id="5164659">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5164665">err</span><span class="op" id="5164668">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5164672">errorf</span><span class="op" id="5164678">(</span><span class="ident" id="5164679">ErrBadHTML</span><span class="op" id="5164689">,</span>&nbsp;<span class="ident" id="5164691">nil</span><span class="op" id="5164694">,</span>&nbsp;<span class="num" id="5164696">0</span><span class="op" id="5164697">,</span>&nbsp;<span class="string" id="5164699">&#34;%q&nbsp;in&nbsp;unquoted&nbsp;attr:&nbsp;%q&#34;</span><span class="op" id="5164724">,</span>&nbsp;<span class="ident" id="5164726">s</span><span class="op" id="5164727">[</span><span class="ident" id="5164728">j</span><span class="op" id="5164729">:</span><span class="ident" id="5164730">j</span><span class="op" id="5164731">+</span><span class="num" id="5164732">1</span><span class="op" id="5164733">]</span><span class="op" id="5164734">,</span>&nbsp;<span class="ident" id="5164736">s</span><span class="op" id="5164737">[</span><span class="op" id="5164738">:</span><span class="ident" id="5164739">i</span><span class="op" id="5164740">]</span><span class="op" id="5164741">)</span><span class="op" id="5164742">,</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164747">}</span><span class="op" id="5164748">,</span>&nbsp;<span class="builtinfunc" id="5164750">len</span><span class="op" id="5164753">(</span><span class="ident" id="5164754">s</span><span class="op" id="5164755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5164762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164765">if</span>&nbsp;<span class="ident" id="5164768">i</span>&nbsp;<span class="op" id="5164770">==</span>&nbsp;<span class="builtinfunc" id="5164773">len</span><span class="op" id="5164776">(</span><span class="ident" id="5164777">s</span><span class="op" id="5164778">)</span>&nbsp;<span class="op" id="5164780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164784">//&nbsp;Remain&nbsp;inside&nbsp;the&nbsp;attribute.</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164818">//&nbsp;Decode&nbsp;the&nbsp;value&nbsp;so&nbsp;non-HTML&nbsp;rules&nbsp;can&nbsp;easily&nbsp;handle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164876">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;button&nbsp;onclick=&#34;alert(&amp;quot;Hi!&amp;quot;)&#34;&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5164927">//&nbsp;without&nbsp;having&nbsp;to&nbsp;entity&nbsp;decode&nbsp;token&nbsp;boundaries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5164982">for</span>&nbsp;<span class="ident" id="5164986">u</span>&nbsp;<span class="op" id="5164988">:=</span>&nbsp;<span class="op" id="5164991">[</span><span class="op" id="5164992">]</span><span class="builtintype" id="5164993">byte</span><span class="op" id="5164997">(</span><span class="ident" id="5164998">html</span><span class="op" id="5165002">.</span><span class="ident" id="5165003">UnescapeString</span><span class="op" id="5165017">(</span><span class="builtintype" id="5165018">string</span><span class="op" id="5165024">(</span><span class="ident" id="5165025">s</span><span class="op" id="5165026">)</span><span class="op" id="5165027">)</span><span class="op" id="5165028">)</span><span class="op" id="5165029">;</span>&nbsp;<span class="builtinfunc" id="5165031">len</span><span class="op" id="5165034">(</span><span class="ident" id="5165035">u</span><span class="op" id="5165036">)</span>&nbsp;<span class="op" id="5165038">!=</span>&nbsp;<span class="num" id="5165041">0</span><span class="op" id="5165042">;</span>&nbsp;<span class="op" id="5165044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165049">c1</span><span class="op" id="5165051">,</span>&nbsp;<span class="ident" id="5165053">i1</span>&nbsp;<span class="op" id="5165056">:=</span>&nbsp;<span class="ident" id="5165059">transitionFunc</span><span class="op" id="5165073">[</span><span class="ident" id="5165074">c</span><span class="op" id="5165075">.</span><span class="ident" id="5165076">state</span><span class="op" id="5165081">]</span><span class="op" id="5165082">(</span><span class="ident" id="5165083">c</span><span class="op" id="5165084">,</span>&nbsp;<span class="ident" id="5165086">u</span><span class="op" id="5165087">)</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165092">c</span><span class="op" id="5165093">,</span>&nbsp;<span class="ident" id="5165095">u</span>&nbsp;<span class="op" id="5165097">=</span>&nbsp;<span class="ident" id="5165099">c1</span><span class="op" id="5165101">,</span>&nbsp;<span class="ident" id="5165103">u</span><span class="op" id="5165104">[</span><span class="ident" id="5165105">i1</span><span class="op" id="5165107">:</span><span class="op" id="5165108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5165112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5165116">return</span>&nbsp;<span class="ident" id="5165123">c</span><span class="op" id="5165124">,</span>&nbsp;<span class="builtinfunc" id="5165126">len</span><span class="op" id="5165129">(</span><span class="ident" id="5165130">s</span><span class="op" id="5165131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5165134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5165137">if</span>&nbsp;<span class="ident" id="5165140">c</span><span class="op" id="5165141">.</span><span class="ident" id="5165142">delim</span>&nbsp;<span class="op" id="5165148">!=</span>&nbsp;<span class="ident" id="5165151">delimSpaceOrTagEnd</span>&nbsp;<span class="op" id="5165170">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5165174">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165198">i</span><span class="op" id="5165199">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5165203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5165206">//&nbsp;On&nbsp;exiting&nbsp;an&nbsp;attribute,&nbsp;we&nbsp;discard&nbsp;all&nbsp;state&nbsp;information</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5165268">//&nbsp;except&nbsp;the&nbsp;state&nbsp;and&nbsp;element.</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5165302">return</span>&nbsp;<span class="ident" id="5165309">context</span><span class="op" id="5165316">{</span><span class="ident" id="5165317">state</span><span class="op" id="5165322">:</span>&nbsp;<span class="ident" id="5165324">stateTag</span><span class="op" id="5165332">,</span>&nbsp;<span class="ident" id="5165334">element</span><span class="op" id="5165341">:</span>&nbsp;<span class="ident" id="5165343">c</span><span class="op" id="5165344">.</span><span class="ident" id="5165345">element</span><span class="op" id="5165352">}</span><span class="op" id="5165353">,</span>&nbsp;<span class="ident" id="5165355">i</span><br>
<span class="lineno"></span><span class="op" id="5165357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165360">//&nbsp;editActionNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;an&nbsp;action&nbsp;pipeline&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5165435">func</span>&nbsp;<span class="op" id="5165440">(</span><span class="ident" id="5165441">e</span>&nbsp;<span class="op" id="5165443">*</span><span class="ident" id="5165444">escaper</span><span class="op" id="5165451">)</span>&nbsp;<span class="ident" id="5165453">editActionNode</span><span class="op" id="5165467">(</span><span class="ident" id="5165468">n</span>&nbsp;<span class="op" id="5165470">*</span><span class="ident" id="5165471">parse</span><span class="op" id="5165476">.</span><span class="ident" id="5165477">ActionNode</span><span class="op" id="5165487">,</span>&nbsp;<span class="ident" id="5165489">cmds</span>&nbsp;<span class="op" id="5165494">[</span><span class="op" id="5165495">]</span><span class="builtintype" id="5165496">string</span><span class="op" id="5165502">)</span>&nbsp;<span class="op" id="5165504">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5165507">if</span>&nbsp;<span class="ident" id="5165510">_</span><span class="op" id="5165511">,</span>&nbsp;<span class="ident" id="5165513">ok</span>&nbsp;<span class="op" id="5165516">:=</span>&nbsp;<span class="ident" id="5165519">e</span><span class="op" id="5165520">.</span><span class="ident" id="5165521">actionNodeEdits</span><span class="op" id="5165536">[</span><span class="ident" id="5165537">n</span><span class="op" id="5165538">]</span><span class="op" id="5165539">;</span>&nbsp;<span class="ident" id="5165541">ok</span>&nbsp;<span class="op" id="5165544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5165548">panic</span><span class="op" id="5165553">(</span><span class="ident" id="5165554">fmt</span><span class="op" id="5165557">.</span><span class="ident" id="5165558">Sprintf</span><span class="op" id="5165565">(</span><span class="string" id="5165566">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5165600">,</span>&nbsp;<span class="ident" id="5165602">n</span><span class="op" id="5165603">)</span><span class="op" id="5165604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5165607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165610">e</span><span class="op" id="5165611">.</span><span class="ident" id="5165612">actionNodeEdits</span><span class="op" id="5165627">[</span><span class="ident" id="5165628">n</span><span class="op" id="5165629">]</span>&nbsp;<span class="op" id="5165631">=</span>&nbsp;<span class="ident" id="5165633">cmds</span><br>
<span class="lineno"></span><span class="op" id="5165638">}</span><br>
<span class="lineno">720</span><br>
<span class="lineno"></span><span class="comment" id="5165641">//&nbsp;editTemplateNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;{{template}}&nbsp;callee&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno"></span><span class="keyword" id="5165721">func</span>&nbsp;<span class="op" id="5165726">(</span><span class="ident" id="5165727">e</span>&nbsp;<span class="op" id="5165729">*</span><span class="ident" id="5165730">escaper</span><span class="op" id="5165737">)</span>&nbsp;<span class="ident" id="5165739">editTemplateNode</span><span class="op" id="5165755">(</span><span class="ident" id="5165756">n</span>&nbsp;<span class="op" id="5165758">*</span><span class="ident" id="5165759">parse</span><span class="op" id="5165764">.</span><span class="ident" id="5165765">TemplateNode</span><span class="op" id="5165777">,</span>&nbsp;<span class="ident" id="5165779">callee</span>&nbsp;<span class="builtintype" id="5165786">string</span><span class="op" id="5165792">)</span>&nbsp;<span class="op" id="5165794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5165797">if</span>&nbsp;<span class="ident" id="5165800">_</span><span class="op" id="5165801">,</span>&nbsp;<span class="ident" id="5165803">ok</span>&nbsp;<span class="op" id="5165806">:=</span>&nbsp;<span class="ident" id="5165809">e</span><span class="op" id="5165810">.</span><span class="ident" id="5165811">templateNodeEdits</span><span class="op" id="5165828">[</span><span class="ident" id="5165829">n</span><span class="op" id="5165830">]</span><span class="op" id="5165831">;</span>&nbsp;<span class="ident" id="5165833">ok</span>&nbsp;<span class="op" id="5165836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5165840">panic</span><span class="op" id="5165845">(</span><span class="ident" id="5165846">fmt</span><span class="op" id="5165849">.</span><span class="ident" id="5165850">Sprintf</span><span class="op" id="5165857">(</span><span class="string" id="5165858">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5165892">,</span>&nbsp;<span class="ident" id="5165894">n</span><span class="op" id="5165895">)</span><span class="op" id="5165896">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5165899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5165902">e</span><span class="op" id="5165903">.</span><span class="ident" id="5165904">templateNodeEdits</span><span class="op" id="5165921">[</span><span class="ident" id="5165922">n</span><span class="op" id="5165923">]</span>&nbsp;<span class="op" id="5165925">=</span>&nbsp;<span class="ident" id="5165927">callee</span><br>
<span class="lineno"></span><span class="op" id="5165934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165937">//&nbsp;editTextNode&nbsp;records&nbsp;a&nbsp;change&nbsp;to&nbsp;a&nbsp;text&nbsp;node&nbsp;for&nbsp;later&nbsp;commit.</span><br>
<span class="lineno">730</span><span class="keyword" id="5166003">func</span>&nbsp;<span class="op" id="5166008">(</span><span class="ident" id="5166009">e</span>&nbsp;<span class="op" id="5166011">*</span><span class="ident" id="5166012">escaper</span><span class="op" id="5166019">)</span>&nbsp;<span class="ident" id="5166021">editTextNode</span><span class="op" id="5166033">(</span><span class="ident" id="5166034">n</span>&nbsp;<span class="op" id="5166036">*</span><span class="ident" id="5166037">parse</span><span class="op" id="5166042">.</span><span class="ident" id="5166043">TextNode</span><span class="op" id="5166051">,</span>&nbsp;<span class="ident" id="5166053">text</span>&nbsp;<span class="op" id="5166058">[</span><span class="op" id="5166059">]</span><span class="builtintype" id="5166060">byte</span><span class="op" id="5166064">)</span>&nbsp;<span class="op" id="5166066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166069">if</span>&nbsp;<span class="ident" id="5166072">_</span><span class="op" id="5166073">,</span>&nbsp;<span class="ident" id="5166075">ok</span>&nbsp;<span class="op" id="5166078">:=</span>&nbsp;<span class="ident" id="5166081">e</span><span class="op" id="5166082">.</span><span class="ident" id="5166083">textNodeEdits</span><span class="op" id="5166096">[</span><span class="ident" id="5166097">n</span><span class="op" id="5166098">]</span><span class="op" id="5166099">;</span>&nbsp;<span class="ident" id="5166101">ok</span>&nbsp;<span class="op" id="5166104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5166108">panic</span><span class="op" id="5166113">(</span><span class="ident" id="5166114">fmt</span><span class="op" id="5166117">.</span><span class="ident" id="5166118">Sprintf</span><span class="op" id="5166125">(</span><span class="string" id="5166126">&#34;node&nbsp;%s&nbsp;shared&nbsp;between&nbsp;templates&#34;</span><span class="op" id="5166160">,</span>&nbsp;<span class="ident" id="5166162">n</span><span class="op" id="5166163">)</span><span class="op" id="5166164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166167">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166170">e</span><span class="op" id="5166171">.</span><span class="ident" id="5166172">textNodeEdits</span><span class="op" id="5166185">[</span><span class="ident" id="5166186">n</span><span class="op" id="5166187">]</span>&nbsp;<span class="op" id="5166189">=</span>&nbsp;<span class="ident" id="5166191">text</span><br>
<span class="lineno">735</span><span class="op" id="5166196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166199">//&nbsp;commit&nbsp;applies&nbsp;changes&nbsp;to&nbsp;actions&nbsp;and&nbsp;template&nbsp;calls&nbsp;needed&nbsp;to&nbsp;contextually</span><br>
<span class="lineno"></span><span class="comment" id="5166278">//&nbsp;autoescape&nbsp;content&nbsp;and&nbsp;adds&nbsp;any&nbsp;derived&nbsp;templates&nbsp;to&nbsp;the&nbsp;set.</span><br>
<span class="lineno"></span><span class="keyword" id="5166343">func</span>&nbsp;<span class="op" id="5166348">(</span><span class="ident" id="5166349">e</span>&nbsp;<span class="op" id="5166351">*</span><span class="ident" id="5166352">escaper</span><span class="op" id="5166359">)</span>&nbsp;<span class="ident" id="5166361">commit</span><span class="op" id="5166367">(</span><span class="op" id="5166368">)</span>&nbsp;<span class="op" id="5166370">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166373">for</span>&nbsp;<span class="ident" id="5166377">name</span>&nbsp;<span class="op" id="5166382">:=</span>&nbsp;<span class="keyword" id="5166385">range</span>&nbsp;<span class="ident" id="5166391">e</span><span class="op" id="5166392">.</span><span class="ident" id="5166393">output</span>&nbsp;<span class="op" id="5166400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166404">e</span><span class="op" id="5166405">.</span><span class="ident" id="5166406">template</span><span class="op" id="5166414">(</span><span class="ident" id="5166415">name</span><span class="op" id="5166419">)</span><span class="op" id="5166420">.</span><span class="ident" id="5166421">Funcs</span><span class="op" id="5166426">(</span><span class="ident" id="5166427">funcMap</span><span class="op" id="5166434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166440">for</span>&nbsp;<span class="ident" id="5166444">_</span><span class="op" id="5166445">,</span>&nbsp;<span class="ident" id="5166447">t</span>&nbsp;<span class="op" id="5166449">:=</span>&nbsp;<span class="keyword" id="5166452">range</span>&nbsp;<span class="ident" id="5166458">e</span><span class="op" id="5166459">.</span><span class="ident" id="5166460">derived</span>&nbsp;<span class="op" id="5166468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166472">if</span>&nbsp;<span class="ident" id="5166475">_</span><span class="op" id="5166476">,</span>&nbsp;<span class="ident" id="5166478">err</span>&nbsp;<span class="op" id="5166482">:=</span>&nbsp;<span class="ident" id="5166485">e</span><span class="op" id="5166486">.</span><span class="ident" id="5166487">tmpl</span><span class="op" id="5166491">.</span><span class="ident" id="5166492">text</span><span class="op" id="5166496">.</span><span class="ident" id="5166497">AddParseTree</span><span class="op" id="5166509">(</span><span class="ident" id="5166510">t</span><span class="op" id="5166511">.</span><span class="ident" id="5166512">Name</span><span class="op" id="5166516">(</span><span class="op" id="5166517">)</span><span class="op" id="5166518">,</span>&nbsp;<span class="ident" id="5166520">t</span><span class="op" id="5166521">.</span><span class="ident" id="5166522">Tree</span><span class="op" id="5166526">)</span><span class="op" id="5166527">;</span>&nbsp;<span class="ident" id="5166529">err</span>&nbsp;<span class="op" id="5166533">!=</span>&nbsp;<span class="ident" id="5166536">nil</span>&nbsp;<span class="op" id="5166540">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5166545">panic</span><span class="op" id="5166550">(</span><span class="string" id="5166551">&#34;error&nbsp;adding&nbsp;derived&nbsp;template&#34;</span><span class="op" id="5166582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166592">for</span>&nbsp;<span class="ident" id="5166596">n</span><span class="op" id="5166597">,</span>&nbsp;<span class="ident" id="5166599">s</span>&nbsp;<span class="op" id="5166601">:=</span>&nbsp;<span class="keyword" id="5166604">range</span>&nbsp;<span class="ident" id="5166610">e</span><span class="op" id="5166611">.</span><span class="ident" id="5166612">actionNodeEdits</span>&nbsp;<span class="op" id="5166628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166632">ensurePipelineContains</span><span class="op" id="5166654">(</span><span class="ident" id="5166655">n</span><span class="op" id="5166656">.</span><span class="ident" id="5166657">Pipe</span><span class="op" id="5166661">,</span>&nbsp;<span class="ident" id="5166663">s</span><span class="op" id="5166664">)</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166670">for</span>&nbsp;<span class="ident" id="5166674">n</span><span class="op" id="5166675">,</span>&nbsp;<span class="ident" id="5166677">name</span>&nbsp;<span class="op" id="5166682">:=</span>&nbsp;<span class="keyword" id="5166685">range</span>&nbsp;<span class="ident" id="5166691">e</span><span class="op" id="5166692">.</span><span class="ident" id="5166693">templateNodeEdits</span>&nbsp;<span class="op" id="5166711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166715">n</span><span class="op" id="5166716">.</span><span class="ident" id="5166717">Name</span>&nbsp;<span class="op" id="5166722">=</span>&nbsp;<span class="ident" id="5166724">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166733">for</span>&nbsp;<span class="ident" id="5166737">n</span><span class="op" id="5166738">,</span>&nbsp;<span class="ident" id="5166740">s</span>&nbsp;<span class="op" id="5166742">:=</span>&nbsp;<span class="keyword" id="5166745">range</span>&nbsp;<span class="ident" id="5166751">e</span><span class="op" id="5166752">.</span><span class="ident" id="5166753">textNodeEdits</span>&nbsp;<span class="op" id="5166767">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166771">n</span><span class="op" id="5166772">.</span><span class="ident" id="5166773">Text</span>&nbsp;<span class="op" id="5166778">=</span>&nbsp;<span class="ident" id="5166780">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166783">}</span><br>
<span class="lineno"></span><span class="op" id="5166785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166788">//&nbsp;template&nbsp;returns&nbsp;the&nbsp;named&nbsp;template&nbsp;given&nbsp;a&nbsp;mangled&nbsp;template&nbsp;name.</span><br>
<span class="lineno">760</span><span class="keyword" id="5166858">func</span>&nbsp;<span class="op" id="5166863">(</span><span class="ident" id="5166864">e</span>&nbsp;<span class="op" id="5166866">*</span><span class="ident" id="5166867">escaper</span><span class="op" id="5166874">)</span>&nbsp;<span class="ident" id="5166876">template</span><span class="op" id="5166884">(</span><span class="ident" id="5166885">name</span>&nbsp;<span class="builtintype" id="5166890">string</span><span class="op" id="5166896">)</span>&nbsp;<span class="op" id="5166898">*</span><span class="ident" id="5166899">template</span><span class="op" id="5166907">.</span><span class="ident" id="5166908">Template</span>&nbsp;<span class="op" id="5166917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166920">t</span>&nbsp;<span class="op" id="5166922">:=</span>&nbsp;<span class="ident" id="5166925">e</span><span class="op" id="5166926">.</span><span class="ident" id="5166927">tmpl</span><span class="op" id="5166931">.</span><span class="ident" id="5166932">text</span><span class="op" id="5166936">.</span><span class="ident" id="5166937">Lookup</span><span class="op" id="5166943">(</span><span class="ident" id="5166944">name</span><span class="op" id="5166948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166951">if</span>&nbsp;<span class="ident" id="5166954">t</span>&nbsp;<span class="op" id="5166956">==</span>&nbsp;<span class="ident" id="5166959">nil</span>&nbsp;<span class="op" id="5166963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5166967">t</span>&nbsp;<span class="op" id="5166969">=</span>&nbsp;<span class="ident" id="5166971">e</span><span class="op" id="5166972">.</span><span class="ident" id="5166973">derived</span><span class="op" id="5166980">[</span><span class="ident" id="5166981">name</span><span class="op" id="5166985">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5166988">}</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5166991">return</span>&nbsp;<span class="ident" id="5166998">t</span><br>
<span class="lineno"></span><span class="op" id="5167000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167003">//&nbsp;Forwarding&nbsp;functions&nbsp;so&nbsp;that&nbsp;clients&nbsp;need&nbsp;only&nbsp;import&nbsp;this&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="5167073">//&nbsp;to&nbsp;reach&nbsp;the&nbsp;general&nbsp;escaping&nbsp;functions&nbsp;of&nbsp;text/template.</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="5167135">//&nbsp;HTMLEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5167215">func</span>&nbsp;<span class="ident" id="5167220">HTMLEscape</span><span class="op" id="5167230">(</span><span class="ident" id="5167231">w</span>&nbsp;<span class="ident" id="5167233">io</span><span class="op" id="5167235">.</span><span class="ident" id="5167236">Writer</span><span class="op" id="5167242">,</span>&nbsp;<span class="ident" id="5167244">b</span>&nbsp;<span class="op" id="5167246">[</span><span class="op" id="5167247">]</span><span class="builtintype" id="5167248">byte</span><span class="op" id="5167252">)</span>&nbsp;<span class="op" id="5167254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167257">template</span><span class="op" id="5167265">.</span><span class="ident" id="5167266">HTMLEscape</span><span class="op" id="5167276">(</span><span class="ident" id="5167277">w</span><span class="op" id="5167278">,</span>&nbsp;<span class="ident" id="5167280">b</span><span class="op" id="5167281">)</span><br>
<span class="lineno"></span><span class="op" id="5167283">}</span><br>
<span class="lineno">775</span><br>
<span class="lineno"></span><span class="comment" id="5167286">//&nbsp;HTMLEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5167368">func</span>&nbsp;<span class="ident" id="5167373">HTMLEscapeString</span><span class="op" id="5167389">(</span><span class="ident" id="5167390">s</span>&nbsp;<span class="builtintype" id="5167392">string</span><span class="op" id="5167398">)</span>&nbsp;<span class="builtintype" id="5167400">string</span>&nbsp;<span class="op" id="5167407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167410">return</span>&nbsp;<span class="ident" id="5167417">template</span><span class="op" id="5167425">.</span><span class="ident" id="5167426">HTMLEscapeString</span><span class="op" id="5167442">(</span><span class="ident" id="5167443">s</span><span class="op" id="5167444">)</span><br>
<span class="lineno"></span><span class="op" id="5167446">}</span><br>
<span class="lineno">780</span><br>
<span class="lineno"></span><span class="comment" id="5167449">//&nbsp;HTMLEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;HTML&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5167515">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5167551">func</span>&nbsp;<span class="ident" id="5167556">HTMLEscaper</span><span class="op" id="5167567">(</span><span class="ident" id="5167568">args</span>&nbsp;<span class="op" id="5167573">...</span><span class="keyword" id="5167576">interface</span><span class="op" id="5167585">{</span><span class="op" id="5167586">}</span><span class="op" id="5167587">)</span>&nbsp;<span class="builtintype" id="5167589">string</span>&nbsp;<span class="op" id="5167596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167599">return</span>&nbsp;<span class="ident" id="5167606">template</span><span class="op" id="5167614">.</span><span class="ident" id="5167615">HTMLEscaper</span><span class="op" id="5167626">(</span><span class="ident" id="5167627">args</span><span class="op" id="5167631">...</span><span class="op" id="5167634">)</span><br>
<span class="lineno">785</span><span class="op" id="5167636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167639">//&nbsp;JSEscape&nbsp;writes&nbsp;to&nbsp;w&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword" id="5167723">func</span>&nbsp;<span class="ident" id="5167728">JSEscape</span><span class="op" id="5167736">(</span><span class="ident" id="5167737">w</span>&nbsp;<span class="ident" id="5167739">io</span><span class="op" id="5167741">.</span><span class="ident" id="5167742">Writer</span><span class="op" id="5167748">,</span>&nbsp;<span class="ident" id="5167750">b</span>&nbsp;<span class="op" id="5167752">[</span><span class="op" id="5167753">]</span><span class="builtintype" id="5167754">byte</span><span class="op" id="5167758">)</span>&nbsp;<span class="op" id="5167760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5167763">template</span><span class="op" id="5167771">.</span><span class="ident" id="5167772">JSEscape</span><span class="op" id="5167780">(</span><span class="ident" id="5167781">w</span><span class="op" id="5167782">,</span>&nbsp;<span class="ident" id="5167784">b</span><span class="op" id="5167785">)</span><br>
<span class="lineno">790</span><span class="op" id="5167787">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167790">//&nbsp;JSEscapeString&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;plain&nbsp;text&nbsp;data&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="5167876">func</span>&nbsp;<span class="ident" id="5167881">JSEscapeString</span><span class="op" id="5167895">(</span><span class="ident" id="5167896">s</span>&nbsp;<span class="builtintype" id="5167898">string</span><span class="op" id="5167904">)</span>&nbsp;<span class="builtintype" id="5167906">string</span>&nbsp;<span class="op" id="5167913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5167916">return</span>&nbsp;<span class="ident" id="5167923">template</span><span class="op" id="5167931">.</span><span class="ident" id="5167932">JSEscapeString</span><span class="op" id="5167946">(</span><span class="ident" id="5167947">s</span><span class="op" id="5167948">)</span><br>
<span class="lineno">795</span><span class="op" id="5167950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5167953">//&nbsp;JSEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;JavaScript&nbsp;equivalent&nbsp;of&nbsp;the&nbsp;textual</span><br>
<span class="lineno"></span><span class="comment" id="5168023">//&nbsp;representation&nbsp;of&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="keyword" id="5168059">func</span>&nbsp;<span class="ident" id="5168064">JSEscaper</span><span class="op" id="5168073">(</span><span class="ident" id="5168074">args</span>&nbsp;<span class="op" id="5168079">...</span><span class="keyword" id="5168082">interface</span><span class="op" id="5168091">{</span><span class="op" id="5168092">}</span><span class="op" id="5168093">)</span>&nbsp;<span class="builtintype" id="5168095">string</span>&nbsp;<span class="op" id="5168102">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168105">return</span>&nbsp;<span class="ident" id="5168112">template</span><span class="op" id="5168120">.</span><span class="ident" id="5168121">JSEscaper</span><span class="op" id="5168130">(</span><span class="ident" id="5168131">args</span><span class="op" id="5168135">...</span><span class="op" id="5168138">)</span><br>
<span class="lineno"></span><span class="op" id="5168140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5168143">//&nbsp;URLQueryEscaper&nbsp;returns&nbsp;the&nbsp;escaped&nbsp;value&nbsp;of&nbsp;the&nbsp;textual&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5168221">//&nbsp;its&nbsp;arguments&nbsp;in&nbsp;a&nbsp;form&nbsp;suitable&nbsp;for&nbsp;embedding&nbsp;in&nbsp;a&nbsp;URL&nbsp;query.</span><br>
<span class="lineno">805</span><span class="keyword" id="5168287">func</span>&nbsp;<span class="ident" id="5168292">URLQueryEscaper</span><span class="op" id="5168307">(</span><span class="ident" id="5168308">args</span>&nbsp;<span class="op" id="5168313">...</span><span class="keyword" id="5168316">interface</span><span class="op" id="5168325">{</span><span class="op" id="5168326">}</span><span class="op" id="5168327">)</span>&nbsp;<span class="builtintype" id="5168329">string</span>&nbsp;<span class="op" id="5168336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5168339">return</span>&nbsp;<span class="ident" id="5168346">template</span><span class="op" id="5168354">.</span><span class="ident" id="5168355">URLQueryEscaper</span><span class="op" id="5168370">(</span><span class="ident" id="5168371">args</span><span class="op" id="5168375">...</span><span class="op" id="5168378">)</span><br>
<span class="lineno"></span><span class="op" id="5168380">}</span>
</div>
</body>
</html>
