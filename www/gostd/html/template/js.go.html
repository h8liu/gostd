<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4603628">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4603683">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4603737">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4603788">package</span>&nbsp;<span class="ident" id="4603796">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4603806">import</span>&nbsp;<span class="op" id="4603813">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603816">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603825">&#34;encoding/json&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603842">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603849">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603860">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4603871">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4603886">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="4603889">//&nbsp;nextJSCtx&nbsp;returns&nbsp;the&nbsp;context&nbsp;that&nbsp;determines&nbsp;whether&nbsp;a&nbsp;slash&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4603964">//&nbsp;given&nbsp;run&nbsp;of&nbsp;tokens&nbsp;starts&nbsp;a&nbsp;regular&nbsp;expression&nbsp;instead&nbsp;of&nbsp;a&nbsp;division</span><br>
<span class="lineno"></span><span class="comment" id="4604037">//&nbsp;operator:&nbsp;/&nbsp;or&nbsp;/=.</span><br>
<span class="lineno"></span><span class="comment" id="4604059">//</span><br>
<span class="lineno">20</span><span class="comment" id="4604062">//&nbsp;This&nbsp;assumes&nbsp;that&nbsp;the&nbsp;token&nbsp;run&nbsp;does&nbsp;not&nbsp;include&nbsp;any&nbsp;string&nbsp;tokens,&nbsp;comment</span><br>
<span class="lineno"></span><span class="comment" id="4604141">//&nbsp;tokens,&nbsp;regular&nbsp;expression&nbsp;literal&nbsp;tokens,&nbsp;or&nbsp;division&nbsp;operators.</span><br>
<span class="lineno"></span><span class="comment" id="4604210">//</span><br>
<span class="lineno"></span><span class="comment" id="4604213">//&nbsp;This&nbsp;fails&nbsp;on&nbsp;some&nbsp;valid&nbsp;but&nbsp;nonsensical&nbsp;JavaScript&nbsp;programs&nbsp;like</span><br>
<span class="lineno"></span><span class="comment" id="4604282">//&nbsp;&#34;x&nbsp;=&nbsp;++/foo/i&#34;&nbsp;which&nbsp;is&nbsp;quite&nbsp;different&nbsp;than&nbsp;&#34;x++/foo/i&#34;,&nbsp;but&nbsp;is&nbsp;not&nbsp;known&nbsp;to</span><br>
<span class="lineno">25</span><span class="comment" id="4604363">//&nbsp;fail&nbsp;on&nbsp;any&nbsp;known&nbsp;useful&nbsp;programs.&nbsp;It&nbsp;is&nbsp;based&nbsp;on&nbsp;the&nbsp;draft</span><br>
<span class="lineno"></span><span class="comment" id="4604426">//&nbsp;JavaScript&nbsp;2.0&nbsp;lexical&nbsp;grammar&nbsp;and&nbsp;requires&nbsp;one&nbsp;token&nbsp;of&nbsp;lookbehind:</span><br>
<span class="lineno"></span><span class="comment" id="4604498">//&nbsp;http://www.mozilla.org/js/language/js20-2000-07/rationale/syntax.html</span><br>
<span class="lineno"></span><span class="keyword" id="4604571">func</span>&nbsp;<span class="ident" id="4604576">nextJSCtx</span><span class="op" id="4604585">(</span><span class="ident" id="4604586">s</span>&nbsp;<span class="op" id="4604588">[</span><span class="op" id="4604589">]</span><span class="builtintype" id="4604590">byte</span><span class="op" id="4604594">,</span>&nbsp;<span class="ident" id="4604596">preceding</span>&nbsp;<span class="ident" id="4604606">jsCtx</span><span class="op" id="4604611">)</span>&nbsp;<span class="ident" id="4604613">jsCtx</span>&nbsp;<span class="op" id="4604619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604622">s</span>&nbsp;<span class="op" id="4604624">=</span>&nbsp;<span class="ident" id="4604626">bytes</span><span class="op" id="4604631">.</span><span class="ident" id="4604632">TrimRight</span><span class="op" id="4604641">(</span><span class="ident" id="4604642">s</span><span class="op" id="4604643">,</span>&nbsp;<span class="string" id="4604645">&#34;\t\n\f\r&nbsp;\u2028\u2029&#34;</span><span class="op" id="4604668">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604671">if</span>&nbsp;<span class="builtinfunc" id="4604674">len</span><span class="op" id="4604677">(</span><span class="ident" id="4604678">s</span><span class="op" id="4604679">)</span>&nbsp;<span class="op" id="4604681">==</span>&nbsp;<span class="num" id="4604684">0</span>&nbsp;<span class="op" id="4604686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604690">return</span>&nbsp;<span class="ident" id="4604697">preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4604708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604712">//&nbsp;All&nbsp;cases&nbsp;below&nbsp;are&nbsp;in&nbsp;the&nbsp;single-byte&nbsp;UTF-8&nbsp;group.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604768">switch</span>&nbsp;<span class="ident" id="4604775">c</span><span class="op" id="4604776">,</span>&nbsp;<span class="ident" id="4604778">n</span>&nbsp;<span class="op" id="4604780">:=</span>&nbsp;<span class="ident" id="4604783">s</span><span class="op" id="4604784">[</span><span class="builtinfunc" id="4604785">len</span><span class="op" id="4604788">(</span><span class="ident" id="4604789">s</span><span class="op" id="4604790">)</span><span class="op" id="4604791">-</span><span class="num" id="4604792">1</span><span class="op" id="4604793">]</span><span class="op" id="4604794">,</span>&nbsp;<span class="builtinfunc" id="4604796">len</span><span class="op" id="4604799">(</span><span class="ident" id="4604800">s</span><span class="op" id="4604801">)</span><span class="op" id="4604802">;</span>&nbsp;<span class="ident" id="4604804">c</span>&nbsp;<span class="op" id="4604806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4604809">case</span>&nbsp;<span class="string" id="4604814">&#39;+&#39;</span><span class="op" id="4604817">,</span>&nbsp;<span class="string" id="4604819">&#39;-&#39;</span><span class="op" id="4604822">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604826">//&nbsp;++&nbsp;and&nbsp;--&nbsp;are&nbsp;not&nbsp;regexp&nbsp;preceders,&nbsp;but&nbsp;+&nbsp;and&nbsp;-&nbsp;are&nbsp;whether</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604891">//&nbsp;they&nbsp;are&nbsp;used&nbsp;as&nbsp;infix&nbsp;or&nbsp;prefix&nbsp;operators.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4604940">start</span>&nbsp;<span class="op" id="4604946">:=</span>&nbsp;<span class="ident" id="4604949">n</span>&nbsp;<span class="op" id="4604951">-</span>&nbsp;<span class="num" id="4604953">1</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4604957">//&nbsp;Count&nbsp;the&nbsp;number&nbsp;of&nbsp;adjacent&nbsp;dashes&nbsp;or&nbsp;pluses.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605009">for</span>&nbsp;<span class="ident" id="4605013">start</span>&nbsp;<span class="op" id="4605019">&gt;</span>&nbsp;<span class="num" id="4605021">0</span>&nbsp;<span class="op" id="4605023">&amp;&amp;</span>&nbsp;<span class="ident" id="4605026">s</span><span class="op" id="4605027">[</span><span class="ident" id="4605028">start</span><span class="op" id="4605033">-</span><span class="num" id="4605034">1</span><span class="op" id="4605035">]</span>&nbsp;<span class="op" id="4605037">==</span>&nbsp;<span class="ident" id="4605040">c</span>&nbsp;<span class="op" id="4605042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4605047">start</span><span class="op" id="4605052">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605061">if</span>&nbsp;<span class="op" id="4605064">(</span><span class="ident" id="4605065">n</span><span class="op" id="4605066">-</span><span class="ident" id="4605067">start</span><span class="op" id="4605072">)</span><span class="op" id="4605073">&amp;</span><span class="num" id="4605074">1</span>&nbsp;<span class="op" id="4605076">==</span>&nbsp;<span class="num" id="4605079">1</span>&nbsp;<span class="op" id="4605081">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605086">//&nbsp;Reached&nbsp;for&nbsp;trailing&nbsp;minus&nbsp;signs&nbsp;since&nbsp;&#34;---&#34;&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605144">//&nbsp;same&nbsp;as&nbsp;&#34;--&nbsp;-&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605166">return</span>&nbsp;<span class="ident" id="4605173">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605191">return</span>&nbsp;<span class="ident" id="4605198">jsCtxDivOp</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605210">case</span>&nbsp;<span class="string" id="4605215">&#39;.&#39;</span><span class="op" id="4605218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605222">//&nbsp;Handle&nbsp;&#34;42.&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605240">if</span>&nbsp;<span class="ident" id="4605243">n</span>&nbsp;<span class="op" id="4605245">!=</span>&nbsp;<span class="num" id="4605248">1</span>&nbsp;<span class="op" id="4605250">&amp;&amp;</span>&nbsp;<span class="string" id="4605253">&#39;0&#39;</span>&nbsp;<span class="op" id="4605257">&lt;=</span>&nbsp;<span class="ident" id="4605260">s</span><span class="op" id="4605261">[</span><span class="ident" id="4605262">n</span><span class="op" id="4605263">-</span><span class="num" id="4605264">2</span><span class="op" id="4605265">]</span>&nbsp;<span class="op" id="4605267">&amp;&amp;</span>&nbsp;<span class="ident" id="4605270">s</span><span class="op" id="4605271">[</span><span class="ident" id="4605272">n</span><span class="op" id="4605273">-</span><span class="num" id="4605274">2</span><span class="op" id="4605275">]</span>&nbsp;<span class="op" id="4605277">&lt;=</span>&nbsp;<span class="string" id="4605280">&#39;9&#39;</span>&nbsp;<span class="op" id="4605284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605289">return</span>&nbsp;<span class="ident" id="4605296">jsCtxDivOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4605309">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605313">return</span>&nbsp;<span class="ident" id="4605320">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605333">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605404">//&nbsp;that&nbsp;only&nbsp;end&nbsp;binary&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605458">case</span>&nbsp;<span class="string" id="4605463">&#39;,&#39;</span><span class="op" id="4605466">,</span>&nbsp;<span class="string" id="4605468">&#39;&lt;&#39;</span><span class="op" id="4605471">,</span>&nbsp;<span class="string" id="4605473">&#39;&gt;&#39;</span><span class="op" id="4605476">,</span>&nbsp;<span class="string" id="4605478">&#39;=&#39;</span><span class="op" id="4605481">,</span>&nbsp;<span class="string" id="4605483">&#39;*&#39;</span><span class="op" id="4605486">,</span>&nbsp;<span class="string" id="4605488">&#39;%&#39;</span><span class="op" id="4605491">,</span>&nbsp;<span class="string" id="4605493">&#39;&amp;&#39;</span><span class="op" id="4605496">,</span>&nbsp;<span class="string" id="4605498">&#39;|&#39;</span><span class="op" id="4605501">,</span>&nbsp;<span class="string" id="4605503">&#39;^&#39;</span><span class="op" id="4605506">,</span>&nbsp;<span class="string" id="4605508">&#39;?&#39;</span><span class="op" id="4605511">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605515">return</span>&nbsp;<span class="ident" id="4605522">jsCtxRegexp</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605535">//&nbsp;Suffixes&nbsp;for&nbsp;all&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605606">//&nbsp;that&nbsp;are&nbsp;prefix&nbsp;operators&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605655">case</span>&nbsp;<span class="string" id="4605660">&#39;!&#39;</span><span class="op" id="4605663">,</span>&nbsp;<span class="string" id="4605665">&#39;~&#39;</span><span class="op" id="4605668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605672">return</span>&nbsp;<span class="ident" id="4605679">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605692">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605762">//&nbsp;that&nbsp;are&nbsp;open&nbsp;brackets&nbsp;not&nbsp;handled&nbsp;above.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605808">case</span>&nbsp;<span class="string" id="4605813">&#39;(&#39;</span><span class="op" id="4605816">,</span>&nbsp;<span class="string" id="4605818">&#39;[&#39;</span><span class="op" id="4605821">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605825">return</span>&nbsp;<span class="ident" id="4605832">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605845">//&nbsp;Matches&nbsp;all&nbsp;the&nbsp;punctuators&nbsp;from&nbsp;section&nbsp;7.7&nbsp;of&nbsp;the&nbsp;language&nbsp;spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605915">//&nbsp;that&nbsp;precede&nbsp;expression&nbsp;starts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605951">case</span>&nbsp;<span class="string" id="4605956">&#39;:&#39;</span><span class="op" id="4605959">,</span>&nbsp;<span class="string" id="4605961">&#39;;&#39;</span><span class="op" id="4605964">,</span>&nbsp;<span class="string" id="4605966">&#39;{&#39;</span><span class="op" id="4605969">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4605973">return</span>&nbsp;<span class="ident" id="4605980">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4605993">//&nbsp;CAVEAT:&nbsp;the&nbsp;close&nbsp;punctuators&nbsp;(&#39;}&#39;,&nbsp;&#39;]&#39;,&nbsp;&#39;)&#39;)&nbsp;precede&nbsp;div&nbsp;ops&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606063">//&nbsp;are&nbsp;handled&nbsp;in&nbsp;the&nbsp;default&nbsp;except&nbsp;for&nbsp;&#39;}&#39;&nbsp;which&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606129">//&nbsp;division&nbsp;op&nbsp;as&nbsp;in</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606151">//&nbsp;&nbsp;&nbsp;&nbsp;({&nbsp;valueOf:&nbsp;function&nbsp;()&nbsp;{&nbsp;return&nbsp;42&nbsp;}&nbsp;}&nbsp;/&nbsp;2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606202">//&nbsp;which&nbsp;is&nbsp;valid,&nbsp;but,&nbsp;in&nbsp;practice,&nbsp;developers&nbsp;don&#39;t&nbsp;divide&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606271">//&nbsp;literals,&nbsp;so&nbsp;our&nbsp;heuristic&nbsp;works&nbsp;well&nbsp;for&nbsp;code&nbsp;like</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606327">//&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;()&nbsp;{&nbsp;...&nbsp;}&nbsp;&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;sideEffect();</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606386">//&nbsp;The&nbsp;&#39;)&#39;&nbsp;punctuator&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression&nbsp;as&nbsp;in</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606448">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(b)&nbsp;/foo/.test(x)&nbsp;&amp;&amp;&nbsp;...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606484">//&nbsp;but&nbsp;this&nbsp;is&nbsp;much&nbsp;less&nbsp;likely&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606522">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a&nbsp;+&nbsp;b)&nbsp;/&nbsp;c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606542">case</span>&nbsp;<span class="string" id="4606547">&#39;}&#39;</span><span class="op" id="4606550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606554">return</span>&nbsp;<span class="ident" id="4606561">jsCtxRegexp</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606574">default</span><span class="op" id="4606581">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606585">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;IdentifierName&nbsp;and&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;a&nbsp;keyword&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606649">//&nbsp;can&nbsp;precede&nbsp;a&nbsp;regular&nbsp;expression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606688">j</span>&nbsp;<span class="op" id="4606690">:=</span>&nbsp;<span class="ident" id="4606693">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606697">for</span>&nbsp;<span class="ident" id="4606701">j</span>&nbsp;<span class="op" id="4606703">&gt;</span>&nbsp;<span class="num" id="4606705">0</span>&nbsp;<span class="op" id="4606707">&amp;&amp;</span>&nbsp;<span class="ident" id="4606710">isJSIdentPart</span><span class="op" id="4606723">(</span><span class="builtintype" id="4606724">rune</span><span class="op" id="4606728">(</span><span class="ident" id="4606729">s</span><span class="op" id="4606730">[</span><span class="ident" id="4606731">j</span><span class="op" id="4606732">-</span><span class="num" id="4606733">1</span><span class="op" id="4606734">]</span><span class="op" id="4606735">)</span><span class="op" id="4606736">)</span>&nbsp;<span class="op" id="4606738">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4606743">j</span><span class="op" id="4606744">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606753">if</span>&nbsp;<span class="ident" id="4606756">regexpPrecederKeywords</span><span class="op" id="4606778">[</span><span class="builtintype" id="4606779">string</span><span class="op" id="4606785">(</span><span class="ident" id="4606786">s</span><span class="op" id="4606787">[</span><span class="ident" id="4606788">j</span><span class="op" id="4606789">:</span><span class="op" id="4606790">]</span><span class="op" id="4606791">)</span><span class="op" id="4606792">]</span>&nbsp;<span class="op" id="4606794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606799">return</span>&nbsp;<span class="ident" id="4606806">jsCtxRegexp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606820">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4606823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606826">//&nbsp;Otherwise&nbsp;is&nbsp;a&nbsp;punctuator&nbsp;not&nbsp;listed&nbsp;above,&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606877">//&nbsp;a&nbsp;string&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op,&nbsp;or&nbsp;an&nbsp;identifier</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4606932">//&nbsp;which&nbsp;precedes&nbsp;a&nbsp;div&nbsp;op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4606961">return</span>&nbsp;<span class="ident" id="4606968">jsCtxDivOp</span><br>
<span class="lineno">100</span><span class="op" id="4606979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4606982">//&nbsp;regexpPrecederKeywords&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;reserved&nbsp;JS&nbsp;keywords&nbsp;that&nbsp;can&nbsp;precede&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4607060">//&nbsp;regular&nbsp;expression&nbsp;in&nbsp;JS&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="4607096">var</span>&nbsp;<span class="ident" id="4607100">regexpPrecederKeywords</span>&nbsp;<span class="op" id="4607123">=</span>&nbsp;<span class="keyword" id="4607125">map</span><span class="op" id="4607128">[</span><span class="builtintype" id="4607129">string</span><span class="op" id="4607135">]</span><span class="builtintype" id="4607136">bool</span><span class="op" id="4607140">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607143">&#34;break&#34;</span><span class="op" id="4607150">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607157">true</span><span class="op" id="4607161">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607164">&#34;case&#34;</span><span class="op" id="4607170">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607178">true</span><span class="op" id="4607182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607185">&#34;continue&#34;</span><span class="op" id="4607195">:</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607199">true</span><span class="op" id="4607203">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607206">&#34;delete&#34;</span><span class="op" id="4607214">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607220">true</span><span class="op" id="4607224">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607227">&#34;do&#34;</span><span class="op" id="4607231">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607241">true</span><span class="op" id="4607245">,</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607248">&#34;else&#34;</span><span class="op" id="4607254">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607262">true</span><span class="op" id="4607266">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607269">&#34;finally&#34;</span><span class="op" id="4607278">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607283">true</span><span class="op" id="4607287">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607290">&#34;in&#34;</span><span class="op" id="4607294">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607304">true</span><span class="op" id="4607308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607311">&#34;instanceof&#34;</span><span class="op" id="4607323">:</span>&nbsp;<span class="builtintype" id="4607325">true</span><span class="op" id="4607329">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607332">&#34;return&#34;</span><span class="op" id="4607340">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607346">true</span><span class="op" id="4607350">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607353">&#34;throw&#34;</span><span class="op" id="4607360">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607367">true</span><span class="op" id="4607371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607374">&#34;try&#34;</span><span class="op" id="4607379">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607388">true</span><span class="op" id="4607392">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607395">&#34;typeof&#34;</span><span class="op" id="4607403">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607409">true</span><span class="op" id="4607413">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4607416">&#34;void&#34;</span><span class="op" id="4607422">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4607430">true</span><span class="op" id="4607434">,</span><br>
<span class="lineno"></span><span class="op" id="4607436">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4607439">var</span>&nbsp;<span class="ident" id="4607443">jsonMarshalType</span>&nbsp;<span class="op" id="4607459">=</span>&nbsp;<span class="ident" id="4607461">reflect</span><span class="op" id="4607468">.</span><span class="ident" id="4607469">TypeOf</span><span class="op" id="4607475">(</span><span class="op" id="4607476">(</span><span class="op" id="4607477">*</span><span class="ident" id="4607478">json</span><span class="op" id="4607482">.</span><span class="ident" id="4607483">Marshaler</span><span class="op" id="4607492">)</span><span class="op" id="4607493">(</span><span class="ident" id="4607494">nil</span><span class="op" id="4607497">)</span><span class="op" id="4607498">)</span><span class="op" id="4607499">.</span><span class="ident" id="4607500">Elem</span><span class="op" id="4607504">(</span><span class="op" id="4607505">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4607508">//&nbsp;indirectToJSONMarshaler&nbsp;returns&nbsp;the&nbsp;value,&nbsp;after&nbsp;dereferencing&nbsp;as&nbsp;many&nbsp;times</span><br>
<span class="lineno"></span><span class="comment" id="4607588">//&nbsp;as&nbsp;necessary&nbsp;to&nbsp;reach&nbsp;the&nbsp;base&nbsp;type&nbsp;(or&nbsp;nil)&nbsp;or&nbsp;an&nbsp;implementation&nbsp;of&nbsp;json.Marshal.</span><br>
<span class="lineno">125</span><span class="keyword" id="4607674">func</span>&nbsp;<span class="ident" id="4607679">indirectToJSONMarshaler</span><span class="op" id="4607702">(</span><span class="ident" id="4607703">a</span>&nbsp;<span class="keyword" id="4607705">interface</span><span class="op" id="4607714">{</span><span class="op" id="4607715">}</span><span class="op" id="4607716">)</span>&nbsp;<span class="keyword" id="4607718">interface</span><span class="op" id="4607727">{</span><span class="op" id="4607728">}</span>&nbsp;<span class="op" id="4607730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607733">v</span>&nbsp;<span class="op" id="4607735">:=</span>&nbsp;<span class="ident" id="4607738">reflect</span><span class="op" id="4607745">.</span><span class="ident" id="4607746">ValueOf</span><span class="op" id="4607753">(</span><span class="ident" id="4607754">a</span><span class="op" id="4607755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607758">for</span>&nbsp;<span class="op" id="4607762">!</span><span class="ident" id="4607763">v</span><span class="op" id="4607764">.</span><span class="ident" id="4607765">Type</span><span class="op" id="4607769">(</span><span class="op" id="4607770">)</span><span class="op" id="4607771">.</span><span class="ident" id="4607772">Implements</span><span class="op" id="4607782">(</span><span class="ident" id="4607783">jsonMarshalType</span><span class="op" id="4607798">)</span>&nbsp;<span class="op" id="4607800">&amp;&amp;</span>&nbsp;<span class="ident" id="4607803">v</span><span class="op" id="4607804">.</span><span class="ident" id="4607805">Kind</span><span class="op" id="4607809">(</span><span class="op" id="4607810">)</span>&nbsp;<span class="op" id="4607812">==</span>&nbsp;<span class="ident" id="4607815">reflect</span><span class="op" id="4607822">.</span><span class="ident" id="4607823">Ptr</span>&nbsp;<span class="op" id="4607827">&amp;&amp;</span>&nbsp;<span class="op" id="4607830">!</span><span class="ident" id="4607831">v</span><span class="op" id="4607832">.</span><span class="ident" id="4607833">IsNil</span><span class="op" id="4607838">(</span><span class="op" id="4607839">)</span>&nbsp;<span class="op" id="4607841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4607845">v</span>&nbsp;<span class="op" id="4607847">=</span>&nbsp;<span class="ident" id="4607849">v</span><span class="op" id="4607850">.</span><span class="ident" id="4607851">Elem</span><span class="op" id="4607855">(</span><span class="op" id="4607856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4607859">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4607862">return</span>&nbsp;<span class="ident" id="4607869">v</span><span class="op" id="4607870">.</span><span class="ident" id="4607871">Interface</span><span class="op" id="4607880">(</span><span class="op" id="4607881">)</span><br>
<span class="lineno"></span><span class="op" id="4607883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4607886">//&nbsp;jsValEscaper&nbsp;escapes&nbsp;its&nbsp;inputs&nbsp;to&nbsp;a&nbsp;JS&nbsp;Expression&nbsp;(section&nbsp;11.14)&nbsp;that&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4607965">//&nbsp;neither&nbsp;side-effects&nbsp;nor&nbsp;free&nbsp;variables&nbsp;outside&nbsp;(NaN,&nbsp;Infinity).</span><br>
<span class="lineno">135</span><span class="keyword" id="4608033">func</span>&nbsp;<span class="ident" id="4608038">jsValEscaper</span><span class="op" id="4608050">(</span><span class="ident" id="4608051">args</span>&nbsp;<span class="op" id="4608056">...</span><span class="keyword" id="4608059">interface</span><span class="op" id="4608068">{</span><span class="op" id="4608069">}</span><span class="op" id="4608070">)</span>&nbsp;<span class="builtintype" id="4608072">string</span>&nbsp;<span class="op" id="4608079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608082">var</span>&nbsp;<span class="ident" id="4608086">a</span>&nbsp;<span class="keyword" id="4608088">interface</span><span class="op" id="4608097">{</span><span class="op" id="4608098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608101">if</span>&nbsp;<span class="builtinfunc" id="4608104">len</span><span class="op" id="4608107">(</span><span class="ident" id="4608108">args</span><span class="op" id="4608112">)</span>&nbsp;<span class="op" id="4608114">==</span>&nbsp;<span class="num" id="4608117">1</span>&nbsp;<span class="op" id="4608119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608123">a</span>&nbsp;<span class="op" id="4608125">=</span>&nbsp;<span class="ident" id="4608127">indirectToJSONMarshaler</span><span class="op" id="4608150">(</span><span class="ident" id="4608151">args</span><span class="op" id="4608155">[</span><span class="num" id="4608156">0</span><span class="op" id="4608157">]</span><span class="op" id="4608158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608162">switch</span>&nbsp;<span class="ident" id="4608169">t</span>&nbsp;<span class="op" id="4608171">:=</span>&nbsp;<span class="ident" id="4608174">a</span><span class="op" id="4608175">.</span><span class="op" id="4608176">(</span><span class="keyword" id="4608177">type</span><span class="op" id="4608181">)</span>&nbsp;<span class="op" id="4608183">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608187">case</span>&nbsp;<span class="ident" id="4608192">JS</span><span class="op" id="4608194">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608199">return</span>&nbsp;<span class="builtintype" id="4608206">string</span><span class="op" id="4608212">(</span><span class="ident" id="4608213">t</span><span class="op" id="4608214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608218">case</span>&nbsp;<span class="ident" id="4608223">JSStr</span><span class="op" id="4608228">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608233">//&nbsp;TODO:&nbsp;normalize&nbsp;quotes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608263">return</span>&nbsp;<span class="string" id="4608270">`&#34;`</span>&nbsp;<span class="op" id="4608274">+</span>&nbsp;<span class="builtintype" id="4608276">string</span><span class="op" id="4608282">(</span><span class="ident" id="4608283">t</span><span class="op" id="4608284">)</span>&nbsp;<span class="op" id="4608286">+</span>&nbsp;<span class="string" id="4608288">`&#34;`</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608294">case</span>&nbsp;<span class="ident" id="4608299">json</span><span class="op" id="4608303">.</span><span class="ident" id="4608304">Marshaler</span><span class="op" id="4608313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608318">//&nbsp;Do&nbsp;not&nbsp;treat&nbsp;as&nbsp;a&nbsp;Stringer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608351">case</span>&nbsp;<span class="ident" id="4608356">fmt</span><span class="op" id="4608359">.</span><span class="ident" id="4608360">Stringer</span><span class="op" id="4608368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608373">a</span>&nbsp;<span class="op" id="4608375">=</span>&nbsp;<span class="ident" id="4608377">t</span><span class="op" id="4608378">.</span><span class="ident" id="4608379">String</span><span class="op" id="4608385">(</span><span class="op" id="4608386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608390">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608393">}</span>&nbsp;<span class="keyword" id="4608395">else</span>&nbsp;<span class="op" id="4608400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608404">for</span>&nbsp;<span class="ident" id="4608408">i</span><span class="op" id="4608409">,</span>&nbsp;<span class="ident" id="4608411">arg</span>&nbsp;<span class="op" id="4608415">:=</span>&nbsp;<span class="keyword" id="4608418">range</span>&nbsp;<span class="ident" id="4608424">args</span>&nbsp;<span class="op" id="4608429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608434">args</span><span class="op" id="4608438">[</span><span class="ident" id="4608439">i</span><span class="op" id="4608440">]</span>&nbsp;<span class="op" id="4608442">=</span>&nbsp;<span class="ident" id="4608444">indirectToJSONMarshaler</span><span class="op" id="4608467">(</span><span class="ident" id="4608468">arg</span><span class="op" id="4608471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608479">a</span>&nbsp;<span class="op" id="4608481">=</span>&nbsp;<span class="ident" id="4608483">fmt</span><span class="op" id="4608486">.</span><span class="ident" id="4608487">Sprint</span><span class="op" id="4608493">(</span><span class="ident" id="4608494">args</span><span class="op" id="4608498">...</span><span class="op" id="4608501">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4608504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608507">//&nbsp;TODO:&nbsp;detect&nbsp;cycles&nbsp;before&nbsp;calling&nbsp;Marshal&nbsp;which&nbsp;loops&nbsp;infinitely&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608580">//&nbsp;cyclic&nbsp;data.&nbsp;This&nbsp;may&nbsp;be&nbsp;an&nbsp;unacceptable&nbsp;DoS&nbsp;risk.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4608636">b</span><span class="op" id="4608637">,</span>&nbsp;<span class="ident" id="4608639">err</span>&nbsp;<span class="op" id="4608643">:=</span>&nbsp;<span class="ident" id="4608646">json</span><span class="op" id="4608650">.</span><span class="ident" id="4608651">Marshal</span><span class="op" id="4608658">(</span><span class="ident" id="4608659">a</span><span class="op" id="4608660">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608663">if</span>&nbsp;<span class="ident" id="4608666">err</span>&nbsp;<span class="op" id="4608670">!=</span>&nbsp;<span class="ident" id="4608673">nil</span>&nbsp;<span class="op" id="4608677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608681">//&nbsp;Put&nbsp;a&nbsp;space&nbsp;before&nbsp;comment&nbsp;so&nbsp;that&nbsp;if&nbsp;it&nbsp;is&nbsp;flush&nbsp;against</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608744">//&nbsp;a&nbsp;division&nbsp;operator&nbsp;it&nbsp;is&nbsp;not&nbsp;turned&nbsp;into&nbsp;a&nbsp;line&nbsp;comment:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608807">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x/{{y}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608824">//&nbsp;turning&nbsp;into</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608842">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;x//*&nbsp;error&nbsp;marshalling&nbsp;y:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4608877">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;line&nbsp;of&nbsp;error&nbsp;message&nbsp;*/null</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4608927">return</span>&nbsp;<span class="ident" id="4608934">fmt</span><span class="op" id="4608937">.</span><span class="ident" id="4608938">Sprintf</span><span class="op" id="4608945">(</span><span class="string" id="4608946">&#34;&nbsp;/*&nbsp;%s&nbsp;*/null&nbsp;&#34;</span><span class="op" id="4608962">,</span>&nbsp;<span class="ident" id="4608964">strings</span><span class="op" id="4608971">.</span><span class="ident" id="4608972">Replace</span><span class="op" id="4608979">(</span><span class="ident" id="4608980">err</span><span class="op" id="4608983">.</span><span class="ident" id="4608984">Error</span><span class="op" id="4608989">(</span><span class="op" id="4608990">)</span><span class="op" id="4608991">,</span>&nbsp;<span class="string" id="4608993">&#34;*/&#34;</span><span class="op" id="4608997">,</span>&nbsp;<span class="string" id="4608999">&#34;*&nbsp;/&#34;</span><span class="op" id="4609004">,</span>&nbsp;<span class="op" id="4609006">-</span><span class="num" id="4609007">1</span><span class="op" id="4609008">)</span><span class="op" id="4609009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609016">//&nbsp;TODO:&nbsp;maybe&nbsp;post-process&nbsp;output&nbsp;to&nbsp;prevent&nbsp;it&nbsp;from&nbsp;containing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609082">//&nbsp;&#34;&lt;!--&#34;,&nbsp;&#34;--&gt;&#34;,&nbsp;&#34;&lt;![CDATA[&#34;,&nbsp;&#34;]]&gt;&#34;,&nbsp;or&nbsp;&#34;&lt;/script&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609135">//&nbsp;in&nbsp;case&nbsp;custom&nbsp;marshallers&nbsp;produce&nbsp;output&nbsp;containing&nbsp;those.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609200">//&nbsp;TODO:&nbsp;Maybe&nbsp;abbreviate&nbsp;\u00ab&nbsp;to&nbsp;\xab&nbsp;to&nbsp;produce&nbsp;more&nbsp;compact&nbsp;output.</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609274">if</span>&nbsp;<span class="builtinfunc" id="4609277">len</span><span class="op" id="4609280">(</span><span class="ident" id="4609281">b</span><span class="op" id="4609282">)</span>&nbsp;<span class="op" id="4609284">==</span>&nbsp;<span class="num" id="4609287">0</span>&nbsp;<span class="op" id="4609289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609293">//&nbsp;In,&nbsp;`x=y/{{.}}*z`&nbsp;a&nbsp;json.Marshaler&nbsp;that&nbsp;produces&nbsp;&#34;&#34;&nbsp;should</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609357">//&nbsp;not&nbsp;cause&nbsp;the&nbsp;output&nbsp;`x=y/*z`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609393">return</span>&nbsp;<span class="string" id="4609400">&#34;&nbsp;null&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609410">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609413">first</span><span class="op" id="4609418">,</span>&nbsp;<span class="ident" id="4609420">_</span>&nbsp;<span class="op" id="4609422">:=</span>&nbsp;<span class="ident" id="4609425">utf8</span><span class="op" id="4609429">.</span><span class="ident" id="4609430">DecodeRune</span><span class="op" id="4609440">(</span><span class="ident" id="4609441">b</span><span class="op" id="4609442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609445">last</span><span class="op" id="4609449">,</span>&nbsp;<span class="ident" id="4609451">_</span>&nbsp;<span class="op" id="4609453">:=</span>&nbsp;<span class="ident" id="4609456">utf8</span><span class="op" id="4609460">.</span><span class="ident" id="4609461">DecodeLastRune</span><span class="op" id="4609475">(</span><span class="ident" id="4609476">b</span><span class="op" id="4609477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609480">var</span>&nbsp;<span class="ident" id="4609484">buf</span>&nbsp;<span class="ident" id="4609488">bytes</span><span class="op" id="4609493">.</span><span class="ident" id="4609494">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609502">//&nbsp;Prevent&nbsp;IdentifierNames&nbsp;and&nbsp;NumericLiterals&nbsp;from&nbsp;running&nbsp;into</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609568">//&nbsp;keywords:&nbsp;in,&nbsp;instanceof,&nbsp;typeof,&nbsp;void</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609611">pad</span>&nbsp;<span class="op" id="4609615">:=</span>&nbsp;<span class="ident" id="4609618">isJSIdentPart</span><span class="op" id="4609631">(</span><span class="ident" id="4609632">first</span><span class="op" id="4609637">)</span>&nbsp;<span class="op" id="4609639">||</span>&nbsp;<span class="ident" id="4609642">isJSIdentPart</span><span class="op" id="4609655">(</span><span class="ident" id="4609656">last</span><span class="op" id="4609660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609663">if</span>&nbsp;<span class="ident" id="4609666">pad</span>&nbsp;<span class="op" id="4609670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609674">buf</span><span class="op" id="4609677">.</span><span class="ident" id="4609678">WriteByte</span><span class="op" id="4609687">(</span><span class="string" id="4609688">&#39;&nbsp;&#39;</span><span class="op" id="4609691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609697">written</span>&nbsp;<span class="op" id="4609705">:=</span>&nbsp;<span class="num" id="4609708">0</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609711">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;json.Marshal&nbsp;escapes&nbsp;codepoints&nbsp;U+2028&nbsp;&amp;&nbsp;U+2029</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4609778">//&nbsp;so&nbsp;it&nbsp;falls&nbsp;within&nbsp;the&nbsp;subset&nbsp;of&nbsp;JSON&nbsp;which&nbsp;is&nbsp;valid&nbsp;JS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609839">for</span>&nbsp;<span class="ident" id="4609843">i</span>&nbsp;<span class="op" id="4609845">:=</span>&nbsp;<span class="num" id="4609848">0</span><span class="op" id="4609849">;</span>&nbsp;<span class="ident" id="4609851">i</span>&nbsp;<span class="op" id="4609853">&lt;</span>&nbsp;<span class="builtinfunc" id="4609855">len</span><span class="op" id="4609858">(</span><span class="ident" id="4609859">b</span><span class="op" id="4609860">)</span><span class="op" id="4609861">;</span>&nbsp;<span class="op" id="4609863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4609867">rune</span><span class="op" id="4609871">,</span>&nbsp;<span class="ident" id="4609873">n</span>&nbsp;<span class="op" id="4609875">:=</span>&nbsp;<span class="ident" id="4609878">utf8</span><span class="op" id="4609882">.</span><span class="ident" id="4609883">DecodeRune</span><span class="op" id="4609893">(</span><span class="ident" id="4609894">b</span><span class="op" id="4609895">[</span><span class="ident" id="4609896">i</span><span class="op" id="4609897">:</span><span class="op" id="4609898">]</span><span class="op" id="4609899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609903">repl</span>&nbsp;<span class="op" id="4609908">:=</span>&nbsp;<span class="string" id="4609911">&#34;&#34;</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4609916">if</span>&nbsp;<span class="builtintype" id="4609919">rune</span>&nbsp;<span class="op" id="4609924">==</span>&nbsp;<span class="num" id="4609927">0x2028</span>&nbsp;<span class="op" id="4609934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609939">repl</span>&nbsp;<span class="op" id="4609944">=</span>&nbsp;<span class="string" id="4609946">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4609957">}</span>&nbsp;<span class="keyword" id="4609959">else</span>&nbsp;<span class="keyword" id="4609964">if</span>&nbsp;<span class="builtintype" id="4609967">rune</span>&nbsp;<span class="op" id="4609972">==</span>&nbsp;<span class="num" id="4609975">0x2029</span>&nbsp;<span class="op" id="4609982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4609987">repl</span>&nbsp;<span class="op" id="4609992">=</span>&nbsp;<span class="string" id="4609994">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610005">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610009">if</span>&nbsp;<span class="ident" id="4610012">repl</span>&nbsp;<span class="op" id="4610017">!=</span>&nbsp;<span class="string" id="4610020">&#34;&#34;</span>&nbsp;<span class="op" id="4610023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610028">buf</span><span class="op" id="4610031">.</span><span class="ident" id="4610032">Write</span><span class="op" id="4610037">(</span><span class="ident" id="4610038">b</span><span class="op" id="4610039">[</span><span class="ident" id="4610040">written</span><span class="op" id="4610047">:</span><span class="ident" id="4610048">i</span><span class="op" id="4610049">]</span><span class="op" id="4610050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610055">buf</span><span class="op" id="4610058">.</span><span class="ident" id="4610059">WriteString</span><span class="op" id="4610070">(</span><span class="ident" id="4610071">repl</span><span class="op" id="4610075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610080">written</span>&nbsp;<span class="op" id="4610088">=</span>&nbsp;<span class="ident" id="4610090">i</span>&nbsp;<span class="op" id="4610092">+</span>&nbsp;<span class="ident" id="4610094">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610098">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610102">i</span>&nbsp;<span class="op" id="4610104">+=</span>&nbsp;<span class="ident" id="4610107">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610110">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610113">if</span>&nbsp;<span class="ident" id="4610116">buf</span><span class="op" id="4610119">.</span><span class="ident" id="4610120">Len</span><span class="op" id="4610123">(</span><span class="op" id="4610124">)</span>&nbsp;<span class="op" id="4610126">!=</span>&nbsp;<span class="num" id="4610129">0</span>&nbsp;<span class="op" id="4610131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610135">buf</span><span class="op" id="4610138">.</span><span class="ident" id="4610139">Write</span><span class="op" id="4610144">(</span><span class="ident" id="4610145">b</span><span class="op" id="4610146">[</span><span class="ident" id="4610147">written</span><span class="op" id="4610154">:</span><span class="op" id="4610155">]</span><span class="op" id="4610156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610160">if</span>&nbsp;<span class="ident" id="4610163">pad</span>&nbsp;<span class="op" id="4610167">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610172">buf</span><span class="op" id="4610175">.</span><span class="ident" id="4610176">WriteByte</span><span class="op" id="4610185">(</span><span class="string" id="4610186">&#39;&nbsp;&#39;</span><span class="op" id="4610189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610197">b</span>&nbsp;<span class="op" id="4610199">=</span>&nbsp;<span class="ident" id="4610201">buf</span><span class="op" id="4610204">.</span><span class="ident" id="4610205">Bytes</span><span class="op" id="4610210">(</span><span class="op" id="4610211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610217">return</span>&nbsp;<span class="builtintype" id="4610224">string</span><span class="op" id="4610230">(</span><span class="ident" id="4610231">b</span><span class="op" id="4610232">)</span><br>
<span class="lineno">215</span><span class="op" id="4610234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4610237">//&nbsp;jsStrEscaper&nbsp;produces&nbsp;a&nbsp;string&nbsp;that&nbsp;can&nbsp;be&nbsp;included&nbsp;between&nbsp;quotes&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4610310">//&nbsp;JavaScript&nbsp;source,&nbsp;in&nbsp;JavaScript&nbsp;embedded&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;&lt;script&gt;&nbsp;element,</span><br>
<span class="lineno"></span><span class="comment" id="4610385">//&nbsp;or&nbsp;in&nbsp;an&nbsp;HTML5&nbsp;event&nbsp;handler&nbsp;attribute&nbsp;such&nbsp;as&nbsp;onclick.</span><br>
<span class="lineno">220</span><span class="keyword" id="4610444">func</span>&nbsp;<span class="ident" id="4610449">jsStrEscaper</span><span class="op" id="4610461">(</span><span class="ident" id="4610462">args</span>&nbsp;<span class="op" id="4610467">...</span><span class="keyword" id="4610470">interface</span><span class="op" id="4610479">{</span><span class="op" id="4610480">}</span><span class="op" id="4610481">)</span>&nbsp;<span class="builtintype" id="4610483">string</span>&nbsp;<span class="op" id="4610490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610493">s</span><span class="op" id="4610494">,</span>&nbsp;<span class="ident" id="4610496">t</span>&nbsp;<span class="op" id="4610498">:=</span>&nbsp;<span class="ident" id="4610501">stringify</span><span class="op" id="4610510">(</span><span class="ident" id="4610511">args</span><span class="op" id="4610515">...</span><span class="op" id="4610518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610521">if</span>&nbsp;<span class="ident" id="4610524">t</span>&nbsp;<span class="op" id="4610526">==</span>&nbsp;<span class="ident" id="4610529">contentTypeJSStr</span>&nbsp;<span class="op" id="4610546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610550">return</span>&nbsp;<span class="ident" id="4610557">replace</span><span class="op" id="4610564">(</span><span class="ident" id="4610565">s</span><span class="op" id="4610566">,</span>&nbsp;<span class="ident" id="4610568">jsStrNormReplacementTable</span><span class="op" id="4610593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4610596">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4610599">return</span>&nbsp;<span class="ident" id="4610606">replace</span><span class="op" id="4610613">(</span><span class="ident" id="4610614">s</span><span class="op" id="4610615">,</span>&nbsp;<span class="ident" id="4610617">jsStrReplacementTable</span><span class="op" id="4610638">)</span><br>
<span class="lineno"></span><span class="op" id="4610640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4610643">//&nbsp;jsRegexpEscaper&nbsp;behaves&nbsp;like&nbsp;jsStrEscaper&nbsp;but&nbsp;escapes&nbsp;regular&nbsp;expression</span><br>
<span class="lineno"></span><span class="comment" id="4610719">//&nbsp;specials&nbsp;so&nbsp;the&nbsp;result&nbsp;is&nbsp;treated&nbsp;literally&nbsp;when&nbsp;included&nbsp;in&nbsp;a&nbsp;regular</span><br>
<span class="lineno">230</span><span class="comment" id="4610793">//&nbsp;expression&nbsp;literal.&nbsp;/foo{{.X}}bar/&nbsp;matches&nbsp;the&nbsp;string&nbsp;&#34;foo&#34;&nbsp;followed&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="4610868">//&nbsp;the&nbsp;literal&nbsp;text&nbsp;of&nbsp;{{.X}}&nbsp;followed&nbsp;by&nbsp;the&nbsp;string&nbsp;&#34;bar&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="4610928">func</span>&nbsp;<span class="ident" id="4610933">jsRegexpEscaper</span><span class="op" id="4610948">(</span><span class="ident" id="4610949">args</span>&nbsp;<span class="op" id="4610954">...</span><span class="keyword" id="4610957">interface</span><span class="op" id="4610966">{</span><span class="op" id="4610967">}</span><span class="op" id="4610968">)</span>&nbsp;<span class="builtintype" id="4610970">string</span>&nbsp;<span class="op" id="4610977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4610980">s</span><span class="op" id="4610981">,</span>&nbsp;<span class="ident" id="4610983">_</span>&nbsp;<span class="op" id="4610985">:=</span>&nbsp;<span class="ident" id="4610988">stringify</span><span class="op" id="4610997">(</span><span class="ident" id="4610998">args</span><span class="op" id="4611002">...</span><span class="op" id="4611005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611008">s</span>&nbsp;<span class="op" id="4611010">=</span>&nbsp;<span class="ident" id="4611012">replace</span><span class="op" id="4611019">(</span><span class="ident" id="4611020">s</span><span class="op" id="4611021">,</span>&nbsp;<span class="ident" id="4611023">jsRegexpReplacementTable</span><span class="op" id="4611047">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611050">if</span>&nbsp;<span class="ident" id="4611053">s</span>&nbsp;<span class="op" id="4611055">==</span>&nbsp;<span class="string" id="4611058">&#34;&#34;</span>&nbsp;<span class="op" id="4611061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4611065">//&nbsp;/{{.X}}/&nbsp;should&nbsp;not&nbsp;produce&nbsp;a&nbsp;line&nbsp;comment&nbsp;when&nbsp;.X&nbsp;==&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611128">return</span>&nbsp;<span class="string" id="4611135">&#34;(?:)&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611146">return</span>&nbsp;<span class="ident" id="4611153">s</span><br>
<span class="lineno">240</span><span class="op" id="4611155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4611158">//&nbsp;replace&nbsp;replaces&nbsp;each&nbsp;rune&nbsp;r&nbsp;of&nbsp;s&nbsp;with&nbsp;replacementTable[r],&nbsp;provided&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4611235">//&nbsp;r&nbsp;&lt;&nbsp;len(replacementTable).&nbsp;If&nbsp;replacementTable[r]&nbsp;is&nbsp;the&nbsp;empty&nbsp;string&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4611313">//&nbsp;no&nbsp;replacement&nbsp;is&nbsp;made.</span><br>
<span class="lineno">245</span><span class="comment" id="4611340">//&nbsp;It&nbsp;also&nbsp;replaces&nbsp;runes&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;with&nbsp;the&nbsp;raw&nbsp;strings&nbsp;`\u2028`&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4611418">//&nbsp;`\u2029`.</span><br>
<span class="lineno"></span><span class="keyword" id="4611431">func</span>&nbsp;<span class="ident" id="4611436">replace</span><span class="op" id="4611443">(</span><span class="ident" id="4611444">s</span>&nbsp;<span class="builtintype" id="4611446">string</span><span class="op" id="4611452">,</span>&nbsp;<span class="ident" id="4611454">replacementTable</span>&nbsp;<span class="op" id="4611471">[</span><span class="op" id="4611472">]</span><span class="builtintype" id="4611473">string</span><span class="op" id="4611479">)</span>&nbsp;<span class="builtintype" id="4611481">string</span>&nbsp;<span class="op" id="4611488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611491">var</span>&nbsp;<span class="ident" id="4611495">b</span>&nbsp;<span class="ident" id="4611497">bytes</span><span class="op" id="4611502">.</span><span class="ident" id="4611503">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611511">written</span>&nbsp;<span class="op" id="4611519">:=</span>&nbsp;<span class="num" id="4611522">0</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611525">for</span>&nbsp;<span class="ident" id="4611529">i</span><span class="op" id="4611530">,</span>&nbsp;<span class="ident" id="4611532">r</span>&nbsp;<span class="op" id="4611534">:=</span>&nbsp;<span class="keyword" id="4611537">range</span>&nbsp;<span class="ident" id="4611543">s</span>&nbsp;<span class="op" id="4611545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611549">var</span>&nbsp;<span class="ident" id="4611553">repl</span>&nbsp;<span class="builtintype" id="4611558">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611567">switch</span>&nbsp;<span class="op" id="4611574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611578">case</span>&nbsp;<span class="builtintype" id="4611583">int</span><span class="op" id="4611586">(</span><span class="ident" id="4611587">r</span><span class="op" id="4611588">)</span>&nbsp;<span class="op" id="4611590">&lt;</span>&nbsp;<span class="builtinfunc" id="4611592">len</span><span class="op" id="4611595">(</span><span class="ident" id="4611596">replacementTable</span><span class="op" id="4611612">)</span>&nbsp;<span class="op" id="4611614">&amp;&amp;</span>&nbsp;<span class="ident" id="4611617">replacementTable</span><span class="op" id="4611633">[</span><span class="ident" id="4611634">r</span><span class="op" id="4611635">]</span>&nbsp;<span class="op" id="4611637">!=</span>&nbsp;<span class="string" id="4611640">&#34;&#34;</span><span class="op" id="4611642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611647">repl</span>&nbsp;<span class="op" id="4611652">=</span>&nbsp;<span class="ident" id="4611654">replacementTable</span><span class="op" id="4611670">[</span><span class="ident" id="4611671">r</span><span class="op" id="4611672">]</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611676">case</span>&nbsp;<span class="ident" id="4611681">r</span>&nbsp;<span class="op" id="4611683">==</span>&nbsp;<span class="string" id="4611686">&#39;\u2028&#39;</span><span class="op" id="4611694">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611699">repl</span>&nbsp;<span class="op" id="4611704">=</span>&nbsp;<span class="string" id="4611706">`\u2028`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611717">case</span>&nbsp;<span class="ident" id="4611722">r</span>&nbsp;<span class="op" id="4611724">==</span>&nbsp;<span class="string" id="4611727">&#39;\u2029&#39;</span><span class="op" id="4611735">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611740">repl</span>&nbsp;<span class="op" id="4611745">=</span>&nbsp;<span class="string" id="4611747">`\u2029`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611758">default</span><span class="op" id="4611765">:</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611770">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611785">b</span><span class="op" id="4611786">.</span><span class="ident" id="4611787">WriteString</span><span class="op" id="4611798">(</span><span class="ident" id="4611799">s</span><span class="op" id="4611800">[</span><span class="ident" id="4611801">written</span><span class="op" id="4611808">:</span><span class="ident" id="4611809">i</span><span class="op" id="4611810">]</span><span class="op" id="4611811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611815">b</span><span class="op" id="4611816">.</span><span class="ident" id="4611817">WriteString</span><span class="op" id="4611828">(</span><span class="ident" id="4611829">repl</span><span class="op" id="4611833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611837">written</span>&nbsp;<span class="op" id="4611845">=</span>&nbsp;<span class="ident" id="4611847">i</span>&nbsp;<span class="op" id="4611849">+</span>&nbsp;<span class="ident" id="4611851">utf8</span><span class="op" id="4611855">.</span><span class="ident" id="4611856">RuneLen</span><span class="op" id="4611863">(</span><span class="ident" id="4611864">r</span><span class="op" id="4611865">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611871">if</span>&nbsp;<span class="ident" id="4611874">written</span>&nbsp;<span class="op" id="4611882">==</span>&nbsp;<span class="num" id="4611885">0</span>&nbsp;<span class="op" id="4611887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611891">return</span>&nbsp;<span class="ident" id="4611898">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4611901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4611904">b</span><span class="op" id="4611905">.</span><span class="ident" id="4611906">WriteString</span><span class="op" id="4611917">(</span><span class="ident" id="4611918">s</span><span class="op" id="4611919">[</span><span class="ident" id="4611920">written</span><span class="op" id="4611927">:</span><span class="op" id="4611928">]</span><span class="op" id="4611929">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4611932">return</span>&nbsp;<span class="ident" id="4611939">b</span><span class="op" id="4611940">.</span><span class="ident" id="4611941">String</span><span class="op" id="4611947">(</span><span class="op" id="4611948">)</span><br>
<span class="lineno"></span><span class="op" id="4611950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4611953">var</span>&nbsp;<span class="ident" id="4611957">jsStrReplacementTable</span>&nbsp;<span class="op" id="4611979">=</span>&nbsp;<span class="op" id="4611981">[</span><span class="op" id="4611982">]</span><span class="builtintype" id="4611983">string</span><span class="op" id="4611989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4611992">0</span><span class="op" id="4611993">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4611998">`\0`</span><span class="op" id="4612002">,</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612005">&#39;\t&#39;</span><span class="op" id="4612009">:</span>&nbsp;<span class="string" id="4612011">`\t`</span><span class="op" id="4612015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612018">&#39;\n&#39;</span><span class="op" id="4612022">:</span>&nbsp;<span class="string" id="4612024">`\n`</span><span class="op" id="4612028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612031">&#39;\v&#39;</span><span class="op" id="4612035">:</span>&nbsp;<span class="string" id="4612037">`\x0b`</span><span class="op" id="4612043">,</span>&nbsp;<span class="comment" id="4612045">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612070">&#39;\f&#39;</span><span class="op" id="4612074">:</span>&nbsp;<span class="string" id="4612076">`\f`</span><span class="op" id="4612080">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612083">&#39;\r&#39;</span><span class="op" id="4612087">:</span>&nbsp;<span class="string" id="4612089">`\r`</span><span class="op" id="4612093">,</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612096">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612158">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612207">&#39;&#34;&#39;</span><span class="op" id="4612210">:</span>&nbsp;&nbsp;<span class="string" id="4612213">`\x22`</span><span class="op" id="4612219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612222">&#39;&amp;&#39;</span><span class="op" id="4612225">:</span>&nbsp;&nbsp;<span class="string" id="4612228">`\x26`</span><span class="op" id="4612234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612237">&#39;\&#39;&#39;</span><span class="op" id="4612241">:</span>&nbsp;<span class="string" id="4612243">`\x27`</span><span class="op" id="4612249">,</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612252">&#39;+&#39;</span><span class="op" id="4612255">:</span>&nbsp;&nbsp;<span class="string" id="4612258">`\x2b`</span><span class="op" id="4612264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612267">&#39;/&#39;</span><span class="op" id="4612270">:</span>&nbsp;&nbsp;<span class="string" id="4612273">`\/`</span><span class="op" id="4612277">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612280">&#39;&lt;&#39;</span><span class="op" id="4612283">:</span>&nbsp;&nbsp;<span class="string" id="4612286">`\x3c`</span><span class="op" id="4612292">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612295">&#39;&gt;&#39;</span><span class="op" id="4612298">:</span>&nbsp;&nbsp;<span class="string" id="4612301">`\x3e`</span><span class="op" id="4612307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612310">&#39;\\&#39;</span><span class="op" id="4612314">:</span>&nbsp;<span class="string" id="4612316">`\\`</span><span class="op" id="4612320">,</span><br>
<span class="lineno">290</span><span class="op" id="4612322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4612325">//&nbsp;jsStrNormReplacementTable&nbsp;is&nbsp;like&nbsp;jsStrReplacementTable&nbsp;but&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="4612397">//&nbsp;overencode&nbsp;existing&nbsp;escapes&nbsp;since&nbsp;this&nbsp;table&nbsp;has&nbsp;no&nbsp;entry&nbsp;for&nbsp;`\`.</span><br>
<span class="lineno"></span><span class="keyword" id="4612467">var</span>&nbsp;<span class="ident" id="4612471">jsStrNormReplacementTable</span>&nbsp;<span class="op" id="4612497">=</span>&nbsp;<span class="op" id="4612499">[</span><span class="op" id="4612500">]</span><span class="builtintype" id="4612501">string</span><span class="op" id="4612507">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4612510">0</span><span class="op" id="4612511">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4612516">`\0`</span><span class="op" id="4612520">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612523">&#39;\t&#39;</span><span class="op" id="4612527">:</span>&nbsp;<span class="string" id="4612529">`\t`</span><span class="op" id="4612533">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612536">&#39;\n&#39;</span><span class="op" id="4612540">:</span>&nbsp;<span class="string" id="4612542">`\n`</span><span class="op" id="4612546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612549">&#39;\v&#39;</span><span class="op" id="4612553">:</span>&nbsp;<span class="string" id="4612555">`\x0b`</span><span class="op" id="4612561">,</span>&nbsp;<span class="comment" id="4612563">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612588">&#39;\f&#39;</span><span class="op" id="4612592">:</span>&nbsp;<span class="string" id="4612594">`\f`</span><span class="op" id="4612598">,</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612601">&#39;\r&#39;</span><span class="op" id="4612605">:</span>&nbsp;<span class="string" id="4612607">`\r`</span><span class="op" id="4612611">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612614">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612676">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612725">&#39;&#34;&#39;</span><span class="op" id="4612728">:</span>&nbsp;&nbsp;<span class="string" id="4612731">`\x22`</span><span class="op" id="4612737">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612740">&#39;&amp;&#39;</span><span class="op" id="4612743">:</span>&nbsp;&nbsp;<span class="string" id="4612746">`\x26`</span><span class="op" id="4612752">,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612755">&#39;\&#39;&#39;</span><span class="op" id="4612759">:</span>&nbsp;<span class="string" id="4612761">`\x27`</span><span class="op" id="4612767">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612770">&#39;+&#39;</span><span class="op" id="4612773">:</span>&nbsp;&nbsp;<span class="string" id="4612776">`\x2b`</span><span class="op" id="4612782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612785">&#39;/&#39;</span><span class="op" id="4612788">:</span>&nbsp;&nbsp;<span class="string" id="4612791">`\/`</span><span class="op" id="4612795">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612798">&#39;&lt;&#39;</span><span class="op" id="4612801">:</span>&nbsp;&nbsp;<span class="string" id="4612804">`\x3c`</span><span class="op" id="4612810">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612813">&#39;&gt;&#39;</span><span class="op" id="4612816">:</span>&nbsp;&nbsp;<span class="string" id="4612819">`\x3e`</span><span class="op" id="4612825">,</span><br>
<span class="lineno">310</span><span class="op" id="4612827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4612830">var</span>&nbsp;<span class="ident" id="4612834">jsRegexpReplacementTable</span>&nbsp;<span class="op" id="4612859">=</span>&nbsp;<span class="op" id="4612861">[</span><span class="op" id="4612862">]</span><span class="builtintype" id="4612863">string</span><span class="op" id="4612869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="4612872">0</span><span class="op" id="4612873">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4612878">`\0`</span><span class="op" id="4612882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612885">&#39;\t&#39;</span><span class="op" id="4612889">:</span>&nbsp;<span class="string" id="4612891">`\t`</span><span class="op" id="4612895">,</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612898">&#39;\n&#39;</span><span class="op" id="4612902">:</span>&nbsp;<span class="string" id="4612904">`\n`</span><span class="op" id="4612908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612911">&#39;\v&#39;</span><span class="op" id="4612915">:</span>&nbsp;<span class="string" id="4612917">`\x0b`</span><span class="op" id="4612923">,</span>&nbsp;<span class="comment" id="4612925">//&nbsp;&#34;\v&#34;&nbsp;==&nbsp;&#34;v&#34;&nbsp;on&nbsp;IE&nbsp;6.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612950">&#39;\f&#39;</span><span class="op" id="4612954">:</span>&nbsp;<span class="string" id="4612956">`\f`</span><span class="op" id="4612960">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4612963">&#39;\r&#39;</span><span class="op" id="4612967">:</span>&nbsp;<span class="string" id="4612969">`\r`</span><span class="op" id="4612973">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4612976">//&nbsp;Encode&nbsp;HTML&nbsp;specials&nbsp;as&nbsp;hex&nbsp;so&nbsp;the&nbsp;output&nbsp;can&nbsp;be&nbsp;embedded</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4613038">//&nbsp;in&nbsp;HTML&nbsp;attributes&nbsp;without&nbsp;further&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613087">&#39;&#34;&#39;</span><span class="op" id="4613090">:</span>&nbsp;&nbsp;<span class="string" id="4613093">`\x22`</span><span class="op" id="4613099">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613102">&#39;$&#39;</span><span class="op" id="4613105">:</span>&nbsp;&nbsp;<span class="string" id="4613108">`\$`</span><span class="op" id="4613112">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613115">&#39;&amp;&#39;</span><span class="op" id="4613118">:</span>&nbsp;&nbsp;<span class="string" id="4613121">`\x26`</span><span class="op" id="4613127">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613130">&#39;\&#39;&#39;</span><span class="op" id="4613134">:</span>&nbsp;<span class="string" id="4613136">`\x27`</span><span class="op" id="4613142">,</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613145">&#39;(&#39;</span><span class="op" id="4613148">:</span>&nbsp;&nbsp;<span class="string" id="4613151">`\(`</span><span class="op" id="4613155">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613158">&#39;)&#39;</span><span class="op" id="4613161">:</span>&nbsp;&nbsp;<span class="string" id="4613164">`\)`</span><span class="op" id="4613168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613171">&#39;*&#39;</span><span class="op" id="4613174">:</span>&nbsp;&nbsp;<span class="string" id="4613177">`\*`</span><span class="op" id="4613181">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613184">&#39;+&#39;</span><span class="op" id="4613187">:</span>&nbsp;&nbsp;<span class="string" id="4613190">`\x2b`</span><span class="op" id="4613196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613199">&#39;-&#39;</span><span class="op" id="4613202">:</span>&nbsp;&nbsp;<span class="string" id="4613205">`\-`</span><span class="op" id="4613209">,</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613212">&#39;.&#39;</span><span class="op" id="4613215">:</span>&nbsp;&nbsp;<span class="string" id="4613218">`\.`</span><span class="op" id="4613222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613225">&#39;/&#39;</span><span class="op" id="4613228">:</span>&nbsp;&nbsp;<span class="string" id="4613231">`\/`</span><span class="op" id="4613235">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613238">&#39;&lt;&#39;</span><span class="op" id="4613241">:</span>&nbsp;&nbsp;<span class="string" id="4613244">`\x3c`</span><span class="op" id="4613250">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613253">&#39;&gt;&#39;</span><span class="op" id="4613256">:</span>&nbsp;&nbsp;<span class="string" id="4613259">`\x3e`</span><span class="op" id="4613265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613268">&#39;?&#39;</span><span class="op" id="4613271">:</span>&nbsp;&nbsp;<span class="string" id="4613274">`\?`</span><span class="op" id="4613278">,</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613281">&#39;[&#39;</span><span class="op" id="4613284">:</span>&nbsp;&nbsp;<span class="string" id="4613287">`\[`</span><span class="op" id="4613291">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613294">&#39;\\&#39;</span><span class="op" id="4613298">:</span>&nbsp;<span class="string" id="4613300">`\\`</span><span class="op" id="4613304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613307">&#39;]&#39;</span><span class="op" id="4613310">:</span>&nbsp;&nbsp;<span class="string" id="4613313">`\]`</span><span class="op" id="4613317">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613320">&#39;^&#39;</span><span class="op" id="4613323">:</span>&nbsp;&nbsp;<span class="string" id="4613326">`\^`</span><span class="op" id="4613330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613333">&#39;{&#39;</span><span class="op" id="4613336">:</span>&nbsp;&nbsp;<span class="string" id="4613339">`\{`</span><span class="op" id="4613343">,</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613346">&#39;|&#39;</span><span class="op" id="4613349">:</span>&nbsp;&nbsp;<span class="string" id="4613352">`\|`</span><span class="op" id="4613356">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4613359">&#39;}&#39;</span><span class="op" id="4613362">:</span>&nbsp;&nbsp;<span class="string" id="4613365">`\}`</span><span class="op" id="4613369">,</span><br>
<span class="lineno"></span><span class="op" id="4613371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4613374">//&nbsp;isJSIdentPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;given&nbsp;rune&nbsp;is&nbsp;a&nbsp;JS&nbsp;identifier&nbsp;part.</span><br>
<span class="lineno">345</span><span class="comment" id="4613447">//&nbsp;It&nbsp;does&nbsp;not&nbsp;handle&nbsp;all&nbsp;the&nbsp;non-Latin&nbsp;letters,&nbsp;joiners,&nbsp;and&nbsp;combining&nbsp;marks,</span><br>
<span class="lineno"></span><span class="comment" id="4613526">//&nbsp;but&nbsp;it&nbsp;does&nbsp;handle&nbsp;every&nbsp;codepoint&nbsp;that&nbsp;can&nbsp;occur&nbsp;in&nbsp;a&nbsp;numeric&nbsp;literal&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="4613603">//&nbsp;a&nbsp;keyword.</span><br>
<span class="lineno"></span><span class="keyword" id="4613617">func</span>&nbsp;<span class="ident" id="4613622">isJSIdentPart</span><span class="op" id="4613635">(</span><span class="ident" id="4613636">r</span>&nbsp;<span class="builtintype" id="4613638">rune</span><span class="op" id="4613642">)</span>&nbsp;<span class="builtintype" id="4613644">bool</span>&nbsp;<span class="op" id="4613649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613652">switch</span>&nbsp;<span class="op" id="4613659">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613662">case</span>&nbsp;<span class="ident" id="4613667">r</span>&nbsp;<span class="op" id="4613669">==</span>&nbsp;<span class="string" id="4613672">&#39;$&#39;</span><span class="op" id="4613675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613679">return</span>&nbsp;<span class="builtintype" id="4613686">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613692">case</span>&nbsp;<span class="string" id="4613697">&#39;0&#39;</span>&nbsp;<span class="op" id="4613701">&lt;=</span>&nbsp;<span class="ident" id="4613704">r</span>&nbsp;<span class="op" id="4613706">&amp;&amp;</span>&nbsp;<span class="ident" id="4613709">r</span>&nbsp;<span class="op" id="4613711">&lt;=</span>&nbsp;<span class="string" id="4613714">&#39;9&#39;</span><span class="op" id="4613717">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613721">return</span>&nbsp;<span class="builtintype" id="4613728">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613734">case</span>&nbsp;<span class="string" id="4613739">&#39;A&#39;</span>&nbsp;<span class="op" id="4613743">&lt;=</span>&nbsp;<span class="ident" id="4613746">r</span>&nbsp;<span class="op" id="4613748">&amp;&amp;</span>&nbsp;<span class="ident" id="4613751">r</span>&nbsp;<span class="op" id="4613753">&lt;=</span>&nbsp;<span class="string" id="4613756">&#39;Z&#39;</span><span class="op" id="4613759">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613763">return</span>&nbsp;<span class="builtintype" id="4613770">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613776">case</span>&nbsp;<span class="ident" id="4613781">r</span>&nbsp;<span class="op" id="4613783">==</span>&nbsp;<span class="string" id="4613786">&#39;_&#39;</span><span class="op" id="4613789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613793">return</span>&nbsp;<span class="builtintype" id="4613800">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613806">case</span>&nbsp;<span class="string" id="4613811">&#39;a&#39;</span>&nbsp;<span class="op" id="4613815">&lt;=</span>&nbsp;<span class="ident" id="4613818">r</span>&nbsp;<span class="op" id="4613820">&amp;&amp;</span>&nbsp;<span class="ident" id="4613823">r</span>&nbsp;<span class="op" id="4613825">&lt;=</span>&nbsp;<span class="string" id="4613828">&#39;z&#39;</span><span class="op" id="4613831">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613835">return</span>&nbsp;<span class="builtintype" id="4613842">true</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4613848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4613851">return</span>&nbsp;<span class="builtintype" id="4613858">false</span><br>
<span class="lineno"></span><span class="op" id="4613864">}</span>
</div>
</body>
</html>
