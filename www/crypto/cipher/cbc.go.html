<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3835158">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3835213">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3835267">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3835318">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3835356">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3835430">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3835503">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835537">package</span>&nbsp;<span class="ident" id="3835545">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835553">type</span>&nbsp;<span class="ident" id="3835558">cbc</span>&nbsp;<span class="keyword" id="3835562">struct</span>&nbsp;<span class="op" id="3835569">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835572">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835582">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835589">blockSize</span>&nbsp;<span class="builtintype" id="3835599">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835604">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835614">[</span><span class="op" id="3835615">]</span><span class="builtintype" id="3835616">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835622">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3835632">[</span><span class="op" id="3835633">]</span><span class="builtintype" id="3835634">byte</span><br>
<span class="lineno"></span><span class="op" id="3835639">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3835642">func</span>&nbsp;<span class="ident" id="3835647">newCBC</span><span class="op" id="3835653">(</span><span class="ident" id="3835654">b</span>&nbsp;<span class="ident" id="3835656">Block</span><span class="op" id="3835661">,</span>&nbsp;<span class="ident" id="3835663">iv</span>&nbsp;<span class="op" id="3835666">[</span><span class="op" id="3835667">]</span><span class="builtintype" id="3835668">byte</span><span class="op" id="3835672">)</span>&nbsp;<span class="op" id="3835674">*</span><span class="ident" id="3835675">cbc</span>&nbsp;<span class="op" id="3835679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835682">return</span>&nbsp;<span class="op" id="3835689">&amp;</span><span class="ident" id="3835690">cbc</span><span class="op" id="3835693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835697">b</span><span class="op" id="3835698">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835708">b</span><span class="op" id="3835709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835713">blockSize</span><span class="op" id="3835722">:</span>&nbsp;<span class="ident" id="3835724">b</span><span class="op" id="3835725">.</span><span class="ident" id="3835726">BlockSize</span><span class="op" id="3835735">(</span><span class="op" id="3835736">)</span><span class="op" id="3835737">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835741">iv</span><span class="op" id="3835743">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3835752">dup</span><span class="op" id="3835755">(</span><span class="ident" id="3835756">iv</span><span class="op" id="3835758">)</span><span class="op" id="3835759">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835763">tmp</span><span class="op" id="3835766">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3835774">make</span><span class="op" id="3835778">(</span><span class="op" id="3835779">[</span><span class="op" id="3835780">]</span><span class="builtintype" id="3835781">byte</span><span class="op" id="3835785">,</span>&nbsp;<span class="ident" id="3835787">b</span><span class="op" id="3835788">.</span><span class="ident" id="3835789">BlockSize</span><span class="op" id="3835798">(</span><span class="op" id="3835799">)</span><span class="op" id="3835800">)</span><span class="op" id="3835801">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835804">}</span><br>
<span class="lineno"></span><span class="op" id="3835806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3835809">type</span>&nbsp;<span class="ident" id="3835814">cbcEncrypter</span>&nbsp;<span class="ident" id="3835827">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3835832">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3835911">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3835984">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3836007">func</span>&nbsp;<span class="ident" id="3836012">NewCBCEncrypter</span><span class="op" id="3836027">(</span><span class="ident" id="3836028">b</span>&nbsp;<span class="ident" id="3836030">Block</span><span class="op" id="3836035">,</span>&nbsp;<span class="ident" id="3836037">iv</span>&nbsp;<span class="op" id="3836040">[</span><span class="op" id="3836041">]</span><span class="builtintype" id="3836042">byte</span><span class="op" id="3836046">)</span>&nbsp;<span class="ident" id="3836048">BlockMode</span>&nbsp;<span class="op" id="3836058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836061">if</span>&nbsp;<span class="builtinfunc" id="3836064">len</span><span class="op" id="3836067">(</span><span class="ident" id="3836068">iv</span><span class="op" id="3836070">)</span>&nbsp;<span class="op" id="3836072">!=</span>&nbsp;<span class="ident" id="3836075">b</span><span class="op" id="3836076">.</span><span class="ident" id="3836077">BlockSize</span><span class="op" id="3836086">(</span><span class="op" id="3836087">)</span>&nbsp;<span class="op" id="3836089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836093">panic</span><span class="op" id="3836098">(</span><span class="string" id="3836099">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3836156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836162">return</span>&nbsp;<span class="op" id="3836169">(</span><span class="op" id="3836170">*</span><span class="ident" id="3836171">cbcEncrypter</span><span class="op" id="3836183">)</span><span class="op" id="3836184">(</span><span class="ident" id="3836185">newCBC</span><span class="op" id="3836191">(</span><span class="ident" id="3836192">b</span><span class="op" id="3836193">,</span>&nbsp;<span class="ident" id="3836195">iv</span><span class="op" id="3836197">)</span><span class="op" id="3836198">)</span><br>
<span class="lineno">40</span><span class="op" id="3836200">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3836203">func</span>&nbsp;<span class="op" id="3836208">(</span><span class="ident" id="3836209">x</span>&nbsp;<span class="op" id="3836211">*</span><span class="ident" id="3836212">cbcEncrypter</span><span class="op" id="3836224">)</span>&nbsp;<span class="ident" id="3836226">BlockSize</span><span class="op" id="3836235">(</span><span class="op" id="3836236">)</span>&nbsp;<span class="builtintype" id="3836238">int</span>&nbsp;<span class="op" id="3836242">{</span>&nbsp;<span class="keyword" id="3836244">return</span>&nbsp;<span class="ident" id="3836251">x</span><span class="op" id="3836252">.</span><span class="ident" id="3836253">blockSize</span>&nbsp;<span class="op" id="3836263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3836266">func</span>&nbsp;<span class="op" id="3836271">(</span><span class="ident" id="3836272">x</span>&nbsp;<span class="op" id="3836274">*</span><span class="ident" id="3836275">cbcEncrypter</span><span class="op" id="3836287">)</span>&nbsp;<span class="ident" id="3836289">CryptBlocks</span><span class="op" id="3836300">(</span><span class="ident" id="3836301">dst</span><span class="op" id="3836304">,</span>&nbsp;<span class="ident" id="3836306">src</span>&nbsp;<span class="op" id="3836310">[</span><span class="op" id="3836311">]</span><span class="builtintype" id="3836312">byte</span><span class="op" id="3836316">)</span>&nbsp;<span class="op" id="3836318">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836321">if</span>&nbsp;<span class="builtinfunc" id="3836324">len</span><span class="op" id="3836327">(</span><span class="ident" id="3836328">src</span><span class="op" id="3836331">)</span><span class="op" id="3836332">%</span><span class="ident" id="3836333">x</span><span class="op" id="3836334">.</span><span class="ident" id="3836335">blockSize</span>&nbsp;<span class="op" id="3836345">!=</span>&nbsp;<span class="num" id="3836348">0</span>&nbsp;<span class="op" id="3836350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836354">panic</span><span class="op" id="3836359">(</span><span class="string" id="3836360">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3836398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836404">if</span>&nbsp;<span class="builtinfunc" id="3836407">len</span><span class="op" id="3836410">(</span><span class="ident" id="3836411">dst</span><span class="op" id="3836414">)</span>&nbsp;<span class="op" id="3836416">&lt;</span>&nbsp;<span class="builtinfunc" id="3836418">len</span><span class="op" id="3836421">(</span><span class="ident" id="3836422">src</span><span class="op" id="3836425">)</span>&nbsp;<span class="op" id="3836427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836431">panic</span><span class="op" id="3836436">(</span><span class="string" id="3836437">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3836479">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836486">iv</span>&nbsp;<span class="op" id="3836489">:=</span>&nbsp;<span class="ident" id="3836492">x</span><span class="op" id="3836493">.</span><span class="ident" id="3836494">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836499">for</span>&nbsp;<span class="builtinfunc" id="3836503">len</span><span class="op" id="3836506">(</span><span class="ident" id="3836507">src</span><span class="op" id="3836510">)</span>&nbsp;<span class="op" id="3836512">&gt;</span>&nbsp;<span class="num" id="3836514">0</span>&nbsp;<span class="op" id="3836516">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836520">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836570">xorBytes</span><span class="op" id="3836578">(</span><span class="ident" id="3836579">dst</span><span class="op" id="3836582">[</span><span class="op" id="3836583">:</span><span class="ident" id="3836584">x</span><span class="op" id="3836585">.</span><span class="ident" id="3836586">blockSize</span><span class="op" id="3836595">]</span><span class="op" id="3836596">,</span>&nbsp;<span class="ident" id="3836598">src</span><span class="op" id="3836601">[</span><span class="op" id="3836602">:</span><span class="ident" id="3836603">x</span><span class="op" id="3836604">.</span><span class="ident" id="3836605">blockSize</span><span class="op" id="3836614">]</span><span class="op" id="3836615">,</span>&nbsp;<span class="ident" id="3836617">iv</span><span class="op" id="3836619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836623">x</span><span class="op" id="3836624">.</span><span class="ident" id="3836625">b</span><span class="op" id="3836626">.</span><span class="ident" id="3836627">Encrypt</span><span class="op" id="3836634">(</span><span class="ident" id="3836635">dst</span><span class="op" id="3836638">[</span><span class="op" id="3836639">:</span><span class="ident" id="3836640">x</span><span class="op" id="3836641">.</span><span class="ident" id="3836642">blockSize</span><span class="op" id="3836651">]</span><span class="op" id="3836652">,</span>&nbsp;<span class="ident" id="3836654">dst</span><span class="op" id="3836657">[</span><span class="op" id="3836658">:</span><span class="ident" id="3836659">x</span><span class="op" id="3836660">.</span><span class="ident" id="3836661">blockSize</span><span class="op" id="3836670">]</span><span class="op" id="3836671">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836676">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836736">iv</span>&nbsp;<span class="op" id="3836739">=</span>&nbsp;<span class="ident" id="3836741">dst</span><span class="op" id="3836744">[</span><span class="op" id="3836745">:</span><span class="ident" id="3836746">x</span><span class="op" id="3836747">.</span><span class="ident" id="3836748">blockSize</span><span class="op" id="3836757">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836761">src</span>&nbsp;<span class="op" id="3836765">=</span>&nbsp;<span class="ident" id="3836767">src</span><span class="op" id="3836770">[</span><span class="ident" id="3836771">x</span><span class="op" id="3836772">.</span><span class="ident" id="3836773">blockSize</span><span class="op" id="3836782">:</span><span class="op" id="3836783">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836787">dst</span>&nbsp;<span class="op" id="3836791">=</span>&nbsp;<span class="ident" id="3836793">dst</span><span class="op" id="3836796">[</span><span class="ident" id="3836797">x</span><span class="op" id="3836798">.</span><span class="ident" id="3836799">blockSize</span><span class="op" id="3836808">:</span><span class="op" id="3836809">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3836816">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836863">copy</span><span class="op" id="3836867">(</span><span class="ident" id="3836868">x</span><span class="op" id="3836869">.</span><span class="ident" id="3836870">iv</span><span class="op" id="3836872">,</span>&nbsp;<span class="ident" id="3836874">iv</span><span class="op" id="3836876">)</span><br>
<span class="lineno"></span><span class="op" id="3836878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3836881">func</span>&nbsp;<span class="op" id="3836886">(</span><span class="ident" id="3836887">x</span>&nbsp;<span class="op" id="3836889">*</span><span class="ident" id="3836890">cbcEncrypter</span><span class="op" id="3836902">)</span>&nbsp;<span class="ident" id="3836904">SetIV</span><span class="op" id="3836909">(</span><span class="ident" id="3836910">iv</span>&nbsp;<span class="op" id="3836913">[</span><span class="op" id="3836914">]</span><span class="builtintype" id="3836915">byte</span><span class="op" id="3836919">)</span>&nbsp;<span class="op" id="3836921">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836924">if</span>&nbsp;<span class="builtinfunc" id="3836927">len</span><span class="op" id="3836930">(</span><span class="ident" id="3836931">iv</span><span class="op" id="3836933">)</span>&nbsp;<span class="op" id="3836935">!=</span>&nbsp;<span class="builtinfunc" id="3836938">len</span><span class="op" id="3836941">(</span><span class="ident" id="3836942">x</span><span class="op" id="3836943">.</span><span class="ident" id="3836944">iv</span><span class="op" id="3836946">)</span>&nbsp;<span class="op" id="3836948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836952">panic</span><span class="op" id="3836957">(</span><span class="string" id="3836958">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3836987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3836993">copy</span><span class="op" id="3836997">(</span><span class="ident" id="3836998">x</span><span class="op" id="3836999">.</span><span class="ident" id="3837000">iv</span><span class="op" id="3837002">,</span>&nbsp;<span class="ident" id="3837004">iv</span><span class="op" id="3837006">)</span><br>
<span class="lineno"></span><span class="op" id="3837008">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3837011">type</span>&nbsp;<span class="ident" id="3837016">cbcDecrypter</span>&nbsp;<span class="ident" id="3837029">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3837034">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3837113">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3837186">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3837256">func</span>&nbsp;<span class="ident" id="3837261">NewCBCDecrypter</span><span class="op" id="3837276">(</span><span class="ident" id="3837277">b</span>&nbsp;<span class="ident" id="3837279">Block</span><span class="op" id="3837284">,</span>&nbsp;<span class="ident" id="3837286">iv</span>&nbsp;<span class="op" id="3837289">[</span><span class="op" id="3837290">]</span><span class="builtintype" id="3837291">byte</span><span class="op" id="3837295">)</span>&nbsp;<span class="ident" id="3837297">BlockMode</span>&nbsp;<span class="op" id="3837307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837310">if</span>&nbsp;<span class="builtinfunc" id="3837313">len</span><span class="op" id="3837316">(</span><span class="ident" id="3837317">iv</span><span class="op" id="3837319">)</span>&nbsp;<span class="op" id="3837321">!=</span>&nbsp;<span class="ident" id="3837324">b</span><span class="op" id="3837325">.</span><span class="ident" id="3837326">BlockSize</span><span class="op" id="3837335">(</span><span class="op" id="3837336">)</span>&nbsp;<span class="op" id="3837338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3837342">panic</span><span class="op" id="3837347">(</span><span class="string" id="3837348">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3837405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837408">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837411">return</span>&nbsp;<span class="op" id="3837418">(</span><span class="op" id="3837419">*</span><span class="ident" id="3837420">cbcDecrypter</span><span class="op" id="3837432">)</span><span class="op" id="3837433">(</span><span class="ident" id="3837434">newCBC</span><span class="op" id="3837440">(</span><span class="ident" id="3837441">b</span><span class="op" id="3837442">,</span>&nbsp;<span class="ident" id="3837444">iv</span><span class="op" id="3837446">)</span><span class="op" id="3837447">)</span><br>
<span class="lineno"></span><span class="op" id="3837449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3837452">func</span>&nbsp;<span class="op" id="3837457">(</span><span class="ident" id="3837458">x</span>&nbsp;<span class="op" id="3837460">*</span><span class="ident" id="3837461">cbcDecrypter</span><span class="op" id="3837473">)</span>&nbsp;<span class="ident" id="3837475">BlockSize</span><span class="op" id="3837484">(</span><span class="op" id="3837485">)</span>&nbsp;<span class="builtintype" id="3837487">int</span>&nbsp;<span class="op" id="3837491">{</span>&nbsp;<span class="keyword" id="3837493">return</span>&nbsp;<span class="ident" id="3837500">x</span><span class="op" id="3837501">.</span><span class="ident" id="3837502">blockSize</span>&nbsp;<span class="op" id="3837512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3837515">func</span>&nbsp;<span class="op" id="3837520">(</span><span class="ident" id="3837521">x</span>&nbsp;<span class="op" id="3837523">*</span><span class="ident" id="3837524">cbcDecrypter</span><span class="op" id="3837536">)</span>&nbsp;<span class="ident" id="3837538">CryptBlocks</span><span class="op" id="3837549">(</span><span class="ident" id="3837550">dst</span><span class="op" id="3837553">,</span>&nbsp;<span class="ident" id="3837555">src</span>&nbsp;<span class="op" id="3837559">[</span><span class="op" id="3837560">]</span><span class="builtintype" id="3837561">byte</span><span class="op" id="3837565">)</span>&nbsp;<span class="op" id="3837567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837570">if</span>&nbsp;<span class="builtinfunc" id="3837573">len</span><span class="op" id="3837576">(</span><span class="ident" id="3837577">src</span><span class="op" id="3837580">)</span><span class="op" id="3837581">%</span><span class="ident" id="3837582">x</span><span class="op" id="3837583">.</span><span class="ident" id="3837584">blockSize</span>&nbsp;<span class="op" id="3837594">!=</span>&nbsp;<span class="num" id="3837597">0</span>&nbsp;<span class="op" id="3837599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3837603">panic</span><span class="op" id="3837608">(</span><span class="string" id="3837609">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3837647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837653">if</span>&nbsp;<span class="builtinfunc" id="3837656">len</span><span class="op" id="3837659">(</span><span class="ident" id="3837660">dst</span><span class="op" id="3837663">)</span>&nbsp;<span class="op" id="3837665">&lt;</span>&nbsp;<span class="builtinfunc" id="3837667">len</span><span class="op" id="3837670">(</span><span class="ident" id="3837671">src</span><span class="op" id="3837674">)</span>&nbsp;<span class="op" id="3837676">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3837680">panic</span><span class="op" id="3837685">(</span><span class="string" id="3837686">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3837728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837734">if</span>&nbsp;<span class="builtinfunc" id="3837737">len</span><span class="op" id="3837740">(</span><span class="ident" id="3837741">src</span><span class="op" id="3837744">)</span>&nbsp;<span class="op" id="3837746">==</span>&nbsp;<span class="num" id="3837749">0</span>&nbsp;<span class="op" id="3837751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837755">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837763">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3837767">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3837868">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837941">end</span>&nbsp;<span class="op" id="3837945">:=</span>&nbsp;<span class="builtinfunc" id="3837948">len</span><span class="op" id="3837951">(</span><span class="ident" id="3837952">src</span><span class="op" id="3837955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837958">start</span>&nbsp;<span class="op" id="3837964">:=</span>&nbsp;<span class="ident" id="3837967">end</span>&nbsp;<span class="op" id="3837971">-</span>&nbsp;<span class="ident" id="3837973">x</span><span class="op" id="3837974">.</span><span class="ident" id="3837975">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837986">prev</span>&nbsp;<span class="op" id="3837991">:=</span>&nbsp;<span class="ident" id="3837994">start</span>&nbsp;<span class="op" id="3838000">-</span>&nbsp;<span class="ident" id="3838002">x</span><span class="op" id="3838003">.</span><span class="ident" id="3838004">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838016">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3838084">copy</span><span class="op" id="3838088">(</span><span class="ident" id="3838089">x</span><span class="op" id="3838090">.</span><span class="ident" id="3838091">tmp</span><span class="op" id="3838094">,</span>&nbsp;<span class="ident" id="3838096">src</span><span class="op" id="3838099">[</span><span class="ident" id="3838100">start</span><span class="op" id="3838105">:</span><span class="ident" id="3838106">end</span><span class="op" id="3838109">]</span><span class="op" id="3838110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838114">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838153">for</span>&nbsp;<span class="ident" id="3838157">start</span>&nbsp;<span class="op" id="3838163">&gt;</span>&nbsp;<span class="num" id="3838165">0</span>&nbsp;<span class="op" id="3838167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838171">x</span><span class="op" id="3838172">.</span><span class="ident" id="3838173">b</span><span class="op" id="3838174">.</span><span class="ident" id="3838175">Decrypt</span><span class="op" id="3838182">(</span><span class="ident" id="3838183">dst</span><span class="op" id="3838186">[</span><span class="ident" id="3838187">start</span><span class="op" id="3838192">:</span><span class="ident" id="3838193">end</span><span class="op" id="3838196">]</span><span class="op" id="3838197">,</span>&nbsp;<span class="ident" id="3838199">src</span><span class="op" id="3838202">[</span><span class="ident" id="3838203">start</span><span class="op" id="3838208">:</span><span class="ident" id="3838209">end</span><span class="op" id="3838212">]</span><span class="op" id="3838213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838217">xorBytes</span><span class="op" id="3838225">(</span><span class="ident" id="3838226">dst</span><span class="op" id="3838229">[</span><span class="ident" id="3838230">start</span><span class="op" id="3838235">:</span><span class="ident" id="3838236">end</span><span class="op" id="3838239">]</span><span class="op" id="3838240">,</span>&nbsp;<span class="ident" id="3838242">dst</span><span class="op" id="3838245">[</span><span class="ident" id="3838246">start</span><span class="op" id="3838251">:</span><span class="ident" id="3838252">end</span><span class="op" id="3838255">]</span><span class="op" id="3838256">,</span>&nbsp;<span class="ident" id="3838258">src</span><span class="op" id="3838261">[</span><span class="ident" id="3838262">prev</span><span class="op" id="3838266">:</span><span class="ident" id="3838267">start</span><span class="op" id="3838272">]</span><span class="op" id="3838273">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838278">end</span>&nbsp;<span class="op" id="3838282">=</span>&nbsp;<span class="ident" id="3838284">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838292">start</span>&nbsp;<span class="op" id="3838298">=</span>&nbsp;<span class="ident" id="3838300">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838307">prev</span>&nbsp;<span class="op" id="3838312">-=</span>&nbsp;<span class="ident" id="3838315">x</span><span class="op" id="3838316">.</span><span class="ident" id="3838317">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838328">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838332">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838393">x</span><span class="op" id="3838394">.</span><span class="ident" id="3838395">b</span><span class="op" id="3838396">.</span><span class="ident" id="3838397">Decrypt</span><span class="op" id="3838404">(</span><span class="ident" id="3838405">dst</span><span class="op" id="3838408">[</span><span class="ident" id="3838409">start</span><span class="op" id="3838414">:</span><span class="ident" id="3838415">end</span><span class="op" id="3838418">]</span><span class="op" id="3838419">,</span>&nbsp;<span class="ident" id="3838421">src</span><span class="op" id="3838424">[</span><span class="ident" id="3838425">start</span><span class="op" id="3838430">:</span><span class="ident" id="3838431">end</span><span class="op" id="3838434">]</span><span class="op" id="3838435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838438">xorBytes</span><span class="op" id="3838446">(</span><span class="ident" id="3838447">dst</span><span class="op" id="3838450">[</span><span class="ident" id="3838451">start</span><span class="op" id="3838456">:</span><span class="ident" id="3838457">end</span><span class="op" id="3838460">]</span><span class="op" id="3838461">,</span>&nbsp;<span class="ident" id="3838463">dst</span><span class="op" id="3838466">[</span><span class="ident" id="3838467">start</span><span class="op" id="3838472">:</span><span class="ident" id="3838473">end</span><span class="op" id="3838476">]</span><span class="op" id="3838477">,</span>&nbsp;<span class="ident" id="3838479">x</span><span class="op" id="3838480">.</span><span class="ident" id="3838481">iv</span><span class="op" id="3838483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838487">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3838544">x</span><span class="op" id="3838545">.</span><span class="ident" id="3838546">iv</span><span class="op" id="3838548">,</span>&nbsp;<span class="ident" id="3838550">x</span><span class="op" id="3838551">.</span><span class="ident" id="3838552">tmp</span>&nbsp;<span class="op" id="3838556">=</span>&nbsp;<span class="ident" id="3838558">x</span><span class="op" id="3838559">.</span><span class="ident" id="3838560">tmp</span><span class="op" id="3838563">,</span>&nbsp;<span class="ident" id="3838565">x</span><span class="op" id="3838566">.</span><span class="ident" id="3838567">iv</span><br>
<span class="lineno"></span><span class="op" id="3838570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3838573">func</span>&nbsp;<span class="op" id="3838578">(</span><span class="ident" id="3838579">x</span>&nbsp;<span class="op" id="3838581">*</span><span class="ident" id="3838582">cbcDecrypter</span><span class="op" id="3838594">)</span>&nbsp;<span class="ident" id="3838596">SetIV</span><span class="op" id="3838601">(</span><span class="ident" id="3838602">iv</span>&nbsp;<span class="op" id="3838605">[</span><span class="op" id="3838606">]</span><span class="builtintype" id="3838607">byte</span><span class="op" id="3838611">)</span>&nbsp;<span class="op" id="3838613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838616">if</span>&nbsp;<span class="builtinfunc" id="3838619">len</span><span class="op" id="3838622">(</span><span class="ident" id="3838623">iv</span><span class="op" id="3838625">)</span>&nbsp;<span class="op" id="3838627">!=</span>&nbsp;<span class="builtinfunc" id="3838630">len</span><span class="op" id="3838633">(</span><span class="ident" id="3838634">x</span><span class="op" id="3838635">.</span><span class="ident" id="3838636">iv</span><span class="op" id="3838638">)</span>&nbsp;<span class="op" id="3838640">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3838644">panic</span><span class="op" id="3838649">(</span><span class="string" id="3838650">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3838679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3838685">copy</span><span class="op" id="3838689">(</span><span class="ident" id="3838690">x</span><span class="op" id="3838691">.</span><span class="ident" id="3838692">iv</span><span class="op" id="3838694">,</span>&nbsp;<span class="ident" id="3838696">iv</span><span class="op" id="3838698">)</span><br>
<span class="lineno"></span><span class="op" id="3838700">}</span>
</div>
</body>
</html>
