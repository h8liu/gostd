<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6235316">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6235371">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6235425">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6235476">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="6235554">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6235630">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6235661">//</span><br>
<span class="lineno"></span><span class="comment" id="6235664">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="6235730">//</span><br>
<span class="lineno"></span><span class="comment" id="6235733">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6235803">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="6235827">//</span><br>
<span class="lineno"></span><span class="comment" id="6235830">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="6235851">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="6235881">//</span><br>
<span class="lineno"></span><span class="comment" id="6235884">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6235949">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6236017">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="6236067">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6236088">//</span><br>
<span class="lineno"></span><span class="keyword" id="6236091">package</span>&nbsp;<span class="ident" id="6236099">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6236107">import</span>&nbsp;<span class="op" id="6236114">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236117">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236126">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236143">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236150">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236157">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236169">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236175">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236186">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236194">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6236205">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="6236212">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6236215">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6236270">type</span>&nbsp;<span class="ident" id="6236275">Var</span>&nbsp;<span class="keyword" id="6236279">interface</span>&nbsp;<span class="op" id="6236289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236292">String</span><span class="op" id="6236298">(</span><span class="op" id="6236299">)</span>&nbsp;<span class="builtintype" id="6236301">string</span><br>
<span class="lineno">40</span><span class="op" id="6236308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6236311">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6236381">type</span>&nbsp;<span class="ident" id="6236386">Int</span>&nbsp;<span class="keyword" id="6236390">struct</span>&nbsp;<span class="op" id="6236397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236400">mu</span>&nbsp;<span class="ident" id="6236403">sync</span><span class="op" id="6236407">.</span><span class="ident" id="6236408">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236417">i</span>&nbsp;&nbsp;<span class="ident" id="6236420">int64</span><br>
<span class="lineno"></span><span class="op" id="6236426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6236429">func</span>&nbsp;<span class="op" id="6236434">(</span><span class="ident" id="6236435">v</span>&nbsp;<span class="op" id="6236437">*</span><span class="ident" id="6236438">Int</span><span class="op" id="6236441">)</span>&nbsp;<span class="ident" id="6236443">String</span><span class="op" id="6236449">(</span><span class="op" id="6236450">)</span>&nbsp;<span class="builtintype" id="6236452">string</span>&nbsp;<span class="op" id="6236459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236462">v</span><span class="op" id="6236463">.</span><span class="ident" id="6236464">mu</span><span class="op" id="6236466">.</span><span class="ident" id="6236467">RLock</span><span class="op" id="6236472">(</span><span class="op" id="6236473">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236476">defer</span>&nbsp;<span class="ident" id="6236482">v</span><span class="op" id="6236483">.</span><span class="ident" id="6236484">mu</span><span class="op" id="6236486">.</span><span class="ident" id="6236487">RUnlock</span><span class="op" id="6236494">(</span><span class="op" id="6236495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236498">return</span>&nbsp;<span class="ident" id="6236505">strconv</span><span class="op" id="6236512">.</span><span class="ident" id="6236513">FormatInt</span><span class="op" id="6236522">(</span><span class="ident" id="6236523">v</span><span class="op" id="6236524">.</span><span class="ident" id="6236525">i</span><span class="op" id="6236526">,</span>&nbsp;<span class="num" id="6236528">10</span><span class="op" id="6236530">)</span><br>
<span class="lineno"></span><span class="op" id="6236532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6236535">func</span>&nbsp;<span class="op" id="6236540">(</span><span class="ident" id="6236541">v</span>&nbsp;<span class="op" id="6236543">*</span><span class="ident" id="6236544">Int</span><span class="op" id="6236547">)</span>&nbsp;<span class="ident" id="6236549">Add</span><span class="op" id="6236552">(</span><span class="ident" id="6236553">delta</span>&nbsp;<span class="ident" id="6236559">int64</span><span class="op" id="6236564">)</span>&nbsp;<span class="op" id="6236566">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236569">v</span><span class="op" id="6236570">.</span><span class="ident" id="6236571">mu</span><span class="op" id="6236573">.</span><span class="ident" id="6236574">Lock</span><span class="op" id="6236578">(</span><span class="op" id="6236579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236582">defer</span>&nbsp;<span class="ident" id="6236588">v</span><span class="op" id="6236589">.</span><span class="ident" id="6236590">mu</span><span class="op" id="6236592">.</span><span class="ident" id="6236593">Unlock</span><span class="op" id="6236599">(</span><span class="op" id="6236600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236603">v</span><span class="op" id="6236604">.</span><span class="ident" id="6236605">i</span>&nbsp;<span class="op" id="6236607">+=</span>&nbsp;<span class="ident" id="6236610">delta</span><br>
<span class="lineno"></span><span class="op" id="6236616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="6236619">func</span>&nbsp;<span class="op" id="6236624">(</span><span class="ident" id="6236625">v</span>&nbsp;<span class="op" id="6236627">*</span><span class="ident" id="6236628">Int</span><span class="op" id="6236631">)</span>&nbsp;<span class="ident" id="6236633">Set</span><span class="op" id="6236636">(</span><span class="ident" id="6236637">value</span>&nbsp;<span class="ident" id="6236643">int64</span><span class="op" id="6236648">)</span>&nbsp;<span class="op" id="6236650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236653">v</span><span class="op" id="6236654">.</span><span class="ident" id="6236655">mu</span><span class="op" id="6236657">.</span><span class="ident" id="6236658">Lock</span><span class="op" id="6236662">(</span><span class="op" id="6236663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236666">defer</span>&nbsp;<span class="ident" id="6236672">v</span><span class="op" id="6236673">.</span><span class="ident" id="6236674">mu</span><span class="op" id="6236676">.</span><span class="ident" id="6236677">Unlock</span><span class="op" id="6236683">(</span><span class="op" id="6236684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236687">v</span><span class="op" id="6236688">.</span><span class="ident" id="6236689">i</span>&nbsp;<span class="op" id="6236691">=</span>&nbsp;<span class="ident" id="6236693">value</span><br>
<span class="lineno"></span><span class="op" id="6236699">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="6236702">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6236772">type</span>&nbsp;<span class="ident" id="6236777">Float</span>&nbsp;<span class="keyword" id="6236783">struct</span>&nbsp;<span class="op" id="6236790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236793">mu</span>&nbsp;<span class="ident" id="6236796">sync</span><span class="op" id="6236800">.</span><span class="ident" id="6236801">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236810">f</span>&nbsp;&nbsp;<span class="builtintype" id="6236813">float64</span><br>
<span class="lineno">70</span><span class="op" id="6236821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6236824">func</span>&nbsp;<span class="op" id="6236829">(</span><span class="ident" id="6236830">v</span>&nbsp;<span class="op" id="6236832">*</span><span class="ident" id="6236833">Float</span><span class="op" id="6236838">)</span>&nbsp;<span class="ident" id="6236840">String</span><span class="op" id="6236846">(</span><span class="op" id="6236847">)</span>&nbsp;<span class="builtintype" id="6236849">string</span>&nbsp;<span class="op" id="6236856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6236859">v</span><span class="op" id="6236860">.</span><span class="ident" id="6236861">mu</span><span class="op" id="6236863">.</span><span class="ident" id="6236864">RLock</span><span class="op" id="6236869">(</span><span class="op" id="6236870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236873">defer</span>&nbsp;<span class="ident" id="6236879">v</span><span class="op" id="6236880">.</span><span class="ident" id="6236881">mu</span><span class="op" id="6236883">.</span><span class="ident" id="6236884">RUnlock</span><span class="op" id="6236891">(</span><span class="op" id="6236892">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6236895">return</span>&nbsp;<span class="ident" id="6236902">strconv</span><span class="op" id="6236909">.</span><span class="ident" id="6236910">FormatFloat</span><span class="op" id="6236921">(</span><span class="ident" id="6236922">v</span><span class="op" id="6236923">.</span><span class="ident" id="6236924">f</span><span class="op" id="6236925">,</span>&nbsp;<span class="string" id="6236927">&#39;g&#39;</span><span class="op" id="6236930">,</span>&nbsp;<span class="op" id="6236932">-</span><span class="num" id="6236933">1</span><span class="op" id="6236934">,</span>&nbsp;<span class="num" id="6236936">64</span><span class="op" id="6236938">)</span><br>
<span class="lineno"></span><span class="op" id="6236940">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6236943">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="6236967">func</span>&nbsp;<span class="op" id="6236972">(</span><span class="ident" id="6236973">v</span>&nbsp;<span class="op" id="6236975">*</span><span class="ident" id="6236976">Float</span><span class="op" id="6236981">)</span>&nbsp;<span class="ident" id="6236983">Add</span><span class="op" id="6236986">(</span><span class="ident" id="6236987">delta</span>&nbsp;<span class="builtintype" id="6236993">float64</span><span class="op" id="6237000">)</span>&nbsp;<span class="op" id="6237002">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237005">v</span><span class="op" id="6237006">.</span><span class="ident" id="6237007">mu</span><span class="op" id="6237009">.</span><span class="ident" id="6237010">Lock</span><span class="op" id="6237014">(</span><span class="op" id="6237015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237018">defer</span>&nbsp;<span class="ident" id="6237024">v</span><span class="op" id="6237025">.</span><span class="ident" id="6237026">mu</span><span class="op" id="6237028">.</span><span class="ident" id="6237029">Unlock</span><span class="op" id="6237035">(</span><span class="op" id="6237036">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237039">v</span><span class="op" id="6237040">.</span><span class="ident" id="6237041">f</span>&nbsp;<span class="op" id="6237043">+=</span>&nbsp;<span class="ident" id="6237046">delta</span><br>
<span class="lineno"></span><span class="op" id="6237052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="6237055">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="6237079">func</span>&nbsp;<span class="op" id="6237084">(</span><span class="ident" id="6237085">v</span>&nbsp;<span class="op" id="6237087">*</span><span class="ident" id="6237088">Float</span><span class="op" id="6237093">)</span>&nbsp;<span class="ident" id="6237095">Set</span><span class="op" id="6237098">(</span><span class="ident" id="6237099">value</span>&nbsp;<span class="builtintype" id="6237105">float64</span><span class="op" id="6237112">)</span>&nbsp;<span class="op" id="6237114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237117">v</span><span class="op" id="6237118">.</span><span class="ident" id="6237119">mu</span><span class="op" id="6237121">.</span><span class="ident" id="6237122">Lock</span><span class="op" id="6237126">(</span><span class="op" id="6237127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237130">defer</span>&nbsp;<span class="ident" id="6237136">v</span><span class="op" id="6237137">.</span><span class="ident" id="6237138">mu</span><span class="op" id="6237140">.</span><span class="ident" id="6237141">Unlock</span><span class="op" id="6237147">(</span><span class="op" id="6237148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237151">v</span><span class="op" id="6237152">.</span><span class="ident" id="6237153">f</span>&nbsp;<span class="op" id="6237155">=</span>&nbsp;<span class="ident" id="6237157">value</span><br>
<span class="lineno">90</span><span class="op" id="6237163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6237166">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6237239">type</span>&nbsp;<span class="ident" id="6237244">Map</span>&nbsp;<span class="keyword" id="6237248">struct</span>&nbsp;<span class="op" id="6237255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237258">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6237263">sync</span><span class="op" id="6237267">.</span><span class="ident" id="6237268">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237277">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6237282">map</span><span class="op" id="6237285">[</span><span class="builtintype" id="6237286">string</span><span class="op" id="6237292">]</span><span class="ident" id="6237293">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237298">keys</span>&nbsp;<span class="op" id="6237303">[</span><span class="op" id="6237304">]</span><span class="builtintype" id="6237305">string</span>&nbsp;<span class="comment" id="6237312">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6237322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6237325">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="6237373">type</span>&nbsp;<span class="ident" id="6237378">KeyValue</span>&nbsp;<span class="keyword" id="6237387">struct</span>&nbsp;<span class="op" id="6237394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237397">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6237403">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237411">Value</span>&nbsp;<span class="ident" id="6237417">Var</span><br>
<span class="lineno"></span><span class="op" id="6237421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6237424">func</span>&nbsp;<span class="op" id="6237429">(</span><span class="ident" id="6237430">v</span>&nbsp;<span class="op" id="6237432">*</span><span class="ident" id="6237433">Map</span><span class="op" id="6237436">)</span>&nbsp;<span class="ident" id="6237438">String</span><span class="op" id="6237444">(</span><span class="op" id="6237445">)</span>&nbsp;<span class="builtintype" id="6237447">string</span>&nbsp;<span class="op" id="6237454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237457">v</span><span class="op" id="6237458">.</span><span class="ident" id="6237459">mu</span><span class="op" id="6237461">.</span><span class="ident" id="6237462">RLock</span><span class="op" id="6237467">(</span><span class="op" id="6237468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237471">defer</span>&nbsp;<span class="ident" id="6237477">v</span><span class="op" id="6237478">.</span><span class="ident" id="6237479">mu</span><span class="op" id="6237481">.</span><span class="ident" id="6237482">RUnlock</span><span class="op" id="6237489">(</span><span class="op" id="6237490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237493">var</span>&nbsp;<span class="ident" id="6237497">b</span>&nbsp;<span class="ident" id="6237499">bytes</span><span class="op" id="6237504">.</span><span class="ident" id="6237505">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237513">fmt</span><span class="op" id="6237516">.</span><span class="ident" id="6237517">Fprintf</span><span class="op" id="6237524">(</span><span class="op" id="6237525">&amp;</span><span class="ident" id="6237526">b</span><span class="op" id="6237527">,</span>&nbsp;<span class="string" id="6237529">&#34;{&#34;</span><span class="op" id="6237532">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237535">first</span>&nbsp;<span class="op" id="6237541">:=</span>&nbsp;<span class="builtintype" id="6237544">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237550">v</span><span class="op" id="6237551">.</span><span class="ident" id="6237552">doLocked</span><span class="op" id="6237560">(</span><span class="keyword" id="6237561">func</span><span class="op" id="6237565">(</span><span class="ident" id="6237566">kv</span>&nbsp;<span class="ident" id="6237569">KeyValue</span><span class="op" id="6237577">)</span>&nbsp;<span class="op" id="6237579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237583">if</span>&nbsp;<span class="op" id="6237586">!</span><span class="ident" id="6237587">first</span>&nbsp;<span class="op" id="6237593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237598">fmt</span><span class="op" id="6237601">.</span><span class="ident" id="6237602">Fprintf</span><span class="op" id="6237609">(</span><span class="op" id="6237610">&amp;</span><span class="ident" id="6237611">b</span><span class="op" id="6237612">,</span>&nbsp;<span class="string" id="6237614">&#34;,&nbsp;&#34;</span><span class="op" id="6237618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6237622">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237626">fmt</span><span class="op" id="6237629">.</span><span class="ident" id="6237630">Fprintf</span><span class="op" id="6237637">(</span><span class="op" id="6237638">&amp;</span><span class="ident" id="6237639">b</span><span class="op" id="6237640">,</span>&nbsp;<span class="string" id="6237642">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="6237650">,</span>&nbsp;<span class="ident" id="6237652">kv</span><span class="op" id="6237654">.</span><span class="ident" id="6237655">Key</span><span class="op" id="6237658">,</span>&nbsp;<span class="ident" id="6237660">kv</span><span class="op" id="6237662">.</span><span class="ident" id="6237663">Value</span><span class="op" id="6237668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237672">first</span>&nbsp;<span class="op" id="6237678">=</span>&nbsp;<span class="builtintype" id="6237680">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6237687">}</span><span class="op" id="6237688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237691">fmt</span><span class="op" id="6237694">.</span><span class="ident" id="6237695">Fprintf</span><span class="op" id="6237702">(</span><span class="op" id="6237703">&amp;</span><span class="ident" id="6237704">b</span><span class="op" id="6237705">,</span>&nbsp;<span class="string" id="6237707">&#34;}&#34;</span><span class="op" id="6237710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237713">return</span>&nbsp;<span class="ident" id="6237720">b</span><span class="op" id="6237721">.</span><span class="ident" id="6237722">String</span><span class="op" id="6237728">(</span><span class="op" id="6237729">)</span><br>
<span class="lineno">120</span><span class="op" id="6237731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6237734">func</span>&nbsp;<span class="op" id="6237739">(</span><span class="ident" id="6237740">v</span>&nbsp;<span class="op" id="6237742">*</span><span class="ident" id="6237743">Map</span><span class="op" id="6237746">)</span>&nbsp;<span class="ident" id="6237748">Init</span><span class="op" id="6237752">(</span><span class="op" id="6237753">)</span>&nbsp;<span class="op" id="6237755">*</span><span class="ident" id="6237756">Map</span>&nbsp;<span class="op" id="6237760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237763">v</span><span class="op" id="6237764">.</span><span class="ident" id="6237765">m</span>&nbsp;<span class="op" id="6237767">=</span>&nbsp;<span class="builtinfunc" id="6237769">make</span><span class="op" id="6237773">(</span><span class="keyword" id="6237774">map</span><span class="op" id="6237777">[</span><span class="builtintype" id="6237778">string</span><span class="op" id="6237784">]</span><span class="ident" id="6237785">Var</span><span class="op" id="6237788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237791">return</span>&nbsp;<span class="ident" id="6237798">v</span><br>
<span class="lineno">125</span><span class="op" id="6237800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6237803">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="6237860">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6237894">func</span>&nbsp;<span class="op" id="6237899">(</span><span class="ident" id="6237900">v</span>&nbsp;<span class="op" id="6237902">*</span><span class="ident" id="6237903">Map</span><span class="op" id="6237906">)</span>&nbsp;<span class="ident" id="6237908">updateKeys</span><span class="op" id="6237918">(</span><span class="op" id="6237919">)</span>&nbsp;<span class="op" id="6237921">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237924">if</span>&nbsp;<span class="builtinfunc" id="6237927">len</span><span class="op" id="6237930">(</span><span class="ident" id="6237931">v</span><span class="op" id="6237932">.</span><span class="ident" id="6237933">m</span><span class="op" id="6237934">)</span>&nbsp;<span class="op" id="6237936">==</span>&nbsp;<span class="builtinfunc" id="6237939">len</span><span class="op" id="6237942">(</span><span class="ident" id="6237943">v</span><span class="op" id="6237944">.</span><span class="ident" id="6237945">keys</span><span class="op" id="6237949">)</span>&nbsp;<span class="op" id="6237951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6237955">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6237972">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6237980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6237983">v</span><span class="op" id="6237984">.</span><span class="ident" id="6237985">keys</span>&nbsp;<span class="op" id="6237990">=</span>&nbsp;<span class="ident" id="6237992">v</span><span class="op" id="6237993">.</span><span class="ident" id="6237994">keys</span><span class="op" id="6237998">[</span><span class="op" id="6237999">:</span><span class="num" id="6238000">0</span><span class="op" id="6238001">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238004">for</span>&nbsp;<span class="ident" id="6238008">k</span>&nbsp;<span class="op" id="6238010">:=</span>&nbsp;<span class="keyword" id="6238013">range</span>&nbsp;<span class="ident" id="6238019">v</span><span class="op" id="6238020">.</span><span class="ident" id="6238021">m</span>&nbsp;<span class="op" id="6238023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238027">v</span><span class="op" id="6238028">.</span><span class="ident" id="6238029">keys</span>&nbsp;<span class="op" id="6238034">=</span>&nbsp;<span class="builtinfunc" id="6238036">append</span><span class="op" id="6238042">(</span><span class="ident" id="6238043">v</span><span class="op" id="6238044">.</span><span class="ident" id="6238045">keys</span><span class="op" id="6238049">,</span>&nbsp;<span class="ident" id="6238051">k</span><span class="op" id="6238052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238058">sort</span><span class="op" id="6238062">.</span><span class="ident" id="6238063">Strings</span><span class="op" id="6238070">(</span><span class="ident" id="6238071">v</span><span class="op" id="6238072">.</span><span class="ident" id="6238073">keys</span><span class="op" id="6238077">)</span><br>
<span class="lineno"></span><span class="op" id="6238079">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6238082">func</span>&nbsp;<span class="op" id="6238087">(</span><span class="ident" id="6238088">v</span>&nbsp;<span class="op" id="6238090">*</span><span class="ident" id="6238091">Map</span><span class="op" id="6238094">)</span>&nbsp;<span class="ident" id="6238096">Get</span><span class="op" id="6238099">(</span><span class="ident" id="6238100">key</span>&nbsp;<span class="builtintype" id="6238104">string</span><span class="op" id="6238110">)</span>&nbsp;<span class="ident" id="6238112">Var</span>&nbsp;<span class="op" id="6238116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238119">v</span><span class="op" id="6238120">.</span><span class="ident" id="6238121">mu</span><span class="op" id="6238123">.</span><span class="ident" id="6238124">RLock</span><span class="op" id="6238129">(</span><span class="op" id="6238130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238133">defer</span>&nbsp;<span class="ident" id="6238139">v</span><span class="op" id="6238140">.</span><span class="ident" id="6238141">mu</span><span class="op" id="6238143">.</span><span class="ident" id="6238144">RUnlock</span><span class="op" id="6238151">(</span><span class="op" id="6238152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238155">return</span>&nbsp;<span class="ident" id="6238162">v</span><span class="op" id="6238163">.</span><span class="ident" id="6238164">m</span><span class="op" id="6238165">[</span><span class="ident" id="6238166">key</span><span class="op" id="6238169">]</span><br>
<span class="lineno">145</span><span class="op" id="6238171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6238174">func</span>&nbsp;<span class="op" id="6238179">(</span><span class="ident" id="6238180">v</span>&nbsp;<span class="op" id="6238182">*</span><span class="ident" id="6238183">Map</span><span class="op" id="6238186">)</span>&nbsp;<span class="ident" id="6238188">Set</span><span class="op" id="6238191">(</span><span class="ident" id="6238192">key</span>&nbsp;<span class="builtintype" id="6238196">string</span><span class="op" id="6238202">,</span>&nbsp;<span class="ident" id="6238204">av</span>&nbsp;<span class="ident" id="6238207">Var</span><span class="op" id="6238210">)</span>&nbsp;<span class="op" id="6238212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238215">v</span><span class="op" id="6238216">.</span><span class="ident" id="6238217">mu</span><span class="op" id="6238219">.</span><span class="ident" id="6238220">Lock</span><span class="op" id="6238224">(</span><span class="op" id="6238225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238228">defer</span>&nbsp;<span class="ident" id="6238234">v</span><span class="op" id="6238235">.</span><span class="ident" id="6238236">mu</span><span class="op" id="6238238">.</span><span class="ident" id="6238239">Unlock</span><span class="op" id="6238245">(</span><span class="op" id="6238246">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238249">v</span><span class="op" id="6238250">.</span><span class="ident" id="6238251">m</span><span class="op" id="6238252">[</span><span class="ident" id="6238253">key</span><span class="op" id="6238256">]</span>&nbsp;<span class="op" id="6238258">=</span>&nbsp;<span class="ident" id="6238260">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238264">v</span><span class="op" id="6238265">.</span><span class="ident" id="6238266">updateKeys</span><span class="op" id="6238276">(</span><span class="op" id="6238277">)</span><br>
<span class="lineno"></span><span class="op" id="6238279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6238282">func</span>&nbsp;<span class="op" id="6238287">(</span><span class="ident" id="6238288">v</span>&nbsp;<span class="op" id="6238290">*</span><span class="ident" id="6238291">Map</span><span class="op" id="6238294">)</span>&nbsp;<span class="ident" id="6238296">Add</span><span class="op" id="6238299">(</span><span class="ident" id="6238300">key</span>&nbsp;<span class="builtintype" id="6238304">string</span><span class="op" id="6238310">,</span>&nbsp;<span class="ident" id="6238312">delta</span>&nbsp;<span class="ident" id="6238318">int64</span><span class="op" id="6238323">)</span>&nbsp;<span class="op" id="6238325">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238328">v</span><span class="op" id="6238329">.</span><span class="ident" id="6238330">mu</span><span class="op" id="6238332">.</span><span class="ident" id="6238333">RLock</span><span class="op" id="6238338">(</span><span class="op" id="6238339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238342">av</span><span class="op" id="6238344">,</span>&nbsp;<span class="ident" id="6238346">ok</span>&nbsp;<span class="op" id="6238349">:=</span>&nbsp;<span class="ident" id="6238352">v</span><span class="op" id="6238353">.</span><span class="ident" id="6238354">m</span><span class="op" id="6238355">[</span><span class="ident" id="6238356">key</span><span class="op" id="6238359">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238362">v</span><span class="op" id="6238363">.</span><span class="ident" id="6238364">mu</span><span class="op" id="6238366">.</span><span class="ident" id="6238367">RUnlock</span><span class="op" id="6238374">(</span><span class="op" id="6238375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238378">if</span>&nbsp;<span class="op" id="6238381">!</span><span class="ident" id="6238382">ok</span>&nbsp;<span class="op" id="6238385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6238389">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238427">v</span><span class="op" id="6238428">.</span><span class="ident" id="6238429">mu</span><span class="op" id="6238431">.</span><span class="ident" id="6238432">Lock</span><span class="op" id="6238436">(</span><span class="op" id="6238437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238441">av</span><span class="op" id="6238443">,</span>&nbsp;<span class="ident" id="6238445">ok</span>&nbsp;<span class="op" id="6238448">=</span>&nbsp;<span class="ident" id="6238450">v</span><span class="op" id="6238451">.</span><span class="ident" id="6238452">m</span><span class="op" id="6238453">[</span><span class="ident" id="6238454">key</span><span class="op" id="6238457">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238461">if</span>&nbsp;<span class="op" id="6238464">!</span><span class="ident" id="6238465">ok</span>&nbsp;<span class="op" id="6238468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238473">av</span>&nbsp;<span class="op" id="6238476">=</span>&nbsp;<span class="builtinfunc" id="6238478">new</span><span class="op" id="6238481">(</span><span class="ident" id="6238482">Int</span><span class="op" id="6238485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238490">v</span><span class="op" id="6238491">.</span><span class="ident" id="6238492">m</span><span class="op" id="6238493">[</span><span class="ident" id="6238494">key</span><span class="op" id="6238497">]</span>&nbsp;<span class="op" id="6238499">=</span>&nbsp;<span class="ident" id="6238501">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238507">v</span><span class="op" id="6238508">.</span><span class="ident" id="6238509">updateKeys</span><span class="op" id="6238519">(</span><span class="op" id="6238520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238528">v</span><span class="op" id="6238529">.</span><span class="ident" id="6238530">mu</span><span class="op" id="6238532">.</span><span class="ident" id="6238533">Unlock</span><span class="op" id="6238539">(</span><span class="op" id="6238540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6238547">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238581">if</span>&nbsp;<span class="ident" id="6238584">iv</span><span class="op" id="6238586">,</span>&nbsp;<span class="ident" id="6238588">ok</span>&nbsp;<span class="op" id="6238591">:=</span>&nbsp;<span class="ident" id="6238594">av</span><span class="op" id="6238596">.</span><span class="op" id="6238597">(</span><span class="op" id="6238598">*</span><span class="ident" id="6238599">Int</span><span class="op" id="6238602">)</span><span class="op" id="6238603">;</span>&nbsp;<span class="ident" id="6238605">ok</span>&nbsp;<span class="op" id="6238608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238612">iv</span><span class="op" id="6238614">.</span><span class="ident" id="6238615">Add</span><span class="op" id="6238618">(</span><span class="ident" id="6238619">delta</span><span class="op" id="6238624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238627">}</span><br>
<span class="lineno"></span><span class="op" id="6238629">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="6238632">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="6238707">func</span>&nbsp;<span class="op" id="6238712">(</span><span class="ident" id="6238713">v</span>&nbsp;<span class="op" id="6238715">*</span><span class="ident" id="6238716">Map</span><span class="op" id="6238719">)</span>&nbsp;<span class="ident" id="6238721">AddFloat</span><span class="op" id="6238729">(</span><span class="ident" id="6238730">key</span>&nbsp;<span class="builtintype" id="6238734">string</span><span class="op" id="6238740">,</span>&nbsp;<span class="ident" id="6238742">delta</span>&nbsp;<span class="builtintype" id="6238748">float64</span><span class="op" id="6238755">)</span>&nbsp;<span class="op" id="6238757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238760">v</span><span class="op" id="6238761">.</span><span class="ident" id="6238762">mu</span><span class="op" id="6238764">.</span><span class="ident" id="6238765">RLock</span><span class="op" id="6238770">(</span><span class="op" id="6238771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238774">av</span><span class="op" id="6238776">,</span>&nbsp;<span class="ident" id="6238778">ok</span>&nbsp;<span class="op" id="6238781">:=</span>&nbsp;<span class="ident" id="6238784">v</span><span class="op" id="6238785">.</span><span class="ident" id="6238786">m</span><span class="op" id="6238787">[</span><span class="ident" id="6238788">key</span><span class="op" id="6238791">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238794">v</span><span class="op" id="6238795">.</span><span class="ident" id="6238796">mu</span><span class="op" id="6238798">.</span><span class="ident" id="6238799">RUnlock</span><span class="op" id="6238806">(</span><span class="op" id="6238807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238810">if</span>&nbsp;<span class="op" id="6238813">!</span><span class="ident" id="6238814">ok</span>&nbsp;<span class="op" id="6238817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6238821">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238859">v</span><span class="op" id="6238860">.</span><span class="ident" id="6238861">mu</span><span class="op" id="6238863">.</span><span class="ident" id="6238864">Lock</span><span class="op" id="6238868">(</span><span class="op" id="6238869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238873">av</span><span class="op" id="6238875">,</span>&nbsp;<span class="ident" id="6238877">ok</span>&nbsp;<span class="op" id="6238880">=</span>&nbsp;<span class="ident" id="6238882">v</span><span class="op" id="6238883">.</span><span class="ident" id="6238884">m</span><span class="op" id="6238885">[</span><span class="ident" id="6238886">key</span><span class="op" id="6238889">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6238893">if</span>&nbsp;<span class="op" id="6238896">!</span><span class="ident" id="6238897">ok</span>&nbsp;<span class="op" id="6238900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238905">av</span>&nbsp;<span class="op" id="6238908">=</span>&nbsp;<span class="builtinfunc" id="6238910">new</span><span class="op" id="6238913">(</span><span class="ident" id="6238914">Float</span><span class="op" id="6238919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238924">v</span><span class="op" id="6238925">.</span><span class="ident" id="6238926">m</span><span class="op" id="6238927">[</span><span class="ident" id="6238928">key</span><span class="op" id="6238931">]</span>&nbsp;<span class="op" id="6238933">=</span>&nbsp;<span class="ident" id="6238935">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238941">v</span><span class="op" id="6238942">.</span><span class="ident" id="6238943">updateKeys</span><span class="op" id="6238953">(</span><span class="op" id="6238954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238958">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6238962">v</span><span class="op" id="6238963">.</span><span class="ident" id="6238964">mu</span><span class="op" id="6238966">.</span><span class="ident" id="6238967">Unlock</span><span class="op" id="6238973">(</span><span class="op" id="6238974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6238977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6238981">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239017">if</span>&nbsp;<span class="ident" id="6239020">iv</span><span class="op" id="6239022">,</span>&nbsp;<span class="ident" id="6239024">ok</span>&nbsp;<span class="op" id="6239027">:=</span>&nbsp;<span class="ident" id="6239030">av</span><span class="op" id="6239032">.</span><span class="op" id="6239033">(</span><span class="op" id="6239034">*</span><span class="ident" id="6239035">Float</span><span class="op" id="6239040">)</span><span class="op" id="6239041">;</span>&nbsp;<span class="ident" id="6239043">ok</span>&nbsp;<span class="op" id="6239046">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239050">iv</span><span class="op" id="6239052">.</span><span class="ident" id="6239053">Add</span><span class="op" id="6239056">(</span><span class="ident" id="6239057">delta</span><span class="op" id="6239062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6239065">}</span><br>
<span class="lineno"></span><span class="op" id="6239067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6239070">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="6239111">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6239154">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="6239207">func</span>&nbsp;<span class="op" id="6239212">(</span><span class="ident" id="6239213">v</span>&nbsp;<span class="op" id="6239215">*</span><span class="ident" id="6239216">Map</span><span class="op" id="6239219">)</span>&nbsp;<span class="ident" id="6239221">Do</span><span class="op" id="6239223">(</span><span class="ident" id="6239224">f</span>&nbsp;<span class="keyword" id="6239226">func</span><span class="op" id="6239230">(</span><span class="ident" id="6239231">KeyValue</span><span class="op" id="6239239">)</span><span class="op" id="6239240">)</span>&nbsp;<span class="op" id="6239242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239245">v</span><span class="op" id="6239246">.</span><span class="ident" id="6239247">mu</span><span class="op" id="6239249">.</span><span class="ident" id="6239250">RLock</span><span class="op" id="6239255">(</span><span class="op" id="6239256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239259">defer</span>&nbsp;<span class="ident" id="6239265">v</span><span class="op" id="6239266">.</span><span class="ident" id="6239267">mu</span><span class="op" id="6239269">.</span><span class="ident" id="6239270">RUnlock</span><span class="op" id="6239277">(</span><span class="op" id="6239278">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239281">v</span><span class="op" id="6239282">.</span><span class="ident" id="6239283">doLocked</span><span class="op" id="6239291">(</span><span class="ident" id="6239292">f</span><span class="op" id="6239293">)</span><br>
<span class="lineno"></span><span class="op" id="6239295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6239298">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="6239345">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="6239377">func</span>&nbsp;<span class="op" id="6239382">(</span><span class="ident" id="6239383">v</span>&nbsp;<span class="op" id="6239385">*</span><span class="ident" id="6239386">Map</span><span class="op" id="6239389">)</span>&nbsp;<span class="ident" id="6239391">doLocked</span><span class="op" id="6239399">(</span><span class="ident" id="6239400">f</span>&nbsp;<span class="keyword" id="6239402">func</span><span class="op" id="6239406">(</span><span class="ident" id="6239407">KeyValue</span><span class="op" id="6239415">)</span><span class="op" id="6239416">)</span>&nbsp;<span class="op" id="6239418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239421">for</span>&nbsp;<span class="ident" id="6239425">_</span><span class="op" id="6239426">,</span>&nbsp;<span class="ident" id="6239428">k</span>&nbsp;<span class="op" id="6239430">:=</span>&nbsp;<span class="keyword" id="6239433">range</span>&nbsp;<span class="ident" id="6239439">v</span><span class="op" id="6239440">.</span><span class="ident" id="6239441">keys</span>&nbsp;<span class="op" id="6239446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239450">f</span><span class="op" id="6239451">(</span><span class="ident" id="6239452">KeyValue</span><span class="op" id="6239460">{</span><span class="ident" id="6239461">k</span><span class="op" id="6239462">,</span>&nbsp;<span class="ident" id="6239464">v</span><span class="op" id="6239465">.</span><span class="ident" id="6239466">m</span><span class="op" id="6239467">[</span><span class="ident" id="6239468">k</span><span class="op" id="6239469">]</span><span class="op" id="6239470">}</span><span class="op" id="6239471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6239474">}</span><br>
<span class="lineno"></span><span class="op" id="6239476">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="6239479">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6239544">type</span>&nbsp;<span class="ident" id="6239549">String</span>&nbsp;<span class="keyword" id="6239556">struct</span>&nbsp;<span class="op" id="6239563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239566">mu</span>&nbsp;<span class="ident" id="6239569">sync</span><span class="op" id="6239573">.</span><span class="ident" id="6239574">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239583">s</span>&nbsp;&nbsp;<span class="builtintype" id="6239586">string</span><br>
<span class="lineno">220</span><span class="op" id="6239593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6239596">func</span>&nbsp;<span class="op" id="6239601">(</span><span class="ident" id="6239602">v</span>&nbsp;<span class="op" id="6239604">*</span><span class="ident" id="6239605">String</span><span class="op" id="6239611">)</span>&nbsp;<span class="ident" id="6239613">String</span><span class="op" id="6239619">(</span><span class="op" id="6239620">)</span>&nbsp;<span class="builtintype" id="6239622">string</span>&nbsp;<span class="op" id="6239629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239632">v</span><span class="op" id="6239633">.</span><span class="ident" id="6239634">mu</span><span class="op" id="6239636">.</span><span class="ident" id="6239637">RLock</span><span class="op" id="6239642">(</span><span class="op" id="6239643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239646">defer</span>&nbsp;<span class="ident" id="6239652">v</span><span class="op" id="6239653">.</span><span class="ident" id="6239654">mu</span><span class="op" id="6239656">.</span><span class="ident" id="6239657">RUnlock</span><span class="op" id="6239664">(</span><span class="op" id="6239665">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239668">return</span>&nbsp;<span class="ident" id="6239675">strconv</span><span class="op" id="6239682">.</span><span class="ident" id="6239683">Quote</span><span class="op" id="6239688">(</span><span class="ident" id="6239689">v</span><span class="op" id="6239690">.</span><span class="ident" id="6239691">s</span><span class="op" id="6239692">)</span><br>
<span class="lineno"></span><span class="op" id="6239694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6239697">func</span>&nbsp;<span class="op" id="6239702">(</span><span class="ident" id="6239703">v</span>&nbsp;<span class="op" id="6239705">*</span><span class="ident" id="6239706">String</span><span class="op" id="6239712">)</span>&nbsp;<span class="ident" id="6239714">Set</span><span class="op" id="6239717">(</span><span class="ident" id="6239718">value</span>&nbsp;<span class="builtintype" id="6239724">string</span><span class="op" id="6239730">)</span>&nbsp;<span class="op" id="6239732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239735">v</span><span class="op" id="6239736">.</span><span class="ident" id="6239737">mu</span><span class="op" id="6239739">.</span><span class="ident" id="6239740">Lock</span><span class="op" id="6239744">(</span><span class="op" id="6239745">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239748">defer</span>&nbsp;<span class="ident" id="6239754">v</span><span class="op" id="6239755">.</span><span class="ident" id="6239756">mu</span><span class="op" id="6239758">.</span><span class="ident" id="6239759">Unlock</span><span class="op" id="6239765">(</span><span class="op" id="6239766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239769">v</span><span class="op" id="6239770">.</span><span class="ident" id="6239771">s</span>&nbsp;<span class="op" id="6239773">=</span>&nbsp;<span class="ident" id="6239775">value</span><br>
<span class="lineno"></span><span class="op" id="6239781">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6239784">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="6239831">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="6239880">type</span>&nbsp;<span class="ident" id="6239885">Func</span>&nbsp;<span class="keyword" id="6239890">func</span><span class="op" id="6239894">(</span><span class="op" id="6239895">)</span>&nbsp;<span class="keyword" id="6239897">interface</span><span class="op" id="6239906">{</span><span class="op" id="6239907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6239910">func</span>&nbsp;<span class="op" id="6239915">(</span><span class="ident" id="6239916">f</span>&nbsp;<span class="ident" id="6239918">Func</span><span class="op" id="6239922">)</span>&nbsp;<span class="ident" id="6239924">String</span><span class="op" id="6239930">(</span><span class="op" id="6239931">)</span>&nbsp;<span class="builtintype" id="6239933">string</span>&nbsp;<span class="op" id="6239940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6239943">v</span><span class="op" id="6239944">,</span>&nbsp;<span class="ident" id="6239946">_</span>&nbsp;<span class="op" id="6239948">:=</span>&nbsp;<span class="ident" id="6239951">json</span><span class="op" id="6239955">.</span><span class="ident" id="6239956">Marshal</span><span class="op" id="6239963">(</span><span class="ident" id="6239964">f</span><span class="op" id="6239965">(</span><span class="op" id="6239966">)</span><span class="op" id="6239967">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6239970">return</span>&nbsp;<span class="builtintype" id="6239977">string</span><span class="op" id="6239983">(</span><span class="ident" id="6239984">v</span><span class="op" id="6239985">)</span><br>
<span class="lineno"></span><span class="op" id="6239987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6239990">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6240018">var</span>&nbsp;<span class="op" id="6240022">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240025">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6240033">sync</span><span class="op" id="6240037">.</span><span class="ident" id="6240038">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240047">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6240055">=</span>&nbsp;<span class="builtinfunc" id="6240057">make</span><span class="op" id="6240061">(</span><span class="keyword" id="6240062">map</span><span class="op" id="6240065">[</span><span class="builtintype" id="6240066">string</span><span class="op" id="6240072">]</span><span class="ident" id="6240073">Var</span><span class="op" id="6240076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240079">varKeys</span>&nbsp;<span class="op" id="6240087">[</span><span class="op" id="6240088">]</span><span class="builtintype" id="6240089">string</span>&nbsp;<span class="comment" id="6240096">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6240106">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="6240109">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6240185">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="6240261">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="6240301">func</span>&nbsp;<span class="ident" id="6240306">Publish</span><span class="op" id="6240313">(</span><span class="ident" id="6240314">name</span>&nbsp;<span class="builtintype" id="6240319">string</span><span class="op" id="6240325">,</span>&nbsp;<span class="ident" id="6240327">v</span>&nbsp;<span class="ident" id="6240329">Var</span><span class="op" id="6240332">)</span>&nbsp;<span class="op" id="6240334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240337">mutex</span><span class="op" id="6240342">.</span><span class="ident" id="6240343">Lock</span><span class="op" id="6240347">(</span><span class="op" id="6240348">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240351">defer</span>&nbsp;<span class="ident" id="6240357">mutex</span><span class="op" id="6240362">.</span><span class="ident" id="6240363">Unlock</span><span class="op" id="6240369">(</span><span class="op" id="6240370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240373">if</span>&nbsp;<span class="ident" id="6240376">_</span><span class="op" id="6240377">,</span>&nbsp;<span class="ident" id="6240379">existing</span>&nbsp;<span class="op" id="6240388">:=</span>&nbsp;<span class="ident" id="6240391">vars</span><span class="op" id="6240395">[</span><span class="ident" id="6240396">name</span><span class="op" id="6240400">]</span><span class="op" id="6240401">;</span>&nbsp;<span class="ident" id="6240403">existing</span>&nbsp;<span class="op" id="6240412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240416">log</span><span class="op" id="6240419">.</span><span class="ident" id="6240420">Panicln</span><span class="op" id="6240427">(</span><span class="string" id="6240428">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="6240457">,</span>&nbsp;<span class="ident" id="6240459">name</span><span class="op" id="6240463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6240466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240469">vars</span><span class="op" id="6240473">[</span><span class="ident" id="6240474">name</span><span class="op" id="6240478">]</span>&nbsp;<span class="op" id="6240480">=</span>&nbsp;<span class="ident" id="6240482">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240485">varKeys</span>&nbsp;<span class="op" id="6240493">=</span>&nbsp;<span class="builtinfunc" id="6240495">append</span><span class="op" id="6240501">(</span><span class="ident" id="6240502">varKeys</span><span class="op" id="6240509">,</span>&nbsp;<span class="ident" id="6240511">name</span><span class="op" id="6240515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240518">sort</span><span class="op" id="6240522">.</span><span class="ident" id="6240523">Strings</span><span class="op" id="6240530">(</span><span class="ident" id="6240531">varKeys</span><span class="op" id="6240538">)</span><br>
<span class="lineno"></span><span class="op" id="6240540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6240543">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="6240587">func</span>&nbsp;<span class="ident" id="6240592">Get</span><span class="op" id="6240595">(</span><span class="ident" id="6240596">name</span>&nbsp;<span class="builtintype" id="6240601">string</span><span class="op" id="6240607">)</span>&nbsp;<span class="ident" id="6240609">Var</span>&nbsp;<span class="op" id="6240613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240616">mutex</span><span class="op" id="6240621">.</span><span class="ident" id="6240622">RLock</span><span class="op" id="6240627">(</span><span class="op" id="6240628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240631">defer</span>&nbsp;<span class="ident" id="6240637">mutex</span><span class="op" id="6240642">.</span><span class="ident" id="6240643">RUnlock</span><span class="op" id="6240650">(</span><span class="op" id="6240651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240654">return</span>&nbsp;<span class="ident" id="6240661">vars</span><span class="op" id="6240665">[</span><span class="ident" id="6240666">name</span><span class="op" id="6240670">]</span><br>
<span class="lineno"></span><span class="op" id="6240672">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="6240675">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6240738">func</span>&nbsp;<span class="ident" id="6240743">NewInt</span><span class="op" id="6240749">(</span><span class="ident" id="6240750">name</span>&nbsp;<span class="builtintype" id="6240755">string</span><span class="op" id="6240761">)</span>&nbsp;<span class="op" id="6240763">*</span><span class="ident" id="6240764">Int</span>&nbsp;<span class="op" id="6240768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240771">v</span>&nbsp;<span class="op" id="6240773">:=</span>&nbsp;<span class="builtinfunc" id="6240776">new</span><span class="op" id="6240779">(</span><span class="ident" id="6240780">Int</span><span class="op" id="6240783">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240786">Publish</span><span class="op" id="6240793">(</span><span class="ident" id="6240794">name</span><span class="op" id="6240798">,</span>&nbsp;<span class="ident" id="6240800">v</span><span class="op" id="6240801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240804">return</span>&nbsp;<span class="ident" id="6240811">v</span><br>
<span class="lineno"></span><span class="op" id="6240813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6240816">func</span>&nbsp;<span class="ident" id="6240821">NewFloat</span><span class="op" id="6240829">(</span><span class="ident" id="6240830">name</span>&nbsp;<span class="builtintype" id="6240835">string</span><span class="op" id="6240841">)</span>&nbsp;<span class="op" id="6240843">*</span><span class="ident" id="6240844">Float</span>&nbsp;<span class="op" id="6240850">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240853">v</span>&nbsp;<span class="op" id="6240855">:=</span>&nbsp;<span class="builtinfunc" id="6240858">new</span><span class="op" id="6240861">(</span><span class="ident" id="6240862">Float</span><span class="op" id="6240867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240870">Publish</span><span class="op" id="6240877">(</span><span class="ident" id="6240878">name</span><span class="op" id="6240882">,</span>&nbsp;<span class="ident" id="6240884">v</span><span class="op" id="6240885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240888">return</span>&nbsp;<span class="ident" id="6240895">v</span><br>
<span class="lineno"></span><span class="op" id="6240897">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6240900">func</span>&nbsp;<span class="ident" id="6240905">NewMap</span><span class="op" id="6240911">(</span><span class="ident" id="6240912">name</span>&nbsp;<span class="builtintype" id="6240917">string</span><span class="op" id="6240923">)</span>&nbsp;<span class="op" id="6240925">*</span><span class="ident" id="6240926">Map</span>&nbsp;<span class="op" id="6240930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240933">v</span>&nbsp;<span class="op" id="6240935">:=</span>&nbsp;<span class="builtinfunc" id="6240938">new</span><span class="op" id="6240941">(</span><span class="ident" id="6240942">Map</span><span class="op" id="6240945">)</span><span class="op" id="6240946">.</span><span class="ident" id="6240947">Init</span><span class="op" id="6240951">(</span><span class="op" id="6240952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6240955">Publish</span><span class="op" id="6240962">(</span><span class="ident" id="6240963">name</span><span class="op" id="6240967">,</span>&nbsp;<span class="ident" id="6240969">v</span><span class="op" id="6240970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6240973">return</span>&nbsp;<span class="ident" id="6240980">v</span><br>
<span class="lineno"></span><span class="op" id="6240982">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="6240985">func</span>&nbsp;<span class="ident" id="6240990">NewString</span><span class="op" id="6240999">(</span><span class="ident" id="6241000">name</span>&nbsp;<span class="builtintype" id="6241005">string</span><span class="op" id="6241011">)</span>&nbsp;<span class="op" id="6241013">*</span><span class="ident" id="6241014">String</span>&nbsp;<span class="op" id="6241021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241024">v</span>&nbsp;<span class="op" id="6241026">:=</span>&nbsp;<span class="builtinfunc" id="6241029">new</span><span class="op" id="6241032">(</span><span class="ident" id="6241033">String</span><span class="op" id="6241039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241042">Publish</span><span class="op" id="6241049">(</span><span class="ident" id="6241050">name</span><span class="op" id="6241054">,</span>&nbsp;<span class="ident" id="6241056">v</span><span class="op" id="6241057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241060">return</span>&nbsp;<span class="ident" id="6241067">v</span><br>
<span class="lineno">295</span><span class="op" id="6241069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6241072">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="6241114">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6241173">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="6241226">func</span>&nbsp;<span class="ident" id="6241231">Do</span><span class="op" id="6241233">(</span><span class="ident" id="6241234">f</span>&nbsp;<span class="keyword" id="6241236">func</span><span class="op" id="6241240">(</span><span class="ident" id="6241241">KeyValue</span><span class="op" id="6241249">)</span><span class="op" id="6241250">)</span>&nbsp;<span class="op" id="6241252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241255">mutex</span><span class="op" id="6241260">.</span><span class="ident" id="6241261">RLock</span><span class="op" id="6241266">(</span><span class="op" id="6241267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241270">defer</span>&nbsp;<span class="ident" id="6241276">mutex</span><span class="op" id="6241281">.</span><span class="ident" id="6241282">RUnlock</span><span class="op" id="6241289">(</span><span class="op" id="6241290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241293">for</span>&nbsp;<span class="ident" id="6241297">_</span><span class="op" id="6241298">,</span>&nbsp;<span class="ident" id="6241300">k</span>&nbsp;<span class="op" id="6241302">:=</span>&nbsp;<span class="keyword" id="6241305">range</span>&nbsp;<span class="ident" id="6241311">varKeys</span>&nbsp;<span class="op" id="6241319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241323">f</span><span class="op" id="6241324">(</span><span class="ident" id="6241325">KeyValue</span><span class="op" id="6241333">{</span><span class="ident" id="6241334">k</span><span class="op" id="6241335">,</span>&nbsp;<span class="ident" id="6241337">vars</span><span class="op" id="6241341">[</span><span class="ident" id="6241342">k</span><span class="op" id="6241343">]</span><span class="op" id="6241344">}</span><span class="op" id="6241345">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6241348">}</span><br>
<span class="lineno"></span><span class="op" id="6241350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6241353">func</span>&nbsp;<span class="ident" id="6241358">expvarHandler</span><span class="op" id="6241371">(</span><span class="ident" id="6241372">w</span>&nbsp;<span class="ident" id="6241374">http</span><span class="op" id="6241378">.</span><span class="ident" id="6241379">ResponseWriter</span><span class="op" id="6241393">,</span>&nbsp;<span class="ident" id="6241395">r</span>&nbsp;<span class="op" id="6241397">*</span><span class="ident" id="6241398">http</span><span class="op" id="6241402">.</span><span class="ident" id="6241403">Request</span><span class="op" id="6241410">)</span>&nbsp;<span class="op" id="6241412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241415">w</span><span class="op" id="6241416">.</span><span class="ident" id="6241417">Header</span><span class="op" id="6241423">(</span><span class="op" id="6241424">)</span><span class="op" id="6241425">.</span><span class="ident" id="6241426">Set</span><span class="op" id="6241429">(</span><span class="string" id="6241430">&#34;Content-Type&#34;</span><span class="op" id="6241444">,</span>&nbsp;<span class="string" id="6241446">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="6241479">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241482">fmt</span><span class="op" id="6241485">.</span><span class="ident" id="6241486">Fprintf</span><span class="op" id="6241493">(</span><span class="ident" id="6241494">w</span><span class="op" id="6241495">,</span>&nbsp;<span class="string" id="6241497">&#34;{\n&#34;</span><span class="op" id="6241502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241505">first</span>&nbsp;<span class="op" id="6241511">:=</span>&nbsp;<span class="builtintype" id="6241514">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241520">Do</span><span class="op" id="6241522">(</span><span class="keyword" id="6241523">func</span><span class="op" id="6241527">(</span><span class="ident" id="6241528">kv</span>&nbsp;<span class="ident" id="6241531">KeyValue</span><span class="op" id="6241539">)</span>&nbsp;<span class="op" id="6241541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241545">if</span>&nbsp;<span class="op" id="6241548">!</span><span class="ident" id="6241549">first</span>&nbsp;<span class="op" id="6241555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241560">fmt</span><span class="op" id="6241563">.</span><span class="ident" id="6241564">Fprintf</span><span class="op" id="6241571">(</span><span class="ident" id="6241572">w</span><span class="op" id="6241573">,</span>&nbsp;<span class="string" id="6241575">&#34;,\n&#34;</span><span class="op" id="6241580">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6241584">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241588">first</span>&nbsp;<span class="op" id="6241594">=</span>&nbsp;<span class="builtintype" id="6241596">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241604">fmt</span><span class="op" id="6241607">.</span><span class="ident" id="6241608">Fprintf</span><span class="op" id="6241615">(</span><span class="ident" id="6241616">w</span><span class="op" id="6241617">,</span>&nbsp;<span class="string" id="6241619">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="6241627">,</span>&nbsp;<span class="ident" id="6241629">kv</span><span class="op" id="6241631">.</span><span class="ident" id="6241632">Key</span><span class="op" id="6241635">,</span>&nbsp;<span class="ident" id="6241637">kv</span><span class="op" id="6241639">.</span><span class="ident" id="6241640">Value</span><span class="op" id="6241645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6241648">}</span><span class="op" id="6241649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241652">fmt</span><span class="op" id="6241655">.</span><span class="ident" id="6241656">Fprintf</span><span class="op" id="6241663">(</span><span class="ident" id="6241664">w</span><span class="op" id="6241665">,</span>&nbsp;<span class="string" id="6241667">&#34;\n}\n&#34;</span><span class="op" id="6241674">)</span><br>
<span class="lineno">320</span><span class="op" id="6241676">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6241679">func</span>&nbsp;<span class="ident" id="6241684">cmdline</span><span class="op" id="6241691">(</span><span class="op" id="6241692">)</span>&nbsp;<span class="keyword" id="6241694">interface</span><span class="op" id="6241703">{</span><span class="op" id="6241704">}</span>&nbsp;<span class="op" id="6241706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241709">return</span>&nbsp;<span class="ident" id="6241716">os</span><span class="op" id="6241718">.</span><span class="ident" id="6241719">Args</span><br>
<span class="lineno"></span><span class="op" id="6241724">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6241727">func</span>&nbsp;<span class="ident" id="6241732">memstats</span><span class="op" id="6241740">(</span><span class="op" id="6241741">)</span>&nbsp;<span class="keyword" id="6241743">interface</span><span class="op" id="6241752">{</span><span class="op" id="6241753">}</span>&nbsp;<span class="op" id="6241755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241758">stats</span>&nbsp;<span class="op" id="6241764">:=</span>&nbsp;<span class="builtinfunc" id="6241767">new</span><span class="op" id="6241770">(</span><span class="ident" id="6241771">runtime</span><span class="op" id="6241778">.</span><span class="ident" id="6241779">MemStats</span><span class="op" id="6241787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241790">runtime</span><span class="op" id="6241797">.</span><span class="ident" id="6241798">ReadMemStats</span><span class="op" id="6241810">(</span><span class="ident" id="6241811">stats</span><span class="op" id="6241816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6241819">return</span>&nbsp;<span class="op" id="6241826">*</span><span class="ident" id="6241827">stats</span><br>
<span class="lineno">330</span><span class="op" id="6241833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6241836">func</span>&nbsp;<span class="ident" id="6241841">init</span><span class="op" id="6241845">(</span><span class="op" id="6241846">)</span>&nbsp;<span class="op" id="6241848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241851">http</span><span class="op" id="6241855">.</span><span class="ident" id="6241856">HandleFunc</span><span class="op" id="6241866">(</span><span class="string" id="6241867">&#34;/debug/vars&#34;</span><span class="op" id="6241880">,</span>&nbsp;<span class="ident" id="6241882">expvarHandler</span><span class="op" id="6241895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241898">Publish</span><span class="op" id="6241905">(</span><span class="string" id="6241906">&#34;cmdline&#34;</span><span class="op" id="6241915">,</span>&nbsp;<span class="ident" id="6241917">Func</span><span class="op" id="6241921">(</span><span class="ident" id="6241922">cmdline</span><span class="op" id="6241929">)</span><span class="op" id="6241930">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6241933">Publish</span><span class="op" id="6241940">(</span><span class="string" id="6241941">&#34;memstats&#34;</span><span class="op" id="6241951">,</span>&nbsp;<span class="ident" id="6241953">Func</span><span class="op" id="6241957">(</span><span class="ident" id="6241958">memstats</span><span class="op" id="6241966">)</span><span class="op" id="6241967">)</span><br>
<span class="lineno"></span><span class="op" id="6241969">}</span>
</div>
</body>
</html>
