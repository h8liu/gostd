<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1617236">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1617291">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1617345">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1617396">package</span>&nbsp;<span class="ident" id="1617404">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1617410">import</span>&nbsp;<span class="op" id="1617417">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1617420">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1617431">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1617446">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1617455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1617458">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1617533">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1617547">//</span><br>
<span class="lineno"></span><span class="comment" id="1617550">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1617630">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1617707">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1617737">//</span><br>
<span class="lineno">20</span><span class="comment" id="1617740">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1617805">//</span><br>
<span class="lineno"></span><span class="comment" id="1617808">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1617882">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1617959">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1618039">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1618054">//</span><br>
<span class="lineno"></span><span class="comment" id="1618057">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1618129">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1618203">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1618280">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1618304">//</span><br>
<span class="lineno"></span><span class="comment" id="1618307">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1618384">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1618463">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1618533">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1618547">//</span><br>
<span class="lineno"></span><span class="comment" id="1618550">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1618630">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1618709">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1618789">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1618803">//</span><br>
<span class="lineno"></span><span class="keyword" id="1618806">type</span>&nbsp;<span class="ident" id="1618811">Pool</span>&nbsp;<span class="keyword" id="1618816">struct</span>&nbsp;<span class="op" id="1618823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618826">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1618836">unsafe</span><span class="op" id="1618842">.</span><span class="ident" id="1618843">Pointer</span>&nbsp;<span class="comment" id="1618851">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1618912">localSize</span>&nbsp;<span class="builtintype" id="1618922">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1618937">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1618966">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619018">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619067">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619125">New</span>&nbsp;<span class="keyword" id="1619129">func</span><span class="op" id="1619133">(</span><span class="op" id="1619134">)</span>&nbsp;<span class="keyword" id="1619136">interface</span><span class="op" id="1619145">{</span><span class="op" id="1619146">}</span><br>
<span class="lineno">50</span><span class="op" id="1619148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1619151">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1619181">type</span>&nbsp;<span class="ident" id="1619186">poolLocal</span>&nbsp;<span class="keyword" id="1619196">struct</span>&nbsp;<span class="op" id="1619203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619206">private</span>&nbsp;<span class="keyword" id="1619214">interface</span><span class="op" id="1619223">{</span><span class="op" id="1619224">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1619228">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619270">shared</span>&nbsp;&nbsp;<span class="op" id="1619278">[</span><span class="op" id="1619279">]</span><span class="keyword" id="1619280">interface</span><span class="op" id="1619289">{</span><span class="op" id="1619290">}</span>&nbsp;<span class="comment" id="1619292">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619318">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619340">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619361">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1619369">[</span><span class="num" id="1619370">128</span><span class="op" id="1619373">]</span><span class="builtintype" id="1619374">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1619383">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1619410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1619413">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1619440">func</span>&nbsp;<span class="op" id="1619445">(</span><span class="ident" id="1619446">p</span>&nbsp;<span class="op" id="1619448">*</span><span class="ident" id="1619449">Pool</span><span class="op" id="1619453">)</span>&nbsp;<span class="ident" id="1619455">Put</span><span class="op" id="1619458">(</span><span class="ident" id="1619459">x</span>&nbsp;<span class="keyword" id="1619461">interface</span><span class="op" id="1619470">{</span><span class="op" id="1619471">}</span><span class="op" id="1619472">)</span>&nbsp;<span class="op" id="1619474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619477">if</span>&nbsp;<span class="ident" id="1619480">raceenabled</span>&nbsp;<span class="op" id="1619492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619496">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619554">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1619616">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619672">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619683">if</span>&nbsp;<span class="ident" id="1619686">x</span>&nbsp;<span class="op" id="1619688">==</span>&nbsp;<span class="ident" id="1619691">nil</span>&nbsp;<span class="op" id="1619695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619699">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619710">l</span>&nbsp;<span class="op" id="1619712">:=</span>&nbsp;<span class="ident" id="1619715">p</span><span class="op" id="1619716">.</span><span class="ident" id="1619717">pin</span><span class="op" id="1619720">(</span><span class="op" id="1619721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619724">if</span>&nbsp;<span class="ident" id="1619727">l</span><span class="op" id="1619728">.</span><span class="ident" id="1619729">private</span>&nbsp;<span class="op" id="1619737">==</span>&nbsp;<span class="ident" id="1619740">nil</span>&nbsp;<span class="op" id="1619744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619748">l</span><span class="op" id="1619749">.</span><span class="ident" id="1619750">private</span>&nbsp;<span class="op" id="1619758">=</span>&nbsp;<span class="ident" id="1619760">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619764">x</span>&nbsp;<span class="op" id="1619766">=</span>&nbsp;<span class="ident" id="1619768">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619776">runtime_procUnpin</span><span class="op" id="1619793">(</span><span class="op" id="1619794">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619797">if</span>&nbsp;<span class="ident" id="1619800">x</span>&nbsp;<span class="op" id="1619802">==</span>&nbsp;<span class="ident" id="1619805">nil</span>&nbsp;<span class="op" id="1619809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1619813">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1619821">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619824">l</span><span class="op" id="1619825">.</span><span class="ident" id="1619826">Lock</span><span class="op" id="1619830">(</span><span class="op" id="1619831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619834">l</span><span class="op" id="1619835">.</span><span class="ident" id="1619836">shared</span>&nbsp;<span class="op" id="1619843">=</span>&nbsp;<span class="builtinfunc" id="1619845">append</span><span class="op" id="1619851">(</span><span class="ident" id="1619852">l</span><span class="op" id="1619853">.</span><span class="ident" id="1619854">shared</span><span class="op" id="1619860">,</span>&nbsp;<span class="ident" id="1619862">x</span><span class="op" id="1619863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1619866">l</span><span class="op" id="1619867">.</span><span class="ident" id="1619868">Unlock</span><span class="op" id="1619874">(</span><span class="op" id="1619875">)</span><br>
<span class="lineno"></span><span class="op" id="1619877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1619880">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1619948">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1619987">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1620047">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1620122">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1620153">//</span><br>
<span class="lineno"></span><span class="comment" id="1620156">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1620227">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1620259">func</span>&nbsp;<span class="op" id="1620264">(</span><span class="ident" id="1620265">p</span>&nbsp;<span class="op" id="1620267">*</span><span class="ident" id="1620268">Pool</span><span class="op" id="1620272">)</span>&nbsp;<span class="ident" id="1620274">Get</span><span class="op" id="1620277">(</span><span class="op" id="1620278">)</span>&nbsp;<span class="keyword" id="1620280">interface</span><span class="op" id="1620289">{</span><span class="op" id="1620290">}</span>&nbsp;<span class="op" id="1620292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620295">if</span>&nbsp;<span class="ident" id="1620298">raceenabled</span>&nbsp;<span class="op" id="1620310">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620314">if</span>&nbsp;<span class="ident" id="1620317">p</span><span class="op" id="1620318">.</span><span class="ident" id="1620319">New</span>&nbsp;<span class="op" id="1620323">!=</span>&nbsp;<span class="ident" id="1620326">nil</span>&nbsp;<span class="op" id="1620330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620335">return</span>&nbsp;<span class="ident" id="1620342">p</span><span class="op" id="1620343">.</span><span class="ident" id="1620344">New</span><span class="op" id="1620347">(</span><span class="op" id="1620348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620356">return</span>&nbsp;<span class="ident" id="1620363">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620368">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620371">l</span>&nbsp;<span class="op" id="1620373">:=</span>&nbsp;<span class="ident" id="1620376">p</span><span class="op" id="1620377">.</span><span class="ident" id="1620378">pin</span><span class="op" id="1620381">(</span><span class="op" id="1620382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620385">x</span>&nbsp;<span class="op" id="1620387">:=</span>&nbsp;<span class="ident" id="1620390">l</span><span class="op" id="1620391">.</span><span class="ident" id="1620392">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620401">l</span><span class="op" id="1620402">.</span><span class="ident" id="1620403">private</span>&nbsp;<span class="op" id="1620411">=</span>&nbsp;<span class="ident" id="1620413">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620418">runtime_procUnpin</span><span class="op" id="1620435">(</span><span class="op" id="1620436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620439">if</span>&nbsp;<span class="ident" id="1620442">x</span>&nbsp;<span class="op" id="1620444">!=</span>&nbsp;<span class="ident" id="1620447">nil</span>&nbsp;<span class="op" id="1620451">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620455">return</span>&nbsp;<span class="ident" id="1620462">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620468">l</span><span class="op" id="1620469">.</span><span class="ident" id="1620470">Lock</span><span class="op" id="1620474">(</span><span class="op" id="1620475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620478">last</span>&nbsp;<span class="op" id="1620483">:=</span>&nbsp;<span class="builtinfunc" id="1620486">len</span><span class="op" id="1620489">(</span><span class="ident" id="1620490">l</span><span class="op" id="1620491">.</span><span class="ident" id="1620492">shared</span><span class="op" id="1620498">)</span>&nbsp;<span class="op" id="1620500">-</span>&nbsp;<span class="num" id="1620502">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620505">if</span>&nbsp;<span class="ident" id="1620508">last</span>&nbsp;<span class="op" id="1620513">&gt;=</span>&nbsp;<span class="num" id="1620516">0</span>&nbsp;<span class="op" id="1620518">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620522">x</span>&nbsp;<span class="op" id="1620524">=</span>&nbsp;<span class="ident" id="1620526">l</span><span class="op" id="1620527">.</span><span class="ident" id="1620528">shared</span><span class="op" id="1620534">[</span><span class="ident" id="1620535">last</span><span class="op" id="1620539">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620543">l</span><span class="op" id="1620544">.</span><span class="ident" id="1620545">shared</span>&nbsp;<span class="op" id="1620552">=</span>&nbsp;<span class="ident" id="1620554">l</span><span class="op" id="1620555">.</span><span class="ident" id="1620556">shared</span><span class="op" id="1620562">[</span><span class="op" id="1620563">:</span><span class="ident" id="1620564">last</span><span class="op" id="1620568">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620574">l</span><span class="op" id="1620575">.</span><span class="ident" id="1620576">Unlock</span><span class="op" id="1620582">(</span><span class="op" id="1620583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620586">if</span>&nbsp;<span class="ident" id="1620589">x</span>&nbsp;<span class="op" id="1620591">!=</span>&nbsp;<span class="ident" id="1620594">nil</span>&nbsp;<span class="op" id="1620598">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620602">return</span>&nbsp;<span class="ident" id="1620609">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1620612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620615">return</span>&nbsp;<span class="ident" id="1620622">p</span><span class="op" id="1620623">.</span><span class="ident" id="1620624">getSlow</span><span class="op" id="1620631">(</span><span class="op" id="1620632">)</span><br>
<span class="lineno"></span><span class="op" id="1620634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1620637">func</span>&nbsp;<span class="op" id="1620642">(</span><span class="ident" id="1620643">p</span>&nbsp;<span class="op" id="1620645">*</span><span class="ident" id="1620646">Pool</span><span class="op" id="1620650">)</span>&nbsp;<span class="ident" id="1620652">getSlow</span><span class="op" id="1620659">(</span><span class="op" id="1620660">)</span>&nbsp;<span class="op" id="1620662">(</span><span class="ident" id="1620663">x</span>&nbsp;<span class="keyword" id="1620665">interface</span><span class="op" id="1620674">{</span><span class="op" id="1620675">}</span><span class="op" id="1620676">)</span>&nbsp;<span class="op" id="1620678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620681">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620741">size</span>&nbsp;<span class="op" id="1620746">:=</span>&nbsp;<span class="ident" id="1620749">atomic</span><span class="op" id="1620755">.</span><span class="ident" id="1620756">LoadUintptr</span><span class="op" id="1620767">(</span><span class="op" id="1620768">&amp;</span><span class="ident" id="1620769">p</span><span class="op" id="1620770">.</span><span class="ident" id="1620771">localSize</span><span class="op" id="1620780">)</span>&nbsp;<span class="comment" id="1620782">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620799">local</span>&nbsp;<span class="op" id="1620805">:=</span>&nbsp;<span class="ident" id="1620808">p</span><span class="op" id="1620809">.</span><span class="ident" id="1620810">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1620840">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1620857">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620904">pid</span>&nbsp;<span class="op" id="1620908">:=</span>&nbsp;<span class="ident" id="1620911">runtime_procPin</span><span class="op" id="1620926">(</span><span class="op" id="1620927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620930">runtime_procUnpin</span><span class="op" id="1620947">(</span><span class="op" id="1620948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1620951">for</span>&nbsp;<span class="ident" id="1620955">i</span>&nbsp;<span class="op" id="1620957">:=</span>&nbsp;<span class="num" id="1620960">0</span><span class="op" id="1620961">;</span>&nbsp;<span class="ident" id="1620963">i</span>&nbsp;<span class="op" id="1620965">&lt;</span>&nbsp;<span class="builtintype" id="1620967">int</span><span class="op" id="1620970">(</span><span class="ident" id="1620971">size</span><span class="op" id="1620975">)</span><span class="op" id="1620976">;</span>&nbsp;<span class="ident" id="1620978">i</span><span class="op" id="1620979">++</span>&nbsp;<span class="op" id="1620982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1620986">l</span>&nbsp;<span class="op" id="1620988">:=</span>&nbsp;<span class="ident" id="1620991">indexLocal</span><span class="op" id="1621001">(</span><span class="ident" id="1621002">local</span><span class="op" id="1621007">,</span>&nbsp;<span class="op" id="1621009">(</span><span class="ident" id="1621010">pid</span><span class="op" id="1621013">+</span><span class="ident" id="1621014">i</span><span class="op" id="1621015">+</span><span class="num" id="1621016">1</span><span class="op" id="1621017">)</span><span class="op" id="1621018">%</span><span class="builtintype" id="1621019">int</span><span class="op" id="1621022">(</span><span class="ident" id="1621023">size</span><span class="op" id="1621027">)</span><span class="op" id="1621028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621032">l</span><span class="op" id="1621033">.</span><span class="ident" id="1621034">Lock</span><span class="op" id="1621038">(</span><span class="op" id="1621039">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621043">last</span>&nbsp;<span class="op" id="1621048">:=</span>&nbsp;<span class="builtinfunc" id="1621051">len</span><span class="op" id="1621054">(</span><span class="ident" id="1621055">l</span><span class="op" id="1621056">.</span><span class="ident" id="1621057">shared</span><span class="op" id="1621063">)</span>&nbsp;<span class="op" id="1621065">-</span>&nbsp;<span class="num" id="1621067">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621071">if</span>&nbsp;<span class="ident" id="1621074">last</span>&nbsp;<span class="op" id="1621079">&gt;=</span>&nbsp;<span class="num" id="1621082">0</span>&nbsp;<span class="op" id="1621084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621089">x</span>&nbsp;<span class="op" id="1621091">=</span>&nbsp;<span class="ident" id="1621093">l</span><span class="op" id="1621094">.</span><span class="ident" id="1621095">shared</span><span class="op" id="1621101">[</span><span class="ident" id="1621102">last</span><span class="op" id="1621106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621111">l</span><span class="op" id="1621112">.</span><span class="ident" id="1621113">shared</span>&nbsp;<span class="op" id="1621120">=</span>&nbsp;<span class="ident" id="1621122">l</span><span class="op" id="1621123">.</span><span class="ident" id="1621124">shared</span><span class="op" id="1621130">[</span><span class="op" id="1621131">:</span><span class="ident" id="1621132">last</span><span class="op" id="1621136">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621141">l</span><span class="op" id="1621142">.</span><span class="ident" id="1621143">Unlock</span><span class="op" id="1621149">(</span><span class="op" id="1621150">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621155">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621167">l</span><span class="op" id="1621168">.</span><span class="ident" id="1621169">Unlock</span><span class="op" id="1621175">(</span><span class="op" id="1621176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621179">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621183">if</span>&nbsp;<span class="ident" id="1621186">x</span>&nbsp;<span class="op" id="1621188">==</span>&nbsp;<span class="ident" id="1621191">nil</span>&nbsp;<span class="op" id="1621195">&amp;&amp;</span>&nbsp;<span class="ident" id="1621198">p</span><span class="op" id="1621199">.</span><span class="ident" id="1621200">New</span>&nbsp;<span class="op" id="1621204">!=</span>&nbsp;<span class="ident" id="1621207">nil</span>&nbsp;<span class="op" id="1621211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621215">x</span>&nbsp;<span class="op" id="1621217">=</span>&nbsp;<span class="ident" id="1621219">p</span><span class="op" id="1621220">.</span><span class="ident" id="1621221">New</span><span class="op" id="1621224">(</span><span class="op" id="1621225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621228">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621231">return</span>&nbsp;<span class="ident" id="1621238">x</span><br>
<span class="lineno"></span><span class="op" id="1621240">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1621243">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1621341">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1621406">func</span>&nbsp;<span class="op" id="1621411">(</span><span class="ident" id="1621412">p</span>&nbsp;<span class="op" id="1621414">*</span><span class="ident" id="1621415">Pool</span><span class="op" id="1621419">)</span>&nbsp;<span class="ident" id="1621421">pin</span><span class="op" id="1621424">(</span><span class="op" id="1621425">)</span>&nbsp;<span class="op" id="1621427">*</span><span class="ident" id="1621428">poolLocal</span>&nbsp;<span class="op" id="1621438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621441">pid</span>&nbsp;<span class="op" id="1621445">:=</span>&nbsp;<span class="ident" id="1621448">runtime_procPin</span><span class="op" id="1621463">(</span><span class="op" id="1621464">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621467">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621555">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621622">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1621687">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621784">s</span>&nbsp;<span class="op" id="1621786">:=</span>&nbsp;<span class="ident" id="1621789">atomic</span><span class="op" id="1621795">.</span><span class="ident" id="1621796">LoadUintptr</span><span class="op" id="1621807">(</span><span class="op" id="1621808">&amp;</span><span class="ident" id="1621809">p</span><span class="op" id="1621810">.</span><span class="ident" id="1621811">localSize</span><span class="op" id="1621820">)</span>&nbsp;<span class="comment" id="1621822">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1621839">l</span>&nbsp;<span class="op" id="1621841">:=</span>&nbsp;<span class="ident" id="1621844">p</span><span class="op" id="1621845">.</span><span class="ident" id="1621846">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1621877">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621894">if</span>&nbsp;<span class="builtintype" id="1621897">uintptr</span><span class="op" id="1621904">(</span><span class="ident" id="1621905">pid</span><span class="op" id="1621908">)</span>&nbsp;<span class="op" id="1621910">&lt;</span>&nbsp;<span class="ident" id="1621912">s</span>&nbsp;<span class="op" id="1621914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621918">return</span>&nbsp;<span class="ident" id="1621925">indexLocal</span><span class="op" id="1621935">(</span><span class="ident" id="1621936">l</span><span class="op" id="1621937">,</span>&nbsp;<span class="ident" id="1621939">pid</span><span class="op" id="1621942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1621945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1621948">return</span>&nbsp;<span class="ident" id="1621955">p</span><span class="op" id="1621956">.</span><span class="ident" id="1621957">pinSlow</span><span class="op" id="1621964">(</span><span class="op" id="1621965">)</span><br>
<span class="lineno">160</span><span class="op" id="1621967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1621970">func</span>&nbsp;<span class="op" id="1621975">(</span><span class="ident" id="1621976">p</span>&nbsp;<span class="op" id="1621978">*</span><span class="ident" id="1621979">Pool</span><span class="op" id="1621983">)</span>&nbsp;<span class="ident" id="1621985">pinSlow</span><span class="op" id="1621992">(</span><span class="op" id="1621993">)</span>&nbsp;<span class="op" id="1621995">*</span><span class="ident" id="1621996">poolLocal</span>&nbsp;<span class="op" id="1622006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622009">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622036">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622077">runtime_procUnpin</span><span class="op" id="1622094">(</span><span class="op" id="1622095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622098">allPoolsMu</span><span class="op" id="1622108">.</span><span class="ident" id="1622109">Lock</span><span class="op" id="1622113">(</span><span class="op" id="1622114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622117">defer</span>&nbsp;<span class="ident" id="1622123">allPoolsMu</span><span class="op" id="1622133">.</span><span class="ident" id="1622134">Unlock</span><span class="op" id="1622140">(</span><span class="op" id="1622141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622144">pid</span>&nbsp;<span class="op" id="1622148">:=</span>&nbsp;<span class="ident" id="1622151">runtime_procPin</span><span class="op" id="1622166">(</span><span class="op" id="1622167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622170">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622223">s</span>&nbsp;<span class="op" id="1622225">:=</span>&nbsp;<span class="ident" id="1622228">p</span><span class="op" id="1622229">.</span><span class="ident" id="1622230">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622241">l</span>&nbsp;<span class="op" id="1622243">:=</span>&nbsp;<span class="ident" id="1622246">p</span><span class="op" id="1622247">.</span><span class="ident" id="1622248">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622255">if</span>&nbsp;<span class="builtintype" id="1622258">uintptr</span><span class="op" id="1622265">(</span><span class="ident" id="1622266">pid</span><span class="op" id="1622269">)</span>&nbsp;<span class="op" id="1622271">&lt;</span>&nbsp;<span class="ident" id="1622273">s</span>&nbsp;<span class="op" id="1622275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622279">return</span>&nbsp;<span class="ident" id="1622286">indexLocal</span><span class="op" id="1622296">(</span><span class="ident" id="1622297">l</span><span class="op" id="1622298">,</span>&nbsp;<span class="ident" id="1622300">pid</span><span class="op" id="1622303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622306">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622309">if</span>&nbsp;<span class="ident" id="1622312">p</span><span class="op" id="1622313">.</span><span class="ident" id="1622314">local</span>&nbsp;<span class="op" id="1622320">==</span>&nbsp;<span class="ident" id="1622323">nil</span>&nbsp;<span class="op" id="1622327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622331">allPools</span>&nbsp;<span class="op" id="1622340">=</span>&nbsp;<span class="builtinfunc" id="1622342">append</span><span class="op" id="1622348">(</span><span class="ident" id="1622349">allPools</span><span class="op" id="1622357">,</span>&nbsp;<span class="ident" id="1622359">p</span><span class="op" id="1622360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1622363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622366">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622452">size</span>&nbsp;<span class="op" id="1622457">:=</span>&nbsp;<span class="ident" id="1622460">runtime</span><span class="op" id="1622467">.</span><span class="ident" id="1622468">GOMAXPROCS</span><span class="op" id="1622478">(</span><span class="num" id="1622479">0</span><span class="op" id="1622480">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622483">local</span>&nbsp;<span class="op" id="1622489">:=</span>&nbsp;<span class="builtinfunc" id="1622492">make</span><span class="op" id="1622496">(</span><span class="op" id="1622497">[</span><span class="op" id="1622498">]</span><span class="ident" id="1622499">poolLocal</span><span class="op" id="1622508">,</span>&nbsp;<span class="ident" id="1622510">size</span><span class="op" id="1622514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622517">atomic</span><span class="op" id="1622523">.</span><span class="ident" id="1622524">StorePointer</span><span class="op" id="1622536">(</span><span class="op" id="1622537">(</span><span class="op" id="1622538">*</span><span class="ident" id="1622539">unsafe</span><span class="op" id="1622545">.</span><span class="ident" id="1622546">Pointer</span><span class="op" id="1622553">)</span><span class="op" id="1622554">(</span><span class="op" id="1622555">&amp;</span><span class="ident" id="1622556">p</span><span class="op" id="1622557">.</span><span class="ident" id="1622558">local</span><span class="op" id="1622563">)</span><span class="op" id="1622564">,</span>&nbsp;<span class="ident" id="1622566">unsafe</span><span class="op" id="1622572">.</span><span class="ident" id="1622573">Pointer</span><span class="op" id="1622580">(</span><span class="op" id="1622581">&amp;</span><span class="ident" id="1622582">local</span><span class="op" id="1622587">[</span><span class="num" id="1622588">0</span><span class="op" id="1622589">]</span><span class="op" id="1622590">)</span><span class="op" id="1622591">)</span>&nbsp;<span class="comment" id="1622593">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1622611">atomic</span><span class="op" id="1622617">.</span><span class="ident" id="1622618">StoreUintptr</span><span class="op" id="1622630">(</span><span class="op" id="1622631">&amp;</span><span class="ident" id="1622632">p</span><span class="op" id="1622633">.</span><span class="ident" id="1622634">localSize</span><span class="op" id="1622643">,</span>&nbsp;<span class="builtintype" id="1622645">uintptr</span><span class="op" id="1622652">(</span><span class="ident" id="1622653">size</span><span class="op" id="1622657">)</span><span class="op" id="1622658">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1622687">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1622705">return</span>&nbsp;<span class="op" id="1622712">&amp;</span><span class="ident" id="1622713">local</span><span class="op" id="1622718">[</span><span class="ident" id="1622719">pid</span><span class="op" id="1622722">]</span><br>
<span class="lineno"></span><span class="op" id="1622724">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1622727">func</span>&nbsp;<span class="ident" id="1622732">poolCleanup</span><span class="op" id="1622743">(</span><span class="op" id="1622744">)</span>&nbsp;<span class="op" id="1622746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622749">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622843">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622920">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1622968">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1623018">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1623089">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623174">for</span>&nbsp;<span class="ident" id="1623178">i</span><span class="op" id="1623179">,</span>&nbsp;<span class="ident" id="1623181">p</span>&nbsp;<span class="op" id="1623183">:=</span>&nbsp;<span class="keyword" id="1623186">range</span>&nbsp;<span class="ident" id="1623192">allPools</span>&nbsp;<span class="op" id="1623201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623205">allPools</span><span class="op" id="1623213">[</span><span class="ident" id="1623214">i</span><span class="op" id="1623215">]</span>&nbsp;<span class="op" id="1623217">=</span>&nbsp;<span class="ident" id="1623219">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623225">for</span>&nbsp;<span class="ident" id="1623229">i</span>&nbsp;<span class="op" id="1623231">:=</span>&nbsp;<span class="num" id="1623234">0</span><span class="op" id="1623235">;</span>&nbsp;<span class="ident" id="1623237">i</span>&nbsp;<span class="op" id="1623239">&lt;</span>&nbsp;<span class="builtintype" id="1623241">int</span><span class="op" id="1623244">(</span><span class="ident" id="1623245">p</span><span class="op" id="1623246">.</span><span class="ident" id="1623247">localSize</span><span class="op" id="1623256">)</span><span class="op" id="1623257">;</span>&nbsp;<span class="ident" id="1623259">i</span><span class="op" id="1623260">++</span>&nbsp;<span class="op" id="1623263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623268">l</span>&nbsp;<span class="op" id="1623270">:=</span>&nbsp;<span class="ident" id="1623273">indexLocal</span><span class="op" id="1623283">(</span><span class="ident" id="1623284">p</span><span class="op" id="1623285">.</span><span class="ident" id="1623286">local</span><span class="op" id="1623291">,</span>&nbsp;<span class="ident" id="1623293">i</span><span class="op" id="1623294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623299">l</span><span class="op" id="1623300">.</span><span class="ident" id="1623301">private</span>&nbsp;<span class="op" id="1623309">=</span>&nbsp;<span class="ident" id="1623311">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623318">for</span>&nbsp;<span class="ident" id="1623322">j</span>&nbsp;<span class="op" id="1623324">:=</span>&nbsp;<span class="keyword" id="1623327">range</span>&nbsp;<span class="ident" id="1623333">l</span><span class="op" id="1623334">.</span><span class="ident" id="1623335">shared</span>&nbsp;<span class="op" id="1623342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623348">l</span><span class="op" id="1623349">.</span><span class="ident" id="1623350">shared</span><span class="op" id="1623356">[</span><span class="ident" id="1623357">j</span><span class="op" id="1623358">]</span>&nbsp;<span class="op" id="1623360">=</span>&nbsp;<span class="ident" id="1623362">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623374">l</span><span class="op" id="1623375">.</span><span class="ident" id="1623376">shared</span>&nbsp;<span class="op" id="1623383">=</span>&nbsp;<span class="ident" id="1623385">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623395">p</span><span class="op" id="1623396">.</span><span class="ident" id="1623397">local</span>&nbsp;<span class="op" id="1623403">=</span>&nbsp;<span class="ident" id="1623405">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623411">p</span><span class="op" id="1623412">.</span><span class="ident" id="1623413">localSize</span>&nbsp;<span class="op" id="1623423">=</span>&nbsp;<span class="num" id="1623425">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1623428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623431">allPools</span>&nbsp;<span class="op" id="1623440">=</span>&nbsp;<span class="op" id="1623442">[</span><span class="op" id="1623443">]</span><span class="op" id="1623444">*</span><span class="ident" id="1623445">Pool</span><span class="op" id="1623449">{</span><span class="op" id="1623450">}</span><br>
<span class="lineno"></span><span class="op" id="1623452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1623455">var</span>&nbsp;<span class="op" id="1623459">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623462">allPoolsMu</span>&nbsp;<span class="ident" id="1623473">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623480">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1623491">[</span><span class="op" id="1623492">]</span><span class="op" id="1623493">*</span><span class="ident" id="1623494">Pool</span><br>
<span class="lineno"></span><span class="op" id="1623499">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1623502">func</span>&nbsp;<span class="ident" id="1623507">init</span><span class="op" id="1623511">(</span><span class="op" id="1623512">)</span>&nbsp;<span class="op" id="1623514">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1623517">runtime_registerPoolCleanup</span><span class="op" id="1623544">(</span><span class="ident" id="1623545">poolCleanup</span><span class="op" id="1623556">)</span><br>
<span class="lineno"></span><span class="op" id="1623558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1623561">func</span>&nbsp;<span class="ident" id="1623566">indexLocal</span><span class="op" id="1623576">(</span><span class="ident" id="1623577">l</span>&nbsp;<span class="ident" id="1623579">unsafe</span><span class="op" id="1623585">.</span><span class="ident" id="1623586">Pointer</span><span class="op" id="1623593">,</span>&nbsp;<span class="ident" id="1623595">i</span>&nbsp;<span class="builtintype" id="1623597">int</span><span class="op" id="1623600">)</span>&nbsp;<span class="op" id="1623602">*</span><span class="ident" id="1623603">poolLocal</span>&nbsp;<span class="op" id="1623613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1623616">return</span>&nbsp;<span class="op" id="1623623">&amp;</span><span class="op" id="1623624">(</span><span class="op" id="1623625">*</span><span class="op" id="1623626">[</span><span class="num" id="1623627">1000000</span><span class="op" id="1623634">]</span><span class="ident" id="1623635">poolLocal</span><span class="op" id="1623644">)</span><span class="op" id="1623645">(</span><span class="ident" id="1623646">l</span><span class="op" id="1623647">)</span><span class="op" id="1623648">[</span><span class="ident" id="1623649">i</span><span class="op" id="1623650">]</span><br>
<span class="lineno">220</span><span class="op" id="1623652">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1623655">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1623682">func</span>&nbsp;<span class="ident" id="1623687">runtime_registerPoolCleanup</span><span class="op" id="1623714">(</span><span class="ident" id="1623715">cleanup</span>&nbsp;<span class="keyword" id="1623723">func</span><span class="op" id="1623727">(</span><span class="op" id="1623728">)</span><span class="op" id="1623729">)</span><br>
<span class="lineno"></span><span class="keyword" id="1623731">func</span>&nbsp;<span class="ident" id="1623736">runtime_procPin</span><span class="op" id="1623751">(</span><span class="op" id="1623752">)</span>&nbsp;<span class="builtintype" id="1623754">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1623758">func</span>&nbsp;<span class="ident" id="1623763">runtime_procUnpin</span><span class="op" id="1623780">(</span><span class="op" id="1623781">)</span>
</div>
</body>
</html>
