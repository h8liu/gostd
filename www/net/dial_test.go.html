<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7392840">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7392895">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7392949">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7393000">package</span>&nbsp;<span class="ident" id="7393008">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7393013">import</span>&nbsp;<span class="op" id="7393020">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393023">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393032">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393040">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393047">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393053">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393059">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393070">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393081">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393091">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393102">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393113">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393121">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7393132">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7393139">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7393142">func</span>&nbsp;<span class="ident" id="7393147">newLocalListener</span><span class="op" id="7393163">(</span><span class="ident" id="7393164">t</span>&nbsp;<span class="op" id="7393166">*</span><span class="ident" id="7393167">testing</span><span class="op" id="7393174">.</span><span class="ident" id="7393175">T</span><span class="op" id="7393176">)</span>&nbsp;<span class="ident" id="7393178">Listener</span>&nbsp;<span class="op" id="7393187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393190">ln</span><span class="op" id="7393192">,</span>&nbsp;<span class="ident" id="7393194">err</span>&nbsp;<span class="op" id="7393198">:=</span>&nbsp;<span class="ident" id="7393201">Listen</span><span class="op" id="7393207">(</span><span class="string" id="7393208">&#34;tcp&#34;</span><span class="op" id="7393213">,</span>&nbsp;<span class="string" id="7393215">&#34;127.0.0.1:0&#34;</span><span class="op" id="7393228">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393231">if</span>&nbsp;<span class="ident" id="7393234">err</span>&nbsp;<span class="op" id="7393238">!=</span>&nbsp;<span class="ident" id="7393241">nil</span>&nbsp;<span class="op" id="7393245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393249">ln</span><span class="op" id="7393251">,</span>&nbsp;<span class="ident" id="7393253">err</span>&nbsp;<span class="op" id="7393257">=</span>&nbsp;<span class="ident" id="7393259">Listen</span><span class="op" id="7393265">(</span><span class="string" id="7393266">&#34;tcp6&#34;</span><span class="op" id="7393272">,</span>&nbsp;<span class="string" id="7393274">&#34;[::1]:0&#34;</span><span class="op" id="7393283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7393286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393289">if</span>&nbsp;<span class="ident" id="7393292">err</span>&nbsp;<span class="op" id="7393296">!=</span>&nbsp;<span class="ident" id="7393299">nil</span>&nbsp;<span class="op" id="7393303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393307">t</span><span class="op" id="7393308">.</span><span class="ident" id="7393309">Fatal</span><span class="op" id="7393314">(</span><span class="ident" id="7393315">err</span><span class="op" id="7393318">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7393321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393324">return</span>&nbsp;<span class="ident" id="7393331">ln</span><br>
<span class="lineno"></span><span class="op" id="7393334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7393337">func</span>&nbsp;<span class="ident" id="7393342">TestDialTimeout</span><span class="op" id="7393357">(</span><span class="ident" id="7393358">t</span>&nbsp;<span class="op" id="7393360">*</span><span class="ident" id="7393361">testing</span><span class="op" id="7393368">.</span><span class="ident" id="7393369">T</span><span class="op" id="7393370">)</span>&nbsp;<span class="op" id="7393372">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393375">origBacklog</span>&nbsp;<span class="op" id="7393387">:=</span>&nbsp;<span class="ident" id="7393390">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393407">defer</span>&nbsp;<span class="keyword" id="7393413">func</span><span class="op" id="7393417">(</span><span class="op" id="7393418">)</span>&nbsp;<span class="op" id="7393420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393424">listenerBacklog</span>&nbsp;<span class="op" id="7393440">=</span>&nbsp;<span class="ident" id="7393442">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7393455">}</span><span class="op" id="7393456">(</span><span class="op" id="7393457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393460">listenerBacklog</span>&nbsp;<span class="op" id="7393476">=</span>&nbsp;<span class="num" id="7393478">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393482">ln</span>&nbsp;<span class="op" id="7393485">:=</span>&nbsp;<span class="ident" id="7393488">newLocalListener</span><span class="op" id="7393504">(</span><span class="ident" id="7393505">t</span><span class="op" id="7393506">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393509">defer</span>&nbsp;<span class="ident" id="7393515">ln</span><span class="op" id="7393517">.</span><span class="ident" id="7393518">Close</span><span class="op" id="7393523">(</span><span class="op" id="7393524">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393528">errc</span>&nbsp;<span class="op" id="7393533">:=</span>&nbsp;<span class="builtinfunc" id="7393536">make</span><span class="op" id="7393540">(</span><span class="keyword" id="7393541">chan</span>&nbsp;<span class="builtintype" id="7393546">error</span><span class="op" id="7393551">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393555">numConns</span>&nbsp;<span class="op" id="7393564">:=</span>&nbsp;<span class="ident" id="7393567">listenerBacklog</span>&nbsp;<span class="op" id="7393583">+</span>&nbsp;<span class="num" id="7393585">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7393591">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7393648">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393697">switch</span>&nbsp;<span class="ident" id="7393704">runtime</span><span class="op" id="7393711">.</span><span class="ident" id="7393712">GOOS</span>&nbsp;<span class="op" id="7393717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393720">case</span>&nbsp;<span class="string" id="7393725">&#34;linux&#34;</span><span class="op" id="7393732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7393736">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7393806">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7393876">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393946">for</span>&nbsp;<span class="ident" id="7393950">i</span>&nbsp;<span class="op" id="7393952">:=</span>&nbsp;<span class="num" id="7393955">0</span><span class="op" id="7393956">;</span>&nbsp;<span class="ident" id="7393958">i</span>&nbsp;<span class="op" id="7393960">&lt;</span>&nbsp;<span class="ident" id="7393962">numConns</span><span class="op" id="7393970">;</span>&nbsp;<span class="ident" id="7393972">i</span><span class="op" id="7393973">++</span>&nbsp;<span class="op" id="7393976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7393981">go</span>&nbsp;<span class="keyword" id="7393984">func</span><span class="op" id="7393988">(</span><span class="op" id="7393989">)</span>&nbsp;<span class="op" id="7393991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7393997">_</span><span class="op" id="7393998">,</span>&nbsp;<span class="ident" id="7394000">err</span>&nbsp;<span class="op" id="7394004">:=</span>&nbsp;<span class="ident" id="7394007">DialTimeout</span><span class="op" id="7394018">(</span><span class="string" id="7394019">&#34;tcp&#34;</span><span class="op" id="7394024">,</span>&nbsp;<span class="ident" id="7394026">ln</span><span class="op" id="7394028">.</span><span class="ident" id="7394029">Addr</span><span class="op" id="7394033">(</span><span class="op" id="7394034">)</span><span class="op" id="7394035">.</span><span class="ident" id="7394036">String</span><span class="op" id="7394042">(</span><span class="op" id="7394043">)</span><span class="op" id="7394044">,</span>&nbsp;<span class="num" id="7394046">200</span><span class="op" id="7394049">*</span><span class="ident" id="7394050">time</span><span class="op" id="7394054">.</span><span class="ident" id="7394055">Millisecond</span><span class="op" id="7394066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7394072">errc</span>&nbsp;<span class="op" id="7394077">&lt;-</span>&nbsp;<span class="ident" id="7394080">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7394087">}</span><span class="op" id="7394088">(</span><span class="op" id="7394089">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7394093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7394096">case</span>&nbsp;<span class="string" id="7394101">&#34;darwin&#34;</span><span class="op" id="7394109">,</span>&nbsp;<span class="string" id="7394111">&#34;plan9&#34;</span><span class="op" id="7394118">,</span>&nbsp;<span class="string" id="7394120">&#34;windows&#34;</span><span class="op" id="7394129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394133">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394187">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394242">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394296">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394319">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394324">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394386">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394442">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394496">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394556">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394561">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394628">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7394725">go</span>&nbsp;<span class="keyword" id="7394728">func</span><span class="op" id="7394732">(</span><span class="op" id="7394733">)</span>&nbsp;<span class="op" id="7394735">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7394740">c</span><span class="op" id="7394741">,</span>&nbsp;<span class="ident" id="7394743">err</span>&nbsp;<span class="op" id="7394747">:=</span>&nbsp;<span class="ident" id="7394750">DialTimeout</span><span class="op" id="7394761">(</span><span class="string" id="7394762">&#34;tcp&#34;</span><span class="op" id="7394767">,</span>&nbsp;<span class="string" id="7394769">&#34;127.0.71.111:49151&#34;</span><span class="op" id="7394789">,</span>&nbsp;<span class="num" id="7394791">200</span><span class="op" id="7394794">*</span><span class="ident" id="7394795">time</span><span class="op" id="7394799">.</span><span class="ident" id="7394800">Millisecond</span><span class="op" id="7394811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7394816">if</span>&nbsp;<span class="ident" id="7394819">err</span>&nbsp;<span class="op" id="7394823">==</span>&nbsp;<span class="ident" id="7394826">nil</span>&nbsp;<span class="op" id="7394830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7394836">err</span>&nbsp;<span class="op" id="7394840">=</span>&nbsp;<span class="ident" id="7394842">fmt</span><span class="op" id="7394845">.</span><span class="ident" id="7394846">Errorf</span><span class="op" id="7394852">(</span><span class="string" id="7394853">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="7394883">,</span>&nbsp;<span class="ident" id="7394885">c</span><span class="op" id="7394886">.</span><span class="ident" id="7394887">RemoteAddr</span><span class="op" id="7394897">(</span><span class="op" id="7394898">)</span><span class="op" id="7394899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7394905">c</span><span class="op" id="7394906">.</span><span class="ident" id="7394907">Close</span><span class="op" id="7394912">(</span><span class="op" id="7394913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7394918">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7394923">errc</span>&nbsp;<span class="op" id="7394928">&lt;-</span>&nbsp;<span class="ident" id="7394931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7394937">}</span><span class="op" id="7394938">(</span><span class="op" id="7394939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7394942">default</span><span class="op" id="7394949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394953">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7394974">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395040">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395096">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395112">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395174">t</span><span class="op" id="7395175">.</span><span class="ident" id="7395176">Skipf</span><span class="op" id="7395181">(</span><span class="string" id="7395182">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="7395214">,</span>&nbsp;<span class="ident" id="7395216">runtime</span><span class="op" id="7395223">.</span><span class="ident" id="7395224">GOOS</span><span class="op" id="7395228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395231">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395235">connected</span>&nbsp;<span class="op" id="7395245">:=</span>&nbsp;<span class="num" id="7395248">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395251">for</span>&nbsp;<span class="op" id="7395255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395259">select</span>&nbsp;<span class="op" id="7395266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395270">case</span>&nbsp;<span class="op" id="7395275">&lt;-</span><span class="ident" id="7395277">time</span><span class="op" id="7395281">.</span><span class="ident" id="7395282">After</span><span class="op" id="7395287">(</span><span class="num" id="7395288">15</span>&nbsp;<span class="op" id="7395291">*</span>&nbsp;<span class="ident" id="7395293">time</span><span class="op" id="7395297">.</span><span class="ident" id="7395298">Second</span><span class="op" id="7395304">)</span><span class="op" id="7395305">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395310">t</span><span class="op" id="7395311">.</span><span class="ident" id="7395312">Fatal</span><span class="op" id="7395317">(</span><span class="string" id="7395318">&#34;too&nbsp;slow&#34;</span><span class="op" id="7395328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395332">case</span>&nbsp;<span class="ident" id="7395337">err</span>&nbsp;<span class="op" id="7395341">:=</span>&nbsp;<span class="op" id="7395344">&lt;-</span><span class="ident" id="7395346">errc</span><span class="op" id="7395350">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395355">if</span>&nbsp;<span class="ident" id="7395358">err</span>&nbsp;<span class="op" id="7395362">==</span>&nbsp;<span class="ident" id="7395365">nil</span>&nbsp;<span class="op" id="7395369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395375">connected</span><span class="op" id="7395384">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395391">if</span>&nbsp;<span class="ident" id="7395394">connected</span>&nbsp;<span class="op" id="7395404">==</span>&nbsp;<span class="ident" id="7395407">numConns</span>&nbsp;<span class="op" id="7395416">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395423">t</span><span class="op" id="7395424">.</span><span class="ident" id="7395425">Fatal</span><span class="op" id="7395430">(</span><span class="string" id="7395431">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="7395485">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395496">}</span>&nbsp;<span class="keyword" id="7395498">else</span>&nbsp;<span class="op" id="7395503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395509">terr</span><span class="op" id="7395513">,</span>&nbsp;<span class="ident" id="7395515">ok</span>&nbsp;<span class="op" id="7395518">:=</span>&nbsp;<span class="ident" id="7395521">err</span><span class="op" id="7395524">.</span><span class="op" id="7395525">(</span><span class="ident" id="7395526">timeout</span><span class="op" id="7395533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395539">if</span>&nbsp;<span class="op" id="7395542">!</span><span class="ident" id="7395543">ok</span>&nbsp;<span class="op" id="7395546">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395553">t</span><span class="op" id="7395554">.</span><span class="ident" id="7395555">Fatalf</span><span class="op" id="7395561">(</span><span class="string" id="7395562">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="7395611">,</span>&nbsp;<span class="ident" id="7395613">err</span><span class="op" id="7395616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395628">if</span>&nbsp;<span class="op" id="7395631">!</span><span class="ident" id="7395632">terr</span><span class="op" id="7395636">.</span><span class="ident" id="7395637">Timeout</span><span class="op" id="7395644">(</span><span class="op" id="7395645">)</span>&nbsp;<span class="op" id="7395647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395654">t</span><span class="op" id="7395655">.</span><span class="ident" id="7395656">Fatalf</span><span class="op" id="7395662">(</span><span class="string" id="7395663">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="7395692">,</span>&nbsp;<span class="ident" id="7395694">err</span><span class="op" id="7395697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395703">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395709">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395746">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395763">}</span><br>
<span class="lineno">115</span><span class="op" id="7395765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7395768">func</span>&nbsp;<span class="ident" id="7395773">TestSelfConnect</span><span class="op" id="7395788">(</span><span class="ident" id="7395789">t</span>&nbsp;<span class="op" id="7395791">*</span><span class="ident" id="7395792">testing</span><span class="op" id="7395799">.</span><span class="ident" id="7395800">T</span><span class="op" id="7395801">)</span>&nbsp;<span class="op" id="7395803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7395806">if</span>&nbsp;<span class="ident" id="7395809">runtime</span><span class="op" id="7395816">.</span><span class="ident" id="7395817">GOOS</span>&nbsp;<span class="op" id="7395822">==</span>&nbsp;<span class="string" id="7395825">&#34;windows&#34;</span>&nbsp;<span class="op" id="7395835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395839">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7395886">t</span><span class="op" id="7395887">.</span><span class="ident" id="7395888">Skip</span><span class="op" id="7395892">(</span><span class="string" id="7395893">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="7395932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7395935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395939">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7395988">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7396021">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396076">l</span><span class="op" id="7396077">,</span>&nbsp;<span class="ident" id="7396079">err</span>&nbsp;<span class="op" id="7396083">:=</span>&nbsp;<span class="ident" id="7396086">Listen</span><span class="op" id="7396092">(</span><span class="string" id="7396093">&#34;tcp&#34;</span><span class="op" id="7396098">,</span>&nbsp;<span class="string" id="7396100">&#34;127.0.0.1:0&#34;</span><span class="op" id="7396113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396116">if</span>&nbsp;<span class="ident" id="7396119">err</span>&nbsp;<span class="op" id="7396123">!=</span>&nbsp;<span class="ident" id="7396126">nil</span>&nbsp;<span class="op" id="7396130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396134">t</span><span class="op" id="7396135">.</span><span class="ident" id="7396136">Fatal</span><span class="op" id="7396141">(</span><span class="ident" id="7396142">err</span><span class="op" id="7396145">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396151">c</span><span class="op" id="7396152">,</span>&nbsp;<span class="ident" id="7396154">err</span>&nbsp;<span class="op" id="7396158">:=</span>&nbsp;<span class="ident" id="7396161">Dial</span><span class="op" id="7396165">(</span><span class="string" id="7396166">&#34;tcp&#34;</span><span class="op" id="7396171">,</span>&nbsp;<span class="ident" id="7396173">l</span><span class="op" id="7396174">.</span><span class="ident" id="7396175">Addr</span><span class="op" id="7396179">(</span><span class="op" id="7396180">)</span><span class="op" id="7396181">.</span><span class="ident" id="7396182">String</span><span class="op" id="7396188">(</span><span class="op" id="7396189">)</span><span class="op" id="7396190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396193">if</span>&nbsp;<span class="ident" id="7396196">err</span>&nbsp;<span class="op" id="7396200">!=</span>&nbsp;<span class="ident" id="7396203">nil</span>&nbsp;<span class="op" id="7396207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396211">t</span><span class="op" id="7396212">.</span><span class="ident" id="7396213">Fatal</span><span class="op" id="7396218">(</span><span class="ident" id="7396219">err</span><span class="op" id="7396222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396225">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396228">addr</span>&nbsp;<span class="op" id="7396233">:=</span>&nbsp;<span class="ident" id="7396236">c</span><span class="op" id="7396237">.</span><span class="ident" id="7396238">LocalAddr</span><span class="op" id="7396247">(</span><span class="op" id="7396248">)</span><span class="op" id="7396249">.</span><span class="ident" id="7396250">String</span><span class="op" id="7396256">(</span><span class="op" id="7396257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396260">c</span><span class="op" id="7396261">.</span><span class="ident" id="7396262">Close</span><span class="op" id="7396267">(</span><span class="op" id="7396268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396271">l</span><span class="op" id="7396272">.</span><span class="ident" id="7396273">Close</span><span class="op" id="7396278">(</span><span class="op" id="7396279">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7396283">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396330">n</span>&nbsp;<span class="op" id="7396332">:=</span>&nbsp;<span class="num" id="7396335">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396343">if</span>&nbsp;<span class="ident" id="7396346">testing</span><span class="op" id="7396353">.</span><span class="ident" id="7396354">Short</span><span class="op" id="7396359">(</span><span class="op" id="7396360">)</span>&nbsp;<span class="op" id="7396362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396366">n</span>&nbsp;<span class="op" id="7396368">=</span>&nbsp;<span class="num" id="7396370">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396379">switch</span>&nbsp;<span class="ident" id="7396386">runtime</span><span class="op" id="7396393">.</span><span class="ident" id="7396394">GOOS</span>&nbsp;<span class="op" id="7396399">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396402">case</span>&nbsp;<span class="string" id="7396407">&#34;darwin&#34;</span><span class="op" id="7396415">,</span>&nbsp;<span class="string" id="7396417">&#34;dragonfly&#34;</span><span class="op" id="7396428">,</span>&nbsp;<span class="string" id="7396430">&#34;freebsd&#34;</span><span class="op" id="7396439">,</span>&nbsp;<span class="string" id="7396441">&#34;netbsd&#34;</span><span class="op" id="7396449">,</span>&nbsp;<span class="string" id="7396451">&#34;openbsd&#34;</span><span class="op" id="7396460">,</span>&nbsp;<span class="string" id="7396462">&#34;plan9&#34;</span><span class="op" id="7396469">,</span>&nbsp;<span class="string" id="7396471">&#34;solaris&#34;</span><span class="op" id="7396480">,</span>&nbsp;<span class="string" id="7396482">&#34;windows&#34;</span><span class="op" id="7396491">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7396495">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7396545">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396600">n</span>&nbsp;<span class="op" id="7396602">=</span>&nbsp;<span class="num" id="7396604">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396609">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396612">for</span>&nbsp;<span class="ident" id="7396616">i</span>&nbsp;<span class="op" id="7396618">:=</span>&nbsp;<span class="num" id="7396621">0</span><span class="op" id="7396622">;</span>&nbsp;<span class="ident" id="7396624">i</span>&nbsp;<span class="op" id="7396626">&lt;</span>&nbsp;<span class="ident" id="7396628">n</span><span class="op" id="7396629">;</span>&nbsp;<span class="ident" id="7396631">i</span><span class="op" id="7396632">++</span>&nbsp;<span class="op" id="7396635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396639">c</span><span class="op" id="7396640">,</span>&nbsp;<span class="ident" id="7396642">err</span>&nbsp;<span class="op" id="7396646">:=</span>&nbsp;<span class="ident" id="7396649">DialTimeout</span><span class="op" id="7396660">(</span><span class="string" id="7396661">&#34;tcp&#34;</span><span class="op" id="7396666">,</span>&nbsp;<span class="ident" id="7396668">addr</span><span class="op" id="7396672">,</span>&nbsp;<span class="ident" id="7396674">time</span><span class="op" id="7396678">.</span><span class="ident" id="7396679">Millisecond</span><span class="op" id="7396690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396694">if</span>&nbsp;<span class="ident" id="7396697">err</span>&nbsp;<span class="op" id="7396701">==</span>&nbsp;<span class="ident" id="7396704">nil</span>&nbsp;<span class="op" id="7396708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7396713">if</span>&nbsp;<span class="ident" id="7396716">c</span><span class="op" id="7396717">.</span><span class="ident" id="7396718">LocalAddr</span><span class="op" id="7396727">(</span><span class="op" id="7396728">)</span><span class="op" id="7396729">.</span><span class="ident" id="7396730">String</span><span class="op" id="7396736">(</span><span class="op" id="7396737">)</span>&nbsp;<span class="op" id="7396739">==</span>&nbsp;<span class="ident" id="7396742">addr</span>&nbsp;<span class="op" id="7396747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396753">t</span><span class="op" id="7396754">.</span><span class="ident" id="7396755">Errorf</span><span class="op" id="7396761">(</span><span class="string" id="7396762">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="7396789">,</span>&nbsp;<span class="ident" id="7396791">i</span><span class="op" id="7396792">,</span>&nbsp;<span class="ident" id="7396794">addr</span><span class="op" id="7396798">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396803">}</span>&nbsp;<span class="keyword" id="7396805">else</span>&nbsp;<span class="op" id="7396810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396816">t</span><span class="op" id="7396817">.</span><span class="ident" id="7396818">Logf</span><span class="op" id="7396822">(</span><span class="string" id="7396823">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="7396885">,</span>&nbsp;<span class="ident" id="7396887">i</span><span class="op" id="7396888">,</span>&nbsp;<span class="ident" id="7396890">addr</span><span class="op" id="7396894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7396904">c</span><span class="op" id="7396905">.</span><span class="ident" id="7396906">Close</span><span class="op" id="7396911">(</span><span class="op" id="7396912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396916">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7396919">}</span><br>
<span class="lineno"></span><span class="op" id="7396921">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7396924">var</span>&nbsp;<span class="ident" id="7396928">runErrorTest</span>&nbsp;<span class="op" id="7396941">=</span>&nbsp;<span class="ident" id="7396943">flag</span><span class="op" id="7396947">.</span><span class="ident" id="7396948">Bool</span><span class="op" id="7396952">(</span><span class="string" id="7396953">&#34;run_error_test&#34;</span><span class="op" id="7396969">,</span>&nbsp;<span class="ident" id="7396971">false</span><span class="op" id="7396976">,</span>&nbsp;<span class="string" id="7396978">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="7397018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="7397021">type</span>&nbsp;<span class="ident" id="7397026">DialErrorTest</span>&nbsp;<span class="keyword" id="7397040">struct</span>&nbsp;<span class="op" id="7397047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397050">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7397058">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397066">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7397074">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7397082">Pattern</span>&nbsp;<span class="builtintype" id="7397090">string</span><br>
<span class="lineno"></span><span class="op" id="7397097">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="7397100">var</span>&nbsp;<span class="ident" id="7397104">dialErrorTests</span>&nbsp;<span class="op" id="7397119">=</span>&nbsp;<span class="op" id="7397121">[</span><span class="op" id="7397122">]</span><span class="ident" id="7397123">DialErrorTest</span><span class="op" id="7397136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397143">&#34;datakit&#34;</span><span class="op" id="7397152">,</span>&nbsp;<span class="string" id="7397154">&#34;mh/astro/r70&#34;</span><span class="op" id="7397168">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397172">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="7397224">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397227">}</span><span class="op" id="7397228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397235">&#34;tcp&#34;</span><span class="op" id="7397240">,</span>&nbsp;<span class="string" id="7397242">&#34;127.0.0.1:☺&#34;</span><span class="op" id="7397257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397261">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="7397307">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397310">}</span><span class="op" id="7397311">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397318">&#34;tcp&#34;</span><span class="op" id="7397323">,</span>&nbsp;<span class="string" id="7397325">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="7397354">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397358">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7397447">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397450">}</span><span class="op" id="7397451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397454">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397458">&#34;tcp&#34;</span><span class="op" id="7397463">,</span>&nbsp;<span class="string" id="7397465">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="7397508">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397512">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="7397629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397632">}</span><span class="op" id="7397633">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397640">&#34;tcp&#34;</span><span class="op" id="7397645">,</span>&nbsp;<span class="string" id="7397647">&#34;no-such-name:80&#34;</span><span class="op" id="7397664">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397668">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="7397742">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397745">}</span><span class="op" id="7397746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397753">&#34;tcp&#34;</span><span class="op" id="7397758">,</span>&nbsp;<span class="string" id="7397760">&#34;mh/astro/r70:http&#34;</span><span class="op" id="7397779">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397783">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="7397853">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397856">}</span><span class="op" id="7397857">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397864">&#34;unix&#34;</span><span class="op" id="7397870">,</span>&nbsp;<span class="string" id="7397872">&#34;/etc/file-not-found&#34;</span><span class="op" id="7397893">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397897">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7397955">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397958">}</span><span class="op" id="7397959">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7397962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397966">&#34;unix&#34;</span><span class="op" id="7397972">,</span>&nbsp;<span class="string" id="7397974">&#34;/etc/&#34;</span><span class="op" id="7397981">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7397985">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7398073">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398076">}</span><span class="op" id="7398077">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398080">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7398084">&#34;unixpacket&#34;</span><span class="op" id="7398096">,</span>&nbsp;<span class="string" id="7398098">&#34;/etc/file-not-found&#34;</span><span class="op" id="7398119">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7398123">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="7398187">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398190">}</span><span class="op" id="7398191">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7398198">&#34;unixpacket&#34;</span><span class="op" id="7398210">,</span>&nbsp;<span class="string" id="7398212">&#34;/etc/&#34;</span><span class="op" id="7398219">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7398223">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="7398317">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398320">}</span><span class="op" id="7398321">,</span><br>
<span class="lineno"></span><span class="op" id="7398323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7398326">var</span>&nbsp;<span class="ident" id="7398330">duplicateErrorPattern</span>&nbsp;<span class="op" id="7398352">=</span>&nbsp;<span class="string" id="7398354">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="7398377">func</span>&nbsp;<span class="ident" id="7398382">TestDialError</span><span class="op" id="7398395">(</span><span class="ident" id="7398396">t</span>&nbsp;<span class="op" id="7398398">*</span><span class="ident" id="7398399">testing</span><span class="op" id="7398406">.</span><span class="ident" id="7398407">T</span><span class="op" id="7398408">)</span>&nbsp;<span class="op" id="7398410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398413">if</span>&nbsp;<span class="op" id="7398416">!</span><span class="op" id="7398417">*</span><span class="ident" id="7398418">runErrorTest</span>&nbsp;<span class="op" id="7398431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398435">t</span><span class="op" id="7398436">.</span><span class="ident" id="7398437">Logf</span><span class="op" id="7398441">(</span><span class="string" id="7398442">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="7398488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398492">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398503">for</span>&nbsp;<span class="ident" id="7398507">i</span><span class="op" id="7398508">,</span>&nbsp;<span class="ident" id="7398510">tt</span>&nbsp;<span class="op" id="7398513">:=</span>&nbsp;<span class="keyword" id="7398516">range</span>&nbsp;<span class="ident" id="7398522">dialErrorTests</span>&nbsp;<span class="op" id="7398537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398541">c</span><span class="op" id="7398542">,</span>&nbsp;<span class="ident" id="7398544">err</span>&nbsp;<span class="op" id="7398548">:=</span>&nbsp;<span class="ident" id="7398551">Dial</span><span class="op" id="7398555">(</span><span class="ident" id="7398556">tt</span><span class="op" id="7398558">.</span><span class="ident" id="7398559">Net</span><span class="op" id="7398562">,</span>&nbsp;<span class="ident" id="7398564">tt</span><span class="op" id="7398566">.</span><span class="ident" id="7398567">Raddr</span><span class="op" id="7398572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398576">if</span>&nbsp;<span class="ident" id="7398579">c</span>&nbsp;<span class="op" id="7398581">!=</span>&nbsp;<span class="ident" id="7398584">nil</span>&nbsp;<span class="op" id="7398588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398593">c</span><span class="op" id="7398594">.</span><span class="ident" id="7398595">Close</span><span class="op" id="7398600">(</span><span class="op" id="7398601">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398609">if</span>&nbsp;<span class="ident" id="7398612">err</span>&nbsp;<span class="op" id="7398616">==</span>&nbsp;<span class="ident" id="7398619">nil</span>&nbsp;<span class="op" id="7398623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398628">t</span><span class="op" id="7398629">.</span><span class="ident" id="7398630">Errorf</span><span class="op" id="7398636">(</span><span class="string" id="7398637">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7398673">,</span>&nbsp;<span class="ident" id="7398675">i</span><span class="op" id="7398676">,</span>&nbsp;<span class="ident" id="7398678">tt</span><span class="op" id="7398680">.</span><span class="ident" id="7398681">Pattern</span><span class="op" id="7398688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398693">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398704">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398708">s</span>&nbsp;<span class="op" id="7398710">:=</span>&nbsp;<span class="ident" id="7398713">err</span><span class="op" id="7398716">.</span><span class="ident" id="7398717">Error</span><span class="op" id="7398722">(</span><span class="op" id="7398723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398727">match</span><span class="op" id="7398732">,</span>&nbsp;<span class="ident" id="7398734">_</span>&nbsp;<span class="op" id="7398736">:=</span>&nbsp;<span class="ident" id="7398739">regexp</span><span class="op" id="7398745">.</span><span class="ident" id="7398746">MatchString</span><span class="op" id="7398757">(</span><span class="ident" id="7398758">tt</span><span class="op" id="7398760">.</span><span class="ident" id="7398761">Pattern</span><span class="op" id="7398768">,</span>&nbsp;<span class="ident" id="7398770">s</span><span class="op" id="7398771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398775">if</span>&nbsp;<span class="op" id="7398778">!</span><span class="ident" id="7398779">match</span>&nbsp;<span class="op" id="7398785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398790">t</span><span class="op" id="7398791">.</span><span class="ident" id="7398792">Errorf</span><span class="op" id="7398798">(</span><span class="string" id="7398799">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="7398828">,</span>&nbsp;<span class="ident" id="7398830">i</span><span class="op" id="7398831">,</span>&nbsp;<span class="ident" id="7398833">s</span><span class="op" id="7398834">,</span>&nbsp;<span class="ident" id="7398836">tt</span><span class="op" id="7398838">.</span><span class="ident" id="7398839">Pattern</span><span class="op" id="7398846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398850">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398854">match</span><span class="op" id="7398859">,</span>&nbsp;<span class="ident" id="7398861">_</span>&nbsp;<span class="op" id="7398863">=</span>&nbsp;<span class="ident" id="7398865">regexp</span><span class="op" id="7398871">.</span><span class="ident" id="7398872">MatchString</span><span class="op" id="7398883">(</span><span class="ident" id="7398884">duplicateErrorPattern</span><span class="op" id="7398905">,</span>&nbsp;<span class="ident" id="7398907">s</span><span class="op" id="7398908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7398912">if</span>&nbsp;<span class="ident" id="7398915">match</span>&nbsp;<span class="op" id="7398921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7398926">t</span><span class="op" id="7398927">.</span><span class="ident" id="7398928">Errorf</span><span class="op" id="7398934">(</span><span class="string" id="7398935">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="7398978">,</span>&nbsp;<span class="ident" id="7398980">i</span><span class="op" id="7398981">,</span>&nbsp;<span class="ident" id="7398983">s</span><span class="op" id="7398984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7398991">}</span><br>
<span class="lineno">240</span><span class="op" id="7398993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7398996">var</span>&nbsp;<span class="ident" id="7399000">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7399029">=</span>&nbsp;<span class="op" id="7399031">[</span><span class="op" id="7399032">]</span><span class="keyword" id="7399033">struct</span>&nbsp;<span class="op" id="7399040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399043">net</span>&nbsp;&nbsp;<span class="builtintype" id="7399048">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399056">addr</span>&nbsp;<span class="builtintype" id="7399061">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399069">err</span>&nbsp;&nbsp;<span class="builtintype" id="7399074">error</span><br>
<span class="lineno"></span><span class="op" id="7399080">}</span><span class="op" id="7399081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399084">{</span><span class="string" id="7399085">&#34;foo&#34;</span><span class="op" id="7399090">,</span>&nbsp;<span class="string" id="7399092">&#34;bar&#34;</span><span class="op" id="7399097">,</span>&nbsp;<span class="op" id="7399099">&amp;</span><span class="ident" id="7399100">OpError</span><span class="op" id="7399107">{</span><span class="ident" id="7399108">Op</span><span class="op" id="7399110">:</span>&nbsp;<span class="string" id="7399112">&#34;dial&#34;</span><span class="op" id="7399118">,</span>&nbsp;<span class="ident" id="7399120">Net</span><span class="op" id="7399123">:</span>&nbsp;<span class="string" id="7399125">&#34;foo&#34;</span><span class="op" id="7399130">,</span>&nbsp;<span class="ident" id="7399132">Addr</span><span class="op" id="7399136">:</span>&nbsp;<span class="ident" id="7399138">nil</span><span class="op" id="7399141">,</span>&nbsp;<span class="ident" id="7399143">Err</span><span class="op" id="7399146">:</span>&nbsp;<span class="ident" id="7399148">UnknownNetworkError</span><span class="op" id="7399167">(</span><span class="string" id="7399168">&#34;foo&#34;</span><span class="op" id="7399173">)</span><span class="op" id="7399174">}</span><span class="op" id="7399175">}</span><span class="op" id="7399176">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399179">{</span><span class="string" id="7399180">&#34;baz&#34;</span><span class="op" id="7399185">,</span>&nbsp;<span class="string" id="7399187">&#34;&#34;</span><span class="op" id="7399189">,</span>&nbsp;<span class="op" id="7399191">&amp;</span><span class="ident" id="7399192">OpError</span><span class="op" id="7399199">{</span><span class="ident" id="7399200">Op</span><span class="op" id="7399202">:</span>&nbsp;<span class="string" id="7399204">&#34;listen&#34;</span><span class="op" id="7399212">,</span>&nbsp;<span class="ident" id="7399214">Net</span><span class="op" id="7399217">:</span>&nbsp;<span class="string" id="7399219">&#34;baz&#34;</span><span class="op" id="7399224">,</span>&nbsp;<span class="ident" id="7399226">Addr</span><span class="op" id="7399230">:</span>&nbsp;<span class="ident" id="7399232">nil</span><span class="op" id="7399235">,</span>&nbsp;<span class="ident" id="7399237">Err</span><span class="op" id="7399240">:</span>&nbsp;<span class="ident" id="7399242">UnknownNetworkError</span><span class="op" id="7399261">(</span><span class="string" id="7399262">&#34;baz&#34;</span><span class="op" id="7399267">)</span><span class="op" id="7399268">}</span><span class="op" id="7399269">}</span><span class="op" id="7399270">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399273">{</span><span class="string" id="7399274">&#34;tcp&#34;</span><span class="op" id="7399279">,</span>&nbsp;<span class="string" id="7399281">&#34;&#34;</span><span class="op" id="7399283">,</span>&nbsp;<span class="op" id="7399285">&amp;</span><span class="ident" id="7399286">OpError</span><span class="op" id="7399293">{</span><span class="ident" id="7399294">Op</span><span class="op" id="7399296">:</span>&nbsp;<span class="string" id="7399298">&#34;dial&#34;</span><span class="op" id="7399304">,</span>&nbsp;<span class="ident" id="7399306">Net</span><span class="op" id="7399309">:</span>&nbsp;<span class="string" id="7399311">&#34;tcp&#34;</span><span class="op" id="7399316">,</span>&nbsp;<span class="ident" id="7399318">Addr</span><span class="op" id="7399322">:</span>&nbsp;<span class="ident" id="7399324">nil</span><span class="op" id="7399327">,</span>&nbsp;<span class="ident" id="7399329">Err</span><span class="op" id="7399332">:</span>&nbsp;<span class="ident" id="7399334">errMissingAddress</span><span class="op" id="7399351">}</span><span class="op" id="7399352">}</span><span class="op" id="7399353">,</span><br>
<span class="lineno">250</span><span class="op" id="7399355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7399358">func</span>&nbsp;<span class="ident" id="7399363">TestInvalidDialAndListenArgs</span><span class="op" id="7399391">(</span><span class="ident" id="7399392">t</span>&nbsp;<span class="op" id="7399394">*</span><span class="ident" id="7399395">testing</span><span class="op" id="7399402">.</span><span class="ident" id="7399403">T</span><span class="op" id="7399404">)</span>&nbsp;<span class="op" id="7399406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399409">for</span>&nbsp;<span class="ident" id="7399413">_</span><span class="op" id="7399414">,</span>&nbsp;<span class="ident" id="7399416">tt</span>&nbsp;<span class="op" id="7399419">:=</span>&nbsp;<span class="keyword" id="7399422">range</span>&nbsp;<span class="ident" id="7399428">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="7399457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399461">var</span>&nbsp;<span class="ident" id="7399465">err</span>&nbsp;<span class="builtintype" id="7399469">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399477">switch</span>&nbsp;<span class="ident" id="7399484">tt</span><span class="op" id="7399486">.</span><span class="ident" id="7399487">err</span><span class="op" id="7399490">.</span><span class="op" id="7399491">(</span><span class="op" id="7399492">*</span><span class="ident" id="7399493">OpError</span><span class="op" id="7399500">)</span><span class="op" id="7399501">.</span><span class="ident" id="7399502">Op</span>&nbsp;<span class="op" id="7399505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399509">case</span>&nbsp;<span class="string" id="7399514">&#34;dial&#34;</span><span class="op" id="7399520">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399525">_</span><span class="op" id="7399526">,</span>&nbsp;<span class="ident" id="7399528">err</span>&nbsp;<span class="op" id="7399532">=</span>&nbsp;<span class="ident" id="7399534">Dial</span><span class="op" id="7399538">(</span><span class="ident" id="7399539">tt</span><span class="op" id="7399541">.</span><span class="ident" id="7399542">net</span><span class="op" id="7399545">,</span>&nbsp;<span class="ident" id="7399547">tt</span><span class="op" id="7399549">.</span><span class="ident" id="7399550">addr</span><span class="op" id="7399554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399558">case</span>&nbsp;<span class="string" id="7399563">&#34;listen&#34;</span><span class="op" id="7399571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399576">_</span><span class="op" id="7399577">,</span>&nbsp;<span class="ident" id="7399579">err</span>&nbsp;<span class="op" id="7399583">=</span>&nbsp;<span class="ident" id="7399585">Listen</span><span class="op" id="7399591">(</span><span class="ident" id="7399592">tt</span><span class="op" id="7399594">.</span><span class="ident" id="7399595">net</span><span class="op" id="7399598">,</span>&nbsp;<span class="ident" id="7399600">tt</span><span class="op" id="7399602">.</span><span class="ident" id="7399603">addr</span><span class="op" id="7399607">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399615">if</span>&nbsp;<span class="op" id="7399618">!</span><span class="ident" id="7399619">reflect</span><span class="op" id="7399626">.</span><span class="ident" id="7399627">DeepEqual</span><span class="op" id="7399636">(</span><span class="ident" id="7399637">tt</span><span class="op" id="7399639">.</span><span class="ident" id="7399640">err</span><span class="op" id="7399643">,</span>&nbsp;<span class="ident" id="7399645">err</span><span class="op" id="7399648">)</span>&nbsp;<span class="op" id="7399650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399655">t</span><span class="op" id="7399656">.</span><span class="ident" id="7399657">Fatalf</span><span class="op" id="7399663">(</span><span class="string" id="7399664">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="7399687">,</span>&nbsp;<span class="ident" id="7399689">err</span><span class="op" id="7399692">,</span>&nbsp;<span class="ident" id="7399694">tt</span><span class="op" id="7399696">.</span><span class="ident" id="7399697">err</span><span class="op" id="7399700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399707">}</span><br>
<span class="lineno">265</span><span class="op" id="7399709">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7399712">func</span>&nbsp;<span class="ident" id="7399717">TestDialTimeoutFDLeak</span><span class="op" id="7399738">(</span><span class="ident" id="7399739">t</span>&nbsp;<span class="op" id="7399741">*</span><span class="ident" id="7399742">testing</span><span class="op" id="7399749">.</span><span class="ident" id="7399750">T</span><span class="op" id="7399751">)</span>&nbsp;<span class="op" id="7399753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399756">if</span>&nbsp;<span class="ident" id="7399759">runtime</span><span class="op" id="7399766">.</span><span class="ident" id="7399767">GOOS</span>&nbsp;<span class="op" id="7399772">!=</span>&nbsp;<span class="string" id="7399775">&#34;linux&#34;</span>&nbsp;<span class="op" id="7399783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7399787">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399832">t</span><span class="op" id="7399833">.</span><span class="ident" id="7399834">Skipf</span><span class="op" id="7399839">(</span><span class="string" id="7399840">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7399861">,</span>&nbsp;<span class="ident" id="7399863">runtime</span><span class="op" id="7399870">.</span><span class="ident" id="7399871">GOOS</span><span class="op" id="7399875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399882">ln</span>&nbsp;<span class="op" id="7399885">:=</span>&nbsp;<span class="ident" id="7399888">newLocalListener</span><span class="op" id="7399904">(</span><span class="ident" id="7399905">t</span><span class="op" id="7399906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399909">defer</span>&nbsp;<span class="ident" id="7399915">ln</span><span class="op" id="7399917">.</span><span class="ident" id="7399918">Close</span><span class="op" id="7399923">(</span><span class="op" id="7399924">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7399928">type</span>&nbsp;<span class="ident" id="7399933">connErr</span>&nbsp;<span class="keyword" id="7399941">struct</span>&nbsp;<span class="op" id="7399948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399952">conn</span>&nbsp;<span class="ident" id="7399957">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399964">err</span>&nbsp;&nbsp;<span class="builtintype" id="7399969">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7399976">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7399979">dials</span>&nbsp;<span class="op" id="7399985">:=</span>&nbsp;<span class="ident" id="7399988">listenerBacklog</span>&nbsp;<span class="op" id="7400004">+</span>&nbsp;<span class="num" id="7400006">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7400011">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400091">maxGoodConnect</span>&nbsp;<span class="op" id="7400106">:=</span>&nbsp;<span class="ident" id="7400109">listenerBacklog</span>&nbsp;<span class="op" id="7400125">+</span>&nbsp;<span class="ident" id="7400127">runtime</span><span class="op" id="7400134">.</span><span class="ident" id="7400135">NumCPU</span><span class="op" id="7400141">(</span><span class="op" id="7400142">)</span><span class="op" id="7400143">*</span><span class="num" id="7400144">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400148">resc</span>&nbsp;<span class="op" id="7400153">:=</span>&nbsp;<span class="builtinfunc" id="7400156">make</span><span class="op" id="7400160">(</span><span class="keyword" id="7400161">chan</span>&nbsp;<span class="ident" id="7400166">connErr</span><span class="op" id="7400173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400176">for</span>&nbsp;<span class="ident" id="7400180">i</span>&nbsp;<span class="op" id="7400182">:=</span>&nbsp;<span class="num" id="7400185">0</span><span class="op" id="7400186">;</span>&nbsp;<span class="ident" id="7400188">i</span>&nbsp;<span class="op" id="7400190">&lt;</span>&nbsp;<span class="ident" id="7400192">dials</span><span class="op" id="7400197">;</span>&nbsp;<span class="ident" id="7400199">i</span><span class="op" id="7400200">++</span>&nbsp;<span class="op" id="7400203">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400207">go</span>&nbsp;<span class="keyword" id="7400210">func</span><span class="op" id="7400214">(</span><span class="op" id="7400215">)</span>&nbsp;<span class="op" id="7400217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400222">conn</span><span class="op" id="7400226">,</span>&nbsp;<span class="ident" id="7400228">err</span>&nbsp;<span class="op" id="7400232">:=</span>&nbsp;<span class="ident" id="7400235">DialTimeout</span><span class="op" id="7400246">(</span><span class="string" id="7400247">&#34;tcp&#34;</span><span class="op" id="7400252">,</span>&nbsp;<span class="ident" id="7400254">ln</span><span class="op" id="7400256">.</span><span class="ident" id="7400257">Addr</span><span class="op" id="7400261">(</span><span class="op" id="7400262">)</span><span class="op" id="7400263">.</span><span class="ident" id="7400264">String</span><span class="op" id="7400270">(</span><span class="op" id="7400271">)</span><span class="op" id="7400272">,</span>&nbsp;<span class="num" id="7400274">500</span><span class="op" id="7400277">*</span><span class="ident" id="7400278">time</span><span class="op" id="7400282">.</span><span class="ident" id="7400283">Millisecond</span><span class="op" id="7400294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400299">resc</span>&nbsp;<span class="op" id="7400304">&lt;-</span>&nbsp;<span class="ident" id="7400307">connErr</span><span class="op" id="7400314">{</span><span class="ident" id="7400315">conn</span><span class="op" id="7400319">,</span>&nbsp;<span class="ident" id="7400321">err</span><span class="op" id="7400324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400328">}</span><span class="op" id="7400329">(</span><span class="op" id="7400330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400333">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400337">var</span>&nbsp;<span class="ident" id="7400341">firstErr</span>&nbsp;<span class="builtintype" id="7400350">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400358">var</span>&nbsp;<span class="ident" id="7400362">ngood</span>&nbsp;<span class="builtintype" id="7400368">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400373">var</span>&nbsp;<span class="ident" id="7400377">toClose</span>&nbsp;<span class="op" id="7400385">[</span><span class="op" id="7400386">]</span><span class="ident" id="7400387">io</span><span class="op" id="7400389">.</span><span class="ident" id="7400390">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400398">for</span>&nbsp;<span class="ident" id="7400402">i</span>&nbsp;<span class="op" id="7400404">:=</span>&nbsp;<span class="num" id="7400407">0</span><span class="op" id="7400408">;</span>&nbsp;<span class="ident" id="7400410">i</span>&nbsp;<span class="op" id="7400412">&lt;</span>&nbsp;<span class="ident" id="7400414">dials</span><span class="op" id="7400419">;</span>&nbsp;<span class="ident" id="7400421">i</span><span class="op" id="7400422">++</span>&nbsp;<span class="op" id="7400425">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400429">ce</span>&nbsp;<span class="op" id="7400432">:=</span>&nbsp;<span class="op" id="7400435">&lt;-</span><span class="ident" id="7400437">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400444">if</span>&nbsp;<span class="ident" id="7400447">ce</span><span class="op" id="7400449">.</span><span class="ident" id="7400450">err</span>&nbsp;<span class="op" id="7400454">==</span>&nbsp;<span class="ident" id="7400457">nil</span>&nbsp;<span class="op" id="7400461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400466">ngood</span><span class="op" id="7400471">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400477">if</span>&nbsp;<span class="ident" id="7400480">ngood</span>&nbsp;<span class="op" id="7400486">&gt;</span>&nbsp;<span class="ident" id="7400488">maxGoodConnect</span>&nbsp;<span class="op" id="7400503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400509">t</span><span class="op" id="7400510">.</span><span class="ident" id="7400511">Errorf</span><span class="op" id="7400517">(</span><span class="string" id="7400518">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="7400557">,</span>&nbsp;<span class="ident" id="7400559">ngood</span><span class="op" id="7400564">,</span>&nbsp;<span class="ident" id="7400566">maxGoodConnect</span><span class="op" id="7400580">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400590">toClose</span>&nbsp;<span class="op" id="7400598">=</span>&nbsp;<span class="builtinfunc" id="7400600">append</span><span class="op" id="7400606">(</span><span class="ident" id="7400607">toClose</span><span class="op" id="7400614">,</span>&nbsp;<span class="ident" id="7400616">ce</span><span class="op" id="7400618">.</span><span class="ident" id="7400619">conn</span><span class="op" id="7400623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400643">err</span>&nbsp;<span class="op" id="7400647">:=</span>&nbsp;<span class="ident" id="7400650">ce</span><span class="op" id="7400652">.</span><span class="ident" id="7400653">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400659">if</span>&nbsp;<span class="ident" id="7400662">firstErr</span>&nbsp;<span class="op" id="7400671">==</span>&nbsp;<span class="string" id="7400674">&#34;&#34;</span>&nbsp;<span class="op" id="7400677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400682">firstErr</span>&nbsp;<span class="op" id="7400691">=</span>&nbsp;<span class="ident" id="7400693">err</span><span class="op" id="7400696">.</span><span class="ident" id="7400697">Error</span><span class="op" id="7400702">(</span><span class="op" id="7400703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400707">}</span>&nbsp;<span class="keyword" id="7400709">else</span>&nbsp;<span class="keyword" id="7400714">if</span>&nbsp;<span class="ident" id="7400717">err</span><span class="op" id="7400720">.</span><span class="ident" id="7400721">Error</span><span class="op" id="7400726">(</span><span class="op" id="7400727">)</span>&nbsp;<span class="op" id="7400729">!=</span>&nbsp;<span class="ident" id="7400732">firstErr</span>&nbsp;<span class="op" id="7400741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400746">t</span><span class="op" id="7400747">.</span><span class="ident" id="7400748">Fatalf</span><span class="op" id="7400754">(</span><span class="string" id="7400755">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="7400813">,</span>&nbsp;<span class="ident" id="7400815">firstErr</span><span class="op" id="7400823">,</span>&nbsp;<span class="ident" id="7400825">err</span><span class="op" id="7400828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400832">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400838">for</span>&nbsp;<span class="ident" id="7400842">_</span><span class="op" id="7400843">,</span>&nbsp;<span class="ident" id="7400845">c</span>&nbsp;<span class="op" id="7400847">:=</span>&nbsp;<span class="keyword" id="7400850">range</span>&nbsp;<span class="ident" id="7400856">toClose</span>&nbsp;<span class="op" id="7400864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400868">c</span><span class="op" id="7400869">.</span><span class="ident" id="7400870">Close</span><span class="op" id="7400875">(</span><span class="op" id="7400876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400882">for</span>&nbsp;<span class="ident" id="7400886">i</span>&nbsp;<span class="op" id="7400888">:=</span>&nbsp;<span class="num" id="7400891">0</span><span class="op" id="7400892">;</span>&nbsp;<span class="ident" id="7400894">i</span>&nbsp;<span class="op" id="7400896">&lt;</span>&nbsp;<span class="num" id="7400898">100</span><span class="op" id="7400901">;</span>&nbsp;<span class="ident" id="7400903">i</span><span class="op" id="7400904">++</span>&nbsp;<span class="op" id="7400907">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400911">if</span>&nbsp;<span class="ident" id="7400914">got</span>&nbsp;<span class="op" id="7400918">:=</span>&nbsp;<span class="ident" id="7400921">numFD</span><span class="op" id="7400926">(</span><span class="op" id="7400927">)</span><span class="op" id="7400928">;</span>&nbsp;<span class="ident" id="7400930">got</span>&nbsp;<span class="op" id="7400934">&lt;</span>&nbsp;<span class="ident" id="7400936">dials</span>&nbsp;<span class="op" id="7400942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7400947">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7400966">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7400975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7400979">time</span><span class="op" id="7400983">.</span><span class="ident" id="7400984">Sleep</span><span class="op" id="7400989">(</span><span class="num" id="7400990">10</span>&nbsp;<span class="op" id="7400993">*</span>&nbsp;<span class="ident" id="7400995">time</span><span class="op" id="7400999">.</span><span class="ident" id="7401000">Millisecond</span><span class="op" id="7401011">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401017">if</span>&nbsp;<span class="ident" id="7401020">got</span>&nbsp;<span class="op" id="7401024">:=</span>&nbsp;<span class="ident" id="7401027">numFD</span><span class="op" id="7401032">(</span><span class="op" id="7401033">)</span><span class="op" id="7401034">;</span>&nbsp;<span class="ident" id="7401036">got</span>&nbsp;<span class="op" id="7401040">&gt;=</span>&nbsp;<span class="ident" id="7401043">dials</span>&nbsp;<span class="op" id="7401049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401053">t</span><span class="op" id="7401054">.</span><span class="ident" id="7401055">Errorf</span><span class="op" id="7401061">(</span><span class="string" id="7401062">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="7401104">,</span>&nbsp;<span class="ident" id="7401106">dials</span><span class="op" id="7401111">,</span>&nbsp;<span class="ident" id="7401113">got</span><span class="op" id="7401116">,</span>&nbsp;<span class="ident" id="7401118">dials</span><span class="op" id="7401123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401126">}</span><br>
<span class="lineno"></span><span class="op" id="7401128">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="7401131">func</span>&nbsp;<span class="ident" id="7401136">numTCP</span><span class="op" id="7401142">(</span><span class="op" id="7401143">)</span>&nbsp;<span class="op" id="7401145">(</span><span class="ident" id="7401146">ntcp</span><span class="op" id="7401150">,</span>&nbsp;<span class="ident" id="7401152">nopen</span><span class="op" id="7401157">,</span>&nbsp;<span class="ident" id="7401159">nclose</span>&nbsp;<span class="builtintype" id="7401166">int</span><span class="op" id="7401169">,</span>&nbsp;<span class="ident" id="7401171">err</span>&nbsp;<span class="builtintype" id="7401175">error</span><span class="op" id="7401180">)</span>&nbsp;<span class="op" id="7401182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401185">lsof</span><span class="op" id="7401189">,</span>&nbsp;<span class="ident" id="7401191">err</span>&nbsp;<span class="op" id="7401195">:=</span>&nbsp;<span class="ident" id="7401198">exec</span><span class="op" id="7401202">.</span><span class="ident" id="7401203">Command</span><span class="op" id="7401210">(</span><span class="string" id="7401211">&#34;lsof&#34;</span><span class="op" id="7401217">,</span>&nbsp;<span class="string" id="7401219">&#34;-n&#34;</span><span class="op" id="7401223">,</span>&nbsp;<span class="string" id="7401225">&#34;-p&#34;</span><span class="op" id="7401229">,</span>&nbsp;<span class="ident" id="7401231">strconv</span><span class="op" id="7401238">.</span><span class="ident" id="7401239">Itoa</span><span class="op" id="7401243">(</span><span class="ident" id="7401244">os</span><span class="op" id="7401246">.</span><span class="ident" id="7401247">Getpid</span><span class="op" id="7401253">(</span><span class="op" id="7401254">)</span><span class="op" id="7401255">)</span><span class="op" id="7401256">)</span><span class="op" id="7401257">.</span><span class="ident" id="7401258">Output</span><span class="op" id="7401264">(</span><span class="op" id="7401265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401268">if</span>&nbsp;<span class="ident" id="7401271">err</span>&nbsp;<span class="op" id="7401275">!=</span>&nbsp;<span class="ident" id="7401278">nil</span>&nbsp;<span class="op" id="7401282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401286">return</span>&nbsp;<span class="num" id="7401293">0</span><span class="op" id="7401294">,</span>&nbsp;<span class="num" id="7401296">0</span><span class="op" id="7401297">,</span>&nbsp;<span class="num" id="7401299">0</span><span class="op" id="7401300">,</span>&nbsp;<span class="ident" id="7401302">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401310">ntcp</span>&nbsp;<span class="op" id="7401315">+=</span>&nbsp;<span class="ident" id="7401318">bytes</span><span class="op" id="7401323">.</span><span class="ident" id="7401324">Count</span><span class="op" id="7401329">(</span><span class="ident" id="7401330">lsof</span><span class="op" id="7401334">,</span>&nbsp;<span class="op" id="7401336">[</span><span class="op" id="7401337">]</span><span class="builtintype" id="7401338">byte</span><span class="op" id="7401342">(</span><span class="string" id="7401343">&#34;TCP&#34;</span><span class="op" id="7401348">)</span><span class="op" id="7401349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401352">for</span>&nbsp;<span class="ident" id="7401356">_</span><span class="op" id="7401357">,</span>&nbsp;<span class="ident" id="7401359">state</span>&nbsp;<span class="op" id="7401365">:=</span>&nbsp;<span class="keyword" id="7401368">range</span>&nbsp;<span class="op" id="7401374">[</span><span class="op" id="7401375">]</span><span class="builtintype" id="7401376">string</span><span class="op" id="7401382">{</span><span class="string" id="7401383">&#34;LISTEN&#34;</span><span class="op" id="7401391">,</span>&nbsp;<span class="string" id="7401393">&#34;SYN_SENT&#34;</span><span class="op" id="7401403">,</span>&nbsp;<span class="string" id="7401405">&#34;SYN_RECEIVED&#34;</span><span class="op" id="7401419">,</span>&nbsp;<span class="string" id="7401421">&#34;ESTABLISHED&#34;</span><span class="op" id="7401434">}</span>&nbsp;<span class="op" id="7401436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401440">nopen</span>&nbsp;<span class="op" id="7401446">+=</span>&nbsp;<span class="ident" id="7401449">bytes</span><span class="op" id="7401454">.</span><span class="ident" id="7401455">Count</span><span class="op" id="7401460">(</span><span class="ident" id="7401461">lsof</span><span class="op" id="7401465">,</span>&nbsp;<span class="op" id="7401467">[</span><span class="op" id="7401468">]</span><span class="builtintype" id="7401469">byte</span><span class="op" id="7401473">(</span><span class="ident" id="7401474">state</span><span class="op" id="7401479">)</span><span class="op" id="7401480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401483">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401486">for</span>&nbsp;<span class="ident" id="7401490">_</span><span class="op" id="7401491">,</span>&nbsp;<span class="ident" id="7401493">state</span>&nbsp;<span class="op" id="7401499">:=</span>&nbsp;<span class="keyword" id="7401502">range</span>&nbsp;<span class="op" id="7401508">[</span><span class="op" id="7401509">]</span><span class="builtintype" id="7401510">string</span><span class="op" id="7401516">{</span><span class="string" id="7401517">&#34;CLOSED&#34;</span><span class="op" id="7401525">,</span>&nbsp;<span class="string" id="7401527">&#34;CLOSE_WAIT&#34;</span><span class="op" id="7401539">,</span>&nbsp;<span class="string" id="7401541">&#34;LAST_ACK&#34;</span><span class="op" id="7401551">,</span>&nbsp;<span class="string" id="7401553">&#34;FIN_WAIT_1&#34;</span><span class="op" id="7401565">,</span>&nbsp;<span class="string" id="7401567">&#34;FIN_WAIT_2&#34;</span><span class="op" id="7401579">,</span>&nbsp;<span class="string" id="7401581">&#34;CLOSING&#34;</span><span class="op" id="7401590">,</span>&nbsp;<span class="string" id="7401592">&#34;TIME_WAIT&#34;</span><span class="op" id="7401603">}</span>&nbsp;<span class="op" id="7401605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401609">nclose</span>&nbsp;<span class="op" id="7401616">+=</span>&nbsp;<span class="ident" id="7401619">bytes</span><span class="op" id="7401624">.</span><span class="ident" id="7401625">Count</span><span class="op" id="7401630">(</span><span class="ident" id="7401631">lsof</span><span class="op" id="7401635">,</span>&nbsp;<span class="op" id="7401637">[</span><span class="op" id="7401638">]</span><span class="builtintype" id="7401639">byte</span><span class="op" id="7401643">(</span><span class="ident" id="7401644">state</span><span class="op" id="7401649">)</span><span class="op" id="7401650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401656">return</span>&nbsp;<span class="ident" id="7401663">ntcp</span><span class="op" id="7401667">,</span>&nbsp;<span class="ident" id="7401669">nopen</span><span class="op" id="7401674">,</span>&nbsp;<span class="ident" id="7401676">nclose</span><span class="op" id="7401682">,</span>&nbsp;<span class="ident" id="7401684">nil</span><br>
<span class="lineno"></span><span class="op" id="7401688">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="7401691">func</span>&nbsp;<span class="ident" id="7401696">TestDialMultiFDLeak</span><span class="op" id="7401715">(</span><span class="ident" id="7401716">t</span>&nbsp;<span class="op" id="7401718">*</span><span class="ident" id="7401719">testing</span><span class="op" id="7401726">.</span><span class="ident" id="7401727">T</span><span class="op" id="7401728">)</span>&nbsp;<span class="op" id="7401730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401733">t</span><span class="op" id="7401734">.</span><span class="ident" id="7401735">Skip</span><span class="op" id="7401739">(</span><span class="string" id="7401740">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="7401776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401780">if</span>&nbsp;<span class="op" id="7401783">!</span><span class="ident" id="7401784">supportsIPv4</span>&nbsp;<span class="op" id="7401797">||</span>&nbsp;<span class="op" id="7401800">!</span><span class="ident" id="7401801">supportsIPv6</span>&nbsp;<span class="op" id="7401814">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401818">t</span><span class="op" id="7401819">.</span><span class="ident" id="7401820">Skip</span><span class="op" id="7401824">(</span><span class="string" id="7401825">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="7401861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7401868">halfDeadServer</span>&nbsp;<span class="op" id="7401883">:=</span>&nbsp;<span class="keyword" id="7401886">func</span><span class="op" id="7401890">(</span><span class="ident" id="7401891">dss</span>&nbsp;<span class="op" id="7401895">*</span><span class="ident" id="7401896">dualStackServer</span><span class="op" id="7401911">,</span>&nbsp;<span class="ident" id="7401913">ln</span>&nbsp;<span class="ident" id="7401916">Listener</span><span class="op" id="7401924">)</span>&nbsp;<span class="op" id="7401926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401930">for</span>&nbsp;<span class="op" id="7401934">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401939">if</span>&nbsp;<span class="ident" id="7401942">c</span><span class="op" id="7401943">,</span>&nbsp;<span class="ident" id="7401945">err</span>&nbsp;<span class="op" id="7401949">:=</span>&nbsp;<span class="ident" id="7401952">ln</span><span class="op" id="7401954">.</span><span class="ident" id="7401955">Accept</span><span class="op" id="7401961">(</span><span class="op" id="7401962">)</span><span class="op" id="7401963">;</span>&nbsp;<span class="ident" id="7401965">err</span>&nbsp;<span class="op" id="7401969">!=</span>&nbsp;<span class="ident" id="7401972">nil</span>&nbsp;<span class="op" id="7401976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7401982">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7401992">}</span>&nbsp;<span class="keyword" id="7401994">else</span>&nbsp;<span class="op" id="7401999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402005">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402038">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402081">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402094">dss</span><span class="op" id="7402097">.</span><span class="ident" id="7402098">putConn</span><span class="op" id="7402105">(</span><span class="ident" id="7402106">c</span><span class="op" id="7402107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402119">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402122">dss</span><span class="op" id="7402125">,</span>&nbsp;<span class="ident" id="7402127">err</span>&nbsp;<span class="op" id="7402131">:=</span>&nbsp;<span class="ident" id="7402134">newDualStackServer</span><span class="op" id="7402152">(</span><span class="op" id="7402153">[</span><span class="op" id="7402154">]</span><span class="ident" id="7402155">streamListener</span><span class="op" id="7402169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402173">{</span><span class="ident" id="7402174">net</span><span class="op" id="7402177">:</span>&nbsp;<span class="string" id="7402179">&#34;tcp4&#34;</span><span class="op" id="7402185">,</span>&nbsp;<span class="ident" id="7402187">addr</span><span class="op" id="7402191">:</span>&nbsp;<span class="string" id="7402193">&#34;127.0.0.1&#34;</span><span class="op" id="7402204">}</span><span class="op" id="7402205">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402209">{</span><span class="ident" id="7402210">net</span><span class="op" id="7402213">:</span>&nbsp;<span class="string" id="7402215">&#34;tcp6&#34;</span><span class="op" id="7402221">,</span>&nbsp;<span class="ident" id="7402223">addr</span><span class="op" id="7402227">:</span>&nbsp;<span class="string" id="7402229">&#34;[::1]&#34;</span><span class="op" id="7402236">}</span><span class="op" id="7402237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402240">}</span><span class="op" id="7402241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402244">if</span>&nbsp;<span class="ident" id="7402247">err</span>&nbsp;<span class="op" id="7402251">!=</span>&nbsp;<span class="ident" id="7402254">nil</span>&nbsp;<span class="op" id="7402258">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402262">t</span><span class="op" id="7402263">.</span><span class="ident" id="7402264">Fatalf</span><span class="op" id="7402270">(</span><span class="string" id="7402271">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7402302">,</span>&nbsp;<span class="ident" id="7402304">err</span><span class="op" id="7402307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402313">defer</span>&nbsp;<span class="ident" id="7402319">dss</span><span class="op" id="7402322">.</span><span class="ident" id="7402323">teardown</span><span class="op" id="7402331">(</span><span class="op" id="7402332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402335">if</span>&nbsp;<span class="ident" id="7402338">err</span>&nbsp;<span class="op" id="7402342">:=</span>&nbsp;<span class="ident" id="7402345">dss</span><span class="op" id="7402348">.</span><span class="ident" id="7402349">buildup</span><span class="op" id="7402356">(</span><span class="ident" id="7402357">halfDeadServer</span><span class="op" id="7402371">)</span><span class="op" id="7402372">;</span>&nbsp;<span class="ident" id="7402374">err</span>&nbsp;<span class="op" id="7402378">!=</span>&nbsp;<span class="ident" id="7402381">nil</span>&nbsp;<span class="op" id="7402385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402389">t</span><span class="op" id="7402390">.</span><span class="ident" id="7402391">Fatalf</span><span class="op" id="7402397">(</span><span class="string" id="7402398">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7402434">,</span>&nbsp;<span class="ident" id="7402436">err</span><span class="op" id="7402439">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402446">_</span><span class="op" id="7402447">,</span>&nbsp;<span class="ident" id="7402449">before</span><span class="op" id="7402455">,</span>&nbsp;<span class="ident" id="7402457">_</span><span class="op" id="7402458">,</span>&nbsp;<span class="ident" id="7402460">err</span>&nbsp;<span class="op" id="7402464">:=</span>&nbsp;<span class="ident" id="7402467">numTCP</span><span class="op" id="7402473">(</span><span class="op" id="7402474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402477">if</span>&nbsp;<span class="ident" id="7402480">err</span>&nbsp;<span class="op" id="7402484">!=</span>&nbsp;<span class="ident" id="7402487">nil</span>&nbsp;<span class="op" id="7402491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402495">t</span><span class="op" id="7402496">.</span><span class="ident" id="7402497">Skipf</span><span class="op" id="7402502">(</span><span class="string" id="7402503">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7402553">,</span>&nbsp;<span class="ident" id="7402555">err</span><span class="op" id="7402558">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7402565">var</span>&nbsp;<span class="ident" id="7402569">wg</span>&nbsp;<span class="ident" id="7402572">sync</span><span class="op" id="7402576">.</span><span class="ident" id="7402577">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402588">portnum</span><span class="op" id="7402595">,</span>&nbsp;<span class="ident" id="7402597">_</span><span class="op" id="7402598">,</span>&nbsp;<span class="ident" id="7402600">_</span>&nbsp;<span class="op" id="7402602">:=</span>&nbsp;<span class="ident" id="7402605">dtoi</span><span class="op" id="7402609">(</span><span class="ident" id="7402610">dss</span><span class="op" id="7402613">.</span><span class="ident" id="7402614">port</span><span class="op" id="7402618">,</span>&nbsp;<span class="num" id="7402620">0</span><span class="op" id="7402621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7402624">ras</span>&nbsp;<span class="op" id="7402628">:=</span>&nbsp;<span class="ident" id="7402631">addrList</span><span class="op" id="7402639">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402643">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402696">&amp;</span><span class="ident" id="7402697">TCPAddr</span><span class="op" id="7402704">{</span><span class="ident" id="7402705">IP</span><span class="op" id="7402707">:</span>&nbsp;<span class="ident" id="7402709">IPv4</span><span class="op" id="7402713">(</span><span class="num" id="7402714">198</span><span class="op" id="7402717">,</span>&nbsp;<span class="num" id="7402719">18</span><span class="op" id="7402721">,</span>&nbsp;<span class="num" id="7402723">0</span><span class="op" id="7402724">,</span>&nbsp;<span class="num" id="7402726">254</span><span class="op" id="7402729">)</span><span class="op" id="7402730">,</span>&nbsp;<span class="ident" id="7402732">Port</span><span class="op" id="7402736">:</span>&nbsp;<span class="ident" id="7402738">portnum</span><span class="op" id="7402745">}</span><span class="op" id="7402746">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402750">&amp;</span><span class="ident" id="7402751">TCPAddr</span><span class="op" id="7402758">{</span><span class="ident" id="7402759">IP</span><span class="op" id="7402761">:</span>&nbsp;<span class="ident" id="7402763">ParseIP</span><span class="op" id="7402770">(</span><span class="string" id="7402771">&#34;2001:2::254&#34;</span><span class="op" id="7402784">)</span><span class="op" id="7402785">,</span>&nbsp;<span class="ident" id="7402787">Port</span><span class="op" id="7402791">:</span>&nbsp;<span class="ident" id="7402793">portnum</span><span class="op" id="7402800">}</span><span class="op" id="7402801">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402806">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402843">&amp;</span><span class="ident" id="7402844">TCPAddr</span><span class="op" id="7402851">{</span><span class="ident" id="7402852">IP</span><span class="op" id="7402854">:</span>&nbsp;<span class="ident" id="7402856">IPv4</span><span class="op" id="7402860">(</span><span class="num" id="7402861">127</span><span class="op" id="7402864">,</span>&nbsp;<span class="num" id="7402866">0</span><span class="op" id="7402867">,</span>&nbsp;<span class="num" id="7402869">0</span><span class="op" id="7402870">,</span>&nbsp;<span class="num" id="7402872">1</span><span class="op" id="7402873">)</span><span class="op" id="7402874">,</span>&nbsp;<span class="ident" id="7402876">Port</span><span class="op" id="7402880">:</span>&nbsp;<span class="ident" id="7402882">portnum</span><span class="op" id="7402889">}</span><span class="op" id="7402890">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402894">&amp;</span><span class="ident" id="7402895">TCPAddr</span><span class="op" id="7402902">{</span><span class="ident" id="7402903">IP</span><span class="op" id="7402905">:</span>&nbsp;<span class="ident" id="7402907">IPv6loopback</span><span class="op" id="7402919">,</span>&nbsp;<span class="ident" id="7402921">Port</span><span class="op" id="7402925">:</span>&nbsp;<span class="ident" id="7402927">portnum</span><span class="op" id="7402934">}</span><span class="op" id="7402935">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7402940">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7402992">&amp;</span><span class="ident" id="7402993">TCPAddr</span><span class="op" id="7403000">{</span><span class="ident" id="7403001">IP</span><span class="op" id="7403003">:</span>&nbsp;<span class="ident" id="7403005">IPv4</span><span class="op" id="7403009">(</span><span class="num" id="7403010">127</span><span class="op" id="7403013">,</span>&nbsp;<span class="num" id="7403015">0</span><span class="op" id="7403016">,</span>&nbsp;<span class="num" id="7403018">0</span><span class="op" id="7403019">,</span>&nbsp;<span class="num" id="7403021">1</span><span class="op" id="7403022">)</span><span class="op" id="7403023">,</span>&nbsp;<span class="ident" id="7403025">Port</span><span class="op" id="7403029">:</span>&nbsp;<span class="ident" id="7403031">portnum</span><span class="op" id="7403038">}</span><span class="op" id="7403039">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403043">&amp;</span><span class="ident" id="7403044">TCPAddr</span><span class="op" id="7403051">{</span><span class="ident" id="7403052">IP</span><span class="op" id="7403054">:</span>&nbsp;<span class="ident" id="7403056">IPv6loopback</span><span class="op" id="7403068">,</span>&nbsp;<span class="ident" id="7403070">Port</span><span class="op" id="7403074">:</span>&nbsp;<span class="ident" id="7403076">portnum</span><span class="op" id="7403083">}</span><span class="op" id="7403084">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403090">const</span>&nbsp;<span class="ident" id="7403096">T1</span>&nbsp;<span class="op" id="7403099">=</span>&nbsp;<span class="num" id="7403101">10</span>&nbsp;<span class="op" id="7403104">*</span>&nbsp;<span class="ident" id="7403106">time</span><span class="op" id="7403110">.</span><span class="ident" id="7403111">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403124">const</span>&nbsp;<span class="ident" id="7403130">T2</span>&nbsp;<span class="op" id="7403133">=</span>&nbsp;<span class="num" id="7403135">2</span>&nbsp;<span class="op" id="7403137">*</span>&nbsp;<span class="ident" id="7403139">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403143">const</span>&nbsp;<span class="ident" id="7403149">N</span>&nbsp;<span class="op" id="7403151">=</span>&nbsp;<span class="num" id="7403153">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403157">for</span>&nbsp;<span class="ident" id="7403161">i</span>&nbsp;<span class="op" id="7403163">:=</span>&nbsp;<span class="num" id="7403166">0</span><span class="op" id="7403167">;</span>&nbsp;<span class="ident" id="7403169">i</span>&nbsp;<span class="op" id="7403171">&lt;</span>&nbsp;<span class="ident" id="7403173">N</span><span class="op" id="7403174">;</span>&nbsp;<span class="ident" id="7403176">i</span><span class="op" id="7403177">++</span>&nbsp;<span class="op" id="7403180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403184">wg</span><span class="op" id="7403186">.</span><span class="ident" id="7403187">Add</span><span class="op" id="7403190">(</span><span class="num" id="7403191">1</span><span class="op" id="7403192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403196">go</span>&nbsp;<span class="keyword" id="7403199">func</span><span class="op" id="7403203">(</span><span class="op" id="7403204">)</span>&nbsp;<span class="op" id="7403206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403211">defer</span>&nbsp;<span class="ident" id="7403217">wg</span><span class="op" id="7403219">.</span><span class="ident" id="7403220">Done</span><span class="op" id="7403224">(</span><span class="op" id="7403225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403230">if</span>&nbsp;<span class="ident" id="7403233">c</span><span class="op" id="7403234">,</span>&nbsp;<span class="ident" id="7403236">err</span>&nbsp;<span class="op" id="7403240">:=</span>&nbsp;<span class="ident" id="7403243">dialMulti</span><span class="op" id="7403252">(</span><span class="string" id="7403253">&#34;tcp&#34;</span><span class="op" id="7403258">,</span>&nbsp;<span class="string" id="7403260">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="7403280">,</span>&nbsp;<span class="ident" id="7403282">nil</span><span class="op" id="7403285">,</span>&nbsp;<span class="ident" id="7403287">ras</span><span class="op" id="7403290">,</span>&nbsp;<span class="ident" id="7403292">time</span><span class="op" id="7403296">.</span><span class="ident" id="7403297">Now</span><span class="op" id="7403300">(</span><span class="op" id="7403301">)</span><span class="op" id="7403302">.</span><span class="ident" id="7403303">Add</span><span class="op" id="7403306">(</span><span class="ident" id="7403307">T1</span><span class="op" id="7403309">)</span><span class="op" id="7403310">)</span><span class="op" id="7403311">;</span>&nbsp;<span class="ident" id="7403313">err</span>&nbsp;<span class="op" id="7403317">==</span>&nbsp;<span class="ident" id="7403320">nil</span>&nbsp;<span class="op" id="7403324">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403330">c</span><span class="op" id="7403331">.</span><span class="ident" id="7403332">Close</span><span class="op" id="7403337">(</span><span class="op" id="7403338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403347">}</span><span class="op" id="7403348">(</span><span class="op" id="7403349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403355">wg</span><span class="op" id="7403357">.</span><span class="ident" id="7403358">Wait</span><span class="op" id="7403362">(</span><span class="op" id="7403363">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403366">time</span><span class="op" id="7403370">.</span><span class="ident" id="7403371">Sleep</span><span class="op" id="7403376">(</span><span class="ident" id="7403377">T2</span><span class="op" id="7403379">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403383">ntcp</span><span class="op" id="7403387">,</span>&nbsp;<span class="ident" id="7403389">after</span><span class="op" id="7403394">,</span>&nbsp;<span class="ident" id="7403396">nclose</span><span class="op" id="7403402">,</span>&nbsp;<span class="ident" id="7403404">err</span>&nbsp;<span class="op" id="7403408">:=</span>&nbsp;<span class="ident" id="7403411">numTCP</span><span class="op" id="7403417">(</span><span class="op" id="7403418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403421">if</span>&nbsp;<span class="ident" id="7403424">err</span>&nbsp;<span class="op" id="7403428">!=</span>&nbsp;<span class="ident" id="7403431">nil</span>&nbsp;<span class="op" id="7403435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403439">t</span><span class="op" id="7403440">.</span><span class="ident" id="7403441">Skipf</span><span class="op" id="7403446">(</span><span class="string" id="7403447">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="7403497">,</span>&nbsp;<span class="ident" id="7403499">err</span><span class="op" id="7403502">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403508">t</span><span class="op" id="7403509">.</span><span class="ident" id="7403510">Logf</span><span class="op" id="7403514">(</span><span class="string" id="7403515">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="7403574">,</span>&nbsp;<span class="ident" id="7403576">ntcp</span><span class="op" id="7403580">,</span>&nbsp;<span class="ident" id="7403582">after</span><span class="op" id="7403587">,</span>&nbsp;<span class="ident" id="7403589">nclose</span><span class="op" id="7403595">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403599">if</span>&nbsp;<span class="ident" id="7403602">after</span>&nbsp;<span class="op" id="7403608">!=</span>&nbsp;<span class="ident" id="7403611">before</span>&nbsp;<span class="op" id="7403618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403622">t</span><span class="op" id="7403623">.</span><span class="ident" id="7403624">Fatalf</span><span class="op" id="7403630">(</span><span class="string" id="7403631">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="7403666">,</span>&nbsp;<span class="ident" id="7403668">after</span><span class="op" id="7403673">,</span>&nbsp;<span class="ident" id="7403675">before</span><span class="op" id="7403681">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403684">}</span><br>
<span class="lineno"></span><span class="op" id="7403686">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7403689">func</span>&nbsp;<span class="ident" id="7403694">numFD</span><span class="op" id="7403699">(</span><span class="op" id="7403700">)</span>&nbsp;<span class="builtintype" id="7403702">int</span>&nbsp;<span class="op" id="7403706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403709">if</span>&nbsp;<span class="ident" id="7403712">runtime</span><span class="op" id="7403719">.</span><span class="ident" id="7403720">GOOS</span>&nbsp;<span class="op" id="7403725">==</span>&nbsp;<span class="string" id="7403728">&#34;linux&#34;</span>&nbsp;<span class="op" id="7403736">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403740">f</span><span class="op" id="7403741">,</span>&nbsp;<span class="ident" id="7403743">err</span>&nbsp;<span class="op" id="7403747">:=</span>&nbsp;<span class="ident" id="7403750">os</span><span class="op" id="7403752">.</span><span class="ident" id="7403753">Open</span><span class="op" id="7403757">(</span><span class="string" id="7403758">&#34;/proc/self/fd&#34;</span><span class="op" id="7403773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403777">if</span>&nbsp;<span class="ident" id="7403780">err</span>&nbsp;<span class="op" id="7403784">!=</span>&nbsp;<span class="ident" id="7403787">nil</span>&nbsp;<span class="op" id="7403791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7403796">panic</span><span class="op" id="7403801">(</span><span class="ident" id="7403802">err</span><span class="op" id="7403805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403813">defer</span>&nbsp;<span class="ident" id="7403819">f</span><span class="op" id="7403820">.</span><span class="ident" id="7403821">Close</span><span class="op" id="7403826">(</span><span class="op" id="7403827">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7403831">names</span><span class="op" id="7403836">,</span>&nbsp;<span class="ident" id="7403838">err</span>&nbsp;<span class="op" id="7403842">:=</span>&nbsp;<span class="ident" id="7403845">f</span><span class="op" id="7403846">.</span><span class="ident" id="7403847">Readdirnames</span><span class="op" id="7403859">(</span><span class="num" id="7403860">0</span><span class="op" id="7403861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403865">if</span>&nbsp;<span class="ident" id="7403868">err</span>&nbsp;<span class="op" id="7403872">!=</span>&nbsp;<span class="ident" id="7403875">nil</span>&nbsp;<span class="op" id="7403879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7403884">panic</span><span class="op" id="7403889">(</span><span class="ident" id="7403890">err</span><span class="op" id="7403893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7403901">return</span>&nbsp;<span class="builtinfunc" id="7403908">len</span><span class="op" id="7403911">(</span><span class="ident" id="7403912">names</span><span class="op" id="7403917">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7403920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7403923">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7403979">panic</span><span class="op" id="7403984">(</span><span class="string" id="7403985">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="7404014">+</span>&nbsp;<span class="ident" id="7404016">runtime</span><span class="op" id="7404023">.</span><span class="ident" id="7404024">GOOS</span><span class="op" id="7404028">)</span><br>
<span class="lineno"></span><span class="op" id="7404030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="7404033">func</span>&nbsp;<span class="ident" id="7404038">TestDialer</span><span class="op" id="7404048">(</span><span class="ident" id="7404049">t</span>&nbsp;<span class="op" id="7404051">*</span><span class="ident" id="7404052">testing</span><span class="op" id="7404059">.</span><span class="ident" id="7404060">T</span><span class="op" id="7404061">)</span>&nbsp;<span class="op" id="7404063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404066">ln</span><span class="op" id="7404068">,</span>&nbsp;<span class="ident" id="7404070">err</span>&nbsp;<span class="op" id="7404074">:=</span>&nbsp;<span class="ident" id="7404077">Listen</span><span class="op" id="7404083">(</span><span class="string" id="7404084">&#34;tcp4&#34;</span><span class="op" id="7404090">,</span>&nbsp;<span class="string" id="7404092">&#34;127.0.0.1:0&#34;</span><span class="op" id="7404105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404108">if</span>&nbsp;<span class="ident" id="7404111">err</span>&nbsp;<span class="op" id="7404115">!=</span>&nbsp;<span class="ident" id="7404118">nil</span>&nbsp;<span class="op" id="7404122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404126">t</span><span class="op" id="7404127">.</span><span class="ident" id="7404128">Fatalf</span><span class="op" id="7404134">(</span><span class="string" id="7404135">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7404154">,</span>&nbsp;<span class="ident" id="7404156">err</span><span class="op" id="7404159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404162">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404165">defer</span>&nbsp;<span class="ident" id="7404171">ln</span><span class="op" id="7404173">.</span><span class="ident" id="7404174">Close</span><span class="op" id="7404179">(</span><span class="op" id="7404180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404183">ch</span>&nbsp;<span class="op" id="7404186">:=</span>&nbsp;<span class="builtinfunc" id="7404189">make</span><span class="op" id="7404193">(</span><span class="keyword" id="7404194">chan</span>&nbsp;<span class="builtintype" id="7404199">error</span><span class="op" id="7404204">,</span>&nbsp;<span class="num" id="7404206">1</span><span class="op" id="7404207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404210">go</span>&nbsp;<span class="keyword" id="7404213">func</span><span class="op" id="7404217">(</span><span class="op" id="7404218">)</span>&nbsp;<span class="op" id="7404220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404224">c</span><span class="op" id="7404225">,</span>&nbsp;<span class="ident" id="7404227">err</span>&nbsp;<span class="op" id="7404231">:=</span>&nbsp;<span class="ident" id="7404234">ln</span><span class="op" id="7404236">.</span><span class="ident" id="7404237">Accept</span><span class="op" id="7404243">(</span><span class="op" id="7404244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404248">if</span>&nbsp;<span class="ident" id="7404251">err</span>&nbsp;<span class="op" id="7404255">!=</span>&nbsp;<span class="ident" id="7404258">nil</span>&nbsp;<span class="op" id="7404262">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404267">ch</span>&nbsp;<span class="op" id="7404270">&lt;-</span>&nbsp;<span class="ident" id="7404273">fmt</span><span class="op" id="7404276">.</span><span class="ident" id="7404277">Errorf</span><span class="op" id="7404283">(</span><span class="string" id="7404284">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7404303">,</span>&nbsp;<span class="ident" id="7404305">err</span><span class="op" id="7404308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404313">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404326">defer</span>&nbsp;<span class="ident" id="7404332">c</span><span class="op" id="7404333">.</span><span class="ident" id="7404334">Close</span><span class="op" id="7404339">(</span><span class="op" id="7404340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404344">ch</span>&nbsp;<span class="op" id="7404347">&lt;-</span>&nbsp;<span class="ident" id="7404350">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404355">}</span><span class="op" id="7404356">(</span><span class="op" id="7404357">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404361">laddr</span><span class="op" id="7404366">,</span>&nbsp;<span class="ident" id="7404368">err</span>&nbsp;<span class="op" id="7404372">:=</span>&nbsp;<span class="ident" id="7404375">ResolveTCPAddr</span><span class="op" id="7404389">(</span><span class="string" id="7404390">&#34;tcp4&#34;</span><span class="op" id="7404396">,</span>&nbsp;<span class="string" id="7404398">&#34;127.0.0.1:0&#34;</span><span class="op" id="7404411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404414">if</span>&nbsp;<span class="ident" id="7404417">err</span>&nbsp;<span class="op" id="7404421">!=</span>&nbsp;<span class="ident" id="7404424">nil</span>&nbsp;<span class="op" id="7404428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404432">t</span><span class="op" id="7404433">.</span><span class="ident" id="7404434">Fatalf</span><span class="op" id="7404440">(</span><span class="string" id="7404441">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7404468">,</span>&nbsp;<span class="ident" id="7404470">err</span><span class="op" id="7404473">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404479">d</span>&nbsp;<span class="op" id="7404481">:=</span>&nbsp;<span class="op" id="7404484">&amp;</span><span class="ident" id="7404485">Dialer</span><span class="op" id="7404491">{</span><span class="ident" id="7404492">LocalAddr</span><span class="op" id="7404501">:</span>&nbsp;<span class="ident" id="7404503">laddr</span><span class="op" id="7404508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404511">c</span><span class="op" id="7404512">,</span>&nbsp;<span class="ident" id="7404514">err</span>&nbsp;<span class="op" id="7404518">:=</span>&nbsp;<span class="ident" id="7404521">d</span><span class="op" id="7404522">.</span><span class="ident" id="7404523">Dial</span><span class="op" id="7404527">(</span><span class="string" id="7404528">&#34;tcp4&#34;</span><span class="op" id="7404534">,</span>&nbsp;<span class="ident" id="7404536">ln</span><span class="op" id="7404538">.</span><span class="ident" id="7404539">Addr</span><span class="op" id="7404543">(</span><span class="op" id="7404544">)</span><span class="op" id="7404545">.</span><span class="ident" id="7404546">String</span><span class="op" id="7404552">(</span><span class="op" id="7404553">)</span><span class="op" id="7404554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404557">if</span>&nbsp;<span class="ident" id="7404560">err</span>&nbsp;<span class="op" id="7404564">!=</span>&nbsp;<span class="ident" id="7404567">nil</span>&nbsp;<span class="op" id="7404571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404575">t</span><span class="op" id="7404576">.</span><span class="ident" id="7404577">Fatalf</span><span class="op" id="7404583">(</span><span class="string" id="7404584">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7404601">,</span>&nbsp;<span class="ident" id="7404603">err</span><span class="op" id="7404606">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404612">defer</span>&nbsp;<span class="ident" id="7404618">c</span><span class="op" id="7404619">.</span><span class="ident" id="7404620">Close</span><span class="op" id="7404625">(</span><span class="op" id="7404626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404629">c</span><span class="op" id="7404630">.</span><span class="ident" id="7404631">Read</span><span class="op" id="7404635">(</span><span class="builtinfunc" id="7404636">make</span><span class="op" id="7404640">(</span><span class="op" id="7404641">[</span><span class="op" id="7404642">]</span><span class="builtintype" id="7404643">byte</span><span class="op" id="7404647">,</span>&nbsp;<span class="num" id="7404649">1</span><span class="op" id="7404650">)</span><span class="op" id="7404651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404654">err</span>&nbsp;<span class="op" id="7404658">=</span>&nbsp;<span class="op" id="7404660">&lt;-</span><span class="ident" id="7404662">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404666">if</span>&nbsp;<span class="ident" id="7404669">err</span>&nbsp;<span class="op" id="7404673">!=</span>&nbsp;<span class="ident" id="7404676">nil</span>&nbsp;<span class="op" id="7404680">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404684">t</span><span class="op" id="7404685">.</span><span class="ident" id="7404686">Error</span><span class="op" id="7404691">(</span><span class="ident" id="7404692">err</span><span class="op" id="7404695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404698">}</span><br>
<span class="lineno"></span><span class="op" id="7404700">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7404703">func</span>&nbsp;<span class="ident" id="7404708">TestDialDualStackLocalhost</span><span class="op" id="7404734">(</span><span class="ident" id="7404735">t</span>&nbsp;<span class="op" id="7404737">*</span><span class="ident" id="7404738">testing</span><span class="op" id="7404745">.</span><span class="ident" id="7404746">T</span><span class="op" id="7404747">)</span>&nbsp;<span class="op" id="7404749">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404752">switch</span>&nbsp;<span class="ident" id="7404759">runtime</span><span class="op" id="7404766">.</span><span class="ident" id="7404767">GOOS</span>&nbsp;<span class="op" id="7404772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404775">case</span>&nbsp;<span class="string" id="7404780">&#34;nacl&#34;</span><span class="op" id="7404786">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404790">t</span><span class="op" id="7404791">.</span><span class="ident" id="7404792">Skipf</span><span class="op" id="7404797">(</span><span class="string" id="7404798">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="7404819">,</span>&nbsp;<span class="ident" id="7404821">runtime</span><span class="op" id="7404828">.</span><span class="ident" id="7404829">GOOS</span><span class="op" id="7404833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7404840">if</span>&nbsp;<span class="ident" id="7404843">ips</span><span class="op" id="7404846">,</span>&nbsp;<span class="ident" id="7404848">err</span>&nbsp;<span class="op" id="7404852">:=</span>&nbsp;<span class="ident" id="7404855">LookupIP</span><span class="op" id="7404863">(</span><span class="string" id="7404864">&#34;localhost&#34;</span><span class="op" id="7404875">)</span><span class="op" id="7404876">;</span>&nbsp;<span class="ident" id="7404878">err</span>&nbsp;<span class="op" id="7404882">!=</span>&nbsp;<span class="ident" id="7404885">nil</span>&nbsp;<span class="op" id="7404889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404893">t</span><span class="op" id="7404894">.</span><span class="ident" id="7404895">Fatalf</span><span class="op" id="7404901">(</span><span class="string" id="7404902">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7404923">,</span>&nbsp;<span class="ident" id="7404925">err</span><span class="op" id="7404928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7404931">}</span>&nbsp;<span class="keyword" id="7404933">else</span>&nbsp;<span class="keyword" id="7404938">if</span>&nbsp;<span class="builtinfunc" id="7404941">len</span><span class="op" id="7404944">(</span><span class="ident" id="7404945">ips</span><span class="op" id="7404948">)</span>&nbsp;<span class="op" id="7404950">&lt;</span>&nbsp;<span class="num" id="7404952">2</span>&nbsp;<span class="op" id="7404954">||</span>&nbsp;<span class="op" id="7404957">!</span><span class="ident" id="7404958">supportsIPv4</span>&nbsp;<span class="op" id="7404971">||</span>&nbsp;<span class="op" id="7404974">!</span><span class="ident" id="7404975">supportsIPv6</span>&nbsp;<span class="op" id="7404988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7404992">t</span><span class="op" id="7404993">.</span><span class="ident" id="7404994">Skip</span><span class="op" id="7404998">(</span><span class="string" id="7404999">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="7405071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405074">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405078">touchAndByeServer</span>&nbsp;<span class="op" id="7405096">:=</span>&nbsp;<span class="keyword" id="7405099">func</span><span class="op" id="7405103">(</span><span class="ident" id="7405104">dss</span>&nbsp;<span class="op" id="7405108">*</span><span class="ident" id="7405109">dualStackServer</span><span class="op" id="7405124">,</span>&nbsp;<span class="ident" id="7405126">ln</span>&nbsp;<span class="ident" id="7405129">Listener</span><span class="op" id="7405137">)</span>&nbsp;<span class="op" id="7405139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405143">for</span>&nbsp;<span class="op" id="7405147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405152">if</span>&nbsp;<span class="ident" id="7405155">c</span><span class="op" id="7405156">,</span>&nbsp;<span class="ident" id="7405158">err</span>&nbsp;<span class="op" id="7405162">:=</span>&nbsp;<span class="ident" id="7405165">ln</span><span class="op" id="7405167">.</span><span class="ident" id="7405168">Accept</span><span class="op" id="7405174">(</span><span class="op" id="7405175">)</span><span class="op" id="7405176">;</span>&nbsp;<span class="ident" id="7405178">err</span>&nbsp;<span class="op" id="7405182">!=</span>&nbsp;<span class="ident" id="7405185">nil</span>&nbsp;<span class="op" id="7405189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405195">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405205">}</span>&nbsp;<span class="keyword" id="7405207">else</span>&nbsp;<span class="op" id="7405212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405218">c</span><span class="op" id="7405219">.</span><span class="ident" id="7405220">Close</span><span class="op" id="7405225">(</span><span class="op" id="7405226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405238">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405241">dss</span><span class="op" id="7405244">,</span>&nbsp;<span class="ident" id="7405246">err</span>&nbsp;<span class="op" id="7405250">:=</span>&nbsp;<span class="ident" id="7405253">newDualStackServer</span><span class="op" id="7405271">(</span><span class="op" id="7405272">[</span><span class="op" id="7405273">]</span><span class="ident" id="7405274">streamListener</span><span class="op" id="7405288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405292">{</span><span class="ident" id="7405293">net</span><span class="op" id="7405296">:</span>&nbsp;<span class="string" id="7405298">&#34;tcp4&#34;</span><span class="op" id="7405304">,</span>&nbsp;<span class="ident" id="7405306">addr</span><span class="op" id="7405310">:</span>&nbsp;<span class="string" id="7405312">&#34;127.0.0.1&#34;</span><span class="op" id="7405323">}</span><span class="op" id="7405324">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405328">{</span><span class="ident" id="7405329">net</span><span class="op" id="7405332">:</span>&nbsp;<span class="string" id="7405334">&#34;tcp6&#34;</span><span class="op" id="7405340">,</span>&nbsp;<span class="ident" id="7405342">addr</span><span class="op" id="7405346">:</span>&nbsp;<span class="string" id="7405348">&#34;[::1]&#34;</span><span class="op" id="7405355">}</span><span class="op" id="7405356">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405359">}</span><span class="op" id="7405360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405363">if</span>&nbsp;<span class="ident" id="7405366">err</span>&nbsp;<span class="op" id="7405370">!=</span>&nbsp;<span class="ident" id="7405373">nil</span>&nbsp;<span class="op" id="7405377">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405381">t</span><span class="op" id="7405382">.</span><span class="ident" id="7405383">Fatalf</span><span class="op" id="7405389">(</span><span class="string" id="7405390">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7405421">,</span>&nbsp;<span class="ident" id="7405423">err</span><span class="op" id="7405426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405432">defer</span>&nbsp;<span class="ident" id="7405438">dss</span><span class="op" id="7405441">.</span><span class="ident" id="7405442">teardown</span><span class="op" id="7405450">(</span><span class="op" id="7405451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405454">if</span>&nbsp;<span class="ident" id="7405457">err</span>&nbsp;<span class="op" id="7405461">:=</span>&nbsp;<span class="ident" id="7405464">dss</span><span class="op" id="7405467">.</span><span class="ident" id="7405468">buildup</span><span class="op" id="7405475">(</span><span class="ident" id="7405476">touchAndByeServer</span><span class="op" id="7405493">)</span><span class="op" id="7405494">;</span>&nbsp;<span class="ident" id="7405496">err</span>&nbsp;<span class="op" id="7405500">!=</span>&nbsp;<span class="ident" id="7405503">nil</span>&nbsp;<span class="op" id="7405507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405511">t</span><span class="op" id="7405512">.</span><span class="ident" id="7405513">Fatalf</span><span class="op" id="7405519">(</span><span class="string" id="7405520">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7405556">,</span>&nbsp;<span class="ident" id="7405558">err</span><span class="op" id="7405561">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405568">d</span>&nbsp;<span class="op" id="7405570">:=</span>&nbsp;<span class="op" id="7405573">&amp;</span><span class="ident" id="7405574">Dialer</span><span class="op" id="7405580">{</span><span class="ident" id="7405581">DualStack</span><span class="op" id="7405590">:</span>&nbsp;<span class="ident" id="7405592">true</span><span class="op" id="7405596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405599">for</span>&nbsp;<span class="keyword" id="7405603">range</span>&nbsp;<span class="ident" id="7405609">dss</span><span class="op" id="7405612">.</span><span class="ident" id="7405613">lns</span>&nbsp;<span class="op" id="7405617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405621">if</span>&nbsp;<span class="ident" id="7405624">c</span><span class="op" id="7405625">,</span>&nbsp;<span class="ident" id="7405627">err</span>&nbsp;<span class="op" id="7405631">:=</span>&nbsp;<span class="ident" id="7405634">d</span><span class="op" id="7405635">.</span><span class="ident" id="7405636">Dial</span><span class="op" id="7405640">(</span><span class="string" id="7405641">&#34;tcp&#34;</span><span class="op" id="7405646">,</span>&nbsp;<span class="string" id="7405648">&#34;localhost:&#34;</span><span class="op" id="7405660">+</span><span class="ident" id="7405661">dss</span><span class="op" id="7405664">.</span><span class="ident" id="7405665">port</span><span class="op" id="7405669">)</span><span class="op" id="7405670">;</span>&nbsp;<span class="ident" id="7405672">err</span>&nbsp;<span class="op" id="7405676">!=</span>&nbsp;<span class="ident" id="7405679">nil</span>&nbsp;<span class="op" id="7405683">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405688">t</span><span class="op" id="7405689">.</span><span class="ident" id="7405690">Errorf</span><span class="op" id="7405696">(</span><span class="string" id="7405697">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7405714">,</span>&nbsp;<span class="ident" id="7405716">err</span><span class="op" id="7405719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405723">}</span>&nbsp;<span class="keyword" id="7405725">else</span>&nbsp;<span class="op" id="7405730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7405735">if</span>&nbsp;<span class="ident" id="7405738">addr</span>&nbsp;<span class="op" id="7405743">:=</span>&nbsp;<span class="ident" id="7405746">c</span><span class="op" id="7405747">.</span><span class="ident" id="7405748">LocalAddr</span><span class="op" id="7405757">(</span><span class="op" id="7405758">)</span><span class="op" id="7405759">.</span><span class="op" id="7405760">(</span><span class="op" id="7405761">*</span><span class="ident" id="7405762">TCPAddr</span><span class="op" id="7405769">)</span><span class="op" id="7405770">;</span>&nbsp;<span class="ident" id="7405772">addr</span><span class="op" id="7405776">.</span><span class="ident" id="7405777">IP</span><span class="op" id="7405779">.</span><span class="ident" id="7405780">To4</span><span class="op" id="7405783">(</span><span class="op" id="7405784">)</span>&nbsp;<span class="op" id="7405786">!=</span>&nbsp;<span class="ident" id="7405789">nil</span>&nbsp;<span class="op" id="7405793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405799">dss</span><span class="op" id="7405802">.</span><span class="ident" id="7405803">teardownNetwork</span><span class="op" id="7405818">(</span><span class="string" id="7405819">&#34;tcp4&#34;</span><span class="op" id="7405825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405830">}</span>&nbsp;<span class="keyword" id="7405832">else</span>&nbsp;<span class="keyword" id="7405837">if</span>&nbsp;<span class="ident" id="7405840">addr</span><span class="op" id="7405844">.</span><span class="ident" id="7405845">IP</span><span class="op" id="7405847">.</span><span class="ident" id="7405848">To16</span><span class="op" id="7405852">(</span><span class="op" id="7405853">)</span>&nbsp;<span class="op" id="7405855">!=</span>&nbsp;<span class="ident" id="7405858">nil</span>&nbsp;<span class="op" id="7405862">&amp;&amp;</span>&nbsp;<span class="ident" id="7405865">addr</span><span class="op" id="7405869">.</span><span class="ident" id="7405870">IP</span><span class="op" id="7405872">.</span><span class="ident" id="7405873">To4</span><span class="op" id="7405876">(</span><span class="op" id="7405877">)</span>&nbsp;<span class="op" id="7405879">==</span>&nbsp;<span class="ident" id="7405882">nil</span>&nbsp;<span class="op" id="7405886">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405892">dss</span><span class="op" id="7405895">.</span><span class="ident" id="7405896">teardownNetwork</span><span class="op" id="7405911">(</span><span class="string" id="7405912">&#34;tcp6&#34;</span><span class="op" id="7405918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405923">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405928">c</span><span class="op" id="7405929">.</span><span class="ident" id="7405930">Close</span><span class="op" id="7405935">(</span><span class="op" id="7405936">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7405943">}</span><br>
<span class="lineno">515</span><span class="op" id="7405945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7405948">func</span>&nbsp;<span class="ident" id="7405953">TestDialerKeepAlive</span><span class="op" id="7405972">(</span><span class="ident" id="7405973">t</span>&nbsp;<span class="op" id="7405975">*</span><span class="ident" id="7405976">testing</span><span class="op" id="7405983">.</span><span class="ident" id="7405984">T</span><span class="op" id="7405985">)</span>&nbsp;<span class="op" id="7405987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7405990">ln</span>&nbsp;<span class="op" id="7405993">:=</span>&nbsp;<span class="ident" id="7405996">newLocalListener</span><span class="op" id="7406012">(</span><span class="ident" id="7406013">t</span><span class="op" id="7406014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406017">defer</span>&nbsp;<span class="ident" id="7406023">ln</span><span class="op" id="7406025">.</span><span class="ident" id="7406026">Close</span><span class="op" id="7406031">(</span><span class="op" id="7406032">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406035">defer</span>&nbsp;<span class="keyword" id="7406041">func</span><span class="op" id="7406045">(</span><span class="op" id="7406046">)</span>&nbsp;<span class="op" id="7406048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406052">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7406073">=</span>&nbsp;<span class="keyword" id="7406075">func</span><span class="op" id="7406079">(</span><span class="op" id="7406080">)</span>&nbsp;<span class="op" id="7406082">{</span><span class="op" id="7406083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406086">}</span><span class="op" id="7406087">(</span><span class="op" id="7406088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406091">go</span>&nbsp;<span class="keyword" id="7406094">func</span><span class="op" id="7406098">(</span><span class="op" id="7406099">)</span>&nbsp;<span class="op" id="7406101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406105">for</span>&nbsp;<span class="op" id="7406109">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406114">c</span><span class="op" id="7406115">,</span>&nbsp;<span class="ident" id="7406117">err</span>&nbsp;<span class="op" id="7406121">:=</span>&nbsp;<span class="ident" id="7406124">ln</span><span class="op" id="7406126">.</span><span class="ident" id="7406127">Accept</span><span class="op" id="7406133">(</span><span class="op" id="7406134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406139">if</span>&nbsp;<span class="ident" id="7406142">err</span>&nbsp;<span class="op" id="7406146">!=</span>&nbsp;<span class="ident" id="7406149">nil</span>&nbsp;<span class="op" id="7406153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406159">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406174">c</span><span class="op" id="7406175">.</span><span class="ident" id="7406176">Close</span><span class="op" id="7406181">(</span><span class="op" id="7406182">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406189">}</span><span class="op" id="7406190">(</span><span class="op" id="7406191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406194">for</span>&nbsp;<span class="ident" id="7406198">_</span><span class="op" id="7406199">,</span>&nbsp;<span class="ident" id="7406201">keepAlive</span>&nbsp;<span class="op" id="7406211">:=</span>&nbsp;<span class="keyword" id="7406214">range</span>&nbsp;<span class="op" id="7406220">[</span><span class="op" id="7406221">]</span><span class="builtintype" id="7406222">bool</span><span class="op" id="7406226">{</span><span class="ident" id="7406227">false</span><span class="op" id="7406232">,</span>&nbsp;<span class="ident" id="7406234">true</span><span class="op" id="7406238">}</span>&nbsp;<span class="op" id="7406240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406244">got</span>&nbsp;<span class="op" id="7406248">:=</span>&nbsp;<span class="ident" id="7406251">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406259">testHookSetKeepAlive</span>&nbsp;<span class="op" id="7406280">=</span>&nbsp;<span class="keyword" id="7406282">func</span><span class="op" id="7406286">(</span><span class="op" id="7406287">)</span>&nbsp;<span class="op" id="7406289">{</span>&nbsp;<span class="ident" id="7406291">got</span>&nbsp;<span class="op" id="7406295">=</span>&nbsp;<span class="ident" id="7406297">true</span>&nbsp;<span class="op" id="7406302">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406306">var</span>&nbsp;<span class="ident" id="7406310">d</span>&nbsp;<span class="ident" id="7406312">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406321">if</span>&nbsp;<span class="ident" id="7406324">keepAlive</span>&nbsp;<span class="op" id="7406334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406339">d</span><span class="op" id="7406340">.</span><span class="ident" id="7406341">KeepAlive</span>&nbsp;<span class="op" id="7406351">=</span>&nbsp;<span class="num" id="7406353">30</span>&nbsp;<span class="op" id="7406356">*</span>&nbsp;<span class="ident" id="7406358">time</span><span class="op" id="7406362">.</span><span class="ident" id="7406363">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406376">c</span><span class="op" id="7406377">,</span>&nbsp;<span class="ident" id="7406379">err</span>&nbsp;<span class="op" id="7406383">:=</span>&nbsp;<span class="ident" id="7406386">d</span><span class="op" id="7406387">.</span><span class="ident" id="7406388">Dial</span><span class="op" id="7406392">(</span><span class="string" id="7406393">&#34;tcp&#34;</span><span class="op" id="7406398">,</span>&nbsp;<span class="ident" id="7406400">ln</span><span class="op" id="7406402">.</span><span class="ident" id="7406403">Addr</span><span class="op" id="7406407">(</span><span class="op" id="7406408">)</span><span class="op" id="7406409">.</span><span class="ident" id="7406410">String</span><span class="op" id="7406416">(</span><span class="op" id="7406417">)</span><span class="op" id="7406418">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406422">if</span>&nbsp;<span class="ident" id="7406425">err</span>&nbsp;<span class="op" id="7406429">!=</span>&nbsp;<span class="ident" id="7406432">nil</span>&nbsp;<span class="op" id="7406436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406441">t</span><span class="op" id="7406442">.</span><span class="ident" id="7406443">Fatal</span><span class="op" id="7406448">(</span><span class="ident" id="7406449">err</span><span class="op" id="7406452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406460">c</span><span class="op" id="7406461">.</span><span class="ident" id="7406462">Close</span><span class="op" id="7406467">(</span><span class="op" id="7406468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7406472">if</span>&nbsp;<span class="ident" id="7406475">got</span>&nbsp;<span class="op" id="7406479">!=</span>&nbsp;<span class="ident" id="7406482">keepAlive</span>&nbsp;<span class="op" id="7406492">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7406497">t</span><span class="op" id="7406498">.</span><span class="ident" id="7406499">Errorf</span><span class="op" id="7406505">(</span><span class="string" id="7406506">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7406564">,</span>&nbsp;<span class="ident" id="7406566">d</span><span class="op" id="7406567">.</span><span class="ident" id="7406568">KeepAlive</span><span class="op" id="7406577">,</span>&nbsp;<span class="ident" id="7406579">got</span><span class="op" id="7406582">,</span>&nbsp;<span class="op" id="7406584">!</span><span class="ident" id="7406585">got</span><span class="op" id="7406588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7406595">}</span><br>
<span class="lineno"></span><span class="op" id="7406597">}</span>
</div>
</body>
</html>
