<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html" class="current">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3841147">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3841202">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3841256">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3841307">package</span>&nbsp;<span class="ident" id="3841315">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3841320">import</span>&nbsp;<span class="op" id="3841327">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841330">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841340">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841356">&#34;crypto/elliptic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841375">&#34;crypto/md5&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841389">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841403">&#34;crypto/sha1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841418">&#34;crypto/sha256&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841435">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841450">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841467">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841477">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3841483">&#34;math/big&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3841494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3841497">var</span>&nbsp;<span class="ident" id="3841501">errClientKeyExchange</span>&nbsp;<span class="op" id="3841522">=</span>&nbsp;<span class="ident" id="3841524">errors</span><span class="op" id="3841530">.</span><span class="ident" id="3841531">New</span><span class="op" id="3841534">(</span><span class="string" id="3841535">&#34;tls:&nbsp;invalid&nbsp;ClientKeyExchange&nbsp;message&#34;</span><span class="op" id="3841575">)</span><br>
<span class="lineno"></span><span class="keyword" id="3841577">var</span>&nbsp;<span class="ident" id="3841581">errServerKeyExchange</span>&nbsp;<span class="op" id="3841602">=</span>&nbsp;<span class="ident" id="3841604">errors</span><span class="op" id="3841610">.</span><span class="ident" id="3841611">New</span><span class="op" id="3841614">(</span><span class="string" id="3841615">&#34;tls:&nbsp;invalid&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3841655">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3841658">//&nbsp;rsaKeyAgreement&nbsp;implements&nbsp;the&nbsp;standard&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;client</span><br>
<span class="lineno"></span><span class="comment" id="3841736">//&nbsp;encrypts&nbsp;the&nbsp;pre-master&nbsp;secret&nbsp;to&nbsp;the&nbsp;server&#39;s&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3841798">type</span>&nbsp;<span class="ident" id="3841803">rsaKeyAgreement</span>&nbsp;<span class="keyword" id="3841819">struct</span><span class="op" id="3841825">{</span><span class="op" id="3841826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3841829">func</span>&nbsp;<span class="op" id="3841834">(</span><span class="ident" id="3841835">ka</span>&nbsp;<span class="ident" id="3841838">rsaKeyAgreement</span><span class="op" id="3841853">)</span>&nbsp;<span class="ident" id="3841855">generateServerKeyExchange</span><span class="op" id="3841880">(</span><span class="ident" id="3841881">config</span>&nbsp;<span class="op" id="3841888">*</span><span class="ident" id="3841889">Config</span><span class="op" id="3841895">,</span>&nbsp;<span class="ident" id="3841897">cert</span>&nbsp;<span class="op" id="3841902">*</span><span class="ident" id="3841903">Certificate</span><span class="op" id="3841914">,</span>&nbsp;<span class="ident" id="3841916">clientHello</span>&nbsp;<span class="op" id="3841928">*</span><span class="ident" id="3841929">clientHelloMsg</span><span class="op" id="3841943">,</span>&nbsp;<span class="ident" id="3841945">hello</span>&nbsp;<span class="op" id="3841951">*</span><span class="ident" id="3841952">serverHelloMsg</span><span class="op" id="3841966">)</span>&nbsp;<span class="op" id="3841968">(</span><span class="op" id="3841969">*</span><span class="ident" id="3841970">serverKeyExchangeMsg</span><span class="op" id="3841990">,</span>&nbsp;<span class="builtintype" id="3841992">error</span><span class="op" id="3841997">)</span>&nbsp;<span class="op" id="3841999">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842002">return</span>&nbsp;<span class="builtintype" id="3842009">nil</span><span class="op" id="3842012">,</span>&nbsp;<span class="builtintype" id="3842014">nil</span><br>
<span class="lineno"></span><span class="op" id="3842018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3842021">func</span>&nbsp;<span class="op" id="3842026">(</span><span class="ident" id="3842027">ka</span>&nbsp;<span class="ident" id="3842030">rsaKeyAgreement</span><span class="op" id="3842045">)</span>&nbsp;<span class="ident" id="3842047">processClientKeyExchange</span><span class="op" id="3842071">(</span><span class="ident" id="3842072">config</span>&nbsp;<span class="op" id="3842079">*</span><span class="ident" id="3842080">Config</span><span class="op" id="3842086">,</span>&nbsp;<span class="ident" id="3842088">cert</span>&nbsp;<span class="op" id="3842093">*</span><span class="ident" id="3842094">Certificate</span><span class="op" id="3842105">,</span>&nbsp;<span class="ident" id="3842107">ckx</span>&nbsp;<span class="op" id="3842111">*</span><span class="ident" id="3842112">clientKeyExchangeMsg</span><span class="op" id="3842132">,</span>&nbsp;<span class="ident" id="3842134">version</span>&nbsp;<span class="builtintype" id="3842142">uint16</span><span class="op" id="3842148">)</span>&nbsp;<span class="op" id="3842150">(</span><span class="op" id="3842151">[</span><span class="op" id="3842152">]</span><span class="builtintype" id="3842153">byte</span><span class="op" id="3842157">,</span>&nbsp;<span class="builtintype" id="3842159">error</span><span class="op" id="3842164">)</span>&nbsp;<span class="op" id="3842166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842169">preMasterSecret</span>&nbsp;<span class="op" id="3842185">:=</span>&nbsp;<span class="builtinfunc" id="3842188">make</span><span class="op" id="3842192">(</span><span class="op" id="3842193">[</span><span class="op" id="3842194">]</span><span class="builtintype" id="3842195">byte</span><span class="op" id="3842199">,</span>&nbsp;<span class="num" id="3842201">48</span><span class="op" id="3842203">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842206">_</span><span class="op" id="3842207">,</span>&nbsp;<span class="ident" id="3842209">err</span>&nbsp;<span class="op" id="3842213">:=</span>&nbsp;<span class="ident" id="3842216">io</span><span class="op" id="3842218">.</span><span class="ident" id="3842219">ReadFull</span><span class="op" id="3842227">(</span><span class="ident" id="3842228">config</span><span class="op" id="3842234">.</span><span class="ident" id="3842235">rand</span><span class="op" id="3842239">(</span><span class="op" id="3842240">)</span><span class="op" id="3842241">,</span>&nbsp;<span class="ident" id="3842243">preMasterSecret</span><span class="op" id="3842258">[</span><span class="num" id="3842259">2</span><span class="op" id="3842260">:</span><span class="op" id="3842261">]</span><span class="op" id="3842262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842265">if</span>&nbsp;<span class="ident" id="3842268">err</span>&nbsp;<span class="op" id="3842272">!=</span>&nbsp;<span class="builtintype" id="3842275">nil</span>&nbsp;<span class="op" id="3842279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842283">return</span>&nbsp;<span class="builtintype" id="3842290">nil</span><span class="op" id="3842293">,</span>&nbsp;<span class="ident" id="3842295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842304">if</span>&nbsp;<span class="builtinfunc" id="3842307">len</span><span class="op" id="3842310">(</span><span class="ident" id="3842311">ckx</span><span class="op" id="3842314">.</span><span class="ident" id="3842315">ciphertext</span><span class="op" id="3842325">)</span>&nbsp;<span class="op" id="3842327">&lt;</span>&nbsp;<span class="num" id="3842329">2</span>&nbsp;<span class="op" id="3842331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842335">return</span>&nbsp;<span class="builtintype" id="3842342">nil</span><span class="op" id="3842345">,</span>&nbsp;<span class="ident" id="3842347">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842369">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842373">ciphertext</span>&nbsp;<span class="op" id="3842384">:=</span>&nbsp;<span class="ident" id="3842387">ckx</span><span class="op" id="3842390">.</span><span class="ident" id="3842391">ciphertext</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842403">if</span>&nbsp;<span class="ident" id="3842406">version</span>&nbsp;<span class="op" id="3842414">!=</span>&nbsp;<span class="ident" id="3842417">VersionSSL30</span>&nbsp;<span class="op" id="3842430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842434">ciphertextLen</span>&nbsp;<span class="op" id="3842448">:=</span>&nbsp;<span class="builtintype" id="3842451">int</span><span class="op" id="3842454">(</span><span class="ident" id="3842455">ckx</span><span class="op" id="3842458">.</span><span class="ident" id="3842459">ciphertext</span><span class="op" id="3842469">[</span><span class="num" id="3842470">0</span><span class="op" id="3842471">]</span><span class="op" id="3842472">)</span><span class="op" id="3842473">&lt;&lt;</span><span class="num" id="3842475">8</span>&nbsp;<span class="op" id="3842477">|</span>&nbsp;<span class="builtintype" id="3842479">int</span><span class="op" id="3842482">(</span><span class="ident" id="3842483">ckx</span><span class="op" id="3842486">.</span><span class="ident" id="3842487">ciphertext</span><span class="op" id="3842497">[</span><span class="num" id="3842498">1</span><span class="op" id="3842499">]</span><span class="op" id="3842500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842504">if</span>&nbsp;<span class="ident" id="3842507">ciphertextLen</span>&nbsp;<span class="op" id="3842521">!=</span>&nbsp;<span class="builtinfunc" id="3842524">len</span><span class="op" id="3842527">(</span><span class="ident" id="3842528">ckx</span><span class="op" id="3842531">.</span><span class="ident" id="3842532">ciphertext</span><span class="op" id="3842542">)</span><span class="op" id="3842543">-</span><span class="num" id="3842544">2</span>&nbsp;<span class="op" id="3842546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842551">return</span>&nbsp;<span class="builtintype" id="3842558">nil</span><span class="op" id="3842561">,</span>&nbsp;<span class="ident" id="3842563">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842586">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842590">ciphertext</span>&nbsp;<span class="op" id="3842601">=</span>&nbsp;<span class="ident" id="3842603">ckx</span><span class="op" id="3842606">.</span><span class="ident" id="3842607">ciphertext</span><span class="op" id="3842617">[</span><span class="num" id="3842618">2</span><span class="op" id="3842619">:</span><span class="op" id="3842620">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3842627">err</span>&nbsp;<span class="op" id="3842631">=</span>&nbsp;<span class="ident" id="3842633">rsa</span><span class="op" id="3842636">.</span><span class="ident" id="3842637">DecryptPKCS1v15SessionKey</span><span class="op" id="3842662">(</span><span class="ident" id="3842663">config</span><span class="op" id="3842669">.</span><span class="ident" id="3842670">rand</span><span class="op" id="3842674">(</span><span class="op" id="3842675">)</span><span class="op" id="3842676">,</span>&nbsp;<span class="ident" id="3842678">cert</span><span class="op" id="3842682">.</span><span class="ident" id="3842683">PrivateKey</span><span class="op" id="3842693">.</span><span class="op" id="3842694">(</span><span class="op" id="3842695">*</span><span class="ident" id="3842696">rsa</span><span class="op" id="3842699">.</span><span class="ident" id="3842700">PrivateKey</span><span class="op" id="3842710">)</span><span class="op" id="3842711">,</span>&nbsp;<span class="ident" id="3842713">ciphertext</span><span class="op" id="3842723">,</span>&nbsp;<span class="ident" id="3842725">preMasterSecret</span><span class="op" id="3842740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842743">if</span>&nbsp;<span class="ident" id="3842746">err</span>&nbsp;<span class="op" id="3842750">!=</span>&nbsp;<span class="builtintype" id="3842753">nil</span>&nbsp;<span class="op" id="3842757">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3842761">return</span>&nbsp;<span class="builtintype" id="3842768">nil</span><span class="op" id="3842771">,</span>&nbsp;<span class="ident" id="3842773">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3842778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842781">//&nbsp;We&nbsp;don&#39;t&nbsp;check&nbsp;the&nbsp;version&nbsp;number&nbsp;in&nbsp;the&nbsp;premaster&nbsp;secret.&nbsp;&nbsp;For&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842854">//&nbsp;by&nbsp;checking&nbsp;it,&nbsp;we&nbsp;would&nbsp;leak&nbsp;information&nbsp;about&nbsp;the&nbsp;validity&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842926">//&nbsp;encrypted&nbsp;pre-master&nbsp;secret.&nbsp;Secondly,&nbsp;it&nbsp;provides&nbsp;only&nbsp;a&nbsp;small</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3842994">//&nbsp;benefit&nbsp;against&nbsp;a&nbsp;downgrade&nbsp;attack&nbsp;and&nbsp;some&nbsp;implementations&nbsp;send&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3843067">//&nbsp;wrong&nbsp;version&nbsp;anyway.&nbsp;See&nbsp;the&nbsp;discussion&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;section</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3843134">//&nbsp;7.4.7.1&nbsp;of&nbsp;RFC&nbsp;4346.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843159">return</span>&nbsp;<span class="ident" id="3843166">preMasterSecret</span><span class="op" id="3843181">,</span>&nbsp;<span class="builtintype" id="3843183">nil</span><br>
<span class="lineno"></span><span class="op" id="3843187">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="3843190">func</span>&nbsp;<span class="op" id="3843195">(</span><span class="ident" id="3843196">ka</span>&nbsp;<span class="ident" id="3843199">rsaKeyAgreement</span><span class="op" id="3843214">)</span>&nbsp;<span class="ident" id="3843216">processServerKeyExchange</span><span class="op" id="3843240">(</span><span class="ident" id="3843241">config</span>&nbsp;<span class="op" id="3843248">*</span><span class="ident" id="3843249">Config</span><span class="op" id="3843255">,</span>&nbsp;<span class="ident" id="3843257">clientHello</span>&nbsp;<span class="op" id="3843269">*</span><span class="ident" id="3843270">clientHelloMsg</span><span class="op" id="3843284">,</span>&nbsp;<span class="ident" id="3843286">serverHello</span>&nbsp;<span class="op" id="3843298">*</span><span class="ident" id="3843299">serverHelloMsg</span><span class="op" id="3843313">,</span>&nbsp;<span class="ident" id="3843315">cert</span>&nbsp;<span class="op" id="3843320">*</span><span class="ident" id="3843321">x509</span><span class="op" id="3843325">.</span><span class="ident" id="3843326">Certificate</span><span class="op" id="3843337">,</span>&nbsp;<span class="ident" id="3843339">skx</span>&nbsp;<span class="op" id="3843343">*</span><span class="ident" id="3843344">serverKeyExchangeMsg</span><span class="op" id="3843364">)</span>&nbsp;<span class="builtintype" id="3843366">error</span>&nbsp;<span class="op" id="3843372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843375">return</span>&nbsp;<span class="ident" id="3843382">errors</span><span class="op" id="3843388">.</span><span class="ident" id="3843389">New</span><span class="op" id="3843392">(</span><span class="string" id="3843393">&#34;tls:&nbsp;unexpected&nbsp;ServerKeyExchange&#34;</span><span class="op" id="3843428">)</span><br>
<span class="lineno"></span><span class="op" id="3843430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3843433">func</span>&nbsp;<span class="op" id="3843438">(</span><span class="ident" id="3843439">ka</span>&nbsp;<span class="ident" id="3843442">rsaKeyAgreement</span><span class="op" id="3843457">)</span>&nbsp;<span class="ident" id="3843459">generateClientKeyExchange</span><span class="op" id="3843484">(</span><span class="ident" id="3843485">config</span>&nbsp;<span class="op" id="3843492">*</span><span class="ident" id="3843493">Config</span><span class="op" id="3843499">,</span>&nbsp;<span class="ident" id="3843501">clientHello</span>&nbsp;<span class="op" id="3843513">*</span><span class="ident" id="3843514">clientHelloMsg</span><span class="op" id="3843528">,</span>&nbsp;<span class="ident" id="3843530">cert</span>&nbsp;<span class="op" id="3843535">*</span><span class="ident" id="3843536">x509</span><span class="op" id="3843540">.</span><span class="ident" id="3843541">Certificate</span><span class="op" id="3843552">)</span>&nbsp;<span class="op" id="3843554">(</span><span class="op" id="3843555">[</span><span class="op" id="3843556">]</span><span class="builtintype" id="3843557">byte</span><span class="op" id="3843561">,</span>&nbsp;<span class="op" id="3843563">*</span><span class="ident" id="3843564">clientKeyExchangeMsg</span><span class="op" id="3843584">,</span>&nbsp;<span class="builtintype" id="3843586">error</span><span class="op" id="3843591">)</span>&nbsp;<span class="op" id="3843593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843596">preMasterSecret</span>&nbsp;<span class="op" id="3843612">:=</span>&nbsp;<span class="builtinfunc" id="3843615">make</span><span class="op" id="3843619">(</span><span class="op" id="3843620">[</span><span class="op" id="3843621">]</span><span class="builtintype" id="3843622">byte</span><span class="op" id="3843626">,</span>&nbsp;<span class="num" id="3843628">48</span><span class="op" id="3843630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843633">preMasterSecret</span><span class="op" id="3843648">[</span><span class="num" id="3843649">0</span><span class="op" id="3843650">]</span>&nbsp;<span class="op" id="3843652">=</span>&nbsp;<span class="builtintype" id="3843654">byte</span><span class="op" id="3843658">(</span><span class="ident" id="3843659">clientHello</span><span class="op" id="3843670">.</span><span class="ident" id="3843671">vers</span>&nbsp;<span class="op" id="3843676">&gt;&gt;</span>&nbsp;<span class="num" id="3843679">8</span><span class="op" id="3843680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843683">preMasterSecret</span><span class="op" id="3843698">[</span><span class="num" id="3843699">1</span><span class="op" id="3843700">]</span>&nbsp;<span class="op" id="3843702">=</span>&nbsp;<span class="builtintype" id="3843704">byte</span><span class="op" id="3843708">(</span><span class="ident" id="3843709">clientHello</span><span class="op" id="3843720">.</span><span class="ident" id="3843721">vers</span><span class="op" id="3843725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843728">_</span><span class="op" id="3843729">,</span>&nbsp;<span class="ident" id="3843731">err</span>&nbsp;<span class="op" id="3843735">:=</span>&nbsp;<span class="ident" id="3843738">io</span><span class="op" id="3843740">.</span><span class="ident" id="3843741">ReadFull</span><span class="op" id="3843749">(</span><span class="ident" id="3843750">config</span><span class="op" id="3843756">.</span><span class="ident" id="3843757">rand</span><span class="op" id="3843761">(</span><span class="op" id="3843762">)</span><span class="op" id="3843763">,</span>&nbsp;<span class="ident" id="3843765">preMasterSecret</span><span class="op" id="3843780">[</span><span class="num" id="3843781">2</span><span class="op" id="3843782">:</span><span class="op" id="3843783">]</span><span class="op" id="3843784">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843787">if</span>&nbsp;<span class="ident" id="3843790">err</span>&nbsp;<span class="op" id="3843794">!=</span>&nbsp;<span class="builtintype" id="3843797">nil</span>&nbsp;<span class="op" id="3843801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843805">return</span>&nbsp;<span class="builtintype" id="3843812">nil</span><span class="op" id="3843815">,</span>&nbsp;<span class="builtintype" id="3843817">nil</span><span class="op" id="3843820">,</span>&nbsp;<span class="ident" id="3843822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843831">encrypted</span><span class="op" id="3843840">,</span>&nbsp;<span class="ident" id="3843842">err</span>&nbsp;<span class="op" id="3843846">:=</span>&nbsp;<span class="ident" id="3843849">rsa</span><span class="op" id="3843852">.</span><span class="ident" id="3843853">EncryptPKCS1v15</span><span class="op" id="3843868">(</span><span class="ident" id="3843869">config</span><span class="op" id="3843875">.</span><span class="ident" id="3843876">rand</span><span class="op" id="3843880">(</span><span class="op" id="3843881">)</span><span class="op" id="3843882">,</span>&nbsp;<span class="ident" id="3843884">cert</span><span class="op" id="3843888">.</span><span class="ident" id="3843889">PublicKey</span><span class="op" id="3843898">.</span><span class="op" id="3843899">(</span><span class="op" id="3843900">*</span><span class="ident" id="3843901">rsa</span><span class="op" id="3843904">.</span><span class="ident" id="3843905">PublicKey</span><span class="op" id="3843914">)</span><span class="op" id="3843915">,</span>&nbsp;<span class="ident" id="3843917">preMasterSecret</span><span class="op" id="3843932">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843935">if</span>&nbsp;<span class="ident" id="3843938">err</span>&nbsp;<span class="op" id="3843942">!=</span>&nbsp;<span class="builtintype" id="3843945">nil</span>&nbsp;<span class="op" id="3843949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3843953">return</span>&nbsp;<span class="builtintype" id="3843960">nil</span><span class="op" id="3843963">,</span>&nbsp;<span class="builtintype" id="3843965">nil</span><span class="op" id="3843968">,</span>&nbsp;<span class="ident" id="3843970">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3843975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3843978">ckx</span>&nbsp;<span class="op" id="3843982">:=</span>&nbsp;<span class="builtinfunc" id="3843985">new</span><span class="op" id="3843988">(</span><span class="ident" id="3843989">clientKeyExchangeMsg</span><span class="op" id="3844009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844012">ckx</span><span class="op" id="3844015">.</span><span class="ident" id="3844016">ciphertext</span>&nbsp;<span class="op" id="3844027">=</span>&nbsp;<span class="builtinfunc" id="3844029">make</span><span class="op" id="3844033">(</span><span class="op" id="3844034">[</span><span class="op" id="3844035">]</span><span class="builtintype" id="3844036">byte</span><span class="op" id="3844040">,</span>&nbsp;<span class="builtinfunc" id="3844042">len</span><span class="op" id="3844045">(</span><span class="ident" id="3844046">encrypted</span><span class="op" id="3844055">)</span><span class="op" id="3844056">+</span><span class="num" id="3844057">2</span><span class="op" id="3844058">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844061">ckx</span><span class="op" id="3844064">.</span><span class="ident" id="3844065">ciphertext</span><span class="op" id="3844075">[</span><span class="num" id="3844076">0</span><span class="op" id="3844077">]</span>&nbsp;<span class="op" id="3844079">=</span>&nbsp;<span class="builtintype" id="3844081">byte</span><span class="op" id="3844085">(</span><span class="builtinfunc" id="3844086">len</span><span class="op" id="3844089">(</span><span class="ident" id="3844090">encrypted</span><span class="op" id="3844099">)</span>&nbsp;<span class="op" id="3844101">&gt;&gt;</span>&nbsp;<span class="num" id="3844104">8</span><span class="op" id="3844105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844108">ckx</span><span class="op" id="3844111">.</span><span class="ident" id="3844112">ciphertext</span><span class="op" id="3844122">[</span><span class="num" id="3844123">1</span><span class="op" id="3844124">]</span>&nbsp;<span class="op" id="3844126">=</span>&nbsp;<span class="builtintype" id="3844128">byte</span><span class="op" id="3844132">(</span><span class="builtinfunc" id="3844133">len</span><span class="op" id="3844136">(</span><span class="ident" id="3844137">encrypted</span><span class="op" id="3844146">)</span><span class="op" id="3844147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3844150">copy</span><span class="op" id="3844154">(</span><span class="ident" id="3844155">ckx</span><span class="op" id="3844158">.</span><span class="ident" id="3844159">ciphertext</span><span class="op" id="3844169">[</span><span class="num" id="3844170">2</span><span class="op" id="3844171">:</span><span class="op" id="3844172">]</span><span class="op" id="3844173">,</span>&nbsp;<span class="ident" id="3844175">encrypted</span><span class="op" id="3844184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844187">return</span>&nbsp;<span class="ident" id="3844194">preMasterSecret</span><span class="op" id="3844209">,</span>&nbsp;<span class="ident" id="3844211">ckx</span><span class="op" id="3844214">,</span>&nbsp;<span class="builtintype" id="3844216">nil</span><br>
<span class="lineno"></span><span class="op" id="3844220">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3844223">//&nbsp;sha1Hash&nbsp;calculates&nbsp;a&nbsp;SHA1&nbsp;hash&nbsp;over&nbsp;the&nbsp;given&nbsp;byte&nbsp;slices.</span><br>
<span class="lineno"></span><span class="keyword" id="3844286">func</span>&nbsp;<span class="ident" id="3844291">sha1Hash</span><span class="op" id="3844299">(</span><span class="ident" id="3844300">slices</span>&nbsp;<span class="op" id="3844307">[</span><span class="op" id="3844308">]</span><span class="op" id="3844309">[</span><span class="op" id="3844310">]</span><span class="builtintype" id="3844311">byte</span><span class="op" id="3844315">)</span>&nbsp;<span class="op" id="3844317">[</span><span class="op" id="3844318">]</span><span class="builtintype" id="3844319">byte</span>&nbsp;<span class="op" id="3844324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844327">hsha1</span>&nbsp;<span class="op" id="3844333">:=</span>&nbsp;<span class="ident" id="3844336">sha1</span><span class="op" id="3844340">.</span><span class="ident" id="3844341">New</span><span class="op" id="3844344">(</span><span class="op" id="3844345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844348">for</span>&nbsp;<span class="ident" id="3844352">_</span><span class="op" id="3844353">,</span>&nbsp;<span class="ident" id="3844355">slice</span>&nbsp;<span class="op" id="3844361">:=</span>&nbsp;<span class="keyword" id="3844364">range</span>&nbsp;<span class="ident" id="3844370">slices</span>&nbsp;<span class="op" id="3844377">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844381">hsha1</span><span class="op" id="3844386">.</span><span class="ident" id="3844387">Write</span><span class="op" id="3844392">(</span><span class="ident" id="3844393">slice</span><span class="op" id="3844398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3844401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844404">return</span>&nbsp;<span class="ident" id="3844411">hsha1</span><span class="op" id="3844416">.</span><span class="ident" id="3844417">Sum</span><span class="op" id="3844420">(</span><span class="builtintype" id="3844421">nil</span><span class="op" id="3844424">)</span><br>
<span class="lineno"></span><span class="op" id="3844426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="3844429">//&nbsp;md5SHA1Hash&nbsp;implements&nbsp;TLS&nbsp;1.0&#39;s&nbsp;hybrid&nbsp;hash&nbsp;function&nbsp;which&nbsp;consists&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3844508">//&nbsp;concatenation&nbsp;of&nbsp;an&nbsp;MD5&nbsp;and&nbsp;SHA1&nbsp;hash.</span><br>
<span class="lineno"></span><span class="keyword" id="3844550">func</span>&nbsp;<span class="ident" id="3844555">md5SHA1Hash</span><span class="op" id="3844566">(</span><span class="ident" id="3844567">slices</span>&nbsp;<span class="op" id="3844574">[</span><span class="op" id="3844575">]</span><span class="op" id="3844576">[</span><span class="op" id="3844577">]</span><span class="builtintype" id="3844578">byte</span><span class="op" id="3844582">)</span>&nbsp;<span class="op" id="3844584">[</span><span class="op" id="3844585">]</span><span class="builtintype" id="3844586">byte</span>&nbsp;<span class="op" id="3844591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844594">md5sha1</span>&nbsp;<span class="op" id="3844602">:=</span>&nbsp;<span class="builtinfunc" id="3844605">make</span><span class="op" id="3844609">(</span><span class="op" id="3844610">[</span><span class="op" id="3844611">]</span><span class="builtintype" id="3844612">byte</span><span class="op" id="3844616">,</span>&nbsp;<span class="ident" id="3844618">md5</span><span class="op" id="3844621">.</span><span class="ident" id="3844622">Size</span><span class="op" id="3844626">+</span><span class="ident" id="3844627">sha1</span><span class="op" id="3844631">.</span><span class="ident" id="3844632">Size</span><span class="op" id="3844636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844639">hmd5</span>&nbsp;<span class="op" id="3844644">:=</span>&nbsp;<span class="ident" id="3844647">md5</span><span class="op" id="3844650">.</span><span class="ident" id="3844651">New</span><span class="op" id="3844654">(</span><span class="op" id="3844655">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844658">for</span>&nbsp;<span class="ident" id="3844662">_</span><span class="op" id="3844663">,</span>&nbsp;<span class="ident" id="3844665">slice</span>&nbsp;<span class="op" id="3844671">:=</span>&nbsp;<span class="keyword" id="3844674">range</span>&nbsp;<span class="ident" id="3844680">slices</span>&nbsp;<span class="op" id="3844687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844691">hmd5</span><span class="op" id="3844695">.</span><span class="ident" id="3844696">Write</span><span class="op" id="3844701">(</span><span class="ident" id="3844702">slice</span><span class="op" id="3844707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3844710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3844713">copy</span><span class="op" id="3844717">(</span><span class="ident" id="3844718">md5sha1</span><span class="op" id="3844725">,</span>&nbsp;<span class="ident" id="3844727">hmd5</span><span class="op" id="3844731">.</span><span class="ident" id="3844732">Sum</span><span class="op" id="3844735">(</span><span class="builtintype" id="3844736">nil</span><span class="op" id="3844739">)</span><span class="op" id="3844740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3844743">copy</span><span class="op" id="3844747">(</span><span class="ident" id="3844748">md5sha1</span><span class="op" id="3844755">[</span><span class="ident" id="3844756">md5</span><span class="op" id="3844759">.</span><span class="ident" id="3844760">Size</span><span class="op" id="3844764">:</span><span class="op" id="3844765">]</span><span class="op" id="3844766">,</span>&nbsp;<span class="ident" id="3844768">sha1Hash</span><span class="op" id="3844776">(</span><span class="ident" id="3844777">slices</span><span class="op" id="3844783">)</span><span class="op" id="3844784">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844787">return</span>&nbsp;<span class="ident" id="3844794">md5sha1</span><br>
<span class="lineno"></span><span class="op" id="3844802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844805">//&nbsp;sha256Hash&nbsp;implements&nbsp;TLS&nbsp;1.2&#39;s&nbsp;hash&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3844855">func</span>&nbsp;<span class="ident" id="3844860">sha256Hash</span><span class="op" id="3844870">(</span><span class="ident" id="3844871">slices</span>&nbsp;<span class="op" id="3844878">[</span><span class="op" id="3844879">]</span><span class="op" id="3844880">[</span><span class="op" id="3844881">]</span><span class="builtintype" id="3844882">byte</span><span class="op" id="3844886">)</span>&nbsp;<span class="op" id="3844888">[</span><span class="op" id="3844889">]</span><span class="builtintype" id="3844890">byte</span>&nbsp;<span class="op" id="3844895">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844898">h</span>&nbsp;<span class="op" id="3844900">:=</span>&nbsp;<span class="ident" id="3844903">sha256</span><span class="op" id="3844909">.</span><span class="ident" id="3844910">New</span><span class="op" id="3844913">(</span><span class="op" id="3844914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844917">for</span>&nbsp;<span class="ident" id="3844921">_</span><span class="op" id="3844922">,</span>&nbsp;<span class="ident" id="3844924">slice</span>&nbsp;<span class="op" id="3844930">:=</span>&nbsp;<span class="keyword" id="3844933">range</span>&nbsp;<span class="ident" id="3844939">slices</span>&nbsp;<span class="op" id="3844946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3844950">h</span><span class="op" id="3844951">.</span><span class="ident" id="3844952">Write</span><span class="op" id="3844957">(</span><span class="ident" id="3844958">slice</span><span class="op" id="3844963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3844966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3844969">return</span>&nbsp;<span class="ident" id="3844976">h</span><span class="op" id="3844977">.</span><span class="ident" id="3844978">Sum</span><span class="op" id="3844981">(</span><span class="builtintype" id="3844982">nil</span><span class="op" id="3844985">)</span><br>
<span class="lineno">120</span><span class="op" id="3844987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3844990">//&nbsp;hashForServerKeyExchange&nbsp;hashes&nbsp;the&nbsp;given&nbsp;slices&nbsp;and&nbsp;returns&nbsp;their&nbsp;digest</span><br>
<span class="lineno"></span><span class="comment" id="3845067">//&nbsp;and&nbsp;the&nbsp;identifier&nbsp;of&nbsp;the&nbsp;hash&nbsp;function&nbsp;used.&nbsp;The&nbsp;hashFunc&nbsp;argument&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3845146">//&nbsp;used&nbsp;for&nbsp;&gt;=&nbsp;TLS&nbsp;1.2&nbsp;and&nbsp;precisely&nbsp;identifies&nbsp;the&nbsp;hash&nbsp;function&nbsp;to&nbsp;use.</span><br>
<span class="lineno">125</span><span class="keyword" id="3845220">func</span>&nbsp;<span class="ident" id="3845225">hashForServerKeyExchange</span><span class="op" id="3845249">(</span><span class="ident" id="3845250">sigType</span><span class="op" id="3845257">,</span>&nbsp;<span class="ident" id="3845259">hashFunc</span>&nbsp;<span class="builtintype" id="3845268">uint8</span><span class="op" id="3845273">,</span>&nbsp;<span class="ident" id="3845275">version</span>&nbsp;<span class="builtintype" id="3845283">uint16</span><span class="op" id="3845289">,</span>&nbsp;<span class="ident" id="3845291">slices</span>&nbsp;<span class="op" id="3845298">...</span><span class="op" id="3845301">[</span><span class="op" id="3845302">]</span><span class="builtintype" id="3845303">byte</span><span class="op" id="3845307">)</span>&nbsp;<span class="op" id="3845309">(</span><span class="op" id="3845310">[</span><span class="op" id="3845311">]</span><span class="builtintype" id="3845312">byte</span><span class="op" id="3845316">,</span>&nbsp;<span class="ident" id="3845318">crypto</span><span class="op" id="3845324">.</span><span class="ident" id="3845325">Hash</span><span class="op" id="3845329">,</span>&nbsp;<span class="builtintype" id="3845331">error</span><span class="op" id="3845336">)</span>&nbsp;<span class="op" id="3845338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845341">if</span>&nbsp;<span class="ident" id="3845344">version</span>&nbsp;<span class="op" id="3845352">&gt;=</span>&nbsp;<span class="ident" id="3845355">VersionTLS12</span>&nbsp;<span class="op" id="3845368">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845372">switch</span>&nbsp;<span class="ident" id="3845379">hashFunc</span>&nbsp;<span class="op" id="3845388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845392">case</span>&nbsp;<span class="ident" id="3845397">hashSHA256</span><span class="op" id="3845407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845412">return</span>&nbsp;<span class="ident" id="3845419">sha256Hash</span><span class="op" id="3845429">(</span><span class="ident" id="3845430">slices</span><span class="op" id="3845436">)</span><span class="op" id="3845437">,</span>&nbsp;<span class="ident" id="3845439">crypto</span><span class="op" id="3845445">.</span><span class="ident" id="3845446">SHA256</span><span class="op" id="3845452">,</span>&nbsp;<span class="builtintype" id="3845454">nil</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845460">case</span>&nbsp;<span class="ident" id="3845465">hashSHA1</span><span class="op" id="3845473">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845478">return</span>&nbsp;<span class="ident" id="3845485">sha1Hash</span><span class="op" id="3845493">(</span><span class="ident" id="3845494">slices</span><span class="op" id="3845500">)</span><span class="op" id="3845501">,</span>&nbsp;<span class="ident" id="3845503">crypto</span><span class="op" id="3845509">.</span><span class="ident" id="3845510">SHA1</span><span class="op" id="3845514">,</span>&nbsp;<span class="builtintype" id="3845516">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845522">default</span><span class="op" id="3845529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845534">return</span>&nbsp;<span class="builtintype" id="3845541">nil</span><span class="op" id="3845544">,</span>&nbsp;<span class="ident" id="3845546">crypto</span><span class="op" id="3845552">.</span><span class="ident" id="3845553">Hash</span><span class="op" id="3845557">(</span><span class="num" id="3845558">0</span><span class="op" id="3845559">)</span><span class="op" id="3845560">,</span>&nbsp;<span class="ident" id="3845562">errors</span><span class="op" id="3845568">.</span><span class="ident" id="3845569">New</span><span class="op" id="3845572">(</span><span class="string" id="3845573">&#34;tls:&nbsp;unknown&nbsp;hash&nbsp;function&nbsp;used&nbsp;by&nbsp;peer&#34;</span><span class="op" id="3845614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3845618">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3845621">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845624">if</span>&nbsp;<span class="ident" id="3845627">sigType</span>&nbsp;<span class="op" id="3845635">==</span>&nbsp;<span class="ident" id="3845638">signatureECDSA</span>&nbsp;<span class="op" id="3845653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845657">return</span>&nbsp;<span class="ident" id="3845664">sha1Hash</span><span class="op" id="3845672">(</span><span class="ident" id="3845673">slices</span><span class="op" id="3845679">)</span><span class="op" id="3845680">,</span>&nbsp;<span class="ident" id="3845682">crypto</span><span class="op" id="3845688">.</span><span class="ident" id="3845689">SHA1</span><span class="op" id="3845693">,</span>&nbsp;<span class="builtintype" id="3845695">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3845700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3845703">return</span>&nbsp;<span class="ident" id="3845710">md5SHA1Hash</span><span class="op" id="3845721">(</span><span class="ident" id="3845722">slices</span><span class="op" id="3845728">)</span><span class="op" id="3845729">,</span>&nbsp;<span class="ident" id="3845731">crypto</span><span class="op" id="3845737">.</span><span class="ident" id="3845738">MD5SHA1</span><span class="op" id="3845745">,</span>&nbsp;<span class="builtintype" id="3845747">nil</span><br>
<span class="lineno">140</span><span class="op" id="3845751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3845754">//&nbsp;pickTLS12HashForSignature&nbsp;returns&nbsp;a&nbsp;TLS&nbsp;1.2&nbsp;hash&nbsp;identifier&nbsp;for&nbsp;signing&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3845831">//&nbsp;ServerKeyExchange&nbsp;given&nbsp;the&nbsp;signature&nbsp;type&nbsp;being&nbsp;used&nbsp;and&nbsp;the&nbsp;client&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3845905">//&nbsp;advertised&nbsp;list&nbsp;of&nbsp;supported&nbsp;signature&nbsp;and&nbsp;hash&nbsp;combinations.</span><br>
<span class="lineno">145</span><span class="keyword" id="3845970">func</span>&nbsp;<span class="ident" id="3845975">pickTLS12HashForSignature</span><span class="op" id="3846000">(</span><span class="ident" id="3846001">sigType</span>&nbsp;<span class="builtintype" id="3846009">uint8</span><span class="op" id="3846014">,</span>&nbsp;<span class="ident" id="3846016">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3846041">[</span><span class="op" id="3846042">]</span><span class="ident" id="3846043">signatureAndHash</span><span class="op" id="3846059">)</span>&nbsp;<span class="op" id="3846061">(</span><span class="builtintype" id="3846062">uint8</span><span class="op" id="3846067">,</span>&nbsp;<span class="builtintype" id="3846069">error</span><span class="op" id="3846074">)</span>&nbsp;<span class="op" id="3846076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846079">if</span>&nbsp;<span class="builtinfunc" id="3846082">len</span><span class="op" id="3846085">(</span><span class="ident" id="3846086">clientSignatureAndHashes</span><span class="op" id="3846110">)</span>&nbsp;<span class="op" id="3846112">==</span>&nbsp;<span class="num" id="3846115">0</span>&nbsp;<span class="op" id="3846117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3846121">//&nbsp;If&nbsp;the&nbsp;client&nbsp;didn&#39;t&nbsp;specify&nbsp;any&nbsp;signature_algorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3846180">//&nbsp;extension&nbsp;then&nbsp;we&nbsp;can&nbsp;assume&nbsp;that&nbsp;it&nbsp;supports&nbsp;SHA1.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3846241">//&nbsp;http://tools.ietf.org/html/rfc5246#section-7.4.1.4.1</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846299">return</span>&nbsp;<span class="ident" id="3846306">hashSHA1</span><span class="op" id="3846314">,</span>&nbsp;<span class="builtintype" id="3846316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3846321">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846325">for</span>&nbsp;<span class="ident" id="3846329">_</span><span class="op" id="3846330">,</span>&nbsp;<span class="ident" id="3846332">sigAndHash</span>&nbsp;<span class="op" id="3846343">:=</span>&nbsp;<span class="keyword" id="3846346">range</span>&nbsp;<span class="ident" id="3846352">clientSignatureAndHashes</span>&nbsp;<span class="op" id="3846377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846381">if</span>&nbsp;<span class="ident" id="3846384">sigAndHash</span><span class="op" id="3846394">.</span><span class="ident" id="3846395">signature</span>&nbsp;<span class="op" id="3846405">!=</span>&nbsp;<span class="ident" id="3846408">sigType</span>&nbsp;<span class="op" id="3846416">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846421">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3846432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846436">switch</span>&nbsp;<span class="ident" id="3846443">sigAndHash</span><span class="op" id="3846453">.</span><span class="ident" id="3846454">hash</span>&nbsp;<span class="op" id="3846459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846463">case</span>&nbsp;<span class="ident" id="3846468">hashSHA1</span><span class="op" id="3846476">,</span>&nbsp;<span class="ident" id="3846478">hashSHA256</span><span class="op" id="3846488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846493">return</span>&nbsp;<span class="ident" id="3846500">sigAndHash</span><span class="op" id="3846510">.</span><span class="ident" id="3846511">hash</span><span class="op" id="3846515">,</span>&nbsp;<span class="builtintype" id="3846517">nil</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3846523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3846526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846530">return</span>&nbsp;<span class="num" id="3846537">0</span><span class="op" id="3846538">,</span>&nbsp;<span class="ident" id="3846540">errors</span><span class="op" id="3846546">.</span><span class="ident" id="3846547">New</span><span class="op" id="3846550">(</span><span class="string" id="3846551">&#34;tls:&nbsp;client&nbsp;doesn&#39;t&nbsp;support&nbsp;any&nbsp;common&nbsp;hash&nbsp;functions&#34;</span><span class="op" id="3846606">)</span><br>
<span class="lineno"></span><span class="op" id="3846608">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="3846611">func</span>&nbsp;<span class="ident" id="3846616">curveForCurveID</span><span class="op" id="3846631">(</span><span class="ident" id="3846632">id</span>&nbsp;<span class="ident" id="3846635">CurveID</span><span class="op" id="3846642">)</span>&nbsp;<span class="op" id="3846644">(</span><span class="ident" id="3846645">elliptic</span><span class="op" id="3846653">.</span><span class="ident" id="3846654">Curve</span><span class="op" id="3846659">,</span>&nbsp;<span class="builtintype" id="3846661">bool</span><span class="op" id="3846665">)</span>&nbsp;<span class="op" id="3846667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846670">switch</span>&nbsp;<span class="ident" id="3846677">id</span>&nbsp;<span class="op" id="3846680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846683">case</span>&nbsp;<span class="ident" id="3846688">CurveP256</span><span class="op" id="3846697">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846701">return</span>&nbsp;<span class="ident" id="3846708">elliptic</span><span class="op" id="3846716">.</span><span class="ident" id="3846717">P256</span><span class="op" id="3846721">(</span><span class="op" id="3846722">)</span><span class="op" id="3846723">,</span>&nbsp;<span class="builtintype" id="3846725">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846731">case</span>&nbsp;<span class="ident" id="3846736">CurveP384</span><span class="op" id="3846745">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846749">return</span>&nbsp;<span class="ident" id="3846756">elliptic</span><span class="op" id="3846764">.</span><span class="ident" id="3846765">P384</span><span class="op" id="3846769">(</span><span class="op" id="3846770">)</span><span class="op" id="3846771">,</span>&nbsp;<span class="builtintype" id="3846773">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846779">case</span>&nbsp;<span class="ident" id="3846784">CurveP521</span><span class="op" id="3846793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846797">return</span>&nbsp;<span class="ident" id="3846804">elliptic</span><span class="op" id="3846812">.</span><span class="ident" id="3846813">P521</span><span class="op" id="3846817">(</span><span class="op" id="3846818">)</span><span class="op" id="3846819">,</span>&nbsp;<span class="builtintype" id="3846821">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846827">default</span><span class="op" id="3846834">:</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3846838">return</span>&nbsp;<span class="builtintype" id="3846845">nil</span><span class="op" id="3846848">,</span>&nbsp;<span class="builtintype" id="3846850">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3846857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="op" id="3846860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="comment" id="3846863">//&nbsp;ecdheRSAKeyAgreement&nbsp;implements&nbsp;a&nbsp;TLS&nbsp;key&nbsp;agreement&nbsp;where&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="3846935">//&nbsp;generates&nbsp;a&nbsp;ephemeral&nbsp;EC&nbsp;public/private&nbsp;key&nbsp;pair&nbsp;and&nbsp;signs&nbsp;it.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="3847005">//&nbsp;pre-master&nbsp;secret&nbsp;is&nbsp;then&nbsp;calculated&nbsp;using&nbsp;ECDH.&nbsp;The&nbsp;signature&nbsp;may</span><br>
<span class="lineno"></span><span class="comment" id="3847075">//&nbsp;either&nbsp;be&nbsp;ECDSA&nbsp;or&nbsp;RSA.</span><br>
<span class="lineno"></span><span class="keyword" id="3847102">type</span>&nbsp;<span class="ident" id="3847107">ecdheKeyAgreement</span>&nbsp;<span class="keyword" id="3847125">struct</span>&nbsp;<span class="op" id="3847132">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847135">version</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3847146">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847154">sigType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3847165">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847172">privateKey</span>&nbsp;<span class="op" id="3847183">[</span><span class="op" id="3847184">]</span><span class="builtintype" id="3847185">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847191">curve</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847202">elliptic</span><span class="op" id="3847210">.</span><span class="ident" id="3847211">Curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847218">x</span><span class="op" id="3847219">,</span>&nbsp;<span class="ident" id="3847221">y</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847229">*</span><span class="ident" id="3847230">big</span><span class="op" id="3847233">.</span><span class="ident" id="3847234">Int</span><br>
<span class="lineno">190</span><span class="op" id="3847238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3847241">func</span>&nbsp;<span class="op" id="3847246">(</span><span class="ident" id="3847247">ka</span>&nbsp;<span class="op" id="3847250">*</span><span class="ident" id="3847251">ecdheKeyAgreement</span><span class="op" id="3847268">)</span>&nbsp;<span class="ident" id="3847270">generateServerKeyExchange</span><span class="op" id="3847295">(</span><span class="ident" id="3847296">config</span>&nbsp;<span class="op" id="3847303">*</span><span class="ident" id="3847304">Config</span><span class="op" id="3847310">,</span>&nbsp;<span class="ident" id="3847312">cert</span>&nbsp;<span class="op" id="3847317">*</span><span class="ident" id="3847318">Certificate</span><span class="op" id="3847329">,</span>&nbsp;<span class="ident" id="3847331">clientHello</span>&nbsp;<span class="op" id="3847343">*</span><span class="ident" id="3847344">clientHelloMsg</span><span class="op" id="3847358">,</span>&nbsp;<span class="ident" id="3847360">hello</span>&nbsp;<span class="op" id="3847366">*</span><span class="ident" id="3847367">serverHelloMsg</span><span class="op" id="3847381">)</span>&nbsp;<span class="op" id="3847383">(</span><span class="op" id="3847384">*</span><span class="ident" id="3847385">serverKeyExchangeMsg</span><span class="op" id="3847405">,</span>&nbsp;<span class="builtintype" id="3847407">error</span><span class="op" id="3847412">)</span>&nbsp;<span class="op" id="3847414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847417">var</span>&nbsp;<span class="ident" id="3847421">curveid</span>&nbsp;<span class="ident" id="3847429">CurveID</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847438">preferredCurves</span>&nbsp;<span class="op" id="3847454">:=</span>&nbsp;<span class="ident" id="3847457">config</span><span class="op" id="3847463">.</span><span class="ident" id="3847464">curvePreferences</span><span class="op" id="3847480">(</span><span class="op" id="3847481">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="ident" id="3847484">NextCandidate</span><span class="op" id="3847497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847500">for</span>&nbsp;<span class="ident" id="3847504">_</span><span class="op" id="3847505">,</span>&nbsp;<span class="ident" id="3847507">candidate</span>&nbsp;<span class="op" id="3847517">:=</span>&nbsp;<span class="keyword" id="3847520">range</span>&nbsp;<span class="ident" id="3847526">preferredCurves</span>&nbsp;<span class="op" id="3847542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847546">for</span>&nbsp;<span class="ident" id="3847550">_</span><span class="op" id="3847551">,</span>&nbsp;<span class="ident" id="3847553">c</span>&nbsp;<span class="op" id="3847555">:=</span>&nbsp;<span class="keyword" id="3847558">range</span>&nbsp;<span class="ident" id="3847564">clientHello</span><span class="op" id="3847575">.</span><span class="ident" id="3847576">supportedCurves</span>&nbsp;<span class="op" id="3847592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847597">if</span>&nbsp;<span class="ident" id="3847600">candidate</span>&nbsp;<span class="op" id="3847610">==</span>&nbsp;<span class="ident" id="3847613">c</span>&nbsp;<span class="op" id="3847615">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847621">curveid</span>&nbsp;<span class="op" id="3847629">=</span>&nbsp;<span class="ident" id="3847631">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847637">break</span>&nbsp;<span class="ident" id="3847643">NextCandidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847667">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847671">if</span>&nbsp;<span class="ident" id="3847674">curveid</span>&nbsp;<span class="op" id="3847682">==</span>&nbsp;<span class="num" id="3847685">0</span>&nbsp;<span class="op" id="3847687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847691">return</span>&nbsp;<span class="builtintype" id="3847698">nil</span><span class="op" id="3847701">,</span>&nbsp;<span class="ident" id="3847703">errors</span><span class="op" id="3847709">.</span><span class="ident" id="3847710">New</span><span class="op" id="3847713">(</span><span class="string" id="3847714">&#34;tls:&nbsp;no&nbsp;supported&nbsp;elliptic&nbsp;curves&nbsp;offered&#34;</span><span class="op" id="3847757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847764">var</span>&nbsp;<span class="ident" id="3847768">ok</span>&nbsp;<span class="builtintype" id="3847771">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847777">if</span>&nbsp;<span class="ident" id="3847780">ka</span><span class="op" id="3847782">.</span><span class="ident" id="3847783">curve</span><span class="op" id="3847788">,</span>&nbsp;<span class="ident" id="3847790">ok</span>&nbsp;<span class="op" id="3847793">=</span>&nbsp;<span class="ident" id="3847795">curveForCurveID</span><span class="op" id="3847810">(</span><span class="ident" id="3847811">curveid</span><span class="op" id="3847818">)</span><span class="op" id="3847819">;</span>&nbsp;<span class="op" id="3847821">!</span><span class="ident" id="3847822">ok</span>&nbsp;<span class="op" id="3847825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847829">return</span>&nbsp;<span class="builtintype" id="3847836">nil</span><span class="op" id="3847839">,</span>&nbsp;<span class="ident" id="3847841">errors</span><span class="op" id="3847847">.</span><span class="ident" id="3847848">New</span><span class="op" id="3847851">(</span><span class="string" id="3847852">&#34;tls:&nbsp;preferredCurves&nbsp;includes&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3847901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3847904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847908">var</span>&nbsp;<span class="ident" id="3847912">x</span><span class="op" id="3847913">,</span>&nbsp;<span class="ident" id="3847915">y</span>&nbsp;<span class="op" id="3847917">*</span><span class="ident" id="3847918">big</span><span class="op" id="3847921">.</span><span class="ident" id="3847922">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3847927">var</span>&nbsp;<span class="ident" id="3847931">err</span>&nbsp;<span class="builtintype" id="3847935">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3847942">ka</span><span class="op" id="3847944">.</span><span class="ident" id="3847945">privateKey</span><span class="op" id="3847955">,</span>&nbsp;<span class="ident" id="3847957">x</span><span class="op" id="3847958">,</span>&nbsp;<span class="ident" id="3847960">y</span><span class="op" id="3847961">,</span>&nbsp;<span class="ident" id="3847963">err</span>&nbsp;<span class="op" id="3847967">=</span>&nbsp;<span class="ident" id="3847969">elliptic</span><span class="op" id="3847977">.</span><span class="ident" id="3847978">GenerateKey</span><span class="op" id="3847989">(</span><span class="ident" id="3847990">ka</span><span class="op" id="3847992">.</span><span class="ident" id="3847993">curve</span><span class="op" id="3847998">,</span>&nbsp;<span class="ident" id="3848000">config</span><span class="op" id="3848006">.</span><span class="ident" id="3848007">rand</span><span class="op" id="3848011">(</span><span class="op" id="3848012">)</span><span class="op" id="3848013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848016">if</span>&nbsp;<span class="ident" id="3848019">err</span>&nbsp;<span class="op" id="3848023">!=</span>&nbsp;<span class="builtintype" id="3848026">nil</span>&nbsp;<span class="op" id="3848030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848034">return</span>&nbsp;<span class="builtintype" id="3848041">nil</span><span class="op" id="3848044">,</span>&nbsp;<span class="ident" id="3848046">err</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848054">ecdhePublic</span>&nbsp;<span class="op" id="3848066">:=</span>&nbsp;<span class="ident" id="3848069">elliptic</span><span class="op" id="3848077">.</span><span class="ident" id="3848078">Marshal</span><span class="op" id="3848085">(</span><span class="ident" id="3848086">ka</span><span class="op" id="3848088">.</span><span class="ident" id="3848089">curve</span><span class="op" id="3848094">,</span>&nbsp;<span class="ident" id="3848096">x</span><span class="op" id="3848097">,</span>&nbsp;<span class="ident" id="3848099">y</span><span class="op" id="3848100">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3848104">//&nbsp;http://tools.ietf.org/html/rfc4492#section-5.4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848155">serverECDHParams</span>&nbsp;<span class="op" id="3848172">:=</span>&nbsp;<span class="builtinfunc" id="3848175">make</span><span class="op" id="3848179">(</span><span class="op" id="3848180">[</span><span class="op" id="3848181">]</span><span class="builtintype" id="3848182">byte</span><span class="op" id="3848186">,</span>&nbsp;<span class="num" id="3848188">1</span><span class="op" id="3848189">+</span><span class="num" id="3848190">2</span><span class="op" id="3848191">+</span><span class="num" id="3848192">1</span><span class="op" id="3848193">+</span><span class="builtinfunc" id="3848194">len</span><span class="op" id="3848197">(</span><span class="ident" id="3848198">ecdhePublic</span><span class="op" id="3848209">)</span><span class="op" id="3848210">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848213">serverECDHParams</span><span class="op" id="3848229">[</span><span class="num" id="3848230">0</span><span class="op" id="3848231">]</span>&nbsp;<span class="op" id="3848233">=</span>&nbsp;<span class="num" id="3848235">3</span>&nbsp;<span class="comment" id="3848237">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848253">serverECDHParams</span><span class="op" id="3848269">[</span><span class="num" id="3848270">1</span><span class="op" id="3848271">]</span>&nbsp;<span class="op" id="3848273">=</span>&nbsp;<span class="builtintype" id="3848275">byte</span><span class="op" id="3848279">(</span><span class="ident" id="3848280">curveid</span>&nbsp;<span class="op" id="3848288">&gt;&gt;</span>&nbsp;<span class="num" id="3848291">8</span><span class="op" id="3848292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848295">serverECDHParams</span><span class="op" id="3848311">[</span><span class="num" id="3848312">2</span><span class="op" id="3848313">]</span>&nbsp;<span class="op" id="3848315">=</span>&nbsp;<span class="builtintype" id="3848317">byte</span><span class="op" id="3848321">(</span><span class="ident" id="3848322">curveid</span><span class="op" id="3848329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848332">serverECDHParams</span><span class="op" id="3848348">[</span><span class="num" id="3848349">3</span><span class="op" id="3848350">]</span>&nbsp;<span class="op" id="3848352">=</span>&nbsp;<span class="builtintype" id="3848354">byte</span><span class="op" id="3848358">(</span><span class="builtinfunc" id="3848359">len</span><span class="op" id="3848362">(</span><span class="ident" id="3848363">ecdhePublic</span><span class="op" id="3848374">)</span><span class="op" id="3848375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3848378">copy</span><span class="op" id="3848382">(</span><span class="ident" id="3848383">serverECDHParams</span><span class="op" id="3848399">[</span><span class="num" id="3848400">4</span><span class="op" id="3848401">:</span><span class="op" id="3848402">]</span><span class="op" id="3848403">,</span>&nbsp;<span class="ident" id="3848405">ecdhePublic</span><span class="op" id="3848416">)</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848420">var</span>&nbsp;<span class="ident" id="3848424">tls12HashId</span>&nbsp;<span class="builtintype" id="3848436">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848443">if</span>&nbsp;<span class="ident" id="3848446">ka</span><span class="op" id="3848448">.</span><span class="ident" id="3848449">version</span>&nbsp;<span class="op" id="3848457">&gt;=</span>&nbsp;<span class="ident" id="3848460">VersionTLS12</span>&nbsp;<span class="op" id="3848473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848477">if</span>&nbsp;<span class="ident" id="3848480">tls12HashId</span><span class="op" id="3848491">,</span>&nbsp;<span class="ident" id="3848493">err</span>&nbsp;<span class="op" id="3848497">=</span>&nbsp;<span class="ident" id="3848499">pickTLS12HashForSignature</span><span class="op" id="3848524">(</span><span class="ident" id="3848525">ka</span><span class="op" id="3848527">.</span><span class="ident" id="3848528">sigType</span><span class="op" id="3848535">,</span>&nbsp;<span class="ident" id="3848537">clientHello</span><span class="op" id="3848548">.</span><span class="ident" id="3848549">signatureAndHashes</span><span class="op" id="3848567">)</span><span class="op" id="3848568">;</span>&nbsp;<span class="ident" id="3848570">err</span>&nbsp;<span class="op" id="3848574">!=</span>&nbsp;<span class="builtintype" id="3848577">nil</span>&nbsp;<span class="op" id="3848581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848586">return</span>&nbsp;<span class="builtintype" id="3848593">nil</span><span class="op" id="3848596">,</span>&nbsp;<span class="ident" id="3848598">err</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848611">digest</span><span class="op" id="3848617">,</span>&nbsp;<span class="ident" id="3848619">hashFunc</span><span class="op" id="3848627">,</span>&nbsp;<span class="ident" id="3848629">err</span>&nbsp;<span class="op" id="3848633">:=</span>&nbsp;<span class="ident" id="3848636">hashForServerKeyExchange</span><span class="op" id="3848660">(</span><span class="ident" id="3848661">ka</span><span class="op" id="3848663">.</span><span class="ident" id="3848664">sigType</span><span class="op" id="3848671">,</span>&nbsp;<span class="ident" id="3848673">tls12HashId</span><span class="op" id="3848684">,</span>&nbsp;<span class="ident" id="3848686">ka</span><span class="op" id="3848688">.</span><span class="ident" id="3848689">version</span><span class="op" id="3848696">,</span>&nbsp;<span class="ident" id="3848698">clientHello</span><span class="op" id="3848709">.</span><span class="ident" id="3848710">random</span><span class="op" id="3848716">,</span>&nbsp;<span class="ident" id="3848718">hello</span><span class="op" id="3848723">.</span><span class="ident" id="3848724">random</span><span class="op" id="3848730">,</span>&nbsp;<span class="ident" id="3848732">serverECDHParams</span><span class="op" id="3848748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848751">if</span>&nbsp;<span class="ident" id="3848754">err</span>&nbsp;<span class="op" id="3848758">!=</span>&nbsp;<span class="builtintype" id="3848761">nil</span>&nbsp;<span class="op" id="3848765">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848769">return</span>&nbsp;<span class="builtintype" id="3848776">nil</span><span class="op" id="3848779">,</span>&nbsp;<span class="ident" id="3848781">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848789">var</span>&nbsp;<span class="ident" id="3848793">sig</span>&nbsp;<span class="op" id="3848797">[</span><span class="op" id="3848798">]</span><span class="builtintype" id="3848799">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848805">switch</span>&nbsp;<span class="ident" id="3848812">ka</span><span class="op" id="3848814">.</span><span class="ident" id="3848815">sigType</span>&nbsp;<span class="op" id="3848823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848826">case</span>&nbsp;<span class="ident" id="3848831">signatureECDSA</span><span class="op" id="3848845">:</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848849">privKey</span><span class="op" id="3848856">,</span>&nbsp;<span class="ident" id="3848858">ok</span>&nbsp;<span class="op" id="3848861">:=</span>&nbsp;<span class="ident" id="3848864">cert</span><span class="op" id="3848868">.</span><span class="ident" id="3848869">PrivateKey</span><span class="op" id="3848879">.</span><span class="op" id="3848880">(</span><span class="op" id="3848881">*</span><span class="ident" id="3848882">ecdsa</span><span class="op" id="3848887">.</span><span class="ident" id="3848888">PrivateKey</span><span class="op" id="3848898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848902">if</span>&nbsp;<span class="op" id="3848905">!</span><span class="ident" id="3848906">ok</span>&nbsp;<span class="op" id="3848909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3848914">return</span>&nbsp;<span class="builtintype" id="3848921">nil</span><span class="op" id="3848924">,</span>&nbsp;<span class="ident" id="3848926">errors</span><span class="op" id="3848932">.</span><span class="ident" id="3848933">New</span><span class="op" id="3848936">(</span><span class="string" id="3848937">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;an&nbsp;ECDSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3848987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3848991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3848995">r</span><span class="op" id="3848996">,</span>&nbsp;<span class="ident" id="3848998">s</span><span class="op" id="3848999">,</span>&nbsp;<span class="ident" id="3849001">err</span>&nbsp;<span class="op" id="3849005">:=</span>&nbsp;<span class="ident" id="3849008">ecdsa</span><span class="op" id="3849013">.</span><span class="ident" id="3849014">Sign</span><span class="op" id="3849018">(</span><span class="ident" id="3849019">config</span><span class="op" id="3849025">.</span><span class="ident" id="3849026">rand</span><span class="op" id="3849030">(</span><span class="op" id="3849031">)</span><span class="op" id="3849032">,</span>&nbsp;<span class="ident" id="3849034">privKey</span><span class="op" id="3849041">,</span>&nbsp;<span class="ident" id="3849043">digest</span><span class="op" id="3849049">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849053">if</span>&nbsp;<span class="ident" id="3849056">err</span>&nbsp;<span class="op" id="3849060">!=</span>&nbsp;<span class="builtintype" id="3849063">nil</span>&nbsp;<span class="op" id="3849067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849072">return</span>&nbsp;<span class="builtintype" id="3849079">nil</span><span class="op" id="3849082">,</span>&nbsp;<span class="ident" id="3849084">errors</span><span class="op" id="3849090">.</span><span class="ident" id="3849091">New</span><span class="op" id="3849094">(</span><span class="string" id="3849095">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3849131">+</span>&nbsp;<span class="ident" id="3849133">err</span><span class="op" id="3849136">.</span><span class="ident" id="3849137">Error</span><span class="op" id="3849142">(</span><span class="op" id="3849143">)</span><span class="op" id="3849144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849152">sig</span><span class="op" id="3849155">,</span>&nbsp;<span class="ident" id="3849157">err</span>&nbsp;<span class="op" id="3849161">=</span>&nbsp;<span class="ident" id="3849163">asn1</span><span class="op" id="3849167">.</span><span class="ident" id="3849168">Marshal</span><span class="op" id="3849175">(</span><span class="ident" id="3849176">ecdsaSignature</span><span class="op" id="3849190">{</span><span class="ident" id="3849191">r</span><span class="op" id="3849192">,</span>&nbsp;<span class="ident" id="3849194">s</span><span class="op" id="3849195">}</span><span class="op" id="3849196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849199">case</span>&nbsp;<span class="ident" id="3849204">signatureRSA</span><span class="op" id="3849216">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849220">privKey</span><span class="op" id="3849227">,</span>&nbsp;<span class="ident" id="3849229">ok</span>&nbsp;<span class="op" id="3849232">:=</span>&nbsp;<span class="ident" id="3849235">cert</span><span class="op" id="3849239">.</span><span class="ident" id="3849240">PrivateKey</span><span class="op" id="3849250">.</span><span class="op" id="3849251">(</span><span class="op" id="3849252">*</span><span class="ident" id="3849253">rsa</span><span class="op" id="3849256">.</span><span class="ident" id="3849257">PrivateKey</span><span class="op" id="3849267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849271">if</span>&nbsp;<span class="op" id="3849274">!</span><span class="ident" id="3849275">ok</span>&nbsp;<span class="op" id="3849278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849283">return</span>&nbsp;<span class="builtintype" id="3849290">nil</span><span class="op" id="3849293">,</span>&nbsp;<span class="ident" id="3849295">errors</span><span class="op" id="3849301">.</span><span class="ident" id="3849302">New</span><span class="op" id="3849305">(</span><span class="string" id="3849306">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;private&nbsp;key&#34;</span><span class="op" id="3849351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849359">sig</span><span class="op" id="3849362">,</span>&nbsp;<span class="ident" id="3849364">err</span>&nbsp;<span class="op" id="3849368">=</span>&nbsp;<span class="ident" id="3849370">rsa</span><span class="op" id="3849373">.</span><span class="ident" id="3849374">SignPKCS1v15</span><span class="op" id="3849386">(</span><span class="ident" id="3849387">config</span><span class="op" id="3849393">.</span><span class="ident" id="3849394">rand</span><span class="op" id="3849398">(</span><span class="op" id="3849399">)</span><span class="op" id="3849400">,</span>&nbsp;<span class="ident" id="3849402">privKey</span><span class="op" id="3849409">,</span>&nbsp;<span class="ident" id="3849411">hashFunc</span><span class="op" id="3849419">,</span>&nbsp;<span class="ident" id="3849421">digest</span><span class="op" id="3849427">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849431">if</span>&nbsp;<span class="ident" id="3849434">err</span>&nbsp;<span class="op" id="3849438">!=</span>&nbsp;<span class="builtintype" id="3849441">nil</span>&nbsp;<span class="op" id="3849445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849450">return</span>&nbsp;<span class="builtintype" id="3849457">nil</span><span class="op" id="3849460">,</span>&nbsp;<span class="ident" id="3849462">errors</span><span class="op" id="3849468">.</span><span class="ident" id="3849469">New</span><span class="op" id="3849472">(</span><span class="string" id="3849473">&#34;failed&nbsp;to&nbsp;sign&nbsp;ECDHE&nbsp;parameters:&nbsp;&#34;</span>&nbsp;<span class="op" id="3849509">+</span>&nbsp;<span class="ident" id="3849511">err</span><span class="op" id="3849514">.</span><span class="ident" id="3849515">Error</span><span class="op" id="3849520">(</span><span class="op" id="3849521">)</span><span class="op" id="3849522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849529">default</span><span class="op" id="3849536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849540">return</span>&nbsp;<span class="builtintype" id="3849547">nil</span><span class="op" id="3849550">,</span>&nbsp;<span class="ident" id="3849552">errors</span><span class="op" id="3849558">.</span><span class="ident" id="3849559">New</span><span class="op" id="3849562">(</span><span class="string" id="3849563">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3849598">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849605">skx</span>&nbsp;<span class="op" id="3849609">:=</span>&nbsp;<span class="builtinfunc" id="3849612">new</span><span class="op" id="3849615">(</span><span class="ident" id="3849616">serverKeyExchangeMsg</span><span class="op" id="3849636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849639">sigAndHashLen</span>&nbsp;<span class="op" id="3849653">:=</span>&nbsp;<span class="num" id="3849656">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849659">if</span>&nbsp;<span class="ident" id="3849662">ka</span><span class="op" id="3849664">.</span><span class="ident" id="3849665">version</span>&nbsp;<span class="op" id="3849673">&gt;=</span>&nbsp;<span class="ident" id="3849676">VersionTLS12</span>&nbsp;<span class="op" id="3849689">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849693">sigAndHashLen</span>&nbsp;<span class="op" id="3849707">=</span>&nbsp;<span class="num" id="3849709">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849715">skx</span><span class="op" id="3849718">.</span><span class="ident" id="3849719">key</span>&nbsp;<span class="op" id="3849723">=</span>&nbsp;<span class="builtinfunc" id="3849725">make</span><span class="op" id="3849729">(</span><span class="op" id="3849730">[</span><span class="op" id="3849731">]</span><span class="builtintype" id="3849732">byte</span><span class="op" id="3849736">,</span>&nbsp;<span class="builtinfunc" id="3849738">len</span><span class="op" id="3849741">(</span><span class="ident" id="3849742">serverECDHParams</span><span class="op" id="3849758">)</span><span class="op" id="3849759">+</span><span class="ident" id="3849760">sigAndHashLen</span><span class="op" id="3849773">+</span><span class="num" id="3849774">2</span><span class="op" id="3849775">+</span><span class="builtinfunc" id="3849776">len</span><span class="op" id="3849779">(</span><span class="ident" id="3849780">sig</span><span class="op" id="3849783">)</span><span class="op" id="3849784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3849787">copy</span><span class="op" id="3849791">(</span><span class="ident" id="3849792">skx</span><span class="op" id="3849795">.</span><span class="ident" id="3849796">key</span><span class="op" id="3849799">,</span>&nbsp;<span class="ident" id="3849801">serverECDHParams</span><span class="op" id="3849817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849820">k</span>&nbsp;<span class="op" id="3849822">:=</span>&nbsp;<span class="ident" id="3849825">skx</span><span class="op" id="3849828">.</span><span class="ident" id="3849829">key</span><span class="op" id="3849832">[</span><span class="builtinfunc" id="3849833">len</span><span class="op" id="3849836">(</span><span class="ident" id="3849837">serverECDHParams</span><span class="op" id="3849853">)</span><span class="op" id="3849854">:</span><span class="op" id="3849855">]</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3849858">if</span>&nbsp;<span class="ident" id="3849861">ka</span><span class="op" id="3849863">.</span><span class="ident" id="3849864">version</span>&nbsp;<span class="op" id="3849872">&gt;=</span>&nbsp;<span class="ident" id="3849875">VersionTLS12</span>&nbsp;<span class="op" id="3849888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849892">k</span><span class="op" id="3849893">[</span><span class="num" id="3849894">0</span><span class="op" id="3849895">]</span>&nbsp;<span class="op" id="3849897">=</span>&nbsp;<span class="ident" id="3849899">tls12HashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849913">k</span><span class="op" id="3849914">[</span><span class="num" id="3849915">1</span><span class="op" id="3849916">]</span>&nbsp;<span class="op" id="3849918">=</span>&nbsp;<span class="ident" id="3849920">ka</span><span class="op" id="3849922">.</span><span class="ident" id="3849923">sigType</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849933">k</span>&nbsp;<span class="op" id="3849935">=</span>&nbsp;<span class="ident" id="3849937">k</span><span class="op" id="3849938">[</span><span class="num" id="3849939">2</span><span class="op" id="3849940">:</span><span class="op" id="3849941">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3849944">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849947">k</span><span class="op" id="3849948">[</span><span class="num" id="3849949">0</span><span class="op" id="3849950">]</span>&nbsp;<span class="op" id="3849952">=</span>&nbsp;<span class="builtintype" id="3849954">byte</span><span class="op" id="3849958">(</span><span class="builtinfunc" id="3849959">len</span><span class="op" id="3849962">(</span><span class="ident" id="3849963">sig</span><span class="op" id="3849966">)</span>&nbsp;<span class="op" id="3849968">&gt;&gt;</span>&nbsp;<span class="num" id="3849971">8</span><span class="op" id="3849972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3849975">k</span><span class="op" id="3849976">[</span><span class="num" id="3849977">1</span><span class="op" id="3849978">]</span>&nbsp;<span class="op" id="3849980">=</span>&nbsp;<span class="builtintype" id="3849982">byte</span><span class="op" id="3849986">(</span><span class="builtinfunc" id="3849987">len</span><span class="op" id="3849990">(</span><span class="ident" id="3849991">sig</span><span class="op" id="3849994">)</span><span class="op" id="3849995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3849998">copy</span><span class="op" id="3850002">(</span><span class="ident" id="3850003">k</span><span class="op" id="3850004">[</span><span class="num" id="3850005">2</span><span class="op" id="3850006">:</span><span class="op" id="3850007">]</span><span class="op" id="3850008">,</span>&nbsp;<span class="ident" id="3850010">sig</span><span class="op" id="3850013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850017">return</span>&nbsp;<span class="ident" id="3850024">skx</span><span class="op" id="3850027">,</span>&nbsp;<span class="builtintype" id="3850029">nil</span><br>
<span class="lineno">285</span><span class="op" id="3850033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3850036">func</span>&nbsp;<span class="op" id="3850041">(</span><span class="ident" id="3850042">ka</span>&nbsp;<span class="op" id="3850045">*</span><span class="ident" id="3850046">ecdheKeyAgreement</span><span class="op" id="3850063">)</span>&nbsp;<span class="ident" id="3850065">processClientKeyExchange</span><span class="op" id="3850089">(</span><span class="ident" id="3850090">config</span>&nbsp;<span class="op" id="3850097">*</span><span class="ident" id="3850098">Config</span><span class="op" id="3850104">,</span>&nbsp;<span class="ident" id="3850106">cert</span>&nbsp;<span class="op" id="3850111">*</span><span class="ident" id="3850112">Certificate</span><span class="op" id="3850123">,</span>&nbsp;<span class="ident" id="3850125">ckx</span>&nbsp;<span class="op" id="3850129">*</span><span class="ident" id="3850130">clientKeyExchangeMsg</span><span class="op" id="3850150">,</span>&nbsp;<span class="ident" id="3850152">version</span>&nbsp;<span class="builtintype" id="3850160">uint16</span><span class="op" id="3850166">)</span>&nbsp;<span class="op" id="3850168">(</span><span class="op" id="3850169">[</span><span class="op" id="3850170">]</span><span class="builtintype" id="3850171">byte</span><span class="op" id="3850175">,</span>&nbsp;<span class="builtintype" id="3850177">error</span><span class="op" id="3850182">)</span>&nbsp;<span class="op" id="3850184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850187">if</span>&nbsp;<span class="builtinfunc" id="3850190">len</span><span class="op" id="3850193">(</span><span class="ident" id="3850194">ckx</span><span class="op" id="3850197">.</span><span class="ident" id="3850198">ciphertext</span><span class="op" id="3850208">)</span>&nbsp;<span class="op" id="3850210">==</span>&nbsp;<span class="num" id="3850213">0</span>&nbsp;<span class="op" id="3850215">||</span>&nbsp;<span class="builtintype" id="3850218">int</span><span class="op" id="3850221">(</span><span class="ident" id="3850222">ckx</span><span class="op" id="3850225">.</span><span class="ident" id="3850226">ciphertext</span><span class="op" id="3850236">[</span><span class="num" id="3850237">0</span><span class="op" id="3850238">]</span><span class="op" id="3850239">)</span>&nbsp;<span class="op" id="3850241">!=</span>&nbsp;<span class="builtinfunc" id="3850244">len</span><span class="op" id="3850247">(</span><span class="ident" id="3850248">ckx</span><span class="op" id="3850251">.</span><span class="ident" id="3850252">ciphertext</span><span class="op" id="3850262">)</span><span class="op" id="3850263">-</span><span class="num" id="3850264">1</span>&nbsp;<span class="op" id="3850266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850270">return</span>&nbsp;<span class="builtintype" id="3850277">nil</span><span class="op" id="3850280">,</span>&nbsp;<span class="ident" id="3850282">errClientKeyExchange</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850307">x</span><span class="op" id="3850308">,</span>&nbsp;<span class="ident" id="3850310">y</span>&nbsp;<span class="op" id="3850312">:=</span>&nbsp;<span class="ident" id="3850315">elliptic</span><span class="op" id="3850323">.</span><span class="ident" id="3850324">Unmarshal</span><span class="op" id="3850333">(</span><span class="ident" id="3850334">ka</span><span class="op" id="3850336">.</span><span class="ident" id="3850337">curve</span><span class="op" id="3850342">,</span>&nbsp;<span class="ident" id="3850344">ckx</span><span class="op" id="3850347">.</span><span class="ident" id="3850348">ciphertext</span><span class="op" id="3850358">[</span><span class="num" id="3850359">1</span><span class="op" id="3850360">:</span><span class="op" id="3850361">]</span><span class="op" id="3850362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850365">if</span>&nbsp;<span class="ident" id="3850368">x</span>&nbsp;<span class="op" id="3850370">==</span>&nbsp;<span class="builtintype" id="3850373">nil</span>&nbsp;<span class="op" id="3850377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850381">return</span>&nbsp;<span class="builtintype" id="3850388">nil</span><span class="op" id="3850391">,</span>&nbsp;<span class="ident" id="3850393">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850415">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850418">if</span>&nbsp;<span class="op" id="3850421">!</span><span class="ident" id="3850422">ka</span><span class="op" id="3850424">.</span><span class="ident" id="3850425">curve</span><span class="op" id="3850430">.</span><span class="ident" id="3850431">IsOnCurve</span><span class="op" id="3850440">(</span><span class="ident" id="3850441">x</span><span class="op" id="3850442">,</span>&nbsp;<span class="ident" id="3850444">y</span><span class="op" id="3850445">)</span>&nbsp;<span class="op" id="3850447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850451">return</span>&nbsp;<span class="builtintype" id="3850458">nil</span><span class="op" id="3850461">,</span>&nbsp;<span class="ident" id="3850463">errClientKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850488">x</span><span class="op" id="3850489">,</span>&nbsp;<span class="ident" id="3850491">_</span>&nbsp;<span class="op" id="3850493">=</span>&nbsp;<span class="ident" id="3850495">ka</span><span class="op" id="3850497">.</span><span class="ident" id="3850498">curve</span><span class="op" id="3850503">.</span><span class="ident" id="3850504">ScalarMult</span><span class="op" id="3850514">(</span><span class="ident" id="3850515">x</span><span class="op" id="3850516">,</span>&nbsp;<span class="ident" id="3850518">y</span><span class="op" id="3850519">,</span>&nbsp;<span class="ident" id="3850521">ka</span><span class="op" id="3850523">.</span><span class="ident" id="3850524">privateKey</span><span class="op" id="3850534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850537">preMasterSecret</span>&nbsp;<span class="op" id="3850553">:=</span>&nbsp;<span class="builtinfunc" id="3850556">make</span><span class="op" id="3850560">(</span><span class="op" id="3850561">[</span><span class="op" id="3850562">]</span><span class="builtintype" id="3850563">byte</span><span class="op" id="3850567">,</span>&nbsp;<span class="op" id="3850569">(</span><span class="ident" id="3850570">ka</span><span class="op" id="3850572">.</span><span class="ident" id="3850573">curve</span><span class="op" id="3850578">.</span><span class="ident" id="3850579">Params</span><span class="op" id="3850585">(</span><span class="op" id="3850586">)</span><span class="op" id="3850587">.</span><span class="ident" id="3850588">BitSize</span><span class="op" id="3850595">+</span><span class="num" id="3850596">7</span><span class="op" id="3850597">)</span><span class="op" id="3850598">&gt;&gt;</span><span class="num" id="3850600">3</span><span class="op" id="3850601">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3850604">xBytes</span>&nbsp;<span class="op" id="3850611">:=</span>&nbsp;<span class="ident" id="3850614">x</span><span class="op" id="3850615">.</span><span class="ident" id="3850616">Bytes</span><span class="op" id="3850621">(</span><span class="op" id="3850622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3850625">copy</span><span class="op" id="3850629">(</span><span class="ident" id="3850630">preMasterSecret</span><span class="op" id="3850645">[</span><span class="builtinfunc" id="3850646">len</span><span class="op" id="3850649">(</span><span class="ident" id="3850650">preMasterSecret</span><span class="op" id="3850665">)</span><span class="op" id="3850666">-</span><span class="builtinfunc" id="3850667">len</span><span class="op" id="3850670">(</span><span class="ident" id="3850671">xBytes</span><span class="op" id="3850677">)</span><span class="op" id="3850678">:</span><span class="op" id="3850679">]</span><span class="op" id="3850680">,</span>&nbsp;<span class="ident" id="3850682">xBytes</span><span class="op" id="3850688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850692">return</span>&nbsp;<span class="ident" id="3850699">preMasterSecret</span><span class="op" id="3850714">,</span>&nbsp;<span class="builtintype" id="3850716">nil</span><br>
<span class="lineno"></span><span class="op" id="3850720">}</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span><span class="keyword" id="3850723">func</span>&nbsp;<span class="op" id="3850728">(</span><span class="ident" id="3850729">ka</span>&nbsp;<span class="op" id="3850732">*</span><span class="ident" id="3850733">ecdheKeyAgreement</span><span class="op" id="3850750">)</span>&nbsp;<span class="ident" id="3850752">processServerKeyExchange</span><span class="op" id="3850776">(</span><span class="ident" id="3850777">config</span>&nbsp;<span class="op" id="3850784">*</span><span class="ident" id="3850785">Config</span><span class="op" id="3850791">,</span>&nbsp;<span class="ident" id="3850793">clientHello</span>&nbsp;<span class="op" id="3850805">*</span><span class="ident" id="3850806">clientHelloMsg</span><span class="op" id="3850820">,</span>&nbsp;<span class="ident" id="3850822">serverHello</span>&nbsp;<span class="op" id="3850834">*</span><span class="ident" id="3850835">serverHelloMsg</span><span class="op" id="3850849">,</span>&nbsp;<span class="ident" id="3850851">cert</span>&nbsp;<span class="op" id="3850856">*</span><span class="ident" id="3850857">x509</span><span class="op" id="3850861">.</span><span class="ident" id="3850862">Certificate</span><span class="op" id="3850873">,</span>&nbsp;<span class="ident" id="3850875">skx</span>&nbsp;<span class="op" id="3850879">*</span><span class="ident" id="3850880">serverKeyExchangeMsg</span><span class="op" id="3850900">)</span>&nbsp;<span class="builtintype" id="3850902">error</span>&nbsp;<span class="op" id="3850908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850911">if</span>&nbsp;<span class="builtinfunc" id="3850914">len</span><span class="op" id="3850917">(</span><span class="ident" id="3850918">skx</span><span class="op" id="3850921">.</span><span class="ident" id="3850922">key</span><span class="op" id="3850925">)</span>&nbsp;<span class="op" id="3850927">&lt;</span>&nbsp;<span class="num" id="3850929">4</span>&nbsp;<span class="op" id="3850931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850935">return</span>&nbsp;<span class="ident" id="3850942">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3850964">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3850967">if</span>&nbsp;<span class="ident" id="3850970">skx</span><span class="op" id="3850973">.</span><span class="ident" id="3850974">key</span><span class="op" id="3850977">[</span><span class="num" id="3850978">0</span><span class="op" id="3850979">]</span>&nbsp;<span class="op" id="3850981">!=</span>&nbsp;<span class="num" id="3850984">3</span>&nbsp;<span class="op" id="3850986">{</span>&nbsp;<span class="comment" id="3850988">//&nbsp;named&nbsp;curve</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851005">return</span>&nbsp;<span class="ident" id="3851012">errors</span><span class="op" id="3851018">.</span><span class="ident" id="3851019">New</span><span class="op" id="3851022">(</span><span class="string" id="3851023">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3851063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851069">curveid</span>&nbsp;<span class="op" id="3851077">:=</span>&nbsp;<span class="ident" id="3851080">CurveID</span><span class="op" id="3851087">(</span><span class="ident" id="3851088">skx</span><span class="op" id="3851091">.</span><span class="ident" id="3851092">key</span><span class="op" id="3851095">[</span><span class="num" id="3851096">1</span><span class="op" id="3851097">]</span><span class="op" id="3851098">)</span><span class="op" id="3851099">&lt;&lt;</span><span class="num" id="3851101">8</span>&nbsp;<span class="op" id="3851103">|</span>&nbsp;<span class="ident" id="3851105">CurveID</span><span class="op" id="3851112">(</span><span class="ident" id="3851113">skx</span><span class="op" id="3851116">.</span><span class="ident" id="3851117">key</span><span class="op" id="3851120">[</span><span class="num" id="3851121">2</span><span class="op" id="3851122">]</span><span class="op" id="3851123">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851127">var</span>&nbsp;<span class="ident" id="3851131">ok</span>&nbsp;<span class="builtintype" id="3851134">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851140">if</span>&nbsp;<span class="ident" id="3851143">ka</span><span class="op" id="3851145">.</span><span class="ident" id="3851146">curve</span><span class="op" id="3851151">,</span>&nbsp;<span class="ident" id="3851153">ok</span>&nbsp;<span class="op" id="3851156">=</span>&nbsp;<span class="ident" id="3851158">curveForCurveID</span><span class="op" id="3851173">(</span><span class="ident" id="3851174">curveid</span><span class="op" id="3851181">)</span><span class="op" id="3851182">;</span>&nbsp;<span class="op" id="3851184">!</span><span class="ident" id="3851185">ok</span>&nbsp;<span class="op" id="3851188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851192">return</span>&nbsp;<span class="ident" id="3851199">errors</span><span class="op" id="3851205">.</span><span class="ident" id="3851206">New</span><span class="op" id="3851209">(</span><span class="string" id="3851210">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;curve&#34;</span><span class="op" id="3851250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851253">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851257">publicLen</span>&nbsp;<span class="op" id="3851267">:=</span>&nbsp;<span class="builtintype" id="3851270">int</span><span class="op" id="3851273">(</span><span class="ident" id="3851274">skx</span><span class="op" id="3851277">.</span><span class="ident" id="3851278">key</span><span class="op" id="3851281">[</span><span class="num" id="3851282">3</span><span class="op" id="3851283">]</span><span class="op" id="3851284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851287">if</span>&nbsp;<span class="ident" id="3851290">publicLen</span><span class="op" id="3851299">+</span><span class="num" id="3851300">4</span>&nbsp;<span class="op" id="3851302">&gt;</span>&nbsp;<span class="builtinfunc" id="3851304">len</span><span class="op" id="3851307">(</span><span class="ident" id="3851308">skx</span><span class="op" id="3851311">.</span><span class="ident" id="3851312">key</span><span class="op" id="3851315">)</span>&nbsp;<span class="op" id="3851317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851321">return</span>&nbsp;<span class="ident" id="3851328">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851353">ka</span><span class="op" id="3851355">.</span><span class="ident" id="3851356">x</span><span class="op" id="3851357">,</span>&nbsp;<span class="ident" id="3851359">ka</span><span class="op" id="3851361">.</span><span class="ident" id="3851362">y</span>&nbsp;<span class="op" id="3851364">=</span>&nbsp;<span class="ident" id="3851366">elliptic</span><span class="op" id="3851374">.</span><span class="ident" id="3851375">Unmarshal</span><span class="op" id="3851384">(</span><span class="ident" id="3851385">ka</span><span class="op" id="3851387">.</span><span class="ident" id="3851388">curve</span><span class="op" id="3851393">,</span>&nbsp;<span class="ident" id="3851395">skx</span><span class="op" id="3851398">.</span><span class="ident" id="3851399">key</span><span class="op" id="3851402">[</span><span class="num" id="3851403">4</span><span class="op" id="3851404">:</span><span class="num" id="3851405">4</span><span class="op" id="3851406">+</span><span class="ident" id="3851407">publicLen</span><span class="op" id="3851416">]</span><span class="op" id="3851417">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851420">if</span>&nbsp;<span class="ident" id="3851423">ka</span><span class="op" id="3851425">.</span><span class="ident" id="3851426">x</span>&nbsp;<span class="op" id="3851428">==</span>&nbsp;<span class="builtintype" id="3851431">nil</span>&nbsp;<span class="op" id="3851435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851439">return</span>&nbsp;<span class="ident" id="3851446">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851471">if</span>&nbsp;<span class="op" id="3851474">!</span><span class="ident" id="3851475">ka</span><span class="op" id="3851477">.</span><span class="ident" id="3851478">curve</span><span class="op" id="3851483">.</span><span class="ident" id="3851484">IsOnCurve</span><span class="op" id="3851493">(</span><span class="ident" id="3851494">ka</span><span class="op" id="3851496">.</span><span class="ident" id="3851497">x</span><span class="op" id="3851498">,</span>&nbsp;<span class="ident" id="3851500">ka</span><span class="op" id="3851502">.</span><span class="ident" id="3851503">y</span><span class="op" id="3851504">)</span>&nbsp;<span class="op" id="3851506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851510">return</span>&nbsp;<span class="ident" id="3851517">errServerKeyExchange</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851539">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851542">serverECDHParams</span>&nbsp;<span class="op" id="3851559">:=</span>&nbsp;<span class="ident" id="3851562">skx</span><span class="op" id="3851565">.</span><span class="ident" id="3851566">key</span><span class="op" id="3851569">[</span><span class="op" id="3851570">:</span><span class="num" id="3851571">4</span><span class="op" id="3851572">+</span><span class="ident" id="3851573">publicLen</span><span class="op" id="3851582">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851586">sig</span>&nbsp;<span class="op" id="3851590">:=</span>&nbsp;<span class="ident" id="3851593">skx</span><span class="op" id="3851596">.</span><span class="ident" id="3851597">key</span><span class="op" id="3851600">[</span><span class="num" id="3851601">4</span><span class="op" id="3851602">+</span><span class="ident" id="3851603">publicLen</span><span class="op" id="3851612">:</span><span class="op" id="3851613">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851616">if</span>&nbsp;<span class="builtinfunc" id="3851619">len</span><span class="op" id="3851622">(</span><span class="ident" id="3851623">sig</span><span class="op" id="3851626">)</span>&nbsp;<span class="op" id="3851628">&lt;</span>&nbsp;<span class="num" id="3851630">2</span>&nbsp;<span class="op" id="3851632">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851636">return</span>&nbsp;<span class="ident" id="3851643">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851669">var</span>&nbsp;<span class="ident" id="3851673">tls12HashId</span>&nbsp;<span class="builtintype" id="3851685">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851692">if</span>&nbsp;<span class="ident" id="3851695">ka</span><span class="op" id="3851697">.</span><span class="ident" id="3851698">version</span>&nbsp;<span class="op" id="3851706">&gt;=</span>&nbsp;<span class="ident" id="3851709">VersionTLS12</span>&nbsp;<span class="op" id="3851722">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3851726">//&nbsp;handle&nbsp;SignatureAndHashAlgorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851764">var</span>&nbsp;<span class="ident" id="3851768">sigAndHash</span>&nbsp;<span class="op" id="3851779">[</span><span class="op" id="3851780">]</span><span class="builtintype" id="3851781">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851789">sigAndHash</span><span class="op" id="3851799">,</span>&nbsp;<span class="ident" id="3851801">sig</span>&nbsp;<span class="op" id="3851805">=</span>&nbsp;<span class="ident" id="3851807">sig</span><span class="op" id="3851810">[</span><span class="op" id="3851811">:</span><span class="num" id="3851812">2</span><span class="op" id="3851813">]</span><span class="op" id="3851814">,</span>&nbsp;<span class="ident" id="3851816">sig</span><span class="op" id="3851819">[</span><span class="num" id="3851820">2</span><span class="op" id="3851821">:</span><span class="op" id="3851822">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851826">if</span>&nbsp;<span class="ident" id="3851829">sigAndHash</span><span class="op" id="3851839">[</span><span class="num" id="3851840">1</span><span class="op" id="3851841">]</span>&nbsp;<span class="op" id="3851843">!=</span>&nbsp;<span class="ident" id="3851846">ka</span><span class="op" id="3851848">.</span><span class="ident" id="3851849">sigType</span>&nbsp;<span class="op" id="3851857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851862">return</span>&nbsp;<span class="ident" id="3851869">errServerKeyExchange</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851896">tls12HashId</span>&nbsp;<span class="op" id="3851908">=</span>&nbsp;<span class="ident" id="3851910">sigAndHash</span><span class="op" id="3851920">[</span><span class="num" id="3851921">0</span><span class="op" id="3851922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851926">if</span>&nbsp;<span class="builtinfunc" id="3851929">len</span><span class="op" id="3851932">(</span><span class="ident" id="3851933">sig</span><span class="op" id="3851936">)</span>&nbsp;<span class="op" id="3851938">&lt;</span>&nbsp;<span class="num" id="3851940">2</span>&nbsp;<span class="op" id="3851942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3851947">return</span>&nbsp;<span class="ident" id="3851954">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851977">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3851980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3851983">sigLen</span>&nbsp;<span class="op" id="3851990">:=</span>&nbsp;<span class="builtintype" id="3851993">int</span><span class="op" id="3851996">(</span><span class="ident" id="3851997">sig</span><span class="op" id="3852000">[</span><span class="num" id="3852001">0</span><span class="op" id="3852002">]</span><span class="op" id="3852003">)</span><span class="op" id="3852004">&lt;&lt;</span><span class="num" id="3852006">8</span>&nbsp;<span class="op" id="3852008">|</span>&nbsp;<span class="builtintype" id="3852010">int</span><span class="op" id="3852013">(</span><span class="ident" id="3852014">sig</span><span class="op" id="3852017">[</span><span class="num" id="3852018">1</span><span class="op" id="3852019">]</span><span class="op" id="3852020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852023">if</span>&nbsp;<span class="ident" id="3852026">sigLen</span><span class="op" id="3852032">+</span><span class="num" id="3852033">2</span>&nbsp;<span class="op" id="3852035">!=</span>&nbsp;<span class="builtinfunc" id="3852038">len</span><span class="op" id="3852041">(</span><span class="ident" id="3852042">sig</span><span class="op" id="3852045">)</span>&nbsp;<span class="op" id="3852047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852051">return</span>&nbsp;<span class="ident" id="3852058">errServerKeyExchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852080">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852083">sig</span>&nbsp;<span class="op" id="3852087">=</span>&nbsp;<span class="ident" id="3852089">sig</span><span class="op" id="3852092">[</span><span class="num" id="3852093">2</span><span class="op" id="3852094">:</span><span class="op" id="3852095">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852099">digest</span><span class="op" id="3852105">,</span>&nbsp;<span class="ident" id="3852107">hashFunc</span><span class="op" id="3852115">,</span>&nbsp;<span class="ident" id="3852117">err</span>&nbsp;<span class="op" id="3852121">:=</span>&nbsp;<span class="ident" id="3852124">hashForServerKeyExchange</span><span class="op" id="3852148">(</span><span class="ident" id="3852149">ka</span><span class="op" id="3852151">.</span><span class="ident" id="3852152">sigType</span><span class="op" id="3852159">,</span>&nbsp;<span class="ident" id="3852161">tls12HashId</span><span class="op" id="3852172">,</span>&nbsp;<span class="ident" id="3852174">ka</span><span class="op" id="3852176">.</span><span class="ident" id="3852177">version</span><span class="op" id="3852184">,</span>&nbsp;<span class="ident" id="3852186">clientHello</span><span class="op" id="3852197">.</span><span class="ident" id="3852198">random</span><span class="op" id="3852204">,</span>&nbsp;<span class="ident" id="3852206">serverHello</span><span class="op" id="3852217">.</span><span class="ident" id="3852218">random</span><span class="op" id="3852224">,</span>&nbsp;<span class="ident" id="3852226">serverECDHParams</span><span class="op" id="3852242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852245">if</span>&nbsp;<span class="ident" id="3852248">err</span>&nbsp;<span class="op" id="3852252">!=</span>&nbsp;<span class="builtintype" id="3852255">nil</span>&nbsp;<span class="op" id="3852259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852263">return</span>&nbsp;<span class="ident" id="3852270">err</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852278">switch</span>&nbsp;<span class="ident" id="3852285">ka</span><span class="op" id="3852287">.</span><span class="ident" id="3852288">sigType</span>&nbsp;<span class="op" id="3852296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852299">case</span>&nbsp;<span class="ident" id="3852304">signatureECDSA</span><span class="op" id="3852318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852322">pubKey</span><span class="op" id="3852328">,</span>&nbsp;<span class="ident" id="3852330">ok</span>&nbsp;<span class="op" id="3852333">:=</span>&nbsp;<span class="ident" id="3852336">cert</span><span class="op" id="3852340">.</span><span class="ident" id="3852341">PublicKey</span><span class="op" id="3852350">.</span><span class="op" id="3852351">(</span><span class="op" id="3852352">*</span><span class="ident" id="3852353">ecdsa</span><span class="op" id="3852358">.</span><span class="ident" id="3852359">PublicKey</span><span class="op" id="3852368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852372">if</span>&nbsp;<span class="op" id="3852375">!</span><span class="ident" id="3852376">ok</span>&nbsp;<span class="op" id="3852379">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852384">return</span>&nbsp;<span class="ident" id="3852391">errors</span><span class="op" id="3852397">.</span><span class="ident" id="3852398">New</span><span class="op" id="3852401">(</span><span class="string" id="3852402">&#34;ECDHE&nbsp;ECDSA&nbsp;requires&nbsp;a&nbsp;ECDSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3852450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852458">ecdsaSig</span>&nbsp;<span class="op" id="3852467">:=</span>&nbsp;<span class="builtinfunc" id="3852470">new</span><span class="op" id="3852473">(</span><span class="ident" id="3852474">ecdsaSignature</span><span class="op" id="3852488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852492">if</span>&nbsp;<span class="ident" id="3852495">_</span><span class="op" id="3852496">,</span>&nbsp;<span class="ident" id="3852498">err</span>&nbsp;<span class="op" id="3852502">:=</span>&nbsp;<span class="ident" id="3852505">asn1</span><span class="op" id="3852509">.</span><span class="ident" id="3852510">Unmarshal</span><span class="op" id="3852519">(</span><span class="ident" id="3852520">sig</span><span class="op" id="3852523">,</span>&nbsp;<span class="ident" id="3852525">ecdsaSig</span><span class="op" id="3852533">)</span><span class="op" id="3852534">;</span>&nbsp;<span class="ident" id="3852536">err</span>&nbsp;<span class="op" id="3852540">!=</span>&nbsp;<span class="builtintype" id="3852543">nil</span>&nbsp;<span class="op" id="3852547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852552">return</span>&nbsp;<span class="ident" id="3852559">err</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852569">if</span>&nbsp;<span class="ident" id="3852572">ecdsaSig</span><span class="op" id="3852580">.</span><span class="ident" id="3852581">R</span><span class="op" id="3852582">.</span><span class="ident" id="3852583">Sign</span><span class="op" id="3852587">(</span><span class="op" id="3852588">)</span>&nbsp;<span class="op" id="3852590">&lt;=</span>&nbsp;<span class="num" id="3852593">0</span>&nbsp;<span class="op" id="3852595">||</span>&nbsp;<span class="ident" id="3852598">ecdsaSig</span><span class="op" id="3852606">.</span><span class="ident" id="3852607">S</span><span class="op" id="3852608">.</span><span class="ident" id="3852609">Sign</span><span class="op" id="3852613">(</span><span class="op" id="3852614">)</span>&nbsp;<span class="op" id="3852616">&lt;=</span>&nbsp;<span class="num" id="3852619">0</span>&nbsp;<span class="op" id="3852621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852626">return</span>&nbsp;<span class="ident" id="3852633">errors</span><span class="op" id="3852639">.</span><span class="ident" id="3852640">New</span><span class="op" id="3852643">(</span><span class="string" id="3852644">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3852695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852703">if</span>&nbsp;<span class="op" id="3852706">!</span><span class="ident" id="3852707">ecdsa</span><span class="op" id="3852712">.</span><span class="ident" id="3852713">Verify</span><span class="op" id="3852719">(</span><span class="ident" id="3852720">pubKey</span><span class="op" id="3852726">,</span>&nbsp;<span class="ident" id="3852728">digest</span><span class="op" id="3852734">,</span>&nbsp;<span class="ident" id="3852736">ecdsaSig</span><span class="op" id="3852744">.</span><span class="ident" id="3852745">R</span><span class="op" id="3852746">,</span>&nbsp;<span class="ident" id="3852748">ecdsaSig</span><span class="op" id="3852756">.</span><span class="ident" id="3852757">S</span><span class="op" id="3852758">)</span>&nbsp;<span class="op" id="3852760">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852765">return</span>&nbsp;<span class="ident" id="3852772">errors</span><span class="op" id="3852778">.</span><span class="ident" id="3852779">New</span><span class="op" id="3852782">(</span><span class="string" id="3852783">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3852811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852818">case</span>&nbsp;<span class="ident" id="3852823">signatureRSA</span><span class="op" id="3852835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3852839">pubKey</span><span class="op" id="3852845">,</span>&nbsp;<span class="ident" id="3852847">ok</span>&nbsp;<span class="op" id="3852850">:=</span>&nbsp;<span class="ident" id="3852853">cert</span><span class="op" id="3852857">.</span><span class="ident" id="3852858">PublicKey</span><span class="op" id="3852867">.</span><span class="op" id="3852868">(</span><span class="op" id="3852869">*</span><span class="ident" id="3852870">rsa</span><span class="op" id="3852873">.</span><span class="ident" id="3852874">PublicKey</span><span class="op" id="3852883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852887">if</span>&nbsp;<span class="op" id="3852890">!</span><span class="ident" id="3852891">ok</span>&nbsp;<span class="op" id="3852894">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852899">return</span>&nbsp;<span class="ident" id="3852906">errors</span><span class="op" id="3852912">.</span><span class="ident" id="3852913">New</span><span class="op" id="3852916">(</span><span class="string" id="3852917">&#34;ECDHE&nbsp;RSA&nbsp;requires&nbsp;a&nbsp;RSA&nbsp;server&nbsp;public&nbsp;key&#34;</span><span class="op" id="3852961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3852965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3852969">if</span>&nbsp;<span class="ident" id="3852972">err</span>&nbsp;<span class="op" id="3852976">:=</span>&nbsp;<span class="ident" id="3852979">rsa</span><span class="op" id="3852982">.</span><span class="ident" id="3852983">VerifyPKCS1v15</span><span class="op" id="3852997">(</span><span class="ident" id="3852998">pubKey</span><span class="op" id="3853004">,</span>&nbsp;<span class="ident" id="3853006">hashFunc</span><span class="op" id="3853014">,</span>&nbsp;<span class="ident" id="3853016">digest</span><span class="op" id="3853022">,</span>&nbsp;<span class="ident" id="3853024">sig</span><span class="op" id="3853027">)</span><span class="op" id="3853028">;</span>&nbsp;<span class="ident" id="3853030">err</span>&nbsp;<span class="op" id="3853034">!=</span>&nbsp;<span class="builtintype" id="3853037">nil</span>&nbsp;<span class="op" id="3853041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853046">return</span>&nbsp;<span class="ident" id="3853053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853059">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853062">default</span><span class="op" id="3853069">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853073">return</span>&nbsp;<span class="ident" id="3853080">errors</span><span class="op" id="3853086">.</span><span class="ident" id="3853087">New</span><span class="op" id="3853090">(</span><span class="string" id="3853091">&#34;unknown&nbsp;ECDHE&nbsp;signature&nbsp;algorithm&#34;</span><span class="op" id="3853126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853133">return</span>&nbsp;<span class="builtintype" id="3853140">nil</span><br>
<span class="lineno">390</span><span class="op" id="3853144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3853147">func</span>&nbsp;<span class="op" id="3853152">(</span><span class="ident" id="3853153">ka</span>&nbsp;<span class="op" id="3853156">*</span><span class="ident" id="3853157">ecdheKeyAgreement</span><span class="op" id="3853174">)</span>&nbsp;<span class="ident" id="3853176">generateClientKeyExchange</span><span class="op" id="3853201">(</span><span class="ident" id="3853202">config</span>&nbsp;<span class="op" id="3853209">*</span><span class="ident" id="3853210">Config</span><span class="op" id="3853216">,</span>&nbsp;<span class="ident" id="3853218">clientHello</span>&nbsp;<span class="op" id="3853230">*</span><span class="ident" id="3853231">clientHelloMsg</span><span class="op" id="3853245">,</span>&nbsp;<span class="ident" id="3853247">cert</span>&nbsp;<span class="op" id="3853252">*</span><span class="ident" id="3853253">x509</span><span class="op" id="3853257">.</span><span class="ident" id="3853258">Certificate</span><span class="op" id="3853269">)</span>&nbsp;<span class="op" id="3853271">(</span><span class="op" id="3853272">[</span><span class="op" id="3853273">]</span><span class="builtintype" id="3853274">byte</span><span class="op" id="3853278">,</span>&nbsp;<span class="op" id="3853280">*</span><span class="ident" id="3853281">clientKeyExchangeMsg</span><span class="op" id="3853301">,</span>&nbsp;<span class="builtintype" id="3853303">error</span><span class="op" id="3853308">)</span>&nbsp;<span class="op" id="3853310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853313">if</span>&nbsp;<span class="ident" id="3853316">ka</span><span class="op" id="3853318">.</span><span class="ident" id="3853319">curve</span>&nbsp;<span class="op" id="3853325">==</span>&nbsp;<span class="builtintype" id="3853328">nil</span>&nbsp;<span class="op" id="3853332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853336">return</span>&nbsp;<span class="builtintype" id="3853343">nil</span><span class="op" id="3853346">,</span>&nbsp;<span class="builtintype" id="3853348">nil</span><span class="op" id="3853351">,</span>&nbsp;<span class="ident" id="3853353">errors</span><span class="op" id="3853359">.</span><span class="ident" id="3853360">New</span><span class="op" id="3853363">(</span><span class="string" id="3853364">&#34;missing&nbsp;ServerKeyExchange&nbsp;message&#34;</span><span class="op" id="3853399">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853405">priv</span><span class="op" id="3853409">,</span>&nbsp;<span class="ident" id="3853411">mx</span><span class="op" id="3853413">,</span>&nbsp;<span class="ident" id="3853415">my</span><span class="op" id="3853417">,</span>&nbsp;<span class="ident" id="3853419">err</span>&nbsp;<span class="op" id="3853423">:=</span>&nbsp;<span class="ident" id="3853426">elliptic</span><span class="op" id="3853434">.</span><span class="ident" id="3853435">GenerateKey</span><span class="op" id="3853446">(</span><span class="ident" id="3853447">ka</span><span class="op" id="3853449">.</span><span class="ident" id="3853450">curve</span><span class="op" id="3853455">,</span>&nbsp;<span class="ident" id="3853457">config</span><span class="op" id="3853463">.</span><span class="ident" id="3853464">rand</span><span class="op" id="3853468">(</span><span class="op" id="3853469">)</span><span class="op" id="3853470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853473">if</span>&nbsp;<span class="ident" id="3853476">err</span>&nbsp;<span class="op" id="3853480">!=</span>&nbsp;<span class="builtintype" id="3853483">nil</span>&nbsp;<span class="op" id="3853487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853491">return</span>&nbsp;<span class="builtintype" id="3853498">nil</span><span class="op" id="3853501">,</span>&nbsp;<span class="builtintype" id="3853503">nil</span><span class="op" id="3853506">,</span>&nbsp;<span class="ident" id="3853508">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3853513">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853516">x</span><span class="op" id="3853517">,</span>&nbsp;<span class="ident" id="3853519">_</span>&nbsp;<span class="op" id="3853521">:=</span>&nbsp;<span class="ident" id="3853524">ka</span><span class="op" id="3853526">.</span><span class="ident" id="3853527">curve</span><span class="op" id="3853532">.</span><span class="ident" id="3853533">ScalarMult</span><span class="op" id="3853543">(</span><span class="ident" id="3853544">ka</span><span class="op" id="3853546">.</span><span class="ident" id="3853547">x</span><span class="op" id="3853548">,</span>&nbsp;<span class="ident" id="3853550">ka</span><span class="op" id="3853552">.</span><span class="ident" id="3853553">y</span><span class="op" id="3853554">,</span>&nbsp;<span class="ident" id="3853556">priv</span><span class="op" id="3853560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853563">preMasterSecret</span>&nbsp;<span class="op" id="3853579">:=</span>&nbsp;<span class="builtinfunc" id="3853582">make</span><span class="op" id="3853586">(</span><span class="op" id="3853587">[</span><span class="op" id="3853588">]</span><span class="builtintype" id="3853589">byte</span><span class="op" id="3853593">,</span>&nbsp;<span class="op" id="3853595">(</span><span class="ident" id="3853596">ka</span><span class="op" id="3853598">.</span><span class="ident" id="3853599">curve</span><span class="op" id="3853604">.</span><span class="ident" id="3853605">Params</span><span class="op" id="3853611">(</span><span class="op" id="3853612">)</span><span class="op" id="3853613">.</span><span class="ident" id="3853614">BitSize</span><span class="op" id="3853621">+</span><span class="num" id="3853622">7</span><span class="op" id="3853623">)</span><span class="op" id="3853624">&gt;&gt;</span><span class="num" id="3853626">3</span><span class="op" id="3853627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853630">xBytes</span>&nbsp;<span class="op" id="3853637">:=</span>&nbsp;<span class="ident" id="3853640">x</span><span class="op" id="3853641">.</span><span class="ident" id="3853642">Bytes</span><span class="op" id="3853647">(</span><span class="op" id="3853648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3853651">copy</span><span class="op" id="3853655">(</span><span class="ident" id="3853656">preMasterSecret</span><span class="op" id="3853671">[</span><span class="builtinfunc" id="3853672">len</span><span class="op" id="3853675">(</span><span class="ident" id="3853676">preMasterSecret</span><span class="op" id="3853691">)</span><span class="op" id="3853692">-</span><span class="builtinfunc" id="3853693">len</span><span class="op" id="3853696">(</span><span class="ident" id="3853697">xBytes</span><span class="op" id="3853703">)</span><span class="op" id="3853704">:</span><span class="op" id="3853705">]</span><span class="op" id="3853706">,</span>&nbsp;<span class="ident" id="3853708">xBytes</span><span class="op" id="3853714">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853718">serialized</span>&nbsp;<span class="op" id="3853729">:=</span>&nbsp;<span class="ident" id="3853732">elliptic</span><span class="op" id="3853740">.</span><span class="ident" id="3853741">Marshal</span><span class="op" id="3853748">(</span><span class="ident" id="3853749">ka</span><span class="op" id="3853751">.</span><span class="ident" id="3853752">curve</span><span class="op" id="3853757">,</span>&nbsp;<span class="ident" id="3853759">mx</span><span class="op" id="3853761">,</span>&nbsp;<span class="ident" id="3853763">my</span><span class="op" id="3853765">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853769">ckx</span>&nbsp;<span class="op" id="3853773">:=</span>&nbsp;<span class="builtinfunc" id="3853776">new</span><span class="op" id="3853779">(</span><span class="ident" id="3853780">clientKeyExchangeMsg</span><span class="op" id="3853800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853803">ckx</span><span class="op" id="3853806">.</span><span class="ident" id="3853807">ciphertext</span>&nbsp;<span class="op" id="3853818">=</span>&nbsp;<span class="builtinfunc" id="3853820">make</span><span class="op" id="3853824">(</span><span class="op" id="3853825">[</span><span class="op" id="3853826">]</span><span class="builtintype" id="3853827">byte</span><span class="op" id="3853831">,</span>&nbsp;<span class="num" id="3853833">1</span><span class="op" id="3853834">+</span><span class="builtinfunc" id="3853835">len</span><span class="op" id="3853838">(</span><span class="ident" id="3853839">serialized</span><span class="op" id="3853849">)</span><span class="op" id="3853850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3853853">ckx</span><span class="op" id="3853856">.</span><span class="ident" id="3853857">ciphertext</span><span class="op" id="3853867">[</span><span class="num" id="3853868">0</span><span class="op" id="3853869">]</span>&nbsp;<span class="op" id="3853871">=</span>&nbsp;<span class="builtintype" id="3853873">byte</span><span class="op" id="3853877">(</span><span class="builtinfunc" id="3853878">len</span><span class="op" id="3853881">(</span><span class="ident" id="3853882">serialized</span><span class="op" id="3853892">)</span><span class="op" id="3853893">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3853896">copy</span><span class="op" id="3853900">(</span><span class="ident" id="3853901">ckx</span><span class="op" id="3853904">.</span><span class="ident" id="3853905">ciphertext</span><span class="op" id="3853915">[</span><span class="num" id="3853916">1</span><span class="op" id="3853917">:</span><span class="op" id="3853918">]</span><span class="op" id="3853919">,</span>&nbsp;<span class="ident" id="3853921">serialized</span><span class="op" id="3853931">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3853935">return</span>&nbsp;<span class="ident" id="3853942">preMasterSecret</span><span class="op" id="3853957">,</span>&nbsp;<span class="ident" id="3853959">ckx</span><span class="op" id="3853962">,</span>&nbsp;<span class="builtintype" id="3853964">nil</span><br>
<span class="lineno"></span><span class="op" id="3853968">}</span>
</div>
</body>
</html>
