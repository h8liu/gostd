<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4290168">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4290223">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4290277">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4290328">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4290365">package</span>&nbsp;<span class="ident" id="4290373">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4290378">import</span>&nbsp;<span class="op" id="4290385">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4290388">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4290395">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4290409">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4290421">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4290431">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4290434">type</span>&nbsp;<span class="ident" id="4290439">pkgBuilder</span>&nbsp;<span class="keyword" id="4290450">struct</span>&nbsp;<span class="op" id="4290457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290460">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4290467">*</span><span class="ident" id="4290468">token</span><span class="op" id="4290473">.</span><span class="ident" id="4290474">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290483">errors</span>&nbsp;<span class="ident" id="4290490">scanner</span><span class="op" id="4290497">.</span><span class="ident" id="4290498">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="4290508">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4290511">func</span>&nbsp;<span class="op" id="4290516">(</span><span class="ident" id="4290517">p</span>&nbsp;<span class="op" id="4290519">*</span><span class="ident" id="4290520">pkgBuilder</span><span class="op" id="4290530">)</span>&nbsp;<span class="builtintype" id="4290532">error</span><span class="op" id="4290537">(</span><span class="ident" id="4290538">pos</span>&nbsp;<span class="ident" id="4290542">token</span><span class="op" id="4290547">.</span><span class="ident" id="4290548">Pos</span><span class="op" id="4290551">,</span>&nbsp;<span class="ident" id="4290553">msg</span>&nbsp;<span class="builtintype" id="4290557">string</span><span class="op" id="4290563">)</span>&nbsp;<span class="op" id="4290565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290568">p</span><span class="op" id="4290569">.</span><span class="ident" id="4290570">errors</span><span class="op" id="4290576">.</span><span class="ident" id="4290577">Add</span><span class="op" id="4290580">(</span><span class="ident" id="4290581">p</span><span class="op" id="4290582">.</span><span class="ident" id="4290583">fset</span><span class="op" id="4290587">.</span><span class="ident" id="4290588">Position</span><span class="op" id="4290596">(</span><span class="ident" id="4290597">pos</span><span class="op" id="4290600">)</span><span class="op" id="4290601">,</span>&nbsp;<span class="ident" id="4290603">msg</span><span class="op" id="4290606">)</span><br>
<span class="lineno"></span><span class="op" id="4290608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="4290611">func</span>&nbsp;<span class="op" id="4290616">(</span><span class="ident" id="4290617">p</span>&nbsp;<span class="op" id="4290619">*</span><span class="ident" id="4290620">pkgBuilder</span><span class="op" id="4290630">)</span>&nbsp;<span class="ident" id="4290632">errorf</span><span class="op" id="4290638">(</span><span class="ident" id="4290639">pos</span>&nbsp;<span class="ident" id="4290643">token</span><span class="op" id="4290648">.</span><span class="ident" id="4290649">Pos</span><span class="op" id="4290652">,</span>&nbsp;<span class="ident" id="4290654">format</span>&nbsp;<span class="builtintype" id="4290661">string</span><span class="op" id="4290667">,</span>&nbsp;<span class="ident" id="4290669">args</span>&nbsp;<span class="op" id="4290674">...</span><span class="keyword" id="4290677">interface</span><span class="op" id="4290686">{</span><span class="op" id="4290687">}</span><span class="op" id="4290688">)</span>&nbsp;<span class="op" id="4290690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290693">p</span><span class="op" id="4290694">.</span><span class="builtintype" id="4290695">error</span><span class="op" id="4290700">(</span><span class="ident" id="4290701">pos</span><span class="op" id="4290704">,</span>&nbsp;<span class="ident" id="4290706">fmt</span><span class="op" id="4290709">.</span><span class="ident" id="4290710">Sprintf</span><span class="op" id="4290717">(</span><span class="ident" id="4290718">format</span><span class="op" id="4290724">,</span>&nbsp;<span class="ident" id="4290726">args</span><span class="op" id="4290730">...</span><span class="op" id="4290733">)</span><span class="op" id="4290734">)</span><br>
<span class="lineno"></span><span class="op" id="4290736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4290739">func</span>&nbsp;<span class="op" id="4290744">(</span><span class="ident" id="4290745">p</span>&nbsp;<span class="op" id="4290747">*</span><span class="ident" id="4290748">pkgBuilder</span><span class="op" id="4290758">)</span>&nbsp;<span class="ident" id="4290760">declare</span><span class="op" id="4290767">(</span><span class="ident" id="4290768">scope</span><span class="op" id="4290773">,</span>&nbsp;<span class="ident" id="4290775">altScope</span>&nbsp;<span class="op" id="4290784">*</span><span class="ident" id="4290785">Scope</span><span class="op" id="4290790">,</span>&nbsp;<span class="ident" id="4290792">obj</span>&nbsp;<span class="op" id="4290796">*</span><span class="ident" id="4290797">Object</span><span class="op" id="4290803">)</span>&nbsp;<span class="op" id="4290805">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290808">alt</span>&nbsp;<span class="op" id="4290812">:=</span>&nbsp;<span class="ident" id="4290815">scope</span><span class="op" id="4290820">.</span><span class="ident" id="4290821">Insert</span><span class="op" id="4290827">(</span><span class="ident" id="4290828">obj</span><span class="op" id="4290831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4290834">if</span>&nbsp;<span class="ident" id="4290837">alt</span>&nbsp;<span class="op" id="4290841">==</span>&nbsp;<span class="ident" id="4290844">nil</span>&nbsp;<span class="op" id="4290848">&amp;&amp;</span>&nbsp;<span class="ident" id="4290851">altScope</span>&nbsp;<span class="op" id="4290860">!=</span>&nbsp;<span class="ident" id="4290863">nil</span>&nbsp;<span class="op" id="4290867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4290871">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290930">alt</span>&nbsp;<span class="op" id="4290934">=</span>&nbsp;<span class="ident" id="4290936">altScope</span><span class="op" id="4290944">.</span><span class="ident" id="4290945">Lookup</span><span class="op" id="4290951">(</span><span class="ident" id="4290952">obj</span><span class="op" id="4290955">.</span><span class="ident" id="4290956">Name</span><span class="op" id="4290960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4290963">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4290966">if</span>&nbsp;<span class="ident" id="4290969">alt</span>&nbsp;<span class="op" id="4290973">!=</span>&nbsp;<span class="ident" id="4290976">nil</span>&nbsp;<span class="op" id="4290980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4290984">prevDecl</span>&nbsp;<span class="op" id="4290993">:=</span>&nbsp;<span class="string" id="4290996">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4291001">if</span>&nbsp;<span class="ident" id="4291004">pos</span>&nbsp;<span class="op" id="4291008">:=</span>&nbsp;<span class="ident" id="4291011">alt</span><span class="op" id="4291014">.</span><span class="ident" id="4291015">Pos</span><span class="op" id="4291018">(</span><span class="op" id="4291019">)</span><span class="op" id="4291020">;</span>&nbsp;<span class="ident" id="4291022">pos</span><span class="op" id="4291025">.</span><span class="ident" id="4291026">IsValid</span><span class="op" id="4291033">(</span><span class="op" id="4291034">)</span>&nbsp;<span class="op" id="4291036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4291041">prevDecl</span>&nbsp;<span class="op" id="4291050">=</span>&nbsp;<span class="ident" id="4291052">fmt</span><span class="op" id="4291055">.</span><span class="ident" id="4291056">Sprintf</span><span class="op" id="4291063">(</span><span class="string" id="4291064">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="4291096">,</span>&nbsp;<span class="ident" id="4291098">p</span><span class="op" id="4291099">.</span><span class="ident" id="4291100">fset</span><span class="op" id="4291104">.</span><span class="ident" id="4291105">Position</span><span class="op" id="4291113">(</span><span class="ident" id="4291114">pos</span><span class="op" id="4291117">)</span><span class="op" id="4291118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4291122">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4291126">p</span><span class="op" id="4291127">.</span><span class="builtintype" id="4291128">error</span><span class="op" id="4291133">(</span><span class="ident" id="4291134">obj</span><span class="op" id="4291137">.</span><span class="ident" id="4291138">Pos</span><span class="op" id="4291141">(</span><span class="op" id="4291142">)</span><span class="op" id="4291143">,</span>&nbsp;<span class="ident" id="4291145">fmt</span><span class="op" id="4291148">.</span><span class="ident" id="4291149">Sprintf</span><span class="op" id="4291156">(</span><span class="string" id="4291157">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="4291188">,</span>&nbsp;<span class="ident" id="4291190">obj</span><span class="op" id="4291193">.</span><span class="ident" id="4291194">Name</span><span class="op" id="4291198">,</span>&nbsp;<span class="ident" id="4291200">prevDecl</span><span class="op" id="4291208">)</span><span class="op" id="4291209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4291212">}</span><br>
<span class="lineno"></span><span class="op" id="4291214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4291217">func</span>&nbsp;<span class="ident" id="4291222">resolve</span><span class="op" id="4291229">(</span><span class="ident" id="4291230">scope</span>&nbsp;<span class="op" id="4291236">*</span><span class="ident" id="4291237">Scope</span><span class="op" id="4291242">,</span>&nbsp;<span class="ident" id="4291244">ident</span>&nbsp;<span class="op" id="4291250">*</span><span class="ident" id="4291251">Ident</span><span class="op" id="4291256">)</span>&nbsp;<span class="builtintype" id="4291258">bool</span>&nbsp;<span class="op" id="4291263">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4291266">for</span>&nbsp;<span class="op" id="4291270">;</span>&nbsp;<span class="ident" id="4291272">scope</span>&nbsp;<span class="op" id="4291278">!=</span>&nbsp;<span class="ident" id="4291281">nil</span><span class="op" id="4291284">;</span>&nbsp;<span class="ident" id="4291286">scope</span>&nbsp;<span class="op" id="4291292">=</span>&nbsp;<span class="ident" id="4291294">scope</span><span class="op" id="4291299">.</span><span class="ident" id="4291300">Outer</span>&nbsp;<span class="op" id="4291306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4291310">if</span>&nbsp;<span class="ident" id="4291313">obj</span>&nbsp;<span class="op" id="4291317">:=</span>&nbsp;<span class="ident" id="4291320">scope</span><span class="op" id="4291325">.</span><span class="ident" id="4291326">Lookup</span><span class="op" id="4291332">(</span><span class="ident" id="4291333">ident</span><span class="op" id="4291338">.</span><span class="ident" id="4291339">Name</span><span class="op" id="4291343">)</span><span class="op" id="4291344">;</span>&nbsp;<span class="ident" id="4291346">obj</span>&nbsp;<span class="op" id="4291350">!=</span>&nbsp;<span class="ident" id="4291353">nil</span>&nbsp;<span class="op" id="4291357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4291362">ident</span><span class="op" id="4291367">.</span><span class="ident" id="4291368">Obj</span>&nbsp;<span class="op" id="4291372">=</span>&nbsp;<span class="ident" id="4291374">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4291381">return</span>&nbsp;<span class="builtintype" id="4291388">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4291395">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4291398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4291401">return</span>&nbsp;<span class="builtintype" id="4291408">false</span><br>
<span class="lineno"></span><span class="op" id="4291414">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4291417">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="4291474">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="4291532">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="4291582">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4291642">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="4291711">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="4291776">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="4291841">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="4291905">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="4291920">type</span>&nbsp;<span class="ident" id="4291925">Importer</span>&nbsp;<span class="keyword" id="4291934">func</span><span class="op" id="4291938">(</span><span class="ident" id="4291939">imports</span>&nbsp;<span class="keyword" id="4291947">map</span><span class="op" id="4291950">[</span><span class="builtintype" id="4291951">string</span><span class="op" id="4291957">]</span><span class="op" id="4291958">*</span><span class="ident" id="4291959">Object</span><span class="op" id="4291965">,</span>&nbsp;<span class="ident" id="4291967">path</span>&nbsp;<span class="builtintype" id="4291972">string</span><span class="op" id="4291978">)</span>&nbsp;<span class="op" id="4291980">(</span><span class="ident" id="4291981">pkg</span>&nbsp;<span class="op" id="4291985">*</span><span class="ident" id="4291986">Object</span><span class="op" id="4291992">,</span>&nbsp;<span class="ident" id="4291994">err</span>&nbsp;<span class="builtintype" id="4291998">error</span><span class="op" id="4292003">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4292006">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="4292085">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="4292164">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="4292244">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="4292321">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="4292398">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4292475">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="4292533">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="4292611">//</span><br>
<span class="lineno"></span><span class="keyword" id="4292614">func</span>&nbsp;<span class="ident" id="4292619">NewPackage</span><span class="op" id="4292629">(</span><span class="ident" id="4292630">fset</span>&nbsp;<span class="op" id="4292635">*</span><span class="ident" id="4292636">token</span><span class="op" id="4292641">.</span><span class="ident" id="4292642">FileSet</span><span class="op" id="4292649">,</span>&nbsp;<span class="ident" id="4292651">files</span>&nbsp;<span class="keyword" id="4292657">map</span><span class="op" id="4292660">[</span><span class="builtintype" id="4292661">string</span><span class="op" id="4292667">]</span><span class="op" id="4292668">*</span><span class="ident" id="4292669">File</span><span class="op" id="4292673">,</span>&nbsp;<span class="ident" id="4292675">importer</span>&nbsp;<span class="ident" id="4292684">Importer</span><span class="op" id="4292692">,</span>&nbsp;<span class="ident" id="4292694">universe</span>&nbsp;<span class="op" id="4292703">*</span><span class="ident" id="4292704">Scope</span><span class="op" id="4292709">)</span>&nbsp;<span class="op" id="4292711">(</span><span class="op" id="4292712">*</span><span class="ident" id="4292713">Package</span><span class="op" id="4292720">,</span>&nbsp;<span class="builtintype" id="4292722">error</span><span class="op" id="4292727">)</span>&nbsp;<span class="op" id="4292729">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4292732">var</span>&nbsp;<span class="ident" id="4292736">p</span>&nbsp;<span class="ident" id="4292738">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4292750">p</span><span class="op" id="4292751">.</span><span class="ident" id="4292752">fset</span>&nbsp;<span class="op" id="4292757">=</span>&nbsp;<span class="ident" id="4292759">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4292766">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4292793">pkgName</span>&nbsp;<span class="op" id="4292801">:=</span>&nbsp;<span class="string" id="4292804">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4292808">pkgScope</span>&nbsp;<span class="op" id="4292817">:=</span>&nbsp;<span class="ident" id="4292820">NewScope</span><span class="op" id="4292828">(</span><span class="ident" id="4292829">universe</span><span class="op" id="4292837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4292840">for</span>&nbsp;<span class="ident" id="4292844">_</span><span class="op" id="4292845">,</span>&nbsp;<span class="ident" id="4292847">file</span>&nbsp;<span class="op" id="4292852">:=</span>&nbsp;<span class="keyword" id="4292855">range</span>&nbsp;<span class="ident" id="4292861">files</span>&nbsp;<span class="op" id="4292867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4292871">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4292901">switch</span>&nbsp;<span class="ident" id="4292908">name</span>&nbsp;<span class="op" id="4292913">:=</span>&nbsp;<span class="ident" id="4292916">file</span><span class="op" id="4292920">.</span><span class="ident" id="4292921">Name</span><span class="op" id="4292925">.</span><span class="ident" id="4292926">Name</span><span class="op" id="4292930">;</span>&nbsp;<span class="op" id="4292932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4292936">case</span>&nbsp;<span class="ident" id="4292941">pkgName</span>&nbsp;<span class="op" id="4292949">==</span>&nbsp;<span class="string" id="4292952">&#34;&#34;</span><span class="op" id="4292954">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4292959">pkgName</span>&nbsp;<span class="op" id="4292967">=</span>&nbsp;<span class="ident" id="4292969">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4292976">case</span>&nbsp;<span class="ident" id="4292981">name</span>&nbsp;<span class="op" id="4292986">!=</span>&nbsp;<span class="ident" id="4292989">pkgName</span><span class="op" id="4292996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293001">p</span><span class="op" id="4293002">.</span><span class="ident" id="4293003">errorf</span><span class="op" id="4293009">(</span><span class="ident" id="4293010">file</span><span class="op" id="4293014">.</span><span class="ident" id="4293015">Package</span><span class="op" id="4293022">,</span>&nbsp;<span class="string" id="4293024">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="4293049">,</span>&nbsp;<span class="ident" id="4293051">name</span><span class="op" id="4293055">,</span>&nbsp;<span class="ident" id="4293057">pkgName</span><span class="op" id="4293064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293069">continue</span>&nbsp;<span class="comment" id="4293078">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4293100">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293105">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293158">for</span>&nbsp;<span class="ident" id="4293162">_</span><span class="op" id="4293163">,</span>&nbsp;<span class="ident" id="4293165">obj</span>&nbsp;<span class="op" id="4293169">:=</span>&nbsp;<span class="keyword" id="4293172">range</span>&nbsp;<span class="ident" id="4293178">file</span><span class="op" id="4293182">.</span><span class="ident" id="4293183">Scope</span><span class="op" id="4293188">.</span><span class="ident" id="4293189">Objects</span>&nbsp;<span class="op" id="4293197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293202">p</span><span class="op" id="4293203">.</span><span class="ident" id="4293204">declare</span><span class="op" id="4293211">(</span><span class="ident" id="4293212">pkgScope</span><span class="op" id="4293220">,</span>&nbsp;<span class="ident" id="4293222">nil</span><span class="op" id="4293225">,</span>&nbsp;<span class="ident" id="4293227">obj</span><span class="op" id="4293230">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4293234">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4293237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293241">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293311">imports</span>&nbsp;<span class="op" id="4293319">:=</span>&nbsp;<span class="builtinfunc" id="4293322">make</span><span class="op" id="4293326">(</span><span class="keyword" id="4293327">map</span><span class="op" id="4293330">[</span><span class="builtintype" id="4293331">string</span><span class="op" id="4293337">]</span><span class="op" id="4293338">*</span><span class="ident" id="4293339">Object</span><span class="op" id="4293345">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293349">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293411">for</span>&nbsp;<span class="ident" id="4293415">_</span><span class="op" id="4293416">,</span>&nbsp;<span class="ident" id="4293418">file</span>&nbsp;<span class="op" id="4293423">:=</span>&nbsp;<span class="keyword" id="4293426">range</span>&nbsp;<span class="ident" id="4293432">files</span>&nbsp;<span class="op" id="4293438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293442">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293496">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293535">if</span>&nbsp;<span class="ident" id="4293538">file</span><span class="op" id="4293542">.</span><span class="ident" id="4293543">Name</span><span class="op" id="4293547">.</span><span class="ident" id="4293548">Name</span>&nbsp;<span class="op" id="4293553">!=</span>&nbsp;<span class="ident" id="4293556">pkgName</span>&nbsp;<span class="op" id="4293564">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293569">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4293580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4293585">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293633">importErrors</span>&nbsp;<span class="op" id="4293646">:=</span>&nbsp;<span class="builtintype" id="4293649">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293657">fileScope</span>&nbsp;<span class="op" id="4293667">:=</span>&nbsp;<span class="ident" id="4293670">NewScope</span><span class="op" id="4293678">(</span><span class="ident" id="4293679">pkgScope</span><span class="op" id="4293687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293691">for</span>&nbsp;<span class="ident" id="4293695">_</span><span class="op" id="4293696">,</span>&nbsp;<span class="ident" id="4293698">spec</span>&nbsp;<span class="op" id="4293703">:=</span>&nbsp;<span class="keyword" id="4293706">range</span>&nbsp;<span class="ident" id="4293712">file</span><span class="op" id="4293716">.</span><span class="ident" id="4293717">Imports</span>&nbsp;<span class="op" id="4293725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293730">if</span>&nbsp;<span class="ident" id="4293733">importer</span>&nbsp;<span class="op" id="4293742">==</span>&nbsp;<span class="ident" id="4293745">nil</span>&nbsp;<span class="op" id="4293749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293755">importErrors</span>&nbsp;<span class="op" id="4293768">=</span>&nbsp;<span class="builtintype" id="4293770">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293779">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4293791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293796">path</span><span class="op" id="4293800">,</span>&nbsp;<span class="ident" id="4293802">_</span>&nbsp;<span class="op" id="4293804">:=</span>&nbsp;<span class="ident" id="4293807">strconv</span><span class="op" id="4293814">.</span><span class="ident" id="4293815">Unquote</span><span class="op" id="4293822">(</span><span class="ident" id="4293823">spec</span><span class="op" id="4293827">.</span><span class="ident" id="4293828">Path</span><span class="op" id="4293832">.</span><span class="ident" id="4293833">Value</span><span class="op" id="4293838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293843">pkg</span><span class="op" id="4293846">,</span>&nbsp;<span class="ident" id="4293848">err</span>&nbsp;<span class="op" id="4293852">:=</span>&nbsp;<span class="ident" id="4293855">importer</span><span class="op" id="4293863">(</span><span class="ident" id="4293864">imports</span><span class="op" id="4293871">,</span>&nbsp;<span class="ident" id="4293873">path</span><span class="op" id="4293877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293882">if</span>&nbsp;<span class="ident" id="4293885">err</span>&nbsp;<span class="op" id="4293889">!=</span>&nbsp;<span class="ident" id="4293892">nil</span>&nbsp;<span class="op" id="4293896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293902">p</span><span class="op" id="4293903">.</span><span class="ident" id="4293904">errorf</span><span class="op" id="4293910">(</span><span class="ident" id="4293911">spec</span><span class="op" id="4293915">.</span><span class="ident" id="4293916">Path</span><span class="op" id="4293920">.</span><span class="ident" id="4293921">Pos</span><span class="op" id="4293924">(</span><span class="op" id="4293925">)</span><span class="op" id="4293926">,</span>&nbsp;<span class="string" id="4293928">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="4293954">,</span>&nbsp;<span class="ident" id="4293956">path</span><span class="op" id="4293960">,</span>&nbsp;<span class="ident" id="4293962">err</span><span class="op" id="4293965">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4293971">importErrors</span>&nbsp;<span class="op" id="4293984">=</span>&nbsp;<span class="builtintype" id="4293986">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4293995">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294012">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294072">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294133">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294196">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294245">name</span>&nbsp;<span class="op" id="4294250">:=</span>&nbsp;<span class="ident" id="4294253">pkg</span><span class="op" id="4294256">.</span><span class="ident" id="4294257">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4294265">if</span>&nbsp;<span class="ident" id="4294268">spec</span><span class="op" id="4294272">.</span><span class="ident" id="4294273">Name</span>&nbsp;<span class="op" id="4294278">!=</span>&nbsp;<span class="ident" id="4294281">nil</span>&nbsp;<span class="op" id="4294285">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294291">name</span>&nbsp;<span class="op" id="4294296">=</span>&nbsp;<span class="ident" id="4294298">spec</span><span class="op" id="4294302">.</span><span class="ident" id="4294303">Name</span><span class="op" id="4294307">.</span><span class="ident" id="4294308">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294322">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4294353">if</span>&nbsp;<span class="ident" id="4294356">name</span>&nbsp;<span class="op" id="4294361">==</span>&nbsp;<span class="string" id="4294364">&#34;.&#34;</span>&nbsp;<span class="op" id="4294368">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294374">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4294418">for</span>&nbsp;<span class="ident" id="4294422">_</span><span class="op" id="4294423">,</span>&nbsp;<span class="ident" id="4294425">obj</span>&nbsp;<span class="op" id="4294429">:=</span>&nbsp;<span class="keyword" id="4294432">range</span>&nbsp;<span class="ident" id="4294438">pkg</span><span class="op" id="4294441">.</span><span class="ident" id="4294442">Data</span><span class="op" id="4294446">.</span><span class="op" id="4294447">(</span><span class="op" id="4294448">*</span><span class="ident" id="4294449">Scope</span><span class="op" id="4294454">)</span><span class="op" id="4294455">.</span><span class="ident" id="4294456">Objects</span>&nbsp;<span class="op" id="4294464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294471">p</span><span class="op" id="4294472">.</span><span class="ident" id="4294473">declare</span><span class="op" id="4294480">(</span><span class="ident" id="4294481">fileScope</span><span class="op" id="4294490">,</span>&nbsp;<span class="ident" id="4294492">pkgScope</span><span class="op" id="4294500">,</span>&nbsp;<span class="ident" id="4294502">obj</span><span class="op" id="4294505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294516">}</span>&nbsp;<span class="keyword" id="4294518">else</span>&nbsp;<span class="keyword" id="4294523">if</span>&nbsp;<span class="ident" id="4294526">name</span>&nbsp;<span class="op" id="4294531">!=</span>&nbsp;<span class="string" id="4294534">&#34;_&#34;</span>&nbsp;<span class="op" id="4294538">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294544">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294597">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294652">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294709">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294737">obj</span>&nbsp;<span class="op" id="4294741">:=</span>&nbsp;<span class="ident" id="4294744">NewObj</span><span class="op" id="4294750">(</span><span class="ident" id="4294751">Pkg</span><span class="op" id="4294754">,</span>&nbsp;<span class="ident" id="4294756">name</span><span class="op" id="4294760">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294766">obj</span><span class="op" id="4294769">.</span><span class="ident" id="4294770">Decl</span>&nbsp;<span class="op" id="4294775">=</span>&nbsp;<span class="ident" id="4294777">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294786">obj</span><span class="op" id="4294789">.</span><span class="ident" id="4294790">Data</span>&nbsp;<span class="op" id="4294795">=</span>&nbsp;<span class="ident" id="4294797">pkg</span><span class="op" id="4294800">.</span><span class="ident" id="4294801">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4294810">p</span><span class="op" id="4294811">.</span><span class="ident" id="4294812">declare</span><span class="op" id="4294819">(</span><span class="ident" id="4294820">fileScope</span><span class="op" id="4294829">,</span>&nbsp;<span class="ident" id="4294831">pkgScope</span><span class="op" id="4294839">,</span>&nbsp;<span class="ident" id="4294841">obj</span><span class="op" id="4294844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4294853">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294858">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4294883">if</span>&nbsp;<span class="ident" id="4294886">importErrors</span>&nbsp;<span class="op" id="4294899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294904">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4294963">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4295022">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4295081">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295120">pkgScope</span><span class="op" id="4295128">.</span><span class="ident" id="4295129">Outer</span>&nbsp;<span class="op" id="4295135">=</span>&nbsp;<span class="ident" id="4295137">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4295143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295147">i</span>&nbsp;<span class="op" id="4295149">:=</span>&nbsp;<span class="num" id="4295152">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4295156">for</span>&nbsp;<span class="ident" id="4295160">_</span><span class="op" id="4295161">,</span>&nbsp;<span class="ident" id="4295163">ident</span>&nbsp;<span class="op" id="4295169">:=</span>&nbsp;<span class="keyword" id="4295172">range</span>&nbsp;<span class="ident" id="4295178">file</span><span class="op" id="4295182">.</span><span class="ident" id="4295183">Unresolved</span>&nbsp;<span class="op" id="4295194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4295199">if</span>&nbsp;<span class="op" id="4295202">!</span><span class="ident" id="4295203">resolve</span><span class="op" id="4295210">(</span><span class="ident" id="4295211">fileScope</span><span class="op" id="4295220">,</span>&nbsp;<span class="ident" id="4295222">ident</span><span class="op" id="4295227">)</span>&nbsp;<span class="op" id="4295229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295235">p</span><span class="op" id="4295236">.</span><span class="ident" id="4295237">errorf</span><span class="op" id="4295243">(</span><span class="ident" id="4295244">ident</span><span class="op" id="4295249">.</span><span class="ident" id="4295250">Pos</span><span class="op" id="4295253">(</span><span class="op" id="4295254">)</span><span class="op" id="4295255">,</span>&nbsp;<span class="string" id="4295257">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="4295278">,</span>&nbsp;<span class="ident" id="4295280">ident</span><span class="op" id="4295285">.</span><span class="ident" id="4295286">Name</span><span class="op" id="4295290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295296">file</span><span class="op" id="4295300">.</span><span class="ident" id="4295301">Unresolved</span><span class="op" id="4295311">[</span><span class="ident" id="4295312">i</span><span class="op" id="4295313">]</span>&nbsp;<span class="op" id="4295315">=</span>&nbsp;<span class="ident" id="4295317">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295327">i</span><span class="op" id="4295328">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4295334">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4295339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295343">file</span><span class="op" id="4295347">.</span><span class="ident" id="4295348">Unresolved</span>&nbsp;<span class="op" id="4295359">=</span>&nbsp;<span class="ident" id="4295361">file</span><span class="op" id="4295365">.</span><span class="ident" id="4295366">Unresolved</span><span class="op" id="4295376">[</span><span class="num" id="4295377">0</span><span class="op" id="4295378">:</span><span class="ident" id="4295379">i</span><span class="op" id="4295380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295384">pkgScope</span><span class="op" id="4295392">.</span><span class="ident" id="4295393">Outer</span>&nbsp;<span class="op" id="4295399">=</span>&nbsp;<span class="ident" id="4295401">universe</span>&nbsp;<span class="comment" id="4295410">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4295435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4295439">p</span><span class="op" id="4295440">.</span><span class="ident" id="4295441">errors</span><span class="op" id="4295447">.</span><span class="ident" id="4295448">Sort</span><span class="op" id="4295452">(</span><span class="op" id="4295453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4295456">return</span>&nbsp;<span class="op" id="4295463">&amp;</span><span class="ident" id="4295464">Package</span><span class="op" id="4295471">{</span><span class="ident" id="4295472">pkgName</span><span class="op" id="4295479">,</span>&nbsp;<span class="ident" id="4295481">pkgScope</span><span class="op" id="4295489">,</span>&nbsp;<span class="ident" id="4295491">imports</span><span class="op" id="4295498">,</span>&nbsp;<span class="ident" id="4295500">files</span><span class="op" id="4295505">}</span><span class="op" id="4295506">,</span>&nbsp;<span class="ident" id="4295508">p</span><span class="op" id="4295509">.</span><span class="ident" id="4295510">errors</span><span class="op" id="4295516">.</span><span class="ident" id="4295517">Err</span><span class="op" id="4295520">(</span><span class="op" id="4295521">)</span><br>
<span class="lineno"></span><span class="op" id="4295523">}</span>
</div>
</body>
</html>
