<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html" class="current">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3999090">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3999145">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3999199">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3999250">package</span>&nbsp;<span class="ident" id="3999258">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3999263">import</span>&nbsp;<span class="op" id="3999270">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999273">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999282">&#34;crypto/aes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999296">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999313">&#34;crypto/hmac&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999328">&#34;crypto/sha256&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999345">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999362">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3999372">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3999377">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3999380">//&nbsp;sessionState&nbsp;contains&nbsp;the&nbsp;information&nbsp;that&nbsp;is&nbsp;serialized&nbsp;into&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span><span class="comment" id="3999455">//&nbsp;ticket&nbsp;in&nbsp;order&nbsp;to&nbsp;later&nbsp;resume&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="3999504">type</span>&nbsp;<span class="ident" id="3999509">sessionState</span>&nbsp;<span class="keyword" id="3999522">struct</span>&nbsp;<span class="op" id="3999529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999532">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3999545">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999553">cipherSuite</span>&nbsp;&nbsp;<span class="builtintype" id="3999566">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999574">masterSecret</span>&nbsp;<span class="op" id="3999587">[</span><span class="op" id="3999588">]</span><span class="builtintype" id="3999589">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999595">certificates</span>&nbsp;<span class="op" id="3999608">[</span><span class="op" id="3999609">]</span><span class="op" id="3999610">[</span><span class="op" id="3999611">]</span><span class="builtintype" id="3999612">byte</span><br>
<span class="lineno">25</span><span class="op" id="3999617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3999620">func</span>&nbsp;<span class="op" id="3999625">(</span><span class="ident" id="3999626">s</span>&nbsp;<span class="op" id="3999628">*</span><span class="ident" id="3999629">sessionState</span><span class="op" id="3999641">)</span>&nbsp;<span class="ident" id="3999643">equal</span><span class="op" id="3999648">(</span><span class="ident" id="3999649">i</span>&nbsp;<span class="keyword" id="3999651">interface</span><span class="op" id="3999660">{</span><span class="op" id="3999661">}</span><span class="op" id="3999662">)</span>&nbsp;<span class="builtintype" id="3999664">bool</span>&nbsp;<span class="op" id="3999669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999672">s1</span><span class="op" id="3999674">,</span>&nbsp;<span class="ident" id="3999676">ok</span>&nbsp;<span class="op" id="3999679">:=</span>&nbsp;<span class="ident" id="3999682">i</span><span class="op" id="3999683">.</span><span class="op" id="3999684">(</span><span class="op" id="3999685">*</span><span class="ident" id="3999686">sessionState</span><span class="op" id="3999698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999701">if</span>&nbsp;<span class="op" id="3999704">!</span><span class="ident" id="3999705">ok</span>&nbsp;<span class="op" id="3999708">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999712">return</span>&nbsp;<span class="builtintype" id="3999719">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3999726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999730">if</span>&nbsp;<span class="ident" id="3999733">s</span><span class="op" id="3999734">.</span><span class="ident" id="3999735">vers</span>&nbsp;<span class="op" id="3999740">!=</span>&nbsp;<span class="ident" id="3999743">s1</span><span class="op" id="3999745">.</span><span class="ident" id="3999746">vers</span>&nbsp;<span class="op" id="3999751">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999756">s</span><span class="op" id="3999757">.</span><span class="ident" id="3999758">cipherSuite</span>&nbsp;<span class="op" id="3999770">!=</span>&nbsp;<span class="ident" id="3999773">s1</span><span class="op" id="3999775">.</span><span class="ident" id="3999776">cipherSuite</span>&nbsp;<span class="op" id="3999788">||</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3999793">!</span><span class="ident" id="3999794">bytes</span><span class="op" id="3999799">.</span><span class="ident" id="3999800">Equal</span><span class="op" id="3999805">(</span><span class="ident" id="3999806">s</span><span class="op" id="3999807">.</span><span class="ident" id="3999808">masterSecret</span><span class="op" id="3999820">,</span>&nbsp;<span class="ident" id="3999822">s1</span><span class="op" id="3999824">.</span><span class="ident" id="3999825">masterSecret</span><span class="op" id="3999837">)</span>&nbsp;<span class="op" id="3999839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999843">return</span>&nbsp;<span class="builtintype" id="3999850">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3999857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999861">if</span>&nbsp;<span class="builtinfunc" id="3999864">len</span><span class="op" id="3999867">(</span><span class="ident" id="3999868">s</span><span class="op" id="3999869">.</span><span class="ident" id="3999870">certificates</span><span class="op" id="3999882">)</span>&nbsp;<span class="op" id="3999884">!=</span>&nbsp;<span class="builtinfunc" id="3999887">len</span><span class="op" id="3999890">(</span><span class="ident" id="3999891">s1</span><span class="op" id="3999893">.</span><span class="ident" id="3999894">certificates</span><span class="op" id="3999906">)</span>&nbsp;<span class="op" id="3999908">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999912">return</span>&nbsp;<span class="builtintype" id="3999919">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3999926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999930">for</span>&nbsp;<span class="ident" id="3999934">i</span>&nbsp;<span class="op" id="3999936">:=</span>&nbsp;<span class="keyword" id="3999939">range</span>&nbsp;<span class="ident" id="3999945">s</span><span class="op" id="3999946">.</span><span class="ident" id="3999947">certificates</span>&nbsp;<span class="op" id="3999960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999964">if</span>&nbsp;<span class="op" id="3999967">!</span><span class="ident" id="3999968">bytes</span><span class="op" id="3999973">.</span><span class="ident" id="3999974">Equal</span><span class="op" id="3999979">(</span><span class="ident" id="3999980">s</span><span class="op" id="3999981">.</span><span class="ident" id="3999982">certificates</span><span class="op" id="3999994">[</span><span class="ident" id="3999995">i</span><span class="op" id="3999996">]</span><span class="op" id="3999997">,</span>&nbsp;<span class="ident" id="3999999">s1</span><span class="op" id="4000001">.</span><span class="ident" id="4000002">certificates</span><span class="op" id="4000014">[</span><span class="ident" id="4000015">i</span><span class="op" id="4000016">]</span><span class="op" id="4000017">)</span>&nbsp;<span class="op" id="4000019">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000024">return</span>&nbsp;<span class="builtintype" id="4000031">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4000039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4000042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000046">return</span>&nbsp;<span class="builtintype" id="4000053">true</span><br>
<span class="lineno">50</span><span class="op" id="4000058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4000061">func</span>&nbsp;<span class="op" id="4000066">(</span><span class="ident" id="4000067">s</span>&nbsp;<span class="op" id="4000069">*</span><span class="ident" id="4000070">sessionState</span><span class="op" id="4000082">)</span>&nbsp;<span class="ident" id="4000084">marshal</span><span class="op" id="4000091">(</span><span class="op" id="4000092">)</span>&nbsp;<span class="op" id="4000094">[</span><span class="op" id="4000095">]</span><span class="builtintype" id="4000096">byte</span>&nbsp;<span class="op" id="4000101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000104">length</span>&nbsp;<span class="op" id="4000111">:=</span>&nbsp;<span class="num" id="4000114">2</span>&nbsp;<span class="op" id="4000116">+</span>&nbsp;<span class="num" id="4000118">2</span>&nbsp;<span class="op" id="4000120">+</span>&nbsp;<span class="num" id="4000122">2</span>&nbsp;<span class="op" id="4000124">+</span>&nbsp;<span class="builtinfunc" id="4000126">len</span><span class="op" id="4000129">(</span><span class="ident" id="4000130">s</span><span class="op" id="4000131">.</span><span class="ident" id="4000132">masterSecret</span><span class="op" id="4000144">)</span>&nbsp;<span class="op" id="4000146">+</span>&nbsp;<span class="num" id="4000148">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000151">for</span>&nbsp;<span class="ident" id="4000155">_</span><span class="op" id="4000156">,</span>&nbsp;<span class="ident" id="4000158">cert</span>&nbsp;<span class="op" id="4000163">:=</span>&nbsp;<span class="keyword" id="4000166">range</span>&nbsp;<span class="ident" id="4000172">s</span><span class="op" id="4000173">.</span><span class="ident" id="4000174">certificates</span>&nbsp;<span class="op" id="4000187">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000191">length</span>&nbsp;<span class="op" id="4000198">+=</span>&nbsp;<span class="num" id="4000201">4</span>&nbsp;<span class="op" id="4000203">+</span>&nbsp;<span class="builtinfunc" id="4000205">len</span><span class="op" id="4000208">(</span><span class="ident" id="4000209">cert</span><span class="op" id="4000213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4000216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000220">ret</span>&nbsp;<span class="op" id="4000224">:=</span>&nbsp;<span class="builtinfunc" id="4000227">make</span><span class="op" id="4000231">(</span><span class="op" id="4000232">[</span><span class="op" id="4000233">]</span><span class="builtintype" id="4000234">byte</span><span class="op" id="4000238">,</span>&nbsp;<span class="ident" id="4000240">length</span><span class="op" id="4000246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000249">x</span>&nbsp;<span class="op" id="4000251">:=</span>&nbsp;<span class="ident" id="4000254">ret</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000259">x</span><span class="op" id="4000260">[</span><span class="num" id="4000261">0</span><span class="op" id="4000262">]</span>&nbsp;<span class="op" id="4000264">=</span>&nbsp;<span class="builtintype" id="4000266">byte</span><span class="op" id="4000270">(</span><span class="ident" id="4000271">s</span><span class="op" id="4000272">.</span><span class="ident" id="4000273">vers</span>&nbsp;<span class="op" id="4000278">&gt;&gt;</span>&nbsp;<span class="num" id="4000281">8</span><span class="op" id="4000282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000285">x</span><span class="op" id="4000286">[</span><span class="num" id="4000287">1</span><span class="op" id="4000288">]</span>&nbsp;<span class="op" id="4000290">=</span>&nbsp;<span class="builtintype" id="4000292">byte</span><span class="op" id="4000296">(</span><span class="ident" id="4000297">s</span><span class="op" id="4000298">.</span><span class="ident" id="4000299">vers</span><span class="op" id="4000303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000306">x</span><span class="op" id="4000307">[</span><span class="num" id="4000308">2</span><span class="op" id="4000309">]</span>&nbsp;<span class="op" id="4000311">=</span>&nbsp;<span class="builtintype" id="4000313">byte</span><span class="op" id="4000317">(</span><span class="ident" id="4000318">s</span><span class="op" id="4000319">.</span><span class="ident" id="4000320">cipherSuite</span>&nbsp;<span class="op" id="4000332">&gt;&gt;</span>&nbsp;<span class="num" id="4000335">8</span><span class="op" id="4000336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000339">x</span><span class="op" id="4000340">[</span><span class="num" id="4000341">3</span><span class="op" id="4000342">]</span>&nbsp;<span class="op" id="4000344">=</span>&nbsp;<span class="builtintype" id="4000346">byte</span><span class="op" id="4000350">(</span><span class="ident" id="4000351">s</span><span class="op" id="4000352">.</span><span class="ident" id="4000353">cipherSuite</span><span class="op" id="4000364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000367">x</span><span class="op" id="4000368">[</span><span class="num" id="4000369">4</span><span class="op" id="4000370">]</span>&nbsp;<span class="op" id="4000372">=</span>&nbsp;<span class="builtintype" id="4000374">byte</span><span class="op" id="4000378">(</span><span class="builtinfunc" id="4000379">len</span><span class="op" id="4000382">(</span><span class="ident" id="4000383">s</span><span class="op" id="4000384">.</span><span class="ident" id="4000385">masterSecret</span><span class="op" id="4000397">)</span>&nbsp;<span class="op" id="4000399">&gt;&gt;</span>&nbsp;<span class="num" id="4000402">8</span><span class="op" id="4000403">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000406">x</span><span class="op" id="4000407">[</span><span class="num" id="4000408">5</span><span class="op" id="4000409">]</span>&nbsp;<span class="op" id="4000411">=</span>&nbsp;<span class="builtintype" id="4000413">byte</span><span class="op" id="4000417">(</span><span class="builtinfunc" id="4000418">len</span><span class="op" id="4000421">(</span><span class="ident" id="4000422">s</span><span class="op" id="4000423">.</span><span class="ident" id="4000424">masterSecret</span><span class="op" id="4000436">)</span><span class="op" id="4000437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000440">x</span>&nbsp;<span class="op" id="4000442">=</span>&nbsp;<span class="ident" id="4000444">x</span><span class="op" id="4000445">[</span><span class="num" id="4000446">6</span><span class="op" id="4000447">:</span><span class="op" id="4000448">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4000451">copy</span><span class="op" id="4000455">(</span><span class="ident" id="4000456">x</span><span class="op" id="4000457">,</span>&nbsp;<span class="ident" id="4000459">s</span><span class="op" id="4000460">.</span><span class="ident" id="4000461">masterSecret</span><span class="op" id="4000473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000476">x</span>&nbsp;<span class="op" id="4000478">=</span>&nbsp;<span class="ident" id="4000480">x</span><span class="op" id="4000481">[</span><span class="builtinfunc" id="4000482">len</span><span class="op" id="4000485">(</span><span class="ident" id="4000486">s</span><span class="op" id="4000487">.</span><span class="ident" id="4000488">masterSecret</span><span class="op" id="4000500">)</span><span class="op" id="4000501">:</span><span class="op" id="4000502">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000506">x</span><span class="op" id="4000507">[</span><span class="num" id="4000508">0</span><span class="op" id="4000509">]</span>&nbsp;<span class="op" id="4000511">=</span>&nbsp;<span class="builtintype" id="4000513">byte</span><span class="op" id="4000517">(</span><span class="builtinfunc" id="4000518">len</span><span class="op" id="4000521">(</span><span class="ident" id="4000522">s</span><span class="op" id="4000523">.</span><span class="ident" id="4000524">certificates</span><span class="op" id="4000536">)</span>&nbsp;<span class="op" id="4000538">&gt;&gt;</span>&nbsp;<span class="num" id="4000541">8</span><span class="op" id="4000542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000545">x</span><span class="op" id="4000546">[</span><span class="num" id="4000547">1</span><span class="op" id="4000548">]</span>&nbsp;<span class="op" id="4000550">=</span>&nbsp;<span class="builtintype" id="4000552">byte</span><span class="op" id="4000556">(</span><span class="builtinfunc" id="4000557">len</span><span class="op" id="4000560">(</span><span class="ident" id="4000561">s</span><span class="op" id="4000562">.</span><span class="ident" id="4000563">certificates</span><span class="op" id="4000575">)</span><span class="op" id="4000576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000579">x</span>&nbsp;<span class="op" id="4000581">=</span>&nbsp;<span class="ident" id="4000583">x</span><span class="op" id="4000584">[</span><span class="num" id="4000585">2</span><span class="op" id="4000586">:</span><span class="op" id="4000587">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000591">for</span>&nbsp;<span class="ident" id="4000595">_</span><span class="op" id="4000596">,</span>&nbsp;<span class="ident" id="4000598">cert</span>&nbsp;<span class="op" id="4000603">:=</span>&nbsp;<span class="keyword" id="4000606">range</span>&nbsp;<span class="ident" id="4000612">s</span><span class="op" id="4000613">.</span><span class="ident" id="4000614">certificates</span>&nbsp;<span class="op" id="4000627">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000631">x</span><span class="op" id="4000632">[</span><span class="num" id="4000633">0</span><span class="op" id="4000634">]</span>&nbsp;<span class="op" id="4000636">=</span>&nbsp;<span class="builtintype" id="4000638">byte</span><span class="op" id="4000642">(</span><span class="builtinfunc" id="4000643">len</span><span class="op" id="4000646">(</span><span class="ident" id="4000647">cert</span><span class="op" id="4000651">)</span>&nbsp;<span class="op" id="4000653">&gt;&gt;</span>&nbsp;<span class="num" id="4000656">24</span><span class="op" id="4000658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000662">x</span><span class="op" id="4000663">[</span><span class="num" id="4000664">1</span><span class="op" id="4000665">]</span>&nbsp;<span class="op" id="4000667">=</span>&nbsp;<span class="builtintype" id="4000669">byte</span><span class="op" id="4000673">(</span><span class="builtinfunc" id="4000674">len</span><span class="op" id="4000677">(</span><span class="ident" id="4000678">cert</span><span class="op" id="4000682">)</span>&nbsp;<span class="op" id="4000684">&gt;&gt;</span>&nbsp;<span class="num" id="4000687">16</span><span class="op" id="4000689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000693">x</span><span class="op" id="4000694">[</span><span class="num" id="4000695">2</span><span class="op" id="4000696">]</span>&nbsp;<span class="op" id="4000698">=</span>&nbsp;<span class="builtintype" id="4000700">byte</span><span class="op" id="4000704">(</span><span class="builtinfunc" id="4000705">len</span><span class="op" id="4000708">(</span><span class="ident" id="4000709">cert</span><span class="op" id="4000713">)</span>&nbsp;<span class="op" id="4000715">&gt;&gt;</span>&nbsp;<span class="num" id="4000718">8</span><span class="op" id="4000719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000723">x</span><span class="op" id="4000724">[</span><span class="num" id="4000725">3</span><span class="op" id="4000726">]</span>&nbsp;<span class="op" id="4000728">=</span>&nbsp;<span class="builtintype" id="4000730">byte</span><span class="op" id="4000734">(</span><span class="builtinfunc" id="4000735">len</span><span class="op" id="4000738">(</span><span class="ident" id="4000739">cert</span><span class="op" id="4000743">)</span><span class="op" id="4000744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4000748">copy</span><span class="op" id="4000752">(</span><span class="ident" id="4000753">x</span><span class="op" id="4000754">[</span><span class="num" id="4000755">4</span><span class="op" id="4000756">:</span><span class="op" id="4000757">]</span><span class="op" id="4000758">,</span>&nbsp;<span class="ident" id="4000760">cert</span><span class="op" id="4000764">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000768">x</span>&nbsp;<span class="op" id="4000770">=</span>&nbsp;<span class="ident" id="4000772">x</span><span class="op" id="4000773">[</span><span class="num" id="4000774">4</span><span class="op" id="4000775">+</span><span class="builtinfunc" id="4000776">len</span><span class="op" id="4000779">(</span><span class="ident" id="4000780">cert</span><span class="op" id="4000784">)</span><span class="op" id="4000785">:</span><span class="op" id="4000786">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4000789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000793">return</span>&nbsp;<span class="ident" id="4000800">ret</span><br>
<span class="lineno"></span><span class="op" id="4000804">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4000807">func</span>&nbsp;<span class="op" id="4000812">(</span><span class="ident" id="4000813">s</span>&nbsp;<span class="op" id="4000815">*</span><span class="ident" id="4000816">sessionState</span><span class="op" id="4000828">)</span>&nbsp;<span class="ident" id="4000830">unmarshal</span><span class="op" id="4000839">(</span><span class="ident" id="4000840">data</span>&nbsp;<span class="op" id="4000845">[</span><span class="op" id="4000846">]</span><span class="builtintype" id="4000847">byte</span><span class="op" id="4000851">)</span>&nbsp;<span class="builtintype" id="4000853">bool</span>&nbsp;<span class="op" id="4000858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000861">if</span>&nbsp;<span class="builtinfunc" id="4000864">len</span><span class="op" id="4000867">(</span><span class="ident" id="4000868">data</span><span class="op" id="4000872">)</span>&nbsp;<span class="op" id="4000874">&lt;</span>&nbsp;<span class="num" id="4000876">8</span>&nbsp;<span class="op" id="4000878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4000882">return</span>&nbsp;<span class="builtintype" id="4000889">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4000896">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000900">s</span><span class="op" id="4000901">.</span><span class="ident" id="4000902">vers</span>&nbsp;<span class="op" id="4000907">=</span>&nbsp;<span class="builtintype" id="4000909">uint16</span><span class="op" id="4000915">(</span><span class="ident" id="4000916">data</span><span class="op" id="4000920">[</span><span class="num" id="4000921">0</span><span class="op" id="4000922">]</span><span class="op" id="4000923">)</span><span class="op" id="4000924">&lt;&lt;</span><span class="num" id="4000926">8</span>&nbsp;<span class="op" id="4000928">|</span>&nbsp;<span class="builtintype" id="4000930">uint16</span><span class="op" id="4000936">(</span><span class="ident" id="4000937">data</span><span class="op" id="4000941">[</span><span class="num" id="4000942">1</span><span class="op" id="4000943">]</span><span class="op" id="4000944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4000947">s</span><span class="op" id="4000948">.</span><span class="ident" id="4000949">cipherSuite</span>&nbsp;<span class="op" id="4000961">=</span>&nbsp;<span class="builtintype" id="4000963">uint16</span><span class="op" id="4000969">(</span><span class="ident" id="4000970">data</span><span class="op" id="4000974">[</span><span class="num" id="4000975">2</span><span class="op" id="4000976">]</span><span class="op" id="4000977">)</span><span class="op" id="4000978">&lt;&lt;</span><span class="num" id="4000980">8</span>&nbsp;<span class="op" id="4000982">|</span>&nbsp;<span class="builtintype" id="4000984">uint16</span><span class="op" id="4000990">(</span><span class="ident" id="4000991">data</span><span class="op" id="4000995">[</span><span class="num" id="4000996">3</span><span class="op" id="4000997">]</span><span class="op" id="4000998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001001">masterSecretLen</span>&nbsp;<span class="op" id="4001017">:=</span>&nbsp;<span class="builtintype" id="4001020">int</span><span class="op" id="4001023">(</span><span class="ident" id="4001024">data</span><span class="op" id="4001028">[</span><span class="num" id="4001029">4</span><span class="op" id="4001030">]</span><span class="op" id="4001031">)</span><span class="op" id="4001032">&lt;&lt;</span><span class="num" id="4001034">8</span>&nbsp;<span class="op" id="4001036">|</span>&nbsp;<span class="builtintype" id="4001038">int</span><span class="op" id="4001041">(</span><span class="ident" id="4001042">data</span><span class="op" id="4001046">[</span><span class="num" id="4001047">5</span><span class="op" id="4001048">]</span><span class="op" id="4001049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001052">data</span>&nbsp;<span class="op" id="4001057">=</span>&nbsp;<span class="ident" id="4001059">data</span><span class="op" id="4001063">[</span><span class="num" id="4001064">6</span><span class="op" id="4001065">:</span><span class="op" id="4001066">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001069">if</span>&nbsp;<span class="builtinfunc" id="4001072">len</span><span class="op" id="4001075">(</span><span class="ident" id="4001076">data</span><span class="op" id="4001080">)</span>&nbsp;<span class="op" id="4001082">&lt;</span>&nbsp;<span class="ident" id="4001084">masterSecretLen</span>&nbsp;<span class="op" id="4001100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001104">return</span>&nbsp;<span class="builtintype" id="4001111">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001122">s</span><span class="op" id="4001123">.</span><span class="ident" id="4001124">masterSecret</span>&nbsp;<span class="op" id="4001137">=</span>&nbsp;<span class="ident" id="4001139">data</span><span class="op" id="4001143">[</span><span class="op" id="4001144">:</span><span class="ident" id="4001145">masterSecretLen</span><span class="op" id="4001160">]</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001163">data</span>&nbsp;<span class="op" id="4001168">=</span>&nbsp;<span class="ident" id="4001170">data</span><span class="op" id="4001174">[</span><span class="ident" id="4001175">masterSecretLen</span><span class="op" id="4001190">:</span><span class="op" id="4001191">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001195">if</span>&nbsp;<span class="builtinfunc" id="4001198">len</span><span class="op" id="4001201">(</span><span class="ident" id="4001202">data</span><span class="op" id="4001206">)</span>&nbsp;<span class="op" id="4001208">&lt;</span>&nbsp;<span class="num" id="4001210">2</span>&nbsp;<span class="op" id="4001212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001216">return</span>&nbsp;<span class="builtintype" id="4001223">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001230">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001234">numCerts</span>&nbsp;<span class="op" id="4001243">:=</span>&nbsp;<span class="builtintype" id="4001246">int</span><span class="op" id="4001249">(</span><span class="ident" id="4001250">data</span><span class="op" id="4001254">[</span><span class="num" id="4001255">0</span><span class="op" id="4001256">]</span><span class="op" id="4001257">)</span><span class="op" id="4001258">&lt;&lt;</span><span class="num" id="4001260">8</span>&nbsp;<span class="op" id="4001262">|</span>&nbsp;<span class="builtintype" id="4001264">int</span><span class="op" id="4001267">(</span><span class="ident" id="4001268">data</span><span class="op" id="4001272">[</span><span class="num" id="4001273">1</span><span class="op" id="4001274">]</span><span class="op" id="4001275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001278">data</span>&nbsp;<span class="op" id="4001283">=</span>&nbsp;<span class="ident" id="4001285">data</span><span class="op" id="4001289">[</span><span class="num" id="4001290">2</span><span class="op" id="4001291">:</span><span class="op" id="4001292">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001296">s</span><span class="op" id="4001297">.</span><span class="ident" id="4001298">certificates</span>&nbsp;<span class="op" id="4001311">=</span>&nbsp;<span class="builtinfunc" id="4001313">make</span><span class="op" id="4001317">(</span><span class="op" id="4001318">[</span><span class="op" id="4001319">]</span><span class="op" id="4001320">[</span><span class="op" id="4001321">]</span><span class="builtintype" id="4001322">byte</span><span class="op" id="4001326">,</span>&nbsp;<span class="ident" id="4001328">numCerts</span><span class="op" id="4001336">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001339">for</span>&nbsp;<span class="ident" id="4001343">i</span>&nbsp;<span class="op" id="4001345">:=</span>&nbsp;<span class="keyword" id="4001348">range</span>&nbsp;<span class="ident" id="4001354">s</span><span class="op" id="4001355">.</span><span class="ident" id="4001356">certificates</span>&nbsp;<span class="op" id="4001369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001373">if</span>&nbsp;<span class="builtinfunc" id="4001376">len</span><span class="op" id="4001379">(</span><span class="ident" id="4001380">data</span><span class="op" id="4001384">)</span>&nbsp;<span class="op" id="4001386">&lt;</span>&nbsp;<span class="num" id="4001388">4</span>&nbsp;<span class="op" id="4001390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001395">return</span>&nbsp;<span class="builtintype" id="4001402">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001414">certLen</span>&nbsp;<span class="op" id="4001422">:=</span>&nbsp;<span class="builtintype" id="4001425">int</span><span class="op" id="4001428">(</span><span class="ident" id="4001429">data</span><span class="op" id="4001433">[</span><span class="num" id="4001434">0</span><span class="op" id="4001435">]</span><span class="op" id="4001436">)</span><span class="op" id="4001437">&lt;&lt;</span><span class="num" id="4001439">24</span>&nbsp;<span class="op" id="4001442">|</span>&nbsp;<span class="builtintype" id="4001444">int</span><span class="op" id="4001447">(</span><span class="ident" id="4001448">data</span><span class="op" id="4001452">[</span><span class="num" id="4001453">1</span><span class="op" id="4001454">]</span><span class="op" id="4001455">)</span><span class="op" id="4001456">&lt;&lt;</span><span class="num" id="4001458">16</span>&nbsp;<span class="op" id="4001461">|</span>&nbsp;<span class="builtintype" id="4001463">int</span><span class="op" id="4001466">(</span><span class="ident" id="4001467">data</span><span class="op" id="4001471">[</span><span class="num" id="4001472">2</span><span class="op" id="4001473">]</span><span class="op" id="4001474">)</span><span class="op" id="4001475">&lt;&lt;</span><span class="num" id="4001477">8</span>&nbsp;<span class="op" id="4001479">|</span>&nbsp;<span class="builtintype" id="4001481">int</span><span class="op" id="4001484">(</span><span class="ident" id="4001485">data</span><span class="op" id="4001489">[</span><span class="num" id="4001490">3</span><span class="op" id="4001491">]</span><span class="op" id="4001492">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001496">data</span>&nbsp;<span class="op" id="4001501">=</span>&nbsp;<span class="ident" id="4001503">data</span><span class="op" id="4001507">[</span><span class="num" id="4001508">4</span><span class="op" id="4001509">:</span><span class="op" id="4001510">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001514">if</span>&nbsp;<span class="ident" id="4001517">certLen</span>&nbsp;<span class="op" id="4001525">&lt;</span>&nbsp;<span class="num" id="4001527">0</span>&nbsp;<span class="op" id="4001529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001534">return</span>&nbsp;<span class="builtintype" id="4001541">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001553">if</span>&nbsp;<span class="builtinfunc" id="4001556">len</span><span class="op" id="4001559">(</span><span class="ident" id="4001560">data</span><span class="op" id="4001564">)</span>&nbsp;<span class="op" id="4001566">&lt;</span>&nbsp;<span class="ident" id="4001568">certLen</span>&nbsp;<span class="op" id="4001576">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001581">return</span>&nbsp;<span class="builtintype" id="4001588">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001596">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001600">s</span><span class="op" id="4001601">.</span><span class="ident" id="4001602">certificates</span><span class="op" id="4001614">[</span><span class="ident" id="4001615">i</span><span class="op" id="4001616">]</span>&nbsp;<span class="op" id="4001618">=</span>&nbsp;<span class="ident" id="4001620">data</span><span class="op" id="4001624">[</span><span class="op" id="4001625">:</span><span class="ident" id="4001626">certLen</span><span class="op" id="4001633">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001637">data</span>&nbsp;<span class="op" id="4001642">=</span>&nbsp;<span class="ident" id="4001644">data</span><span class="op" id="4001648">[</span><span class="ident" id="4001649">certLen</span><span class="op" id="4001656">:</span><span class="op" id="4001657">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001660">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001664">if</span>&nbsp;<span class="builtinfunc" id="4001667">len</span><span class="op" id="4001670">(</span><span class="ident" id="4001671">data</span><span class="op" id="4001675">)</span>&nbsp;<span class="op" id="4001677">&gt;</span>&nbsp;<span class="num" id="4001679">0</span>&nbsp;<span class="op" id="4001681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001685">return</span>&nbsp;<span class="builtintype" id="4001692">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4001699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001703">return</span>&nbsp;<span class="builtintype" id="4001710">true</span><br>
<span class="lineno"></span><span class="op" id="4001715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001718">func</span>&nbsp;<span class="op" id="4001723">(</span><span class="ident" id="4001724">c</span>&nbsp;<span class="op" id="4001726">*</span><span class="ident" id="4001727">Conn</span><span class="op" id="4001731">)</span>&nbsp;<span class="ident" id="4001733">encryptTicket</span><span class="op" id="4001746">(</span><span class="ident" id="4001747">state</span>&nbsp;<span class="op" id="4001753">*</span><span class="ident" id="4001754">sessionState</span><span class="op" id="4001766">)</span>&nbsp;<span class="op" id="4001768">(</span><span class="op" id="4001769">[</span><span class="op" id="4001770">]</span><span class="builtintype" id="4001771">byte</span><span class="op" id="4001775">,</span>&nbsp;<span class="builtintype" id="4001777">error</span><span class="op" id="4001782">)</span>&nbsp;<span class="op" id="4001784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001787">serialized</span>&nbsp;<span class="op" id="4001798">:=</span>&nbsp;<span class="ident" id="4001801">state</span><span class="op" id="4001806">.</span><span class="ident" id="4001807">marshal</span><span class="op" id="4001814">(</span><span class="op" id="4001815">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001818">encrypted</span>&nbsp;<span class="op" id="4001828">:=</span>&nbsp;<span class="builtinfunc" id="4001831">make</span><span class="op" id="4001835">(</span><span class="op" id="4001836">[</span><span class="op" id="4001837">]</span><span class="builtintype" id="4001838">byte</span><span class="op" id="4001842">,</span>&nbsp;<span class="ident" id="4001844">aes</span><span class="op" id="4001847">.</span><span class="ident" id="4001848">BlockSize</span><span class="op" id="4001857">+</span><span class="builtinfunc" id="4001858">len</span><span class="op" id="4001861">(</span><span class="ident" id="4001862">serialized</span><span class="op" id="4001872">)</span><span class="op" id="4001873">+</span><span class="ident" id="4001874">sha256</span><span class="op" id="4001880">.</span><span class="ident" id="4001881">Size</span><span class="op" id="4001885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001888">iv</span>&nbsp;<span class="op" id="4001891">:=</span>&nbsp;<span class="ident" id="4001894">encrypted</span><span class="op" id="4001903">[</span><span class="op" id="4001904">:</span><span class="ident" id="4001905">aes</span><span class="op" id="4001908">.</span><span class="ident" id="4001909">BlockSize</span><span class="op" id="4001918">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001921">macBytes</span>&nbsp;<span class="op" id="4001930">:=</span>&nbsp;<span class="ident" id="4001933">encrypted</span><span class="op" id="4001942">[</span><span class="builtinfunc" id="4001943">len</span><span class="op" id="4001946">(</span><span class="ident" id="4001947">encrypted</span><span class="op" id="4001956">)</span><span class="op" id="4001957">-</span><span class="ident" id="4001958">sha256</span><span class="op" id="4001964">.</span><span class="ident" id="4001965">Size</span><span class="op" id="4001969">:</span><span class="op" id="4001970">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4001974">if</span>&nbsp;<span class="ident" id="4001977">_</span><span class="op" id="4001978">,</span>&nbsp;<span class="ident" id="4001980">err</span>&nbsp;<span class="op" id="4001984">:=</span>&nbsp;<span class="ident" id="4001987">io</span><span class="op" id="4001989">.</span><span class="ident" id="4001990">ReadFull</span><span class="op" id="4001998">(</span><span class="ident" id="4001999">c</span><span class="op" id="4002000">.</span><span class="ident" id="4002001">config</span><span class="op" id="4002007">.</span><span class="ident" id="4002008">rand</span><span class="op" id="4002012">(</span><span class="op" id="4002013">)</span><span class="op" id="4002014">,</span>&nbsp;<span class="ident" id="4002016">iv</span><span class="op" id="4002018">)</span><span class="op" id="4002019">;</span>&nbsp;<span class="ident" id="4002021">err</span>&nbsp;<span class="op" id="4002025">!=</span>&nbsp;<span class="ident" id="4002028">nil</span>&nbsp;<span class="op" id="4002032">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002036">return</span>&nbsp;<span class="ident" id="4002043">nil</span><span class="op" id="4002046">,</span>&nbsp;<span class="ident" id="4002048">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4002053">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002056">block</span><span class="op" id="4002061">,</span>&nbsp;<span class="ident" id="4002063">err</span>&nbsp;<span class="op" id="4002067">:=</span>&nbsp;<span class="ident" id="4002070">aes</span><span class="op" id="4002073">.</span><span class="ident" id="4002074">NewCipher</span><span class="op" id="4002083">(</span><span class="ident" id="4002084">c</span><span class="op" id="4002085">.</span><span class="ident" id="4002086">config</span><span class="op" id="4002092">.</span><span class="ident" id="4002093">SessionTicketKey</span><span class="op" id="4002109">[</span><span class="op" id="4002110">:</span><span class="num" id="4002111">16</span><span class="op" id="4002113">]</span><span class="op" id="4002114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002117">if</span>&nbsp;<span class="ident" id="4002120">err</span>&nbsp;<span class="op" id="4002124">!=</span>&nbsp;<span class="ident" id="4002127">nil</span>&nbsp;<span class="op" id="4002131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002135">return</span>&nbsp;<span class="ident" id="4002142">nil</span><span class="op" id="4002145">,</span>&nbsp;<span class="ident" id="4002147">errors</span><span class="op" id="4002153">.</span><span class="ident" id="4002154">New</span><span class="op" id="4002157">(</span><span class="string" id="4002158">&#34;tls:&nbsp;failed&nbsp;to&nbsp;create&nbsp;cipher&nbsp;while&nbsp;encrypting&nbsp;ticket:&nbsp;&#34;</span>&nbsp;<span class="op" id="4002215">+</span>&nbsp;<span class="ident" id="4002217">err</span><span class="op" id="4002220">.</span><span class="ident" id="4002221">Error</span><span class="op" id="4002226">(</span><span class="op" id="4002227">)</span><span class="op" id="4002228">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4002231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002234">cipher</span><span class="op" id="4002240">.</span><span class="ident" id="4002241">NewCTR</span><span class="op" id="4002247">(</span><span class="ident" id="4002248">block</span><span class="op" id="4002253">,</span>&nbsp;<span class="ident" id="4002255">iv</span><span class="op" id="4002257">)</span><span class="op" id="4002258">.</span><span class="ident" id="4002259">XORKeyStream</span><span class="op" id="4002271">(</span><span class="ident" id="4002272">encrypted</span><span class="op" id="4002281">[</span><span class="ident" id="4002282">aes</span><span class="op" id="4002285">.</span><span class="ident" id="4002286">BlockSize</span><span class="op" id="4002295">:</span><span class="op" id="4002296">]</span><span class="op" id="4002297">,</span>&nbsp;<span class="ident" id="4002299">serialized</span><span class="op" id="4002309">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002313">mac</span>&nbsp;<span class="op" id="4002317">:=</span>&nbsp;<span class="ident" id="4002320">hmac</span><span class="op" id="4002324">.</span><span class="ident" id="4002325">New</span><span class="op" id="4002328">(</span><span class="ident" id="4002329">sha256</span><span class="op" id="4002335">.</span><span class="ident" id="4002336">New</span><span class="op" id="4002339">,</span>&nbsp;<span class="ident" id="4002341">c</span><span class="op" id="4002342">.</span><span class="ident" id="4002343">config</span><span class="op" id="4002349">.</span><span class="ident" id="4002350">SessionTicketKey</span><span class="op" id="4002366">[</span><span class="num" id="4002367">16</span><span class="op" id="4002369">:</span><span class="num" id="4002370">32</span><span class="op" id="4002372">]</span><span class="op" id="4002373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002376">mac</span><span class="op" id="4002379">.</span><span class="ident" id="4002380">Write</span><span class="op" id="4002385">(</span><span class="ident" id="4002386">encrypted</span><span class="op" id="4002395">[</span><span class="op" id="4002396">:</span><span class="builtinfunc" id="4002397">len</span><span class="op" id="4002400">(</span><span class="ident" id="4002401">encrypted</span><span class="op" id="4002410">)</span><span class="op" id="4002411">-</span><span class="ident" id="4002412">sha256</span><span class="op" id="4002418">.</span><span class="ident" id="4002419">Size</span><span class="op" id="4002423">]</span><span class="op" id="4002424">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002427">mac</span><span class="op" id="4002430">.</span><span class="ident" id="4002431">Sum</span><span class="op" id="4002434">(</span><span class="ident" id="4002435">macBytes</span><span class="op" id="4002443">[</span><span class="op" id="4002444">:</span><span class="num" id="4002445">0</span><span class="op" id="4002446">]</span><span class="op" id="4002447">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002451">return</span>&nbsp;<span class="ident" id="4002458">encrypted</span><span class="op" id="4002467">,</span>&nbsp;<span class="ident" id="4002469">nil</span><br>
<span class="lineno"></span><span class="op" id="4002473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="4002476">func</span>&nbsp;<span class="op" id="4002481">(</span><span class="ident" id="4002482">c</span>&nbsp;<span class="op" id="4002484">*</span><span class="ident" id="4002485">Conn</span><span class="op" id="4002489">)</span>&nbsp;<span class="ident" id="4002491">decryptTicket</span><span class="op" id="4002504">(</span><span class="ident" id="4002505">encrypted</span>&nbsp;<span class="op" id="4002515">[</span><span class="op" id="4002516">]</span><span class="builtintype" id="4002517">byte</span><span class="op" id="4002521">)</span>&nbsp;<span class="op" id="4002523">(</span><span class="op" id="4002524">*</span><span class="ident" id="4002525">sessionState</span><span class="op" id="4002537">,</span>&nbsp;<span class="builtintype" id="4002539">bool</span><span class="op" id="4002543">)</span>&nbsp;<span class="op" id="4002545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002548">if</span>&nbsp;<span class="ident" id="4002551">c</span><span class="op" id="4002552">.</span><span class="ident" id="4002553">config</span><span class="op" id="4002559">.</span><span class="ident" id="4002560">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4002583">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4002588">len</span><span class="op" id="4002591">(</span><span class="ident" id="4002592">encrypted</span><span class="op" id="4002601">)</span>&nbsp;<span class="op" id="4002603">&lt;</span>&nbsp;<span class="ident" id="4002605">aes</span><span class="op" id="4002608">.</span><span class="ident" id="4002609">BlockSize</span><span class="op" id="4002618">+</span><span class="ident" id="4002619">sha256</span><span class="op" id="4002625">.</span><span class="ident" id="4002626">Size</span>&nbsp;<span class="op" id="4002631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002635">return</span>&nbsp;<span class="ident" id="4002642">nil</span><span class="op" id="4002645">,</span>&nbsp;<span class="builtintype" id="4002647">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4002654">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002658">iv</span>&nbsp;<span class="op" id="4002661">:=</span>&nbsp;<span class="ident" id="4002664">encrypted</span><span class="op" id="4002673">[</span><span class="op" id="4002674">:</span><span class="ident" id="4002675">aes</span><span class="op" id="4002678">.</span><span class="ident" id="4002679">BlockSize</span><span class="op" id="4002688">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002691">macBytes</span>&nbsp;<span class="op" id="4002700">:=</span>&nbsp;<span class="ident" id="4002703">encrypted</span><span class="op" id="4002712">[</span><span class="builtinfunc" id="4002713">len</span><span class="op" id="4002716">(</span><span class="ident" id="4002717">encrypted</span><span class="op" id="4002726">)</span><span class="op" id="4002727">-</span><span class="ident" id="4002728">sha256</span><span class="op" id="4002734">.</span><span class="ident" id="4002735">Size</span><span class="op" id="4002739">:</span><span class="op" id="4002740">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002744">mac</span>&nbsp;<span class="op" id="4002748">:=</span>&nbsp;<span class="ident" id="4002751">hmac</span><span class="op" id="4002755">.</span><span class="ident" id="4002756">New</span><span class="op" id="4002759">(</span><span class="ident" id="4002760">sha256</span><span class="op" id="4002766">.</span><span class="ident" id="4002767">New</span><span class="op" id="4002770">,</span>&nbsp;<span class="ident" id="4002772">c</span><span class="op" id="4002773">.</span><span class="ident" id="4002774">config</span><span class="op" id="4002780">.</span><span class="ident" id="4002781">SessionTicketKey</span><span class="op" id="4002797">[</span><span class="num" id="4002798">16</span><span class="op" id="4002800">:</span><span class="num" id="4002801">32</span><span class="op" id="4002803">]</span><span class="op" id="4002804">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002807">mac</span><span class="op" id="4002810">.</span><span class="ident" id="4002811">Write</span><span class="op" id="4002816">(</span><span class="ident" id="4002817">encrypted</span><span class="op" id="4002826">[</span><span class="op" id="4002827">:</span><span class="builtinfunc" id="4002828">len</span><span class="op" id="4002831">(</span><span class="ident" id="4002832">encrypted</span><span class="op" id="4002841">)</span><span class="op" id="4002842">-</span><span class="ident" id="4002843">sha256</span><span class="op" id="4002849">.</span><span class="ident" id="4002850">Size</span><span class="op" id="4002854">]</span><span class="op" id="4002855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002858">expected</span>&nbsp;<span class="op" id="4002867">:=</span>&nbsp;<span class="ident" id="4002870">mac</span><span class="op" id="4002873">.</span><span class="ident" id="4002874">Sum</span><span class="op" id="4002877">(</span><span class="ident" id="4002878">nil</span><span class="op" id="4002881">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002885">if</span>&nbsp;<span class="ident" id="4002888">subtle</span><span class="op" id="4002894">.</span><span class="ident" id="4002895">ConstantTimeCompare</span><span class="op" id="4002914">(</span><span class="ident" id="4002915">macBytes</span><span class="op" id="4002923">,</span>&nbsp;<span class="ident" id="4002925">expected</span><span class="op" id="4002933">)</span>&nbsp;<span class="op" id="4002935">!=</span>&nbsp;<span class="num" id="4002938">1</span>&nbsp;<span class="op" id="4002940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4002944">return</span>&nbsp;<span class="ident" id="4002951">nil</span><span class="op" id="4002954">,</span>&nbsp;<span class="builtintype" id="4002956">false</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4002963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4002967">block</span><span class="op" id="4002972">,</span>&nbsp;<span class="ident" id="4002974">err</span>&nbsp;<span class="op" id="4002978">:=</span>&nbsp;<span class="ident" id="4002981">aes</span><span class="op" id="4002984">.</span><span class="ident" id="4002985">NewCipher</span><span class="op" id="4002994">(</span><span class="ident" id="4002995">c</span><span class="op" id="4002996">.</span><span class="ident" id="4002997">config</span><span class="op" id="4003003">.</span><span class="ident" id="4003004">SessionTicketKey</span><span class="op" id="4003020">[</span><span class="op" id="4003021">:</span><span class="num" id="4003022">16</span><span class="op" id="4003024">]</span><span class="op" id="4003025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4003028">if</span>&nbsp;<span class="ident" id="4003031">err</span>&nbsp;<span class="op" id="4003035">!=</span>&nbsp;<span class="ident" id="4003038">nil</span>&nbsp;<span class="op" id="4003042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4003046">return</span>&nbsp;<span class="ident" id="4003053">nil</span><span class="op" id="4003056">,</span>&nbsp;<span class="builtintype" id="4003058">false</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4003065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4003068">ciphertext</span>&nbsp;<span class="op" id="4003079">:=</span>&nbsp;<span class="ident" id="4003082">encrypted</span><span class="op" id="4003091">[</span><span class="ident" id="4003092">aes</span><span class="op" id="4003095">.</span><span class="ident" id="4003096">BlockSize</span>&nbsp;<span class="op" id="4003106">:</span>&nbsp;<span class="builtinfunc" id="4003108">len</span><span class="op" id="4003111">(</span><span class="ident" id="4003112">encrypted</span><span class="op" id="4003121">)</span><span class="op" id="4003122">-</span><span class="ident" id="4003123">sha256</span><span class="op" id="4003129">.</span><span class="ident" id="4003130">Size</span><span class="op" id="4003134">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4003137">plaintext</span>&nbsp;<span class="op" id="4003147">:=</span>&nbsp;<span class="ident" id="4003150">ciphertext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4003162">cipher</span><span class="op" id="4003168">.</span><span class="ident" id="4003169">NewCTR</span><span class="op" id="4003175">(</span><span class="ident" id="4003176">block</span><span class="op" id="4003181">,</span>&nbsp;<span class="ident" id="4003183">iv</span><span class="op" id="4003185">)</span><span class="op" id="4003186">.</span><span class="ident" id="4003187">XORKeyStream</span><span class="op" id="4003199">(</span><span class="ident" id="4003200">plaintext</span><span class="op" id="4003209">,</span>&nbsp;<span class="ident" id="4003211">ciphertext</span><span class="op" id="4003221">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4003225">state</span>&nbsp;<span class="op" id="4003231">:=</span>&nbsp;<span class="builtinfunc" id="4003234">new</span><span class="op" id="4003237">(</span><span class="ident" id="4003238">sessionState</span><span class="op" id="4003250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4003253">ok</span>&nbsp;<span class="op" id="4003256">:=</span>&nbsp;<span class="ident" id="4003259">state</span><span class="op" id="4003264">.</span><span class="ident" id="4003265">unmarshal</span><span class="op" id="4003274">(</span><span class="ident" id="4003275">plaintext</span><span class="op" id="4003284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4003287">return</span>&nbsp;<span class="ident" id="4003294">state</span><span class="op" id="4003299">,</span>&nbsp;<span class="ident" id="4003301">ok</span><br>
<span class="lineno"></span><span class="op" id="4003304">}</span>
</div>
</body>
</html>
