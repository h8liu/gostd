<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html" class="current">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6198739">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6198794">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6198848">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6198899">package</span>&nbsp;<span class="ident" id="6198907">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6198912">import</span>&nbsp;<span class="op" id="6198919">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198922">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198931">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198947">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198957">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198966">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6198981">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6199004">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6199018">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="6199023">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6199026">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="6199063">const</span>&nbsp;<span class="op" id="6199069">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199072">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6199084">=</span>&nbsp;<span class="num" id="6199086">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199092">gcBlockSize</span>&nbsp;<span class="op" id="6199104">=</span>&nbsp;<span class="num" id="6199106">0x04</span><br>
<span class="lineno"></span><span class="op" id="6199111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6199114">var</span>&nbsp;<span class="ident" id="6199118">log2Lookup</span>&nbsp;<span class="op" id="6199129">=</span>&nbsp;<span class="op" id="6199131">[</span><span class="num" id="6199132">8</span><span class="op" id="6199133">]</span><span class="builtintype" id="6199134">int</span><span class="op" id="6199137">{</span><span class="num" id="6199138">2</span><span class="op" id="6199139">,</span>&nbsp;<span class="num" id="6199141">4</span><span class="op" id="6199142">,</span>&nbsp;<span class="num" id="6199144">8</span><span class="op" id="6199145">,</span>&nbsp;<span class="num" id="6199147">16</span><span class="op" id="6199149">,</span>&nbsp;<span class="num" id="6199151">32</span><span class="op" id="6199153">,</span>&nbsp;<span class="num" id="6199155">64</span><span class="op" id="6199157">,</span>&nbsp;<span class="num" id="6199159">128</span><span class="op" id="6199162">,</span>&nbsp;<span class="num" id="6199164">256</span><span class="op" id="6199167">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="6199170">func</span>&nbsp;<span class="ident" id="6199175">log2</span><span class="op" id="6199179">(</span><span class="ident" id="6199180">x</span>&nbsp;<span class="builtintype" id="6199182">int</span><span class="op" id="6199185">)</span>&nbsp;<span class="builtintype" id="6199187">int</span>&nbsp;<span class="op" id="6199191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199194">for</span>&nbsp;<span class="ident" id="6199198">i</span><span class="op" id="6199199">,</span>&nbsp;<span class="ident" id="6199201">v</span>&nbsp;<span class="op" id="6199203">:=</span>&nbsp;<span class="keyword" id="6199206">range</span>&nbsp;<span class="ident" id="6199212">log2Lookup</span>&nbsp;<span class="op" id="6199223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199227">if</span>&nbsp;<span class="ident" id="6199230">x</span>&nbsp;<span class="op" id="6199232">&lt;=</span>&nbsp;<span class="ident" id="6199235">v</span>&nbsp;<span class="op" id="6199237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199242">return</span>&nbsp;<span class="ident" id="6199249">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199253">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6199256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6199259">return</span>&nbsp;<span class="op" id="6199266">-</span><span class="num" id="6199267">1</span><br>
<span class="lineno"></span><span class="op" id="6199269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="6199272">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="6199290">func</span>&nbsp;<span class="ident" id="6199295">writeUint16</span><span class="op" id="6199306">(</span><span class="ident" id="6199307">b</span>&nbsp;<span class="op" id="6199309">[</span><span class="op" id="6199310">]</span><span class="builtintype" id="6199311">uint8</span><span class="op" id="6199316">,</span>&nbsp;<span class="ident" id="6199318">u</span>&nbsp;<span class="builtintype" id="6199320">uint16</span><span class="op" id="6199326">)</span>&nbsp;<span class="op" id="6199328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199331">b</span><span class="op" id="6199332">[</span><span class="num" id="6199333">0</span><span class="op" id="6199334">]</span>&nbsp;<span class="op" id="6199336">=</span>&nbsp;<span class="builtintype" id="6199338">uint8</span><span class="op" id="6199343">(</span><span class="ident" id="6199344">u</span><span class="op" id="6199345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199348">b</span><span class="op" id="6199349">[</span><span class="num" id="6199350">1</span><span class="op" id="6199351">]</span>&nbsp;<span class="op" id="6199353">=</span>&nbsp;<span class="builtintype" id="6199355">uint8</span><span class="op" id="6199360">(</span><span class="ident" id="6199361">u</span>&nbsp;<span class="op" id="6199363">&gt;&gt;</span>&nbsp;<span class="num" id="6199366">8</span><span class="op" id="6199367">)</span><br>
<span class="lineno"></span><span class="op" id="6199369">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="6199372">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6199404">type</span>&nbsp;<span class="ident" id="6199409">writer</span>&nbsp;<span class="keyword" id="6199416">interface</span>&nbsp;<span class="op" id="6199426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199429">Flush</span><span class="op" id="6199434">(</span><span class="op" id="6199435">)</span>&nbsp;<span class="builtintype" id="6199437">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199444">io</span><span class="op" id="6199446">.</span><span class="ident" id="6199447">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199455">io</span><span class="op" id="6199457">.</span><span class="ident" id="6199458">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="6199469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6199472">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6199519">type</span>&nbsp;<span class="ident" id="6199524">encoder</span>&nbsp;<span class="keyword" id="6199532">struct</span>&nbsp;<span class="op" id="6199539">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199542">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199617">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199688">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6199692">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199700">err</span>&nbsp;<span class="builtintype" id="6199704">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199711">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199767">g</span>&nbsp;<span class="op" id="6199769">*</span><span class="ident" id="6199770">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6199775">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6199859">buf</span>&nbsp;<span class="op" id="6199863">[</span><span class="num" id="6199864">1024</span><span class="op" id="6199868">]</span><span class="builtintype" id="6199869">byte</span><br>
<span class="lineno"></span><span class="op" id="6199874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6199877">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="6199944">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6200010">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6200074">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="6200087">type</span>&nbsp;<span class="ident" id="6200092">blockWriter</span>&nbsp;<span class="keyword" id="6200104">struct</span>&nbsp;<span class="op" id="6200111">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200114">e</span>&nbsp;<span class="op" id="6200116">*</span><span class="ident" id="6200117">encoder</span><br>
<span class="lineno"></span><span class="op" id="6200125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6200128">func</span>&nbsp;<span class="op" id="6200133">(</span><span class="ident" id="6200134">b</span>&nbsp;<span class="ident" id="6200136">blockWriter</span><span class="op" id="6200147">)</span>&nbsp;<span class="ident" id="6200149">Write</span><span class="op" id="6200154">(</span><span class="ident" id="6200155">data</span>&nbsp;<span class="op" id="6200160">[</span><span class="op" id="6200161">]</span><span class="builtintype" id="6200162">byte</span><span class="op" id="6200166">)</span>&nbsp;<span class="op" id="6200168">(</span><span class="builtintype" id="6200169">int</span><span class="op" id="6200172">,</span>&nbsp;<span class="builtintype" id="6200174">error</span><span class="op" id="6200179">)</span>&nbsp;<span class="op" id="6200181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200184">if</span>&nbsp;<span class="ident" id="6200187">b</span><span class="op" id="6200188">.</span><span class="ident" id="6200189">e</span><span class="op" id="6200190">.</span><span class="ident" id="6200191">err</span>&nbsp;<span class="op" id="6200195">!=</span>&nbsp;<span class="ident" id="6200198">nil</span>&nbsp;<span class="op" id="6200202">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200206">return</span>&nbsp;<span class="num" id="6200213">0</span><span class="op" id="6200214">,</span>&nbsp;<span class="ident" id="6200216">b</span><span class="op" id="6200217">.</span><span class="ident" id="6200218">e</span><span class="op" id="6200219">.</span><span class="ident" id="6200220">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200228">if</span>&nbsp;<span class="builtinfunc" id="6200231">len</span><span class="op" id="6200234">(</span><span class="ident" id="6200235">data</span><span class="op" id="6200239">)</span>&nbsp;<span class="op" id="6200241">==</span>&nbsp;<span class="num" id="6200244">0</span>&nbsp;<span class="op" id="6200246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200250">return</span>&nbsp;<span class="num" id="6200257">0</span><span class="op" id="6200258">,</span>&nbsp;<span class="ident" id="6200260">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200265">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200268">total</span>&nbsp;<span class="op" id="6200274">:=</span>&nbsp;<span class="num" id="6200277">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200280">for</span>&nbsp;<span class="ident" id="6200284">total</span>&nbsp;<span class="op" id="6200290">&lt;</span>&nbsp;<span class="builtinfunc" id="6200292">len</span><span class="op" id="6200295">(</span><span class="ident" id="6200296">data</span><span class="op" id="6200300">)</span>&nbsp;<span class="op" id="6200302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200306">n</span>&nbsp;<span class="op" id="6200308">:=</span>&nbsp;<span class="builtinfunc" id="6200311">copy</span><span class="op" id="6200315">(</span><span class="ident" id="6200316">b</span><span class="op" id="6200317">.</span><span class="ident" id="6200318">e</span><span class="op" id="6200319">.</span><span class="ident" id="6200320">buf</span><span class="op" id="6200323">[</span><span class="num" id="6200324">1</span><span class="op" id="6200325">:</span><span class="num" id="6200326">256</span><span class="op" id="6200329">]</span><span class="op" id="6200330">,</span>&nbsp;<span class="ident" id="6200332">data</span><span class="op" id="6200336">[</span><span class="ident" id="6200337">total</span><span class="op" id="6200342">:</span><span class="op" id="6200343">]</span><span class="op" id="6200344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200348">total</span>&nbsp;<span class="op" id="6200354">+=</span>&nbsp;<span class="ident" id="6200357">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200361">b</span><span class="op" id="6200362">.</span><span class="ident" id="6200363">e</span><span class="op" id="6200364">.</span><span class="ident" id="6200365">buf</span><span class="op" id="6200368">[</span><span class="num" id="6200369">0</span><span class="op" id="6200370">]</span>&nbsp;<span class="op" id="6200372">=</span>&nbsp;<span class="builtintype" id="6200374">uint8</span><span class="op" id="6200379">(</span><span class="ident" id="6200380">n</span><span class="op" id="6200381">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200386">n</span><span class="op" id="6200387">,</span>&nbsp;<span class="ident" id="6200389">b</span><span class="op" id="6200390">.</span><span class="ident" id="6200391">e</span><span class="op" id="6200392">.</span><span class="ident" id="6200393">err</span>&nbsp;<span class="op" id="6200397">=</span>&nbsp;<span class="ident" id="6200399">b</span><span class="op" id="6200400">.</span><span class="ident" id="6200401">e</span><span class="op" id="6200402">.</span><span class="ident" id="6200403">w</span><span class="op" id="6200404">.</span><span class="ident" id="6200405">Write</span><span class="op" id="6200410">(</span><span class="ident" id="6200411">b</span><span class="op" id="6200412">.</span><span class="ident" id="6200413">e</span><span class="op" id="6200414">.</span><span class="ident" id="6200415">buf</span><span class="op" id="6200418">[</span><span class="op" id="6200419">:</span><span class="ident" id="6200420">n</span><span class="op" id="6200421">+</span><span class="num" id="6200422">1</span><span class="op" id="6200423">]</span><span class="op" id="6200424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200428">if</span>&nbsp;<span class="ident" id="6200431">b</span><span class="op" id="6200432">.</span><span class="ident" id="6200433">e</span><span class="op" id="6200434">.</span><span class="ident" id="6200435">err</span>&nbsp;<span class="op" id="6200439">!=</span>&nbsp;<span class="ident" id="6200442">nil</span>&nbsp;<span class="op" id="6200446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200451">return</span>&nbsp;<span class="num" id="6200458">0</span><span class="op" id="6200459">,</span>&nbsp;<span class="ident" id="6200461">b</span><span class="op" id="6200462">.</span><span class="ident" id="6200463">e</span><span class="op" id="6200464">.</span><span class="ident" id="6200465">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200471">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200477">return</span>&nbsp;<span class="ident" id="6200484">total</span><span class="op" id="6200489">,</span>&nbsp;<span class="ident" id="6200491">b</span><span class="op" id="6200492">.</span><span class="ident" id="6200493">e</span><span class="op" id="6200494">.</span><span class="ident" id="6200495">err</span><br>
<span class="lineno"></span><span class="op" id="6200499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6200502">func</span>&nbsp;<span class="op" id="6200507">(</span><span class="ident" id="6200508">e</span>&nbsp;<span class="op" id="6200510">*</span><span class="ident" id="6200511">encoder</span><span class="op" id="6200518">)</span>&nbsp;<span class="ident" id="6200520">flush</span><span class="op" id="6200525">(</span><span class="op" id="6200526">)</span>&nbsp;<span class="op" id="6200528">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200531">if</span>&nbsp;<span class="ident" id="6200534">e</span><span class="op" id="6200535">.</span><span class="ident" id="6200536">err</span>&nbsp;<span class="op" id="6200540">!=</span>&nbsp;<span class="ident" id="6200543">nil</span>&nbsp;<span class="op" id="6200547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200551">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200562">e</span><span class="op" id="6200563">.</span><span class="ident" id="6200564">err</span>&nbsp;<span class="op" id="6200568">=</span>&nbsp;<span class="ident" id="6200570">e</span><span class="op" id="6200571">.</span><span class="ident" id="6200572">w</span><span class="op" id="6200573">.</span><span class="ident" id="6200574">Flush</span><span class="op" id="6200579">(</span><span class="op" id="6200580">)</span><br>
<span class="lineno"></span><span class="op" id="6200582">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="6200585">func</span>&nbsp;<span class="op" id="6200590">(</span><span class="ident" id="6200591">e</span>&nbsp;<span class="op" id="6200593">*</span><span class="ident" id="6200594">encoder</span><span class="op" id="6200601">)</span>&nbsp;<span class="ident" id="6200603">write</span><span class="op" id="6200608">(</span><span class="ident" id="6200609">p</span>&nbsp;<span class="op" id="6200611">[</span><span class="op" id="6200612">]</span><span class="builtintype" id="6200613">byte</span><span class="op" id="6200617">)</span>&nbsp;<span class="op" id="6200619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200622">if</span>&nbsp;<span class="ident" id="6200625">e</span><span class="op" id="6200626">.</span><span class="ident" id="6200627">err</span>&nbsp;<span class="op" id="6200631">!=</span>&nbsp;<span class="ident" id="6200634">nil</span>&nbsp;<span class="op" id="6200638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200642">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200650">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200653">_</span><span class="op" id="6200654">,</span>&nbsp;<span class="ident" id="6200656">e</span><span class="op" id="6200657">.</span><span class="ident" id="6200658">err</span>&nbsp;<span class="op" id="6200662">=</span>&nbsp;<span class="ident" id="6200664">e</span><span class="op" id="6200665">.</span><span class="ident" id="6200666">w</span><span class="op" id="6200667">.</span><span class="ident" id="6200668">Write</span><span class="op" id="6200673">(</span><span class="ident" id="6200674">p</span><span class="op" id="6200675">)</span><br>
<span class="lineno"></span><span class="op" id="6200677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6200680">func</span>&nbsp;<span class="op" id="6200685">(</span><span class="ident" id="6200686">e</span>&nbsp;<span class="op" id="6200688">*</span><span class="ident" id="6200689">encoder</span><span class="op" id="6200696">)</span>&nbsp;<span class="ident" id="6200698">writeByte</span><span class="op" id="6200707">(</span><span class="ident" id="6200708">b</span>&nbsp;<span class="builtintype" id="6200710">byte</span><span class="op" id="6200714">)</span>&nbsp;<span class="op" id="6200716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200719">if</span>&nbsp;<span class="ident" id="6200722">e</span><span class="op" id="6200723">.</span><span class="ident" id="6200724">err</span>&nbsp;<span class="op" id="6200728">!=</span>&nbsp;<span class="ident" id="6200731">nil</span>&nbsp;<span class="op" id="6200735">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200739">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200750">e</span><span class="op" id="6200751">.</span><span class="ident" id="6200752">err</span>&nbsp;<span class="op" id="6200756">=</span>&nbsp;<span class="ident" id="6200758">e</span><span class="op" id="6200759">.</span><span class="ident" id="6200760">w</span><span class="op" id="6200761">.</span><span class="ident" id="6200762">WriteByte</span><span class="op" id="6200771">(</span><span class="ident" id="6200772">b</span><span class="op" id="6200773">)</span><br>
<span class="lineno"></span><span class="op" id="6200775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="6200778">func</span>&nbsp;<span class="op" id="6200783">(</span><span class="ident" id="6200784">e</span>&nbsp;<span class="op" id="6200786">*</span><span class="ident" id="6200787">encoder</span><span class="op" id="6200794">)</span>&nbsp;<span class="ident" id="6200796">writeHeader</span><span class="op" id="6200807">(</span><span class="op" id="6200808">)</span>&nbsp;<span class="op" id="6200810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200813">if</span>&nbsp;<span class="ident" id="6200816">e</span><span class="op" id="6200817">.</span><span class="ident" id="6200818">err</span>&nbsp;<span class="op" id="6200822">!=</span>&nbsp;<span class="ident" id="6200825">nil</span>&nbsp;<span class="op" id="6200829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200833">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200844">_</span><span class="op" id="6200845">,</span>&nbsp;<span class="ident" id="6200847">e</span><span class="op" id="6200848">.</span><span class="ident" id="6200849">err</span>&nbsp;<span class="op" id="6200853">=</span>&nbsp;<span class="ident" id="6200855">io</span><span class="op" id="6200857">.</span><span class="ident" id="6200858">WriteString</span><span class="op" id="6200869">(</span><span class="ident" id="6200870">e</span><span class="op" id="6200871">.</span><span class="ident" id="6200872">w</span><span class="op" id="6200873">,</span>&nbsp;<span class="string" id="6200875">&#34;GIF89a&#34;</span><span class="op" id="6200883">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200886">if</span>&nbsp;<span class="ident" id="6200889">e</span><span class="op" id="6200890">.</span><span class="ident" id="6200891">err</span>&nbsp;<span class="op" id="6200895">!=</span>&nbsp;<span class="ident" id="6200898">nil</span>&nbsp;<span class="op" id="6200902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6200906">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6200914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200918">pm</span>&nbsp;<span class="op" id="6200921">:=</span>&nbsp;<span class="ident" id="6200924">e</span><span class="op" id="6200925">.</span><span class="ident" id="6200926">g</span><span class="op" id="6200927">.</span><span class="ident" id="6200928">Image</span><span class="op" id="6200933">[</span><span class="num" id="6200934">0</span><span class="op" id="6200935">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6200938">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6200975">writeUint16</span><span class="op" id="6200986">(</span><span class="ident" id="6200987">e</span><span class="op" id="6200988">.</span><span class="ident" id="6200989">buf</span><span class="op" id="6200992">[</span><span class="num" id="6200993">0</span><span class="op" id="6200994">:</span><span class="num" id="6200995">2</span><span class="op" id="6200996">]</span><span class="op" id="6200997">,</span>&nbsp;<span class="builtintype" id="6200999">uint16</span><span class="op" id="6201005">(</span><span class="ident" id="6201006">pm</span><span class="op" id="6201008">.</span><span class="ident" id="6201009">Bounds</span><span class="op" id="6201015">(</span><span class="op" id="6201016">)</span><span class="op" id="6201017">.</span><span class="ident" id="6201018">Dx</span><span class="op" id="6201020">(</span><span class="op" id="6201021">)</span><span class="op" id="6201022">)</span><span class="op" id="6201023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201026">writeUint16</span><span class="op" id="6201037">(</span><span class="ident" id="6201038">e</span><span class="op" id="6201039">.</span><span class="ident" id="6201040">buf</span><span class="op" id="6201043">[</span><span class="num" id="6201044">2</span><span class="op" id="6201045">:</span><span class="num" id="6201046">4</span><span class="op" id="6201047">]</span><span class="op" id="6201048">,</span>&nbsp;<span class="builtintype" id="6201050">uint16</span><span class="op" id="6201056">(</span><span class="ident" id="6201057">pm</span><span class="op" id="6201059">.</span><span class="ident" id="6201060">Bounds</span><span class="op" id="6201066">(</span><span class="op" id="6201067">)</span><span class="op" id="6201068">.</span><span class="ident" id="6201069">Dy</span><span class="op" id="6201071">(</span><span class="op" id="6201072">)</span><span class="op" id="6201073">)</span><span class="op" id="6201074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201077">e</span><span class="op" id="6201078">.</span><span class="ident" id="6201079">write</span><span class="op" id="6201084">(</span><span class="ident" id="6201085">e</span><span class="op" id="6201086">.</span><span class="ident" id="6201087">buf</span><span class="op" id="6201090">[</span><span class="op" id="6201091">:</span><span class="num" id="6201092">4</span><span class="op" id="6201093">]</span><span class="op" id="6201094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6201098">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6201163">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201182">e</span><span class="op" id="6201183">.</span><span class="ident" id="6201184">buf</span><span class="op" id="6201187">[</span><span class="num" id="6201188">0</span><span class="op" id="6201189">]</span>&nbsp;<span class="op" id="6201191">=</span>&nbsp;<span class="num" id="6201193">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201199">e</span><span class="op" id="6201200">.</span><span class="ident" id="6201201">buf</span><span class="op" id="6201204">[</span><span class="num" id="6201205">1</span><span class="op" id="6201206">]</span>&nbsp;<span class="op" id="6201208">=</span>&nbsp;<span class="num" id="6201210">0x00</span>&nbsp;<span class="comment" id="6201215">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201243">e</span><span class="op" id="6201244">.</span><span class="ident" id="6201245">buf</span><span class="op" id="6201248">[</span><span class="num" id="6201249">2</span><span class="op" id="6201250">]</span>&nbsp;<span class="op" id="6201252">=</span>&nbsp;<span class="num" id="6201254">0x00</span>&nbsp;<span class="comment" id="6201259">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201283">e</span><span class="op" id="6201284">.</span><span class="ident" id="6201285">write</span><span class="op" id="6201290">(</span><span class="ident" id="6201291">e</span><span class="op" id="6201292">.</span><span class="ident" id="6201293">buf</span><span class="op" id="6201296">[</span><span class="op" id="6201297">:</span><span class="num" id="6201298">3</span><span class="op" id="6201299">]</span><span class="op" id="6201300">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6201304">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201341">if</span>&nbsp;<span class="builtinfunc" id="6201344">len</span><span class="op" id="6201347">(</span><span class="ident" id="6201348">e</span><span class="op" id="6201349">.</span><span class="ident" id="6201350">g</span><span class="op" id="6201351">.</span><span class="ident" id="6201352">Image</span><span class="op" id="6201357">)</span>&nbsp;<span class="op" id="6201359">&gt;</span>&nbsp;<span class="num" id="6201361">1</span>&nbsp;<span class="op" id="6201363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201367">e</span><span class="op" id="6201368">.</span><span class="ident" id="6201369">buf</span><span class="op" id="6201372">[</span><span class="num" id="6201373">0</span><span class="op" id="6201374">]</span>&nbsp;<span class="op" id="6201376">=</span>&nbsp;<span class="num" id="6201378">0x21</span>&nbsp;<span class="comment" id="6201383">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201410">e</span><span class="op" id="6201411">.</span><span class="ident" id="6201412">buf</span><span class="op" id="6201415">[</span><span class="num" id="6201416">1</span><span class="op" id="6201417">]</span>&nbsp;<span class="op" id="6201419">=</span>&nbsp;<span class="num" id="6201421">0xff</span>&nbsp;<span class="comment" id="6201426">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201450">e</span><span class="op" id="6201451">.</span><span class="ident" id="6201452">buf</span><span class="op" id="6201455">[</span><span class="num" id="6201456">2</span><span class="op" id="6201457">]</span>&nbsp;<span class="op" id="6201459">=</span>&nbsp;<span class="num" id="6201461">0x0b</span>&nbsp;<span class="comment" id="6201466">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201483">e</span><span class="op" id="6201484">.</span><span class="ident" id="6201485">write</span><span class="op" id="6201490">(</span><span class="ident" id="6201491">e</span><span class="op" id="6201492">.</span><span class="ident" id="6201493">buf</span><span class="op" id="6201496">[</span><span class="op" id="6201497">:</span><span class="num" id="6201498">3</span><span class="op" id="6201499">]</span><span class="op" id="6201500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201504">_</span><span class="op" id="6201505">,</span>&nbsp;<span class="ident" id="6201507">e</span><span class="op" id="6201508">.</span><span class="ident" id="6201509">err</span>&nbsp;<span class="op" id="6201513">=</span>&nbsp;<span class="ident" id="6201515">io</span><span class="op" id="6201517">.</span><span class="ident" id="6201518">WriteString</span><span class="op" id="6201529">(</span><span class="ident" id="6201530">e</span><span class="op" id="6201531">.</span><span class="ident" id="6201532">w</span><span class="op" id="6201533">,</span>&nbsp;<span class="string" id="6201535">&#34;NETSCAPE2.0&#34;</span><span class="op" id="6201548">)</span>&nbsp;<span class="comment" id="6201550">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201579">if</span>&nbsp;<span class="ident" id="6201582">e</span><span class="op" id="6201583">.</span><span class="ident" id="6201584">err</span>&nbsp;<span class="op" id="6201588">!=</span>&nbsp;<span class="ident" id="6201591">nil</span>&nbsp;<span class="op" id="6201595">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201600">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201613">e</span><span class="op" id="6201614">.</span><span class="ident" id="6201615">buf</span><span class="op" id="6201618">[</span><span class="num" id="6201619">0</span><span class="op" id="6201620">]</span>&nbsp;<span class="op" id="6201622">=</span>&nbsp;<span class="num" id="6201624">0x03</span>&nbsp;<span class="comment" id="6201629">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201646">e</span><span class="op" id="6201647">.</span><span class="ident" id="6201648">buf</span><span class="op" id="6201651">[</span><span class="num" id="6201652">1</span><span class="op" id="6201653">]</span>&nbsp;<span class="op" id="6201655">=</span>&nbsp;<span class="num" id="6201657">0x01</span>&nbsp;<span class="comment" id="6201662">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201684">writeUint16</span><span class="op" id="6201695">(</span><span class="ident" id="6201696">e</span><span class="op" id="6201697">.</span><span class="ident" id="6201698">buf</span><span class="op" id="6201701">[</span><span class="num" id="6201702">2</span><span class="op" id="6201703">:</span><span class="num" id="6201704">4</span><span class="op" id="6201705">]</span><span class="op" id="6201706">,</span>&nbsp;<span class="builtintype" id="6201708">uint16</span><span class="op" id="6201714">(</span><span class="ident" id="6201715">e</span><span class="op" id="6201716">.</span><span class="ident" id="6201717">g</span><span class="op" id="6201718">.</span><span class="ident" id="6201719">LoopCount</span><span class="op" id="6201728">)</span><span class="op" id="6201729">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201733">e</span><span class="op" id="6201734">.</span><span class="ident" id="6201735">buf</span><span class="op" id="6201738">[</span><span class="num" id="6201739">4</span><span class="op" id="6201740">]</span>&nbsp;<span class="op" id="6201742">=</span>&nbsp;<span class="num" id="6201744">0x00</span>&nbsp;<span class="comment" id="6201749">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201772">e</span><span class="op" id="6201773">.</span><span class="ident" id="6201774">write</span><span class="op" id="6201779">(</span><span class="ident" id="6201780">e</span><span class="op" id="6201781">.</span><span class="ident" id="6201782">buf</span><span class="op" id="6201785">[</span><span class="op" id="6201786">:</span><span class="num" id="6201787">5</span><span class="op" id="6201788">]</span><span class="op" id="6201789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201792">}</span><br>
<span class="lineno"></span><span class="op" id="6201794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="6201797">func</span>&nbsp;<span class="op" id="6201802">(</span><span class="ident" id="6201803">e</span>&nbsp;<span class="op" id="6201805">*</span><span class="ident" id="6201806">encoder</span><span class="op" id="6201813">)</span>&nbsp;<span class="ident" id="6201815">writeColorTable</span><span class="op" id="6201830">(</span><span class="ident" id="6201831">p</span>&nbsp;<span class="ident" id="6201833">color</span><span class="op" id="6201838">.</span><span class="ident" id="6201839">Palette</span><span class="op" id="6201846">,</span>&nbsp;<span class="ident" id="6201848">size</span>&nbsp;<span class="builtintype" id="6201853">int</span><span class="op" id="6201856">)</span>&nbsp;<span class="op" id="6201858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201861">if</span>&nbsp;<span class="ident" id="6201864">e</span><span class="op" id="6201865">.</span><span class="ident" id="6201866">err</span>&nbsp;<span class="op" id="6201870">!=</span>&nbsp;<span class="ident" id="6201873">nil</span>&nbsp;<span class="op" id="6201877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201881">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6201889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201893">for</span>&nbsp;<span class="ident" id="6201897">i</span>&nbsp;<span class="op" id="6201899">:=</span>&nbsp;<span class="num" id="6201902">0</span><span class="op" id="6201903">;</span>&nbsp;<span class="ident" id="6201905">i</span>&nbsp;<span class="op" id="6201907">&lt;</span>&nbsp;<span class="ident" id="6201909">log2Lookup</span><span class="op" id="6201919">[</span><span class="ident" id="6201920">size</span><span class="op" id="6201924">]</span><span class="op" id="6201925">;</span>&nbsp;<span class="ident" id="6201927">i</span><span class="op" id="6201928">++</span>&nbsp;<span class="op" id="6201931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6201935">if</span>&nbsp;<span class="ident" id="6201938">i</span>&nbsp;<span class="op" id="6201940">&lt;</span>&nbsp;<span class="builtinfunc" id="6201942">len</span><span class="op" id="6201945">(</span><span class="ident" id="6201946">p</span><span class="op" id="6201947">)</span>&nbsp;<span class="op" id="6201949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201954">r</span><span class="op" id="6201955">,</span>&nbsp;<span class="ident" id="6201957">g</span><span class="op" id="6201958">,</span>&nbsp;<span class="ident" id="6201960">b</span><span class="op" id="6201961">,</span>&nbsp;<span class="ident" id="6201963">_</span>&nbsp;<span class="op" id="6201965">:=</span>&nbsp;<span class="ident" id="6201968">p</span><span class="op" id="6201969">[</span><span class="ident" id="6201970">i</span><span class="op" id="6201971">]</span><span class="op" id="6201972">.</span><span class="ident" id="6201973">RGBA</span><span class="op" id="6201977">(</span><span class="op" id="6201978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6201983">e</span><span class="op" id="6201984">.</span><span class="ident" id="6201985">buf</span><span class="op" id="6201988">[</span><span class="num" id="6201989">3</span><span class="op" id="6201990">*</span><span class="ident" id="6201991">i</span><span class="op" id="6201992">+</span><span class="num" id="6201993">0</span><span class="op" id="6201994">]</span>&nbsp;<span class="op" id="6201996">=</span>&nbsp;<span class="builtintype" id="6201998">uint8</span><span class="op" id="6202003">(</span><span class="ident" id="6202004">r</span>&nbsp;<span class="op" id="6202006">&gt;&gt;</span>&nbsp;<span class="num" id="6202009">8</span><span class="op" id="6202010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202015">e</span><span class="op" id="6202016">.</span><span class="ident" id="6202017">buf</span><span class="op" id="6202020">[</span><span class="num" id="6202021">3</span><span class="op" id="6202022">*</span><span class="ident" id="6202023">i</span><span class="op" id="6202024">+</span><span class="num" id="6202025">1</span><span class="op" id="6202026">]</span>&nbsp;<span class="op" id="6202028">=</span>&nbsp;<span class="builtintype" id="6202030">uint8</span><span class="op" id="6202035">(</span><span class="ident" id="6202036">g</span>&nbsp;<span class="op" id="6202038">&gt;&gt;</span>&nbsp;<span class="num" id="6202041">8</span><span class="op" id="6202042">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202047">e</span><span class="op" id="6202048">.</span><span class="ident" id="6202049">buf</span><span class="op" id="6202052">[</span><span class="num" id="6202053">3</span><span class="op" id="6202054">*</span><span class="ident" id="6202055">i</span><span class="op" id="6202056">+</span><span class="num" id="6202057">2</span><span class="op" id="6202058">]</span>&nbsp;<span class="op" id="6202060">=</span>&nbsp;<span class="builtintype" id="6202062">uint8</span><span class="op" id="6202067">(</span><span class="ident" id="6202068">b</span>&nbsp;<span class="op" id="6202070">&gt;&gt;</span>&nbsp;<span class="num" id="6202073">8</span><span class="op" id="6202074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202078">}</span>&nbsp;<span class="keyword" id="6202080">else</span>&nbsp;<span class="op" id="6202085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6202090">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202112">e</span><span class="op" id="6202113">.</span><span class="ident" id="6202114">buf</span><span class="op" id="6202117">[</span><span class="num" id="6202118">3</span><span class="op" id="6202119">*</span><span class="ident" id="6202120">i</span><span class="op" id="6202121">+</span><span class="num" id="6202122">0</span><span class="op" id="6202123">]</span>&nbsp;<span class="op" id="6202125">=</span>&nbsp;<span class="num" id="6202127">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202135">e</span><span class="op" id="6202136">.</span><span class="ident" id="6202137">buf</span><span class="op" id="6202140">[</span><span class="num" id="6202141">3</span><span class="op" id="6202142">*</span><span class="ident" id="6202143">i</span><span class="op" id="6202144">+</span><span class="num" id="6202145">1</span><span class="op" id="6202146">]</span>&nbsp;<span class="op" id="6202148">=</span>&nbsp;<span class="num" id="6202150">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202158">e</span><span class="op" id="6202159">.</span><span class="ident" id="6202160">buf</span><span class="op" id="6202163">[</span><span class="num" id="6202164">3</span><span class="op" id="6202165">*</span><span class="ident" id="6202166">i</span><span class="op" id="6202167">+</span><span class="num" id="6202168">2</span><span class="op" id="6202169">]</span>&nbsp;<span class="op" id="6202171">=</span>&nbsp;<span class="num" id="6202173">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202183">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202186">e</span><span class="op" id="6202187">.</span><span class="ident" id="6202188">write</span><span class="op" id="6202193">(</span><span class="ident" id="6202194">e</span><span class="op" id="6202195">.</span><span class="ident" id="6202196">buf</span><span class="op" id="6202199">[</span><span class="op" id="6202200">:</span><span class="num" id="6202201">3</span><span class="op" id="6202202">*</span><span class="ident" id="6202203">log2Lookup</span><span class="op" id="6202213">[</span><span class="ident" id="6202214">size</span><span class="op" id="6202218">]</span><span class="op" id="6202219">]</span><span class="op" id="6202220">)</span><br>
<span class="lineno"></span><span class="op" id="6202222">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="6202225">func</span>&nbsp;<span class="op" id="6202230">(</span><span class="ident" id="6202231">e</span>&nbsp;<span class="op" id="6202233">*</span><span class="ident" id="6202234">encoder</span><span class="op" id="6202241">)</span>&nbsp;<span class="ident" id="6202243">writeImageBlock</span><span class="op" id="6202258">(</span><span class="ident" id="6202259">pm</span>&nbsp;<span class="op" id="6202262">*</span><span class="ident" id="6202263">image</span><span class="op" id="6202268">.</span><span class="ident" id="6202269">Paletted</span><span class="op" id="6202277">,</span>&nbsp;<span class="ident" id="6202279">delay</span>&nbsp;<span class="builtintype" id="6202285">int</span><span class="op" id="6202288">)</span>&nbsp;<span class="op" id="6202290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202293">if</span>&nbsp;<span class="ident" id="6202296">e</span><span class="op" id="6202297">.</span><span class="ident" id="6202298">err</span>&nbsp;<span class="op" id="6202302">!=</span>&nbsp;<span class="ident" id="6202305">nil</span>&nbsp;<span class="op" id="6202309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202313">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202321">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202325">if</span>&nbsp;<span class="builtinfunc" id="6202328">len</span><span class="op" id="6202331">(</span><span class="ident" id="6202332">pm</span><span class="op" id="6202334">.</span><span class="ident" id="6202335">Palette</span><span class="op" id="6202342">)</span>&nbsp;<span class="op" id="6202344">==</span>&nbsp;<span class="num" id="6202347">0</span>&nbsp;<span class="op" id="6202349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202353">e</span><span class="op" id="6202354">.</span><span class="ident" id="6202355">err</span>&nbsp;<span class="op" id="6202359">=</span>&nbsp;<span class="ident" id="6202361">errors</span><span class="op" id="6202367">.</span><span class="ident" id="6202368">New</span><span class="op" id="6202371">(</span><span class="string" id="6202372">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="6202423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202427">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202435">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202439">b</span>&nbsp;<span class="op" id="6202441">:=</span>&nbsp;<span class="ident" id="6202444">pm</span><span class="op" id="6202446">.</span><span class="ident" id="6202447">Bounds</span><span class="op" id="6202453">(</span><span class="op" id="6202454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202457">if</span>&nbsp;<span class="ident" id="6202460">b</span><span class="op" id="6202461">.</span><span class="ident" id="6202462">Dx</span><span class="op" id="6202464">(</span><span class="op" id="6202465">)</span>&nbsp;<span class="op" id="6202467">&gt;=</span>&nbsp;<span class="num" id="6202470">1</span><span class="op" id="6202471">&lt;&lt;</span><span class="num" id="6202473">16</span>&nbsp;<span class="op" id="6202476">||</span>&nbsp;<span class="ident" id="6202479">b</span><span class="op" id="6202480">.</span><span class="ident" id="6202481">Dy</span><span class="op" id="6202483">(</span><span class="op" id="6202484">)</span>&nbsp;<span class="op" id="6202486">&gt;=</span>&nbsp;<span class="num" id="6202489">1</span><span class="op" id="6202490">&lt;&lt;</span><span class="num" id="6202492">16</span>&nbsp;<span class="op" id="6202495">||</span>&nbsp;<span class="ident" id="6202498">b</span><span class="op" id="6202499">.</span><span class="ident" id="6202500">Min</span><span class="op" id="6202503">.</span><span class="ident" id="6202504">X</span>&nbsp;<span class="op" id="6202506">&lt;</span>&nbsp;<span class="num" id="6202508">0</span>&nbsp;<span class="op" id="6202510">||</span>&nbsp;<span class="ident" id="6202513">b</span><span class="op" id="6202514">.</span><span class="ident" id="6202515">Min</span><span class="op" id="6202518">.</span><span class="ident" id="6202519">X</span>&nbsp;<span class="op" id="6202521">&gt;=</span>&nbsp;<span class="num" id="6202524">1</span><span class="op" id="6202525">&lt;&lt;</span><span class="num" id="6202527">16</span>&nbsp;<span class="op" id="6202530">||</span>&nbsp;<span class="ident" id="6202533">b</span><span class="op" id="6202534">.</span><span class="ident" id="6202535">Min</span><span class="op" id="6202538">.</span><span class="ident" id="6202539">Y</span>&nbsp;<span class="op" id="6202541">&lt;</span>&nbsp;<span class="num" id="6202543">0</span>&nbsp;<span class="op" id="6202545">||</span>&nbsp;<span class="ident" id="6202548">b</span><span class="op" id="6202549">.</span><span class="ident" id="6202550">Min</span><span class="op" id="6202553">.</span><span class="ident" id="6202554">Y</span>&nbsp;<span class="op" id="6202556">&gt;=</span>&nbsp;<span class="num" id="6202559">1</span><span class="op" id="6202560">&lt;&lt;</span><span class="num" id="6202562">16</span>&nbsp;<span class="op" id="6202565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202569">e</span><span class="op" id="6202570">.</span><span class="ident" id="6202571">err</span>&nbsp;<span class="op" id="6202575">=</span>&nbsp;<span class="ident" id="6202577">errors</span><span class="op" id="6202583">.</span><span class="ident" id="6202584">New</span><span class="op" id="6202587">(</span><span class="string" id="6202588">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6202629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202633">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202645">transparentIndex</span>&nbsp;<span class="op" id="6202662">:=</span>&nbsp;<span class="op" id="6202665">-</span><span class="num" id="6202666">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202669">for</span>&nbsp;<span class="ident" id="6202673">i</span><span class="op" id="6202674">,</span>&nbsp;<span class="ident" id="6202676">c</span>&nbsp;<span class="op" id="6202678">:=</span>&nbsp;<span class="keyword" id="6202681">range</span>&nbsp;<span class="ident" id="6202687">pm</span><span class="op" id="6202689">.</span><span class="ident" id="6202690">Palette</span>&nbsp;<span class="op" id="6202698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202702">if</span>&nbsp;<span class="ident" id="6202705">_</span><span class="op" id="6202706">,</span>&nbsp;<span class="ident" id="6202708">_</span><span class="op" id="6202709">,</span>&nbsp;<span class="ident" id="6202711">_</span><span class="op" id="6202712">,</span>&nbsp;<span class="ident" id="6202714">a</span>&nbsp;<span class="op" id="6202716">:=</span>&nbsp;<span class="ident" id="6202719">c</span><span class="op" id="6202720">.</span><span class="ident" id="6202721">RGBA</span><span class="op" id="6202725">(</span><span class="op" id="6202726">)</span><span class="op" id="6202727">;</span>&nbsp;<span class="ident" id="6202729">a</span>&nbsp;<span class="op" id="6202731">==</span>&nbsp;<span class="num" id="6202734">0</span>&nbsp;<span class="op" id="6202736">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202741">transparentIndex</span>&nbsp;<span class="op" id="6202758">=</span>&nbsp;<span class="ident" id="6202760">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202765">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6202776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202780">if</span>&nbsp;<span class="ident" id="6202783">delay</span>&nbsp;<span class="op" id="6202789">&gt;</span>&nbsp;<span class="num" id="6202791">0</span>&nbsp;<span class="op" id="6202793">||</span>&nbsp;<span class="ident" id="6202796">transparentIndex</span>&nbsp;<span class="op" id="6202813">!=</span>&nbsp;<span class="op" id="6202816">-</span><span class="num" id="6202817">1</span>&nbsp;<span class="op" id="6202819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202823">e</span><span class="op" id="6202824">.</span><span class="ident" id="6202825">buf</span><span class="op" id="6202828">[</span><span class="num" id="6202829">0</span><span class="op" id="6202830">]</span>&nbsp;<span class="op" id="6202832">=</span>&nbsp;<span class="ident" id="6202834">sExtension</span>&nbsp;&nbsp;<span class="comment" id="6202846">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202873">e</span><span class="op" id="6202874">.</span><span class="ident" id="6202875">buf</span><span class="op" id="6202878">[</span><span class="num" id="6202879">1</span><span class="op" id="6202880">]</span>&nbsp;<span class="op" id="6202882">=</span>&nbsp;<span class="ident" id="6202884">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6202896">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202924">e</span><span class="op" id="6202925">.</span><span class="ident" id="6202926">buf</span><span class="op" id="6202929">[</span><span class="num" id="6202930">2</span><span class="op" id="6202931">]</span>&nbsp;<span class="op" id="6202933">=</span>&nbsp;<span class="ident" id="6202935">gcBlockSize</span>&nbsp;<span class="comment" id="6202947">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6202964">if</span>&nbsp;<span class="ident" id="6202967">transparentIndex</span>&nbsp;<span class="op" id="6202984">!=</span>&nbsp;<span class="op" id="6202987">-</span><span class="num" id="6202988">1</span>&nbsp;<span class="op" id="6202990">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6202995">e</span><span class="op" id="6202996">.</span><span class="ident" id="6202997">buf</span><span class="op" id="6203000">[</span><span class="num" id="6203001">3</span><span class="op" id="6203002">]</span>&nbsp;<span class="op" id="6203004">=</span>&nbsp;<span class="num" id="6203006">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203013">}</span>&nbsp;<span class="keyword" id="6203015">else</span>&nbsp;<span class="op" id="6203020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203025">e</span><span class="op" id="6203026">.</span><span class="ident" id="6203027">buf</span><span class="op" id="6203030">[</span><span class="num" id="6203031">3</span><span class="op" id="6203032">]</span>&nbsp;<span class="op" id="6203034">=</span>&nbsp;<span class="num" id="6203036">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203047">writeUint16</span><span class="op" id="6203058">(</span><span class="ident" id="6203059">e</span><span class="op" id="6203060">.</span><span class="ident" id="6203061">buf</span><span class="op" id="6203064">[</span><span class="num" id="6203065">4</span><span class="op" id="6203066">:</span><span class="num" id="6203067">6</span><span class="op" id="6203068">]</span><span class="op" id="6203069">,</span>&nbsp;<span class="builtintype" id="6203071">uint16</span><span class="op" id="6203077">(</span><span class="ident" id="6203078">delay</span><span class="op" id="6203083">)</span><span class="op" id="6203084">)</span>&nbsp;<span class="comment" id="6203086">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6203126">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6203156">if</span>&nbsp;<span class="ident" id="6203159">transparentIndex</span>&nbsp;<span class="op" id="6203176">!=</span>&nbsp;<span class="op" id="6203179">-</span><span class="num" id="6203180">1</span>&nbsp;<span class="op" id="6203182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203187">e</span><span class="op" id="6203188">.</span><span class="ident" id="6203189">buf</span><span class="op" id="6203192">[</span><span class="num" id="6203193">6</span><span class="op" id="6203194">]</span>&nbsp;<span class="op" id="6203196">=</span>&nbsp;<span class="builtintype" id="6203198">uint8</span><span class="op" id="6203203">(</span><span class="ident" id="6203204">transparentIndex</span><span class="op" id="6203220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203224">}</span>&nbsp;<span class="keyword" id="6203226">else</span>&nbsp;<span class="op" id="6203231">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203236">e</span><span class="op" id="6203237">.</span><span class="ident" id="6203238">buf</span><span class="op" id="6203241">[</span><span class="num" id="6203242">6</span><span class="op" id="6203243">]</span>&nbsp;<span class="op" id="6203245">=</span>&nbsp;<span class="num" id="6203247">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203258">e</span><span class="op" id="6203259">.</span><span class="ident" id="6203260">buf</span><span class="op" id="6203263">[</span><span class="num" id="6203264">7</span><span class="op" id="6203265">]</span>&nbsp;<span class="op" id="6203267">=</span>&nbsp;<span class="num" id="6203269">0x00</span>&nbsp;<span class="comment" id="6203274">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203297">e</span><span class="op" id="6203298">.</span><span class="ident" id="6203299">write</span><span class="op" id="6203304">(</span><span class="ident" id="6203305">e</span><span class="op" id="6203306">.</span><span class="ident" id="6203307">buf</span><span class="op" id="6203310">[</span><span class="op" id="6203311">:</span><span class="num" id="6203312">8</span><span class="op" id="6203313">]</span><span class="op" id="6203314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203317">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203320">e</span><span class="op" id="6203321">.</span><span class="ident" id="6203322">buf</span><span class="op" id="6203325">[</span><span class="num" id="6203326">0</span><span class="op" id="6203327">]</span>&nbsp;<span class="op" id="6203329">=</span>&nbsp;<span class="ident" id="6203331">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203349">writeUint16</span><span class="op" id="6203360">(</span><span class="ident" id="6203361">e</span><span class="op" id="6203362">.</span><span class="ident" id="6203363">buf</span><span class="op" id="6203366">[</span><span class="num" id="6203367">1</span><span class="op" id="6203368">:</span><span class="num" id="6203369">3</span><span class="op" id="6203370">]</span><span class="op" id="6203371">,</span>&nbsp;<span class="builtintype" id="6203373">uint16</span><span class="op" id="6203379">(</span><span class="ident" id="6203380">b</span><span class="op" id="6203381">.</span><span class="ident" id="6203382">Min</span><span class="op" id="6203385">.</span><span class="ident" id="6203386">X</span><span class="op" id="6203387">)</span><span class="op" id="6203388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203391">writeUint16</span><span class="op" id="6203402">(</span><span class="ident" id="6203403">e</span><span class="op" id="6203404">.</span><span class="ident" id="6203405">buf</span><span class="op" id="6203408">[</span><span class="num" id="6203409">3</span><span class="op" id="6203410">:</span><span class="num" id="6203411">5</span><span class="op" id="6203412">]</span><span class="op" id="6203413">,</span>&nbsp;<span class="builtintype" id="6203415">uint16</span><span class="op" id="6203421">(</span><span class="ident" id="6203422">b</span><span class="op" id="6203423">.</span><span class="ident" id="6203424">Min</span><span class="op" id="6203427">.</span><span class="ident" id="6203428">Y</span><span class="op" id="6203429">)</span><span class="op" id="6203430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203433">writeUint16</span><span class="op" id="6203444">(</span><span class="ident" id="6203445">e</span><span class="op" id="6203446">.</span><span class="ident" id="6203447">buf</span><span class="op" id="6203450">[</span><span class="num" id="6203451">5</span><span class="op" id="6203452">:</span><span class="num" id="6203453">7</span><span class="op" id="6203454">]</span><span class="op" id="6203455">,</span>&nbsp;<span class="builtintype" id="6203457">uint16</span><span class="op" id="6203463">(</span><span class="ident" id="6203464">b</span><span class="op" id="6203465">.</span><span class="ident" id="6203466">Dx</span><span class="op" id="6203468">(</span><span class="op" id="6203469">)</span><span class="op" id="6203470">)</span><span class="op" id="6203471">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203474">writeUint16</span><span class="op" id="6203485">(</span><span class="ident" id="6203486">e</span><span class="op" id="6203487">.</span><span class="ident" id="6203488">buf</span><span class="op" id="6203491">[</span><span class="num" id="6203492">7</span><span class="op" id="6203493">:</span><span class="num" id="6203494">9</span><span class="op" id="6203495">]</span><span class="op" id="6203496">,</span>&nbsp;<span class="builtintype" id="6203498">uint16</span><span class="op" id="6203504">(</span><span class="ident" id="6203505">b</span><span class="op" id="6203506">.</span><span class="ident" id="6203507">Dy</span><span class="op" id="6203509">(</span><span class="op" id="6203510">)</span><span class="op" id="6203511">)</span><span class="op" id="6203512">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203515">e</span><span class="op" id="6203516">.</span><span class="ident" id="6203517">write</span><span class="op" id="6203522">(</span><span class="ident" id="6203523">e</span><span class="op" id="6203524">.</span><span class="ident" id="6203525">buf</span><span class="op" id="6203528">[</span><span class="op" id="6203529">:</span><span class="num" id="6203530">9</span><span class="op" id="6203531">]</span><span class="op" id="6203532">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203536">paddedSize</span>&nbsp;<span class="op" id="6203547">:=</span>&nbsp;<span class="ident" id="6203550">log2</span><span class="op" id="6203554">(</span><span class="builtinfunc" id="6203555">len</span><span class="op" id="6203558">(</span><span class="ident" id="6203559">pm</span><span class="op" id="6203561">.</span><span class="ident" id="6203562">Palette</span><span class="op" id="6203569">)</span><span class="op" id="6203570">)</span>&nbsp;<span class="comment" id="6203572">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6203612">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203646">e</span><span class="op" id="6203647">.</span><span class="ident" id="6203648">writeByte</span><span class="op" id="6203657">(</span><span class="num" id="6203658">0x80</span>&nbsp;<span class="op" id="6203663">|</span>&nbsp;<span class="builtintype" id="6203665">uint8</span><span class="op" id="6203670">(</span><span class="ident" id="6203671">paddedSize</span><span class="op" id="6203681">)</span><span class="op" id="6203682">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6203686">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203709">e</span><span class="op" id="6203710">.</span><span class="ident" id="6203711">writeColorTable</span><span class="op" id="6203726">(</span><span class="ident" id="6203727">pm</span><span class="op" id="6203729">.</span><span class="ident" id="6203730">Palette</span><span class="op" id="6203737">,</span>&nbsp;<span class="ident" id="6203739">paddedSize</span><span class="op" id="6203749">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203753">litWidth</span>&nbsp;<span class="op" id="6203762">:=</span>&nbsp;<span class="ident" id="6203765">paddedSize</span>&nbsp;<span class="op" id="6203776">+</span>&nbsp;<span class="num" id="6203778">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6203781">if</span>&nbsp;<span class="ident" id="6203784">litWidth</span>&nbsp;<span class="op" id="6203793">&lt;</span>&nbsp;<span class="num" id="6203795">2</span>&nbsp;<span class="op" id="6203797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203801">litWidth</span>&nbsp;<span class="op" id="6203810">=</span>&nbsp;<span class="num" id="6203812">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6203815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203818">e</span><span class="op" id="6203819">.</span><span class="ident" id="6203820">writeByte</span><span class="op" id="6203829">(</span><span class="builtintype" id="6203830">uint8</span><span class="op" id="6203835">(</span><span class="ident" id="6203836">litWidth</span><span class="op" id="6203844">)</span><span class="op" id="6203845">)</span>&nbsp;<span class="comment" id="6203847">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203875">lzww</span>&nbsp;<span class="op" id="6203880">:=</span>&nbsp;<span class="ident" id="6203883">lzw</span><span class="op" id="6203886">.</span><span class="ident" id="6203887">NewWriter</span><span class="op" id="6203896">(</span><span class="ident" id="6203897">blockWriter</span><span class="op" id="6203908">{</span><span class="ident" id="6203909">e</span><span class="op" id="6203910">:</span>&nbsp;<span class="ident" id="6203912">e</span><span class="op" id="6203913">}</span><span class="op" id="6203914">,</span>&nbsp;<span class="ident" id="6203916">lzw</span><span class="op" id="6203919">.</span><span class="ident" id="6203920">LSB</span><span class="op" id="6203923">,</span>&nbsp;<span class="ident" id="6203925">litWidth</span><span class="op" id="6203933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6203936">if</span>&nbsp;<span class="ident" id="6203939">dx</span>&nbsp;<span class="op" id="6203942">:=</span>&nbsp;<span class="ident" id="6203945">b</span><span class="op" id="6203946">.</span><span class="ident" id="6203947">Dx</span><span class="op" id="6203949">(</span><span class="op" id="6203950">)</span><span class="op" id="6203951">;</span>&nbsp;<span class="ident" id="6203953">dx</span>&nbsp;<span class="op" id="6203956">==</span>&nbsp;<span class="ident" id="6203959">pm</span><span class="op" id="6203961">.</span><span class="ident" id="6203962">Stride</span>&nbsp;<span class="op" id="6203969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6203973">_</span><span class="op" id="6203974">,</span>&nbsp;<span class="ident" id="6203976">e</span><span class="op" id="6203977">.</span><span class="ident" id="6203978">err</span>&nbsp;<span class="op" id="6203982">=</span>&nbsp;<span class="ident" id="6203984">lzww</span><span class="op" id="6203988">.</span><span class="ident" id="6203989">Write</span><span class="op" id="6203994">(</span><span class="ident" id="6203995">pm</span><span class="op" id="6203997">.</span><span class="ident" id="6203998">Pix</span><span class="op" id="6204001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204005">if</span>&nbsp;<span class="ident" id="6204008">e</span><span class="op" id="6204009">.</span><span class="ident" id="6204010">err</span>&nbsp;<span class="op" id="6204014">!=</span>&nbsp;<span class="ident" id="6204017">nil</span>&nbsp;<span class="op" id="6204021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204026">lzww</span><span class="op" id="6204030">.</span><span class="ident" id="6204031">Close</span><span class="op" id="6204036">(</span><span class="op" id="6204037">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204042">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204054">}</span>&nbsp;<span class="keyword" id="6204056">else</span>&nbsp;<span class="op" id="6204061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204065">for</span>&nbsp;<span class="ident" id="6204069">i</span><span class="op" id="6204070">,</span>&nbsp;<span class="ident" id="6204072">y</span>&nbsp;<span class="op" id="6204074">:=</span>&nbsp;<span class="num" id="6204077">0</span><span class="op" id="6204078">,</span>&nbsp;<span class="ident" id="6204080">b</span><span class="op" id="6204081">.</span><span class="ident" id="6204082">Min</span><span class="op" id="6204085">.</span><span class="ident" id="6204086">Y</span><span class="op" id="6204087">;</span>&nbsp;<span class="ident" id="6204089">y</span>&nbsp;<span class="op" id="6204091">&lt;</span>&nbsp;<span class="ident" id="6204093">b</span><span class="op" id="6204094">.</span><span class="ident" id="6204095">Max</span><span class="op" id="6204098">.</span><span class="ident" id="6204099">Y</span><span class="op" id="6204100">;</span>&nbsp;<span class="ident" id="6204102">i</span><span class="op" id="6204103">,</span>&nbsp;<span class="ident" id="6204105">y</span>&nbsp;<span class="op" id="6204107">=</span>&nbsp;<span class="ident" id="6204109">i</span><span class="op" id="6204110">+</span><span class="ident" id="6204111">pm</span><span class="op" id="6204113">.</span><span class="ident" id="6204114">Stride</span><span class="op" id="6204120">,</span>&nbsp;<span class="ident" id="6204122">y</span><span class="op" id="6204123">+</span><span class="num" id="6204124">1</span>&nbsp;<span class="op" id="6204126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204131">_</span><span class="op" id="6204132">,</span>&nbsp;<span class="ident" id="6204134">e</span><span class="op" id="6204135">.</span><span class="ident" id="6204136">err</span>&nbsp;<span class="op" id="6204140">=</span>&nbsp;<span class="ident" id="6204142">lzww</span><span class="op" id="6204146">.</span><span class="ident" id="6204147">Write</span><span class="op" id="6204152">(</span><span class="ident" id="6204153">pm</span><span class="op" id="6204155">.</span><span class="ident" id="6204156">Pix</span><span class="op" id="6204159">[</span><span class="ident" id="6204160">i</span>&nbsp;<span class="op" id="6204162">:</span>&nbsp;<span class="ident" id="6204164">i</span><span class="op" id="6204165">+</span><span class="ident" id="6204166">dx</span><span class="op" id="6204168">]</span><span class="op" id="6204169">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204174">if</span>&nbsp;<span class="ident" id="6204177">e</span><span class="op" id="6204178">.</span><span class="ident" id="6204179">err</span>&nbsp;<span class="op" id="6204183">!=</span>&nbsp;<span class="ident" id="6204186">nil</span>&nbsp;<span class="op" id="6204190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204196">lzww</span><span class="op" id="6204200">.</span><span class="ident" id="6204201">Close</span><span class="op" id="6204206">(</span><span class="op" id="6204207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204213">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204227">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204233">lzww</span><span class="op" id="6204237">.</span><span class="ident" id="6204238">Close</span><span class="op" id="6204243">(</span><span class="op" id="6204244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204247">e</span><span class="op" id="6204248">.</span><span class="ident" id="6204249">writeByte</span><span class="op" id="6204258">(</span><span class="num" id="6204259">0x00</span><span class="op" id="6204263">)</span>&nbsp;<span class="comment" id="6204265">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="6204286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="6204289">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="6204329">type</span>&nbsp;<span class="ident" id="6204334">Options</span>&nbsp;<span class="keyword" id="6204342">struct</span>&nbsp;<span class="op" id="6204349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204352">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204417">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204446">NumColors</span>&nbsp;<span class="builtintype" id="6204456">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204462">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204526">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204581">Quantizer</span>&nbsp;<span class="ident" id="6204591">draw</span><span class="op" id="6204595">.</span><span class="ident" id="6204596">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204608">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6204679">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6204737">Drawer</span>&nbsp;<span class="ident" id="6204744">draw</span><span class="op" id="6204748">.</span><span class="ident" id="6204749">Drawer</span><br>
<span class="lineno"></span><span class="op" id="6204756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6204759">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6204823">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="6204869">func</span>&nbsp;<span class="ident" id="6204874">EncodeAll</span><span class="op" id="6204883">(</span><span class="ident" id="6204884">w</span>&nbsp;<span class="ident" id="6204886">io</span><span class="op" id="6204888">.</span><span class="ident" id="6204889">Writer</span><span class="op" id="6204895">,</span>&nbsp;<span class="ident" id="6204897">g</span>&nbsp;<span class="op" id="6204899">*</span><span class="ident" id="6204900">GIF</span><span class="op" id="6204903">)</span>&nbsp;<span class="builtintype" id="6204905">error</span>&nbsp;<span class="op" id="6204911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204914">if</span>&nbsp;<span class="builtinfunc" id="6204917">len</span><span class="op" id="6204920">(</span><span class="ident" id="6204921">g</span><span class="op" id="6204922">.</span><span class="ident" id="6204923">Image</span><span class="op" id="6204928">)</span>&nbsp;<span class="op" id="6204930">==</span>&nbsp;<span class="num" id="6204933">0</span>&nbsp;<span class="op" id="6204935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6204939">return</span>&nbsp;<span class="ident" id="6204946">errors</span><span class="op" id="6204952">.</span><span class="ident" id="6204953">New</span><span class="op" id="6204956">(</span><span class="string" id="6204957">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="6204995">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6204998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205002">if</span>&nbsp;<span class="builtinfunc" id="6205005">len</span><span class="op" id="6205008">(</span><span class="ident" id="6205009">g</span><span class="op" id="6205010">.</span><span class="ident" id="6205011">Image</span><span class="op" id="6205016">)</span>&nbsp;<span class="op" id="6205018">!=</span>&nbsp;<span class="builtinfunc" id="6205021">len</span><span class="op" id="6205024">(</span><span class="ident" id="6205025">g</span><span class="op" id="6205026">.</span><span class="ident" id="6205027">Delay</span><span class="op" id="6205032">)</span>&nbsp;<span class="op" id="6205034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205038">return</span>&nbsp;<span class="ident" id="6205045">errors</span><span class="op" id="6205051">.</span><span class="ident" id="6205052">New</span><span class="op" id="6205055">(</span><span class="string" id="6205056">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="6205097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205100">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205103">if</span>&nbsp;<span class="ident" id="6205106">g</span><span class="op" id="6205107">.</span><span class="ident" id="6205108">LoopCount</span>&nbsp;<span class="op" id="6205118">&lt;</span>&nbsp;<span class="num" id="6205120">0</span>&nbsp;<span class="op" id="6205122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205126">g</span><span class="op" id="6205127">.</span><span class="ident" id="6205128">LoopCount</span>&nbsp;<span class="op" id="6205138">=</span>&nbsp;<span class="num" id="6205140">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205147">e</span>&nbsp;<span class="op" id="6205149">:=</span>&nbsp;<span class="ident" id="6205152">encoder</span><span class="op" id="6205159">{</span><span class="ident" id="6205160">g</span><span class="op" id="6205161">:</span>&nbsp;<span class="ident" id="6205163">g</span><span class="op" id="6205164">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205167">if</span>&nbsp;<span class="ident" id="6205170">ww</span><span class="op" id="6205172">,</span>&nbsp;<span class="ident" id="6205174">ok</span>&nbsp;<span class="op" id="6205177">:=</span>&nbsp;<span class="ident" id="6205180">w</span><span class="op" id="6205181">.</span><span class="op" id="6205182">(</span><span class="ident" id="6205183">writer</span><span class="op" id="6205189">)</span><span class="op" id="6205190">;</span>&nbsp;<span class="ident" id="6205192">ok</span>&nbsp;<span class="op" id="6205195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205199">e</span><span class="op" id="6205200">.</span><span class="ident" id="6205201">w</span>&nbsp;<span class="op" id="6205203">=</span>&nbsp;<span class="ident" id="6205205">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205209">}</span>&nbsp;<span class="keyword" id="6205211">else</span>&nbsp;<span class="op" id="6205216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205220">e</span><span class="op" id="6205221">.</span><span class="ident" id="6205222">w</span>&nbsp;<span class="op" id="6205224">=</span>&nbsp;<span class="ident" id="6205226">bufio</span><span class="op" id="6205231">.</span><span class="ident" id="6205232">NewWriter</span><span class="op" id="6205241">(</span><span class="ident" id="6205242">w</span><span class="op" id="6205243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205246">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205250">e</span><span class="op" id="6205251">.</span><span class="ident" id="6205252">writeHeader</span><span class="op" id="6205263">(</span><span class="op" id="6205264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205267">for</span>&nbsp;<span class="ident" id="6205271">i</span><span class="op" id="6205272">,</span>&nbsp;<span class="ident" id="6205274">pm</span>&nbsp;<span class="op" id="6205277">:=</span>&nbsp;<span class="keyword" id="6205280">range</span>&nbsp;<span class="ident" id="6205286">g</span><span class="op" id="6205287">.</span><span class="ident" id="6205288">Image</span>&nbsp;<span class="op" id="6205294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205298">e</span><span class="op" id="6205299">.</span><span class="ident" id="6205300">writeImageBlock</span><span class="op" id="6205315">(</span><span class="ident" id="6205316">pm</span><span class="op" id="6205318">,</span>&nbsp;<span class="ident" id="6205320">g</span><span class="op" id="6205321">.</span><span class="ident" id="6205322">Delay</span><span class="op" id="6205327">[</span><span class="ident" id="6205328">i</span><span class="op" id="6205329">]</span><span class="op" id="6205330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205333">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205336">e</span><span class="op" id="6205337">.</span><span class="ident" id="6205338">writeByte</span><span class="op" id="6205347">(</span><span class="ident" id="6205348">sTrailer</span><span class="op" id="6205356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205359">e</span><span class="op" id="6205360">.</span><span class="ident" id="6205361">flush</span><span class="op" id="6205366">(</span><span class="op" id="6205367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205370">return</span>&nbsp;<span class="ident" id="6205377">e</span><span class="op" id="6205378">.</span><span class="ident" id="6205379">err</span><br>
<span class="lineno"></span><span class="op" id="6205383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="6205386">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="6205435">func</span>&nbsp;<span class="ident" id="6205440">Encode</span><span class="op" id="6205446">(</span><span class="ident" id="6205447">w</span>&nbsp;<span class="ident" id="6205449">io</span><span class="op" id="6205451">.</span><span class="ident" id="6205452">Writer</span><span class="op" id="6205458">,</span>&nbsp;<span class="ident" id="6205460">m</span>&nbsp;<span class="ident" id="6205462">image</span><span class="op" id="6205467">.</span><span class="ident" id="6205468">Image</span><span class="op" id="6205473">,</span>&nbsp;<span class="ident" id="6205475">o</span>&nbsp;<span class="op" id="6205477">*</span><span class="ident" id="6205478">Options</span><span class="op" id="6205485">)</span>&nbsp;<span class="builtintype" id="6205487">error</span>&nbsp;<span class="op" id="6205493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6205496">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205540">b</span>&nbsp;<span class="op" id="6205542">:=</span>&nbsp;<span class="ident" id="6205545">m</span><span class="op" id="6205546">.</span><span class="ident" id="6205547">Bounds</span><span class="op" id="6205553">(</span><span class="op" id="6205554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205557">if</span>&nbsp;<span class="ident" id="6205560">b</span><span class="op" id="6205561">.</span><span class="ident" id="6205562">Dx</span><span class="op" id="6205564">(</span><span class="op" id="6205565">)</span>&nbsp;<span class="op" id="6205567">&gt;=</span>&nbsp;<span class="num" id="6205570">1</span><span class="op" id="6205571">&lt;&lt;</span><span class="num" id="6205573">16</span>&nbsp;<span class="op" id="6205576">||</span>&nbsp;<span class="ident" id="6205579">b</span><span class="op" id="6205580">.</span><span class="ident" id="6205581">Dy</span><span class="op" id="6205583">(</span><span class="op" id="6205584">)</span>&nbsp;<span class="op" id="6205586">&gt;=</span>&nbsp;<span class="num" id="6205589">1</span><span class="op" id="6205590">&lt;&lt;</span><span class="num" id="6205592">16</span>&nbsp;<span class="op" id="6205595">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205599">return</span>&nbsp;<span class="ident" id="6205606">errors</span><span class="op" id="6205612">.</span><span class="ident" id="6205613">New</span><span class="op" id="6205616">(</span><span class="string" id="6205617">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="6205652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205659">opts</span>&nbsp;<span class="op" id="6205664">:=</span>&nbsp;<span class="ident" id="6205667">Options</span><span class="op" id="6205674">{</span><span class="op" id="6205675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205678">if</span>&nbsp;<span class="ident" id="6205681">o</span>&nbsp;<span class="op" id="6205683">!=</span>&nbsp;<span class="ident" id="6205686">nil</span>&nbsp;<span class="op" id="6205690">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205694">opts</span>&nbsp;<span class="op" id="6205699">=</span>&nbsp;<span class="op" id="6205701">*</span><span class="ident" id="6205702">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205708">if</span>&nbsp;<span class="ident" id="6205711">opts</span><span class="op" id="6205715">.</span><span class="ident" id="6205716">NumColors</span>&nbsp;<span class="op" id="6205726">&lt;</span>&nbsp;<span class="num" id="6205728">1</span>&nbsp;<span class="op" id="6205730">||</span>&nbsp;<span class="num" id="6205733">256</span>&nbsp;<span class="op" id="6205737">&lt;</span>&nbsp;<span class="ident" id="6205739">opts</span><span class="op" id="6205743">.</span><span class="ident" id="6205744">NumColors</span>&nbsp;<span class="op" id="6205754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205758">opts</span><span class="op" id="6205762">.</span><span class="ident" id="6205763">NumColors</span>&nbsp;<span class="op" id="6205773">=</span>&nbsp;<span class="num" id="6205775">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205780">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205783">if</span>&nbsp;<span class="ident" id="6205786">opts</span><span class="op" id="6205790">.</span><span class="ident" id="6205791">Drawer</span>&nbsp;<span class="op" id="6205798">==</span>&nbsp;<span class="ident" id="6205801">nil</span>&nbsp;<span class="op" id="6205805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205809">opts</span><span class="op" id="6205813">.</span><span class="ident" id="6205814">Drawer</span>&nbsp;<span class="op" id="6205821">=</span>&nbsp;<span class="ident" id="6205823">draw</span><span class="op" id="6205827">.</span><span class="ident" id="6205828">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6205844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205848">pm</span><span class="op" id="6205850">,</span>&nbsp;<span class="ident" id="6205852">ok</span>&nbsp;<span class="op" id="6205855">:=</span>&nbsp;<span class="ident" id="6205858">m</span><span class="op" id="6205859">.</span><span class="op" id="6205860">(</span><span class="op" id="6205861">*</span><span class="ident" id="6205862">image</span><span class="op" id="6205867">.</span><span class="ident" id="6205868">Paletted</span><span class="op" id="6205876">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6205879">if</span>&nbsp;<span class="op" id="6205882">!</span><span class="ident" id="6205883">ok</span>&nbsp;<span class="op" id="6205886">||</span>&nbsp;<span class="builtinfunc" id="6205889">len</span><span class="op" id="6205892">(</span><span class="ident" id="6205893">pm</span><span class="op" id="6205895">.</span><span class="ident" id="6205896">Palette</span><span class="op" id="6205903">)</span>&nbsp;<span class="op" id="6205905">&gt;</span>&nbsp;<span class="ident" id="6205907">opts</span><span class="op" id="6205911">.</span><span class="ident" id="6205912">NumColors</span>&nbsp;<span class="op" id="6205922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6205926">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6205985">pm</span>&nbsp;<span class="op" id="6205988">=</span>&nbsp;<span class="ident" id="6205990">image</span><span class="op" id="6205995">.</span><span class="ident" id="6205996">NewPaletted</span><span class="op" id="6206007">(</span><span class="ident" id="6206008">b</span><span class="op" id="6206009">,</span>&nbsp;<span class="ident" id="6206011">palette</span><span class="op" id="6206018">.</span><span class="ident" id="6206019">Plan9</span><span class="op" id="6206024">[</span><span class="op" id="6206025">:</span><span class="ident" id="6206026">opts</span><span class="op" id="6206030">.</span><span class="ident" id="6206031">NumColors</span><span class="op" id="6206040">]</span><span class="op" id="6206041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6206045">if</span>&nbsp;<span class="ident" id="6206048">opts</span><span class="op" id="6206052">.</span><span class="ident" id="6206053">Quantizer</span>&nbsp;<span class="op" id="6206063">!=</span>&nbsp;<span class="ident" id="6206066">nil</span>&nbsp;<span class="op" id="6206070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6206075">pm</span><span class="op" id="6206077">.</span><span class="ident" id="6206078">Palette</span>&nbsp;<span class="op" id="6206086">=</span>&nbsp;<span class="ident" id="6206088">opts</span><span class="op" id="6206092">.</span><span class="ident" id="6206093">Quantizer</span><span class="op" id="6206102">.</span><span class="ident" id="6206103">Quantize</span><span class="op" id="6206111">(</span><span class="builtinfunc" id="6206112">make</span><span class="op" id="6206116">(</span><span class="ident" id="6206117">color</span><span class="op" id="6206122">.</span><span class="ident" id="6206123">Palette</span><span class="op" id="6206130">,</span>&nbsp;<span class="num" id="6206132">0</span><span class="op" id="6206133">,</span>&nbsp;<span class="ident" id="6206135">opts</span><span class="op" id="6206139">.</span><span class="ident" id="6206140">NumColors</span><span class="op" id="6206149">)</span><span class="op" id="6206150">,</span>&nbsp;<span class="ident" id="6206152">m</span><span class="op" id="6206153">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6206157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6206161">opts</span><span class="op" id="6206165">.</span><span class="ident" id="6206166">Drawer</span><span class="op" id="6206172">.</span><span class="ident" id="6206173">Draw</span><span class="op" id="6206177">(</span><span class="ident" id="6206178">pm</span><span class="op" id="6206180">,</span>&nbsp;<span class="ident" id="6206182">b</span><span class="op" id="6206183">,</span>&nbsp;<span class="ident" id="6206185">m</span><span class="op" id="6206186">,</span>&nbsp;<span class="ident" id="6206188">image</span><span class="op" id="6206193">.</span><span class="ident" id="6206194">ZP</span><span class="op" id="6206196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6206199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6206203">return</span>&nbsp;<span class="ident" id="6206210">EncodeAll</span><span class="op" id="6206219">(</span><span class="ident" id="6206220">w</span><span class="op" id="6206221">,</span>&nbsp;<span class="op" id="6206223">&amp;</span><span class="ident" id="6206224">GIF</span><span class="op" id="6206227">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6206231">Image</span><span class="op" id="6206236">:</span>&nbsp;<span class="op" id="6206238">[</span><span class="op" id="6206239">]</span><span class="op" id="6206240">*</span><span class="ident" id="6206241">image</span><span class="op" id="6206246">.</span><span class="ident" id="6206247">Paletted</span><span class="op" id="6206255">{</span><span class="ident" id="6206256">pm</span><span class="op" id="6206258">}</span><span class="op" id="6206259">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6206263">Delay</span><span class="op" id="6206268">:</span>&nbsp;<span class="op" id="6206270">[</span><span class="op" id="6206271">]</span><span class="builtintype" id="6206272">int</span><span class="op" id="6206275">{</span><span class="num" id="6206276">0</span><span class="op" id="6206277">}</span><span class="op" id="6206278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6206281">}</span><span class="op" id="6206282">)</span><br>
<span class="lineno"></span><span class="op" id="6206284">}</span>
</div>
</body>
</html>
