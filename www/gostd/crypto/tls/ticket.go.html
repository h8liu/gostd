<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4206395">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4206450">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4206504">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4206555">package</span>&nbsp;<span class="ident" id="4206563">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4206568">import</span>&nbsp;<span class="op" id="4206575">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206578">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206587">&#34;crypto/aes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206601">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206618">&#34;crypto/hmac&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206633">&#34;crypto/sha256&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206650">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206667">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4206677">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4206682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4206685">//&nbsp;sessionState&nbsp;contains&nbsp;the&nbsp;information&nbsp;that&nbsp;is&nbsp;serialized&nbsp;into&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span><span class="comment" id="4206760">//&nbsp;ticket&nbsp;in&nbsp;order&nbsp;to&nbsp;later&nbsp;resume&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">20</span><span class="keyword" id="4206809">type</span>&nbsp;<span class="ident" id="4206814">sessionState</span>&nbsp;<span class="keyword" id="4206827">struct</span>&nbsp;<span class="op" id="4206834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206837">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4206850">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206858">cipherSuite</span>&nbsp;&nbsp;<span class="builtintype" id="4206871">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206879">masterSecret</span>&nbsp;<span class="op" id="4206892">[</span><span class="op" id="4206893">]</span><span class="builtintype" id="4206894">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206900">certificates</span>&nbsp;<span class="op" id="4206913">[</span><span class="op" id="4206914">]</span><span class="op" id="4206915">[</span><span class="op" id="4206916">]</span><span class="builtintype" id="4206917">byte</span><br>
<span class="lineno">25</span><span class="op" id="4206922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4206925">func</span>&nbsp;<span class="op" id="4206930">(</span><span class="ident" id="4206931">s</span>&nbsp;<span class="op" id="4206933">*</span><span class="ident" id="4206934">sessionState</span><span class="op" id="4206946">)</span>&nbsp;<span class="ident" id="4206948">equal</span><span class="op" id="4206953">(</span><span class="ident" id="4206954">i</span>&nbsp;<span class="keyword" id="4206956">interface</span><span class="op" id="4206965">{</span><span class="op" id="4206966">}</span><span class="op" id="4206967">)</span>&nbsp;<span class="builtintype" id="4206969">bool</span>&nbsp;<span class="op" id="4206974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4206977">s1</span><span class="op" id="4206979">,</span>&nbsp;<span class="ident" id="4206981">ok</span>&nbsp;<span class="op" id="4206984">:=</span>&nbsp;<span class="ident" id="4206987">i</span><span class="op" id="4206988">.</span><span class="op" id="4206989">(</span><span class="op" id="4206990">*</span><span class="ident" id="4206991">sessionState</span><span class="op" id="4207003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207006">if</span>&nbsp;<span class="op" id="4207009">!</span><span class="ident" id="4207010">ok</span>&nbsp;<span class="op" id="4207013">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207017">return</span>&nbsp;<span class="builtintype" id="4207024">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207035">if</span>&nbsp;<span class="ident" id="4207038">s</span><span class="op" id="4207039">.</span><span class="ident" id="4207040">vers</span>&nbsp;<span class="op" id="4207045">!=</span>&nbsp;<span class="ident" id="4207048">s1</span><span class="op" id="4207050">.</span><span class="ident" id="4207051">vers</span>&nbsp;<span class="op" id="4207056">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207061">s</span><span class="op" id="4207062">.</span><span class="ident" id="4207063">cipherSuite</span>&nbsp;<span class="op" id="4207075">!=</span>&nbsp;<span class="ident" id="4207078">s1</span><span class="op" id="4207080">.</span><span class="ident" id="4207081">cipherSuite</span>&nbsp;<span class="op" id="4207093">||</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207098">!</span><span class="ident" id="4207099">bytes</span><span class="op" id="4207104">.</span><span class="ident" id="4207105">Equal</span><span class="op" id="4207110">(</span><span class="ident" id="4207111">s</span><span class="op" id="4207112">.</span><span class="ident" id="4207113">masterSecret</span><span class="op" id="4207125">,</span>&nbsp;<span class="ident" id="4207127">s1</span><span class="op" id="4207129">.</span><span class="ident" id="4207130">masterSecret</span><span class="op" id="4207142">)</span>&nbsp;<span class="op" id="4207144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207148">return</span>&nbsp;<span class="builtintype" id="4207155">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207166">if</span>&nbsp;<span class="builtinfunc" id="4207169">len</span><span class="op" id="4207172">(</span><span class="ident" id="4207173">s</span><span class="op" id="4207174">.</span><span class="ident" id="4207175">certificates</span><span class="op" id="4207187">)</span>&nbsp;<span class="op" id="4207189">!=</span>&nbsp;<span class="builtinfunc" id="4207192">len</span><span class="op" id="4207195">(</span><span class="ident" id="4207196">s1</span><span class="op" id="4207198">.</span><span class="ident" id="4207199">certificates</span><span class="op" id="4207211">)</span>&nbsp;<span class="op" id="4207213">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207217">return</span>&nbsp;<span class="builtintype" id="4207224">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207235">for</span>&nbsp;<span class="ident" id="4207239">i</span>&nbsp;<span class="op" id="4207241">:=</span>&nbsp;<span class="keyword" id="4207244">range</span>&nbsp;<span class="ident" id="4207250">s</span><span class="op" id="4207251">.</span><span class="ident" id="4207252">certificates</span>&nbsp;<span class="op" id="4207265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207269">if</span>&nbsp;<span class="op" id="4207272">!</span><span class="ident" id="4207273">bytes</span><span class="op" id="4207278">.</span><span class="ident" id="4207279">Equal</span><span class="op" id="4207284">(</span><span class="ident" id="4207285">s</span><span class="op" id="4207286">.</span><span class="ident" id="4207287">certificates</span><span class="op" id="4207299">[</span><span class="ident" id="4207300">i</span><span class="op" id="4207301">]</span><span class="op" id="4207302">,</span>&nbsp;<span class="ident" id="4207304">s1</span><span class="op" id="4207306">.</span><span class="ident" id="4207307">certificates</span><span class="op" id="4207319">[</span><span class="ident" id="4207320">i</span><span class="op" id="4207321">]</span><span class="op" id="4207322">)</span>&nbsp;<span class="op" id="4207324">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207329">return</span>&nbsp;<span class="builtintype" id="4207336">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207351">return</span>&nbsp;<span class="builtintype" id="4207358">true</span><br>
<span class="lineno">50</span><span class="op" id="4207363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4207366">func</span>&nbsp;<span class="op" id="4207371">(</span><span class="ident" id="4207372">s</span>&nbsp;<span class="op" id="4207374">*</span><span class="ident" id="4207375">sessionState</span><span class="op" id="4207387">)</span>&nbsp;<span class="ident" id="4207389">marshal</span><span class="op" id="4207396">(</span><span class="op" id="4207397">)</span>&nbsp;<span class="op" id="4207399">[</span><span class="op" id="4207400">]</span><span class="builtintype" id="4207401">byte</span>&nbsp;<span class="op" id="4207406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207409">length</span>&nbsp;<span class="op" id="4207416">:=</span>&nbsp;<span class="num" id="4207419">2</span>&nbsp;<span class="op" id="4207421">+</span>&nbsp;<span class="num" id="4207423">2</span>&nbsp;<span class="op" id="4207425">+</span>&nbsp;<span class="num" id="4207427">2</span>&nbsp;<span class="op" id="4207429">+</span>&nbsp;<span class="builtinfunc" id="4207431">len</span><span class="op" id="4207434">(</span><span class="ident" id="4207435">s</span><span class="op" id="4207436">.</span><span class="ident" id="4207437">masterSecret</span><span class="op" id="4207449">)</span>&nbsp;<span class="op" id="4207451">+</span>&nbsp;<span class="num" id="4207453">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207456">for</span>&nbsp;<span class="ident" id="4207460">_</span><span class="op" id="4207461">,</span>&nbsp;<span class="ident" id="4207463">cert</span>&nbsp;<span class="op" id="4207468">:=</span>&nbsp;<span class="keyword" id="4207471">range</span>&nbsp;<span class="ident" id="4207477">s</span><span class="op" id="4207478">.</span><span class="ident" id="4207479">certificates</span>&nbsp;<span class="op" id="4207492">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207496">length</span>&nbsp;<span class="op" id="4207503">+=</span>&nbsp;<span class="num" id="4207506">4</span>&nbsp;<span class="op" id="4207508">+</span>&nbsp;<span class="builtinfunc" id="4207510">len</span><span class="op" id="4207513">(</span><span class="ident" id="4207514">cert</span><span class="op" id="4207518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4207521">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207525">ret</span>&nbsp;<span class="op" id="4207529">:=</span>&nbsp;<span class="builtinfunc" id="4207532">make</span><span class="op" id="4207536">(</span><span class="op" id="4207537">[</span><span class="op" id="4207538">]</span><span class="builtintype" id="4207539">byte</span><span class="op" id="4207543">,</span>&nbsp;<span class="ident" id="4207545">length</span><span class="op" id="4207551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207554">x</span>&nbsp;<span class="op" id="4207556">:=</span>&nbsp;<span class="ident" id="4207559">ret</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207564">x</span><span class="op" id="4207565">[</span><span class="num" id="4207566">0</span><span class="op" id="4207567">]</span>&nbsp;<span class="op" id="4207569">=</span>&nbsp;<span class="builtintype" id="4207571">byte</span><span class="op" id="4207575">(</span><span class="ident" id="4207576">s</span><span class="op" id="4207577">.</span><span class="ident" id="4207578">vers</span>&nbsp;<span class="op" id="4207583">&gt;&gt;</span>&nbsp;<span class="num" id="4207586">8</span><span class="op" id="4207587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207590">x</span><span class="op" id="4207591">[</span><span class="num" id="4207592">1</span><span class="op" id="4207593">]</span>&nbsp;<span class="op" id="4207595">=</span>&nbsp;<span class="builtintype" id="4207597">byte</span><span class="op" id="4207601">(</span><span class="ident" id="4207602">s</span><span class="op" id="4207603">.</span><span class="ident" id="4207604">vers</span><span class="op" id="4207608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207611">x</span><span class="op" id="4207612">[</span><span class="num" id="4207613">2</span><span class="op" id="4207614">]</span>&nbsp;<span class="op" id="4207616">=</span>&nbsp;<span class="builtintype" id="4207618">byte</span><span class="op" id="4207622">(</span><span class="ident" id="4207623">s</span><span class="op" id="4207624">.</span><span class="ident" id="4207625">cipherSuite</span>&nbsp;<span class="op" id="4207637">&gt;&gt;</span>&nbsp;<span class="num" id="4207640">8</span><span class="op" id="4207641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207644">x</span><span class="op" id="4207645">[</span><span class="num" id="4207646">3</span><span class="op" id="4207647">]</span>&nbsp;<span class="op" id="4207649">=</span>&nbsp;<span class="builtintype" id="4207651">byte</span><span class="op" id="4207655">(</span><span class="ident" id="4207656">s</span><span class="op" id="4207657">.</span><span class="ident" id="4207658">cipherSuite</span><span class="op" id="4207669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207672">x</span><span class="op" id="4207673">[</span><span class="num" id="4207674">4</span><span class="op" id="4207675">]</span>&nbsp;<span class="op" id="4207677">=</span>&nbsp;<span class="builtintype" id="4207679">byte</span><span class="op" id="4207683">(</span><span class="builtinfunc" id="4207684">len</span><span class="op" id="4207687">(</span><span class="ident" id="4207688">s</span><span class="op" id="4207689">.</span><span class="ident" id="4207690">masterSecret</span><span class="op" id="4207702">)</span>&nbsp;<span class="op" id="4207704">&gt;&gt;</span>&nbsp;<span class="num" id="4207707">8</span><span class="op" id="4207708">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207711">x</span><span class="op" id="4207712">[</span><span class="num" id="4207713">5</span><span class="op" id="4207714">]</span>&nbsp;<span class="op" id="4207716">=</span>&nbsp;<span class="builtintype" id="4207718">byte</span><span class="op" id="4207722">(</span><span class="builtinfunc" id="4207723">len</span><span class="op" id="4207726">(</span><span class="ident" id="4207727">s</span><span class="op" id="4207728">.</span><span class="ident" id="4207729">masterSecret</span><span class="op" id="4207741">)</span><span class="op" id="4207742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207745">x</span>&nbsp;<span class="op" id="4207747">=</span>&nbsp;<span class="ident" id="4207749">x</span><span class="op" id="4207750">[</span><span class="num" id="4207751">6</span><span class="op" id="4207752">:</span><span class="op" id="4207753">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4207756">copy</span><span class="op" id="4207760">(</span><span class="ident" id="4207761">x</span><span class="op" id="4207762">,</span>&nbsp;<span class="ident" id="4207764">s</span><span class="op" id="4207765">.</span><span class="ident" id="4207766">masterSecret</span><span class="op" id="4207778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207781">x</span>&nbsp;<span class="op" id="4207783">=</span>&nbsp;<span class="ident" id="4207785">x</span><span class="op" id="4207786">[</span><span class="builtinfunc" id="4207787">len</span><span class="op" id="4207790">(</span><span class="ident" id="4207791">s</span><span class="op" id="4207792">.</span><span class="ident" id="4207793">masterSecret</span><span class="op" id="4207805">)</span><span class="op" id="4207806">:</span><span class="op" id="4207807">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207811">x</span><span class="op" id="4207812">[</span><span class="num" id="4207813">0</span><span class="op" id="4207814">]</span>&nbsp;<span class="op" id="4207816">=</span>&nbsp;<span class="builtintype" id="4207818">byte</span><span class="op" id="4207822">(</span><span class="builtinfunc" id="4207823">len</span><span class="op" id="4207826">(</span><span class="ident" id="4207827">s</span><span class="op" id="4207828">.</span><span class="ident" id="4207829">certificates</span><span class="op" id="4207841">)</span>&nbsp;<span class="op" id="4207843">&gt;&gt;</span>&nbsp;<span class="num" id="4207846">8</span><span class="op" id="4207847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207850">x</span><span class="op" id="4207851">[</span><span class="num" id="4207852">1</span><span class="op" id="4207853">]</span>&nbsp;<span class="op" id="4207855">=</span>&nbsp;<span class="builtintype" id="4207857">byte</span><span class="op" id="4207861">(</span><span class="builtinfunc" id="4207862">len</span><span class="op" id="4207865">(</span><span class="ident" id="4207866">s</span><span class="op" id="4207867">.</span><span class="ident" id="4207868">certificates</span><span class="op" id="4207880">)</span><span class="op" id="4207881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207884">x</span>&nbsp;<span class="op" id="4207886">=</span>&nbsp;<span class="ident" id="4207888">x</span><span class="op" id="4207889">[</span><span class="num" id="4207890">2</span><span class="op" id="4207891">:</span><span class="op" id="4207892">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4207896">for</span>&nbsp;<span class="ident" id="4207900">_</span><span class="op" id="4207901">,</span>&nbsp;<span class="ident" id="4207903">cert</span>&nbsp;<span class="op" id="4207908">:=</span>&nbsp;<span class="keyword" id="4207911">range</span>&nbsp;<span class="ident" id="4207917">s</span><span class="op" id="4207918">.</span><span class="ident" id="4207919">certificates</span>&nbsp;<span class="op" id="4207932">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207936">x</span><span class="op" id="4207937">[</span><span class="num" id="4207938">0</span><span class="op" id="4207939">]</span>&nbsp;<span class="op" id="4207941">=</span>&nbsp;<span class="builtintype" id="4207943">byte</span><span class="op" id="4207947">(</span><span class="builtinfunc" id="4207948">len</span><span class="op" id="4207951">(</span><span class="ident" id="4207952">cert</span><span class="op" id="4207956">)</span>&nbsp;<span class="op" id="4207958">&gt;&gt;</span>&nbsp;<span class="num" id="4207961">24</span><span class="op" id="4207963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207967">x</span><span class="op" id="4207968">[</span><span class="num" id="4207969">1</span><span class="op" id="4207970">]</span>&nbsp;<span class="op" id="4207972">=</span>&nbsp;<span class="builtintype" id="4207974">byte</span><span class="op" id="4207978">(</span><span class="builtinfunc" id="4207979">len</span><span class="op" id="4207982">(</span><span class="ident" id="4207983">cert</span><span class="op" id="4207987">)</span>&nbsp;<span class="op" id="4207989">&gt;&gt;</span>&nbsp;<span class="num" id="4207992">16</span><span class="op" id="4207994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4207998">x</span><span class="op" id="4207999">[</span><span class="num" id="4208000">2</span><span class="op" id="4208001">]</span>&nbsp;<span class="op" id="4208003">=</span>&nbsp;<span class="builtintype" id="4208005">byte</span><span class="op" id="4208009">(</span><span class="builtinfunc" id="4208010">len</span><span class="op" id="4208013">(</span><span class="ident" id="4208014">cert</span><span class="op" id="4208018">)</span>&nbsp;<span class="op" id="4208020">&gt;&gt;</span>&nbsp;<span class="num" id="4208023">8</span><span class="op" id="4208024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208028">x</span><span class="op" id="4208029">[</span><span class="num" id="4208030">3</span><span class="op" id="4208031">]</span>&nbsp;<span class="op" id="4208033">=</span>&nbsp;<span class="builtintype" id="4208035">byte</span><span class="op" id="4208039">(</span><span class="builtinfunc" id="4208040">len</span><span class="op" id="4208043">(</span><span class="ident" id="4208044">cert</span><span class="op" id="4208048">)</span><span class="op" id="4208049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4208053">copy</span><span class="op" id="4208057">(</span><span class="ident" id="4208058">x</span><span class="op" id="4208059">[</span><span class="num" id="4208060">4</span><span class="op" id="4208061">:</span><span class="op" id="4208062">]</span><span class="op" id="4208063">,</span>&nbsp;<span class="ident" id="4208065">cert</span><span class="op" id="4208069">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208073">x</span>&nbsp;<span class="op" id="4208075">=</span>&nbsp;<span class="ident" id="4208077">x</span><span class="op" id="4208078">[</span><span class="num" id="4208079">4</span><span class="op" id="4208080">+</span><span class="builtinfunc" id="4208081">len</span><span class="op" id="4208084">(</span><span class="ident" id="4208085">cert</span><span class="op" id="4208089">)</span><span class="op" id="4208090">:</span><span class="op" id="4208091">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208098">return</span>&nbsp;<span class="ident" id="4208105">ret</span><br>
<span class="lineno"></span><span class="op" id="4208109">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="4208112">func</span>&nbsp;<span class="op" id="4208117">(</span><span class="ident" id="4208118">s</span>&nbsp;<span class="op" id="4208120">*</span><span class="ident" id="4208121">sessionState</span><span class="op" id="4208133">)</span>&nbsp;<span class="ident" id="4208135">unmarshal</span><span class="op" id="4208144">(</span><span class="ident" id="4208145">data</span>&nbsp;<span class="op" id="4208150">[</span><span class="op" id="4208151">]</span><span class="builtintype" id="4208152">byte</span><span class="op" id="4208156">)</span>&nbsp;<span class="builtintype" id="4208158">bool</span>&nbsp;<span class="op" id="4208163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208166">if</span>&nbsp;<span class="builtinfunc" id="4208169">len</span><span class="op" id="4208172">(</span><span class="ident" id="4208173">data</span><span class="op" id="4208177">)</span>&nbsp;<span class="op" id="4208179">&lt;</span>&nbsp;<span class="num" id="4208181">8</span>&nbsp;<span class="op" id="4208183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208187">return</span>&nbsp;<span class="builtintype" id="4208194">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208201">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208205">s</span><span class="op" id="4208206">.</span><span class="ident" id="4208207">vers</span>&nbsp;<span class="op" id="4208212">=</span>&nbsp;<span class="builtintype" id="4208214">uint16</span><span class="op" id="4208220">(</span><span class="ident" id="4208221">data</span><span class="op" id="4208225">[</span><span class="num" id="4208226">0</span><span class="op" id="4208227">]</span><span class="op" id="4208228">)</span><span class="op" id="4208229">&lt;&lt;</span><span class="num" id="4208231">8</span>&nbsp;<span class="op" id="4208233">|</span>&nbsp;<span class="builtintype" id="4208235">uint16</span><span class="op" id="4208241">(</span><span class="ident" id="4208242">data</span><span class="op" id="4208246">[</span><span class="num" id="4208247">1</span><span class="op" id="4208248">]</span><span class="op" id="4208249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208252">s</span><span class="op" id="4208253">.</span><span class="ident" id="4208254">cipherSuite</span>&nbsp;<span class="op" id="4208266">=</span>&nbsp;<span class="builtintype" id="4208268">uint16</span><span class="op" id="4208274">(</span><span class="ident" id="4208275">data</span><span class="op" id="4208279">[</span><span class="num" id="4208280">2</span><span class="op" id="4208281">]</span><span class="op" id="4208282">)</span><span class="op" id="4208283">&lt;&lt;</span><span class="num" id="4208285">8</span>&nbsp;<span class="op" id="4208287">|</span>&nbsp;<span class="builtintype" id="4208289">uint16</span><span class="op" id="4208295">(</span><span class="ident" id="4208296">data</span><span class="op" id="4208300">[</span><span class="num" id="4208301">3</span><span class="op" id="4208302">]</span><span class="op" id="4208303">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208306">masterSecretLen</span>&nbsp;<span class="op" id="4208322">:=</span>&nbsp;<span class="builtintype" id="4208325">int</span><span class="op" id="4208328">(</span><span class="ident" id="4208329">data</span><span class="op" id="4208333">[</span><span class="num" id="4208334">4</span><span class="op" id="4208335">]</span><span class="op" id="4208336">)</span><span class="op" id="4208337">&lt;&lt;</span><span class="num" id="4208339">8</span>&nbsp;<span class="op" id="4208341">|</span>&nbsp;<span class="builtintype" id="4208343">int</span><span class="op" id="4208346">(</span><span class="ident" id="4208347">data</span><span class="op" id="4208351">[</span><span class="num" id="4208352">5</span><span class="op" id="4208353">]</span><span class="op" id="4208354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208357">data</span>&nbsp;<span class="op" id="4208362">=</span>&nbsp;<span class="ident" id="4208364">data</span><span class="op" id="4208368">[</span><span class="num" id="4208369">6</span><span class="op" id="4208370">:</span><span class="op" id="4208371">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208374">if</span>&nbsp;<span class="builtinfunc" id="4208377">len</span><span class="op" id="4208380">(</span><span class="ident" id="4208381">data</span><span class="op" id="4208385">)</span>&nbsp;<span class="op" id="4208387">&lt;</span>&nbsp;<span class="ident" id="4208389">masterSecretLen</span>&nbsp;<span class="op" id="4208405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208409">return</span>&nbsp;<span class="builtintype" id="4208416">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208427">s</span><span class="op" id="4208428">.</span><span class="ident" id="4208429">masterSecret</span>&nbsp;<span class="op" id="4208442">=</span>&nbsp;<span class="ident" id="4208444">data</span><span class="op" id="4208448">[</span><span class="op" id="4208449">:</span><span class="ident" id="4208450">masterSecretLen</span><span class="op" id="4208465">]</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208468">data</span>&nbsp;<span class="op" id="4208473">=</span>&nbsp;<span class="ident" id="4208475">data</span><span class="op" id="4208479">[</span><span class="ident" id="4208480">masterSecretLen</span><span class="op" id="4208495">:</span><span class="op" id="4208496">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208500">if</span>&nbsp;<span class="builtinfunc" id="4208503">len</span><span class="op" id="4208506">(</span><span class="ident" id="4208507">data</span><span class="op" id="4208511">)</span>&nbsp;<span class="op" id="4208513">&lt;</span>&nbsp;<span class="num" id="4208515">2</span>&nbsp;<span class="op" id="4208517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208521">return</span>&nbsp;<span class="builtintype" id="4208528">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208535">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208539">numCerts</span>&nbsp;<span class="op" id="4208548">:=</span>&nbsp;<span class="builtintype" id="4208551">int</span><span class="op" id="4208554">(</span><span class="ident" id="4208555">data</span><span class="op" id="4208559">[</span><span class="num" id="4208560">0</span><span class="op" id="4208561">]</span><span class="op" id="4208562">)</span><span class="op" id="4208563">&lt;&lt;</span><span class="num" id="4208565">8</span>&nbsp;<span class="op" id="4208567">|</span>&nbsp;<span class="builtintype" id="4208569">int</span><span class="op" id="4208572">(</span><span class="ident" id="4208573">data</span><span class="op" id="4208577">[</span><span class="num" id="4208578">1</span><span class="op" id="4208579">]</span><span class="op" id="4208580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208583">data</span>&nbsp;<span class="op" id="4208588">=</span>&nbsp;<span class="ident" id="4208590">data</span><span class="op" id="4208594">[</span><span class="num" id="4208595">2</span><span class="op" id="4208596">:</span><span class="op" id="4208597">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208601">s</span><span class="op" id="4208602">.</span><span class="ident" id="4208603">certificates</span>&nbsp;<span class="op" id="4208616">=</span>&nbsp;<span class="builtinfunc" id="4208618">make</span><span class="op" id="4208622">(</span><span class="op" id="4208623">[</span><span class="op" id="4208624">]</span><span class="op" id="4208625">[</span><span class="op" id="4208626">]</span><span class="builtintype" id="4208627">byte</span><span class="op" id="4208631">,</span>&nbsp;<span class="ident" id="4208633">numCerts</span><span class="op" id="4208641">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208644">for</span>&nbsp;<span class="ident" id="4208648">i</span>&nbsp;<span class="op" id="4208650">:=</span>&nbsp;<span class="keyword" id="4208653">range</span>&nbsp;<span class="ident" id="4208659">s</span><span class="op" id="4208660">.</span><span class="ident" id="4208661">certificates</span>&nbsp;<span class="op" id="4208674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208678">if</span>&nbsp;<span class="builtinfunc" id="4208681">len</span><span class="op" id="4208684">(</span><span class="ident" id="4208685">data</span><span class="op" id="4208689">)</span>&nbsp;<span class="op" id="4208691">&lt;</span>&nbsp;<span class="num" id="4208693">4</span>&nbsp;<span class="op" id="4208695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208700">return</span>&nbsp;<span class="builtintype" id="4208707">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208719">certLen</span>&nbsp;<span class="op" id="4208727">:=</span>&nbsp;<span class="builtintype" id="4208730">int</span><span class="op" id="4208733">(</span><span class="ident" id="4208734">data</span><span class="op" id="4208738">[</span><span class="num" id="4208739">0</span><span class="op" id="4208740">]</span><span class="op" id="4208741">)</span><span class="op" id="4208742">&lt;&lt;</span><span class="num" id="4208744">24</span>&nbsp;<span class="op" id="4208747">|</span>&nbsp;<span class="builtintype" id="4208749">int</span><span class="op" id="4208752">(</span><span class="ident" id="4208753">data</span><span class="op" id="4208757">[</span><span class="num" id="4208758">1</span><span class="op" id="4208759">]</span><span class="op" id="4208760">)</span><span class="op" id="4208761">&lt;&lt;</span><span class="num" id="4208763">16</span>&nbsp;<span class="op" id="4208766">|</span>&nbsp;<span class="builtintype" id="4208768">int</span><span class="op" id="4208771">(</span><span class="ident" id="4208772">data</span><span class="op" id="4208776">[</span><span class="num" id="4208777">2</span><span class="op" id="4208778">]</span><span class="op" id="4208779">)</span><span class="op" id="4208780">&lt;&lt;</span><span class="num" id="4208782">8</span>&nbsp;<span class="op" id="4208784">|</span>&nbsp;<span class="builtintype" id="4208786">int</span><span class="op" id="4208789">(</span><span class="ident" id="4208790">data</span><span class="op" id="4208794">[</span><span class="num" id="4208795">3</span><span class="op" id="4208796">]</span><span class="op" id="4208797">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208801">data</span>&nbsp;<span class="op" id="4208806">=</span>&nbsp;<span class="ident" id="4208808">data</span><span class="op" id="4208812">[</span><span class="num" id="4208813">4</span><span class="op" id="4208814">:</span><span class="op" id="4208815">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208819">if</span>&nbsp;<span class="ident" id="4208822">certLen</span>&nbsp;<span class="op" id="4208830">&lt;</span>&nbsp;<span class="num" id="4208832">0</span>&nbsp;<span class="op" id="4208834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208839">return</span>&nbsp;<span class="builtintype" id="4208846">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208858">if</span>&nbsp;<span class="builtinfunc" id="4208861">len</span><span class="op" id="4208864">(</span><span class="ident" id="4208865">data</span><span class="op" id="4208869">)</span>&nbsp;<span class="op" id="4208871">&lt;</span>&nbsp;<span class="ident" id="4208873">certLen</span>&nbsp;<span class="op" id="4208881">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208886">return</span>&nbsp;<span class="builtintype" id="4208893">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208905">s</span><span class="op" id="4208906">.</span><span class="ident" id="4208907">certificates</span><span class="op" id="4208919">[</span><span class="ident" id="4208920">i</span><span class="op" id="4208921">]</span>&nbsp;<span class="op" id="4208923">=</span>&nbsp;<span class="ident" id="4208925">data</span><span class="op" id="4208929">[</span><span class="op" id="4208930">:</span><span class="ident" id="4208931">certLen</span><span class="op" id="4208938">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4208942">data</span>&nbsp;<span class="op" id="4208947">=</span>&nbsp;<span class="ident" id="4208949">data</span><span class="op" id="4208953">[</span><span class="ident" id="4208954">certLen</span><span class="op" id="4208961">:</span><span class="op" id="4208962">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4208965">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208969">if</span>&nbsp;<span class="builtinfunc" id="4208972">len</span><span class="op" id="4208975">(</span><span class="ident" id="4208976">data</span><span class="op" id="4208980">)</span>&nbsp;<span class="op" id="4208982">&gt;</span>&nbsp;<span class="num" id="4208984">0</span>&nbsp;<span class="op" id="4208986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4208990">return</span>&nbsp;<span class="builtintype" id="4208997">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209008">return</span>&nbsp;<span class="builtintype" id="4209015">true</span><br>
<span class="lineno"></span><span class="op" id="4209020">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4209023">func</span>&nbsp;<span class="op" id="4209028">(</span><span class="ident" id="4209029">c</span>&nbsp;<span class="op" id="4209031">*</span><span class="ident" id="4209032">Conn</span><span class="op" id="4209036">)</span>&nbsp;<span class="ident" id="4209038">encryptTicket</span><span class="op" id="4209051">(</span><span class="ident" id="4209052">state</span>&nbsp;<span class="op" id="4209058">*</span><span class="ident" id="4209059">sessionState</span><span class="op" id="4209071">)</span>&nbsp;<span class="op" id="4209073">(</span><span class="op" id="4209074">[</span><span class="op" id="4209075">]</span><span class="builtintype" id="4209076">byte</span><span class="op" id="4209080">,</span>&nbsp;<span class="builtintype" id="4209082">error</span><span class="op" id="4209087">)</span>&nbsp;<span class="op" id="4209089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209092">serialized</span>&nbsp;<span class="op" id="4209103">:=</span>&nbsp;<span class="ident" id="4209106">state</span><span class="op" id="4209111">.</span><span class="ident" id="4209112">marshal</span><span class="op" id="4209119">(</span><span class="op" id="4209120">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209123">encrypted</span>&nbsp;<span class="op" id="4209133">:=</span>&nbsp;<span class="builtinfunc" id="4209136">make</span><span class="op" id="4209140">(</span><span class="op" id="4209141">[</span><span class="op" id="4209142">]</span><span class="builtintype" id="4209143">byte</span><span class="op" id="4209147">,</span>&nbsp;<span class="ident" id="4209149">aes</span><span class="op" id="4209152">.</span><span class="ident" id="4209153">BlockSize</span><span class="op" id="4209162">+</span><span class="builtinfunc" id="4209163">len</span><span class="op" id="4209166">(</span><span class="ident" id="4209167">serialized</span><span class="op" id="4209177">)</span><span class="op" id="4209178">+</span><span class="ident" id="4209179">sha256</span><span class="op" id="4209185">.</span><span class="ident" id="4209186">Size</span><span class="op" id="4209190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209193">iv</span>&nbsp;<span class="op" id="4209196">:=</span>&nbsp;<span class="ident" id="4209199">encrypted</span><span class="op" id="4209208">[</span><span class="op" id="4209209">:</span><span class="ident" id="4209210">aes</span><span class="op" id="4209213">.</span><span class="ident" id="4209214">BlockSize</span><span class="op" id="4209223">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209226">macBytes</span>&nbsp;<span class="op" id="4209235">:=</span>&nbsp;<span class="ident" id="4209238">encrypted</span><span class="op" id="4209247">[</span><span class="builtinfunc" id="4209248">len</span><span class="op" id="4209251">(</span><span class="ident" id="4209252">encrypted</span><span class="op" id="4209261">)</span><span class="op" id="4209262">-</span><span class="ident" id="4209263">sha256</span><span class="op" id="4209269">.</span><span class="ident" id="4209270">Size</span><span class="op" id="4209274">:</span><span class="op" id="4209275">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209279">if</span>&nbsp;<span class="ident" id="4209282">_</span><span class="op" id="4209283">,</span>&nbsp;<span class="ident" id="4209285">err</span>&nbsp;<span class="op" id="4209289">:=</span>&nbsp;<span class="ident" id="4209292">io</span><span class="op" id="4209294">.</span><span class="ident" id="4209295">ReadFull</span><span class="op" id="4209303">(</span><span class="ident" id="4209304">c</span><span class="op" id="4209305">.</span><span class="ident" id="4209306">config</span><span class="op" id="4209312">.</span><span class="ident" id="4209313">rand</span><span class="op" id="4209317">(</span><span class="op" id="4209318">)</span><span class="op" id="4209319">,</span>&nbsp;<span class="ident" id="4209321">iv</span><span class="op" id="4209323">)</span><span class="op" id="4209324">;</span>&nbsp;<span class="ident" id="4209326">err</span>&nbsp;<span class="op" id="4209330">!=</span>&nbsp;<span class="ident" id="4209333">nil</span>&nbsp;<span class="op" id="4209337">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209341">return</span>&nbsp;<span class="ident" id="4209348">nil</span><span class="op" id="4209351">,</span>&nbsp;<span class="ident" id="4209353">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209361">block</span><span class="op" id="4209366">,</span>&nbsp;<span class="ident" id="4209368">err</span>&nbsp;<span class="op" id="4209372">:=</span>&nbsp;<span class="ident" id="4209375">aes</span><span class="op" id="4209378">.</span><span class="ident" id="4209379">NewCipher</span><span class="op" id="4209388">(</span><span class="ident" id="4209389">c</span><span class="op" id="4209390">.</span><span class="ident" id="4209391">config</span><span class="op" id="4209397">.</span><span class="ident" id="4209398">SessionTicketKey</span><span class="op" id="4209414">[</span><span class="op" id="4209415">:</span><span class="num" id="4209416">16</span><span class="op" id="4209418">]</span><span class="op" id="4209419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209422">if</span>&nbsp;<span class="ident" id="4209425">err</span>&nbsp;<span class="op" id="4209429">!=</span>&nbsp;<span class="ident" id="4209432">nil</span>&nbsp;<span class="op" id="4209436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209440">return</span>&nbsp;<span class="ident" id="4209447">nil</span><span class="op" id="4209450">,</span>&nbsp;<span class="ident" id="4209452">errors</span><span class="op" id="4209458">.</span><span class="ident" id="4209459">New</span><span class="op" id="4209462">(</span><span class="string" id="4209463">&#34;tls:&nbsp;failed&nbsp;to&nbsp;create&nbsp;cipher&nbsp;while&nbsp;encrypting&nbsp;ticket:&nbsp;&#34;</span>&nbsp;<span class="op" id="4209520">+</span>&nbsp;<span class="ident" id="4209522">err</span><span class="op" id="4209525">.</span><span class="ident" id="4209526">Error</span><span class="op" id="4209531">(</span><span class="op" id="4209532">)</span><span class="op" id="4209533">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209539">cipher</span><span class="op" id="4209545">.</span><span class="ident" id="4209546">NewCTR</span><span class="op" id="4209552">(</span><span class="ident" id="4209553">block</span><span class="op" id="4209558">,</span>&nbsp;<span class="ident" id="4209560">iv</span><span class="op" id="4209562">)</span><span class="op" id="4209563">.</span><span class="ident" id="4209564">XORKeyStream</span><span class="op" id="4209576">(</span><span class="ident" id="4209577">encrypted</span><span class="op" id="4209586">[</span><span class="ident" id="4209587">aes</span><span class="op" id="4209590">.</span><span class="ident" id="4209591">BlockSize</span><span class="op" id="4209600">:</span><span class="op" id="4209601">]</span><span class="op" id="4209602">,</span>&nbsp;<span class="ident" id="4209604">serialized</span><span class="op" id="4209614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209618">mac</span>&nbsp;<span class="op" id="4209622">:=</span>&nbsp;<span class="ident" id="4209625">hmac</span><span class="op" id="4209629">.</span><span class="ident" id="4209630">New</span><span class="op" id="4209633">(</span><span class="ident" id="4209634">sha256</span><span class="op" id="4209640">.</span><span class="ident" id="4209641">New</span><span class="op" id="4209644">,</span>&nbsp;<span class="ident" id="4209646">c</span><span class="op" id="4209647">.</span><span class="ident" id="4209648">config</span><span class="op" id="4209654">.</span><span class="ident" id="4209655">SessionTicketKey</span><span class="op" id="4209671">[</span><span class="num" id="4209672">16</span><span class="op" id="4209674">:</span><span class="num" id="4209675">32</span><span class="op" id="4209677">]</span><span class="op" id="4209678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209681">mac</span><span class="op" id="4209684">.</span><span class="ident" id="4209685">Write</span><span class="op" id="4209690">(</span><span class="ident" id="4209691">encrypted</span><span class="op" id="4209700">[</span><span class="op" id="4209701">:</span><span class="builtinfunc" id="4209702">len</span><span class="op" id="4209705">(</span><span class="ident" id="4209706">encrypted</span><span class="op" id="4209715">)</span><span class="op" id="4209716">-</span><span class="ident" id="4209717">sha256</span><span class="op" id="4209723">.</span><span class="ident" id="4209724">Size</span><span class="op" id="4209728">]</span><span class="op" id="4209729">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209732">mac</span><span class="op" id="4209735">.</span><span class="ident" id="4209736">Sum</span><span class="op" id="4209739">(</span><span class="ident" id="4209740">macBytes</span><span class="op" id="4209748">[</span><span class="op" id="4209749">:</span><span class="num" id="4209750">0</span><span class="op" id="4209751">]</span><span class="op" id="4209752">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209756">return</span>&nbsp;<span class="ident" id="4209763">encrypted</span><span class="op" id="4209772">,</span>&nbsp;<span class="ident" id="4209774">nil</span><br>
<span class="lineno"></span><span class="op" id="4209778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="4209781">func</span>&nbsp;<span class="op" id="4209786">(</span><span class="ident" id="4209787">c</span>&nbsp;<span class="op" id="4209789">*</span><span class="ident" id="4209790">Conn</span><span class="op" id="4209794">)</span>&nbsp;<span class="ident" id="4209796">decryptTicket</span><span class="op" id="4209809">(</span><span class="ident" id="4209810">encrypted</span>&nbsp;<span class="op" id="4209820">[</span><span class="op" id="4209821">]</span><span class="builtintype" id="4209822">byte</span><span class="op" id="4209826">)</span>&nbsp;<span class="op" id="4209828">(</span><span class="op" id="4209829">*</span><span class="ident" id="4209830">sessionState</span><span class="op" id="4209842">,</span>&nbsp;<span class="builtintype" id="4209844">bool</span><span class="op" id="4209848">)</span>&nbsp;<span class="op" id="4209850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209853">if</span>&nbsp;<span class="ident" id="4209856">c</span><span class="op" id="4209857">.</span><span class="ident" id="4209858">config</span><span class="op" id="4209864">.</span><span class="ident" id="4209865">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4209888">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4209893">len</span><span class="op" id="4209896">(</span><span class="ident" id="4209897">encrypted</span><span class="op" id="4209906">)</span>&nbsp;<span class="op" id="4209908">&lt;</span>&nbsp;<span class="ident" id="4209910">aes</span><span class="op" id="4209913">.</span><span class="ident" id="4209914">BlockSize</span><span class="op" id="4209923">+</span><span class="ident" id="4209924">sha256</span><span class="op" id="4209930">.</span><span class="ident" id="4209931">Size</span>&nbsp;<span class="op" id="4209936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4209940">return</span>&nbsp;<span class="ident" id="4209947">nil</span><span class="op" id="4209950">,</span>&nbsp;<span class="builtintype" id="4209952">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4209959">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209963">iv</span>&nbsp;<span class="op" id="4209966">:=</span>&nbsp;<span class="ident" id="4209969">encrypted</span><span class="op" id="4209978">[</span><span class="op" id="4209979">:</span><span class="ident" id="4209980">aes</span><span class="op" id="4209983">.</span><span class="ident" id="4209984">BlockSize</span><span class="op" id="4209993">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4209996">macBytes</span>&nbsp;<span class="op" id="4210005">:=</span>&nbsp;<span class="ident" id="4210008">encrypted</span><span class="op" id="4210017">[</span><span class="builtinfunc" id="4210018">len</span><span class="op" id="4210021">(</span><span class="ident" id="4210022">encrypted</span><span class="op" id="4210031">)</span><span class="op" id="4210032">-</span><span class="ident" id="4210033">sha256</span><span class="op" id="4210039">.</span><span class="ident" id="4210040">Size</span><span class="op" id="4210044">:</span><span class="op" id="4210045">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210049">mac</span>&nbsp;<span class="op" id="4210053">:=</span>&nbsp;<span class="ident" id="4210056">hmac</span><span class="op" id="4210060">.</span><span class="ident" id="4210061">New</span><span class="op" id="4210064">(</span><span class="ident" id="4210065">sha256</span><span class="op" id="4210071">.</span><span class="ident" id="4210072">New</span><span class="op" id="4210075">,</span>&nbsp;<span class="ident" id="4210077">c</span><span class="op" id="4210078">.</span><span class="ident" id="4210079">config</span><span class="op" id="4210085">.</span><span class="ident" id="4210086">SessionTicketKey</span><span class="op" id="4210102">[</span><span class="num" id="4210103">16</span><span class="op" id="4210105">:</span><span class="num" id="4210106">32</span><span class="op" id="4210108">]</span><span class="op" id="4210109">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210112">mac</span><span class="op" id="4210115">.</span><span class="ident" id="4210116">Write</span><span class="op" id="4210121">(</span><span class="ident" id="4210122">encrypted</span><span class="op" id="4210131">[</span><span class="op" id="4210132">:</span><span class="builtinfunc" id="4210133">len</span><span class="op" id="4210136">(</span><span class="ident" id="4210137">encrypted</span><span class="op" id="4210146">)</span><span class="op" id="4210147">-</span><span class="ident" id="4210148">sha256</span><span class="op" id="4210154">.</span><span class="ident" id="4210155">Size</span><span class="op" id="4210159">]</span><span class="op" id="4210160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210163">expected</span>&nbsp;<span class="op" id="4210172">:=</span>&nbsp;<span class="ident" id="4210175">mac</span><span class="op" id="4210178">.</span><span class="ident" id="4210179">Sum</span><span class="op" id="4210182">(</span><span class="ident" id="4210183">nil</span><span class="op" id="4210186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210190">if</span>&nbsp;<span class="ident" id="4210193">subtle</span><span class="op" id="4210199">.</span><span class="ident" id="4210200">ConstantTimeCompare</span><span class="op" id="4210219">(</span><span class="ident" id="4210220">macBytes</span><span class="op" id="4210228">,</span>&nbsp;<span class="ident" id="4210230">expected</span><span class="op" id="4210238">)</span>&nbsp;<span class="op" id="4210240">!=</span>&nbsp;<span class="num" id="4210243">1</span>&nbsp;<span class="op" id="4210245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210249">return</span>&nbsp;<span class="ident" id="4210256">nil</span><span class="op" id="4210259">,</span>&nbsp;<span class="builtintype" id="4210261">false</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210272">block</span><span class="op" id="4210277">,</span>&nbsp;<span class="ident" id="4210279">err</span>&nbsp;<span class="op" id="4210283">:=</span>&nbsp;<span class="ident" id="4210286">aes</span><span class="op" id="4210289">.</span><span class="ident" id="4210290">NewCipher</span><span class="op" id="4210299">(</span><span class="ident" id="4210300">c</span><span class="op" id="4210301">.</span><span class="ident" id="4210302">config</span><span class="op" id="4210308">.</span><span class="ident" id="4210309">SessionTicketKey</span><span class="op" id="4210325">[</span><span class="op" id="4210326">:</span><span class="num" id="4210327">16</span><span class="op" id="4210329">]</span><span class="op" id="4210330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210333">if</span>&nbsp;<span class="ident" id="4210336">err</span>&nbsp;<span class="op" id="4210340">!=</span>&nbsp;<span class="ident" id="4210343">nil</span>&nbsp;<span class="op" id="4210347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210351">return</span>&nbsp;<span class="ident" id="4210358">nil</span><span class="op" id="4210361">,</span>&nbsp;<span class="builtintype" id="4210363">false</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4210370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210373">ciphertext</span>&nbsp;<span class="op" id="4210384">:=</span>&nbsp;<span class="ident" id="4210387">encrypted</span><span class="op" id="4210396">[</span><span class="ident" id="4210397">aes</span><span class="op" id="4210400">.</span><span class="ident" id="4210401">BlockSize</span>&nbsp;<span class="op" id="4210411">:</span>&nbsp;<span class="builtinfunc" id="4210413">len</span><span class="op" id="4210416">(</span><span class="ident" id="4210417">encrypted</span><span class="op" id="4210426">)</span><span class="op" id="4210427">-</span><span class="ident" id="4210428">sha256</span><span class="op" id="4210434">.</span><span class="ident" id="4210435">Size</span><span class="op" id="4210439">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210442">plaintext</span>&nbsp;<span class="op" id="4210452">:=</span>&nbsp;<span class="ident" id="4210455">ciphertext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210467">cipher</span><span class="op" id="4210473">.</span><span class="ident" id="4210474">NewCTR</span><span class="op" id="4210480">(</span><span class="ident" id="4210481">block</span><span class="op" id="4210486">,</span>&nbsp;<span class="ident" id="4210488">iv</span><span class="op" id="4210490">)</span><span class="op" id="4210491">.</span><span class="ident" id="4210492">XORKeyStream</span><span class="op" id="4210504">(</span><span class="ident" id="4210505">plaintext</span><span class="op" id="4210514">,</span>&nbsp;<span class="ident" id="4210516">ciphertext</span><span class="op" id="4210526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210530">state</span>&nbsp;<span class="op" id="4210536">:=</span>&nbsp;<span class="builtinfunc" id="4210539">new</span><span class="op" id="4210542">(</span><span class="ident" id="4210543">sessionState</span><span class="op" id="4210555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4210558">ok</span>&nbsp;<span class="op" id="4210561">:=</span>&nbsp;<span class="ident" id="4210564">state</span><span class="op" id="4210569">.</span><span class="ident" id="4210570">unmarshal</span><span class="op" id="4210579">(</span><span class="ident" id="4210580">plaintext</span><span class="op" id="4210589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4210592">return</span>&nbsp;<span class="ident" id="4210599">state</span><span class="op" id="4210604">,</span>&nbsp;<span class="ident" id="4210606">ok</span><br>
<span class="lineno"></span><span class="op" id="4210609">}</span>
</div>
</body>
</html>
