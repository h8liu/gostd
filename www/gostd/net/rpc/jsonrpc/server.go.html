<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5129865">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5129921">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5129975">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5130026">package</span>&nbsp;<span class="ident" id="5130034">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5130043">import</span>&nbsp;<span class="op" id="5130050">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130053">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130070">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130080">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130086">&#34;net/rpc&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5130097">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5130104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="5130107">var</span>&nbsp;<span class="ident" id="5130111">errMissingParams</span>&nbsp;<span class="op" id="5130128">=</span>&nbsp;<span class="ident" id="5130130">errors</span><span class="op" id="5130136">.</span><span class="ident" id="5130137">New</span><span class="op" id="5130140">(</span><span class="string" id="5130141">&#34;jsonrpc:&nbsp;request&nbsp;body&nbsp;missing&nbsp;params&#34;</span><span class="op" id="5130179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5130182">type</span>&nbsp;<span class="ident" id="5130187">serverCodec</span>&nbsp;<span class="keyword" id="5130199">struct</span>&nbsp;<span class="op" id="5130206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130209">dec</span>&nbsp;<span class="op" id="5130213">*</span><span class="ident" id="5130214">json</span><span class="op" id="5130218">.</span><span class="ident" id="5130219">Decoder</span>&nbsp;<span class="comment" id="5130227">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130255">enc</span>&nbsp;<span class="op" id="5130259">*</span><span class="ident" id="5130260">json</span><span class="op" id="5130264">.</span><span class="ident" id="5130265">Encoder</span>&nbsp;<span class="comment" id="5130273">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130301">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5130305">io</span><span class="op" id="5130307">.</span><span class="ident" id="5130308">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130317">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130342">req</span>&nbsp;<span class="ident" id="5130346">serverRequest</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130362">//&nbsp;JSON-RPC&nbsp;clients&nbsp;can&nbsp;use&nbsp;arbitrary&nbsp;json&nbsp;values&nbsp;as&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130429">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;uint64&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130473">//&nbsp;We&nbsp;assign&nbsp;uint64&nbsp;sequence&nbsp;numbers&nbsp;to&nbsp;incoming&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130532">//&nbsp;but&nbsp;save&nbsp;the&nbsp;original&nbsp;request&nbsp;ID&nbsp;in&nbsp;the&nbsp;pending&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130589">//&nbsp;When&nbsp;rpc&nbsp;responds,&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number&nbsp;in</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5130642">//&nbsp;the&nbsp;response&nbsp;to&nbsp;find&nbsp;the&nbsp;original&nbsp;request&nbsp;ID.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130692">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5130700">sync</span><span class="op" id="5130704">.</span><span class="ident" id="5130705">Mutex</span>&nbsp;<span class="comment" id="5130711">//&nbsp;protects&nbsp;seq,&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130737">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5130745">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130753">pending</span>&nbsp;<span class="keyword" id="5130761">map</span><span class="op" id="5130764">[</span><span class="ident" id="5130765">uint64</span><span class="op" id="5130771">]</span><span class="op" id="5130772">*</span><span class="ident" id="5130773">json</span><span class="op" id="5130777">.</span><span class="ident" id="5130778">RawMessage</span><br>
<span class="lineno"></span><span class="op" id="5130789">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="5130792">//&nbsp;NewServerCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ServerCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5130864">func</span>&nbsp;<span class="ident" id="5130869">NewServerCodec</span><span class="op" id="5130883">(</span><span class="ident" id="5130884">conn</span>&nbsp;<span class="ident" id="5130889">io</span><span class="op" id="5130891">.</span><span class="ident" id="5130892">ReadWriteCloser</span><span class="op" id="5130907">)</span>&nbsp;<span class="ident" id="5130909">rpc</span><span class="op" id="5130912">.</span><span class="ident" id="5130913">ServerCodec</span>&nbsp;<span class="op" id="5130925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5130928">return</span>&nbsp;<span class="op" id="5130935">&amp;</span><span class="ident" id="5130936">serverCodec</span><span class="op" id="5130947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130951">dec</span><span class="op" id="5130954">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5130960">json</span><span class="op" id="5130964">.</span><span class="ident" id="5130965">NewDecoder</span><span class="op" id="5130975">(</span><span class="ident" id="5130976">conn</span><span class="op" id="5130980">)</span><span class="op" id="5130981">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5130985">enc</span><span class="op" id="5130988">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5130994">json</span><span class="op" id="5130998">.</span><span class="ident" id="5130999">NewEncoder</span><span class="op" id="5131009">(</span><span class="ident" id="5131010">conn</span><span class="op" id="5131014">)</span><span class="op" id="5131015">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131019">c</span><span class="op" id="5131020">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5131028">conn</span><span class="op" id="5131032">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131036">pending</span><span class="op" id="5131043">:</span>&nbsp;<span class="builtinfunc" id="5131045">make</span><span class="op" id="5131049">(</span><span class="keyword" id="5131050">map</span><span class="op" id="5131053">[</span><span class="ident" id="5131054">uint64</span><span class="op" id="5131060">]</span><span class="op" id="5131061">*</span><span class="ident" id="5131062">json</span><span class="op" id="5131066">.</span><span class="ident" id="5131067">RawMessage</span><span class="op" id="5131077">)</span><span class="op" id="5131078">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131081">}</span><br>
<span class="lineno"></span><span class="op" id="5131083">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="5131086">type</span>&nbsp;<span class="ident" id="5131091">serverRequest</span>&nbsp;<span class="keyword" id="5131105">struct</span>&nbsp;<span class="op" id="5131112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131115">Method</span>&nbsp;<span class="builtintype" id="5131122">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5131139">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131156">Params</span>&nbsp;<span class="op" id="5131163">*</span><span class="ident" id="5131164">json</span><span class="op" id="5131168">.</span><span class="ident" id="5131169">RawMessage</span>&nbsp;<span class="string" id="5131180">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131197">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5131204">*</span><span class="ident" id="5131205">json</span><span class="op" id="5131209">.</span><span class="ident" id="5131210">RawMessage</span>&nbsp;<span class="string" id="5131221">`json:&#34;id&#34;`</span><br>
<span class="lineno">50</span><span class="op" id="5131233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5131236">func</span>&nbsp;<span class="op" id="5131241">(</span><span class="ident" id="5131242">r</span>&nbsp;<span class="op" id="5131244">*</span><span class="ident" id="5131245">serverRequest</span><span class="op" id="5131258">)</span>&nbsp;<span class="ident" id="5131260">reset</span><span class="op" id="5131265">(</span><span class="op" id="5131266">)</span>&nbsp;<span class="op" id="5131268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131271">r</span><span class="op" id="5131272">.</span><span class="ident" id="5131273">Method</span>&nbsp;<span class="op" id="5131280">=</span>&nbsp;<span class="string" id="5131282">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131286">r</span><span class="op" id="5131287">.</span><span class="ident" id="5131288">Params</span>&nbsp;<span class="op" id="5131295">=</span>&nbsp;<span class="ident" id="5131297">nil</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131302">r</span><span class="op" id="5131303">.</span><span class="ident" id="5131304">Id</span>&nbsp;<span class="op" id="5131307">=</span>&nbsp;<span class="ident" id="5131309">nil</span><br>
<span class="lineno"></span><span class="op" id="5131313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5131316">type</span>&nbsp;<span class="ident" id="5131321">serverResponse</span>&nbsp;<span class="keyword" id="5131336">struct</span>&nbsp;<span class="op" id="5131343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131346">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5131353">*</span><span class="ident" id="5131354">json</span><span class="op" id="5131358">.</span><span class="ident" id="5131359">RawMessage</span>&nbsp;<span class="string" id="5131370">`json:&#34;id&#34;`</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131383">Result</span>&nbsp;<span class="keyword" id="5131390">interface</span><span class="op" id="5131399">{</span><span class="op" id="5131400">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5131407">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131424">Error</span>&nbsp;&nbsp;<span class="keyword" id="5131431">interface</span><span class="op" id="5131440">{</span><span class="op" id="5131441">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5131448">`json:&#34;error&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5131463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5131466">func</span>&nbsp;<span class="op" id="5131471">(</span><span class="ident" id="5131472">c</span>&nbsp;<span class="op" id="5131474">*</span><span class="ident" id="5131475">serverCodec</span><span class="op" id="5131486">)</span>&nbsp;<span class="ident" id="5131488">ReadRequestHeader</span><span class="op" id="5131505">(</span><span class="ident" id="5131506">r</span>&nbsp;<span class="op" id="5131508">*</span><span class="ident" id="5131509">rpc</span><span class="op" id="5131512">.</span><span class="ident" id="5131513">Request</span><span class="op" id="5131520">)</span>&nbsp;<span class="builtintype" id="5131522">error</span>&nbsp;<span class="op" id="5131528">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131531">c</span><span class="op" id="5131532">.</span><span class="ident" id="5131533">req</span><span class="op" id="5131536">.</span><span class="ident" id="5131537">reset</span><span class="op" id="5131542">(</span><span class="op" id="5131543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131546">if</span>&nbsp;<span class="ident" id="5131549">err</span>&nbsp;<span class="op" id="5131553">:=</span>&nbsp;<span class="ident" id="5131556">c</span><span class="op" id="5131557">.</span><span class="ident" id="5131558">dec</span><span class="op" id="5131561">.</span><span class="ident" id="5131562">Decode</span><span class="op" id="5131568">(</span><span class="op" id="5131569">&amp;</span><span class="ident" id="5131570">c</span><span class="op" id="5131571">.</span><span class="ident" id="5131572">req</span><span class="op" id="5131575">)</span><span class="op" id="5131576">;</span>&nbsp;<span class="ident" id="5131578">err</span>&nbsp;<span class="op" id="5131582">!=</span>&nbsp;<span class="ident" id="5131585">nil</span>&nbsp;<span class="op" id="5131589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131593">return</span>&nbsp;<span class="ident" id="5131600">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131608">r</span><span class="op" id="5131609">.</span><span class="ident" id="5131610">ServiceMethod</span>&nbsp;<span class="op" id="5131624">=</span>&nbsp;<span class="ident" id="5131626">c</span><span class="op" id="5131627">.</span><span class="ident" id="5131628">req</span><span class="op" id="5131631">.</span><span class="ident" id="5131632">Method</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5131641">//&nbsp;JSON&nbsp;request&nbsp;id&nbsp;can&nbsp;be&nbsp;any&nbsp;JSON&nbsp;value;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5131684">//&nbsp;RPC&nbsp;package&nbsp;expects&nbsp;uint64.&nbsp;&nbsp;Translate&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5131730">//&nbsp;internal&nbsp;uint64&nbsp;and&nbsp;save&nbsp;JSON&nbsp;on&nbsp;the&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131777">c</span><span class="op" id="5131778">.</span><span class="ident" id="5131779">mutex</span><span class="op" id="5131784">.</span><span class="ident" id="5131785">Lock</span><span class="op" id="5131789">(</span><span class="op" id="5131790">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131793">c</span><span class="op" id="5131794">.</span><span class="ident" id="5131795">seq</span><span class="op" id="5131798">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131802">c</span><span class="op" id="5131803">.</span><span class="ident" id="5131804">pending</span><span class="op" id="5131811">[</span><span class="ident" id="5131812">c</span><span class="op" id="5131813">.</span><span class="ident" id="5131814">seq</span><span class="op" id="5131817">]</span>&nbsp;<span class="op" id="5131819">=</span>&nbsp;<span class="ident" id="5131821">c</span><span class="op" id="5131822">.</span><span class="ident" id="5131823">req</span><span class="op" id="5131826">.</span><span class="ident" id="5131827">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131831">c</span><span class="op" id="5131832">.</span><span class="ident" id="5131833">req</span><span class="op" id="5131836">.</span><span class="ident" id="5131837">Id</span>&nbsp;<span class="op" id="5131840">=</span>&nbsp;<span class="ident" id="5131842">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131847">r</span><span class="op" id="5131848">.</span><span class="ident" id="5131849">Seq</span>&nbsp;<span class="op" id="5131853">=</span>&nbsp;<span class="ident" id="5131855">c</span><span class="op" id="5131856">.</span><span class="ident" id="5131857">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5131862">c</span><span class="op" id="5131863">.</span><span class="ident" id="5131864">mutex</span><span class="op" id="5131869">.</span><span class="ident" id="5131870">Unlock</span><span class="op" id="5131876">(</span><span class="op" id="5131877">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131881">return</span>&nbsp;<span class="ident" id="5131888">nil</span><br>
<span class="lineno"></span><span class="op" id="5131892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5131895">func</span>&nbsp;<span class="op" id="5131900">(</span><span class="ident" id="5131901">c</span>&nbsp;<span class="op" id="5131903">*</span><span class="ident" id="5131904">serverCodec</span><span class="op" id="5131915">)</span>&nbsp;<span class="ident" id="5131917">ReadRequestBody</span><span class="op" id="5131932">(</span><span class="ident" id="5131933">x</span>&nbsp;<span class="keyword" id="5131935">interface</span><span class="op" id="5131944">{</span><span class="op" id="5131945">}</span><span class="op" id="5131946">)</span>&nbsp;<span class="builtintype" id="5131948">error</span>&nbsp;<span class="op" id="5131954">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131957">if</span>&nbsp;<span class="ident" id="5131960">x</span>&nbsp;<span class="op" id="5131962">==</span>&nbsp;<span class="ident" id="5131965">nil</span>&nbsp;<span class="op" id="5131969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131973">return</span>&nbsp;<span class="ident" id="5131980">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5131985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5131988">if</span>&nbsp;<span class="ident" id="5131991">c</span><span class="op" id="5131992">.</span><span class="ident" id="5131993">req</span><span class="op" id="5131996">.</span><span class="ident" id="5131997">Params</span>&nbsp;<span class="op" id="5132004">==</span>&nbsp;<span class="ident" id="5132007">nil</span>&nbsp;<span class="op" id="5132011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132015">return</span>&nbsp;<span class="ident" id="5132022">errMissingParams</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132040">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132043">//&nbsp;JSON&nbsp;params&nbsp;is&nbsp;array&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132075">//&nbsp;RPC&nbsp;params&nbsp;is&nbsp;struct.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132101">//&nbsp;Unmarshal&nbsp;into&nbsp;array&nbsp;containing&nbsp;struct&nbsp;for&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132153">//&nbsp;Should&nbsp;think&nbsp;about&nbsp;making&nbsp;RPC&nbsp;more&nbsp;general.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132201">var</span>&nbsp;<span class="ident" id="5132205">params</span>&nbsp;<span class="op" id="5132212">[</span><span class="num" id="5132213">1</span><span class="op" id="5132214">]</span><span class="keyword" id="5132215">interface</span><span class="op" id="5132224">{</span><span class="op" id="5132225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132228">params</span><span class="op" id="5132234">[</span><span class="num" id="5132235">0</span><span class="op" id="5132236">]</span>&nbsp;<span class="op" id="5132238">=</span>&nbsp;<span class="ident" id="5132240">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132243">return</span>&nbsp;<span class="ident" id="5132250">json</span><span class="op" id="5132254">.</span><span class="ident" id="5132255">Unmarshal</span><span class="op" id="5132264">(</span><span class="op" id="5132265">*</span><span class="ident" id="5132266">c</span><span class="op" id="5132267">.</span><span class="ident" id="5132268">req</span><span class="op" id="5132271">.</span><span class="ident" id="5132272">Params</span><span class="op" id="5132278">,</span>&nbsp;<span class="op" id="5132280">&amp;</span><span class="ident" id="5132281">params</span><span class="op" id="5132287">)</span><br>
<span class="lineno"></span><span class="op" id="5132289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5132292">var</span>&nbsp;<span class="ident" id="5132296">null</span>&nbsp;<span class="op" id="5132301">=</span>&nbsp;<span class="ident" id="5132303">json</span><span class="op" id="5132307">.</span><span class="ident" id="5132308">RawMessage</span><span class="op" id="5132318">(</span><span class="op" id="5132319">[</span><span class="op" id="5132320">]</span><span class="builtintype" id="5132321">byte</span><span class="op" id="5132325">(</span><span class="string" id="5132326">&#34;null&#34;</span><span class="op" id="5132332">)</span><span class="op" id="5132333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5132336">func</span>&nbsp;<span class="op" id="5132341">(</span><span class="ident" id="5132342">c</span>&nbsp;<span class="op" id="5132344">*</span><span class="ident" id="5132345">serverCodec</span><span class="op" id="5132356">)</span>&nbsp;<span class="ident" id="5132358">WriteResponse</span><span class="op" id="5132371">(</span><span class="ident" id="5132372">r</span>&nbsp;<span class="op" id="5132374">*</span><span class="ident" id="5132375">rpc</span><span class="op" id="5132378">.</span><span class="ident" id="5132379">Response</span><span class="op" id="5132387">,</span>&nbsp;<span class="ident" id="5132389">x</span>&nbsp;<span class="keyword" id="5132391">interface</span><span class="op" id="5132400">{</span><span class="op" id="5132401">}</span><span class="op" id="5132402">)</span>&nbsp;<span class="builtintype" id="5132404">error</span>&nbsp;<span class="op" id="5132410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132413">c</span><span class="op" id="5132414">.</span><span class="ident" id="5132415">mutex</span><span class="op" id="5132420">.</span><span class="ident" id="5132421">Lock</span><span class="op" id="5132425">(</span><span class="op" id="5132426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132429">b</span><span class="op" id="5132430">,</span>&nbsp;<span class="ident" id="5132432">ok</span>&nbsp;<span class="op" id="5132435">:=</span>&nbsp;<span class="ident" id="5132438">c</span><span class="op" id="5132439">.</span><span class="ident" id="5132440">pending</span><span class="op" id="5132447">[</span><span class="ident" id="5132448">r</span><span class="op" id="5132449">.</span><span class="ident" id="5132450">Seq</span><span class="op" id="5132453">]</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132456">if</span>&nbsp;<span class="op" id="5132459">!</span><span class="ident" id="5132460">ok</span>&nbsp;<span class="op" id="5132463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132467">c</span><span class="op" id="5132468">.</span><span class="ident" id="5132469">mutex</span><span class="op" id="5132474">.</span><span class="ident" id="5132475">Unlock</span><span class="op" id="5132481">(</span><span class="op" id="5132482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132486">return</span>&nbsp;<span class="ident" id="5132493">errors</span><span class="op" id="5132499">.</span><span class="ident" id="5132500">New</span><span class="op" id="5132503">(</span><span class="string" id="5132504">&#34;invalid&nbsp;sequence&nbsp;number&nbsp;in&nbsp;response&#34;</span><span class="op" id="5132541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132544">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5132547">delete</span><span class="op" id="5132553">(</span><span class="ident" id="5132554">c</span><span class="op" id="5132555">.</span><span class="ident" id="5132556">pending</span><span class="op" id="5132563">,</span>&nbsp;<span class="ident" id="5132565">r</span><span class="op" id="5132566">.</span><span class="ident" id="5132567">Seq</span><span class="op" id="5132570">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132573">c</span><span class="op" id="5132574">.</span><span class="ident" id="5132575">mutex</span><span class="op" id="5132580">.</span><span class="ident" id="5132581">Unlock</span><span class="op" id="5132587">(</span><span class="op" id="5132588">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132592">if</span>&nbsp;<span class="ident" id="5132595">b</span>&nbsp;<span class="op" id="5132597">==</span>&nbsp;<span class="ident" id="5132600">nil</span>&nbsp;<span class="op" id="5132604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5132608">//&nbsp;Invalid&nbsp;request&nbsp;so&nbsp;no&nbsp;id.&nbsp;&nbsp;Use&nbsp;JSON&nbsp;null.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132655">b</span>&nbsp;<span class="op" id="5132657">=</span>&nbsp;<span class="op" id="5132659">&amp;</span><span class="ident" id="5132660">null</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132669">resp</span>&nbsp;<span class="op" id="5132674">:=</span>&nbsp;<span class="ident" id="5132677">serverResponse</span><span class="op" id="5132691">{</span><span class="ident" id="5132692">Id</span><span class="op" id="5132694">:</span>&nbsp;<span class="ident" id="5132696">b</span><span class="op" id="5132697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132700">if</span>&nbsp;<span class="ident" id="5132703">r</span><span class="op" id="5132704">.</span><span class="ident" id="5132705">Error</span>&nbsp;<span class="op" id="5132711">==</span>&nbsp;<span class="string" id="5132714">&#34;&#34;</span>&nbsp;<span class="op" id="5132717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132721">resp</span><span class="op" id="5132725">.</span><span class="ident" id="5132726">Result</span>&nbsp;<span class="op" id="5132733">=</span>&nbsp;<span class="ident" id="5132735">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132738">}</span>&nbsp;<span class="keyword" id="5132740">else</span>&nbsp;<span class="op" id="5132745">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5132749">resp</span><span class="op" id="5132753">.</span><span class="ident" id="5132754">Error</span>&nbsp;<span class="op" id="5132760">=</span>&nbsp;<span class="ident" id="5132762">r</span><span class="op" id="5132763">.</span><span class="ident" id="5132764">Error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5132771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132774">return</span>&nbsp;<span class="ident" id="5132781">c</span><span class="op" id="5132782">.</span><span class="ident" id="5132783">enc</span><span class="op" id="5132786">.</span><span class="ident" id="5132787">Encode</span><span class="op" id="5132793">(</span><span class="ident" id="5132794">resp</span><span class="op" id="5132798">)</span><br>
<span class="lineno"></span><span class="op" id="5132800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="keyword" id="5132803">func</span>&nbsp;<span class="op" id="5132808">(</span><span class="ident" id="5132809">c</span>&nbsp;<span class="op" id="5132811">*</span><span class="ident" id="5132812">serverCodec</span><span class="op" id="5132823">)</span>&nbsp;<span class="ident" id="5132825">Close</span><span class="op" id="5132830">(</span><span class="op" id="5132831">)</span>&nbsp;<span class="builtintype" id="5132833">error</span>&nbsp;<span class="op" id="5132839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5132842">return</span>&nbsp;<span class="ident" id="5132849">c</span><span class="op" id="5132850">.</span><span class="ident" id="5132851">c</span><span class="op" id="5132852">.</span><span class="ident" id="5132853">Close</span><span class="op" id="5132858">(</span><span class="op" id="5132859">)</span><br>
<span class="lineno"></span><span class="op" id="5132861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5132864">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;JSON-RPC&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno">130</span><span class="comment" id="5132926">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5132997">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5133058">func</span>&nbsp;<span class="ident" id="5133063">ServeConn</span><span class="op" id="5133072">(</span><span class="ident" id="5133073">conn</span>&nbsp;<span class="ident" id="5133078">io</span><span class="op" id="5133080">.</span><span class="ident" id="5133081">ReadWriteCloser</span><span class="op" id="5133096">)</span>&nbsp;<span class="op" id="5133098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5133101">rpc</span><span class="op" id="5133104">.</span><span class="ident" id="5133105">ServeCodec</span><span class="op" id="5133115">(</span><span class="ident" id="5133116">NewServerCodec</span><span class="op" id="5133130">(</span><span class="ident" id="5133131">conn</span><span class="op" id="5133135">)</span><span class="op" id="5133136">)</span><br>
<span class="lineno"></span><span class="op" id="5133138">}</span>
</div>
</body>
</html>
