<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html" class="current">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6391628">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6391683">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6391737">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6391788">package</span>&nbsp;<span class="ident" id="6391796">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6391802">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6391876">import</span>&nbsp;<span class="op" id="6391883">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391886">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391896">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391903">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391909">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391922">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391929">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391941">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391957">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391963">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391974">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6391982">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6391989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6391992">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6392073">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6392111">type</span>&nbsp;<span class="ident" id="6392116">request</span>&nbsp;<span class="keyword" id="6392124">struct</span>&nbsp;<span class="op" id="6392131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392134">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392144">*</span><span class="ident" id="6392145">io</span><span class="op" id="6392147">.</span><span class="ident" id="6392148">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392160">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6392170">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392178">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392188">map</span><span class="op" id="6392191">[</span><span class="builtintype" id="6392192">string</span><span class="op" id="6392198">]</span><span class="builtintype" id="6392199">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392207">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392217">[</span><span class="num" id="6392218">1024</span><span class="op" id="6392222">]</span><span class="builtintype" id="6392223">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392229">rawParams</span>&nbsp;<span class="op" id="6392239">[</span><span class="op" id="6392240">]</span><span class="builtintype" id="6392241">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392247">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6392257">bool</span><br>
<span class="lineno"></span><span class="op" id="6392262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6392265">func</span>&nbsp;<span class="ident" id="6392270">newRequest</span><span class="op" id="6392280">(</span><span class="ident" id="6392281">reqId</span>&nbsp;<span class="builtintype" id="6392287">uint16</span><span class="op" id="6392293">,</span>&nbsp;<span class="ident" id="6392295">flags</span>&nbsp;<span class="builtintype" id="6392301">uint8</span><span class="op" id="6392306">)</span>&nbsp;<span class="op" id="6392308">*</span><span class="ident" id="6392309">request</span>&nbsp;<span class="op" id="6392317">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392320">r</span>&nbsp;<span class="op" id="6392322">:=</span>&nbsp;<span class="op" id="6392325">&amp;</span><span class="ident" id="6392326">request</span><span class="op" id="6392333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392337">reqId</span><span class="op" id="6392342">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392347">reqId</span><span class="op" id="6392352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392356">params</span><span class="op" id="6392362">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392366">map</span><span class="op" id="6392369">[</span><span class="builtintype" id="6392370">string</span><span class="op" id="6392376">]</span><span class="builtintype" id="6392377">string</span><span class="op" id="6392383">{</span><span class="op" id="6392384">}</span><span class="op" id="6392385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392389">keepConn</span><span class="op" id="6392397">:</span>&nbsp;<span class="ident" id="6392399">flags</span><span class="op" id="6392404">&amp;</span><span class="ident" id="6392405">flagKeepConn</span>&nbsp;<span class="op" id="6392418">!=</span>&nbsp;<span class="num" id="6392421">0</span><span class="op" id="6392422">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392425">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392428">r</span><span class="op" id="6392429">.</span><span class="ident" id="6392430">rawParams</span>&nbsp;<span class="op" id="6392440">=</span>&nbsp;<span class="ident" id="6392442">r</span><span class="op" id="6392443">.</span><span class="ident" id="6392444">buf</span><span class="op" id="6392447">[</span><span class="op" id="6392448">:</span><span class="num" id="6392449">0</span><span class="op" id="6392450">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392453">return</span>&nbsp;<span class="ident" id="6392460">r</span><br>
<span class="lineno"></span><span class="op" id="6392462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6392465">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6392517">func</span>&nbsp;<span class="op" id="6392522">(</span><span class="ident" id="6392523">r</span>&nbsp;<span class="op" id="6392525">*</span><span class="ident" id="6392526">request</span><span class="op" id="6392533">)</span>&nbsp;<span class="ident" id="6392535">parseParams</span><span class="op" id="6392546">(</span><span class="op" id="6392547">)</span>&nbsp;<span class="op" id="6392549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392552">text</span>&nbsp;<span class="op" id="6392557">:=</span>&nbsp;<span class="ident" id="6392560">r</span><span class="op" id="6392561">.</span><span class="ident" id="6392562">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392573">r</span><span class="op" id="6392574">.</span><span class="ident" id="6392575">rawParams</span>&nbsp;<span class="op" id="6392585">=</span>&nbsp;<span class="ident" id="6392587">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392592">for</span>&nbsp;<span class="builtinfunc" id="6392596">len</span><span class="op" id="6392599">(</span><span class="ident" id="6392600">text</span><span class="op" id="6392604">)</span>&nbsp;<span class="op" id="6392606">&gt;</span>&nbsp;<span class="num" id="6392608">0</span>&nbsp;<span class="op" id="6392610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392614">keyLen</span><span class="op" id="6392620">,</span>&nbsp;<span class="ident" id="6392622">n</span>&nbsp;<span class="op" id="6392624">:=</span>&nbsp;<span class="ident" id="6392627">readSize</span><span class="op" id="6392635">(</span><span class="ident" id="6392636">text</span><span class="op" id="6392640">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392644">if</span>&nbsp;<span class="ident" id="6392647">n</span>&nbsp;<span class="op" id="6392649">==</span>&nbsp;<span class="num" id="6392652">0</span>&nbsp;<span class="op" id="6392654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392659">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392672">text</span>&nbsp;<span class="op" id="6392677">=</span>&nbsp;<span class="ident" id="6392679">text</span><span class="op" id="6392683">[</span><span class="ident" id="6392684">n</span><span class="op" id="6392685">:</span><span class="op" id="6392686">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392690">valLen</span><span class="op" id="6392696">,</span>&nbsp;<span class="ident" id="6392698">n</span>&nbsp;<span class="op" id="6392700">:=</span>&nbsp;<span class="ident" id="6392703">readSize</span><span class="op" id="6392711">(</span><span class="ident" id="6392712">text</span><span class="op" id="6392716">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392720">if</span>&nbsp;<span class="ident" id="6392723">n</span>&nbsp;<span class="op" id="6392725">==</span>&nbsp;<span class="num" id="6392728">0</span>&nbsp;<span class="op" id="6392730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6392735">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392748">text</span>&nbsp;<span class="op" id="6392753">=</span>&nbsp;<span class="ident" id="6392755">text</span><span class="op" id="6392759">[</span><span class="ident" id="6392760">n</span><span class="op" id="6392761">:</span><span class="op" id="6392762">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392766">key</span>&nbsp;<span class="op" id="6392770">:=</span>&nbsp;<span class="ident" id="6392773">readString</span><span class="op" id="6392783">(</span><span class="ident" id="6392784">text</span><span class="op" id="6392788">,</span>&nbsp;<span class="ident" id="6392790">keyLen</span><span class="op" id="6392796">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392800">text</span>&nbsp;<span class="op" id="6392805">=</span>&nbsp;<span class="ident" id="6392807">text</span><span class="op" id="6392811">[</span><span class="ident" id="6392812">keyLen</span><span class="op" id="6392818">:</span><span class="op" id="6392819">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392823">val</span>&nbsp;<span class="op" id="6392827">:=</span>&nbsp;<span class="ident" id="6392830">readString</span><span class="op" id="6392840">(</span><span class="ident" id="6392841">text</span><span class="op" id="6392845">,</span>&nbsp;<span class="ident" id="6392847">valLen</span><span class="op" id="6392853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392857">text</span>&nbsp;<span class="op" id="6392862">=</span>&nbsp;<span class="ident" id="6392864">text</span><span class="op" id="6392868">[</span><span class="ident" id="6392869">valLen</span><span class="op" id="6392875">:</span><span class="op" id="6392876">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392880">r</span><span class="op" id="6392881">.</span><span class="ident" id="6392882">params</span><span class="op" id="6392888">[</span><span class="ident" id="6392889">key</span><span class="op" id="6392892">]</span>&nbsp;<span class="op" id="6392894">=</span>&nbsp;<span class="ident" id="6392896">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392901">}</span><br>
<span class="lineno">65</span><span class="op" id="6392903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6392906">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6392950">type</span>&nbsp;<span class="ident" id="6392955">response</span>&nbsp;<span class="keyword" id="6392964">struct</span>&nbsp;<span class="op" id="6392971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392974">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6392986">*</span><span class="ident" id="6392987">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6392996">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393008">http</span><span class="op" id="6393012">.</span><span class="ident" id="6393013">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393021">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393033">*</span><span class="ident" id="6393034">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393045">wroteHeader</span>&nbsp;<span class="builtintype" id="6393057">bool</span><br>
<span class="lineno"></span><span class="op" id="6393062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6393065">func</span>&nbsp;<span class="ident" id="6393070">newResponse</span><span class="op" id="6393081">(</span><span class="ident" id="6393082">c</span>&nbsp;<span class="op" id="6393084">*</span><span class="ident" id="6393085">child</span><span class="op" id="6393090">,</span>&nbsp;<span class="ident" id="6393092">req</span>&nbsp;<span class="op" id="6393096">*</span><span class="ident" id="6393097">request</span><span class="op" id="6393104">)</span>&nbsp;<span class="op" id="6393106">*</span><span class="ident" id="6393107">response</span>&nbsp;<span class="op" id="6393116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393119">return</span>&nbsp;<span class="op" id="6393126">&amp;</span><span class="ident" id="6393127">response</span><span class="op" id="6393135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393139">req</span><span class="op" id="6393142">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393147">req</span><span class="op" id="6393150">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393154">header</span><span class="op" id="6393160">:</span>&nbsp;<span class="ident" id="6393162">http</span><span class="op" id="6393166">.</span><span class="ident" id="6393167">Header</span><span class="op" id="6393173">{</span><span class="op" id="6393174">}</span><span class="op" id="6393175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393179">w</span><span class="op" id="6393180">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393187">newWriter</span><span class="op" id="6393196">(</span><span class="ident" id="6393197">c</span><span class="op" id="6393198">.</span><span class="ident" id="6393199">conn</span><span class="op" id="6393203">,</span>&nbsp;<span class="ident" id="6393205">typeStdout</span><span class="op" id="6393215">,</span>&nbsp;<span class="ident" id="6393217">req</span><span class="op" id="6393220">.</span><span class="ident" id="6393221">reqId</span><span class="op" id="6393226">)</span><span class="op" id="6393227">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393230">}</span><br>
<span class="lineno"></span><span class="op" id="6393232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6393235">func</span>&nbsp;<span class="op" id="6393240">(</span><span class="ident" id="6393241">r</span>&nbsp;<span class="op" id="6393243">*</span><span class="ident" id="6393244">response</span><span class="op" id="6393252">)</span>&nbsp;<span class="ident" id="6393254">Header</span><span class="op" id="6393260">(</span><span class="op" id="6393261">)</span>&nbsp;<span class="ident" id="6393263">http</span><span class="op" id="6393267">.</span><span class="ident" id="6393268">Header</span>&nbsp;<span class="op" id="6393275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393278">return</span>&nbsp;<span class="ident" id="6393285">r</span><span class="op" id="6393286">.</span><span class="ident" id="6393287">header</span><br>
<span class="lineno">85</span><span class="op" id="6393294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6393297">func</span>&nbsp;<span class="op" id="6393302">(</span><span class="ident" id="6393303">r</span>&nbsp;<span class="op" id="6393305">*</span><span class="ident" id="6393306">response</span><span class="op" id="6393314">)</span>&nbsp;<span class="ident" id="6393316">Write</span><span class="op" id="6393321">(</span><span class="ident" id="6393322">data</span>&nbsp;<span class="op" id="6393327">[</span><span class="op" id="6393328">]</span><span class="builtintype" id="6393329">byte</span><span class="op" id="6393333">)</span>&nbsp;<span class="op" id="6393335">(</span><span class="builtintype" id="6393336">int</span><span class="op" id="6393339">,</span>&nbsp;<span class="builtintype" id="6393341">error</span><span class="op" id="6393346">)</span>&nbsp;<span class="op" id="6393348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393351">if</span>&nbsp;<span class="op" id="6393354">!</span><span class="ident" id="6393355">r</span><span class="op" id="6393356">.</span><span class="ident" id="6393357">wroteHeader</span>&nbsp;<span class="op" id="6393369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393373">r</span><span class="op" id="6393374">.</span><span class="ident" id="6393375">WriteHeader</span><span class="op" id="6393386">(</span><span class="ident" id="6393387">http</span><span class="op" id="6393391">.</span><span class="ident" id="6393392">StatusOK</span><span class="op" id="6393400">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393406">return</span>&nbsp;<span class="ident" id="6393413">r</span><span class="op" id="6393414">.</span><span class="ident" id="6393415">w</span><span class="op" id="6393416">.</span><span class="ident" id="6393417">Write</span><span class="op" id="6393422">(</span><span class="ident" id="6393423">data</span><span class="op" id="6393427">)</span><br>
<span class="lineno"></span><span class="op" id="6393429">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6393432">func</span>&nbsp;<span class="op" id="6393437">(</span><span class="ident" id="6393438">r</span>&nbsp;<span class="op" id="6393440">*</span><span class="ident" id="6393441">response</span><span class="op" id="6393449">)</span>&nbsp;<span class="ident" id="6393451">WriteHeader</span><span class="op" id="6393462">(</span><span class="ident" id="6393463">code</span>&nbsp;<span class="builtintype" id="6393468">int</span><span class="op" id="6393471">)</span>&nbsp;<span class="op" id="6393473">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393476">if</span>&nbsp;<span class="ident" id="6393479">r</span><span class="op" id="6393480">.</span><span class="ident" id="6393481">wroteHeader</span>&nbsp;<span class="op" id="6393493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393497">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393508">r</span><span class="op" id="6393509">.</span><span class="ident" id="6393510">wroteHeader</span>&nbsp;<span class="op" id="6393522">=</span>&nbsp;<span class="builtintype" id="6393524">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393530">if</span>&nbsp;<span class="ident" id="6393533">code</span>&nbsp;<span class="op" id="6393538">==</span>&nbsp;<span class="ident" id="6393541">http</span><span class="op" id="6393545">.</span><span class="ident" id="6393546">StatusNotModified</span>&nbsp;<span class="op" id="6393564">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6393568">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393593">r</span><span class="op" id="6393594">.</span><span class="ident" id="6393595">header</span><span class="op" id="6393601">.</span><span class="ident" id="6393602">Del</span><span class="op" id="6393605">(</span><span class="string" id="6393606">&#34;Content-Type&#34;</span><span class="op" id="6393620">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393624">r</span><span class="op" id="6393625">.</span><span class="ident" id="6393626">header</span><span class="op" id="6393632">.</span><span class="ident" id="6393633">Del</span><span class="op" id="6393636">(</span><span class="string" id="6393637">&#34;Content-Length&#34;</span><span class="op" id="6393653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393657">r</span><span class="op" id="6393658">.</span><span class="ident" id="6393659">header</span><span class="op" id="6393665">.</span><span class="ident" id="6393666">Del</span><span class="op" id="6393669">(</span><span class="string" id="6393670">&#34;Transfer-Encoding&#34;</span><span class="op" id="6393689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393692">}</span>&nbsp;<span class="keyword" id="6393694">else</span>&nbsp;<span class="keyword" id="6393699">if</span>&nbsp;<span class="ident" id="6393702">r</span><span class="op" id="6393703">.</span><span class="ident" id="6393704">header</span><span class="op" id="6393710">.</span><span class="ident" id="6393711">Get</span><span class="op" id="6393714">(</span><span class="string" id="6393715">&#34;Content-Type&#34;</span><span class="op" id="6393729">)</span>&nbsp;<span class="op" id="6393731">==</span>&nbsp;<span class="string" id="6393734">&#34;&#34;</span>&nbsp;<span class="op" id="6393737">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393741">r</span><span class="op" id="6393742">.</span><span class="ident" id="6393743">header</span><span class="op" id="6393749">.</span><span class="ident" id="6393750">Set</span><span class="op" id="6393753">(</span><span class="string" id="6393754">&#34;Content-Type&#34;</span><span class="op" id="6393768">,</span>&nbsp;<span class="string" id="6393770">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6393796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393799">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6393803">if</span>&nbsp;<span class="ident" id="6393806">r</span><span class="op" id="6393807">.</span><span class="ident" id="6393808">header</span><span class="op" id="6393814">.</span><span class="ident" id="6393815">Get</span><span class="op" id="6393818">(</span><span class="string" id="6393819">&#34;Date&#34;</span><span class="op" id="6393825">)</span>&nbsp;<span class="op" id="6393827">==</span>&nbsp;<span class="string" id="6393830">&#34;&#34;</span>&nbsp;<span class="op" id="6393833">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393837">r</span><span class="op" id="6393838">.</span><span class="ident" id="6393839">header</span><span class="op" id="6393845">.</span><span class="ident" id="6393846">Set</span><span class="op" id="6393849">(</span><span class="string" id="6393850">&#34;Date&#34;</span><span class="op" id="6393856">,</span>&nbsp;<span class="ident" id="6393858">time</span><span class="op" id="6393862">.</span><span class="ident" id="6393863">Now</span><span class="op" id="6393866">(</span><span class="op" id="6393867">)</span><span class="op" id="6393868">.</span><span class="ident" id="6393869">UTC</span><span class="op" id="6393872">(</span><span class="op" id="6393873">)</span><span class="op" id="6393874">.</span><span class="ident" id="6393875">Format</span><span class="op" id="6393881">(</span><span class="ident" id="6393882">http</span><span class="op" id="6393886">.</span><span class="ident" id="6393887">TimeFormat</span><span class="op" id="6393897">)</span><span class="op" id="6393898">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6393901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393905">fmt</span><span class="op" id="6393908">.</span><span class="ident" id="6393909">Fprintf</span><span class="op" id="6393916">(</span><span class="ident" id="6393917">r</span><span class="op" id="6393918">.</span><span class="ident" id="6393919">w</span><span class="op" id="6393920">,</span>&nbsp;<span class="string" id="6393922">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6393941">,</span>&nbsp;<span class="ident" id="6393943">code</span><span class="op" id="6393947">,</span>&nbsp;<span class="ident" id="6393949">http</span><span class="op" id="6393953">.</span><span class="ident" id="6393954">StatusText</span><span class="op" id="6393964">(</span><span class="ident" id="6393965">code</span><span class="op" id="6393969">)</span><span class="op" id="6393970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393973">r</span><span class="op" id="6393974">.</span><span class="ident" id="6393975">header</span><span class="op" id="6393981">.</span><span class="ident" id="6393982">Write</span><span class="op" id="6393987">(</span><span class="ident" id="6393988">r</span><span class="op" id="6393989">.</span><span class="ident" id="6393990">w</span><span class="op" id="6393991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6393994">r</span><span class="op" id="6393995">.</span><span class="ident" id="6393996">w</span><span class="op" id="6393997">.</span><span class="ident" id="6393998">WriteString</span><span class="op" id="6394009">(</span><span class="string" id="6394010">&#34;\r\n&#34;</span><span class="op" id="6394016">)</span><br>
<span class="lineno">115</span><span class="op" id="6394018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394021">func</span>&nbsp;<span class="op" id="6394026">(</span><span class="ident" id="6394027">r</span>&nbsp;<span class="op" id="6394029">*</span><span class="ident" id="6394030">response</span><span class="op" id="6394038">)</span>&nbsp;<span class="ident" id="6394040">Flush</span><span class="op" id="6394045">(</span><span class="op" id="6394046">)</span>&nbsp;<span class="op" id="6394048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394051">if</span>&nbsp;<span class="op" id="6394054">!</span><span class="ident" id="6394055">r</span><span class="op" id="6394056">.</span><span class="ident" id="6394057">wroteHeader</span>&nbsp;<span class="op" id="6394069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394073">r</span><span class="op" id="6394074">.</span><span class="ident" id="6394075">WriteHeader</span><span class="op" id="6394086">(</span><span class="ident" id="6394087">http</span><span class="op" id="6394091">.</span><span class="ident" id="6394092">StatusOK</span><span class="op" id="6394100">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394106">r</span><span class="op" id="6394107">.</span><span class="ident" id="6394108">w</span><span class="op" id="6394109">.</span><span class="ident" id="6394110">Flush</span><span class="op" id="6394115">(</span><span class="op" id="6394116">)</span><br>
<span class="lineno"></span><span class="op" id="6394118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394121">func</span>&nbsp;<span class="op" id="6394126">(</span><span class="ident" id="6394127">r</span>&nbsp;<span class="op" id="6394129">*</span><span class="ident" id="6394130">response</span><span class="op" id="6394138">)</span>&nbsp;<span class="ident" id="6394140">Close</span><span class="op" id="6394145">(</span><span class="op" id="6394146">)</span>&nbsp;<span class="builtintype" id="6394148">error</span>&nbsp;<span class="op" id="6394154">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394157">r</span><span class="op" id="6394158">.</span><span class="ident" id="6394159">Flush</span><span class="op" id="6394164">(</span><span class="op" id="6394165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394168">return</span>&nbsp;<span class="ident" id="6394175">r</span><span class="op" id="6394176">.</span><span class="ident" id="6394177">w</span><span class="op" id="6394178">.</span><span class="ident" id="6394179">Close</span><span class="op" id="6394184">(</span><span class="op" id="6394185">)</span><br>
<span class="lineno"></span><span class="op" id="6394187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394190">type</span>&nbsp;<span class="ident" id="6394195">child</span>&nbsp;<span class="keyword" id="6394201">struct</span>&nbsp;<span class="op" id="6394208">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394211">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394219">*</span><span class="ident" id="6394220">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394226">handler</span>&nbsp;<span class="ident" id="6394234">http</span><span class="op" id="6394238">.</span><span class="ident" id="6394239">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394249">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394258">sync</span><span class="op" id="6394262">.</span><span class="ident" id="6394263">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6394278">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394301">requests</span>&nbsp;<span class="keyword" id="6394310">map</span><span class="op" id="6394313">[</span><span class="builtintype" id="6394314">uint16</span><span class="op" id="6394320">]</span><span class="op" id="6394321">*</span><span class="ident" id="6394322">request</span>&nbsp;<span class="comment" id="6394330">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6394353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394356">func</span>&nbsp;<span class="ident" id="6394361">newChild</span><span class="op" id="6394369">(</span><span class="ident" id="6394370">rwc</span>&nbsp;<span class="ident" id="6394374">io</span><span class="op" id="6394376">.</span><span class="ident" id="6394377">ReadWriteCloser</span><span class="op" id="6394392">,</span>&nbsp;<span class="ident" id="6394394">handler</span>&nbsp;<span class="ident" id="6394402">http</span><span class="op" id="6394406">.</span><span class="ident" id="6394407">Handler</span><span class="op" id="6394414">)</span>&nbsp;<span class="op" id="6394416">*</span><span class="ident" id="6394417">child</span>&nbsp;<span class="op" id="6394423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394426">return</span>&nbsp;<span class="op" id="6394433">&amp;</span><span class="ident" id="6394434">child</span><span class="op" id="6394439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394443">conn</span><span class="op" id="6394447">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394453">newConn</span><span class="op" id="6394460">(</span><span class="ident" id="6394461">rwc</span><span class="op" id="6394464">)</span><span class="op" id="6394465">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394469">handler</span><span class="op" id="6394476">:</span>&nbsp;&nbsp;<span class="ident" id="6394479">handler</span><span class="op" id="6394486">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394490">requests</span><span class="op" id="6394498">:</span>&nbsp;<span class="builtinfunc" id="6394500">make</span><span class="op" id="6394504">(</span><span class="keyword" id="6394505">map</span><span class="op" id="6394508">[</span><span class="builtintype" id="6394509">uint16</span><span class="op" id="6394515">]</span><span class="op" id="6394516">*</span><span class="ident" id="6394517">request</span><span class="op" id="6394524">)</span><span class="op" id="6394525">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394528">}</span><br>
<span class="lineno"></span><span class="op" id="6394530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6394533">func</span>&nbsp;<span class="op" id="6394538">(</span><span class="ident" id="6394539">c</span>&nbsp;<span class="op" id="6394541">*</span><span class="ident" id="6394542">child</span><span class="op" id="6394547">)</span>&nbsp;<span class="ident" id="6394549">serve</span><span class="op" id="6394554">(</span><span class="op" id="6394555">)</span>&nbsp;<span class="op" id="6394557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394560">defer</span>&nbsp;<span class="ident" id="6394566">c</span><span class="op" id="6394567">.</span><span class="ident" id="6394568">conn</span><span class="op" id="6394572">.</span><span class="ident" id="6394573">Close</span><span class="op" id="6394578">(</span><span class="op" id="6394579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394582">var</span>&nbsp;<span class="ident" id="6394586">rec</span>&nbsp;<span class="ident" id="6394590">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394598">for</span>&nbsp;<span class="op" id="6394602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394606">if</span>&nbsp;<span class="ident" id="6394609">err</span>&nbsp;<span class="op" id="6394613">:=</span>&nbsp;<span class="ident" id="6394616">rec</span><span class="op" id="6394619">.</span><span class="ident" id="6394620">read</span><span class="op" id="6394624">(</span><span class="ident" id="6394625">c</span><span class="op" id="6394626">.</span><span class="ident" id="6394627">conn</span><span class="op" id="6394631">.</span><span class="ident" id="6394632">rwc</span><span class="op" id="6394635">)</span><span class="op" id="6394636">;</span>&nbsp;<span class="ident" id="6394638">err</span>&nbsp;<span class="op" id="6394642">!=</span>&nbsp;<span class="ident" id="6394645">nil</span>&nbsp;<span class="op" id="6394649">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394654">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394667">if</span>&nbsp;<span class="ident" id="6394670">err</span>&nbsp;<span class="op" id="6394674">:=</span>&nbsp;<span class="ident" id="6394677">c</span><span class="op" id="6394678">.</span><span class="ident" id="6394679">handleRecord</span><span class="op" id="6394691">(</span><span class="op" id="6394692">&amp;</span><span class="ident" id="6394693">rec</span><span class="op" id="6394696">)</span><span class="op" id="6394697">;</span>&nbsp;<span class="ident" id="6394699">err</span>&nbsp;<span class="op" id="6394703">!=</span>&nbsp;<span class="ident" id="6394706">nil</span>&nbsp;<span class="op" id="6394710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394715">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394724">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6394727">}</span><br>
<span class="lineno"></span><span class="op" id="6394729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394732">var</span>&nbsp;<span class="ident" id="6394736">errCloseConn</span>&nbsp;<span class="op" id="6394749">=</span>&nbsp;<span class="ident" id="6394751">errors</span><span class="op" id="6394757">.</span><span class="ident" id="6394758">New</span><span class="op" id="6394761">(</span><span class="string" id="6394762">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6394797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6394800">var</span>&nbsp;<span class="ident" id="6394804">emptyBody</span>&nbsp;<span class="op" id="6394814">=</span>&nbsp;<span class="ident" id="6394816">ioutil</span><span class="op" id="6394822">.</span><span class="ident" id="6394823">NopCloser</span><span class="op" id="6394832">(</span><span class="ident" id="6394833">strings</span><span class="op" id="6394840">.</span><span class="ident" id="6394841">NewReader</span><span class="op" id="6394850">(</span><span class="string" id="6394851">&#34;&#34;</span><span class="op" id="6394853">)</span><span class="op" id="6394854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6394857">func</span>&nbsp;<span class="op" id="6394862">(</span><span class="ident" id="6394863">c</span>&nbsp;<span class="op" id="6394865">*</span><span class="ident" id="6394866">child</span><span class="op" id="6394871">)</span>&nbsp;<span class="ident" id="6394873">handleRecord</span><span class="op" id="6394885">(</span><span class="ident" id="6394886">rec</span>&nbsp;<span class="op" id="6394890">*</span><span class="ident" id="6394891">record</span><span class="op" id="6394897">)</span>&nbsp;<span class="builtintype" id="6394899">error</span>&nbsp;<span class="op" id="6394905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394908">c</span><span class="op" id="6394909">.</span><span class="ident" id="6394910">mu</span><span class="op" id="6394912">.</span><span class="ident" id="6394913">Lock</span><span class="op" id="6394917">(</span><span class="op" id="6394918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394921">req</span><span class="op" id="6394924">,</span>&nbsp;<span class="ident" id="6394926">ok</span>&nbsp;<span class="op" id="6394929">:=</span>&nbsp;<span class="ident" id="6394932">c</span><span class="op" id="6394933">.</span><span class="ident" id="6394934">requests</span><span class="op" id="6394942">[</span><span class="ident" id="6394943">rec</span><span class="op" id="6394946">.</span><span class="ident" id="6394947">h</span><span class="op" id="6394948">.</span><span class="ident" id="6394949">Id</span><span class="op" id="6394951">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6394954">c</span><span class="op" id="6394955">.</span><span class="ident" id="6394956">mu</span><span class="op" id="6394958">.</span><span class="ident" id="6394959">Unlock</span><span class="op" id="6394965">(</span><span class="op" id="6394966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6394969">if</span>&nbsp;<span class="op" id="6394972">!</span><span class="ident" id="6394973">ok</span>&nbsp;<span class="op" id="6394976">&amp;&amp;</span>&nbsp;<span class="ident" id="6394979">rec</span><span class="op" id="6394982">.</span><span class="ident" id="6394983">h</span><span class="op" id="6394984">.</span><span class="ident" id="6394985">Type</span>&nbsp;<span class="op" id="6394990">!=</span>&nbsp;<span class="ident" id="6394993">typeBeginRequest</span>&nbsp;<span class="op" id="6395010">&amp;&amp;</span>&nbsp;<span class="ident" id="6395013">rec</span><span class="op" id="6395016">.</span><span class="ident" id="6395017">h</span><span class="op" id="6395018">.</span><span class="ident" id="6395019">Type</span>&nbsp;<span class="op" id="6395024">!=</span>&nbsp;<span class="ident" id="6395027">typeGetValues</span>&nbsp;<span class="op" id="6395041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6395045">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395095">return</span>&nbsp;<span class="ident" id="6395102">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395107">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395111">switch</span>&nbsp;<span class="ident" id="6395118">rec</span><span class="op" id="6395121">.</span><span class="ident" id="6395122">h</span><span class="op" id="6395123">.</span><span class="ident" id="6395124">Type</span>&nbsp;<span class="op" id="6395129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395132">case</span>&nbsp;<span class="ident" id="6395137">typeBeginRequest</span><span class="op" id="6395153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395157">if</span>&nbsp;<span class="ident" id="6395160">req</span>&nbsp;<span class="op" id="6395164">!=</span>&nbsp;<span class="ident" id="6395167">nil</span>&nbsp;<span class="op" id="6395171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6395176">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6395239">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395290">return</span>&nbsp;<span class="ident" id="6395297">errors</span><span class="op" id="6395303">.</span><span class="ident" id="6395304">New</span><span class="op" id="6395307">(</span><span class="string" id="6395308">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6395353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395362">var</span>&nbsp;<span class="ident" id="6395366">br</span>&nbsp;<span class="ident" id="6395369">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395384">if</span>&nbsp;<span class="ident" id="6395387">err</span>&nbsp;<span class="op" id="6395391">:=</span>&nbsp;<span class="ident" id="6395394">br</span><span class="op" id="6395396">.</span><span class="ident" id="6395397">read</span><span class="op" id="6395401">(</span><span class="ident" id="6395402">rec</span><span class="op" id="6395405">.</span><span class="ident" id="6395406">content</span><span class="op" id="6395413">(</span><span class="op" id="6395414">)</span><span class="op" id="6395415">)</span><span class="op" id="6395416">;</span>&nbsp;<span class="ident" id="6395418">err</span>&nbsp;<span class="op" id="6395422">!=</span>&nbsp;<span class="ident" id="6395425">nil</span>&nbsp;<span class="op" id="6395429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395434">return</span>&nbsp;<span class="ident" id="6395441">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395451">if</span>&nbsp;<span class="ident" id="6395454">br</span><span class="op" id="6395456">.</span><span class="ident" id="6395457">role</span>&nbsp;<span class="op" id="6395462">!=</span>&nbsp;<span class="ident" id="6395465">roleResponder</span>&nbsp;<span class="op" id="6395479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395484">c</span><span class="op" id="6395485">.</span><span class="ident" id="6395486">conn</span><span class="op" id="6395490">.</span><span class="ident" id="6395491">writeEndRequest</span><span class="op" id="6395506">(</span><span class="ident" id="6395507">rec</span><span class="op" id="6395510">.</span><span class="ident" id="6395511">h</span><span class="op" id="6395512">.</span><span class="ident" id="6395513">Id</span><span class="op" id="6395515">,</span>&nbsp;<span class="num" id="6395517">0</span><span class="op" id="6395518">,</span>&nbsp;<span class="ident" id="6395520">statusUnknownRole</span><span class="op" id="6395537">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395542">return</span>&nbsp;<span class="ident" id="6395549">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395559">req</span>&nbsp;<span class="op" id="6395563">=</span>&nbsp;<span class="ident" id="6395565">newRequest</span><span class="op" id="6395575">(</span><span class="ident" id="6395576">rec</span><span class="op" id="6395579">.</span><span class="ident" id="6395580">h</span><span class="op" id="6395581">.</span><span class="ident" id="6395582">Id</span><span class="op" id="6395584">,</span>&nbsp;<span class="ident" id="6395586">br</span><span class="op" id="6395588">.</span><span class="ident" id="6395589">flags</span><span class="op" id="6395594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395598">c</span><span class="op" id="6395599">.</span><span class="ident" id="6395600">mu</span><span class="op" id="6395602">.</span><span class="ident" id="6395603">Lock</span><span class="op" id="6395607">(</span><span class="op" id="6395608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395612">c</span><span class="op" id="6395613">.</span><span class="ident" id="6395614">requests</span><span class="op" id="6395622">[</span><span class="ident" id="6395623">rec</span><span class="op" id="6395626">.</span><span class="ident" id="6395627">h</span><span class="op" id="6395628">.</span><span class="ident" id="6395629">Id</span><span class="op" id="6395631">]</span>&nbsp;<span class="op" id="6395633">=</span>&nbsp;<span class="ident" id="6395635">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395641">c</span><span class="op" id="6395642">.</span><span class="ident" id="6395643">mu</span><span class="op" id="6395645">.</span><span class="ident" id="6395646">Unlock</span><span class="op" id="6395652">(</span><span class="op" id="6395653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395657">return</span>&nbsp;<span class="ident" id="6395664">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395669">case</span>&nbsp;<span class="ident" id="6395674">typeParams</span><span class="op" id="6395684">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6395688">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6395759">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395832">if</span>&nbsp;<span class="builtinfunc" id="6395835">len</span><span class="op" id="6395838">(</span><span class="ident" id="6395839">rec</span><span class="op" id="6395842">.</span><span class="ident" id="6395843">content</span><span class="op" id="6395850">(</span><span class="op" id="6395851">)</span><span class="op" id="6395852">)</span>&nbsp;<span class="op" id="6395854">&gt;</span>&nbsp;<span class="num" id="6395856">0</span>&nbsp;<span class="op" id="6395858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395863">req</span><span class="op" id="6395866">.</span><span class="ident" id="6395867">rawParams</span>&nbsp;<span class="op" id="6395877">=</span>&nbsp;<span class="builtinfunc" id="6395879">append</span><span class="op" id="6395885">(</span><span class="ident" id="6395886">req</span><span class="op" id="6395889">.</span><span class="ident" id="6395890">rawParams</span><span class="op" id="6395899">,</span>&nbsp;<span class="ident" id="6395901">rec</span><span class="op" id="6395904">.</span><span class="ident" id="6395905">content</span><span class="op" id="6395912">(</span><span class="op" id="6395913">)</span><span class="op" id="6395914">...</span><span class="op" id="6395917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395922">return</span>&nbsp;<span class="ident" id="6395929">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6395935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395939">req</span><span class="op" id="6395942">.</span><span class="ident" id="6395943">parseParams</span><span class="op" id="6395954">(</span><span class="op" id="6395955">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395959">return</span>&nbsp;<span class="ident" id="6395966">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6395971">case</span>&nbsp;<span class="ident" id="6395976">typeStdin</span><span class="op" id="6395985">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6395989">content</span>&nbsp;<span class="op" id="6395997">:=</span>&nbsp;<span class="ident" id="6396000">rec</span><span class="op" id="6396003">.</span><span class="ident" id="6396004">content</span><span class="op" id="6396011">(</span><span class="op" id="6396012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396016">if</span>&nbsp;<span class="ident" id="6396019">req</span><span class="op" id="6396022">.</span><span class="ident" id="6396023">pw</span>&nbsp;<span class="op" id="6396026">==</span>&nbsp;<span class="ident" id="6396029">nil</span>&nbsp;<span class="op" id="6396033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396038">var</span>&nbsp;<span class="ident" id="6396042">body</span>&nbsp;<span class="ident" id="6396047">io</span><span class="op" id="6396049">.</span><span class="ident" id="6396050">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396064">if</span>&nbsp;<span class="builtinfunc" id="6396067">len</span><span class="op" id="6396070">(</span><span class="ident" id="6396071">content</span><span class="op" id="6396078">)</span>&nbsp;<span class="op" id="6396080">&gt;</span>&nbsp;<span class="num" id="6396082">0</span>&nbsp;<span class="op" id="6396084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396090">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396154">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396197">body</span><span class="op" id="6396201">,</span>&nbsp;<span class="ident" id="6396203">req</span><span class="op" id="6396206">.</span><span class="ident" id="6396207">pw</span>&nbsp;<span class="op" id="6396210">=</span>&nbsp;<span class="ident" id="6396212">io</span><span class="op" id="6396214">.</span><span class="ident" id="6396215">Pipe</span><span class="op" id="6396219">(</span><span class="op" id="6396220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6396225">}</span>&nbsp;<span class="keyword" id="6396227">else</span>&nbsp;<span class="op" id="6396232">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396238">body</span>&nbsp;<span class="op" id="6396243">=</span>&nbsp;<span class="ident" id="6396245">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6396258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396263">go</span>&nbsp;<span class="ident" id="6396266">c</span><span class="op" id="6396267">.</span><span class="ident" id="6396268">serveRequest</span><span class="op" id="6396280">(</span><span class="ident" id="6396281">req</span><span class="op" id="6396284">,</span>&nbsp;<span class="ident" id="6396286">body</span><span class="op" id="6396290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6396294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396298">if</span>&nbsp;<span class="builtinfunc" id="6396301">len</span><span class="op" id="6396304">(</span><span class="ident" id="6396305">content</span><span class="op" id="6396312">)</span>&nbsp;<span class="op" id="6396314">&gt;</span>&nbsp;<span class="num" id="6396316">0</span>&nbsp;<span class="op" id="6396318">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396323">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396391">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396454">req</span><span class="op" id="6396457">.</span><span class="ident" id="6396458">pw</span><span class="op" id="6396460">.</span><span class="ident" id="6396461">Write</span><span class="op" id="6396466">(</span><span class="ident" id="6396467">content</span><span class="op" id="6396474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6396478">}</span>&nbsp;<span class="keyword" id="6396480">else</span>&nbsp;<span class="keyword" id="6396485">if</span>&nbsp;<span class="ident" id="6396488">req</span><span class="op" id="6396491">.</span><span class="ident" id="6396492">pw</span>&nbsp;<span class="op" id="6396495">!=</span>&nbsp;<span class="ident" id="6396498">nil</span>&nbsp;<span class="op" id="6396502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396507">req</span><span class="op" id="6396510">.</span><span class="ident" id="6396511">pw</span><span class="op" id="6396513">.</span><span class="ident" id="6396514">Close</span><span class="op" id="6396519">(</span><span class="op" id="6396520">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6396524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396528">return</span>&nbsp;<span class="ident" id="6396535">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396540">case</span>&nbsp;<span class="ident" id="6396545">typeGetValues</span><span class="op" id="6396558">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396562">values</span>&nbsp;<span class="op" id="6396569">:=</span>&nbsp;<span class="keyword" id="6396572">map</span><span class="op" id="6396575">[</span><span class="builtintype" id="6396576">string</span><span class="op" id="6396582">]</span><span class="builtintype" id="6396583">string</span><span class="op" id="6396589">{</span><span class="string" id="6396590">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6396607">:</span>&nbsp;<span class="string" id="6396609">&#34;1&#34;</span><span class="op" id="6396612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396616">c</span><span class="op" id="6396617">.</span><span class="ident" id="6396618">conn</span><span class="op" id="6396622">.</span><span class="ident" id="6396623">writePairs</span><span class="op" id="6396633">(</span><span class="ident" id="6396634">typeGetValuesResult</span><span class="op" id="6396653">,</span>&nbsp;<span class="num" id="6396655">0</span><span class="op" id="6396656">,</span>&nbsp;<span class="ident" id="6396658">values</span><span class="op" id="6396664">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396668">return</span>&nbsp;<span class="ident" id="6396675">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396680">case</span>&nbsp;<span class="ident" id="6396685">typeData</span><span class="op" id="6396693">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396697">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396764">return</span>&nbsp;<span class="ident" id="6396771">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396776">case</span>&nbsp;<span class="ident" id="6396781">typeAbortRequest</span><span class="op" id="6396797">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6396801">println</span><span class="op" id="6396808">(</span><span class="string" id="6396809">&#34;abort&#34;</span><span class="op" id="6396816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396820">c</span><span class="op" id="6396821">.</span><span class="ident" id="6396822">mu</span><span class="op" id="6396824">.</span><span class="ident" id="6396825">Lock</span><span class="op" id="6396829">(</span><span class="op" id="6396830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6396834">delete</span><span class="op" id="6396840">(</span><span class="ident" id="6396841">c</span><span class="op" id="6396842">.</span><span class="ident" id="6396843">requests</span><span class="op" id="6396851">,</span>&nbsp;<span class="ident" id="6396853">rec</span><span class="op" id="6396856">.</span><span class="ident" id="6396857">h</span><span class="op" id="6396858">.</span><span class="ident" id="6396859">Id</span><span class="op" id="6396861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396865">c</span><span class="op" id="6396866">.</span><span class="ident" id="6396867">mu</span><span class="op" id="6396869">.</span><span class="ident" id="6396870">Unlock</span><span class="op" id="6396876">(</span><span class="op" id="6396877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6396881">c</span><span class="op" id="6396882">.</span><span class="ident" id="6396883">conn</span><span class="op" id="6396887">.</span><span class="ident" id="6396888">writeEndRequest</span><span class="op" id="6396903">(</span><span class="ident" id="6396904">rec</span><span class="op" id="6396907">.</span><span class="ident" id="6396908">h</span><span class="op" id="6396909">.</span><span class="ident" id="6396910">Id</span><span class="op" id="6396912">,</span>&nbsp;<span class="num" id="6396914">0</span><span class="op" id="6396915">,</span>&nbsp;<span class="ident" id="6396917">statusRequestComplete</span><span class="op" id="6396938">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6396942">if</span>&nbsp;<span class="op" id="6396945">!</span><span class="ident" id="6396946">req</span><span class="op" id="6396949">.</span><span class="ident" id="6396950">keepConn</span>&nbsp;<span class="op" id="6396959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6396964">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6397004">return</span>&nbsp;<span class="ident" id="6397011">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6397026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6397030">return</span>&nbsp;<span class="ident" id="6397037">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6397042">default</span><span class="op" id="6397049">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397053">b</span>&nbsp;<span class="op" id="6397055">:=</span>&nbsp;<span class="builtinfunc" id="6397058">make</span><span class="op" id="6397062">(</span><span class="op" id="6397063">[</span><span class="op" id="6397064">]</span><span class="builtintype" id="6397065">byte</span><span class="op" id="6397069">,</span>&nbsp;<span class="num" id="6397071">8</span><span class="op" id="6397072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397076">b</span><span class="op" id="6397077">[</span><span class="num" id="6397078">0</span><span class="op" id="6397079">]</span>&nbsp;<span class="op" id="6397081">=</span>&nbsp;<span class="builtintype" id="6397083">byte</span><span class="op" id="6397087">(</span><span class="ident" id="6397088">rec</span><span class="op" id="6397091">.</span><span class="ident" id="6397092">h</span><span class="op" id="6397093">.</span><span class="ident" id="6397094">Type</span><span class="op" id="6397098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397102">c</span><span class="op" id="6397103">.</span><span class="ident" id="6397104">conn</span><span class="op" id="6397108">.</span><span class="ident" id="6397109">writeRecord</span><span class="op" id="6397120">(</span><span class="ident" id="6397121">typeUnknownType</span><span class="op" id="6397136">,</span>&nbsp;<span class="num" id="6397138">0</span><span class="op" id="6397139">,</span>&nbsp;<span class="ident" id="6397141">b</span><span class="op" id="6397142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6397146">return</span>&nbsp;<span class="ident" id="6397153">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6397158">}</span><br>
<span class="lineno"></span><span class="op" id="6397160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6397163">func</span>&nbsp;<span class="op" id="6397168">(</span><span class="ident" id="6397169">c</span>&nbsp;<span class="op" id="6397171">*</span><span class="ident" id="6397172">child</span><span class="op" id="6397177">)</span>&nbsp;<span class="ident" id="6397179">serveRequest</span><span class="op" id="6397191">(</span><span class="ident" id="6397192">req</span>&nbsp;<span class="op" id="6397196">*</span><span class="ident" id="6397197">request</span><span class="op" id="6397204">,</span>&nbsp;<span class="ident" id="6397206">body</span>&nbsp;<span class="ident" id="6397211">io</span><span class="op" id="6397213">.</span><span class="ident" id="6397214">ReadCloser</span><span class="op" id="6397224">)</span>&nbsp;<span class="op" id="6397226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397229">r</span>&nbsp;<span class="op" id="6397231">:=</span>&nbsp;<span class="ident" id="6397234">newResponse</span><span class="op" id="6397245">(</span><span class="ident" id="6397246">c</span><span class="op" id="6397247">,</span>&nbsp;<span class="ident" id="6397249">req</span><span class="op" id="6397252">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397255">httpReq</span><span class="op" id="6397262">,</span>&nbsp;<span class="ident" id="6397264">err</span>&nbsp;<span class="op" id="6397268">:=</span>&nbsp;<span class="ident" id="6397271">cgi</span><span class="op" id="6397274">.</span><span class="ident" id="6397275">RequestFromMap</span><span class="op" id="6397289">(</span><span class="ident" id="6397290">req</span><span class="op" id="6397293">.</span><span class="ident" id="6397294">params</span><span class="op" id="6397300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6397303">if</span>&nbsp;<span class="ident" id="6397306">err</span>&nbsp;<span class="op" id="6397310">!=</span>&nbsp;<span class="ident" id="6397313">nil</span>&nbsp;<span class="op" id="6397317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397321">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397365">r</span><span class="op" id="6397366">.</span><span class="ident" id="6397367">WriteHeader</span><span class="op" id="6397378">(</span><span class="ident" id="6397379">http</span><span class="op" id="6397383">.</span><span class="ident" id="6397384">StatusInternalServerError</span><span class="op" id="6397409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397413">c</span><span class="op" id="6397414">.</span><span class="ident" id="6397415">conn</span><span class="op" id="6397419">.</span><span class="ident" id="6397420">writeRecord</span><span class="op" id="6397431">(</span><span class="ident" id="6397432">typeStderr</span><span class="op" id="6397442">,</span>&nbsp;<span class="ident" id="6397444">req</span><span class="op" id="6397447">.</span><span class="ident" id="6397448">reqId</span><span class="op" id="6397453">,</span>&nbsp;<span class="op" id="6397455">[</span><span class="op" id="6397456">]</span><span class="builtintype" id="6397457">byte</span><span class="op" id="6397461">(</span><span class="ident" id="6397462">err</span><span class="op" id="6397465">.</span><span class="ident" id="6397466">Error</span><span class="op" id="6397471">(</span><span class="op" id="6397472">)</span><span class="op" id="6397473">)</span><span class="op" id="6397474">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6397477">}</span>&nbsp;<span class="keyword" id="6397479">else</span>&nbsp;<span class="op" id="6397484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397488">httpReq</span><span class="op" id="6397495">.</span><span class="ident" id="6397496">Body</span>&nbsp;<span class="op" id="6397501">=</span>&nbsp;<span class="ident" id="6397503">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397510">c</span><span class="op" id="6397511">.</span><span class="ident" id="6397512">handler</span><span class="op" id="6397519">.</span><span class="ident" id="6397520">ServeHTTP</span><span class="op" id="6397529">(</span><span class="ident" id="6397530">r</span><span class="op" id="6397531">,</span>&nbsp;<span class="ident" id="6397533">httpReq</span><span class="op" id="6397540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6397543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397546">r</span><span class="op" id="6397547">.</span><span class="ident" id="6397548">Close</span><span class="op" id="6397553">(</span><span class="op" id="6397554">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397557">c</span><span class="op" id="6397558">.</span><span class="ident" id="6397559">mu</span><span class="op" id="6397561">.</span><span class="ident" id="6397562">Lock</span><span class="op" id="6397566">(</span><span class="op" id="6397567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="6397570">delete</span><span class="op" id="6397576">(</span><span class="ident" id="6397577">c</span><span class="op" id="6397578">.</span><span class="ident" id="6397579">requests</span><span class="op" id="6397587">,</span>&nbsp;<span class="ident" id="6397589">req</span><span class="op" id="6397592">.</span><span class="ident" id="6397593">reqId</span><span class="op" id="6397598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397601">c</span><span class="op" id="6397602">.</span><span class="ident" id="6397603">mu</span><span class="op" id="6397605">.</span><span class="ident" id="6397606">Unlock</span><span class="op" id="6397612">(</span><span class="op" id="6397613">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6397616">c</span><span class="op" id="6397617">.</span><span class="ident" id="6397618">conn</span><span class="op" id="6397622">.</span><span class="ident" id="6397623">writeEndRequest</span><span class="op" id="6397638">(</span><span class="ident" id="6397639">req</span><span class="op" id="6397642">.</span><span class="ident" id="6397643">reqId</span><span class="op" id="6397648">,</span>&nbsp;<span class="num" id="6397650">0</span><span class="op" id="6397651">,</span>&nbsp;<span class="ident" id="6397653">statusRequestComplete</span><span class="op" id="6397674">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397678">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397742">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397803">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397858">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397916">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6397972">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6398030">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398069">io</span><span class="op" id="6398071">.</span><span class="ident" id="6398072">CopyN</span><span class="op" id="6398077">(</span><span class="ident" id="6398078">ioutil</span><span class="op" id="6398084">.</span><span class="ident" id="6398085">Discard</span><span class="op" id="6398092">,</span>&nbsp;<span class="ident" id="6398094">body</span><span class="op" id="6398098">,</span>&nbsp;<span class="num" id="6398100">100</span><span class="op" id="6398103">&lt;&lt;</span><span class="num" id="6398105">20</span><span class="op" id="6398107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398110">body</span><span class="op" id="6398114">.</span><span class="ident" id="6398115">Close</span><span class="op" id="6398120">(</span><span class="op" id="6398121">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398125">if</span>&nbsp;<span class="op" id="6398128">!</span><span class="ident" id="6398129">req</span><span class="op" id="6398132">.</span><span class="ident" id="6398133">keepConn</span>&nbsp;<span class="op" id="6398142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398146">c</span><span class="op" id="6398147">.</span><span class="ident" id="6398148">conn</span><span class="op" id="6398152">.</span><span class="ident" id="6398153">Close</span><span class="op" id="6398158">(</span><span class="op" id="6398159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398162">}</span><br>
<span class="lineno"></span><span class="op" id="6398164">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6398167">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6398247">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6398322">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6398343">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6398400">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6398452">func</span>&nbsp;<span class="ident" id="6398457">Serve</span><span class="op" id="6398462">(</span><span class="ident" id="6398463">l</span>&nbsp;<span class="ident" id="6398465">net</span><span class="op" id="6398468">.</span><span class="ident" id="6398469">Listener</span><span class="op" id="6398477">,</span>&nbsp;<span class="ident" id="6398479">handler</span>&nbsp;<span class="ident" id="6398487">http</span><span class="op" id="6398491">.</span><span class="ident" id="6398492">Handler</span><span class="op" id="6398499">)</span>&nbsp;<span class="builtintype" id="6398501">error</span>&nbsp;<span class="op" id="6398507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398510">if</span>&nbsp;<span class="ident" id="6398513">l</span>&nbsp;<span class="op" id="6398515">==</span>&nbsp;<span class="ident" id="6398518">nil</span>&nbsp;<span class="op" id="6398522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398526">var</span>&nbsp;<span class="ident" id="6398530">err</span>&nbsp;<span class="builtintype" id="6398534">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398542">l</span><span class="op" id="6398543">,</span>&nbsp;<span class="ident" id="6398545">err</span>&nbsp;<span class="op" id="6398549">=</span>&nbsp;<span class="ident" id="6398551">net</span><span class="op" id="6398554">.</span><span class="ident" id="6398555">FileListener</span><span class="op" id="6398567">(</span><span class="ident" id="6398568">os</span><span class="op" id="6398570">.</span><span class="ident" id="6398571">Stdin</span><span class="op" id="6398576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398580">if</span>&nbsp;<span class="ident" id="6398583">err</span>&nbsp;<span class="op" id="6398587">!=</span>&nbsp;<span class="ident" id="6398590">nil</span>&nbsp;<span class="op" id="6398594">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398599">return</span>&nbsp;<span class="ident" id="6398606">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398612">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398616">defer</span>&nbsp;<span class="ident" id="6398622">l</span><span class="op" id="6398623">.</span><span class="ident" id="6398624">Close</span><span class="op" id="6398629">(</span><span class="op" id="6398630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398636">if</span>&nbsp;<span class="ident" id="6398639">handler</span>&nbsp;<span class="op" id="6398647">==</span>&nbsp;<span class="ident" id="6398650">nil</span>&nbsp;<span class="op" id="6398654">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398658">handler</span>&nbsp;<span class="op" id="6398666">=</span>&nbsp;<span class="ident" id="6398668">http</span><span class="op" id="6398672">.</span><span class="ident" id="6398673">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398693">for</span>&nbsp;<span class="op" id="6398697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398701">rw</span><span class="op" id="6398703">,</span>&nbsp;<span class="ident" id="6398705">err</span>&nbsp;<span class="op" id="6398709">:=</span>&nbsp;<span class="ident" id="6398712">l</span><span class="op" id="6398713">.</span><span class="ident" id="6398714">Accept</span><span class="op" id="6398720">(</span><span class="op" id="6398721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398725">if</span>&nbsp;<span class="ident" id="6398728">err</span>&nbsp;<span class="op" id="6398732">!=</span>&nbsp;<span class="ident" id="6398735">nil</span>&nbsp;<span class="op" id="6398739">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398744">return</span>&nbsp;<span class="ident" id="6398751">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6398761">c</span>&nbsp;<span class="op" id="6398763">:=</span>&nbsp;<span class="ident" id="6398766">newChild</span><span class="op" id="6398774">(</span><span class="ident" id="6398775">rw</span><span class="op" id="6398777">,</span>&nbsp;<span class="ident" id="6398779">handler</span><span class="op" id="6398786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6398790">go</span>&nbsp;<span class="ident" id="6398793">c</span><span class="op" id="6398794">.</span><span class="ident" id="6398795">serve</span><span class="op" id="6398800">(</span><span class="op" id="6398801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6398804">}</span><br>
<span class="lineno">305</span><span class="op" id="6398806">}</span>
</div>
</body>
</html>
