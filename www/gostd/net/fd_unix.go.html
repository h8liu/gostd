<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3617124">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3617179">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3617233">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3617284">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617354">package</span>&nbsp;<span class="ident" id="3617362">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617367">import</span>&nbsp;<span class="op" id="3617374">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617377">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617383">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617389">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617400">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617415">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3617426">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3617433">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3617436">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3617464">type</span>&nbsp;<span class="ident" id="3617469">netFD</span>&nbsp;<span class="keyword" id="3617475">struct</span>&nbsp;<span class="op" id="3617482">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617485">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617560">fdmu</span>&nbsp;<span class="ident" id="3617565">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617575">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617601">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3617613">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617618">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3617630">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617635">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3617647">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617652">isConnected</span>&nbsp;<span class="builtintype" id="3617664">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617670">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3617682">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617690">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617702">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617708">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3617720">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3617727">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3617743">pd</span>&nbsp;<span class="ident" id="3617746">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3617755">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3617758">func</span>&nbsp;<span class="ident" id="3617763">sysInit</span><span class="op" id="3617770">(</span><span class="op" id="3617771">)</span>&nbsp;<span class="op" id="3617773">{</span><br>
<span class="lineno"></span><span class="op" id="3617775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617778">func</span>&nbsp;<span class="ident" id="3617783">dial</span><span class="op" id="3617787">(</span><span class="ident" id="3617788">network</span>&nbsp;<span class="builtintype" id="3617796">string</span><span class="op" id="3617802">,</span>&nbsp;<span class="ident" id="3617804">ra</span>&nbsp;<span class="ident" id="3617807">Addr</span><span class="op" id="3617811">,</span>&nbsp;<span class="ident" id="3617813">dialer</span>&nbsp;<span class="keyword" id="3617820">func</span><span class="op" id="3617824">(</span><span class="ident" id="3617825">time</span><span class="op" id="3617829">.</span><span class="ident" id="3617830">Time</span><span class="op" id="3617834">)</span>&nbsp;<span class="op" id="3617836">(</span><span class="ident" id="3617837">Conn</span><span class="op" id="3617841">,</span>&nbsp;<span class="builtintype" id="3617843">error</span><span class="op" id="3617848">)</span><span class="op" id="3617849">,</span>&nbsp;<span class="ident" id="3617851">deadline</span>&nbsp;<span class="ident" id="3617860">time</span><span class="op" id="3617864">.</span><span class="ident" id="3617865">Time</span><span class="op" id="3617869">)</span>&nbsp;<span class="op" id="3617871">(</span><span class="ident" id="3617872">Conn</span><span class="op" id="3617876">,</span>&nbsp;<span class="builtintype" id="3617878">error</span><span class="op" id="3617883">)</span>&nbsp;<span class="op" id="3617885">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617888">return</span>&nbsp;<span class="ident" id="3617895">dialer</span><span class="op" id="3617901">(</span><span class="ident" id="3617902">deadline</span><span class="op" id="3617910">)</span><br>
<span class="lineno"></span><span class="op" id="3617912">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3617915">func</span>&nbsp;<span class="ident" id="3617920">newFD</span><span class="op" id="3617925">(</span><span class="ident" id="3617926">sysfd</span><span class="op" id="3617931">,</span>&nbsp;<span class="ident" id="3617933">family</span><span class="op" id="3617939">,</span>&nbsp;<span class="ident" id="3617941">sotype</span>&nbsp;<span class="builtintype" id="3617948">int</span><span class="op" id="3617951">,</span>&nbsp;<span class="ident" id="3617953">net</span>&nbsp;<span class="builtintype" id="3617957">string</span><span class="op" id="3617963">)</span>&nbsp;<span class="op" id="3617965">(</span><span class="op" id="3617966">*</span><span class="ident" id="3617967">netFD</span><span class="op" id="3617972">,</span>&nbsp;<span class="builtintype" id="3617974">error</span><span class="op" id="3617979">)</span>&nbsp;<span class="op" id="3617981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3617984">return</span>&nbsp;<span class="op" id="3617991">&amp;</span><span class="ident" id="3617992">netFD</span><span class="op" id="3617997">{</span><span class="ident" id="3617998">sysfd</span><span class="op" id="3618003">:</span>&nbsp;<span class="ident" id="3618005">sysfd</span><span class="op" id="3618010">,</span>&nbsp;<span class="ident" id="3618012">family</span><span class="op" id="3618018">:</span>&nbsp;<span class="ident" id="3618020">family</span><span class="op" id="3618026">,</span>&nbsp;<span class="ident" id="3618028">sotype</span><span class="op" id="3618034">:</span>&nbsp;<span class="ident" id="3618036">sotype</span><span class="op" id="3618042">,</span>&nbsp;<span class="ident" id="3618044">net</span><span class="op" id="3618047">:</span>&nbsp;<span class="ident" id="3618049">net</span><span class="op" id="3618052">}</span><span class="op" id="3618053">,</span>&nbsp;<span class="ident" id="3618055">nil</span><br>
<span class="lineno">45</span><span class="op" id="3618059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3618062">func</span>&nbsp;<span class="op" id="3618067">(</span><span class="ident" id="3618068">fd</span>&nbsp;<span class="op" id="3618071">*</span><span class="ident" id="3618072">netFD</span><span class="op" id="3618077">)</span>&nbsp;<span class="ident" id="3618079">init</span><span class="op" id="3618083">(</span><span class="op" id="3618084">)</span>&nbsp;<span class="builtintype" id="3618086">error</span>&nbsp;<span class="op" id="3618092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618095">if</span>&nbsp;<span class="ident" id="3618098">err</span>&nbsp;<span class="op" id="3618102">:=</span>&nbsp;<span class="ident" id="3618105">fd</span><span class="op" id="3618107">.</span><span class="ident" id="3618108">pd</span><span class="op" id="3618110">.</span><span class="ident" id="3618111">Init</span><span class="op" id="3618115">(</span><span class="ident" id="3618116">fd</span><span class="op" id="3618118">)</span><span class="op" id="3618119">;</span>&nbsp;<span class="ident" id="3618121">err</span>&nbsp;<span class="op" id="3618125">!=</span>&nbsp;<span class="ident" id="3618128">nil</span>&nbsp;<span class="op" id="3618132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618136">return</span>&nbsp;<span class="ident" id="3618143">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618151">return</span>&nbsp;<span class="ident" id="3618158">nil</span><br>
<span class="lineno"></span><span class="op" id="3618162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3618165">func</span>&nbsp;<span class="op" id="3618170">(</span><span class="ident" id="3618171">fd</span>&nbsp;<span class="op" id="3618174">*</span><span class="ident" id="3618175">netFD</span><span class="op" id="3618180">)</span>&nbsp;<span class="ident" id="3618182">setAddr</span><span class="op" id="3618189">(</span><span class="ident" id="3618190">laddr</span><span class="op" id="3618195">,</span>&nbsp;<span class="ident" id="3618197">raddr</span>&nbsp;<span class="ident" id="3618203">Addr</span><span class="op" id="3618207">)</span>&nbsp;<span class="op" id="3618209">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618212">fd</span><span class="op" id="3618214">.</span><span class="ident" id="3618215">laddr</span>&nbsp;<span class="op" id="3618221">=</span>&nbsp;<span class="ident" id="3618223">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618230">fd</span><span class="op" id="3618232">.</span><span class="ident" id="3618233">raddr</span>&nbsp;<span class="op" id="3618239">=</span>&nbsp;<span class="ident" id="3618241">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618248">runtime</span><span class="op" id="3618255">.</span><span class="ident" id="3618256">SetFinalizer</span><span class="op" id="3618268">(</span><span class="ident" id="3618269">fd</span><span class="op" id="3618271">,</span>&nbsp;<span class="op" id="3618273">(</span><span class="op" id="3618274">*</span><span class="ident" id="3618275">netFD</span><span class="op" id="3618280">)</span><span class="op" id="3618281">.</span><span class="ident" id="3618282">Close</span><span class="op" id="3618287">)</span><br>
<span class="lineno"></span><span class="op" id="3618289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3618292">func</span>&nbsp;<span class="op" id="3618297">(</span><span class="ident" id="3618298">fd</span>&nbsp;<span class="op" id="3618301">*</span><span class="ident" id="3618302">netFD</span><span class="op" id="3618307">)</span>&nbsp;<span class="ident" id="3618309">name</span><span class="op" id="3618313">(</span><span class="op" id="3618314">)</span>&nbsp;<span class="builtintype" id="3618316">string</span>&nbsp;<span class="op" id="3618323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618326">var</span>&nbsp;<span class="ident" id="3618330">ls</span><span class="op" id="3618332">,</span>&nbsp;<span class="ident" id="3618334">rs</span>&nbsp;<span class="builtintype" id="3618337">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618345">if</span>&nbsp;<span class="ident" id="3618348">fd</span><span class="op" id="3618350">.</span><span class="ident" id="3618351">laddr</span>&nbsp;<span class="op" id="3618357">!=</span>&nbsp;<span class="ident" id="3618360">nil</span>&nbsp;<span class="op" id="3618364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618368">ls</span>&nbsp;<span class="op" id="3618371">=</span>&nbsp;<span class="ident" id="3618373">fd</span><span class="op" id="3618375">.</span><span class="ident" id="3618376">laddr</span><span class="op" id="3618381">.</span><span class="ident" id="3618382">String</span><span class="op" id="3618388">(</span><span class="op" id="3618389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618392">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618395">if</span>&nbsp;<span class="ident" id="3618398">fd</span><span class="op" id="3618400">.</span><span class="ident" id="3618401">raddr</span>&nbsp;<span class="op" id="3618407">!=</span>&nbsp;<span class="ident" id="3618410">nil</span>&nbsp;<span class="op" id="3618414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3618418">rs</span>&nbsp;<span class="op" id="3618421">=</span>&nbsp;<span class="ident" id="3618423">fd</span><span class="op" id="3618425">.</span><span class="ident" id="3618426">raddr</span><span class="op" id="3618431">.</span><span class="ident" id="3618432">String</span><span class="op" id="3618438">(</span><span class="op" id="3618439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618445">return</span>&nbsp;<span class="ident" id="3618452">fd</span><span class="op" id="3618454">.</span><span class="ident" id="3618455">net</span>&nbsp;<span class="op" id="3618459">+</span>&nbsp;<span class="string" id="3618461">&#34;:&#34;</span>&nbsp;<span class="op" id="3618465">+</span>&nbsp;<span class="ident" id="3618467">ls</span>&nbsp;<span class="op" id="3618470">+</span>&nbsp;<span class="string" id="3618472">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3618477">+</span>&nbsp;<span class="ident" id="3618479">rs</span><br>
<span class="lineno"></span><span class="op" id="3618482">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3618485">func</span>&nbsp;<span class="op" id="3618490">(</span><span class="ident" id="3618491">fd</span>&nbsp;<span class="op" id="3618494">*</span><span class="ident" id="3618495">netFD</span><span class="op" id="3618500">)</span>&nbsp;<span class="ident" id="3618502">connect</span><span class="op" id="3618509">(</span><span class="ident" id="3618510">la</span><span class="op" id="3618512">,</span>&nbsp;<span class="ident" id="3618514">ra</span>&nbsp;<span class="ident" id="3618517">syscall</span><span class="op" id="3618524">.</span><span class="ident" id="3618525">Sockaddr</span><span class="op" id="3618533">,</span>&nbsp;<span class="ident" id="3618535">deadline</span>&nbsp;<span class="ident" id="3618544">time</span><span class="op" id="3618548">.</span><span class="ident" id="3618549">Time</span><span class="op" id="3618553">)</span>&nbsp;<span class="builtintype" id="3618555">error</span>&nbsp;<span class="op" id="3618561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3618564">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3618607">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3618653">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618699">switch</span>&nbsp;<span class="ident" id="3618706">err</span>&nbsp;<span class="op" id="3618710">:=</span>&nbsp;<span class="ident" id="3618713">syscall</span><span class="op" id="3618720">.</span><span class="ident" id="3618721">Connect</span><span class="op" id="3618728">(</span><span class="ident" id="3618729">fd</span><span class="op" id="3618731">.</span><span class="ident" id="3618732">sysfd</span><span class="op" id="3618737">,</span>&nbsp;<span class="ident" id="3618739">ra</span><span class="op" id="3618741">)</span><span class="op" id="3618742">;</span>&nbsp;<span class="ident" id="3618744">err</span>&nbsp;<span class="op" id="3618748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618751">case</span>&nbsp;<span class="ident" id="3618756">syscall</span><span class="op" id="3618763">.</span><span class="ident" id="3618764">EINPROGRESS</span><span class="op" id="3618775">,</span>&nbsp;<span class="ident" id="3618777">syscall</span><span class="op" id="3618784">.</span><span class="ident" id="3618785">EALREADY</span><span class="op" id="3618793">,</span>&nbsp;<span class="ident" id="3618795">syscall</span><span class="op" id="3618802">.</span><span class="ident" id="3618803">EINTR</span><span class="op" id="3618808">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618811">case</span>&nbsp;<span class="ident" id="3618816">nil</span><span class="op" id="3618819">,</span>&nbsp;<span class="ident" id="3618821">syscall</span><span class="op" id="3618828">.</span><span class="ident" id="3618829">EISCONN</span><span class="op" id="3618836">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618840">if</span>&nbsp;<span class="op" id="3618843">!</span><span class="ident" id="3618844">deadline</span><span class="op" id="3618852">.</span><span class="ident" id="3618853">IsZero</span><span class="op" id="3618859">(</span><span class="op" id="3618860">)</span>&nbsp;<span class="op" id="3618862">&amp;&amp;</span>&nbsp;<span class="ident" id="3618865">deadline</span><span class="op" id="3618873">.</span><span class="ident" id="3618874">Before</span><span class="op" id="3618880">(</span><span class="ident" id="3618881">time</span><span class="op" id="3618885">.</span><span class="ident" id="3618886">Now</span><span class="op" id="3618889">(</span><span class="op" id="3618890">)</span><span class="op" id="3618891">)</span>&nbsp;<span class="op" id="3618893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618898">return</span>&nbsp;<span class="ident" id="3618905">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618922">if</span>&nbsp;<span class="ident" id="3618925">err</span>&nbsp;<span class="op" id="3618929">:=</span>&nbsp;<span class="ident" id="3618932">fd</span><span class="op" id="3618934">.</span><span class="ident" id="3618935">init</span><span class="op" id="3618939">(</span><span class="op" id="3618940">)</span><span class="op" id="3618941">;</span>&nbsp;<span class="ident" id="3618943">err</span>&nbsp;<span class="op" id="3618947">!=</span>&nbsp;<span class="ident" id="3618950">nil</span>&nbsp;<span class="op" id="3618954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618959">return</span>&nbsp;<span class="ident" id="3618966">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3618972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618976">return</span>&nbsp;<span class="ident" id="3618983">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3618988">case</span>&nbsp;<span class="ident" id="3618993">syscall</span><span class="op" id="3619000">.</span><span class="ident" id="3619001">EINVAL</span><span class="op" id="3619007">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619011">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619063">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619116">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619170">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619224">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619273">if</span>&nbsp;<span class="ident" id="3619276">runtime</span><span class="op" id="3619283">.</span><span class="ident" id="3619284">GOOS</span>&nbsp;<span class="op" id="3619289">==</span>&nbsp;<span class="string" id="3619292">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3619302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619307">return</span>&nbsp;<span class="ident" id="3619314">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3619320">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619324">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619337">default</span><span class="op" id="3619344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619348">return</span>&nbsp;<span class="ident" id="3619355">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3619360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619363">if</span>&nbsp;<span class="ident" id="3619366">err</span>&nbsp;<span class="op" id="3619370">:=</span>&nbsp;<span class="ident" id="3619373">fd</span><span class="op" id="3619375">.</span><span class="ident" id="3619376">init</span><span class="op" id="3619380">(</span><span class="op" id="3619381">)</span><span class="op" id="3619382">;</span>&nbsp;<span class="ident" id="3619384">err</span>&nbsp;<span class="op" id="3619388">!=</span>&nbsp;<span class="ident" id="3619391">nil</span>&nbsp;<span class="op" id="3619395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619399">return</span>&nbsp;<span class="ident" id="3619406">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3619411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619414">if</span>&nbsp;<span class="op" id="3619417">!</span><span class="ident" id="3619418">deadline</span><span class="op" id="3619426">.</span><span class="ident" id="3619427">IsZero</span><span class="op" id="3619433">(</span><span class="op" id="3619434">)</span>&nbsp;<span class="op" id="3619436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619440">fd</span><span class="op" id="3619442">.</span><span class="ident" id="3619443">setWriteDeadline</span><span class="op" id="3619459">(</span><span class="ident" id="3619460">deadline</span><span class="op" id="3619468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619472">defer</span>&nbsp;<span class="ident" id="3619478">fd</span><span class="op" id="3619480">.</span><span class="ident" id="3619481">setWriteDeadline</span><span class="op" id="3619497">(</span><span class="ident" id="3619498">noDeadline</span><span class="op" id="3619508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3619511">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619514">for</span>&nbsp;<span class="op" id="3619518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619522">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619573">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619627">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619675">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619731">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619786">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619839">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3619892">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619906">if</span>&nbsp;<span class="ident" id="3619909">err</span>&nbsp;<span class="op" id="3619913">:=</span>&nbsp;<span class="ident" id="3619916">fd</span><span class="op" id="3619918">.</span><span class="ident" id="3619919">pd</span><span class="op" id="3619921">.</span><span class="ident" id="3619922">WaitWrite</span><span class="op" id="3619931">(</span><span class="op" id="3619932">)</span><span class="op" id="3619933">;</span>&nbsp;<span class="ident" id="3619935">err</span>&nbsp;<span class="op" id="3619939">!=</span>&nbsp;<span class="ident" id="3619942">nil</span>&nbsp;<span class="op" id="3619946">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3619951">return</span>&nbsp;<span class="ident" id="3619958">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3619964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3619968">nerr</span><span class="op" id="3619972">,</span>&nbsp;<span class="ident" id="3619974">err</span>&nbsp;<span class="op" id="3619978">:=</span>&nbsp;<span class="ident" id="3619981">syscall</span><span class="op" id="3619988">.</span><span class="ident" id="3619989">GetsockoptInt</span><span class="op" id="3620002">(</span><span class="ident" id="3620003">fd</span><span class="op" id="3620005">.</span><span class="ident" id="3620006">sysfd</span><span class="op" id="3620011">,</span>&nbsp;<span class="ident" id="3620013">syscall</span><span class="op" id="3620020">.</span><span class="ident" id="3620021">SOL_SOCKET</span><span class="op" id="3620031">,</span>&nbsp;<span class="ident" id="3620033">syscall</span><span class="op" id="3620040">.</span><span class="ident" id="3620041">SO_ERROR</span><span class="op" id="3620049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620053">if</span>&nbsp;<span class="ident" id="3620056">err</span>&nbsp;<span class="op" id="3620060">!=</span>&nbsp;<span class="ident" id="3620063">nil</span>&nbsp;<span class="op" id="3620067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620072">return</span>&nbsp;<span class="ident" id="3620079">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3620085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620089">switch</span>&nbsp;<span class="ident" id="3620096">err</span>&nbsp;<span class="op" id="3620100">:=</span>&nbsp;<span class="ident" id="3620103">syscall</span><span class="op" id="3620110">.</span><span class="ident" id="3620111">Errno</span><span class="op" id="3620116">(</span><span class="ident" id="3620117">nerr</span><span class="op" id="3620121">)</span><span class="op" id="3620122">;</span>&nbsp;<span class="ident" id="3620124">err</span>&nbsp;<span class="op" id="3620128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620132">case</span>&nbsp;<span class="ident" id="3620137">syscall</span><span class="op" id="3620144">.</span><span class="ident" id="3620145">EINPROGRESS</span><span class="op" id="3620156">,</span>&nbsp;<span class="ident" id="3620158">syscall</span><span class="op" id="3620165">.</span><span class="ident" id="3620166">EALREADY</span><span class="op" id="3620174">,</span>&nbsp;<span class="ident" id="3620176">syscall</span><span class="op" id="3620183">.</span><span class="ident" id="3620184">EINTR</span><span class="op" id="3620189">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620193">case</span>&nbsp;<span class="ident" id="3620198">syscall</span><span class="op" id="3620205">.</span><span class="ident" id="3620206">Errno</span><span class="op" id="3620211">(</span><span class="num" id="3620212">0</span><span class="op" id="3620213">)</span><span class="op" id="3620214">,</span>&nbsp;<span class="ident" id="3620216">syscall</span><span class="op" id="3620223">.</span><span class="ident" id="3620224">EISCONN</span><span class="op" id="3620231">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620236">return</span>&nbsp;<span class="ident" id="3620243">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620249">default</span><span class="op" id="3620256">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620261">return</span>&nbsp;<span class="ident" id="3620268">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3620274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3620277">}</span><br>
<span class="lineno"></span><span class="op" id="3620279">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3620282">func</span>&nbsp;<span class="op" id="3620287">(</span><span class="ident" id="3620288">fd</span>&nbsp;<span class="op" id="3620291">*</span><span class="ident" id="3620292">netFD</span><span class="op" id="3620297">)</span>&nbsp;<span class="ident" id="3620299">destroy</span><span class="op" id="3620306">(</span><span class="op" id="3620307">)</span>&nbsp;<span class="op" id="3620309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620312">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3620386">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620435">fd</span><span class="op" id="3620437">.</span><span class="ident" id="3620438">pd</span><span class="op" id="3620440">.</span><span class="ident" id="3620441">Close</span><span class="op" id="3620446">(</span><span class="op" id="3620447">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620450">closesocket</span><span class="op" id="3620461">(</span><span class="ident" id="3620462">fd</span><span class="op" id="3620464">.</span><span class="ident" id="3620465">sysfd</span><span class="op" id="3620470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620473">fd</span><span class="op" id="3620475">.</span><span class="ident" id="3620476">sysfd</span>&nbsp;<span class="op" id="3620482">=</span>&nbsp;<span class="op" id="3620484">-</span><span class="num" id="3620485">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620488">runtime</span><span class="op" id="3620495">.</span><span class="ident" id="3620496">SetFinalizer</span><span class="op" id="3620508">(</span><span class="ident" id="3620509">fd</span><span class="op" id="3620511">,</span>&nbsp;<span class="ident" id="3620513">nil</span><span class="op" id="3620516">)</span><br>
<span class="lineno"></span><span class="op" id="3620518">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3620521">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3620552">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3620598">func</span>&nbsp;<span class="op" id="3620603">(</span><span class="ident" id="3620604">fd</span>&nbsp;<span class="op" id="3620607">*</span><span class="ident" id="3620608">netFD</span><span class="op" id="3620613">)</span>&nbsp;<span class="ident" id="3620615">incref</span><span class="op" id="3620621">(</span><span class="op" id="3620622">)</span>&nbsp;<span class="builtintype" id="3620624">error</span>&nbsp;<span class="op" id="3620630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620633">if</span>&nbsp;<span class="op" id="3620636">!</span><span class="ident" id="3620637">fd</span><span class="op" id="3620639">.</span><span class="ident" id="3620640">fdmu</span><span class="op" id="3620644">.</span><span class="ident" id="3620645">Incref</span><span class="op" id="3620651">(</span><span class="op" id="3620652">)</span>&nbsp;<span class="op" id="3620654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620658">return</span>&nbsp;<span class="ident" id="3620665">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3620677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620680">return</span>&nbsp;<span class="ident" id="3620687">nil</span><br>
<span class="lineno"></span><span class="op" id="3620691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3620694">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3620766">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3620805">func</span>&nbsp;<span class="op" id="3620810">(</span><span class="ident" id="3620811">fd</span>&nbsp;<span class="op" id="3620814">*</span><span class="ident" id="3620815">netFD</span><span class="op" id="3620820">)</span>&nbsp;<span class="ident" id="3620822">decref</span><span class="op" id="3620828">(</span><span class="op" id="3620829">)</span>&nbsp;<span class="op" id="3620831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3620834">if</span>&nbsp;<span class="ident" id="3620837">fd</span><span class="op" id="3620839">.</span><span class="ident" id="3620840">fdmu</span><span class="op" id="3620844">.</span><span class="ident" id="3620845">Decref</span><span class="op" id="3620851">(</span><span class="op" id="3620852">)</span>&nbsp;<span class="op" id="3620854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3620858">fd</span><span class="op" id="3620860">.</span><span class="ident" id="3620861">destroy</span><span class="op" id="3620868">(</span><span class="op" id="3620869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3620872">}</span><br>
<span class="lineno">155</span><span class="op" id="3620874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3620877">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3620929">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3620975">func</span>&nbsp;<span class="op" id="3620980">(</span><span class="ident" id="3620981">fd</span>&nbsp;<span class="op" id="3620984">*</span><span class="ident" id="3620985">netFD</span><span class="op" id="3620990">)</span>&nbsp;<span class="ident" id="3620992">readLock</span><span class="op" id="3621000">(</span><span class="op" id="3621001">)</span>&nbsp;<span class="builtintype" id="3621003">error</span>&nbsp;<span class="op" id="3621009">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621012">if</span>&nbsp;<span class="op" id="3621015">!</span><span class="ident" id="3621016">fd</span><span class="op" id="3621018">.</span><span class="ident" id="3621019">fdmu</span><span class="op" id="3621023">.</span><span class="ident" id="3621024">RWLock</span><span class="op" id="3621030">(</span><span class="builtintype" id="3621031">true</span><span class="op" id="3621035">)</span>&nbsp;<span class="op" id="3621037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621041">return</span>&nbsp;<span class="ident" id="3621048">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3621060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621063">return</span>&nbsp;<span class="ident" id="3621070">nil</span><br>
<span class="lineno"></span><span class="op" id="3621074">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3621077">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3621134">func</span>&nbsp;<span class="op" id="3621139">(</span><span class="ident" id="3621140">fd</span>&nbsp;<span class="op" id="3621143">*</span><span class="ident" id="3621144">netFD</span><span class="op" id="3621149">)</span>&nbsp;<span class="ident" id="3621151">readUnlock</span><span class="op" id="3621161">(</span><span class="op" id="3621162">)</span>&nbsp;<span class="op" id="3621164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621167">if</span>&nbsp;<span class="ident" id="3621170">fd</span><span class="op" id="3621172">.</span><span class="ident" id="3621173">fdmu</span><span class="op" id="3621177">.</span><span class="ident" id="3621178">RWUnlock</span><span class="op" id="3621186">(</span><span class="builtintype" id="3621187">true</span><span class="op" id="3621191">)</span>&nbsp;<span class="op" id="3621193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621197">fd</span><span class="op" id="3621199">.</span><span class="ident" id="3621200">destroy</span><span class="op" id="3621207">(</span><span class="op" id="3621208">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3621211">}</span><br>
<span class="lineno"></span><span class="op" id="3621213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3621216">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3621268">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3621314">func</span>&nbsp;<span class="op" id="3621319">(</span><span class="ident" id="3621320">fd</span>&nbsp;<span class="op" id="3621323">*</span><span class="ident" id="3621324">netFD</span><span class="op" id="3621329">)</span>&nbsp;<span class="ident" id="3621331">writeLock</span><span class="op" id="3621340">(</span><span class="op" id="3621341">)</span>&nbsp;<span class="builtintype" id="3621343">error</span>&nbsp;<span class="op" id="3621349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621352">if</span>&nbsp;<span class="op" id="3621355">!</span><span class="ident" id="3621356">fd</span><span class="op" id="3621358">.</span><span class="ident" id="3621359">fdmu</span><span class="op" id="3621363">.</span><span class="ident" id="3621364">RWLock</span><span class="op" id="3621370">(</span><span class="builtintype" id="3621371">false</span><span class="op" id="3621376">)</span>&nbsp;<span class="op" id="3621378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621382">return</span>&nbsp;<span class="ident" id="3621389">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3621401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621404">return</span>&nbsp;<span class="ident" id="3621411">nil</span><br>
<span class="lineno">180</span><span class="op" id="3621415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3621418">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3621475">func</span>&nbsp;<span class="op" id="3621480">(</span><span class="ident" id="3621481">fd</span>&nbsp;<span class="op" id="3621484">*</span><span class="ident" id="3621485">netFD</span><span class="op" id="3621490">)</span>&nbsp;<span class="ident" id="3621492">writeUnlock</span><span class="op" id="3621503">(</span><span class="op" id="3621504">)</span>&nbsp;<span class="op" id="3621506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621509">if</span>&nbsp;<span class="ident" id="3621512">fd</span><span class="op" id="3621514">.</span><span class="ident" id="3621515">fdmu</span><span class="op" id="3621519">.</span><span class="ident" id="3621520">RWUnlock</span><span class="op" id="3621528">(</span><span class="builtintype" id="3621529">false</span><span class="op" id="3621534">)</span>&nbsp;<span class="op" id="3621536">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621540">fd</span><span class="op" id="3621542">.</span><span class="ident" id="3621543">destroy</span><span class="op" id="3621550">(</span><span class="op" id="3621551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3621554">}</span><br>
<span class="lineno"></span><span class="op" id="3621556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3621559">func</span>&nbsp;<span class="op" id="3621564">(</span><span class="ident" id="3621565">fd</span>&nbsp;<span class="op" id="3621568">*</span><span class="ident" id="3621569">netFD</span><span class="op" id="3621574">)</span>&nbsp;<span class="ident" id="3621576">Close</span><span class="op" id="3621581">(</span><span class="op" id="3621582">)</span>&nbsp;<span class="builtintype" id="3621584">error</span>&nbsp;<span class="op" id="3621590">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621593">fd</span><span class="op" id="3621595">.</span><span class="ident" id="3621596">pd</span><span class="op" id="3621598">.</span><span class="ident" id="3621599">Lock</span><span class="op" id="3621603">(</span><span class="op" id="3621604">)</span>&nbsp;<span class="comment" id="3621606">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621661">if</span>&nbsp;<span class="op" id="3621664">!</span><span class="ident" id="3621665">fd</span><span class="op" id="3621667">.</span><span class="ident" id="3621668">fdmu</span><span class="op" id="3621672">.</span><span class="ident" id="3621673">IncrefAndClose</span><span class="op" id="3621687">(</span><span class="op" id="3621688">)</span>&nbsp;<span class="op" id="3621690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3621694">fd</span><span class="op" id="3621696">.</span><span class="ident" id="3621697">pd</span><span class="op" id="3621699">.</span><span class="ident" id="3621700">Unlock</span><span class="op" id="3621706">(</span><span class="op" id="3621707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3621711">return</span>&nbsp;<span class="ident" id="3621718">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3621730">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621733">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621789">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621845">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621907">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3621970">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622032">doWakeup</span>&nbsp;<span class="op" id="3622041">:=</span>&nbsp;<span class="ident" id="3622044">fd</span><span class="op" id="3622046">.</span><span class="ident" id="3622047">pd</span><span class="op" id="3622049">.</span><span class="ident" id="3622050">Evict</span><span class="op" id="3622055">(</span><span class="op" id="3622056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622059">fd</span><span class="op" id="3622061">.</span><span class="ident" id="3622062">pd</span><span class="op" id="3622064">.</span><span class="ident" id="3622065">Unlock</span><span class="op" id="3622071">(</span><span class="op" id="3622072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622075">fd</span><span class="op" id="3622077">.</span><span class="ident" id="3622078">decref</span><span class="op" id="3622084">(</span><span class="op" id="3622085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622088">if</span>&nbsp;<span class="ident" id="3622091">doWakeup</span>&nbsp;<span class="op" id="3622100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622104">fd</span><span class="op" id="3622106">.</span><span class="ident" id="3622107">pd</span><span class="op" id="3622109">.</span><span class="ident" id="3622110">Wakeup</span><span class="op" id="3622116">(</span><span class="op" id="3622117">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622123">return</span>&nbsp;<span class="ident" id="3622130">nil</span><br>
<span class="lineno"></span><span class="op" id="3622134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622137">func</span>&nbsp;<span class="op" id="3622142">(</span><span class="ident" id="3622143">fd</span>&nbsp;<span class="op" id="3622146">*</span><span class="ident" id="3622147">netFD</span><span class="op" id="3622152">)</span>&nbsp;<span class="ident" id="3622154">shutdown</span><span class="op" id="3622162">(</span><span class="ident" id="3622163">how</span>&nbsp;<span class="builtintype" id="3622167">int</span><span class="op" id="3622170">)</span>&nbsp;<span class="builtintype" id="3622172">error</span>&nbsp;<span class="op" id="3622178">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622181">if</span>&nbsp;<span class="ident" id="3622184">err</span>&nbsp;<span class="op" id="3622188">:=</span>&nbsp;<span class="ident" id="3622191">fd</span><span class="op" id="3622193">.</span><span class="ident" id="3622194">incref</span><span class="op" id="3622200">(</span><span class="op" id="3622201">)</span><span class="op" id="3622202">;</span>&nbsp;<span class="ident" id="3622204">err</span>&nbsp;<span class="op" id="3622208">!=</span>&nbsp;<span class="ident" id="3622211">nil</span>&nbsp;<span class="op" id="3622215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622219">return</span>&nbsp;<span class="ident" id="3622226">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622234">defer</span>&nbsp;<span class="ident" id="3622240">fd</span><span class="op" id="3622242">.</span><span class="ident" id="3622243">decref</span><span class="op" id="3622249">(</span><span class="op" id="3622250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622253">err</span>&nbsp;<span class="op" id="3622257">:=</span>&nbsp;<span class="ident" id="3622260">syscall</span><span class="op" id="3622267">.</span><span class="ident" id="3622268">Shutdown</span><span class="op" id="3622276">(</span><span class="ident" id="3622277">fd</span><span class="op" id="3622279">.</span><span class="ident" id="3622280">sysfd</span><span class="op" id="3622285">,</span>&nbsp;<span class="ident" id="3622287">how</span><span class="op" id="3622290">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622293">if</span>&nbsp;<span class="ident" id="3622296">err</span>&nbsp;<span class="op" id="3622300">!=</span>&nbsp;<span class="ident" id="3622303">nil</span>&nbsp;<span class="op" id="3622307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622311">return</span>&nbsp;<span class="op" id="3622318">&amp;</span><span class="ident" id="3622319">OpError</span><span class="op" id="3622326">{</span><span class="string" id="3622327">&#34;shutdown&#34;</span><span class="op" id="3622337">,</span>&nbsp;<span class="ident" id="3622339">fd</span><span class="op" id="3622341">.</span><span class="ident" id="3622342">net</span><span class="op" id="3622345">,</span>&nbsp;<span class="ident" id="3622347">fd</span><span class="op" id="3622349">.</span><span class="ident" id="3622350">laddr</span><span class="op" id="3622355">,</span>&nbsp;<span class="ident" id="3622357">err</span><span class="op" id="3622360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622366">return</span>&nbsp;<span class="ident" id="3622373">nil</span><br>
<span class="lineno"></span><span class="op" id="3622377">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3622380">func</span>&nbsp;<span class="op" id="3622385">(</span><span class="ident" id="3622386">fd</span>&nbsp;<span class="op" id="3622389">*</span><span class="ident" id="3622390">netFD</span><span class="op" id="3622395">)</span>&nbsp;<span class="ident" id="3622397">closeRead</span><span class="op" id="3622406">(</span><span class="op" id="3622407">)</span>&nbsp;<span class="builtintype" id="3622409">error</span>&nbsp;<span class="op" id="3622415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622418">return</span>&nbsp;<span class="ident" id="3622425">fd</span><span class="op" id="3622427">.</span><span class="ident" id="3622428">shutdown</span><span class="op" id="3622436">(</span><span class="ident" id="3622437">syscall</span><span class="op" id="3622444">.</span><span class="ident" id="3622445">SHUT_RD</span><span class="op" id="3622452">)</span><br>
<span class="lineno"></span><span class="op" id="3622454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3622457">func</span>&nbsp;<span class="op" id="3622462">(</span><span class="ident" id="3622463">fd</span>&nbsp;<span class="op" id="3622466">*</span><span class="ident" id="3622467">netFD</span><span class="op" id="3622472">)</span>&nbsp;<span class="ident" id="3622474">closeWrite</span><span class="op" id="3622484">(</span><span class="op" id="3622485">)</span>&nbsp;<span class="builtintype" id="3622487">error</span>&nbsp;<span class="op" id="3622493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622496">return</span>&nbsp;<span class="ident" id="3622503">fd</span><span class="op" id="3622505">.</span><span class="ident" id="3622506">shutdown</span><span class="op" id="3622514">(</span><span class="ident" id="3622515">syscall</span><span class="op" id="3622522">.</span><span class="ident" id="3622523">SHUT_WR</span><span class="op" id="3622530">)</span><br>
<span class="lineno"></span><span class="op" id="3622532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3622535">func</span>&nbsp;<span class="op" id="3622540">(</span><span class="ident" id="3622541">fd</span>&nbsp;<span class="op" id="3622544">*</span><span class="ident" id="3622545">netFD</span><span class="op" id="3622550">)</span>&nbsp;<span class="ident" id="3622552">Read</span><span class="op" id="3622556">(</span><span class="ident" id="3622557">p</span>&nbsp;<span class="op" id="3622559">[</span><span class="op" id="3622560">]</span><span class="builtintype" id="3622561">byte</span><span class="op" id="3622565">)</span>&nbsp;<span class="op" id="3622567">(</span><span class="ident" id="3622568">n</span>&nbsp;<span class="builtintype" id="3622570">int</span><span class="op" id="3622573">,</span>&nbsp;<span class="ident" id="3622575">err</span>&nbsp;<span class="builtintype" id="3622579">error</span><span class="op" id="3622584">)</span>&nbsp;<span class="op" id="3622586">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622589">if</span>&nbsp;<span class="ident" id="3622592">err</span>&nbsp;<span class="op" id="3622596">:=</span>&nbsp;<span class="ident" id="3622599">fd</span><span class="op" id="3622601">.</span><span class="ident" id="3622602">readLock</span><span class="op" id="3622610">(</span><span class="op" id="3622611">)</span><span class="op" id="3622612">;</span>&nbsp;<span class="ident" id="3622614">err</span>&nbsp;<span class="op" id="3622618">!=</span>&nbsp;<span class="ident" id="3622621">nil</span>&nbsp;<span class="op" id="3622625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622629">return</span>&nbsp;<span class="num" id="3622636">0</span><span class="op" id="3622637">,</span>&nbsp;<span class="ident" id="3622639">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622647">defer</span>&nbsp;<span class="ident" id="3622653">fd</span><span class="op" id="3622655">.</span><span class="ident" id="3622656">readUnlock</span><span class="op" id="3622666">(</span><span class="op" id="3622667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622670">if</span>&nbsp;<span class="ident" id="3622673">err</span>&nbsp;<span class="op" id="3622677">:=</span>&nbsp;<span class="ident" id="3622680">fd</span><span class="op" id="3622682">.</span><span class="ident" id="3622683">pd</span><span class="op" id="3622685">.</span><span class="ident" id="3622686">PrepareRead</span><span class="op" id="3622697">(</span><span class="op" id="3622698">)</span><span class="op" id="3622699">;</span>&nbsp;<span class="ident" id="3622701">err</span>&nbsp;<span class="op" id="3622705">!=</span>&nbsp;<span class="ident" id="3622708">nil</span>&nbsp;<span class="op" id="3622712">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622716">return</span>&nbsp;<span class="num" id="3622723">0</span><span class="op" id="3622724">,</span>&nbsp;<span class="op" id="3622726">&amp;</span><span class="ident" id="3622727">OpError</span><span class="op" id="3622734">{</span><span class="string" id="3622735">&#34;read&#34;</span><span class="op" id="3622741">,</span>&nbsp;<span class="ident" id="3622743">fd</span><span class="op" id="3622745">.</span><span class="ident" id="3622746">net</span><span class="op" id="3622749">,</span>&nbsp;<span class="ident" id="3622751">fd</span><span class="op" id="3622753">.</span><span class="ident" id="3622754">raddr</span><span class="op" id="3622759">,</span>&nbsp;<span class="ident" id="3622761">err</span><span class="op" id="3622764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622770">for</span>&nbsp;<span class="op" id="3622774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622778">n</span><span class="op" id="3622779">,</span>&nbsp;<span class="ident" id="3622781">err</span>&nbsp;<span class="op" id="3622785">=</span>&nbsp;<span class="ident" id="3622787">syscall</span><span class="op" id="3622794">.</span><span class="ident" id="3622795">Read</span><span class="op" id="3622799">(</span><span class="builtintype" id="3622800">int</span><span class="op" id="3622803">(</span><span class="ident" id="3622804">fd</span><span class="op" id="3622806">.</span><span class="ident" id="3622807">sysfd</span><span class="op" id="3622812">)</span><span class="op" id="3622813">,</span>&nbsp;<span class="ident" id="3622815">p</span><span class="op" id="3622816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622820">if</span>&nbsp;<span class="ident" id="3622823">err</span>&nbsp;<span class="op" id="3622827">!=</span>&nbsp;<span class="ident" id="3622830">nil</span>&nbsp;<span class="op" id="3622834">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622839">n</span>&nbsp;<span class="op" id="3622841">=</span>&nbsp;<span class="num" id="3622843">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622848">if</span>&nbsp;<span class="ident" id="3622851">err</span>&nbsp;<span class="op" id="3622855">==</span>&nbsp;<span class="ident" id="3622858">syscall</span><span class="op" id="3622865">.</span><span class="ident" id="3622866">EAGAIN</span>&nbsp;<span class="op" id="3622873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622879">if</span>&nbsp;<span class="ident" id="3622882">err</span>&nbsp;<span class="op" id="3622886">=</span>&nbsp;<span class="ident" id="3622888">fd</span><span class="op" id="3622890">.</span><span class="ident" id="3622891">pd</span><span class="op" id="3622893">.</span><span class="ident" id="3622894">WaitRead</span><span class="op" id="3622902">(</span><span class="op" id="3622903">)</span><span class="op" id="3622904">;</span>&nbsp;<span class="ident" id="3622906">err</span>&nbsp;<span class="op" id="3622910">==</span>&nbsp;<span class="ident" id="3622913">nil</span>&nbsp;<span class="op" id="3622917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622924">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622937">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3622950">err</span>&nbsp;<span class="op" id="3622954">=</span>&nbsp;<span class="ident" id="3622956">chkReadErr</span><span class="op" id="3622966">(</span><span class="ident" id="3622967">n</span><span class="op" id="3622968">,</span>&nbsp;<span class="ident" id="3622970">err</span><span class="op" id="3622973">,</span>&nbsp;<span class="ident" id="3622975">fd</span><span class="op" id="3622977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622981">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3622988">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3622991">if</span>&nbsp;<span class="ident" id="3622994">err</span>&nbsp;<span class="op" id="3622998">!=</span>&nbsp;<span class="ident" id="3623001">nil</span>&nbsp;<span class="op" id="3623005">&amp;&amp;</span>&nbsp;<span class="ident" id="3623008">err</span>&nbsp;<span class="op" id="3623012">!=</span>&nbsp;<span class="ident" id="3623015">io</span><span class="op" id="3623017">.</span><span class="ident" id="3623018">EOF</span>&nbsp;<span class="op" id="3623022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623026">err</span>&nbsp;<span class="op" id="3623030">=</span>&nbsp;<span class="op" id="3623032">&amp;</span><span class="ident" id="3623033">OpError</span><span class="op" id="3623040">{</span><span class="string" id="3623041">&#34;read&#34;</span><span class="op" id="3623047">,</span>&nbsp;<span class="ident" id="3623049">fd</span><span class="op" id="3623051">.</span><span class="ident" id="3623052">net</span><span class="op" id="3623055">,</span>&nbsp;<span class="ident" id="3623057">fd</span><span class="op" id="3623059">.</span><span class="ident" id="3623060">raddr</span><span class="op" id="3623065">,</span>&nbsp;<span class="ident" id="3623067">err</span><span class="op" id="3623070">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623073">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623076">return</span><br>
<span class="lineno"></span><span class="op" id="3623083">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3623086">func</span>&nbsp;<span class="op" id="3623091">(</span><span class="ident" id="3623092">fd</span>&nbsp;<span class="op" id="3623095">*</span><span class="ident" id="3623096">netFD</span><span class="op" id="3623101">)</span>&nbsp;<span class="ident" id="3623103">readFrom</span><span class="op" id="3623111">(</span><span class="ident" id="3623112">p</span>&nbsp;<span class="op" id="3623114">[</span><span class="op" id="3623115">]</span><span class="builtintype" id="3623116">byte</span><span class="op" id="3623120">)</span>&nbsp;<span class="op" id="3623122">(</span><span class="ident" id="3623123">n</span>&nbsp;<span class="builtintype" id="3623125">int</span><span class="op" id="3623128">,</span>&nbsp;<span class="ident" id="3623130">sa</span>&nbsp;<span class="ident" id="3623133">syscall</span><span class="op" id="3623140">.</span><span class="ident" id="3623141">Sockaddr</span><span class="op" id="3623149">,</span>&nbsp;<span class="ident" id="3623151">err</span>&nbsp;<span class="builtintype" id="3623155">error</span><span class="op" id="3623160">)</span>&nbsp;<span class="op" id="3623162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623165">if</span>&nbsp;<span class="ident" id="3623168">err</span>&nbsp;<span class="op" id="3623172">:=</span>&nbsp;<span class="ident" id="3623175">fd</span><span class="op" id="3623177">.</span><span class="ident" id="3623178">readLock</span><span class="op" id="3623186">(</span><span class="op" id="3623187">)</span><span class="op" id="3623188">;</span>&nbsp;<span class="ident" id="3623190">err</span>&nbsp;<span class="op" id="3623194">!=</span>&nbsp;<span class="ident" id="3623197">nil</span>&nbsp;<span class="op" id="3623201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623205">return</span>&nbsp;<span class="num" id="3623212">0</span><span class="op" id="3623213">,</span>&nbsp;<span class="ident" id="3623215">nil</span><span class="op" id="3623218">,</span>&nbsp;<span class="ident" id="3623220">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623225">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623228">defer</span>&nbsp;<span class="ident" id="3623234">fd</span><span class="op" id="3623236">.</span><span class="ident" id="3623237">readUnlock</span><span class="op" id="3623247">(</span><span class="op" id="3623248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623251">if</span>&nbsp;<span class="ident" id="3623254">err</span>&nbsp;<span class="op" id="3623258">:=</span>&nbsp;<span class="ident" id="3623261">fd</span><span class="op" id="3623263">.</span><span class="ident" id="3623264">pd</span><span class="op" id="3623266">.</span><span class="ident" id="3623267">PrepareRead</span><span class="op" id="3623278">(</span><span class="op" id="3623279">)</span><span class="op" id="3623280">;</span>&nbsp;<span class="ident" id="3623282">err</span>&nbsp;<span class="op" id="3623286">!=</span>&nbsp;<span class="ident" id="3623289">nil</span>&nbsp;<span class="op" id="3623293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623297">return</span>&nbsp;<span class="num" id="3623304">0</span><span class="op" id="3623305">,</span>&nbsp;<span class="ident" id="3623307">nil</span><span class="op" id="3623310">,</span>&nbsp;<span class="op" id="3623312">&amp;</span><span class="ident" id="3623313">OpError</span><span class="op" id="3623320">{</span><span class="string" id="3623321">&#34;read&#34;</span><span class="op" id="3623327">,</span>&nbsp;<span class="ident" id="3623329">fd</span><span class="op" id="3623331">.</span><span class="ident" id="3623332">net</span><span class="op" id="3623335">,</span>&nbsp;<span class="ident" id="3623337">fd</span><span class="op" id="3623339">.</span><span class="ident" id="3623340">laddr</span><span class="op" id="3623345">,</span>&nbsp;<span class="ident" id="3623347">err</span><span class="op" id="3623350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623356">for</span>&nbsp;<span class="op" id="3623360">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623364">n</span><span class="op" id="3623365">,</span>&nbsp;<span class="ident" id="3623367">sa</span><span class="op" id="3623369">,</span>&nbsp;<span class="ident" id="3623371">err</span>&nbsp;<span class="op" id="3623375">=</span>&nbsp;<span class="ident" id="3623377">syscall</span><span class="op" id="3623384">.</span><span class="ident" id="3623385">Recvfrom</span><span class="op" id="3623393">(</span><span class="ident" id="3623394">fd</span><span class="op" id="3623396">.</span><span class="ident" id="3623397">sysfd</span><span class="op" id="3623402">,</span>&nbsp;<span class="ident" id="3623404">p</span><span class="op" id="3623405">,</span>&nbsp;<span class="num" id="3623407">0</span><span class="op" id="3623408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623412">if</span>&nbsp;<span class="ident" id="3623415">err</span>&nbsp;<span class="op" id="3623419">!=</span>&nbsp;<span class="ident" id="3623422">nil</span>&nbsp;<span class="op" id="3623426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623431">n</span>&nbsp;<span class="op" id="3623433">=</span>&nbsp;<span class="num" id="3623435">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623440">if</span>&nbsp;<span class="ident" id="3623443">err</span>&nbsp;<span class="op" id="3623447">==</span>&nbsp;<span class="ident" id="3623450">syscall</span><span class="op" id="3623457">.</span><span class="ident" id="3623458">EAGAIN</span>&nbsp;<span class="op" id="3623465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623471">if</span>&nbsp;<span class="ident" id="3623474">err</span>&nbsp;<span class="op" id="3623478">=</span>&nbsp;<span class="ident" id="3623480">fd</span><span class="op" id="3623482">.</span><span class="ident" id="3623483">pd</span><span class="op" id="3623485">.</span><span class="ident" id="3623486">WaitRead</span><span class="op" id="3623494">(</span><span class="op" id="3623495">)</span><span class="op" id="3623496">;</span>&nbsp;<span class="ident" id="3623498">err</span>&nbsp;<span class="op" id="3623502">==</span>&nbsp;<span class="ident" id="3623505">nil</span>&nbsp;<span class="op" id="3623509">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623516">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623542">err</span>&nbsp;<span class="op" id="3623546">=</span>&nbsp;<span class="ident" id="3623548">chkReadErr</span><span class="op" id="3623558">(</span><span class="ident" id="3623559">n</span><span class="op" id="3623560">,</span>&nbsp;<span class="ident" id="3623562">err</span><span class="op" id="3623565">,</span>&nbsp;<span class="ident" id="3623567">fd</span><span class="op" id="3623569">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623573">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623583">if</span>&nbsp;<span class="ident" id="3623586">err</span>&nbsp;<span class="op" id="3623590">!=</span>&nbsp;<span class="ident" id="3623593">nil</span>&nbsp;<span class="op" id="3623597">&amp;&amp;</span>&nbsp;<span class="ident" id="3623600">err</span>&nbsp;<span class="op" id="3623604">!=</span>&nbsp;<span class="ident" id="3623607">io</span><span class="op" id="3623609">.</span><span class="ident" id="3623610">EOF</span>&nbsp;<span class="op" id="3623614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623618">err</span>&nbsp;<span class="op" id="3623622">=</span>&nbsp;<span class="op" id="3623624">&amp;</span><span class="ident" id="3623625">OpError</span><span class="op" id="3623632">{</span><span class="string" id="3623633">&#34;read&#34;</span><span class="op" id="3623639">,</span>&nbsp;<span class="ident" id="3623641">fd</span><span class="op" id="3623643">.</span><span class="ident" id="3623644">net</span><span class="op" id="3623647">,</span>&nbsp;<span class="ident" id="3623649">fd</span><span class="op" id="3623651">.</span><span class="ident" id="3623652">laddr</span><span class="op" id="3623657">,</span>&nbsp;<span class="ident" id="3623659">err</span><span class="op" id="3623662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623665">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623668">return</span><br>
<span class="lineno"></span><span class="op" id="3623675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3623678">func</span>&nbsp;<span class="op" id="3623683">(</span><span class="ident" id="3623684">fd</span>&nbsp;<span class="op" id="3623687">*</span><span class="ident" id="3623688">netFD</span><span class="op" id="3623693">)</span>&nbsp;<span class="ident" id="3623695">readMsg</span><span class="op" id="3623702">(</span><span class="ident" id="3623703">p</span>&nbsp;<span class="op" id="3623705">[</span><span class="op" id="3623706">]</span><span class="builtintype" id="3623707">byte</span><span class="op" id="3623711">,</span>&nbsp;<span class="ident" id="3623713">oob</span>&nbsp;<span class="op" id="3623717">[</span><span class="op" id="3623718">]</span><span class="builtintype" id="3623719">byte</span><span class="op" id="3623723">)</span>&nbsp;<span class="op" id="3623725">(</span><span class="ident" id="3623726">n</span><span class="op" id="3623727">,</span>&nbsp;<span class="ident" id="3623729">oobn</span><span class="op" id="3623733">,</span>&nbsp;<span class="ident" id="3623735">flags</span>&nbsp;<span class="builtintype" id="3623741">int</span><span class="op" id="3623744">,</span>&nbsp;<span class="ident" id="3623746">sa</span>&nbsp;<span class="ident" id="3623749">syscall</span><span class="op" id="3623756">.</span><span class="ident" id="3623757">Sockaddr</span><span class="op" id="3623765">,</span>&nbsp;<span class="ident" id="3623767">err</span>&nbsp;<span class="builtintype" id="3623771">error</span><span class="op" id="3623776">)</span>&nbsp;<span class="op" id="3623778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623781">if</span>&nbsp;<span class="ident" id="3623784">err</span>&nbsp;<span class="op" id="3623788">:=</span>&nbsp;<span class="ident" id="3623791">fd</span><span class="op" id="3623793">.</span><span class="ident" id="3623794">readLock</span><span class="op" id="3623802">(</span><span class="op" id="3623803">)</span><span class="op" id="3623804">;</span>&nbsp;<span class="ident" id="3623806">err</span>&nbsp;<span class="op" id="3623810">!=</span>&nbsp;<span class="ident" id="3623813">nil</span>&nbsp;<span class="op" id="3623817">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623821">return</span>&nbsp;<span class="num" id="3623828">0</span><span class="op" id="3623829">,</span>&nbsp;<span class="num" id="3623831">0</span><span class="op" id="3623832">,</span>&nbsp;<span class="num" id="3623834">0</span><span class="op" id="3623835">,</span>&nbsp;<span class="ident" id="3623837">nil</span><span class="op" id="3623840">,</span>&nbsp;<span class="ident" id="3623842">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623850">defer</span>&nbsp;<span class="ident" id="3623856">fd</span><span class="op" id="3623858">.</span><span class="ident" id="3623859">readUnlock</span><span class="op" id="3623869">(</span><span class="op" id="3623870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623873">if</span>&nbsp;<span class="ident" id="3623876">err</span>&nbsp;<span class="op" id="3623880">:=</span>&nbsp;<span class="ident" id="3623883">fd</span><span class="op" id="3623885">.</span><span class="ident" id="3623886">pd</span><span class="op" id="3623888">.</span><span class="ident" id="3623889">PrepareRead</span><span class="op" id="3623900">(</span><span class="op" id="3623901">)</span><span class="op" id="3623902">;</span>&nbsp;<span class="ident" id="3623904">err</span>&nbsp;<span class="op" id="3623908">!=</span>&nbsp;<span class="ident" id="3623911">nil</span>&nbsp;<span class="op" id="3623915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623919">return</span>&nbsp;<span class="num" id="3623926">0</span><span class="op" id="3623927">,</span>&nbsp;<span class="num" id="3623929">0</span><span class="op" id="3623930">,</span>&nbsp;<span class="num" id="3623932">0</span><span class="op" id="3623933">,</span>&nbsp;<span class="ident" id="3623935">nil</span><span class="op" id="3623938">,</span>&nbsp;<span class="op" id="3623940">&amp;</span><span class="ident" id="3623941">OpError</span><span class="op" id="3623948">{</span><span class="string" id="3623949">&#34;read&#34;</span><span class="op" id="3623955">,</span>&nbsp;<span class="ident" id="3623957">fd</span><span class="op" id="3623959">.</span><span class="ident" id="3623960">net</span><span class="op" id="3623963">,</span>&nbsp;<span class="ident" id="3623965">fd</span><span class="op" id="3623967">.</span><span class="ident" id="3623968">laddr</span><span class="op" id="3623973">,</span>&nbsp;<span class="ident" id="3623975">err</span><span class="op" id="3623978">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3623981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3623984">for</span>&nbsp;<span class="op" id="3623988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3623992">n</span><span class="op" id="3623993">,</span>&nbsp;<span class="ident" id="3623995">oobn</span><span class="op" id="3623999">,</span>&nbsp;<span class="ident" id="3624001">flags</span><span class="op" id="3624006">,</span>&nbsp;<span class="ident" id="3624008">sa</span><span class="op" id="3624010">,</span>&nbsp;<span class="ident" id="3624012">err</span>&nbsp;<span class="op" id="3624016">=</span>&nbsp;<span class="ident" id="3624018">syscall</span><span class="op" id="3624025">.</span><span class="ident" id="3624026">Recvmsg</span><span class="op" id="3624033">(</span><span class="ident" id="3624034">fd</span><span class="op" id="3624036">.</span><span class="ident" id="3624037">sysfd</span><span class="op" id="3624042">,</span>&nbsp;<span class="ident" id="3624044">p</span><span class="op" id="3624045">,</span>&nbsp;<span class="ident" id="3624047">oob</span><span class="op" id="3624050">,</span>&nbsp;<span class="num" id="3624052">0</span><span class="op" id="3624053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624057">if</span>&nbsp;<span class="ident" id="3624060">err</span>&nbsp;<span class="op" id="3624064">!=</span>&nbsp;<span class="ident" id="3624067">nil</span>&nbsp;<span class="op" id="3624071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3624076">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624122">if</span>&nbsp;<span class="ident" id="3624125">err</span>&nbsp;<span class="op" id="3624129">==</span>&nbsp;<span class="ident" id="3624132">syscall</span><span class="op" id="3624139">.</span><span class="ident" id="3624140">EAGAIN</span>&nbsp;<span class="op" id="3624147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624153">if</span>&nbsp;<span class="ident" id="3624156">err</span>&nbsp;<span class="op" id="3624160">=</span>&nbsp;<span class="ident" id="3624162">fd</span><span class="op" id="3624164">.</span><span class="ident" id="3624165">pd</span><span class="op" id="3624167">.</span><span class="ident" id="3624168">WaitRead</span><span class="op" id="3624176">(</span><span class="op" id="3624177">)</span><span class="op" id="3624178">;</span>&nbsp;<span class="ident" id="3624180">err</span>&nbsp;<span class="op" id="3624184">==</span>&nbsp;<span class="ident" id="3624187">nil</span>&nbsp;<span class="op" id="3624191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624198">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624216">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624224">err</span>&nbsp;<span class="op" id="3624228">=</span>&nbsp;<span class="ident" id="3624230">chkReadErr</span><span class="op" id="3624240">(</span><span class="ident" id="3624241">n</span><span class="op" id="3624242">,</span>&nbsp;<span class="ident" id="3624244">err</span><span class="op" id="3624247">,</span>&nbsp;<span class="ident" id="3624249">fd</span><span class="op" id="3624251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624255">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624265">if</span>&nbsp;<span class="ident" id="3624268">err</span>&nbsp;<span class="op" id="3624272">!=</span>&nbsp;<span class="ident" id="3624275">nil</span>&nbsp;<span class="op" id="3624279">&amp;&amp;</span>&nbsp;<span class="ident" id="3624282">err</span>&nbsp;<span class="op" id="3624286">!=</span>&nbsp;<span class="ident" id="3624289">io</span><span class="op" id="3624291">.</span><span class="ident" id="3624292">EOF</span>&nbsp;<span class="op" id="3624296">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624300">err</span>&nbsp;<span class="op" id="3624304">=</span>&nbsp;<span class="op" id="3624306">&amp;</span><span class="ident" id="3624307">OpError</span><span class="op" id="3624314">{</span><span class="string" id="3624315">&#34;read&#34;</span><span class="op" id="3624321">,</span>&nbsp;<span class="ident" id="3624323">fd</span><span class="op" id="3624325">.</span><span class="ident" id="3624326">net</span><span class="op" id="3624329">,</span>&nbsp;<span class="ident" id="3624331">fd</span><span class="op" id="3624333">.</span><span class="ident" id="3624334">laddr</span><span class="op" id="3624339">,</span>&nbsp;<span class="ident" id="3624341">err</span><span class="op" id="3624344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624350">return</span><br>
<span class="lineno"></span><span class="op" id="3624357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3624360">func</span>&nbsp;<span class="ident" id="3624365">chkReadErr</span><span class="op" id="3624375">(</span><span class="ident" id="3624376">n</span>&nbsp;<span class="builtintype" id="3624378">int</span><span class="op" id="3624381">,</span>&nbsp;<span class="ident" id="3624383">err</span>&nbsp;<span class="builtintype" id="3624387">error</span><span class="op" id="3624392">,</span>&nbsp;<span class="ident" id="3624394">fd</span>&nbsp;<span class="op" id="3624397">*</span><span class="ident" id="3624398">netFD</span><span class="op" id="3624403">)</span>&nbsp;<span class="builtintype" id="3624405">error</span>&nbsp;<span class="op" id="3624411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624414">if</span>&nbsp;<span class="ident" id="3624417">n</span>&nbsp;<span class="op" id="3624419">==</span>&nbsp;<span class="num" id="3624422">0</span>&nbsp;<span class="op" id="3624424">&amp;&amp;</span>&nbsp;<span class="ident" id="3624427">err</span>&nbsp;<span class="op" id="3624431">==</span>&nbsp;<span class="ident" id="3624434">nil</span>&nbsp;<span class="op" id="3624438">&amp;&amp;</span>&nbsp;<span class="ident" id="3624441">fd</span><span class="op" id="3624443">.</span><span class="ident" id="3624444">sotype</span>&nbsp;<span class="op" id="3624451">!=</span>&nbsp;<span class="ident" id="3624454">syscall</span><span class="op" id="3624461">.</span><span class="ident" id="3624462">SOCK_DGRAM</span>&nbsp;<span class="op" id="3624473">&amp;&amp;</span>&nbsp;<span class="ident" id="3624476">fd</span><span class="op" id="3624478">.</span><span class="ident" id="3624479">sotype</span>&nbsp;<span class="op" id="3624486">!=</span>&nbsp;<span class="ident" id="3624489">syscall</span><span class="op" id="3624496">.</span><span class="ident" id="3624497">SOCK_RAW</span>&nbsp;<span class="op" id="3624506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624510">return</span>&nbsp;<span class="ident" id="3624517">io</span><span class="op" id="3624519">.</span><span class="ident" id="3624520">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624528">return</span>&nbsp;<span class="ident" id="3624535">err</span><br>
<span class="lineno">315</span><span class="op" id="3624539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3624542">func</span>&nbsp;<span class="op" id="3624547">(</span><span class="ident" id="3624548">fd</span>&nbsp;<span class="op" id="3624551">*</span><span class="ident" id="3624552">netFD</span><span class="op" id="3624557">)</span>&nbsp;<span class="ident" id="3624559">Write</span><span class="op" id="3624564">(</span><span class="ident" id="3624565">p</span>&nbsp;<span class="op" id="3624567">[</span><span class="op" id="3624568">]</span><span class="builtintype" id="3624569">byte</span><span class="op" id="3624573">)</span>&nbsp;<span class="op" id="3624575">(</span><span class="ident" id="3624576">nn</span>&nbsp;<span class="builtintype" id="3624579">int</span><span class="op" id="3624582">,</span>&nbsp;<span class="ident" id="3624584">err</span>&nbsp;<span class="builtintype" id="3624588">error</span><span class="op" id="3624593">)</span>&nbsp;<span class="op" id="3624595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624598">if</span>&nbsp;<span class="ident" id="3624601">err</span>&nbsp;<span class="op" id="3624605">:=</span>&nbsp;<span class="ident" id="3624608">fd</span><span class="op" id="3624610">.</span><span class="ident" id="3624611">writeLock</span><span class="op" id="3624620">(</span><span class="op" id="3624621">)</span><span class="op" id="3624622">;</span>&nbsp;<span class="ident" id="3624624">err</span>&nbsp;<span class="op" id="3624628">!=</span>&nbsp;<span class="ident" id="3624631">nil</span>&nbsp;<span class="op" id="3624635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624639">return</span>&nbsp;<span class="num" id="3624646">0</span><span class="op" id="3624647">,</span>&nbsp;<span class="ident" id="3624649">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624657">defer</span>&nbsp;<span class="ident" id="3624663">fd</span><span class="op" id="3624665">.</span><span class="ident" id="3624666">writeUnlock</span><span class="op" id="3624677">(</span><span class="op" id="3624678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624681">if</span>&nbsp;<span class="ident" id="3624684">err</span>&nbsp;<span class="op" id="3624688">:=</span>&nbsp;<span class="ident" id="3624691">fd</span><span class="op" id="3624693">.</span><span class="ident" id="3624694">pd</span><span class="op" id="3624696">.</span><span class="ident" id="3624697">PrepareWrite</span><span class="op" id="3624709">(</span><span class="op" id="3624710">)</span><span class="op" id="3624711">;</span>&nbsp;<span class="ident" id="3624713">err</span>&nbsp;<span class="op" id="3624717">!=</span>&nbsp;<span class="ident" id="3624720">nil</span>&nbsp;<span class="op" id="3624724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624728">return</span>&nbsp;<span class="num" id="3624735">0</span><span class="op" id="3624736">,</span>&nbsp;<span class="op" id="3624738">&amp;</span><span class="ident" id="3624739">OpError</span><span class="op" id="3624746">{</span><span class="string" id="3624747">&#34;write&#34;</span><span class="op" id="3624754">,</span>&nbsp;<span class="ident" id="3624756">fd</span><span class="op" id="3624758">.</span><span class="ident" id="3624759">net</span><span class="op" id="3624762">,</span>&nbsp;<span class="ident" id="3624764">fd</span><span class="op" id="3624766">.</span><span class="ident" id="3624767">raddr</span><span class="op" id="3624772">,</span>&nbsp;<span class="ident" id="3624774">err</span><span class="op" id="3624777">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624780">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624783">for</span>&nbsp;<span class="op" id="3624787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624791">var</span>&nbsp;<span class="ident" id="3624795">n</span>&nbsp;<span class="builtintype" id="3624797">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624803">n</span><span class="op" id="3624804">,</span>&nbsp;<span class="ident" id="3624806">err</span>&nbsp;<span class="op" id="3624810">=</span>&nbsp;<span class="ident" id="3624812">syscall</span><span class="op" id="3624819">.</span><span class="ident" id="3624820">Write</span><span class="op" id="3624825">(</span><span class="builtintype" id="3624826">int</span><span class="op" id="3624829">(</span><span class="ident" id="3624830">fd</span><span class="op" id="3624832">.</span><span class="ident" id="3624833">sysfd</span><span class="op" id="3624838">)</span><span class="op" id="3624839">,</span>&nbsp;<span class="ident" id="3624841">p</span><span class="op" id="3624842">[</span><span class="ident" id="3624843">nn</span><span class="op" id="3624845">:</span><span class="op" id="3624846">]</span><span class="op" id="3624847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624851">if</span>&nbsp;<span class="ident" id="3624854">n</span>&nbsp;<span class="op" id="3624856">&gt;</span>&nbsp;<span class="num" id="3624858">0</span>&nbsp;<span class="op" id="3624860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3624865">nn</span>&nbsp;<span class="op" id="3624868">+=</span>&nbsp;<span class="ident" id="3624871">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624879">if</span>&nbsp;<span class="ident" id="3624882">nn</span>&nbsp;<span class="op" id="3624885">==</span>&nbsp;<span class="builtinfunc" id="3624888">len</span><span class="op" id="3624891">(</span><span class="ident" id="3624892">p</span><span class="op" id="3624893">)</span>&nbsp;<span class="op" id="3624895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624900">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624912">if</span>&nbsp;<span class="ident" id="3624915">err</span>&nbsp;<span class="op" id="3624919">==</span>&nbsp;<span class="ident" id="3624922">syscall</span><span class="op" id="3624929">.</span><span class="ident" id="3624930">EAGAIN</span>&nbsp;<span class="op" id="3624937">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624942">if</span>&nbsp;<span class="ident" id="3624945">err</span>&nbsp;<span class="op" id="3624949">=</span>&nbsp;<span class="ident" id="3624951">fd</span><span class="op" id="3624953">.</span><span class="ident" id="3624954">pd</span><span class="op" id="3624956">.</span><span class="ident" id="3624957">WaitWrite</span><span class="op" id="3624966">(</span><span class="op" id="3624967">)</span><span class="op" id="3624968">;</span>&nbsp;<span class="ident" id="3624970">err</span>&nbsp;<span class="op" id="3624974">==</span>&nbsp;<span class="ident" id="3624977">nil</span>&nbsp;<span class="op" id="3624981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3624987">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3624999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625007">if</span>&nbsp;<span class="ident" id="3625010">err</span>&nbsp;<span class="op" id="3625014">!=</span>&nbsp;<span class="ident" id="3625017">nil</span>&nbsp;<span class="op" id="3625021">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625026">n</span>&nbsp;<span class="op" id="3625028">=</span>&nbsp;<span class="num" id="3625030">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625035">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625047">if</span>&nbsp;<span class="ident" id="3625050">n</span>&nbsp;<span class="op" id="3625052">==</span>&nbsp;<span class="num" id="3625055">0</span>&nbsp;<span class="op" id="3625057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625062">err</span>&nbsp;<span class="op" id="3625066">=</span>&nbsp;<span class="ident" id="3625068">io</span><span class="op" id="3625070">.</span><span class="ident" id="3625071">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625091">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625102">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625105">if</span>&nbsp;<span class="ident" id="3625108">err</span>&nbsp;<span class="op" id="3625112">!=</span>&nbsp;<span class="ident" id="3625115">nil</span>&nbsp;<span class="op" id="3625119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625123">err</span>&nbsp;<span class="op" id="3625127">=</span>&nbsp;<span class="op" id="3625129">&amp;</span><span class="ident" id="3625130">OpError</span><span class="op" id="3625137">{</span><span class="string" id="3625138">&#34;write&#34;</span><span class="op" id="3625145">,</span>&nbsp;<span class="ident" id="3625147">fd</span><span class="op" id="3625149">.</span><span class="ident" id="3625150">net</span><span class="op" id="3625153">,</span>&nbsp;<span class="ident" id="3625155">fd</span><span class="op" id="3625157">.</span><span class="ident" id="3625158">raddr</span><span class="op" id="3625163">,</span>&nbsp;<span class="ident" id="3625165">err</span><span class="op" id="3625168">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625171">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625174">return</span>&nbsp;<span class="ident" id="3625181">nn</span><span class="op" id="3625183">,</span>&nbsp;<span class="ident" id="3625185">err</span><br>
<span class="lineno"></span><span class="op" id="3625189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3625192">func</span>&nbsp;<span class="op" id="3625197">(</span><span class="ident" id="3625198">fd</span>&nbsp;<span class="op" id="3625201">*</span><span class="ident" id="3625202">netFD</span><span class="op" id="3625207">)</span>&nbsp;<span class="ident" id="3625209">writeTo</span><span class="op" id="3625216">(</span><span class="ident" id="3625217">p</span>&nbsp;<span class="op" id="3625219">[</span><span class="op" id="3625220">]</span><span class="builtintype" id="3625221">byte</span><span class="op" id="3625225">,</span>&nbsp;<span class="ident" id="3625227">sa</span>&nbsp;<span class="ident" id="3625230">syscall</span><span class="op" id="3625237">.</span><span class="ident" id="3625238">Sockaddr</span><span class="op" id="3625246">)</span>&nbsp;<span class="op" id="3625248">(</span><span class="ident" id="3625249">n</span>&nbsp;<span class="builtintype" id="3625251">int</span><span class="op" id="3625254">,</span>&nbsp;<span class="ident" id="3625256">err</span>&nbsp;<span class="builtintype" id="3625260">error</span><span class="op" id="3625265">)</span>&nbsp;<span class="op" id="3625267">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625270">if</span>&nbsp;<span class="ident" id="3625273">err</span>&nbsp;<span class="op" id="3625277">:=</span>&nbsp;<span class="ident" id="3625280">fd</span><span class="op" id="3625282">.</span><span class="ident" id="3625283">writeLock</span><span class="op" id="3625292">(</span><span class="op" id="3625293">)</span><span class="op" id="3625294">;</span>&nbsp;<span class="ident" id="3625296">err</span>&nbsp;<span class="op" id="3625300">!=</span>&nbsp;<span class="ident" id="3625303">nil</span>&nbsp;<span class="op" id="3625307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625311">return</span>&nbsp;<span class="num" id="3625318">0</span><span class="op" id="3625319">,</span>&nbsp;<span class="ident" id="3625321">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625329">defer</span>&nbsp;<span class="ident" id="3625335">fd</span><span class="op" id="3625337">.</span><span class="ident" id="3625338">writeUnlock</span><span class="op" id="3625349">(</span><span class="op" id="3625350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625353">if</span>&nbsp;<span class="ident" id="3625356">err</span>&nbsp;<span class="op" id="3625360">:=</span>&nbsp;<span class="ident" id="3625363">fd</span><span class="op" id="3625365">.</span><span class="ident" id="3625366">pd</span><span class="op" id="3625368">.</span><span class="ident" id="3625369">PrepareWrite</span><span class="op" id="3625381">(</span><span class="op" id="3625382">)</span><span class="op" id="3625383">;</span>&nbsp;<span class="ident" id="3625385">err</span>&nbsp;<span class="op" id="3625389">!=</span>&nbsp;<span class="ident" id="3625392">nil</span>&nbsp;<span class="op" id="3625396">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625400">return</span>&nbsp;<span class="num" id="3625407">0</span><span class="op" id="3625408">,</span>&nbsp;<span class="op" id="3625410">&amp;</span><span class="ident" id="3625411">OpError</span><span class="op" id="3625418">{</span><span class="string" id="3625419">&#34;write&#34;</span><span class="op" id="3625426">,</span>&nbsp;<span class="ident" id="3625428">fd</span><span class="op" id="3625430">.</span><span class="ident" id="3625431">net</span><span class="op" id="3625434">,</span>&nbsp;<span class="ident" id="3625436">fd</span><span class="op" id="3625438">.</span><span class="ident" id="3625439">raddr</span><span class="op" id="3625444">,</span>&nbsp;<span class="ident" id="3625446">err</span><span class="op" id="3625449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625455">for</span>&nbsp;<span class="op" id="3625459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625463">err</span>&nbsp;<span class="op" id="3625467">=</span>&nbsp;<span class="ident" id="3625469">syscall</span><span class="op" id="3625476">.</span><span class="ident" id="3625477">Sendto</span><span class="op" id="3625483">(</span><span class="ident" id="3625484">fd</span><span class="op" id="3625486">.</span><span class="ident" id="3625487">sysfd</span><span class="op" id="3625492">,</span>&nbsp;<span class="ident" id="3625494">p</span><span class="op" id="3625495">,</span>&nbsp;<span class="num" id="3625497">0</span><span class="op" id="3625498">,</span>&nbsp;<span class="ident" id="3625500">sa</span><span class="op" id="3625502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625506">if</span>&nbsp;<span class="ident" id="3625509">err</span>&nbsp;<span class="op" id="3625513">==</span>&nbsp;<span class="ident" id="3625516">syscall</span><span class="op" id="3625523">.</span><span class="ident" id="3625524">EAGAIN</span>&nbsp;<span class="op" id="3625531">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625536">if</span>&nbsp;<span class="ident" id="3625539">err</span>&nbsp;<span class="op" id="3625543">=</span>&nbsp;<span class="ident" id="3625545">fd</span><span class="op" id="3625547">.</span><span class="ident" id="3625548">pd</span><span class="op" id="3625550">.</span><span class="ident" id="3625551">WaitWrite</span><span class="op" id="3625560">(</span><span class="op" id="3625561">)</span><span class="op" id="3625562">;</span>&nbsp;<span class="ident" id="3625564">err</span>&nbsp;<span class="op" id="3625568">==</span>&nbsp;<span class="ident" id="3625571">nil</span>&nbsp;<span class="op" id="3625575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625581">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625601">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625611">if</span>&nbsp;<span class="ident" id="3625614">err</span>&nbsp;<span class="op" id="3625618">==</span>&nbsp;<span class="ident" id="3625621">nil</span>&nbsp;<span class="op" id="3625625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625629">n</span>&nbsp;<span class="op" id="3625631">=</span>&nbsp;<span class="builtinfunc" id="3625633">len</span><span class="op" id="3625636">(</span><span class="ident" id="3625637">p</span><span class="op" id="3625638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625641">}</span>&nbsp;<span class="keyword" id="3625643">else</span>&nbsp;<span class="op" id="3625648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3625652">err</span>&nbsp;<span class="op" id="3625656">=</span>&nbsp;<span class="op" id="3625658">&amp;</span><span class="ident" id="3625659">OpError</span><span class="op" id="3625666">{</span><span class="string" id="3625667">&#34;write&#34;</span><span class="op" id="3625674">,</span>&nbsp;<span class="ident" id="3625676">fd</span><span class="op" id="3625678">.</span><span class="ident" id="3625679">net</span><span class="op" id="3625682">,</span>&nbsp;<span class="ident" id="3625684">fd</span><span class="op" id="3625686">.</span><span class="ident" id="3625687">raddr</span><span class="op" id="3625692">,</span>&nbsp;<span class="ident" id="3625694">err</span><span class="op" id="3625697">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625703">return</span><br>
<span class="lineno"></span><span class="op" id="3625710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3625713">func</span>&nbsp;<span class="op" id="3625718">(</span><span class="ident" id="3625719">fd</span>&nbsp;<span class="op" id="3625722">*</span><span class="ident" id="3625723">netFD</span><span class="op" id="3625728">)</span>&nbsp;<span class="ident" id="3625730">writeMsg</span><span class="op" id="3625738">(</span><span class="ident" id="3625739">p</span>&nbsp;<span class="op" id="3625741">[</span><span class="op" id="3625742">]</span><span class="builtintype" id="3625743">byte</span><span class="op" id="3625747">,</span>&nbsp;<span class="ident" id="3625749">oob</span>&nbsp;<span class="op" id="3625753">[</span><span class="op" id="3625754">]</span><span class="builtintype" id="3625755">byte</span><span class="op" id="3625759">,</span>&nbsp;<span class="ident" id="3625761">sa</span>&nbsp;<span class="ident" id="3625764">syscall</span><span class="op" id="3625771">.</span><span class="ident" id="3625772">Sockaddr</span><span class="op" id="3625780">)</span>&nbsp;<span class="op" id="3625782">(</span><span class="ident" id="3625783">n</span>&nbsp;<span class="builtintype" id="3625785">int</span><span class="op" id="3625788">,</span>&nbsp;<span class="ident" id="3625790">oobn</span>&nbsp;<span class="builtintype" id="3625795">int</span><span class="op" id="3625798">,</span>&nbsp;<span class="ident" id="3625800">err</span>&nbsp;<span class="builtintype" id="3625804">error</span><span class="op" id="3625809">)</span>&nbsp;<span class="op" id="3625811">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625814">if</span>&nbsp;<span class="ident" id="3625817">err</span>&nbsp;<span class="op" id="3625821">:=</span>&nbsp;<span class="ident" id="3625824">fd</span><span class="op" id="3625826">.</span><span class="ident" id="3625827">writeLock</span><span class="op" id="3625836">(</span><span class="op" id="3625837">)</span><span class="op" id="3625838">;</span>&nbsp;<span class="ident" id="3625840">err</span>&nbsp;<span class="op" id="3625844">!=</span>&nbsp;<span class="ident" id="3625847">nil</span>&nbsp;<span class="op" id="3625851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625855">return</span>&nbsp;<span class="num" id="3625862">0</span><span class="op" id="3625863">,</span>&nbsp;<span class="num" id="3625865">0</span><span class="op" id="3625866">,</span>&nbsp;<span class="ident" id="3625868">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3625873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625876">defer</span>&nbsp;<span class="ident" id="3625882">fd</span><span class="op" id="3625884">.</span><span class="ident" id="3625885">writeUnlock</span><span class="op" id="3625896">(</span><span class="op" id="3625897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625900">if</span>&nbsp;<span class="ident" id="3625903">err</span>&nbsp;<span class="op" id="3625907">:=</span>&nbsp;<span class="ident" id="3625910">fd</span><span class="op" id="3625912">.</span><span class="ident" id="3625913">pd</span><span class="op" id="3625915">.</span><span class="ident" id="3625916">PrepareWrite</span><span class="op" id="3625928">(</span><span class="op" id="3625929">)</span><span class="op" id="3625930">;</span>&nbsp;<span class="ident" id="3625932">err</span>&nbsp;<span class="op" id="3625936">!=</span>&nbsp;<span class="ident" id="3625939">nil</span>&nbsp;<span class="op" id="3625943">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3625947">return</span>&nbsp;<span class="num" id="3625954">0</span><span class="op" id="3625955">,</span>&nbsp;<span class="num" id="3625957">0</span><span class="op" id="3625958">,</span>&nbsp;<span class="op" id="3625960">&amp;</span><span class="ident" id="3625961">OpError</span><span class="op" id="3625968">{</span><span class="string" id="3625969">&#34;write&#34;</span><span class="op" id="3625976">,</span>&nbsp;<span class="ident" id="3625978">fd</span><span class="op" id="3625980">.</span><span class="ident" id="3625981">net</span><span class="op" id="3625984">,</span>&nbsp;<span class="ident" id="3625986">fd</span><span class="op" id="3625988">.</span><span class="ident" id="3625989">raddr</span><span class="op" id="3625994">,</span>&nbsp;<span class="ident" id="3625996">err</span><span class="op" id="3625999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626005">for</span>&nbsp;<span class="op" id="3626009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626013">n</span><span class="op" id="3626014">,</span>&nbsp;<span class="ident" id="3626016">err</span>&nbsp;<span class="op" id="3626020">=</span>&nbsp;<span class="ident" id="3626022">syscall</span><span class="op" id="3626029">.</span><span class="ident" id="3626030">SendmsgN</span><span class="op" id="3626038">(</span><span class="ident" id="3626039">fd</span><span class="op" id="3626041">.</span><span class="ident" id="3626042">sysfd</span><span class="op" id="3626047">,</span>&nbsp;<span class="ident" id="3626049">p</span><span class="op" id="3626050">,</span>&nbsp;<span class="ident" id="3626052">oob</span><span class="op" id="3626055">,</span>&nbsp;<span class="ident" id="3626057">sa</span><span class="op" id="3626059">,</span>&nbsp;<span class="num" id="3626061">0</span><span class="op" id="3626062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626066">if</span>&nbsp;<span class="ident" id="3626069">err</span>&nbsp;<span class="op" id="3626073">==</span>&nbsp;<span class="ident" id="3626076">syscall</span><span class="op" id="3626083">.</span><span class="ident" id="3626084">EAGAIN</span>&nbsp;<span class="op" id="3626091">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626096">if</span>&nbsp;<span class="ident" id="3626099">err</span>&nbsp;<span class="op" id="3626103">=</span>&nbsp;<span class="ident" id="3626105">fd</span><span class="op" id="3626107">.</span><span class="ident" id="3626108">pd</span><span class="op" id="3626110">.</span><span class="ident" id="3626111">WaitWrite</span><span class="op" id="3626120">(</span><span class="op" id="3626121">)</span><span class="op" id="3626122">;</span>&nbsp;<span class="ident" id="3626124">err</span>&nbsp;<span class="op" id="3626128">==</span>&nbsp;<span class="ident" id="3626131">nil</span>&nbsp;<span class="op" id="3626135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626141">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626161">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626171">if</span>&nbsp;<span class="ident" id="3626174">err</span>&nbsp;<span class="op" id="3626178">==</span>&nbsp;<span class="ident" id="3626181">nil</span>&nbsp;<span class="op" id="3626185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626189">oobn</span>&nbsp;<span class="op" id="3626194">=</span>&nbsp;<span class="builtinfunc" id="3626196">len</span><span class="op" id="3626199">(</span><span class="ident" id="3626200">oob</span><span class="op" id="3626203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626206">}</span>&nbsp;<span class="keyword" id="3626208">else</span>&nbsp;<span class="op" id="3626213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626217">err</span>&nbsp;<span class="op" id="3626221">=</span>&nbsp;<span class="op" id="3626223">&amp;</span><span class="ident" id="3626224">OpError</span><span class="op" id="3626231">{</span><span class="string" id="3626232">&#34;write&#34;</span><span class="op" id="3626239">,</span>&nbsp;<span class="ident" id="3626241">fd</span><span class="op" id="3626243">.</span><span class="ident" id="3626244">net</span><span class="op" id="3626247">,</span>&nbsp;<span class="ident" id="3626249">fd</span><span class="op" id="3626251">.</span><span class="ident" id="3626252">raddr</span><span class="op" id="3626257">,</span>&nbsp;<span class="ident" id="3626259">err</span><span class="op" id="3626262">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626268">return</span><br>
<span class="lineno"></span><span class="op" id="3626275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3626278">func</span>&nbsp;<span class="op" id="3626283">(</span><span class="ident" id="3626284">fd</span>&nbsp;<span class="op" id="3626287">*</span><span class="ident" id="3626288">netFD</span><span class="op" id="3626293">)</span>&nbsp;<span class="ident" id="3626295">accept</span><span class="op" id="3626301">(</span><span class="op" id="3626302">)</span>&nbsp;<span class="op" id="3626304">(</span><span class="ident" id="3626305">netfd</span>&nbsp;<span class="op" id="3626311">*</span><span class="ident" id="3626312">netFD</span><span class="op" id="3626317">,</span>&nbsp;<span class="ident" id="3626319">err</span>&nbsp;<span class="builtintype" id="3626323">error</span><span class="op" id="3626328">)</span>&nbsp;<span class="op" id="3626330">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626333">if</span>&nbsp;<span class="ident" id="3626336">err</span>&nbsp;<span class="op" id="3626340">:=</span>&nbsp;<span class="ident" id="3626343">fd</span><span class="op" id="3626345">.</span><span class="ident" id="3626346">readLock</span><span class="op" id="3626354">(</span><span class="op" id="3626355">)</span><span class="op" id="3626356">;</span>&nbsp;<span class="ident" id="3626358">err</span>&nbsp;<span class="op" id="3626362">!=</span>&nbsp;<span class="ident" id="3626365">nil</span>&nbsp;<span class="op" id="3626369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626373">return</span>&nbsp;<span class="ident" id="3626380">nil</span><span class="op" id="3626383">,</span>&nbsp;<span class="ident" id="3626385">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626393">defer</span>&nbsp;<span class="ident" id="3626399">fd</span><span class="op" id="3626401">.</span><span class="ident" id="3626402">readUnlock</span><span class="op" id="3626412">(</span><span class="op" id="3626413">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626417">var</span>&nbsp;<span class="ident" id="3626421">s</span>&nbsp;<span class="builtintype" id="3626423">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626428">var</span>&nbsp;<span class="ident" id="3626432">rsa</span>&nbsp;<span class="ident" id="3626436">syscall</span><span class="op" id="3626443">.</span><span class="ident" id="3626444">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626454">if</span>&nbsp;<span class="ident" id="3626457">err</span>&nbsp;<span class="op" id="3626461">=</span>&nbsp;<span class="ident" id="3626463">fd</span><span class="op" id="3626465">.</span><span class="ident" id="3626466">pd</span><span class="op" id="3626468">.</span><span class="ident" id="3626469">PrepareRead</span><span class="op" id="3626480">(</span><span class="op" id="3626481">)</span><span class="op" id="3626482">;</span>&nbsp;<span class="ident" id="3626484">err</span>&nbsp;<span class="op" id="3626488">!=</span>&nbsp;<span class="ident" id="3626491">nil</span>&nbsp;<span class="op" id="3626495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626499">return</span>&nbsp;<span class="ident" id="3626506">nil</span><span class="op" id="3626509">,</span>&nbsp;<span class="op" id="3626511">&amp;</span><span class="ident" id="3626512">OpError</span><span class="op" id="3626519">{</span><span class="string" id="3626520">&#34;accept&#34;</span><span class="op" id="3626528">,</span>&nbsp;<span class="ident" id="3626530">fd</span><span class="op" id="3626532">.</span><span class="ident" id="3626533">net</span><span class="op" id="3626536">,</span>&nbsp;<span class="ident" id="3626538">fd</span><span class="op" id="3626540">.</span><span class="ident" id="3626541">laddr</span><span class="op" id="3626546">,</span>&nbsp;<span class="ident" id="3626548">err</span><span class="op" id="3626551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626554">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626557">for</span>&nbsp;<span class="op" id="3626561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3626565">s</span><span class="op" id="3626566">,</span>&nbsp;<span class="ident" id="3626568">rsa</span><span class="op" id="3626571">,</span>&nbsp;<span class="ident" id="3626573">err</span>&nbsp;<span class="op" id="3626577">=</span>&nbsp;<span class="ident" id="3626579">accept</span><span class="op" id="3626585">(</span><span class="ident" id="3626586">fd</span><span class="op" id="3626588">.</span><span class="ident" id="3626589">sysfd</span><span class="op" id="3626594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626598">if</span>&nbsp;<span class="ident" id="3626601">err</span>&nbsp;<span class="op" id="3626605">!=</span>&nbsp;<span class="ident" id="3626608">nil</span>&nbsp;<span class="op" id="3626612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626617">if</span>&nbsp;<span class="ident" id="3626620">err</span>&nbsp;<span class="op" id="3626624">==</span>&nbsp;<span class="ident" id="3626627">syscall</span><span class="op" id="3626634">.</span><span class="ident" id="3626635">EAGAIN</span>&nbsp;<span class="op" id="3626642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626648">if</span>&nbsp;<span class="ident" id="3626651">err</span>&nbsp;<span class="op" id="3626655">=</span>&nbsp;<span class="ident" id="3626657">fd</span><span class="op" id="3626659">.</span><span class="ident" id="3626660">pd</span><span class="op" id="3626662">.</span><span class="ident" id="3626663">WaitRead</span><span class="op" id="3626671">(</span><span class="op" id="3626672">)</span><span class="op" id="3626673">;</span>&nbsp;<span class="ident" id="3626675">err</span>&nbsp;<span class="op" id="3626679">==</span>&nbsp;<span class="ident" id="3626682">nil</span>&nbsp;<span class="op" id="3626686">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626693">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626711">}</span>&nbsp;<span class="keyword" id="3626713">else</span>&nbsp;<span class="keyword" id="3626718">if</span>&nbsp;<span class="ident" id="3626721">err</span>&nbsp;<span class="op" id="3626725">==</span>&nbsp;<span class="ident" id="3626728">syscall</span><span class="op" id="3626735">.</span><span class="ident" id="3626736">ECONNABORTED</span>&nbsp;<span class="op" id="3626749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626755">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3626818">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626884">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626901">return</span>&nbsp;<span class="ident" id="3626908">nil</span><span class="op" id="3626911">,</span>&nbsp;<span class="op" id="3626913">&amp;</span><span class="ident" id="3626914">OpError</span><span class="op" id="3626921">{</span><span class="string" id="3626922">&#34;accept&#34;</span><span class="op" id="3626930">,</span>&nbsp;<span class="ident" id="3626932">fd</span><span class="op" id="3626934">.</span><span class="ident" id="3626935">net</span><span class="op" id="3626938">,</span>&nbsp;<span class="ident" id="3626940">fd</span><span class="op" id="3626942">.</span><span class="ident" id="3626943">laddr</span><span class="op" id="3626948">,</span>&nbsp;<span class="ident" id="3626950">err</span><span class="op" id="3626953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626961">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3626968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3626972">if</span>&nbsp;<span class="ident" id="3626975">netfd</span><span class="op" id="3626980">,</span>&nbsp;<span class="ident" id="3626982">err</span>&nbsp;<span class="op" id="3626986">=</span>&nbsp;<span class="ident" id="3626988">newFD</span><span class="op" id="3626993">(</span><span class="ident" id="3626994">s</span><span class="op" id="3626995">,</span>&nbsp;<span class="ident" id="3626997">fd</span><span class="op" id="3626999">.</span><span class="ident" id="3627000">family</span><span class="op" id="3627006">,</span>&nbsp;<span class="ident" id="3627008">fd</span><span class="op" id="3627010">.</span><span class="ident" id="3627011">sotype</span><span class="op" id="3627017">,</span>&nbsp;<span class="ident" id="3627019">fd</span><span class="op" id="3627021">.</span><span class="ident" id="3627022">net</span><span class="op" id="3627025">)</span><span class="op" id="3627026">;</span>&nbsp;<span class="ident" id="3627028">err</span>&nbsp;<span class="op" id="3627032">!=</span>&nbsp;<span class="ident" id="3627035">nil</span>&nbsp;<span class="op" id="3627039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627043">closesocket</span><span class="op" id="3627054">(</span><span class="ident" id="3627055">s</span><span class="op" id="3627056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627060">return</span>&nbsp;<span class="ident" id="3627067">nil</span><span class="op" id="3627070">,</span>&nbsp;<span class="ident" id="3627072">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627080">if</span>&nbsp;<span class="ident" id="3627083">err</span>&nbsp;<span class="op" id="3627087">=</span>&nbsp;<span class="ident" id="3627089">netfd</span><span class="op" id="3627094">.</span><span class="ident" id="3627095">init</span><span class="op" id="3627099">(</span><span class="op" id="3627100">)</span><span class="op" id="3627101">;</span>&nbsp;<span class="ident" id="3627103">err</span>&nbsp;<span class="op" id="3627107">!=</span>&nbsp;<span class="ident" id="3627110">nil</span>&nbsp;<span class="op" id="3627114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627118">fd</span><span class="op" id="3627120">.</span><span class="ident" id="3627121">Close</span><span class="op" id="3627126">(</span><span class="op" id="3627127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627131">return</span>&nbsp;<span class="ident" id="3627138">nil</span><span class="op" id="3627141">,</span>&nbsp;<span class="ident" id="3627143">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3627148">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627151">lsa</span><span class="op" id="3627154">,</span>&nbsp;<span class="ident" id="3627156">_</span>&nbsp;<span class="op" id="3627158">:=</span>&nbsp;<span class="ident" id="3627161">syscall</span><span class="op" id="3627168">.</span><span class="ident" id="3627169">Getsockname</span><span class="op" id="3627180">(</span><span class="ident" id="3627181">netfd</span><span class="op" id="3627186">.</span><span class="ident" id="3627187">sysfd</span><span class="op" id="3627192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627195">netfd</span><span class="op" id="3627200">.</span><span class="ident" id="3627201">setAddr</span><span class="op" id="3627208">(</span><span class="ident" id="3627209">netfd</span><span class="op" id="3627214">.</span><span class="ident" id="3627215">addrFunc</span><span class="op" id="3627223">(</span><span class="op" id="3627224">)</span><span class="op" id="3627225">(</span><span class="ident" id="3627226">lsa</span><span class="op" id="3627229">)</span><span class="op" id="3627230">,</span>&nbsp;<span class="ident" id="3627232">netfd</span><span class="op" id="3627237">.</span><span class="ident" id="3627238">addrFunc</span><span class="op" id="3627246">(</span><span class="op" id="3627247">)</span><span class="op" id="3627248">(</span><span class="ident" id="3627249">rsa</span><span class="op" id="3627252">)</span><span class="op" id="3627253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627256">return</span>&nbsp;<span class="ident" id="3627263">netfd</span><span class="op" id="3627268">,</span>&nbsp;<span class="ident" id="3627270">nil</span><br>
<span class="lineno"></span><span class="op" id="3627274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3627277">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3627344">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3627399">var</span>&nbsp;<span class="ident" id="3627403">tryDupCloexec</span>&nbsp;<span class="op" id="3627417">=</span>&nbsp;<span class="builtintype" id="3627419">int32</span><span class="op" id="3627424">(</span><span class="num" id="3627425">1</span><span class="op" id="3627426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3627429">func</span>&nbsp;<span class="ident" id="3627434">dupCloseOnExec</span><span class="op" id="3627448">(</span><span class="ident" id="3627449">fd</span>&nbsp;<span class="builtintype" id="3627452">int</span><span class="op" id="3627455">)</span>&nbsp;<span class="op" id="3627457">(</span><span class="ident" id="3627458">newfd</span>&nbsp;<span class="builtintype" id="3627464">int</span><span class="op" id="3627467">,</span>&nbsp;<span class="ident" id="3627469">err</span>&nbsp;<span class="builtintype" id="3627473">error</span><span class="op" id="3627478">)</span>&nbsp;<span class="op" id="3627480">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627483">if</span>&nbsp;<span class="ident" id="3627486">atomic</span><span class="op" id="3627492">.</span><span class="ident" id="3627493">LoadInt32</span><span class="op" id="3627502">(</span><span class="op" id="3627503">&amp;</span><span class="ident" id="3627504">tryDupCloexec</span><span class="op" id="3627517">)</span>&nbsp;<span class="op" id="3627519">==</span>&nbsp;<span class="num" id="3627522">1</span>&nbsp;<span class="op" id="3627524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3627528">r0</span><span class="op" id="3627530">,</span>&nbsp;<span class="ident" id="3627532">_</span><span class="op" id="3627533">,</span>&nbsp;<span class="ident" id="3627535">e1</span>&nbsp;<span class="op" id="3627538">:=</span>&nbsp;<span class="ident" id="3627541">syscall</span><span class="op" id="3627548">.</span><span class="ident" id="3627549">Syscall</span><span class="op" id="3627556">(</span><span class="ident" id="3627557">syscall</span><span class="op" id="3627564">.</span><span class="ident" id="3627565">SYS_FCNTL</span><span class="op" id="3627574">,</span>&nbsp;<span class="builtintype" id="3627576">uintptr</span><span class="op" id="3627583">(</span><span class="ident" id="3627584">fd</span><span class="op" id="3627586">)</span><span class="op" id="3627587">,</span>&nbsp;<span class="ident" id="3627589">syscall</span><span class="op" id="3627596">.</span><span class="ident" id="3627597">F_DUPFD_CLOEXEC</span><span class="op" id="3627612">,</span>&nbsp;<span class="num" id="3627614">0</span><span class="op" id="3627615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3627619">if</span>&nbsp;<span class="ident" id="3627622">runtime</span><span class="op" id="3627629">.</span><span class="ident" id="3627630">GOOS</span>&nbsp;<span class="op" id="3627635">==</span>&nbsp;<span class="string" id="3627638">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3627647">&amp;&amp;</span>&nbsp;<span class="ident" id="3627650">e1</span>&nbsp;<span class="op" id="3627653">==</span>&nbsp;<span class="ident" id="3627656">syscall</span><span class="op" id="3627663">.</span><span class="ident" id="3627664">EBADF</span>&nbsp;<span class="op" id="3627670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627675">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627725">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627772">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627820">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627869">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627913">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3627957">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628002">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628025">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628080">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628095">e1</span>&nbsp;<span class="op" id="3628098">=</span>&nbsp;<span class="ident" id="3628100">syscall</span><span class="op" id="3628107">.</span><span class="ident" id="3628108">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628117">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628121">switch</span>&nbsp;<span class="ident" id="3628128">e1</span>&nbsp;<span class="op" id="3628131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628135">case</span>&nbsp;<span class="num" id="3628140">0</span><span class="op" id="3628141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628146">return</span>&nbsp;<span class="builtintype" id="3628153">int</span><span class="op" id="3628156">(</span><span class="ident" id="3628157">r0</span><span class="op" id="3628159">)</span><span class="op" id="3628160">,</span>&nbsp;<span class="ident" id="3628162">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628168">case</span>&nbsp;<span class="ident" id="3628173">syscall</span><span class="op" id="3628180">.</span><span class="ident" id="3628181">EINVAL</span><span class="op" id="3628187">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628192">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628240">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628259">atomic</span><span class="op" id="3628265">.</span><span class="ident" id="3628266">StoreInt32</span><span class="op" id="3628276">(</span><span class="op" id="3628277">&amp;</span><span class="ident" id="3628278">tryDupCloexec</span><span class="op" id="3628291">,</span>&nbsp;<span class="num" id="3628293">0</span><span class="op" id="3628294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628298">default</span><span class="op" id="3628305">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628310">return</span>&nbsp;<span class="op" id="3628317">-</span><span class="num" id="3628318">1</span><span class="op" id="3628319">,</span>&nbsp;<span class="ident" id="3628321">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628326">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628332">return</span>&nbsp;<span class="ident" id="3628339">dupCloseOnExecOld</span><span class="op" id="3628356">(</span><span class="ident" id="3628357">fd</span><span class="op" id="3628359">)</span><br>
<span class="lineno"></span><span class="op" id="3628361">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3628364">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3628429">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3628479">func</span>&nbsp;<span class="ident" id="3628484">dupCloseOnExecOld</span><span class="op" id="3628501">(</span><span class="ident" id="3628502">fd</span>&nbsp;<span class="builtintype" id="3628505">int</span><span class="op" id="3628508">)</span>&nbsp;<span class="op" id="3628510">(</span><span class="ident" id="3628511">newfd</span>&nbsp;<span class="builtintype" id="3628517">int</span><span class="op" id="3628520">,</span>&nbsp;<span class="ident" id="3628522">err</span>&nbsp;<span class="builtintype" id="3628526">error</span><span class="op" id="3628531">)</span>&nbsp;<span class="op" id="3628533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628536">syscall</span><span class="op" id="3628543">.</span><span class="ident" id="3628544">ForkLock</span><span class="op" id="3628552">.</span><span class="ident" id="3628553">RLock</span><span class="op" id="3628558">(</span><span class="op" id="3628559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628562">defer</span>&nbsp;<span class="ident" id="3628568">syscall</span><span class="op" id="3628575">.</span><span class="ident" id="3628576">ForkLock</span><span class="op" id="3628584">.</span><span class="ident" id="3628585">RUnlock</span><span class="op" id="3628592">(</span><span class="op" id="3628593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628596">newfd</span><span class="op" id="3628601">,</span>&nbsp;<span class="ident" id="3628603">err</span>&nbsp;<span class="op" id="3628607">=</span>&nbsp;<span class="ident" id="3628609">syscall</span><span class="op" id="3628616">.</span><span class="ident" id="3628617">Dup</span><span class="op" id="3628620">(</span><span class="ident" id="3628621">fd</span><span class="op" id="3628623">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628626">if</span>&nbsp;<span class="ident" id="3628629">err</span>&nbsp;<span class="op" id="3628633">!=</span>&nbsp;<span class="ident" id="3628636">nil</span>&nbsp;<span class="op" id="3628640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628644">return</span>&nbsp;<span class="op" id="3628651">-</span><span class="num" id="3628652">1</span><span class="op" id="3628653">,</span>&nbsp;<span class="ident" id="3628655">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628660">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628663">syscall</span><span class="op" id="3628670">.</span><span class="ident" id="3628671">CloseOnExec</span><span class="op" id="3628682">(</span><span class="ident" id="3628683">newfd</span><span class="op" id="3628688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628691">return</span><br>
<span class="lineno">490</span><span class="op" id="3628698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3628701">func</span>&nbsp;<span class="op" id="3628706">(</span><span class="ident" id="3628707">fd</span>&nbsp;<span class="op" id="3628710">*</span><span class="ident" id="3628711">netFD</span><span class="op" id="3628716">)</span>&nbsp;<span class="ident" id="3628718">dup</span><span class="op" id="3628721">(</span><span class="op" id="3628722">)</span>&nbsp;<span class="op" id="3628724">(</span><span class="ident" id="3628725">f</span>&nbsp;<span class="op" id="3628727">*</span><span class="ident" id="3628728">os</span><span class="op" id="3628730">.</span><span class="ident" id="3628731">File</span><span class="op" id="3628735">,</span>&nbsp;<span class="ident" id="3628737">err</span>&nbsp;<span class="builtintype" id="3628741">error</span><span class="op" id="3628746">)</span>&nbsp;<span class="op" id="3628748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3628751">ns</span><span class="op" id="3628753">,</span>&nbsp;<span class="ident" id="3628755">err</span>&nbsp;<span class="op" id="3628759">:=</span>&nbsp;<span class="ident" id="3628762">dupCloseOnExec</span><span class="op" id="3628776">(</span><span class="ident" id="3628777">fd</span><span class="op" id="3628779">.</span><span class="ident" id="3628780">sysfd</span><span class="op" id="3628785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628788">if</span>&nbsp;<span class="ident" id="3628791">err</span>&nbsp;<span class="op" id="3628795">!=</span>&nbsp;<span class="ident" id="3628798">nil</span>&nbsp;<span class="op" id="3628802">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3628806">return</span>&nbsp;<span class="ident" id="3628813">nil</span><span class="op" id="3628816">,</span>&nbsp;<span class="op" id="3628818">&amp;</span><span class="ident" id="3628819">OpError</span><span class="op" id="3628826">{</span><span class="string" id="3628827">&#34;dup&#34;</span><span class="op" id="3628832">,</span>&nbsp;<span class="ident" id="3628834">fd</span><span class="op" id="3628836">.</span><span class="ident" id="3628837">net</span><span class="op" id="3628840">,</span>&nbsp;<span class="ident" id="3628842">fd</span><span class="op" id="3628844">.</span><span class="ident" id="3628845">laddr</span><span class="op" id="3628850">,</span>&nbsp;<span class="ident" id="3628852">err</span><span class="op" id="3628855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3628858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628862">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628931">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3628994">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3629068">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629124">if</span>&nbsp;<span class="ident" id="3629127">err</span>&nbsp;<span class="op" id="3629131">=</span>&nbsp;<span class="ident" id="3629133">syscall</span><span class="op" id="3629140">.</span><span class="ident" id="3629141">SetNonblock</span><span class="op" id="3629152">(</span><span class="ident" id="3629153">ns</span><span class="op" id="3629155">,</span>&nbsp;<span class="builtintype" id="3629157">false</span><span class="op" id="3629162">)</span><span class="op" id="3629163">;</span>&nbsp;<span class="ident" id="3629165">err</span>&nbsp;<span class="op" id="3629169">!=</span>&nbsp;<span class="ident" id="3629172">nil</span>&nbsp;<span class="op" id="3629176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629180">return</span>&nbsp;<span class="ident" id="3629187">nil</span><span class="op" id="3629190">,</span>&nbsp;<span class="op" id="3629192">&amp;</span><span class="ident" id="3629193">OpError</span><span class="op" id="3629200">{</span><span class="string" id="3629201">&#34;setnonblock&#34;</span><span class="op" id="3629214">,</span>&nbsp;<span class="ident" id="3629216">fd</span><span class="op" id="3629218">.</span><span class="ident" id="3629219">net</span><span class="op" id="3629222">,</span>&nbsp;<span class="ident" id="3629224">fd</span><span class="op" id="3629226">.</span><span class="ident" id="3629227">laddr</span><span class="op" id="3629232">,</span>&nbsp;<span class="ident" id="3629234">err</span><span class="op" id="3629237">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629240">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629244">return</span>&nbsp;<span class="ident" id="3629251">os</span><span class="op" id="3629253">.</span><span class="ident" id="3629254">NewFile</span><span class="op" id="3629261">(</span><span class="builtintype" id="3629262">uintptr</span><span class="op" id="3629269">(</span><span class="ident" id="3629270">ns</span><span class="op" id="3629272">)</span><span class="op" id="3629273">,</span>&nbsp;<span class="ident" id="3629275">fd</span><span class="op" id="3629277">.</span><span class="ident" id="3629278">name</span><span class="op" id="3629282">(</span><span class="op" id="3629283">)</span><span class="op" id="3629284">)</span><span class="op" id="3629285">,</span>&nbsp;<span class="ident" id="3629287">nil</span><br>
<span class="lineno"></span><span class="op" id="3629291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629294">func</span>&nbsp;<span class="ident" id="3629299">closesocket</span><span class="op" id="3629310">(</span><span class="ident" id="3629311">s</span>&nbsp;<span class="builtintype" id="3629313">int</span><span class="op" id="3629316">)</span>&nbsp;<span class="builtintype" id="3629318">error</span>&nbsp;<span class="op" id="3629324">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629327">return</span>&nbsp;<span class="ident" id="3629334">syscall</span><span class="op" id="3629341">.</span><span class="ident" id="3629342">Close</span><span class="op" id="3629347">(</span><span class="ident" id="3629348">s</span><span class="op" id="3629349">)</span><br>
<span class="lineno"></span><span class="op" id="3629351">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3629354">func</span>&nbsp;<span class="ident" id="3629359">skipRawSocketTests</span><span class="op" id="3629377">(</span><span class="op" id="3629378">)</span>&nbsp;<span class="op" id="3629380">(</span><span class="ident" id="3629381">skip</span>&nbsp;<span class="builtintype" id="3629386">bool</span><span class="op" id="3629390">,</span>&nbsp;<span class="ident" id="3629392">skipmsg</span>&nbsp;<span class="builtintype" id="3629400">string</span><span class="op" id="3629406">,</span>&nbsp;<span class="ident" id="3629408">err</span>&nbsp;<span class="builtintype" id="3629412">error</span><span class="op" id="3629417">)</span>&nbsp;<span class="op" id="3629419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629422">if</span>&nbsp;<span class="ident" id="3629425">os</span><span class="op" id="3629427">.</span><span class="ident" id="3629428">Getuid</span><span class="op" id="3629434">(</span><span class="op" id="3629435">)</span>&nbsp;<span class="op" id="3629437">!=</span>&nbsp;<span class="num" id="3629440">0</span>&nbsp;<span class="op" id="3629442">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629446">return</span>&nbsp;<span class="builtintype" id="3629453">true</span><span class="op" id="3629457">,</span>&nbsp;<span class="string" id="3629459">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3629488">,</span>&nbsp;<span class="ident" id="3629490">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3629495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3629498">return</span>&nbsp;<span class="builtintype" id="3629505">false</span><span class="op" id="3629510">,</span>&nbsp;<span class="string" id="3629512">&#34;&#34;</span><span class="op" id="3629514">,</span>&nbsp;<span class="ident" id="3629516">nil</span><br>
<span class="lineno"></span><span class="op" id="3629520">}</span>
</div>
</body>
</html>
