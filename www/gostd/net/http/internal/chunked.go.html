<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html" class="current">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4971129">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4971184">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4971238">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4971289">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4971351">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4971418">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4971440">package</span>&nbsp;<span class="ident" id="4971448">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4971458">import</span>&nbsp;<span class="op" id="4971465">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4971468">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4971477">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4971486">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4971496">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4971503">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4971508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4971511">const</span>&nbsp;<span class="ident" id="4971517">maxLineLength</span>&nbsp;<span class="op" id="4971531">=</span>&nbsp;<span class="num" id="4971533">4096</span>&nbsp;<span class="comment" id="4971538">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4971574">var</span>&nbsp;<span class="ident" id="4971578">ErrLineTooLong</span>&nbsp;<span class="op" id="4971593">=</span>&nbsp;<span class="ident" id="4971595">errors</span><span class="op" id="4971601">.</span><span class="ident" id="4971602">New</span><span class="op" id="4971605">(</span><span class="string" id="4971606">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4971628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4971631">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4971716">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4971769">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4971844">//</span><br>
<span class="lineno"></span><span class="comment" id="4971847">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4971922">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4971986">func</span>&nbsp;<span class="ident" id="4971991">NewChunkedReader</span><span class="op" id="4972007">(</span><span class="ident" id="4972008">r</span>&nbsp;<span class="ident" id="4972010">io</span><span class="op" id="4972012">.</span><span class="ident" id="4972013">Reader</span><span class="op" id="4972019">)</span>&nbsp;<span class="ident" id="4972021">io</span><span class="op" id="4972023">.</span><span class="ident" id="4972024">Reader</span>&nbsp;<span class="op" id="4972031">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972034">br</span><span class="op" id="4972036">,</span>&nbsp;<span class="ident" id="4972038">ok</span>&nbsp;<span class="op" id="4972041">:=</span>&nbsp;<span class="ident" id="4972044">r</span><span class="op" id="4972045">.</span><span class="op" id="4972046">(</span><span class="op" id="4972047">*</span><span class="ident" id="4972048">bufio</span><span class="op" id="4972053">.</span><span class="ident" id="4972054">Reader</span><span class="op" id="4972060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972063">if</span>&nbsp;<span class="op" id="4972066">!</span><span class="ident" id="4972067">ok</span>&nbsp;<span class="op" id="4972070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972074">br</span>&nbsp;<span class="op" id="4972077">=</span>&nbsp;<span class="ident" id="4972079">bufio</span><span class="op" id="4972084">.</span><span class="ident" id="4972085">NewReader</span><span class="op" id="4972094">(</span><span class="ident" id="4972095">r</span><span class="op" id="4972096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972102">return</span>&nbsp;<span class="op" id="4972109">&amp;</span><span class="ident" id="4972110">chunkedReader</span><span class="op" id="4972123">{</span><span class="ident" id="4972124">r</span><span class="op" id="4972125">:</span>&nbsp;<span class="ident" id="4972127">br</span><span class="op" id="4972129">}</span><br>
<span class="lineno">35</span><span class="op" id="4972131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972134">type</span>&nbsp;<span class="ident" id="4972139">chunkedReader</span>&nbsp;<span class="keyword" id="4972153">struct</span>&nbsp;<span class="op" id="4972160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972163">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4972167">*</span><span class="ident" id="4972168">bufio</span><span class="op" id="4972173">.</span><span class="ident" id="4972174">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972182">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4972186">uint64</span>&nbsp;<span class="comment" id="4972193">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972219">err</span>&nbsp;<span class="builtintype" id="4972223">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972230">buf</span>&nbsp;<span class="op" id="4972234">[</span><span class="num" id="4972235">2</span><span class="op" id="4972236">]</span><span class="builtintype" id="4972237">byte</span><br>
<span class="lineno"></span><span class="op" id="4972242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972245">func</span>&nbsp;<span class="op" id="4972250">(</span><span class="ident" id="4972251">cr</span>&nbsp;<span class="op" id="4972254">*</span><span class="ident" id="4972255">chunkedReader</span><span class="op" id="4972268">)</span>&nbsp;<span class="ident" id="4972270">beginChunk</span><span class="op" id="4972280">(</span><span class="op" id="4972281">)</span>&nbsp;<span class="op" id="4972283">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4972286">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972306">var</span>&nbsp;<span class="ident" id="4972310">line</span>&nbsp;<span class="op" id="4972315">[</span><span class="op" id="4972316">]</span><span class="builtintype" id="4972317">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972323">line</span><span class="op" id="4972327">,</span>&nbsp;<span class="ident" id="4972329">cr</span><span class="op" id="4972331">.</span><span class="ident" id="4972332">err</span>&nbsp;<span class="op" id="4972336">=</span>&nbsp;<span class="ident" id="4972338">readLine</span><span class="op" id="4972346">(</span><span class="ident" id="4972347">cr</span><span class="op" id="4972349">.</span><span class="ident" id="4972350">r</span><span class="op" id="4972351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972354">if</span>&nbsp;<span class="ident" id="4972357">cr</span><span class="op" id="4972359">.</span><span class="ident" id="4972360">err</span>&nbsp;<span class="op" id="4972364">!=</span>&nbsp;<span class="ident" id="4972367">nil</span>&nbsp;<span class="op" id="4972371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972375">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972386">cr</span><span class="op" id="4972388">.</span><span class="ident" id="4972389">n</span><span class="op" id="4972390">,</span>&nbsp;<span class="ident" id="4972392">cr</span><span class="op" id="4972394">.</span><span class="ident" id="4972395">err</span>&nbsp;<span class="op" id="4972399">=</span>&nbsp;<span class="ident" id="4972401">parseHexUint</span><span class="op" id="4972413">(</span><span class="ident" id="4972414">line</span><span class="op" id="4972418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972421">if</span>&nbsp;<span class="ident" id="4972424">cr</span><span class="op" id="4972426">.</span><span class="ident" id="4972427">err</span>&nbsp;<span class="op" id="4972431">!=</span>&nbsp;<span class="ident" id="4972434">nil</span>&nbsp;<span class="op" id="4972438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972442">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972450">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972453">if</span>&nbsp;<span class="ident" id="4972456">cr</span><span class="op" id="4972458">.</span><span class="ident" id="4972459">n</span>&nbsp;<span class="op" id="4972461">==</span>&nbsp;<span class="num" id="4972464">0</span>&nbsp;<span class="op" id="4972466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972470">cr</span><span class="op" id="4972472">.</span><span class="ident" id="4972473">err</span>&nbsp;<span class="op" id="4972477">=</span>&nbsp;<span class="ident" id="4972479">io</span><span class="op" id="4972481">.</span><span class="ident" id="4972482">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972487">}</span><br>
<span class="lineno"></span><span class="op" id="4972489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4972492">func</span>&nbsp;<span class="op" id="4972497">(</span><span class="ident" id="4972498">cr</span>&nbsp;<span class="op" id="4972501">*</span><span class="ident" id="4972502">chunkedReader</span><span class="op" id="4972515">)</span>&nbsp;<span class="ident" id="4972517">chunkHeaderAvailable</span><span class="op" id="4972537">(</span><span class="op" id="4972538">)</span>&nbsp;<span class="builtintype" id="4972540">bool</span>&nbsp;<span class="op" id="4972545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972548">n</span>&nbsp;<span class="op" id="4972550">:=</span>&nbsp;<span class="ident" id="4972553">cr</span><span class="op" id="4972555">.</span><span class="ident" id="4972556">r</span><span class="op" id="4972557">.</span><span class="ident" id="4972558">Buffered</span><span class="op" id="4972566">(</span><span class="op" id="4972567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972570">if</span>&nbsp;<span class="ident" id="4972573">n</span>&nbsp;<span class="op" id="4972575">&gt;</span>&nbsp;<span class="num" id="4972577">0</span>&nbsp;<span class="op" id="4972579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972583">peek</span><span class="op" id="4972587">,</span>&nbsp;<span class="ident" id="4972589">_</span>&nbsp;<span class="op" id="4972591">:=</span>&nbsp;<span class="ident" id="4972594">cr</span><span class="op" id="4972596">.</span><span class="ident" id="4972597">r</span><span class="op" id="4972598">.</span><span class="ident" id="4972599">Peek</span><span class="op" id="4972603">(</span><span class="ident" id="4972604">n</span><span class="op" id="4972605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972609">return</span>&nbsp;<span class="ident" id="4972616">bytes</span><span class="op" id="4972621">.</span><span class="ident" id="4972622">IndexByte</span><span class="op" id="4972631">(</span><span class="ident" id="4972632">peek</span><span class="op" id="4972636">,</span>&nbsp;<span class="string" id="4972638">&#39;\n&#39;</span><span class="op" id="4972642">)</span>&nbsp;<span class="op" id="4972644">&gt;=</span>&nbsp;<span class="num" id="4972647">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972650">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972653">return</span>&nbsp;<span class="builtintype" id="4972660">false</span><br>
<span class="lineno"></span><span class="op" id="4972666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4972669">func</span>&nbsp;<span class="op" id="4972674">(</span><span class="ident" id="4972675">cr</span>&nbsp;<span class="op" id="4972678">*</span><span class="ident" id="4972679">chunkedReader</span><span class="op" id="4972692">)</span>&nbsp;<span class="ident" id="4972694">Read</span><span class="op" id="4972698">(</span><span class="ident" id="4972699">b</span>&nbsp;<span class="op" id="4972701">[</span><span class="op" id="4972702">]</span><span class="builtintype" id="4972703">uint8</span><span class="op" id="4972708">)</span>&nbsp;<span class="op" id="4972710">(</span><span class="ident" id="4972711">n</span>&nbsp;<span class="builtintype" id="4972713">int</span><span class="op" id="4972716">,</span>&nbsp;<span class="ident" id="4972718">err</span>&nbsp;<span class="builtintype" id="4972722">error</span><span class="op" id="4972727">)</span>&nbsp;<span class="op" id="4972729">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972732">for</span>&nbsp;<span class="ident" id="4972736">cr</span><span class="op" id="4972738">.</span><span class="ident" id="4972739">err</span>&nbsp;<span class="op" id="4972743">==</span>&nbsp;<span class="ident" id="4972746">nil</span>&nbsp;<span class="op" id="4972750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972754">if</span>&nbsp;<span class="ident" id="4972757">cr</span><span class="op" id="4972759">.</span><span class="ident" id="4972760">n</span>&nbsp;<span class="op" id="4972762">==</span>&nbsp;<span class="num" id="4972765">0</span>&nbsp;<span class="op" id="4972767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972772">if</span>&nbsp;<span class="ident" id="4972775">n</span>&nbsp;<span class="op" id="4972777">&gt;</span>&nbsp;<span class="num" id="4972779">0</span>&nbsp;<span class="op" id="4972781">&amp;&amp;</span>&nbsp;<span class="op" id="4972784">!</span><span class="ident" id="4972785">cr</span><span class="op" id="4972787">.</span><span class="ident" id="4972788">chunkHeaderAvailable</span><span class="op" id="4972808">(</span><span class="op" id="4972809">)</span>&nbsp;<span class="op" id="4972811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4972817">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4972867">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972902">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972916">cr</span><span class="op" id="4972918">.</span><span class="ident" id="4972919">beginChunk</span><span class="op" id="4972929">(</span><span class="op" id="4972930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972935">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972946">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972950">if</span>&nbsp;<span class="builtinfunc" id="4972953">len</span><span class="op" id="4972956">(</span><span class="ident" id="4972957">b</span><span class="op" id="4972958">)</span>&nbsp;<span class="op" id="4972960">==</span>&nbsp;<span class="num" id="4972963">0</span>&nbsp;<span class="op" id="4972965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972970">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4972978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4972982">rbuf</span>&nbsp;<span class="op" id="4972987">:=</span>&nbsp;<span class="ident" id="4972990">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4972994">if</span>&nbsp;<span class="ident" id="4972997">uint64</span><span class="op" id="4973003">(</span><span class="builtinfunc" id="4973004">len</span><span class="op" id="4973007">(</span><span class="ident" id="4973008">rbuf</span><span class="op" id="4973012">)</span><span class="op" id="4973013">)</span>&nbsp;<span class="op" id="4973015">&gt;</span>&nbsp;<span class="ident" id="4973017">cr</span><span class="op" id="4973019">.</span><span class="ident" id="4973020">n</span>&nbsp;<span class="op" id="4973022">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973027">rbuf</span>&nbsp;<span class="op" id="4973032">=</span>&nbsp;<span class="ident" id="4973034">rbuf</span><span class="op" id="4973038">[</span><span class="op" id="4973039">:</span><span class="ident" id="4973040">cr</span><span class="op" id="4973042">.</span><span class="ident" id="4973043">n</span><span class="op" id="4973044">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973052">var</span>&nbsp;<span class="ident" id="4973056">n0</span>&nbsp;<span class="builtintype" id="4973059">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973065">n0</span><span class="op" id="4973067">,</span>&nbsp;<span class="ident" id="4973069">cr</span><span class="op" id="4973071">.</span><span class="ident" id="4973072">err</span>&nbsp;<span class="op" id="4973076">=</span>&nbsp;<span class="ident" id="4973078">cr</span><span class="op" id="4973080">.</span><span class="ident" id="4973081">r</span><span class="op" id="4973082">.</span><span class="ident" id="4973083">Read</span><span class="op" id="4973087">(</span><span class="ident" id="4973088">rbuf</span><span class="op" id="4973092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973096">n</span>&nbsp;<span class="op" id="4973098">+=</span>&nbsp;<span class="ident" id="4973101">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973106">b</span>&nbsp;<span class="op" id="4973108">=</span>&nbsp;<span class="ident" id="4973110">b</span><span class="op" id="4973111">[</span><span class="ident" id="4973112">n0</span><span class="op" id="4973114">:</span><span class="op" id="4973115">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973119">cr</span><span class="op" id="4973121">.</span><span class="ident" id="4973122">n</span>&nbsp;<span class="op" id="4973124">-=</span>&nbsp;<span class="ident" id="4973127">uint64</span><span class="op" id="4973133">(</span><span class="ident" id="4973134">n0</span><span class="op" id="4973136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4973140">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4973195">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973233">if</span>&nbsp;<span class="ident" id="4973236">cr</span><span class="op" id="4973238">.</span><span class="ident" id="4973239">n</span>&nbsp;<span class="op" id="4973241">==</span>&nbsp;<span class="num" id="4973244">0</span>&nbsp;<span class="op" id="4973246">&amp;&amp;</span>&nbsp;<span class="ident" id="4973249">cr</span><span class="op" id="4973251">.</span><span class="ident" id="4973252">err</span>&nbsp;<span class="op" id="4973256">==</span>&nbsp;<span class="ident" id="4973259">nil</span>&nbsp;<span class="op" id="4973263">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973268">if</span>&nbsp;<span class="ident" id="4973271">_</span><span class="op" id="4973272">,</span>&nbsp;<span class="ident" id="4973274">cr</span><span class="op" id="4973276">.</span><span class="ident" id="4973277">err</span>&nbsp;<span class="op" id="4973281">=</span>&nbsp;<span class="ident" id="4973283">io</span><span class="op" id="4973285">.</span><span class="ident" id="4973286">ReadFull</span><span class="op" id="4973294">(</span><span class="ident" id="4973295">cr</span><span class="op" id="4973297">.</span><span class="ident" id="4973298">r</span><span class="op" id="4973299">,</span>&nbsp;<span class="ident" id="4973301">cr</span><span class="op" id="4973303">.</span><span class="ident" id="4973304">buf</span><span class="op" id="4973307">[</span><span class="op" id="4973308">:</span><span class="num" id="4973309">2</span><span class="op" id="4973310">]</span><span class="op" id="4973311">)</span><span class="op" id="4973312">;</span>&nbsp;<span class="ident" id="4973314">cr</span><span class="op" id="4973316">.</span><span class="ident" id="4973317">err</span>&nbsp;<span class="op" id="4973321">==</span>&nbsp;<span class="ident" id="4973324">nil</span>&nbsp;<span class="op" id="4973328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973334">if</span>&nbsp;<span class="ident" id="4973337">cr</span><span class="op" id="4973339">.</span><span class="ident" id="4973340">buf</span><span class="op" id="4973343">[</span><span class="num" id="4973344">0</span><span class="op" id="4973345">]</span>&nbsp;<span class="op" id="4973347">!=</span>&nbsp;<span class="string" id="4973350">&#39;\r&#39;</span>&nbsp;<span class="op" id="4973355">||</span>&nbsp;<span class="ident" id="4973358">cr</span><span class="op" id="4973360">.</span><span class="ident" id="4973361">buf</span><span class="op" id="4973364">[</span><span class="num" id="4973365">1</span><span class="op" id="4973366">]</span>&nbsp;<span class="op" id="4973368">!=</span>&nbsp;<span class="string" id="4973371">&#39;\n&#39;</span>&nbsp;<span class="op" id="4973376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973383">cr</span><span class="op" id="4973385">.</span><span class="ident" id="4973386">err</span>&nbsp;<span class="op" id="4973390">=</span>&nbsp;<span class="ident" id="4973392">errors</span><span class="op" id="4973398">.</span><span class="ident" id="4973399">New</span><span class="op" id="4973402">(</span><span class="string" id="4973403">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4973431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973437">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973442">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973452">return</span>&nbsp;<span class="ident" id="4973459">n</span><span class="op" id="4973460">,</span>&nbsp;<span class="ident" id="4973462">cr</span><span class="op" id="4973464">.</span><span class="ident" id="4973465">err</span><br>
<span class="lineno"></span><span class="op" id="4973469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4973472">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4973515">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4973561">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4973613">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4973677">func</span>&nbsp;<span class="ident" id="4973682">readLine</span><span class="op" id="4973690">(</span><span class="ident" id="4973691">b</span>&nbsp;<span class="op" id="4973693">*</span><span class="ident" id="4973694">bufio</span><span class="op" id="4973699">.</span><span class="ident" id="4973700">Reader</span><span class="op" id="4973706">)</span>&nbsp;<span class="op" id="4973708">(</span><span class="ident" id="4973709">p</span>&nbsp;<span class="op" id="4973711">[</span><span class="op" id="4973712">]</span><span class="builtintype" id="4973713">byte</span><span class="op" id="4973717">,</span>&nbsp;<span class="ident" id="4973719">err</span>&nbsp;<span class="builtintype" id="4973723">error</span><span class="op" id="4973728">)</span>&nbsp;<span class="op" id="4973730">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973733">if</span>&nbsp;<span class="ident" id="4973736">p</span><span class="op" id="4973737">,</span>&nbsp;<span class="ident" id="4973739">err</span>&nbsp;<span class="op" id="4973743">=</span>&nbsp;<span class="ident" id="4973745">b</span><span class="op" id="4973746">.</span><span class="ident" id="4973747">ReadSlice</span><span class="op" id="4973756">(</span><span class="string" id="4973757">&#39;\n&#39;</span><span class="op" id="4973761">)</span><span class="op" id="4973762">;</span>&nbsp;<span class="ident" id="4973764">err</span>&nbsp;<span class="op" id="4973768">!=</span>&nbsp;<span class="ident" id="4973771">nil</span>&nbsp;<span class="op" id="4973775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4973779">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4973819">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973880">if</span>&nbsp;<span class="ident" id="4973883">err</span>&nbsp;<span class="op" id="4973887">==</span>&nbsp;<span class="ident" id="4973890">io</span><span class="op" id="4973892">.</span><span class="ident" id="4973893">EOF</span>&nbsp;<span class="op" id="4973897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973902">err</span>&nbsp;<span class="op" id="4973906">=</span>&nbsp;<span class="ident" id="4973908">io</span><span class="op" id="4973910">.</span><span class="ident" id="4973911">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973930">}</span>&nbsp;<span class="keyword" id="4973932">else</span>&nbsp;<span class="keyword" id="4973937">if</span>&nbsp;<span class="ident" id="4973940">err</span>&nbsp;<span class="op" id="4973944">==</span>&nbsp;<span class="ident" id="4973947">bufio</span><span class="op" id="4973952">.</span><span class="ident" id="4973953">ErrBufferFull</span>&nbsp;<span class="op" id="4973967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4973972">err</span>&nbsp;<span class="op" id="4973976">=</span>&nbsp;<span class="ident" id="4973978">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4973995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4973999">return</span>&nbsp;<span class="ident" id="4974006">nil</span><span class="op" id="4974009">,</span>&nbsp;<span class="ident" id="4974011">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4974016">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974019">if</span>&nbsp;<span class="builtinfunc" id="4974022">len</span><span class="op" id="4974025">(</span><span class="ident" id="4974026">p</span><span class="op" id="4974027">)</span>&nbsp;<span class="op" id="4974029">&gt;=</span>&nbsp;<span class="ident" id="4974032">maxLineLength</span>&nbsp;<span class="op" id="4974046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974050">return</span>&nbsp;<span class="ident" id="4974057">nil</span><span class="op" id="4974060">,</span>&nbsp;<span class="ident" id="4974062">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4974078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974081">return</span>&nbsp;<span class="ident" id="4974088">trimTrailingWhitespace</span><span class="op" id="4974110">(</span><span class="ident" id="4974111">p</span><span class="op" id="4974112">)</span><span class="op" id="4974113">,</span>&nbsp;<span class="ident" id="4974115">nil</span><br>
<span class="lineno"></span><span class="op" id="4974119">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4974122">func</span>&nbsp;<span class="ident" id="4974127">trimTrailingWhitespace</span><span class="op" id="4974149">(</span><span class="ident" id="4974150">b</span>&nbsp;<span class="op" id="4974152">[</span><span class="op" id="4974153">]</span><span class="builtintype" id="4974154">byte</span><span class="op" id="4974158">)</span>&nbsp;<span class="op" id="4974160">[</span><span class="op" id="4974161">]</span><span class="builtintype" id="4974162">byte</span>&nbsp;<span class="op" id="4974167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974170">for</span>&nbsp;<span class="builtinfunc" id="4974174">len</span><span class="op" id="4974177">(</span><span class="ident" id="4974178">b</span><span class="op" id="4974179">)</span>&nbsp;<span class="op" id="4974181">&gt;</span>&nbsp;<span class="num" id="4974183">0</span>&nbsp;<span class="op" id="4974185">&amp;&amp;</span>&nbsp;<span class="ident" id="4974188">isASCIISpace</span><span class="op" id="4974200">(</span><span class="ident" id="4974201">b</span><span class="op" id="4974202">[</span><span class="builtinfunc" id="4974203">len</span><span class="op" id="4974206">(</span><span class="ident" id="4974207">b</span><span class="op" id="4974208">)</span><span class="op" id="4974209">-</span><span class="num" id="4974210">1</span><span class="op" id="4974211">]</span><span class="op" id="4974212">)</span>&nbsp;<span class="op" id="4974214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4974218">b</span>&nbsp;<span class="op" id="4974220">=</span>&nbsp;<span class="ident" id="4974222">b</span><span class="op" id="4974223">[</span><span class="op" id="4974224">:</span><span class="builtinfunc" id="4974225">len</span><span class="op" id="4974228">(</span><span class="ident" id="4974229">b</span><span class="op" id="4974230">)</span><span class="op" id="4974231">-</span><span class="num" id="4974232">1</span><span class="op" id="4974233">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4974236">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974239">return</span>&nbsp;<span class="ident" id="4974246">b</span><br>
<span class="lineno"></span><span class="op" id="4974248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4974251">func</span>&nbsp;<span class="ident" id="4974256">isASCIISpace</span><span class="op" id="4974268">(</span><span class="ident" id="4974269">b</span>&nbsp;<span class="builtintype" id="4974271">byte</span><span class="op" id="4974275">)</span>&nbsp;<span class="builtintype" id="4974277">bool</span>&nbsp;<span class="op" id="4974282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974285">return</span>&nbsp;<span class="ident" id="4974292">b</span>&nbsp;<span class="op" id="4974294">==</span>&nbsp;<span class="string" id="4974297">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4974301">||</span>&nbsp;<span class="ident" id="4974304">b</span>&nbsp;<span class="op" id="4974306">==</span>&nbsp;<span class="string" id="4974309">&#39;\t&#39;</span>&nbsp;<span class="op" id="4974314">||</span>&nbsp;<span class="ident" id="4974317">b</span>&nbsp;<span class="op" id="4974319">==</span>&nbsp;<span class="string" id="4974322">&#39;\n&#39;</span>&nbsp;<span class="op" id="4974327">||</span>&nbsp;<span class="ident" id="4974330">b</span>&nbsp;<span class="op" id="4974332">==</span>&nbsp;<span class="string" id="4974335">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4974340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4974343">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4974424">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4974505">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4974573">//</span><br>
<span class="lineno"></span><span class="comment" id="4974576">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4974643">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4974706">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4974772">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4974841">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4974877">func</span>&nbsp;<span class="ident" id="4974882">NewChunkedWriter</span><span class="op" id="4974898">(</span><span class="ident" id="4974899">w</span>&nbsp;<span class="ident" id="4974901">io</span><span class="op" id="4974903">.</span><span class="ident" id="4974904">Writer</span><span class="op" id="4974910">)</span>&nbsp;<span class="ident" id="4974912">io</span><span class="op" id="4974914">.</span><span class="ident" id="4974915">WriteCloser</span>&nbsp;<span class="op" id="4974927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4974930">return</span>&nbsp;<span class="op" id="4974937">&amp;</span><span class="ident" id="4974938">chunkedWriter</span><span class="op" id="4974951">{</span><span class="ident" id="4974952">w</span><span class="op" id="4974953">}</span><br>
<span class="lineno"></span><span class="op" id="4974955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4974958">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4975033">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4975095">type</span>&nbsp;<span class="ident" id="4975100">chunkedWriter</span>&nbsp;<span class="keyword" id="4975114">struct</span>&nbsp;<span class="op" id="4975121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4975124">Wire</span>&nbsp;<span class="ident" id="4975129">io</span><span class="op" id="4975131">.</span><span class="ident" id="4975132">Writer</span><br>
<span class="lineno"></span><span class="op" id="4975139">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4975142">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4975194">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4975273">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4975336">func</span>&nbsp;<span class="op" id="4975341">(</span><span class="ident" id="4975342">cw</span>&nbsp;<span class="op" id="4975345">*</span><span class="ident" id="4975346">chunkedWriter</span><span class="op" id="4975359">)</span>&nbsp;<span class="ident" id="4975361">Write</span><span class="op" id="4975366">(</span><span class="ident" id="4975367">data</span>&nbsp;<span class="op" id="4975372">[</span><span class="op" id="4975373">]</span><span class="builtintype" id="4975374">byte</span><span class="op" id="4975378">)</span>&nbsp;<span class="op" id="4975380">(</span><span class="ident" id="4975381">n</span>&nbsp;<span class="builtintype" id="4975383">int</span><span class="op" id="4975386">,</span>&nbsp;<span class="ident" id="4975388">err</span>&nbsp;<span class="builtintype" id="4975392">error</span><span class="op" id="4975397">)</span>&nbsp;<span class="op" id="4975399">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4975403">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975473">if</span>&nbsp;<span class="builtinfunc" id="4975476">len</span><span class="op" id="4975479">(</span><span class="ident" id="4975480">data</span><span class="op" id="4975484">)</span>&nbsp;<span class="op" id="4975486">==</span>&nbsp;<span class="num" id="4975489">0</span>&nbsp;<span class="op" id="4975491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975495">return</span>&nbsp;<span class="num" id="4975502">0</span><span class="op" id="4975503">,</span>&nbsp;<span class="ident" id="4975505">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4975510">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975514">if</span>&nbsp;<span class="ident" id="4975517">_</span><span class="op" id="4975518">,</span>&nbsp;<span class="ident" id="4975520">err</span>&nbsp;<span class="op" id="4975524">=</span>&nbsp;<span class="ident" id="4975526">fmt</span><span class="op" id="4975529">.</span><span class="ident" id="4975530">Fprintf</span><span class="op" id="4975537">(</span><span class="ident" id="4975538">cw</span><span class="op" id="4975540">.</span><span class="ident" id="4975541">Wire</span><span class="op" id="4975545">,</span>&nbsp;<span class="string" id="4975547">&#34;%x\r\n&#34;</span><span class="op" id="4975555">,</span>&nbsp;<span class="builtinfunc" id="4975557">len</span><span class="op" id="4975560">(</span><span class="ident" id="4975561">data</span><span class="op" id="4975565">)</span><span class="op" id="4975566">)</span><span class="op" id="4975567">;</span>&nbsp;<span class="ident" id="4975569">err</span>&nbsp;<span class="op" id="4975573">!=</span>&nbsp;<span class="ident" id="4975576">nil</span>&nbsp;<span class="op" id="4975580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975584">return</span>&nbsp;<span class="num" id="4975591">0</span><span class="op" id="4975592">,</span>&nbsp;<span class="ident" id="4975594">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4975599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975602">if</span>&nbsp;<span class="ident" id="4975605">n</span><span class="op" id="4975606">,</span>&nbsp;<span class="ident" id="4975608">err</span>&nbsp;<span class="op" id="4975612">=</span>&nbsp;<span class="ident" id="4975614">cw</span><span class="op" id="4975616">.</span><span class="ident" id="4975617">Wire</span><span class="op" id="4975621">.</span><span class="ident" id="4975622">Write</span><span class="op" id="4975627">(</span><span class="ident" id="4975628">data</span><span class="op" id="4975632">)</span><span class="op" id="4975633">;</span>&nbsp;<span class="ident" id="4975635">err</span>&nbsp;<span class="op" id="4975639">!=</span>&nbsp;<span class="ident" id="4975642">nil</span>&nbsp;<span class="op" id="4975646">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975650">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4975658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975661">if</span>&nbsp;<span class="ident" id="4975664">n</span>&nbsp;<span class="op" id="4975666">!=</span>&nbsp;<span class="builtinfunc" id="4975669">len</span><span class="op" id="4975672">(</span><span class="ident" id="4975673">data</span><span class="op" id="4975677">)</span>&nbsp;<span class="op" id="4975679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4975683">err</span>&nbsp;<span class="op" id="4975687">=</span>&nbsp;<span class="ident" id="4975689">io</span><span class="op" id="4975691">.</span><span class="ident" id="4975692">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975708">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4975716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4975719">_</span><span class="op" id="4975720">,</span>&nbsp;<span class="ident" id="4975722">err</span>&nbsp;<span class="op" id="4975726">=</span>&nbsp;<span class="ident" id="4975728">io</span><span class="op" id="4975730">.</span><span class="ident" id="4975731">WriteString</span><span class="op" id="4975742">(</span><span class="ident" id="4975743">cw</span><span class="op" id="4975745">.</span><span class="ident" id="4975746">Wire</span><span class="op" id="4975750">,</span>&nbsp;<span class="string" id="4975752">&#34;\r\n&#34;</span><span class="op" id="4975758">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975762">return</span><br>
<span class="lineno"></span><span class="op" id="4975769">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4975772">func</span>&nbsp;<span class="op" id="4975777">(</span><span class="ident" id="4975778">cw</span>&nbsp;<span class="op" id="4975781">*</span><span class="ident" id="4975782">chunkedWriter</span><span class="op" id="4975795">)</span>&nbsp;<span class="ident" id="4975797">Close</span><span class="op" id="4975802">(</span><span class="op" id="4975803">)</span>&nbsp;<span class="builtintype" id="4975805">error</span>&nbsp;<span class="op" id="4975811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4975814">_</span><span class="op" id="4975815">,</span>&nbsp;<span class="ident" id="4975817">err</span>&nbsp;<span class="op" id="4975821">:=</span>&nbsp;<span class="ident" id="4975824">io</span><span class="op" id="4975826">.</span><span class="ident" id="4975827">WriteString</span><span class="op" id="4975838">(</span><span class="ident" id="4975839">cw</span><span class="op" id="4975841">.</span><span class="ident" id="4975842">Wire</span><span class="op" id="4975846">,</span>&nbsp;<span class="string" id="4975848">&#34;0\r\n&#34;</span><span class="op" id="4975855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975858">return</span>&nbsp;<span class="ident" id="4975865">err</span><br>
<span class="lineno"></span><span class="op" id="4975869">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4975872">func</span>&nbsp;<span class="ident" id="4975877">parseHexUint</span><span class="op" id="4975889">(</span><span class="ident" id="4975890">v</span>&nbsp;<span class="op" id="4975892">[</span><span class="op" id="4975893">]</span><span class="builtintype" id="4975894">byte</span><span class="op" id="4975898">)</span>&nbsp;<span class="op" id="4975900">(</span><span class="ident" id="4975901">n</span>&nbsp;<span class="ident" id="4975903">uint64</span><span class="op" id="4975909">,</span>&nbsp;<span class="ident" id="4975911">err</span>&nbsp;<span class="builtintype" id="4975915">error</span><span class="op" id="4975920">)</span>&nbsp;<span class="op" id="4975922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975925">for</span>&nbsp;<span class="ident" id="4975929">_</span><span class="op" id="4975930">,</span>&nbsp;<span class="ident" id="4975932">b</span>&nbsp;<span class="op" id="4975934">:=</span>&nbsp;<span class="keyword" id="4975937">range</span>&nbsp;<span class="ident" id="4975943">v</span>&nbsp;<span class="op" id="4975945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4975949">n</span>&nbsp;<span class="op" id="4975951">&lt;&lt;=</span>&nbsp;<span class="num" id="4975955">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975959">switch</span>&nbsp;<span class="op" id="4975966">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4975970">case</span>&nbsp;<span class="string" id="4975975">&#39;0&#39;</span>&nbsp;<span class="op" id="4975979">&lt;=</span>&nbsp;<span class="ident" id="4975982">b</span>&nbsp;<span class="op" id="4975984">&amp;&amp;</span>&nbsp;<span class="ident" id="4975987">b</span>&nbsp;<span class="op" id="4975989">&lt;=</span>&nbsp;<span class="string" id="4975992">&#39;9&#39;</span><span class="op" id="4975995">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4976000">b</span>&nbsp;<span class="op" id="4976002">=</span>&nbsp;<span class="ident" id="4976004">b</span>&nbsp;<span class="op" id="4976006">-</span>&nbsp;<span class="string" id="4976008">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4976014">case</span>&nbsp;<span class="string" id="4976019">&#39;a&#39;</span>&nbsp;<span class="op" id="4976023">&lt;=</span>&nbsp;<span class="ident" id="4976026">b</span>&nbsp;<span class="op" id="4976028">&amp;&amp;</span>&nbsp;<span class="ident" id="4976031">b</span>&nbsp;<span class="op" id="4976033">&lt;=</span>&nbsp;<span class="string" id="4976036">&#39;f&#39;</span><span class="op" id="4976039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4976044">b</span>&nbsp;<span class="op" id="4976046">=</span>&nbsp;<span class="ident" id="4976048">b</span>&nbsp;<span class="op" id="4976050">-</span>&nbsp;<span class="string" id="4976052">&#39;a&#39;</span>&nbsp;<span class="op" id="4976056">+</span>&nbsp;<span class="num" id="4976058">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4976063">case</span>&nbsp;<span class="string" id="4976068">&#39;A&#39;</span>&nbsp;<span class="op" id="4976072">&lt;=</span>&nbsp;<span class="ident" id="4976075">b</span>&nbsp;<span class="op" id="4976077">&amp;&amp;</span>&nbsp;<span class="ident" id="4976080">b</span>&nbsp;<span class="op" id="4976082">&lt;=</span>&nbsp;<span class="string" id="4976085">&#39;F&#39;</span><span class="op" id="4976088">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4976093">b</span>&nbsp;<span class="op" id="4976095">=</span>&nbsp;<span class="ident" id="4976097">b</span>&nbsp;<span class="op" id="4976099">-</span>&nbsp;<span class="string" id="4976101">&#39;A&#39;</span>&nbsp;<span class="op" id="4976105">+</span>&nbsp;<span class="num" id="4976107">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4976112">default</span><span class="op" id="4976119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4976124">return</span>&nbsp;<span class="num" id="4976131">0</span><span class="op" id="4976132">,</span>&nbsp;<span class="ident" id="4976134">errors</span><span class="op" id="4976140">.</span><span class="ident" id="4976141">New</span><span class="op" id="4976144">(</span><span class="string" id="4976145">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4976175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4976179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4976183">n</span>&nbsp;<span class="op" id="4976185">|=</span>&nbsp;<span class="ident" id="4976188">uint64</span><span class="op" id="4976194">(</span><span class="ident" id="4976195">b</span><span class="op" id="4976196">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4976199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4976202">return</span><br>
<span class="lineno"></span><span class="op" id="4976209">}</span>
</div>
</body>
</html>
