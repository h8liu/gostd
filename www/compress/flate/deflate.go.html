<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4298885">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4298940">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4298994">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4299045">package</span>&nbsp;<span class="ident" id="4299053">flate</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4299060">import</span>&nbsp;<span class="op" id="4299067">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4299070">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4299077">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4299083">&#34;math&#34;</span><br>
<span class="lineno"></span><span class="op" id="4299090">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4299093">const</span>&nbsp;<span class="op" id="4299099">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299102">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299121">=</span>&nbsp;<span class="num" id="4299123">0</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299126">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299145">=</span>&nbsp;<span class="num" id="4299147">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299150">fastCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299169">=</span>&nbsp;<span class="num" id="4299171">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299174">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299193">=</span>&nbsp;<span class="num" id="4299195">9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299198">DefaultCompression</span>&nbsp;<span class="op" id="4299217">=</span>&nbsp;<span class="op" id="4299219">-</span><span class="num" id="4299220">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299223">logWindowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299242">=</span>&nbsp;<span class="num" id="4299244">15</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299248">windowSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299267">=</span>&nbsp;<span class="num" id="4299269">1</span>&nbsp;<span class="op" id="4299271">&lt;&lt;</span>&nbsp;<span class="ident" id="4299274">logWindowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299289">windowMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299308">=</span>&nbsp;<span class="ident" id="4299310">windowSize</span>&nbsp;<span class="op" id="4299321">-</span>&nbsp;<span class="num" id="4299323">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299326">logMaxOffsetSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4299345">=</span>&nbsp;<span class="num" id="4299347">15</span>&nbsp;&nbsp;<span class="comment" id="4299351">//&nbsp;Standard&nbsp;DEFLATE</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299372">minMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299391">=</span>&nbsp;<span class="num" id="4299393">3</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4299397">//&nbsp;The&nbsp;smallest&nbsp;match&nbsp;that&nbsp;the&nbsp;compressor&nbsp;looks&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299450">maxMatchLength</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299469">=</span>&nbsp;<span class="num" id="4299471">258</span>&nbsp;<span class="comment" id="4299475">//&nbsp;The&nbsp;longest&nbsp;match&nbsp;for&nbsp;the&nbsp;compressor</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299516">minOffsetSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299535">=</span>&nbsp;<span class="num" id="4299537">1</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4299541">//&nbsp;The&nbsp;shortest&nbsp;offset&nbsp;that&nbsp;makes&nbsp;any&nbsp;sense</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4299587">//&nbsp;The&nbsp;maximum&nbsp;number&nbsp;of&nbsp;tokens&nbsp;we&nbsp;put&nbsp;into&nbsp;a&nbsp;single&nbsp;flat&nbsp;block,&nbsp;just&nbsp;too</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4299662">//&nbsp;stop&nbsp;things&nbsp;from&nbsp;getting&nbsp;too&nbsp;large.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299702">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4299722">=</span>&nbsp;<span class="num" id="4299724">1</span>&nbsp;<span class="op" id="4299726">&lt;&lt;</span>&nbsp;<span class="num" id="4299729">14</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299733">maxStoreBlockSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4299753">=</span>&nbsp;<span class="num" id="4299755">65535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299762">hashBits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299782">=</span>&nbsp;<span class="num" id="4299784">17</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299788">hashSize</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299808">=</span>&nbsp;<span class="num" id="4299810">1</span>&nbsp;<span class="op" id="4299812">&lt;&lt;</span>&nbsp;<span class="ident" id="4299815">hashBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299825">hashMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299845">=</span>&nbsp;<span class="op" id="4299847">(</span><span class="num" id="4299848">1</span>&nbsp;<span class="op" id="4299850">&lt;&lt;</span>&nbsp;<span class="ident" id="4299853">hashBits</span><span class="op" id="4299861">)</span>&nbsp;<span class="op" id="4299863">-</span>&nbsp;<span class="num" id="4299865">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299868">hashShift</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299888">=</span>&nbsp;<span class="op" id="4299890">(</span><span class="ident" id="4299891">hashBits</span>&nbsp;<span class="op" id="4299900">+</span>&nbsp;<span class="ident" id="4299902">minMatchLength</span>&nbsp;<span class="op" id="4299917">-</span>&nbsp;<span class="num" id="4299919">1</span><span class="op" id="4299920">)</span>&nbsp;<span class="op" id="4299922">/</span>&nbsp;<span class="ident" id="4299924">minMatchLength</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299940">maxHashOffset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4299960">=</span>&nbsp;<span class="num" id="4299962">1</span>&nbsp;<span class="op" id="4299964">&lt;&lt;</span>&nbsp;<span class="num" id="4299967">24</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4299972">skipNever</span>&nbsp;<span class="op" id="4299982">=</span>&nbsp;<span class="ident" id="4299984">math</span><span class="op" id="4299988">.</span><span class="ident" id="4299989">MaxInt32</span><br>
<span class="lineno"></span><span class="op" id="4299998">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="4300001">type</span>&nbsp;<span class="ident" id="4300006">compressionLevel</span>&nbsp;<span class="keyword" id="4300023">struct</span>&nbsp;<span class="op" id="4300030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300033">good</span><span class="op" id="4300037">,</span>&nbsp;<span class="ident" id="4300039">lazy</span><span class="op" id="4300043">,</span>&nbsp;<span class="ident" id="4300045">nice</span><span class="op" id="4300049">,</span>&nbsp;<span class="ident" id="4300051">chain</span><span class="op" id="4300056">,</span>&nbsp;<span class="ident" id="4300058">fastSkipHashing</span>&nbsp;<span class="builtintype" id="4300074">int</span><br>
<span class="lineno"></span><span class="op" id="4300078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4300081">var</span>&nbsp;<span class="ident" id="4300085">levels</span>&nbsp;<span class="op" id="4300092">=</span>&nbsp;<span class="op" id="4300094">[</span><span class="op" id="4300095">]</span><span class="ident" id="4300096">compressionLevel</span><span class="op" id="4300112">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300115">{</span><span class="op" id="4300116">}</span><span class="op" id="4300117">,</span>&nbsp;<span class="comment" id="4300119">//&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300125">//&nbsp;For&nbsp;levels&nbsp;1-3&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;trying&nbsp;with&nbsp;lazy&nbsp;matches</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300185">{</span><span class="num" id="4300186">3</span><span class="op" id="4300187">,</span>&nbsp;<span class="num" id="4300189">0</span><span class="op" id="4300190">,</span>&nbsp;<span class="num" id="4300192">8</span><span class="op" id="4300193">,</span>&nbsp;<span class="num" id="4300195">4</span><span class="op" id="4300196">,</span>&nbsp;<span class="num" id="4300198">4</span><span class="op" id="4300199">}</span><span class="op" id="4300200">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300203">{</span><span class="num" id="4300204">3</span><span class="op" id="4300205">,</span>&nbsp;<span class="num" id="4300207">0</span><span class="op" id="4300208">,</span>&nbsp;<span class="num" id="4300210">16</span><span class="op" id="4300212">,</span>&nbsp;<span class="num" id="4300214">8</span><span class="op" id="4300215">,</span>&nbsp;<span class="num" id="4300217">5</span><span class="op" id="4300218">}</span><span class="op" id="4300219">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300222">{</span><span class="num" id="4300223">3</span><span class="op" id="4300224">,</span>&nbsp;<span class="num" id="4300226">0</span><span class="op" id="4300227">,</span>&nbsp;<span class="num" id="4300229">32</span><span class="op" id="4300231">,</span>&nbsp;<span class="num" id="4300233">32</span><span class="op" id="4300235">,</span>&nbsp;<span class="num" id="4300237">6</span><span class="op" id="4300238">}</span><span class="op" id="4300239">,</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300242">//&nbsp;Levels&nbsp;4-9&nbsp;use&nbsp;increasingly&nbsp;more&nbsp;lazy&nbsp;matching</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300293">//&nbsp;and&nbsp;increasingly&nbsp;stringent&nbsp;conditions&nbsp;for&nbsp;&#34;good&nbsp;enough&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300354">{</span><span class="num" id="4300355">4</span><span class="op" id="4300356">,</span>&nbsp;<span class="num" id="4300358">4</span><span class="op" id="4300359">,</span>&nbsp;<span class="num" id="4300361">16</span><span class="op" id="4300363">,</span>&nbsp;<span class="num" id="4300365">16</span><span class="op" id="4300367">,</span>&nbsp;<span class="ident" id="4300369">skipNever</span><span class="op" id="4300378">}</span><span class="op" id="4300379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300382">{</span><span class="num" id="4300383">8</span><span class="op" id="4300384">,</span>&nbsp;<span class="num" id="4300386">16</span><span class="op" id="4300388">,</span>&nbsp;<span class="num" id="4300390">32</span><span class="op" id="4300392">,</span>&nbsp;<span class="num" id="4300394">32</span><span class="op" id="4300396">,</span>&nbsp;<span class="ident" id="4300398">skipNever</span><span class="op" id="4300407">}</span><span class="op" id="4300408">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300411">{</span><span class="num" id="4300412">8</span><span class="op" id="4300413">,</span>&nbsp;<span class="num" id="4300415">16</span><span class="op" id="4300417">,</span>&nbsp;<span class="num" id="4300419">128</span><span class="op" id="4300422">,</span>&nbsp;<span class="num" id="4300424">128</span><span class="op" id="4300427">,</span>&nbsp;<span class="ident" id="4300429">skipNever</span><span class="op" id="4300438">}</span><span class="op" id="4300439">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300442">{</span><span class="num" id="4300443">8</span><span class="op" id="4300444">,</span>&nbsp;<span class="num" id="4300446">32</span><span class="op" id="4300448">,</span>&nbsp;<span class="num" id="4300450">128</span><span class="op" id="4300453">,</span>&nbsp;<span class="num" id="4300455">256</span><span class="op" id="4300458">,</span>&nbsp;<span class="ident" id="4300460">skipNever</span><span class="op" id="4300469">}</span><span class="op" id="4300470">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300473">{</span><span class="num" id="4300474">32</span><span class="op" id="4300476">,</span>&nbsp;<span class="num" id="4300478">128</span><span class="op" id="4300481">,</span>&nbsp;<span class="num" id="4300483">258</span><span class="op" id="4300486">,</span>&nbsp;<span class="num" id="4300488">1024</span><span class="op" id="4300492">,</span>&nbsp;<span class="ident" id="4300494">skipNever</span><span class="op" id="4300503">}</span><span class="op" id="4300504">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4300507">{</span><span class="num" id="4300508">32</span><span class="op" id="4300510">,</span>&nbsp;<span class="num" id="4300512">258</span><span class="op" id="4300515">,</span>&nbsp;<span class="num" id="4300517">258</span><span class="op" id="4300520">,</span>&nbsp;<span class="num" id="4300522">4096</span><span class="op" id="4300526">,</span>&nbsp;<span class="ident" id="4300528">skipNever</span><span class="op" id="4300537">}</span><span class="op" id="4300538">,</span><br>
<span class="lineno"></span><span class="op" id="4300540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4300543">type</span>&nbsp;<span class="ident" id="4300548">compressor</span>&nbsp;<span class="keyword" id="4300559">struct</span>&nbsp;<span class="op" id="4300566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300569">compressionLevel</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300588">w</span>&nbsp;<span class="op" id="4300590">*</span><span class="ident" id="4300591">huffmanBitWriter</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300610">//&nbsp;compression&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300636">fill</span>&nbsp;<span class="keyword" id="4300641">func</span><span class="op" id="4300645">(</span><span class="op" id="4300646">*</span><span class="ident" id="4300647">compressor</span><span class="op" id="4300657">,</span>&nbsp;<span class="op" id="4300659">[</span><span class="op" id="4300660">]</span><span class="builtintype" id="4300661">byte</span><span class="op" id="4300665">)</span>&nbsp;<span class="builtintype" id="4300667">int</span>&nbsp;<span class="comment" id="4300671">//&nbsp;copy&nbsp;data&nbsp;to&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300695">step</span>&nbsp;<span class="keyword" id="4300700">func</span><span class="op" id="4300704">(</span><span class="op" id="4300705">*</span><span class="ident" id="4300706">compressor</span><span class="op" id="4300716">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4300730">//&nbsp;process&nbsp;window</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4300749">sync</span>&nbsp;<span class="builtintype" id="4300754">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4300784">//&nbsp;requesting&nbsp;flush</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300806">//&nbsp;Input&nbsp;hash&nbsp;chains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300828">//&nbsp;hashHead[hashValue]&nbsp;contains&nbsp;the&nbsp;largest&nbsp;inputIndex&nbsp;with&nbsp;the&nbsp;specified&nbsp;hash&nbsp;value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300914">//&nbsp;If&nbsp;hashHead[hashValue]&nbsp;is&nbsp;within&nbsp;the&nbsp;current&nbsp;window,&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4300976">//&nbsp;hashPrev[hashHead[hashValue]&nbsp;&amp;&nbsp;windowMask]&nbsp;contains&nbsp;the&nbsp;previous&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4301051">//&nbsp;with&nbsp;the&nbsp;same&nbsp;hash&nbsp;value.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301081">chainHead</span>&nbsp;&nbsp;<span class="builtintype" id="4301092">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301097">hashHead</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4301108">[</span><span class="op" id="4301109">]</span><span class="builtintype" id="4301110">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301115">hashPrev</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4301126">[</span><span class="op" id="4301127">]</span><span class="builtintype" id="4301128">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301133">hashOffset</span>&nbsp;<span class="builtintype" id="4301144">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4301150">//&nbsp;input&nbsp;window:&nbsp;unprocessed&nbsp;data&nbsp;is&nbsp;window[index:windowEnd]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301212">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301226">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301231">window</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4301245">[</span><span class="op" id="4301246">]</span><span class="builtintype" id="4301247">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301253">windowEnd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301267">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301272">blockStart</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301286">int</span>&nbsp;&nbsp;<span class="comment" id="4301291">//&nbsp;window&nbsp;index&nbsp;where&nbsp;current&nbsp;tokens&nbsp;start</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301335">byteAvailable</span>&nbsp;<span class="builtintype" id="4301349">bool</span>&nbsp;<span class="comment" id="4301354">//&nbsp;if&nbsp;true,&nbsp;still&nbsp;need&nbsp;to&nbsp;process&nbsp;window[index-1].</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4301407">//&nbsp;queued&nbsp;output&nbsp;tokens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301432">tokens</span>&nbsp;<span class="op" id="4301439">[</span><span class="op" id="4301440">]</span><span class="ident" id="4301441">token</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4301449">//&nbsp;deflate&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301467">length</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301482">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301487">offset</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301502">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301507">hash</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301522">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301527">maxInsertIndex</span>&nbsp;<span class="builtintype" id="4301542">int</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301547">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4301562">error</span><br>
<span class="lineno"></span><span class="op" id="4301568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4301571">func</span>&nbsp;<span class="op" id="4301576">(</span><span class="ident" id="4301577">d</span>&nbsp;<span class="op" id="4301579">*</span><span class="ident" id="4301580">compressor</span><span class="op" id="4301590">)</span>&nbsp;<span class="ident" id="4301592">fillDeflate</span><span class="op" id="4301603">(</span><span class="ident" id="4301604">b</span>&nbsp;<span class="op" id="4301606">[</span><span class="op" id="4301607">]</span><span class="builtintype" id="4301608">byte</span><span class="op" id="4301612">)</span>&nbsp;<span class="builtintype" id="4301614">int</span>&nbsp;<span class="op" id="4301618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4301621">if</span>&nbsp;<span class="ident" id="4301624">d</span><span class="op" id="4301625">.</span><span class="ident" id="4301626">index</span>&nbsp;<span class="op" id="4301632">&gt;=</span>&nbsp;<span class="num" id="4301635">2</span><span class="op" id="4301636">*</span><span class="ident" id="4301637">windowSize</span><span class="op" id="4301647">-</span><span class="op" id="4301648">(</span><span class="ident" id="4301649">minMatchLength</span><span class="op" id="4301663">+</span><span class="ident" id="4301664">maxMatchLength</span><span class="op" id="4301678">)</span>&nbsp;<span class="op" id="4301680">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4301684">//&nbsp;shift&nbsp;the&nbsp;window&nbsp;by&nbsp;windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4301720">copy</span><span class="op" id="4301724">(</span><span class="ident" id="4301725">d</span><span class="op" id="4301726">.</span><span class="ident" id="4301727">window</span><span class="op" id="4301733">,</span>&nbsp;<span class="ident" id="4301735">d</span><span class="op" id="4301736">.</span><span class="ident" id="4301737">window</span><span class="op" id="4301743">[</span><span class="ident" id="4301744">windowSize</span><span class="op" id="4301754">:</span><span class="num" id="4301755">2</span><span class="op" id="4301756">*</span><span class="ident" id="4301757">windowSize</span><span class="op" id="4301767">]</span><span class="op" id="4301768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301772">d</span><span class="op" id="4301773">.</span><span class="ident" id="4301774">index</span>&nbsp;<span class="op" id="4301780">-=</span>&nbsp;<span class="ident" id="4301783">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301796">d</span><span class="op" id="4301797">.</span><span class="ident" id="4301798">windowEnd</span>&nbsp;<span class="op" id="4301808">-=</span>&nbsp;<span class="ident" id="4301811">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4301824">if</span>&nbsp;<span class="ident" id="4301827">d</span><span class="op" id="4301828">.</span><span class="ident" id="4301829">blockStart</span>&nbsp;<span class="op" id="4301840">&gt;=</span>&nbsp;<span class="ident" id="4301843">windowSize</span>&nbsp;<span class="op" id="4301854">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301859">d</span><span class="op" id="4301860">.</span><span class="ident" id="4301861">blockStart</span>&nbsp;<span class="op" id="4301872">-=</span>&nbsp;<span class="ident" id="4301875">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4301888">}</span>&nbsp;<span class="keyword" id="4301890">else</span>&nbsp;<span class="op" id="4301895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301900">d</span><span class="op" id="4301901">.</span><span class="ident" id="4301902">blockStart</span>&nbsp;<span class="op" id="4301913">=</span>&nbsp;<span class="ident" id="4301915">math</span><span class="op" id="4301919">.</span><span class="ident" id="4301920">MaxInt32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4301931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4301935">d</span><span class="op" id="4301936">.</span><span class="ident" id="4301937">hashOffset</span>&nbsp;<span class="op" id="4301948">+=</span>&nbsp;<span class="ident" id="4301951">windowSize</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4301964">if</span>&nbsp;<span class="ident" id="4301967">d</span><span class="op" id="4301968">.</span><span class="ident" id="4301969">hashOffset</span>&nbsp;<span class="op" id="4301980">&gt;</span>&nbsp;<span class="ident" id="4301982">maxHashOffset</span>&nbsp;<span class="op" id="4301996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302001">delta</span>&nbsp;<span class="op" id="4302007">:=</span>&nbsp;<span class="ident" id="4302010">d</span><span class="op" id="4302011">.</span><span class="ident" id="4302012">hashOffset</span>&nbsp;<span class="op" id="4302023">-</span>&nbsp;<span class="num" id="4302025">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302030">d</span><span class="op" id="4302031">.</span><span class="ident" id="4302032">hashOffset</span>&nbsp;<span class="op" id="4302043">-=</span>&nbsp;<span class="ident" id="4302046">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302055">d</span><span class="op" id="4302056">.</span><span class="ident" id="4302057">chainHead</span>&nbsp;<span class="op" id="4302067">-=</span>&nbsp;<span class="ident" id="4302070">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302079">for</span>&nbsp;<span class="ident" id="4302083">i</span><span class="op" id="4302084">,</span>&nbsp;<span class="ident" id="4302086">v</span>&nbsp;<span class="op" id="4302088">:=</span>&nbsp;<span class="keyword" id="4302091">range</span>&nbsp;<span class="ident" id="4302097">d</span><span class="op" id="4302098">.</span><span class="ident" id="4302099">hashPrev</span>&nbsp;<span class="op" id="4302108">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302114">if</span>&nbsp;<span class="ident" id="4302117">v</span>&nbsp;<span class="op" id="4302119">&gt;</span>&nbsp;<span class="ident" id="4302121">delta</span>&nbsp;<span class="op" id="4302127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302134">d</span><span class="op" id="4302135">.</span><span class="ident" id="4302136">hashPrev</span><span class="op" id="4302144">[</span><span class="ident" id="4302145">i</span><span class="op" id="4302146">]</span>&nbsp;<span class="op" id="4302148">-=</span>&nbsp;<span class="ident" id="4302151">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302161">}</span>&nbsp;<span class="keyword" id="4302163">else</span>&nbsp;<span class="op" id="4302168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302175">d</span><span class="op" id="4302176">.</span><span class="ident" id="4302177">hashPrev</span><span class="op" id="4302185">[</span><span class="ident" id="4302186">i</span><span class="op" id="4302187">]</span>&nbsp;<span class="op" id="4302189">=</span>&nbsp;<span class="num" id="4302191">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302197">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302207">for</span>&nbsp;<span class="ident" id="4302211">i</span><span class="op" id="4302212">,</span>&nbsp;<span class="ident" id="4302214">v</span>&nbsp;<span class="op" id="4302216">:=</span>&nbsp;<span class="keyword" id="4302219">range</span>&nbsp;<span class="ident" id="4302225">d</span><span class="op" id="4302226">.</span><span class="ident" id="4302227">hashHead</span>&nbsp;<span class="op" id="4302236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302242">if</span>&nbsp;<span class="ident" id="4302245">v</span>&nbsp;<span class="op" id="4302247">&gt;</span>&nbsp;<span class="ident" id="4302249">delta</span>&nbsp;<span class="op" id="4302255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302262">d</span><span class="op" id="4302263">.</span><span class="ident" id="4302264">hashHead</span><span class="op" id="4302272">[</span><span class="ident" id="4302273">i</span><span class="op" id="4302274">]</span>&nbsp;<span class="op" id="4302276">-=</span>&nbsp;<span class="ident" id="4302279">delta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302289">}</span>&nbsp;<span class="keyword" id="4302291">else</span>&nbsp;<span class="op" id="4302296">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302303">d</span><span class="op" id="4302304">.</span><span class="ident" id="4302305">hashHead</span><span class="op" id="4302313">[</span><span class="ident" id="4302314">i</span><span class="op" id="4302315">]</span>&nbsp;<span class="op" id="4302317">=</span>&nbsp;<span class="num" id="4302319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302337">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302340">n</span>&nbsp;<span class="op" id="4302342">:=</span>&nbsp;<span class="builtinfunc" id="4302345">copy</span><span class="op" id="4302349">(</span><span class="ident" id="4302350">d</span><span class="op" id="4302351">.</span><span class="ident" id="4302352">window</span><span class="op" id="4302358">[</span><span class="ident" id="4302359">d</span><span class="op" id="4302360">.</span><span class="ident" id="4302361">windowEnd</span><span class="op" id="4302370">:</span><span class="op" id="4302371">]</span><span class="op" id="4302372">,</span>&nbsp;<span class="ident" id="4302374">b</span><span class="op" id="4302375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302378">d</span><span class="op" id="4302379">.</span><span class="ident" id="4302380">windowEnd</span>&nbsp;<span class="op" id="4302390">+=</span>&nbsp;<span class="ident" id="4302393">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302396">return</span>&nbsp;<span class="ident" id="4302403">n</span><br>
<span class="lineno"></span><span class="op" id="4302405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="4302408">func</span>&nbsp;<span class="op" id="4302413">(</span><span class="ident" id="4302414">d</span>&nbsp;<span class="op" id="4302416">*</span><span class="ident" id="4302417">compressor</span><span class="op" id="4302427">)</span>&nbsp;<span class="ident" id="4302429">writeBlock</span><span class="op" id="4302439">(</span><span class="ident" id="4302440">tokens</span>&nbsp;<span class="op" id="4302447">[</span><span class="op" id="4302448">]</span><span class="ident" id="4302449">token</span><span class="op" id="4302454">,</span>&nbsp;<span class="ident" id="4302456">index</span>&nbsp;<span class="builtintype" id="4302462">int</span><span class="op" id="4302465">,</span>&nbsp;<span class="ident" id="4302467">eof</span>&nbsp;<span class="builtintype" id="4302471">bool</span><span class="op" id="4302475">)</span>&nbsp;<span class="builtintype" id="4302477">error</span>&nbsp;<span class="op" id="4302483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302486">if</span>&nbsp;<span class="ident" id="4302489">index</span>&nbsp;<span class="op" id="4302495">&gt;</span>&nbsp;<span class="num" id="4302497">0</span>&nbsp;<span class="op" id="4302499">||</span>&nbsp;<span class="ident" id="4302502">eof</span>&nbsp;<span class="op" id="4302506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302510">var</span>&nbsp;<span class="ident" id="4302514">window</span>&nbsp;<span class="op" id="4302521">[</span><span class="op" id="4302522">]</span><span class="builtintype" id="4302523">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302530">if</span>&nbsp;<span class="ident" id="4302533">d</span><span class="op" id="4302534">.</span><span class="ident" id="4302535">blockStart</span>&nbsp;<span class="op" id="4302546">&lt;=</span>&nbsp;<span class="ident" id="4302549">index</span>&nbsp;<span class="op" id="4302555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302560">window</span>&nbsp;<span class="op" id="4302567">=</span>&nbsp;<span class="ident" id="4302569">d</span><span class="op" id="4302570">.</span><span class="ident" id="4302571">window</span><span class="op" id="4302577">[</span><span class="ident" id="4302578">d</span><span class="op" id="4302579">.</span><span class="ident" id="4302580">blockStart</span><span class="op" id="4302590">:</span><span class="ident" id="4302591">index</span><span class="op" id="4302596">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302600">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302604">d</span><span class="op" id="4302605">.</span><span class="ident" id="4302606">blockStart</span>&nbsp;<span class="op" id="4302617">=</span>&nbsp;<span class="ident" id="4302619">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302627">d</span><span class="op" id="4302628">.</span><span class="ident" id="4302629">w</span><span class="op" id="4302630">.</span><span class="ident" id="4302631">writeBlock</span><span class="op" id="4302641">(</span><span class="ident" id="4302642">tokens</span><span class="op" id="4302648">,</span>&nbsp;<span class="ident" id="4302650">eof</span><span class="op" id="4302653">,</span>&nbsp;<span class="ident" id="4302655">window</span><span class="op" id="4302661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302665">return</span>&nbsp;<span class="ident" id="4302672">d</span><span class="op" id="4302673">.</span><span class="ident" id="4302674">w</span><span class="op" id="4302675">.</span><span class="ident" id="4302676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4302681">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302684">return</span>&nbsp;<span class="ident" id="4302691">nil</span><br>
<span class="lineno"></span><span class="op" id="4302695">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4302698">//&nbsp;Try&nbsp;to&nbsp;find&nbsp;a&nbsp;match&nbsp;starting&nbsp;at&nbsp;index&nbsp;whose&nbsp;length&nbsp;is&nbsp;greater&nbsp;than&nbsp;prevSize.</span><br>
<span class="lineno"></span><span class="comment" id="4302778">//&nbsp;We&nbsp;only&nbsp;look&nbsp;at&nbsp;chainCount&nbsp;possibilities&nbsp;before&nbsp;giving&nbsp;up.</span><br>
<span class="lineno">150</span><span class="keyword" id="4302840">func</span>&nbsp;<span class="op" id="4302845">(</span><span class="ident" id="4302846">d</span>&nbsp;<span class="op" id="4302848">*</span><span class="ident" id="4302849">compressor</span><span class="op" id="4302859">)</span>&nbsp;<span class="ident" id="4302861">findMatch</span><span class="op" id="4302870">(</span><span class="ident" id="4302871">pos</span>&nbsp;<span class="builtintype" id="4302875">int</span><span class="op" id="4302878">,</span>&nbsp;<span class="ident" id="4302880">prevHead</span>&nbsp;<span class="builtintype" id="4302889">int</span><span class="op" id="4302892">,</span>&nbsp;<span class="ident" id="4302894">prevLength</span>&nbsp;<span class="builtintype" id="4302905">int</span><span class="op" id="4302908">,</span>&nbsp;<span class="ident" id="4302910">lookahead</span>&nbsp;<span class="builtintype" id="4302920">int</span><span class="op" id="4302923">)</span>&nbsp;<span class="op" id="4302925">(</span><span class="ident" id="4302926">length</span><span class="op" id="4302932">,</span>&nbsp;<span class="ident" id="4302934">offset</span>&nbsp;<span class="builtintype" id="4302941">int</span><span class="op" id="4302944">,</span>&nbsp;<span class="ident" id="4302946">ok</span>&nbsp;<span class="builtintype" id="4302949">bool</span><span class="op" id="4302953">)</span>&nbsp;<span class="op" id="4302955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4302958">minMatchLook</span>&nbsp;<span class="op" id="4302971">:=</span>&nbsp;<span class="ident" id="4302974">maxMatchLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4302990">if</span>&nbsp;<span class="ident" id="4302993">lookahead</span>&nbsp;<span class="op" id="4303003">&lt;</span>&nbsp;<span class="ident" id="4303005">minMatchLook</span>&nbsp;<span class="op" id="4303018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303022">minMatchLook</span>&nbsp;<span class="op" id="4303035">=</span>&nbsp;<span class="ident" id="4303037">lookahead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303048">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303052">win</span>&nbsp;<span class="op" id="4303056">:=</span>&nbsp;<span class="ident" id="4303059">d</span><span class="op" id="4303060">.</span><span class="ident" id="4303061">window</span><span class="op" id="4303067">[</span><span class="num" id="4303068">0</span>&nbsp;<span class="op" id="4303070">:</span>&nbsp;<span class="ident" id="4303072">pos</span><span class="op" id="4303075">+</span><span class="ident" id="4303076">minMatchLook</span><span class="op" id="4303088">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4303092">//&nbsp;We&nbsp;quit&nbsp;when&nbsp;we&nbsp;get&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;at&nbsp;least&nbsp;nice&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303150">nice</span>&nbsp;<span class="op" id="4303155">:=</span>&nbsp;<span class="builtinfunc" id="4303158">len</span><span class="op" id="4303161">(</span><span class="ident" id="4303162">win</span><span class="op" id="4303165">)</span>&nbsp;<span class="op" id="4303167">-</span>&nbsp;<span class="ident" id="4303169">pos</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303174">if</span>&nbsp;<span class="ident" id="4303177">d</span><span class="op" id="4303178">.</span><span class="ident" id="4303179">nice</span>&nbsp;<span class="op" id="4303184">&lt;</span>&nbsp;<span class="ident" id="4303186">nice</span>&nbsp;<span class="op" id="4303191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303195">nice</span>&nbsp;<span class="op" id="4303200">=</span>&nbsp;<span class="ident" id="4303202">d</span><span class="op" id="4303203">.</span><span class="ident" id="4303204">nice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4303214">//&nbsp;If&nbsp;we&#39;ve&nbsp;got&nbsp;a&nbsp;match&nbsp;that&#39;s&nbsp;good&nbsp;enough,&nbsp;only&nbsp;look&nbsp;in&nbsp;1/4&nbsp;the&nbsp;chain.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303287">tries</span>&nbsp;<span class="op" id="4303293">:=</span>&nbsp;<span class="ident" id="4303296">d</span><span class="op" id="4303297">.</span><span class="ident" id="4303298">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303305">length</span>&nbsp;<span class="op" id="4303312">=</span>&nbsp;<span class="ident" id="4303314">prevLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303326">if</span>&nbsp;<span class="ident" id="4303329">length</span>&nbsp;<span class="op" id="4303336">&gt;=</span>&nbsp;<span class="ident" id="4303339">d</span><span class="op" id="4303340">.</span><span class="ident" id="4303341">good</span>&nbsp;<span class="op" id="4303346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303350">tries</span>&nbsp;<span class="op" id="4303356">&gt;&gt;=</span>&nbsp;<span class="num" id="4303360">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303363">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303367">w0</span>&nbsp;<span class="op" id="4303370">:=</span>&nbsp;<span class="ident" id="4303373">win</span><span class="op" id="4303376">[</span><span class="ident" id="4303377">pos</span><span class="op" id="4303380">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303383">w1</span>&nbsp;<span class="op" id="4303386">:=</span>&nbsp;<span class="ident" id="4303389">win</span><span class="op" id="4303392">[</span><span class="ident" id="4303393">pos</span><span class="op" id="4303396">+</span><span class="num" id="4303397">1</span><span class="op" id="4303398">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303401">wEnd</span>&nbsp;<span class="op" id="4303406">:=</span>&nbsp;<span class="ident" id="4303409">win</span><span class="op" id="4303412">[</span><span class="ident" id="4303413">pos</span><span class="op" id="4303416">+</span><span class="ident" id="4303417">length</span><span class="op" id="4303423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303426">minIndex</span>&nbsp;<span class="op" id="4303435">:=</span>&nbsp;<span class="ident" id="4303438">pos</span>&nbsp;<span class="op" id="4303442">-</span>&nbsp;<span class="ident" id="4303444">windowSize</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303457">for</span>&nbsp;<span class="ident" id="4303461">i</span>&nbsp;<span class="op" id="4303463">:=</span>&nbsp;<span class="ident" id="4303466">prevHead</span><span class="op" id="4303474">;</span>&nbsp;<span class="ident" id="4303476">tries</span>&nbsp;<span class="op" id="4303482">&gt;</span>&nbsp;<span class="num" id="4303484">0</span><span class="op" id="4303485">;</span>&nbsp;<span class="ident" id="4303487">tries</span><span class="op" id="4303492">--</span>&nbsp;<span class="op" id="4303495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303499">if</span>&nbsp;<span class="ident" id="4303502">w0</span>&nbsp;<span class="op" id="4303505">==</span>&nbsp;<span class="ident" id="4303508">win</span><span class="op" id="4303511">[</span><span class="ident" id="4303512">i</span><span class="op" id="4303513">]</span>&nbsp;<span class="op" id="4303515">&amp;&amp;</span>&nbsp;<span class="ident" id="4303518">w1</span>&nbsp;<span class="op" id="4303521">==</span>&nbsp;<span class="ident" id="4303524">win</span><span class="op" id="4303527">[</span><span class="ident" id="4303528">i</span><span class="op" id="4303529">+</span><span class="num" id="4303530">1</span><span class="op" id="4303531">]</span>&nbsp;<span class="op" id="4303533">&amp;&amp;</span>&nbsp;<span class="ident" id="4303536">wEnd</span>&nbsp;<span class="op" id="4303541">==</span>&nbsp;<span class="ident" id="4303544">win</span><span class="op" id="4303547">[</span><span class="ident" id="4303548">i</span><span class="op" id="4303549">+</span><span class="ident" id="4303550">length</span><span class="op" id="4303556">]</span>&nbsp;<span class="op" id="4303558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4303563">//&nbsp;The&nbsp;hash&nbsp;function&nbsp;ensures&nbsp;that&nbsp;if&nbsp;win[i]&nbsp;and&nbsp;win[i+1]&nbsp;match,&nbsp;win[i+2]&nbsp;matches</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303648">n</span>&nbsp;<span class="op" id="4303650">:=</span>&nbsp;<span class="num" id="4303653">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303658">for</span>&nbsp;<span class="ident" id="4303662">pos</span><span class="op" id="4303665">+</span><span class="ident" id="4303666">n</span>&nbsp;<span class="op" id="4303668">&lt;</span>&nbsp;<span class="builtinfunc" id="4303670">len</span><span class="op" id="4303673">(</span><span class="ident" id="4303674">win</span><span class="op" id="4303677">)</span>&nbsp;<span class="op" id="4303679">&amp;&amp;</span>&nbsp;<span class="ident" id="4303682">win</span><span class="op" id="4303685">[</span><span class="ident" id="4303686">i</span><span class="op" id="4303687">+</span><span class="ident" id="4303688">n</span><span class="op" id="4303689">]</span>&nbsp;<span class="op" id="4303691">==</span>&nbsp;<span class="ident" id="4303694">win</span><span class="op" id="4303697">[</span><span class="ident" id="4303698">pos</span><span class="op" id="4303701">+</span><span class="ident" id="4303702">n</span><span class="op" id="4303703">]</span>&nbsp;<span class="op" id="4303705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303711">n</span><span class="op" id="4303712">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303723">if</span>&nbsp;<span class="ident" id="4303726">n</span>&nbsp;<span class="op" id="4303728">&gt;</span>&nbsp;<span class="ident" id="4303730">length</span>&nbsp;<span class="op" id="4303737">&amp;&amp;</span>&nbsp;<span class="op" id="4303740">(</span><span class="ident" id="4303741">n</span>&nbsp;<span class="op" id="4303743">&gt;</span>&nbsp;<span class="num" id="4303745">3</span>&nbsp;<span class="op" id="4303747">||</span>&nbsp;<span class="ident" id="4303750">pos</span><span class="op" id="4303753">-</span><span class="ident" id="4303754">i</span>&nbsp;<span class="op" id="4303756">&lt;=</span>&nbsp;<span class="num" id="4303759">4096</span><span class="op" id="4303763">)</span>&nbsp;<span class="op" id="4303765">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303771">length</span>&nbsp;<span class="op" id="4303778">=</span>&nbsp;<span class="ident" id="4303780">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303786">offset</span>&nbsp;<span class="op" id="4303793">=</span>&nbsp;<span class="ident" id="4303795">pos</span>&nbsp;<span class="op" id="4303799">-</span>&nbsp;<span class="ident" id="4303801">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303807">ok</span>&nbsp;<span class="op" id="4303810">=</span>&nbsp;<span class="ident" id="4303812">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303821">if</span>&nbsp;<span class="ident" id="4303824">n</span>&nbsp;<span class="op" id="4303826">&gt;=</span>&nbsp;<span class="ident" id="4303829">nice</span>&nbsp;<span class="op" id="4303834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4303841">//&nbsp;The&nbsp;match&nbsp;is&nbsp;good&nbsp;enough&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;try&nbsp;to&nbsp;find&nbsp;a&nbsp;better&nbsp;one.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303914">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4303930">wEnd</span>&nbsp;<span class="op" id="4303935">=</span>&nbsp;<span class="ident" id="4303937">win</span><span class="op" id="4303940">[</span><span class="ident" id="4303941">pos</span><span class="op" id="4303944">+</span><span class="ident" id="4303945">n</span><span class="op" id="4303946">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4303955">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4303959">if</span>&nbsp;<span class="ident" id="4303962">i</span>&nbsp;<span class="op" id="4303964">==</span>&nbsp;<span class="ident" id="4303967">minIndex</span>&nbsp;<span class="op" id="4303976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4303981">//&nbsp;hashPrev[i&nbsp;&amp;&nbsp;windowMask]&nbsp;has&nbsp;already&nbsp;been&nbsp;overwritten,&nbsp;so&nbsp;stop&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304055">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304067">if</span>&nbsp;<span class="ident" id="4304070">i</span>&nbsp;<span class="op" id="4304072">=</span>&nbsp;<span class="ident" id="4304074">d</span><span class="op" id="4304075">.</span><span class="ident" id="4304076">hashPrev</span><span class="op" id="4304084">[</span><span class="ident" id="4304085">i</span><span class="op" id="4304086">&amp;</span><span class="ident" id="4304087">windowMask</span><span class="op" id="4304097">]</span>&nbsp;<span class="op" id="4304099">-</span>&nbsp;<span class="ident" id="4304101">d</span><span class="op" id="4304102">.</span><span class="ident" id="4304103">hashOffset</span><span class="op" id="4304113">;</span>&nbsp;<span class="ident" id="4304115">i</span>&nbsp;<span class="op" id="4304117">&lt;</span>&nbsp;<span class="ident" id="4304119">minIndex</span>&nbsp;<span class="op" id="4304128">||</span>&nbsp;<span class="ident" id="4304131">i</span>&nbsp;<span class="op" id="4304133">&lt;</span>&nbsp;<span class="num" id="4304135">0</span>&nbsp;<span class="op" id="4304137">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304142">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304150">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304156">return</span><br>
<span class="lineno"></span><span class="op" id="4304163">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="4304166">func</span>&nbsp;<span class="op" id="4304171">(</span><span class="ident" id="4304172">d</span>&nbsp;<span class="op" id="4304174">*</span><span class="ident" id="4304175">compressor</span><span class="op" id="4304185">)</span>&nbsp;<span class="ident" id="4304187">writeStoredBlock</span><span class="op" id="4304203">(</span><span class="ident" id="4304204">buf</span>&nbsp;<span class="op" id="4304208">[</span><span class="op" id="4304209">]</span><span class="builtintype" id="4304210">byte</span><span class="op" id="4304214">)</span>&nbsp;<span class="builtintype" id="4304216">error</span>&nbsp;<span class="op" id="4304222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304225">if</span>&nbsp;<span class="ident" id="4304228">d</span><span class="op" id="4304229">.</span><span class="ident" id="4304230">w</span><span class="op" id="4304231">.</span><span class="ident" id="4304232">writeStoredHeader</span><span class="op" id="4304249">(</span><span class="builtinfunc" id="4304250">len</span><span class="op" id="4304253">(</span><span class="ident" id="4304254">buf</span><span class="op" id="4304257">)</span><span class="op" id="4304258">,</span>&nbsp;<span class="ident" id="4304260">false</span><span class="op" id="4304265">)</span><span class="op" id="4304266">;</span>&nbsp;<span class="ident" id="4304268">d</span><span class="op" id="4304269">.</span><span class="ident" id="4304270">w</span><span class="op" id="4304271">.</span><span class="ident" id="4304272">err</span>&nbsp;<span class="op" id="4304276">!=</span>&nbsp;<span class="ident" id="4304279">nil</span>&nbsp;<span class="op" id="4304283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304287">return</span>&nbsp;<span class="ident" id="4304294">d</span><span class="op" id="4304295">.</span><span class="ident" id="4304296">w</span><span class="op" id="4304297">.</span><span class="ident" id="4304298">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304303">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304306">d</span><span class="op" id="4304307">.</span><span class="ident" id="4304308">w</span><span class="op" id="4304309">.</span><span class="ident" id="4304310">writeBytes</span><span class="op" id="4304320">(</span><span class="ident" id="4304321">buf</span><span class="op" id="4304324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304327">return</span>&nbsp;<span class="ident" id="4304334">d</span><span class="op" id="4304335">.</span><span class="ident" id="4304336">w</span><span class="op" id="4304337">.</span><span class="ident" id="4304338">err</span><br>
<span class="lineno"></span><span class="op" id="4304342">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4304345">func</span>&nbsp;<span class="op" id="4304350">(</span><span class="ident" id="4304351">d</span>&nbsp;<span class="op" id="4304353">*</span><span class="ident" id="4304354">compressor</span><span class="op" id="4304364">)</span>&nbsp;<span class="ident" id="4304366">initDeflate</span><span class="op" id="4304377">(</span><span class="op" id="4304378">)</span>&nbsp;<span class="op" id="4304380">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304383">d</span><span class="op" id="4304384">.</span><span class="ident" id="4304385">hashHead</span>&nbsp;<span class="op" id="4304394">=</span>&nbsp;<span class="builtinfunc" id="4304396">make</span><span class="op" id="4304400">(</span><span class="op" id="4304401">[</span><span class="op" id="4304402">]</span><span class="builtintype" id="4304403">int</span><span class="op" id="4304406">,</span>&nbsp;<span class="ident" id="4304408">hashSize</span><span class="op" id="4304416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304419">d</span><span class="op" id="4304420">.</span><span class="ident" id="4304421">hashPrev</span>&nbsp;<span class="op" id="4304430">=</span>&nbsp;<span class="builtinfunc" id="4304432">make</span><span class="op" id="4304436">(</span><span class="op" id="4304437">[</span><span class="op" id="4304438">]</span><span class="builtintype" id="4304439">int</span><span class="op" id="4304442">,</span>&nbsp;<span class="ident" id="4304444">windowSize</span><span class="op" id="4304454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304457">d</span><span class="op" id="4304458">.</span><span class="ident" id="4304459">window</span>&nbsp;<span class="op" id="4304466">=</span>&nbsp;<span class="builtinfunc" id="4304468">make</span><span class="op" id="4304472">(</span><span class="op" id="4304473">[</span><span class="op" id="4304474">]</span><span class="builtintype" id="4304475">byte</span><span class="op" id="4304479">,</span>&nbsp;<span class="num" id="4304481">2</span><span class="op" id="4304482">*</span><span class="ident" id="4304483">windowSize</span><span class="op" id="4304493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304496">d</span><span class="op" id="4304497">.</span><span class="ident" id="4304498">hashOffset</span>&nbsp;<span class="op" id="4304509">=</span>&nbsp;<span class="num" id="4304511">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304514">d</span><span class="op" id="4304515">.</span><span class="ident" id="4304516">tokens</span>&nbsp;<span class="op" id="4304523">=</span>&nbsp;<span class="builtinfunc" id="4304525">make</span><span class="op" id="4304529">(</span><span class="op" id="4304530">[</span><span class="op" id="4304531">]</span><span class="ident" id="4304532">token</span><span class="op" id="4304537">,</span>&nbsp;<span class="num" id="4304539">0</span><span class="op" id="4304540">,</span>&nbsp;<span class="ident" id="4304542">maxFlateBlockTokens</span><span class="op" id="4304561">+</span><span class="num" id="4304562">1</span><span class="op" id="4304563">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304566">d</span><span class="op" id="4304567">.</span><span class="ident" id="4304568">length</span>&nbsp;<span class="op" id="4304575">=</span>&nbsp;<span class="ident" id="4304577">minMatchLength</span>&nbsp;<span class="op" id="4304592">-</span>&nbsp;<span class="num" id="4304594">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304597">d</span><span class="op" id="4304598">.</span><span class="ident" id="4304599">offset</span>&nbsp;<span class="op" id="4304606">=</span>&nbsp;<span class="num" id="4304608">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304611">d</span><span class="op" id="4304612">.</span><span class="ident" id="4304613">byteAvailable</span>&nbsp;<span class="op" id="4304627">=</span>&nbsp;<span class="ident" id="4304629">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304636">d</span><span class="op" id="4304637">.</span><span class="ident" id="4304638">index</span>&nbsp;<span class="op" id="4304644">=</span>&nbsp;<span class="num" id="4304646">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304649">d</span><span class="op" id="4304650">.</span><span class="ident" id="4304651">hash</span>&nbsp;<span class="op" id="4304656">=</span>&nbsp;<span class="num" id="4304658">0</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304661">d</span><span class="op" id="4304662">.</span><span class="ident" id="4304663">chainHead</span>&nbsp;<span class="op" id="4304673">=</span>&nbsp;<span class="op" id="4304675">-</span><span class="num" id="4304676">1</span><br>
<span class="lineno"></span><span class="op" id="4304678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4304681">func</span>&nbsp;<span class="op" id="4304686">(</span><span class="ident" id="4304687">d</span>&nbsp;<span class="op" id="4304689">*</span><span class="ident" id="4304690">compressor</span><span class="op" id="4304700">)</span>&nbsp;<span class="ident" id="4304702">deflate</span><span class="op" id="4304709">(</span><span class="op" id="4304710">)</span>&nbsp;<span class="op" id="4304712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304715">if</span>&nbsp;<span class="ident" id="4304718">d</span><span class="op" id="4304719">.</span><span class="ident" id="4304720">windowEnd</span><span class="op" id="4304729">-</span><span class="ident" id="4304730">d</span><span class="op" id="4304731">.</span><span class="ident" id="4304732">index</span>&nbsp;<span class="op" id="4304738">&lt;</span>&nbsp;<span class="ident" id="4304740">minMatchLength</span><span class="op" id="4304754">+</span><span class="ident" id="4304755">maxMatchLength</span>&nbsp;<span class="op" id="4304770">&amp;&amp;</span>&nbsp;<span class="op" id="4304773">!</span><span class="ident" id="4304774">d</span><span class="op" id="4304775">.</span><span class="ident" id="4304776">sync</span>&nbsp;<span class="op" id="4304781">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304797">d</span><span class="op" id="4304798">.</span><span class="ident" id="4304799">maxInsertIndex</span>&nbsp;<span class="op" id="4304814">=</span>&nbsp;<span class="ident" id="4304816">d</span><span class="op" id="4304817">.</span><span class="ident" id="4304818">windowEnd</span>&nbsp;<span class="op" id="4304828">-</span>&nbsp;<span class="op" id="4304830">(</span><span class="ident" id="4304831">minMatchLength</span>&nbsp;<span class="op" id="4304846">-</span>&nbsp;<span class="num" id="4304848">1</span><span class="op" id="4304849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304852">if</span>&nbsp;<span class="ident" id="4304855">d</span><span class="op" id="4304856">.</span><span class="ident" id="4304857">index</span>&nbsp;<span class="op" id="4304863">&lt;</span>&nbsp;<span class="ident" id="4304865">d</span><span class="op" id="4304866">.</span><span class="ident" id="4304867">maxInsertIndex</span>&nbsp;<span class="op" id="4304882">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4304886">d</span><span class="op" id="4304887">.</span><span class="ident" id="4304888">hash</span>&nbsp;<span class="op" id="4304893">=</span>&nbsp;<span class="builtintype" id="4304895">int</span><span class="op" id="4304898">(</span><span class="ident" id="4304899">d</span><span class="op" id="4304900">.</span><span class="ident" id="4304901">window</span><span class="op" id="4304907">[</span><span class="ident" id="4304908">d</span><span class="op" id="4304909">.</span><span class="ident" id="4304910">index</span><span class="op" id="4304915">]</span><span class="op" id="4304916">)</span><span class="op" id="4304917">&lt;&lt;</span><span class="ident" id="4304919">hashShift</span>&nbsp;<span class="op" id="4304929">+</span>&nbsp;<span class="builtintype" id="4304931">int</span><span class="op" id="4304934">(</span><span class="ident" id="4304935">d</span><span class="op" id="4304936">.</span><span class="ident" id="4304937">window</span><span class="op" id="4304943">[</span><span class="ident" id="4304944">d</span><span class="op" id="4304945">.</span><span class="ident" id="4304946">index</span><span class="op" id="4304951">+</span><span class="num" id="4304952">1</span><span class="op" id="4304953">]</span><span class="op" id="4304954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4304957">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4304960">Loop</span><span class="op" id="4304964">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304967">for</span>&nbsp;<span class="op" id="4304971">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4304975">if</span>&nbsp;<span class="ident" id="4304978">d</span><span class="op" id="4304979">.</span><span class="ident" id="4304980">index</span>&nbsp;<span class="op" id="4304986">&gt;</span>&nbsp;<span class="ident" id="4304988">d</span><span class="op" id="4304989">.</span><span class="ident" id="4304990">windowEnd</span>&nbsp;<span class="op" id="4305000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4305005">panic</span><span class="op" id="4305010">(</span><span class="string" id="4305011">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4305030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305038">lookahead</span>&nbsp;<span class="op" id="4305048">:=</span>&nbsp;<span class="ident" id="4305051">d</span><span class="op" id="4305052">.</span><span class="ident" id="4305053">windowEnd</span>&nbsp;<span class="op" id="4305063">-</span>&nbsp;<span class="ident" id="4305065">d</span><span class="op" id="4305066">.</span><span class="ident" id="4305067">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305075">if</span>&nbsp;<span class="ident" id="4305078">lookahead</span>&nbsp;<span class="op" id="4305088">&lt;</span>&nbsp;<span class="ident" id="4305090">minMatchLength</span><span class="op" id="4305104">+</span><span class="ident" id="4305105">maxMatchLength</span>&nbsp;<span class="op" id="4305120">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305125">if</span>&nbsp;<span class="op" id="4305128">!</span><span class="ident" id="4305129">d</span><span class="op" id="4305130">.</span><span class="ident" id="4305131">sync</span>&nbsp;<span class="op" id="4305136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305142">break</span>&nbsp;<span class="ident" id="4305148">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305161">if</span>&nbsp;<span class="ident" id="4305164">d</span><span class="op" id="4305165">.</span><span class="ident" id="4305166">index</span>&nbsp;<span class="op" id="4305172">&gt;</span>&nbsp;<span class="ident" id="4305174">d</span><span class="op" id="4305175">.</span><span class="ident" id="4305176">windowEnd</span>&nbsp;<span class="op" id="4305186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4305192">panic</span><span class="op" id="4305197">(</span><span class="string" id="4305198">&#34;index&nbsp;&gt;&nbsp;windowEnd&#34;</span><span class="op" id="4305217">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305227">if</span>&nbsp;<span class="ident" id="4305230">lookahead</span>&nbsp;<span class="op" id="4305240">==</span>&nbsp;<span class="num" id="4305243">0</span>&nbsp;<span class="op" id="4305245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4305251">//&nbsp;Flush&nbsp;current&nbsp;output&nbsp;block&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305293">if</span>&nbsp;<span class="ident" id="4305296">d</span><span class="op" id="4305297">.</span><span class="ident" id="4305298">byteAvailable</span>&nbsp;<span class="op" id="4305312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4305319">//&nbsp;There&nbsp;is&nbsp;still&nbsp;one&nbsp;pending&nbsp;token&nbsp;that&nbsp;needs&nbsp;to&nbsp;be&nbsp;flushed</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305385">d</span><span class="op" id="4305386">.</span><span class="ident" id="4305387">tokens</span>&nbsp;<span class="op" id="4305394">=</span>&nbsp;<span class="builtinfunc" id="4305396">append</span><span class="op" id="4305402">(</span><span class="ident" id="4305403">d</span><span class="op" id="4305404">.</span><span class="ident" id="4305405">tokens</span><span class="op" id="4305411">,</span>&nbsp;<span class="ident" id="4305413">literalToken</span><span class="op" id="4305425">(</span><span class="builtintype" id="4305426">uint32</span><span class="op" id="4305432">(</span><span class="ident" id="4305433">d</span><span class="op" id="4305434">.</span><span class="ident" id="4305435">window</span><span class="op" id="4305441">[</span><span class="ident" id="4305442">d</span><span class="op" id="4305443">.</span><span class="ident" id="4305444">index</span><span class="op" id="4305449">-</span><span class="num" id="4305450">1</span><span class="op" id="4305451">]</span><span class="op" id="4305452">)</span><span class="op" id="4305453">)</span><span class="op" id="4305454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305461">d</span><span class="op" id="4305462">.</span><span class="ident" id="4305463">byteAvailable</span>&nbsp;<span class="op" id="4305477">=</span>&nbsp;<span class="ident" id="4305479">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305495">if</span>&nbsp;<span class="builtinfunc" id="4305498">len</span><span class="op" id="4305501">(</span><span class="ident" id="4305502">d</span><span class="op" id="4305503">.</span><span class="ident" id="4305504">tokens</span><span class="op" id="4305510">)</span>&nbsp;<span class="op" id="4305512">&gt;</span>&nbsp;<span class="num" id="4305514">0</span>&nbsp;<span class="op" id="4305516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305523">if</span>&nbsp;<span class="ident" id="4305526">d</span><span class="op" id="4305527">.</span><span class="ident" id="4305528">err</span>&nbsp;<span class="op" id="4305532">=</span>&nbsp;<span class="ident" id="4305534">d</span><span class="op" id="4305535">.</span><span class="ident" id="4305536">writeBlock</span><span class="op" id="4305546">(</span><span class="ident" id="4305547">d</span><span class="op" id="4305548">.</span><span class="ident" id="4305549">tokens</span><span class="op" id="4305555">,</span>&nbsp;<span class="ident" id="4305557">d</span><span class="op" id="4305558">.</span><span class="ident" id="4305559">index</span><span class="op" id="4305564">,</span>&nbsp;<span class="ident" id="4305566">false</span><span class="op" id="4305571">)</span><span class="op" id="4305572">;</span>&nbsp;<span class="ident" id="4305574">d</span><span class="op" id="4305575">.</span><span class="ident" id="4305576">err</span>&nbsp;<span class="op" id="4305580">!=</span>&nbsp;<span class="ident" id="4305583">nil</span>&nbsp;<span class="op" id="4305587">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305595">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305614">d</span><span class="op" id="4305615">.</span><span class="ident" id="4305616">tokens</span>&nbsp;<span class="op" id="4305623">=</span>&nbsp;<span class="ident" id="4305625">d</span><span class="op" id="4305626">.</span><span class="ident" id="4305627">tokens</span><span class="op" id="4305633">[</span><span class="op" id="4305634">:</span><span class="num" id="4305635">0</span><span class="op" id="4305636">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305648">break</span>&nbsp;<span class="ident" id="4305654">Loop</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4305670">if</span>&nbsp;<span class="ident" id="4305673">d</span><span class="op" id="4305674">.</span><span class="ident" id="4305675">index</span>&nbsp;<span class="op" id="4305681">&lt;</span>&nbsp;<span class="ident" id="4305683">d</span><span class="op" id="4305684">.</span><span class="ident" id="4305685">maxInsertIndex</span>&nbsp;<span class="op" id="4305700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4305705">//&nbsp;Update&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305727">d</span><span class="op" id="4305728">.</span><span class="ident" id="4305729">hash</span>&nbsp;<span class="op" id="4305734">=</span>&nbsp;<span class="op" id="4305736">(</span><span class="ident" id="4305737">d</span><span class="op" id="4305738">.</span><span class="ident" id="4305739">hash</span><span class="op" id="4305743">&lt;&lt;</span><span class="ident" id="4305745">hashShift</span>&nbsp;<span class="op" id="4305755">+</span>&nbsp;<span class="builtintype" id="4305757">int</span><span class="op" id="4305760">(</span><span class="ident" id="4305761">d</span><span class="op" id="4305762">.</span><span class="ident" id="4305763">window</span><span class="op" id="4305769">[</span><span class="ident" id="4305770">d</span><span class="op" id="4305771">.</span><span class="ident" id="4305772">index</span><span class="op" id="4305777">+</span><span class="num" id="4305778">2</span><span class="op" id="4305779">]</span><span class="op" id="4305780">)</span><span class="op" id="4305781">)</span>&nbsp;<span class="op" id="4305783">&amp;</span>&nbsp;<span class="ident" id="4305785">hashMask</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305797">d</span><span class="op" id="4305798">.</span><span class="ident" id="4305799">chainHead</span>&nbsp;<span class="op" id="4305809">=</span>&nbsp;<span class="ident" id="4305811">d</span><span class="op" id="4305812">.</span><span class="ident" id="4305813">hashHead</span><span class="op" id="4305821">[</span><span class="ident" id="4305822">d</span><span class="op" id="4305823">.</span><span class="ident" id="4305824">hash</span><span class="op" id="4305828">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305833">d</span><span class="op" id="4305834">.</span><span class="ident" id="4305835">hashPrev</span><span class="op" id="4305843">[</span><span class="ident" id="4305844">d</span><span class="op" id="4305845">.</span><span class="ident" id="4305846">index</span><span class="op" id="4305851">&amp;</span><span class="ident" id="4305852">windowMask</span><span class="op" id="4305862">]</span>&nbsp;<span class="op" id="4305864">=</span>&nbsp;<span class="ident" id="4305866">d</span><span class="op" id="4305867">.</span><span class="ident" id="4305868">chainHead</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305881">d</span><span class="op" id="4305882">.</span><span class="ident" id="4305883">hashHead</span><span class="op" id="4305891">[</span><span class="ident" id="4305892">d</span><span class="op" id="4305893">.</span><span class="ident" id="4305894">hash</span><span class="op" id="4305898">]</span>&nbsp;<span class="op" id="4305900">=</span>&nbsp;<span class="ident" id="4305902">d</span><span class="op" id="4305903">.</span><span class="ident" id="4305904">index</span>&nbsp;<span class="op" id="4305910">+</span>&nbsp;<span class="ident" id="4305912">d</span><span class="op" id="4305913">.</span><span class="ident" id="4305914">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4305927">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305931">prevLength</span>&nbsp;<span class="op" id="4305942">:=</span>&nbsp;<span class="ident" id="4305945">d</span><span class="op" id="4305946">.</span><span class="ident" id="4305947">length</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305956">prevOffset</span>&nbsp;<span class="op" id="4305967">:=</span>&nbsp;<span class="ident" id="4305970">d</span><span class="op" id="4305971">.</span><span class="ident" id="4305972">offset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4305981">d</span><span class="op" id="4305982">.</span><span class="ident" id="4305983">length</span>&nbsp;<span class="op" id="4305990">=</span>&nbsp;<span class="ident" id="4305992">minMatchLength</span>&nbsp;<span class="op" id="4306007">-</span>&nbsp;<span class="num" id="4306009">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306013">d</span><span class="op" id="4306014">.</span><span class="ident" id="4306015">offset</span>&nbsp;<span class="op" id="4306022">=</span>&nbsp;<span class="num" id="4306024">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306028">minIndex</span>&nbsp;<span class="op" id="4306037">:=</span>&nbsp;<span class="ident" id="4306040">d</span><span class="op" id="4306041">.</span><span class="ident" id="4306042">index</span>&nbsp;<span class="op" id="4306048">-</span>&nbsp;<span class="ident" id="4306050">windowSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4306063">if</span>&nbsp;<span class="ident" id="4306066">minIndex</span>&nbsp;<span class="op" id="4306075">&lt;</span>&nbsp;<span class="num" id="4306077">0</span>&nbsp;<span class="op" id="4306079">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306084">minIndex</span>&nbsp;<span class="op" id="4306093">=</span>&nbsp;<span class="num" id="4306095">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4306099">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4306104">if</span>&nbsp;<span class="ident" id="4306107">d</span><span class="op" id="4306108">.</span><span class="ident" id="4306109">chainHead</span><span class="op" id="4306118">-</span><span class="ident" id="4306119">d</span><span class="op" id="4306120">.</span><span class="ident" id="4306121">hashOffset</span>&nbsp;<span class="op" id="4306132">&gt;=</span>&nbsp;<span class="ident" id="4306135">minIndex</span>&nbsp;<span class="op" id="4306144">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4306150">(</span><span class="ident" id="4306151">d</span><span class="op" id="4306152">.</span><span class="ident" id="4306153">fastSkipHashing</span>&nbsp;<span class="op" id="4306169">!=</span>&nbsp;<span class="ident" id="4306172">skipNever</span>&nbsp;<span class="op" id="4306182">&amp;&amp;</span>&nbsp;<span class="ident" id="4306185">lookahead</span>&nbsp;<span class="op" id="4306195">&gt;</span>&nbsp;<span class="ident" id="4306197">minMatchLength</span><span class="op" id="4306211">-</span><span class="num" id="4306212">1</span>&nbsp;<span class="op" id="4306214">||</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306221">d</span><span class="op" id="4306222">.</span><span class="ident" id="4306223">fastSkipHashing</span>&nbsp;<span class="op" id="4306239">==</span>&nbsp;<span class="ident" id="4306242">skipNever</span>&nbsp;<span class="op" id="4306252">&amp;&amp;</span>&nbsp;<span class="ident" id="4306255">lookahead</span>&nbsp;<span class="op" id="4306265">&gt;</span>&nbsp;<span class="ident" id="4306267">prevLength</span>&nbsp;<span class="op" id="4306278">&amp;&amp;</span>&nbsp;<span class="ident" id="4306281">prevLength</span>&nbsp;<span class="op" id="4306292">&lt;</span>&nbsp;<span class="ident" id="4306294">d</span><span class="op" id="4306295">.</span><span class="ident" id="4306296">lazy</span><span class="op" id="4306300">)</span>&nbsp;<span class="op" id="4306302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4306307">if</span>&nbsp;<span class="ident" id="4306310">newLength</span><span class="op" id="4306319">,</span>&nbsp;<span class="ident" id="4306321">newOffset</span><span class="op" id="4306330">,</span>&nbsp;<span class="ident" id="4306332">ok</span>&nbsp;<span class="op" id="4306335">:=</span>&nbsp;<span class="ident" id="4306338">d</span><span class="op" id="4306339">.</span><span class="ident" id="4306340">findMatch</span><span class="op" id="4306349">(</span><span class="ident" id="4306350">d</span><span class="op" id="4306351">.</span><span class="ident" id="4306352">index</span><span class="op" id="4306357">,</span>&nbsp;<span class="ident" id="4306359">d</span><span class="op" id="4306360">.</span><span class="ident" id="4306361">chainHead</span><span class="op" id="4306370">-</span><span class="ident" id="4306371">d</span><span class="op" id="4306372">.</span><span class="ident" id="4306373">hashOffset</span><span class="op" id="4306383">,</span>&nbsp;<span class="ident" id="4306385">minMatchLength</span><span class="op" id="4306399">-</span><span class="num" id="4306400">1</span><span class="op" id="4306401">,</span>&nbsp;<span class="ident" id="4306403">lookahead</span><span class="op" id="4306412">)</span><span class="op" id="4306413">;</span>&nbsp;<span class="ident" id="4306415">ok</span>&nbsp;<span class="op" id="4306418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306424">d</span><span class="op" id="4306425">.</span><span class="ident" id="4306426">length</span>&nbsp;<span class="op" id="4306433">=</span>&nbsp;<span class="ident" id="4306435">newLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306449">d</span><span class="op" id="4306450">.</span><span class="ident" id="4306451">offset</span>&nbsp;<span class="op" id="4306458">=</span>&nbsp;<span class="ident" id="4306460">newOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4306473">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4306477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4306481">if</span>&nbsp;<span class="ident" id="4306484">d</span><span class="op" id="4306485">.</span><span class="ident" id="4306486">fastSkipHashing</span>&nbsp;<span class="op" id="4306502">!=</span>&nbsp;<span class="ident" id="4306505">skipNever</span>&nbsp;<span class="op" id="4306515">&amp;&amp;</span>&nbsp;<span class="ident" id="4306518">d</span><span class="op" id="4306519">.</span><span class="ident" id="4306520">length</span>&nbsp;<span class="op" id="4306527">&gt;=</span>&nbsp;<span class="ident" id="4306530">minMatchLength</span>&nbsp;<span class="op" id="4306545">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306551">d</span><span class="op" id="4306552">.</span><span class="ident" id="4306553">fastSkipHashing</span>&nbsp;<span class="op" id="4306569">==</span>&nbsp;<span class="ident" id="4306572">skipNever</span>&nbsp;<span class="op" id="4306582">&amp;&amp;</span>&nbsp;<span class="ident" id="4306585">prevLength</span>&nbsp;<span class="op" id="4306596">&gt;=</span>&nbsp;<span class="ident" id="4306599">minMatchLength</span>&nbsp;<span class="op" id="4306614">&amp;&amp;</span>&nbsp;<span class="ident" id="4306617">d</span><span class="op" id="4306618">.</span><span class="ident" id="4306619">length</span>&nbsp;<span class="op" id="4306626">&lt;=</span>&nbsp;<span class="ident" id="4306629">prevLength</span>&nbsp;<span class="op" id="4306640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4306645">//&nbsp;There&nbsp;was&nbsp;a&nbsp;match&nbsp;at&nbsp;the&nbsp;previous&nbsp;step,&nbsp;and&nbsp;the&nbsp;current&nbsp;match&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4306716">//&nbsp;not&nbsp;better.&nbsp;Output&nbsp;the&nbsp;previous&nbsp;match.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4306761">if</span>&nbsp;<span class="ident" id="4306764">d</span><span class="op" id="4306765">.</span><span class="ident" id="4306766">fastSkipHashing</span>&nbsp;<span class="op" id="4306782">!=</span>&nbsp;<span class="ident" id="4306785">skipNever</span>&nbsp;<span class="op" id="4306795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306801">d</span><span class="op" id="4306802">.</span><span class="ident" id="4306803">tokens</span>&nbsp;<span class="op" id="4306810">=</span>&nbsp;<span class="builtinfunc" id="4306812">append</span><span class="op" id="4306818">(</span><span class="ident" id="4306819">d</span><span class="op" id="4306820">.</span><span class="ident" id="4306821">tokens</span><span class="op" id="4306827">,</span>&nbsp;<span class="ident" id="4306829">matchToken</span><span class="op" id="4306839">(</span><span class="builtintype" id="4306840">uint32</span><span class="op" id="4306846">(</span><span class="ident" id="4306847">d</span><span class="op" id="4306848">.</span><span class="ident" id="4306849">length</span><span class="op" id="4306855">-</span><span class="ident" id="4306856">minMatchLength</span><span class="op" id="4306870">)</span><span class="op" id="4306871">,</span>&nbsp;<span class="builtintype" id="4306873">uint32</span><span class="op" id="4306879">(</span><span class="ident" id="4306880">d</span><span class="op" id="4306881">.</span><span class="ident" id="4306882">offset</span><span class="op" id="4306888">-</span><span class="ident" id="4306889">minOffsetSize</span><span class="op" id="4306902">)</span><span class="op" id="4306903">)</span><span class="op" id="4306904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4306909">}</span>&nbsp;<span class="keyword" id="4306911">else</span>&nbsp;<span class="op" id="4306916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4306922">d</span><span class="op" id="4306923">.</span><span class="ident" id="4306924">tokens</span>&nbsp;<span class="op" id="4306931">=</span>&nbsp;<span class="builtinfunc" id="4306933">append</span><span class="op" id="4306939">(</span><span class="ident" id="4306940">d</span><span class="op" id="4306941">.</span><span class="ident" id="4306942">tokens</span><span class="op" id="4306948">,</span>&nbsp;<span class="ident" id="4306950">matchToken</span><span class="op" id="4306960">(</span><span class="builtintype" id="4306961">uint32</span><span class="op" id="4306967">(</span><span class="ident" id="4306968">prevLength</span><span class="op" id="4306978">-</span><span class="ident" id="4306979">minMatchLength</span><span class="op" id="4306993">)</span><span class="op" id="4306994">,</span>&nbsp;<span class="builtintype" id="4306996">uint32</span><span class="op" id="4307002">(</span><span class="ident" id="4307003">prevOffset</span><span class="op" id="4307013">-</span><span class="ident" id="4307014">minOffsetSize</span><span class="op" id="4307027">)</span><span class="op" id="4307028">)</span><span class="op" id="4307029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307034">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307039">//&nbsp;Insert&nbsp;in&nbsp;the&nbsp;hash&nbsp;table&nbsp;all&nbsp;strings&nbsp;up&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;match.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307110">//&nbsp;index&nbsp;and&nbsp;index-1&nbsp;are&nbsp;already&nbsp;inserted.&nbsp;If&nbsp;there&nbsp;is&nbsp;not&nbsp;enough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307179">//&nbsp;lookahead,&nbsp;the&nbsp;last&nbsp;two&nbsp;strings&nbsp;are&nbsp;not&nbsp;inserted&nbsp;into&nbsp;the&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307248">//&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307261">if</span>&nbsp;<span class="ident" id="4307264">d</span><span class="op" id="4307265">.</span><span class="ident" id="4307266">length</span>&nbsp;<span class="op" id="4307273">&lt;=</span>&nbsp;<span class="ident" id="4307276">d</span><span class="op" id="4307277">.</span><span class="ident" id="4307278">fastSkipHashing</span>&nbsp;<span class="op" id="4307294">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307300">var</span>&nbsp;<span class="ident" id="4307304">newIndex</span>&nbsp;<span class="builtintype" id="4307313">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307321">if</span>&nbsp;<span class="ident" id="4307324">d</span><span class="op" id="4307325">.</span><span class="ident" id="4307326">fastSkipHashing</span>&nbsp;<span class="op" id="4307342">!=</span>&nbsp;<span class="ident" id="4307345">skipNever</span>&nbsp;<span class="op" id="4307355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307362">newIndex</span>&nbsp;<span class="op" id="4307371">=</span>&nbsp;<span class="ident" id="4307373">d</span><span class="op" id="4307374">.</span><span class="ident" id="4307375">index</span>&nbsp;<span class="op" id="4307381">+</span>&nbsp;<span class="ident" id="4307383">d</span><span class="op" id="4307384">.</span><span class="ident" id="4307385">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307396">}</span>&nbsp;<span class="keyword" id="4307398">else</span>&nbsp;<span class="op" id="4307403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307410">newIndex</span>&nbsp;<span class="op" id="4307419">=</span>&nbsp;<span class="ident" id="4307421">d</span><span class="op" id="4307422">.</span><span class="ident" id="4307423">index</span>&nbsp;<span class="op" id="4307429">+</span>&nbsp;<span class="ident" id="4307431">prevLength</span>&nbsp;<span class="op" id="4307442">-</span>&nbsp;<span class="num" id="4307444">1</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307456">for</span>&nbsp;<span class="ident" id="4307460">d</span><span class="op" id="4307461">.</span><span class="ident" id="4307462">index</span><span class="op" id="4307467">++</span><span class="op" id="4307469">;</span>&nbsp;<span class="ident" id="4307471">d</span><span class="op" id="4307472">.</span><span class="ident" id="4307473">index</span>&nbsp;<span class="op" id="4307479">&lt;</span>&nbsp;<span class="ident" id="4307481">newIndex</span><span class="op" id="4307489">;</span>&nbsp;<span class="ident" id="4307491">d</span><span class="op" id="4307492">.</span><span class="ident" id="4307493">index</span><span class="op" id="4307498">++</span>&nbsp;<span class="op" id="4307501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307508">if</span>&nbsp;<span class="ident" id="4307511">d</span><span class="op" id="4307512">.</span><span class="ident" id="4307513">index</span>&nbsp;<span class="op" id="4307519">&lt;</span>&nbsp;<span class="ident" id="4307521">d</span><span class="op" id="4307522">.</span><span class="ident" id="4307523">maxInsertIndex</span>&nbsp;<span class="op" id="4307538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307546">d</span><span class="op" id="4307547">.</span><span class="ident" id="4307548">hash</span>&nbsp;<span class="op" id="4307553">=</span>&nbsp;<span class="op" id="4307555">(</span><span class="ident" id="4307556">d</span><span class="op" id="4307557">.</span><span class="ident" id="4307558">hash</span><span class="op" id="4307562">&lt;&lt;</span><span class="ident" id="4307564">hashShift</span>&nbsp;<span class="op" id="4307574">+</span>&nbsp;<span class="builtintype" id="4307576">int</span><span class="op" id="4307579">(</span><span class="ident" id="4307580">d</span><span class="op" id="4307581">.</span><span class="ident" id="4307582">window</span><span class="op" id="4307588">[</span><span class="ident" id="4307589">d</span><span class="op" id="4307590">.</span><span class="ident" id="4307591">index</span><span class="op" id="4307596">+</span><span class="num" id="4307597">2</span><span class="op" id="4307598">]</span><span class="op" id="4307599">)</span><span class="op" id="4307600">)</span>&nbsp;<span class="op" id="4307602">&amp;</span>&nbsp;<span class="ident" id="4307604">hashMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307619">//&nbsp;Get&nbsp;previous&nbsp;value&nbsp;with&nbsp;the&nbsp;same&nbsp;hash.</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307667">//&nbsp;Our&nbsp;chain&nbsp;should&nbsp;point&nbsp;to&nbsp;the&nbsp;previous&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307722">d</span><span class="op" id="4307723">.</span><span class="ident" id="4307724">hashPrev</span><span class="op" id="4307732">[</span><span class="ident" id="4307733">d</span><span class="op" id="4307734">.</span><span class="ident" id="4307735">index</span><span class="op" id="4307740">&amp;</span><span class="ident" id="4307741">windowMask</span><span class="op" id="4307751">]</span>&nbsp;<span class="op" id="4307753">=</span>&nbsp;<span class="ident" id="4307755">d</span><span class="op" id="4307756">.</span><span class="ident" id="4307757">hashHead</span><span class="op" id="4307765">[</span><span class="ident" id="4307766">d</span><span class="op" id="4307767">.</span><span class="ident" id="4307768">hash</span><span class="op" id="4307772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4307780">//&nbsp;Set&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;hash&nbsp;chain&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307827">d</span><span class="op" id="4307828">.</span><span class="ident" id="4307829">hashHead</span><span class="op" id="4307837">[</span><span class="ident" id="4307838">d</span><span class="op" id="4307839">.</span><span class="ident" id="4307840">hash</span><span class="op" id="4307844">]</span>&nbsp;<span class="op" id="4307846">=</span>&nbsp;<span class="ident" id="4307848">d</span><span class="op" id="4307849">.</span><span class="ident" id="4307850">index</span>&nbsp;<span class="op" id="4307856">+</span>&nbsp;<span class="ident" id="4307858">d</span><span class="op" id="4307859">.</span><span class="ident" id="4307860">hashOffset</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307876">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4307888">if</span>&nbsp;<span class="ident" id="4307891">d</span><span class="op" id="4307892">.</span><span class="ident" id="4307893">fastSkipHashing</span>&nbsp;<span class="op" id="4307909">==</span>&nbsp;<span class="ident" id="4307912">skipNever</span>&nbsp;<span class="op" id="4307922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307929">d</span><span class="op" id="4307930">.</span><span class="ident" id="4307931">byteAvailable</span>&nbsp;<span class="op" id="4307945">=</span>&nbsp;<span class="ident" id="4307947">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4307958">d</span><span class="op" id="4307959">.</span><span class="ident" id="4307960">length</span>&nbsp;<span class="op" id="4307967">=</span>&nbsp;<span class="ident" id="4307969">minMatchLength</span>&nbsp;<span class="op" id="4307984">-</span>&nbsp;<span class="num" id="4307986">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307992">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4307997">}</span>&nbsp;<span class="keyword" id="4307999">else</span>&nbsp;<span class="op" id="4308004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4308010">//&nbsp;For&nbsp;matches&nbsp;this&nbsp;long,&nbsp;we&nbsp;don&#39;t&nbsp;bother&nbsp;inserting&nbsp;each&nbsp;individual</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4308082">//&nbsp;item&nbsp;into&nbsp;the&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308110">d</span><span class="op" id="4308111">.</span><span class="ident" id="4308112">index</span>&nbsp;<span class="op" id="4308118">+=</span>&nbsp;<span class="ident" id="4308121">d</span><span class="op" id="4308122">.</span><span class="ident" id="4308123">length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308134">if</span>&nbsp;<span class="ident" id="4308137">d</span><span class="op" id="4308138">.</span><span class="ident" id="4308139">index</span>&nbsp;<span class="op" id="4308145">&lt;</span>&nbsp;<span class="ident" id="4308147">d</span><span class="op" id="4308148">.</span><span class="ident" id="4308149">maxInsertIndex</span>&nbsp;<span class="op" id="4308164">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308171">d</span><span class="op" id="4308172">.</span><span class="ident" id="4308173">hash</span>&nbsp;<span class="op" id="4308178">=</span>&nbsp;<span class="op" id="4308180">(</span><span class="builtintype" id="4308181">int</span><span class="op" id="4308184">(</span><span class="ident" id="4308185">d</span><span class="op" id="4308186">.</span><span class="ident" id="4308187">window</span><span class="op" id="4308193">[</span><span class="ident" id="4308194">d</span><span class="op" id="4308195">.</span><span class="ident" id="4308196">index</span><span class="op" id="4308201">]</span><span class="op" id="4308202">)</span><span class="op" id="4308203">&lt;&lt;</span><span class="ident" id="4308205">hashShift</span>&nbsp;<span class="op" id="4308215">+</span>&nbsp;<span class="builtintype" id="4308217">int</span><span class="op" id="4308220">(</span><span class="ident" id="4308221">d</span><span class="op" id="4308222">.</span><span class="ident" id="4308223">window</span><span class="op" id="4308229">[</span><span class="ident" id="4308230">d</span><span class="op" id="4308231">.</span><span class="ident" id="4308232">index</span><span class="op" id="4308237">+</span><span class="num" id="4308238">1</span><span class="op" id="4308239">]</span><span class="op" id="4308240">)</span><span class="op" id="4308241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308257">if</span>&nbsp;<span class="builtinfunc" id="4308260">len</span><span class="op" id="4308263">(</span><span class="ident" id="4308264">d</span><span class="op" id="4308265">.</span><span class="ident" id="4308266">tokens</span><span class="op" id="4308272">)</span>&nbsp;<span class="op" id="4308274">==</span>&nbsp;<span class="ident" id="4308277">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4308297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4308303">//&nbsp;The&nbsp;block&nbsp;includes&nbsp;the&nbsp;current&nbsp;character</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308351">if</span>&nbsp;<span class="ident" id="4308354">d</span><span class="op" id="4308355">.</span><span class="ident" id="4308356">err</span>&nbsp;<span class="op" id="4308360">=</span>&nbsp;<span class="ident" id="4308362">d</span><span class="op" id="4308363">.</span><span class="ident" id="4308364">writeBlock</span><span class="op" id="4308374">(</span><span class="ident" id="4308375">d</span><span class="op" id="4308376">.</span><span class="ident" id="4308377">tokens</span><span class="op" id="4308383">,</span>&nbsp;<span class="ident" id="4308385">d</span><span class="op" id="4308386">.</span><span class="ident" id="4308387">index</span><span class="op" id="4308392">,</span>&nbsp;<span class="ident" id="4308394">false</span><span class="op" id="4308399">)</span><span class="op" id="4308400">;</span>&nbsp;<span class="ident" id="4308402">d</span><span class="op" id="4308403">.</span><span class="ident" id="4308404">err</span>&nbsp;<span class="op" id="4308408">!=</span>&nbsp;<span class="ident" id="4308411">nil</span>&nbsp;<span class="op" id="4308415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308422">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308439">d</span><span class="op" id="4308440">.</span><span class="ident" id="4308441">tokens</span>&nbsp;<span class="op" id="4308448">=</span>&nbsp;<span class="ident" id="4308450">d</span><span class="op" id="4308451">.</span><span class="ident" id="4308452">tokens</span><span class="op" id="4308458">[</span><span class="op" id="4308459">:</span><span class="num" id="4308460">0</span><span class="op" id="4308461">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308466">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308470">}</span>&nbsp;<span class="keyword" id="4308472">else</span>&nbsp;<span class="op" id="4308477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308482">if</span>&nbsp;<span class="ident" id="4308485">d</span><span class="op" id="4308486">.</span><span class="ident" id="4308487">fastSkipHashing</span>&nbsp;<span class="op" id="4308503">!=</span>&nbsp;<span class="ident" id="4308506">skipNever</span>&nbsp;<span class="op" id="4308516">||</span>&nbsp;<span class="ident" id="4308519">d</span><span class="op" id="4308520">.</span><span class="ident" id="4308521">byteAvailable</span>&nbsp;<span class="op" id="4308535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308541">i</span>&nbsp;<span class="op" id="4308543">:=</span>&nbsp;<span class="ident" id="4308546">d</span><span class="op" id="4308547">.</span><span class="ident" id="4308548">index</span>&nbsp;<span class="op" id="4308554">-</span>&nbsp;<span class="num" id="4308556">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308562">if</span>&nbsp;<span class="ident" id="4308565">d</span><span class="op" id="4308566">.</span><span class="ident" id="4308567">fastSkipHashing</span>&nbsp;<span class="op" id="4308583">!=</span>&nbsp;<span class="ident" id="4308586">skipNever</span>&nbsp;<span class="op" id="4308596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308603">i</span>&nbsp;<span class="op" id="4308605">=</span>&nbsp;<span class="ident" id="4308607">d</span><span class="op" id="4308608">.</span><span class="ident" id="4308609">index</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308625">d</span><span class="op" id="4308626">.</span><span class="ident" id="4308627">tokens</span>&nbsp;<span class="op" id="4308634">=</span>&nbsp;<span class="builtinfunc" id="4308636">append</span><span class="op" id="4308642">(</span><span class="ident" id="4308643">d</span><span class="op" id="4308644">.</span><span class="ident" id="4308645">tokens</span><span class="op" id="4308651">,</span>&nbsp;<span class="ident" id="4308653">literalToken</span><span class="op" id="4308665">(</span><span class="builtintype" id="4308666">uint32</span><span class="op" id="4308672">(</span><span class="ident" id="4308673">d</span><span class="op" id="4308674">.</span><span class="ident" id="4308675">window</span><span class="op" id="4308681">[</span><span class="ident" id="4308682">i</span><span class="op" id="4308683">]</span><span class="op" id="4308684">)</span><span class="op" id="4308685">)</span><span class="op" id="4308686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308692">if</span>&nbsp;<span class="builtinfunc" id="4308695">len</span><span class="op" id="4308698">(</span><span class="ident" id="4308699">d</span><span class="op" id="4308700">.</span><span class="ident" id="4308701">tokens</span><span class="op" id="4308707">)</span>&nbsp;<span class="op" id="4308709">==</span>&nbsp;<span class="ident" id="4308712">maxFlateBlockTokens</span>&nbsp;<span class="op" id="4308732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308739">if</span>&nbsp;<span class="ident" id="4308742">d</span><span class="op" id="4308743">.</span><span class="ident" id="4308744">err</span>&nbsp;<span class="op" id="4308748">=</span>&nbsp;<span class="ident" id="4308750">d</span><span class="op" id="4308751">.</span><span class="ident" id="4308752">writeBlock</span><span class="op" id="4308762">(</span><span class="ident" id="4308763">d</span><span class="op" id="4308764">.</span><span class="ident" id="4308765">tokens</span><span class="op" id="4308771">,</span>&nbsp;<span class="ident" id="4308773">i</span><span class="op" id="4308774">+</span><span class="num" id="4308775">1</span><span class="op" id="4308776">,</span>&nbsp;<span class="ident" id="4308778">false</span><span class="op" id="4308783">)</span><span class="op" id="4308784">;</span>&nbsp;<span class="ident" id="4308786">d</span><span class="op" id="4308787">.</span><span class="ident" id="4308788">err</span>&nbsp;<span class="op" id="4308792">!=</span>&nbsp;<span class="ident" id="4308795">nil</span>&nbsp;<span class="op" id="4308799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308807">return</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308826">d</span><span class="op" id="4308827">.</span><span class="ident" id="4308828">tokens</span>&nbsp;<span class="op" id="4308835">=</span>&nbsp;<span class="ident" id="4308837">d</span><span class="op" id="4308838">.</span><span class="ident" id="4308839">tokens</span><span class="op" id="4308845">[</span><span class="op" id="4308846">:</span><span class="num" id="4308847">0</span><span class="op" id="4308848">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308864">d</span><span class="op" id="4308865">.</span><span class="ident" id="4308866">index</span><span class="op" id="4308871">++</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4308877">if</span>&nbsp;<span class="ident" id="4308880">d</span><span class="op" id="4308881">.</span><span class="ident" id="4308882">fastSkipHashing</span>&nbsp;<span class="op" id="4308898">==</span>&nbsp;<span class="ident" id="4308901">skipNever</span>&nbsp;<span class="op" id="4308911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4308917">d</span><span class="op" id="4308918">.</span><span class="ident" id="4308919">byteAvailable</span>&nbsp;<span class="op" id="4308933">=</span>&nbsp;<span class="ident" id="4308935">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308947">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4308950">}</span><br>
<span class="lineno">360</span><span class="op" id="4308952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4308955">func</span>&nbsp;<span class="op" id="4308960">(</span><span class="ident" id="4308961">d</span>&nbsp;<span class="op" id="4308963">*</span><span class="ident" id="4308964">compressor</span><span class="op" id="4308974">)</span>&nbsp;<span class="ident" id="4308976">fillStore</span><span class="op" id="4308985">(</span><span class="ident" id="4308986">b</span>&nbsp;<span class="op" id="4308988">[</span><span class="op" id="4308989">]</span><span class="builtintype" id="4308990">byte</span><span class="op" id="4308994">)</span>&nbsp;<span class="builtintype" id="4308996">int</span>&nbsp;<span class="op" id="4309000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309003">n</span>&nbsp;<span class="op" id="4309005">:=</span>&nbsp;<span class="builtinfunc" id="4309008">copy</span><span class="op" id="4309012">(</span><span class="ident" id="4309013">d</span><span class="op" id="4309014">.</span><span class="ident" id="4309015">window</span><span class="op" id="4309021">[</span><span class="ident" id="4309022">d</span><span class="op" id="4309023">.</span><span class="ident" id="4309024">windowEnd</span><span class="op" id="4309033">:</span><span class="op" id="4309034">]</span><span class="op" id="4309035">,</span>&nbsp;<span class="ident" id="4309037">b</span><span class="op" id="4309038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309041">d</span><span class="op" id="4309042">.</span><span class="ident" id="4309043">windowEnd</span>&nbsp;<span class="op" id="4309053">+=</span>&nbsp;<span class="ident" id="4309056">n</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309059">return</span>&nbsp;<span class="ident" id="4309066">n</span><br>
<span class="lineno"></span><span class="op" id="4309068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4309071">func</span>&nbsp;<span class="op" id="4309076">(</span><span class="ident" id="4309077">d</span>&nbsp;<span class="op" id="4309079">*</span><span class="ident" id="4309080">compressor</span><span class="op" id="4309090">)</span>&nbsp;<span class="ident" id="4309092">store</span><span class="op" id="4309097">(</span><span class="op" id="4309098">)</span>&nbsp;<span class="op" id="4309100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309103">if</span>&nbsp;<span class="ident" id="4309106">d</span><span class="op" id="4309107">.</span><span class="ident" id="4309108">windowEnd</span>&nbsp;<span class="op" id="4309118">&gt;</span>&nbsp;<span class="num" id="4309120">0</span>&nbsp;<span class="op" id="4309122">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309126">d</span><span class="op" id="4309127">.</span><span class="ident" id="4309128">err</span>&nbsp;<span class="op" id="4309132">=</span>&nbsp;<span class="ident" id="4309134">d</span><span class="op" id="4309135">.</span><span class="ident" id="4309136">writeStoredBlock</span><span class="op" id="4309152">(</span><span class="ident" id="4309153">d</span><span class="op" id="4309154">.</span><span class="ident" id="4309155">window</span><span class="op" id="4309161">[</span><span class="op" id="4309162">:</span><span class="ident" id="4309163">d</span><span class="op" id="4309164">.</span><span class="ident" id="4309165">windowEnd</span><span class="op" id="4309174">]</span><span class="op" id="4309175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4309178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309181">d</span><span class="op" id="4309182">.</span><span class="ident" id="4309183">windowEnd</span>&nbsp;<span class="op" id="4309193">=</span>&nbsp;<span class="num" id="4309195">0</span><br>
<span class="lineno"></span><span class="op" id="4309197">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span><span class="keyword" id="4309200">func</span>&nbsp;<span class="op" id="4309205">(</span><span class="ident" id="4309206">d</span>&nbsp;<span class="op" id="4309208">*</span><span class="ident" id="4309209">compressor</span><span class="op" id="4309219">)</span>&nbsp;<span class="ident" id="4309221">write</span><span class="op" id="4309226">(</span><span class="ident" id="4309227">b</span>&nbsp;<span class="op" id="4309229">[</span><span class="op" id="4309230">]</span><span class="builtintype" id="4309231">byte</span><span class="op" id="4309235">)</span>&nbsp;<span class="op" id="4309237">(</span><span class="ident" id="4309238">n</span>&nbsp;<span class="builtintype" id="4309240">int</span><span class="op" id="4309243">,</span>&nbsp;<span class="ident" id="4309245">err</span>&nbsp;<span class="builtintype" id="4309249">error</span><span class="op" id="4309254">)</span>&nbsp;<span class="op" id="4309256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309259">n</span>&nbsp;<span class="op" id="4309261">=</span>&nbsp;<span class="builtinfunc" id="4309263">len</span><span class="op" id="4309266">(</span><span class="ident" id="4309267">b</span><span class="op" id="4309268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309271">b</span>&nbsp;<span class="op" id="4309273">=</span>&nbsp;<span class="ident" id="4309275">b</span><span class="op" id="4309276">[</span><span class="ident" id="4309277">d</span><span class="op" id="4309278">.</span><span class="ident" id="4309279">fill</span><span class="op" id="4309283">(</span><span class="ident" id="4309284">d</span><span class="op" id="4309285">,</span>&nbsp;<span class="ident" id="4309287">b</span><span class="op" id="4309288">)</span><span class="op" id="4309289">:</span><span class="op" id="4309290">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309293">for</span>&nbsp;<span class="builtinfunc" id="4309297">len</span><span class="op" id="4309300">(</span><span class="ident" id="4309301">b</span><span class="op" id="4309302">)</span>&nbsp;<span class="op" id="4309304">&gt;</span>&nbsp;<span class="num" id="4309306">0</span>&nbsp;<span class="op" id="4309308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309312">d</span><span class="op" id="4309313">.</span><span class="ident" id="4309314">step</span><span class="op" id="4309318">(</span><span class="ident" id="4309319">d</span><span class="op" id="4309320">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309324">b</span>&nbsp;<span class="op" id="4309326">=</span>&nbsp;<span class="ident" id="4309328">b</span><span class="op" id="4309329">[</span><span class="ident" id="4309330">d</span><span class="op" id="4309331">.</span><span class="ident" id="4309332">fill</span><span class="op" id="4309336">(</span><span class="ident" id="4309337">d</span><span class="op" id="4309338">,</span>&nbsp;<span class="ident" id="4309340">b</span><span class="op" id="4309341">)</span><span class="op" id="4309342">:</span><span class="op" id="4309343">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4309346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309349">return</span>&nbsp;<span class="ident" id="4309356">n</span><span class="op" id="4309357">,</span>&nbsp;<span class="ident" id="4309359">d</span><span class="op" id="4309360">.</span><span class="ident" id="4309361">err</span><br>
<span class="lineno"></span><span class="op" id="4309365">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span><span class="keyword" id="4309368">func</span>&nbsp;<span class="op" id="4309373">(</span><span class="ident" id="4309374">d</span>&nbsp;<span class="op" id="4309376">*</span><span class="ident" id="4309377">compressor</span><span class="op" id="4309387">)</span>&nbsp;<span class="ident" id="4309389">syncFlush</span><span class="op" id="4309398">(</span><span class="op" id="4309399">)</span>&nbsp;<span class="builtintype" id="4309401">error</span>&nbsp;<span class="op" id="4309407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309410">d</span><span class="op" id="4309411">.</span><span class="ident" id="4309412">sync</span>&nbsp;<span class="op" id="4309417">=</span>&nbsp;<span class="ident" id="4309419">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309425">d</span><span class="op" id="4309426">.</span><span class="ident" id="4309427">step</span><span class="op" id="4309431">(</span><span class="ident" id="4309432">d</span><span class="op" id="4309433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309436">if</span>&nbsp;<span class="ident" id="4309439">d</span><span class="op" id="4309440">.</span><span class="ident" id="4309441">err</span>&nbsp;<span class="op" id="4309445">==</span>&nbsp;<span class="ident" id="4309448">nil</span>&nbsp;<span class="op" id="4309452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309456">d</span><span class="op" id="4309457">.</span><span class="ident" id="4309458">w</span><span class="op" id="4309459">.</span><span class="ident" id="4309460">writeStoredHeader</span><span class="op" id="4309477">(</span><span class="num" id="4309478">0</span><span class="op" id="4309479">,</span>&nbsp;<span class="ident" id="4309481">false</span><span class="op" id="4309486">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309490">d</span><span class="op" id="4309491">.</span><span class="ident" id="4309492">w</span><span class="op" id="4309493">.</span><span class="ident" id="4309494">flush</span><span class="op" id="4309499">(</span><span class="op" id="4309500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309504">d</span><span class="op" id="4309505">.</span><span class="ident" id="4309506">err</span>&nbsp;<span class="op" id="4309510">=</span>&nbsp;<span class="ident" id="4309512">d</span><span class="op" id="4309513">.</span><span class="ident" id="4309514">w</span><span class="op" id="4309515">.</span><span class="ident" id="4309516">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4309521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309524">d</span><span class="op" id="4309525">.</span><span class="ident" id="4309526">sync</span>&nbsp;<span class="op" id="4309531">=</span>&nbsp;<span class="ident" id="4309533">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309540">return</span>&nbsp;<span class="ident" id="4309547">d</span><span class="op" id="4309548">.</span><span class="ident" id="4309549">err</span><br>
<span class="lineno">395</span><span class="op" id="4309553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4309556">func</span>&nbsp;<span class="op" id="4309561">(</span><span class="ident" id="4309562">d</span>&nbsp;<span class="op" id="4309564">*</span><span class="ident" id="4309565">compressor</span><span class="op" id="4309575">)</span>&nbsp;<span class="ident" id="4309577">init</span><span class="op" id="4309581">(</span><span class="ident" id="4309582">w</span>&nbsp;<span class="ident" id="4309584">io</span><span class="op" id="4309586">.</span><span class="ident" id="4309587">Writer</span><span class="op" id="4309593">,</span>&nbsp;<span class="ident" id="4309595">level</span>&nbsp;<span class="builtintype" id="4309601">int</span><span class="op" id="4309604">)</span>&nbsp;<span class="op" id="4309606">(</span><span class="ident" id="4309607">err</span>&nbsp;<span class="builtintype" id="4309611">error</span><span class="op" id="4309616">)</span>&nbsp;<span class="op" id="4309618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309621">d</span><span class="op" id="4309622">.</span><span class="ident" id="4309623">w</span>&nbsp;<span class="op" id="4309625">=</span>&nbsp;<span class="ident" id="4309627">newHuffmanBitWriter</span><span class="op" id="4309646">(</span><span class="ident" id="4309647">w</span><span class="op" id="4309648">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309652">switch</span>&nbsp;<span class="op" id="4309659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309662">case</span>&nbsp;<span class="ident" id="4309667">level</span>&nbsp;<span class="op" id="4309673">==</span>&nbsp;<span class="ident" id="4309676">NoCompression</span><span class="op" id="4309689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309693">d</span><span class="op" id="4309694">.</span><span class="ident" id="4309695">window</span>&nbsp;<span class="op" id="4309702">=</span>&nbsp;<span class="builtinfunc" id="4309704">make</span><span class="op" id="4309708">(</span><span class="op" id="4309709">[</span><span class="op" id="4309710">]</span><span class="builtintype" id="4309711">byte</span><span class="op" id="4309715">,</span>&nbsp;<span class="ident" id="4309717">maxStoreBlockSize</span><span class="op" id="4309734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309738">d</span><span class="op" id="4309739">.</span><span class="ident" id="4309740">fill</span>&nbsp;<span class="op" id="4309745">=</span>&nbsp;<span class="op" id="4309747">(</span><span class="op" id="4309748">*</span><span class="ident" id="4309749">compressor</span><span class="op" id="4309759">)</span><span class="op" id="4309760">.</span><span class="ident" id="4309761">fillStore</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309773">d</span><span class="op" id="4309774">.</span><span class="ident" id="4309775">step</span>&nbsp;<span class="op" id="4309780">=</span>&nbsp;<span class="op" id="4309782">(</span><span class="op" id="4309783">*</span><span class="ident" id="4309784">compressor</span><span class="op" id="4309794">)</span><span class="op" id="4309795">.</span><span class="ident" id="4309796">store</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309803">case</span>&nbsp;<span class="ident" id="4309808">level</span>&nbsp;<span class="op" id="4309814">==</span>&nbsp;<span class="ident" id="4309817">DefaultCompression</span><span class="op" id="4309835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309839">level</span>&nbsp;<span class="op" id="4309845">=</span>&nbsp;<span class="num" id="4309847">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309851">fallthrough</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4309864">case</span>&nbsp;<span class="num" id="4309869">1</span>&nbsp;<span class="op" id="4309871">&lt;=</span>&nbsp;<span class="ident" id="4309874">level</span>&nbsp;<span class="op" id="4309880">&amp;&amp;</span>&nbsp;<span class="ident" id="4309883">level</span>&nbsp;<span class="op" id="4309889">&lt;=</span>&nbsp;<span class="num" id="4309892">9</span><span class="op" id="4309893">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309897">d</span><span class="op" id="4309898">.</span><span class="ident" id="4309899">compressionLevel</span>&nbsp;<span class="op" id="4309916">=</span>&nbsp;<span class="ident" id="4309918">levels</span><span class="op" id="4309924">[</span><span class="ident" id="4309925">level</span><span class="op" id="4309930">]</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309934">d</span><span class="op" id="4309935">.</span><span class="ident" id="4309936">initDeflate</span><span class="op" id="4309947">(</span><span class="op" id="4309948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309952">d</span><span class="op" id="4309953">.</span><span class="ident" id="4309954">fill</span>&nbsp;<span class="op" id="4309959">=</span>&nbsp;<span class="op" id="4309961">(</span><span class="op" id="4309962">*</span><span class="ident" id="4309963">compressor</span><span class="op" id="4309973">)</span><span class="op" id="4309974">.</span><span class="ident" id="4309975">fillDeflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4309989">d</span><span class="op" id="4309990">.</span><span class="ident" id="4309991">step</span>&nbsp;<span class="op" id="4309996">=</span>&nbsp;<span class="op" id="4309998">(</span><span class="op" id="4309999">*</span><span class="ident" id="4310000">compressor</span><span class="op" id="4310010">)</span><span class="op" id="4310011">.</span><span class="ident" id="4310012">deflate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310021">default</span><span class="op" id="4310028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310032">return</span>&nbsp;<span class="ident" id="4310039">fmt</span><span class="op" id="4310042">.</span><span class="ident" id="4310043">Errorf</span><span class="op" id="4310049">(</span><span class="string" id="4310050">&#34;flate:&nbsp;invalid&nbsp;compression&nbsp;level&nbsp;%d:&nbsp;want&nbsp;value&nbsp;in&nbsp;range&nbsp;[-1,&nbsp;9]&#34;</span><span class="op" id="4310116">,</span>&nbsp;<span class="ident" id="4310118">level</span><span class="op" id="4310123">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310129">return</span>&nbsp;<span class="ident" id="4310136">nil</span><br>
<span class="lineno"></span><span class="op" id="4310140">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4310143">var</span>&nbsp;<span class="ident" id="4310147">zeroes</span>&nbsp;<span class="op" id="4310154">[</span><span class="num" id="4310155">32</span><span class="op" id="4310157">]</span><span class="builtintype" id="4310158">int</span><br>
<span class="lineno">420</span><span class="keyword" id="4310162">var</span>&nbsp;<span class="ident" id="4310166">bzeroes</span>&nbsp;<span class="op" id="4310174">[</span><span class="num" id="4310175">256</span><span class="op" id="4310178">]</span><span class="builtintype" id="4310179">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4310185">func</span>&nbsp;<span class="op" id="4310190">(</span><span class="ident" id="4310191">d</span>&nbsp;<span class="op" id="4310193">*</span><span class="ident" id="4310194">compressor</span><span class="op" id="4310204">)</span>&nbsp;<span class="ident" id="4310206">reset</span><span class="op" id="4310211">(</span><span class="ident" id="4310212">w</span>&nbsp;<span class="ident" id="4310214">io</span><span class="op" id="4310216">.</span><span class="ident" id="4310217">Writer</span><span class="op" id="4310223">)</span>&nbsp;<span class="op" id="4310225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310228">d</span><span class="op" id="4310229">.</span><span class="ident" id="4310230">w</span><span class="op" id="4310231">.</span><span class="ident" id="4310232">reset</span><span class="op" id="4310237">(</span><span class="ident" id="4310238">w</span><span class="op" id="4310239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310242">d</span><span class="op" id="4310243">.</span><span class="ident" id="4310244">sync</span>&nbsp;<span class="op" id="4310249">=</span>&nbsp;<span class="ident" id="4310251">false</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310258">d</span><span class="op" id="4310259">.</span><span class="ident" id="4310260">err</span>&nbsp;<span class="op" id="4310264">=</span>&nbsp;<span class="ident" id="4310266">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310271">switch</span>&nbsp;<span class="ident" id="4310278">d</span><span class="op" id="4310279">.</span><span class="ident" id="4310280">compressionLevel</span><span class="op" id="4310296">.</span><span class="ident" id="4310297">chain</span>&nbsp;<span class="op" id="4310303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310306">case</span>&nbsp;<span class="num" id="4310311">0</span><span class="op" id="4310312">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4310316">//&nbsp;level&nbsp;was&nbsp;NoCompression.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310346">for</span>&nbsp;<span class="ident" id="4310350">i</span>&nbsp;<span class="op" id="4310352">:=</span>&nbsp;<span class="keyword" id="4310355">range</span>&nbsp;<span class="ident" id="4310361">d</span><span class="op" id="4310362">.</span><span class="ident" id="4310363">window</span>&nbsp;<span class="op" id="4310370">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310375">d</span><span class="op" id="4310376">.</span><span class="ident" id="4310377">window</span><span class="op" id="4310383">[</span><span class="ident" id="4310384">i</span><span class="op" id="4310385">]</span>&nbsp;<span class="op" id="4310387">=</span>&nbsp;<span class="num" id="4310389">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310397">d</span><span class="op" id="4310398">.</span><span class="ident" id="4310399">windowEnd</span>&nbsp;<span class="op" id="4310409">=</span>&nbsp;<span class="num" id="4310411">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310414">default</span><span class="op" id="4310421">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310425">d</span><span class="op" id="4310426">.</span><span class="ident" id="4310427">chainHead</span>&nbsp;<span class="op" id="4310437">=</span>&nbsp;<span class="op" id="4310439">-</span><span class="num" id="4310440">1</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310444">for</span>&nbsp;<span class="ident" id="4310448">s</span>&nbsp;<span class="op" id="4310450">:=</span>&nbsp;<span class="ident" id="4310453">d</span><span class="op" id="4310454">.</span><span class="ident" id="4310455">hashHead</span><span class="op" id="4310463">;</span>&nbsp;<span class="builtinfunc" id="4310465">len</span><span class="op" id="4310468">(</span><span class="ident" id="4310469">s</span><span class="op" id="4310470">)</span>&nbsp;<span class="op" id="4310472">&gt;</span>&nbsp;<span class="num" id="4310474">0</span><span class="op" id="4310475">;</span>&nbsp;<span class="op" id="4310477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310482">n</span>&nbsp;<span class="op" id="4310484">:=</span>&nbsp;<span class="builtinfunc" id="4310487">copy</span><span class="op" id="4310491">(</span><span class="ident" id="4310492">s</span><span class="op" id="4310493">,</span>&nbsp;<span class="ident" id="4310495">zeroes</span><span class="op" id="4310501">[</span><span class="op" id="4310502">:</span><span class="op" id="4310503">]</span><span class="op" id="4310504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310509">s</span>&nbsp;<span class="op" id="4310511">=</span>&nbsp;<span class="ident" id="4310513">s</span><span class="op" id="4310514">[</span><span class="ident" id="4310515">n</span><span class="op" id="4310516">:</span><span class="op" id="4310517">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310525">for</span>&nbsp;<span class="ident" id="4310529">s</span>&nbsp;<span class="op" id="4310531">:=</span>&nbsp;<span class="ident" id="4310534">d</span><span class="op" id="4310535">.</span><span class="ident" id="4310536">hashPrev</span><span class="op" id="4310544">;</span>&nbsp;<span class="builtinfunc" id="4310546">len</span><span class="op" id="4310549">(</span><span class="ident" id="4310550">s</span><span class="op" id="4310551">)</span>&nbsp;<span class="op" id="4310553">&gt;</span>&nbsp;<span class="num" id="4310555">0</span><span class="op" id="4310556">;</span>&nbsp;<span class="ident" id="4310558">s</span>&nbsp;<span class="op" id="4310560">=</span>&nbsp;<span class="ident" id="4310562">s</span><span class="op" id="4310563">[</span><span class="builtinfunc" id="4310564">len</span><span class="op" id="4310567">(</span><span class="ident" id="4310568">zeroes</span><span class="op" id="4310574">)</span><span class="op" id="4310575">:</span><span class="op" id="4310576">]</span>&nbsp;<span class="op" id="4310578">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4310583">copy</span><span class="op" id="4310587">(</span><span class="ident" id="4310588">s</span><span class="op" id="4310589">,</span>&nbsp;<span class="ident" id="4310591">zeroes</span><span class="op" id="4310597">[</span><span class="op" id="4310598">:</span><span class="op" id="4310599">]</span><span class="op" id="4310600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310608">d</span><span class="op" id="4310609">.</span><span class="ident" id="4310610">hashOffset</span>&nbsp;<span class="op" id="4310621">=</span>&nbsp;<span class="num" id="4310623">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310628">d</span><span class="op" id="4310629">.</span><span class="ident" id="4310630">index</span><span class="op" id="4310635">,</span>&nbsp;<span class="ident" id="4310637">d</span><span class="op" id="4310638">.</span><span class="ident" id="4310639">windowEnd</span>&nbsp;<span class="op" id="4310649">=</span>&nbsp;<span class="num" id="4310651">0</span><span class="op" id="4310652">,</span>&nbsp;<span class="num" id="4310654">0</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310658">for</span>&nbsp;<span class="ident" id="4310662">s</span>&nbsp;<span class="op" id="4310664">:=</span>&nbsp;<span class="ident" id="4310667">d</span><span class="op" id="4310668">.</span><span class="ident" id="4310669">window</span><span class="op" id="4310675">;</span>&nbsp;<span class="builtinfunc" id="4310677">len</span><span class="op" id="4310680">(</span><span class="ident" id="4310681">s</span><span class="op" id="4310682">)</span>&nbsp;<span class="op" id="4310684">&gt;</span>&nbsp;<span class="num" id="4310686">0</span><span class="op" id="4310687">;</span>&nbsp;<span class="op" id="4310689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310694">n</span>&nbsp;<span class="op" id="4310696">:=</span>&nbsp;<span class="builtinfunc" id="4310699">copy</span><span class="op" id="4310703">(</span><span class="ident" id="4310704">s</span><span class="op" id="4310705">,</span>&nbsp;<span class="ident" id="4310707">bzeroes</span><span class="op" id="4310714">[</span><span class="op" id="4310715">:</span><span class="op" id="4310716">]</span><span class="op" id="4310717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310722">s</span>&nbsp;<span class="op" id="4310724">=</span>&nbsp;<span class="ident" id="4310726">s</span><span class="op" id="4310727">[</span><span class="ident" id="4310728">n</span><span class="op" id="4310729">:</span><span class="op" id="4310730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310738">d</span><span class="op" id="4310739">.</span><span class="ident" id="4310740">blockStart</span><span class="op" id="4310750">,</span>&nbsp;<span class="ident" id="4310752">d</span><span class="op" id="4310753">.</span><span class="ident" id="4310754">byteAvailable</span>&nbsp;<span class="op" id="4310768">=</span>&nbsp;<span class="num" id="4310770">0</span><span class="op" id="4310771">,</span>&nbsp;<span class="ident" id="4310773">false</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310782">d</span><span class="op" id="4310783">.</span><span class="ident" id="4310784">tokens</span>&nbsp;<span class="op" id="4310791">=</span>&nbsp;<span class="ident" id="4310793">d</span><span class="op" id="4310794">.</span><span class="ident" id="4310795">tokens</span><span class="op" id="4310801">[</span><span class="op" id="4310802">:</span><span class="ident" id="4310803">maxFlateBlockTokens</span><span class="op" id="4310822">+</span><span class="num" id="4310823">1</span><span class="op" id="4310824">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4310828">for</span>&nbsp;<span class="ident" id="4310832">i</span>&nbsp;<span class="op" id="4310834">:=</span>&nbsp;<span class="num" id="4310837">0</span><span class="op" id="4310838">;</span>&nbsp;<span class="ident" id="4310840">i</span>&nbsp;<span class="op" id="4310842">&lt;=</span>&nbsp;<span class="ident" id="4310845">maxFlateBlockTokens</span><span class="op" id="4310864">;</span>&nbsp;<span class="ident" id="4310866">i</span><span class="op" id="4310867">++</span>&nbsp;<span class="op" id="4310870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310875">d</span><span class="op" id="4310876">.</span><span class="ident" id="4310877">tokens</span><span class="op" id="4310883">[</span><span class="ident" id="4310884">i</span><span class="op" id="4310885">]</span>&nbsp;<span class="op" id="4310887">=</span>&nbsp;<span class="num" id="4310889">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4310893">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310897">d</span><span class="op" id="4310898">.</span><span class="ident" id="4310899">tokens</span>&nbsp;<span class="op" id="4310906">=</span>&nbsp;<span class="ident" id="4310908">d</span><span class="op" id="4310909">.</span><span class="ident" id="4310910">tokens</span><span class="op" id="4310916">[</span><span class="op" id="4310917">:</span><span class="num" id="4310918">0</span><span class="op" id="4310919">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310923">d</span><span class="op" id="4310924">.</span><span class="ident" id="4310925">length</span>&nbsp;<span class="op" id="4310932">=</span>&nbsp;<span class="ident" id="4310934">minMatchLength</span>&nbsp;<span class="op" id="4310949">-</span>&nbsp;<span class="num" id="4310951">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310955">d</span><span class="op" id="4310956">.</span><span class="ident" id="4310957">offset</span>&nbsp;<span class="op" id="4310964">=</span>&nbsp;<span class="num" id="4310966">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310970">d</span><span class="op" id="4310971">.</span><span class="ident" id="4310972">hash</span>&nbsp;<span class="op" id="4310977">=</span>&nbsp;<span class="num" id="4310979">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4310983">d</span><span class="op" id="4310984">.</span><span class="ident" id="4310985">maxInsertIndex</span>&nbsp;<span class="op" id="4311000">=</span>&nbsp;<span class="num" id="4311002">0</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4311005">}</span><br>
<span class="lineno"></span><span class="op" id="4311007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4311010">func</span>&nbsp;<span class="op" id="4311015">(</span><span class="ident" id="4311016">d</span>&nbsp;<span class="op" id="4311018">*</span><span class="ident" id="4311019">compressor</span><span class="op" id="4311029">)</span>&nbsp;<span class="builtinfunc" id="4311031">close</span><span class="op" id="4311036">(</span><span class="op" id="4311037">)</span>&nbsp;<span class="builtintype" id="4311039">error</span>&nbsp;<span class="op" id="4311045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311048">d</span><span class="op" id="4311049">.</span><span class="ident" id="4311050">sync</span>&nbsp;<span class="op" id="4311055">=</span>&nbsp;<span class="ident" id="4311057">true</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311063">d</span><span class="op" id="4311064">.</span><span class="ident" id="4311065">step</span><span class="op" id="4311069">(</span><span class="ident" id="4311070">d</span><span class="op" id="4311071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311074">if</span>&nbsp;<span class="ident" id="4311077">d</span><span class="op" id="4311078">.</span><span class="ident" id="4311079">err</span>&nbsp;<span class="op" id="4311083">!=</span>&nbsp;<span class="ident" id="4311086">nil</span>&nbsp;<span class="op" id="4311090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311094">return</span>&nbsp;<span class="ident" id="4311101">d</span><span class="op" id="4311102">.</span><span class="ident" id="4311103">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4311108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311111">if</span>&nbsp;<span class="ident" id="4311114">d</span><span class="op" id="4311115">.</span><span class="ident" id="4311116">w</span><span class="op" id="4311117">.</span><span class="ident" id="4311118">writeStoredHeader</span><span class="op" id="4311135">(</span><span class="num" id="4311136">0</span><span class="op" id="4311137">,</span>&nbsp;<span class="ident" id="4311139">true</span><span class="op" id="4311143">)</span><span class="op" id="4311144">;</span>&nbsp;<span class="ident" id="4311146">d</span><span class="op" id="4311147">.</span><span class="ident" id="4311148">w</span><span class="op" id="4311149">.</span><span class="ident" id="4311150">err</span>&nbsp;<span class="op" id="4311154">!=</span>&nbsp;<span class="ident" id="4311157">nil</span>&nbsp;<span class="op" id="4311161">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311165">return</span>&nbsp;<span class="ident" id="4311172">d</span><span class="op" id="4311173">.</span><span class="ident" id="4311174">w</span><span class="op" id="4311175">.</span><span class="ident" id="4311176">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4311181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4311184">d</span><span class="op" id="4311185">.</span><span class="ident" id="4311186">w</span><span class="op" id="4311187">.</span><span class="ident" id="4311188">flush</span><span class="op" id="4311193">(</span><span class="op" id="4311194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311197">return</span>&nbsp;<span class="ident" id="4311204">d</span><span class="op" id="4311205">.</span><span class="ident" id="4311206">w</span><span class="op" id="4311207">.</span><span class="ident" id="4311208">err</span><br>
<span class="lineno"></span><span class="op" id="4311212">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment" id="4311215">//&nbsp;NewWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;Writer&nbsp;compressing&nbsp;data&nbsp;at&nbsp;the&nbsp;given&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4311286">//&nbsp;Following&nbsp;zlib,&nbsp;levels&nbsp;range&nbsp;from&nbsp;1&nbsp;(BestSpeed)&nbsp;to&nbsp;9&nbsp;(BestCompression);</span><br>
<span class="lineno"></span><span class="comment" id="4311361">//&nbsp;higher&nbsp;levels&nbsp;typically&nbsp;run&nbsp;slower&nbsp;but&nbsp;compress&nbsp;more.&nbsp;Level&nbsp;0</span><br>
<span class="lineno"></span><span class="comment" id="4311426">//&nbsp;(NoCompression)&nbsp;does&nbsp;not&nbsp;attempt&nbsp;any&nbsp;compression;&nbsp;it&nbsp;only&nbsp;adds&nbsp;the</span><br>
<span class="lineno">480</span><span class="comment" id="4311496">//&nbsp;necessary&nbsp;DEFLATE&nbsp;framing.&nbsp;Level&nbsp;-1&nbsp;(DefaultCompression)&nbsp;uses&nbsp;the&nbsp;default</span><br>
<span class="lineno"></span><span class="comment" id="4311573">//&nbsp;compression&nbsp;level.</span><br>
<span class="lineno"></span><span class="comment" id="4311595">//</span><br>
<span class="lineno"></span><span class="comment" id="4311598">//&nbsp;If&nbsp;level&nbsp;is&nbsp;in&nbsp;the&nbsp;range&nbsp;[-1,&nbsp;9]&nbsp;then&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="4311671">//&nbsp;Otherwise&nbsp;the&nbsp;error&nbsp;returned&nbsp;will&nbsp;be&nbsp;non-nil.</span><br>
<span class="lineno">485</span><span class="keyword" id="4311720">func</span>&nbsp;<span class="ident" id="4311725">NewWriter</span><span class="op" id="4311734">(</span><span class="ident" id="4311735">w</span>&nbsp;<span class="ident" id="4311737">io</span><span class="op" id="4311739">.</span><span class="ident" id="4311740">Writer</span><span class="op" id="4311746">,</span>&nbsp;<span class="ident" id="4311748">level</span>&nbsp;<span class="builtintype" id="4311754">int</span><span class="op" id="4311757">)</span>&nbsp;<span class="op" id="4311759">(</span><span class="op" id="4311760">*</span><span class="ident" id="4311761">Writer</span><span class="op" id="4311767">,</span>&nbsp;<span class="builtintype" id="4311769">error</span><span class="op" id="4311774">)</span>&nbsp;<span class="op" id="4311776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311779">var</span>&nbsp;<span class="ident" id="4311783">dw</span>&nbsp;<span class="ident" id="4311786">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311794">if</span>&nbsp;<span class="ident" id="4311797">err</span>&nbsp;<span class="op" id="4311801">:=</span>&nbsp;<span class="ident" id="4311804">dw</span><span class="op" id="4311806">.</span><span class="ident" id="4311807">d</span><span class="op" id="4311808">.</span><span class="ident" id="4311809">init</span><span class="op" id="4311813">(</span><span class="ident" id="4311814">w</span><span class="op" id="4311815">,</span>&nbsp;<span class="ident" id="4311817">level</span><span class="op" id="4311822">)</span><span class="op" id="4311823">;</span>&nbsp;<span class="ident" id="4311825">err</span>&nbsp;<span class="op" id="4311829">!=</span>&nbsp;<span class="ident" id="4311832">nil</span>&nbsp;<span class="op" id="4311836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311840">return</span>&nbsp;<span class="ident" id="4311847">nil</span><span class="op" id="4311850">,</span>&nbsp;<span class="ident" id="4311852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4311857">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4311860">return</span>&nbsp;<span class="op" id="4311867">&amp;</span><span class="ident" id="4311868">dw</span><span class="op" id="4311870">,</span>&nbsp;<span class="ident" id="4311872">nil</span><br>
<span class="lineno"></span><span class="op" id="4311876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4311879">//&nbsp;NewWriterDict&nbsp;is&nbsp;like&nbsp;NewWriter&nbsp;but&nbsp;initializes&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="4311938">//&nbsp;Writer&nbsp;with&nbsp;a&nbsp;preset&nbsp;dictionary.&nbsp;&nbsp;The&nbsp;returned&nbsp;Writer&nbsp;behaves</span><br>
<span class="lineno">495</span><span class="comment" id="4312003">//&nbsp;as&nbsp;if&nbsp;the&nbsp;dictionary&nbsp;had&nbsp;been&nbsp;written&nbsp;to&nbsp;it&nbsp;without&nbsp;producing</span><br>
<span class="lineno"></span><span class="comment" id="4312068">//&nbsp;any&nbsp;compressed&nbsp;output.&nbsp;&nbsp;The&nbsp;compressed&nbsp;data&nbsp;written&nbsp;to&nbsp;w</span><br>
<span class="lineno"></span><span class="comment" id="4312128">//&nbsp;can&nbsp;only&nbsp;be&nbsp;decompressed&nbsp;by&nbsp;a&nbsp;Reader&nbsp;initialized&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4312189">//&nbsp;same&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4312209">func</span>&nbsp;<span class="ident" id="4312214">NewWriterDict</span><span class="op" id="4312227">(</span><span class="ident" id="4312228">w</span>&nbsp;<span class="ident" id="4312230">io</span><span class="op" id="4312232">.</span><span class="ident" id="4312233">Writer</span><span class="op" id="4312239">,</span>&nbsp;<span class="ident" id="4312241">level</span>&nbsp;<span class="builtintype" id="4312247">int</span><span class="op" id="4312250">,</span>&nbsp;<span class="ident" id="4312252">dict</span>&nbsp;<span class="op" id="4312257">[</span><span class="op" id="4312258">]</span><span class="builtintype" id="4312259">byte</span><span class="op" id="4312263">)</span>&nbsp;<span class="op" id="4312265">(</span><span class="op" id="4312266">*</span><span class="ident" id="4312267">Writer</span><span class="op" id="4312273">,</span>&nbsp;<span class="builtintype" id="4312275">error</span><span class="op" id="4312280">)</span>&nbsp;<span class="op" id="4312282">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312285">dw</span>&nbsp;<span class="op" id="4312288">:=</span>&nbsp;<span class="op" id="4312291">&amp;</span><span class="ident" id="4312292">dictWriter</span><span class="op" id="4312302">{</span><span class="ident" id="4312303">w</span><span class="op" id="4312304">,</span>&nbsp;<span class="ident" id="4312306">false</span><span class="op" id="4312311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312314">zw</span><span class="op" id="4312316">,</span>&nbsp;<span class="ident" id="4312318">err</span>&nbsp;<span class="op" id="4312322">:=</span>&nbsp;<span class="ident" id="4312325">NewWriter</span><span class="op" id="4312334">(</span><span class="ident" id="4312335">dw</span><span class="op" id="4312337">,</span>&nbsp;<span class="ident" id="4312339">level</span><span class="op" id="4312344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312347">if</span>&nbsp;<span class="ident" id="4312350">err</span>&nbsp;<span class="op" id="4312354">!=</span>&nbsp;<span class="ident" id="4312357">nil</span>&nbsp;<span class="op" id="4312361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312365">return</span>&nbsp;<span class="ident" id="4312372">nil</span><span class="op" id="4312375">,</span>&nbsp;<span class="ident" id="4312377">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4312382">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312385">zw</span><span class="op" id="4312387">.</span><span class="ident" id="4312388">Write</span><span class="op" id="4312393">(</span><span class="ident" id="4312394">dict</span><span class="op" id="4312398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312401">zw</span><span class="op" id="4312403">.</span><span class="ident" id="4312404">Flush</span><span class="op" id="4312409">(</span><span class="op" id="4312410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312413">dw</span><span class="op" id="4312415">.</span><span class="ident" id="4312416">enabled</span>&nbsp;<span class="op" id="4312424">=</span>&nbsp;<span class="ident" id="4312426">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312432">zw</span><span class="op" id="4312434">.</span><span class="ident" id="4312435">dict</span>&nbsp;<span class="op" id="4312440">=</span>&nbsp;<span class="builtinfunc" id="4312442">append</span><span class="op" id="4312448">(</span><span class="ident" id="4312449">zw</span><span class="op" id="4312451">.</span><span class="ident" id="4312452">dict</span><span class="op" id="4312456">,</span>&nbsp;<span class="ident" id="4312458">dict</span><span class="op" id="4312462">...</span><span class="op" id="4312465">)</span>&nbsp;<span class="comment" id="4312467">//&nbsp;duplicate&nbsp;dictionary&nbsp;for&nbsp;Reset&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312510">return</span>&nbsp;<span class="ident" id="4312517">zw</span><span class="op" id="4312519">,</span>&nbsp;<span class="ident" id="4312521">err</span><br>
<span class="lineno">510</span><span class="op" id="4312525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4312528">type</span>&nbsp;<span class="ident" id="4312533">dictWriter</span>&nbsp;<span class="keyword" id="4312544">struct</span>&nbsp;<span class="op" id="4312551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312554">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4312562">io</span><span class="op" id="4312564">.</span><span class="ident" id="4312565">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312573">enabled</span>&nbsp;<span class="builtintype" id="4312581">bool</span><br>
<span class="lineno">515</span><span class="op" id="4312586">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4312589">func</span>&nbsp;<span class="op" id="4312594">(</span><span class="ident" id="4312595">w</span>&nbsp;<span class="op" id="4312597">*</span><span class="ident" id="4312598">dictWriter</span><span class="op" id="4312608">)</span>&nbsp;<span class="ident" id="4312610">Write</span><span class="op" id="4312615">(</span><span class="ident" id="4312616">b</span>&nbsp;<span class="op" id="4312618">[</span><span class="op" id="4312619">]</span><span class="builtintype" id="4312620">byte</span><span class="op" id="4312624">)</span>&nbsp;<span class="op" id="4312626">(</span><span class="ident" id="4312627">n</span>&nbsp;<span class="builtintype" id="4312629">int</span><span class="op" id="4312632">,</span>&nbsp;<span class="ident" id="4312634">err</span>&nbsp;<span class="builtintype" id="4312638">error</span><span class="op" id="4312643">)</span>&nbsp;<span class="op" id="4312645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312648">if</span>&nbsp;<span class="ident" id="4312651">w</span><span class="op" id="4312652">.</span><span class="ident" id="4312653">enabled</span>&nbsp;<span class="op" id="4312661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312665">return</span>&nbsp;<span class="ident" id="4312672">w</span><span class="op" id="4312673">.</span><span class="ident" id="4312674">w</span><span class="op" id="4312675">.</span><span class="ident" id="4312676">Write</span><span class="op" id="4312681">(</span><span class="ident" id="4312682">b</span><span class="op" id="4312683">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4312686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4312689">return</span>&nbsp;<span class="builtinfunc" id="4312696">len</span><span class="op" id="4312699">(</span><span class="ident" id="4312700">b</span><span class="op" id="4312701">)</span><span class="op" id="4312702">,</span>&nbsp;<span class="ident" id="4312704">nil</span><br>
<span class="lineno"></span><span class="op" id="4312708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4312711">//&nbsp;A&nbsp;Writer&nbsp;takes&nbsp;data&nbsp;written&nbsp;to&nbsp;it&nbsp;and&nbsp;writes&nbsp;the&nbsp;compressed</span><br>
<span class="lineno">525</span><span class="comment" id="4312774">//&nbsp;form&nbsp;of&nbsp;that&nbsp;data&nbsp;to&nbsp;an&nbsp;underlying&nbsp;writer&nbsp;(see&nbsp;NewWriter).</span><br>
<span class="lineno"></span><span class="keyword" id="4312836">type</span>&nbsp;<span class="ident" id="4312841">Writer</span>&nbsp;<span class="keyword" id="4312848">struct</span>&nbsp;<span class="op" id="4312855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312858">d</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4312863">compressor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4312875">dict</span>&nbsp;<span class="op" id="4312880">[</span><span class="op" id="4312881">]</span><span class="builtintype" id="4312882">byte</span><br>
<span class="lineno"></span><span class="op" id="4312887">}</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span><span class="comment" id="4312890">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;w,&nbsp;which&nbsp;will&nbsp;eventually&nbsp;write&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4312949">//&nbsp;compressed&nbsp;form&nbsp;of&nbsp;data&nbsp;to&nbsp;its&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4313002">func</span>&nbsp;<span class="op" id="4313007">(</span><span class="ident" id="4313008">w</span>&nbsp;<span class="op" id="4313010">*</span><span class="ident" id="4313011">Writer</span><span class="op" id="4313017">)</span>&nbsp;<span class="ident" id="4313019">Write</span><span class="op" id="4313024">(</span><span class="ident" id="4313025">data</span>&nbsp;<span class="op" id="4313030">[</span><span class="op" id="4313031">]</span><span class="builtintype" id="4313032">byte</span><span class="op" id="4313036">)</span>&nbsp;<span class="op" id="4313038">(</span><span class="ident" id="4313039">n</span>&nbsp;<span class="builtintype" id="4313041">int</span><span class="op" id="4313044">,</span>&nbsp;<span class="ident" id="4313046">err</span>&nbsp;<span class="builtintype" id="4313050">error</span><span class="op" id="4313055">)</span>&nbsp;<span class="op" id="4313057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313060">return</span>&nbsp;<span class="ident" id="4313067">w</span><span class="op" id="4313068">.</span><span class="ident" id="4313069">d</span><span class="op" id="4313070">.</span><span class="ident" id="4313071">write</span><span class="op" id="4313076">(</span><span class="ident" id="4313077">data</span><span class="op" id="4313081">)</span><br>
<span class="lineno">535</span><span class="op" id="4313083">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4313086">//&nbsp;Flush&nbsp;flushes&nbsp;any&nbsp;pending&nbsp;compressed&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="comment" id="4313157">//&nbsp;It&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;in&nbsp;compressed&nbsp;network&nbsp;protocols,&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4313228">//&nbsp;a&nbsp;remote&nbsp;reader&nbsp;has&nbsp;enough&nbsp;data&nbsp;to&nbsp;reconstruct&nbsp;a&nbsp;packet.</span><br>
<span class="lineno">540</span><span class="comment" id="4313288">//&nbsp;Flush&nbsp;does&nbsp;not&nbsp;return&nbsp;until&nbsp;the&nbsp;data&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span><span class="comment" id="4313346">//&nbsp;If&nbsp;the&nbsp;underlying&nbsp;writer&nbsp;returns&nbsp;an&nbsp;error,&nbsp;Flush&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="4313418">//</span><br>
<span class="lineno"></span><span class="comment" id="4313421">//&nbsp;In&nbsp;the&nbsp;terminology&nbsp;of&nbsp;the&nbsp;zlib&nbsp;library,&nbsp;Flush&nbsp;is&nbsp;equivalent&nbsp;to&nbsp;Z_SYNC_FLUSH.</span><br>
<span class="lineno"></span><span class="keyword" id="4313501">func</span>&nbsp;<span class="op" id="4313506">(</span><span class="ident" id="4313507">w</span>&nbsp;<span class="op" id="4313509">*</span><span class="ident" id="4313510">Writer</span><span class="op" id="4313516">)</span>&nbsp;<span class="ident" id="4313518">Flush</span><span class="op" id="4313523">(</span><span class="op" id="4313524">)</span>&nbsp;<span class="builtintype" id="4313526">error</span>&nbsp;<span class="op" id="4313532">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313535">//&nbsp;For&nbsp;more&nbsp;about&nbsp;flushing:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313564">//&nbsp;http://www.bolet.org/~pornin/deflate-flush.html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313616">return</span>&nbsp;<span class="ident" id="4313623">w</span><span class="op" id="4313624">.</span><span class="ident" id="4313625">d</span><span class="op" id="4313626">.</span><span class="ident" id="4313627">syncFlush</span><span class="op" id="4313636">(</span><span class="op" id="4313637">)</span><br>
<span class="lineno"></span><span class="op" id="4313639">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">550</span><span class="comment" id="4313642">//&nbsp;Close&nbsp;flushes&nbsp;and&nbsp;closes&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4313682">func</span>&nbsp;<span class="op" id="4313687">(</span><span class="ident" id="4313688">w</span>&nbsp;<span class="op" id="4313690">*</span><span class="ident" id="4313691">Writer</span><span class="op" id="4313697">)</span>&nbsp;<span class="ident" id="4313699">Close</span><span class="op" id="4313704">(</span><span class="op" id="4313705">)</span>&nbsp;<span class="builtintype" id="4313707">error</span>&nbsp;<span class="op" id="4313713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313716">return</span>&nbsp;<span class="ident" id="4313723">w</span><span class="op" id="4313724">.</span><span class="ident" id="4313725">d</span><span class="op" id="4313726">.</span><span class="builtinfunc" id="4313727">close</span><span class="op" id="4313732">(</span><span class="op" id="4313733">)</span><br>
<span class="lineno"></span><span class="op" id="4313735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">555</span><span class="comment" id="4313738">//&nbsp;Reset&nbsp;discards&nbsp;the&nbsp;writer&#39;s&nbsp;state&nbsp;and&nbsp;makes&nbsp;it&nbsp;equivalent&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4313802">//&nbsp;the&nbsp;result&nbsp;of&nbsp;NewWriter&nbsp;or&nbsp;NewWriterDict&nbsp;called&nbsp;with&nbsp;dst</span><br>
<span class="lineno"></span><span class="comment" id="4313862">//&nbsp;and&nbsp;w&#39;s&nbsp;level&nbsp;and&nbsp;dictionary.</span><br>
<span class="lineno"></span><span class="keyword" id="4313895">func</span>&nbsp;<span class="op" id="4313900">(</span><span class="ident" id="4313901">w</span>&nbsp;<span class="op" id="4313903">*</span><span class="ident" id="4313904">Writer</span><span class="op" id="4313910">)</span>&nbsp;<span class="ident" id="4313912">Reset</span><span class="op" id="4313917">(</span><span class="ident" id="4313918">dst</span>&nbsp;<span class="ident" id="4313922">io</span><span class="op" id="4313924">.</span><span class="ident" id="4313925">Writer</span><span class="op" id="4313931">)</span>&nbsp;<span class="op" id="4313933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4313936">if</span>&nbsp;<span class="ident" id="4313939">dw</span><span class="op" id="4313941">,</span>&nbsp;<span class="ident" id="4313943">ok</span>&nbsp;<span class="op" id="4313946">:=</span>&nbsp;<span class="ident" id="4313949">w</span><span class="op" id="4313950">.</span><span class="ident" id="4313951">d</span><span class="op" id="4313952">.</span><span class="ident" id="4313953">w</span><span class="op" id="4313954">.</span><span class="ident" id="4313955">w</span><span class="op" id="4313956">.</span><span class="op" id="4313957">(</span><span class="op" id="4313958">*</span><span class="ident" id="4313959">dictWriter</span><span class="op" id="4313969">)</span><span class="op" id="4313970">;</span>&nbsp;<span class="ident" id="4313972">ok</span>&nbsp;<span class="op" id="4313975">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4313979">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriterDict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314017">dw</span><span class="op" id="4314019">.</span><span class="ident" id="4314020">w</span>&nbsp;<span class="op" id="4314022">=</span>&nbsp;<span class="ident" id="4314024">dst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314030">w</span><span class="op" id="4314031">.</span><span class="ident" id="4314032">d</span><span class="op" id="4314033">.</span><span class="ident" id="4314034">reset</span><span class="op" id="4314039">(</span><span class="ident" id="4314040">dw</span><span class="op" id="4314042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314046">dw</span><span class="op" id="4314048">.</span><span class="ident" id="4314049">enabled</span>&nbsp;<span class="op" id="4314057">=</span>&nbsp;<span class="ident" id="4314059">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314067">w</span><span class="op" id="4314068">.</span><span class="ident" id="4314069">Write</span><span class="op" id="4314074">(</span><span class="ident" id="4314075">w</span><span class="op" id="4314076">.</span><span class="ident" id="4314077">dict</span><span class="op" id="4314081">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314085">w</span><span class="op" id="4314086">.</span><span class="ident" id="4314087">Flush</span><span class="op" id="4314092">(</span><span class="op" id="4314093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314097">dw</span><span class="op" id="4314099">.</span><span class="ident" id="4314100">enabled</span>&nbsp;<span class="op" id="4314108">=</span>&nbsp;<span class="ident" id="4314110">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314116">}</span>&nbsp;<span class="keyword" id="4314118">else</span>&nbsp;<span class="op" id="4314123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4314127">//&nbsp;w&nbsp;was&nbsp;created&nbsp;with&nbsp;NewWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4314161">w</span><span class="op" id="4314162">.</span><span class="ident" id="4314163">d</span><span class="op" id="4314164">.</span><span class="ident" id="4314165">reset</span><span class="op" id="4314170">(</span><span class="ident" id="4314171">dst</span><span class="op" id="4314174">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4314177">}</span><br>
<span class="lineno"></span><span class="op" id="4314179">}</span>
</div>
</body>
</html>
