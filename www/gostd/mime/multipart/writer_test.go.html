<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7312956">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7313011">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7313065">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7313116">package</span>&nbsp;<span class="ident" id="7313124">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7313135">import</span>&nbsp;<span class="op" id="7313142">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7313145">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7313154">&#34;io/ioutil&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7313167">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7313178">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op" id="7313188">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7313191">func</span>&nbsp;<span class="ident" id="7313196">TestWriter</span><span class="op" id="7313206">(</span><span class="ident" id="7313207">t</span>&nbsp;<span class="op" id="7313209">*</span><span class="ident" id="7313210">testing</span><span class="op" id="7313217">.</span><span class="ident" id="7313218">T</span><span class="op" id="7313219">)</span>&nbsp;<span class="op" id="7313221">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313224">fileContents</span>&nbsp;<span class="op" id="7313237">:=</span>&nbsp;<span class="op" id="7313240">[</span><span class="op" id="7313241">]</span><span class="builtintype" id="7313242">byte</span><span class="op" id="7313246">(</span><span class="string" id="7313247">&#34;my&nbsp;file&nbsp;contents&#34;</span><span class="op" id="7313265">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313269">var</span>&nbsp;<span class="ident" id="7313273">b</span>&nbsp;<span class="ident" id="7313275">bytes</span><span class="op" id="7313280">.</span><span class="ident" id="7313281">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313289">w</span>&nbsp;<span class="op" id="7313291">:=</span>&nbsp;<span class="ident" id="7313294">NewWriter</span><span class="op" id="7313303">(</span><span class="op" id="7313304">&amp;</span><span class="ident" id="7313305">b</span><span class="op" id="7313306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313309">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313313">part</span><span class="op" id="7313317">,</span>&nbsp;<span class="ident" id="7313319">err</span>&nbsp;<span class="op" id="7313323">:=</span>&nbsp;<span class="ident" id="7313326">w</span><span class="op" id="7313327">.</span><span class="ident" id="7313328">CreateFormFile</span><span class="op" id="7313342">(</span><span class="string" id="7313343">&#34;myfile&#34;</span><span class="op" id="7313351">,</span>&nbsp;<span class="string" id="7313353">&#34;my-file.txt&#34;</span><span class="op" id="7313366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313370">if</span>&nbsp;<span class="ident" id="7313373">err</span>&nbsp;<span class="op" id="7313377">!=</span>&nbsp;<span class="ident" id="7313380">nil</span>&nbsp;<span class="op" id="7313384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313389">t</span><span class="op" id="7313390">.</span><span class="ident" id="7313391">Fatalf</span><span class="op" id="7313397">(</span><span class="string" id="7313398">&#34;CreateFormFile:&nbsp;%v&#34;</span><span class="op" id="7313418">,</span>&nbsp;<span class="ident" id="7313420">err</span><span class="op" id="7313423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313427">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313431">part</span><span class="op" id="7313435">.</span><span class="ident" id="7313436">Write</span><span class="op" id="7313441">(</span><span class="ident" id="7313442">fileContents</span><span class="op" id="7313454">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313458">err</span>&nbsp;<span class="op" id="7313462">=</span>&nbsp;<span class="ident" id="7313464">w</span><span class="op" id="7313465">.</span><span class="ident" id="7313466">WriteField</span><span class="op" id="7313476">(</span><span class="string" id="7313477">&#34;key&#34;</span><span class="op" id="7313482">,</span>&nbsp;<span class="string" id="7313484">&#34;val&#34;</span><span class="op" id="7313489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313493">if</span>&nbsp;<span class="ident" id="7313496">err</span>&nbsp;<span class="op" id="7313500">!=</span>&nbsp;<span class="ident" id="7313503">nil</span>&nbsp;<span class="op" id="7313507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313512">t</span><span class="op" id="7313513">.</span><span class="ident" id="7313514">Fatalf</span><span class="op" id="7313520">(</span><span class="string" id="7313521">&#34;WriteField:&nbsp;%v&#34;</span><span class="op" id="7313537">,</span>&nbsp;<span class="ident" id="7313539">err</span><span class="op" id="7313542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313546">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313550">part</span><span class="op" id="7313554">.</span><span class="ident" id="7313555">Write</span><span class="op" id="7313560">(</span><span class="op" id="7313561">[</span><span class="op" id="7313562">]</span><span class="builtintype" id="7313563">byte</span><span class="op" id="7313567">(</span><span class="string" id="7313568">&#34;val&#34;</span><span class="op" id="7313573">)</span><span class="op" id="7313574">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313578">err</span>&nbsp;<span class="op" id="7313582">=</span>&nbsp;<span class="ident" id="7313584">w</span><span class="op" id="7313585">.</span><span class="ident" id="7313586">Close</span><span class="op" id="7313591">(</span><span class="op" id="7313592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313596">if</span>&nbsp;<span class="ident" id="7313599">err</span>&nbsp;<span class="op" id="7313603">!=</span>&nbsp;<span class="ident" id="7313606">nil</span>&nbsp;<span class="op" id="7313610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313615">t</span><span class="op" id="7313616">.</span><span class="ident" id="7313617">Fatalf</span><span class="op" id="7313623">(</span><span class="string" id="7313624">&#34;Close:&nbsp;%v&#34;</span><span class="op" id="7313635">,</span>&nbsp;<span class="ident" id="7313637">err</span><span class="op" id="7313640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313648">s</span>&nbsp;<span class="op" id="7313650">:=</span>&nbsp;<span class="ident" id="7313653">b</span><span class="op" id="7313654">.</span><span class="ident" id="7313655">String</span><span class="op" id="7313661">(</span><span class="op" id="7313662">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313666">if</span>&nbsp;<span class="builtinfunc" id="7313669">len</span><span class="op" id="7313672">(</span><span class="ident" id="7313673">s</span><span class="op" id="7313674">)</span>&nbsp;<span class="op" id="7313676">==</span>&nbsp;<span class="num" id="7313679">0</span>&nbsp;<span class="op" id="7313681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313686">t</span><span class="op" id="7313687">.</span><span class="ident" id="7313688">Fatal</span><span class="op" id="7313693">(</span><span class="string" id="7313694">&#34;String:&nbsp;unexpected&nbsp;empty&nbsp;result&#34;</span><span class="op" id="7313727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313735">if</span>&nbsp;<span class="ident" id="7313738">s</span><span class="op" id="7313739">[</span><span class="num" id="7313740">0</span><span class="op" id="7313741">]</span>&nbsp;<span class="op" id="7313743">==</span>&nbsp;<span class="string" id="7313746">&#39;\r&#39;</span>&nbsp;<span class="op" id="7313751">||</span>&nbsp;<span class="ident" id="7313754">s</span><span class="op" id="7313755">[</span><span class="num" id="7313756">0</span><span class="op" id="7313757">]</span>&nbsp;<span class="op" id="7313759">==</span>&nbsp;<span class="string" id="7313762">&#39;\n&#39;</span>&nbsp;<span class="op" id="7313767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313772">t</span><span class="op" id="7313773">.</span><span class="ident" id="7313774">Fatal</span><span class="op" id="7313779">(</span><span class="string" id="7313780">&#34;String:&nbsp;unexpected&nbsp;newline&#34;</span><span class="op" id="7313808">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313819">r</span>&nbsp;<span class="op" id="7313821">:=</span>&nbsp;<span class="ident" id="7313824">NewReader</span><span class="op" id="7313833">(</span><span class="op" id="7313834">&amp;</span><span class="ident" id="7313835">b</span><span class="op" id="7313836">,</span>&nbsp;<span class="ident" id="7313838">w</span><span class="op" id="7313839">.</span><span class="ident" id="7313840">Boundary</span><span class="op" id="7313848">(</span><span class="op" id="7313849">)</span><span class="op" id="7313850">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313854">part</span><span class="op" id="7313858">,</span>&nbsp;<span class="ident" id="7313860">err</span>&nbsp;<span class="op" id="7313864">:=</span>&nbsp;<span class="ident" id="7313867">r</span><span class="op" id="7313868">.</span><span class="ident" id="7313869">NextPart</span><span class="op" id="7313877">(</span><span class="op" id="7313878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313881">if</span>&nbsp;<span class="ident" id="7313884">err</span>&nbsp;<span class="op" id="7313888">!=</span>&nbsp;<span class="ident" id="7313891">nil</span>&nbsp;<span class="op" id="7313895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313899">t</span><span class="op" id="7313900">.</span><span class="ident" id="7313901">Fatalf</span><span class="op" id="7313907">(</span><span class="string" id="7313908">&#34;part&nbsp;1:&nbsp;%v&#34;</span><span class="op" id="7313920">,</span>&nbsp;<span class="ident" id="7313922">err</span><span class="op" id="7313925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7313928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7313931">if</span>&nbsp;<span class="ident" id="7313934">g</span><span class="op" id="7313935">,</span>&nbsp;<span class="ident" id="7313937">e</span>&nbsp;<span class="op" id="7313939">:=</span>&nbsp;<span class="ident" id="7313942">part</span><span class="op" id="7313946">.</span><span class="ident" id="7313947">FormName</span><span class="op" id="7313955">(</span><span class="op" id="7313956">)</span><span class="op" id="7313957">,</span>&nbsp;<span class="string" id="7313959">&#34;myfile&#34;</span><span class="op" id="7313967">;</span>&nbsp;<span class="ident" id="7313969">g</span>&nbsp;<span class="op" id="7313971">!=</span>&nbsp;<span class="ident" id="7313974">e</span>&nbsp;<span class="op" id="7313976">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7313980">t</span><span class="op" id="7313981">.</span><span class="ident" id="7313982">Errorf</span><span class="op" id="7313988">(</span><span class="string" id="7313989">&#34;part&nbsp;1:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7314024">,</span>&nbsp;<span class="ident" id="7314026">e</span><span class="op" id="7314027">,</span>&nbsp;<span class="ident" id="7314029">g</span><span class="op" id="7314030">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314036">slurp</span><span class="op" id="7314041">,</span>&nbsp;<span class="ident" id="7314043">err</span>&nbsp;<span class="op" id="7314047">:=</span>&nbsp;<span class="ident" id="7314050">ioutil</span><span class="op" id="7314056">.</span><span class="ident" id="7314057">ReadAll</span><span class="op" id="7314064">(</span><span class="ident" id="7314065">part</span><span class="op" id="7314069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314072">if</span>&nbsp;<span class="ident" id="7314075">err</span>&nbsp;<span class="op" id="7314079">!=</span>&nbsp;<span class="ident" id="7314082">nil</span>&nbsp;<span class="op" id="7314086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314090">t</span><span class="op" id="7314091">.</span><span class="ident" id="7314092">Fatalf</span><span class="op" id="7314098">(</span><span class="string" id="7314099">&#34;part&nbsp;1:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7314120">,</span>&nbsp;<span class="ident" id="7314122">err</span><span class="op" id="7314125">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314128">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314131">if</span>&nbsp;<span class="ident" id="7314134">e</span><span class="op" id="7314135">,</span>&nbsp;<span class="ident" id="7314137">g</span>&nbsp;<span class="op" id="7314139">:=</span>&nbsp;<span class="builtintype" id="7314142">string</span><span class="op" id="7314148">(</span><span class="ident" id="7314149">fileContents</span><span class="op" id="7314161">)</span><span class="op" id="7314162">,</span>&nbsp;<span class="builtintype" id="7314164">string</span><span class="op" id="7314170">(</span><span class="ident" id="7314171">slurp</span><span class="op" id="7314176">)</span><span class="op" id="7314177">;</span>&nbsp;<span class="ident" id="7314179">e</span>&nbsp;<span class="op" id="7314181">!=</span>&nbsp;<span class="ident" id="7314184">g</span>&nbsp;<span class="op" id="7314186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314190">t</span><span class="op" id="7314191">.</span><span class="ident" id="7314192">Errorf</span><span class="op" id="7314198">(</span><span class="string" id="7314199">&#34;part&nbsp;1:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7314233">,</span>&nbsp;<span class="ident" id="7314235">e</span><span class="op" id="7314236">,</span>&nbsp;<span class="ident" id="7314238">g</span><span class="op" id="7314239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314246">part</span><span class="op" id="7314250">,</span>&nbsp;<span class="ident" id="7314252">err</span>&nbsp;<span class="op" id="7314256">=</span>&nbsp;<span class="ident" id="7314258">r</span><span class="op" id="7314259">.</span><span class="ident" id="7314260">NextPart</span><span class="op" id="7314268">(</span><span class="op" id="7314269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314272">if</span>&nbsp;<span class="ident" id="7314275">err</span>&nbsp;<span class="op" id="7314279">!=</span>&nbsp;<span class="ident" id="7314282">nil</span>&nbsp;<span class="op" id="7314286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314290">t</span><span class="op" id="7314291">.</span><span class="ident" id="7314292">Fatalf</span><span class="op" id="7314298">(</span><span class="string" id="7314299">&#34;part&nbsp;2:&nbsp;%v&#34;</span><span class="op" id="7314311">,</span>&nbsp;<span class="ident" id="7314313">err</span><span class="op" id="7314316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314322">if</span>&nbsp;<span class="ident" id="7314325">g</span><span class="op" id="7314326">,</span>&nbsp;<span class="ident" id="7314328">e</span>&nbsp;<span class="op" id="7314330">:=</span>&nbsp;<span class="ident" id="7314333">part</span><span class="op" id="7314337">.</span><span class="ident" id="7314338">FormName</span><span class="op" id="7314346">(</span><span class="op" id="7314347">)</span><span class="op" id="7314348">,</span>&nbsp;<span class="string" id="7314350">&#34;key&#34;</span><span class="op" id="7314355">;</span>&nbsp;<span class="ident" id="7314357">g</span>&nbsp;<span class="op" id="7314359">!=</span>&nbsp;<span class="ident" id="7314362">e</span>&nbsp;<span class="op" id="7314364">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314368">t</span><span class="op" id="7314369">.</span><span class="ident" id="7314370">Errorf</span><span class="op" id="7314376">(</span><span class="string" id="7314377">&#34;part&nbsp;2:&nbsp;want&nbsp;form&nbsp;name&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7314412">,</span>&nbsp;<span class="ident" id="7314414">e</span><span class="op" id="7314415">,</span>&nbsp;<span class="ident" id="7314417">g</span><span class="op" id="7314418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314424">slurp</span><span class="op" id="7314429">,</span>&nbsp;<span class="ident" id="7314431">err</span>&nbsp;<span class="op" id="7314435">=</span>&nbsp;<span class="ident" id="7314437">ioutil</span><span class="op" id="7314443">.</span><span class="ident" id="7314444">ReadAll</span><span class="op" id="7314451">(</span><span class="ident" id="7314452">part</span><span class="op" id="7314456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314459">if</span>&nbsp;<span class="ident" id="7314462">err</span>&nbsp;<span class="op" id="7314466">!=</span>&nbsp;<span class="ident" id="7314469">nil</span>&nbsp;<span class="op" id="7314473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314477">t</span><span class="op" id="7314478">.</span><span class="ident" id="7314479">Fatalf</span><span class="op" id="7314485">(</span><span class="string" id="7314486">&#34;part&nbsp;2:&nbsp;ReadAll:&nbsp;%v&#34;</span><span class="op" id="7314507">,</span>&nbsp;<span class="ident" id="7314509">err</span><span class="op" id="7314512">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314518">if</span>&nbsp;<span class="ident" id="7314521">e</span><span class="op" id="7314522">,</span>&nbsp;<span class="ident" id="7314524">g</span>&nbsp;<span class="op" id="7314526">:=</span>&nbsp;<span class="string" id="7314529">&#34;val&#34;</span><span class="op" id="7314534">,</span>&nbsp;<span class="builtintype" id="7314536">string</span><span class="op" id="7314542">(</span><span class="ident" id="7314543">slurp</span><span class="op" id="7314548">)</span><span class="op" id="7314549">;</span>&nbsp;<span class="ident" id="7314551">e</span>&nbsp;<span class="op" id="7314553">!=</span>&nbsp;<span class="ident" id="7314556">g</span>&nbsp;<span class="op" id="7314558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314562">t</span><span class="op" id="7314563">.</span><span class="ident" id="7314564">Errorf</span><span class="op" id="7314570">(</span><span class="string" id="7314571">&#34;part&nbsp;2:&nbsp;want&nbsp;contents&nbsp;%q,&nbsp;got&nbsp;%q&#34;</span><span class="op" id="7314605">,</span>&nbsp;<span class="ident" id="7314607">e</span><span class="op" id="7314608">,</span>&nbsp;<span class="ident" id="7314610">g</span><span class="op" id="7314611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314618">part</span><span class="op" id="7314622">,</span>&nbsp;<span class="ident" id="7314624">err</span>&nbsp;<span class="op" id="7314628">=</span>&nbsp;<span class="ident" id="7314630">r</span><span class="op" id="7314631">.</span><span class="ident" id="7314632">NextPart</span><span class="op" id="7314640">(</span><span class="op" id="7314641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314644">if</span>&nbsp;<span class="ident" id="7314647">part</span>&nbsp;<span class="op" id="7314652">!=</span>&nbsp;<span class="ident" id="7314655">nil</span>&nbsp;<span class="op" id="7314659">||</span>&nbsp;<span class="ident" id="7314662">err</span>&nbsp;<span class="op" id="7314666">==</span>&nbsp;<span class="ident" id="7314669">nil</span>&nbsp;<span class="op" id="7314673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314677">t</span><span class="op" id="7314678">.</span><span class="ident" id="7314679">Fatalf</span><span class="op" id="7314685">(</span><span class="string" id="7314686">&#34;expected&nbsp;end&nbsp;of&nbsp;parts;&nbsp;got&nbsp;%v,&nbsp;%v&#34;</span><span class="op" id="7314721">,</span>&nbsp;<span class="ident" id="7314723">part</span><span class="op" id="7314727">,</span>&nbsp;<span class="ident" id="7314729">err</span><span class="op" id="7314732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314735">}</span><br>
<span class="lineno"></span><span class="op" id="7314737">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="7314740">func</span>&nbsp;<span class="ident" id="7314745">TestWriterSetBoundary</span><span class="op" id="7314766">(</span><span class="ident" id="7314767">t</span>&nbsp;<span class="op" id="7314769">*</span><span class="ident" id="7314770">testing</span><span class="op" id="7314777">.</span><span class="ident" id="7314778">T</span><span class="op" id="7314779">)</span>&nbsp;<span class="op" id="7314781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7314784">var</span>&nbsp;<span class="ident" id="7314788">b</span>&nbsp;<span class="ident" id="7314790">bytes</span><span class="op" id="7314795">.</span><span class="ident" id="7314796">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314804">w</span>&nbsp;<span class="op" id="7314806">:=</span>&nbsp;<span class="ident" id="7314809">NewWriter</span><span class="op" id="7314818">(</span><span class="op" id="7314819">&amp;</span><span class="ident" id="7314820">b</span><span class="op" id="7314821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314824">tests</span>&nbsp;<span class="op" id="7314830">:=</span>&nbsp;<span class="op" id="7314833">[</span><span class="op" id="7314834">]</span><span class="keyword" id="7314835">struct</span>&nbsp;<span class="op" id="7314842">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314846">b</span>&nbsp;&nbsp;<span class="builtintype" id="7314849">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7314858">ok</span>&nbsp;<span class="builtintype" id="7314861">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314867">}</span><span class="op" id="7314868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314872">{</span><span class="string" id="7314873">&#34;abc&#34;</span><span class="op" id="7314878">,</span>&nbsp;<span class="builtintype" id="7314880">true</span><span class="op" id="7314884">}</span><span class="op" id="7314885">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314889">{</span><span class="string" id="7314890">&#34;&#34;</span><span class="op" id="7314892">,</span>&nbsp;<span class="builtintype" id="7314894">false</span><span class="op" id="7314899">}</span><span class="op" id="7314900">,</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314904">{</span><span class="string" id="7314905">&#34;ungültig&#34;</span><span class="op" id="7314916">,</span>&nbsp;<span class="builtintype" id="7314918">false</span><span class="op" id="7314923">}</span><span class="op" id="7314924">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314928">{</span><span class="string" id="7314929">&#34;!&#34;</span><span class="op" id="7314932">,</span>&nbsp;<span class="builtintype" id="7314934">false</span><span class="op" id="7314939">}</span><span class="op" id="7314940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314944">{</span><span class="ident" id="7314945">strings</span><span class="op" id="7314952">.</span><span class="ident" id="7314953">Repeat</span><span class="op" id="7314959">(</span><span class="string" id="7314960">&#34;x&#34;</span><span class="op" id="7314963">,</span>&nbsp;<span class="num" id="7314965">69</span><span class="op" id="7314967">)</span><span class="op" id="7314968">,</span>&nbsp;<span class="builtintype" id="7314970">true</span><span class="op" id="7314974">}</span><span class="op" id="7314975">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7314979">{</span><span class="ident" id="7314980">strings</span><span class="op" id="7314987">.</span><span class="ident" id="7314988">Repeat</span><span class="op" id="7314994">(</span><span class="string" id="7314995">&#34;x&#34;</span><span class="op" id="7314998">,</span>&nbsp;<span class="num" id="7315000">70</span><span class="op" id="7315002">)</span><span class="op" id="7315003">,</span>&nbsp;<span class="builtintype" id="7315005">false</span><span class="op" id="7315010">}</span><span class="op" id="7315011">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315015">{</span><span class="string" id="7315016">&#34;bad!ascii!&#34;</span><span class="op" id="7315028">,</span>&nbsp;<span class="builtintype" id="7315030">false</span><span class="op" id="7315035">}</span><span class="op" id="7315036">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315040">{</span><span class="string" id="7315041">&#34;my-separator&#34;</span><span class="op" id="7315055">,</span>&nbsp;<span class="builtintype" id="7315057">true</span><span class="op" id="7315061">}</span><span class="op" id="7315062">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7315068">for</span>&nbsp;<span class="ident" id="7315072">i</span><span class="op" id="7315073">,</span>&nbsp;<span class="ident" id="7315075">tt</span>&nbsp;<span class="op" id="7315078">:=</span>&nbsp;<span class="keyword" id="7315081">range</span>&nbsp;<span class="ident" id="7315087">tests</span>&nbsp;<span class="op" id="7315093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315097">err</span>&nbsp;<span class="op" id="7315101">:=</span>&nbsp;<span class="ident" id="7315104">w</span><span class="op" id="7315105">.</span><span class="ident" id="7315106">SetBoundary</span><span class="op" id="7315117">(</span><span class="ident" id="7315118">tt</span><span class="op" id="7315120">.</span><span class="ident" id="7315121">b</span><span class="op" id="7315122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315126">got</span>&nbsp;<span class="op" id="7315130">:=</span>&nbsp;<span class="ident" id="7315133">err</span>&nbsp;<span class="op" id="7315137">==</span>&nbsp;<span class="ident" id="7315140">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7315146">if</span>&nbsp;<span class="ident" id="7315149">got</span>&nbsp;<span class="op" id="7315153">!=</span>&nbsp;<span class="ident" id="7315156">tt</span><span class="op" id="7315158">.</span><span class="ident" id="7315159">ok</span>&nbsp;<span class="op" id="7315162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315167">t</span><span class="op" id="7315168">.</span><span class="ident" id="7315169">Errorf</span><span class="op" id="7315175">(</span><span class="string" id="7315176">&#34;%d.&nbsp;boundary&nbsp;%q&nbsp;=&nbsp;%v&nbsp;(%v);&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7315212">,</span>&nbsp;<span class="ident" id="7315214">i</span><span class="op" id="7315215">,</span>&nbsp;<span class="ident" id="7315217">tt</span><span class="op" id="7315219">.</span><span class="ident" id="7315220">b</span><span class="op" id="7315221">,</span>&nbsp;<span class="ident" id="7315223">got</span><span class="op" id="7315226">,</span>&nbsp;<span class="ident" id="7315228">err</span><span class="op" id="7315231">,</span>&nbsp;<span class="ident" id="7315233">tt</span><span class="op" id="7315235">.</span><span class="ident" id="7315236">ok</span><span class="op" id="7315238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315242">}</span>&nbsp;<span class="keyword" id="7315244">else</span>&nbsp;<span class="keyword" id="7315249">if</span>&nbsp;<span class="ident" id="7315252">tt</span><span class="op" id="7315254">.</span><span class="ident" id="7315255">ok</span>&nbsp;<span class="op" id="7315258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315263">got</span>&nbsp;<span class="op" id="7315267">:=</span>&nbsp;<span class="ident" id="7315270">w</span><span class="op" id="7315271">.</span><span class="ident" id="7315272">Boundary</span><span class="op" id="7315280">(</span><span class="op" id="7315281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7315286">if</span>&nbsp;<span class="ident" id="7315289">got</span>&nbsp;<span class="op" id="7315293">!=</span>&nbsp;<span class="ident" id="7315296">tt</span><span class="op" id="7315298">.</span><span class="ident" id="7315299">b</span>&nbsp;<span class="op" id="7315301">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315307">t</span><span class="op" id="7315308">.</span><span class="ident" id="7315309">Errorf</span><span class="op" id="7315315">(</span><span class="string" id="7315316">&#34;boundary&nbsp;=&nbsp;%q;&nbsp;want&nbsp;%q&#34;</span><span class="op" id="7315340">,</span>&nbsp;<span class="ident" id="7315342">got</span><span class="op" id="7315345">,</span>&nbsp;<span class="ident" id="7315347">tt</span><span class="op" id="7315349">.</span><span class="ident" id="7315350">b</span><span class="op" id="7315351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315366">w</span><span class="op" id="7315367">.</span><span class="ident" id="7315368">Close</span><span class="op" id="7315373">(</span><span class="op" id="7315374">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7315377">if</span>&nbsp;<span class="ident" id="7315380">got</span>&nbsp;<span class="op" id="7315384">:=</span>&nbsp;<span class="ident" id="7315387">b</span><span class="op" id="7315388">.</span><span class="ident" id="7315389">String</span><span class="op" id="7315395">(</span><span class="op" id="7315396">)</span><span class="op" id="7315397">;</span>&nbsp;<span class="op" id="7315399">!</span><span class="ident" id="7315400">strings</span><span class="op" id="7315407">.</span><span class="ident" id="7315408">Contains</span><span class="op" id="7315416">(</span><span class="ident" id="7315417">got</span><span class="op" id="7315420">,</span>&nbsp;<span class="string" id="7315422">&#34;\r\n--my-separator--\r\n&#34;</span><span class="op" id="7315448">)</span>&nbsp;<span class="op" id="7315450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315454">t</span><span class="op" id="7315455">.</span><span class="ident" id="7315456">Errorf</span><span class="op" id="7315462">(</span><span class="string" id="7315463">&#34;expected&nbsp;my-separator&nbsp;in&nbsp;output.&nbsp;got:&nbsp;%q&#34;</span><span class="op" id="7315505">,</span>&nbsp;<span class="ident" id="7315507">got</span><span class="op" id="7315510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315513">}</span><br>
<span class="lineno"></span><span class="op" id="7315515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="7315518">func</span>&nbsp;<span class="ident" id="7315523">TestWriterBoundaryGoroutines</span><span class="op" id="7315551">(</span><span class="ident" id="7315552">t</span>&nbsp;<span class="op" id="7315554">*</span><span class="ident" id="7315555">testing</span><span class="op" id="7315562">.</span><span class="ident" id="7315563">T</span><span class="op" id="7315564">)</span>&nbsp;<span class="op" id="7315566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7315569">//&nbsp;Verify&nbsp;there&#39;s&nbsp;no&nbsp;data&nbsp;race&nbsp;accessing&nbsp;any&nbsp;lazy&nbsp;boundary&nbsp;if&nbsp;it&#39;s&nbsp;used&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7315645">//&nbsp;different&nbsp;goroutines.&nbsp;This&nbsp;was&nbsp;previously&nbsp;broken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7315701">//&nbsp;https://codereview.appspot.com/95760043/&nbsp;and&nbsp;reverted&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7315762">//&nbsp;https://codereview.appspot.com/117600043/</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315808">w</span>&nbsp;<span class="op" id="7315810">:=</span>&nbsp;<span class="ident" id="7315813">NewWriter</span><span class="op" id="7315822">(</span><span class="ident" id="7315823">ioutil</span><span class="op" id="7315829">.</span><span class="ident" id="7315830">Discard</span><span class="op" id="7315837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315840">done</span>&nbsp;<span class="op" id="7315845">:=</span>&nbsp;<span class="builtinfunc" id="7315848">make</span><span class="op" id="7315852">(</span><span class="keyword" id="7315853">chan</span>&nbsp;<span class="builtintype" id="7315858">int</span><span class="op" id="7315861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7315864">go</span>&nbsp;<span class="keyword" id="7315867">func</span><span class="op" id="7315871">(</span><span class="op" id="7315872">)</span>&nbsp;<span class="op" id="7315874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315878">w</span><span class="op" id="7315879">.</span><span class="ident" id="7315880">CreateFormField</span><span class="op" id="7315895">(</span><span class="string" id="7315896">&#34;foo&#34;</span><span class="op" id="7315901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315905">done</span>&nbsp;<span class="op" id="7315910">&lt;-</span>&nbsp;<span class="num" id="7315913">1</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315916">}</span><span class="op" id="7315917">(</span><span class="op" id="7315918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7315921">w</span><span class="op" id="7315922">.</span><span class="ident" id="7315923">Boundary</span><span class="op" id="7315931">(</span><span class="op" id="7315932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7315935">&lt;-</span><span class="ident" id="7315937">done</span><br>
<span class="lineno"></span><span class="op" id="7315942">}</span>
</div>
</body>
</html>
