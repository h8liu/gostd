<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/cgi</h2>
<ul>
<li><a href="/gostd/net/http/cgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/cgi/child_test.go.html">child_test.go</a></li>
<li><a href="/gostd/net/http/cgi/host.go.html">host.go</a></li>
<li><a href="/gostd/net/http/cgi/host_test.go.html">host_test.go</a></li>
<li><a href="/gostd/net/http/cgi/matryoshka_test.go.html">matryoshka_test.go</a></li>
<li><a href="/gostd/net/http/cgi/posix_test.go.html">posix_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6255185">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6255240">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6255294">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6255345">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;CGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child</span><br>
<span class="lineno"></span><span class="comment" id="6255405">//&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6255418">package</span>&nbsp;<span class="ident" id="6255426">cgi</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6255431">import</span>&nbsp;<span class="op" id="6255438">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255441">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255450">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255464">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255474">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255481">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255487">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255500">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255507">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255519">&#34;net/url&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255530">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255536">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6255547">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="6255557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="6255560">//&nbsp;Request&nbsp;returns&nbsp;the&nbsp;HTTP&nbsp;request&nbsp;as&nbsp;represented&nbsp;in&nbsp;the&nbsp;current</span><br>
<span class="lineno"></span><span class="comment" id="6255626">//&nbsp;environment.&nbsp;This&nbsp;assumes&nbsp;the&nbsp;current&nbsp;program&nbsp;is&nbsp;being&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6255688">//&nbsp;by&nbsp;a&nbsp;web&nbsp;server&nbsp;in&nbsp;a&nbsp;CGI&nbsp;environment.</span><br>
<span class="lineno"></span><span class="comment" id="6255729">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;is&nbsp;populated,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="6255789">func</span>&nbsp;<span class="ident" id="6255794">Request</span><span class="op" id="6255801">(</span><span class="op" id="6255802">)</span>&nbsp;<span class="op" id="6255804">(</span><span class="op" id="6255805">*</span><span class="ident" id="6255806">http</span><span class="op" id="6255810">.</span><span class="ident" id="6255811">Request</span><span class="op" id="6255818">,</span>&nbsp;<span class="builtintype" id="6255820">error</span><span class="op" id="6255825">)</span>&nbsp;<span class="op" id="6255827">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255830">r</span><span class="op" id="6255831">,</span>&nbsp;<span class="ident" id="6255833">err</span>&nbsp;<span class="op" id="6255837">:=</span>&nbsp;<span class="ident" id="6255840">RequestFromMap</span><span class="op" id="6255854">(</span><span class="ident" id="6255855">envMap</span><span class="op" id="6255861">(</span><span class="ident" id="6255862">os</span><span class="op" id="6255864">.</span><span class="ident" id="6255865">Environ</span><span class="op" id="6255872">(</span><span class="op" id="6255873">)</span><span class="op" id="6255874">)</span><span class="op" id="6255875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6255878">if</span>&nbsp;<span class="ident" id="6255881">err</span>&nbsp;<span class="op" id="6255885">!=</span>&nbsp;<span class="ident" id="6255888">nil</span>&nbsp;<span class="op" id="6255892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6255896">return</span>&nbsp;<span class="ident" id="6255903">nil</span><span class="op" id="6255906">,</span>&nbsp;<span class="ident" id="6255908">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6255913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6255916">if</span>&nbsp;<span class="ident" id="6255919">r</span><span class="op" id="6255920">.</span><span class="ident" id="6255921">ContentLength</span>&nbsp;<span class="op" id="6255935">&gt;</span>&nbsp;<span class="num" id="6255937">0</span>&nbsp;<span class="op" id="6255939">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6255943">r</span><span class="op" id="6255944">.</span><span class="ident" id="6255945">Body</span>&nbsp;<span class="op" id="6255950">=</span>&nbsp;<span class="ident" id="6255952">ioutil</span><span class="op" id="6255958">.</span><span class="ident" id="6255959">NopCloser</span><span class="op" id="6255968">(</span><span class="ident" id="6255969">io</span><span class="op" id="6255971">.</span><span class="ident" id="6255972">LimitReader</span><span class="op" id="6255983">(</span><span class="ident" id="6255984">os</span><span class="op" id="6255986">.</span><span class="ident" id="6255987">Stdin</span><span class="op" id="6255992">,</span>&nbsp;<span class="ident" id="6255994">r</span><span class="op" id="6255995">.</span><span class="ident" id="6255996">ContentLength</span><span class="op" id="6256009">)</span><span class="op" id="6256010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6256013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256016">return</span>&nbsp;<span class="ident" id="6256023">r</span><span class="op" id="6256024">,</span>&nbsp;<span class="ident" id="6256026">nil</span><br>
<span class="lineno"></span><span class="op" id="6256030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="6256033">func</span>&nbsp;<span class="ident" id="6256038">envMap</span><span class="op" id="6256044">(</span><span class="ident" id="6256045">env</span>&nbsp;<span class="op" id="6256049">[</span><span class="op" id="6256050">]</span><span class="builtintype" id="6256051">string</span><span class="op" id="6256057">)</span>&nbsp;<span class="keyword" id="6256059">map</span><span class="op" id="6256062">[</span><span class="builtintype" id="6256063">string</span><span class="op" id="6256069">]</span><span class="builtintype" id="6256070">string</span>&nbsp;<span class="op" id="6256077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256080">m</span>&nbsp;<span class="op" id="6256082">:=</span>&nbsp;<span class="builtinfunc" id="6256085">make</span><span class="op" id="6256089">(</span><span class="keyword" id="6256090">map</span><span class="op" id="6256093">[</span><span class="builtintype" id="6256094">string</span><span class="op" id="6256100">]</span><span class="builtintype" id="6256101">string</span><span class="op" id="6256107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256110">for</span>&nbsp;<span class="ident" id="6256114">_</span><span class="op" id="6256115">,</span>&nbsp;<span class="ident" id="6256117">kv</span>&nbsp;<span class="op" id="6256120">:=</span>&nbsp;<span class="keyword" id="6256123">range</span>&nbsp;<span class="ident" id="6256129">env</span>&nbsp;<span class="op" id="6256133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256137">if</span>&nbsp;<span class="ident" id="6256140">idx</span>&nbsp;<span class="op" id="6256144">:=</span>&nbsp;<span class="ident" id="6256147">strings</span><span class="op" id="6256154">.</span><span class="ident" id="6256155">Index</span><span class="op" id="6256160">(</span><span class="ident" id="6256161">kv</span><span class="op" id="6256163">,</span>&nbsp;<span class="string" id="6256165">&#34;=&#34;</span><span class="op" id="6256168">)</span><span class="op" id="6256169">;</span>&nbsp;<span class="ident" id="6256171">idx</span>&nbsp;<span class="op" id="6256175">!=</span>&nbsp;<span class="op" id="6256178">-</span><span class="num" id="6256179">1</span>&nbsp;<span class="op" id="6256181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256186">m</span><span class="op" id="6256187">[</span><span class="ident" id="6256188">kv</span><span class="op" id="6256190">[</span><span class="op" id="6256191">:</span><span class="ident" id="6256192">idx</span><span class="op" id="6256195">]</span><span class="op" id="6256196">]</span>&nbsp;<span class="op" id="6256198">=</span>&nbsp;<span class="ident" id="6256200">kv</span><span class="op" id="6256202">[</span><span class="ident" id="6256203">idx</span><span class="op" id="6256206">+</span><span class="num" id="6256207">1</span><span class="op" id="6256208">:</span><span class="op" id="6256209">]</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6256213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6256216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256219">return</span>&nbsp;<span class="ident" id="6256226">m</span><br>
<span class="lineno"></span><span class="op" id="6256228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="6256231">//&nbsp;RequestFromMap&nbsp;creates&nbsp;an&nbsp;http.Request&nbsp;from&nbsp;CGI&nbsp;variables.</span><br>
<span class="lineno"></span><span class="comment" id="6256293">//&nbsp;The&nbsp;returned&nbsp;Request&#39;s&nbsp;Body&nbsp;field&nbsp;is&nbsp;not&nbsp;populated.</span><br>
<span class="lineno"></span><span class="keyword" id="6256348">func</span>&nbsp;<span class="ident" id="6256353">RequestFromMap</span><span class="op" id="6256367">(</span><span class="ident" id="6256368">params</span>&nbsp;<span class="keyword" id="6256375">map</span><span class="op" id="6256378">[</span><span class="builtintype" id="6256379">string</span><span class="op" id="6256385">]</span><span class="builtintype" id="6256386">string</span><span class="op" id="6256392">)</span>&nbsp;<span class="op" id="6256394">(</span><span class="op" id="6256395">*</span><span class="ident" id="6256396">http</span><span class="op" id="6256400">.</span><span class="ident" id="6256401">Request</span><span class="op" id="6256408">,</span>&nbsp;<span class="builtintype" id="6256410">error</span><span class="op" id="6256415">)</span>&nbsp;<span class="op" id="6256417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256420">r</span>&nbsp;<span class="op" id="6256422">:=</span>&nbsp;<span class="builtinfunc" id="6256425">new</span><span class="op" id="6256428">(</span><span class="ident" id="6256429">http</span><span class="op" id="6256433">.</span><span class="ident" id="6256434">Request</span><span class="op" id="6256441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256444">r</span><span class="op" id="6256445">.</span><span class="ident" id="6256446">Method</span>&nbsp;<span class="op" id="6256453">=</span>&nbsp;<span class="ident" id="6256455">params</span><span class="op" id="6256461">[</span><span class="string" id="6256462">&#34;REQUEST_METHOD&#34;</span><span class="op" id="6256478">]</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256481">if</span>&nbsp;<span class="ident" id="6256484">r</span><span class="op" id="6256485">.</span><span class="ident" id="6256486">Method</span>&nbsp;<span class="op" id="6256493">==</span>&nbsp;<span class="string" id="6256496">&#34;&#34;</span>&nbsp;<span class="op" id="6256499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256503">return</span>&nbsp;<span class="ident" id="6256510">nil</span><span class="op" id="6256513">,</span>&nbsp;<span class="ident" id="6256515">errors</span><span class="op" id="6256521">.</span><span class="ident" id="6256522">New</span><span class="op" id="6256525">(</span><span class="string" id="6256526">&#34;cgi:&nbsp;no&nbsp;REQUEST_METHOD&nbsp;in&nbsp;environment&#34;</span><span class="op" id="6256565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6256568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256572">r</span><span class="op" id="6256573">.</span><span class="ident" id="6256574">Proto</span>&nbsp;<span class="op" id="6256580">=</span>&nbsp;<span class="ident" id="6256582">params</span><span class="op" id="6256588">[</span><span class="string" id="6256589">&#34;SERVER_PROTOCOL&#34;</span><span class="op" id="6256606">]</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256609">var</span>&nbsp;<span class="ident" id="6256613">ok</span>&nbsp;<span class="builtintype" id="6256616">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256622">r</span><span class="op" id="6256623">.</span><span class="ident" id="6256624">ProtoMajor</span><span class="op" id="6256634">,</span>&nbsp;<span class="ident" id="6256636">r</span><span class="op" id="6256637">.</span><span class="ident" id="6256638">ProtoMinor</span><span class="op" id="6256648">,</span>&nbsp;<span class="ident" id="6256650">ok</span>&nbsp;<span class="op" id="6256653">=</span>&nbsp;<span class="ident" id="6256655">http</span><span class="op" id="6256659">.</span><span class="ident" id="6256660">ParseHTTPVersion</span><span class="op" id="6256676">(</span><span class="ident" id="6256677">r</span><span class="op" id="6256678">.</span><span class="ident" id="6256679">Proto</span><span class="op" id="6256684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256687">if</span>&nbsp;<span class="op" id="6256690">!</span><span class="ident" id="6256691">ok</span>&nbsp;<span class="op" id="6256694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256698">return</span>&nbsp;<span class="ident" id="6256705">nil</span><span class="op" id="6256708">,</span>&nbsp;<span class="ident" id="6256710">errors</span><span class="op" id="6256716">.</span><span class="ident" id="6256717">New</span><span class="op" id="6256720">(</span><span class="string" id="6256721">&#34;cgi:&nbsp;invalid&nbsp;SERVER_PROTOCOL&nbsp;version&#34;</span><span class="op" id="6256759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6256762">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256766">r</span><span class="op" id="6256767">.</span><span class="ident" id="6256768">Close</span>&nbsp;<span class="op" id="6256774">=</span>&nbsp;<span class="builtintype" id="6256776">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256782">r</span><span class="op" id="6256783">.</span><span class="ident" id="6256784">Trailer</span>&nbsp;<span class="op" id="6256792">=</span>&nbsp;<span class="ident" id="6256794">http</span><span class="op" id="6256798">.</span><span class="ident" id="6256799">Header</span><span class="op" id="6256805">{</span><span class="op" id="6256806">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256809">r</span><span class="op" id="6256810">.</span><span class="ident" id="6256811">Header</span>&nbsp;<span class="op" id="6256818">=</span>&nbsp;<span class="ident" id="6256820">http</span><span class="op" id="6256824">.</span><span class="ident" id="6256825">Header</span><span class="op" id="6256831">{</span><span class="op" id="6256832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256836">r</span><span class="op" id="6256837">.</span><span class="ident" id="6256838">Host</span>&nbsp;<span class="op" id="6256843">=</span>&nbsp;<span class="ident" id="6256845">params</span><span class="op" id="6256851">[</span><span class="string" id="6256852">&#34;HTTP_HOST&#34;</span><span class="op" id="6256863">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256867">if</span>&nbsp;<span class="ident" id="6256870">lenstr</span>&nbsp;<span class="op" id="6256877">:=</span>&nbsp;<span class="ident" id="6256880">params</span><span class="op" id="6256886">[</span><span class="string" id="6256887">&#34;CONTENT_LENGTH&#34;</span><span class="op" id="6256903">]</span><span class="op" id="6256904">;</span>&nbsp;<span class="ident" id="6256906">lenstr</span>&nbsp;<span class="op" id="6256913">!=</span>&nbsp;<span class="string" id="6256916">&#34;&#34;</span>&nbsp;<span class="op" id="6256919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256923">clen</span><span class="op" id="6256927">,</span>&nbsp;<span class="ident" id="6256929">err</span>&nbsp;<span class="op" id="6256933">:=</span>&nbsp;<span class="ident" id="6256936">strconv</span><span class="op" id="6256943">.</span><span class="ident" id="6256944">ParseInt</span><span class="op" id="6256952">(</span><span class="ident" id="6256953">lenstr</span><span class="op" id="6256959">,</span>&nbsp;<span class="num" id="6256961">10</span><span class="op" id="6256963">,</span>&nbsp;<span class="num" id="6256965">64</span><span class="op" id="6256967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256971">if</span>&nbsp;<span class="ident" id="6256974">err</span>&nbsp;<span class="op" id="6256978">!=</span>&nbsp;<span class="ident" id="6256981">nil</span>&nbsp;<span class="op" id="6256985">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256990">return</span>&nbsp;<span class="ident" id="6256997">nil</span><span class="op" id="6257000">,</span>&nbsp;<span class="ident" id="6257002">errors</span><span class="op" id="6257008">.</span><span class="ident" id="6257009">New</span><span class="op" id="6257012">(</span><span class="string" id="6257013">&#34;cgi:&nbsp;bad&nbsp;CONTENT_LENGTH&nbsp;in&nbsp;environment:&nbsp;&#34;</span>&nbsp;<span class="op" id="6257056">+</span>&nbsp;<span class="ident" id="6257058">lenstr</span><span class="op" id="6257064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257068">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257072">r</span><span class="op" id="6257073">.</span><span class="ident" id="6257074">ContentLength</span>&nbsp;<span class="op" id="6257088">=</span>&nbsp;<span class="ident" id="6257090">clen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257100">if</span>&nbsp;<span class="ident" id="6257103">ct</span>&nbsp;<span class="op" id="6257106">:=</span>&nbsp;<span class="ident" id="6257109">params</span><span class="op" id="6257115">[</span><span class="string" id="6257116">&#34;CONTENT_TYPE&#34;</span><span class="op" id="6257130">]</span><span class="op" id="6257131">;</span>&nbsp;<span class="ident" id="6257133">ct</span>&nbsp;<span class="op" id="6257136">!=</span>&nbsp;<span class="string" id="6257139">&#34;&#34;</span>&nbsp;<span class="op" id="6257142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257146">r</span><span class="op" id="6257147">.</span><span class="ident" id="6257148">Header</span><span class="op" id="6257154">.</span><span class="ident" id="6257155">Set</span><span class="op" id="6257158">(</span><span class="string" id="6257159">&#34;Content-Type&#34;</span><span class="op" id="6257173">,</span>&nbsp;<span class="ident" id="6257175">ct</span><span class="op" id="6257177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257180">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257184">//&nbsp;Copy&nbsp;&#34;HTTP_FOO_BAR&#34;&nbsp;variables&nbsp;to&nbsp;&#34;Foo-Bar&#34;&nbsp;Headers</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257239">for</span>&nbsp;<span class="ident" id="6257243">k</span><span class="op" id="6257244">,</span>&nbsp;<span class="ident" id="6257246">v</span>&nbsp;<span class="op" id="6257248">:=</span>&nbsp;<span class="keyword" id="6257251">range</span>&nbsp;<span class="ident" id="6257257">params</span>&nbsp;<span class="op" id="6257264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257268">if</span>&nbsp;<span class="op" id="6257271">!</span><span class="ident" id="6257272">strings</span><span class="op" id="6257279">.</span><span class="ident" id="6257280">HasPrefix</span><span class="op" id="6257289">(</span><span class="ident" id="6257290">k</span><span class="op" id="6257291">,</span>&nbsp;<span class="string" id="6257293">&#34;HTTP_&#34;</span><span class="op" id="6257300">)</span>&nbsp;<span class="op" id="6257302">||</span>&nbsp;<span class="ident" id="6257305">k</span>&nbsp;<span class="op" id="6257307">==</span>&nbsp;<span class="string" id="6257310">&#34;HTTP_HOST&#34;</span>&nbsp;<span class="op" id="6257322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257327">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257342">r</span><span class="op" id="6257343">.</span><span class="ident" id="6257344">Header</span><span class="op" id="6257350">.</span><span class="ident" id="6257351">Add</span><span class="op" id="6257354">(</span><span class="ident" id="6257355">strings</span><span class="op" id="6257362">.</span><span class="ident" id="6257363">Replace</span><span class="op" id="6257370">(</span><span class="ident" id="6257371">k</span><span class="op" id="6257372">[</span><span class="num" id="6257373">5</span><span class="op" id="6257374">:</span><span class="op" id="6257375">]</span><span class="op" id="6257376">,</span>&nbsp;<span class="string" id="6257378">&#34;_&#34;</span><span class="op" id="6257381">,</span>&nbsp;<span class="string" id="6257383">&#34;-&#34;</span><span class="op" id="6257386">,</span>&nbsp;<span class="op" id="6257388">-</span><span class="num" id="6257389">1</span><span class="op" id="6257390">)</span><span class="op" id="6257391">,</span>&nbsp;<span class="ident" id="6257393">v</span><span class="op" id="6257394">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257401">//&nbsp;TODO:&nbsp;cookies.&nbsp;&nbsp;parsing&nbsp;them&nbsp;isn&#39;t&nbsp;exported,&nbsp;though.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257459">uriStr</span>&nbsp;<span class="op" id="6257466">:=</span>&nbsp;<span class="ident" id="6257469">params</span><span class="op" id="6257475">[</span><span class="string" id="6257476">&#34;REQUEST_URI&#34;</span><span class="op" id="6257489">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257492">if</span>&nbsp;<span class="ident" id="6257495">uriStr</span>&nbsp;<span class="op" id="6257502">==</span>&nbsp;<span class="string" id="6257505">&#34;&#34;</span>&nbsp;<span class="op" id="6257508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257512">//&nbsp;Fallback&nbsp;to&nbsp;SCRIPT_NAME,&nbsp;PATH_INFO&nbsp;and&nbsp;QUERY_STRING.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257570">uriStr</span>&nbsp;<span class="op" id="6257577">=</span>&nbsp;<span class="ident" id="6257579">params</span><span class="op" id="6257585">[</span><span class="string" id="6257586">&#34;SCRIPT_NAME&#34;</span><span class="op" id="6257599">]</span>&nbsp;<span class="op" id="6257601">+</span>&nbsp;<span class="ident" id="6257603">params</span><span class="op" id="6257609">[</span><span class="string" id="6257610">&#34;PATH_INFO&#34;</span><span class="op" id="6257621">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257625">s</span>&nbsp;<span class="op" id="6257627">:=</span>&nbsp;<span class="ident" id="6257630">params</span><span class="op" id="6257636">[</span><span class="string" id="6257637">&#34;QUERY_STRING&#34;</span><span class="op" id="6257651">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257655">if</span>&nbsp;<span class="ident" id="6257658">s</span>&nbsp;<span class="op" id="6257660">!=</span>&nbsp;<span class="string" id="6257663">&#34;&#34;</span>&nbsp;<span class="op" id="6257666">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257671">uriStr</span>&nbsp;<span class="op" id="6257678">+=</span>&nbsp;<span class="string" id="6257681">&#34;?&#34;</span>&nbsp;<span class="op" id="6257685">+</span>&nbsp;<span class="ident" id="6257687">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257691">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257698">//&nbsp;There&#39;s&nbsp;apparently&nbsp;a&nbsp;de-facto&nbsp;standard&nbsp;for&nbsp;this.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257751">//&nbsp;http://docstore.mik.ua/orelly/linux/cgi/ch03_02.htm#ch03-35636</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257818">if</span>&nbsp;<span class="ident" id="6257821">s</span>&nbsp;<span class="op" id="6257823">:=</span>&nbsp;<span class="ident" id="6257826">params</span><span class="op" id="6257832">[</span><span class="string" id="6257833">&#34;HTTPS&#34;</span><span class="op" id="6257840">]</span><span class="op" id="6257841">;</span>&nbsp;<span class="ident" id="6257843">s</span>&nbsp;<span class="op" id="6257845">==</span>&nbsp;<span class="string" id="6257848">&#34;on&#34;</span>&nbsp;<span class="op" id="6257853">||</span>&nbsp;<span class="ident" id="6257856">s</span>&nbsp;<span class="op" id="6257858">==</span>&nbsp;<span class="string" id="6257861">&#34;ON&#34;</span>&nbsp;<span class="op" id="6257866">||</span>&nbsp;<span class="ident" id="6257869">s</span>&nbsp;<span class="op" id="6257871">==</span>&nbsp;<span class="string" id="6257874">&#34;1&#34;</span>&nbsp;<span class="op" id="6257878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257882">r</span><span class="op" id="6257883">.</span><span class="ident" id="6257884">TLS</span>&nbsp;<span class="op" id="6257888">=</span>&nbsp;<span class="op" id="6257890">&amp;</span><span class="ident" id="6257891">tls</span><span class="op" id="6257894">.</span><span class="ident" id="6257895">ConnectionState</span><span class="op" id="6257910">{</span><span class="ident" id="6257911">HandshakeComplete</span><span class="op" id="6257928">:</span>&nbsp;<span class="builtintype" id="6257930">true</span><span class="op" id="6257934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6257937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257941">if</span>&nbsp;<span class="ident" id="6257944">r</span><span class="op" id="6257945">.</span><span class="ident" id="6257946">Host</span>&nbsp;<span class="op" id="6257951">!=</span>&nbsp;<span class="string" id="6257954">&#34;&#34;</span>&nbsp;<span class="op" id="6257957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6257961">//&nbsp;Hostname&nbsp;is&nbsp;provided,&nbsp;so&nbsp;we&nbsp;can&nbsp;reasonably&nbsp;construct&nbsp;a&nbsp;URL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258026">rawurl</span>&nbsp;<span class="op" id="6258033">:=</span>&nbsp;<span class="ident" id="6258036">r</span><span class="op" id="6258037">.</span><span class="ident" id="6258038">Host</span>&nbsp;<span class="op" id="6258043">+</span>&nbsp;<span class="ident" id="6258045">uriStr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258054">if</span>&nbsp;<span class="ident" id="6258057">r</span><span class="op" id="6258058">.</span><span class="ident" id="6258059">TLS</span>&nbsp;<span class="op" id="6258063">==</span>&nbsp;<span class="ident" id="6258066">nil</span>&nbsp;<span class="op" id="6258070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258075">rawurl</span>&nbsp;<span class="op" id="6258082">=</span>&nbsp;<span class="string" id="6258084">&#34;http://&#34;</span>&nbsp;<span class="op" id="6258094">+</span>&nbsp;<span class="ident" id="6258096">rawurl</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258105">}</span>&nbsp;<span class="keyword" id="6258107">else</span>&nbsp;<span class="op" id="6258112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258117">rawurl</span>&nbsp;<span class="op" id="6258124">=</span>&nbsp;<span class="string" id="6258126">&#34;https://&#34;</span>&nbsp;<span class="op" id="6258137">+</span>&nbsp;<span class="ident" id="6258139">rawurl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258152">url</span><span class="op" id="6258155">,</span>&nbsp;<span class="ident" id="6258157">err</span>&nbsp;<span class="op" id="6258161">:=</span>&nbsp;<span class="ident" id="6258164">url</span><span class="op" id="6258167">.</span><span class="ident" id="6258168">Parse</span><span class="op" id="6258173">(</span><span class="ident" id="6258174">rawurl</span><span class="op" id="6258180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258184">if</span>&nbsp;<span class="ident" id="6258187">err</span>&nbsp;<span class="op" id="6258191">!=</span>&nbsp;<span class="ident" id="6258194">nil</span>&nbsp;<span class="op" id="6258198">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258203">return</span>&nbsp;<span class="ident" id="6258210">nil</span><span class="op" id="6258213">,</span>&nbsp;<span class="ident" id="6258215">errors</span><span class="op" id="6258221">.</span><span class="ident" id="6258222">New</span><span class="op" id="6258225">(</span><span class="string" id="6258226">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;host&nbsp;and&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6258283">+</span>&nbsp;<span class="ident" id="6258285">rawurl</span><span class="op" id="6258291">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258299">r</span><span class="op" id="6258300">.</span><span class="ident" id="6258301">URL</span>&nbsp;<span class="op" id="6258305">=</span>&nbsp;<span class="ident" id="6258307">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258315">//&nbsp;Fallback&nbsp;logic&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;Host&nbsp;header&nbsp;or&nbsp;the&nbsp;URL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258376">//&nbsp;failed&nbsp;to&nbsp;parse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258396">if</span>&nbsp;<span class="ident" id="6258399">r</span><span class="op" id="6258400">.</span><span class="ident" id="6258401">URL</span>&nbsp;<span class="op" id="6258405">==</span>&nbsp;<span class="ident" id="6258408">nil</span>&nbsp;<span class="op" id="6258412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258416">url</span><span class="op" id="6258419">,</span>&nbsp;<span class="ident" id="6258421">err</span>&nbsp;<span class="op" id="6258425">:=</span>&nbsp;<span class="ident" id="6258428">url</span><span class="op" id="6258431">.</span><span class="ident" id="6258432">Parse</span><span class="op" id="6258437">(</span><span class="ident" id="6258438">uriStr</span><span class="op" id="6258444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258448">if</span>&nbsp;<span class="ident" id="6258451">err</span>&nbsp;<span class="op" id="6258455">!=</span>&nbsp;<span class="ident" id="6258458">nil</span>&nbsp;<span class="op" id="6258462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258467">return</span>&nbsp;<span class="ident" id="6258474">nil</span><span class="op" id="6258477">,</span>&nbsp;<span class="ident" id="6258479">errors</span><span class="op" id="6258485">.</span><span class="ident" id="6258486">New</span><span class="op" id="6258489">(</span><span class="string" id="6258490">&#34;cgi:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;REQUEST_URI&nbsp;into&nbsp;a&nbsp;URL:&nbsp;&#34;</span>&nbsp;<span class="op" id="6258538">+</span>&nbsp;<span class="ident" id="6258540">uriStr</span><span class="op" id="6258546">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258554">r</span><span class="op" id="6258555">.</span><span class="ident" id="6258556">URL</span>&nbsp;<span class="op" id="6258560">=</span>&nbsp;<span class="ident" id="6258562">url</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258571">//&nbsp;Request.RemoteAddr&nbsp;has&nbsp;its&nbsp;port&nbsp;set&nbsp;by&nbsp;Go&#39;s&nbsp;standard&nbsp;http</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258633">//&nbsp;server,&nbsp;so&nbsp;we&nbsp;do&nbsp;here&nbsp;too.&nbsp;We&nbsp;don&#39;t&nbsp;have&nbsp;one,&nbsp;though,&nbsp;so&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258697">//&nbsp;use&nbsp;a&nbsp;dummy&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258718">r</span><span class="op" id="6258719">.</span><span class="ident" id="6258720">RemoteAddr</span>&nbsp;<span class="op" id="6258731">=</span>&nbsp;<span class="ident" id="6258733">net</span><span class="op" id="6258736">.</span><span class="ident" id="6258737">JoinHostPort</span><span class="op" id="6258749">(</span><span class="ident" id="6258750">params</span><span class="op" id="6258756">[</span><span class="string" id="6258757">&#34;REMOTE_ADDR&#34;</span><span class="op" id="6258770">]</span><span class="op" id="6258771">,</span>&nbsp;<span class="string" id="6258773">&#34;0&#34;</span><span class="op" id="6258776">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258780">return</span>&nbsp;<span class="ident" id="6258787">r</span><span class="op" id="6258788">,</span>&nbsp;<span class="ident" id="6258790">nil</span><br>
<span class="lineno">140</span><span class="op" id="6258794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6258797">//&nbsp;Serve&nbsp;executes&nbsp;the&nbsp;provided&nbsp;Handler&nbsp;on&nbsp;the&nbsp;currently&nbsp;active&nbsp;CGI</span><br>
<span class="lineno"></span><span class="comment" id="6258864">//&nbsp;request,&nbsp;if&nbsp;any.&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;current&nbsp;CGI&nbsp;environment</span><br>
<span class="lineno"></span><span class="comment" id="6258922">//&nbsp;an&nbsp;error&nbsp;is&nbsp;returned.&nbsp;The&nbsp;provided&nbsp;handler&nbsp;may&nbsp;be&nbsp;nil&nbsp;to&nbsp;use</span><br>
<span class="lineno">145</span><span class="comment" id="6258986">//&nbsp;http.DefaultServeMux.</span><br>
<span class="lineno"></span><span class="keyword" id="6259011">func</span>&nbsp;<span class="ident" id="6259016">Serve</span><span class="op" id="6259021">(</span><span class="ident" id="6259022">handler</span>&nbsp;<span class="ident" id="6259030">http</span><span class="op" id="6259034">.</span><span class="ident" id="6259035">Handler</span><span class="op" id="6259042">)</span>&nbsp;<span class="builtintype" id="6259044">error</span>&nbsp;<span class="op" id="6259050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259053">req</span><span class="op" id="6259056">,</span>&nbsp;<span class="ident" id="6259058">err</span>&nbsp;<span class="op" id="6259062">:=</span>&nbsp;<span class="ident" id="6259065">Request</span><span class="op" id="6259072">(</span><span class="op" id="6259073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259076">if</span>&nbsp;<span class="ident" id="6259079">err</span>&nbsp;<span class="op" id="6259083">!=</span>&nbsp;<span class="ident" id="6259086">nil</span>&nbsp;<span class="op" id="6259090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259094">return</span>&nbsp;<span class="ident" id="6259101">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259109">if</span>&nbsp;<span class="ident" id="6259112">handler</span>&nbsp;<span class="op" id="6259120">==</span>&nbsp;<span class="ident" id="6259123">nil</span>&nbsp;<span class="op" id="6259127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259131">handler</span>&nbsp;<span class="op" id="6259139">=</span>&nbsp;<span class="ident" id="6259141">http</span><span class="op" id="6259145">.</span><span class="ident" id="6259146">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259166">rw</span>&nbsp;<span class="op" id="6259169">:=</span>&nbsp;<span class="op" id="6259172">&amp;</span><span class="ident" id="6259173">response</span><span class="op" id="6259181">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259185">req</span><span class="op" id="6259188">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259193">req</span><span class="op" id="6259196">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259200">header</span><span class="op" id="6259206">:</span>&nbsp;<span class="builtinfunc" id="6259208">make</span><span class="op" id="6259212">(</span><span class="ident" id="6259213">http</span><span class="op" id="6259217">.</span><span class="ident" id="6259218">Header</span><span class="op" id="6259224">)</span><span class="op" id="6259225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259229">bufw</span><span class="op" id="6259233">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6259237">bufio</span><span class="op" id="6259242">.</span><span class="ident" id="6259243">NewWriter</span><span class="op" id="6259252">(</span><span class="ident" id="6259253">os</span><span class="op" id="6259255">.</span><span class="ident" id="6259256">Stdout</span><span class="op" id="6259262">)</span><span class="op" id="6259263">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259269">handler</span><span class="op" id="6259276">.</span><span class="ident" id="6259277">ServeHTTP</span><span class="op" id="6259286">(</span><span class="ident" id="6259287">rw</span><span class="op" id="6259289">,</span>&nbsp;<span class="ident" id="6259291">req</span><span class="op" id="6259294">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259297">rw</span><span class="op" id="6259299">.</span><span class="ident" id="6259300">Write</span><span class="op" id="6259305">(</span><span class="ident" id="6259306">nil</span><span class="op" id="6259309">)</span>&nbsp;<span class="comment" id="6259311">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;response&nbsp;is&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259344">if</span>&nbsp;<span class="ident" id="6259347">err</span>&nbsp;<span class="op" id="6259351">=</span>&nbsp;<span class="ident" id="6259353">rw</span><span class="op" id="6259355">.</span><span class="ident" id="6259356">bufw</span><span class="op" id="6259360">.</span><span class="ident" id="6259361">Flush</span><span class="op" id="6259366">(</span><span class="op" id="6259367">)</span><span class="op" id="6259368">;</span>&nbsp;<span class="ident" id="6259370">err</span>&nbsp;<span class="op" id="6259374">!=</span>&nbsp;<span class="ident" id="6259377">nil</span>&nbsp;<span class="op" id="6259381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259385">return</span>&nbsp;<span class="ident" id="6259392">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259397">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259400">return</span>&nbsp;<span class="ident" id="6259407">nil</span><br>
<span class="lineno">165</span><span class="op" id="6259411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259414">type</span>&nbsp;<span class="ident" id="6259419">response</span>&nbsp;<span class="keyword" id="6259428">struct</span>&nbsp;<span class="op" id="6259435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259438">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259449">*</span><span class="ident" id="6259450">http</span><span class="op" id="6259454">.</span><span class="ident" id="6259455">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259464">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6259475">http</span><span class="op" id="6259479">.</span><span class="ident" id="6259480">Header</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259488">bufw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6259499">*</span><span class="ident" id="6259500">bufio</span><span class="op" id="6259505">.</span><span class="ident" id="6259506">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259514">headerSent</span>&nbsp;<span class="builtintype" id="6259525">bool</span><br>
<span class="lineno"></span><span class="op" id="6259530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259533">func</span>&nbsp;<span class="op" id="6259538">(</span><span class="ident" id="6259539">r</span>&nbsp;<span class="op" id="6259541">*</span><span class="ident" id="6259542">response</span><span class="op" id="6259550">)</span>&nbsp;<span class="ident" id="6259552">Flush</span><span class="op" id="6259557">(</span><span class="op" id="6259558">)</span>&nbsp;<span class="op" id="6259560">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259563">r</span><span class="op" id="6259564">.</span><span class="ident" id="6259565">bufw</span><span class="op" id="6259569">.</span><span class="ident" id="6259570">Flush</span><span class="op" id="6259575">(</span><span class="op" id="6259576">)</span><br>
<span class="lineno"></span><span class="op" id="6259578">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259581">func</span>&nbsp;<span class="op" id="6259586">(</span><span class="ident" id="6259587">r</span>&nbsp;<span class="op" id="6259589">*</span><span class="ident" id="6259590">response</span><span class="op" id="6259598">)</span>&nbsp;<span class="ident" id="6259600">Header</span><span class="op" id="6259606">(</span><span class="op" id="6259607">)</span>&nbsp;<span class="ident" id="6259609">http</span><span class="op" id="6259613">.</span><span class="ident" id="6259614">Header</span>&nbsp;<span class="op" id="6259621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259624">return</span>&nbsp;<span class="ident" id="6259631">r</span><span class="op" id="6259632">.</span><span class="ident" id="6259633">header</span><br>
<span class="lineno">180</span><span class="op" id="6259640">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259643">func</span>&nbsp;<span class="op" id="6259648">(</span><span class="ident" id="6259649">r</span>&nbsp;<span class="op" id="6259651">*</span><span class="ident" id="6259652">response</span><span class="op" id="6259660">)</span>&nbsp;<span class="ident" id="6259662">Write</span><span class="op" id="6259667">(</span><span class="ident" id="6259668">p</span>&nbsp;<span class="op" id="6259670">[</span><span class="op" id="6259671">]</span><span class="builtintype" id="6259672">byte</span><span class="op" id="6259676">)</span>&nbsp;<span class="op" id="6259678">(</span><span class="ident" id="6259679">n</span>&nbsp;<span class="builtintype" id="6259681">int</span><span class="op" id="6259684">,</span>&nbsp;<span class="ident" id="6259686">err</span>&nbsp;<span class="builtintype" id="6259690">error</span><span class="op" id="6259695">)</span>&nbsp;<span class="op" id="6259697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259700">if</span>&nbsp;<span class="op" id="6259703">!</span><span class="ident" id="6259704">r</span><span class="op" id="6259705">.</span><span class="ident" id="6259706">headerSent</span>&nbsp;<span class="op" id="6259717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259721">r</span><span class="op" id="6259722">.</span><span class="ident" id="6259723">WriteHeader</span><span class="op" id="6259734">(</span><span class="ident" id="6259735">http</span><span class="op" id="6259739">.</span><span class="ident" id="6259740">StatusOK</span><span class="op" id="6259748">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259754">return</span>&nbsp;<span class="ident" id="6259761">r</span><span class="op" id="6259762">.</span><span class="ident" id="6259763">bufw</span><span class="op" id="6259767">.</span><span class="ident" id="6259768">Write</span><span class="op" id="6259773">(</span><span class="ident" id="6259774">p</span><span class="op" id="6259775">)</span><br>
<span class="lineno"></span><span class="op" id="6259777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6259780">func</span>&nbsp;<span class="op" id="6259785">(</span><span class="ident" id="6259786">r</span>&nbsp;<span class="op" id="6259788">*</span><span class="ident" id="6259789">response</span><span class="op" id="6259797">)</span>&nbsp;<span class="ident" id="6259799">WriteHeader</span><span class="op" id="6259810">(</span><span class="ident" id="6259811">code</span>&nbsp;<span class="builtintype" id="6259816">int</span><span class="op" id="6259819">)</span>&nbsp;<span class="op" id="6259821">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259824">if</span>&nbsp;<span class="ident" id="6259827">r</span><span class="op" id="6259828">.</span><span class="ident" id="6259829">headerSent</span>&nbsp;<span class="op" id="6259840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259844">//&nbsp;Note:&nbsp;explicitly&nbsp;using&nbsp;Stderr,&nbsp;as&nbsp;Stdout&nbsp;is&nbsp;our&nbsp;HTTP&nbsp;output.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259910">fmt</span><span class="op" id="6259913">.</span><span class="ident" id="6259914">Fprintf</span><span class="op" id="6259921">(</span><span class="ident" id="6259922">os</span><span class="op" id="6259924">.</span><span class="ident" id="6259925">Stderr</span><span class="op" id="6259931">,</span>&nbsp;<span class="string" id="6259933">&#34;CGI&nbsp;attempted&nbsp;to&nbsp;write&nbsp;header&nbsp;twice&nbsp;on&nbsp;request&nbsp;for&nbsp;%s&#34;</span><span class="op" id="6259988">,</span>&nbsp;<span class="ident" id="6259990">r</span><span class="op" id="6259991">.</span><span class="ident" id="6259992">req</span><span class="op" id="6259995">.</span><span class="ident" id="6259996">URL</span><span class="op" id="6259999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260003">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260011">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260014">r</span><span class="op" id="6260015">.</span><span class="ident" id="6260016">headerSent</span>&nbsp;<span class="op" id="6260027">=</span>&nbsp;<span class="builtintype" id="6260029">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260035">fmt</span><span class="op" id="6260038">.</span><span class="ident" id="6260039">Fprintf</span><span class="op" id="6260046">(</span><span class="ident" id="6260047">r</span><span class="op" id="6260048">.</span><span class="ident" id="6260049">bufw</span><span class="op" id="6260053">,</span>&nbsp;<span class="string" id="6260055">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6260074">,</span>&nbsp;<span class="ident" id="6260076">code</span><span class="op" id="6260080">,</span>&nbsp;<span class="ident" id="6260082">http</span><span class="op" id="6260086">.</span><span class="ident" id="6260087">StatusText</span><span class="op" id="6260097">(</span><span class="ident" id="6260098">code</span><span class="op" id="6260102">)</span><span class="op" id="6260103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6260107">//&nbsp;Set&nbsp;a&nbsp;default&nbsp;Content-Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260138">if</span>&nbsp;<span class="ident" id="6260141">_</span><span class="op" id="6260142">,</span>&nbsp;<span class="ident" id="6260144">hasType</span>&nbsp;<span class="op" id="6260152">:=</span>&nbsp;<span class="ident" id="6260155">r</span><span class="op" id="6260156">.</span><span class="ident" id="6260157">header</span><span class="op" id="6260163">[</span><span class="string" id="6260164">&#34;Content-Type&#34;</span><span class="op" id="6260178">]</span><span class="op" id="6260179">;</span>&nbsp;<span class="op" id="6260181">!</span><span class="ident" id="6260182">hasType</span>&nbsp;<span class="op" id="6260190">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260194">r</span><span class="op" id="6260195">.</span><span class="ident" id="6260196">header</span><span class="op" id="6260202">.</span><span class="ident" id="6260203">Add</span><span class="op" id="6260206">(</span><span class="string" id="6260207">&#34;Content-Type&#34;</span><span class="op" id="6260221">,</span>&nbsp;<span class="string" id="6260223">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6260249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260256">r</span><span class="op" id="6260257">.</span><span class="ident" id="6260258">header</span><span class="op" id="6260264">.</span><span class="ident" id="6260265">Write</span><span class="op" id="6260270">(</span><span class="ident" id="6260271">r</span><span class="op" id="6260272">.</span><span class="ident" id="6260273">bufw</span><span class="op" id="6260277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260280">r</span><span class="op" id="6260281">.</span><span class="ident" id="6260282">bufw</span><span class="op" id="6260286">.</span><span class="ident" id="6260287">WriteString</span><span class="op" id="6260298">(</span><span class="string" id="6260299">&#34;\r\n&#34;</span><span class="op" id="6260305">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260308">r</span><span class="op" id="6260309">.</span><span class="ident" id="6260310">bufw</span><span class="op" id="6260314">.</span><span class="ident" id="6260315">Flush</span><span class="op" id="6260320">(</span><span class="op" id="6260321">)</span><br>
<span class="lineno"></span><span class="op" id="6260323">}</span>
</div>
</body>
</html>
