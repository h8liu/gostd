<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html" class="current">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3237846">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3237902">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3237956">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3238007">package</span>&nbsp;<span class="ident" id="3238015">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3238020">import</span>&nbsp;<span class="string" id="3238027">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3238035">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3238093">type</span>&nbsp;<span class="ident" id="3238098">call</span>&nbsp;<span class="keyword" id="3238103">struct</span>&nbsp;<span class="op" id="3238110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238113">wg</span>&nbsp;<span class="ident" id="3238116">sync</span><span class="op" id="3238120">.</span><span class="ident" id="3238121">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3238133">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3238196">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238247">val</span>&nbsp;<span class="keyword" id="3238251">interface</span><span class="op" id="3238260">{</span><span class="op" id="3238261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238264">err</span>&nbsp;<span class="builtintype" id="3238268">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3238276">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3238336">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3238398">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238443">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3238449">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238454">chans</span>&nbsp;<span class="op" id="3238460">[</span><span class="op" id="3238461">]</span><span class="keyword" id="3238462">chan</span><span class="op" id="3238466">&lt;-</span>&nbsp;<span class="ident" id="3238469">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3238488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3238491">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3238559">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3238626">type</span>&nbsp;<span class="ident" id="3238631">singleflight</span>&nbsp;<span class="keyword" id="3238644">struct</span>&nbsp;<span class="op" id="3238651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238654">mu</span>&nbsp;<span class="ident" id="3238657">sync</span><span class="op" id="3238661">.</span><span class="ident" id="3238662">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3238674">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238689">m</span>&nbsp;&nbsp;<span class="keyword" id="3238692">map</span><span class="op" id="3238695">[</span><span class="builtintype" id="3238696">string</span><span class="op" id="3238702">]</span><span class="op" id="3238703">*</span><span class="ident" id="3238704">call</span>&nbsp;<span class="comment" id="3238709">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3238731">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3238734">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3238803">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3238820">type</span>&nbsp;<span class="ident" id="3238825">singleflightResult</span>&nbsp;<span class="keyword" id="3238844">struct</span>&nbsp;<span class="op" id="3238851">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238854">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3238861">interface</span><span class="op" id="3238870">{</span><span class="op" id="3238871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238874">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3238881">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238888">shared</span>&nbsp;<span class="builtintype" id="3238895">bool</span><br>
<span class="lineno"></span><span class="op" id="3238900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3238903">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3238972">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3239038">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3239107">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3239162">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3239240">func</span>&nbsp;<span class="op" id="3239245">(</span><span class="ident" id="3239246">g</span>&nbsp;<span class="op" id="3239248">*</span><span class="ident" id="3239249">singleflight</span><span class="op" id="3239261">)</span>&nbsp;<span class="ident" id="3239263">Do</span><span class="op" id="3239265">(</span><span class="ident" id="3239266">key</span>&nbsp;<span class="builtintype" id="3239270">string</span><span class="op" id="3239276">,</span>&nbsp;<span class="ident" id="3239278">fn</span>&nbsp;<span class="keyword" id="3239281">func</span><span class="op" id="3239285">(</span><span class="op" id="3239286">)</span>&nbsp;<span class="op" id="3239288">(</span><span class="keyword" id="3239289">interface</span><span class="op" id="3239298">{</span><span class="op" id="3239299">}</span><span class="op" id="3239300">,</span>&nbsp;<span class="builtintype" id="3239302">error</span><span class="op" id="3239307">)</span><span class="op" id="3239308">)</span>&nbsp;<span class="op" id="3239310">(</span><span class="ident" id="3239311">v</span>&nbsp;<span class="keyword" id="3239313">interface</span><span class="op" id="3239322">{</span><span class="op" id="3239323">}</span><span class="op" id="3239324">,</span>&nbsp;<span class="ident" id="3239326">err</span>&nbsp;<span class="builtintype" id="3239330">error</span><span class="op" id="3239335">,</span>&nbsp;<span class="ident" id="3239337">shared</span>&nbsp;<span class="builtintype" id="3239344">bool</span><span class="op" id="3239348">)</span>&nbsp;<span class="op" id="3239350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239353">g</span><span class="op" id="3239354">.</span><span class="ident" id="3239355">mu</span><span class="op" id="3239357">.</span><span class="ident" id="3239358">Lock</span><span class="op" id="3239362">(</span><span class="op" id="3239363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239366">if</span>&nbsp;<span class="ident" id="3239369">g</span><span class="op" id="3239370">.</span><span class="ident" id="3239371">m</span>&nbsp;<span class="op" id="3239373">==</span>&nbsp;<span class="ident" id="3239376">nil</span>&nbsp;<span class="op" id="3239380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239384">g</span><span class="op" id="3239385">.</span><span class="ident" id="3239386">m</span>&nbsp;<span class="op" id="3239388">=</span>&nbsp;<span class="builtinfunc" id="3239390">make</span><span class="op" id="3239394">(</span><span class="keyword" id="3239395">map</span><span class="op" id="3239398">[</span><span class="builtintype" id="3239399">string</span><span class="op" id="3239405">]</span><span class="op" id="3239406">*</span><span class="ident" id="3239407">call</span><span class="op" id="3239411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239414">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239417">if</span>&nbsp;<span class="ident" id="3239420">c</span><span class="op" id="3239421">,</span>&nbsp;<span class="ident" id="3239423">ok</span>&nbsp;<span class="op" id="3239426">:=</span>&nbsp;<span class="ident" id="3239429">g</span><span class="op" id="3239430">.</span><span class="ident" id="3239431">m</span><span class="op" id="3239432">[</span><span class="ident" id="3239433">key</span><span class="op" id="3239436">]</span><span class="op" id="3239437">;</span>&nbsp;<span class="ident" id="3239439">ok</span>&nbsp;<span class="op" id="3239442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239446">c</span><span class="op" id="3239447">.</span><span class="ident" id="3239448">dups</span><span class="op" id="3239452">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239457">g</span><span class="op" id="3239458">.</span><span class="ident" id="3239459">mu</span><span class="op" id="3239461">.</span><span class="ident" id="3239462">Unlock</span><span class="op" id="3239468">(</span><span class="op" id="3239469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239473">c</span><span class="op" id="3239474">.</span><span class="ident" id="3239475">wg</span><span class="op" id="3239477">.</span><span class="ident" id="3239478">Wait</span><span class="op" id="3239482">(</span><span class="op" id="3239483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239487">return</span>&nbsp;<span class="ident" id="3239494">c</span><span class="op" id="3239495">.</span><span class="ident" id="3239496">val</span><span class="op" id="3239499">,</span>&nbsp;<span class="ident" id="3239501">c</span><span class="op" id="3239502">.</span><span class="ident" id="3239503">err</span><span class="op" id="3239506">,</span>&nbsp;<span class="builtintype" id="3239508">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239517">c</span>&nbsp;<span class="op" id="3239519">:=</span>&nbsp;<span class="builtinfunc" id="3239522">new</span><span class="op" id="3239525">(</span><span class="ident" id="3239526">call</span><span class="op" id="3239530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239533">c</span><span class="op" id="3239534">.</span><span class="ident" id="3239535">wg</span><span class="op" id="3239537">.</span><span class="ident" id="3239538">Add</span><span class="op" id="3239541">(</span><span class="num" id="3239542">1</span><span class="op" id="3239543">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239546">g</span><span class="op" id="3239547">.</span><span class="ident" id="3239548">m</span><span class="op" id="3239549">[</span><span class="ident" id="3239550">key</span><span class="op" id="3239553">]</span>&nbsp;<span class="op" id="3239555">=</span>&nbsp;<span class="ident" id="3239557">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239560">g</span><span class="op" id="3239561">.</span><span class="ident" id="3239562">mu</span><span class="op" id="3239564">.</span><span class="ident" id="3239565">Unlock</span><span class="op" id="3239571">(</span><span class="op" id="3239572">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239576">g</span><span class="op" id="3239577">.</span><span class="ident" id="3239578">doCall</span><span class="op" id="3239584">(</span><span class="ident" id="3239585">c</span><span class="op" id="3239586">,</span>&nbsp;<span class="ident" id="3239588">key</span><span class="op" id="3239591">,</span>&nbsp;<span class="ident" id="3239593">fn</span><span class="op" id="3239595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239598">return</span>&nbsp;<span class="ident" id="3239605">c</span><span class="op" id="3239606">.</span><span class="ident" id="3239607">val</span><span class="op" id="3239610">,</span>&nbsp;<span class="ident" id="3239612">c</span><span class="op" id="3239613">.</span><span class="ident" id="3239614">err</span><span class="op" id="3239617">,</span>&nbsp;<span class="ident" id="3239619">c</span><span class="op" id="3239620">.</span><span class="ident" id="3239621">dups</span>&nbsp;<span class="op" id="3239626">&gt;</span>&nbsp;<span class="num" id="3239628">0</span><br>
<span class="lineno"></span><span class="op" id="3239630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3239633">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3239698">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3239730">func</span>&nbsp;<span class="op" id="3239735">(</span><span class="ident" id="3239736">g</span>&nbsp;<span class="op" id="3239738">*</span><span class="ident" id="3239739">singleflight</span><span class="op" id="3239751">)</span>&nbsp;<span class="ident" id="3239753">DoChan</span><span class="op" id="3239759">(</span><span class="ident" id="3239760">key</span>&nbsp;<span class="builtintype" id="3239764">string</span><span class="op" id="3239770">,</span>&nbsp;<span class="ident" id="3239772">fn</span>&nbsp;<span class="keyword" id="3239775">func</span><span class="op" id="3239779">(</span><span class="op" id="3239780">)</span>&nbsp;<span class="op" id="3239782">(</span><span class="keyword" id="3239783">interface</span><span class="op" id="3239792">{</span><span class="op" id="3239793">}</span><span class="op" id="3239794">,</span>&nbsp;<span class="builtintype" id="3239796">error</span><span class="op" id="3239801">)</span><span class="op" id="3239802">)</span>&nbsp;<span class="op" id="3239804">&lt;-</span><span class="keyword" id="3239806">chan</span>&nbsp;<span class="ident" id="3239811">singleflightResult</span>&nbsp;<span class="op" id="3239830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239833">ch</span>&nbsp;<span class="op" id="3239836">:=</span>&nbsp;<span class="builtinfunc" id="3239839">make</span><span class="op" id="3239843">(</span><span class="keyword" id="3239844">chan</span>&nbsp;<span class="ident" id="3239849">singleflightResult</span><span class="op" id="3239867">,</span>&nbsp;<span class="num" id="3239869">1</span><span class="op" id="3239870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239873">g</span><span class="op" id="3239874">.</span><span class="ident" id="3239875">mu</span><span class="op" id="3239877">.</span><span class="ident" id="3239878">Lock</span><span class="op" id="3239882">(</span><span class="op" id="3239883">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239886">if</span>&nbsp;<span class="ident" id="3239889">g</span><span class="op" id="3239890">.</span><span class="ident" id="3239891">m</span>&nbsp;<span class="op" id="3239893">==</span>&nbsp;<span class="ident" id="3239896">nil</span>&nbsp;<span class="op" id="3239900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239904">g</span><span class="op" id="3239905">.</span><span class="ident" id="3239906">m</span>&nbsp;<span class="op" id="3239908">=</span>&nbsp;<span class="builtinfunc" id="3239910">make</span><span class="op" id="3239914">(</span><span class="keyword" id="3239915">map</span><span class="op" id="3239918">[</span><span class="builtintype" id="3239919">string</span><span class="op" id="3239925">]</span><span class="op" id="3239926">*</span><span class="ident" id="3239927">call</span><span class="op" id="3239931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239937">if</span>&nbsp;<span class="ident" id="3239940">c</span><span class="op" id="3239941">,</span>&nbsp;<span class="ident" id="3239943">ok</span>&nbsp;<span class="op" id="3239946">:=</span>&nbsp;<span class="ident" id="3239949">g</span><span class="op" id="3239950">.</span><span class="ident" id="3239951">m</span><span class="op" id="3239952">[</span><span class="ident" id="3239953">key</span><span class="op" id="3239956">]</span><span class="op" id="3239957">;</span>&nbsp;<span class="ident" id="3239959">ok</span>&nbsp;<span class="op" id="3239962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239966">c</span><span class="op" id="3239967">.</span><span class="ident" id="3239968">dups</span><span class="op" id="3239972">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239977">c</span><span class="op" id="3239978">.</span><span class="ident" id="3239979">chans</span>&nbsp;<span class="op" id="3239985">=</span>&nbsp;<span class="builtinfunc" id="3239987">append</span><span class="op" id="3239993">(</span><span class="ident" id="3239994">c</span><span class="op" id="3239995">.</span><span class="ident" id="3239996">chans</span><span class="op" id="3240001">,</span>&nbsp;<span class="ident" id="3240003">ch</span><span class="op" id="3240005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240009">g</span><span class="op" id="3240010">.</span><span class="ident" id="3240011">mu</span><span class="op" id="3240013">.</span><span class="ident" id="3240014">Unlock</span><span class="op" id="3240020">(</span><span class="op" id="3240021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240025">return</span>&nbsp;<span class="ident" id="3240032">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240039">c</span>&nbsp;<span class="op" id="3240041">:=</span>&nbsp;<span class="op" id="3240044">&amp;</span><span class="ident" id="3240045">call</span><span class="op" id="3240049">{</span><span class="ident" id="3240050">chans</span><span class="op" id="3240055">:</span>&nbsp;<span class="op" id="3240057">[</span><span class="op" id="3240058">]</span><span class="keyword" id="3240059">chan</span><span class="op" id="3240063">&lt;-</span>&nbsp;<span class="ident" id="3240066">singleflightResult</span><span class="op" id="3240084">{</span><span class="ident" id="3240085">ch</span><span class="op" id="3240087">}</span><span class="op" id="3240088">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240091">c</span><span class="op" id="3240092">.</span><span class="ident" id="3240093">wg</span><span class="op" id="3240095">.</span><span class="ident" id="3240096">Add</span><span class="op" id="3240099">(</span><span class="num" id="3240100">1</span><span class="op" id="3240101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240104">g</span><span class="op" id="3240105">.</span><span class="ident" id="3240106">m</span><span class="op" id="3240107">[</span><span class="ident" id="3240108">key</span><span class="op" id="3240111">]</span>&nbsp;<span class="op" id="3240113">=</span>&nbsp;<span class="ident" id="3240115">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240118">g</span><span class="op" id="3240119">.</span><span class="ident" id="3240120">mu</span><span class="op" id="3240122">.</span><span class="ident" id="3240123">Unlock</span><span class="op" id="3240129">(</span><span class="op" id="3240130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240134">go</span>&nbsp;<span class="ident" id="3240137">g</span><span class="op" id="3240138">.</span><span class="ident" id="3240139">doCall</span><span class="op" id="3240145">(</span><span class="ident" id="3240146">c</span><span class="op" id="3240147">,</span>&nbsp;<span class="ident" id="3240149">key</span><span class="op" id="3240152">,</span>&nbsp;<span class="ident" id="3240154">fn</span><span class="op" id="3240156">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240160">return</span>&nbsp;<span class="ident" id="3240167">ch</span><br>
<span class="lineno"></span><span class="op" id="3240170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3240173">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3240218">func</span>&nbsp;<span class="op" id="3240223">(</span><span class="ident" id="3240224">g</span>&nbsp;<span class="op" id="3240226">*</span><span class="ident" id="3240227">singleflight</span><span class="op" id="3240239">)</span>&nbsp;<span class="ident" id="3240241">doCall</span><span class="op" id="3240247">(</span><span class="ident" id="3240248">c</span>&nbsp;<span class="op" id="3240250">*</span><span class="ident" id="3240251">call</span><span class="op" id="3240255">,</span>&nbsp;<span class="ident" id="3240257">key</span>&nbsp;<span class="builtintype" id="3240261">string</span><span class="op" id="3240267">,</span>&nbsp;<span class="ident" id="3240269">fn</span>&nbsp;<span class="keyword" id="3240272">func</span><span class="op" id="3240276">(</span><span class="op" id="3240277">)</span>&nbsp;<span class="op" id="3240279">(</span><span class="keyword" id="3240280">interface</span><span class="op" id="3240289">{</span><span class="op" id="3240290">}</span><span class="op" id="3240291">,</span>&nbsp;<span class="builtintype" id="3240293">error</span><span class="op" id="3240298">)</span><span class="op" id="3240299">)</span>&nbsp;<span class="op" id="3240301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240304">c</span><span class="op" id="3240305">.</span><span class="ident" id="3240306">val</span><span class="op" id="3240309">,</span>&nbsp;<span class="ident" id="3240311">c</span><span class="op" id="3240312">.</span><span class="ident" id="3240313">err</span>&nbsp;<span class="op" id="3240317">=</span>&nbsp;<span class="ident" id="3240319">fn</span><span class="op" id="3240321">(</span><span class="op" id="3240322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240325">c</span><span class="op" id="3240326">.</span><span class="ident" id="3240327">wg</span><span class="op" id="3240329">.</span><span class="ident" id="3240330">Done</span><span class="op" id="3240334">(</span><span class="op" id="3240335">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240339">g</span><span class="op" id="3240340">.</span><span class="ident" id="3240341">mu</span><span class="op" id="3240343">.</span><span class="ident" id="3240344">Lock</span><span class="op" id="3240348">(</span><span class="op" id="3240349">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3240352">delete</span><span class="op" id="3240358">(</span><span class="ident" id="3240359">g</span><span class="op" id="3240360">.</span><span class="ident" id="3240361">m</span><span class="op" id="3240362">,</span>&nbsp;<span class="ident" id="3240364">key</span><span class="op" id="3240367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240370">for</span>&nbsp;<span class="ident" id="3240374">_</span><span class="op" id="3240375">,</span>&nbsp;<span class="ident" id="3240377">ch</span>&nbsp;<span class="op" id="3240380">:=</span>&nbsp;<span class="keyword" id="3240383">range</span>&nbsp;<span class="ident" id="3240389">c</span><span class="op" id="3240390">.</span><span class="ident" id="3240391">chans</span>&nbsp;<span class="op" id="3240397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240401">ch</span>&nbsp;<span class="op" id="3240404">&lt;-</span>&nbsp;<span class="ident" id="3240407">singleflightResult</span><span class="op" id="3240425">{</span><span class="ident" id="3240426">c</span><span class="op" id="3240427">.</span><span class="ident" id="3240428">val</span><span class="op" id="3240431">,</span>&nbsp;<span class="ident" id="3240433">c</span><span class="op" id="3240434">.</span><span class="ident" id="3240435">err</span><span class="op" id="3240438">,</span>&nbsp;<span class="ident" id="3240440">c</span><span class="op" id="3240441">.</span><span class="ident" id="3240442">dups</span>&nbsp;<span class="op" id="3240447">&gt;</span>&nbsp;<span class="num" id="3240449">0</span><span class="op" id="3240450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240456">g</span><span class="op" id="3240457">.</span><span class="ident" id="3240458">mu</span><span class="op" id="3240460">.</span><span class="ident" id="3240461">Unlock</span><span class="op" id="3240467">(</span><span class="op" id="3240468">)</span><br>
<span class="lineno">100</span><span class="op" id="3240470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3240473">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3240543">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3240612">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3240644">func</span>&nbsp;<span class="op" id="3240649">(</span><span class="ident" id="3240650">g</span>&nbsp;<span class="op" id="3240652">*</span><span class="ident" id="3240653">singleflight</span><span class="op" id="3240665">)</span>&nbsp;<span class="ident" id="3240667">Forget</span><span class="op" id="3240673">(</span><span class="ident" id="3240674">key</span>&nbsp;<span class="builtintype" id="3240678">string</span><span class="op" id="3240684">)</span>&nbsp;<span class="op" id="3240686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240689">g</span><span class="op" id="3240690">.</span><span class="ident" id="3240691">mu</span><span class="op" id="3240693">.</span><span class="ident" id="3240694">Lock</span><span class="op" id="3240698">(</span><span class="op" id="3240699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3240702">delete</span><span class="op" id="3240708">(</span><span class="ident" id="3240709">g</span><span class="op" id="3240710">.</span><span class="ident" id="3240711">m</span><span class="op" id="3240712">,</span>&nbsp;<span class="ident" id="3240714">key</span><span class="op" id="3240717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240720">g</span><span class="op" id="3240721">.</span><span class="ident" id="3240722">mu</span><span class="op" id="3240724">.</span><span class="ident" id="3240725">Unlock</span><span class="op" id="3240731">(</span><span class="op" id="3240732">)</span><br>
<span class="lineno"></span><span class="op" id="3240734">}</span>
</div>
</body>
</html>
