<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6255814">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6255869">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6255923">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6255974">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="6256052">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6256128">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6256159">//</span><br>
<span class="lineno"></span><span class="comment" id="6256162">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="6256228">//</span><br>
<span class="lineno"></span><span class="comment" id="6256231">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6256301">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="6256325">//</span><br>
<span class="lineno"></span><span class="comment" id="6256328">//&nbsp;&nbsp;&nbsp;&nbspcmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="6256349">//&nbsp;&nbsp;&nbsp;&nbspmemstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="6256379">//</span><br>
<span class="lineno"></span><span class="comment" id="6256382">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6256447">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6256515">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="6256565">//&nbsp;&nbsp;&nbsp;&nbspimport&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6256586">//</span><br>
<span class="lineno"></span><span class="keyword" id="6256589">package</span>&nbsp;<span class="ident" id="6256597">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6256605">import</span>&nbsp;<span class="op" id="6256612">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256615">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256624">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256641">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256648">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256655">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256667">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256673">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256684">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256692">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6256703">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="6256710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6256713">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6256768">type</span>&nbsp;<span class="ident" id="6256773">Var</span>&nbsp;<span class="keyword" id="6256777">interface</span>&nbsp;<span class="op" id="6256787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256790">String</span><span class="op" id="6256796">(</span><span class="op" id="6256797">)</span>&nbsp;<span class="builtintype" id="6256799">string</span><br>
<span class="lineno">40</span><span class="op" id="6256806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6256809">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6256879">type</span>&nbsp;<span class="ident" id="6256884">Int</span>&nbsp;<span class="keyword" id="6256888">struct</span>&nbsp;<span class="op" id="6256895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256898">mu</span>&nbsp;<span class="ident" id="6256901">sync</span><span class="op" id="6256905">.</span><span class="ident" id="6256906">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256915">i</span>&nbsp;&nbsp;<span class="ident" id="6256918">int64</span><br>
<span class="lineno"></span><span class="op" id="6256924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6256927">func</span>&nbsp;<span class="op" id="6256932">(</span><span class="ident" id="6256933">v</span>&nbsp;<span class="op" id="6256935">*</span><span class="ident" id="6256936">Int</span><span class="op" id="6256939">)</span>&nbsp;<span class="ident" id="6256941">String</span><span class="op" id="6256947">(</span><span class="op" id="6256948">)</span>&nbsp;<span class="builtintype" id="6256950">string</span>&nbsp;<span class="op" id="6256957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6256960">v</span><span class="op" id="6256961">.</span><span class="ident" id="6256962">mu</span><span class="op" id="6256964">.</span><span class="ident" id="6256965">RLock</span><span class="op" id="6256970">(</span><span class="op" id="6256971">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256974">defer</span>&nbsp;<span class="ident" id="6256980">v</span><span class="op" id="6256981">.</span><span class="ident" id="6256982">mu</span><span class="op" id="6256984">.</span><span class="ident" id="6256985">RUnlock</span><span class="op" id="6256992">(</span><span class="op" id="6256993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6256996">return</span>&nbsp;<span class="ident" id="6257003">strconv</span><span class="op" id="6257010">.</span><span class="ident" id="6257011">FormatInt</span><span class="op" id="6257020">(</span><span class="ident" id="6257021">v</span><span class="op" id="6257022">.</span><span class="ident" id="6257023">i</span><span class="op" id="6257024">,</span>&nbsp;<span class="num" id="6257026">10</span><span class="op" id="6257028">)</span><br>
<span class="lineno"></span><span class="op" id="6257030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6257033">func</span>&nbsp;<span class="op" id="6257038">(</span><span class="ident" id="6257039">v</span>&nbsp;<span class="op" id="6257041">*</span><span class="ident" id="6257042">Int</span><span class="op" id="6257045">)</span>&nbsp;<span class="ident" id="6257047">Add</span><span class="op" id="6257050">(</span><span class="ident" id="6257051">delta</span>&nbsp;<span class="ident" id="6257057">int64</span><span class="op" id="6257062">)</span>&nbsp;<span class="op" id="6257064">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257067">v</span><span class="op" id="6257068">.</span><span class="ident" id="6257069">mu</span><span class="op" id="6257071">.</span><span class="ident" id="6257072">Lock</span><span class="op" id="6257076">(</span><span class="op" id="6257077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257080">defer</span>&nbsp;<span class="ident" id="6257086">v</span><span class="op" id="6257087">.</span><span class="ident" id="6257088">mu</span><span class="op" id="6257090">.</span><span class="ident" id="6257091">Unlock</span><span class="op" id="6257097">(</span><span class="op" id="6257098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257101">v</span><span class="op" id="6257102">.</span><span class="ident" id="6257103">i</span>&nbsp;<span class="op" id="6257105">+=</span>&nbsp;<span class="ident" id="6257108">delta</span><br>
<span class="lineno"></span><span class="op" id="6257114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="6257117">func</span>&nbsp;<span class="op" id="6257122">(</span><span class="ident" id="6257123">v</span>&nbsp;<span class="op" id="6257125">*</span><span class="ident" id="6257126">Int</span><span class="op" id="6257129">)</span>&nbsp;<span class="ident" id="6257131">Set</span><span class="op" id="6257134">(</span><span class="ident" id="6257135">value</span>&nbsp;<span class="ident" id="6257141">int64</span><span class="op" id="6257146">)</span>&nbsp;<span class="op" id="6257148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257151">v</span><span class="op" id="6257152">.</span><span class="ident" id="6257153">mu</span><span class="op" id="6257155">.</span><span class="ident" id="6257156">Lock</span><span class="op" id="6257160">(</span><span class="op" id="6257161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257164">defer</span>&nbsp;<span class="ident" id="6257170">v</span><span class="op" id="6257171">.</span><span class="ident" id="6257172">mu</span><span class="op" id="6257174">.</span><span class="ident" id="6257175">Unlock</span><span class="op" id="6257181">(</span><span class="op" id="6257182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257185">v</span><span class="op" id="6257186">.</span><span class="ident" id="6257187">i</span>&nbsp;<span class="op" id="6257189">=</span>&nbsp;<span class="ident" id="6257191">value</span><br>
<span class="lineno"></span><span class="op" id="6257197">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="6257200">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6257270">type</span>&nbsp;<span class="ident" id="6257275">Float</span>&nbsp;<span class="keyword" id="6257281">struct</span>&nbsp;<span class="op" id="6257288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257291">mu</span>&nbsp;<span class="ident" id="6257294">sync</span><span class="op" id="6257298">.</span><span class="ident" id="6257299">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257308">f</span>&nbsp;&nbsp;<span class="builtintype" id="6257311">float64</span><br>
<span class="lineno">70</span><span class="op" id="6257319">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6257322">func</span>&nbsp;<span class="op" id="6257327">(</span><span class="ident" id="6257328">v</span>&nbsp;<span class="op" id="6257330">*</span><span class="ident" id="6257331">Float</span><span class="op" id="6257336">)</span>&nbsp;<span class="ident" id="6257338">String</span><span class="op" id="6257344">(</span><span class="op" id="6257345">)</span>&nbsp;<span class="builtintype" id="6257347">string</span>&nbsp;<span class="op" id="6257354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257357">v</span><span class="op" id="6257358">.</span><span class="ident" id="6257359">mu</span><span class="op" id="6257361">.</span><span class="ident" id="6257362">RLock</span><span class="op" id="6257367">(</span><span class="op" id="6257368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257371">defer</span>&nbsp;<span class="ident" id="6257377">v</span><span class="op" id="6257378">.</span><span class="ident" id="6257379">mu</span><span class="op" id="6257381">.</span><span class="ident" id="6257382">RUnlock</span><span class="op" id="6257389">(</span><span class="op" id="6257390">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257393">return</span>&nbsp;<span class="ident" id="6257400">strconv</span><span class="op" id="6257407">.</span><span class="ident" id="6257408">FormatFloat</span><span class="op" id="6257419">(</span><span class="ident" id="6257420">v</span><span class="op" id="6257421">.</span><span class="ident" id="6257422">f</span><span class="op" id="6257423">,</span>&nbsp;<span class="string" id="6257425">&#39;g&#39;</span><span class="op" id="6257428">,</span>&nbsp;<span class="op" id="6257430">-</span><span class="num" id="6257431">1</span><span class="op" id="6257432">,</span>&nbsp;<span class="num" id="6257434">64</span><span class="op" id="6257436">)</span><br>
<span class="lineno"></span><span class="op" id="6257438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6257441">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="6257465">func</span>&nbsp;<span class="op" id="6257470">(</span><span class="ident" id="6257471">v</span>&nbsp;<span class="op" id="6257473">*</span><span class="ident" id="6257474">Float</span><span class="op" id="6257479">)</span>&nbsp;<span class="ident" id="6257481">Add</span><span class="op" id="6257484">(</span><span class="ident" id="6257485">delta</span>&nbsp;<span class="builtintype" id="6257491">float64</span><span class="op" id="6257498">)</span>&nbsp;<span class="op" id="6257500">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257503">v</span><span class="op" id="6257504">.</span><span class="ident" id="6257505">mu</span><span class="op" id="6257507">.</span><span class="ident" id="6257508">Lock</span><span class="op" id="6257512">(</span><span class="op" id="6257513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257516">defer</span>&nbsp;<span class="ident" id="6257522">v</span><span class="op" id="6257523">.</span><span class="ident" id="6257524">mu</span><span class="op" id="6257526">.</span><span class="ident" id="6257527">Unlock</span><span class="op" id="6257533">(</span><span class="op" id="6257534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257537">v</span><span class="op" id="6257538">.</span><span class="ident" id="6257539">f</span>&nbsp;<span class="op" id="6257541">+=</span>&nbsp;<span class="ident" id="6257544">delta</span><br>
<span class="lineno"></span><span class="op" id="6257550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="6257553">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="6257577">func</span>&nbsp;<span class="op" id="6257582">(</span><span class="ident" id="6257583">v</span>&nbsp;<span class="op" id="6257585">*</span><span class="ident" id="6257586">Float</span><span class="op" id="6257591">)</span>&nbsp;<span class="ident" id="6257593">Set</span><span class="op" id="6257596">(</span><span class="ident" id="6257597">value</span>&nbsp;<span class="builtintype" id="6257603">float64</span><span class="op" id="6257610">)</span>&nbsp;<span class="op" id="6257612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257615">v</span><span class="op" id="6257616">.</span><span class="ident" id="6257617">mu</span><span class="op" id="6257619">.</span><span class="ident" id="6257620">Lock</span><span class="op" id="6257624">(</span><span class="op" id="6257625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257628">defer</span>&nbsp;<span class="ident" id="6257634">v</span><span class="op" id="6257635">.</span><span class="ident" id="6257636">mu</span><span class="op" id="6257638">.</span><span class="ident" id="6257639">Unlock</span><span class="op" id="6257645">(</span><span class="op" id="6257646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257649">v</span><span class="op" id="6257650">.</span><span class="ident" id="6257651">f</span>&nbsp;<span class="op" id="6257653">=</span>&nbsp;<span class="ident" id="6257655">value</span><br>
<span class="lineno">90</span><span class="op" id="6257661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6257664">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6257737">type</span>&nbsp;<span class="ident" id="6257742">Map</span>&nbsp;<span class="keyword" id="6257746">struct</span>&nbsp;<span class="op" id="6257753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257756">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6257761">sync</span><span class="op" id="6257765">.</span><span class="ident" id="6257766">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257775">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6257780">map</span><span class="op" id="6257783">[</span><span class="builtintype" id="6257784">string</span><span class="op" id="6257790">]</span><span class="ident" id="6257791">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257796">keys</span>&nbsp;<span class="op" id="6257801">[</span><span class="op" id="6257802">]</span><span class="builtintype" id="6257803">string</span>&nbsp;<span class="comment" id="6257810">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6257820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6257823">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="6257871">type</span>&nbsp;<span class="ident" id="6257876">KeyValue</span>&nbsp;<span class="keyword" id="6257885">struct</span>&nbsp;<span class="op" id="6257892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257895">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6257901">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257909">Value</span>&nbsp;<span class="ident" id="6257915">Var</span><br>
<span class="lineno"></span><span class="op" id="6257919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6257922">func</span>&nbsp;<span class="op" id="6257927">(</span><span class="ident" id="6257928">v</span>&nbsp;<span class="op" id="6257930">*</span><span class="ident" id="6257931">Map</span><span class="op" id="6257934">)</span>&nbsp;<span class="ident" id="6257936">String</span><span class="op" id="6257942">(</span><span class="op" id="6257943">)</span>&nbsp;<span class="builtintype" id="6257945">string</span>&nbsp;<span class="op" id="6257952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6257955">v</span><span class="op" id="6257956">.</span><span class="ident" id="6257957">mu</span><span class="op" id="6257959">.</span><span class="ident" id="6257960">RLock</span><span class="op" id="6257965">(</span><span class="op" id="6257966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257969">defer</span>&nbsp;<span class="ident" id="6257975">v</span><span class="op" id="6257976">.</span><span class="ident" id="6257977">mu</span><span class="op" id="6257979">.</span><span class="ident" id="6257980">RUnlock</span><span class="op" id="6257987">(</span><span class="op" id="6257988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6257991">var</span>&nbsp;<span class="ident" id="6257995">b</span>&nbsp;<span class="ident" id="6257997">bytes</span><span class="op" id="6258002">.</span><span class="ident" id="6258003">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258011">fmt</span><span class="op" id="6258014">.</span><span class="ident" id="6258015">Fprintf</span><span class="op" id="6258022">(</span><span class="op" id="6258023">&amp;</span><span class="ident" id="6258024">b</span><span class="op" id="6258025">,</span>&nbsp;<span class="string" id="6258027">&#34;{&#34;</span><span class="op" id="6258030">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258033">first</span>&nbsp;<span class="op" id="6258039">:=</span>&nbsp;<span class="builtintype" id="6258042">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258048">v</span><span class="op" id="6258049">.</span><span class="ident" id="6258050">doLocked</span><span class="op" id="6258058">(</span><span class="keyword" id="6258059">func</span><span class="op" id="6258063">(</span><span class="ident" id="6258064">kv</span>&nbsp;<span class="ident" id="6258067">KeyValue</span><span class="op" id="6258075">)</span>&nbsp;<span class="op" id="6258077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258081">if</span>&nbsp;<span class="op" id="6258084">!</span><span class="ident" id="6258085">first</span>&nbsp;<span class="op" id="6258091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258096">fmt</span><span class="op" id="6258099">.</span><span class="ident" id="6258100">Fprintf</span><span class="op" id="6258107">(</span><span class="op" id="6258108">&amp;</span><span class="ident" id="6258109">b</span><span class="op" id="6258110">,</span>&nbsp;<span class="string" id="6258112">&#34;,&nbsp;&#34;</span><span class="op" id="6258116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258120">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258124">fmt</span><span class="op" id="6258127">.</span><span class="ident" id="6258128">Fprintf</span><span class="op" id="6258135">(</span><span class="op" id="6258136">&amp;</span><span class="ident" id="6258137">b</span><span class="op" id="6258138">,</span>&nbsp;<span class="string" id="6258140">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="6258148">,</span>&nbsp;<span class="ident" id="6258150">kv</span><span class="op" id="6258152">.</span><span class="ident" id="6258153">Key</span><span class="op" id="6258156">,</span>&nbsp;<span class="ident" id="6258158">kv</span><span class="op" id="6258160">.</span><span class="ident" id="6258161">Value</span><span class="op" id="6258166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258170">first</span>&nbsp;<span class="op" id="6258176">=</span>&nbsp;<span class="builtintype" id="6258178">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258185">}</span><span class="op" id="6258186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258189">fmt</span><span class="op" id="6258192">.</span><span class="ident" id="6258193">Fprintf</span><span class="op" id="6258200">(</span><span class="op" id="6258201">&amp;</span><span class="ident" id="6258202">b</span><span class="op" id="6258203">,</span>&nbsp;<span class="string" id="6258205">&#34;}&#34;</span><span class="op" id="6258208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258211">return</span>&nbsp;<span class="ident" id="6258218">b</span><span class="op" id="6258219">.</span><span class="ident" id="6258220">String</span><span class="op" id="6258226">(</span><span class="op" id="6258227">)</span><br>
<span class="lineno">120</span><span class="op" id="6258229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258232">func</span>&nbsp;<span class="op" id="6258237">(</span><span class="ident" id="6258238">v</span>&nbsp;<span class="op" id="6258240">*</span><span class="ident" id="6258241">Map</span><span class="op" id="6258244">)</span>&nbsp;<span class="ident" id="6258246">Init</span><span class="op" id="6258250">(</span><span class="op" id="6258251">)</span>&nbsp;<span class="op" id="6258253">*</span><span class="ident" id="6258254">Map</span>&nbsp;<span class="op" id="6258258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258261">v</span><span class="op" id="6258262">.</span><span class="ident" id="6258263">m</span>&nbsp;<span class="op" id="6258265">=</span>&nbsp;<span class="builtinfunc" id="6258267">make</span><span class="op" id="6258271">(</span><span class="keyword" id="6258272">map</span><span class="op" id="6258275">[</span><span class="builtintype" id="6258276">string</span><span class="op" id="6258282">]</span><span class="ident" id="6258283">Var</span><span class="op" id="6258286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258289">return</span>&nbsp;<span class="ident" id="6258296">v</span><br>
<span class="lineno">125</span><span class="op" id="6258298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6258301">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="6258358">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6258392">func</span>&nbsp;<span class="op" id="6258397">(</span><span class="ident" id="6258398">v</span>&nbsp;<span class="op" id="6258400">*</span><span class="ident" id="6258401">Map</span><span class="op" id="6258404">)</span>&nbsp;<span class="ident" id="6258406">updateKeys</span><span class="op" id="6258416">(</span><span class="op" id="6258417">)</span>&nbsp;<span class="op" id="6258419">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258422">if</span>&nbsp;<span class="builtinfunc" id="6258425">len</span><span class="op" id="6258428">(</span><span class="ident" id="6258429">v</span><span class="op" id="6258430">.</span><span class="ident" id="6258431">m</span><span class="op" id="6258432">)</span>&nbsp;<span class="op" id="6258434">==</span>&nbsp;<span class="builtinfunc" id="6258437">len</span><span class="op" id="6258440">(</span><span class="ident" id="6258441">v</span><span class="op" id="6258442">.</span><span class="ident" id="6258443">keys</span><span class="op" id="6258447">)</span>&nbsp;<span class="op" id="6258449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258453">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258470">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258481">v</span><span class="op" id="6258482">.</span><span class="ident" id="6258483">keys</span>&nbsp;<span class="op" id="6258488">=</span>&nbsp;<span class="ident" id="6258490">v</span><span class="op" id="6258491">.</span><span class="ident" id="6258492">keys</span><span class="op" id="6258496">[</span><span class="op" id="6258497">:</span><span class="num" id="6258498">0</span><span class="op" id="6258499">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258502">for</span>&nbsp;<span class="ident" id="6258506">k</span>&nbsp;<span class="op" id="6258508">:=</span>&nbsp;<span class="keyword" id="6258511">range</span>&nbsp;<span class="ident" id="6258517">v</span><span class="op" id="6258518">.</span><span class="ident" id="6258519">m</span>&nbsp;<span class="op" id="6258521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258525">v</span><span class="op" id="6258526">.</span><span class="ident" id="6258527">keys</span>&nbsp;<span class="op" id="6258532">=</span>&nbsp;<span class="builtinfunc" id="6258534">append</span><span class="op" id="6258540">(</span><span class="ident" id="6258541">v</span><span class="op" id="6258542">.</span><span class="ident" id="6258543">keys</span><span class="op" id="6258547">,</span>&nbsp;<span class="ident" id="6258549">k</span><span class="op" id="6258550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6258553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258556">sort</span><span class="op" id="6258560">.</span><span class="ident" id="6258561">Strings</span><span class="op" id="6258568">(</span><span class="ident" id="6258569">v</span><span class="op" id="6258570">.</span><span class="ident" id="6258571">keys</span><span class="op" id="6258575">)</span><br>
<span class="lineno"></span><span class="op" id="6258577">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6258580">func</span>&nbsp;<span class="op" id="6258585">(</span><span class="ident" id="6258586">v</span>&nbsp;<span class="op" id="6258588">*</span><span class="ident" id="6258589">Map</span><span class="op" id="6258592">)</span>&nbsp;<span class="ident" id="6258594">Get</span><span class="op" id="6258597">(</span><span class="ident" id="6258598">key</span>&nbsp;<span class="builtintype" id="6258602">string</span><span class="op" id="6258608">)</span>&nbsp;<span class="ident" id="6258610">Var</span>&nbsp;<span class="op" id="6258614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258617">v</span><span class="op" id="6258618">.</span><span class="ident" id="6258619">mu</span><span class="op" id="6258621">.</span><span class="ident" id="6258622">RLock</span><span class="op" id="6258627">(</span><span class="op" id="6258628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258631">defer</span>&nbsp;<span class="ident" id="6258637">v</span><span class="op" id="6258638">.</span><span class="ident" id="6258639">mu</span><span class="op" id="6258641">.</span><span class="ident" id="6258642">RUnlock</span><span class="op" id="6258649">(</span><span class="op" id="6258650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258653">return</span>&nbsp;<span class="ident" id="6258660">v</span><span class="op" id="6258661">.</span><span class="ident" id="6258662">m</span><span class="op" id="6258663">[</span><span class="ident" id="6258664">key</span><span class="op" id="6258667">]</span><br>
<span class="lineno">145</span><span class="op" id="6258669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258672">func</span>&nbsp;<span class="op" id="6258677">(</span><span class="ident" id="6258678">v</span>&nbsp;<span class="op" id="6258680">*</span><span class="ident" id="6258681">Map</span><span class="op" id="6258684">)</span>&nbsp;<span class="ident" id="6258686">Set</span><span class="op" id="6258689">(</span><span class="ident" id="6258690">key</span>&nbsp;<span class="builtintype" id="6258694">string</span><span class="op" id="6258700">,</span>&nbsp;<span class="ident" id="6258702">av</span>&nbsp;<span class="ident" id="6258705">Var</span><span class="op" id="6258708">)</span>&nbsp;<span class="op" id="6258710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258713">v</span><span class="op" id="6258714">.</span><span class="ident" id="6258715">mu</span><span class="op" id="6258717">.</span><span class="ident" id="6258718">Lock</span><span class="op" id="6258722">(</span><span class="op" id="6258723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258726">defer</span>&nbsp;<span class="ident" id="6258732">v</span><span class="op" id="6258733">.</span><span class="ident" id="6258734">mu</span><span class="op" id="6258736">.</span><span class="ident" id="6258737">Unlock</span><span class="op" id="6258743">(</span><span class="op" id="6258744">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258747">v</span><span class="op" id="6258748">.</span><span class="ident" id="6258749">m</span><span class="op" id="6258750">[</span><span class="ident" id="6258751">key</span><span class="op" id="6258754">]</span>&nbsp;<span class="op" id="6258756">=</span>&nbsp;<span class="ident" id="6258758">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258762">v</span><span class="op" id="6258763">.</span><span class="ident" id="6258764">updateKeys</span><span class="op" id="6258774">(</span><span class="op" id="6258775">)</span><br>
<span class="lineno"></span><span class="op" id="6258777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6258780">func</span>&nbsp;<span class="op" id="6258785">(</span><span class="ident" id="6258786">v</span>&nbsp;<span class="op" id="6258788">*</span><span class="ident" id="6258789">Map</span><span class="op" id="6258792">)</span>&nbsp;<span class="ident" id="6258794">Add</span><span class="op" id="6258797">(</span><span class="ident" id="6258798">key</span>&nbsp;<span class="builtintype" id="6258802">string</span><span class="op" id="6258808">,</span>&nbsp;<span class="ident" id="6258810">delta</span>&nbsp;<span class="ident" id="6258816">int64</span><span class="op" id="6258821">)</span>&nbsp;<span class="op" id="6258823">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258826">v</span><span class="op" id="6258827">.</span><span class="ident" id="6258828">mu</span><span class="op" id="6258830">.</span><span class="ident" id="6258831">RLock</span><span class="op" id="6258836">(</span><span class="op" id="6258837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258840">av</span><span class="op" id="6258842">,</span>&nbsp;<span class="ident" id="6258844">ok</span>&nbsp;<span class="op" id="6258847">:=</span>&nbsp;<span class="ident" id="6258850">v</span><span class="op" id="6258851">.</span><span class="ident" id="6258852">m</span><span class="op" id="6258853">[</span><span class="ident" id="6258854">key</span><span class="op" id="6258857">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258860">v</span><span class="op" id="6258861">.</span><span class="ident" id="6258862">mu</span><span class="op" id="6258864">.</span><span class="ident" id="6258865">RUnlock</span><span class="op" id="6258872">(</span><span class="op" id="6258873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258876">if</span>&nbsp;<span class="op" id="6258879">!</span><span class="ident" id="6258880">ok</span>&nbsp;<span class="op" id="6258883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6258887">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258925">v</span><span class="op" id="6258926">.</span><span class="ident" id="6258927">mu</span><span class="op" id="6258929">.</span><span class="ident" id="6258930">Lock</span><span class="op" id="6258934">(</span><span class="op" id="6258935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258939">av</span><span class="op" id="6258941">,</span>&nbsp;<span class="ident" id="6258943">ok</span>&nbsp;<span class="op" id="6258946">=</span>&nbsp;<span class="ident" id="6258948">v</span><span class="op" id="6258949">.</span><span class="ident" id="6258950">m</span><span class="op" id="6258951">[</span><span class="ident" id="6258952">key</span><span class="op" id="6258955">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6258959">if</span>&nbsp;<span class="op" id="6258962">!</span><span class="ident" id="6258963">ok</span>&nbsp;<span class="op" id="6258966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258971">av</span>&nbsp;<span class="op" id="6258974">=</span>&nbsp;<span class="builtinfunc" id="6258976">new</span><span class="op" id="6258979">(</span><span class="ident" id="6258980">Int</span><span class="op" id="6258983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6258988">v</span><span class="op" id="6258989">.</span><span class="ident" id="6258990">m</span><span class="op" id="6258991">[</span><span class="ident" id="6258992">key</span><span class="op" id="6258995">]</span>&nbsp;<span class="op" id="6258997">=</span>&nbsp;<span class="ident" id="6258999">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259005">v</span><span class="op" id="6259006">.</span><span class="ident" id="6259007">updateKeys</span><span class="op" id="6259017">(</span><span class="op" id="6259018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259026">v</span><span class="op" id="6259027">.</span><span class="ident" id="6259028">mu</span><span class="op" id="6259030">.</span><span class="ident" id="6259031">Unlock</span><span class="op" id="6259037">(</span><span class="op" id="6259038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259045">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259079">if</span>&nbsp;<span class="ident" id="6259082">iv</span><span class="op" id="6259084">,</span>&nbsp;<span class="ident" id="6259086">ok</span>&nbsp;<span class="op" id="6259089">:=</span>&nbsp;<span class="ident" id="6259092">av</span><span class="op" id="6259094">.</span><span class="op" id="6259095">(</span><span class="op" id="6259096">*</span><span class="ident" id="6259097">Int</span><span class="op" id="6259100">)</span><span class="op" id="6259101">;</span>&nbsp;<span class="ident" id="6259103">ok</span>&nbsp;<span class="op" id="6259106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259110">iv</span><span class="op" id="6259112">.</span><span class="ident" id="6259113">Add</span><span class="op" id="6259116">(</span><span class="ident" id="6259117">delta</span><span class="op" id="6259122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259125">}</span><br>
<span class="lineno"></span><span class="op" id="6259127">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="6259130">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="6259205">func</span>&nbsp;<span class="op" id="6259210">(</span><span class="ident" id="6259211">v</span>&nbsp;<span class="op" id="6259213">*</span><span class="ident" id="6259214">Map</span><span class="op" id="6259217">)</span>&nbsp;<span class="ident" id="6259219">AddFloat</span><span class="op" id="6259227">(</span><span class="ident" id="6259228">key</span>&nbsp;<span class="builtintype" id="6259232">string</span><span class="op" id="6259238">,</span>&nbsp;<span class="ident" id="6259240">delta</span>&nbsp;<span class="builtintype" id="6259246">float64</span><span class="op" id="6259253">)</span>&nbsp;<span class="op" id="6259255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259258">v</span><span class="op" id="6259259">.</span><span class="ident" id="6259260">mu</span><span class="op" id="6259262">.</span><span class="ident" id="6259263">RLock</span><span class="op" id="6259268">(</span><span class="op" id="6259269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259272">av</span><span class="op" id="6259274">,</span>&nbsp;<span class="ident" id="6259276">ok</span>&nbsp;<span class="op" id="6259279">:=</span>&nbsp;<span class="ident" id="6259282">v</span><span class="op" id="6259283">.</span><span class="ident" id="6259284">m</span><span class="op" id="6259285">[</span><span class="ident" id="6259286">key</span><span class="op" id="6259289">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259292">v</span><span class="op" id="6259293">.</span><span class="ident" id="6259294">mu</span><span class="op" id="6259296">.</span><span class="ident" id="6259297">RUnlock</span><span class="op" id="6259304">(</span><span class="op" id="6259305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259308">if</span>&nbsp;<span class="op" id="6259311">!</span><span class="ident" id="6259312">ok</span>&nbsp;<span class="op" id="6259315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259319">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259357">v</span><span class="op" id="6259358">.</span><span class="ident" id="6259359">mu</span><span class="op" id="6259361">.</span><span class="ident" id="6259362">Lock</span><span class="op" id="6259366">(</span><span class="op" id="6259367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259371">av</span><span class="op" id="6259373">,</span>&nbsp;<span class="ident" id="6259375">ok</span>&nbsp;<span class="op" id="6259378">=</span>&nbsp;<span class="ident" id="6259380">v</span><span class="op" id="6259381">.</span><span class="ident" id="6259382">m</span><span class="op" id="6259383">[</span><span class="ident" id="6259384">key</span><span class="op" id="6259387">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259391">if</span>&nbsp;<span class="op" id="6259394">!</span><span class="ident" id="6259395">ok</span>&nbsp;<span class="op" id="6259398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259403">av</span>&nbsp;<span class="op" id="6259406">=</span>&nbsp;<span class="builtinfunc" id="6259408">new</span><span class="op" id="6259411">(</span><span class="ident" id="6259412">Float</span><span class="op" id="6259417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259422">v</span><span class="op" id="6259423">.</span><span class="ident" id="6259424">m</span><span class="op" id="6259425">[</span><span class="ident" id="6259426">key</span><span class="op" id="6259429">]</span>&nbsp;<span class="op" id="6259431">=</span>&nbsp;<span class="ident" id="6259433">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259439">v</span><span class="op" id="6259440">.</span><span class="ident" id="6259441">updateKeys</span><span class="op" id="6259451">(</span><span class="op" id="6259452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259456">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259460">v</span><span class="op" id="6259461">.</span><span class="ident" id="6259462">mu</span><span class="op" id="6259464">.</span><span class="ident" id="6259465">Unlock</span><span class="op" id="6259471">(</span><span class="op" id="6259472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6259479">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259515">if</span>&nbsp;<span class="ident" id="6259518">iv</span><span class="op" id="6259520">,</span>&nbsp;<span class="ident" id="6259522">ok</span>&nbsp;<span class="op" id="6259525">:=</span>&nbsp;<span class="ident" id="6259528">av</span><span class="op" id="6259530">.</span><span class="op" id="6259531">(</span><span class="op" id="6259532">*</span><span class="ident" id="6259533">Float</span><span class="op" id="6259538">)</span><span class="op" id="6259539">;</span>&nbsp;<span class="ident" id="6259541">ok</span>&nbsp;<span class="op" id="6259544">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259548">iv</span><span class="op" id="6259550">.</span><span class="ident" id="6259551">Add</span><span class="op" id="6259554">(</span><span class="ident" id="6259555">delta</span><span class="op" id="6259560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259563">}</span><br>
<span class="lineno"></span><span class="op" id="6259565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6259568">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="6259609">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6259652">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="6259705">func</span>&nbsp;<span class="op" id="6259710">(</span><span class="ident" id="6259711">v</span>&nbsp;<span class="op" id="6259713">*</span><span class="ident" id="6259714">Map</span><span class="op" id="6259717">)</span>&nbsp;<span class="ident" id="6259719">Do</span><span class="op" id="6259721">(</span><span class="ident" id="6259722">f</span>&nbsp;<span class="keyword" id="6259724">func</span><span class="op" id="6259728">(</span><span class="ident" id="6259729">KeyValue</span><span class="op" id="6259737">)</span><span class="op" id="6259738">)</span>&nbsp;<span class="op" id="6259740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259743">v</span><span class="op" id="6259744">.</span><span class="ident" id="6259745">mu</span><span class="op" id="6259747">.</span><span class="ident" id="6259748">RLock</span><span class="op" id="6259753">(</span><span class="op" id="6259754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259757">defer</span>&nbsp;<span class="ident" id="6259763">v</span><span class="op" id="6259764">.</span><span class="ident" id="6259765">mu</span><span class="op" id="6259767">.</span><span class="ident" id="6259768">RUnlock</span><span class="op" id="6259775">(</span><span class="op" id="6259776">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259779">v</span><span class="op" id="6259780">.</span><span class="ident" id="6259781">doLocked</span><span class="op" id="6259789">(</span><span class="ident" id="6259790">f</span><span class="op" id="6259791">)</span><br>
<span class="lineno"></span><span class="op" id="6259793">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6259796">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="6259843">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="6259875">func</span>&nbsp;<span class="op" id="6259880">(</span><span class="ident" id="6259881">v</span>&nbsp;<span class="op" id="6259883">*</span><span class="ident" id="6259884">Map</span><span class="op" id="6259887">)</span>&nbsp;<span class="ident" id="6259889">doLocked</span><span class="op" id="6259897">(</span><span class="ident" id="6259898">f</span>&nbsp;<span class="keyword" id="6259900">func</span><span class="op" id="6259904">(</span><span class="ident" id="6259905">KeyValue</span><span class="op" id="6259913">)</span><span class="op" id="6259914">)</span>&nbsp;<span class="op" id="6259916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6259919">for</span>&nbsp;<span class="ident" id="6259923">_</span><span class="op" id="6259924">,</span>&nbsp;<span class="ident" id="6259926">k</span>&nbsp;<span class="op" id="6259928">:=</span>&nbsp;<span class="keyword" id="6259931">range</span>&nbsp;<span class="ident" id="6259937">v</span><span class="op" id="6259938">.</span><span class="ident" id="6259939">keys</span>&nbsp;<span class="op" id="6259944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6259948">f</span><span class="op" id="6259949">(</span><span class="ident" id="6259950">KeyValue</span><span class="op" id="6259958">{</span><span class="ident" id="6259959">k</span><span class="op" id="6259960">,</span>&nbsp;<span class="ident" id="6259962">v</span><span class="op" id="6259963">.</span><span class="ident" id="6259964">m</span><span class="op" id="6259965">[</span><span class="ident" id="6259966">k</span><span class="op" id="6259967">]</span><span class="op" id="6259968">}</span><span class="op" id="6259969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6259972">}</span><br>
<span class="lineno"></span><span class="op" id="6259974">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="6259977">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6260042">type</span>&nbsp;<span class="ident" id="6260047">String</span>&nbsp;<span class="keyword" id="6260054">struct</span>&nbsp;<span class="op" id="6260061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260064">mu</span>&nbsp;<span class="ident" id="6260067">sync</span><span class="op" id="6260071">.</span><span class="ident" id="6260072">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260081">s</span>&nbsp;&nbsp;<span class="builtintype" id="6260084">string</span><br>
<span class="lineno">220</span><span class="op" id="6260091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260094">func</span>&nbsp;<span class="op" id="6260099">(</span><span class="ident" id="6260100">v</span>&nbsp;<span class="op" id="6260102">*</span><span class="ident" id="6260103">String</span><span class="op" id="6260109">)</span>&nbsp;<span class="ident" id="6260111">String</span><span class="op" id="6260117">(</span><span class="op" id="6260118">)</span>&nbsp;<span class="builtintype" id="6260120">string</span>&nbsp;<span class="op" id="6260127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260130">v</span><span class="op" id="6260131">.</span><span class="ident" id="6260132">mu</span><span class="op" id="6260134">.</span><span class="ident" id="6260135">RLock</span><span class="op" id="6260140">(</span><span class="op" id="6260141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260144">defer</span>&nbsp;<span class="ident" id="6260150">v</span><span class="op" id="6260151">.</span><span class="ident" id="6260152">mu</span><span class="op" id="6260154">.</span><span class="ident" id="6260155">RUnlock</span><span class="op" id="6260162">(</span><span class="op" id="6260163">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260166">return</span>&nbsp;<span class="ident" id="6260173">strconv</span><span class="op" id="6260180">.</span><span class="ident" id="6260181">Quote</span><span class="op" id="6260186">(</span><span class="ident" id="6260187">v</span><span class="op" id="6260188">.</span><span class="ident" id="6260189">s</span><span class="op" id="6260190">)</span><br>
<span class="lineno"></span><span class="op" id="6260192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260195">func</span>&nbsp;<span class="op" id="6260200">(</span><span class="ident" id="6260201">v</span>&nbsp;<span class="op" id="6260203">*</span><span class="ident" id="6260204">String</span><span class="op" id="6260210">)</span>&nbsp;<span class="ident" id="6260212">Set</span><span class="op" id="6260215">(</span><span class="ident" id="6260216">value</span>&nbsp;<span class="builtintype" id="6260222">string</span><span class="op" id="6260228">)</span>&nbsp;<span class="op" id="6260230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260233">v</span><span class="op" id="6260234">.</span><span class="ident" id="6260235">mu</span><span class="op" id="6260237">.</span><span class="ident" id="6260238">Lock</span><span class="op" id="6260242">(</span><span class="op" id="6260243">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260246">defer</span>&nbsp;<span class="ident" id="6260252">v</span><span class="op" id="6260253">.</span><span class="ident" id="6260254">mu</span><span class="op" id="6260256">.</span><span class="ident" id="6260257">Unlock</span><span class="op" id="6260263">(</span><span class="op" id="6260264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260267">v</span><span class="op" id="6260268">.</span><span class="ident" id="6260269">s</span>&nbsp;<span class="op" id="6260271">=</span>&nbsp;<span class="ident" id="6260273">value</span><br>
<span class="lineno"></span><span class="op" id="6260279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6260282">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="6260329">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="6260378">type</span>&nbsp;<span class="ident" id="6260383">Func</span>&nbsp;<span class="keyword" id="6260388">func</span><span class="op" id="6260392">(</span><span class="op" id="6260393">)</span>&nbsp;<span class="keyword" id="6260395">interface</span><span class="op" id="6260404">{</span><span class="op" id="6260405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6260408">func</span>&nbsp;<span class="op" id="6260413">(</span><span class="ident" id="6260414">f</span>&nbsp;<span class="ident" id="6260416">Func</span><span class="op" id="6260420">)</span>&nbsp;<span class="ident" id="6260422">String</span><span class="op" id="6260428">(</span><span class="op" id="6260429">)</span>&nbsp;<span class="builtintype" id="6260431">string</span>&nbsp;<span class="op" id="6260438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260441">v</span><span class="op" id="6260442">,</span>&nbsp;<span class="ident" id="6260444">_</span>&nbsp;<span class="op" id="6260446">:=</span>&nbsp;<span class="ident" id="6260449">json</span><span class="op" id="6260453">.</span><span class="ident" id="6260454">Marshal</span><span class="op" id="6260461">(</span><span class="ident" id="6260462">f</span><span class="op" id="6260463">(</span><span class="op" id="6260464">)</span><span class="op" id="6260465">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260468">return</span>&nbsp;<span class="builtintype" id="6260475">string</span><span class="op" id="6260481">(</span><span class="ident" id="6260482">v</span><span class="op" id="6260483">)</span><br>
<span class="lineno"></span><span class="op" id="6260485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6260488">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6260516">var</span>&nbsp;<span class="op" id="6260520">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260523">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6260531">sync</span><span class="op" id="6260535">.</span><span class="ident" id="6260536">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260545">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6260553">=</span>&nbsp;<span class="builtinfunc" id="6260555">make</span><span class="op" id="6260559">(</span><span class="keyword" id="6260560">map</span><span class="op" id="6260563">[</span><span class="builtintype" id="6260564">string</span><span class="op" id="6260570">]</span><span class="ident" id="6260571">Var</span><span class="op" id="6260574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260577">varKeys</span>&nbsp;<span class="op" id="6260585">[</span><span class="op" id="6260586">]</span><span class="builtintype" id="6260587">string</span>&nbsp;<span class="comment" id="6260594">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6260604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="6260607">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6260683">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="6260759">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="6260799">func</span>&nbsp;<span class="ident" id="6260804">Publish</span><span class="op" id="6260811">(</span><span class="ident" id="6260812">name</span>&nbsp;<span class="builtintype" id="6260817">string</span><span class="op" id="6260823">,</span>&nbsp;<span class="ident" id="6260825">v</span>&nbsp;<span class="ident" id="6260827">Var</span><span class="op" id="6260830">)</span>&nbsp;<span class="op" id="6260832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260835">mutex</span><span class="op" id="6260840">.</span><span class="ident" id="6260841">Lock</span><span class="op" id="6260845">(</span><span class="op" id="6260846">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260849">defer</span>&nbsp;<span class="ident" id="6260855">mutex</span><span class="op" id="6260860">.</span><span class="ident" id="6260861">Unlock</span><span class="op" id="6260867">(</span><span class="op" id="6260868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6260871">if</span>&nbsp;<span class="ident" id="6260874">_</span><span class="op" id="6260875">,</span>&nbsp;<span class="ident" id="6260877">existing</span>&nbsp;<span class="op" id="6260886">:=</span>&nbsp;<span class="ident" id="6260889">vars</span><span class="op" id="6260893">[</span><span class="ident" id="6260894">name</span><span class="op" id="6260898">]</span><span class="op" id="6260899">;</span>&nbsp;<span class="ident" id="6260901">existing</span>&nbsp;<span class="op" id="6260910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260914">log</span><span class="op" id="6260917">.</span><span class="ident" id="6260918">Panicln</span><span class="op" id="6260925">(</span><span class="string" id="6260926">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="6260955">,</span>&nbsp;<span class="ident" id="6260957">name</span><span class="op" id="6260961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6260964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260967">vars</span><span class="op" id="6260971">[</span><span class="ident" id="6260972">name</span><span class="op" id="6260976">]</span>&nbsp;<span class="op" id="6260978">=</span>&nbsp;<span class="ident" id="6260980">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6260983">varKeys</span>&nbsp;<span class="op" id="6260991">=</span>&nbsp;<span class="builtinfunc" id="6260993">append</span><span class="op" id="6260999">(</span><span class="ident" id="6261000">varKeys</span><span class="op" id="6261007">,</span>&nbsp;<span class="ident" id="6261009">name</span><span class="op" id="6261013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261016">sort</span><span class="op" id="6261020">.</span><span class="ident" id="6261021">Strings</span><span class="op" id="6261028">(</span><span class="ident" id="6261029">varKeys</span><span class="op" id="6261036">)</span><br>
<span class="lineno"></span><span class="op" id="6261038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6261041">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="6261085">func</span>&nbsp;<span class="ident" id="6261090">Get</span><span class="op" id="6261093">(</span><span class="ident" id="6261094">name</span>&nbsp;<span class="builtintype" id="6261099">string</span><span class="op" id="6261105">)</span>&nbsp;<span class="ident" id="6261107">Var</span>&nbsp;<span class="op" id="6261111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261114">mutex</span><span class="op" id="6261119">.</span><span class="ident" id="6261120">RLock</span><span class="op" id="6261125">(</span><span class="op" id="6261126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261129">defer</span>&nbsp;<span class="ident" id="6261135">mutex</span><span class="op" id="6261140">.</span><span class="ident" id="6261141">RUnlock</span><span class="op" id="6261148">(</span><span class="op" id="6261149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261152">return</span>&nbsp;<span class="ident" id="6261159">vars</span><span class="op" id="6261163">[</span><span class="ident" id="6261164">name</span><span class="op" id="6261168">]</span><br>
<span class="lineno"></span><span class="op" id="6261170">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="6261173">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6261236">func</span>&nbsp;<span class="ident" id="6261241">NewInt</span><span class="op" id="6261247">(</span><span class="ident" id="6261248">name</span>&nbsp;<span class="builtintype" id="6261253">string</span><span class="op" id="6261259">)</span>&nbsp;<span class="op" id="6261261">*</span><span class="ident" id="6261262">Int</span>&nbsp;<span class="op" id="6261266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261269">v</span>&nbsp;<span class="op" id="6261271">:=</span>&nbsp;<span class="builtinfunc" id="6261274">new</span><span class="op" id="6261277">(</span><span class="ident" id="6261278">Int</span><span class="op" id="6261281">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261284">Publish</span><span class="op" id="6261291">(</span><span class="ident" id="6261292">name</span><span class="op" id="6261296">,</span>&nbsp;<span class="ident" id="6261298">v</span><span class="op" id="6261299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261302">return</span>&nbsp;<span class="ident" id="6261309">v</span><br>
<span class="lineno"></span><span class="op" id="6261311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6261314">func</span>&nbsp;<span class="ident" id="6261319">NewFloat</span><span class="op" id="6261327">(</span><span class="ident" id="6261328">name</span>&nbsp;<span class="builtintype" id="6261333">string</span><span class="op" id="6261339">)</span>&nbsp;<span class="op" id="6261341">*</span><span class="ident" id="6261342">Float</span>&nbsp;<span class="op" id="6261348">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261351">v</span>&nbsp;<span class="op" id="6261353">:=</span>&nbsp;<span class="builtinfunc" id="6261356">new</span><span class="op" id="6261359">(</span><span class="ident" id="6261360">Float</span><span class="op" id="6261365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261368">Publish</span><span class="op" id="6261375">(</span><span class="ident" id="6261376">name</span><span class="op" id="6261380">,</span>&nbsp;<span class="ident" id="6261382">v</span><span class="op" id="6261383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261386">return</span>&nbsp;<span class="ident" id="6261393">v</span><br>
<span class="lineno"></span><span class="op" id="6261395">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6261398">func</span>&nbsp;<span class="ident" id="6261403">NewMap</span><span class="op" id="6261409">(</span><span class="ident" id="6261410">name</span>&nbsp;<span class="builtintype" id="6261415">string</span><span class="op" id="6261421">)</span>&nbsp;<span class="op" id="6261423">*</span><span class="ident" id="6261424">Map</span>&nbsp;<span class="op" id="6261428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261431">v</span>&nbsp;<span class="op" id="6261433">:=</span>&nbsp;<span class="builtinfunc" id="6261436">new</span><span class="op" id="6261439">(</span><span class="ident" id="6261440">Map</span><span class="op" id="6261443">)</span><span class="op" id="6261444">.</span><span class="ident" id="6261445">Init</span><span class="op" id="6261449">(</span><span class="op" id="6261450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261453">Publish</span><span class="op" id="6261460">(</span><span class="ident" id="6261461">name</span><span class="op" id="6261465">,</span>&nbsp;<span class="ident" id="6261467">v</span><span class="op" id="6261468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261471">return</span>&nbsp;<span class="ident" id="6261478">v</span><br>
<span class="lineno"></span><span class="op" id="6261480">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="6261483">func</span>&nbsp;<span class="ident" id="6261488">NewString</span><span class="op" id="6261497">(</span><span class="ident" id="6261498">name</span>&nbsp;<span class="builtintype" id="6261503">string</span><span class="op" id="6261509">)</span>&nbsp;<span class="op" id="6261511">*</span><span class="ident" id="6261512">String</span>&nbsp;<span class="op" id="6261519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261522">v</span>&nbsp;<span class="op" id="6261524">:=</span>&nbsp;<span class="builtinfunc" id="6261527">new</span><span class="op" id="6261530">(</span><span class="ident" id="6261531">String</span><span class="op" id="6261537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261540">Publish</span><span class="op" id="6261547">(</span><span class="ident" id="6261548">name</span><span class="op" id="6261552">,</span>&nbsp;<span class="ident" id="6261554">v</span><span class="op" id="6261555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261558">return</span>&nbsp;<span class="ident" id="6261565">v</span><br>
<span class="lineno">295</span><span class="op" id="6261567">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6261570">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="6261612">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6261671">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="6261724">func</span>&nbsp;<span class="ident" id="6261729">Do</span><span class="op" id="6261731">(</span><span class="ident" id="6261732">f</span>&nbsp;<span class="keyword" id="6261734">func</span><span class="op" id="6261738">(</span><span class="ident" id="6261739">KeyValue</span><span class="op" id="6261747">)</span><span class="op" id="6261748">)</span>&nbsp;<span class="op" id="6261750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261753">mutex</span><span class="op" id="6261758">.</span><span class="ident" id="6261759">RLock</span><span class="op" id="6261764">(</span><span class="op" id="6261765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261768">defer</span>&nbsp;<span class="ident" id="6261774">mutex</span><span class="op" id="6261779">.</span><span class="ident" id="6261780">RUnlock</span><span class="op" id="6261787">(</span><span class="op" id="6261788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6261791">for</span>&nbsp;<span class="ident" id="6261795">_</span><span class="op" id="6261796">,</span>&nbsp;<span class="ident" id="6261798">k</span>&nbsp;<span class="op" id="6261800">:=</span>&nbsp;<span class="keyword" id="6261803">range</span>&nbsp;<span class="ident" id="6261809">varKeys</span>&nbsp;<span class="op" id="6261817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261821">f</span><span class="op" id="6261822">(</span><span class="ident" id="6261823">KeyValue</span><span class="op" id="6261831">{</span><span class="ident" id="6261832">k</span><span class="op" id="6261833">,</span>&nbsp;<span class="ident" id="6261835">vars</span><span class="op" id="6261839">[</span><span class="ident" id="6261840">k</span><span class="op" id="6261841">]</span><span class="op" id="6261842">}</span><span class="op" id="6261843">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6261846">}</span><br>
<span class="lineno"></span><span class="op" id="6261848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6261851">func</span>&nbsp;<span class="ident" id="6261856">expvarHandler</span><span class="op" id="6261869">(</span><span class="ident" id="6261870">w</span>&nbsp;<span class="ident" id="6261872">http</span><span class="op" id="6261876">.</span><span class="ident" id="6261877">ResponseWriter</span><span class="op" id="6261891">,</span>&nbsp;<span class="ident" id="6261893">r</span>&nbsp;<span class="op" id="6261895">*</span><span class="ident" id="6261896">http</span><span class="op" id="6261900">.</span><span class="ident" id="6261901">Request</span><span class="op" id="6261908">)</span>&nbsp;<span class="op" id="6261910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261913">w</span><span class="op" id="6261914">.</span><span class="ident" id="6261915">Header</span><span class="op" id="6261921">(</span><span class="op" id="6261922">)</span><span class="op" id="6261923">.</span><span class="ident" id="6261924">Set</span><span class="op" id="6261927">(</span><span class="string" id="6261928">&#34;Content-Type&#34;</span><span class="op" id="6261942">,</span>&nbsp;<span class="string" id="6261944">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="6261977">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6261980">fmt</span><span class="op" id="6261983">.</span><span class="ident" id="6261984">Fprintf</span><span class="op" id="6261991">(</span><span class="ident" id="6261992">w</span><span class="op" id="6261993">,</span>&nbsp;<span class="string" id="6261995">&#34;{\n&#34;</span><span class="op" id="6262000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262003">first</span>&nbsp;<span class="op" id="6262009">:=</span>&nbsp;<span class="builtintype" id="6262012">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262018">Do</span><span class="op" id="6262020">(</span><span class="keyword" id="6262021">func</span><span class="op" id="6262025">(</span><span class="ident" id="6262026">kv</span>&nbsp;<span class="ident" id="6262029">KeyValue</span><span class="op" id="6262037">)</span>&nbsp;<span class="op" id="6262039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262043">if</span>&nbsp;<span class="op" id="6262046">!</span><span class="ident" id="6262047">first</span>&nbsp;<span class="op" id="6262053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262058">fmt</span><span class="op" id="6262061">.</span><span class="ident" id="6262062">Fprintf</span><span class="op" id="6262069">(</span><span class="ident" id="6262070">w</span><span class="op" id="6262071">,</span>&nbsp;<span class="string" id="6262073">&#34;,\n&#34;</span><span class="op" id="6262078">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6262082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262086">first</span>&nbsp;<span class="op" id="6262092">=</span>&nbsp;<span class="builtintype" id="6262094">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262102">fmt</span><span class="op" id="6262105">.</span><span class="ident" id="6262106">Fprintf</span><span class="op" id="6262113">(</span><span class="ident" id="6262114">w</span><span class="op" id="6262115">,</span>&nbsp;<span class="string" id="6262117">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="6262125">,</span>&nbsp;<span class="ident" id="6262127">kv</span><span class="op" id="6262129">.</span><span class="ident" id="6262130">Key</span><span class="op" id="6262133">,</span>&nbsp;<span class="ident" id="6262135">kv</span><span class="op" id="6262137">.</span><span class="ident" id="6262138">Value</span><span class="op" id="6262143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6262146">}</span><span class="op" id="6262147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262150">fmt</span><span class="op" id="6262153">.</span><span class="ident" id="6262154">Fprintf</span><span class="op" id="6262161">(</span><span class="ident" id="6262162">w</span><span class="op" id="6262163">,</span>&nbsp;<span class="string" id="6262165">&#34;\n}\n&#34;</span><span class="op" id="6262172">)</span><br>
<span class="lineno">320</span><span class="op" id="6262174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6262177">func</span>&nbsp;<span class="ident" id="6262182">cmdline</span><span class="op" id="6262189">(</span><span class="op" id="6262190">)</span>&nbsp;<span class="keyword" id="6262192">interface</span><span class="op" id="6262201">{</span><span class="op" id="6262202">}</span>&nbsp;<span class="op" id="6262204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262207">return</span>&nbsp;<span class="ident" id="6262214">os</span><span class="op" id="6262216">.</span><span class="ident" id="6262217">Args</span><br>
<span class="lineno"></span><span class="op" id="6262222">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6262225">func</span>&nbsp;<span class="ident" id="6262230">memstats</span><span class="op" id="6262238">(</span><span class="op" id="6262239">)</span>&nbsp;<span class="keyword" id="6262241">interface</span><span class="op" id="6262250">{</span><span class="op" id="6262251">}</span>&nbsp;<span class="op" id="6262253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262256">stats</span>&nbsp;<span class="op" id="6262262">:=</span>&nbsp;<span class="builtinfunc" id="6262265">new</span><span class="op" id="6262268">(</span><span class="ident" id="6262269">runtime</span><span class="op" id="6262276">.</span><span class="ident" id="6262277">MemStats</span><span class="op" id="6262285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262288">runtime</span><span class="op" id="6262295">.</span><span class="ident" id="6262296">ReadMemStats</span><span class="op" id="6262308">(</span><span class="ident" id="6262309">stats</span><span class="op" id="6262314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6262317">return</span>&nbsp;<span class="op" id="6262324">*</span><span class="ident" id="6262325">stats</span><br>
<span class="lineno">330</span><span class="op" id="6262331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6262334">func</span>&nbsp;<span class="ident" id="6262339">init</span><span class="op" id="6262343">(</span><span class="op" id="6262344">)</span>&nbsp;<span class="op" id="6262346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262349">http</span><span class="op" id="6262353">.</span><span class="ident" id="6262354">HandleFunc</span><span class="op" id="6262364">(</span><span class="string" id="6262365">&#34;/debug/vars&#34;</span><span class="op" id="6262378">,</span>&nbsp;<span class="ident" id="6262380">expvarHandler</span><span class="op" id="6262393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262396">Publish</span><span class="op" id="6262403">(</span><span class="string" id="6262404">&#34;cmdline&#34;</span><span class="op" id="6262413">,</span>&nbsp;<span class="ident" id="6262415">Func</span><span class="op" id="6262419">(</span><span class="ident" id="6262420">cmdline</span><span class="op" id="6262427">)</span><span class="op" id="6262428">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6262431">Publish</span><span class="op" id="6262438">(</span><span class="string" id="6262439">&#34;memstats&#34;</span><span class="op" id="6262449">,</span>&nbsp;<span class="ident" id="6262451">Func</span><span class="op" id="6262455">(</span><span class="ident" id="6262456">memstats</span><span class="op" id="6262464">)</span><span class="op" id="6262465">)</span><br>
<span class="lineno"></span><span class="op" id="6262467">}</span>
</div>
</body>
</html>
