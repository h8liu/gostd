<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/x509</h2>
<ul>
<li><a href="/gostd/crypto/x509/cert_pool.go.html">cert_pool.go</a></li>
<li><a href="/gostd/crypto/x509/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt.go.html">pem_decrypt.go</a></li>
<li><a href="/gostd/crypto/x509/pem_decrypt_test.go.html">pem_decrypt_test.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs1.go.html">pkcs1.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8.go.html">pkcs8.go</a></li>
<li><a href="/gostd/crypto/x509/pkcs8_test.go.html">pkcs8_test.go</a></li>
<li><a href="/gostd/crypto/x509/root.go.html">root.go</a></li>
<li><a href="/gostd/crypto/x509/root_unix.go.html">root_unix.go</a></li>
<li><a href="/gostd/crypto/x509/sec1.go.html">sec1.go</a></li>
<li><a href="/gostd/crypto/x509/sec1_test.go.html">sec1_test.go</a></li>
<li><a href="/gostd/crypto/x509/verify.go.html">verify.go</a></li>
<li><a href="/gostd/crypto/x509/verify_test.go.html">verify_test.go</a></li>
<li><a href="/gostd/crypto/x509/x509.go.html">x509.go</a></li>
<li><a href="/gostd/crypto/x509/x509_test.go.html">x509_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4319690">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4319745">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4319799">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4319850">package</span>&nbsp;<span class="ident" id="4319858">x509</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4319864">import</span>&nbsp;<span class="op" id="4319871">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319874">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319881">&#34;net&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319888">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319899">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319910">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4319918">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="4319933">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="4319936">type</span>&nbsp;<span class="ident" id="4319941">InvalidReason</span>&nbsp;<span class="builtintype" id="4319955">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4319960">const</span>&nbsp;<span class="op" id="4319966">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4319969">//&nbsp;NotAuthorizedToSign&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;is&nbsp;signed&nbsp;by&nbsp;another</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320041">//&nbsp;which&nbsp;isn&#39;t&nbsp;marked&nbsp;as&nbsp;a&nbsp;CA&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320085">NotAuthorizedToSign</span>&nbsp;<span class="ident" id="4320105">InvalidReason</span>&nbsp;<span class="op" id="4320119">=</span>&nbsp;<span class="ident" id="4320121">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320127">//&nbsp;Expired&nbsp;results&nbsp;when&nbsp;a&nbsp;certificate&nbsp;has&nbsp;expired,&nbsp;based&nbsp;on&nbsp;the&nbsp;time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320197">//&nbsp;given&nbsp;in&nbsp;the&nbsp;VerifyOptions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320229">Expired</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320238">//&nbsp;CANotAuthorizedForThisName&nbsp;results&nbsp;when&nbsp;an&nbsp;intermediate&nbsp;or&nbsp;root</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320306">//&nbsp;certificate&nbsp;has&nbsp;a&nbsp;name&nbsp;constraint&nbsp;which&nbsp;doesn&#39;t&nbsp;include&nbsp;the&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320375">//&nbsp;being&nbsp;checked.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320394">CANotAuthorizedForThisName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320422">//&nbsp;TooManyIntermediates&nbsp;results&nbsp;when&nbsp;a&nbsp;path&nbsp;length&nbsp;constraint&nbsp;is</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320488">//&nbsp;violated.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320502">TooManyIntermediates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320524">//&nbsp;IncompatibleUsage&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&#39;s&nbsp;key&nbsp;usage&nbsp;indicates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4320597">//&nbsp;that&nbsp;it&nbsp;may&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;a&nbsp;different&nbsp;purpose.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320651">IncompatibleUsage</span><br>
<span class="lineno">35</span><span class="op" id="4320669">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4320672">//&nbsp;CertificateInvalidError&nbsp;results&nbsp;when&nbsp;an&nbsp;odd&nbsp;error&nbsp;occurs.&nbsp;Users&nbsp;of&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="4320747">//&nbsp;library&nbsp;probably&nbsp;want&nbsp;to&nbsp;handle&nbsp;all&nbsp;these&nbsp;errors&nbsp;uniformly.</span><br>
<span class="lineno"></span><span class="keyword" id="4320810">type</span>&nbsp;<span class="ident" id="4320815">CertificateInvalidError</span>&nbsp;<span class="keyword" id="4320839">struct</span>&nbsp;<span class="op" id="4320846">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320849">Cert</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4320856">*</span><span class="ident" id="4320857">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4320870">Reason</span>&nbsp;<span class="ident" id="4320877">InvalidReason</span><br>
<span class="lineno"></span><span class="op" id="4320891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4320894">func</span>&nbsp;<span class="op" id="4320899">(</span><span class="ident" id="4320900">e</span>&nbsp;<span class="ident" id="4320902">CertificateInvalidError</span><span class="op" id="4320925">)</span>&nbsp;<span class="ident" id="4320927">Error</span><span class="op" id="4320932">(</span><span class="op" id="4320933">)</span>&nbsp;<span class="builtintype" id="4320935">string</span>&nbsp;<span class="op" id="4320942">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320945">switch</span>&nbsp;<span class="ident" id="4320952">e</span><span class="op" id="4320953">.</span><span class="ident" id="4320954">Reason</span>&nbsp;<span class="op" id="4320961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320964">case</span>&nbsp;<span class="ident" id="4320969">NotAuthorizedToSign</span><span class="op" id="4320988">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4320992">return</span>&nbsp;<span class="string" id="4320999">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;other&nbsp;certificates&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321065">case</span>&nbsp;<span class="ident" id="4321070">Expired</span><span class="op" id="4321077">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321081">return</span>&nbsp;<span class="string" id="4321088">&#34;x509:&nbsp;certificate&nbsp;has&nbsp;expired&nbsp;or&nbsp;is&nbsp;not&nbsp;yet&nbsp;valid&#34;</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321141">case</span>&nbsp;<span class="ident" id="4321146">CANotAuthorizedForThisName</span><span class="op" id="4321172">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321176">return</span>&nbsp;<span class="string" id="4321183">&#34;x509:&nbsp;a&nbsp;root&nbsp;or&nbsp;intermediate&nbsp;certificate&nbsp;is&nbsp;not&nbsp;authorized&nbsp;to&nbsp;sign&nbsp;in&nbsp;this&nbsp;domain&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321268">case</span>&nbsp;<span class="ident" id="4321273">TooManyIntermediates</span><span class="op" id="4321293">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321297">return</span>&nbsp;<span class="string" id="4321304">&#34;x509:&nbsp;too&nbsp;many&nbsp;intermediates&nbsp;for&nbsp;path&nbsp;length&nbsp;constraint&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321363">case</span>&nbsp;<span class="ident" id="4321368">IncompatibleUsage</span><span class="op" id="4321385">:</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321389">return</span>&nbsp;<span class="string" id="4321396">&#34;x509:&nbsp;certificate&nbsp;specifies&nbsp;an&nbsp;incompatible&nbsp;key&nbsp;usage&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321456">return</span>&nbsp;<span class="string" id="4321463">&#34;x509:&nbsp;unknown&nbsp;error&#34;</span><br>
<span class="lineno"></span><span class="op" id="4321485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4321488">//&nbsp;HostnameError&nbsp;results&nbsp;when&nbsp;the&nbsp;set&nbsp;of&nbsp;authorized&nbsp;names&nbsp;doesn&#39;t&nbsp;match&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4321564">//&nbsp;requested&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4321583">type</span>&nbsp;<span class="ident" id="4321588">HostnameError</span>&nbsp;<span class="keyword" id="4321602">struct</span>&nbsp;<span class="op" id="4321609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321612">Certificate</span>&nbsp;<span class="op" id="4321624">*</span><span class="ident" id="4321625">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321638">Host</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4321650">string</span><br>
<span class="lineno">65</span><span class="op" id="4321657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4321660">func</span>&nbsp;<span class="op" id="4321665">(</span><span class="ident" id="4321666">h</span>&nbsp;<span class="ident" id="4321668">HostnameError</span><span class="op" id="4321681">)</span>&nbsp;<span class="ident" id="4321683">Error</span><span class="op" id="4321688">(</span><span class="op" id="4321689">)</span>&nbsp;<span class="builtintype" id="4321691">string</span>&nbsp;<span class="op" id="4321698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4321701">c</span>&nbsp;<span class="op" id="4321703">:=</span>&nbsp;<span class="ident" id="4321706">h</span><span class="op" id="4321707">.</span><span class="ident" id="4321708">Certificate</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321722">var</span>&nbsp;<span class="ident" id="4321726">valid</span>&nbsp;<span class="builtintype" id="4321732">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321740">if</span>&nbsp;<span class="ident" id="4321743">ip</span>&nbsp;<span class="op" id="4321746">:=</span>&nbsp;<span class="ident" id="4321749">net</span><span class="op" id="4321752">.</span><span class="ident" id="4321753">ParseIP</span><span class="op" id="4321760">(</span><span class="ident" id="4321761">h</span><span class="op" id="4321762">.</span><span class="ident" id="4321763">Host</span><span class="op" id="4321767">)</span><span class="op" id="4321768">;</span>&nbsp;<span class="ident" id="4321770">ip</span>&nbsp;<span class="op" id="4321773">!=</span>&nbsp;<span class="ident" id="4321776">nil</span>&nbsp;<span class="op" id="4321780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4321784">//&nbsp;Trying&nbsp;to&nbsp;validate&nbsp;an&nbsp;IP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321814">if</span>&nbsp;<span class="builtinfunc" id="4321817">len</span><span class="op" id="4321820">(</span><span class="ident" id="4321821">c</span><span class="op" id="4321822">.</span><span class="ident" id="4321823">IPAddresses</span><span class="op" id="4321834">)</span>&nbsp;<span class="op" id="4321836">==</span>&nbsp;<span class="num" id="4321839">0</span>&nbsp;<span class="op" id="4321841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321846">return</span>&nbsp;<span class="string" id="4321853">&#34;x509:&nbsp;cannot&nbsp;validate&nbsp;certificate&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4321894">+</span>&nbsp;<span class="ident" id="4321896">h</span><span class="op" id="4321897">.</span><span class="ident" id="4321898">Host</span>&nbsp;<span class="op" id="4321903">+</span>&nbsp;<span class="string" id="4321905">&#34;&nbsp;because&nbsp;it&nbsp;doesn&#39;t&nbsp;contain&nbsp;any&nbsp;IP&nbsp;SANs&#34;</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4321949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321953">for</span>&nbsp;<span class="ident" id="4321957">_</span><span class="op" id="4321958">,</span>&nbsp;<span class="ident" id="4321960">san</span>&nbsp;<span class="op" id="4321964">:=</span>&nbsp;<span class="keyword" id="4321967">range</span>&nbsp;<span class="ident" id="4321973">c</span><span class="op" id="4321974">.</span><span class="ident" id="4321975">IPAddresses</span>&nbsp;<span class="op" id="4321987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4321992">if</span>&nbsp;<span class="builtinfunc" id="4321995">len</span><span class="op" id="4321998">(</span><span class="ident" id="4321999">valid</span><span class="op" id="4322004">)</span>&nbsp;<span class="op" id="4322006">&gt;</span>&nbsp;<span class="num" id="4322008">0</span>&nbsp;<span class="op" id="4322010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322016">valid</span>&nbsp;<span class="op" id="4322022">+=</span>&nbsp;<span class="string" id="4322025">&#34;,&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322033">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322038">valid</span>&nbsp;<span class="op" id="4322044">+=</span>&nbsp;<span class="ident" id="4322047">san</span><span class="op" id="4322050">.</span><span class="ident" id="4322051">String</span><span class="op" id="4322057">(</span><span class="op" id="4322058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322065">}</span>&nbsp;<span class="keyword" id="4322067">else</span>&nbsp;<span class="op" id="4322072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322076">if</span>&nbsp;<span class="builtinfunc" id="4322079">len</span><span class="op" id="4322082">(</span><span class="ident" id="4322083">c</span><span class="op" id="4322084">.</span><span class="ident" id="4322085">DNSNames</span><span class="op" id="4322093">)</span>&nbsp;<span class="op" id="4322095">&gt;</span>&nbsp;<span class="num" id="4322097">0</span>&nbsp;<span class="op" id="4322099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322104">valid</span>&nbsp;<span class="op" id="4322110">=</span>&nbsp;<span class="ident" id="4322112">strings</span><span class="op" id="4322119">.</span><span class="ident" id="4322120">Join</span><span class="op" id="4322124">(</span><span class="ident" id="4322125">c</span><span class="op" id="4322126">.</span><span class="ident" id="4322127">DNSNames</span><span class="op" id="4322135">,</span>&nbsp;<span class="string" id="4322137">&#34;,&nbsp;&#34;</span><span class="op" id="4322141">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322145">}</span>&nbsp;<span class="keyword" id="4322147">else</span>&nbsp;<span class="op" id="4322152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322157">valid</span>&nbsp;<span class="op" id="4322163">=</span>&nbsp;<span class="ident" id="4322165">c</span><span class="op" id="4322166">.</span><span class="ident" id="4322167">Subject</span><span class="op" id="4322174">.</span><span class="ident" id="4322175">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322194">return</span>&nbsp;<span class="string" id="4322201">&#34;x509:&nbsp;certificate&nbsp;is&nbsp;valid&nbsp;for&nbsp;&#34;</span>&nbsp;<span class="op" id="4322235">+</span>&nbsp;<span class="ident" id="4322237">valid</span>&nbsp;<span class="op" id="4322243">+</span>&nbsp;<span class="string" id="4322245">&#34;,&nbsp;not&nbsp;&#34;</span>&nbsp;<span class="op" id="4322254">+</span>&nbsp;<span class="ident" id="4322256">h</span><span class="op" id="4322257">.</span><span class="ident" id="4322258">Host</span><br>
<span class="lineno">90</span><span class="op" id="4322263">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4322266">//&nbsp;UnknownAuthorityError&nbsp;results&nbsp;when&nbsp;the&nbsp;certificate&nbsp;issuer&nbsp;is&nbsp;unknown</span><br>
<span class="lineno"></span><span class="keyword" id="4322338">type</span>&nbsp;<span class="ident" id="4322343">UnknownAuthorityError</span>&nbsp;<span class="keyword" id="4322365">struct</span>&nbsp;<span class="op" id="4322372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322375">cert</span>&nbsp;<span class="op" id="4322380">*</span><span class="ident" id="4322381">Certificate</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322394">//&nbsp;hintErr&nbsp;contains&nbsp;an&nbsp;error&nbsp;that&nbsp;may&nbsp;be&nbsp;helpful&nbsp;in&nbsp;determining&nbsp;why&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322466">//&nbsp;authority&nbsp;wasn&#39;t&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322494">hintErr</span>&nbsp;<span class="builtintype" id="4322502">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322509">//&nbsp;hintCert&nbsp;contains&nbsp;a&nbsp;possible&nbsp;authority&nbsp;certificate&nbsp;that&nbsp;was&nbsp;rejected</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4322582">//&nbsp;because&nbsp;of&nbsp;the&nbsp;error&nbsp;in&nbsp;hintErr.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322619">hintCert</span>&nbsp;<span class="op" id="4322628">*</span><span class="ident" id="4322629">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4322641">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4322644">func</span>&nbsp;<span class="op" id="4322649">(</span><span class="ident" id="4322650">e</span>&nbsp;<span class="ident" id="4322652">UnknownAuthorityError</span><span class="op" id="4322673">)</span>&nbsp;<span class="ident" id="4322675">Error</span><span class="op" id="4322680">(</span><span class="op" id="4322681">)</span>&nbsp;<span class="builtintype" id="4322683">string</span>&nbsp;<span class="op" id="4322690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322693">s</span>&nbsp;<span class="op" id="4322695">:=</span>&nbsp;<span class="string" id="4322698">&#34;x509:&nbsp;certificate&nbsp;signed&nbsp;by&nbsp;unknown&nbsp;authority&#34;</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322747">if</span>&nbsp;<span class="ident" id="4322750">e</span><span class="op" id="4322751">.</span><span class="ident" id="4322752">hintErr</span>&nbsp;<span class="op" id="4322760">!=</span>&nbsp;<span class="ident" id="4322763">nil</span>&nbsp;<span class="op" id="4322767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322771">certName</span>&nbsp;<span class="op" id="4322780">:=</span>&nbsp;<span class="ident" id="4322783">e</span><span class="op" id="4322784">.</span><span class="ident" id="4322785">hintCert</span><span class="op" id="4322793">.</span><span class="ident" id="4322794">Subject</span><span class="op" id="4322801">.</span><span class="ident" id="4322802">CommonName</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322815">if</span>&nbsp;<span class="builtinfunc" id="4322818">len</span><span class="op" id="4322821">(</span><span class="ident" id="4322822">certName</span><span class="op" id="4322830">)</span>&nbsp;<span class="op" id="4322832">==</span>&nbsp;<span class="num" id="4322835">0</span>&nbsp;<span class="op" id="4322837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4322842">if</span>&nbsp;<span class="builtinfunc" id="4322845">len</span><span class="op" id="4322848">(</span><span class="ident" id="4322849">e</span><span class="op" id="4322850">.</span><span class="ident" id="4322851">hintCert</span><span class="op" id="4322859">.</span><span class="ident" id="4322860">Subject</span><span class="op" id="4322867">.</span><span class="ident" id="4322868">Organization</span><span class="op" id="4322880">)</span>&nbsp;<span class="op" id="4322882">&gt;</span>&nbsp;<span class="num" id="4322884">0</span>&nbsp;<span class="op" id="4322886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322892">certName</span>&nbsp;<span class="op" id="4322901">=</span>&nbsp;<span class="ident" id="4322903">e</span><span class="op" id="4322904">.</span><span class="ident" id="4322905">hintCert</span><span class="op" id="4322913">.</span><span class="ident" id="4322914">Subject</span><span class="op" id="4322921">.</span><span class="ident" id="4322922">Organization</span><span class="op" id="4322934">[</span><span class="num" id="4322935">0</span><span class="op" id="4322936">]</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4322941">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4322946">certName</span>&nbsp;<span class="op" id="4322955">=</span>&nbsp;<span class="string" id="4322957">&#34;serial:&#34;</span>&nbsp;<span class="op" id="4322967">+</span>&nbsp;<span class="ident" id="4322969">e</span><span class="op" id="4322970">.</span><span class="ident" id="4322971">hintCert</span><span class="op" id="4322979">.</span><span class="ident" id="4322980">SerialNumber</span><span class="op" id="4322992">.</span><span class="ident" id="4322993">String</span><span class="op" id="4322999">(</span><span class="op" id="4323000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323008">s</span>&nbsp;<span class="op" id="4323010">+=</span>&nbsp;<span class="ident" id="4323013">fmt</span><span class="op" id="4323016">.</span><span class="ident" id="4323017">Sprintf</span><span class="op" id="4323024">(</span><span class="string" id="4323025">&#34;&nbsp;(possibly&nbsp;because&nbsp;of&nbsp;%q&nbsp;while&nbsp;trying&nbsp;to&nbsp;verify&nbsp;candidate&nbsp;authority&nbsp;certificate&nbsp;%q)&#34;</span><span class="op" id="4323110">,</span>&nbsp;<span class="ident" id="4323112">e</span><span class="op" id="4323113">.</span><span class="ident" id="4323114">hintErr</span><span class="op" id="4323121">,</span>&nbsp;<span class="ident" id="4323123">certName</span><span class="op" id="4323131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4323134">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323137">return</span>&nbsp;<span class="ident" id="4323144">s</span><br>
<span class="lineno"></span><span class="op" id="4323146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4323149">//&nbsp;SystemRootsError&nbsp;results&nbsp;when&nbsp;we&nbsp;fail&nbsp;to&nbsp;load&nbsp;the&nbsp;system&nbsp;root&nbsp;certificates.</span><br>
<span class="lineno"></span><span class="keyword" id="4323228">type</span>&nbsp;<span class="ident" id="4323233">SystemRootsError</span>&nbsp;<span class="keyword" id="4323250">struct</span><span class="op" id="4323256">{</span><span class="op" id="4323257">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="keyword" id="4323260">func</span>&nbsp;<span class="op" id="4323265">(</span><span class="ident" id="4323266">SystemRootsError</span><span class="op" id="4323282">)</span>&nbsp;<span class="ident" id="4323284">Error</span><span class="op" id="4323289">(</span><span class="op" id="4323290">)</span>&nbsp;<span class="builtintype" id="4323292">string</span>&nbsp;<span class="op" id="4323299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4323302">return</span>&nbsp;<span class="string" id="4323309">&#34;x509:&nbsp;failed&nbsp;to&nbsp;load&nbsp;system&nbsp;roots&nbsp;and&nbsp;no&nbsp;roots&nbsp;provided&#34;</span><br>
<span class="lineno"></span><span class="op" id="4323367">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4323370">//&nbsp;VerifyOptions&nbsp;contains&nbsp;parameters&nbsp;for&nbsp;Certificate.Verify.&nbsp;It&#39;s&nbsp;a&nbsp;structure</span><br>
<span class="lineno"></span><span class="comment" id="4323448">//&nbsp;because&nbsp;other&nbsp;PKIX&nbsp;verification&nbsp;APIs&nbsp;have&nbsp;ended&nbsp;up&nbsp;needing&nbsp;many&nbsp;options.</span><br>
<span class="lineno"></span><span class="keyword" id="4323524">type</span>&nbsp;<span class="ident" id="4323529">VerifyOptions</span>&nbsp;<span class="keyword" id="4323543">struct</span>&nbsp;<span class="op" id="4323550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323553">DNSName</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4323567">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323575">Intermediates</span>&nbsp;<span class="op" id="4323589">*</span><span class="ident" id="4323590">CertPool</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323600">Roots</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4323614">*</span><span class="ident" id="4323615">CertPool</span>&nbsp;<span class="comment" id="4323624">//&nbsp;if&nbsp;nil,&nbsp;the&nbsp;system&nbsp;roots&nbsp;are&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4323662">CurrentTime</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4323676">time</span><span class="op" id="4323680">.</span><span class="ident" id="4323681">Time</span>&nbsp;<span class="comment" id="4323686">//&nbsp;if&nbsp;zero,&nbsp;the&nbsp;current&nbsp;time&nbsp;is&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323724">//&nbsp;KeyUsage&nbsp;specifies&nbsp;which&nbsp;Extended&nbsp;Key&nbsp;Usage&nbsp;values&nbsp;are&nbsp;acceptable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323795">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;means&nbsp;ExtKeyUsageServerAuth.&nbsp;Key&nbsp;usage&nbsp;is&nbsp;considered&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323868">//&nbsp;constraint&nbsp;down&nbsp;the&nbsp;chain&nbsp;which&nbsp;mirrors&nbsp;Windows&nbsp;CryptoAPI&nbsp;behaviour,</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4323941">//&nbsp;but&nbsp;not&nbsp;the&nbsp;spec.&nbsp;To&nbsp;accept&nbsp;any&nbsp;key&nbsp;usage,&nbsp;include&nbsp;ExtKeyUsageAny.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324012">KeyUsages</span>&nbsp;<span class="op" id="4324022">[</span><span class="op" id="4324023">]</span><span class="ident" id="4324024">ExtKeyUsage</span><br>
<span class="lineno"></span><span class="op" id="4324036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4324039">const</span>&nbsp;<span class="op" id="4324045">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324048">leafCertificate</span>&nbsp;<span class="op" id="4324064">=</span>&nbsp;<span class="ident" id="4324066">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324072">intermediateCertificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324097">rootCertificate</span><br>
<span class="lineno"></span><span class="op" id="4324113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="4324116">//&nbsp;isValid&nbsp;performs&nbsp;validity&nbsp;checks&nbsp;on&nbsp;the&nbsp;c.</span><br>
<span class="lineno"></span><span class="keyword" id="4324162">func</span>&nbsp;<span class="op" id="4324167">(</span><span class="ident" id="4324168">c</span>&nbsp;<span class="op" id="4324170">*</span><span class="ident" id="4324171">Certificate</span><span class="op" id="4324182">)</span>&nbsp;<span class="ident" id="4324184">isValid</span><span class="op" id="4324191">(</span><span class="ident" id="4324192">certType</span>&nbsp;<span class="builtintype" id="4324201">int</span><span class="op" id="4324204">,</span>&nbsp;<span class="ident" id="4324206">currentChain</span>&nbsp;<span class="op" id="4324219">[</span><span class="op" id="4324220">]</span><span class="op" id="4324221">*</span><span class="ident" id="4324222">Certificate</span><span class="op" id="4324233">,</span>&nbsp;<span class="ident" id="4324235">opts</span>&nbsp;<span class="op" id="4324240">*</span><span class="ident" id="4324241">VerifyOptions</span><span class="op" id="4324254">)</span>&nbsp;<span class="builtintype" id="4324256">error</span>&nbsp;<span class="op" id="4324262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324265">now</span>&nbsp;<span class="op" id="4324269">:=</span>&nbsp;<span class="ident" id="4324272">opts</span><span class="op" id="4324276">.</span><span class="ident" id="4324277">CurrentTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324290">if</span>&nbsp;<span class="ident" id="4324293">now</span><span class="op" id="4324296">.</span><span class="ident" id="4324297">IsZero</span><span class="op" id="4324303">(</span><span class="op" id="4324304">)</span>&nbsp;<span class="op" id="4324306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324310">now</span>&nbsp;<span class="op" id="4324314">=</span>&nbsp;<span class="ident" id="4324316">time</span><span class="op" id="4324320">.</span><span class="ident" id="4324321">Now</span><span class="op" id="4324324">(</span><span class="op" id="4324325">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324331">if</span>&nbsp;<span class="ident" id="4324334">now</span><span class="op" id="4324337">.</span><span class="ident" id="4324338">Before</span><span class="op" id="4324344">(</span><span class="ident" id="4324345">c</span><span class="op" id="4324346">.</span><span class="ident" id="4324347">NotBefore</span><span class="op" id="4324356">)</span>&nbsp;<span class="op" id="4324358">||</span>&nbsp;<span class="ident" id="4324361">now</span><span class="op" id="4324364">.</span><span class="ident" id="4324365">After</span><span class="op" id="4324370">(</span><span class="ident" id="4324371">c</span><span class="op" id="4324372">.</span><span class="ident" id="4324373">NotAfter</span><span class="op" id="4324381">)</span>&nbsp;<span class="op" id="4324383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324387">return</span>&nbsp;<span class="ident" id="4324394">CertificateInvalidError</span><span class="op" id="4324417">{</span><span class="ident" id="4324418">c</span><span class="op" id="4324419">,</span>&nbsp;<span class="ident" id="4324421">Expired</span><span class="op" id="4324428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324435">if</span>&nbsp;<span class="builtinfunc" id="4324438">len</span><span class="op" id="4324441">(</span><span class="ident" id="4324442">c</span><span class="op" id="4324443">.</span><span class="ident" id="4324444">PermittedDNSDomains</span><span class="op" id="4324463">)</span>&nbsp;<span class="op" id="4324465">&gt;</span>&nbsp;<span class="num" id="4324467">0</span>&nbsp;<span class="op" id="4324469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324473">ok</span>&nbsp;<span class="op" id="4324476">:=</span>&nbsp;<span class="builtintype" id="4324479">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324487">for</span>&nbsp;<span class="ident" id="4324491">_</span><span class="op" id="4324492">,</span>&nbsp;<span class="ident" id="4324494">domain</span>&nbsp;<span class="op" id="4324501">:=</span>&nbsp;<span class="keyword" id="4324504">range</span>&nbsp;<span class="ident" id="4324510">c</span><span class="op" id="4324511">.</span><span class="ident" id="4324512">PermittedDNSDomains</span>&nbsp;<span class="op" id="4324532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324537">if</span>&nbsp;<span class="ident" id="4324540">opts</span><span class="op" id="4324544">.</span><span class="ident" id="4324545">DNSName</span>&nbsp;<span class="op" id="4324553">==</span>&nbsp;<span class="ident" id="4324556">domain</span>&nbsp;<span class="op" id="4324563">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324570">(</span><span class="ident" id="4324571">strings</span><span class="op" id="4324578">.</span><span class="ident" id="4324579">HasSuffix</span><span class="op" id="4324588">(</span><span class="ident" id="4324589">opts</span><span class="op" id="4324593">.</span><span class="ident" id="4324594">DNSName</span><span class="op" id="4324601">,</span>&nbsp;<span class="ident" id="4324603">domain</span><span class="op" id="4324609">)</span>&nbsp;<span class="op" id="4324611">&amp;&amp;</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4324619">len</span><span class="op" id="4324622">(</span><span class="ident" id="4324623">opts</span><span class="op" id="4324627">.</span><span class="ident" id="4324628">DNSName</span><span class="op" id="4324635">)</span>&nbsp;<span class="op" id="4324637">&gt;=</span>&nbsp;<span class="num" id="4324640">1</span><span class="op" id="4324641">+</span><span class="builtinfunc" id="4324642">len</span><span class="op" id="4324645">(</span><span class="ident" id="4324646">domain</span><span class="op" id="4324652">)</span>&nbsp;<span class="op" id="4324654">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324662">opts</span><span class="op" id="4324666">.</span><span class="ident" id="4324667">DNSName</span><span class="op" id="4324674">[</span><span class="builtinfunc" id="4324675">len</span><span class="op" id="4324678">(</span><span class="ident" id="4324679">opts</span><span class="op" id="4324683">.</span><span class="ident" id="4324684">DNSName</span><span class="op" id="4324691">)</span><span class="op" id="4324692">-</span><span class="builtinfunc" id="4324693">len</span><span class="op" id="4324696">(</span><span class="ident" id="4324697">domain</span><span class="op" id="4324703">)</span><span class="op" id="4324704">-</span><span class="num" id="4324705">1</span><span class="op" id="4324706">]</span>&nbsp;<span class="op" id="4324708">==</span>&nbsp;<span class="string" id="4324711">&#39;.&#39;</span><span class="op" id="4324714">)</span>&nbsp;<span class="op" id="4324716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4324722">ok</span>&nbsp;<span class="op" id="4324725">=</span>&nbsp;<span class="builtintype" id="4324727">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324736">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324745">}</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324754">if</span>&nbsp;<span class="op" id="4324757">!</span><span class="ident" id="4324758">ok</span>&nbsp;<span class="op" id="4324761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4324766">return</span>&nbsp;<span class="ident" id="4324773">CertificateInvalidError</span><span class="op" id="4324796">{</span><span class="ident" id="4324797">c</span><span class="op" id="4324798">,</span>&nbsp;<span class="ident" id="4324800">CANotAuthorizedForThisName</span><span class="op" id="4324826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324830">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4324833">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4324837">//&nbsp;KeyUsage&nbsp;status&nbsp;flags&nbsp;are&nbsp;ignored.&nbsp;From&nbsp;Engineering&nbsp;Security,&nbsp;Peter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4324909">//&nbsp;Gutmann:&nbsp;A&nbsp;European&nbsp;government&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signing&nbsp;certificates&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4324982">//&nbsp;being&nbsp;valid&nbsp;for&nbsp;encryption&nbsp;only,&nbsp;but&nbsp;no-one&nbsp;noticed.&nbsp;Another</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325047">//&nbsp;European&nbsp;CA&nbsp;marked&nbsp;its&nbsp;signature&nbsp;keys&nbsp;as&nbsp;not&nbsp;being&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325112">//&nbsp;signatures.&nbsp;A&nbsp;different&nbsp;CA&nbsp;marked&nbsp;its&nbsp;own&nbsp;trusted&nbsp;root&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325183">//&nbsp;as&nbsp;being&nbsp;invalid&nbsp;for&nbsp;certificate&nbsp;signing.&nbsp;&nbsp;Another&nbsp;national&nbsp;CA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325250">//&nbsp;distributed&nbsp;a&nbsp;certificate&nbsp;to&nbsp;be&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;data&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325315">//&nbsp;countryâ€™s&nbsp;tax&nbsp;authority&nbsp;that&nbsp;was&nbsp;marked&nbsp;as&nbsp;only&nbsp;being&nbsp;usable&nbsp;for</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325386">//&nbsp;digital&nbsp;signatures&nbsp;but&nbsp;not&nbsp;for&nbsp;encryption.&nbsp;Yet&nbsp;another&nbsp;CA&nbsp;reversed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325457">//&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bit&nbsp;flags&nbsp;in&nbsp;the&nbsp;keyUsage&nbsp;due&nbsp;to&nbsp;confusion&nbsp;over</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325526">//&nbsp;encoding&nbsp;endianness,&nbsp;essentially&nbsp;setting&nbsp;a&nbsp;random&nbsp;keyUsage&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325592">//&nbsp;certificates&nbsp;that&nbsp;it&nbsp;issued.&nbsp;Another&nbsp;CA&nbsp;created&nbsp;a&nbsp;self-invalidating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325664">//&nbsp;certificate&nbsp;by&nbsp;adding&nbsp;a&nbsp;certificate&nbsp;policy&nbsp;statement&nbsp;stipulating</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325733">//&nbsp;that&nbsp;the&nbsp;certificate&nbsp;had&nbsp;to&nbsp;be&nbsp;used&nbsp;strictly&nbsp;as&nbsp;specified&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325802">//&nbsp;keyUsage,&nbsp;and&nbsp;a&nbsp;keyUsage&nbsp;containing&nbsp;a&nbsp;flag&nbsp;indicating&nbsp;that&nbsp;the&nbsp;RSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4325873">//&nbsp;encryption&nbsp;key&nbsp;could&nbsp;only&nbsp;be&nbsp;used&nbsp;for&nbsp;Diffie-Hellman&nbsp;key&nbsp;agreement.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4325946">if</span>&nbsp;<span class="ident" id="4325949">certType</span>&nbsp;<span class="op" id="4325958">==</span>&nbsp;<span class="ident" id="4325961">intermediateCertificate</span>&nbsp;<span class="op" id="4325985">&amp;&amp;</span>&nbsp;<span class="op" id="4325988">(</span><span class="op" id="4325989">!</span><span class="ident" id="4325990">c</span><span class="op" id="4325991">.</span><span class="ident" id="4325992">BasicConstraintsValid</span>&nbsp;<span class="op" id="4326014">||</span>&nbsp;<span class="op" id="4326017">!</span><span class="ident" id="4326018">c</span><span class="op" id="4326019">.</span><span class="ident" id="4326020">IsCA</span><span class="op" id="4326024">)</span>&nbsp;<span class="op" id="4326026">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326030">return</span>&nbsp;<span class="ident" id="4326037">CertificateInvalidError</span><span class="op" id="4326060">{</span><span class="ident" id="4326061">c</span><span class="op" id="4326062">,</span>&nbsp;<span class="ident" id="4326064">NotAuthorizedToSign</span><span class="op" id="4326083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326090">if</span>&nbsp;<span class="ident" id="4326093">c</span><span class="op" id="4326094">.</span><span class="ident" id="4326095">BasicConstraintsValid</span>&nbsp;<span class="op" id="4326117">&amp;&amp;</span>&nbsp;<span class="ident" id="4326120">c</span><span class="op" id="4326121">.</span><span class="ident" id="4326122">MaxPathLen</span>&nbsp;<span class="op" id="4326133">&gt;=</span>&nbsp;<span class="num" id="4326136">0</span>&nbsp;<span class="op" id="4326138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4326142">numIntermediates</span>&nbsp;<span class="op" id="4326159">:=</span>&nbsp;<span class="builtinfunc" id="4326162">len</span><span class="op" id="4326165">(</span><span class="ident" id="4326166">currentChain</span><span class="op" id="4326178">)</span>&nbsp;<span class="op" id="4326180">-</span>&nbsp;<span class="num" id="4326182">1</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326186">if</span>&nbsp;<span class="ident" id="4326189">numIntermediates</span>&nbsp;<span class="op" id="4326206">&gt;</span>&nbsp;<span class="ident" id="4326208">c</span><span class="op" id="4326209">.</span><span class="ident" id="4326210">MaxPathLen</span>&nbsp;<span class="op" id="4326221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326226">return</span>&nbsp;<span class="ident" id="4326233">CertificateInvalidError</span><span class="op" id="4326256">{</span><span class="ident" id="4326257">c</span><span class="op" id="4326258">,</span>&nbsp;<span class="ident" id="4326260">TooManyIntermediates</span><span class="op" id="4326280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326287">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326291">return</span>&nbsp;<span class="ident" id="4326298">nil</span><br>
<span class="lineno"></span><span class="op" id="4326302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4326305">//&nbsp;Verify&nbsp;attempts&nbsp;to&nbsp;verify&nbsp;c&nbsp;by&nbsp;building&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;from&nbsp;c&nbsp;to&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4326379">//&nbsp;certificate&nbsp;in&nbsp;opts.Roots,&nbsp;using&nbsp;certificates&nbsp;in&nbsp;opts.Intermediates&nbsp;if</span><br>
<span class="lineno">205</span><span class="comment" id="4326453">//&nbsp;needed.&nbsp;If&nbsp;successful,&nbsp;it&nbsp;returns&nbsp;one&nbsp;or&nbsp;more&nbsp;chains&nbsp;where&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4326525">//&nbsp;element&nbsp;of&nbsp;the&nbsp;chain&nbsp;is&nbsp;c&nbsp;and&nbsp;the&nbsp;last&nbsp;element&nbsp;is&nbsp;from&nbsp;opts.Roots.</span><br>
<span class="lineno"></span><span class="comment" id="4326595">//</span><br>
<span class="lineno"></span><span class="comment" id="4326598">//&nbsp;If&nbsp;opts.Roots&nbsp;is&nbsp;nil&nbsp;and&nbsp;system&nbsp;roots&nbsp;are&nbsp;unavailable&nbsp;the&nbsp;returned&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4326674">//&nbsp;will&nbsp;be&nbsp;of&nbsp;type&nbsp;SystemRootsError.</span><br>
<span class="lineno">210</span><span class="comment" id="4326711">//</span><br>
<span class="lineno"></span><span class="comment" id="4326714">//&nbsp;WARNING:&nbsp;this&nbsp;doesn&#39;t&nbsp;do&nbsp;any&nbsp;revocation&nbsp;checking.</span><br>
<span class="lineno"></span><span class="keyword" id="4326767">func</span>&nbsp;<span class="op" id="4326772">(</span><span class="ident" id="4326773">c</span>&nbsp;<span class="op" id="4326775">*</span><span class="ident" id="4326776">Certificate</span><span class="op" id="4326787">)</span>&nbsp;<span class="ident" id="4326789">Verify</span><span class="op" id="4326795">(</span><span class="ident" id="4326796">opts</span>&nbsp;<span class="ident" id="4326801">VerifyOptions</span><span class="op" id="4326814">)</span>&nbsp;<span class="op" id="4326816">(</span><span class="ident" id="4326817">chains</span>&nbsp;<span class="op" id="4326824">[</span><span class="op" id="4326825">]</span><span class="op" id="4326826">[</span><span class="op" id="4326827">]</span><span class="op" id="4326828">*</span><span class="ident" id="4326829">Certificate</span><span class="op" id="4326840">,</span>&nbsp;<span class="ident" id="4326842">err</span>&nbsp;<span class="builtintype" id="4326846">error</span><span class="op" id="4326851">)</span>&nbsp;<span class="op" id="4326853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4326856">//&nbsp;Use&nbsp;Windows&#39;s&nbsp;own&nbsp;verification&nbsp;and&nbsp;chain&nbsp;building.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326911">if</span>&nbsp;<span class="ident" id="4326914">opts</span><span class="op" id="4326918">.</span><span class="ident" id="4326919">Roots</span>&nbsp;<span class="op" id="4326925">==</span>&nbsp;<span class="ident" id="4326928">nil</span>&nbsp;<span class="op" id="4326932">&amp;&amp;</span>&nbsp;<span class="ident" id="4326935">runtime</span><span class="op" id="4326942">.</span><span class="ident" id="4326943">GOOS</span>&nbsp;<span class="op" id="4326948">==</span>&nbsp;<span class="string" id="4326951">&#34;windows&#34;</span>&nbsp;<span class="op" id="4326961">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326965">return</span>&nbsp;<span class="ident" id="4326972">c</span><span class="op" id="4326973">.</span><span class="ident" id="4326974">systemVerify</span><span class="op" id="4326986">(</span><span class="op" id="4326987">&amp;</span><span class="ident" id="4326988">opts</span><span class="op" id="4326992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4326995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4326999">if</span>&nbsp;<span class="ident" id="4327002">opts</span><span class="op" id="4327006">.</span><span class="ident" id="4327007">Roots</span>&nbsp;<span class="op" id="4327013">==</span>&nbsp;<span class="ident" id="4327016">nil</span>&nbsp;<span class="op" id="4327020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327024">opts</span><span class="op" id="4327028">.</span><span class="ident" id="4327029">Roots</span>&nbsp;<span class="op" id="4327035">=</span>&nbsp;<span class="ident" id="4327037">systemRootsPool</span><span class="op" id="4327052">(</span><span class="op" id="4327053">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327057">if</span>&nbsp;<span class="ident" id="4327060">opts</span><span class="op" id="4327064">.</span><span class="ident" id="4327065">Roots</span>&nbsp;<span class="op" id="4327071">==</span>&nbsp;<span class="ident" id="4327074">nil</span>&nbsp;<span class="op" id="4327078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327083">return</span>&nbsp;<span class="ident" id="4327090">nil</span><span class="op" id="4327093">,</span>&nbsp;<span class="ident" id="4327095">SystemRootsError</span><span class="op" id="4327111">{</span><span class="op" id="4327112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327123">err</span>&nbsp;<span class="op" id="4327127">=</span>&nbsp;<span class="ident" id="4327129">c</span><span class="op" id="4327130">.</span><span class="ident" id="4327131">isValid</span><span class="op" id="4327138">(</span><span class="ident" id="4327139">leafCertificate</span><span class="op" id="4327154">,</span>&nbsp;<span class="ident" id="4327156">nil</span><span class="op" id="4327159">,</span>&nbsp;<span class="op" id="4327161">&amp;</span><span class="ident" id="4327162">opts</span><span class="op" id="4327166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327169">if</span>&nbsp;<span class="ident" id="4327172">err</span>&nbsp;<span class="op" id="4327176">!=</span>&nbsp;<span class="ident" id="4327179">nil</span>&nbsp;<span class="op" id="4327183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327187">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327199">if</span>&nbsp;<span class="builtinfunc" id="4327202">len</span><span class="op" id="4327205">(</span><span class="ident" id="4327206">opts</span><span class="op" id="4327210">.</span><span class="ident" id="4327211">DNSName</span><span class="op" id="4327218">)</span>&nbsp;<span class="op" id="4327220">&gt;</span>&nbsp;<span class="num" id="4327222">0</span>&nbsp;<span class="op" id="4327224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327228">err</span>&nbsp;<span class="op" id="4327232">=</span>&nbsp;<span class="ident" id="4327234">c</span><span class="op" id="4327235">.</span><span class="ident" id="4327236">VerifyHostname</span><span class="op" id="4327250">(</span><span class="ident" id="4327251">opts</span><span class="op" id="4327255">.</span><span class="ident" id="4327256">DNSName</span><span class="op" id="4327263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327267">if</span>&nbsp;<span class="ident" id="4327270">err</span>&nbsp;<span class="op" id="4327274">!=</span>&nbsp;<span class="ident" id="4327277">nil</span>&nbsp;<span class="op" id="4327281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327286">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327295">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327302">candidateChains</span><span class="op" id="4327317">,</span>&nbsp;<span class="ident" id="4327319">err</span>&nbsp;<span class="op" id="4327323">:=</span>&nbsp;<span class="ident" id="4327326">c</span><span class="op" id="4327327">.</span><span class="ident" id="4327328">buildChains</span><span class="op" id="4327339">(</span><span class="builtinfunc" id="4327340">make</span><span class="op" id="4327344">(</span><span class="keyword" id="4327345">map</span><span class="op" id="4327348">[</span><span class="builtintype" id="4327349">int</span><span class="op" id="4327352">]</span><span class="op" id="4327353">[</span><span class="op" id="4327354">]</span><span class="op" id="4327355">[</span><span class="op" id="4327356">]</span><span class="op" id="4327357">*</span><span class="ident" id="4327358">Certificate</span><span class="op" id="4327369">)</span><span class="op" id="4327370">,</span>&nbsp;<span class="op" id="4327372">[</span><span class="op" id="4327373">]</span><span class="op" id="4327374">*</span><span class="ident" id="4327375">Certificate</span><span class="op" id="4327386">{</span><span class="ident" id="4327387">c</span><span class="op" id="4327388">}</span><span class="op" id="4327389">,</span>&nbsp;<span class="op" id="4327391">&amp;</span><span class="ident" id="4327392">opts</span><span class="op" id="4327396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327399">if</span>&nbsp;<span class="ident" id="4327402">err</span>&nbsp;<span class="op" id="4327406">!=</span>&nbsp;<span class="ident" id="4327409">nil</span>&nbsp;<span class="op" id="4327413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327417">return</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327429">keyUsages</span>&nbsp;<span class="op" id="4327439">:=</span>&nbsp;<span class="ident" id="4327442">opts</span><span class="op" id="4327446">.</span><span class="ident" id="4327447">KeyUsages</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327458">if</span>&nbsp;<span class="builtinfunc" id="4327461">len</span><span class="op" id="4327464">(</span><span class="ident" id="4327465">keyUsages</span><span class="op" id="4327474">)</span>&nbsp;<span class="op" id="4327476">==</span>&nbsp;<span class="num" id="4327479">0</span>&nbsp;<span class="op" id="4327481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327485">keyUsages</span>&nbsp;<span class="op" id="4327495">=</span>&nbsp;<span class="op" id="4327497">[</span><span class="op" id="4327498">]</span><span class="ident" id="4327499">ExtKeyUsage</span><span class="op" id="4327510">{</span><span class="ident" id="4327511">ExtKeyUsageServerAuth</span><span class="op" id="4327532">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327535">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4327539">//&nbsp;If&nbsp;any&nbsp;key&nbsp;usage&nbsp;is&nbsp;acceptable&nbsp;then&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327591">for</span>&nbsp;<span class="ident" id="4327595">_</span><span class="op" id="4327596">,</span>&nbsp;<span class="ident" id="4327598">usage</span>&nbsp;<span class="op" id="4327604">:=</span>&nbsp;<span class="keyword" id="4327607">range</span>&nbsp;<span class="ident" id="4327613">keyUsages</span>&nbsp;<span class="op" id="4327623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327627">if</span>&nbsp;<span class="ident" id="4327630">usage</span>&nbsp;<span class="op" id="4327636">==</span>&nbsp;<span class="ident" id="4327639">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4327654">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327659">chains</span>&nbsp;<span class="op" id="4327666">=</span>&nbsp;<span class="ident" id="4327668">candidateChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327687">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327703">for</span>&nbsp;<span class="ident" id="4327707">_</span><span class="op" id="4327708">,</span>&nbsp;<span class="ident" id="4327710">candidate</span>&nbsp;<span class="op" id="4327720">:=</span>&nbsp;<span class="keyword" id="4327723">range</span>&nbsp;<span class="ident" id="4327729">candidateChains</span>&nbsp;<span class="op" id="4327745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327749">if</span>&nbsp;<span class="ident" id="4327752">checkChainForKeyUsage</span><span class="op" id="4327773">(</span><span class="ident" id="4327774">candidate</span><span class="op" id="4327783">,</span>&nbsp;<span class="ident" id="4327785">keyUsages</span><span class="op" id="4327794">)</span>&nbsp;<span class="op" id="4327796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327801">chains</span>&nbsp;<span class="op" id="4327808">=</span>&nbsp;<span class="builtinfunc" id="4327810">append</span><span class="op" id="4327816">(</span><span class="ident" id="4327817">chains</span><span class="op" id="4327823">,</span>&nbsp;<span class="ident" id="4327825">candidate</span><span class="op" id="4327834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327838">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327841">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327845">if</span>&nbsp;<span class="builtinfunc" id="4327848">len</span><span class="op" id="4327851">(</span><span class="ident" id="4327852">chains</span><span class="op" id="4327858">)</span>&nbsp;<span class="op" id="4327860">==</span>&nbsp;<span class="num" id="4327863">0</span>&nbsp;<span class="op" id="4327865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4327869">err</span>&nbsp;<span class="op" id="4327873">=</span>&nbsp;<span class="ident" id="4327875">CertificateInvalidError</span><span class="op" id="4327898">{</span><span class="ident" id="4327899">c</span><span class="op" id="4327900">,</span>&nbsp;<span class="ident" id="4327902">IncompatibleUsage</span><span class="op" id="4327919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4327922">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4327926">return</span><br>
<span class="lineno"></span><span class="op" id="4327933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4327936">func</span>&nbsp;<span class="ident" id="4327941">appendToFreshChain</span><span class="op" id="4327959">(</span><span class="ident" id="4327960">chain</span>&nbsp;<span class="op" id="4327966">[</span><span class="op" id="4327967">]</span><span class="op" id="4327968">*</span><span class="ident" id="4327969">Certificate</span><span class="op" id="4327980">,</span>&nbsp;<span class="ident" id="4327982">cert</span>&nbsp;<span class="op" id="4327987">*</span><span class="ident" id="4327988">Certificate</span><span class="op" id="4327999">)</span>&nbsp;<span class="op" id="4328001">[</span><span class="op" id="4328002">]</span><span class="op" id="4328003">*</span><span class="ident" id="4328004">Certificate</span>&nbsp;<span class="op" id="4328016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328019">n</span>&nbsp;<span class="op" id="4328021">:=</span>&nbsp;<span class="builtinfunc" id="4328024">make</span><span class="op" id="4328028">(</span><span class="op" id="4328029">[</span><span class="op" id="4328030">]</span><span class="op" id="4328031">*</span><span class="ident" id="4328032">Certificate</span><span class="op" id="4328043">,</span>&nbsp;<span class="builtinfunc" id="4328045">len</span><span class="op" id="4328048">(</span><span class="ident" id="4328049">chain</span><span class="op" id="4328054">)</span><span class="op" id="4328055">+</span><span class="num" id="4328056">1</span><span class="op" id="4328057">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4328060">copy</span><span class="op" id="4328064">(</span><span class="ident" id="4328065">n</span><span class="op" id="4328066">,</span>&nbsp;<span class="ident" id="4328068">chain</span><span class="op" id="4328073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328076">n</span><span class="op" id="4328077">[</span><span class="builtinfunc" id="4328078">len</span><span class="op" id="4328081">(</span><span class="ident" id="4328082">chain</span><span class="op" id="4328087">)</span><span class="op" id="4328088">]</span>&nbsp;<span class="op" id="4328090">=</span>&nbsp;<span class="ident" id="4328092">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328098">return</span>&nbsp;<span class="ident" id="4328105">n</span><br>
<span class="lineno"></span><span class="op" id="4328107">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span><span class="keyword" id="4328110">func</span>&nbsp;<span class="op" id="4328115">(</span><span class="ident" id="4328116">c</span>&nbsp;<span class="op" id="4328118">*</span><span class="ident" id="4328119">Certificate</span><span class="op" id="4328130">)</span>&nbsp;<span class="ident" id="4328132">buildChains</span><span class="op" id="4328143">(</span><span class="ident" id="4328144">cache</span>&nbsp;<span class="keyword" id="4328150">map</span><span class="op" id="4328153">[</span><span class="builtintype" id="4328154">int</span><span class="op" id="4328157">]</span><span class="op" id="4328158">[</span><span class="op" id="4328159">]</span><span class="op" id="4328160">[</span><span class="op" id="4328161">]</span><span class="op" id="4328162">*</span><span class="ident" id="4328163">Certificate</span><span class="op" id="4328174">,</span>&nbsp;<span class="ident" id="4328176">currentChain</span>&nbsp;<span class="op" id="4328189">[</span><span class="op" id="4328190">]</span><span class="op" id="4328191">*</span><span class="ident" id="4328192">Certificate</span><span class="op" id="4328203">,</span>&nbsp;<span class="ident" id="4328205">opts</span>&nbsp;<span class="op" id="4328210">*</span><span class="ident" id="4328211">VerifyOptions</span><span class="op" id="4328224">)</span>&nbsp;<span class="op" id="4328226">(</span><span class="ident" id="4328227">chains</span>&nbsp;<span class="op" id="4328234">[</span><span class="op" id="4328235">]</span><span class="op" id="4328236">[</span><span class="op" id="4328237">]</span><span class="op" id="4328238">*</span><span class="ident" id="4328239">Certificate</span><span class="op" id="4328250">,</span>&nbsp;<span class="ident" id="4328252">err</span>&nbsp;<span class="builtintype" id="4328256">error</span><span class="op" id="4328261">)</span>&nbsp;<span class="op" id="4328263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328266">possibleRoots</span><span class="op" id="4328279">,</span>&nbsp;<span class="ident" id="4328281">failedRoot</span><span class="op" id="4328291">,</span>&nbsp;<span class="ident" id="4328293">rootErr</span>&nbsp;<span class="op" id="4328301">:=</span>&nbsp;<span class="ident" id="4328304">opts</span><span class="op" id="4328308">.</span><span class="ident" id="4328309">Roots</span><span class="op" id="4328314">.</span><span class="ident" id="4328315">findVerifiedParents</span><span class="op" id="4328334">(</span><span class="ident" id="4328335">c</span><span class="op" id="4328336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328339">for</span>&nbsp;<span class="ident" id="4328343">_</span><span class="op" id="4328344">,</span>&nbsp;<span class="ident" id="4328346">rootNum</span>&nbsp;<span class="op" id="4328354">:=</span>&nbsp;<span class="keyword" id="4328357">range</span>&nbsp;<span class="ident" id="4328363">possibleRoots</span>&nbsp;<span class="op" id="4328377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328381">root</span>&nbsp;<span class="op" id="4328386">:=</span>&nbsp;<span class="ident" id="4328389">opts</span><span class="op" id="4328393">.</span><span class="ident" id="4328394">Roots</span><span class="op" id="4328399">.</span><span class="ident" id="4328400">certs</span><span class="op" id="4328405">[</span><span class="ident" id="4328406">rootNum</span><span class="op" id="4328413">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328417">err</span>&nbsp;<span class="op" id="4328421">=</span>&nbsp;<span class="ident" id="4328423">root</span><span class="op" id="4328427">.</span><span class="ident" id="4328428">isValid</span><span class="op" id="4328435">(</span><span class="ident" id="4328436">rootCertificate</span><span class="op" id="4328451">,</span>&nbsp;<span class="ident" id="4328453">currentChain</span><span class="op" id="4328465">,</span>&nbsp;<span class="ident" id="4328467">opts</span><span class="op" id="4328471">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328475">if</span>&nbsp;<span class="ident" id="4328478">err</span>&nbsp;<span class="op" id="4328482">!=</span>&nbsp;<span class="ident" id="4328485">nil</span>&nbsp;<span class="op" id="4328489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328494">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328509">chains</span>&nbsp;<span class="op" id="4328516">=</span>&nbsp;<span class="builtinfunc" id="4328518">append</span><span class="op" id="4328524">(</span><span class="ident" id="4328525">chains</span><span class="op" id="4328531">,</span>&nbsp;<span class="ident" id="4328533">appendToFreshChain</span><span class="op" id="4328551">(</span><span class="ident" id="4328552">currentChain</span><span class="op" id="4328564">,</span>&nbsp;<span class="ident" id="4328566">root</span><span class="op" id="4328570">)</span><span class="op" id="4328571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328574">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328578">possibleIntermediates</span><span class="op" id="4328599">,</span>&nbsp;<span class="ident" id="4328601">failedIntermediate</span><span class="op" id="4328619">,</span>&nbsp;<span class="ident" id="4328621">intermediateErr</span>&nbsp;<span class="op" id="4328637">:=</span>&nbsp;<span class="ident" id="4328640">opts</span><span class="op" id="4328644">.</span><span class="ident" id="4328645">Intermediates</span><span class="op" id="4328658">.</span><span class="ident" id="4328659">findVerifiedParents</span><span class="op" id="4328678">(</span><span class="ident" id="4328679">c</span><span class="op" id="4328680">)</span><br>
<span class="lineno"></span><span class="ident" id="4328682">nextIntermediate</span><span class="op" id="4328698">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328701">for</span>&nbsp;<span class="ident" id="4328705">_</span><span class="op" id="4328706">,</span>&nbsp;<span class="ident" id="4328708">intermediateNum</span>&nbsp;<span class="op" id="4328724">:=</span>&nbsp;<span class="keyword" id="4328727">range</span>&nbsp;<span class="ident" id="4328733">possibleIntermediates</span>&nbsp;<span class="op" id="4328755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328759">intermediate</span>&nbsp;<span class="op" id="4328772">:=</span>&nbsp;<span class="ident" id="4328775">opts</span><span class="op" id="4328779">.</span><span class="ident" id="4328780">Intermediates</span><span class="op" id="4328793">.</span><span class="ident" id="4328794">certs</span><span class="op" id="4328799">[</span><span class="ident" id="4328800">intermediateNum</span><span class="op" id="4328815">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328819">for</span>&nbsp;<span class="ident" id="4328823">_</span><span class="op" id="4328824">,</span>&nbsp;<span class="ident" id="4328826">cert</span>&nbsp;<span class="op" id="4328831">:=</span>&nbsp;<span class="keyword" id="4328834">range</span>&nbsp;<span class="ident" id="4328840">currentChain</span>&nbsp;<span class="op" id="4328853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328858">if</span>&nbsp;<span class="ident" id="4328861">cert</span>&nbsp;<span class="op" id="4328866">==</span>&nbsp;<span class="ident" id="4328869">intermediate</span>&nbsp;<span class="op" id="4328882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328888">continue</span>&nbsp;<span class="ident" id="4328897">nextIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4328921">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4328925">err</span>&nbsp;<span class="op" id="4328929">=</span>&nbsp;<span class="ident" id="4328931">intermediate</span><span class="op" id="4328943">.</span><span class="ident" id="4328944">isValid</span><span class="op" id="4328951">(</span><span class="ident" id="4328952">intermediateCertificate</span><span class="op" id="4328975">,</span>&nbsp;<span class="ident" id="4328977">currentChain</span><span class="op" id="4328989">,</span>&nbsp;<span class="ident" id="4328991">opts</span><span class="op" id="4328995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4328999">if</span>&nbsp;<span class="ident" id="4329002">err</span>&nbsp;<span class="op" id="4329006">!=</span>&nbsp;<span class="ident" id="4329009">nil</span>&nbsp;<span class="op" id="4329013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329018">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329033">var</span>&nbsp;<span class="ident" id="4329037">childChains</span>&nbsp;<span class="op" id="4329049">[</span><span class="op" id="4329050">]</span><span class="op" id="4329051">[</span><span class="op" id="4329052">]</span><span class="op" id="4329053">*</span><span class="ident" id="4329054">Certificate</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329068">childChains</span><span class="op" id="4329079">,</span>&nbsp;<span class="ident" id="4329081">ok</span>&nbsp;<span class="op" id="4329084">:=</span>&nbsp;<span class="ident" id="4329087">cache</span><span class="op" id="4329092">[</span><span class="ident" id="4329093">intermediateNum</span><span class="op" id="4329108">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329112">if</span>&nbsp;<span class="op" id="4329115">!</span><span class="ident" id="4329116">ok</span>&nbsp;<span class="op" id="4329119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329124">childChains</span><span class="op" id="4329135">,</span>&nbsp;<span class="ident" id="4329137">err</span>&nbsp;<span class="op" id="4329141">=</span>&nbsp;<span class="ident" id="4329143">intermediate</span><span class="op" id="4329155">.</span><span class="ident" id="4329156">buildChains</span><span class="op" id="4329167">(</span><span class="ident" id="4329168">cache</span><span class="op" id="4329173">,</span>&nbsp;<span class="ident" id="4329175">appendToFreshChain</span><span class="op" id="4329193">(</span><span class="ident" id="4329194">currentChain</span><span class="op" id="4329206">,</span>&nbsp;<span class="ident" id="4329208">intermediate</span><span class="op" id="4329220">)</span><span class="op" id="4329221">,</span>&nbsp;<span class="ident" id="4329223">opts</span><span class="op" id="4329227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329232">cache</span><span class="op" id="4329237">[</span><span class="ident" id="4329238">intermediateNum</span><span class="op" id="4329253">]</span>&nbsp;<span class="op" id="4329255">=</span>&nbsp;<span class="ident" id="4329257">childChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329271">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329275">chains</span>&nbsp;<span class="op" id="4329282">=</span>&nbsp;<span class="builtinfunc" id="4329284">append</span><span class="op" id="4329290">(</span><span class="ident" id="4329291">chains</span><span class="op" id="4329297">,</span>&nbsp;<span class="ident" id="4329299">childChains</span><span class="op" id="4329310">...</span><span class="op" id="4329313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329320">if</span>&nbsp;<span class="builtinfunc" id="4329323">len</span><span class="op" id="4329326">(</span><span class="ident" id="4329327">chains</span><span class="op" id="4329333">)</span>&nbsp;<span class="op" id="4329335">&gt;</span>&nbsp;<span class="num" id="4329337">0</span>&nbsp;<span class="op" id="4329339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329343">err</span>&nbsp;<span class="op" id="4329347">=</span>&nbsp;<span class="ident" id="4329349">nil</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329358">if</span>&nbsp;<span class="builtinfunc" id="4329361">len</span><span class="op" id="4329364">(</span><span class="ident" id="4329365">chains</span><span class="op" id="4329371">)</span>&nbsp;<span class="op" id="4329373">==</span>&nbsp;<span class="num" id="4329376">0</span>&nbsp;<span class="op" id="4329378">&amp;&amp;</span>&nbsp;<span class="ident" id="4329381">err</span>&nbsp;<span class="op" id="4329385">==</span>&nbsp;<span class="ident" id="4329388">nil</span>&nbsp;<span class="op" id="4329392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329396">hintErr</span>&nbsp;<span class="op" id="4329404">:=</span>&nbsp;<span class="ident" id="4329407">rootErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329417">hintCert</span>&nbsp;<span class="op" id="4329426">:=</span>&nbsp;<span class="ident" id="4329429">failedRoot</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329442">if</span>&nbsp;<span class="ident" id="4329445">hintErr</span>&nbsp;<span class="op" id="4329453">==</span>&nbsp;<span class="ident" id="4329456">nil</span>&nbsp;<span class="op" id="4329460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329465">hintErr</span>&nbsp;<span class="op" id="4329473">=</span>&nbsp;<span class="ident" id="4329475">intermediateErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329494">hintCert</span>&nbsp;<span class="op" id="4329503">=</span>&nbsp;<span class="ident" id="4329505">failedIntermediate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329530">err</span>&nbsp;<span class="op" id="4329534">=</span>&nbsp;<span class="ident" id="4329536">UnknownAuthorityError</span><span class="op" id="4329557">{</span><span class="ident" id="4329558">c</span><span class="op" id="4329559">,</span>&nbsp;<span class="ident" id="4329561">hintErr</span><span class="op" id="4329568">,</span>&nbsp;<span class="ident" id="4329570">hintCert</span><span class="op" id="4329578">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329585">return</span><br>
<span class="lineno"></span><span class="op" id="4329592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="keyword" id="4329595">func</span>&nbsp;<span class="ident" id="4329600">matchHostnames</span><span class="op" id="4329614">(</span><span class="ident" id="4329615">pattern</span><span class="op" id="4329622">,</span>&nbsp;<span class="ident" id="4329624">host</span>&nbsp;<span class="builtintype" id="4329629">string</span><span class="op" id="4329635">)</span>&nbsp;<span class="builtintype" id="4329637">bool</span>&nbsp;<span class="op" id="4329642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329645">if</span>&nbsp;<span class="builtinfunc" id="4329648">len</span><span class="op" id="4329651">(</span><span class="ident" id="4329652">pattern</span><span class="op" id="4329659">)</span>&nbsp;<span class="op" id="4329661">==</span>&nbsp;<span class="num" id="4329664">0</span>&nbsp;<span class="op" id="4329666">||</span>&nbsp;<span class="builtinfunc" id="4329669">len</span><span class="op" id="4329672">(</span><span class="ident" id="4329673">host</span><span class="op" id="4329677">)</span>&nbsp;<span class="op" id="4329679">==</span>&nbsp;<span class="num" id="4329682">0</span>&nbsp;<span class="op" id="4329684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329688">return</span>&nbsp;<span class="builtintype" id="4329695">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329706">patternParts</span>&nbsp;<span class="op" id="4329719">:=</span>&nbsp;<span class="ident" id="4329722">strings</span><span class="op" id="4329729">.</span><span class="ident" id="4329730">Split</span><span class="op" id="4329735">(</span><span class="ident" id="4329736">pattern</span><span class="op" id="4329743">,</span>&nbsp;<span class="string" id="4329745">&#34;.&#34;</span><span class="op" id="4329748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4329751">hostParts</span>&nbsp;<span class="op" id="4329761">:=</span>&nbsp;<span class="ident" id="4329764">strings</span><span class="op" id="4329771">.</span><span class="ident" id="4329772">Split</span><span class="op" id="4329777">(</span><span class="ident" id="4329778">host</span><span class="op" id="4329782">,</span>&nbsp;<span class="string" id="4329784">&#34;.&#34;</span><span class="op" id="4329787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329791">if</span>&nbsp;<span class="builtinfunc" id="4329794">len</span><span class="op" id="4329797">(</span><span class="ident" id="4329798">patternParts</span><span class="op" id="4329810">)</span>&nbsp;<span class="op" id="4329812">!=</span>&nbsp;<span class="builtinfunc" id="4329815">len</span><span class="op" id="4329818">(</span><span class="ident" id="4329819">hostParts</span><span class="op" id="4329828">)</span>&nbsp;<span class="op" id="4329830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329834">return</span>&nbsp;<span class="builtintype" id="4329841">false</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329852">for</span>&nbsp;<span class="ident" id="4329856">i</span><span class="op" id="4329857">,</span>&nbsp;<span class="ident" id="4329859">patternPart</span>&nbsp;<span class="op" id="4329871">:=</span>&nbsp;<span class="keyword" id="4329874">range</span>&nbsp;<span class="ident" id="4329880">patternParts</span>&nbsp;<span class="op" id="4329893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329897">if</span>&nbsp;<span class="ident" id="4329900">patternPart</span>&nbsp;<span class="op" id="4329912">==</span>&nbsp;<span class="string" id="4329915">&#34;*&#34;</span>&nbsp;<span class="op" id="4329919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329924">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329939">if</span>&nbsp;<span class="ident" id="4329942">patternPart</span>&nbsp;<span class="op" id="4329954">!=</span>&nbsp;<span class="ident" id="4329957">hostParts</span><span class="op" id="4329966">[</span><span class="ident" id="4329967">i</span><span class="op" id="4329968">]</span>&nbsp;<span class="op" id="4329970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329975">return</span>&nbsp;<span class="builtintype" id="4329982">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4329993">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4329997">return</span>&nbsp;<span class="builtintype" id="4330004">true</span><br>
<span class="lineno"></span><span class="op" id="4330009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4330012">//&nbsp;toLowerCaseASCII&nbsp;returns&nbsp;a&nbsp;lower-case&nbsp;version&nbsp;of&nbsp;in.&nbsp;See&nbsp;RFC&nbsp;6125&nbsp;6.4.1.&nbsp;We&nbsp;use</span><br>
<span class="lineno">350</span><span class="comment" id="4330095">//&nbsp;an&nbsp;explicitly&nbsp;ASCII&nbsp;function&nbsp;to&nbsp;avoid&nbsp;any&nbsp;sharp&nbsp;corners&nbsp;resulting&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4330169">//&nbsp;performing&nbsp;Unicode&nbsp;operations&nbsp;on&nbsp;DNS&nbsp;labels.</span><br>
<span class="lineno"></span><span class="keyword" id="4330217">func</span>&nbsp;<span class="ident" id="4330222">toLowerCaseASCII</span><span class="op" id="4330238">(</span><span class="ident" id="4330239">in</span>&nbsp;<span class="builtintype" id="4330242">string</span><span class="op" id="4330248">)</span>&nbsp;<span class="builtintype" id="4330250">string</span>&nbsp;<span class="op" id="4330257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330260">//&nbsp;If&nbsp;the&nbsp;string&nbsp;is&nbsp;already&nbsp;lower-case&nbsp;then&nbsp;there&#39;s&nbsp;nothing&nbsp;to&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330328">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4330347">:=</span>&nbsp;<span class="builtintype" id="4330350">true</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330356">for</span>&nbsp;<span class="ident" id="4330360">_</span><span class="op" id="4330361">,</span>&nbsp;<span class="ident" id="4330363">c</span>&nbsp;<span class="op" id="4330365">:=</span>&nbsp;<span class="keyword" id="4330368">range</span>&nbsp;<span class="ident" id="4330374">in</span>&nbsp;<span class="op" id="4330377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330381">if</span>&nbsp;<span class="ident" id="4330384">c</span>&nbsp;<span class="op" id="4330386">==</span>&nbsp;<span class="ident" id="4330389">utf8</span><span class="op" id="4330393">.</span><span class="ident" id="4330394">RuneError</span>&nbsp;<span class="op" id="4330404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330409">//&nbsp;If&nbsp;we&nbsp;get&nbsp;a&nbsp;UTF-8&nbsp;error&nbsp;then&nbsp;there&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330459">//&nbsp;upper-case&nbsp;ASCII&nbsp;bytes&nbsp;in&nbsp;the&nbsp;invalid&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330513">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4330532">=</span>&nbsp;<span class="builtintype" id="4330534">false</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330543">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330555">if</span>&nbsp;<span class="string" id="4330558">&#39;A&#39;</span>&nbsp;<span class="op" id="4330562">&lt;=</span>&nbsp;<span class="ident" id="4330565">c</span>&nbsp;<span class="op" id="4330567">&amp;&amp;</span>&nbsp;<span class="ident" id="4330570">c</span>&nbsp;<span class="op" id="4330572">&lt;=</span>&nbsp;<span class="string" id="4330575">&#39;Z&#39;</span>&nbsp;<span class="op" id="4330579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330584">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4330603">=</span>&nbsp;<span class="builtintype" id="4330605">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330614">break</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330629">if</span>&nbsp;<span class="ident" id="4330632">isAlreadyLowerCase</span>&nbsp;<span class="op" id="4330651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330655">return</span>&nbsp;<span class="ident" id="4330662">in</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330670">out</span>&nbsp;<span class="op" id="4330674">:=</span>&nbsp;<span class="op" id="4330677">[</span><span class="op" id="4330678">]</span><span class="builtintype" id="4330679">byte</span><span class="op" id="4330683">(</span><span class="ident" id="4330684">in</span><span class="op" id="4330686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330689">for</span>&nbsp;<span class="ident" id="4330693">i</span><span class="op" id="4330694">,</span>&nbsp;<span class="ident" id="4330696">c</span>&nbsp;<span class="op" id="4330698">:=</span>&nbsp;<span class="keyword" id="4330701">range</span>&nbsp;<span class="ident" id="4330707">out</span>&nbsp;<span class="op" id="4330711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330715">if</span>&nbsp;<span class="string" id="4330718">&#39;A&#39;</span>&nbsp;<span class="op" id="4330722">&lt;=</span>&nbsp;<span class="ident" id="4330725">c</span>&nbsp;<span class="op" id="4330727">&amp;&amp;</span>&nbsp;<span class="ident" id="4330730">c</span>&nbsp;<span class="op" id="4330732">&lt;=</span>&nbsp;<span class="string" id="4330735">&#39;Z&#39;</span>&nbsp;<span class="op" id="4330739">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4330744">out</span><span class="op" id="4330747">[</span><span class="ident" id="4330748">i</span><span class="op" id="4330749">]</span>&nbsp;<span class="op" id="4330751">+=</span>&nbsp;<span class="string" id="4330754">&#39;a&#39;</span>&nbsp;<span class="op" id="4330758">-</span>&nbsp;<span class="string" id="4330760">&#39;A&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4330769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4330772">return</span>&nbsp;<span class="builtintype" id="4330779">string</span><span class="op" id="4330785">(</span><span class="ident" id="4330786">out</span><span class="op" id="4330789">)</span><br>
<span class="lineno"></span><span class="op" id="4330791">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="4330794">//&nbsp;VerifyHostname&nbsp;returns&nbsp;nil&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;valid&nbsp;certificate&nbsp;for&nbsp;the&nbsp;named&nbsp;host.</span><br>
<span class="lineno"></span><span class="comment" id="4330872">//&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;an&nbsp;error&nbsp;describing&nbsp;the&nbsp;mismatch.</span><br>
<span class="lineno"></span><span class="keyword" id="4330930">func</span>&nbsp;<span class="op" id="4330935">(</span><span class="ident" id="4330936">c</span>&nbsp;<span class="op" id="4330938">*</span><span class="ident" id="4330939">Certificate</span><span class="op" id="4330950">)</span>&nbsp;<span class="ident" id="4330952">VerifyHostname</span><span class="op" id="4330966">(</span><span class="ident" id="4330967">h</span>&nbsp;<span class="builtintype" id="4330969">string</span><span class="op" id="4330975">)</span>&nbsp;<span class="builtintype" id="4330977">error</span>&nbsp;<span class="op" id="4330983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4330986">//&nbsp;IP&nbsp;addresses&nbsp;may&nbsp;be&nbsp;written&nbsp;in&nbsp;[&nbsp;].</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331026">candidateIP</span>&nbsp;<span class="op" id="4331038">:=</span>&nbsp;<span class="ident" id="4331041">h</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331044">if</span>&nbsp;<span class="builtinfunc" id="4331047">len</span><span class="op" id="4331050">(</span><span class="ident" id="4331051">h</span><span class="op" id="4331052">)</span>&nbsp;<span class="op" id="4331054">&gt;=</span>&nbsp;<span class="num" id="4331057">3</span>&nbsp;<span class="op" id="4331059">&amp;&amp;</span>&nbsp;<span class="ident" id="4331062">h</span><span class="op" id="4331063">[</span><span class="num" id="4331064">0</span><span class="op" id="4331065">]</span>&nbsp;<span class="op" id="4331067">==</span>&nbsp;<span class="string" id="4331070">&#39;[&#39;</span>&nbsp;<span class="op" id="4331074">&amp;&amp;</span>&nbsp;<span class="ident" id="4331077">h</span><span class="op" id="4331078">[</span><span class="builtinfunc" id="4331079">len</span><span class="op" id="4331082">(</span><span class="ident" id="4331083">h</span><span class="op" id="4331084">)</span><span class="op" id="4331085">-</span><span class="num" id="4331086">1</span><span class="op" id="4331087">]</span>&nbsp;<span class="op" id="4331089">==</span>&nbsp;<span class="string" id="4331092">&#39;]&#39;</span>&nbsp;<span class="op" id="4331096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331100">candidateIP</span>&nbsp;<span class="op" id="4331112">=</span>&nbsp;<span class="ident" id="4331114">h</span><span class="op" id="4331115">[</span><span class="num" id="4331116">1</span>&nbsp;<span class="op" id="4331118">:</span>&nbsp;<span class="builtinfunc" id="4331120">len</span><span class="op" id="4331123">(</span><span class="ident" id="4331124">h</span><span class="op" id="4331125">)</span><span class="op" id="4331126">-</span><span class="num" id="4331127">1</span><span class="op" id="4331128">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331134">if</span>&nbsp;<span class="ident" id="4331137">ip</span>&nbsp;<span class="op" id="4331140">:=</span>&nbsp;<span class="ident" id="4331143">net</span><span class="op" id="4331146">.</span><span class="ident" id="4331147">ParseIP</span><span class="op" id="4331154">(</span><span class="ident" id="4331155">candidateIP</span><span class="op" id="4331166">)</span><span class="op" id="4331167">;</span>&nbsp;<span class="ident" id="4331169">ip</span>&nbsp;<span class="op" id="4331172">!=</span>&nbsp;<span class="ident" id="4331175">nil</span>&nbsp;<span class="op" id="4331179">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331183">//&nbsp;We&nbsp;only&nbsp;match&nbsp;IP&nbsp;addresses&nbsp;against&nbsp;IP&nbsp;SANs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331232">//&nbsp;https://tools.ietf.org/html/rfc6125#appendix-B.2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331286">for</span>&nbsp;<span class="ident" id="4331290">_</span><span class="op" id="4331291">,</span>&nbsp;<span class="ident" id="4331293">candidate</span>&nbsp;<span class="op" id="4331303">:=</span>&nbsp;<span class="keyword" id="4331306">range</span>&nbsp;<span class="ident" id="4331312">c</span><span class="op" id="4331313">.</span><span class="ident" id="4331314">IPAddresses</span>&nbsp;<span class="op" id="4331326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331331">if</span>&nbsp;<span class="ident" id="4331334">ip</span><span class="op" id="4331336">.</span><span class="ident" id="4331337">Equal</span><span class="op" id="4331342">(</span><span class="ident" id="4331343">candidate</span><span class="op" id="4331352">)</span>&nbsp;<span class="op" id="4331354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331360">return</span>&nbsp;<span class="ident" id="4331367">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331382">return</span>&nbsp;<span class="ident" id="4331389">HostnameError</span><span class="op" id="4331402">{</span><span class="ident" id="4331403">c</span><span class="op" id="4331404">,</span>&nbsp;<span class="ident" id="4331406">candidateIP</span><span class="op" id="4331417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331424">lowered</span>&nbsp;<span class="op" id="4331432">:=</span>&nbsp;<span class="ident" id="4331435">toLowerCaseASCII</span><span class="op" id="4331451">(</span><span class="ident" id="4331452">h</span><span class="op" id="4331453">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331457">if</span>&nbsp;<span class="builtinfunc" id="4331460">len</span><span class="op" id="4331463">(</span><span class="ident" id="4331464">c</span><span class="op" id="4331465">.</span><span class="ident" id="4331466">DNSNames</span><span class="op" id="4331474">)</span>&nbsp;<span class="op" id="4331476">&gt;</span>&nbsp;<span class="num" id="4331478">0</span>&nbsp;<span class="op" id="4331480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331484">for</span>&nbsp;<span class="ident" id="4331488">_</span><span class="op" id="4331489">,</span>&nbsp;<span class="ident" id="4331491">match</span>&nbsp;<span class="op" id="4331497">:=</span>&nbsp;<span class="keyword" id="4331500">range</span>&nbsp;<span class="ident" id="4331506">c</span><span class="op" id="4331507">.</span><span class="ident" id="4331508">DNSNames</span>&nbsp;<span class="op" id="4331517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331522">if</span>&nbsp;<span class="ident" id="4331525">matchHostnames</span><span class="op" id="4331539">(</span><span class="ident" id="4331540">toLowerCaseASCII</span><span class="op" id="4331556">(</span><span class="ident" id="4331557">match</span><span class="op" id="4331562">)</span><span class="op" id="4331563">,</span>&nbsp;<span class="ident" id="4331565">lowered</span><span class="op" id="4331572">)</span>&nbsp;<span class="op" id="4331574">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331580">return</span>&nbsp;<span class="ident" id="4331587">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4331602">//&nbsp;If&nbsp;Subject&nbsp;Alt&nbsp;Name&nbsp;is&nbsp;given,&nbsp;we&nbsp;ignore&nbsp;the&nbsp;common&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331663">}</span>&nbsp;<span class="keyword" id="4331665">else</span>&nbsp;<span class="keyword" id="4331670">if</span>&nbsp;<span class="ident" id="4331673">matchHostnames</span><span class="op" id="4331687">(</span><span class="ident" id="4331688">toLowerCaseASCII</span><span class="op" id="4331704">(</span><span class="ident" id="4331705">c</span><span class="op" id="4331706">.</span><span class="ident" id="4331707">Subject</span><span class="op" id="4331714">.</span><span class="ident" id="4331715">CommonName</span><span class="op" id="4331725">)</span><span class="op" id="4331726">,</span>&nbsp;<span class="ident" id="4331728">lowered</span><span class="op" id="4331735">)</span>&nbsp;<span class="op" id="4331737">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331741">return</span>&nbsp;<span class="ident" id="4331748">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331757">return</span>&nbsp;<span class="ident" id="4331764">HostnameError</span><span class="op" id="4331777">{</span><span class="ident" id="4331778">c</span><span class="op" id="4331779">,</span>&nbsp;<span class="ident" id="4331781">h</span><span class="op" id="4331782">}</span><br>
<span class="lineno"></span><span class="op" id="4331784">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword" id="4331787">func</span>&nbsp;<span class="ident" id="4331792">checkChainForKeyUsage</span><span class="op" id="4331813">(</span><span class="ident" id="4331814">chain</span>&nbsp;<span class="op" id="4331820">[</span><span class="op" id="4331821">]</span><span class="op" id="4331822">*</span><span class="ident" id="4331823">Certificate</span><span class="op" id="4331834">,</span>&nbsp;<span class="ident" id="4331836">keyUsages</span>&nbsp;<span class="op" id="4331846">[</span><span class="op" id="4331847">]</span><span class="ident" id="4331848">ExtKeyUsage</span><span class="op" id="4331859">)</span>&nbsp;<span class="builtintype" id="4331861">bool</span>&nbsp;<span class="op" id="4331866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331869">usages</span>&nbsp;<span class="op" id="4331876">:=</span>&nbsp;<span class="builtinfunc" id="4331879">make</span><span class="op" id="4331883">(</span><span class="op" id="4331884">[</span><span class="op" id="4331885">]</span><span class="ident" id="4331886">ExtKeyUsage</span><span class="op" id="4331897">,</span>&nbsp;<span class="builtinfunc" id="4331899">len</span><span class="op" id="4331902">(</span><span class="ident" id="4331903">keyUsages</span><span class="op" id="4331912">)</span><span class="op" id="4331913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4331916">copy</span><span class="op" id="4331920">(</span><span class="ident" id="4331921">usages</span><span class="op" id="4331927">,</span>&nbsp;<span class="ident" id="4331929">keyUsages</span><span class="op" id="4331938">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331942">if</span>&nbsp;<span class="builtinfunc" id="4331945">len</span><span class="op" id="4331948">(</span><span class="ident" id="4331949">chain</span><span class="op" id="4331954">)</span>&nbsp;<span class="op" id="4331956">==</span>&nbsp;<span class="num" id="4331959">0</span>&nbsp;<span class="op" id="4331961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4331965">return</span>&nbsp;<span class="builtintype" id="4331972">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4331979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4331983">usagesRemaining</span>&nbsp;<span class="op" id="4331999">:=</span>&nbsp;<span class="builtinfunc" id="4332002">len</span><span class="op" id="4332005">(</span><span class="ident" id="4332006">usages</span><span class="op" id="4332012">)</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4332016">//&nbsp;We&nbsp;walk&nbsp;down&nbsp;the&nbsp;list&nbsp;and&nbsp;cross&nbsp;out&nbsp;any&nbsp;usages&nbsp;that&nbsp;aren&#39;t&nbsp;supported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4332089">//&nbsp;by&nbsp;each&nbsp;certificate.&nbsp;If&nbsp;we&nbsp;cross&nbsp;out&nbsp;all&nbsp;the&nbsp;usages,&nbsp;then&nbsp;the&nbsp;chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4332161">//&nbsp;is&nbsp;unacceptable.</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="ident" id="4332182">NextCert</span><span class="op" id="4332190">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332193">for</span>&nbsp;<span class="ident" id="4332197">i</span>&nbsp;<span class="op" id="4332199">:=</span>&nbsp;<span class="builtinfunc" id="4332202">len</span><span class="op" id="4332205">(</span><span class="ident" id="4332206">chain</span><span class="op" id="4332211">)</span>&nbsp;<span class="op" id="4332213">-</span>&nbsp;<span class="num" id="4332215">1</span><span class="op" id="4332216">;</span>&nbsp;<span class="ident" id="4332218">i</span>&nbsp;<span class="op" id="4332220">&gt;=</span>&nbsp;<span class="num" id="4332223">0</span><span class="op" id="4332224">;</span>&nbsp;<span class="ident" id="4332226">i</span><span class="op" id="4332227">--</span>&nbsp;<span class="op" id="4332230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332234">cert</span>&nbsp;<span class="op" id="4332239">:=</span>&nbsp;<span class="ident" id="4332242">chain</span><span class="op" id="4332247">[</span><span class="ident" id="4332248">i</span><span class="op" id="4332249">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332253">if</span>&nbsp;<span class="builtinfunc" id="4332256">len</span><span class="op" id="4332259">(</span><span class="ident" id="4332260">cert</span><span class="op" id="4332264">.</span><span class="ident" id="4332265">ExtKeyUsage</span><span class="op" id="4332276">)</span>&nbsp;<span class="op" id="4332278">==</span>&nbsp;<span class="num" id="4332281">0</span>&nbsp;<span class="op" id="4332283">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4332286">len</span><span class="op" id="4332289">(</span><span class="ident" id="4332290">cert</span><span class="op" id="4332294">.</span><span class="ident" id="4332295">UnknownExtKeyUsage</span><span class="op" id="4332313">)</span>&nbsp;<span class="op" id="4332315">==</span>&nbsp;<span class="num" id="4332318">0</span>&nbsp;<span class="op" id="4332320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4332325">//&nbsp;The&nbsp;certificate&nbsp;doesn&#39;t&nbsp;have&nbsp;any&nbsp;extended&nbsp;key&nbsp;usage&nbsp;specified.</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332410">for</span>&nbsp;<span class="ident" id="4332414">_</span><span class="op" id="4332415">,</span>&nbsp;<span class="ident" id="4332417">usage</span>&nbsp;<span class="op" id="4332423">:=</span>&nbsp;<span class="keyword" id="4332426">range</span>&nbsp;<span class="ident" id="4332432">cert</span><span class="op" id="4332436">.</span><span class="ident" id="4332437">ExtKeyUsage</span>&nbsp;<span class="op" id="4332449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332454">if</span>&nbsp;<span class="ident" id="4332457">usage</span>&nbsp;<span class="op" id="4332463">==</span>&nbsp;<span class="ident" id="4332466">ExtKeyUsageAny</span>&nbsp;<span class="op" id="4332481">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4332487">//&nbsp;The&nbsp;certificate&nbsp;is&nbsp;explicitly&nbsp;good&nbsp;for&nbsp;any&nbsp;usage.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332544">continue</span>&nbsp;<span class="ident" id="4332553">NextCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332565">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332574">const</span>&nbsp;<span class="ident" id="4332580">invalidUsage</span>&nbsp;<span class="ident" id="4332593">ExtKeyUsage</span>&nbsp;<span class="op" id="4332605">=</span>&nbsp;<span class="op" id="4332607">-</span><span class="num" id="4332608">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332612">NextRequestedUsage</span><span class="op" id="4332630">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332634">for</span>&nbsp;<span class="ident" id="4332638">i</span><span class="op" id="4332639">,</span>&nbsp;<span class="ident" id="4332641">requestedUsage</span>&nbsp;<span class="op" id="4332656">:=</span>&nbsp;<span class="keyword" id="4332659">range</span>&nbsp;<span class="ident" id="4332665">usages</span>&nbsp;<span class="op" id="4332672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332677">if</span>&nbsp;<span class="ident" id="4332680">requestedUsage</span>&nbsp;<span class="op" id="4332695">==</span>&nbsp;<span class="ident" id="4332698">invalidUsage</span>&nbsp;<span class="op" id="4332711">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332717">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332735">for</span>&nbsp;<span class="ident" id="4332739">_</span><span class="op" id="4332740">,</span>&nbsp;<span class="ident" id="4332742">usage</span>&nbsp;<span class="op" id="4332748">:=</span>&nbsp;<span class="keyword" id="4332751">range</span>&nbsp;<span class="ident" id="4332757">cert</span><span class="op" id="4332761">.</span><span class="ident" id="4332762">ExtKeyUsage</span>&nbsp;<span class="op" id="4332774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332780">if</span>&nbsp;<span class="ident" id="4332783">requestedUsage</span>&nbsp;<span class="op" id="4332798">==</span>&nbsp;<span class="ident" id="4332801">usage</span>&nbsp;<span class="op" id="4332807">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4332814">continue</span>&nbsp;<span class="ident" id="4332823">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332846">}</span>&nbsp;<span class="keyword" id="4332848">else</span>&nbsp;<span class="keyword" id="4332853">if</span>&nbsp;<span class="ident" id="4332856">requestedUsage</span>&nbsp;<span class="op" id="4332871">==</span>&nbsp;<span class="ident" id="4332874">ExtKeyUsageServerAuth</span>&nbsp;<span class="op" id="4332896">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4332904">(</span><span class="ident" id="4332905">usage</span>&nbsp;<span class="op" id="4332911">==</span>&nbsp;<span class="ident" id="4332914">ExtKeyUsageNetscapeServerGatedCrypto</span>&nbsp;<span class="op" id="4332951">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4332960">usage</span>&nbsp;<span class="op" id="4332966">==</span>&nbsp;<span class="ident" id="4332969">ExtKeyUsageMicrosoftServerGatedCrypto</span><span class="op" id="4333006">)</span>&nbsp;<span class="op" id="4333008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4333015">//&nbsp;In&nbsp;order&nbsp;to&nbsp;support&nbsp;COMODO</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4333050">//&nbsp;certificate&nbsp;chains,&nbsp;we&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4333089">//&nbsp;accept&nbsp;Netscape&nbsp;or&nbsp;Microsoft&nbsp;SGC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4333130">//&nbsp;usages&nbsp;as&nbsp;equal&nbsp;to&nbsp;ServerAuth.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4333169">continue</span>&nbsp;<span class="ident" id="4333178">NextRequestedUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4333201">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4333206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4333212">usages</span><span class="op" id="4333218">[</span><span class="ident" id="4333219">i</span><span class="op" id="4333220">]</span>&nbsp;<span class="op" id="4333222">=</span>&nbsp;<span class="ident" id="4333224">invalidUsage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4333240">usagesRemaining</span><span class="op" id="4333255">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4333261">if</span>&nbsp;<span class="ident" id="4333264">usagesRemaining</span>&nbsp;<span class="op" id="4333280">==</span>&nbsp;<span class="num" id="4333283">0</span>&nbsp;<span class="op" id="4333285">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4333291">return</span>&nbsp;<span class="builtintype" id="4333298">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4333307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4333311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4333314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4333318">return</span>&nbsp;<span class="builtintype" id="4333325">true</span><br>
<span class="lineno"></span><span class="op" id="4333330">}</span>
</div>
</body>
</html>
