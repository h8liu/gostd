<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/jpeg</h2>
<ul>
<li><a href="/gostd/image/jpeg/dct_test.go.html">dct_test.go</a></li>
<li><a href="/gostd/image/jpeg/fdct.go.html">fdct.go</a></li>
<li><a href="/gostd/image/jpeg/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/image/jpeg/idct.go.html">idct.go</a></li>
<li><a href="/gostd/image/jpeg/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/jpeg/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/jpeg/scan.go.html">scan.go</a></li>
<li><a href="/gostd/image/jpeg/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/jpeg/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5926399">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5926454">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5926508">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5926559">package</span>&nbsp;<span class="ident" id="5926567">jpeg</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5926573">import</span>&nbsp;<span class="op" id="5926580">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5926583">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5926588">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="5926591">//&nbsp;maxCodeLength&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;bits&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="5926669">const</span>&nbsp;<span class="ident" id="5926675">maxCodeLength</span>&nbsp;<span class="op" id="5926689">=</span>&nbsp;<span class="num" id="5926691">16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5926695">//&nbsp;maxNCodes&nbsp;is&nbsp;the&nbsp;maximum&nbsp;(inclusive)&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;a&nbsp;Huffman&nbsp;tree.</span><br>
<span class="lineno">15</span><span class="keyword" id="5926770">const</span>&nbsp;<span class="ident" id="5926776">maxNCodes</span>&nbsp;<span class="op" id="5926786">=</span>&nbsp;<span class="num" id="5926788">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5926793">//&nbsp;lutSize&nbsp;is&nbsp;the&nbsp;log-2&nbsp;size&nbsp;of&nbsp;the&nbsp;Huffman&nbsp;decoder&#39;s&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span><span class="keyword" id="5926862">const</span>&nbsp;<span class="ident" id="5926868">lutSize</span>&nbsp;<span class="op" id="5926876">=</span>&nbsp;<span class="num" id="5926878">8</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5926881">//&nbsp;huffman&nbsp;is&nbsp;a&nbsp;Huffman&nbsp;decoder,&nbsp;specified&nbsp;in&nbsp;section&nbsp;C.</span><br>
<span class="lineno"></span><span class="keyword" id="5926938">type</span>&nbsp;<span class="ident" id="5926943">huffman</span>&nbsp;<span class="keyword" id="5926951">struct</span>&nbsp;<span class="op" id="5926958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5926961">//&nbsp;length&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;in&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927008">nCodes</span>&nbsp;<span class="builtintype" id="5927015">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927022">//&nbsp;lut&nbsp;is&nbsp;the&nbsp;look-up&nbsp;table&nbsp;for&nbsp;the&nbsp;next&nbsp;lutSize&nbsp;bits&nbsp;in&nbsp;the&nbsp;bit-stream.</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927096">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;the&nbsp;uint16&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.&nbsp;The&nbsp;low&nbsp;8&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927168">//&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;code&nbsp;length,&nbsp;or&nbsp;0&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;fit&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927241">//&nbsp;lutSize&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927259">lut</span>&nbsp;<span class="op" id="5927263">[</span><span class="num" id="5927264">1</span>&nbsp;<span class="op" id="5927266">&lt;&lt;</span>&nbsp;<span class="ident" id="5927269">lutSize</span><span class="op" id="5927276">]</span><span class="builtintype" id="5927277">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927285">//&nbsp;vals&nbsp;are&nbsp;the&nbsp;decoded&nbsp;values,&nbsp;sorted&nbsp;by&nbsp;their&nbsp;encoding.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927344">vals</span>&nbsp;<span class="op" id="5927349">[</span><span class="ident" id="5927350">maxNCodes</span><span class="op" id="5927359">]</span><span class="builtintype" id="5927360">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927367">//&nbsp;minCodes[i]&nbsp;is&nbsp;the&nbsp;minimum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927438">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927464">minCodes</span>&nbsp;<span class="op" id="5927473">[</span><span class="ident" id="5927474">maxCodeLength</span><span class="op" id="5927487">]</span><span class="builtintype" id="5927488">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927495">//&nbsp;maxCodes[i]&nbsp;is&nbsp;the&nbsp;maximum&nbsp;code&nbsp;of&nbsp;length&nbsp;i,&nbsp;or&nbsp;-1&nbsp;if&nbsp;there&nbsp;are&nbsp;no</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927566">//&nbsp;codes&nbsp;of&nbsp;that&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927592">maxCodes</span>&nbsp;<span class="op" id="5927601">[</span><span class="ident" id="5927602">maxCodeLength</span><span class="op" id="5927615">]</span><span class="builtintype" id="5927616">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5927623">//&nbsp;valsIndices[i]&nbsp;is&nbsp;the&nbsp;index&nbsp;into&nbsp;vals&nbsp;of&nbsp;minCodes[i].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5927681">valsIndices</span>&nbsp;<span class="op" id="5927693">[</span><span class="ident" id="5927694">maxCodeLength</span><span class="op" id="5927707">]</span><span class="builtintype" id="5927708">int32</span><br>
<span class="lineno"></span><span class="op" id="5927714">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5927717">//&nbsp;errShortHuffmanData&nbsp;means&nbsp;that&nbsp;an&nbsp;unexpected&nbsp;EOF&nbsp;occurred&nbsp;while&nbsp;decoding</span><br>
<span class="lineno"></span><span class="comment" id="5927793">//&nbsp;Huffman&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5927810">var</span>&nbsp;<span class="ident" id="5927814">errShortHuffmanData</span>&nbsp;<span class="op" id="5927834">=</span>&nbsp;<span class="ident" id="5927836">FormatError</span><span class="op" id="5927847">(</span><span class="string" id="5927848">&#34;short&nbsp;Huffman&nbsp;data&#34;</span><span class="op" id="5927868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5927871">//&nbsp;ensureNBits&nbsp;reads&nbsp;bytes&nbsp;from&nbsp;the&nbsp;byte&nbsp;buffer&nbsp;to&nbsp;ensure&nbsp;that&nbsp;d.bits.n&nbsp;is&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="5927949">//&nbsp;least&nbsp;n.&nbsp;For&nbsp;best&nbsp;performance&nbsp;(avoiding&nbsp;function&nbsp;calls&nbsp;inside&nbsp;hot&nbsp;loops),</span><br>
<span class="lineno"></span><span class="comment" id="5928026">//&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;responsible&nbsp;for&nbsp;first&nbsp;checking&nbsp;that&nbsp;d.bits.n&nbsp;&lt;&nbsp;n.</span><br>
<span class="lineno"></span><span class="keyword" id="5928101">func</span>&nbsp;<span class="op" id="5928106">(</span><span class="ident" id="5928107">d</span>&nbsp;<span class="op" id="5928109">*</span><span class="ident" id="5928110">decoder</span><span class="op" id="5928117">)</span>&nbsp;<span class="ident" id="5928119">ensureNBits</span><span class="op" id="5928130">(</span><span class="ident" id="5928131">n</span>&nbsp;<span class="builtintype" id="5928133">int32</span><span class="op" id="5928138">)</span>&nbsp;<span class="builtintype" id="5928140">error</span>&nbsp;<span class="op" id="5928146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928149">for</span>&nbsp;<span class="op" id="5928153">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928157">c</span><span class="op" id="5928158">,</span>&nbsp;<span class="ident" id="5928160">err</span>&nbsp;<span class="op" id="5928164">:=</span>&nbsp;<span class="ident" id="5928167">d</span><span class="op" id="5928168">.</span><span class="ident" id="5928169">readByteStuffedByte</span><span class="op" id="5928188">(</span><span class="op" id="5928189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928193">if</span>&nbsp;<span class="ident" id="5928196">err</span>&nbsp;<span class="op" id="5928200">!=</span>&nbsp;<span class="ident" id="5928203">nil</span>&nbsp;<span class="op" id="5928207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928212">if</span>&nbsp;<span class="ident" id="5928215">err</span>&nbsp;<span class="op" id="5928219">==</span>&nbsp;<span class="ident" id="5928222">io</span><span class="op" id="5928224">.</span><span class="ident" id="5928225">EOF</span>&nbsp;<span class="op" id="5928229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928235">return</span>&nbsp;<span class="ident" id="5928242">errShortHuffmanData</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928265">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928270">return</span>&nbsp;<span class="ident" id="5928277">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928283">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928287">d</span><span class="op" id="5928288">.</span><span class="ident" id="5928289">bits</span><span class="op" id="5928293">.</span><span class="ident" id="5928294">a</span>&nbsp;<span class="op" id="5928296">=</span>&nbsp;<span class="ident" id="5928298">d</span><span class="op" id="5928299">.</span><span class="ident" id="5928300">bits</span><span class="op" id="5928304">.</span><span class="ident" id="5928305">a</span><span class="op" id="5928306">&lt;&lt;</span><span class="num" id="5928308">8</span>&nbsp;<span class="op" id="5928310">|</span>&nbsp;<span class="builtintype" id="5928312">uint32</span><span class="op" id="5928318">(</span><span class="ident" id="5928319">c</span><span class="op" id="5928320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928324">d</span><span class="op" id="5928325">.</span><span class="ident" id="5928326">bits</span><span class="op" id="5928330">.</span><span class="ident" id="5928331">n</span>&nbsp;<span class="op" id="5928333">+=</span>&nbsp;<span class="num" id="5928336">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928340">if</span>&nbsp;<span class="ident" id="5928343">d</span><span class="op" id="5928344">.</span><span class="ident" id="5928345">bits</span><span class="op" id="5928349">.</span><span class="ident" id="5928350">m</span>&nbsp;<span class="op" id="5928352">==</span>&nbsp;<span class="num" id="5928355">0</span>&nbsp;<span class="op" id="5928357">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928362">d</span><span class="op" id="5928363">.</span><span class="ident" id="5928364">bits</span><span class="op" id="5928368">.</span><span class="ident" id="5928369">m</span>&nbsp;<span class="op" id="5928371">=</span>&nbsp;<span class="num" id="5928373">1</span>&nbsp;<span class="op" id="5928375">&lt;&lt;</span>&nbsp;<span class="num" id="5928378">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928382">}</span>&nbsp;<span class="keyword" id="5928384">else</span>&nbsp;<span class="op" id="5928389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928394">d</span><span class="op" id="5928395">.</span><span class="ident" id="5928396">bits</span><span class="op" id="5928400">.</span><span class="ident" id="5928401">m</span>&nbsp;<span class="op" id="5928403">&lt;&lt;=</span>&nbsp;<span class="num" id="5928407">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928415">if</span>&nbsp;<span class="ident" id="5928418">d</span><span class="op" id="5928419">.</span><span class="ident" id="5928420">bits</span><span class="op" id="5928424">.</span><span class="ident" id="5928425">n</span>&nbsp;<span class="op" id="5928427">&gt;=</span>&nbsp;<span class="ident" id="5928430">n</span>&nbsp;<span class="op" id="5928432">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928437">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928451">return</span>&nbsp;<span class="ident" id="5928458">nil</span><br>
<span class="lineno"></span><span class="op" id="5928462">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="5928465">//&nbsp;receiveExtend&nbsp;is&nbsp;the&nbsp;composition&nbsp;of&nbsp;RECEIVE&nbsp;and&nbsp;EXTEND,&nbsp;specified&nbsp;in&nbsp;section</span><br>
<span class="lineno"></span><span class="comment" id="5928545">//&nbsp;F.2.2.1.</span><br>
<span class="lineno"></span><span class="keyword" id="5928557">func</span>&nbsp;<span class="op" id="5928562">(</span><span class="ident" id="5928563">d</span>&nbsp;<span class="op" id="5928565">*</span><span class="ident" id="5928566">decoder</span><span class="op" id="5928573">)</span>&nbsp;<span class="ident" id="5928575">receiveExtend</span><span class="op" id="5928588">(</span><span class="ident" id="5928589">t</span>&nbsp;<span class="builtintype" id="5928591">uint8</span><span class="op" id="5928596">)</span>&nbsp;<span class="op" id="5928598">(</span><span class="builtintype" id="5928599">int32</span><span class="op" id="5928604">,</span>&nbsp;<span class="builtintype" id="5928606">error</span><span class="op" id="5928611">)</span>&nbsp;<span class="op" id="5928613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928616">if</span>&nbsp;<span class="ident" id="5928619">d</span><span class="op" id="5928620">.</span><span class="ident" id="5928621">bits</span><span class="op" id="5928625">.</span><span class="ident" id="5928626">n</span>&nbsp;<span class="op" id="5928628">&lt;</span>&nbsp;<span class="builtintype" id="5928630">int32</span><span class="op" id="5928635">(</span><span class="ident" id="5928636">t</span><span class="op" id="5928637">)</span>&nbsp;<span class="op" id="5928639">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928643">if</span>&nbsp;<span class="ident" id="5928646">err</span>&nbsp;<span class="op" id="5928650">:=</span>&nbsp;<span class="ident" id="5928653">d</span><span class="op" id="5928654">.</span><span class="ident" id="5928655">ensureNBits</span><span class="op" id="5928666">(</span><span class="builtintype" id="5928667">int32</span><span class="op" id="5928672">(</span><span class="ident" id="5928673">t</span><span class="op" id="5928674">)</span><span class="op" id="5928675">)</span><span class="op" id="5928676">;</span>&nbsp;<span class="ident" id="5928678">err</span>&nbsp;<span class="op" id="5928682">!=</span>&nbsp;<span class="ident" id="5928685">nil</span>&nbsp;<span class="op" id="5928689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928694">return</span>&nbsp;<span class="num" id="5928701">0</span><span class="op" id="5928702">,</span>&nbsp;<span class="ident" id="5928704">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928716">d</span><span class="op" id="5928717">.</span><span class="ident" id="5928718">bits</span><span class="op" id="5928722">.</span><span class="ident" id="5928723">n</span>&nbsp;<span class="op" id="5928725">-=</span>&nbsp;<span class="builtintype" id="5928728">int32</span><span class="op" id="5928733">(</span><span class="ident" id="5928734">t</span><span class="op" id="5928735">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928738">d</span><span class="op" id="5928739">.</span><span class="ident" id="5928740">bits</span><span class="op" id="5928744">.</span><span class="ident" id="5928745">m</span>&nbsp;<span class="op" id="5928747">&gt;&gt;=</span>&nbsp;<span class="ident" id="5928751">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928754">s</span>&nbsp;<span class="op" id="5928756">:=</span>&nbsp;<span class="builtintype" id="5928759">int32</span><span class="op" id="5928764">(</span><span class="num" id="5928765">1</span><span class="op" id="5928766">)</span>&nbsp;<span class="op" id="5928768">&lt;&lt;</span>&nbsp;<span class="ident" id="5928771">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928774">x</span>&nbsp;<span class="op" id="5928776">:=</span>&nbsp;<span class="builtintype" id="5928779">int32</span><span class="op" id="5928784">(</span><span class="ident" id="5928785">d</span><span class="op" id="5928786">.</span><span class="ident" id="5928787">bits</span><span class="op" id="5928791">.</span><span class="ident" id="5928792">a</span><span class="op" id="5928793">&gt;&gt;</span><span class="builtintype" id="5928795">uint8</span><span class="op" id="5928800">(</span><span class="ident" id="5928801">d</span><span class="op" id="5928802">.</span><span class="ident" id="5928803">bits</span><span class="op" id="5928807">.</span><span class="ident" id="5928808">n</span><span class="op" id="5928809">)</span><span class="op" id="5928810">)</span>&nbsp;<span class="op" id="5928812">&amp;</span>&nbsp;<span class="op" id="5928814">(</span><span class="ident" id="5928815">s</span>&nbsp;<span class="op" id="5928817">-</span>&nbsp;<span class="num" id="5928819">1</span><span class="op" id="5928820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928823">if</span>&nbsp;<span class="ident" id="5928826">x</span>&nbsp;<span class="op" id="5928828">&lt;</span>&nbsp;<span class="ident" id="5928830">s</span><span class="op" id="5928831">&gt;&gt;</span><span class="num" id="5928833">1</span>&nbsp;<span class="op" id="5928835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5928839">x</span>&nbsp;<span class="op" id="5928841">+=</span>&nbsp;<span class="op" id="5928844">(</span><span class="op" id="5928845">(</span><span class="op" id="5928846">-</span><span class="num" id="5928847">1</span><span class="op" id="5928848">)</span>&nbsp;<span class="op" id="5928850">&lt;&lt;</span>&nbsp;<span class="ident" id="5928853">t</span><span class="op" id="5928854">)</span>&nbsp;<span class="op" id="5928856">+</span>&nbsp;<span class="num" id="5928858">1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5928861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5928864">return</span>&nbsp;<span class="ident" id="5928871">x</span><span class="op" id="5928872">,</span>&nbsp;<span class="ident" id="5928874">nil</span><br>
<span class="lineno"></span><span class="op" id="5928878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5928881">//&nbsp;processDHT&nbsp;processes&nbsp;a&nbsp;Define&nbsp;Huffman&nbsp;Table&nbsp;marker,&nbsp;and&nbsp;initializes&nbsp;a&nbsp;huffman</span><br>
<span class="lineno">90</span><span class="comment" id="5928962">//&nbsp;struct&nbsp;from&nbsp;its&nbsp;contents.&nbsp;Specified&nbsp;in&nbsp;section&nbsp;B.2.4.2.</span><br>
<span class="lineno"></span><span class="keyword" id="5929021">func</span>&nbsp;<span class="op" id="5929026">(</span><span class="ident" id="5929027">d</span>&nbsp;<span class="op" id="5929029">*</span><span class="ident" id="5929030">decoder</span><span class="op" id="5929037">)</span>&nbsp;<span class="ident" id="5929039">processDHT</span><span class="op" id="5929049">(</span><span class="ident" id="5929050">n</span>&nbsp;<span class="builtintype" id="5929052">int</span><span class="op" id="5929055">)</span>&nbsp;<span class="builtintype" id="5929057">error</span>&nbsp;<span class="op" id="5929063">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929066">for</span>&nbsp;<span class="ident" id="5929070">n</span>&nbsp;<span class="op" id="5929072">&gt;</span>&nbsp;<span class="num" id="5929074">0</span>&nbsp;<span class="op" id="5929076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929080">if</span>&nbsp;<span class="ident" id="5929083">n</span>&nbsp;<span class="op" id="5929085">&lt;</span>&nbsp;<span class="num" id="5929087">17</span>&nbsp;<span class="op" id="5929090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929095">return</span>&nbsp;<span class="ident" id="5929102">FormatError</span><span class="op" id="5929113">(</span><span class="string" id="5929114">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5929136">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929144">if</span>&nbsp;<span class="ident" id="5929147">err</span>&nbsp;<span class="op" id="5929151">:=</span>&nbsp;<span class="ident" id="5929154">d</span><span class="op" id="5929155">.</span><span class="ident" id="5929156">readFull</span><span class="op" id="5929164">(</span><span class="ident" id="5929165">d</span><span class="op" id="5929166">.</span><span class="ident" id="5929167">tmp</span><span class="op" id="5929170">[</span><span class="op" id="5929171">:</span><span class="num" id="5929172">17</span><span class="op" id="5929174">]</span><span class="op" id="5929175">)</span><span class="op" id="5929176">;</span>&nbsp;<span class="ident" id="5929178">err</span>&nbsp;<span class="op" id="5929182">!=</span>&nbsp;<span class="ident" id="5929185">nil</span>&nbsp;<span class="op" id="5929189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929194">return</span>&nbsp;<span class="ident" id="5929201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929211">tc</span>&nbsp;<span class="op" id="5929214">:=</span>&nbsp;<span class="ident" id="5929217">d</span><span class="op" id="5929218">.</span><span class="ident" id="5929219">tmp</span><span class="op" id="5929222">[</span><span class="num" id="5929223">0</span><span class="op" id="5929224">]</span>&nbsp;<span class="op" id="5929226">&gt;&gt;</span>&nbsp;<span class="num" id="5929229">4</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929233">if</span>&nbsp;<span class="ident" id="5929236">tc</span>&nbsp;<span class="op" id="5929239">&gt;</span>&nbsp;<span class="ident" id="5929241">maxTc</span>&nbsp;<span class="op" id="5929247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929252">return</span>&nbsp;<span class="ident" id="5929259">FormatError</span><span class="op" id="5929270">(</span><span class="string" id="5929271">&#34;bad&nbsp;Tc&nbsp;value&#34;</span><span class="op" id="5929285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929293">th</span>&nbsp;<span class="op" id="5929296">:=</span>&nbsp;<span class="ident" id="5929299">d</span><span class="op" id="5929300">.</span><span class="ident" id="5929301">tmp</span><span class="op" id="5929304">[</span><span class="num" id="5929305">0</span><span class="op" id="5929306">]</span>&nbsp;<span class="op" id="5929308">&amp;</span>&nbsp;<span class="num" id="5929310">0x0f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929317">if</span>&nbsp;<span class="ident" id="5929320">th</span>&nbsp;<span class="op" id="5929323">&gt;</span>&nbsp;<span class="ident" id="5929325">maxTh</span>&nbsp;<span class="op" id="5929331">||</span>&nbsp;<span class="op" id="5929334">!</span><span class="ident" id="5929335">d</span><span class="op" id="5929336">.</span><span class="ident" id="5929337">progressive</span>&nbsp;<span class="op" id="5929349">&amp;&amp;</span>&nbsp;<span class="ident" id="5929352">th</span>&nbsp;<span class="op" id="5929355">&gt;</span>&nbsp;<span class="num" id="5929357">1</span>&nbsp;<span class="op" id="5929359">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929364">return</span>&nbsp;<span class="ident" id="5929371">FormatError</span><span class="op" id="5929382">(</span><span class="string" id="5929383">&#34;bad&nbsp;Th&nbsp;value&#34;</span><span class="op" id="5929397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929405">h</span>&nbsp;<span class="op" id="5929407">:=</span>&nbsp;<span class="op" id="5929410">&amp;</span><span class="ident" id="5929411">d</span><span class="op" id="5929412">.</span><span class="ident" id="5929413">huff</span><span class="op" id="5929417">[</span><span class="ident" id="5929418">tc</span><span class="op" id="5929420">]</span><span class="op" id="5929421">[</span><span class="ident" id="5929422">th</span><span class="op" id="5929424">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5929429">//&nbsp;Read&nbsp;nCodes&nbsp;and&nbsp;h.vals&nbsp;(and&nbsp;derive&nbsp;h.nCodes).</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5929480">//&nbsp;nCodes[i]&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;codes&nbsp;with&nbsp;code&nbsp;length&nbsp;i.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5929538">//&nbsp;h.nCodes&nbsp;is&nbsp;the&nbsp;total&nbsp;number&nbsp;of&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929582">h</span><span class="op" id="5929583">.</span><span class="ident" id="5929584">nCodes</span>&nbsp;<span class="op" id="5929591">=</span>&nbsp;<span class="num" id="5929593">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929597">var</span>&nbsp;<span class="ident" id="5929601">nCodes</span>&nbsp;<span class="op" id="5929608">[</span><span class="ident" id="5929609">maxCodeLength</span><span class="op" id="5929622">]</span><span class="builtintype" id="5929623">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929631">for</span>&nbsp;<span class="ident" id="5929635">i</span>&nbsp;<span class="op" id="5929637">:=</span>&nbsp;<span class="keyword" id="5929640">range</span>&nbsp;<span class="ident" id="5929646">nCodes</span>&nbsp;<span class="op" id="5929653">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929658">nCodes</span><span class="op" id="5929664">[</span><span class="ident" id="5929665">i</span><span class="op" id="5929666">]</span>&nbsp;<span class="op" id="5929668">=</span>&nbsp;<span class="builtintype" id="5929670">int32</span><span class="op" id="5929675">(</span><span class="ident" id="5929676">d</span><span class="op" id="5929677">.</span><span class="ident" id="5929678">tmp</span><span class="op" id="5929681">[</span><span class="ident" id="5929682">i</span><span class="op" id="5929683">+</span><span class="num" id="5929684">1</span><span class="op" id="5929685">]</span><span class="op" id="5929686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929691">h</span><span class="op" id="5929692">.</span><span class="ident" id="5929693">nCodes</span>&nbsp;<span class="op" id="5929700">+=</span>&nbsp;<span class="ident" id="5929703">nCodes</span><span class="op" id="5929709">[</span><span class="ident" id="5929710">i</span><span class="op" id="5929711">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929719">if</span>&nbsp;<span class="ident" id="5929722">h</span><span class="op" id="5929723">.</span><span class="ident" id="5929724">nCodes</span>&nbsp;<span class="op" id="5929731">==</span>&nbsp;<span class="num" id="5929734">0</span>&nbsp;<span class="op" id="5929736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929741">return</span>&nbsp;<span class="ident" id="5929748">FormatError</span><span class="op" id="5929759">(</span><span class="string" id="5929760">&#34;Huffman&nbsp;table&nbsp;has&nbsp;zero&nbsp;length&#34;</span><span class="op" id="5929791">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929799">if</span>&nbsp;<span class="ident" id="5929802">h</span><span class="op" id="5929803">.</span><span class="ident" id="5929804">nCodes</span>&nbsp;<span class="op" id="5929811">&gt;</span>&nbsp;<span class="ident" id="5929813">maxNCodes</span>&nbsp;<span class="op" id="5929823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929828">return</span>&nbsp;<span class="ident" id="5929835">FormatError</span><span class="op" id="5929846">(</span><span class="string" id="5929847">&#34;Huffman&nbsp;table&nbsp;has&nbsp;excessive&nbsp;length&#34;</span><span class="op" id="5929883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5929891">n</span>&nbsp;<span class="op" id="5929893">-=</span>&nbsp;<span class="builtintype" id="5929896">int</span><span class="op" id="5929899">(</span><span class="ident" id="5929900">h</span><span class="op" id="5929901">.</span><span class="ident" id="5929902">nCodes</span><span class="op" id="5929908">)</span>&nbsp;<span class="op" id="5929910">+</span>&nbsp;<span class="num" id="5929912">17</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929917">if</span>&nbsp;<span class="ident" id="5929920">n</span>&nbsp;<span class="op" id="5929922">&lt;</span>&nbsp;<span class="num" id="5929924">0</span>&nbsp;<span class="op" id="5929926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929931">return</span>&nbsp;<span class="ident" id="5929938">FormatError</span><span class="op" id="5929949">(</span><span class="string" id="5929950">&#34;DHT&nbsp;has&nbsp;wrong&nbsp;length&#34;</span><span class="op" id="5929972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5929976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5929980">if</span>&nbsp;<span class="ident" id="5929983">err</span>&nbsp;<span class="op" id="5929987">:=</span>&nbsp;<span class="ident" id="5929990">d</span><span class="op" id="5929991">.</span><span class="ident" id="5929992">readFull</span><span class="op" id="5930000">(</span><span class="ident" id="5930001">h</span><span class="op" id="5930002">.</span><span class="ident" id="5930003">vals</span><span class="op" id="5930007">[</span><span class="op" id="5930008">:</span><span class="ident" id="5930009">h</span><span class="op" id="5930010">.</span><span class="ident" id="5930011">nCodes</span><span class="op" id="5930017">]</span><span class="op" id="5930018">)</span><span class="op" id="5930019">;</span>&nbsp;<span class="ident" id="5930021">err</span>&nbsp;<span class="op" id="5930025">!=</span>&nbsp;<span class="ident" id="5930028">nil</span>&nbsp;<span class="op" id="5930032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930037">return</span>&nbsp;<span class="ident" id="5930044">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930055">//&nbsp;Derive&nbsp;the&nbsp;look-up&nbsp;table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930086">for</span>&nbsp;<span class="ident" id="5930090">i</span>&nbsp;<span class="op" id="5930092">:=</span>&nbsp;<span class="keyword" id="5930095">range</span>&nbsp;<span class="ident" id="5930101">h</span><span class="op" id="5930102">.</span><span class="ident" id="5930103">lut</span>&nbsp;<span class="op" id="5930107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930112">h</span><span class="op" id="5930113">.</span><span class="ident" id="5930114">lut</span><span class="op" id="5930117">[</span><span class="ident" id="5930118">i</span><span class="op" id="5930119">]</span>&nbsp;<span class="op" id="5930121">=</span>&nbsp;<span class="num" id="5930123">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930131">var</span>&nbsp;<span class="ident" id="5930135">x</span><span class="op" id="5930136">,</span>&nbsp;<span class="ident" id="5930138">code</span>&nbsp;<span class="builtintype" id="5930143">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930152">for</span>&nbsp;<span class="ident" id="5930156">i</span>&nbsp;<span class="op" id="5930158">:=</span>&nbsp;<span class="builtintype" id="5930161">uint32</span><span class="op" id="5930167">(</span><span class="num" id="5930168">0</span><span class="op" id="5930169">)</span><span class="op" id="5930170">;</span>&nbsp;<span class="ident" id="5930172">i</span>&nbsp;<span class="op" id="5930174">&lt;</span>&nbsp;<span class="ident" id="5930176">lutSize</span><span class="op" id="5930183">;</span>&nbsp;<span class="ident" id="5930185">i</span><span class="op" id="5930186">++</span>&nbsp;<span class="op" id="5930189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930194">code</span>&nbsp;<span class="op" id="5930199">&lt;&lt;=</span>&nbsp;<span class="num" id="5930203">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930208">for</span>&nbsp;<span class="ident" id="5930212">j</span>&nbsp;<span class="op" id="5930214">:=</span>&nbsp;<span class="builtintype" id="5930217">int32</span><span class="op" id="5930222">(</span><span class="num" id="5930223">0</span><span class="op" id="5930224">)</span><span class="op" id="5930225">;</span>&nbsp;<span class="ident" id="5930227">j</span>&nbsp;<span class="op" id="5930229">&lt;</span>&nbsp;<span class="ident" id="5930231">nCodes</span><span class="op" id="5930237">[</span><span class="ident" id="5930238">i</span><span class="op" id="5930239">]</span><span class="op" id="5930240">;</span>&nbsp;<span class="ident" id="5930242">j</span><span class="op" id="5930243">++</span>&nbsp;<span class="op" id="5930246">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930252">//&nbsp;The&nbsp;codeLength&nbsp;is&nbsp;1+i,&nbsp;so&nbsp;shift&nbsp;code&nbsp;by&nbsp;8-(1+i)&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930310">//&nbsp;calculate&nbsp;the&nbsp;high&nbsp;bits&nbsp;for&nbsp;every&nbsp;8-bit&nbsp;sequence</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930366">//&nbsp;whose&nbsp;codeLength&#39;s&nbsp;high&nbsp;bits&nbsp;matches&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930416">//&nbsp;The&nbsp;high&nbsp;8&nbsp;bits&nbsp;of&nbsp;lutValue&nbsp;are&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930474">//&nbsp;The&nbsp;low&nbsp;8&nbsp;bits&nbsp;are&nbsp;1&nbsp;plus&nbsp;the&nbsp;codeLength.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930523">base</span>&nbsp;<span class="op" id="5930528">:=</span>&nbsp;<span class="builtintype" id="5930531">uint8</span><span class="op" id="5930536">(</span><span class="ident" id="5930537">code</span>&nbsp;<span class="op" id="5930542">&lt;&lt;</span>&nbsp;<span class="op" id="5930545">(</span><span class="num" id="5930546">7</span>&nbsp;<span class="op" id="5930548">-</span>&nbsp;<span class="ident" id="5930550">i</span><span class="op" id="5930551">)</span><span class="op" id="5930552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930558">lutValue</span>&nbsp;<span class="op" id="5930567">:=</span>&nbsp;<span class="builtintype" id="5930570">uint16</span><span class="op" id="5930576">(</span><span class="ident" id="5930577">h</span><span class="op" id="5930578">.</span><span class="ident" id="5930579">vals</span><span class="op" id="5930583">[</span><span class="ident" id="5930584">x</span><span class="op" id="5930585">]</span><span class="op" id="5930586">)</span><span class="op" id="5930587">&lt;&lt;</span><span class="num" id="5930589">8</span>&nbsp;<span class="op" id="5930591">|</span>&nbsp;<span class="builtintype" id="5930593">uint16</span><span class="op" id="5930599">(</span><span class="num" id="5930600">2</span><span class="op" id="5930601">+</span><span class="ident" id="5930602">i</span><span class="op" id="5930603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930609">for</span>&nbsp;<span class="ident" id="5930613">k</span>&nbsp;<span class="op" id="5930615">:=</span>&nbsp;<span class="builtintype" id="5930618">uint8</span><span class="op" id="5930623">(</span><span class="num" id="5930624">0</span><span class="op" id="5930625">)</span><span class="op" id="5930626">;</span>&nbsp;<span class="ident" id="5930628">k</span>&nbsp;<span class="op" id="5930630">&lt;</span>&nbsp;<span class="num" id="5930632">1</span><span class="op" id="5930633">&lt;&lt;</span><span class="op" id="5930635">(</span><span class="num" id="5930636">7</span><span class="op" id="5930637">-</span><span class="ident" id="5930638">i</span><span class="op" id="5930639">)</span><span class="op" id="5930640">;</span>&nbsp;<span class="ident" id="5930642">k</span><span class="op" id="5930643">++</span>&nbsp;<span class="op" id="5930646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930653">h</span><span class="op" id="5930654">.</span><span class="ident" id="5930655">lut</span><span class="op" id="5930658">[</span><span class="ident" id="5930659">base</span><span class="op" id="5930663">|</span><span class="ident" id="5930664">k</span><span class="op" id="5930665">]</span>&nbsp;<span class="op" id="5930667">=</span>&nbsp;<span class="ident" id="5930669">lutValue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930682">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930688">code</span><span class="op" id="5930692">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930699">x</span><span class="op" id="5930700">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5930715">//&nbsp;Derive&nbsp;minCodes,&nbsp;maxCodes,&nbsp;and&nbsp;valsIndices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930764">var</span>&nbsp;<span class="ident" id="5930768">c</span><span class="op" id="5930769">,</span>&nbsp;<span class="ident" id="5930771">index</span>&nbsp;<span class="builtintype" id="5930777">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930785">for</span>&nbsp;<span class="ident" id="5930789">i</span><span class="op" id="5930790">,</span>&nbsp;<span class="ident" id="5930792">n</span>&nbsp;<span class="op" id="5930794">:=</span>&nbsp;<span class="keyword" id="5930797">range</span>&nbsp;<span class="ident" id="5930803">nCodes</span>&nbsp;<span class="op" id="5930810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5930815">if</span>&nbsp;<span class="ident" id="5930818">n</span>&nbsp;<span class="op" id="5930820">==</span>&nbsp;<span class="num" id="5930823">0</span>&nbsp;<span class="op" id="5930825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930831">h</span><span class="op" id="5930832">.</span><span class="ident" id="5930833">minCodes</span><span class="op" id="5930841">[</span><span class="ident" id="5930842">i</span><span class="op" id="5930843">]</span>&nbsp;<span class="op" id="5930845">=</span>&nbsp;<span class="op" id="5930847">-</span><span class="num" id="5930848">1</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930854">h</span><span class="op" id="5930855">.</span><span class="ident" id="5930856">maxCodes</span><span class="op" id="5930864">[</span><span class="ident" id="5930865">i</span><span class="op" id="5930866">]</span>&nbsp;<span class="op" id="5930868">=</span>&nbsp;<span class="op" id="5930870">-</span><span class="num" id="5930871">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930877">h</span><span class="op" id="5930878">.</span><span class="ident" id="5930879">valsIndices</span><span class="op" id="5930890">[</span><span class="ident" id="5930891">i</span><span class="op" id="5930892">]</span>&nbsp;<span class="op" id="5930894">=</span>&nbsp;<span class="op" id="5930896">-</span><span class="num" id="5930897">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5930902">}</span>&nbsp;<span class="keyword" id="5930904">else</span>&nbsp;<span class="op" id="5930909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930915">h</span><span class="op" id="5930916">.</span><span class="ident" id="5930917">minCodes</span><span class="op" id="5930925">[</span><span class="ident" id="5930926">i</span><span class="op" id="5930927">]</span>&nbsp;<span class="op" id="5930929">=</span>&nbsp;<span class="ident" id="5930931">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930937">h</span><span class="op" id="5930938">.</span><span class="ident" id="5930939">maxCodes</span><span class="op" id="5930947">[</span><span class="ident" id="5930948">i</span><span class="op" id="5930949">]</span>&nbsp;<span class="op" id="5930951">=</span>&nbsp;<span class="ident" id="5930953">c</span>&nbsp;<span class="op" id="5930955">+</span>&nbsp;<span class="ident" id="5930957">n</span>&nbsp;<span class="op" id="5930959">-</span>&nbsp;<span class="num" id="5930961">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930967">h</span><span class="op" id="5930968">.</span><span class="ident" id="5930969">valsIndices</span><span class="op" id="5930980">[</span><span class="ident" id="5930981">i</span><span class="op" id="5930982">]</span>&nbsp;<span class="op" id="5930984">=</span>&nbsp;<span class="ident" id="5930986">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5930996">c</span>&nbsp;<span class="op" id="5930998">+=</span>&nbsp;<span class="ident" id="5931001">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931007">index</span>&nbsp;<span class="op" id="5931013">+=</span>&nbsp;<span class="ident" id="5931016">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931026">c</span>&nbsp;<span class="op" id="5931028">&lt;&lt;=</span>&nbsp;<span class="num" id="5931032">1</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931042">return</span>&nbsp;<span class="ident" id="5931049">nil</span><br>
<span class="lineno"></span><span class="op" id="5931053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="5931056">//&nbsp;decodeHuffman&nbsp;returns&nbsp;the&nbsp;next&nbsp;Huffman-coded&nbsp;value&nbsp;from&nbsp;the&nbsp;bit-stream,</span><br>
<span class="lineno"></span><span class="comment" id="5931131">//&nbsp;decoded&nbsp;according&nbsp;to&nbsp;h.</span><br>
<span class="lineno"></span><span class="keyword" id="5931158">func</span>&nbsp;<span class="op" id="5931163">(</span><span class="ident" id="5931164">d</span>&nbsp;<span class="op" id="5931166">*</span><span class="ident" id="5931167">decoder</span><span class="op" id="5931174">)</span>&nbsp;<span class="ident" id="5931176">decodeHuffman</span><span class="op" id="5931189">(</span><span class="ident" id="5931190">h</span>&nbsp;<span class="op" id="5931192">*</span><span class="ident" id="5931193">huffman</span><span class="op" id="5931200">)</span>&nbsp;<span class="op" id="5931202">(</span><span class="builtintype" id="5931203">uint8</span><span class="op" id="5931208">,</span>&nbsp;<span class="builtintype" id="5931210">error</span><span class="op" id="5931215">)</span>&nbsp;<span class="op" id="5931217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931220">if</span>&nbsp;<span class="ident" id="5931223">h</span><span class="op" id="5931224">.</span><span class="ident" id="5931225">nCodes</span>&nbsp;<span class="op" id="5931232">==</span>&nbsp;<span class="num" id="5931235">0</span>&nbsp;<span class="op" id="5931237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931241">return</span>&nbsp;<span class="num" id="5931248">0</span><span class="op" id="5931249">,</span>&nbsp;<span class="ident" id="5931251">FormatError</span><span class="op" id="5931262">(</span><span class="string" id="5931263">&#34;uninitialized&nbsp;Huffman&nbsp;table&#34;</span><span class="op" id="5931292">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931295">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931299">if</span>&nbsp;<span class="ident" id="5931302">d</span><span class="op" id="5931303">.</span><span class="ident" id="5931304">bits</span><span class="op" id="5931308">.</span><span class="ident" id="5931309">n</span>&nbsp;<span class="op" id="5931311">&lt;</span>&nbsp;<span class="num" id="5931313">8</span>&nbsp;<span class="op" id="5931315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931319">if</span>&nbsp;<span class="ident" id="5931322">err</span>&nbsp;<span class="op" id="5931326">:=</span>&nbsp;<span class="ident" id="5931329">d</span><span class="op" id="5931330">.</span><span class="ident" id="5931331">ensureNBits</span><span class="op" id="5931342">(</span><span class="num" id="5931343">8</span><span class="op" id="5931344">)</span><span class="op" id="5931345">;</span>&nbsp;<span class="ident" id="5931347">err</span>&nbsp;<span class="op" id="5931351">!=</span>&nbsp;<span class="ident" id="5931354">nil</span>&nbsp;<span class="op" id="5931358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931363">if</span>&nbsp;<span class="ident" id="5931366">err</span>&nbsp;<span class="op" id="5931370">!=</span>&nbsp;<span class="ident" id="5931373">errMissingFF00</span>&nbsp;<span class="op" id="5931388">&amp;&amp;</span>&nbsp;<span class="ident" id="5931391">err</span>&nbsp;<span class="op" id="5931395">!=</span>&nbsp;<span class="ident" id="5931398">errShortHuffmanData</span>&nbsp;<span class="op" id="5931418">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931424">return</span>&nbsp;<span class="num" id="5931431">0</span><span class="op" id="5931432">,</span>&nbsp;<span class="ident" id="5931434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5931446">//&nbsp;There&nbsp;are&nbsp;no&nbsp;more&nbsp;bytes&nbsp;of&nbsp;data&nbsp;in&nbsp;this&nbsp;segment,&nbsp;but&nbsp;we&nbsp;may&nbsp;still</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5931518">//&nbsp;be&nbsp;able&nbsp;to&nbsp;read&nbsp;the&nbsp;next&nbsp;symbol&nbsp;out&nbsp;of&nbsp;the&nbsp;previously&nbsp;read&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5931589">//&nbsp;First,&nbsp;undo&nbsp;the&nbsp;readByte&nbsp;that&nbsp;the&nbsp;ensureNBits&nbsp;call&nbsp;made.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931652">d</span><span class="op" id="5931653">.</span><span class="ident" id="5931654">unreadByteStuffedByte</span><span class="op" id="5931675">(</span><span class="op" id="5931676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931681">goto</span>&nbsp;<span class="ident" id="5931686">slowPath</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931703">if</span>&nbsp;<span class="ident" id="5931706">v</span>&nbsp;<span class="op" id="5931708">:=</span>&nbsp;<span class="ident" id="5931711">h</span><span class="op" id="5931712">.</span><span class="ident" id="5931713">lut</span><span class="op" id="5931716">[</span><span class="op" id="5931717">(</span><span class="ident" id="5931718">d</span><span class="op" id="5931719">.</span><span class="ident" id="5931720">bits</span><span class="op" id="5931724">.</span><span class="ident" id="5931725">a</span><span class="op" id="5931726">&gt;&gt;</span><span class="builtintype" id="5931728">uint32</span><span class="op" id="5931734">(</span><span class="ident" id="5931735">d</span><span class="op" id="5931736">.</span><span class="ident" id="5931737">bits</span><span class="op" id="5931741">.</span><span class="ident" id="5931742">n</span><span class="op" id="5931743">-</span><span class="ident" id="5931744">lutSize</span><span class="op" id="5931751">)</span><span class="op" id="5931752">)</span><span class="op" id="5931753">&amp;</span><span class="num" id="5931754">0xff</span><span class="op" id="5931758">]</span><span class="op" id="5931759">;</span>&nbsp;<span class="ident" id="5931761">v</span>&nbsp;<span class="op" id="5931763">!=</span>&nbsp;<span class="num" id="5931766">0</span>&nbsp;<span class="op" id="5931768">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931772">n</span>&nbsp;<span class="op" id="5931774">:=</span>&nbsp;<span class="op" id="5931777">(</span><span class="ident" id="5931778">v</span>&nbsp;<span class="op" id="5931780">&amp;</span>&nbsp;<span class="num" id="5931782">0xff</span><span class="op" id="5931786">)</span>&nbsp;<span class="op" id="5931788">-</span>&nbsp;<span class="num" id="5931790">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931794">d</span><span class="op" id="5931795">.</span><span class="ident" id="5931796">bits</span><span class="op" id="5931800">.</span><span class="ident" id="5931801">n</span>&nbsp;<span class="op" id="5931803">-=</span>&nbsp;<span class="builtintype" id="5931806">int32</span><span class="op" id="5931811">(</span><span class="ident" id="5931812">n</span><span class="op" id="5931813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5931817">d</span><span class="op" id="5931818">.</span><span class="ident" id="5931819">bits</span><span class="op" id="5931823">.</span><span class="ident" id="5931824">m</span>&nbsp;<span class="op" id="5931826">&gt;&gt;=</span>&nbsp;<span class="ident" id="5931830">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931834">return</span>&nbsp;<span class="builtintype" id="5931841">uint8</span><span class="op" id="5931846">(</span><span class="ident" id="5931847">v</span>&nbsp;<span class="op" id="5931849">&gt;&gt;</span>&nbsp;<span class="num" id="5931852">8</span><span class="op" id="5931853">)</span><span class="op" id="5931854">,</span>&nbsp;<span class="ident" id="5931856">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5931861">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="ident" id="5931864">slowPath</span><span class="op" id="5931872">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931875">for</span>&nbsp;<span class="ident" id="5931879">i</span><span class="op" id="5931880">,</span>&nbsp;<span class="ident" id="5931882">code</span>&nbsp;<span class="op" id="5931887">:=</span>&nbsp;<span class="num" id="5931890">0</span><span class="op" id="5931891">,</span>&nbsp;<span class="builtintype" id="5931893">int32</span><span class="op" id="5931898">(</span><span class="num" id="5931899">0</span><span class="op" id="5931900">)</span><span class="op" id="5931901">;</span>&nbsp;<span class="ident" id="5931903">i</span>&nbsp;<span class="op" id="5931905">&lt;</span>&nbsp;<span class="ident" id="5931907">maxCodeLength</span><span class="op" id="5931920">;</span>&nbsp;<span class="ident" id="5931922">i</span><span class="op" id="5931923">++</span>&nbsp;<span class="op" id="5931926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931930">if</span>&nbsp;<span class="ident" id="5931933">d</span><span class="op" id="5931934">.</span><span class="ident" id="5931935">bits</span><span class="op" id="5931939">.</span><span class="ident" id="5931940">n</span>&nbsp;<span class="op" id="5931942">==</span>&nbsp;<span class="num" id="5931945">0</span>&nbsp;<span class="op" id="5931947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931952">if</span>&nbsp;<span class="ident" id="5931955">err</span>&nbsp;<span class="op" id="5931959">:=</span>&nbsp;<span class="ident" id="5931962">d</span><span class="op" id="5931963">.</span><span class="ident" id="5931964">ensureNBits</span><span class="op" id="5931975">(</span><span class="num" id="5931976">1</span><span class="op" id="5931977">)</span><span class="op" id="5931978">;</span>&nbsp;<span class="ident" id="5931980">err</span>&nbsp;<span class="op" id="5931984">!=</span>&nbsp;<span class="ident" id="5931987">nil</span>&nbsp;<span class="op" id="5931991">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5931997">return</span>&nbsp;<span class="num" id="5932004">0</span><span class="op" id="5932005">,</span>&nbsp;<span class="ident" id="5932007">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932022">if</span>&nbsp;<span class="ident" id="5932025">d</span><span class="op" id="5932026">.</span><span class="ident" id="5932027">bits</span><span class="op" id="5932031">.</span><span class="ident" id="5932032">a</span><span class="op" id="5932033">&amp;</span><span class="ident" id="5932034">d</span><span class="op" id="5932035">.</span><span class="ident" id="5932036">bits</span><span class="op" id="5932040">.</span><span class="ident" id="5932041">m</span>&nbsp;<span class="op" id="5932043">!=</span>&nbsp;<span class="num" id="5932046">0</span>&nbsp;<span class="op" id="5932048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932053">code</span>&nbsp;<span class="op" id="5932058">|=</span>&nbsp;<span class="num" id="5932061">1</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932069">d</span><span class="op" id="5932070">.</span><span class="ident" id="5932071">bits</span><span class="op" id="5932075">.</span><span class="ident" id="5932076">n</span><span class="op" id="5932077">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932082">d</span><span class="op" id="5932083">.</span><span class="ident" id="5932084">bits</span><span class="op" id="5932088">.</span><span class="ident" id="5932089">m</span>&nbsp;<span class="op" id="5932091">&gt;&gt;=</span>&nbsp;<span class="num" id="5932095">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932099">if</span>&nbsp;<span class="ident" id="5932102">code</span>&nbsp;<span class="op" id="5932107">&lt;=</span>&nbsp;<span class="ident" id="5932110">h</span><span class="op" id="5932111">.</span><span class="ident" id="5932112">maxCodes</span><span class="op" id="5932120">[</span><span class="ident" id="5932121">i</span><span class="op" id="5932122">]</span>&nbsp;<span class="op" id="5932124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932129">return</span>&nbsp;<span class="ident" id="5932136">h</span><span class="op" id="5932137">.</span><span class="ident" id="5932138">vals</span><span class="op" id="5932142">[</span><span class="ident" id="5932143">h</span><span class="op" id="5932144">.</span><span class="ident" id="5932145">valsIndices</span><span class="op" id="5932156">[</span><span class="ident" id="5932157">i</span><span class="op" id="5932158">]</span><span class="op" id="5932159">+</span><span class="ident" id="5932160">code</span><span class="op" id="5932164">-</span><span class="ident" id="5932165">h</span><span class="op" id="5932166">.</span><span class="ident" id="5932167">minCodes</span><span class="op" id="5932175">[</span><span class="ident" id="5932176">i</span><span class="op" id="5932177">]</span><span class="op" id="5932178">]</span><span class="op" id="5932179">,</span>&nbsp;<span class="ident" id="5932181">nil</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932191">code</span>&nbsp;<span class="op" id="5932196">&lt;&lt;=</span>&nbsp;<span class="num" id="5932200">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932206">return</span>&nbsp;<span class="num" id="5932213">0</span><span class="op" id="5932214">,</span>&nbsp;<span class="ident" id="5932216">FormatError</span><span class="op" id="5932227">(</span><span class="string" id="5932228">&#34;bad&nbsp;Huffman&nbsp;code&#34;</span><span class="op" id="5932246">)</span><br>
<span class="lineno"></span><span class="op" id="5932248">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="5932251">func</span>&nbsp;<span class="op" id="5932256">(</span><span class="ident" id="5932257">d</span>&nbsp;<span class="op" id="5932259">*</span><span class="ident" id="5932260">decoder</span><span class="op" id="5932267">)</span>&nbsp;<span class="ident" id="5932269">decodeBit</span><span class="op" id="5932278">(</span><span class="op" id="5932279">)</span>&nbsp;<span class="op" id="5932281">(</span><span class="builtintype" id="5932282">bool</span><span class="op" id="5932286">,</span>&nbsp;<span class="builtintype" id="5932288">error</span><span class="op" id="5932293">)</span>&nbsp;<span class="op" id="5932295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932298">if</span>&nbsp;<span class="ident" id="5932301">d</span><span class="op" id="5932302">.</span><span class="ident" id="5932303">bits</span><span class="op" id="5932307">.</span><span class="ident" id="5932308">n</span>&nbsp;<span class="op" id="5932310">==</span>&nbsp;<span class="num" id="5932313">0</span>&nbsp;<span class="op" id="5932315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932319">if</span>&nbsp;<span class="ident" id="5932322">err</span>&nbsp;<span class="op" id="5932326">:=</span>&nbsp;<span class="ident" id="5932329">d</span><span class="op" id="5932330">.</span><span class="ident" id="5932331">ensureNBits</span><span class="op" id="5932342">(</span><span class="num" id="5932343">1</span><span class="op" id="5932344">)</span><span class="op" id="5932345">;</span>&nbsp;<span class="ident" id="5932347">err</span>&nbsp;<span class="op" id="5932351">!=</span>&nbsp;<span class="ident" id="5932354">nil</span>&nbsp;<span class="op" id="5932358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932363">return</span>&nbsp;<span class="builtintype" id="5932370">false</span><span class="op" id="5932375">,</span>&nbsp;<span class="ident" id="5932377">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932389">ret</span>&nbsp;<span class="op" id="5932393">:=</span>&nbsp;<span class="ident" id="5932396">d</span><span class="op" id="5932397">.</span><span class="ident" id="5932398">bits</span><span class="op" id="5932402">.</span><span class="ident" id="5932403">a</span><span class="op" id="5932404">&amp;</span><span class="ident" id="5932405">d</span><span class="op" id="5932406">.</span><span class="ident" id="5932407">bits</span><span class="op" id="5932411">.</span><span class="ident" id="5932412">m</span>&nbsp;<span class="op" id="5932414">!=</span>&nbsp;<span class="num" id="5932417">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932420">d</span><span class="op" id="5932421">.</span><span class="ident" id="5932422">bits</span><span class="op" id="5932426">.</span><span class="ident" id="5932427">n</span><span class="op" id="5932428">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932432">d</span><span class="op" id="5932433">.</span><span class="ident" id="5932434">bits</span><span class="op" id="5932438">.</span><span class="ident" id="5932439">m</span>&nbsp;<span class="op" id="5932441">&gt;&gt;=</span>&nbsp;<span class="num" id="5932445">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932448">return</span>&nbsp;<span class="ident" id="5932455">ret</span><span class="op" id="5932458">,</span>&nbsp;<span class="ident" id="5932460">nil</span><br>
<span class="lineno"></span><span class="op" id="5932464">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5932467">func</span>&nbsp;<span class="op" id="5932472">(</span><span class="ident" id="5932473">d</span>&nbsp;<span class="op" id="5932475">*</span><span class="ident" id="5932476">decoder</span><span class="op" id="5932483">)</span>&nbsp;<span class="ident" id="5932485">decodeBits</span><span class="op" id="5932495">(</span><span class="ident" id="5932496">n</span>&nbsp;<span class="builtintype" id="5932498">int32</span><span class="op" id="5932503">)</span>&nbsp;<span class="op" id="5932505">(</span><span class="builtintype" id="5932506">uint32</span><span class="op" id="5932512">,</span>&nbsp;<span class="builtintype" id="5932514">error</span><span class="op" id="5932519">)</span>&nbsp;<span class="op" id="5932521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932524">if</span>&nbsp;<span class="ident" id="5932527">d</span><span class="op" id="5932528">.</span><span class="ident" id="5932529">bits</span><span class="op" id="5932533">.</span><span class="ident" id="5932534">n</span>&nbsp;<span class="op" id="5932536">&lt;</span>&nbsp;<span class="ident" id="5932538">n</span>&nbsp;<span class="op" id="5932540">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932544">if</span>&nbsp;<span class="ident" id="5932547">err</span>&nbsp;<span class="op" id="5932551">:=</span>&nbsp;<span class="ident" id="5932554">d</span><span class="op" id="5932555">.</span><span class="ident" id="5932556">ensureNBits</span><span class="op" id="5932567">(</span><span class="ident" id="5932568">n</span><span class="op" id="5932569">)</span><span class="op" id="5932570">;</span>&nbsp;<span class="ident" id="5932572">err</span>&nbsp;<span class="op" id="5932576">!=</span>&nbsp;<span class="ident" id="5932579">nil</span>&nbsp;<span class="op" id="5932583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932588">return</span>&nbsp;<span class="num" id="5932595">0</span><span class="op" id="5932596">,</span>&nbsp;<span class="ident" id="5932598">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5932607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932610">ret</span>&nbsp;<span class="op" id="5932614">:=</span>&nbsp;<span class="ident" id="5932617">d</span><span class="op" id="5932618">.</span><span class="ident" id="5932619">bits</span><span class="op" id="5932623">.</span><span class="ident" id="5932624">a</span>&nbsp;<span class="op" id="5932626">&gt;&gt;</span>&nbsp;<span class="builtintype" id="5932629">uint32</span><span class="op" id="5932635">(</span><span class="ident" id="5932636">d</span><span class="op" id="5932637">.</span><span class="ident" id="5932638">bits</span><span class="op" id="5932642">.</span><span class="ident" id="5932643">n</span><span class="op" id="5932644">-</span><span class="ident" id="5932645">n</span><span class="op" id="5932646">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932649">ret</span>&nbsp;<span class="op" id="5932653">&amp;=</span>&nbsp;<span class="op" id="5932656">(</span><span class="num" id="5932657">1</span>&nbsp;<span class="op" id="5932659">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5932662">uint32</span><span class="op" id="5932668">(</span><span class="ident" id="5932669">n</span><span class="op" id="5932670">)</span><span class="op" id="5932671">)</span>&nbsp;<span class="op" id="5932673">-</span>&nbsp;<span class="num" id="5932675">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932678">d</span><span class="op" id="5932679">.</span><span class="ident" id="5932680">bits</span><span class="op" id="5932684">.</span><span class="ident" id="5932685">n</span>&nbsp;<span class="op" id="5932687">-=</span>&nbsp;<span class="ident" id="5932690">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5932693">d</span><span class="op" id="5932694">.</span><span class="ident" id="5932695">bits</span><span class="op" id="5932699">.</span><span class="ident" id="5932700">m</span>&nbsp;<span class="op" id="5932702">&gt;&gt;=</span>&nbsp;<span class="builtintype" id="5932706">uint32</span><span class="op" id="5932712">(</span><span class="ident" id="5932713">n</span><span class="op" id="5932714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5932717">return</span>&nbsp;<span class="ident" id="5932724">ret</span><span class="op" id="5932727">,</span>&nbsp;<span class="ident" id="5932729">nil</span><br>
<span class="lineno"></span><span class="op" id="5932733">}</span>
</div>
</body>
</html>
