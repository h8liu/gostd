<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httptest</h2>
<ul>
<li><a href="/gostd/net/http/httptest/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder.go.html">recorder.go</a></li>
<li><a href="/gostd/net/http/httptest/recorder_test.go.html">recorder_test.go</a></li>
<li><a href="/gostd/net/http/httptest/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/httptest/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6359507">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6359562">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6359616">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6359667">//&nbsp;Implementation&nbsp;of&nbsp;Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6359696">package</span>&nbsp;<span class="ident" id="6359704">httptest</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6359714">import</span>&nbsp;<span class="op" id="6359721">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359724">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359738">&#34;flag&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359746">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359753">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359760">&#34;net/http&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359772">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6359778">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="6359785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6359788">//&nbsp;A&nbsp;Server&nbsp;is&nbsp;an&nbsp;HTTP&nbsp;server&nbsp;listening&nbsp;on&nbsp;a&nbsp;system-chosen&nbsp;port&nbsp;on&nbsp;the</span><br>
<span class="lineno">20</span><span class="comment" id="6359859">//&nbsp;local&nbsp;loopback&nbsp;interface,&nbsp;for&nbsp;use&nbsp;in&nbsp;end-to-end&nbsp;HTTP&nbsp;tests.</span><br>
<span class="lineno"></span><span class="keyword" id="6359922">type</span>&nbsp;<span class="ident" id="6359927">Server</span>&nbsp;<span class="keyword" id="6359934">struct</span>&nbsp;<span class="op" id="6359941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6359944">URL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6359953">string</span>&nbsp;<span class="comment" id="6359960">//&nbsp;base&nbsp;URL&nbsp;of&nbsp;form&nbsp;http://ipaddr:port&nbsp;with&nbsp;no&nbsp;trailing&nbsp;slash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360023">Listener</span>&nbsp;<span class="ident" id="6360032">net</span><span class="op" id="6360035">.</span><span class="ident" id="6360036">Listener</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360047">//&nbsp;TLS&nbsp;is&nbsp;the&nbsp;optional&nbsp;TLS&nbsp;configuration,&nbsp;populated&nbsp;with&nbsp;a&nbsp;new&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360118">//&nbsp;after&nbsp;TLS&nbsp;is&nbsp;started.&nbsp;If&nbsp;set&nbsp;on&nbsp;an&nbsp;unstarted&nbsp;server&nbsp;before&nbsp;StartTLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360190">//&nbsp;is&nbsp;called,&nbsp;existing&nbsp;fields&nbsp;are&nbsp;copied&nbsp;into&nbsp;the&nbsp;new&nbsp;config.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360253">TLS</span>&nbsp;<span class="op" id="6360257">*</span><span class="ident" id="6360258">tls</span><span class="op" id="6360261">.</span><span class="ident" id="6360262">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360271">//&nbsp;Config&nbsp;may&nbsp;be&nbsp;changed&nbsp;after&nbsp;calling&nbsp;NewUnstartedServer&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360334">//&nbsp;before&nbsp;Start&nbsp;or&nbsp;StartTLS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360364">Config</span>&nbsp;<span class="op" id="6360371">*</span><span class="ident" id="6360372">http</span><span class="op" id="6360376">.</span><span class="ident" id="6360377">Server</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360386">//&nbsp;wg&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;HTTP&nbsp;requests&nbsp;on&nbsp;this&nbsp;server.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6360456">//&nbsp;Close&nbsp;blocks&nbsp;until&nbsp;all&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360506">wg</span>&nbsp;<span class="ident" id="6360509">sync</span><span class="op" id="6360513">.</span><span class="ident" id="6360514">WaitGroup</span><br>
<span class="lineno"></span><span class="op" id="6360524">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6360527">//&nbsp;historyListener&nbsp;keeps&nbsp;track&nbsp;of&nbsp;all&nbsp;connections&nbsp;that&nbsp;it&#39;s&nbsp;ever</span><br>
<span class="lineno">40</span><span class="comment" id="6360592">//&nbsp;accepted.</span><br>
<span class="lineno"></span><span class="keyword" id="6360605">type</span>&nbsp;<span class="ident" id="6360610">historyListener</span>&nbsp;<span class="keyword" id="6360626">struct</span>&nbsp;<span class="op" id="6360633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360636">net</span><span class="op" id="6360639">.</span><span class="ident" id="6360640">Listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360650">sync</span><span class="op" id="6360654">.</span><span class="ident" id="6360655">Mutex</span>&nbsp;<span class="comment" id="6360661">//&nbsp;protects&nbsp;history</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360682">history</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6360693">[</span><span class="op" id="6360694">]</span><span class="ident" id="6360695">net</span><span class="op" id="6360698">.</span><span class="ident" id="6360699">Conn</span><br>
<span class="lineno">45</span><span class="op" id="6360704">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360707">func</span>&nbsp;<span class="op" id="6360712">(</span><span class="ident" id="6360713">hs</span>&nbsp;<span class="op" id="6360716">*</span><span class="ident" id="6360717">historyListener</span><span class="op" id="6360732">)</span>&nbsp;<span class="ident" id="6360734">Accept</span><span class="op" id="6360740">(</span><span class="op" id="6360741">)</span>&nbsp;<span class="op" id="6360743">(</span><span class="ident" id="6360744">c</span>&nbsp;<span class="ident" id="6360746">net</span><span class="op" id="6360749">.</span><span class="ident" id="6360750">Conn</span><span class="op" id="6360754">,</span>&nbsp;<span class="ident" id="6360756">err</span>&nbsp;<span class="builtintype" id="6360760">error</span><span class="op" id="6360765">)</span>&nbsp;<span class="op" id="6360767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360770">c</span><span class="op" id="6360771">,</span>&nbsp;<span class="ident" id="6360773">err</span>&nbsp;<span class="op" id="6360777">=</span>&nbsp;<span class="ident" id="6360779">hs</span><span class="op" id="6360781">.</span><span class="ident" id="6360782">Listener</span><span class="op" id="6360790">.</span><span class="ident" id="6360791">Accept</span><span class="op" id="6360797">(</span><span class="op" id="6360798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360801">if</span>&nbsp;<span class="ident" id="6360804">err</span>&nbsp;<span class="op" id="6360808">==</span>&nbsp;<span class="ident" id="6360811">nil</span>&nbsp;<span class="op" id="6360815">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360819">hs</span><span class="op" id="6360821">.</span><span class="ident" id="6360822">Lock</span><span class="op" id="6360826">(</span><span class="op" id="6360827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360831">hs</span><span class="op" id="6360833">.</span><span class="ident" id="6360834">history</span>&nbsp;<span class="op" id="6360842">=</span>&nbsp;<span class="builtinfunc" id="6360844">append</span><span class="op" id="6360850">(</span><span class="ident" id="6360851">hs</span><span class="op" id="6360853">.</span><span class="ident" id="6360854">history</span><span class="op" id="6360861">,</span>&nbsp;<span class="ident" id="6360863">c</span><span class="op" id="6360864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360868">hs</span><span class="op" id="6360870">.</span><span class="ident" id="6360871">Unlock</span><span class="op" id="6360877">(</span><span class="op" id="6360878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6360881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360884">return</span><br>
<span class="lineno">55</span><span class="op" id="6360891">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6360894">func</span>&nbsp;<span class="ident" id="6360899">newLocalListener</span><span class="op" id="6360915">(</span><span class="op" id="6360916">)</span>&nbsp;<span class="ident" id="6360918">net</span><span class="op" id="6360921">.</span><span class="ident" id="6360922">Listener</span>&nbsp;<span class="op" id="6360931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360934">if</span>&nbsp;<span class="op" id="6360937">*</span><span class="ident" id="6360938">serve</span>&nbsp;<span class="op" id="6360944">!=</span>&nbsp;<span class="string" id="6360947">&#34;&#34;</span>&nbsp;<span class="op" id="6360950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6360954">l</span><span class="op" id="6360955">,</span>&nbsp;<span class="ident" id="6360957">err</span>&nbsp;<span class="op" id="6360961">:=</span>&nbsp;<span class="ident" id="6360964">net</span><span class="op" id="6360967">.</span><span class="ident" id="6360968">Listen</span><span class="op" id="6360974">(</span><span class="string" id="6360975">&#34;tcp&#34;</span><span class="op" id="6360980">,</span>&nbsp;<span class="op" id="6360982">*</span><span class="ident" id="6360983">serve</span><span class="op" id="6360988">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6360992">if</span>&nbsp;<span class="ident" id="6360995">err</span>&nbsp;<span class="op" id="6360999">!=</span>&nbsp;<span class="ident" id="6361002">nil</span>&nbsp;<span class="op" id="6361006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6361011">panic</span><span class="op" id="6361016">(</span><span class="ident" id="6361017">fmt</span><span class="op" id="6361020">.</span><span class="ident" id="6361021">Sprintf</span><span class="op" id="6361028">(</span><span class="string" id="6361029">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;%v:&nbsp;%v&#34;</span><span class="op" id="6361067">,</span>&nbsp;<span class="op" id="6361069">*</span><span class="ident" id="6361070">serve</span><span class="op" id="6361075">,</span>&nbsp;<span class="ident" id="6361077">err</span><span class="op" id="6361080">)</span><span class="op" id="6361081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6361085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6361089">return</span>&nbsp;<span class="ident" id="6361096">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6361099">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361102">l</span><span class="op" id="6361103">,</span>&nbsp;<span class="ident" id="6361105">err</span>&nbsp;<span class="op" id="6361109">:=</span>&nbsp;<span class="ident" id="6361112">net</span><span class="op" id="6361115">.</span><span class="ident" id="6361116">Listen</span><span class="op" id="6361122">(</span><span class="string" id="6361123">&#34;tcp&#34;</span><span class="op" id="6361128">,</span>&nbsp;<span class="string" id="6361130">&#34;127.0.0.1:0&#34;</span><span class="op" id="6361143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6361146">if</span>&nbsp;<span class="ident" id="6361149">err</span>&nbsp;<span class="op" id="6361153">!=</span>&nbsp;<span class="ident" id="6361156">nil</span>&nbsp;<span class="op" id="6361160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6361164">if</span>&nbsp;<span class="ident" id="6361167">l</span><span class="op" id="6361168">,</span>&nbsp;<span class="ident" id="6361170">err</span>&nbsp;<span class="op" id="6361174">=</span>&nbsp;<span class="ident" id="6361176">net</span><span class="op" id="6361179">.</span><span class="ident" id="6361180">Listen</span><span class="op" id="6361186">(</span><span class="string" id="6361187">&#34;tcp6&#34;</span><span class="op" id="6361193">,</span>&nbsp;<span class="string" id="6361195">&#34;[::1]:0&#34;</span><span class="op" id="6361204">)</span><span class="op" id="6361205">;</span>&nbsp;<span class="ident" id="6361207">err</span>&nbsp;<span class="op" id="6361211">!=</span>&nbsp;<span class="ident" id="6361214">nil</span>&nbsp;<span class="op" id="6361218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6361223">panic</span><span class="op" id="6361228">(</span><span class="ident" id="6361229">fmt</span><span class="op" id="6361232">.</span><span class="ident" id="6361233">Sprintf</span><span class="op" id="6361240">(</span><span class="string" id="6361241">&#34;httptest:&nbsp;failed&nbsp;to&nbsp;listen&nbsp;on&nbsp;a&nbsp;port:&nbsp;%v&#34;</span><span class="op" id="6361283">,</span>&nbsp;<span class="ident" id="6361285">err</span><span class="op" id="6361288">)</span><span class="op" id="6361289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6361293">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6361296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6361299">return</span>&nbsp;<span class="ident" id="6361306">l</span><br>
<span class="lineno"></span><span class="op" id="6361308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6361311">//&nbsp;When&nbsp;debugging&nbsp;a&nbsp;particular&nbsp;http&nbsp;server-based&nbsp;test,</span><br>
<span class="lineno">75</span><span class="comment" id="6361366">//&nbsp;this&nbsp;flag&nbsp;lets&nbsp;you&nbsp;run</span><br>
<span class="lineno"></span><span class="comment" id="6361392">//&nbsp;&nbsp;&nbsp;&nbspgo&nbsp;test&nbsp;-run=BrokenTest&nbsp;-httptest.serve=127.0.0.1:8000</span><br>
<span class="lineno"></span><span class="comment" id="6361450">//&nbsp;to&nbsp;start&nbsp;the&nbsp;broken&nbsp;server&nbsp;so&nbsp;you&nbsp;can&nbsp;interact&nbsp;with&nbsp;it&nbsp;manually.</span><br>
<span class="lineno"></span><span class="keyword" id="6361518">var</span>&nbsp;<span class="ident" id="6361522">serve</span>&nbsp;<span class="op" id="6361528">=</span>&nbsp;<span class="ident" id="6361530">flag</span><span class="op" id="6361534">.</span><span class="ident" id="6361535">String</span><span class="op" id="6361541">(</span><span class="string" id="6361542">&#34;httptest.serve&#34;</span><span class="op" id="6361558">,</span>&nbsp;<span class="string" id="6361560">&#34;&#34;</span><span class="op" id="6361562">,</span>&nbsp;<span class="string" id="6361564">&#34;if&nbsp;non-empty,&nbsp;httptest.NewServer&nbsp;serves&nbsp;on&nbsp;this&nbsp;address&nbsp;and&nbsp;blocks&#34;</span><span class="op" id="6361632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="6361635">//&nbsp;NewServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="comment" id="6361681">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6361745">func</span>&nbsp;<span class="ident" id="6361750">NewServer</span><span class="op" id="6361759">(</span><span class="ident" id="6361760">handler</span>&nbsp;<span class="ident" id="6361768">http</span><span class="op" id="6361772">.</span><span class="ident" id="6361773">Handler</span><span class="op" id="6361780">)</span>&nbsp;<span class="op" id="6361782">*</span><span class="ident" id="6361783">Server</span>&nbsp;<span class="op" id="6361790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361793">ts</span>&nbsp;<span class="op" id="6361796">:=</span>&nbsp;<span class="ident" id="6361799">NewUnstartedServer</span><span class="op" id="6361817">(</span><span class="ident" id="6361818">handler</span><span class="op" id="6361825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6361828">ts</span><span class="op" id="6361830">.</span><span class="ident" id="6361831">Start</span><span class="op" id="6361836">(</span><span class="op" id="6361837">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6361840">return</span>&nbsp;<span class="ident" id="6361847">ts</span><br>
<span class="lineno"></span><span class="op" id="6361850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6361853">//&nbsp;NewUnstartedServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;but&nbsp;doesn&#39;t&nbsp;start&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="6361918">//</span><br>
<span class="lineno">90</span><span class="comment" id="6361921">//&nbsp;After&nbsp;changing&nbsp;its&nbsp;configuration,&nbsp;the&nbsp;caller&nbsp;should&nbsp;call&nbsp;Start&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6361990">//&nbsp;StartTLS.</span><br>
<span class="lineno"></span><span class="comment" id="6362003">//</span><br>
<span class="lineno"></span><span class="comment" id="6362006">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6362070">func</span>&nbsp;<span class="ident" id="6362075">NewUnstartedServer</span><span class="op" id="6362093">(</span><span class="ident" id="6362094">handler</span>&nbsp;<span class="ident" id="6362102">http</span><span class="op" id="6362106">.</span><span class="ident" id="6362107">Handler</span><span class="op" id="6362114">)</span>&nbsp;<span class="op" id="6362116">*</span><span class="ident" id="6362117">Server</span>&nbsp;<span class="op" id="6362124">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362127">return</span>&nbsp;<span class="op" id="6362134">&amp;</span><span class="ident" id="6362135">Server</span><span class="op" id="6362141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362145">Listener</span><span class="op" id="6362153">:</span>&nbsp;<span class="ident" id="6362155">newLocalListener</span><span class="op" id="6362171">(</span><span class="op" id="6362172">)</span><span class="op" id="6362173">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362177">Config</span><span class="op" id="6362183">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6362187">&amp;</span><span class="ident" id="6362188">http</span><span class="op" id="6362192">.</span><span class="ident" id="6362193">Server</span><span class="op" id="6362199">{</span><span class="ident" id="6362200">Handler</span><span class="op" id="6362207">:</span>&nbsp;<span class="ident" id="6362209">handler</span><span class="op" id="6362216">}</span><span class="op" id="6362217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362220">}</span><br>
<span class="lineno"></span><span class="op" id="6362222">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="6362225">//&nbsp;Start&nbsp;starts&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6362275">func</span>&nbsp;<span class="op" id="6362280">(</span><span class="ident" id="6362281">s</span>&nbsp;<span class="op" id="6362283">*</span><span class="ident" id="6362284">Server</span><span class="op" id="6362290">)</span>&nbsp;<span class="ident" id="6362292">Start</span><span class="op" id="6362297">(</span><span class="op" id="6362298">)</span>&nbsp;<span class="op" id="6362300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362303">if</span>&nbsp;<span class="ident" id="6362306">s</span><span class="op" id="6362307">.</span><span class="ident" id="6362308">URL</span>&nbsp;<span class="op" id="6362312">!=</span>&nbsp;<span class="string" id="6362315">&#34;&#34;</span>&nbsp;<span class="op" id="6362318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6362322">panic</span><span class="op" id="6362327">(</span><span class="string" id="6362328">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6362352">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362358">s</span><span class="op" id="6362359">.</span><span class="ident" id="6362360">Listener</span>&nbsp;<span class="op" id="6362369">=</span>&nbsp;<span class="op" id="6362371">&amp;</span><span class="ident" id="6362372">historyListener</span><span class="op" id="6362387">{</span><span class="ident" id="6362388">Listener</span><span class="op" id="6362396">:</span>&nbsp;<span class="ident" id="6362398">s</span><span class="op" id="6362399">.</span><span class="ident" id="6362400">Listener</span><span class="op" id="6362408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362411">s</span><span class="op" id="6362412">.</span><span class="ident" id="6362413">URL</span>&nbsp;<span class="op" id="6362417">=</span>&nbsp;<span class="string" id="6362419">&#34;http://&#34;</span>&nbsp;<span class="op" id="6362429">+</span>&nbsp;<span class="ident" id="6362431">s</span><span class="op" id="6362432">.</span><span class="ident" id="6362433">Listener</span><span class="op" id="6362441">.</span><span class="ident" id="6362442">Addr</span><span class="op" id="6362446">(</span><span class="op" id="6362447">)</span><span class="op" id="6362448">.</span><span class="ident" id="6362449">String</span><span class="op" id="6362455">(</span><span class="op" id="6362456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362459">s</span><span class="op" id="6362460">.</span><span class="ident" id="6362461">wrapHandler</span><span class="op" id="6362472">(</span><span class="op" id="6362473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362476">go</span>&nbsp;<span class="ident" id="6362479">s</span><span class="op" id="6362480">.</span><span class="ident" id="6362481">Config</span><span class="op" id="6362487">.</span><span class="ident" id="6362488">Serve</span><span class="op" id="6362493">(</span><span class="ident" id="6362494">s</span><span class="op" id="6362495">.</span><span class="ident" id="6362496">Listener</span><span class="op" id="6362504">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362507">if</span>&nbsp;<span class="op" id="6362510">*</span><span class="ident" id="6362511">serve</span>&nbsp;<span class="op" id="6362517">!=</span>&nbsp;<span class="string" id="6362520">&#34;&#34;</span>&nbsp;<span class="op" id="6362523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362527">fmt</span><span class="op" id="6362530">.</span><span class="ident" id="6362531">Fprintln</span><span class="op" id="6362539">(</span><span class="ident" id="6362540">os</span><span class="op" id="6362542">.</span><span class="ident" id="6362543">Stderr</span><span class="op" id="6362549">,</span>&nbsp;<span class="string" id="6362551">&#34;httptest:&nbsp;serving&nbsp;on&#34;</span><span class="op" id="6362573">,</span>&nbsp;<span class="ident" id="6362575">s</span><span class="op" id="6362576">.</span><span class="ident" id="6362577">URL</span><span class="op" id="6362580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362584">select</span>&nbsp;<span class="op" id="6362591">{</span><span class="op" id="6362592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362595">}</span><br>
<span class="lineno"></span><span class="op" id="6362597">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="6362600">//&nbsp;StartTLS&nbsp;starts&nbsp;TLS&nbsp;on&nbsp;a&nbsp;server&nbsp;from&nbsp;NewUnstartedServer.</span><br>
<span class="lineno"></span><span class="keyword" id="6362660">func</span>&nbsp;<span class="op" id="6362665">(</span><span class="ident" id="6362666">s</span>&nbsp;<span class="op" id="6362668">*</span><span class="ident" id="6362669">Server</span><span class="op" id="6362675">)</span>&nbsp;<span class="ident" id="6362677">StartTLS</span><span class="op" id="6362685">(</span><span class="op" id="6362686">)</span>&nbsp;<span class="op" id="6362688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362691">if</span>&nbsp;<span class="ident" id="6362694">s</span><span class="op" id="6362695">.</span><span class="ident" id="6362696">URL</span>&nbsp;<span class="op" id="6362700">!=</span>&nbsp;<span class="string" id="6362703">&#34;&#34;</span>&nbsp;<span class="op" id="6362706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6362710">panic</span><span class="op" id="6362715">(</span><span class="string" id="6362716">&#34;Server&nbsp;already&nbsp;started&#34;</span><span class="op" id="6362740">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362746">cert</span><span class="op" id="6362750">,</span>&nbsp;<span class="ident" id="6362752">err</span>&nbsp;<span class="op" id="6362756">:=</span>&nbsp;<span class="ident" id="6362759">tls</span><span class="op" id="6362762">.</span><span class="ident" id="6362763">X509KeyPair</span><span class="op" id="6362774">(</span><span class="ident" id="6362775">localhostCert</span><span class="op" id="6362788">,</span>&nbsp;<span class="ident" id="6362790">localhostKey</span><span class="op" id="6362802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362805">if</span>&nbsp;<span class="ident" id="6362808">err</span>&nbsp;<span class="op" id="6362812">!=</span>&nbsp;<span class="ident" id="6362815">nil</span>&nbsp;<span class="op" id="6362819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6362823">panic</span><span class="op" id="6362828">(</span><span class="ident" id="6362829">fmt</span><span class="op" id="6362832">.</span><span class="ident" id="6362833">Sprintf</span><span class="op" id="6362840">(</span><span class="string" id="6362841">&#34;httptest:&nbsp;NewTLSServer:&nbsp;%v&#34;</span><span class="op" id="6362869">,</span>&nbsp;<span class="ident" id="6362871">err</span><span class="op" id="6362874">)</span><span class="op" id="6362875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362878">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362882">existingConfig</span>&nbsp;<span class="op" id="6362897">:=</span>&nbsp;<span class="ident" id="6362900">s</span><span class="op" id="6362901">.</span><span class="ident" id="6362902">TLS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6362907">s</span><span class="op" id="6362908">.</span><span class="ident" id="6362909">TLS</span>&nbsp;<span class="op" id="6362913">=</span>&nbsp;<span class="builtinfunc" id="6362915">new</span><span class="op" id="6362918">(</span><span class="ident" id="6362919">tls</span><span class="op" id="6362922">.</span><span class="ident" id="6362923">Config</span><span class="op" id="6362929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362932">if</span>&nbsp;<span class="ident" id="6362935">existingConfig</span>&nbsp;<span class="op" id="6362950">!=</span>&nbsp;<span class="ident" id="6362953">nil</span>&nbsp;<span class="op" id="6362957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362961">*</span><span class="ident" id="6362962">s</span><span class="op" id="6362963">.</span><span class="ident" id="6362964">TLS</span>&nbsp;<span class="op" id="6362968">=</span>&nbsp;<span class="op" id="6362970">*</span><span class="ident" id="6362971">existingConfig</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6362987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6362990">if</span>&nbsp;<span class="ident" id="6362993">s</span><span class="op" id="6362994">.</span><span class="ident" id="6362995">TLS</span><span class="op" id="6362998">.</span><span class="ident" id="6362999">NextProtos</span>&nbsp;<span class="op" id="6363010">==</span>&nbsp;<span class="ident" id="6363013">nil</span>&nbsp;<span class="op" id="6363017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363021">s</span><span class="op" id="6363022">.</span><span class="ident" id="6363023">TLS</span><span class="op" id="6363026">.</span><span class="ident" id="6363027">NextProtos</span>&nbsp;<span class="op" id="6363038">=</span>&nbsp;<span class="op" id="6363040">[</span><span class="op" id="6363041">]</span><span class="builtintype" id="6363042">string</span><span class="op" id="6363048">{</span><span class="string" id="6363049">&#34;http/1.1&#34;</span><span class="op" id="6363059">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6363062">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6363065">if</span>&nbsp;<span class="builtinfunc" id="6363068">len</span><span class="op" id="6363071">(</span><span class="ident" id="6363072">s</span><span class="op" id="6363073">.</span><span class="ident" id="6363074">TLS</span><span class="op" id="6363077">.</span><span class="ident" id="6363078">Certificates</span><span class="op" id="6363090">)</span>&nbsp;<span class="op" id="6363092">==</span>&nbsp;<span class="num" id="6363095">0</span>&nbsp;<span class="op" id="6363097">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363101">s</span><span class="op" id="6363102">.</span><span class="ident" id="6363103">TLS</span><span class="op" id="6363106">.</span><span class="ident" id="6363107">Certificates</span>&nbsp;<span class="op" id="6363120">=</span>&nbsp;<span class="op" id="6363122">[</span><span class="op" id="6363123">]</span><span class="ident" id="6363124">tls</span><span class="op" id="6363127">.</span><span class="ident" id="6363128">Certificate</span><span class="op" id="6363139">{</span><span class="ident" id="6363140">cert</span><span class="op" id="6363144">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6363147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363150">tlsListener</span>&nbsp;<span class="op" id="6363162">:=</span>&nbsp;<span class="ident" id="6363165">tls</span><span class="op" id="6363168">.</span><span class="ident" id="6363169">NewListener</span><span class="op" id="6363180">(</span><span class="ident" id="6363181">s</span><span class="op" id="6363182">.</span><span class="ident" id="6363183">Listener</span><span class="op" id="6363191">,</span>&nbsp;<span class="ident" id="6363193">s</span><span class="op" id="6363194">.</span><span class="ident" id="6363195">TLS</span><span class="op" id="6363198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363202">s</span><span class="op" id="6363203">.</span><span class="ident" id="6363204">Listener</span>&nbsp;<span class="op" id="6363213">=</span>&nbsp;<span class="op" id="6363215">&amp;</span><span class="ident" id="6363216">historyListener</span><span class="op" id="6363231">{</span><span class="ident" id="6363232">Listener</span><span class="op" id="6363240">:</span>&nbsp;<span class="ident" id="6363242">tlsListener</span><span class="op" id="6363253">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363256">s</span><span class="op" id="6363257">.</span><span class="ident" id="6363258">URL</span>&nbsp;<span class="op" id="6363262">=</span>&nbsp;<span class="string" id="6363264">&#34;https://&#34;</span>&nbsp;<span class="op" id="6363275">+</span>&nbsp;<span class="ident" id="6363277">s</span><span class="op" id="6363278">.</span><span class="ident" id="6363279">Listener</span><span class="op" id="6363287">.</span><span class="ident" id="6363288">Addr</span><span class="op" id="6363292">(</span><span class="op" id="6363293">)</span><span class="op" id="6363294">.</span><span class="ident" id="6363295">String</span><span class="op" id="6363301">(</span><span class="op" id="6363302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363305">s</span><span class="op" id="6363306">.</span><span class="ident" id="6363307">wrapHandler</span><span class="op" id="6363318">(</span><span class="op" id="6363319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6363322">go</span>&nbsp;<span class="ident" id="6363325">s</span><span class="op" id="6363326">.</span><span class="ident" id="6363327">Config</span><span class="op" id="6363333">.</span><span class="ident" id="6363334">Serve</span><span class="op" id="6363339">(</span><span class="ident" id="6363340">s</span><span class="op" id="6363341">.</span><span class="ident" id="6363342">Listener</span><span class="op" id="6363350">)</span><br>
<span class="lineno"></span><span class="op" id="6363352">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6363355">func</span>&nbsp;<span class="op" id="6363360">(</span><span class="ident" id="6363361">s</span>&nbsp;<span class="op" id="6363363">*</span><span class="ident" id="6363364">Server</span><span class="op" id="6363370">)</span>&nbsp;<span class="ident" id="6363372">wrapHandler</span><span class="op" id="6363383">(</span><span class="op" id="6363384">)</span>&nbsp;<span class="op" id="6363386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363389">h</span>&nbsp;<span class="op" id="6363391">:=</span>&nbsp;<span class="ident" id="6363394">s</span><span class="op" id="6363395">.</span><span class="ident" id="6363396">Config</span><span class="op" id="6363402">.</span><span class="ident" id="6363403">Handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6363412">if</span>&nbsp;<span class="ident" id="6363415">h</span>&nbsp;<span class="op" id="6363417">==</span>&nbsp;<span class="ident" id="6363420">nil</span>&nbsp;<span class="op" id="6363424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363428">h</span>&nbsp;<span class="op" id="6363430">=</span>&nbsp;<span class="ident" id="6363432">http</span><span class="op" id="6363436">.</span><span class="ident" id="6363437">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6363454">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363457">s</span><span class="op" id="6363458">.</span><span class="ident" id="6363459">Config</span><span class="op" id="6363465">.</span><span class="ident" id="6363466">Handler</span>&nbsp;<span class="op" id="6363474">=</span>&nbsp;<span class="op" id="6363476">&amp;</span><span class="ident" id="6363477">waitGroupHandler</span><span class="op" id="6363493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363497">s</span><span class="op" id="6363498">:</span>&nbsp;<span class="ident" id="6363500">s</span><span class="op" id="6363501">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363505">h</span><span class="op" id="6363506">:</span>&nbsp;<span class="ident" id="6363508">h</span><span class="op" id="6363509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6363512">}</span><br>
<span class="lineno"></span><span class="op" id="6363514">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="6363517">//&nbsp;NewTLSServer&nbsp;starts&nbsp;and&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server&nbsp;using&nbsp;TLS.</span><br>
<span class="lineno"></span><span class="comment" id="6363576">//&nbsp;The&nbsp;caller&nbsp;should&nbsp;call&nbsp;Close&nbsp;when&nbsp;finished,&nbsp;to&nbsp;shut&nbsp;it&nbsp;down.</span><br>
<span class="lineno"></span><span class="keyword" id="6363640">func</span>&nbsp;<span class="ident" id="6363645">NewTLSServer</span><span class="op" id="6363657">(</span><span class="ident" id="6363658">handler</span>&nbsp;<span class="ident" id="6363666">http</span><span class="op" id="6363670">.</span><span class="ident" id="6363671">Handler</span><span class="op" id="6363678">)</span>&nbsp;<span class="op" id="6363680">*</span><span class="ident" id="6363681">Server</span>&nbsp;<span class="op" id="6363688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363691">ts</span>&nbsp;<span class="op" id="6363694">:=</span>&nbsp;<span class="ident" id="6363697">NewUnstartedServer</span><span class="op" id="6363715">(</span><span class="ident" id="6363716">handler</span><span class="op" id="6363723">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363726">ts</span><span class="op" id="6363728">.</span><span class="ident" id="6363729">StartTLS</span><span class="op" id="6363737">(</span><span class="op" id="6363738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6363741">return</span>&nbsp;<span class="ident" id="6363748">ts</span><br>
<span class="lineno"></span><span class="op" id="6363751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6363754">//&nbsp;Close&nbsp;shuts&nbsp;down&nbsp;the&nbsp;server&nbsp;and&nbsp;blocks&nbsp;until&nbsp;all&nbsp;outstanding</span><br>
<span class="lineno">165</span><span class="comment" id="6363818">//&nbsp;requests&nbsp;on&nbsp;this&nbsp;server&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6363861">func</span>&nbsp;<span class="op" id="6363866">(</span><span class="ident" id="6363867">s</span>&nbsp;<span class="op" id="6363869">*</span><span class="ident" id="6363870">Server</span><span class="op" id="6363876">)</span>&nbsp;<span class="ident" id="6363878">Close</span><span class="op" id="6363883">(</span><span class="op" id="6363884">)</span>&nbsp;<span class="op" id="6363886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363889">s</span><span class="op" id="6363890">.</span><span class="ident" id="6363891">Listener</span><span class="op" id="6363899">.</span><span class="ident" id="6363900">Close</span><span class="op" id="6363905">(</span><span class="op" id="6363906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363909">s</span><span class="op" id="6363910">.</span><span class="ident" id="6363911">wg</span><span class="op" id="6363913">.</span><span class="ident" id="6363914">Wait</span><span class="op" id="6363918">(</span><span class="op" id="6363919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6363922">s</span><span class="op" id="6363923">.</span><span class="ident" id="6363924">CloseClientConnections</span><span class="op" id="6363946">(</span><span class="op" id="6363947">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6363950">if</span>&nbsp;<span class="ident" id="6363953">t</span><span class="op" id="6363954">,</span>&nbsp;<span class="ident" id="6363956">ok</span>&nbsp;<span class="op" id="6363959">:=</span>&nbsp;<span class="ident" id="6363962">http</span><span class="op" id="6363966">.</span><span class="ident" id="6363967">DefaultTransport</span><span class="op" id="6363983">.</span><span class="op" id="6363984">(</span><span class="op" id="6363985">*</span><span class="ident" id="6363986">http</span><span class="op" id="6363990">.</span><span class="ident" id="6363991">Transport</span><span class="op" id="6364000">)</span><span class="op" id="6364001">;</span>&nbsp;<span class="ident" id="6364003">ok</span>&nbsp;<span class="op" id="6364006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364010">t</span><span class="op" id="6364011">.</span><span class="ident" id="6364012">CloseIdleConnections</span><span class="op" id="6364032">(</span><span class="op" id="6364033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364036">}</span><br>
<span class="lineno"></span><span class="op" id="6364038">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span><span class="comment" id="6364041">//&nbsp;CloseClientConnections&nbsp;closes&nbsp;any&nbsp;currently&nbsp;open&nbsp;HTTP&nbsp;connections</span><br>
<span class="lineno"></span><span class="comment" id="6364110">//&nbsp;to&nbsp;the&nbsp;test&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="6364133">func</span>&nbsp;<span class="op" id="6364138">(</span><span class="ident" id="6364139">s</span>&nbsp;<span class="op" id="6364141">*</span><span class="ident" id="6364142">Server</span><span class="op" id="6364148">)</span>&nbsp;<span class="ident" id="6364150">CloseClientConnections</span><span class="op" id="6364172">(</span><span class="op" id="6364173">)</span>&nbsp;<span class="op" id="6364175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364178">hl</span><span class="op" id="6364180">,</span>&nbsp;<span class="ident" id="6364182">ok</span>&nbsp;<span class="op" id="6364185">:=</span>&nbsp;<span class="ident" id="6364188">s</span><span class="op" id="6364189">.</span><span class="ident" id="6364190">Listener</span><span class="op" id="6364198">.</span><span class="op" id="6364199">(</span><span class="op" id="6364200">*</span><span class="ident" id="6364201">historyListener</span><span class="op" id="6364216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364219">if</span>&nbsp;<span class="op" id="6364222">!</span><span class="ident" id="6364223">ok</span>&nbsp;<span class="op" id="6364226">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364230">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364241">hl</span><span class="op" id="6364243">.</span><span class="ident" id="6364244">Lock</span><span class="op" id="6364248">(</span><span class="op" id="6364249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364252">for</span>&nbsp;<span class="ident" id="6364256">_</span><span class="op" id="6364257">,</span>&nbsp;<span class="ident" id="6364259">conn</span>&nbsp;<span class="op" id="6364264">:=</span>&nbsp;<span class="keyword" id="6364267">range</span>&nbsp;<span class="ident" id="6364273">hl</span><span class="op" id="6364275">.</span><span class="ident" id="6364276">history</span>&nbsp;<span class="op" id="6364284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364288">conn</span><span class="op" id="6364292">.</span><span class="ident" id="6364293">Close</span><span class="op" id="6364298">(</span><span class="op" id="6364299">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6364302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364305">hl</span><span class="op" id="6364307">.</span><span class="ident" id="6364308">Unlock</span><span class="op" id="6364314">(</span><span class="op" id="6364315">)</span><br>
<span class="lineno"></span><span class="op" id="6364317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6364320">//&nbsp;waitGroupHandler&nbsp;wraps&nbsp;a&nbsp;handler,&nbsp;incrementing&nbsp;and&nbsp;decrementing&nbsp;a</span><br>
<span class="lineno">190</span><span class="comment" id="6364389">//&nbsp;sync.WaitGroup&nbsp;on&nbsp;each&nbsp;request,&nbsp;to&nbsp;enable&nbsp;Server.Close&nbsp;to&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="6364456">//&nbsp;until&nbsp;outstanding&nbsp;requests&nbsp;are&nbsp;finished.</span><br>
<span class="lineno"></span><span class="keyword" id="6364500">type</span>&nbsp;<span class="ident" id="6364505">waitGroupHandler</span>&nbsp;<span class="keyword" id="6364522">struct</span>&nbsp;<span class="op" id="6364529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364532">s</span>&nbsp;<span class="op" id="6364534">*</span><span class="ident" id="6364535">Server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364543">h</span>&nbsp;<span class="ident" id="6364545">http</span><span class="op" id="6364549">.</span><span class="ident" id="6364550">Handler</span>&nbsp;<span class="comment" id="6364558">//&nbsp;non-nil</span><br>
<span class="lineno">195</span><span class="op" id="6364569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6364572">func</span>&nbsp;<span class="op" id="6364577">(</span><span class="ident" id="6364578">h</span>&nbsp;<span class="op" id="6364580">*</span><span class="ident" id="6364581">waitGroupHandler</span><span class="op" id="6364597">)</span>&nbsp;<span class="ident" id="6364599">ServeHTTP</span><span class="op" id="6364608">(</span><span class="ident" id="6364609">w</span>&nbsp;<span class="ident" id="6364611">http</span><span class="op" id="6364615">.</span><span class="ident" id="6364616">ResponseWriter</span><span class="op" id="6364630">,</span>&nbsp;<span class="ident" id="6364632">r</span>&nbsp;<span class="op" id="6364634">*</span><span class="ident" id="6364635">http</span><span class="op" id="6364639">.</span><span class="ident" id="6364640">Request</span><span class="op" id="6364647">)</span>&nbsp;<span class="op" id="6364649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364652">h</span><span class="op" id="6364653">.</span><span class="ident" id="6364654">s</span><span class="op" id="6364655">.</span><span class="ident" id="6364656">wg</span><span class="op" id="6364658">.</span><span class="ident" id="6364659">Add</span><span class="op" id="6364662">(</span><span class="num" id="6364663">1</span><span class="op" id="6364664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6364667">defer</span>&nbsp;<span class="ident" id="6364673">h</span><span class="op" id="6364674">.</span><span class="ident" id="6364675">s</span><span class="op" id="6364676">.</span><span class="ident" id="6364677">wg</span><span class="op" id="6364679">.</span><span class="ident" id="6364680">Done</span><span class="op" id="6364684">(</span><span class="op" id="6364685">)</span>&nbsp;<span class="comment" id="6364687">//&nbsp;a&nbsp;defer,&nbsp;in&nbsp;case&nbsp;ServeHTTP&nbsp;below&nbsp;panics</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6364731">h</span><span class="op" id="6364732">.</span><span class="ident" id="6364733">h</span><span class="op" id="6364734">.</span><span class="ident" id="6364735">ServeHTTP</span><span class="op" id="6364744">(</span><span class="ident" id="6364745">w</span><span class="op" id="6364746">,</span>&nbsp;<span class="ident" id="6364748">r</span><span class="op" id="6364749">)</span><br>
<span class="lineno"></span><span class="op" id="6364751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6364754">//&nbsp;localhostCert&nbsp;is&nbsp;a&nbsp;PEM-encoded&nbsp;TLS&nbsp;cert&nbsp;with&nbsp;SAN&nbsp;IPs</span><br>
<span class="lineno"></span><span class="comment" id="6364810">//&nbsp;&#34;127.0.0.1&#34;&nbsp;and&nbsp;&#34;[::1]&#34;,&nbsp;expiring&nbsp;at&nbsp;the&nbsp;last&nbsp;second&nbsp;of&nbsp;2049&nbsp;(the&nbsp;end</span><br>
<span class="lineno">205</span><span class="comment" id="6364883">//&nbsp;of&nbsp;ASN.1&nbsp;time).</span><br>
<span class="lineno"></span><span class="comment" id="6364902">//&nbsp;generated&nbsp;from&nbsp;src/crypto/tls:</span><br>
<span class="lineno"></span><span class="comment" id="6364936">//&nbsp;go&nbsp;run&nbsp;generate_cert.go&nbsp;&nbsp;--rsa-bits&nbsp;512&nbsp;--host&nbsp;127.0.0.1,::1,example.com&nbsp;--ca&nbsp;--start-date&nbsp;&#34;Jan&nbsp;1&nbsp;00:00:00&nbsp;1970&#34;&nbsp;--duration=1000000h</span><br>
<span class="lineno"></span><span class="keyword" id="6365072">var</span>&nbsp;<span class="ident" id="6365076">localhostCert</span>&nbsp;<span class="op" id="6365090">=</span>&nbsp;<span class="op" id="6365092">[</span><span class="op" id="6365093">]</span><span class="builtintype" id="6365094">byte</span><span class="op" id="6365098">(</span><span class="string" id="6365099">`-----BEGIN&nbsp;CERTIFICATE-----<br>
<span class="lineno"></span>MIIBdzCCASOgAwIBAgIBADALBgkqhkiG9w0BAQUwEjEQMA4GA1UEChMHQWNtZSBD<br>
<span class="lineno">210</span>bzAeFw03MDAxMDEwMDAwMDBaFw00OTEyMzEyMzU5NTlaMBIxEDAOBgNVBAoTB0Fj<br>
<span class="lineno"></span>bWUgQ28wWjALBgkqhkiG9w0BAQEDSwAwSAJBAN55NcYKZeInyTuhcCwFMhDHCmwa<br>
<span class="lineno"></span>IUSdtXdcbItRB/yfXGBhiex00IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEA<br>
<span class="lineno"></span>AaNoMGYwDgYDVR0PAQH/BAQDAgCkMBMGA1UdJQQMMAoGCCsGAQUFBwMBMA8GA1Ud<br>
<span class="lineno"></span>EwEB/wQFMAMBAf8wLgYDVR0RBCcwJYILZXhhbXBsZS5jb22HBH8AAAGHEAAAAAAA<br>
<span class="lineno">215</span>AAAAAAAAAAAAAAEwCwYJKoZIhvcNAQEFA0EAAoQn/ytgqpiLcZu9XKbCJsJcvkgk<br>
<span class="lineno"></span>Se6AbGXgSlq+ZCEVo0qIwSgeBqmsJxUu7NCSOwVJLYNEBO2DtIxoYVk+MA==<br>
<span class="lineno"></span>-----END&nbsp;CERTIFICATE-----`</span><span class="op" id="6365670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6365673">//&nbsp;localhostKey&nbsp;is&nbsp;the&nbsp;private&nbsp;key&nbsp;for&nbsp;localhostCert.</span><br>
<span class="lineno">220</span><span class="keyword" id="6365727">var</span>&nbsp;<span class="ident" id="6365731">localhostKey</span>&nbsp;<span class="op" id="6365744">=</span>&nbsp;<span class="op" id="6365746">[</span><span class="op" id="6365747">]</span><span class="builtintype" id="6365748">byte</span><span class="op" id="6365752">(</span><span class="string" id="6365753">`-----BEGIN&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----<br>
<span class="lineno"></span>MIIBPAIBAAJBAN55NcYKZeInyTuhcCwFMhDHCmwaIUSdtXdcbItRB/yfXGBhiex0<br>
<span class="lineno"></span>0IaLXQnSU+QZPRZWYqeTEbFSgihqi1PUDy8CAwEAAQJBAQdUx66rfh8sYsgfdcvV<br>
<span class="lineno"></span>NoafYpnEcB5s4m/vSVe6SU7dCK6eYec9f9wpT353ljhDUHq3EbmE4foNzJngh35d<br>
<span class="lineno"></span>AekCIQDhRQG5Li0Wj8TM4obOnnXUXf1jRv0UkzE9AHWLG5q3AwIhAPzSjpYUDjVW<br>
<span class="lineno">225</span>MCUXgckTpKCuGwbJk7424Nb8bLzf3kllAiA5mUBgjfr/WtFSJdWcPQ4Zt9KTMNKD<br>
<span class="lineno"></span>EUO0ukpTwEIl6wIhAMbGqZK3zAAFdq8DD2jPx+UJXnh0rnOkZBzDtJ6/iN69AiEA<br>
<span class="lineno"></span>1Aq8MJgTaYsDQWyU/hDq5YkDJc9e9DSCvUIzqxQWMQE=<br>
<span class="lineno"></span>-----END&nbsp;RSA&nbsp;PRIVATE&nbsp;KEY-----`</span><span class="op" id="6366251">)</span>
</div>
</body>
</html>
