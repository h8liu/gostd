<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3717689">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3717744">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3717798">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3717849">package</span>&nbsp;<span class="ident" id="3717857">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3717862">import</span>&nbsp;<span class="op" id="3717869">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717872">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717882">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717898">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717912">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717929">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717944">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717961">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717971">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3717978">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3717983">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3717986">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3718062">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3718114">type</span>&nbsp;<span class="ident" id="3718119">serverHandshakeState</span>&nbsp;<span class="keyword" id="3718140">struct</span>&nbsp;<span class="op" id="3718147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718150">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718166">*</span><span class="ident" id="3718167">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718173">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718189">*</span><span class="ident" id="3718190">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718206">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718222">*</span><span class="ident" id="3718223">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718239">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718255">*</span><span class="ident" id="3718256">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718269">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3718285">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718291">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3718307">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718313">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718329">*</span><span class="ident" id="3718330">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718344">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3718360">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718374">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718390">[</span><span class="op" id="3718391">]</span><span class="builtintype" id="3718392">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718398">certsFromClient</span>&nbsp;<span class="op" id="3718414">[</span><span class="op" id="3718415">]</span><span class="op" id="3718416">[</span><span class="op" id="3718417">]</span><span class="builtintype" id="3718418">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718424">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3718440">*</span><span class="ident" id="3718441">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3718453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3718456">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3718513">func</span>&nbsp;<span class="op" id="3718518">(</span><span class="ident" id="3718519">c</span>&nbsp;<span class="op" id="3718521">*</span><span class="ident" id="3718522">Conn</span><span class="op" id="3718526">)</span>&nbsp;<span class="ident" id="3718528">serverHandshake</span><span class="op" id="3718543">(</span><span class="op" id="3718544">)</span>&nbsp;<span class="builtintype" id="3718546">error</span>&nbsp;<span class="op" id="3718552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718555">config</span>&nbsp;<span class="op" id="3718562">:=</span>&nbsp;<span class="ident" id="3718565">c</span><span class="op" id="3718566">.</span><span class="ident" id="3718567">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3718576">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3718647">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718677">config</span><span class="op" id="3718683">.</span><span class="ident" id="3718684">serverInitOnce</span><span class="op" id="3718698">.</span><span class="ident" id="3718699">Do</span><span class="op" id="3718701">(</span><span class="ident" id="3718702">config</span><span class="op" id="3718708">.</span><span class="ident" id="3718709">serverInit</span><span class="op" id="3718719">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718723">hs</span>&nbsp;<span class="op" id="3718726">:=</span>&nbsp;<span class="ident" id="3718729">serverHandshakeState</span><span class="op" id="3718749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718753">c</span><span class="op" id="3718754">:</span>&nbsp;<span class="ident" id="3718756">c</span><span class="op" id="3718757">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3718760">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3718763">isResume</span><span class="op" id="3718771">,</span>&nbsp;<span class="ident" id="3718773">err</span>&nbsp;<span class="op" id="3718777">:=</span>&nbsp;<span class="ident" id="3718780">hs</span><span class="op" id="3718782">.</span><span class="ident" id="3718783">readClientHello</span><span class="op" id="3718798">(</span><span class="op" id="3718799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3718802">if</span>&nbsp;<span class="ident" id="3718805">err</span>&nbsp;<span class="op" id="3718809">!=</span>&nbsp;<span class="ident" id="3718812">nil</span>&nbsp;<span class="op" id="3718816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3718820">return</span>&nbsp;<span class="ident" id="3718827">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3718832">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3718836">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3718928">if</span>&nbsp;<span class="ident" id="3718931">isResume</span>&nbsp;<span class="op" id="3718940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3718944">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719029">if</span>&nbsp;<span class="ident" id="3719032">err</span>&nbsp;<span class="op" id="3719036">:=</span>&nbsp;<span class="ident" id="3719039">hs</span><span class="op" id="3719041">.</span><span class="ident" id="3719042">doResumeHandshake</span><span class="op" id="3719059">(</span><span class="op" id="3719060">)</span><span class="op" id="3719061">;</span>&nbsp;<span class="ident" id="3719063">err</span>&nbsp;<span class="op" id="3719067">!=</span>&nbsp;<span class="ident" id="3719070">nil</span>&nbsp;<span class="op" id="3719074">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719079">return</span>&nbsp;<span class="ident" id="3719086">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719096">if</span>&nbsp;<span class="ident" id="3719099">err</span>&nbsp;<span class="op" id="3719103">:=</span>&nbsp;<span class="ident" id="3719106">hs</span><span class="op" id="3719108">.</span><span class="ident" id="3719109">establishKeys</span><span class="op" id="3719122">(</span><span class="op" id="3719123">)</span><span class="op" id="3719124">;</span>&nbsp;<span class="ident" id="3719126">err</span>&nbsp;<span class="op" id="3719130">!=</span>&nbsp;<span class="ident" id="3719133">nil</span>&nbsp;<span class="op" id="3719137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719142">return</span>&nbsp;<span class="ident" id="3719149">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719155">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719159">if</span>&nbsp;<span class="ident" id="3719162">err</span>&nbsp;<span class="op" id="3719166">:=</span>&nbsp;<span class="ident" id="3719169">hs</span><span class="op" id="3719171">.</span><span class="ident" id="3719172">sendFinished</span><span class="op" id="3719184">(</span><span class="ident" id="3719185">c</span><span class="op" id="3719186">.</span><span class="ident" id="3719187">firstFinished</span><span class="op" id="3719200">[</span><span class="op" id="3719201">:</span><span class="op" id="3719202">]</span><span class="op" id="3719203">)</span><span class="op" id="3719204">;</span>&nbsp;<span class="ident" id="3719206">err</span>&nbsp;<span class="op" id="3719210">!=</span>&nbsp;<span class="ident" id="3719213">nil</span>&nbsp;<span class="op" id="3719217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719222">return</span>&nbsp;<span class="ident" id="3719229">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719239">if</span>&nbsp;<span class="ident" id="3719242">err</span>&nbsp;<span class="op" id="3719246">:=</span>&nbsp;<span class="ident" id="3719249">hs</span><span class="op" id="3719251">.</span><span class="ident" id="3719252">readFinished</span><span class="op" id="3719264">(</span><span class="ident" id="3719265">nil</span><span class="op" id="3719268">)</span><span class="op" id="3719269">;</span>&nbsp;<span class="ident" id="3719271">err</span>&nbsp;<span class="op" id="3719275">!=</span>&nbsp;<span class="ident" id="3719278">nil</span>&nbsp;<span class="op" id="3719282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719287">return</span>&nbsp;<span class="ident" id="3719294">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3719304">c</span><span class="op" id="3719305">.</span><span class="ident" id="3719306">didResume</span>&nbsp;<span class="op" id="3719316">=</span>&nbsp;<span class="builtintype" id="3719318">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719324">}</span>&nbsp;<span class="keyword" id="3719326">else</span>&nbsp;<span class="op" id="3719331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3719335">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3719397">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719435">if</span>&nbsp;<span class="ident" id="3719438">err</span>&nbsp;<span class="op" id="3719442">:=</span>&nbsp;<span class="ident" id="3719445">hs</span><span class="op" id="3719447">.</span><span class="ident" id="3719448">doFullHandshake</span><span class="op" id="3719463">(</span><span class="op" id="3719464">)</span><span class="op" id="3719465">;</span>&nbsp;<span class="ident" id="3719467">err</span>&nbsp;<span class="op" id="3719471">!=</span>&nbsp;<span class="ident" id="3719474">nil</span>&nbsp;<span class="op" id="3719478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719483">return</span>&nbsp;<span class="ident" id="3719490">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719500">if</span>&nbsp;<span class="ident" id="3719503">err</span>&nbsp;<span class="op" id="3719507">:=</span>&nbsp;<span class="ident" id="3719510">hs</span><span class="op" id="3719512">.</span><span class="ident" id="3719513">establishKeys</span><span class="op" id="3719526">(</span><span class="op" id="3719527">)</span><span class="op" id="3719528">;</span>&nbsp;<span class="ident" id="3719530">err</span>&nbsp;<span class="op" id="3719534">!=</span>&nbsp;<span class="ident" id="3719537">nil</span>&nbsp;<span class="op" id="3719541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719546">return</span>&nbsp;<span class="ident" id="3719553">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719563">if</span>&nbsp;<span class="ident" id="3719566">err</span>&nbsp;<span class="op" id="3719570">:=</span>&nbsp;<span class="ident" id="3719573">hs</span><span class="op" id="3719575">.</span><span class="ident" id="3719576">readFinished</span><span class="op" id="3719588">(</span><span class="ident" id="3719589">c</span><span class="op" id="3719590">.</span><span class="ident" id="3719591">firstFinished</span><span class="op" id="3719604">[</span><span class="op" id="3719605">:</span><span class="op" id="3719606">]</span><span class="op" id="3719607">)</span><span class="op" id="3719608">;</span>&nbsp;<span class="ident" id="3719610">err</span>&nbsp;<span class="op" id="3719614">!=</span>&nbsp;<span class="ident" id="3719617">nil</span>&nbsp;<span class="op" id="3719621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719626">return</span>&nbsp;<span class="ident" id="3719633">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719643">if</span>&nbsp;<span class="ident" id="3719646">err</span>&nbsp;<span class="op" id="3719650">:=</span>&nbsp;<span class="ident" id="3719653">hs</span><span class="op" id="3719655">.</span><span class="ident" id="3719656">sendSessionTicket</span><span class="op" id="3719673">(</span><span class="op" id="3719674">)</span><span class="op" id="3719675">;</span>&nbsp;<span class="ident" id="3719677">err</span>&nbsp;<span class="op" id="3719681">!=</span>&nbsp;<span class="ident" id="3719684">nil</span>&nbsp;<span class="op" id="3719688">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719693">return</span>&nbsp;<span class="ident" id="3719700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719710">if</span>&nbsp;<span class="ident" id="3719713">err</span>&nbsp;<span class="op" id="3719717">:=</span>&nbsp;<span class="ident" id="3719720">hs</span><span class="op" id="3719722">.</span><span class="ident" id="3719723">sendFinished</span><span class="op" id="3719735">(</span><span class="ident" id="3719736">nil</span><span class="op" id="3719739">)</span><span class="op" id="3719740">;</span>&nbsp;<span class="ident" id="3719742">err</span>&nbsp;<span class="op" id="3719746">!=</span>&nbsp;<span class="ident" id="3719749">nil</span>&nbsp;<span class="op" id="3719753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719758">return</span>&nbsp;<span class="ident" id="3719765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719771">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3719774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3719777">c</span><span class="op" id="3719778">.</span><span class="ident" id="3719779">handshakeComplete</span>&nbsp;<span class="op" id="3719797">=</span>&nbsp;<span class="builtintype" id="3719799">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3719806">return</span>&nbsp;<span class="ident" id="3719813">nil</span><br>
<span class="lineno"></span><span class="op" id="3719817">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3719820">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3719895">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3719942">func</span>&nbsp;<span class="op" id="3719947">(</span><span class="ident" id="3719948">hs</span>&nbsp;<span class="op" id="3719951">*</span><span class="ident" id="3719952">serverHandshakeState</span><span class="op" id="3719972">)</span>&nbsp;<span class="ident" id="3719974">readClientHello</span><span class="op" id="3719989">(</span><span class="op" id="3719990">)</span>&nbsp;<span class="op" id="3719992">(</span><span class="ident" id="3719993">isResume</span>&nbsp;<span class="builtintype" id="3720002">bool</span><span class="op" id="3720006">,</span>&nbsp;<span class="ident" id="3720008">err</span>&nbsp;<span class="builtintype" id="3720012">error</span><span class="op" id="3720017">)</span>&nbsp;<span class="op" id="3720019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720022">config</span>&nbsp;<span class="op" id="3720029">:=</span>&nbsp;<span class="ident" id="3720032">hs</span><span class="op" id="3720034">.</span><span class="ident" id="3720035">c</span><span class="op" id="3720036">.</span><span class="ident" id="3720037">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720045">c</span>&nbsp;<span class="op" id="3720047">:=</span>&nbsp;<span class="ident" id="3720050">hs</span><span class="op" id="3720052">.</span><span class="ident" id="3720053">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720057">msg</span><span class="op" id="3720060">,</span>&nbsp;<span class="ident" id="3720062">err</span>&nbsp;<span class="op" id="3720066">:=</span>&nbsp;<span class="ident" id="3720069">c</span><span class="op" id="3720070">.</span><span class="ident" id="3720071">readHandshake</span><span class="op" id="3720084">(</span><span class="op" id="3720085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720088">if</span>&nbsp;<span class="ident" id="3720091">err</span>&nbsp;<span class="op" id="3720095">!=</span>&nbsp;<span class="ident" id="3720098">nil</span>&nbsp;<span class="op" id="3720102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720106">return</span>&nbsp;<span class="builtintype" id="3720113">false</span><span class="op" id="3720118">,</span>&nbsp;<span class="ident" id="3720120">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720128">var</span>&nbsp;<span class="ident" id="3720132">ok</span>&nbsp;<span class="builtintype" id="3720135">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720141">hs</span><span class="op" id="3720143">.</span><span class="ident" id="3720144">clientHello</span><span class="op" id="3720155">,</span>&nbsp;<span class="ident" id="3720157">ok</span>&nbsp;<span class="op" id="3720160">=</span>&nbsp;<span class="ident" id="3720162">msg</span><span class="op" id="3720165">.</span><span class="op" id="3720166">(</span><span class="op" id="3720167">*</span><span class="ident" id="3720168">clientHelloMsg</span><span class="op" id="3720182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720185">if</span>&nbsp;<span class="op" id="3720188">!</span><span class="ident" id="3720189">ok</span>&nbsp;<span class="op" id="3720192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720196">c</span><span class="op" id="3720197">.</span><span class="ident" id="3720198">sendAlert</span><span class="op" id="3720207">(</span><span class="ident" id="3720208">alertUnexpectedMessage</span><span class="op" id="3720230">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720234">return</span>&nbsp;<span class="builtintype" id="3720241">false</span><span class="op" id="3720246">,</span>&nbsp;<span class="ident" id="3720248">unexpectedMessageError</span><span class="op" id="3720270">(</span><span class="ident" id="3720271">hs</span><span class="op" id="3720273">.</span><span class="ident" id="3720274">clientHello</span><span class="op" id="3720285">,</span>&nbsp;<span class="ident" id="3720287">msg</span><span class="op" id="3720290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720296">c</span><span class="op" id="3720297">.</span><span class="ident" id="3720298">vers</span><span class="op" id="3720302">,</span>&nbsp;<span class="ident" id="3720304">ok</span>&nbsp;<span class="op" id="3720307">=</span>&nbsp;<span class="ident" id="3720309">config</span><span class="op" id="3720315">.</span><span class="ident" id="3720316">mutualVersion</span><span class="op" id="3720329">(</span><span class="ident" id="3720330">hs</span><span class="op" id="3720332">.</span><span class="ident" id="3720333">clientHello</span><span class="op" id="3720344">.</span><span class="ident" id="3720345">vers</span><span class="op" id="3720349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720352">if</span>&nbsp;<span class="op" id="3720355">!</span><span class="ident" id="3720356">ok</span>&nbsp;<span class="op" id="3720359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720363">c</span><span class="op" id="3720364">.</span><span class="ident" id="3720365">sendAlert</span><span class="op" id="3720374">(</span><span class="ident" id="3720375">alertProtocolVersion</span><span class="op" id="3720395">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720399">return</span>&nbsp;<span class="builtintype" id="3720406">false</span><span class="op" id="3720411">,</span>&nbsp;<span class="ident" id="3720413">fmt</span><span class="op" id="3720416">.</span><span class="ident" id="3720417">Errorf</span><span class="op" id="3720423">(</span><span class="string" id="3720424">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3720492">,</span>&nbsp;<span class="ident" id="3720494">hs</span><span class="op" id="3720496">.</span><span class="ident" id="3720497">clientHello</span><span class="op" id="3720508">.</span><span class="ident" id="3720509">vers</span><span class="op" id="3720513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720516">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720519">c</span><span class="op" id="3720520">.</span><span class="ident" id="3720521">haveVers</span>&nbsp;<span class="op" id="3720530">=</span>&nbsp;<span class="builtintype" id="3720532">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720539">hs</span><span class="op" id="3720541">.</span><span class="ident" id="3720542">finishedHash</span>&nbsp;<span class="op" id="3720555">=</span>&nbsp;<span class="ident" id="3720557">newFinishedHash</span><span class="op" id="3720572">(</span><span class="ident" id="3720573">c</span><span class="op" id="3720574">.</span><span class="ident" id="3720575">vers</span><span class="op" id="3720579">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720582">hs</span><span class="op" id="3720584">.</span><span class="ident" id="3720585">finishedHash</span><span class="op" id="3720597">.</span><span class="ident" id="3720598">Write</span><span class="op" id="3720603">(</span><span class="ident" id="3720604">hs</span><span class="op" id="3720606">.</span><span class="ident" id="3720607">clientHello</span><span class="op" id="3720618">.</span><span class="ident" id="3720619">marshal</span><span class="op" id="3720626">(</span><span class="op" id="3720627">)</span><span class="op" id="3720628">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720632">hs</span><span class="op" id="3720634">.</span><span class="ident" id="3720635">hello</span>&nbsp;<span class="op" id="3720641">=</span>&nbsp;<span class="builtinfunc" id="3720643">new</span><span class="op" id="3720646">(</span><span class="ident" id="3720647">serverHelloMsg</span><span class="op" id="3720661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720665">supportedCurve</span>&nbsp;<span class="op" id="3720680">:=</span>&nbsp;<span class="builtintype" id="3720683">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720690">preferredCurves</span>&nbsp;<span class="op" id="3720706">:=</span>&nbsp;<span class="ident" id="3720709">config</span><span class="op" id="3720715">.</span><span class="ident" id="3720716">curvePreferences</span><span class="op" id="3720732">(</span><span class="op" id="3720733">)</span><br>
<span class="lineno"></span><span class="ident" id="3720735">Curves</span><span class="op" id="3720741">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720744">for</span>&nbsp;<span class="ident" id="3720748">_</span><span class="op" id="3720749">,</span>&nbsp;<span class="ident" id="3720751">curve</span>&nbsp;<span class="op" id="3720757">:=</span>&nbsp;<span class="keyword" id="3720760">range</span>&nbsp;<span class="ident" id="3720766">hs</span><span class="op" id="3720768">.</span><span class="ident" id="3720769">clientHello</span><span class="op" id="3720780">.</span><span class="ident" id="3720781">supportedCurves</span>&nbsp;<span class="op" id="3720797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720801">for</span>&nbsp;<span class="ident" id="3720805">_</span><span class="op" id="3720806">,</span>&nbsp;<span class="ident" id="3720808">supported</span>&nbsp;<span class="op" id="3720818">:=</span>&nbsp;<span class="keyword" id="3720821">range</span>&nbsp;<span class="ident" id="3720827">preferredCurves</span>&nbsp;<span class="op" id="3720843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720848">if</span>&nbsp;<span class="ident" id="3720851">supported</span>&nbsp;<span class="op" id="3720861">==</span>&nbsp;<span class="ident" id="3720864">curve</span>&nbsp;<span class="op" id="3720870">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720876">supportedCurve</span>&nbsp;<span class="op" id="3720891">=</span>&nbsp;<span class="builtintype" id="3720893">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720902">break</span>&nbsp;<span class="ident" id="3720908">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720918">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3720925">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3720929">supportedPointFormat</span>&nbsp;<span class="op" id="3720950">:=</span>&nbsp;<span class="builtintype" id="3720953">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3720960">for</span>&nbsp;<span class="ident" id="3720964">_</span><span class="op" id="3720965">,</span>&nbsp;<span class="ident" id="3720967">pointFormat</span>&nbsp;<span class="op" id="3720979">:=</span>&nbsp;<span class="keyword" id="3720982">range</span>&nbsp;<span class="ident" id="3720988">hs</span><span class="op" id="3720990">.</span><span class="ident" id="3720991">clientHello</span><span class="op" id="3721002">.</span><span class="ident" id="3721003">supportedPoints</span>&nbsp;<span class="op" id="3721019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721023">if</span>&nbsp;<span class="ident" id="3721026">pointFormat</span>&nbsp;<span class="op" id="3721038">==</span>&nbsp;<span class="ident" id="3721041">pointFormatUncompressed</span>&nbsp;<span class="op" id="3721065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721070">supportedPointFormat</span>&nbsp;<span class="op" id="3721091">=</span>&nbsp;<span class="builtintype" id="3721093">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721101">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721115">hs</span><span class="op" id="3721117">.</span><span class="ident" id="3721118">ellipticOk</span>&nbsp;<span class="op" id="3721129">=</span>&nbsp;<span class="ident" id="3721131">supportedCurve</span>&nbsp;<span class="op" id="3721146">&amp;&amp;</span>&nbsp;<span class="ident" id="3721149">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721172">foundCompression</span>&nbsp;<span class="op" id="3721189">:=</span>&nbsp;<span class="builtintype" id="3721192">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3721199">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721274">for</span>&nbsp;<span class="ident" id="3721278">_</span><span class="op" id="3721279">,</span>&nbsp;<span class="ident" id="3721281">compression</span>&nbsp;<span class="op" id="3721293">:=</span>&nbsp;<span class="keyword" id="3721296">range</span>&nbsp;<span class="ident" id="3721302">hs</span><span class="op" id="3721304">.</span><span class="ident" id="3721305">clientHello</span><span class="op" id="3721316">.</span><span class="ident" id="3721317">compressionMethods</span>&nbsp;<span class="op" id="3721336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721340">if</span>&nbsp;<span class="ident" id="3721343">compression</span>&nbsp;<span class="op" id="3721355">==</span>&nbsp;<span class="ident" id="3721358">compressionNone</span>&nbsp;<span class="op" id="3721374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721379">foundCompression</span>&nbsp;<span class="op" id="3721396">=</span>&nbsp;<span class="builtintype" id="3721398">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721406">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721417">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721421">if</span>&nbsp;<span class="op" id="3721424">!</span><span class="ident" id="3721425">foundCompression</span>&nbsp;<span class="op" id="3721442">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721446">c</span><span class="op" id="3721447">.</span><span class="ident" id="3721448">sendAlert</span><span class="op" id="3721457">(</span><span class="ident" id="3721458">alertHandshakeFailure</span><span class="op" id="3721479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721483">return</span>&nbsp;<span class="builtintype" id="3721490">false</span><span class="op" id="3721495">,</span>&nbsp;<span class="ident" id="3721497">errors</span><span class="op" id="3721503">.</span><span class="ident" id="3721504">New</span><span class="op" id="3721507">(</span><span class="string" id="3721508">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3721563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721570">hs</span><span class="op" id="3721572">.</span><span class="ident" id="3721573">hello</span><span class="op" id="3721578">.</span><span class="ident" id="3721579">vers</span>&nbsp;<span class="op" id="3721584">=</span>&nbsp;<span class="ident" id="3721586">c</span><span class="op" id="3721587">.</span><span class="ident" id="3721588">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721594">hs</span><span class="op" id="3721596">.</span><span class="ident" id="3721597">hello</span><span class="op" id="3721602">.</span><span class="ident" id="3721603">random</span>&nbsp;<span class="op" id="3721610">=</span>&nbsp;<span class="builtinfunc" id="3721612">make</span><span class="op" id="3721616">(</span><span class="op" id="3721617">[</span><span class="op" id="3721618">]</span><span class="builtintype" id="3721619">byte</span><span class="op" id="3721623">,</span>&nbsp;<span class="num" id="3721625">32</span><span class="op" id="3721627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721630">_</span><span class="op" id="3721631">,</span>&nbsp;<span class="ident" id="3721633">err</span>&nbsp;<span class="op" id="3721637">=</span>&nbsp;<span class="ident" id="3721639">io</span><span class="op" id="3721641">.</span><span class="ident" id="3721642">ReadFull</span><span class="op" id="3721650">(</span><span class="ident" id="3721651">config</span><span class="op" id="3721657">.</span><span class="ident" id="3721658">rand</span><span class="op" id="3721662">(</span><span class="op" id="3721663">)</span><span class="op" id="3721664">,</span>&nbsp;<span class="ident" id="3721666">hs</span><span class="op" id="3721668">.</span><span class="ident" id="3721669">hello</span><span class="op" id="3721674">.</span><span class="ident" id="3721675">random</span><span class="op" id="3721681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721684">if</span>&nbsp;<span class="ident" id="3721687">err</span>&nbsp;<span class="op" id="3721691">!=</span>&nbsp;<span class="ident" id="3721694">nil</span>&nbsp;<span class="op" id="3721698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721702">c</span><span class="op" id="3721703">.</span><span class="ident" id="3721704">sendAlert</span><span class="op" id="3721713">(</span><span class="ident" id="3721714">alertInternalError</span><span class="op" id="3721732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721736">return</span>&nbsp;<span class="builtintype" id="3721743">false</span><span class="op" id="3721748">,</span>&nbsp;<span class="ident" id="3721750">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721755">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721758">hs</span><span class="op" id="3721760">.</span><span class="ident" id="3721761">hello</span><span class="op" id="3721766">.</span><span class="ident" id="3721767">secureRenegotiation</span>&nbsp;<span class="op" id="3721787">=</span>&nbsp;<span class="ident" id="3721789">hs</span><span class="op" id="3721791">.</span><span class="ident" id="3721792">clientHello</span><span class="op" id="3721803">.</span><span class="ident" id="3721804">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721825">hs</span><span class="op" id="3721827">.</span><span class="ident" id="3721828">hello</span><span class="op" id="3721833">.</span><span class="ident" id="3721834">compressionMethod</span>&nbsp;<span class="op" id="3721852">=</span>&nbsp;<span class="ident" id="3721854">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721871">if</span>&nbsp;<span class="builtinfunc" id="3721874">len</span><span class="op" id="3721877">(</span><span class="ident" id="3721878">hs</span><span class="op" id="3721880">.</span><span class="ident" id="3721881">clientHello</span><span class="op" id="3721892">.</span><span class="ident" id="3721893">serverName</span><span class="op" id="3721903">)</span>&nbsp;<span class="op" id="3721905">&gt;</span>&nbsp;<span class="num" id="3721907">0</span>&nbsp;<span class="op" id="3721909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3721913">c</span><span class="op" id="3721914">.</span><span class="ident" id="3721915">serverName</span>&nbsp;<span class="op" id="3721926">=</span>&nbsp;<span class="ident" id="3721928">hs</span><span class="op" id="3721930">.</span><span class="ident" id="3721931">clientHello</span><span class="op" id="3721942">.</span><span class="ident" id="3721943">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3721955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3721959">if</span>&nbsp;<span class="builtinfunc" id="3721962">len</span><span class="op" id="3721965">(</span><span class="ident" id="3721966">hs</span><span class="op" id="3721968">.</span><span class="ident" id="3721969">clientHello</span><span class="op" id="3721980">.</span><span class="ident" id="3721981">alpnProtocols</span><span class="op" id="3721994">)</span>&nbsp;<span class="op" id="3721996">&gt;</span>&nbsp;<span class="num" id="3721998">0</span>&nbsp;<span class="op" id="3722000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722004">if</span>&nbsp;<span class="ident" id="3722007">selectedProto</span><span class="op" id="3722020">,</span>&nbsp;<span class="ident" id="3722022">fallback</span>&nbsp;<span class="op" id="3722031">:=</span>&nbsp;<span class="ident" id="3722034">mutualProtocol</span><span class="op" id="3722048">(</span><span class="ident" id="3722049">hs</span><span class="op" id="3722051">.</span><span class="ident" id="3722052">clientHello</span><span class="op" id="3722063">.</span><span class="ident" id="3722064">alpnProtocols</span><span class="op" id="3722077">,</span>&nbsp;<span class="ident" id="3722079">c</span><span class="op" id="3722080">.</span><span class="ident" id="3722081">config</span><span class="op" id="3722087">.</span><span class="ident" id="3722088">NextProtos</span><span class="op" id="3722098">)</span><span class="op" id="3722099">;</span>&nbsp;<span class="op" id="3722101">!</span><span class="ident" id="3722102">fallback</span>&nbsp;<span class="op" id="3722111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722116">hs</span><span class="op" id="3722118">.</span><span class="ident" id="3722119">hello</span><span class="op" id="3722124">.</span><span class="ident" id="3722125">alpnProtocol</span>&nbsp;<span class="op" id="3722138">=</span>&nbsp;<span class="ident" id="3722140">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722157">c</span><span class="op" id="3722158">.</span><span class="ident" id="3722159">clientProtocol</span>&nbsp;<span class="op" id="3722174">=</span>&nbsp;<span class="ident" id="3722176">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722195">}</span>&nbsp;<span class="keyword" id="3722197">else</span>&nbsp;<span class="op" id="3722202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3722206">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3722278">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3722337">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3722374">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722431">if</span>&nbsp;<span class="ident" id="3722434">hs</span><span class="op" id="3722436">.</span><span class="ident" id="3722437">clientHello</span><span class="op" id="3722448">.</span><span class="ident" id="3722449">nextProtoNeg</span>&nbsp;<span class="op" id="3722462">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3722465">len</span><span class="op" id="3722468">(</span><span class="ident" id="3722469">config</span><span class="op" id="3722475">.</span><span class="ident" id="3722476">NextProtos</span><span class="op" id="3722486">)</span>&nbsp;<span class="op" id="3722488">&gt;</span>&nbsp;<span class="num" id="3722490">0</span>&nbsp;<span class="op" id="3722492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722497">hs</span><span class="op" id="3722499">.</span><span class="ident" id="3722500">hello</span><span class="op" id="3722505">.</span><span class="ident" id="3722506">nextProtoNeg</span>&nbsp;<span class="op" id="3722519">=</span>&nbsp;<span class="builtintype" id="3722521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722529">hs</span><span class="op" id="3722531">.</span><span class="ident" id="3722532">hello</span><span class="op" id="3722537">.</span><span class="ident" id="3722538">nextProtos</span>&nbsp;<span class="op" id="3722549">=</span>&nbsp;<span class="ident" id="3722551">config</span><span class="op" id="3722557">.</span><span class="ident" id="3722558">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722578">if</span>&nbsp;<span class="builtinfunc" id="3722581">len</span><span class="op" id="3722584">(</span><span class="ident" id="3722585">config</span><span class="op" id="3722591">.</span><span class="ident" id="3722592">Certificates</span><span class="op" id="3722604">)</span>&nbsp;<span class="op" id="3722606">==</span>&nbsp;<span class="num" id="3722609">0</span>&nbsp;<span class="op" id="3722611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722615">c</span><span class="op" id="3722616">.</span><span class="ident" id="3722617">sendAlert</span><span class="op" id="3722626">(</span><span class="ident" id="3722627">alertInternalError</span><span class="op" id="3722645">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722649">return</span>&nbsp;<span class="builtintype" id="3722656">false</span><span class="op" id="3722661">,</span>&nbsp;<span class="ident" id="3722663">errors</span><span class="op" id="3722669">.</span><span class="ident" id="3722670">New</span><span class="op" id="3722673">(</span><span class="string" id="3722674">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3722707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3722710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722713">hs</span><span class="op" id="3722715">.</span><span class="ident" id="3722716">cert</span>&nbsp;<span class="op" id="3722721">=</span>&nbsp;<span class="op" id="3722723">&amp;</span><span class="ident" id="3722724">config</span><span class="op" id="3722730">.</span><span class="ident" id="3722731">Certificates</span><span class="op" id="3722743">[</span><span class="num" id="3722744">0</span><span class="op" id="3722745">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3722748">if</span>&nbsp;<span class="builtinfunc" id="3722751">len</span><span class="op" id="3722754">(</span><span class="ident" id="3722755">hs</span><span class="op" id="3722757">.</span><span class="ident" id="3722758">clientHello</span><span class="op" id="3722769">.</span><span class="ident" id="3722770">serverName</span><span class="op" id="3722780">)</span>&nbsp;<span class="op" id="3722782">&gt;</span>&nbsp;<span class="num" id="3722784">0</span>&nbsp;<span class="op" id="3722786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722790">chi</span>&nbsp;<span class="op" id="3722794">:=</span>&nbsp;<span class="op" id="3722797">&amp;</span><span class="ident" id="3722798">ClientHelloInfo</span><span class="op" id="3722813">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722818">CipherSuites</span><span class="op" id="3722830">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3722835">hs</span><span class="op" id="3722837">.</span><span class="ident" id="3722838">clientHello</span><span class="op" id="3722849">.</span><span class="ident" id="3722850">cipherSuites</span><span class="op" id="3722862">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722867">ServerName</span><span class="op" id="3722877">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3722884">hs</span><span class="op" id="3722886">.</span><span class="ident" id="3722887">clientHello</span><span class="op" id="3722898">.</span><span class="ident" id="3722899">serverName</span><span class="op" id="3722909">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722914">SupportedCurves</span><span class="op" id="3722929">:</span>&nbsp;<span class="ident" id="3722931">hs</span><span class="op" id="3722933">.</span><span class="ident" id="3722934">clientHello</span><span class="op" id="3722945">.</span><span class="ident" id="3722946">supportedCurves</span><span class="op" id="3722961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3722966">SupportedPoints</span><span class="op" id="3722981">:</span>&nbsp;<span class="ident" id="3722983">hs</span><span class="op" id="3722985">.</span><span class="ident" id="3722986">clientHello</span><span class="op" id="3722997">.</span><span class="ident" id="3722998">supportedPoints</span><span class="op" id="3723013">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723017">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723021">if</span>&nbsp;<span class="ident" id="3723024">hs</span><span class="op" id="3723026">.</span><span class="ident" id="3723027">cert</span><span class="op" id="3723031">,</span>&nbsp;<span class="ident" id="3723033">err</span>&nbsp;<span class="op" id="3723037">=</span>&nbsp;<span class="ident" id="3723039">config</span><span class="op" id="3723045">.</span><span class="ident" id="3723046">getCertificate</span><span class="op" id="3723060">(</span><span class="ident" id="3723061">chi</span><span class="op" id="3723064">)</span><span class="op" id="3723065">;</span>&nbsp;<span class="ident" id="3723067">err</span>&nbsp;<span class="op" id="3723071">!=</span>&nbsp;<span class="ident" id="3723074">nil</span>&nbsp;<span class="op" id="3723078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723083">c</span><span class="op" id="3723084">.</span><span class="ident" id="3723085">sendAlert</span><span class="op" id="3723094">(</span><span class="ident" id="3723095">alertInternalError</span><span class="op" id="3723113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723118">return</span>&nbsp;<span class="builtintype" id="3723125">false</span><span class="op" id="3723130">,</span>&nbsp;<span class="ident" id="3723132">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723141">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723145">_</span><span class="op" id="3723146">,</span>&nbsp;<span class="ident" id="3723148">hs</span><span class="op" id="3723150">.</span><span class="ident" id="3723151">ecdsaOk</span>&nbsp;<span class="op" id="3723159">=</span>&nbsp;<span class="ident" id="3723161">hs</span><span class="op" id="3723163">.</span><span class="ident" id="3723164">cert</span><span class="op" id="3723168">.</span><span class="ident" id="3723169">PrivateKey</span><span class="op" id="3723179">.</span><span class="op" id="3723180">(</span><span class="op" id="3723181">*</span><span class="ident" id="3723182">ecdsa</span><span class="op" id="3723187">.</span><span class="ident" id="3723188">PrivateKey</span><span class="op" id="3723198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723202">if</span>&nbsp;<span class="ident" id="3723205">hs</span><span class="op" id="3723207">.</span><span class="ident" id="3723208">checkForResumption</span><span class="op" id="3723226">(</span><span class="op" id="3723227">)</span>&nbsp;<span class="op" id="3723229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723233">return</span>&nbsp;<span class="builtintype" id="3723240">true</span><span class="op" id="3723244">,</span>&nbsp;<span class="ident" id="3723246">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723255">var</span>&nbsp;<span class="ident" id="3723259">preferenceList</span><span class="op" id="3723273">,</span>&nbsp;<span class="ident" id="3723275">supportedList</span>&nbsp;<span class="op" id="3723289">[</span><span class="op" id="3723290">]</span><span class="builtintype" id="3723291">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723299">if</span>&nbsp;<span class="ident" id="3723302">c</span><span class="op" id="3723303">.</span><span class="ident" id="3723304">config</span><span class="op" id="3723310">.</span><span class="ident" id="3723311">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3723336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723340">preferenceList</span>&nbsp;<span class="op" id="3723355">=</span>&nbsp;<span class="ident" id="3723357">c</span><span class="op" id="3723358">.</span><span class="ident" id="3723359">config</span><span class="op" id="3723365">.</span><span class="ident" id="3723366">cipherSuites</span><span class="op" id="3723378">(</span><span class="op" id="3723379">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723383">supportedList</span>&nbsp;<span class="op" id="3723397">=</span>&nbsp;<span class="ident" id="3723399">hs</span><span class="op" id="3723401">.</span><span class="ident" id="3723402">clientHello</span><span class="op" id="3723413">.</span><span class="ident" id="3723414">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723428">}</span>&nbsp;<span class="keyword" id="3723430">else</span>&nbsp;<span class="op" id="3723435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723439">preferenceList</span>&nbsp;<span class="op" id="3723454">=</span>&nbsp;<span class="ident" id="3723456">hs</span><span class="op" id="3723458">.</span><span class="ident" id="3723459">clientHello</span><span class="op" id="3723470">.</span><span class="ident" id="3723471">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723486">supportedList</span>&nbsp;<span class="op" id="3723500">=</span>&nbsp;<span class="ident" id="3723502">c</span><span class="op" id="3723503">.</span><span class="ident" id="3723504">config</span><span class="op" id="3723510">.</span><span class="ident" id="3723511">cipherSuites</span><span class="op" id="3723523">(</span><span class="op" id="3723524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723527">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723531">for</span>&nbsp;<span class="ident" id="3723535">_</span><span class="op" id="3723536">,</span>&nbsp;<span class="ident" id="3723538">id</span>&nbsp;<span class="op" id="3723541">:=</span>&nbsp;<span class="keyword" id="3723544">range</span>&nbsp;<span class="ident" id="3723550">preferenceList</span>&nbsp;<span class="op" id="3723565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723569">if</span>&nbsp;<span class="ident" id="3723572">hs</span><span class="op" id="3723574">.</span><span class="ident" id="3723575">suite</span>&nbsp;<span class="op" id="3723581">=</span>&nbsp;<span class="ident" id="3723583">c</span><span class="op" id="3723584">.</span><span class="ident" id="3723585">tryCipherSuite</span><span class="op" id="3723599">(</span><span class="ident" id="3723600">id</span><span class="op" id="3723602">,</span>&nbsp;<span class="ident" id="3723604">supportedList</span><span class="op" id="3723617">,</span>&nbsp;<span class="ident" id="3723619">c</span><span class="op" id="3723620">.</span><span class="ident" id="3723621">vers</span><span class="op" id="3723625">,</span>&nbsp;<span class="ident" id="3723627">hs</span><span class="op" id="3723629">.</span><span class="ident" id="3723630">ellipticOk</span><span class="op" id="3723640">,</span>&nbsp;<span class="ident" id="3723642">hs</span><span class="op" id="3723644">.</span><span class="ident" id="3723645">ecdsaOk</span><span class="op" id="3723652">)</span><span class="op" id="3723653">;</span>&nbsp;<span class="ident" id="3723655">hs</span><span class="op" id="3723657">.</span><span class="ident" id="3723658">suite</span>&nbsp;<span class="op" id="3723664">!=</span>&nbsp;<span class="ident" id="3723667">nil</span>&nbsp;<span class="op" id="3723671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723676">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723684">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723691">if</span>&nbsp;<span class="ident" id="3723694">hs</span><span class="op" id="3723696">.</span><span class="ident" id="3723697">suite</span>&nbsp;<span class="op" id="3723703">==</span>&nbsp;<span class="ident" id="3723706">nil</span>&nbsp;<span class="op" id="3723710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3723714">c</span><span class="op" id="3723715">.</span><span class="ident" id="3723716">sendAlert</span><span class="op" id="3723725">(</span><span class="ident" id="3723726">alertHandshakeFailure</span><span class="op" id="3723747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723751">return</span>&nbsp;<span class="builtintype" id="3723758">false</span><span class="op" id="3723763">,</span>&nbsp;<span class="ident" id="3723765">errors</span><span class="op" id="3723771">.</span><span class="ident" id="3723772">New</span><span class="op" id="3723775">(</span><span class="string" id="3723776">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3723834">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3723837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3723841">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723911">for</span>&nbsp;<span class="ident" id="3723915">_</span><span class="op" id="3723916">,</span>&nbsp;<span class="ident" id="3723918">id</span>&nbsp;<span class="op" id="3723921">:=</span>&nbsp;<span class="keyword" id="3723924">range</span>&nbsp;<span class="ident" id="3723930">hs</span><span class="op" id="3723932">.</span><span class="ident" id="3723933">clientHello</span><span class="op" id="3723944">.</span><span class="ident" id="3723945">cipherSuites</span>&nbsp;<span class="op" id="3723958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3723962">if</span>&nbsp;<span class="ident" id="3723965">id</span>&nbsp;<span class="op" id="3723968">==</span>&nbsp;<span class="ident" id="3723971">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3723989">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3723994">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724043">if</span>&nbsp;<span class="ident" id="3724046">hs</span><span class="op" id="3724048">.</span><span class="ident" id="3724049">clientHello</span><span class="op" id="3724060">.</span><span class="ident" id="3724061">vers</span>&nbsp;<span class="op" id="3724066">&lt;</span>&nbsp;<span class="ident" id="3724068">c</span><span class="op" id="3724069">.</span><span class="ident" id="3724070">config</span><span class="op" id="3724076">.</span><span class="ident" id="3724077">MaxVersion</span>&nbsp;<span class="op" id="3724088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724094">c</span><span class="op" id="3724095">.</span><span class="ident" id="3724096">sendAlert</span><span class="op" id="3724105">(</span><span class="ident" id="3724106">alertInappropriateFallback</span><span class="op" id="3724132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724138">return</span>&nbsp;<span class="builtintype" id="3724145">false</span><span class="op" id="3724150">,</span>&nbsp;<span class="ident" id="3724152">errors</span><span class="op" id="3724158">.</span><span class="ident" id="3724159">New</span><span class="op" id="3724162">(</span><span class="string" id="3724163">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3724213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724218">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724223">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724234">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724238">return</span>&nbsp;<span class="builtintype" id="3724245">false</span><span class="op" id="3724250">,</span>&nbsp;<span class="ident" id="3724252">nil</span><br>
<span class="lineno">240</span><span class="op" id="3724256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3724259">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3724346">func</span>&nbsp;<span class="op" id="3724351">(</span><span class="ident" id="3724352">hs</span>&nbsp;<span class="op" id="3724355">*</span><span class="ident" id="3724356">serverHandshakeState</span><span class="op" id="3724376">)</span>&nbsp;<span class="ident" id="3724378">checkForResumption</span><span class="op" id="3724396">(</span><span class="op" id="3724397">)</span>&nbsp;<span class="builtintype" id="3724399">bool</span>&nbsp;<span class="op" id="3724404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724407">c</span>&nbsp;<span class="op" id="3724409">:=</span>&nbsp;<span class="ident" id="3724412">hs</span><span class="op" id="3724414">.</span><span class="ident" id="3724415">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724419">if</span>&nbsp;<span class="ident" id="3724422">c</span><span class="op" id="3724423">.</span><span class="ident" id="3724424">config</span><span class="op" id="3724430">.</span><span class="ident" id="3724431">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3724454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724458">return</span>&nbsp;<span class="builtintype" id="3724465">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724476">var</span>&nbsp;<span class="ident" id="3724480">ok</span>&nbsp;<span class="builtintype" id="3724483">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724489">if</span>&nbsp;<span class="ident" id="3724492">hs</span><span class="op" id="3724494">.</span><span class="ident" id="3724495">sessionState</span><span class="op" id="3724507">,</span>&nbsp;<span class="ident" id="3724509">ok</span>&nbsp;<span class="op" id="3724512">=</span>&nbsp;<span class="ident" id="3724514">c</span><span class="op" id="3724515">.</span><span class="ident" id="3724516">decryptTicket</span><span class="op" id="3724529">(</span><span class="ident" id="3724530">hs</span><span class="op" id="3724532">.</span><span class="ident" id="3724533">clientHello</span><span class="op" id="3724544">.</span><span class="ident" id="3724545">sessionTicket</span><span class="op" id="3724558">)</span><span class="op" id="3724559">;</span>&nbsp;<span class="op" id="3724561">!</span><span class="ident" id="3724562">ok</span>&nbsp;<span class="op" id="3724565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724569">return</span>&nbsp;<span class="builtintype" id="3724576">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724583">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724587">if</span>&nbsp;<span class="ident" id="3724590">hs</span><span class="op" id="3724592">.</span><span class="ident" id="3724593">sessionState</span><span class="op" id="3724605">.</span><span class="ident" id="3724606">vers</span>&nbsp;<span class="op" id="3724611">&gt;</span>&nbsp;<span class="ident" id="3724613">hs</span><span class="op" id="3724615">.</span><span class="ident" id="3724616">clientHello</span><span class="op" id="3724627">.</span><span class="ident" id="3724628">vers</span>&nbsp;<span class="op" id="3724633">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724637">return</span>&nbsp;<span class="builtintype" id="3724644">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724654">if</span>&nbsp;<span class="ident" id="3724657">vers</span><span class="op" id="3724661">,</span>&nbsp;<span class="ident" id="3724663">ok</span>&nbsp;<span class="op" id="3724666">:=</span>&nbsp;<span class="ident" id="3724669">c</span><span class="op" id="3724670">.</span><span class="ident" id="3724671">config</span><span class="op" id="3724677">.</span><span class="ident" id="3724678">mutualVersion</span><span class="op" id="3724691">(</span><span class="ident" id="3724692">hs</span><span class="op" id="3724694">.</span><span class="ident" id="3724695">sessionState</span><span class="op" id="3724707">.</span><span class="ident" id="3724708">vers</span><span class="op" id="3724712">)</span><span class="op" id="3724713">;</span>&nbsp;<span class="op" id="3724715">!</span><span class="ident" id="3724716">ok</span>&nbsp;<span class="op" id="3724719">||</span>&nbsp;<span class="ident" id="3724722">vers</span>&nbsp;<span class="op" id="3724727">!=</span>&nbsp;<span class="ident" id="3724730">hs</span><span class="op" id="3724732">.</span><span class="ident" id="3724733">sessionState</span><span class="op" id="3724745">.</span><span class="ident" id="3724746">vers</span>&nbsp;<span class="op" id="3724751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724755">return</span>&nbsp;<span class="builtintype" id="3724762">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724773">cipherSuiteOk</span>&nbsp;<span class="op" id="3724787">:=</span>&nbsp;<span class="builtintype" id="3724790">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3724797">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724873">for</span>&nbsp;<span class="ident" id="3724877">_</span><span class="op" id="3724878">,</span>&nbsp;<span class="ident" id="3724880">id</span>&nbsp;<span class="op" id="3724883">:=</span>&nbsp;<span class="keyword" id="3724886">range</span>&nbsp;<span class="ident" id="3724892">hs</span><span class="op" id="3724894">.</span><span class="ident" id="3724895">clientHello</span><span class="op" id="3724906">.</span><span class="ident" id="3724907">cipherSuites</span>&nbsp;<span class="op" id="3724920">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724924">if</span>&nbsp;<span class="ident" id="3724927">id</span>&nbsp;<span class="op" id="3724930">==</span>&nbsp;<span class="ident" id="3724933">hs</span><span class="op" id="3724935">.</span><span class="ident" id="3724936">sessionState</span><span class="op" id="3724948">.</span><span class="ident" id="3724949">cipherSuite</span>&nbsp;<span class="op" id="3724961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3724966">cipherSuiteOk</span>&nbsp;<span class="op" id="3724980">=</span>&nbsp;<span class="builtintype" id="3724982">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3724990">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3724998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725001">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725004">if</span>&nbsp;<span class="op" id="3725007">!</span><span class="ident" id="3725008">cipherSuiteOk</span>&nbsp;<span class="op" id="3725022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725026">return</span>&nbsp;<span class="builtintype" id="3725033">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725044">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725109">hs</span><span class="op" id="3725111">.</span><span class="ident" id="3725112">suite</span>&nbsp;<span class="op" id="3725118">=</span>&nbsp;<span class="ident" id="3725120">c</span><span class="op" id="3725121">.</span><span class="ident" id="3725122">tryCipherSuite</span><span class="op" id="3725136">(</span><span class="ident" id="3725137">hs</span><span class="op" id="3725139">.</span><span class="ident" id="3725140">sessionState</span><span class="op" id="3725152">.</span><span class="ident" id="3725153">cipherSuite</span><span class="op" id="3725164">,</span>&nbsp;<span class="ident" id="3725166">c</span><span class="op" id="3725167">.</span><span class="ident" id="3725168">config</span><span class="op" id="3725174">.</span><span class="ident" id="3725175">cipherSuites</span><span class="op" id="3725187">(</span><span class="op" id="3725188">)</span><span class="op" id="3725189">,</span>&nbsp;<span class="ident" id="3725191">hs</span><span class="op" id="3725193">.</span><span class="ident" id="3725194">sessionState</span><span class="op" id="3725206">.</span><span class="ident" id="3725207">vers</span><span class="op" id="3725211">,</span>&nbsp;<span class="ident" id="3725213">hs</span><span class="op" id="3725215">.</span><span class="ident" id="3725216">ellipticOk</span><span class="op" id="3725226">,</span>&nbsp;<span class="ident" id="3725228">hs</span><span class="op" id="3725230">.</span><span class="ident" id="3725231">ecdsaOk</span><span class="op" id="3725238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725241">if</span>&nbsp;<span class="ident" id="3725244">hs</span><span class="op" id="3725246">.</span><span class="ident" id="3725247">suite</span>&nbsp;<span class="op" id="3725253">==</span>&nbsp;<span class="ident" id="3725256">nil</span>&nbsp;<span class="op" id="3725260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725264">return</span>&nbsp;<span class="builtintype" id="3725271">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725278">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725282">sessionHasClientCerts</span>&nbsp;<span class="op" id="3725304">:=</span>&nbsp;<span class="builtinfunc" id="3725307">len</span><span class="op" id="3725310">(</span><span class="ident" id="3725311">hs</span><span class="op" id="3725313">.</span><span class="ident" id="3725314">sessionState</span><span class="op" id="3725326">.</span><span class="ident" id="3725327">certificates</span><span class="op" id="3725339">)</span>&nbsp;<span class="op" id="3725341">!=</span>&nbsp;<span class="num" id="3725344">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725347">needClientCerts</span>&nbsp;<span class="op" id="3725363">:=</span>&nbsp;<span class="ident" id="3725366">c</span><span class="op" id="3725367">.</span><span class="ident" id="3725368">config</span><span class="op" id="3725374">.</span><span class="ident" id="3725375">ClientAuth</span>&nbsp;<span class="op" id="3725386">==</span>&nbsp;<span class="ident" id="3725389">RequireAnyClientCert</span>&nbsp;<span class="op" id="3725410">||</span>&nbsp;<span class="ident" id="3725413">c</span><span class="op" id="3725414">.</span><span class="ident" id="3725415">config</span><span class="op" id="3725421">.</span><span class="ident" id="3725422">ClientAuth</span>&nbsp;<span class="op" id="3725433">==</span>&nbsp;<span class="ident" id="3725436">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725464">if</span>&nbsp;<span class="ident" id="3725467">needClientCerts</span>&nbsp;<span class="op" id="3725483">&amp;&amp;</span>&nbsp;<span class="op" id="3725486">!</span><span class="ident" id="3725487">sessionHasClientCerts</span>&nbsp;<span class="op" id="3725509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725513">return</span>&nbsp;<span class="builtintype" id="3725520">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725527">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725530">if</span>&nbsp;<span class="ident" id="3725533">sessionHasClientCerts</span>&nbsp;<span class="op" id="3725555">&amp;&amp;</span>&nbsp;<span class="ident" id="3725558">c</span><span class="op" id="3725559">.</span><span class="ident" id="3725560">config</span><span class="op" id="3725566">.</span><span class="ident" id="3725567">ClientAuth</span>&nbsp;<span class="op" id="3725578">==</span>&nbsp;<span class="ident" id="3725581">NoClientCert</span>&nbsp;<span class="op" id="3725594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725598">return</span>&nbsp;<span class="builtintype" id="3725605">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3725612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725616">return</span>&nbsp;<span class="builtintype" id="3725623">true</span><br>
<span class="lineno">290</span><span class="op" id="3725628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3725631">func</span>&nbsp;<span class="op" id="3725636">(</span><span class="ident" id="3725637">hs</span>&nbsp;<span class="op" id="3725640">*</span><span class="ident" id="3725641">serverHandshakeState</span><span class="op" id="3725661">)</span>&nbsp;<span class="ident" id="3725663">doResumeHandshake</span><span class="op" id="3725680">(</span><span class="op" id="3725681">)</span>&nbsp;<span class="builtintype" id="3725683">error</span>&nbsp;<span class="op" id="3725689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725692">c</span>&nbsp;<span class="op" id="3725694">:=</span>&nbsp;<span class="ident" id="3725697">hs</span><span class="op" id="3725699">.</span><span class="ident" id="3725700">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725704">hs</span><span class="op" id="3725706">.</span><span class="ident" id="3725707">hello</span><span class="op" id="3725712">.</span><span class="ident" id="3725713">cipherSuite</span>&nbsp;<span class="op" id="3725725">=</span>&nbsp;<span class="ident" id="3725727">hs</span><span class="op" id="3725729">.</span><span class="ident" id="3725730">suite</span><span class="op" id="3725735">.</span><span class="ident" id="3725736">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725740">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3725810">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725845">hs</span><span class="op" id="3725847">.</span><span class="ident" id="3725848">hello</span><span class="op" id="3725853">.</span><span class="ident" id="3725854">sessionId</span>&nbsp;<span class="op" id="3725864">=</span>&nbsp;<span class="ident" id="3725866">hs</span><span class="op" id="3725868">.</span><span class="ident" id="3725869">clientHello</span><span class="op" id="3725880">.</span><span class="ident" id="3725881">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725892">hs</span><span class="op" id="3725894">.</span><span class="ident" id="3725895">finishedHash</span><span class="op" id="3725907">.</span><span class="ident" id="3725908">Write</span><span class="op" id="3725913">(</span><span class="ident" id="3725914">hs</span><span class="op" id="3725916">.</span><span class="ident" id="3725917">hello</span><span class="op" id="3725922">.</span><span class="ident" id="3725923">marshal</span><span class="op" id="3725930">(</span><span class="op" id="3725931">)</span><span class="op" id="3725932">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3725935">c</span><span class="op" id="3725936">.</span><span class="ident" id="3725937">writeRecord</span><span class="op" id="3725948">(</span><span class="ident" id="3725949">recordTypeHandshake</span><span class="op" id="3725968">,</span>&nbsp;<span class="ident" id="3725970">hs</span><span class="op" id="3725972">.</span><span class="ident" id="3725973">hello</span><span class="op" id="3725978">.</span><span class="ident" id="3725979">marshal</span><span class="op" id="3725986">(</span><span class="op" id="3725987">)</span><span class="op" id="3725988">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3725992">if</span>&nbsp;<span class="builtinfunc" id="3725995">len</span><span class="op" id="3725998">(</span><span class="ident" id="3725999">hs</span><span class="op" id="3726001">.</span><span class="ident" id="3726002">sessionState</span><span class="op" id="3726014">.</span><span class="ident" id="3726015">certificates</span><span class="op" id="3726027">)</span>&nbsp;<span class="op" id="3726029">&gt;</span>&nbsp;<span class="num" id="3726031">0</span>&nbsp;<span class="op" id="3726033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726037">if</span>&nbsp;<span class="ident" id="3726040">_</span><span class="op" id="3726041">,</span>&nbsp;<span class="ident" id="3726043">err</span>&nbsp;<span class="op" id="3726047">:=</span>&nbsp;<span class="ident" id="3726050">hs</span><span class="op" id="3726052">.</span><span class="ident" id="3726053">processCertsFromClient</span><span class="op" id="3726075">(</span><span class="ident" id="3726076">hs</span><span class="op" id="3726078">.</span><span class="ident" id="3726079">sessionState</span><span class="op" id="3726091">.</span><span class="ident" id="3726092">certificates</span><span class="op" id="3726104">)</span><span class="op" id="3726105">;</span>&nbsp;<span class="ident" id="3726107">err</span>&nbsp;<span class="op" id="3726111">!=</span>&nbsp;<span class="ident" id="3726114">nil</span>&nbsp;<span class="op" id="3726118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726123">return</span>&nbsp;<span class="ident" id="3726130">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726143">hs</span><span class="op" id="3726145">.</span><span class="ident" id="3726146">masterSecret</span>&nbsp;<span class="op" id="3726159">=</span>&nbsp;<span class="ident" id="3726161">hs</span><span class="op" id="3726163">.</span><span class="ident" id="3726164">sessionState</span><span class="op" id="3726176">.</span><span class="ident" id="3726177">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726192">return</span>&nbsp;<span class="ident" id="3726199">nil</span><br>
<span class="lineno"></span><span class="op" id="3726203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3726206">func</span>&nbsp;<span class="op" id="3726211">(</span><span class="ident" id="3726212">hs</span>&nbsp;<span class="op" id="3726215">*</span><span class="ident" id="3726216">serverHandshakeState</span><span class="op" id="3726236">)</span>&nbsp;<span class="ident" id="3726238">doFullHandshake</span><span class="op" id="3726253">(</span><span class="op" id="3726254">)</span>&nbsp;<span class="builtintype" id="3726256">error</span>&nbsp;<span class="op" id="3726262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726265">config</span>&nbsp;<span class="op" id="3726272">:=</span>&nbsp;<span class="ident" id="3726275">hs</span><span class="op" id="3726277">.</span><span class="ident" id="3726278">c</span><span class="op" id="3726279">.</span><span class="ident" id="3726280">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726288">c</span>&nbsp;<span class="op" id="3726290">:=</span>&nbsp;<span class="ident" id="3726293">hs</span><span class="op" id="3726295">.</span><span class="ident" id="3726296">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726300">if</span>&nbsp;<span class="ident" id="3726303">hs</span><span class="op" id="3726305">.</span><span class="ident" id="3726306">clientHello</span><span class="op" id="3726317">.</span><span class="ident" id="3726318">ocspStapling</span>&nbsp;<span class="op" id="3726331">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3726334">len</span><span class="op" id="3726337">(</span><span class="ident" id="3726338">hs</span><span class="op" id="3726340">.</span><span class="ident" id="3726341">cert</span><span class="op" id="3726345">.</span><span class="ident" id="3726346">OCSPStaple</span><span class="op" id="3726356">)</span>&nbsp;<span class="op" id="3726358">&gt;</span>&nbsp;<span class="num" id="3726360">0</span>&nbsp;<span class="op" id="3726362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726366">hs</span><span class="op" id="3726368">.</span><span class="ident" id="3726369">hello</span><span class="op" id="3726374">.</span><span class="ident" id="3726375">ocspStapling</span>&nbsp;<span class="op" id="3726388">=</span>&nbsp;<span class="builtintype" id="3726390">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3726396">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726400">hs</span><span class="op" id="3726402">.</span><span class="ident" id="3726403">hello</span><span class="op" id="3726408">.</span><span class="ident" id="3726409">ticketSupported</span>&nbsp;<span class="op" id="3726425">=</span>&nbsp;<span class="ident" id="3726427">hs</span><span class="op" id="3726429">.</span><span class="ident" id="3726430">clientHello</span><span class="op" id="3726441">.</span><span class="ident" id="3726442">ticketSupported</span>&nbsp;<span class="op" id="3726458">&amp;&amp;</span>&nbsp;<span class="op" id="3726461">!</span><span class="ident" id="3726462">config</span><span class="op" id="3726468">.</span><span class="ident" id="3726469">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726493">hs</span><span class="op" id="3726495">.</span><span class="ident" id="3726496">hello</span><span class="op" id="3726501">.</span><span class="ident" id="3726502">cipherSuite</span>&nbsp;<span class="op" id="3726514">=</span>&nbsp;<span class="ident" id="3726516">hs</span><span class="op" id="3726518">.</span><span class="ident" id="3726519">suite</span><span class="op" id="3726524">.</span><span class="ident" id="3726525">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726529">hs</span><span class="op" id="3726531">.</span><span class="ident" id="3726532">finishedHash</span><span class="op" id="3726544">.</span><span class="ident" id="3726545">Write</span><span class="op" id="3726550">(</span><span class="ident" id="3726551">hs</span><span class="op" id="3726553">.</span><span class="ident" id="3726554">hello</span><span class="op" id="3726559">.</span><span class="ident" id="3726560">marshal</span><span class="op" id="3726567">(</span><span class="op" id="3726568">)</span><span class="op" id="3726569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726572">c</span><span class="op" id="3726573">.</span><span class="ident" id="3726574">writeRecord</span><span class="op" id="3726585">(</span><span class="ident" id="3726586">recordTypeHandshake</span><span class="op" id="3726605">,</span>&nbsp;<span class="ident" id="3726607">hs</span><span class="op" id="3726609">.</span><span class="ident" id="3726610">hello</span><span class="op" id="3726615">.</span><span class="ident" id="3726616">marshal</span><span class="op" id="3726623">(</span><span class="op" id="3726624">)</span><span class="op" id="3726625">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726629">certMsg</span>&nbsp;<span class="op" id="3726637">:=</span>&nbsp;<span class="builtinfunc" id="3726640">new</span><span class="op" id="3726643">(</span><span class="ident" id="3726644">certificateMsg</span><span class="op" id="3726658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726661">certMsg</span><span class="op" id="3726668">.</span><span class="ident" id="3726669">certificates</span>&nbsp;<span class="op" id="3726682">=</span>&nbsp;<span class="ident" id="3726684">hs</span><span class="op" id="3726686">.</span><span class="ident" id="3726687">cert</span><span class="op" id="3726691">.</span><span class="ident" id="3726692">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726705">hs</span><span class="op" id="3726707">.</span><span class="ident" id="3726708">finishedHash</span><span class="op" id="3726720">.</span><span class="ident" id="3726721">Write</span><span class="op" id="3726726">(</span><span class="ident" id="3726727">certMsg</span><span class="op" id="3726734">.</span><span class="ident" id="3726735">marshal</span><span class="op" id="3726742">(</span><span class="op" id="3726743">)</span><span class="op" id="3726744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726747">c</span><span class="op" id="3726748">.</span><span class="ident" id="3726749">writeRecord</span><span class="op" id="3726760">(</span><span class="ident" id="3726761">recordTypeHandshake</span><span class="op" id="3726780">,</span>&nbsp;<span class="ident" id="3726782">certMsg</span><span class="op" id="3726789">.</span><span class="ident" id="3726790">marshal</span><span class="op" id="3726797">(</span><span class="op" id="3726798">)</span><span class="op" id="3726799">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3726803">if</span>&nbsp;<span class="ident" id="3726806">hs</span><span class="op" id="3726808">.</span><span class="ident" id="3726809">hello</span><span class="op" id="3726814">.</span><span class="ident" id="3726815">ocspStapling</span>&nbsp;<span class="op" id="3726828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726832">certStatus</span>&nbsp;<span class="op" id="3726843">:=</span>&nbsp;<span class="builtinfunc" id="3726846">new</span><span class="op" id="3726849">(</span><span class="ident" id="3726850">certificateStatusMsg</span><span class="op" id="3726870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726874">certStatus</span><span class="op" id="3726884">.</span><span class="ident" id="3726885">statusType</span>&nbsp;<span class="op" id="3726896">=</span>&nbsp;<span class="ident" id="3726898">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726915">certStatus</span><span class="op" id="3726925">.</span><span class="ident" id="3726926">response</span>&nbsp;<span class="op" id="3726935">=</span>&nbsp;<span class="ident" id="3726937">hs</span><span class="op" id="3726939">.</span><span class="ident" id="3726940">cert</span><span class="op" id="3726944">.</span><span class="ident" id="3726945">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3726958">hs</span><span class="op" id="3726960">.</span><span class="ident" id="3726961">finishedHash</span><span class="op" id="3726973">.</span><span class="ident" id="3726974">Write</span><span class="op" id="3726979">(</span><span class="ident" id="3726980">certStatus</span><span class="op" id="3726990">.</span><span class="ident" id="3726991">marshal</span><span class="op" id="3726998">(</span><span class="op" id="3726999">)</span><span class="op" id="3727000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727004">c</span><span class="op" id="3727005">.</span><span class="ident" id="3727006">writeRecord</span><span class="op" id="3727017">(</span><span class="ident" id="3727018">recordTypeHandshake</span><span class="op" id="3727037">,</span>&nbsp;<span class="ident" id="3727039">certStatus</span><span class="op" id="3727049">.</span><span class="ident" id="3727050">marshal</span><span class="op" id="3727057">(</span><span class="op" id="3727058">)</span><span class="op" id="3727059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727066">keyAgreement</span>&nbsp;<span class="op" id="3727079">:=</span>&nbsp;<span class="ident" id="3727082">hs</span><span class="op" id="3727084">.</span><span class="ident" id="3727085">suite</span><span class="op" id="3727090">.</span><span class="ident" id="3727091">ka</span><span class="op" id="3727093">(</span><span class="ident" id="3727094">c</span><span class="op" id="3727095">.</span><span class="ident" id="3727096">vers</span><span class="op" id="3727100">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727103">skx</span><span class="op" id="3727106">,</span>&nbsp;<span class="ident" id="3727108">err</span>&nbsp;<span class="op" id="3727112">:=</span>&nbsp;<span class="ident" id="3727115">keyAgreement</span><span class="op" id="3727127">.</span><span class="ident" id="3727128">generateServerKeyExchange</span><span class="op" id="3727153">(</span><span class="ident" id="3727154">config</span><span class="op" id="3727160">,</span>&nbsp;<span class="ident" id="3727162">hs</span><span class="op" id="3727164">.</span><span class="ident" id="3727165">cert</span><span class="op" id="3727169">,</span>&nbsp;<span class="ident" id="3727171">hs</span><span class="op" id="3727173">.</span><span class="ident" id="3727174">clientHello</span><span class="op" id="3727185">,</span>&nbsp;<span class="ident" id="3727187">hs</span><span class="op" id="3727189">.</span><span class="ident" id="3727190">hello</span><span class="op" id="3727195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727198">if</span>&nbsp;<span class="ident" id="3727201">err</span>&nbsp;<span class="op" id="3727205">!=</span>&nbsp;<span class="ident" id="3727208">nil</span>&nbsp;<span class="op" id="3727212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727216">c</span><span class="op" id="3727217">.</span><span class="ident" id="3727218">sendAlert</span><span class="op" id="3727227">(</span><span class="ident" id="3727228">alertHandshakeFailure</span><span class="op" id="3727249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727253">return</span>&nbsp;<span class="ident" id="3727260">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727265">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727268">if</span>&nbsp;<span class="ident" id="3727271">skx</span>&nbsp;<span class="op" id="3727275">!=</span>&nbsp;<span class="ident" id="3727278">nil</span>&nbsp;<span class="op" id="3727282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727286">hs</span><span class="op" id="3727288">.</span><span class="ident" id="3727289">finishedHash</span><span class="op" id="3727301">.</span><span class="ident" id="3727302">Write</span><span class="op" id="3727307">(</span><span class="ident" id="3727308">skx</span><span class="op" id="3727311">.</span><span class="ident" id="3727312">marshal</span><span class="op" id="3727319">(</span><span class="op" id="3727320">)</span><span class="op" id="3727321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727325">c</span><span class="op" id="3727326">.</span><span class="ident" id="3727327">writeRecord</span><span class="op" id="3727338">(</span><span class="ident" id="3727339">recordTypeHandshake</span><span class="op" id="3727358">,</span>&nbsp;<span class="ident" id="3727360">skx</span><span class="op" id="3727363">.</span><span class="ident" id="3727364">marshal</span><span class="op" id="3727371">(</span><span class="op" id="3727372">)</span><span class="op" id="3727373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727380">if</span>&nbsp;<span class="ident" id="3727383">config</span><span class="op" id="3727389">.</span><span class="ident" id="3727390">ClientAuth</span>&nbsp;<span class="op" id="3727401">&gt;=</span>&nbsp;<span class="ident" id="3727404">RequestClientCert</span>&nbsp;<span class="op" id="3727422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727426">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727460">certReq</span>&nbsp;<span class="op" id="3727468">:=</span>&nbsp;<span class="builtinfunc" id="3727471">new</span><span class="op" id="3727474">(</span><span class="ident" id="3727475">certificateRequestMsg</span><span class="op" id="3727496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727500">certReq</span><span class="op" id="3727507">.</span><span class="ident" id="3727508">certificateTypes</span>&nbsp;<span class="op" id="3727525">=</span>&nbsp;<span class="op" id="3727527">[</span><span class="op" id="3727528">]</span><span class="builtintype" id="3727529">byte</span><span class="op" id="3727533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3727538">byte</span><span class="op" id="3727542">(</span><span class="ident" id="3727543">certTypeRSASign</span><span class="op" id="3727558">)</span><span class="op" id="3727559">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3727564">byte</span><span class="op" id="3727568">(</span><span class="ident" id="3727569">certTypeECDSASign</span><span class="op" id="3727586">)</span><span class="op" id="3727587">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3727595">if</span>&nbsp;<span class="ident" id="3727598">c</span><span class="op" id="3727599">.</span><span class="ident" id="3727600">vers</span>&nbsp;<span class="op" id="3727605">&gt;=</span>&nbsp;<span class="ident" id="3727608">VersionTLS12</span>&nbsp;<span class="op" id="3727621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727626">certReq</span><span class="op" id="3727633">.</span><span class="ident" id="3727634">hasSignatureAndHash</span>&nbsp;<span class="op" id="3727654">=</span>&nbsp;<span class="builtintype" id="3727656">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3727664">certReq</span><span class="op" id="3727671">.</span><span class="ident" id="3727672">signatureAndHashes</span>&nbsp;<span class="op" id="3727691">=</span>&nbsp;<span class="ident" id="3727693">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3727734">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727739">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727795">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727856">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727913">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3727971">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728018">if</span>&nbsp;<span class="ident" id="3728021">config</span><span class="op" id="3728027">.</span><span class="ident" id="3728028">ClientCAs</span>&nbsp;<span class="op" id="3728038">!=</span>&nbsp;<span class="ident" id="3728041">nil</span>&nbsp;<span class="op" id="3728045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728050">certReq</span><span class="op" id="3728057">.</span><span class="ident" id="3728058">certificateAuthorities</span>&nbsp;<span class="op" id="3728081">=</span>&nbsp;<span class="ident" id="3728083">config</span><span class="op" id="3728089">.</span><span class="ident" id="3728090">ClientCAs</span><span class="op" id="3728099">.</span><span class="ident" id="3728100">Subjects</span><span class="op" id="3728108">(</span><span class="op" id="3728109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728113">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728117">hs</span><span class="op" id="3728119">.</span><span class="ident" id="3728120">finishedHash</span><span class="op" id="3728132">.</span><span class="ident" id="3728133">Write</span><span class="op" id="3728138">(</span><span class="ident" id="3728139">certReq</span><span class="op" id="3728146">.</span><span class="ident" id="3728147">marshal</span><span class="op" id="3728154">(</span><span class="op" id="3728155">)</span><span class="op" id="3728156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728160">c</span><span class="op" id="3728161">.</span><span class="ident" id="3728162">writeRecord</span><span class="op" id="3728173">(</span><span class="ident" id="3728174">recordTypeHandshake</span><span class="op" id="3728193">,</span>&nbsp;<span class="ident" id="3728195">certReq</span><span class="op" id="3728202">.</span><span class="ident" id="3728203">marshal</span><span class="op" id="3728210">(</span><span class="op" id="3728211">)</span><span class="op" id="3728212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728219">helloDone</span>&nbsp;<span class="op" id="3728229">:=</span>&nbsp;<span class="builtinfunc" id="3728232">new</span><span class="op" id="3728235">(</span><span class="ident" id="3728236">serverHelloDoneMsg</span><span class="op" id="3728254">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728257">hs</span><span class="op" id="3728259">.</span><span class="ident" id="3728260">finishedHash</span><span class="op" id="3728272">.</span><span class="ident" id="3728273">Write</span><span class="op" id="3728278">(</span><span class="ident" id="3728279">helloDone</span><span class="op" id="3728288">.</span><span class="ident" id="3728289">marshal</span><span class="op" id="3728296">(</span><span class="op" id="3728297">)</span><span class="op" id="3728298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728301">c</span><span class="op" id="3728302">.</span><span class="ident" id="3728303">writeRecord</span><span class="op" id="3728314">(</span><span class="ident" id="3728315">recordTypeHandshake</span><span class="op" id="3728334">,</span>&nbsp;<span class="ident" id="3728336">helloDone</span><span class="op" id="3728345">.</span><span class="ident" id="3728346">marshal</span><span class="op" id="3728353">(</span><span class="op" id="3728354">)</span><span class="op" id="3728355">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728359">var</span>&nbsp;<span class="ident" id="3728363">pub</span>&nbsp;<span class="ident" id="3728367">crypto</span><span class="op" id="3728373">.</span><span class="ident" id="3728374">PublicKey</span>&nbsp;<span class="comment" id="3728384">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728424">msg</span><span class="op" id="3728427">,</span>&nbsp;<span class="ident" id="3728429">err</span>&nbsp;<span class="op" id="3728433">:=</span>&nbsp;<span class="ident" id="3728436">c</span><span class="op" id="3728437">.</span><span class="ident" id="3728438">readHandshake</span><span class="op" id="3728451">(</span><span class="op" id="3728452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728455">if</span>&nbsp;<span class="ident" id="3728458">err</span>&nbsp;<span class="op" id="3728462">!=</span>&nbsp;<span class="ident" id="3728465">nil</span>&nbsp;<span class="op" id="3728469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728473">return</span>&nbsp;<span class="ident" id="3728480">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728489">var</span>&nbsp;<span class="ident" id="3728493">ok</span>&nbsp;<span class="builtintype" id="3728496">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3728502">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3728572">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728617">if</span>&nbsp;<span class="ident" id="3728620">config</span><span class="op" id="3728626">.</span><span class="ident" id="3728627">ClientAuth</span>&nbsp;<span class="op" id="3728638">&gt;=</span>&nbsp;<span class="ident" id="3728641">RequestClientCert</span>&nbsp;<span class="op" id="3728659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728663">if</span>&nbsp;<span class="ident" id="3728666">certMsg</span><span class="op" id="3728673">,</span>&nbsp;<span class="ident" id="3728675">ok</span>&nbsp;<span class="op" id="3728678">=</span>&nbsp;<span class="ident" id="3728680">msg</span><span class="op" id="3728683">.</span><span class="op" id="3728684">(</span><span class="op" id="3728685">*</span><span class="ident" id="3728686">certificateMsg</span><span class="op" id="3728700">)</span><span class="op" id="3728701">;</span>&nbsp;<span class="op" id="3728703">!</span><span class="ident" id="3728704">ok</span>&nbsp;<span class="op" id="3728707">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728712">c</span><span class="op" id="3728713">.</span><span class="ident" id="3728714">sendAlert</span><span class="op" id="3728723">(</span><span class="ident" id="3728724">alertUnexpectedMessage</span><span class="op" id="3728746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728751">return</span>&nbsp;<span class="ident" id="3728758">unexpectedMessageError</span><span class="op" id="3728780">(</span><span class="ident" id="3728781">certMsg</span><span class="op" id="3728788">,</span>&nbsp;<span class="ident" id="3728790">msg</span><span class="op" id="3728793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3728797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3728801">hs</span><span class="op" id="3728803">.</span><span class="ident" id="3728804">finishedHash</span><span class="op" id="3728816">.</span><span class="ident" id="3728817">Write</span><span class="op" id="3728822">(</span><span class="ident" id="3728823">certMsg</span><span class="op" id="3728830">.</span><span class="ident" id="3728831">marshal</span><span class="op" id="3728838">(</span><span class="op" id="3728839">)</span><span class="op" id="3728840">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728845">if</span>&nbsp;<span class="builtinfunc" id="3728848">len</span><span class="op" id="3728851">(</span><span class="ident" id="3728852">certMsg</span><span class="op" id="3728859">.</span><span class="ident" id="3728860">certificates</span><span class="op" id="3728872">)</span>&nbsp;<span class="op" id="3728874">==</span>&nbsp;<span class="num" id="3728877">0</span>&nbsp;<span class="op" id="3728879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3728884">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728936">switch</span>&nbsp;<span class="ident" id="3728943">config</span><span class="op" id="3728949">.</span><span class="ident" id="3728950">ClientAuth</span>&nbsp;<span class="op" id="3728961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3728966">case</span>&nbsp;<span class="ident" id="3728971">RequireAnyClientCert</span><span class="op" id="3728991">,</span>&nbsp;<span class="ident" id="3728993">RequireAndVerifyClientCert</span><span class="op" id="3729019">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729025">c</span><span class="op" id="3729026">.</span><span class="ident" id="3729027">sendAlert</span><span class="op" id="3729036">(</span><span class="ident" id="3729037">alertBadCertificate</span><span class="op" id="3729056">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729062">return</span>&nbsp;<span class="ident" id="3729069">errors</span><span class="op" id="3729075">.</span><span class="ident" id="3729076">New</span><span class="op" id="3729079">(</span><span class="string" id="3729080">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3729122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729136">pub</span><span class="op" id="3729139">,</span>&nbsp;<span class="ident" id="3729141">err</span>&nbsp;<span class="op" id="3729145">=</span>&nbsp;<span class="ident" id="3729147">hs</span><span class="op" id="3729149">.</span><span class="ident" id="3729150">processCertsFromClient</span><span class="op" id="3729172">(</span><span class="ident" id="3729173">certMsg</span><span class="op" id="3729180">.</span><span class="ident" id="3729181">certificates</span><span class="op" id="3729193">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729197">if</span>&nbsp;<span class="ident" id="3729200">err</span>&nbsp;<span class="op" id="3729204">!=</span>&nbsp;<span class="ident" id="3729207">nil</span>&nbsp;<span class="op" id="3729211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729216">return</span>&nbsp;<span class="ident" id="3729223">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729234">msg</span><span class="op" id="3729237">,</span>&nbsp;<span class="ident" id="3729239">err</span>&nbsp;<span class="op" id="3729243">=</span>&nbsp;<span class="ident" id="3729245">c</span><span class="op" id="3729246">.</span><span class="ident" id="3729247">readHandshake</span><span class="op" id="3729260">(</span><span class="op" id="3729261">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729265">if</span>&nbsp;<span class="ident" id="3729268">err</span>&nbsp;<span class="op" id="3729272">!=</span>&nbsp;<span class="ident" id="3729275">nil</span>&nbsp;<span class="op" id="3729279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729284">return</span>&nbsp;<span class="ident" id="3729291">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729304">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729332">ckx</span><span class="op" id="3729335">,</span>&nbsp;<span class="ident" id="3729337">ok</span>&nbsp;<span class="op" id="3729340">:=</span>&nbsp;<span class="ident" id="3729343">msg</span><span class="op" id="3729346">.</span><span class="op" id="3729347">(</span><span class="op" id="3729348">*</span><span class="ident" id="3729349">clientKeyExchangeMsg</span><span class="op" id="3729369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729372">if</span>&nbsp;<span class="op" id="3729375">!</span><span class="ident" id="3729376">ok</span>&nbsp;<span class="op" id="3729379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729383">c</span><span class="op" id="3729384">.</span><span class="ident" id="3729385">sendAlert</span><span class="op" id="3729394">(</span><span class="ident" id="3729395">alertUnexpectedMessage</span><span class="op" id="3729417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729421">return</span>&nbsp;<span class="ident" id="3729428">unexpectedMessageError</span><span class="op" id="3729450">(</span><span class="ident" id="3729451">ckx</span><span class="op" id="3729454">,</span>&nbsp;<span class="ident" id="3729456">msg</span><span class="op" id="3729459">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3729462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729465">hs</span><span class="op" id="3729467">.</span><span class="ident" id="3729468">finishedHash</span><span class="op" id="3729480">.</span><span class="ident" id="3729481">Write</span><span class="op" id="3729486">(</span><span class="ident" id="3729487">ckx</span><span class="op" id="3729490">.</span><span class="ident" id="3729491">marshal</span><span class="op" id="3729498">(</span><span class="op" id="3729499">)</span><span class="op" id="3729500">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729504">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729585">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729658">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729727">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729807">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3729887">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3729941">if</span>&nbsp;<span class="builtinfunc" id="3729944">len</span><span class="op" id="3729947">(</span><span class="ident" id="3729948">c</span><span class="op" id="3729949">.</span><span class="ident" id="3729950">peerCertificates</span><span class="op" id="3729966">)</span>&nbsp;<span class="op" id="3729968">&gt;</span>&nbsp;<span class="num" id="3729970">0</span>&nbsp;<span class="op" id="3729972">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3729976">msg</span><span class="op" id="3729979">,</span>&nbsp;<span class="ident" id="3729981">err</span>&nbsp;<span class="op" id="3729985">=</span>&nbsp;<span class="ident" id="3729987">c</span><span class="op" id="3729988">.</span><span class="ident" id="3729989">readHandshake</span><span class="op" id="3730002">(</span><span class="op" id="3730003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730007">if</span>&nbsp;<span class="ident" id="3730010">err</span>&nbsp;<span class="op" id="3730014">!=</span>&nbsp;<span class="ident" id="3730017">nil</span>&nbsp;<span class="op" id="3730021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730026">return</span>&nbsp;<span class="ident" id="3730033">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730039">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730043">certVerify</span><span class="op" id="3730053">,</span>&nbsp;<span class="ident" id="3730055">ok</span>&nbsp;<span class="op" id="3730058">:=</span>&nbsp;<span class="ident" id="3730061">msg</span><span class="op" id="3730064">.</span><span class="op" id="3730065">(</span><span class="op" id="3730066">*</span><span class="ident" id="3730067">certificateVerifyMsg</span><span class="op" id="3730087">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730091">if</span>&nbsp;<span class="op" id="3730094">!</span><span class="ident" id="3730095">ok</span>&nbsp;<span class="op" id="3730098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730103">c</span><span class="op" id="3730104">.</span><span class="ident" id="3730105">sendAlert</span><span class="op" id="3730114">(</span><span class="ident" id="3730115">alertUnexpectedMessage</span><span class="op" id="3730137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730142">return</span>&nbsp;<span class="ident" id="3730149">unexpectedMessageError</span><span class="op" id="3730171">(</span><span class="ident" id="3730172">certVerify</span><span class="op" id="3730182">,</span>&nbsp;<span class="ident" id="3730184">msg</span><span class="op" id="3730187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730196">switch</span>&nbsp;<span class="ident" id="3730203">key</span>&nbsp;<span class="op" id="3730207">:=</span>&nbsp;<span class="ident" id="3730210">pub</span><span class="op" id="3730213">.</span><span class="op" id="3730214">(</span><span class="keyword" id="3730215">type</span><span class="op" id="3730219">)</span>&nbsp;<span class="op" id="3730221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730225">case</span>&nbsp;<span class="op" id="3730230">*</span><span class="ident" id="3730231">ecdsa</span><span class="op" id="3730236">.</span><span class="ident" id="3730237">PublicKey</span><span class="op" id="3730246">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730251">ecdsaSig</span>&nbsp;<span class="op" id="3730260">:=</span>&nbsp;<span class="builtinfunc" id="3730263">new</span><span class="op" id="3730266">(</span><span class="ident" id="3730267">ecdsaSignature</span><span class="op" id="3730281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730286">if</span>&nbsp;<span class="ident" id="3730289">_</span><span class="op" id="3730290">,</span>&nbsp;<span class="ident" id="3730292">err</span>&nbsp;<span class="op" id="3730296">=</span>&nbsp;<span class="ident" id="3730298">asn1</span><span class="op" id="3730302">.</span><span class="ident" id="3730303">Unmarshal</span><span class="op" id="3730312">(</span><span class="ident" id="3730313">certVerify</span><span class="op" id="3730323">.</span><span class="ident" id="3730324">signature</span><span class="op" id="3730333">,</span>&nbsp;<span class="ident" id="3730335">ecdsaSig</span><span class="op" id="3730343">)</span><span class="op" id="3730344">;</span>&nbsp;<span class="ident" id="3730346">err</span>&nbsp;<span class="op" id="3730350">!=</span>&nbsp;<span class="ident" id="3730353">nil</span>&nbsp;<span class="op" id="3730357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730363">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730377">if</span>&nbsp;<span class="ident" id="3730380">ecdsaSig</span><span class="op" id="3730388">.</span><span class="ident" id="3730389">R</span><span class="op" id="3730390">.</span><span class="ident" id="3730391">Sign</span><span class="op" id="3730395">(</span><span class="op" id="3730396">)</span>&nbsp;<span class="op" id="3730398">&lt;=</span>&nbsp;<span class="num" id="3730401">0</span>&nbsp;<span class="op" id="3730403">||</span>&nbsp;<span class="ident" id="3730406">ecdsaSig</span><span class="op" id="3730414">.</span><span class="ident" id="3730415">S</span><span class="op" id="3730416">.</span><span class="ident" id="3730417">Sign</span><span class="op" id="3730421">(</span><span class="op" id="3730422">)</span>&nbsp;<span class="op" id="3730424">&lt;=</span>&nbsp;<span class="num" id="3730427">0</span>&nbsp;<span class="op" id="3730429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730435">err</span>&nbsp;<span class="op" id="3730439">=</span>&nbsp;<span class="ident" id="3730441">errors</span><span class="op" id="3730447">.</span><span class="ident" id="3730448">New</span><span class="op" id="3730451">(</span><span class="string" id="3730452">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3730503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730509">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730518">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730523">digest</span><span class="op" id="3730529">,</span>&nbsp;<span class="ident" id="3730531">_</span><span class="op" id="3730532">,</span>&nbsp;<span class="ident" id="3730534">_</span>&nbsp;<span class="op" id="3730536">:=</span>&nbsp;<span class="ident" id="3730539">hs</span><span class="op" id="3730541">.</span><span class="ident" id="3730542">finishedHash</span><span class="op" id="3730554">.</span><span class="ident" id="3730555">hashForClientCertificate</span><span class="op" id="3730579">(</span><span class="ident" id="3730580">signatureECDSA</span><span class="op" id="3730594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730599">if</span>&nbsp;<span class="op" id="3730602">!</span><span class="ident" id="3730603">ecdsa</span><span class="op" id="3730608">.</span><span class="ident" id="3730609">Verify</span><span class="op" id="3730615">(</span><span class="ident" id="3730616">key</span><span class="op" id="3730619">,</span>&nbsp;<span class="ident" id="3730621">digest</span><span class="op" id="3730627">,</span>&nbsp;<span class="ident" id="3730629">ecdsaSig</span><span class="op" id="3730637">.</span><span class="ident" id="3730638">R</span><span class="op" id="3730639">,</span>&nbsp;<span class="ident" id="3730641">ecdsaSig</span><span class="op" id="3730649">.</span><span class="ident" id="3730650">S</span><span class="op" id="3730651">)</span>&nbsp;<span class="op" id="3730653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730659">err</span>&nbsp;<span class="op" id="3730663">=</span>&nbsp;<span class="ident" id="3730665">errors</span><span class="op" id="3730671">.</span><span class="ident" id="3730672">New</span><span class="op" id="3730675">(</span><span class="string" id="3730676">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3730704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730710">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730719">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730723">case</span>&nbsp;<span class="op" id="3730728">*</span><span class="ident" id="3730729">rsa</span><span class="op" id="3730732">.</span><span class="ident" id="3730733">PublicKey</span><span class="op" id="3730742">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730747">digest</span><span class="op" id="3730753">,</span>&nbsp;<span class="ident" id="3730755">hashFunc</span><span class="op" id="3730763">,</span>&nbsp;<span class="ident" id="3730765">_</span>&nbsp;<span class="op" id="3730767">:=</span>&nbsp;<span class="ident" id="3730770">hs</span><span class="op" id="3730772">.</span><span class="ident" id="3730773">finishedHash</span><span class="op" id="3730785">.</span><span class="ident" id="3730786">hashForClientCertificate</span><span class="op" id="3730810">(</span><span class="ident" id="3730811">signatureRSA</span><span class="op" id="3730823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730828">err</span>&nbsp;<span class="op" id="3730832">=</span>&nbsp;<span class="ident" id="3730834">rsa</span><span class="op" id="3730837">.</span><span class="ident" id="3730838">VerifyPKCS1v15</span><span class="op" id="3730852">(</span><span class="ident" id="3730853">key</span><span class="op" id="3730856">,</span>&nbsp;<span class="ident" id="3730858">hashFunc</span><span class="op" id="3730866">,</span>&nbsp;<span class="ident" id="3730868">digest</span><span class="op" id="3730874">,</span>&nbsp;<span class="ident" id="3730876">certVerify</span><span class="op" id="3730886">.</span><span class="ident" id="3730887">signature</span><span class="op" id="3730896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3730900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730904">if</span>&nbsp;<span class="ident" id="3730907">err</span>&nbsp;<span class="op" id="3730911">!=</span>&nbsp;<span class="ident" id="3730914">nil</span>&nbsp;<span class="op" id="3730918">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3730923">c</span><span class="op" id="3730924">.</span><span class="ident" id="3730925">sendAlert</span><span class="op" id="3730934">(</span><span class="ident" id="3730935">alertBadCertificate</span><span class="op" id="3730954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3730959">return</span>&nbsp;<span class="ident" id="3730966">errors</span><span class="op" id="3730972">.</span><span class="ident" id="3730973">New</span><span class="op" id="3730976">(</span><span class="string" id="3730977">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3731031">+</span>&nbsp;<span class="ident" id="3731033">err</span><span class="op" id="3731036">.</span><span class="ident" id="3731037">Error</span><span class="op" id="3731042">(</span><span class="op" id="3731043">)</span><span class="op" id="3731044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731053">hs</span><span class="op" id="3731055">.</span><span class="ident" id="3731056">finishedHash</span><span class="op" id="3731068">.</span><span class="ident" id="3731069">Write</span><span class="op" id="3731074">(</span><span class="ident" id="3731075">certVerify</span><span class="op" id="3731085">.</span><span class="ident" id="3731086">marshal</span><span class="op" id="3731093">(</span><span class="op" id="3731094">)</span><span class="op" id="3731095">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731102">preMasterSecret</span><span class="op" id="3731117">,</span>&nbsp;<span class="ident" id="3731119">err</span>&nbsp;<span class="op" id="3731123">:=</span>&nbsp;<span class="ident" id="3731126">keyAgreement</span><span class="op" id="3731138">.</span><span class="ident" id="3731139">processClientKeyExchange</span><span class="op" id="3731163">(</span><span class="ident" id="3731164">config</span><span class="op" id="3731170">,</span>&nbsp;<span class="ident" id="3731172">hs</span><span class="op" id="3731174">.</span><span class="ident" id="3731175">cert</span><span class="op" id="3731179">,</span>&nbsp;<span class="ident" id="3731181">ckx</span><span class="op" id="3731184">,</span>&nbsp;<span class="ident" id="3731186">c</span><span class="op" id="3731187">.</span><span class="ident" id="3731188">vers</span><span class="op" id="3731192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731195">if</span>&nbsp;<span class="ident" id="3731198">err</span>&nbsp;<span class="op" id="3731202">!=</span>&nbsp;<span class="ident" id="3731205">nil</span>&nbsp;<span class="op" id="3731209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731213">c</span><span class="op" id="3731214">.</span><span class="ident" id="3731215">sendAlert</span><span class="op" id="3731224">(</span><span class="ident" id="3731225">alertHandshakeFailure</span><span class="op" id="3731246">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731250">return</span>&nbsp;<span class="ident" id="3731257">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3731262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731265">hs</span><span class="op" id="3731267">.</span><span class="ident" id="3731268">masterSecret</span>&nbsp;<span class="op" id="3731281">=</span>&nbsp;<span class="ident" id="3731283">masterFromPreMasterSecret</span><span class="op" id="3731308">(</span><span class="ident" id="3731309">c</span><span class="op" id="3731310">.</span><span class="ident" id="3731311">vers</span><span class="op" id="3731315">,</span>&nbsp;<span class="ident" id="3731317">preMasterSecret</span><span class="op" id="3731332">,</span>&nbsp;<span class="ident" id="3731334">hs</span><span class="op" id="3731336">.</span><span class="ident" id="3731337">clientHello</span><span class="op" id="3731348">.</span><span class="ident" id="3731349">random</span><span class="op" id="3731355">,</span>&nbsp;<span class="ident" id="3731357">hs</span><span class="op" id="3731359">.</span><span class="ident" id="3731360">hello</span><span class="op" id="3731365">.</span><span class="ident" id="3731366">random</span><span class="op" id="3731372">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731376">return</span>&nbsp;<span class="ident" id="3731383">nil</span><br>
<span class="lineno">475</span><span class="op" id="3731387">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3731390">func</span>&nbsp;<span class="op" id="3731395">(</span><span class="ident" id="3731396">hs</span>&nbsp;<span class="op" id="3731399">*</span><span class="ident" id="3731400">serverHandshakeState</span><span class="op" id="3731420">)</span>&nbsp;<span class="ident" id="3731422">establishKeys</span><span class="op" id="3731435">(</span><span class="op" id="3731436">)</span>&nbsp;<span class="builtintype" id="3731438">error</span>&nbsp;<span class="op" id="3731444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731447">c</span>&nbsp;<span class="op" id="3731449">:=</span>&nbsp;<span class="ident" id="3731452">hs</span><span class="op" id="3731454">.</span><span class="ident" id="3731455">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731459">clientMAC</span><span class="op" id="3731468">,</span>&nbsp;<span class="ident" id="3731470">serverMAC</span><span class="op" id="3731479">,</span>&nbsp;<span class="ident" id="3731481">clientKey</span><span class="op" id="3731490">,</span>&nbsp;<span class="ident" id="3731492">serverKey</span><span class="op" id="3731501">,</span>&nbsp;<span class="ident" id="3731503">clientIV</span><span class="op" id="3731511">,</span>&nbsp;<span class="ident" id="3731513">serverIV</span>&nbsp;<span class="op" id="3731522">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731527">keysFromMasterSecret</span><span class="op" id="3731547">(</span><span class="ident" id="3731548">c</span><span class="op" id="3731549">.</span><span class="ident" id="3731550">vers</span><span class="op" id="3731554">,</span>&nbsp;<span class="ident" id="3731556">hs</span><span class="op" id="3731558">.</span><span class="ident" id="3731559">masterSecret</span><span class="op" id="3731571">,</span>&nbsp;<span class="ident" id="3731573">hs</span><span class="op" id="3731575">.</span><span class="ident" id="3731576">clientHello</span><span class="op" id="3731587">.</span><span class="ident" id="3731588">random</span><span class="op" id="3731594">,</span>&nbsp;<span class="ident" id="3731596">hs</span><span class="op" id="3731598">.</span><span class="ident" id="3731599">hello</span><span class="op" id="3731604">.</span><span class="ident" id="3731605">random</span><span class="op" id="3731611">,</span>&nbsp;<span class="ident" id="3731613">hs</span><span class="op" id="3731615">.</span><span class="ident" id="3731616">suite</span><span class="op" id="3731621">.</span><span class="ident" id="3731622">macLen</span><span class="op" id="3731628">,</span>&nbsp;<span class="ident" id="3731630">hs</span><span class="op" id="3731632">.</span><span class="ident" id="3731633">suite</span><span class="op" id="3731638">.</span><span class="ident" id="3731639">keyLen</span><span class="op" id="3731645">,</span>&nbsp;<span class="ident" id="3731647">hs</span><span class="op" id="3731649">.</span><span class="ident" id="3731650">suite</span><span class="op" id="3731655">.</span><span class="ident" id="3731656">ivLen</span><span class="op" id="3731661">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731665">var</span>&nbsp;<span class="ident" id="3731669">clientCipher</span><span class="op" id="3731681">,</span>&nbsp;<span class="ident" id="3731683">serverCipher</span>&nbsp;<span class="keyword" id="3731696">interface</span><span class="op" id="3731705">{</span><span class="op" id="3731706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731709">var</span>&nbsp;<span class="ident" id="3731713">clientHash</span><span class="op" id="3731723">,</span>&nbsp;<span class="ident" id="3731725">serverHash</span>&nbsp;<span class="ident" id="3731736">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3731750">if</span>&nbsp;<span class="ident" id="3731753">hs</span><span class="op" id="3731755">.</span><span class="ident" id="3731756">suite</span><span class="op" id="3731761">.</span><span class="ident" id="3731762">aead</span>&nbsp;<span class="op" id="3731767">==</span>&nbsp;<span class="ident" id="3731770">nil</span>&nbsp;<span class="op" id="3731774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731778">clientCipher</span>&nbsp;<span class="op" id="3731791">=</span>&nbsp;<span class="ident" id="3731793">hs</span><span class="op" id="3731795">.</span><span class="ident" id="3731796">suite</span><span class="op" id="3731801">.</span><span class="ident" id="3731802">cipher</span><span class="op" id="3731808">(</span><span class="ident" id="3731809">clientKey</span><span class="op" id="3731818">,</span>&nbsp;<span class="ident" id="3731820">clientIV</span><span class="op" id="3731828">,</span>&nbsp;<span class="builtintype" id="3731830">true</span>&nbsp;<span class="comment" id="3731835">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3731852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731856">clientHash</span>&nbsp;<span class="op" id="3731867">=</span>&nbsp;<span class="ident" id="3731869">hs</span><span class="op" id="3731871">.</span><span class="ident" id="3731872">suite</span><span class="op" id="3731877">.</span><span class="ident" id="3731878">mac</span><span class="op" id="3731881">(</span><span class="ident" id="3731882">c</span><span class="op" id="3731883">.</span><span class="ident" id="3731884">vers</span><span class="op" id="3731888">,</span>&nbsp;<span class="ident" id="3731890">clientMAC</span><span class="op" id="3731899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731903">serverCipher</span>&nbsp;<span class="op" id="3731916">=</span>&nbsp;<span class="ident" id="3731918">hs</span><span class="op" id="3731920">.</span><span class="ident" id="3731921">suite</span><span class="op" id="3731926">.</span><span class="ident" id="3731927">cipher</span><span class="op" id="3731933">(</span><span class="ident" id="3731934">serverKey</span><span class="op" id="3731943">,</span>&nbsp;<span class="ident" id="3731945">serverIV</span><span class="op" id="3731953">,</span>&nbsp;<span class="builtintype" id="3731955">false</span>&nbsp;<span class="comment" id="3731961">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3731982">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3731986">serverHash</span>&nbsp;<span class="op" id="3731997">=</span>&nbsp;<span class="ident" id="3731999">hs</span><span class="op" id="3732001">.</span><span class="ident" id="3732002">suite</span><span class="op" id="3732007">.</span><span class="ident" id="3732008">mac</span><span class="op" id="3732011">(</span><span class="ident" id="3732012">c</span><span class="op" id="3732013">.</span><span class="ident" id="3732014">vers</span><span class="op" id="3732018">,</span>&nbsp;<span class="ident" id="3732020">serverMAC</span><span class="op" id="3732029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732032">}</span>&nbsp;<span class="keyword" id="3732034">else</span>&nbsp;<span class="op" id="3732039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732043">clientCipher</span>&nbsp;<span class="op" id="3732056">=</span>&nbsp;<span class="ident" id="3732058">hs</span><span class="op" id="3732060">.</span><span class="ident" id="3732061">suite</span><span class="op" id="3732066">.</span><span class="ident" id="3732067">aead</span><span class="op" id="3732071">(</span><span class="ident" id="3732072">clientKey</span><span class="op" id="3732081">,</span>&nbsp;<span class="ident" id="3732083">clientIV</span><span class="op" id="3732091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732095">serverCipher</span>&nbsp;<span class="op" id="3732108">=</span>&nbsp;<span class="ident" id="3732110">hs</span><span class="op" id="3732112">.</span><span class="ident" id="3732113">suite</span><span class="op" id="3732118">.</span><span class="ident" id="3732119">aead</span><span class="op" id="3732123">(</span><span class="ident" id="3732124">serverKey</span><span class="op" id="3732133">,</span>&nbsp;<span class="ident" id="3732135">serverIV</span><span class="op" id="3732143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732146">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732150">c</span><span class="op" id="3732151">.</span><span class="ident" id="3732152">in</span><span class="op" id="3732154">.</span><span class="ident" id="3732155">prepareCipherSpec</span><span class="op" id="3732172">(</span><span class="ident" id="3732173">c</span><span class="op" id="3732174">.</span><span class="ident" id="3732175">vers</span><span class="op" id="3732179">,</span>&nbsp;<span class="ident" id="3732181">clientCipher</span><span class="op" id="3732193">,</span>&nbsp;<span class="ident" id="3732195">clientHash</span><span class="op" id="3732205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732208">c</span><span class="op" id="3732209">.</span><span class="ident" id="3732210">out</span><span class="op" id="3732213">.</span><span class="ident" id="3732214">prepareCipherSpec</span><span class="op" id="3732231">(</span><span class="ident" id="3732232">c</span><span class="op" id="3732233">.</span><span class="ident" id="3732234">vers</span><span class="op" id="3732238">,</span>&nbsp;<span class="ident" id="3732240">serverCipher</span><span class="op" id="3732252">,</span>&nbsp;<span class="ident" id="3732254">serverHash</span><span class="op" id="3732264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732268">return</span>&nbsp;<span class="ident" id="3732275">nil</span><br>
<span class="lineno">500</span><span class="op" id="3732279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3732282">func</span>&nbsp;<span class="op" id="3732287">(</span><span class="ident" id="3732288">hs</span>&nbsp;<span class="op" id="3732291">*</span><span class="ident" id="3732292">serverHandshakeState</span><span class="op" id="3732312">)</span>&nbsp;<span class="ident" id="3732314">readFinished</span><span class="op" id="3732326">(</span><span class="ident" id="3732327">out</span>&nbsp;<span class="op" id="3732331">[</span><span class="op" id="3732332">]</span><span class="builtintype" id="3732333">byte</span><span class="op" id="3732337">)</span>&nbsp;<span class="builtintype" id="3732339">error</span>&nbsp;<span class="op" id="3732345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732348">c</span>&nbsp;<span class="op" id="3732350">:=</span>&nbsp;<span class="ident" id="3732353">hs</span><span class="op" id="3732355">.</span><span class="ident" id="3732356">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732360">c</span><span class="op" id="3732361">.</span><span class="ident" id="3732362">readRecord</span><span class="op" id="3732372">(</span><span class="ident" id="3732373">recordTypeChangeCipherSpec</span><span class="op" id="3732399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732402">if</span>&nbsp;<span class="ident" id="3732405">err</span>&nbsp;<span class="op" id="3732409">:=</span>&nbsp;<span class="ident" id="3732412">c</span><span class="op" id="3732413">.</span><span class="ident" id="3732414">in</span><span class="op" id="3732416">.</span><span class="builtintype" id="3732417">error</span><span class="op" id="3732422">(</span><span class="op" id="3732423">)</span><span class="op" id="3732424">;</span>&nbsp;<span class="ident" id="3732426">err</span>&nbsp;<span class="op" id="3732430">!=</span>&nbsp;<span class="ident" id="3732433">nil</span>&nbsp;<span class="op" id="3732437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732441">return</span>&nbsp;<span class="ident" id="3732448">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732457">if</span>&nbsp;<span class="ident" id="3732460">hs</span><span class="op" id="3732462">.</span><span class="ident" id="3732463">hello</span><span class="op" id="3732468">.</span><span class="ident" id="3732469">nextProtoNeg</span>&nbsp;<span class="op" id="3732482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732486">msg</span><span class="op" id="3732489">,</span>&nbsp;<span class="ident" id="3732491">err</span>&nbsp;<span class="op" id="3732495">:=</span>&nbsp;<span class="ident" id="3732498">c</span><span class="op" id="3732499">.</span><span class="ident" id="3732500">readHandshake</span><span class="op" id="3732513">(</span><span class="op" id="3732514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732518">if</span>&nbsp;<span class="ident" id="3732521">err</span>&nbsp;<span class="op" id="3732525">!=</span>&nbsp;<span class="ident" id="3732528">nil</span>&nbsp;<span class="op" id="3732532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732537">return</span>&nbsp;<span class="ident" id="3732544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732550">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732554">nextProto</span><span class="op" id="3732563">,</span>&nbsp;<span class="ident" id="3732565">ok</span>&nbsp;<span class="op" id="3732568">:=</span>&nbsp;<span class="ident" id="3732571">msg</span><span class="op" id="3732574">.</span><span class="op" id="3732575">(</span><span class="op" id="3732576">*</span><span class="ident" id="3732577">nextProtoMsg</span><span class="op" id="3732589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732593">if</span>&nbsp;<span class="op" id="3732596">!</span><span class="ident" id="3732597">ok</span>&nbsp;<span class="op" id="3732600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732605">c</span><span class="op" id="3732606">.</span><span class="ident" id="3732607">sendAlert</span><span class="op" id="3732616">(</span><span class="ident" id="3732617">alertUnexpectedMessage</span><span class="op" id="3732639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732644">return</span>&nbsp;<span class="ident" id="3732651">unexpectedMessageError</span><span class="op" id="3732673">(</span><span class="ident" id="3732674">nextProto</span><span class="op" id="3732683">,</span>&nbsp;<span class="ident" id="3732685">msg</span><span class="op" id="3732688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732692">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732696">hs</span><span class="op" id="3732698">.</span><span class="ident" id="3732699">finishedHash</span><span class="op" id="3732711">.</span><span class="ident" id="3732712">Write</span><span class="op" id="3732717">(</span><span class="ident" id="3732718">nextProto</span><span class="op" id="3732727">.</span><span class="ident" id="3732728">marshal</span><span class="op" id="3732735">(</span><span class="op" id="3732736">)</span><span class="op" id="3732737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732741">c</span><span class="op" id="3732742">.</span><span class="ident" id="3732743">clientProtocol</span>&nbsp;<span class="op" id="3732758">=</span>&nbsp;<span class="ident" id="3732760">nextProto</span><span class="op" id="3732769">.</span><span class="ident" id="3732770">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732777">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732781">msg</span><span class="op" id="3732784">,</span>&nbsp;<span class="ident" id="3732786">err</span>&nbsp;<span class="op" id="3732790">:=</span>&nbsp;<span class="ident" id="3732793">c</span><span class="op" id="3732794">.</span><span class="ident" id="3732795">readHandshake</span><span class="op" id="3732808">(</span><span class="op" id="3732809">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732812">if</span>&nbsp;<span class="ident" id="3732815">err</span>&nbsp;<span class="op" id="3732819">!=</span>&nbsp;<span class="ident" id="3732822">nil</span>&nbsp;<span class="op" id="3732826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732830">return</span>&nbsp;<span class="ident" id="3732837">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732845">clientFinished</span><span class="op" id="3732859">,</span>&nbsp;<span class="ident" id="3732861">ok</span>&nbsp;<span class="op" id="3732864">:=</span>&nbsp;<span class="ident" id="3732867">msg</span><span class="op" id="3732870">.</span><span class="op" id="3732871">(</span><span class="op" id="3732872">*</span><span class="ident" id="3732873">finishedMsg</span><span class="op" id="3732884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732887">if</span>&nbsp;<span class="op" id="3732890">!</span><span class="ident" id="3732891">ok</span>&nbsp;<span class="op" id="3732894">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732898">c</span><span class="op" id="3732899">.</span><span class="ident" id="3732900">sendAlert</span><span class="op" id="3732909">(</span><span class="ident" id="3732910">alertUnexpectedMessage</span><span class="op" id="3732932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3732936">return</span>&nbsp;<span class="ident" id="3732943">unexpectedMessageError</span><span class="op" id="3732965">(</span><span class="ident" id="3732966">clientFinished</span><span class="op" id="3732980">,</span>&nbsp;<span class="ident" id="3732982">msg</span><span class="op" id="3732985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3732988">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3732992">verify</span>&nbsp;<span class="op" id="3732999">:=</span>&nbsp;<span class="ident" id="3733002">hs</span><span class="op" id="3733004">.</span><span class="ident" id="3733005">finishedHash</span><span class="op" id="3733017">.</span><span class="ident" id="3733018">clientSum</span><span class="op" id="3733027">(</span><span class="ident" id="3733028">hs</span><span class="op" id="3733030">.</span><span class="ident" id="3733031">masterSecret</span><span class="op" id="3733043">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733046">if</span>&nbsp;<span class="builtinfunc" id="3733049">len</span><span class="op" id="3733052">(</span><span class="ident" id="3733053">verify</span><span class="op" id="3733059">)</span>&nbsp;<span class="op" id="3733061">!=</span>&nbsp;<span class="builtinfunc" id="3733064">len</span><span class="op" id="3733067">(</span><span class="ident" id="3733068">clientFinished</span><span class="op" id="3733082">.</span><span class="ident" id="3733083">verifyData</span><span class="op" id="3733093">)</span>&nbsp;<span class="op" id="3733095">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733100">subtle</span><span class="op" id="3733106">.</span><span class="ident" id="3733107">ConstantTimeCompare</span><span class="op" id="3733126">(</span><span class="ident" id="3733127">verify</span><span class="op" id="3733133">,</span>&nbsp;<span class="ident" id="3733135">clientFinished</span><span class="op" id="3733149">.</span><span class="ident" id="3733150">verifyData</span><span class="op" id="3733160">)</span>&nbsp;<span class="op" id="3733162">!=</span>&nbsp;<span class="num" id="3733165">1</span>&nbsp;<span class="op" id="3733167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733171">c</span><span class="op" id="3733172">.</span><span class="ident" id="3733173">sendAlert</span><span class="op" id="3733182">(</span><span class="ident" id="3733183">alertHandshakeFailure</span><span class="op" id="3733204">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733208">return</span>&nbsp;<span class="ident" id="3733215">errors</span><span class="op" id="3733221">.</span><span class="ident" id="3733222">New</span><span class="op" id="3733225">(</span><span class="string" id="3733226">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3733271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733274">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733278">hs</span><span class="op" id="3733280">.</span><span class="ident" id="3733281">finishedHash</span><span class="op" id="3733293">.</span><span class="ident" id="3733294">Write</span><span class="op" id="3733299">(</span><span class="ident" id="3733300">clientFinished</span><span class="op" id="3733314">.</span><span class="ident" id="3733315">marshal</span><span class="op" id="3733322">(</span><span class="op" id="3733323">)</span><span class="op" id="3733324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3733327">copy</span><span class="op" id="3733331">(</span><span class="ident" id="3733332">out</span><span class="op" id="3733335">,</span>&nbsp;<span class="ident" id="3733337">verify</span><span class="op" id="3733343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733346">return</span>&nbsp;<span class="ident" id="3733353">nil</span><br>
<span class="lineno"></span><span class="op" id="3733357">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3733360">func</span>&nbsp;<span class="op" id="3733365">(</span><span class="ident" id="3733366">hs</span>&nbsp;<span class="op" id="3733369">*</span><span class="ident" id="3733370">serverHandshakeState</span><span class="op" id="3733390">)</span>&nbsp;<span class="ident" id="3733392">sendSessionTicket</span><span class="op" id="3733409">(</span><span class="op" id="3733410">)</span>&nbsp;<span class="builtintype" id="3733412">error</span>&nbsp;<span class="op" id="3733418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733421">if</span>&nbsp;<span class="op" id="3733424">!</span><span class="ident" id="3733425">hs</span><span class="op" id="3733427">.</span><span class="ident" id="3733428">hello</span><span class="op" id="3733433">.</span><span class="ident" id="3733434">ticketSupported</span>&nbsp;<span class="op" id="3733450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733454">return</span>&nbsp;<span class="ident" id="3733461">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733466">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733470">c</span>&nbsp;<span class="op" id="3733472">:=</span>&nbsp;<span class="ident" id="3733475">hs</span><span class="op" id="3733477">.</span><span class="ident" id="3733478">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733481">m</span>&nbsp;<span class="op" id="3733483">:=</span>&nbsp;<span class="builtinfunc" id="3733486">new</span><span class="op" id="3733489">(</span><span class="ident" id="3733490">newSessionTicketMsg</span><span class="op" id="3733509">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733513">var</span>&nbsp;<span class="ident" id="3733517">err</span>&nbsp;<span class="builtintype" id="3733521">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733528">state</span>&nbsp;<span class="op" id="3733534">:=</span>&nbsp;<span class="ident" id="3733537">sessionState</span><span class="op" id="3733549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733553">vers</span><span class="op" id="3733557">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733567">c</span><span class="op" id="3733568">.</span><span class="ident" id="3733569">vers</span><span class="op" id="3733573">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733577">cipherSuite</span><span class="op" id="3733588">:</span>&nbsp;&nbsp;<span class="ident" id="3733591">hs</span><span class="op" id="3733593">.</span><span class="ident" id="3733594">suite</span><span class="op" id="3733599">.</span><span class="ident" id="3733600">id</span><span class="op" id="3733602">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733606">masterSecret</span><span class="op" id="3733618">:</span>&nbsp;<span class="ident" id="3733620">hs</span><span class="op" id="3733622">.</span><span class="ident" id="3733623">masterSecret</span><span class="op" id="3733635">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733639">certificates</span><span class="op" id="3733651">:</span>&nbsp;<span class="ident" id="3733653">hs</span><span class="op" id="3733655">.</span><span class="ident" id="3733656">certsFromClient</span><span class="op" id="3733671">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733677">m</span><span class="op" id="3733678">.</span><span class="ident" id="3733679">ticket</span><span class="op" id="3733685">,</span>&nbsp;<span class="ident" id="3733687">err</span>&nbsp;<span class="op" id="3733691">=</span>&nbsp;<span class="ident" id="3733693">c</span><span class="op" id="3733694">.</span><span class="ident" id="3733695">encryptTicket</span><span class="op" id="3733708">(</span><span class="op" id="3733709">&amp;</span><span class="ident" id="3733710">state</span><span class="op" id="3733715">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733718">if</span>&nbsp;<span class="ident" id="3733721">err</span>&nbsp;<span class="op" id="3733725">!=</span>&nbsp;<span class="ident" id="3733728">nil</span>&nbsp;<span class="op" id="3733732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733736">return</span>&nbsp;<span class="ident" id="3733743">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3733748">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733752">hs</span><span class="op" id="3733754">.</span><span class="ident" id="3733755">finishedHash</span><span class="op" id="3733767">.</span><span class="ident" id="3733768">Write</span><span class="op" id="3733773">(</span><span class="ident" id="3733774">m</span><span class="op" id="3733775">.</span><span class="ident" id="3733776">marshal</span><span class="op" id="3733783">(</span><span class="op" id="3733784">)</span><span class="op" id="3733785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733788">c</span><span class="op" id="3733789">.</span><span class="ident" id="3733790">writeRecord</span><span class="op" id="3733801">(</span><span class="ident" id="3733802">recordTypeHandshake</span><span class="op" id="3733821">,</span>&nbsp;<span class="ident" id="3733823">m</span><span class="op" id="3733824">.</span><span class="ident" id="3733825">marshal</span><span class="op" id="3733832">(</span><span class="op" id="3733833">)</span><span class="op" id="3733834">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3733838">return</span>&nbsp;<span class="ident" id="3733845">nil</span><br>
<span class="lineno">570</span><span class="op" id="3733849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733852">func</span>&nbsp;<span class="op" id="3733857">(</span><span class="ident" id="3733858">hs</span>&nbsp;<span class="op" id="3733861">*</span><span class="ident" id="3733862">serverHandshakeState</span><span class="op" id="3733882">)</span>&nbsp;<span class="ident" id="3733884">sendFinished</span><span class="op" id="3733896">(</span><span class="ident" id="3733897">out</span>&nbsp;<span class="op" id="3733901">[</span><span class="op" id="3733902">]</span><span class="builtintype" id="3733903">byte</span><span class="op" id="3733907">)</span>&nbsp;<span class="builtintype" id="3733909">error</span>&nbsp;<span class="op" id="3733915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733918">c</span>&nbsp;<span class="op" id="3733920">:=</span>&nbsp;<span class="ident" id="3733923">hs</span><span class="op" id="3733925">.</span><span class="ident" id="3733926">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733930">c</span><span class="op" id="3733931">.</span><span class="ident" id="3733932">writeRecord</span><span class="op" id="3733943">(</span><span class="ident" id="3733944">recordTypeChangeCipherSpec</span><span class="op" id="3733970">,</span>&nbsp;<span class="op" id="3733972">[</span><span class="op" id="3733973">]</span><span class="builtintype" id="3733974">byte</span><span class="op" id="3733978">{</span><span class="num" id="3733979">1</span><span class="op" id="3733980">}</span><span class="op" id="3733981">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3733985">finished</span>&nbsp;<span class="op" id="3733994">:=</span>&nbsp;<span class="builtinfunc" id="3733997">new</span><span class="op" id="3734000">(</span><span class="ident" id="3734001">finishedMsg</span><span class="op" id="3734012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734015">finished</span><span class="op" id="3734023">.</span><span class="ident" id="3734024">verifyData</span>&nbsp;<span class="op" id="3734035">=</span>&nbsp;<span class="ident" id="3734037">hs</span><span class="op" id="3734039">.</span><span class="ident" id="3734040">finishedHash</span><span class="op" id="3734052">.</span><span class="ident" id="3734053">serverSum</span><span class="op" id="3734062">(</span><span class="ident" id="3734063">hs</span><span class="op" id="3734065">.</span><span class="ident" id="3734066">masterSecret</span><span class="op" id="3734078">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734081">hs</span><span class="op" id="3734083">.</span><span class="ident" id="3734084">finishedHash</span><span class="op" id="3734096">.</span><span class="ident" id="3734097">Write</span><span class="op" id="3734102">(</span><span class="ident" id="3734103">finished</span><span class="op" id="3734111">.</span><span class="ident" id="3734112">marshal</span><span class="op" id="3734119">(</span><span class="op" id="3734120">)</span><span class="op" id="3734121">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734124">c</span><span class="op" id="3734125">.</span><span class="ident" id="3734126">writeRecord</span><span class="op" id="3734137">(</span><span class="ident" id="3734138">recordTypeHandshake</span><span class="op" id="3734157">,</span>&nbsp;<span class="ident" id="3734159">finished</span><span class="op" id="3734167">.</span><span class="ident" id="3734168">marshal</span><span class="op" id="3734175">(</span><span class="op" id="3734176">)</span><span class="op" id="3734177">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734181">c</span><span class="op" id="3734182">.</span><span class="ident" id="3734183">cipherSuite</span>&nbsp;<span class="op" id="3734195">=</span>&nbsp;<span class="ident" id="3734197">hs</span><span class="op" id="3734199">.</span><span class="ident" id="3734200">suite</span><span class="op" id="3734205">.</span><span class="ident" id="3734206">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3734210">copy</span><span class="op" id="3734214">(</span><span class="ident" id="3734215">out</span><span class="op" id="3734218">,</span>&nbsp;<span class="ident" id="3734220">finished</span><span class="op" id="3734228">.</span><span class="ident" id="3734229">verifyData</span><span class="op" id="3734239">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734243">return</span>&nbsp;<span class="ident" id="3734250">nil</span><br>
<span class="lineno"></span><span class="op" id="3734254">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3734257">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3734334">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3734411">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3734454">func</span>&nbsp;<span class="op" id="3734459">(</span><span class="ident" id="3734460">hs</span>&nbsp;<span class="op" id="3734463">*</span><span class="ident" id="3734464">serverHandshakeState</span><span class="op" id="3734484">)</span>&nbsp;<span class="ident" id="3734486">processCertsFromClient</span><span class="op" id="3734508">(</span><span class="ident" id="3734509">certificates</span>&nbsp;<span class="op" id="3734522">[</span><span class="op" id="3734523">]</span><span class="op" id="3734524">[</span><span class="op" id="3734525">]</span><span class="builtintype" id="3734526">byte</span><span class="op" id="3734530">)</span>&nbsp;<span class="op" id="3734532">(</span><span class="ident" id="3734533">crypto</span><span class="op" id="3734539">.</span><span class="ident" id="3734540">PublicKey</span><span class="op" id="3734549">,</span>&nbsp;<span class="builtintype" id="3734551">error</span><span class="op" id="3734556">)</span>&nbsp;<span class="op" id="3734558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734561">c</span>&nbsp;<span class="op" id="3734563">:=</span>&nbsp;<span class="ident" id="3734566">hs</span><span class="op" id="3734568">.</span><span class="ident" id="3734569">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734573">hs</span><span class="op" id="3734575">.</span><span class="ident" id="3734576">certsFromClient</span>&nbsp;<span class="op" id="3734592">=</span>&nbsp;<span class="ident" id="3734594">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734608">certs</span>&nbsp;<span class="op" id="3734614">:=</span>&nbsp;<span class="builtinfunc" id="3734617">make</span><span class="op" id="3734621">(</span><span class="op" id="3734622">[</span><span class="op" id="3734623">]</span><span class="op" id="3734624">*</span><span class="ident" id="3734625">x509</span><span class="op" id="3734629">.</span><span class="ident" id="3734630">Certificate</span><span class="op" id="3734641">,</span>&nbsp;<span class="builtinfunc" id="3734643">len</span><span class="op" id="3734646">(</span><span class="ident" id="3734647">certificates</span><span class="op" id="3734659">)</span><span class="op" id="3734660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734663">var</span>&nbsp;<span class="ident" id="3734667">err</span>&nbsp;<span class="builtintype" id="3734671">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734678">for</span>&nbsp;<span class="ident" id="3734682">i</span><span class="op" id="3734683">,</span>&nbsp;<span class="ident" id="3734685">asn1Data</span>&nbsp;<span class="op" id="3734694">:=</span>&nbsp;<span class="keyword" id="3734697">range</span>&nbsp;<span class="ident" id="3734703">certificates</span>&nbsp;<span class="op" id="3734716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734720">if</span>&nbsp;<span class="ident" id="3734723">certs</span><span class="op" id="3734728">[</span><span class="ident" id="3734729">i</span><span class="op" id="3734730">]</span><span class="op" id="3734731">,</span>&nbsp;<span class="ident" id="3734733">err</span>&nbsp;<span class="op" id="3734737">=</span>&nbsp;<span class="ident" id="3734739">x509</span><span class="op" id="3734743">.</span><span class="ident" id="3734744">ParseCertificate</span><span class="op" id="3734760">(</span><span class="ident" id="3734761">asn1Data</span><span class="op" id="3734769">)</span><span class="op" id="3734770">;</span>&nbsp;<span class="ident" id="3734772">err</span>&nbsp;<span class="op" id="3734776">!=</span>&nbsp;<span class="ident" id="3734779">nil</span>&nbsp;<span class="op" id="3734783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734788">c</span><span class="op" id="3734789">.</span><span class="ident" id="3734790">sendAlert</span><span class="op" id="3734799">(</span><span class="ident" id="3734800">alertBadCertificate</span><span class="op" id="3734819">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734824">return</span>&nbsp;<span class="ident" id="3734831">nil</span><span class="op" id="3734834">,</span>&nbsp;<span class="ident" id="3734836">errors</span><span class="op" id="3734842">.</span><span class="ident" id="3734843">New</span><span class="op" id="3734846">(</span><span class="string" id="3734847">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3734891">+</span>&nbsp;<span class="ident" id="3734893">err</span><span class="op" id="3734896">.</span><span class="ident" id="3734897">Error</span><span class="op" id="3734902">(</span><span class="op" id="3734903">)</span><span class="op" id="3734904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3734911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3734915">if</span>&nbsp;<span class="ident" id="3734918">c</span><span class="op" id="3734919">.</span><span class="ident" id="3734920">config</span><span class="op" id="3734926">.</span><span class="ident" id="3734927">ClientAuth</span>&nbsp;<span class="op" id="3734938">&gt;=</span>&nbsp;<span class="ident" id="3734941">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3734965">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3734968">len</span><span class="op" id="3734971">(</span><span class="ident" id="3734972">certs</span><span class="op" id="3734977">)</span>&nbsp;<span class="op" id="3734979">&gt;</span>&nbsp;<span class="num" id="3734981">0</span>&nbsp;<span class="op" id="3734983">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3734987">opts</span>&nbsp;<span class="op" id="3734992">:=</span>&nbsp;<span class="ident" id="3734995">x509</span><span class="op" id="3734999">.</span><span class="ident" id="3735000">VerifyOptions</span><span class="op" id="3735013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735018">Roots</span><span class="op" id="3735023">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3735033">c</span><span class="op" id="3735034">.</span><span class="ident" id="3735035">config</span><span class="op" id="3735041">.</span><span class="ident" id="3735042">ClientCAs</span><span class="op" id="3735051">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735056">CurrentTime</span><span class="op" id="3735067">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3735071">c</span><span class="op" id="3735072">.</span><span class="ident" id="3735073">config</span><span class="op" id="3735079">.</span><span class="ident" id="3735080">time</span><span class="op" id="3735084">(</span><span class="op" id="3735085">)</span><span class="op" id="3735086">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735091">Intermediates</span><span class="op" id="3735104">:</span>&nbsp;<span class="ident" id="3735106">x509</span><span class="op" id="3735110">.</span><span class="ident" id="3735111">NewCertPool</span><span class="op" id="3735122">(</span><span class="op" id="3735123">)</span><span class="op" id="3735124">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735129">KeyUsages</span><span class="op" id="3735138">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735144">[</span><span class="op" id="3735145">]</span><span class="ident" id="3735146">x509</span><span class="op" id="3735150">.</span><span class="ident" id="3735151">ExtKeyUsage</span><span class="op" id="3735162">{</span><span class="ident" id="3735163">x509</span><span class="op" id="3735167">.</span><span class="ident" id="3735168">ExtKeyUsageClientAuth</span><span class="op" id="3735189">}</span><span class="op" id="3735190">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735199">for</span>&nbsp;<span class="ident" id="3735203">_</span><span class="op" id="3735204">,</span>&nbsp;<span class="ident" id="3735206">cert</span>&nbsp;<span class="op" id="3735211">:=</span>&nbsp;<span class="keyword" id="3735214">range</span>&nbsp;<span class="ident" id="3735220">certs</span><span class="op" id="3735225">[</span><span class="num" id="3735226">1</span><span class="op" id="3735227">:</span><span class="op" id="3735228">]</span>&nbsp;<span class="op" id="3735230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735235">opts</span><span class="op" id="3735239">.</span><span class="ident" id="3735240">Intermediates</span><span class="op" id="3735253">.</span><span class="ident" id="3735254">AddCert</span><span class="op" id="3735261">(</span><span class="ident" id="3735262">cert</span><span class="op" id="3735266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735270">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735275">chains</span><span class="op" id="3735281">,</span>&nbsp;<span class="ident" id="3735283">err</span>&nbsp;<span class="op" id="3735287">:=</span>&nbsp;<span class="ident" id="3735290">certs</span><span class="op" id="3735295">[</span><span class="num" id="3735296">0</span><span class="op" id="3735297">]</span><span class="op" id="3735298">.</span><span class="ident" id="3735299">Verify</span><span class="op" id="3735305">(</span><span class="ident" id="3735306">opts</span><span class="op" id="3735310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735314">if</span>&nbsp;<span class="ident" id="3735317">err</span>&nbsp;<span class="op" id="3735321">!=</span>&nbsp;<span class="ident" id="3735324">nil</span>&nbsp;<span class="op" id="3735328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735333">c</span><span class="op" id="3735334">.</span><span class="ident" id="3735335">sendAlert</span><span class="op" id="3735344">(</span><span class="ident" id="3735345">alertBadCertificate</span><span class="op" id="3735364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735369">return</span>&nbsp;<span class="ident" id="3735376">nil</span><span class="op" id="3735379">,</span>&nbsp;<span class="ident" id="3735381">errors</span><span class="op" id="3735387">.</span><span class="ident" id="3735388">New</span><span class="op" id="3735391">(</span><span class="string" id="3735392">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3735439">+</span>&nbsp;<span class="ident" id="3735441">err</span><span class="op" id="3735444">.</span><span class="ident" id="3735445">Error</span><span class="op" id="3735450">(</span><span class="op" id="3735451">)</span><span class="op" id="3735452">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735456">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735461">ok</span>&nbsp;<span class="op" id="3735464">:=</span>&nbsp;<span class="builtintype" id="3735467">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735475">for</span>&nbsp;<span class="ident" id="3735479">_</span><span class="op" id="3735480">,</span>&nbsp;<span class="ident" id="3735482">ku</span>&nbsp;<span class="op" id="3735485">:=</span>&nbsp;<span class="keyword" id="3735488">range</span>&nbsp;<span class="ident" id="3735494">certs</span><span class="op" id="3735499">[</span><span class="num" id="3735500">0</span><span class="op" id="3735501">]</span><span class="op" id="3735502">.</span><span class="ident" id="3735503">ExtKeyUsage</span>&nbsp;<span class="op" id="3735515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735520">if</span>&nbsp;<span class="ident" id="3735523">ku</span>&nbsp;<span class="op" id="3735526">==</span>&nbsp;<span class="ident" id="3735529">x509</span><span class="op" id="3735533">.</span><span class="ident" id="3735534">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3735556">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735562">ok</span>&nbsp;<span class="op" id="3735565">=</span>&nbsp;<span class="builtintype" id="3735567">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735576">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735593">if</span>&nbsp;<span class="op" id="3735596">!</span><span class="ident" id="3735597">ok</span>&nbsp;<span class="op" id="3735600">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735605">c</span><span class="op" id="3735606">.</span><span class="ident" id="3735607">sendAlert</span><span class="op" id="3735616">(</span><span class="ident" id="3735617">alertHandshakeFailure</span><span class="op" id="3735638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735643">return</span>&nbsp;<span class="ident" id="3735650">nil</span><span class="op" id="3735653">,</span>&nbsp;<span class="ident" id="3735655">errors</span><span class="op" id="3735661">.</span><span class="ident" id="3735662">New</span><span class="op" id="3735665">(</span><span class="string" id="3735666">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3735769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735778">c</span><span class="op" id="3735779">.</span><span class="ident" id="3735780">verifiedChains</span>&nbsp;<span class="op" id="3735795">=</span>&nbsp;<span class="ident" id="3735797">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3735805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735809">if</span>&nbsp;<span class="builtinfunc" id="3735812">len</span><span class="op" id="3735815">(</span><span class="ident" id="3735816">certs</span><span class="op" id="3735821">)</span>&nbsp;<span class="op" id="3735823">&gt;</span>&nbsp;<span class="num" id="3735825">0</span>&nbsp;<span class="op" id="3735827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735831">var</span>&nbsp;<span class="ident" id="3735835">pub</span>&nbsp;<span class="ident" id="3735839">crypto</span><span class="op" id="3735845">.</span><span class="ident" id="3735846">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735858">switch</span>&nbsp;<span class="ident" id="3735865">key</span>&nbsp;<span class="op" id="3735869">:=</span>&nbsp;<span class="ident" id="3735872">certs</span><span class="op" id="3735877">[</span><span class="num" id="3735878">0</span><span class="op" id="3735879">]</span><span class="op" id="3735880">.</span><span class="ident" id="3735881">PublicKey</span><span class="op" id="3735890">.</span><span class="op" id="3735891">(</span><span class="keyword" id="3735892">type</span><span class="op" id="3735896">)</span>&nbsp;<span class="op" id="3735898">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735902">case</span>&nbsp;<span class="op" id="3735907">*</span><span class="ident" id="3735908">ecdsa</span><span class="op" id="3735913">.</span><span class="ident" id="3735914">PublicKey</span><span class="op" id="3735923">,</span>&nbsp;<span class="op" id="3735925">*</span><span class="ident" id="3735926">rsa</span><span class="op" id="3735929">.</span><span class="ident" id="3735930">PublicKey</span><span class="op" id="3735939">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735944">pub</span>&nbsp;<span class="op" id="3735948">=</span>&nbsp;<span class="ident" id="3735950">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3735956">default</span><span class="op" id="3735963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3735968">c</span><span class="op" id="3735969">.</span><span class="ident" id="3735970">sendAlert</span><span class="op" id="3735979">(</span><span class="ident" id="3735980">alertUnsupportedCertificate</span><span class="op" id="3736007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736012">return</span>&nbsp;<span class="ident" id="3736019">nil</span><span class="op" id="3736022">,</span>&nbsp;<span class="ident" id="3736024">fmt</span><span class="op" id="3736027">.</span><span class="ident" id="3736028">Errorf</span><span class="op" id="3736034">(</span><span class="string" id="3736035">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3736108">,</span>&nbsp;<span class="ident" id="3736110">certs</span><span class="op" id="3736115">[</span><span class="num" id="3736116">0</span><span class="op" id="3736117">]</span><span class="op" id="3736118">.</span><span class="ident" id="3736119">PublicKey</span><span class="op" id="3736128">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736136">c</span><span class="op" id="3736137">.</span><span class="ident" id="3736138">peerCertificates</span>&nbsp;<span class="op" id="3736155">=</span>&nbsp;<span class="ident" id="3736157">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736165">return</span>&nbsp;<span class="ident" id="3736172">pub</span><span class="op" id="3736175">,</span>&nbsp;<span class="ident" id="3736177">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736186">return</span>&nbsp;<span class="ident" id="3736193">nil</span><span class="op" id="3736196">,</span>&nbsp;<span class="ident" id="3736198">nil</span><br>
<span class="lineno"></span><span class="op" id="3736202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736205">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3736284">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3736309">func</span>&nbsp;<span class="op" id="3736314">(</span><span class="ident" id="3736315">c</span>&nbsp;<span class="op" id="3736317">*</span><span class="ident" id="3736318">Conn</span><span class="op" id="3736322">)</span>&nbsp;<span class="ident" id="3736324">tryCipherSuite</span><span class="op" id="3736338">(</span><span class="ident" id="3736339">id</span>&nbsp;<span class="builtintype" id="3736342">uint16</span><span class="op" id="3736348">,</span>&nbsp;<span class="ident" id="3736350">supportedCipherSuites</span>&nbsp;<span class="op" id="3736372">[</span><span class="op" id="3736373">]</span><span class="builtintype" id="3736374">uint16</span><span class="op" id="3736380">,</span>&nbsp;<span class="ident" id="3736382">version</span>&nbsp;<span class="builtintype" id="3736390">uint16</span><span class="op" id="3736396">,</span>&nbsp;<span class="ident" id="3736398">ellipticOk</span><span class="op" id="3736408">,</span>&nbsp;<span class="ident" id="3736410">ecdsaOk</span>&nbsp;<span class="builtintype" id="3736418">bool</span><span class="op" id="3736422">)</span>&nbsp;<span class="op" id="3736424">*</span><span class="ident" id="3736425">cipherSuite</span>&nbsp;<span class="op" id="3736437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736440">for</span>&nbsp;<span class="ident" id="3736444">_</span><span class="op" id="3736445">,</span>&nbsp;<span class="ident" id="3736447">supported</span>&nbsp;<span class="op" id="3736457">:=</span>&nbsp;<span class="keyword" id="3736460">range</span>&nbsp;<span class="ident" id="3736466">supportedCipherSuites</span>&nbsp;<span class="op" id="3736488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736492">if</span>&nbsp;<span class="ident" id="3736495">id</span>&nbsp;<span class="op" id="3736498">==</span>&nbsp;<span class="ident" id="3736501">supported</span>&nbsp;<span class="op" id="3736511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736516">var</span>&nbsp;<span class="ident" id="3736520">candidate</span>&nbsp;<span class="op" id="3736530">*</span><span class="ident" id="3736531">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736547">for</span>&nbsp;<span class="ident" id="3736551">_</span><span class="op" id="3736552">,</span>&nbsp;<span class="ident" id="3736554">s</span>&nbsp;<span class="op" id="3736556">:=</span>&nbsp;<span class="keyword" id="3736559">range</span>&nbsp;<span class="ident" id="3736565">cipherSuites</span>&nbsp;<span class="op" id="3736578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736584">if</span>&nbsp;<span class="ident" id="3736587">s</span><span class="op" id="3736588">.</span><span class="ident" id="3736589">id</span>&nbsp;<span class="op" id="3736592">==</span>&nbsp;<span class="ident" id="3736595">id</span>&nbsp;<span class="op" id="3736598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3736605">candidate</span>&nbsp;<span class="op" id="3736615">=</span>&nbsp;<span class="ident" id="3736617">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736624">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736634">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736639">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736644">if</span>&nbsp;<span class="ident" id="3736647">candidate</span>&nbsp;<span class="op" id="3736657">==</span>&nbsp;<span class="ident" id="3736660">nil</span>&nbsp;<span class="op" id="3736664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736670">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736687">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3736735">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736766">if</span>&nbsp;<span class="op" id="3736769">(</span><span class="ident" id="3736770">candidate</span><span class="op" id="3736779">.</span><span class="ident" id="3736780">flags</span><span class="op" id="3736785">&amp;</span><span class="ident" id="3736786">suiteECDHE</span>&nbsp;<span class="op" id="3736797">!=</span>&nbsp;<span class="num" id="3736800">0</span><span class="op" id="3736801">)</span>&nbsp;<span class="op" id="3736803">&amp;&amp;</span>&nbsp;<span class="op" id="3736806">!</span><span class="ident" id="3736807">ellipticOk</span>&nbsp;<span class="op" id="3736818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736824">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736836">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736841">if</span>&nbsp;<span class="op" id="3736844">(</span><span class="ident" id="3736845">candidate</span><span class="op" id="3736854">.</span><span class="ident" id="3736855">flags</span><span class="op" id="3736860">&amp;</span><span class="ident" id="3736861">suiteECDSA</span>&nbsp;<span class="op" id="3736872">!=</span>&nbsp;<span class="num" id="3736875">0</span><span class="op" id="3736876">)</span>&nbsp;<span class="op" id="3736878">!=</span>&nbsp;<span class="ident" id="3736881">ecdsaOk</span>&nbsp;<span class="op" id="3736889">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736895">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736912">if</span>&nbsp;<span class="ident" id="3736915">version</span>&nbsp;<span class="op" id="3736923">&lt;</span>&nbsp;<span class="ident" id="3736925">VersionTLS12</span>&nbsp;<span class="op" id="3736938">&amp;&amp;</span>&nbsp;<span class="ident" id="3736941">candidate</span><span class="op" id="3736950">.</span><span class="ident" id="3736951">flags</span><span class="op" id="3736956">&amp;</span><span class="ident" id="3736957">suiteTLS12</span>&nbsp;<span class="op" id="3736968">!=</span>&nbsp;<span class="num" id="3736971">0</span>&nbsp;<span class="op" id="3736973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736979">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3736991">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3736996">return</span>&nbsp;<span class="ident" id="3737003">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3737018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3737022">return</span>&nbsp;<span class="ident" id="3737029">nil</span><br>
<span class="lineno">685</span><span class="op" id="3737033">}</span>
</div>
</body>
</html>
