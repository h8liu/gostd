<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4052249">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4052304">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4052358">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4052409">package</span>&nbsp;<span class="ident" id="4052417">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4052422">import</span>&nbsp;<span class="string" id="4052429">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052444">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="4052498">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="4052554">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="4052593">type</span>&nbsp;<span class="ident" id="4052598">fdMutex</span>&nbsp;<span class="keyword" id="4052606">struct</span>&nbsp;<span class="op" id="4052613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052616">state</span>&nbsp;<span class="ident" id="4052622">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052630">rsema</span>&nbsp;<span class="builtintype" id="4052636">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4052644">wsema</span>&nbsp;<span class="builtintype" id="4052650">uint32</span><br>
<span class="lineno"></span><span class="op" id="4052657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4052660">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="4052702">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="4052787">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="4052824">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="4052862">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="4052921">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="4052970">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="4053020">const</span>&nbsp;<span class="op" id="4053026">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053029">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="4053042">=</span>&nbsp;<span class="num" id="4053044">1</span>&nbsp;<span class="op" id="4053046">&lt;&lt;</span>&nbsp;<span class="num" id="4053049">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053052">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053065">=</span>&nbsp;<span class="num" id="4053067">1</span>&nbsp;<span class="op" id="4053069">&lt;&lt;</span>&nbsp;<span class="num" id="4053072">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053075">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053088">=</span>&nbsp;<span class="num" id="4053090">1</span>&nbsp;<span class="op" id="4053092">&lt;&lt;</span>&nbsp;<span class="num" id="4053095">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053098">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4053111">=</span>&nbsp;<span class="num" id="4053113">1</span>&nbsp;<span class="op" id="4053115">&lt;&lt;</span>&nbsp;<span class="num" id="4053118">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053121">mutexRefMask</span>&nbsp;<span class="op" id="4053134">=</span>&nbsp;<span class="op" id="4053136">(</span><span class="num" id="4053137">1</span><span class="op" id="4053138">&lt;&lt;</span><span class="num" id="4053140">20</span>&nbsp;<span class="op" id="4053143">-</span>&nbsp;<span class="num" id="4053145">1</span><span class="op" id="4053146">)</span>&nbsp;<span class="op" id="4053148">&lt;&lt;</span>&nbsp;<span class="num" id="4053151">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053154">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053167">=</span>&nbsp;<span class="num" id="4053169">1</span>&nbsp;<span class="op" id="4053171">&lt;&lt;</span>&nbsp;<span class="num" id="4053174">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053178">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053191">=</span>&nbsp;<span class="op" id="4053193">(</span><span class="num" id="4053194">1</span><span class="op" id="4053195">&lt;&lt;</span><span class="num" id="4053197">20</span>&nbsp;<span class="op" id="4053200">-</span>&nbsp;<span class="num" id="4053202">1</span><span class="op" id="4053203">)</span>&nbsp;<span class="op" id="4053205">&lt;&lt;</span>&nbsp;<span class="num" id="4053208">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053212">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053225">=</span>&nbsp;<span class="num" id="4053227">1</span>&nbsp;<span class="op" id="4053229">&lt;&lt;</span>&nbsp;<span class="num" id="4053232">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053236">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4053249">=</span>&nbsp;<span class="op" id="4053251">(</span><span class="num" id="4053252">1</span><span class="op" id="4053253">&lt;&lt;</span><span class="num" id="4053255">20</span>&nbsp;<span class="op" id="4053258">-</span>&nbsp;<span class="num" id="4053260">1</span><span class="op" id="4053261">)</span>&nbsp;<span class="op" id="4053263">&lt;&lt;</span>&nbsp;<span class="num" id="4053266">43</span><br>
<span class="lineno">35</span><span class="op" id="4053269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4053272">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="4053328">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="4053387">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="4053468">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="4053545">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="4053618">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="4053668">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="4053719">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="4053763">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4053850">func</span>&nbsp;<span class="op" id="4053855">(</span><span class="ident" id="4053856">mu</span>&nbsp;<span class="op" id="4053859">*</span><span class="ident" id="4053860">fdMutex</span><span class="op" id="4053867">)</span>&nbsp;<span class="ident" id="4053869">Incref</span><span class="op" id="4053875">(</span><span class="op" id="4053876">)</span>&nbsp;<span class="builtintype" id="4053878">bool</span>&nbsp;<span class="op" id="4053883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053886">for</span>&nbsp;<span class="op" id="4053890">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4053894">old</span>&nbsp;<span class="op" id="4053898">:=</span>&nbsp;<span class="ident" id="4053901">atomic</span><span class="op" id="4053907">.</span><span class="ident" id="4053908">LoadUint64</span><span class="op" id="4053918">(</span><span class="op" id="4053919">&amp;</span><span class="ident" id="4053920">mu</span><span class="op" id="4053922">.</span><span class="ident" id="4053923">state</span><span class="op" id="4053928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053932">if</span>&nbsp;<span class="ident" id="4053935">old</span><span class="op" id="4053938">&amp;</span><span class="ident" id="4053939">mutexClosed</span>&nbsp;<span class="op" id="4053951">!=</span>&nbsp;<span class="num" id="4053954">0</span>&nbsp;<span class="op" id="4053956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4053961">return</span>&nbsp;<span class="builtintype" id="4053968">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4053976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4053980">new</span>&nbsp;<span class="op" id="4053984">:=</span>&nbsp;<span class="ident" id="4053987">old</span>&nbsp;<span class="op" id="4053991">+</span>&nbsp;<span class="ident" id="4053993">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054004">if</span>&nbsp;<span class="builtinfunc" id="4054007">new</span><span class="op" id="4054010">&amp;</span><span class="ident" id="4054011">mutexRefMask</span>&nbsp;<span class="op" id="4054024">==</span>&nbsp;<span class="num" id="4054027">0</span>&nbsp;<span class="op" id="4054029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4054034">panic</span><span class="op" id="4054039">(</span><span class="string" id="4054040">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4054067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054075">if</span>&nbsp;<span class="ident" id="4054078">atomic</span><span class="op" id="4054084">.</span><span class="ident" id="4054085">CompareAndSwapUint64</span><span class="op" id="4054105">(</span><span class="op" id="4054106">&amp;</span><span class="ident" id="4054107">mu</span><span class="op" id="4054109">.</span><span class="ident" id="4054110">state</span><span class="op" id="4054115">,</span>&nbsp;<span class="ident" id="4054117">old</span><span class="op" id="4054120">,</span>&nbsp;<span class="builtinfunc" id="4054122">new</span><span class="op" id="4054125">)</span>&nbsp;<span class="op" id="4054127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054132">return</span>&nbsp;<span class="builtintype" id="4054139">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054146">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054149">}</span><br>
<span class="lineno"></span><span class="op" id="4054151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4054154">func</span>&nbsp;<span class="op" id="4054159">(</span><span class="ident" id="4054160">mu</span>&nbsp;<span class="op" id="4054163">*</span><span class="ident" id="4054164">fdMutex</span><span class="op" id="4054171">)</span>&nbsp;<span class="ident" id="4054173">IncrefAndClose</span><span class="op" id="4054187">(</span><span class="op" id="4054188">)</span>&nbsp;<span class="builtintype" id="4054190">bool</span>&nbsp;<span class="op" id="4054195">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054198">for</span>&nbsp;<span class="op" id="4054202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054206">old</span>&nbsp;<span class="op" id="4054210">:=</span>&nbsp;<span class="ident" id="4054213">atomic</span><span class="op" id="4054219">.</span><span class="ident" id="4054220">LoadUint64</span><span class="op" id="4054230">(</span><span class="op" id="4054231">&amp;</span><span class="ident" id="4054232">mu</span><span class="op" id="4054234">.</span><span class="ident" id="4054235">state</span><span class="op" id="4054240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054244">if</span>&nbsp;<span class="ident" id="4054247">old</span><span class="op" id="4054250">&amp;</span><span class="ident" id="4054251">mutexClosed</span>&nbsp;<span class="op" id="4054263">!=</span>&nbsp;<span class="num" id="4054266">0</span>&nbsp;<span class="op" id="4054268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054273">return</span>&nbsp;<span class="builtintype" id="4054280">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054288">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054292">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4054337">new</span>&nbsp;<span class="op" id="4054341">:=</span>&nbsp;<span class="op" id="4054344">(</span><span class="ident" id="4054345">old</span>&nbsp;<span class="op" id="4054349">|</span>&nbsp;<span class="ident" id="4054351">mutexClosed</span><span class="op" id="4054362">)</span>&nbsp;<span class="op" id="4054364">+</span>&nbsp;<span class="ident" id="4054366">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054377">if</span>&nbsp;<span class="builtinfunc" id="4054380">new</span><span class="op" id="4054383">&amp;</span><span class="ident" id="4054384">mutexRefMask</span>&nbsp;<span class="op" id="4054397">==</span>&nbsp;<span class="num" id="4054400">0</span>&nbsp;<span class="op" id="4054402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4054407">panic</span><span class="op" id="4054412">(</span><span class="string" id="4054413">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4054440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054444">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054448">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4054488">new</span>&nbsp;<span class="op" id="4054492">&amp;^=</span>&nbsp;<span class="ident" id="4054496">mutexRMask</span>&nbsp;<span class="op" id="4054507">|</span>&nbsp;<span class="ident" id="4054509">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054522">if</span>&nbsp;<span class="ident" id="4054525">atomic</span><span class="op" id="4054531">.</span><span class="ident" id="4054532">CompareAndSwapUint64</span><span class="op" id="4054552">(</span><span class="op" id="4054553">&amp;</span><span class="ident" id="4054554">mu</span><span class="op" id="4054556">.</span><span class="ident" id="4054557">state</span><span class="op" id="4054562">,</span>&nbsp;<span class="ident" id="4054564">old</span><span class="op" id="4054567">,</span>&nbsp;<span class="builtinfunc" id="4054569">new</span><span class="op" id="4054572">)</span>&nbsp;<span class="op" id="4054574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054579">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4054618">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054668">for</span>&nbsp;<span class="ident" id="4054672">old</span><span class="op" id="4054675">&amp;</span><span class="ident" id="4054676">mutexRMask</span>&nbsp;<span class="op" id="4054687">!=</span>&nbsp;<span class="num" id="4054690">0</span>&nbsp;<span class="op" id="4054692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054698">old</span>&nbsp;<span class="op" id="4054702">-=</span>&nbsp;<span class="ident" id="4054705">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054720">runtime_Semrelease</span><span class="op" id="4054738">(</span><span class="op" id="4054739">&amp;</span><span class="ident" id="4054740">mu</span><span class="op" id="4054742">.</span><span class="ident" id="4054743">rsema</span><span class="op" id="4054748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054758">for</span>&nbsp;<span class="ident" id="4054762">old</span><span class="op" id="4054765">&amp;</span><span class="ident" id="4054766">mutexWMask</span>&nbsp;<span class="op" id="4054777">!=</span>&nbsp;<span class="num" id="4054780">0</span>&nbsp;<span class="op" id="4054782">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054788">old</span>&nbsp;<span class="op" id="4054792">-=</span>&nbsp;<span class="ident" id="4054795">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054810">runtime_Semrelease</span><span class="op" id="4054828">(</span><span class="op" id="4054829">&amp;</span><span class="ident" id="4054830">mu</span><span class="op" id="4054832">.</span><span class="ident" id="4054833">wsema</span><span class="op" id="4054838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054848">return</span>&nbsp;<span class="builtintype" id="4054855">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054862">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4054865">}</span><br>
<span class="lineno"></span><span class="op" id="4054867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4054870">func</span>&nbsp;<span class="op" id="4054875">(</span><span class="ident" id="4054876">mu</span>&nbsp;<span class="op" id="4054879">*</span><span class="ident" id="4054880">fdMutex</span><span class="op" id="4054887">)</span>&nbsp;<span class="ident" id="4054889">Decref</span><span class="op" id="4054895">(</span><span class="op" id="4054896">)</span>&nbsp;<span class="builtintype" id="4054898">bool</span>&nbsp;<span class="op" id="4054903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054906">for</span>&nbsp;<span class="op" id="4054910">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4054914">old</span>&nbsp;<span class="op" id="4054918">:=</span>&nbsp;<span class="ident" id="4054921">atomic</span><span class="op" id="4054927">.</span><span class="ident" id="4054928">LoadUint64</span><span class="op" id="4054938">(</span><span class="op" id="4054939">&amp;</span><span class="ident" id="4054940">mu</span><span class="op" id="4054942">.</span><span class="ident" id="4054943">state</span><span class="op" id="4054948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4054952">if</span>&nbsp;<span class="ident" id="4054955">old</span><span class="op" id="4054958">&amp;</span><span class="ident" id="4054959">mutexRefMask</span>&nbsp;<span class="op" id="4054972">==</span>&nbsp;<span class="num" id="4054975">0</span>&nbsp;<span class="op" id="4054977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4054982">panic</span><span class="op" id="4054987">(</span><span class="string" id="4054988">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4055015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055023">new</span>&nbsp;<span class="op" id="4055027">:=</span>&nbsp;<span class="ident" id="4055030">old</span>&nbsp;<span class="op" id="4055034">-</span>&nbsp;<span class="ident" id="4055036">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055047">if</span>&nbsp;<span class="ident" id="4055050">atomic</span><span class="op" id="4055056">.</span><span class="ident" id="4055057">CompareAndSwapUint64</span><span class="op" id="4055077">(</span><span class="op" id="4055078">&amp;</span><span class="ident" id="4055079">mu</span><span class="op" id="4055081">.</span><span class="ident" id="4055082">state</span><span class="op" id="4055087">,</span>&nbsp;<span class="ident" id="4055089">old</span><span class="op" id="4055092">,</span>&nbsp;<span class="builtinfunc" id="4055094">new</span><span class="op" id="4055097">)</span>&nbsp;<span class="op" id="4055099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055104">return</span>&nbsp;<span class="builtinfunc" id="4055111">new</span><span class="op" id="4055114">&amp;</span><span class="op" id="4055115">(</span><span class="ident" id="4055116">mutexClosed</span><span class="op" id="4055127">|</span><span class="ident" id="4055128">mutexRefMask</span><span class="op" id="4055140">)</span>&nbsp;<span class="op" id="4055142">==</span>&nbsp;<span class="ident" id="4055145">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055162">}</span><br>
<span class="lineno"></span><span class="op" id="4055164">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="4055167">func</span>&nbsp;<span class="op" id="4055172">(</span><span class="ident" id="4055173">mu</span>&nbsp;<span class="op" id="4055176">*</span><span class="ident" id="4055177">fdMutex</span><span class="op" id="4055184">)</span>&nbsp;<span class="ident" id="4055186">RWLock</span><span class="op" id="4055192">(</span><span class="ident" id="4055193">read</span>&nbsp;<span class="builtintype" id="4055198">bool</span><span class="op" id="4055202">)</span>&nbsp;<span class="builtintype" id="4055204">bool</span>&nbsp;<span class="op" id="4055209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055212">var</span>&nbsp;<span class="ident" id="4055216">mutexBit</span><span class="op" id="4055224">,</span>&nbsp;<span class="ident" id="4055226">mutexWait</span><span class="op" id="4055235">,</span>&nbsp;<span class="ident" id="4055237">mutexMask</span>&nbsp;<span class="ident" id="4055247">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055255">var</span>&nbsp;<span class="ident" id="4055259">mutexSema</span>&nbsp;<span class="op" id="4055269">*</span><span class="builtintype" id="4055270">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055278">if</span>&nbsp;<span class="ident" id="4055281">read</span>&nbsp;<span class="op" id="4055286">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055290">mutexBit</span>&nbsp;<span class="op" id="4055299">=</span>&nbsp;<span class="ident" id="4055301">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055314">mutexWait</span>&nbsp;<span class="op" id="4055324">=</span>&nbsp;<span class="ident" id="4055326">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055339">mutexMask</span>&nbsp;<span class="op" id="4055349">=</span>&nbsp;<span class="ident" id="4055351">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055364">mutexSema</span>&nbsp;<span class="op" id="4055374">=</span>&nbsp;<span class="op" id="4055376">&amp;</span><span class="ident" id="4055377">mu</span><span class="op" id="4055379">.</span><span class="ident" id="4055380">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055387">}</span>&nbsp;<span class="keyword" id="4055389">else</span>&nbsp;<span class="op" id="4055394">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055398">mutexBit</span>&nbsp;<span class="op" id="4055407">=</span>&nbsp;<span class="ident" id="4055409">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055422">mutexWait</span>&nbsp;<span class="op" id="4055432">=</span>&nbsp;<span class="ident" id="4055434">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055447">mutexMask</span>&nbsp;<span class="op" id="4055457">=</span>&nbsp;<span class="ident" id="4055459">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055472">mutexSema</span>&nbsp;<span class="op" id="4055482">=</span>&nbsp;<span class="op" id="4055484">&amp;</span><span class="ident" id="4055485">mu</span><span class="op" id="4055487">.</span><span class="ident" id="4055488">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055495">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055498">for</span>&nbsp;<span class="op" id="4055502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4055506">old</span>&nbsp;<span class="op" id="4055510">:=</span>&nbsp;<span class="ident" id="4055513">atomic</span><span class="op" id="4055519">.</span><span class="ident" id="4055520">LoadUint64</span><span class="op" id="4055530">(</span><span class="op" id="4055531">&amp;</span><span class="ident" id="4055532">mu</span><span class="op" id="4055534">.</span><span class="ident" id="4055535">state</span><span class="op" id="4055540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055544">if</span>&nbsp;<span class="ident" id="4055547">old</span><span class="op" id="4055550">&amp;</span><span class="ident" id="4055551">mutexClosed</span>&nbsp;<span class="op" id="4055563">!=</span>&nbsp;<span class="num" id="4055566">0</span>&nbsp;<span class="op" id="4055568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055573">return</span>&nbsp;<span class="builtintype" id="4055580">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055588">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055592">var</span>&nbsp;<span class="builtinfunc" id="4055596">new</span>&nbsp;<span class="ident" id="4055600">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055609">if</span>&nbsp;<span class="ident" id="4055612">old</span><span class="op" id="4055615">&amp;</span><span class="ident" id="4055616">mutexBit</span>&nbsp;<span class="op" id="4055625">==</span>&nbsp;<span class="num" id="4055628">0</span>&nbsp;<span class="op" id="4055630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055635">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055667">new</span>&nbsp;<span class="op" id="4055671">=</span>&nbsp;<span class="op" id="4055673">(</span><span class="ident" id="4055674">old</span>&nbsp;<span class="op" id="4055678">|</span>&nbsp;<span class="ident" id="4055680">mutexBit</span><span class="op" id="4055688">)</span>&nbsp;<span class="op" id="4055690">+</span>&nbsp;<span class="ident" id="4055692">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055704">if</span>&nbsp;<span class="builtinfunc" id="4055707">new</span><span class="op" id="4055710">&amp;</span><span class="ident" id="4055711">mutexRefMask</span>&nbsp;<span class="op" id="4055724">==</span>&nbsp;<span class="num" id="4055727">0</span>&nbsp;<span class="op" id="4055729">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055735">panic</span><span class="op" id="4055740">(</span><span class="string" id="4055741">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4055768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055773">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055777">}</span>&nbsp;<span class="keyword" id="4055779">else</span>&nbsp;<span class="op" id="4055784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4055789">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055810">new</span>&nbsp;<span class="op" id="4055814">=</span>&nbsp;<span class="ident" id="4055816">old</span>&nbsp;<span class="op" id="4055820">+</span>&nbsp;<span class="ident" id="4055822">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055835">if</span>&nbsp;<span class="builtinfunc" id="4055838">new</span><span class="op" id="4055841">&amp;</span><span class="ident" id="4055842">mutexMask</span>&nbsp;<span class="op" id="4055852">==</span>&nbsp;<span class="num" id="4055855">0</span>&nbsp;<span class="op" id="4055857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4055863">panic</span><span class="op" id="4055868">(</span><span class="string" id="4055869">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4055896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4055905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055909">if</span>&nbsp;<span class="ident" id="4055912">atomic</span><span class="op" id="4055918">.</span><span class="ident" id="4055919">CompareAndSwapUint64</span><span class="op" id="4055939">(</span><span class="op" id="4055940">&amp;</span><span class="ident" id="4055941">mu</span><span class="op" id="4055943">.</span><span class="ident" id="4055944">state</span><span class="op" id="4055949">,</span>&nbsp;<span class="ident" id="4055951">old</span><span class="op" id="4055954">,</span>&nbsp;<span class="builtinfunc" id="4055956">new</span><span class="op" id="4055959">)</span>&nbsp;<span class="op" id="4055961">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055966">if</span>&nbsp;<span class="ident" id="4055969">old</span><span class="op" id="4055972">&amp;</span><span class="ident" id="4055973">mutexBit</span>&nbsp;<span class="op" id="4055982">==</span>&nbsp;<span class="num" id="4055985">0</span>&nbsp;<span class="op" id="4055987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4055993">return</span>&nbsp;<span class="builtintype" id="4056000">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056013">runtime_Semacquire</span><span class="op" id="4056031">(</span><span class="ident" id="4056032">mutexSema</span><span class="op" id="4056041">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056046">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056094">}</span><br>
<span class="lineno"></span><span class="op" id="4056096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4056099">func</span>&nbsp;<span class="op" id="4056104">(</span><span class="ident" id="4056105">mu</span>&nbsp;<span class="op" id="4056108">*</span><span class="ident" id="4056109">fdMutex</span><span class="op" id="4056116">)</span>&nbsp;<span class="ident" id="4056118">RWUnlock</span><span class="op" id="4056126">(</span><span class="ident" id="4056127">read</span>&nbsp;<span class="builtintype" id="4056132">bool</span><span class="op" id="4056136">)</span>&nbsp;<span class="builtintype" id="4056138">bool</span>&nbsp;<span class="op" id="4056143">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056146">var</span>&nbsp;<span class="ident" id="4056150">mutexBit</span><span class="op" id="4056158">,</span>&nbsp;<span class="ident" id="4056160">mutexWait</span><span class="op" id="4056169">,</span>&nbsp;<span class="ident" id="4056171">mutexMask</span>&nbsp;<span class="ident" id="4056181">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056189">var</span>&nbsp;<span class="ident" id="4056193">mutexSema</span>&nbsp;<span class="op" id="4056203">*</span><span class="builtintype" id="4056204">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056212">if</span>&nbsp;<span class="ident" id="4056215">read</span>&nbsp;<span class="op" id="4056220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056224">mutexBit</span>&nbsp;<span class="op" id="4056233">=</span>&nbsp;<span class="ident" id="4056235">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056248">mutexWait</span>&nbsp;<span class="op" id="4056258">=</span>&nbsp;<span class="ident" id="4056260">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056273">mutexMask</span>&nbsp;<span class="op" id="4056283">=</span>&nbsp;<span class="ident" id="4056285">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056298">mutexSema</span>&nbsp;<span class="op" id="4056308">=</span>&nbsp;<span class="op" id="4056310">&amp;</span><span class="ident" id="4056311">mu</span><span class="op" id="4056313">.</span><span class="ident" id="4056314">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056321">}</span>&nbsp;<span class="keyword" id="4056323">else</span>&nbsp;<span class="op" id="4056328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056332">mutexBit</span>&nbsp;<span class="op" id="4056341">=</span>&nbsp;<span class="ident" id="4056343">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056356">mutexWait</span>&nbsp;<span class="op" id="4056366">=</span>&nbsp;<span class="ident" id="4056368">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056381">mutexMask</span>&nbsp;<span class="op" id="4056391">=</span>&nbsp;<span class="ident" id="4056393">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056406">mutexSema</span>&nbsp;<span class="op" id="4056416">=</span>&nbsp;<span class="op" id="4056418">&amp;</span><span class="ident" id="4056419">mu</span><span class="op" id="4056421">.</span><span class="ident" id="4056422">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056432">for</span>&nbsp;<span class="op" id="4056436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056440">old</span>&nbsp;<span class="op" id="4056444">:=</span>&nbsp;<span class="ident" id="4056447">atomic</span><span class="op" id="4056453">.</span><span class="ident" id="4056454">LoadUint64</span><span class="op" id="4056464">(</span><span class="op" id="4056465">&amp;</span><span class="ident" id="4056466">mu</span><span class="op" id="4056468">.</span><span class="ident" id="4056469">state</span><span class="op" id="4056474">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056478">if</span>&nbsp;<span class="ident" id="4056481">old</span><span class="op" id="4056484">&amp;</span><span class="ident" id="4056485">mutexBit</span>&nbsp;<span class="op" id="4056494">==</span>&nbsp;<span class="num" id="4056497">0</span>&nbsp;<span class="op" id="4056499">||</span>&nbsp;<span class="ident" id="4056502">old</span><span class="op" id="4056505">&amp;</span><span class="ident" id="4056506">mutexRefMask</span>&nbsp;<span class="op" id="4056519">==</span>&nbsp;<span class="num" id="4056522">0</span>&nbsp;<span class="op" id="4056524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4056529">panic</span><span class="op" id="4056534">(</span><span class="string" id="4056535">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="4056562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4056570">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4056634">new</span>&nbsp;<span class="op" id="4056638">:=</span>&nbsp;<span class="op" id="4056641">(</span><span class="ident" id="4056642">old</span>&nbsp;<span class="op" id="4056646">&amp;^</span>&nbsp;<span class="ident" id="4056649">mutexBit</span><span class="op" id="4056657">)</span>&nbsp;<span class="op" id="4056659">-</span>&nbsp;<span class="ident" id="4056661">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056672">if</span>&nbsp;<span class="ident" id="4056675">old</span><span class="op" id="4056678">&amp;</span><span class="ident" id="4056679">mutexMask</span>&nbsp;<span class="op" id="4056689">!=</span>&nbsp;<span class="num" id="4056692">0</span>&nbsp;<span class="op" id="4056694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4056699">new</span>&nbsp;<span class="op" id="4056703">-=</span>&nbsp;<span class="ident" id="4056706">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056722">if</span>&nbsp;<span class="ident" id="4056725">atomic</span><span class="op" id="4056731">.</span><span class="ident" id="4056732">CompareAndSwapUint64</span><span class="op" id="4056752">(</span><span class="op" id="4056753">&amp;</span><span class="ident" id="4056754">mu</span><span class="op" id="4056756">.</span><span class="ident" id="4056757">state</span><span class="op" id="4056762">,</span>&nbsp;<span class="ident" id="4056764">old</span><span class="op" id="4056767">,</span>&nbsp;<span class="builtinfunc" id="4056769">new</span><span class="op" id="4056772">)</span>&nbsp;<span class="op" id="4056774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056779">if</span>&nbsp;<span class="ident" id="4056782">old</span><span class="op" id="4056785">&amp;</span><span class="ident" id="4056786">mutexMask</span>&nbsp;<span class="op" id="4056796">!=</span>&nbsp;<span class="num" id="4056799">0</span>&nbsp;<span class="op" id="4056801">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4056807">runtime_Semrelease</span><span class="op" id="4056825">(</span><span class="ident" id="4056826">mutexSema</span><span class="op" id="4056835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4056845">return</span>&nbsp;<span class="builtinfunc" id="4056852">new</span><span class="op" id="4056855">&amp;</span><span class="op" id="4056856">(</span><span class="ident" id="4056857">mutexClosed</span><span class="op" id="4056868">|</span><span class="ident" id="4056869">mutexRefMask</span><span class="op" id="4056881">)</span>&nbsp;<span class="op" id="4056883">==</span>&nbsp;<span class="ident" id="4056886">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4056903">}</span><br>
<span class="lineno">180</span><span class="op" id="4056905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4056908">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="4056943">func</span>&nbsp;<span class="ident" id="4056948">runtime_Semacquire</span><span class="op" id="4056966">(</span><span class="ident" id="4056967">sema</span>&nbsp;<span class="op" id="4056972">*</span><span class="builtintype" id="4056973">uint32</span><span class="op" id="4056979">)</span><br>
<span class="lineno"></span><span class="keyword" id="4056981">func</span>&nbsp;<span class="ident" id="4056986">runtime_Semrelease</span><span class="op" id="4057004">(</span><span class="ident" id="4057005">sema</span>&nbsp;<span class="op" id="4057010">*</span><span class="builtintype" id="4057011">uint32</span><span class="op" id="4057017">)</span>
</div>
</body>
</html>
