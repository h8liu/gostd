<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1444053">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1444108">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1444162">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1444213">package</span>&nbsp;<span class="ident" id="1444221">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1444227">import</span>&nbsp;<span class="op" id="1444234">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1444237">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1444248">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1444263">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1444272">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1444275">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1444350">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1444364">//</span><br>
<span class="lineno"></span><span class="comment" id="1444367">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1444447">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1444524">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1444554">//</span><br>
<span class="lineno">20</span><span class="comment" id="1444557">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1444622">//</span><br>
<span class="lineno"></span><span class="comment" id="1444625">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1444699">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1444776">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1444856">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1444871">//</span><br>
<span class="lineno"></span><span class="comment" id="1444874">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1444946">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1445020">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1445097">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1445121">//</span><br>
<span class="lineno"></span><span class="comment" id="1445124">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1445201">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1445280">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1445350">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1445364">//</span><br>
<span class="lineno"></span><span class="comment" id="1445367">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1445447">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1445526">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1445606">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1445620">//</span><br>
<span class="lineno"></span><span class="keyword" id="1445623">type</span>&nbsp;<span class="ident" id="1445628">Pool</span>&nbsp;<span class="keyword" id="1445633">struct</span>&nbsp;<span class="op" id="1445640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445643">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1445653">unsafe</span><span class="op" id="1445659">.</span><span class="ident" id="1445660">Pointer</span>&nbsp;<span class="comment" id="1445668">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445729">localSize</span>&nbsp;<span class="builtintype" id="1445739">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1445754">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445783">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445835">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445884">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445942">New</span>&nbsp;<span class="keyword" id="1445946">func</span><span class="op" id="1445950">(</span><span class="op" id="1445951">)</span>&nbsp;<span class="keyword" id="1445953">interface</span><span class="op" id="1445962">{</span><span class="op" id="1445963">}</span><br>
<span class="lineno">50</span><span class="op" id="1445965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1445968">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1445998">type</span>&nbsp;<span class="ident" id="1446003">poolLocal</span>&nbsp;<span class="keyword" id="1446013">struct</span>&nbsp;<span class="op" id="1446020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446023">private</span>&nbsp;<span class="keyword" id="1446031">interface</span><span class="op" id="1446040">{</span><span class="op" id="1446041">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1446045">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446087">shared</span>&nbsp;&nbsp;<span class="op" id="1446095">[</span><span class="op" id="1446096">]</span><span class="keyword" id="1446097">interface</span><span class="op" id="1446106">{</span><span class="op" id="1446107">}</span>&nbsp;<span class="comment" id="1446109">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446135">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446157">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446178">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1446186">[</span><span class="num" id="1446187">128</span><span class="op" id="1446190">]</span><span class="builtintype" id="1446191">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1446200">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1446227">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1446230">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1446257">func</span>&nbsp;<span class="op" id="1446262">(</span><span class="ident" id="1446263">p</span>&nbsp;<span class="op" id="1446265">*</span><span class="ident" id="1446266">Pool</span><span class="op" id="1446270">)</span>&nbsp;<span class="ident" id="1446272">Put</span><span class="op" id="1446275">(</span><span class="ident" id="1446276">x</span>&nbsp;<span class="keyword" id="1446278">interface</span><span class="op" id="1446287">{</span><span class="op" id="1446288">}</span><span class="op" id="1446289">)</span>&nbsp;<span class="op" id="1446291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446294">if</span>&nbsp;<span class="ident" id="1446297">raceenabled</span>&nbsp;<span class="op" id="1446309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446313">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446371">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446433">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446489">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446500">if</span>&nbsp;<span class="ident" id="1446503">x</span>&nbsp;<span class="op" id="1446505">==</span>&nbsp;<span class="ident" id="1446508">nil</span>&nbsp;<span class="op" id="1446512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446516">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446527">l</span>&nbsp;<span class="op" id="1446529">:=</span>&nbsp;<span class="ident" id="1446532">p</span><span class="op" id="1446533">.</span><span class="ident" id="1446534">pin</span><span class="op" id="1446537">(</span><span class="op" id="1446538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446541">if</span>&nbsp;<span class="ident" id="1446544">l</span><span class="op" id="1446545">.</span><span class="ident" id="1446546">private</span>&nbsp;<span class="op" id="1446554">==</span>&nbsp;<span class="ident" id="1446557">nil</span>&nbsp;<span class="op" id="1446561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446565">l</span><span class="op" id="1446566">.</span><span class="ident" id="1446567">private</span>&nbsp;<span class="op" id="1446575">=</span>&nbsp;<span class="ident" id="1446577">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446581">x</span>&nbsp;<span class="op" id="1446583">=</span>&nbsp;<span class="ident" id="1446585">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446593">runtime_procUnpin</span><span class="op" id="1446610">(</span><span class="op" id="1446611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446614">if</span>&nbsp;<span class="ident" id="1446617">x</span>&nbsp;<span class="op" id="1446619">==</span>&nbsp;<span class="ident" id="1446622">nil</span>&nbsp;<span class="op" id="1446626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446630">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446638">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446641">l</span><span class="op" id="1446642">.</span><span class="ident" id="1446643">Lock</span><span class="op" id="1446647">(</span><span class="op" id="1446648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446651">l</span><span class="op" id="1446652">.</span><span class="ident" id="1446653">shared</span>&nbsp;<span class="op" id="1446660">=</span>&nbsp;<span class="builtinfunc" id="1446662">append</span><span class="op" id="1446668">(</span><span class="ident" id="1446669">l</span><span class="op" id="1446670">.</span><span class="ident" id="1446671">shared</span><span class="op" id="1446677">,</span>&nbsp;<span class="ident" id="1446679">x</span><span class="op" id="1446680">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446683">l</span><span class="op" id="1446684">.</span><span class="ident" id="1446685">Unlock</span><span class="op" id="1446691">(</span><span class="op" id="1446692">)</span><br>
<span class="lineno"></span><span class="op" id="1446694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1446697">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1446765">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1446804">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1446864">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1446939">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1446970">//</span><br>
<span class="lineno"></span><span class="comment" id="1446973">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1447044">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1447076">func</span>&nbsp;<span class="op" id="1447081">(</span><span class="ident" id="1447082">p</span>&nbsp;<span class="op" id="1447084">*</span><span class="ident" id="1447085">Pool</span><span class="op" id="1447089">)</span>&nbsp;<span class="ident" id="1447091">Get</span><span class="op" id="1447094">(</span><span class="op" id="1447095">)</span>&nbsp;<span class="keyword" id="1447097">interface</span><span class="op" id="1447106">{</span><span class="op" id="1447107">}</span>&nbsp;<span class="op" id="1447109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447112">if</span>&nbsp;<span class="ident" id="1447115">raceenabled</span>&nbsp;<span class="op" id="1447127">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447131">if</span>&nbsp;<span class="ident" id="1447134">p</span><span class="op" id="1447135">.</span><span class="ident" id="1447136">New</span>&nbsp;<span class="op" id="1447140">!=</span>&nbsp;<span class="ident" id="1447143">nil</span>&nbsp;<span class="op" id="1447147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447152">return</span>&nbsp;<span class="ident" id="1447159">p</span><span class="op" id="1447160">.</span><span class="ident" id="1447161">New</span><span class="op" id="1447164">(</span><span class="op" id="1447165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447173">return</span>&nbsp;<span class="ident" id="1447180">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447185">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447188">l</span>&nbsp;<span class="op" id="1447190">:=</span>&nbsp;<span class="ident" id="1447193">p</span><span class="op" id="1447194">.</span><span class="ident" id="1447195">pin</span><span class="op" id="1447198">(</span><span class="op" id="1447199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447202">x</span>&nbsp;<span class="op" id="1447204">:=</span>&nbsp;<span class="ident" id="1447207">l</span><span class="op" id="1447208">.</span><span class="ident" id="1447209">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447218">l</span><span class="op" id="1447219">.</span><span class="ident" id="1447220">private</span>&nbsp;<span class="op" id="1447228">=</span>&nbsp;<span class="ident" id="1447230">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447235">runtime_procUnpin</span><span class="op" id="1447252">(</span><span class="op" id="1447253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447256">if</span>&nbsp;<span class="ident" id="1447259">x</span>&nbsp;<span class="op" id="1447261">!=</span>&nbsp;<span class="ident" id="1447264">nil</span>&nbsp;<span class="op" id="1447268">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447272">return</span>&nbsp;<span class="ident" id="1447279">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447285">l</span><span class="op" id="1447286">.</span><span class="ident" id="1447287">Lock</span><span class="op" id="1447291">(</span><span class="op" id="1447292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447295">last</span>&nbsp;<span class="op" id="1447300">:=</span>&nbsp;<span class="builtinfunc" id="1447303">len</span><span class="op" id="1447306">(</span><span class="ident" id="1447307">l</span><span class="op" id="1447308">.</span><span class="ident" id="1447309">shared</span><span class="op" id="1447315">)</span>&nbsp;<span class="op" id="1447317">-</span>&nbsp;<span class="num" id="1447319">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447322">if</span>&nbsp;<span class="ident" id="1447325">last</span>&nbsp;<span class="op" id="1447330">&gt;=</span>&nbsp;<span class="num" id="1447333">0</span>&nbsp;<span class="op" id="1447335">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447339">x</span>&nbsp;<span class="op" id="1447341">=</span>&nbsp;<span class="ident" id="1447343">l</span><span class="op" id="1447344">.</span><span class="ident" id="1447345">shared</span><span class="op" id="1447351">[</span><span class="ident" id="1447352">last</span><span class="op" id="1447356">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447360">l</span><span class="op" id="1447361">.</span><span class="ident" id="1447362">shared</span>&nbsp;<span class="op" id="1447369">=</span>&nbsp;<span class="ident" id="1447371">l</span><span class="op" id="1447372">.</span><span class="ident" id="1447373">shared</span><span class="op" id="1447379">[</span><span class="op" id="1447380">:</span><span class="ident" id="1447381">last</span><span class="op" id="1447385">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447391">l</span><span class="op" id="1447392">.</span><span class="ident" id="1447393">Unlock</span><span class="op" id="1447399">(</span><span class="op" id="1447400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447403">if</span>&nbsp;<span class="ident" id="1447406">x</span>&nbsp;<span class="op" id="1447408">!=</span>&nbsp;<span class="ident" id="1447411">nil</span>&nbsp;<span class="op" id="1447415">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447419">return</span>&nbsp;<span class="ident" id="1447426">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447432">return</span>&nbsp;<span class="ident" id="1447439">p</span><span class="op" id="1447440">.</span><span class="ident" id="1447441">getSlow</span><span class="op" id="1447448">(</span><span class="op" id="1447449">)</span><br>
<span class="lineno"></span><span class="op" id="1447451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1447454">func</span>&nbsp;<span class="op" id="1447459">(</span><span class="ident" id="1447460">p</span>&nbsp;<span class="op" id="1447462">*</span><span class="ident" id="1447463">Pool</span><span class="op" id="1447467">)</span>&nbsp;<span class="ident" id="1447469">getSlow</span><span class="op" id="1447476">(</span><span class="op" id="1447477">)</span>&nbsp;<span class="op" id="1447479">(</span><span class="ident" id="1447480">x</span>&nbsp;<span class="keyword" id="1447482">interface</span><span class="op" id="1447491">{</span><span class="op" id="1447492">}</span><span class="op" id="1447493">)</span>&nbsp;<span class="op" id="1447495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447498">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447558">size</span>&nbsp;<span class="op" id="1447563">:=</span>&nbsp;<span class="ident" id="1447566">atomic</span><span class="op" id="1447572">.</span><span class="ident" id="1447573">LoadUintptr</span><span class="op" id="1447584">(</span><span class="op" id="1447585">&amp;</span><span class="ident" id="1447586">p</span><span class="op" id="1447587">.</span><span class="ident" id="1447588">localSize</span><span class="op" id="1447597">)</span>&nbsp;<span class="comment" id="1447599">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447616">local</span>&nbsp;<span class="op" id="1447622">:=</span>&nbsp;<span class="ident" id="1447625">p</span><span class="op" id="1447626">.</span><span class="ident" id="1447627">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1447657">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1447674">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447721">pid</span>&nbsp;<span class="op" id="1447725">:=</span>&nbsp;<span class="ident" id="1447728">runtime_procPin</span><span class="op" id="1447743">(</span><span class="op" id="1447744">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447747">runtime_procUnpin</span><span class="op" id="1447764">(</span><span class="op" id="1447765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447768">for</span>&nbsp;<span class="ident" id="1447772">i</span>&nbsp;<span class="op" id="1447774">:=</span>&nbsp;<span class="num" id="1447777">0</span><span class="op" id="1447778">;</span>&nbsp;<span class="ident" id="1447780">i</span>&nbsp;<span class="op" id="1447782">&lt;</span>&nbsp;<span class="builtintype" id="1447784">int</span><span class="op" id="1447787">(</span><span class="ident" id="1447788">size</span><span class="op" id="1447792">)</span><span class="op" id="1447793">;</span>&nbsp;<span class="ident" id="1447795">i</span><span class="op" id="1447796">++</span>&nbsp;<span class="op" id="1447799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447803">l</span>&nbsp;<span class="op" id="1447805">:=</span>&nbsp;<span class="ident" id="1447808">indexLocal</span><span class="op" id="1447818">(</span><span class="ident" id="1447819">local</span><span class="op" id="1447824">,</span>&nbsp;<span class="op" id="1447826">(</span><span class="ident" id="1447827">pid</span><span class="op" id="1447830">+</span><span class="ident" id="1447831">i</span><span class="op" id="1447832">+</span><span class="num" id="1447833">1</span><span class="op" id="1447834">)</span><span class="op" id="1447835">%</span><span class="builtintype" id="1447836">int</span><span class="op" id="1447839">(</span><span class="ident" id="1447840">size</span><span class="op" id="1447844">)</span><span class="op" id="1447845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447849">l</span><span class="op" id="1447850">.</span><span class="ident" id="1447851">Lock</span><span class="op" id="1447855">(</span><span class="op" id="1447856">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447860">last</span>&nbsp;<span class="op" id="1447865">:=</span>&nbsp;<span class="builtinfunc" id="1447868">len</span><span class="op" id="1447871">(</span><span class="ident" id="1447872">l</span><span class="op" id="1447873">.</span><span class="ident" id="1447874">shared</span><span class="op" id="1447880">)</span>&nbsp;<span class="op" id="1447882">-</span>&nbsp;<span class="num" id="1447884">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447888">if</span>&nbsp;<span class="ident" id="1447891">last</span>&nbsp;<span class="op" id="1447896">&gt;=</span>&nbsp;<span class="num" id="1447899">0</span>&nbsp;<span class="op" id="1447901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447906">x</span>&nbsp;<span class="op" id="1447908">=</span>&nbsp;<span class="ident" id="1447910">l</span><span class="op" id="1447911">.</span><span class="ident" id="1447912">shared</span><span class="op" id="1447918">[</span><span class="ident" id="1447919">last</span><span class="op" id="1447923">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447928">l</span><span class="op" id="1447929">.</span><span class="ident" id="1447930">shared</span>&nbsp;<span class="op" id="1447937">=</span>&nbsp;<span class="ident" id="1447939">l</span><span class="op" id="1447940">.</span><span class="ident" id="1447941">shared</span><span class="op" id="1447947">[</span><span class="op" id="1447948">:</span><span class="ident" id="1447949">last</span><span class="op" id="1447953">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447958">l</span><span class="op" id="1447959">.</span><span class="ident" id="1447960">Unlock</span><span class="op" id="1447966">(</span><span class="op" id="1447967">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1447972">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1447984">l</span><span class="op" id="1447985">.</span><span class="ident" id="1447986">Unlock</span><span class="op" id="1447992">(</span><span class="op" id="1447993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1447996">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448000">if</span>&nbsp;<span class="ident" id="1448003">x</span>&nbsp;<span class="op" id="1448005">==</span>&nbsp;<span class="ident" id="1448008">nil</span>&nbsp;<span class="op" id="1448012">&amp;&amp;</span>&nbsp;<span class="ident" id="1448015">p</span><span class="op" id="1448016">.</span><span class="ident" id="1448017">New</span>&nbsp;<span class="op" id="1448021">!=</span>&nbsp;<span class="ident" id="1448024">nil</span>&nbsp;<span class="op" id="1448028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448032">x</span>&nbsp;<span class="op" id="1448034">=</span>&nbsp;<span class="ident" id="1448036">p</span><span class="op" id="1448037">.</span><span class="ident" id="1448038">New</span><span class="op" id="1448041">(</span><span class="op" id="1448042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448048">return</span>&nbsp;<span class="ident" id="1448055">x</span><br>
<span class="lineno"></span><span class="op" id="1448057">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1448060">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1448158">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1448223">func</span>&nbsp;<span class="op" id="1448228">(</span><span class="ident" id="1448229">p</span>&nbsp;<span class="op" id="1448231">*</span><span class="ident" id="1448232">Pool</span><span class="op" id="1448236">)</span>&nbsp;<span class="ident" id="1448238">pin</span><span class="op" id="1448241">(</span><span class="op" id="1448242">)</span>&nbsp;<span class="op" id="1448244">*</span><span class="ident" id="1448245">poolLocal</span>&nbsp;<span class="op" id="1448255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448258">pid</span>&nbsp;<span class="op" id="1448262">:=</span>&nbsp;<span class="ident" id="1448265">runtime_procPin</span><span class="op" id="1448280">(</span><span class="op" id="1448281">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448284">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448372">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448439">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448504">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448601">s</span>&nbsp;<span class="op" id="1448603">:=</span>&nbsp;<span class="ident" id="1448606">atomic</span><span class="op" id="1448612">.</span><span class="ident" id="1448613">LoadUintptr</span><span class="op" id="1448624">(</span><span class="op" id="1448625">&amp;</span><span class="ident" id="1448626">p</span><span class="op" id="1448627">.</span><span class="ident" id="1448628">localSize</span><span class="op" id="1448637">)</span>&nbsp;<span class="comment" id="1448639">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448656">l</span>&nbsp;<span class="op" id="1448658">:=</span>&nbsp;<span class="ident" id="1448661">p</span><span class="op" id="1448662">.</span><span class="ident" id="1448663">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1448694">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448711">if</span>&nbsp;<span class="builtintype" id="1448714">uintptr</span><span class="op" id="1448721">(</span><span class="ident" id="1448722">pid</span><span class="op" id="1448725">)</span>&nbsp;<span class="op" id="1448727">&lt;</span>&nbsp;<span class="ident" id="1448729">s</span>&nbsp;<span class="op" id="1448731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448735">return</span>&nbsp;<span class="ident" id="1448742">indexLocal</span><span class="op" id="1448752">(</span><span class="ident" id="1448753">l</span><span class="op" id="1448754">,</span>&nbsp;<span class="ident" id="1448756">pid</span><span class="op" id="1448759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1448762">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448765">return</span>&nbsp;<span class="ident" id="1448772">p</span><span class="op" id="1448773">.</span><span class="ident" id="1448774">pinSlow</span><span class="op" id="1448781">(</span><span class="op" id="1448782">)</span><br>
<span class="lineno">160</span><span class="op" id="1448784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1448787">func</span>&nbsp;<span class="op" id="1448792">(</span><span class="ident" id="1448793">p</span>&nbsp;<span class="op" id="1448795">*</span><span class="ident" id="1448796">Pool</span><span class="op" id="1448800">)</span>&nbsp;<span class="ident" id="1448802">pinSlow</span><span class="op" id="1448809">(</span><span class="op" id="1448810">)</span>&nbsp;<span class="op" id="1448812">*</span><span class="ident" id="1448813">poolLocal</span>&nbsp;<span class="op" id="1448823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448826">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448853">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448894">runtime_procUnpin</span><span class="op" id="1448911">(</span><span class="op" id="1448912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448915">allPoolsMu</span><span class="op" id="1448925">.</span><span class="ident" id="1448926">Lock</span><span class="op" id="1448930">(</span><span class="op" id="1448931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1448934">defer</span>&nbsp;<span class="ident" id="1448940">allPoolsMu</span><span class="op" id="1448950">.</span><span class="ident" id="1448951">Unlock</span><span class="op" id="1448957">(</span><span class="op" id="1448958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1448961">pid</span>&nbsp;<span class="op" id="1448965">:=</span>&nbsp;<span class="ident" id="1448968">runtime_procPin</span><span class="op" id="1448983">(</span><span class="op" id="1448984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1448987">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449040">s</span>&nbsp;<span class="op" id="1449042">:=</span>&nbsp;<span class="ident" id="1449045">p</span><span class="op" id="1449046">.</span><span class="ident" id="1449047">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449058">l</span>&nbsp;<span class="op" id="1449060">:=</span>&nbsp;<span class="ident" id="1449063">p</span><span class="op" id="1449064">.</span><span class="ident" id="1449065">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449072">if</span>&nbsp;<span class="builtintype" id="1449075">uintptr</span><span class="op" id="1449082">(</span><span class="ident" id="1449083">pid</span><span class="op" id="1449086">)</span>&nbsp;<span class="op" id="1449088">&lt;</span>&nbsp;<span class="ident" id="1449090">s</span>&nbsp;<span class="op" id="1449092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449096">return</span>&nbsp;<span class="ident" id="1449103">indexLocal</span><span class="op" id="1449113">(</span><span class="ident" id="1449114">l</span><span class="op" id="1449115">,</span>&nbsp;<span class="ident" id="1449117">pid</span><span class="op" id="1449120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449123">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449126">if</span>&nbsp;<span class="ident" id="1449129">p</span><span class="op" id="1449130">.</span><span class="ident" id="1449131">local</span>&nbsp;<span class="op" id="1449137">==</span>&nbsp;<span class="ident" id="1449140">nil</span>&nbsp;<span class="op" id="1449144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449148">allPools</span>&nbsp;<span class="op" id="1449157">=</span>&nbsp;<span class="builtinfunc" id="1449159">append</span><span class="op" id="1449165">(</span><span class="ident" id="1449166">allPools</span><span class="op" id="1449174">,</span>&nbsp;<span class="ident" id="1449176">p</span><span class="op" id="1449177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1449180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449183">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449269">size</span>&nbsp;<span class="op" id="1449274">:=</span>&nbsp;<span class="ident" id="1449277">runtime</span><span class="op" id="1449284">.</span><span class="ident" id="1449285">GOMAXPROCS</span><span class="op" id="1449295">(</span><span class="num" id="1449296">0</span><span class="op" id="1449297">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449300">local</span>&nbsp;<span class="op" id="1449306">:=</span>&nbsp;<span class="builtinfunc" id="1449309">make</span><span class="op" id="1449313">(</span><span class="op" id="1449314">[</span><span class="op" id="1449315">]</span><span class="ident" id="1449316">poolLocal</span><span class="op" id="1449325">,</span>&nbsp;<span class="ident" id="1449327">size</span><span class="op" id="1449331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449334">atomic</span><span class="op" id="1449340">.</span><span class="ident" id="1449341">StorePointer</span><span class="op" id="1449353">(</span><span class="op" id="1449354">(</span><span class="op" id="1449355">*</span><span class="ident" id="1449356">unsafe</span><span class="op" id="1449362">.</span><span class="ident" id="1449363">Pointer</span><span class="op" id="1449370">)</span><span class="op" id="1449371">(</span><span class="op" id="1449372">&amp;</span><span class="ident" id="1449373">p</span><span class="op" id="1449374">.</span><span class="ident" id="1449375">local</span><span class="op" id="1449380">)</span><span class="op" id="1449381">,</span>&nbsp;<span class="ident" id="1449383">unsafe</span><span class="op" id="1449389">.</span><span class="ident" id="1449390">Pointer</span><span class="op" id="1449397">(</span><span class="op" id="1449398">&amp;</span><span class="ident" id="1449399">local</span><span class="op" id="1449404">[</span><span class="num" id="1449405">0</span><span class="op" id="1449406">]</span><span class="op" id="1449407">)</span><span class="op" id="1449408">)</span>&nbsp;<span class="comment" id="1449410">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1449428">atomic</span><span class="op" id="1449434">.</span><span class="ident" id="1449435">StoreUintptr</span><span class="op" id="1449447">(</span><span class="op" id="1449448">&amp;</span><span class="ident" id="1449449">p</span><span class="op" id="1449450">.</span><span class="ident" id="1449451">localSize</span><span class="op" id="1449460">,</span>&nbsp;<span class="builtintype" id="1449462">uintptr</span><span class="op" id="1449469">(</span><span class="ident" id="1449470">size</span><span class="op" id="1449474">)</span><span class="op" id="1449475">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1449504">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449522">return</span>&nbsp;<span class="op" id="1449529">&amp;</span><span class="ident" id="1449530">local</span><span class="op" id="1449535">[</span><span class="ident" id="1449536">pid</span><span class="op" id="1449539">]</span><br>
<span class="lineno"></span><span class="op" id="1449541">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1449544">func</span>&nbsp;<span class="ident" id="1449549">poolCleanup</span><span class="op" id="1449560">(</span><span class="op" id="1449561">)</span>&nbsp;<span class="op" id="1449563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449566">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449660">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449737">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449785">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449835">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1449906">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1449991">for</span>&nbsp;<span class="ident" id="1449995">i</span><span class="op" id="1449996">,</span>&nbsp;<span class="ident" id="1449998">p</span>&nbsp;<span class="op" id="1450000">:=</span>&nbsp;<span class="keyword" id="1450003">range</span>&nbsp;<span class="ident" id="1450009">allPools</span>&nbsp;<span class="op" id="1450018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450022">allPools</span><span class="op" id="1450030">[</span><span class="ident" id="1450031">i</span><span class="op" id="1450032">]</span>&nbsp;<span class="op" id="1450034">=</span>&nbsp;<span class="ident" id="1450036">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450042">for</span>&nbsp;<span class="ident" id="1450046">i</span>&nbsp;<span class="op" id="1450048">:=</span>&nbsp;<span class="num" id="1450051">0</span><span class="op" id="1450052">;</span>&nbsp;<span class="ident" id="1450054">i</span>&nbsp;<span class="op" id="1450056">&lt;</span>&nbsp;<span class="builtintype" id="1450058">int</span><span class="op" id="1450061">(</span><span class="ident" id="1450062">p</span><span class="op" id="1450063">.</span><span class="ident" id="1450064">localSize</span><span class="op" id="1450073">)</span><span class="op" id="1450074">;</span>&nbsp;<span class="ident" id="1450076">i</span><span class="op" id="1450077">++</span>&nbsp;<span class="op" id="1450080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450085">l</span>&nbsp;<span class="op" id="1450087">:=</span>&nbsp;<span class="ident" id="1450090">indexLocal</span><span class="op" id="1450100">(</span><span class="ident" id="1450101">p</span><span class="op" id="1450102">.</span><span class="ident" id="1450103">local</span><span class="op" id="1450108">,</span>&nbsp;<span class="ident" id="1450110">i</span><span class="op" id="1450111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450116">l</span><span class="op" id="1450117">.</span><span class="ident" id="1450118">private</span>&nbsp;<span class="op" id="1450126">=</span>&nbsp;<span class="ident" id="1450128">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450135">for</span>&nbsp;<span class="ident" id="1450139">j</span>&nbsp;<span class="op" id="1450141">:=</span>&nbsp;<span class="keyword" id="1450144">range</span>&nbsp;<span class="ident" id="1450150">l</span><span class="op" id="1450151">.</span><span class="ident" id="1450152">shared</span>&nbsp;<span class="op" id="1450159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450165">l</span><span class="op" id="1450166">.</span><span class="ident" id="1450167">shared</span><span class="op" id="1450173">[</span><span class="ident" id="1450174">j</span><span class="op" id="1450175">]</span>&nbsp;<span class="op" id="1450177">=</span>&nbsp;<span class="ident" id="1450179">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450186">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450191">l</span><span class="op" id="1450192">.</span><span class="ident" id="1450193">shared</span>&nbsp;<span class="op" id="1450200">=</span>&nbsp;<span class="ident" id="1450202">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450212">p</span><span class="op" id="1450213">.</span><span class="ident" id="1450214">local</span>&nbsp;<span class="op" id="1450220">=</span>&nbsp;<span class="ident" id="1450222">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450228">p</span><span class="op" id="1450229">.</span><span class="ident" id="1450230">localSize</span>&nbsp;<span class="op" id="1450240">=</span>&nbsp;<span class="num" id="1450242">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1450245">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450248">allPools</span>&nbsp;<span class="op" id="1450257">=</span>&nbsp;<span class="op" id="1450259">[</span><span class="op" id="1450260">]</span><span class="op" id="1450261">*</span><span class="ident" id="1450262">Pool</span><span class="op" id="1450266">{</span><span class="op" id="1450267">}</span><br>
<span class="lineno"></span><span class="op" id="1450269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1450272">var</span>&nbsp;<span class="op" id="1450276">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450279">allPoolsMu</span>&nbsp;<span class="ident" id="1450290">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450297">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1450308">[</span><span class="op" id="1450309">]</span><span class="op" id="1450310">*</span><span class="ident" id="1450311">Pool</span><br>
<span class="lineno"></span><span class="op" id="1450316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1450319">func</span>&nbsp;<span class="ident" id="1450324">init</span><span class="op" id="1450328">(</span><span class="op" id="1450329">)</span>&nbsp;<span class="op" id="1450331">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1450334">runtime_registerPoolCleanup</span><span class="op" id="1450361">(</span><span class="ident" id="1450362">poolCleanup</span><span class="op" id="1450373">)</span><br>
<span class="lineno"></span><span class="op" id="1450375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1450378">func</span>&nbsp;<span class="ident" id="1450383">indexLocal</span><span class="op" id="1450393">(</span><span class="ident" id="1450394">l</span>&nbsp;<span class="ident" id="1450396">unsafe</span><span class="op" id="1450402">.</span><span class="ident" id="1450403">Pointer</span><span class="op" id="1450410">,</span>&nbsp;<span class="ident" id="1450412">i</span>&nbsp;<span class="builtintype" id="1450414">int</span><span class="op" id="1450417">)</span>&nbsp;<span class="op" id="1450419">*</span><span class="ident" id="1450420">poolLocal</span>&nbsp;<span class="op" id="1450430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1450433">return</span>&nbsp;<span class="op" id="1450440">&amp;</span><span class="op" id="1450441">(</span><span class="op" id="1450442">*</span><span class="op" id="1450443">[</span><span class="num" id="1450444">1000000</span><span class="op" id="1450451">]</span><span class="ident" id="1450452">poolLocal</span><span class="op" id="1450461">)</span><span class="op" id="1450462">(</span><span class="ident" id="1450463">l</span><span class="op" id="1450464">)</span><span class="op" id="1450465">[</span><span class="ident" id="1450466">i</span><span class="op" id="1450467">]</span><br>
<span class="lineno">220</span><span class="op" id="1450469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1450472">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1450499">func</span>&nbsp;<span class="ident" id="1450504">runtime_registerPoolCleanup</span><span class="op" id="1450531">(</span><span class="ident" id="1450532">cleanup</span>&nbsp;<span class="keyword" id="1450540">func</span><span class="op" id="1450544">(</span><span class="op" id="1450545">)</span><span class="op" id="1450546">)</span><br>
<span class="lineno"></span><span class="keyword" id="1450548">func</span>&nbsp;<span class="ident" id="1450553">runtime_procPin</span><span class="op" id="1450568">(</span><span class="op" id="1450569">)</span>&nbsp;<span class="builtintype" id="1450571">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1450575">func</span>&nbsp;<span class="ident" id="1450580">runtime_procUnpin</span><span class="op" id="1450597">(</span><span class="op" id="1450598">)</span>
</div>
</body>
</html>
