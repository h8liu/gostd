<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3450587">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3450643">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3450697">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3450748">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3450826">package</span>&nbsp;<span class="ident" id="3450834">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3450839">import</span>&nbsp;<span class="op" id="3450846">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3450849">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3450855">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3450861">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3450872">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3450879">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3450882">//&nbsp;BUG(rsc):&nbsp;On&nbsp;OpenBSD,&nbsp;listening&nbsp;on&nbsp;the&nbsp;&#34;tcp&#34;&nbsp;network&nbsp;does&nbsp;not&nbsp;listen&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3450958">//&nbsp;both&nbsp;IPv4&nbsp;and&nbsp;IPv6&nbsp;connections.&nbsp;This&nbsp;is&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;IPv4&nbsp;traffic</span><br>
<span class="lineno"></span><span class="comment" id="3451035">//&nbsp;will&nbsp;not&nbsp;be&nbsp;routed&nbsp;to&nbsp;an&nbsp;IPv6&nbsp;socket&nbsp;-&nbsp;two&nbsp;separate&nbsp;sockets&nbsp;are&nbsp;required</span><br>
<span class="lineno"></span><span class="comment" id="3451111">//&nbsp;if&nbsp;both&nbsp;AFs&nbsp;are&nbsp;to&nbsp;be&nbsp;supported.&nbsp;See&nbsp;inet6(4)&nbsp;on&nbsp;OpenBSD&nbsp;for&nbsp;details.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3451185">func</span>&nbsp;<span class="ident" id="3451190">sockaddrToTCP</span><span class="op" id="3451203">(</span><span class="ident" id="3451204">sa</span>&nbsp;<span class="ident" id="3451207">syscall</span><span class="op" id="3451214">.</span><span class="ident" id="3451215">Sockaddr</span><span class="op" id="3451223">)</span>&nbsp;<span class="ident" id="3451225">Addr</span>&nbsp;<span class="op" id="3451230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451233">switch</span>&nbsp;<span class="ident" id="3451240">sa</span>&nbsp;<span class="op" id="3451243">:=</span>&nbsp;<span class="ident" id="3451246">sa</span><span class="op" id="3451248">.</span><span class="op" id="3451249">(</span><span class="keyword" id="3451250">type</span><span class="op" id="3451254">)</span>&nbsp;<span class="op" id="3451256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451259">case</span>&nbsp;<span class="op" id="3451264">*</span><span class="ident" id="3451265">syscall</span><span class="op" id="3451272">.</span><span class="ident" id="3451273">SockaddrInet4</span><span class="op" id="3451286">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451290">return</span>&nbsp;<span class="op" id="3451297">&amp;</span><span class="ident" id="3451298">TCPAddr</span><span class="op" id="3451305">{</span><span class="ident" id="3451306">IP</span><span class="op" id="3451308">:</span>&nbsp;<span class="ident" id="3451310">sa</span><span class="op" id="3451312">.</span><span class="ident" id="3451313">Addr</span><span class="op" id="3451317">[</span><span class="num" id="3451318">0</span><span class="op" id="3451319">:</span><span class="op" id="3451320">]</span><span class="op" id="3451321">,</span>&nbsp;<span class="ident" id="3451323">Port</span><span class="op" id="3451327">:</span>&nbsp;<span class="ident" id="3451329">sa</span><span class="op" id="3451331">.</span><span class="ident" id="3451332">Port</span><span class="op" id="3451336">}</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451339">case</span>&nbsp;<span class="op" id="3451344">*</span><span class="ident" id="3451345">syscall</span><span class="op" id="3451352">.</span><span class="ident" id="3451353">SockaddrInet6</span><span class="op" id="3451366">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451370">return</span>&nbsp;<span class="op" id="3451377">&amp;</span><span class="ident" id="3451378">TCPAddr</span><span class="op" id="3451385">{</span><span class="ident" id="3451386">IP</span><span class="op" id="3451388">:</span>&nbsp;<span class="ident" id="3451390">sa</span><span class="op" id="3451392">.</span><span class="ident" id="3451393">Addr</span><span class="op" id="3451397">[</span><span class="num" id="3451398">0</span><span class="op" id="3451399">:</span><span class="op" id="3451400">]</span><span class="op" id="3451401">,</span>&nbsp;<span class="ident" id="3451403">Port</span><span class="op" id="3451407">:</span>&nbsp;<span class="ident" id="3451409">sa</span><span class="op" id="3451411">.</span><span class="ident" id="3451412">Port</span><span class="op" id="3451416">,</span>&nbsp;<span class="ident" id="3451418">Zone</span><span class="op" id="3451422">:</span>&nbsp;<span class="ident" id="3451424">zoneToString</span><span class="op" id="3451436">(</span><span class="builtintype" id="3451437">int</span><span class="op" id="3451440">(</span><span class="ident" id="3451441">sa</span><span class="op" id="3451443">.</span><span class="ident" id="3451444">ZoneId</span><span class="op" id="3451450">)</span><span class="op" id="3451451">)</span><span class="op" id="3451452">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451455">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451458">return</span>&nbsp;<span class="ident" id="3451465">nil</span><br>
<span class="lineno"></span><span class="op" id="3451469">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="3451472">func</span>&nbsp;<span class="op" id="3451477">(</span><span class="ident" id="3451478">a</span>&nbsp;<span class="op" id="3451480">*</span><span class="ident" id="3451481">TCPAddr</span><span class="op" id="3451488">)</span>&nbsp;<span class="ident" id="3451490">family</span><span class="op" id="3451496">(</span><span class="op" id="3451497">)</span>&nbsp;<span class="builtintype" id="3451499">int</span>&nbsp;<span class="op" id="3451503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451506">if</span>&nbsp;<span class="ident" id="3451509">a</span>&nbsp;<span class="op" id="3451511">==</span>&nbsp;<span class="ident" id="3451514">nil</span>&nbsp;<span class="op" id="3451518">||</span>&nbsp;<span class="builtinfunc" id="3451521">len</span><span class="op" id="3451524">(</span><span class="ident" id="3451525">a</span><span class="op" id="3451526">.</span><span class="ident" id="3451527">IP</span><span class="op" id="3451529">)</span>&nbsp;<span class="op" id="3451531">&lt;=</span>&nbsp;<span class="ident" id="3451534">IPv4len</span>&nbsp;<span class="op" id="3451542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451546">return</span>&nbsp;<span class="ident" id="3451553">syscall</span><span class="op" id="3451560">.</span><span class="ident" id="3451561">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451570">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451573">if</span>&nbsp;<span class="ident" id="3451576">a</span><span class="op" id="3451577">.</span><span class="ident" id="3451578">IP</span><span class="op" id="3451580">.</span><span class="ident" id="3451581">To4</span><span class="op" id="3451584">(</span><span class="op" id="3451585">)</span>&nbsp;<span class="op" id="3451587">!=</span>&nbsp;<span class="ident" id="3451590">nil</span>&nbsp;<span class="op" id="3451594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451598">return</span>&nbsp;<span class="ident" id="3451605">syscall</span><span class="op" id="3451612">.</span><span class="ident" id="3451613">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451625">return</span>&nbsp;<span class="ident" id="3451632">syscall</span><span class="op" id="3451639">.</span><span class="ident" id="3451640">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="3451649">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="3451652">func</span>&nbsp;<span class="op" id="3451657">(</span><span class="ident" id="3451658">a</span>&nbsp;<span class="op" id="3451660">*</span><span class="ident" id="3451661">TCPAddr</span><span class="op" id="3451668">)</span>&nbsp;<span class="ident" id="3451670">isWildcard</span><span class="op" id="3451680">(</span><span class="op" id="3451681">)</span>&nbsp;<span class="builtintype" id="3451683">bool</span>&nbsp;<span class="op" id="3451688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451691">if</span>&nbsp;<span class="ident" id="3451694">a</span>&nbsp;<span class="op" id="3451696">==</span>&nbsp;<span class="ident" id="3451699">nil</span>&nbsp;<span class="op" id="3451703">||</span>&nbsp;<span class="ident" id="3451706">a</span><span class="op" id="3451707">.</span><span class="ident" id="3451708">IP</span>&nbsp;<span class="op" id="3451711">==</span>&nbsp;<span class="ident" id="3451714">nil</span>&nbsp;<span class="op" id="3451718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451722">return</span>&nbsp;<span class="ident" id="3451729">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451735">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451738">return</span>&nbsp;<span class="ident" id="3451745">a</span><span class="op" id="3451746">.</span><span class="ident" id="3451747">IP</span><span class="op" id="3451749">.</span><span class="ident" id="3451750">IsUnspecified</span><span class="op" id="3451763">(</span><span class="op" id="3451764">)</span><br>
<span class="lineno"></span><span class="op" id="3451766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3451769">func</span>&nbsp;<span class="op" id="3451774">(</span><span class="ident" id="3451775">a</span>&nbsp;<span class="op" id="3451777">*</span><span class="ident" id="3451778">TCPAddr</span><span class="op" id="3451785">)</span>&nbsp;<span class="ident" id="3451787">sockaddr</span><span class="op" id="3451795">(</span><span class="ident" id="3451796">family</span>&nbsp;<span class="builtintype" id="3451803">int</span><span class="op" id="3451806">)</span>&nbsp;<span class="op" id="3451808">(</span><span class="ident" id="3451809">syscall</span><span class="op" id="3451816">.</span><span class="ident" id="3451817">Sockaddr</span><span class="op" id="3451825">,</span>&nbsp;<span class="builtintype" id="3451827">error</span><span class="op" id="3451832">)</span>&nbsp;<span class="op" id="3451834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451837">if</span>&nbsp;<span class="ident" id="3451840">a</span>&nbsp;<span class="op" id="3451842">==</span>&nbsp;<span class="ident" id="3451845">nil</span>&nbsp;<span class="op" id="3451849">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451853">return</span>&nbsp;<span class="ident" id="3451860">nil</span><span class="op" id="3451863">,</span>&nbsp;<span class="ident" id="3451865">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3451870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3451873">return</span>&nbsp;<span class="ident" id="3451880">ipToSockaddr</span><span class="op" id="3451892">(</span><span class="ident" id="3451893">family</span><span class="op" id="3451899">,</span>&nbsp;<span class="ident" id="3451901">a</span><span class="op" id="3451902">.</span><span class="ident" id="3451903">IP</span><span class="op" id="3451905">,</span>&nbsp;<span class="ident" id="3451907">a</span><span class="op" id="3451908">.</span><span class="ident" id="3451909">Port</span><span class="op" id="3451913">,</span>&nbsp;<span class="ident" id="3451915">a</span><span class="op" id="3451916">.</span><span class="ident" id="3451917">Zone</span><span class="op" id="3451921">)</span><br>
<span class="lineno"></span><span class="op" id="3451923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3451926">//&nbsp;TCPConn&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;interface&nbsp;for&nbsp;TCP&nbsp;network</span><br>
<span class="lineno"></span><span class="comment" id="3451996">//&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3452012">type</span>&nbsp;<span class="ident" id="3452017">TCPConn</span>&nbsp;<span class="keyword" id="3452025">struct</span>&nbsp;<span class="op" id="3452032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452035">conn</span><br>
<span class="lineno"></span><span class="op" id="3452040">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="3452043">func</span>&nbsp;<span class="ident" id="3452048">newTCPConn</span><span class="op" id="3452058">(</span><span class="ident" id="3452059">fd</span>&nbsp;<span class="op" id="3452062">*</span><span class="ident" id="3452063">netFD</span><span class="op" id="3452068">)</span>&nbsp;<span class="op" id="3452070">*</span><span class="ident" id="3452071">TCPConn</span>&nbsp;<span class="op" id="3452079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452082">c</span>&nbsp;<span class="op" id="3452084">:=</span>&nbsp;<span class="op" id="3452087">&amp;</span><span class="ident" id="3452088">TCPConn</span><span class="op" id="3452095">{</span><span class="ident" id="3452096">conn</span><span class="op" id="3452100">{</span><span class="ident" id="3452101">fd</span><span class="op" id="3452103">}</span><span class="op" id="3452104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3452107">c</span><span class="op" id="3452108">.</span><span class="ident" id="3452109">SetNoDelay</span><span class="op" id="3452119">(</span><span class="ident" id="3452120">true</span><span class="op" id="3452124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452127">return</span>&nbsp;<span class="ident" id="3452134">c</span><br>
<span class="lineno">65</span><span class="op" id="3452136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452139">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;io.ReaderFrom&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="3452197">func</span>&nbsp;<span class="op" id="3452202">(</span><span class="ident" id="3452203">c</span>&nbsp;<span class="op" id="3452205">*</span><span class="ident" id="3452206">TCPConn</span><span class="op" id="3452213">)</span>&nbsp;<span class="ident" id="3452215">ReadFrom</span><span class="op" id="3452223">(</span><span class="ident" id="3452224">r</span>&nbsp;<span class="ident" id="3452226">io</span><span class="op" id="3452228">.</span><span class="ident" id="3452229">Reader</span><span class="op" id="3452235">)</span>&nbsp;<span class="op" id="3452237">(</span><span class="ident" id="3452238">int64</span><span class="op" id="3452243">,</span>&nbsp;<span class="builtintype" id="3452245">error</span><span class="op" id="3452250">)</span>&nbsp;<span class="op" id="3452252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452255">if</span>&nbsp;<span class="ident" id="3452258">n</span><span class="op" id="3452259">,</span>&nbsp;<span class="ident" id="3452261">err</span><span class="op" id="3452264">,</span>&nbsp;<span class="ident" id="3452266">handled</span>&nbsp;<span class="op" id="3452274">:=</span>&nbsp;<span class="ident" id="3452277">sendFile</span><span class="op" id="3452285">(</span><span class="ident" id="3452286">c</span><span class="op" id="3452287">.</span><span class="ident" id="3452288">fd</span><span class="op" id="3452290">,</span>&nbsp;<span class="ident" id="3452292">r</span><span class="op" id="3452293">)</span><span class="op" id="3452294">;</span>&nbsp;<span class="ident" id="3452296">handled</span>&nbsp;<span class="op" id="3452304">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452308">return</span>&nbsp;<span class="ident" id="3452315">n</span><span class="op" id="3452316">,</span>&nbsp;<span class="ident" id="3452318">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452326">return</span>&nbsp;<span class="ident" id="3452333">genericReadFrom</span><span class="op" id="3452348">(</span><span class="ident" id="3452349">c</span><span class="op" id="3452350">,</span>&nbsp;<span class="ident" id="3452352">r</span><span class="op" id="3452353">)</span><br>
<span class="lineno"></span><span class="op" id="3452355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3452358">//&nbsp;CloseRead&nbsp;shuts&nbsp;down&nbsp;the&nbsp;reading&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3452422">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3452461">func</span>&nbsp;<span class="op" id="3452466">(</span><span class="ident" id="3452467">c</span>&nbsp;<span class="op" id="3452469">*</span><span class="ident" id="3452470">TCPConn</span><span class="op" id="3452477">)</span>&nbsp;<span class="ident" id="3452479">CloseRead</span><span class="op" id="3452488">(</span><span class="op" id="3452489">)</span>&nbsp;<span class="builtintype" id="3452491">error</span>&nbsp;<span class="op" id="3452497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452500">if</span>&nbsp;<span class="op" id="3452503">!</span><span class="ident" id="3452504">c</span><span class="op" id="3452505">.</span><span class="ident" id="3452506">ok</span><span class="op" id="3452508">(</span><span class="op" id="3452509">)</span>&nbsp;<span class="op" id="3452511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452515">return</span>&nbsp;<span class="ident" id="3452522">syscall</span><span class="op" id="3452529">.</span><span class="ident" id="3452530">EINVAL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452541">return</span>&nbsp;<span class="ident" id="3452548">c</span><span class="op" id="3452549">.</span><span class="ident" id="3452550">fd</span><span class="op" id="3452552">.</span><span class="ident" id="3452553">closeRead</span><span class="op" id="3452562">(</span><span class="op" id="3452563">)</span><br>
<span class="lineno"></span><span class="op" id="3452565">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452568">//&nbsp;CloseWrite&nbsp;shuts&nbsp;down&nbsp;the&nbsp;writing&nbsp;side&nbsp;of&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno">85</span><span class="comment" id="3452633">//&nbsp;Most&nbsp;callers&nbsp;should&nbsp;just&nbsp;use&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3452672">func</span>&nbsp;<span class="op" id="3452677">(</span><span class="ident" id="3452678">c</span>&nbsp;<span class="op" id="3452680">*</span><span class="ident" id="3452681">TCPConn</span><span class="op" id="3452688">)</span>&nbsp;<span class="ident" id="3452690">CloseWrite</span><span class="op" id="3452700">(</span><span class="op" id="3452701">)</span>&nbsp;<span class="builtintype" id="3452703">error</span>&nbsp;<span class="op" id="3452709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452712">if</span>&nbsp;<span class="op" id="3452715">!</span><span class="ident" id="3452716">c</span><span class="op" id="3452717">.</span><span class="ident" id="3452718">ok</span><span class="op" id="3452720">(</span><span class="op" id="3452721">)</span>&nbsp;<span class="op" id="3452723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452727">return</span>&nbsp;<span class="ident" id="3452734">syscall</span><span class="op" id="3452741">.</span><span class="ident" id="3452742">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3452750">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3452753">return</span>&nbsp;<span class="ident" id="3452760">c</span><span class="op" id="3452761">.</span><span class="ident" id="3452762">fd</span><span class="op" id="3452764">.</span><span class="ident" id="3452765">closeWrite</span><span class="op" id="3452775">(</span><span class="op" id="3452776">)</span><br>
<span class="lineno"></span><span class="op" id="3452778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3452781">//&nbsp;SetLinger&nbsp;sets&nbsp;the&nbsp;behavior&nbsp;of&nbsp;Close&nbsp;on&nbsp;a&nbsp;connection&nbsp;which&nbsp;still</span><br>
<span class="lineno"></span><span class="comment" id="3452849">//&nbsp;has&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;sent&nbsp;or&nbsp;to&nbsp;be&nbsp;acknowledged.</span><br>
<span class="lineno">95</span><span class="comment" id="3452903">//</span><br>
<span class="lineno"></span><span class="comment" id="3452906">//&nbsp;If&nbsp;sec&nbsp;&lt;&nbsp;0&nbsp;(the&nbsp;default),&nbsp;the&nbsp;operating&nbsp;system&nbsp;finishes&nbsp;sending&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3452977">//&nbsp;data&nbsp;in&nbsp;the&nbsp;background.</span><br>
<span class="lineno"></span><span class="comment" id="3453004">//</span><br>
<span class="lineno"></span><span class="comment" id="3453007">//&nbsp;If&nbsp;sec&nbsp;==&nbsp;0,&nbsp;the&nbsp;operating&nbsp;system&nbsp;discards&nbsp;any&nbsp;unsent&nbsp;or</span><br>
<span class="lineno">100</span><span class="comment" id="3453067">//&nbsp;unacknowledged&nbsp;data.</span><br>
<span class="lineno"></span><span class="comment" id="3453091">//</span><br>
<span class="lineno"></span><span class="comment" id="3453094">//&nbsp;If&nbsp;sec&nbsp;&gt;&nbsp;0,&nbsp;the&nbsp;data&nbsp;is&nbsp;sent&nbsp;in&nbsp;the&nbsp;background&nbsp;as&nbsp;with&nbsp;sec&nbsp;&lt;&nbsp;0.&nbsp;On</span><br>
<span class="lineno"></span><span class="comment" id="3453164">//&nbsp;some&nbsp;operating&nbsp;systems&nbsp;after&nbsp;sec&nbsp;seconds&nbsp;have&nbsp;elapsed&nbsp;any&nbsp;remaining</span><br>
<span class="lineno"></span><span class="comment" id="3453235">//&nbsp;unsent&nbsp;data&nbsp;may&nbsp;be&nbsp;discarded.</span><br>
<span class="lineno">105</span><span class="keyword" id="3453268">func</span>&nbsp;<span class="op" id="3453273">(</span><span class="ident" id="3453274">c</span>&nbsp;<span class="op" id="3453276">*</span><span class="ident" id="3453277">TCPConn</span><span class="op" id="3453284">)</span>&nbsp;<span class="ident" id="3453286">SetLinger</span><span class="op" id="3453295">(</span><span class="ident" id="3453296">sec</span>&nbsp;<span class="builtintype" id="3453300">int</span><span class="op" id="3453303">)</span>&nbsp;<span class="builtintype" id="3453305">error</span>&nbsp;<span class="op" id="3453311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453314">if</span>&nbsp;<span class="op" id="3453317">!</span><span class="ident" id="3453318">c</span><span class="op" id="3453319">.</span><span class="ident" id="3453320">ok</span><span class="op" id="3453322">(</span><span class="op" id="3453323">)</span>&nbsp;<span class="op" id="3453325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453329">return</span>&nbsp;<span class="ident" id="3453336">syscall</span><span class="op" id="3453343">.</span><span class="ident" id="3453344">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453355">return</span>&nbsp;<span class="ident" id="3453362">setLinger</span><span class="op" id="3453371">(</span><span class="ident" id="3453372">c</span><span class="op" id="3453373">.</span><span class="ident" id="3453374">fd</span><span class="op" id="3453376">,</span>&nbsp;<span class="ident" id="3453378">sec</span><span class="op" id="3453381">)</span><br>
<span class="lineno">110</span><span class="op" id="3453383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3453386">//&nbsp;SetKeepAlive&nbsp;sets&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;send</span><br>
<span class="lineno"></span><span class="comment" id="3453448">//&nbsp;keepalive&nbsp;messages&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3453489">func</span>&nbsp;<span class="op" id="3453494">(</span><span class="ident" id="3453495">c</span>&nbsp;<span class="op" id="3453497">*</span><span class="ident" id="3453498">TCPConn</span><span class="op" id="3453505">)</span>&nbsp;<span class="ident" id="3453507">SetKeepAlive</span><span class="op" id="3453519">(</span><span class="ident" id="3453520">keepalive</span>&nbsp;<span class="builtintype" id="3453530">bool</span><span class="op" id="3453534">)</span>&nbsp;<span class="builtintype" id="3453536">error</span>&nbsp;<span class="op" id="3453542">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453545">if</span>&nbsp;<span class="op" id="3453548">!</span><span class="ident" id="3453549">c</span><span class="op" id="3453550">.</span><span class="ident" id="3453551">ok</span><span class="op" id="3453553">(</span><span class="op" id="3453554">)</span>&nbsp;<span class="op" id="3453556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453560">return</span>&nbsp;<span class="ident" id="3453567">syscall</span><span class="op" id="3453574">.</span><span class="ident" id="3453575">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453586">return</span>&nbsp;<span class="ident" id="3453593">setKeepAlive</span><span class="op" id="3453605">(</span><span class="ident" id="3453606">c</span><span class="op" id="3453607">.</span><span class="ident" id="3453608">fd</span><span class="op" id="3453610">,</span>&nbsp;<span class="ident" id="3453612">keepalive</span><span class="op" id="3453621">)</span><br>
<span class="lineno"></span><span class="op" id="3453623">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3453626">//&nbsp;SetKeepAlivePeriod&nbsp;sets&nbsp;period&nbsp;between&nbsp;keep&nbsp;alives.</span><br>
<span class="lineno"></span><span class="keyword" id="3453681">func</span>&nbsp;<span class="op" id="3453686">(</span><span class="ident" id="3453687">c</span>&nbsp;<span class="op" id="3453689">*</span><span class="ident" id="3453690">TCPConn</span><span class="op" id="3453697">)</span>&nbsp;<span class="ident" id="3453699">SetKeepAlivePeriod</span><span class="op" id="3453717">(</span><span class="ident" id="3453718">d</span>&nbsp;<span class="ident" id="3453720">time</span><span class="op" id="3453724">.</span><span class="ident" id="3453725">Duration</span><span class="op" id="3453733">)</span>&nbsp;<span class="builtintype" id="3453735">error</span>&nbsp;<span class="op" id="3453741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453744">if</span>&nbsp;<span class="op" id="3453747">!</span><span class="ident" id="3453748">c</span><span class="op" id="3453749">.</span><span class="ident" id="3453750">ok</span><span class="op" id="3453752">(</span><span class="op" id="3453753">)</span>&nbsp;<span class="op" id="3453755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453759">return</span>&nbsp;<span class="ident" id="3453766">syscall</span><span class="op" id="3453773">.</span><span class="ident" id="3453774">EINVAL</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3453782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3453785">return</span>&nbsp;<span class="ident" id="3453792">setKeepAlivePeriod</span><span class="op" id="3453810">(</span><span class="ident" id="3453811">c</span><span class="op" id="3453812">.</span><span class="ident" id="3453813">fd</span><span class="op" id="3453815">,</span>&nbsp;<span class="ident" id="3453817">d</span><span class="op" id="3453818">)</span><br>
<span class="lineno"></span><span class="op" id="3453820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3453823">//&nbsp;SetNoDelay&nbsp;controls&nbsp;whether&nbsp;the&nbsp;operating&nbsp;system&nbsp;should&nbsp;delay</span><br>
<span class="lineno">130</span><span class="comment" id="3453888">//&nbsp;packet&nbsp;transmission&nbsp;in&nbsp;hopes&nbsp;of&nbsp;sending&nbsp;fewer&nbsp;packets&nbsp;(Nagle&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3453954">//&nbsp;algorithm).&nbsp;&nbsp;The&nbsp;default&nbsp;is&nbsp;true&nbsp;(no&nbsp;delay),&nbsp;meaning&nbsp;that&nbsp;data&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3454023">//&nbsp;sent&nbsp;as&nbsp;soon&nbsp;as&nbsp;possible&nbsp;after&nbsp;a&nbsp;Write.</span><br>
<span class="lineno"></span><span class="keyword" id="3454066">func</span>&nbsp;<span class="op" id="3454071">(</span><span class="ident" id="3454072">c</span>&nbsp;<span class="op" id="3454074">*</span><span class="ident" id="3454075">TCPConn</span><span class="op" id="3454082">)</span>&nbsp;<span class="ident" id="3454084">SetNoDelay</span><span class="op" id="3454094">(</span><span class="ident" id="3454095">noDelay</span>&nbsp;<span class="builtintype" id="3454103">bool</span><span class="op" id="3454107">)</span>&nbsp;<span class="builtintype" id="3454109">error</span>&nbsp;<span class="op" id="3454115">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454118">if</span>&nbsp;<span class="op" id="3454121">!</span><span class="ident" id="3454122">c</span><span class="op" id="3454123">.</span><span class="ident" id="3454124">ok</span><span class="op" id="3454126">(</span><span class="op" id="3454127">)</span>&nbsp;<span class="op" id="3454129">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454133">return</span>&nbsp;<span class="ident" id="3454140">syscall</span><span class="op" id="3454147">.</span><span class="ident" id="3454148">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454159">return</span>&nbsp;<span class="ident" id="3454166">setNoDelay</span><span class="op" id="3454176">(</span><span class="ident" id="3454177">c</span><span class="op" id="3454178">.</span><span class="ident" id="3454179">fd</span><span class="op" id="3454181">,</span>&nbsp;<span class="ident" id="3454183">noDelay</span><span class="op" id="3454190">)</span><br>
<span class="lineno"></span><span class="op" id="3454192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3454195">//&nbsp;DialTCP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;net,</span><br>
<span class="lineno"></span><span class="comment" id="3454263">//&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;is&nbsp;not&nbsp;nil,&nbsp;it&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3454334">//&nbsp;used&nbsp;as&nbsp;the&nbsp;local&nbsp;address&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3454383">func</span>&nbsp;<span class="ident" id="3454388">DialTCP</span><span class="op" id="3454395">(</span><span class="ident" id="3454396">net</span>&nbsp;<span class="builtintype" id="3454400">string</span><span class="op" id="3454406">,</span>&nbsp;<span class="ident" id="3454408">laddr</span><span class="op" id="3454413">,</span>&nbsp;<span class="ident" id="3454415">raddr</span>&nbsp;<span class="op" id="3454421">*</span><span class="ident" id="3454422">TCPAddr</span><span class="op" id="3454429">)</span>&nbsp;<span class="op" id="3454431">(</span><span class="op" id="3454432">*</span><span class="ident" id="3454433">TCPConn</span><span class="op" id="3454440">,</span>&nbsp;<span class="builtintype" id="3454442">error</span><span class="op" id="3454447">)</span>&nbsp;<span class="op" id="3454449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454452">switch</span>&nbsp;<span class="ident" id="3454459">net</span>&nbsp;<span class="op" id="3454463">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454466">case</span>&nbsp;<span class="string" id="3454471">&#34;tcp&#34;</span><span class="op" id="3454476">,</span>&nbsp;<span class="string" id="3454478">&#34;tcp4&#34;</span><span class="op" id="3454484">,</span>&nbsp;<span class="string" id="3454486">&#34;tcp6&#34;</span><span class="op" id="3454492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454495">default</span><span class="op" id="3454502">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454506">return</span>&nbsp;<span class="ident" id="3454513">nil</span><span class="op" id="3454516">,</span>&nbsp;<span class="op" id="3454518">&amp;</span><span class="ident" id="3454519">OpError</span><span class="op" id="3454526">{</span><span class="ident" id="3454527">Op</span><span class="op" id="3454529">:</span>&nbsp;<span class="string" id="3454531">&#34;dial&#34;</span><span class="op" id="3454537">,</span>&nbsp;<span class="ident" id="3454539">Net</span><span class="op" id="3454542">:</span>&nbsp;<span class="ident" id="3454544">net</span><span class="op" id="3454547">,</span>&nbsp;<span class="ident" id="3454549">Addr</span><span class="op" id="3454553">:</span>&nbsp;<span class="ident" id="3454555">raddr</span><span class="op" id="3454560">,</span>&nbsp;<span class="ident" id="3454562">Err</span><span class="op" id="3454565">:</span>&nbsp;<span class="ident" id="3454567">UnknownNetworkError</span><span class="op" id="3454586">(</span><span class="ident" id="3454587">net</span><span class="op" id="3454590">)</span><span class="op" id="3454591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454594">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454597">if</span>&nbsp;<span class="ident" id="3454600">raddr</span>&nbsp;<span class="op" id="3454606">==</span>&nbsp;<span class="ident" id="3454609">nil</span>&nbsp;<span class="op" id="3454613">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454617">return</span>&nbsp;<span class="ident" id="3454624">nil</span><span class="op" id="3454627">,</span>&nbsp;<span class="op" id="3454629">&amp;</span><span class="ident" id="3454630">OpError</span><span class="op" id="3454637">{</span><span class="ident" id="3454638">Op</span><span class="op" id="3454640">:</span>&nbsp;<span class="string" id="3454642">&#34;dial&#34;</span><span class="op" id="3454648">,</span>&nbsp;<span class="ident" id="3454650">Net</span><span class="op" id="3454653">:</span>&nbsp;<span class="ident" id="3454655">net</span><span class="op" id="3454658">,</span>&nbsp;<span class="ident" id="3454660">Addr</span><span class="op" id="3454664">:</span>&nbsp;<span class="ident" id="3454666">nil</span><span class="op" id="3454669">,</span>&nbsp;<span class="ident" id="3454671">Err</span><span class="op" id="3454674">:</span>&nbsp;<span class="ident" id="3454676">errMissingAddress</span><span class="op" id="3454693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3454696">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3454699">return</span>&nbsp;<span class="ident" id="3454706">dialTCP</span><span class="op" id="3454713">(</span><span class="ident" id="3454714">net</span><span class="op" id="3454717">,</span>&nbsp;<span class="ident" id="3454719">laddr</span><span class="op" id="3454724">,</span>&nbsp;<span class="ident" id="3454726">raddr</span><span class="op" id="3454731">,</span>&nbsp;<span class="ident" id="3454733">noDeadline</span><span class="op" id="3454743">)</span><br>
<span class="lineno"></span><span class="op" id="3454745">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="keyword" id="3454748">func</span>&nbsp;<span class="ident" id="3454753">dialTCP</span><span class="op" id="3454760">(</span><span class="ident" id="3454761">net</span>&nbsp;<span class="builtintype" id="3454765">string</span><span class="op" id="3454771">,</span>&nbsp;<span class="ident" id="3454773">laddr</span><span class="op" id="3454778">,</span>&nbsp;<span class="ident" id="3454780">raddr</span>&nbsp;<span class="op" id="3454786">*</span><span class="ident" id="3454787">TCPAddr</span><span class="op" id="3454794">,</span>&nbsp;<span class="ident" id="3454796">deadline</span>&nbsp;<span class="ident" id="3454805">time</span><span class="op" id="3454809">.</span><span class="ident" id="3454810">Time</span><span class="op" id="3454814">)</span>&nbsp;<span class="op" id="3454816">(</span><span class="op" id="3454817">*</span><span class="ident" id="3454818">TCPConn</span><span class="op" id="3454825">,</span>&nbsp;<span class="builtintype" id="3454827">error</span><span class="op" id="3454832">)</span>&nbsp;<span class="op" id="3454834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3454837">fd</span><span class="op" id="3454839">,</span>&nbsp;<span class="ident" id="3454841">err</span>&nbsp;<span class="op" id="3454845">:=</span>&nbsp;<span class="ident" id="3454848">internetSocket</span><span class="op" id="3454862">(</span><span class="ident" id="3454863">net</span><span class="op" id="3454866">,</span>&nbsp;<span class="ident" id="3454868">laddr</span><span class="op" id="3454873">,</span>&nbsp;<span class="ident" id="3454875">raddr</span><span class="op" id="3454880">,</span>&nbsp;<span class="ident" id="3454882">deadline</span><span class="op" id="3454890">,</span>&nbsp;<span class="ident" id="3454892">syscall</span><span class="op" id="3454899">.</span><span class="ident" id="3454900">SOCK_STREAM</span><span class="op" id="3454911">,</span>&nbsp;<span class="num" id="3454913">0</span><span class="op" id="3454914">,</span>&nbsp;<span class="string" id="3454916">&#34;dial&#34;</span><span class="op" id="3454922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3454926">//&nbsp;TCP&nbsp;has&nbsp;a&nbsp;rarely&nbsp;used&nbsp;mechanism&nbsp;called&nbsp;a&nbsp;&#39;simultaneous&nbsp;connection&#39;&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455000">//&nbsp;which&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr1,&nbsp;addr2)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine&nbsp;at&nbsp;addr1&nbsp;can</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455068">//&nbsp;connect&nbsp;to&nbsp;a&nbsp;simultaneous&nbsp;Dial(&#34;tcp&#34;,&nbsp;addr2,&nbsp;addr1)&nbsp;run&nbsp;on&nbsp;the&nbsp;machine</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455143">//&nbsp;at&nbsp;addr2,&nbsp;without&nbsp;either&nbsp;machine&nbsp;executing&nbsp;Listen.&nbsp;&nbsp;If&nbsp;laddr&nbsp;==&nbsp;nil,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455216">//&nbsp;it&nbsp;means&nbsp;we&nbsp;want&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate&nbsp;originating&nbsp;local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455289">//&nbsp;address.&nbsp;&nbsp;Some&nbsp;Linux&nbsp;kernels&nbsp;cycle&nbsp;blindly&nbsp;through&nbsp;a&nbsp;fixed&nbsp;range&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455361">//&nbsp;local&nbsp;ports,&nbsp;regardless&nbsp;of&nbsp;destination&nbsp;port.&nbsp;&nbsp;If&nbsp;a&nbsp;kernel&nbsp;happens&nbsp;to</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455434">//&nbsp;pick&nbsp;local&nbsp;port&nbsp;50001&nbsp;as&nbsp;the&nbsp;source&nbsp;for&nbsp;a&nbsp;Dial(&#34;tcp&#34;,&nbsp;&#34;&#34;,&nbsp;&#34;localhost:50001&#34;),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455516">//&nbsp;then&nbsp;the&nbsp;Dial&nbsp;will&nbsp;succeed,&nbsp;having&nbsp;simultaneously&nbsp;connected&nbsp;to&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455591">//&nbsp;This&nbsp;can&nbsp;only&nbsp;happen&nbsp;when&nbsp;we&nbsp;are&nbsp;letting&nbsp;the&nbsp;kernel&nbsp;pick&nbsp;a&nbsp;port&nbsp;(laddr&nbsp;==&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455674">//&nbsp;and&nbsp;when&nbsp;there&nbsp;is&nbsp;no&nbsp;listener&nbsp;for&nbsp;the&nbsp;destination&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455737">//&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;argue&nbsp;this&nbsp;is&nbsp;anything&nbsp;other&nbsp;than&nbsp;a&nbsp;kernel&nbsp;bug.&nbsp;&nbsp;If&nbsp;we</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455809">//&nbsp;see&nbsp;this&nbsp;happen,&nbsp;rather&nbsp;than&nbsp;expose&nbsp;the&nbsp;buggy&nbsp;effect&nbsp;to&nbsp;users,&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455879">//&nbsp;close&nbsp;the&nbsp;fd&nbsp;and&nbsp;try&nbsp;again.&nbsp;&nbsp;If&nbsp;it&nbsp;happens&nbsp;twice&nbsp;more,&nbsp;we&nbsp;relent&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455952">//&nbsp;use&nbsp;the&nbsp;result.&nbsp;&nbsp;See&nbsp;also:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3455983">//&nbsp;&nbsp;&nbsp;&nbsphttp://golang.org/issue/2690</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456016">//&nbsp;&nbsp;&nbsp;&nbsphttp://stackoverflow.com/questions/4949858/</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456064">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456068">//&nbsp;The&nbsp;opposite&nbsp;can&nbsp;also&nbsp;happen:&nbsp;if&nbsp;we&nbsp;ask&nbsp;the&nbsp;kernel&nbsp;to&nbsp;pick&nbsp;an&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456146">//&nbsp;originating&nbsp;local&nbsp;address,&nbsp;sometimes&nbsp;it&nbsp;picks&nbsp;one&nbsp;that&nbsp;is&nbsp;already&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456224">//&nbsp;So&nbsp;if&nbsp;the&nbsp;error&nbsp;is&nbsp;EADDRNOTAVAIL,&nbsp;we&nbsp;have&nbsp;to&nbsp;try&nbsp;again&nbsp;too,&nbsp;just&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456297">//&nbsp;a&nbsp;different&nbsp;reason.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456321">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456325">//&nbsp;The&nbsp;kernel&nbsp;socket&nbsp;code&nbsp;is&nbsp;no&nbsp;doubt&nbsp;enjoying&nbsp;watching&nbsp;us&nbsp;squirm.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456393">for</span>&nbsp;<span class="ident" id="3456397">i</span>&nbsp;<span class="op" id="3456399">:=</span>&nbsp;<span class="num" id="3456402">0</span><span class="op" id="3456403">;</span>&nbsp;<span class="ident" id="3456405">i</span>&nbsp;<span class="op" id="3456407">&lt;</span>&nbsp;<span class="num" id="3456409">2</span>&nbsp;<span class="op" id="3456411">&amp;&amp;</span>&nbsp;<span class="op" id="3456414">(</span><span class="ident" id="3456415">laddr</span>&nbsp;<span class="op" id="3456421">==</span>&nbsp;<span class="ident" id="3456424">nil</span>&nbsp;<span class="op" id="3456428">||</span>&nbsp;<span class="ident" id="3456431">laddr</span><span class="op" id="3456436">.</span><span class="ident" id="3456437">Port</span>&nbsp;<span class="op" id="3456442">==</span>&nbsp;<span class="num" id="3456445">0</span><span class="op" id="3456446">)</span>&nbsp;<span class="op" id="3456448">&amp;&amp;</span>&nbsp;<span class="op" id="3456451">(</span><span class="ident" id="3456452">selfConnect</span><span class="op" id="3456463">(</span><span class="ident" id="3456464">fd</span><span class="op" id="3456466">,</span>&nbsp;<span class="ident" id="3456468">err</span><span class="op" id="3456471">)</span>&nbsp;<span class="op" id="3456473">||</span>&nbsp;<span class="ident" id="3456476">spuriousENOTAVAIL</span><span class="op" id="3456493">(</span><span class="ident" id="3456494">err</span><span class="op" id="3456497">)</span><span class="op" id="3456498">)</span><span class="op" id="3456499">;</span>&nbsp;<span class="ident" id="3456501">i</span><span class="op" id="3456502">++</span>&nbsp;<span class="op" id="3456505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456509">if</span>&nbsp;<span class="ident" id="3456512">err</span>&nbsp;<span class="op" id="3456516">==</span>&nbsp;<span class="ident" id="3456519">nil</span>&nbsp;<span class="op" id="3456523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456528">fd</span><span class="op" id="3456530">.</span><span class="ident" id="3456531">Close</span><span class="op" id="3456536">(</span><span class="op" id="3456537">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3456545">fd</span><span class="op" id="3456547">,</span>&nbsp;<span class="ident" id="3456549">err</span>&nbsp;<span class="op" id="3456553">=</span>&nbsp;<span class="ident" id="3456555">internetSocket</span><span class="op" id="3456569">(</span><span class="ident" id="3456570">net</span><span class="op" id="3456573">,</span>&nbsp;<span class="ident" id="3456575">laddr</span><span class="op" id="3456580">,</span>&nbsp;<span class="ident" id="3456582">raddr</span><span class="op" id="3456587">,</span>&nbsp;<span class="ident" id="3456589">deadline</span><span class="op" id="3456597">,</span>&nbsp;<span class="ident" id="3456599">syscall</span><span class="op" id="3456606">.</span><span class="ident" id="3456607">SOCK_STREAM</span><span class="op" id="3456618">,</span>&nbsp;<span class="num" id="3456620">0</span><span class="op" id="3456621">,</span>&nbsp;<span class="string" id="3456623">&#34;dial&#34;</span><span class="op" id="3456629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456636">if</span>&nbsp;<span class="ident" id="3456639">err</span>&nbsp;<span class="op" id="3456643">!=</span>&nbsp;<span class="ident" id="3456646">nil</span>&nbsp;<span class="op" id="3456650">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456654">return</span>&nbsp;<span class="ident" id="3456661">nil</span><span class="op" id="3456664">,</span>&nbsp;<span class="op" id="3456666">&amp;</span><span class="ident" id="3456667">OpError</span><span class="op" id="3456674">{</span><span class="ident" id="3456675">Op</span><span class="op" id="3456677">:</span>&nbsp;<span class="string" id="3456679">&#34;dial&#34;</span><span class="op" id="3456685">,</span>&nbsp;<span class="ident" id="3456687">Net</span><span class="op" id="3456690">:</span>&nbsp;<span class="ident" id="3456692">net</span><span class="op" id="3456695">,</span>&nbsp;<span class="ident" id="3456697">Addr</span><span class="op" id="3456701">:</span>&nbsp;<span class="ident" id="3456703">raddr</span><span class="op" id="3456708">,</span>&nbsp;<span class="ident" id="3456710">Err</span><span class="op" id="3456713">:</span>&nbsp;<span class="ident" id="3456715">err</span><span class="op" id="3456718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456724">return</span>&nbsp;<span class="ident" id="3456731">newTCPConn</span><span class="op" id="3456741">(</span><span class="ident" id="3456742">fd</span><span class="op" id="3456744">)</span><span class="op" id="3456745">,</span>&nbsp;<span class="ident" id="3456747">nil</span><br>
<span class="lineno"></span><span class="op" id="3456751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span><span class="keyword" id="3456754">func</span>&nbsp;<span class="ident" id="3456759">selfConnect</span><span class="op" id="3456770">(</span><span class="ident" id="3456771">fd</span>&nbsp;<span class="op" id="3456774">*</span><span class="ident" id="3456775">netFD</span><span class="op" id="3456780">,</span>&nbsp;<span class="ident" id="3456782">err</span>&nbsp;<span class="builtintype" id="3456786">error</span><span class="op" id="3456791">)</span>&nbsp;<span class="builtintype" id="3456793">bool</span>&nbsp;<span class="op" id="3456798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456801">//&nbsp;If&nbsp;the&nbsp;connect&nbsp;failed,&nbsp;we&nbsp;clearly&nbsp;didn&#39;t&nbsp;connect&nbsp;to&nbsp;ourselves.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456868">if</span>&nbsp;<span class="ident" id="3456871">err</span>&nbsp;<span class="op" id="3456875">!=</span>&nbsp;<span class="ident" id="3456878">nil</span>&nbsp;<span class="op" id="3456882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3456886">return</span>&nbsp;<span class="ident" id="3456893">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3456900">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456904">//&nbsp;The&nbsp;socket&nbsp;constructor&nbsp;can&nbsp;return&nbsp;an&nbsp;fd&nbsp;with&nbsp;raddr&nbsp;nil&nbsp;under&nbsp;certain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3456977">//&nbsp;unknown&nbsp;conditions.&nbsp;The&nbsp;errors&nbsp;in&nbsp;the&nbsp;calls&nbsp;there&nbsp;to&nbsp;Getpeername</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457046">//&nbsp;are&nbsp;discarded,&nbsp;but&nbsp;we&nbsp;can&#39;t&nbsp;catch&nbsp;the&nbsp;problem&nbsp;there&nbsp;because&nbsp;those</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457116">//&nbsp;calls&nbsp;are&nbsp;sometimes&nbsp;legally&nbsp;erroneous&nbsp;with&nbsp;a&nbsp;&#34;socket&nbsp;not&nbsp;connected&#34;.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457189">//&nbsp;Since&nbsp;this&nbsp;code&nbsp;(selfConnect)&nbsp;is&nbsp;already&nbsp;trying&nbsp;to&nbsp;work&nbsp;around</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457256">//&nbsp;a&nbsp;problem,&nbsp;we&nbsp;make&nbsp;sure&nbsp;if&nbsp;this&nbsp;happens&nbsp;we&nbsp;recognize&nbsp;trouble&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457325">//&nbsp;ask&nbsp;the&nbsp;DialTCP&nbsp;routine&nbsp;to&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3457367">//&nbsp;TODO:&nbsp;try&nbsp;to&nbsp;understand&nbsp;what&#39;s&nbsp;really&nbsp;going&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457419">if</span>&nbsp;<span class="ident" id="3457422">fd</span><span class="op" id="3457424">.</span><span class="ident" id="3457425">laddr</span>&nbsp;<span class="op" id="3457431">==</span>&nbsp;<span class="ident" id="3457434">nil</span>&nbsp;<span class="op" id="3457438">||</span>&nbsp;<span class="ident" id="3457441">fd</span><span class="op" id="3457443">.</span><span class="ident" id="3457444">raddr</span>&nbsp;<span class="op" id="3457450">==</span>&nbsp;<span class="ident" id="3457453">nil</span>&nbsp;<span class="op" id="3457457">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457461">return</span>&nbsp;<span class="ident" id="3457468">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3457474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457477">l</span>&nbsp;<span class="op" id="3457479">:=</span>&nbsp;<span class="ident" id="3457482">fd</span><span class="op" id="3457484">.</span><span class="ident" id="3457485">laddr</span><span class="op" id="3457490">.</span><span class="op" id="3457491">(</span><span class="op" id="3457492">*</span><span class="ident" id="3457493">TCPAddr</span><span class="op" id="3457500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457503">r</span>&nbsp;<span class="op" id="3457505">:=</span>&nbsp;<span class="ident" id="3457508">fd</span><span class="op" id="3457510">.</span><span class="ident" id="3457511">raddr</span><span class="op" id="3457516">.</span><span class="op" id="3457517">(</span><span class="op" id="3457518">*</span><span class="ident" id="3457519">TCPAddr</span><span class="op" id="3457526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457529">return</span>&nbsp;<span class="ident" id="3457536">l</span><span class="op" id="3457537">.</span><span class="ident" id="3457538">Port</span>&nbsp;<span class="op" id="3457543">==</span>&nbsp;<span class="ident" id="3457546">r</span><span class="op" id="3457547">.</span><span class="ident" id="3457548">Port</span>&nbsp;<span class="op" id="3457553">&amp;&amp;</span>&nbsp;<span class="ident" id="3457556">l</span><span class="op" id="3457557">.</span><span class="ident" id="3457558">IP</span><span class="op" id="3457560">.</span><span class="ident" id="3457561">Equal</span><span class="op" id="3457566">(</span><span class="ident" id="3457567">r</span><span class="op" id="3457568">.</span><span class="ident" id="3457569">IP</span><span class="op" id="3457571">)</span><br>
<span class="lineno">215</span><span class="op" id="3457573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3457576">func</span>&nbsp;<span class="ident" id="3457581">spuriousENOTAVAIL</span><span class="op" id="3457598">(</span><span class="ident" id="3457599">err</span>&nbsp;<span class="builtintype" id="3457603">error</span><span class="op" id="3457608">)</span>&nbsp;<span class="builtintype" id="3457610">bool</span>&nbsp;<span class="op" id="3457615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457618">e</span><span class="op" id="3457619">,</span>&nbsp;<span class="ident" id="3457621">ok</span>&nbsp;<span class="op" id="3457624">:=</span>&nbsp;<span class="ident" id="3457627">err</span><span class="op" id="3457630">.</span><span class="op" id="3457631">(</span><span class="op" id="3457632">*</span><span class="ident" id="3457633">OpError</span><span class="op" id="3457640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457643">return</span>&nbsp;<span class="ident" id="3457650">ok</span>&nbsp;<span class="op" id="3457653">&amp;&amp;</span>&nbsp;<span class="ident" id="3457656">e</span><span class="op" id="3457657">.</span><span class="ident" id="3457658">Err</span>&nbsp;<span class="op" id="3457662">==</span>&nbsp;<span class="ident" id="3457665">syscall</span><span class="op" id="3457672">.</span><span class="ident" id="3457673">EADDRNOTAVAIL</span><br>
<span class="lineno">220</span><span class="op" id="3457687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3457690">//&nbsp;TCPListener&nbsp;is&nbsp;a&nbsp;TCP&nbsp;network&nbsp;listener.&nbsp;&nbsp;Clients&nbsp;should&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="3457758">//&nbsp;use&nbsp;variables&nbsp;of&nbsp;type&nbsp;Listener&nbsp;instead&nbsp;of&nbsp;assuming&nbsp;TCP.</span><br>
<span class="lineno"></span><span class="keyword" id="3457817">type</span>&nbsp;<span class="ident" id="3457822">TCPListener</span>&nbsp;<span class="keyword" id="3457834">struct</span>&nbsp;<span class="op" id="3457841">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3457844">fd</span>&nbsp;<span class="op" id="3457847">*</span><span class="ident" id="3457848">netFD</span><br>
<span class="lineno"></span><span class="op" id="3457854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3457857">//&nbsp;AcceptTCP&nbsp;accepts&nbsp;the&nbsp;next&nbsp;incoming&nbsp;call&nbsp;and&nbsp;returns&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3457921">//&nbsp;connection.</span><br>
<span class="lineno">230</span><span class="keyword" id="3457936">func</span>&nbsp;<span class="op" id="3457941">(</span><span class="ident" id="3457942">l</span>&nbsp;<span class="op" id="3457944">*</span><span class="ident" id="3457945">TCPListener</span><span class="op" id="3457956">)</span>&nbsp;<span class="ident" id="3457958">AcceptTCP</span><span class="op" id="3457967">(</span><span class="op" id="3457968">)</span>&nbsp;<span class="op" id="3457970">(</span><span class="op" id="3457971">*</span><span class="ident" id="3457972">TCPConn</span><span class="op" id="3457979">,</span>&nbsp;<span class="builtintype" id="3457981">error</span><span class="op" id="3457986">)</span>&nbsp;<span class="op" id="3457988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3457991">if</span>&nbsp;<span class="ident" id="3457994">l</span>&nbsp;<span class="op" id="3457996">==</span>&nbsp;<span class="ident" id="3457999">nil</span>&nbsp;<span class="op" id="3458003">||</span>&nbsp;<span class="ident" id="3458006">l</span><span class="op" id="3458007">.</span><span class="ident" id="3458008">fd</span>&nbsp;<span class="op" id="3458011">==</span>&nbsp;<span class="ident" id="3458014">nil</span>&nbsp;<span class="op" id="3458018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458022">return</span>&nbsp;<span class="ident" id="3458029">nil</span><span class="op" id="3458032">,</span>&nbsp;<span class="ident" id="3458034">syscall</span><span class="op" id="3458041">.</span><span class="ident" id="3458042">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458053">fd</span><span class="op" id="3458055">,</span>&nbsp;<span class="ident" id="3458057">err</span>&nbsp;<span class="op" id="3458061">:=</span>&nbsp;<span class="ident" id="3458064">l</span><span class="op" id="3458065">.</span><span class="ident" id="3458066">fd</span><span class="op" id="3458068">.</span><span class="ident" id="3458069">accept</span><span class="op" id="3458075">(</span><span class="op" id="3458076">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458079">if</span>&nbsp;<span class="ident" id="3458082">err</span>&nbsp;<span class="op" id="3458086">!=</span>&nbsp;<span class="ident" id="3458089">nil</span>&nbsp;<span class="op" id="3458093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458097">return</span>&nbsp;<span class="ident" id="3458104">nil</span><span class="op" id="3458107">,</span>&nbsp;<span class="ident" id="3458109">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458114">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458117">return</span>&nbsp;<span class="ident" id="3458124">newTCPConn</span><span class="op" id="3458134">(</span><span class="ident" id="3458135">fd</span><span class="op" id="3458137">)</span><span class="op" id="3458138">,</span>&nbsp;<span class="ident" id="3458140">nil</span><br>
<span class="lineno"></span><span class="op" id="3458144">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3458147">//&nbsp;Accept&nbsp;implements&nbsp;the&nbsp;Accept&nbsp;method&nbsp;in&nbsp;the&nbsp;Listener&nbsp;interface;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3458216">//&nbsp;waits&nbsp;for&nbsp;the&nbsp;next&nbsp;call&nbsp;and&nbsp;returns&nbsp;a&nbsp;generic&nbsp;Conn.</span><br>
<span class="lineno"></span><span class="keyword" id="3458271">func</span>&nbsp;<span class="op" id="3458276">(</span><span class="ident" id="3458277">l</span>&nbsp;<span class="op" id="3458279">*</span><span class="ident" id="3458280">TCPListener</span><span class="op" id="3458291">)</span>&nbsp;<span class="ident" id="3458293">Accept</span><span class="op" id="3458299">(</span><span class="op" id="3458300">)</span>&nbsp;<span class="op" id="3458302">(</span><span class="ident" id="3458303">Conn</span><span class="op" id="3458307">,</span>&nbsp;<span class="builtintype" id="3458309">error</span><span class="op" id="3458314">)</span>&nbsp;<span class="op" id="3458316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3458319">c</span><span class="op" id="3458320">,</span>&nbsp;<span class="ident" id="3458322">err</span>&nbsp;<span class="op" id="3458326">:=</span>&nbsp;<span class="ident" id="3458329">l</span><span class="op" id="3458330">.</span><span class="ident" id="3458331">AcceptTCP</span><span class="op" id="3458340">(</span><span class="op" id="3458341">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458344">if</span>&nbsp;<span class="ident" id="3458347">err</span>&nbsp;<span class="op" id="3458351">!=</span>&nbsp;<span class="ident" id="3458354">nil</span>&nbsp;<span class="op" id="3458358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458362">return</span>&nbsp;<span class="ident" id="3458369">nil</span><span class="op" id="3458372">,</span>&nbsp;<span class="ident" id="3458374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458382">return</span>&nbsp;<span class="ident" id="3458389">c</span><span class="op" id="3458390">,</span>&nbsp;<span class="ident" id="3458392">nil</span><br>
<span class="lineno"></span><span class="op" id="3458396">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span><span class="comment" id="3458399">//&nbsp;Close&nbsp;stops&nbsp;listening&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="3458444">//&nbsp;Already&nbsp;Accepted&nbsp;connections&nbsp;are&nbsp;not&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3458492">func</span>&nbsp;<span class="op" id="3458497">(</span><span class="ident" id="3458498">l</span>&nbsp;<span class="op" id="3458500">*</span><span class="ident" id="3458501">TCPListener</span><span class="op" id="3458512">)</span>&nbsp;<span class="ident" id="3458514">Close</span><span class="op" id="3458519">(</span><span class="op" id="3458520">)</span>&nbsp;<span class="builtintype" id="3458522">error</span>&nbsp;<span class="op" id="3458528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458531">if</span>&nbsp;<span class="ident" id="3458534">l</span>&nbsp;<span class="op" id="3458536">==</span>&nbsp;<span class="ident" id="3458539">nil</span>&nbsp;<span class="op" id="3458543">||</span>&nbsp;<span class="ident" id="3458546">l</span><span class="op" id="3458547">.</span><span class="ident" id="3458548">fd</span>&nbsp;<span class="op" id="3458551">==</span>&nbsp;<span class="ident" id="3458554">nil</span>&nbsp;<span class="op" id="3458558">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458562">return</span>&nbsp;<span class="ident" id="3458569">syscall</span><span class="op" id="3458576">.</span><span class="ident" id="3458577">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458588">return</span>&nbsp;<span class="ident" id="3458595">l</span><span class="op" id="3458596">.</span><span class="ident" id="3458597">fd</span><span class="op" id="3458599">.</span><span class="ident" id="3458600">Close</span><span class="op" id="3458605">(</span><span class="op" id="3458606">)</span><br>
<span class="lineno"></span><span class="op" id="3458608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span><span class="comment" id="3458611">//&nbsp;Addr&nbsp;returns&nbsp;the&nbsp;listener&#39;s&nbsp;network&nbsp;address,&nbsp;a&nbsp;*TCPAddr.</span><br>
<span class="lineno"></span><span class="keyword" id="3458671">func</span>&nbsp;<span class="op" id="3458676">(</span><span class="ident" id="3458677">l</span>&nbsp;<span class="op" id="3458679">*</span><span class="ident" id="3458680">TCPListener</span><span class="op" id="3458691">)</span>&nbsp;<span class="ident" id="3458693">Addr</span><span class="op" id="3458697">(</span><span class="op" id="3458698">)</span>&nbsp;<span class="ident" id="3458700">Addr</span>&nbsp;<span class="op" id="3458705">{</span>&nbsp;<span class="keyword" id="3458707">return</span>&nbsp;<span class="ident" id="3458714">l</span><span class="op" id="3458715">.</span><span class="ident" id="3458716">fd</span><span class="op" id="3458718">.</span><span class="ident" id="3458719">laddr</span>&nbsp;<span class="op" id="3458725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3458728">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;deadline&nbsp;associated&nbsp;with&nbsp;the&nbsp;listener.</span><br>
<span class="lineno"></span><span class="comment" id="3458791">//&nbsp;A&nbsp;zero&nbsp;time&nbsp;value&nbsp;disables&nbsp;the&nbsp;deadline.</span><br>
<span class="lineno">265</span><span class="keyword" id="3458835">func</span>&nbsp;<span class="op" id="3458840">(</span><span class="ident" id="3458841">l</span>&nbsp;<span class="op" id="3458843">*</span><span class="ident" id="3458844">TCPListener</span><span class="op" id="3458855">)</span>&nbsp;<span class="ident" id="3458857">SetDeadline</span><span class="op" id="3458868">(</span><span class="ident" id="3458869">t</span>&nbsp;<span class="ident" id="3458871">time</span><span class="op" id="3458875">.</span><span class="ident" id="3458876">Time</span><span class="op" id="3458880">)</span>&nbsp;<span class="builtintype" id="3458882">error</span>&nbsp;<span class="op" id="3458888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458891">if</span>&nbsp;<span class="ident" id="3458894">l</span>&nbsp;<span class="op" id="3458896">==</span>&nbsp;<span class="ident" id="3458899">nil</span>&nbsp;<span class="op" id="3458903">||</span>&nbsp;<span class="ident" id="3458906">l</span><span class="op" id="3458907">.</span><span class="ident" id="3458908">fd</span>&nbsp;<span class="op" id="3458911">==</span>&nbsp;<span class="ident" id="3458914">nil</span>&nbsp;<span class="op" id="3458918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458922">return</span>&nbsp;<span class="ident" id="3458929">syscall</span><span class="op" id="3458936">.</span><span class="ident" id="3458937">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3458945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3458948">return</span>&nbsp;<span class="ident" id="3458955">l</span><span class="op" id="3458956">.</span><span class="ident" id="3458957">fd</span><span class="op" id="3458959">.</span><span class="ident" id="3458960">setDeadline</span><span class="op" id="3458971">(</span><span class="ident" id="3458972">t</span><span class="op" id="3458973">)</span><br>
<span class="lineno">270</span><span class="op" id="3458975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3458978">//&nbsp;File&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;underlying&nbsp;os.File,&nbsp;set&nbsp;to&nbsp;blocking</span><br>
<span class="lineno"></span><span class="comment" id="3459044">//&nbsp;mode.&nbsp;&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;close&nbsp;f&nbsp;when&nbsp;finished.</span><br>
<span class="lineno"></span><span class="comment" id="3459114">//&nbsp;Closing&nbsp;l&nbsp;does&nbsp;not&nbsp;affect&nbsp;f,&nbsp;and&nbsp;closing&nbsp;f&nbsp;does&nbsp;not&nbsp;affect&nbsp;l.</span><br>
<span class="lineno">275</span><span class="comment" id="3459179">//</span><br>
<span class="lineno"></span><span class="comment" id="3459182">//&nbsp;The&nbsp;returned&nbsp;os.File&#39;s&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;different&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3459246">//&nbsp;connection&#39;s.&nbsp;&nbsp;Attempting&nbsp;to&nbsp;change&nbsp;properties&nbsp;of&nbsp;the&nbsp;original</span><br>
<span class="lineno"></span><span class="comment" id="3459312">//&nbsp;using&nbsp;this&nbsp;duplicate&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;have&nbsp;the&nbsp;desired&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="3459376">func</span>&nbsp;<span class="op" id="3459381">(</span><span class="ident" id="3459382">l</span>&nbsp;<span class="op" id="3459384">*</span><span class="ident" id="3459385">TCPListener</span><span class="op" id="3459396">)</span>&nbsp;<span class="ident" id="3459398">File</span><span class="op" id="3459402">(</span><span class="op" id="3459403">)</span>&nbsp;<span class="op" id="3459405">(</span><span class="ident" id="3459406">f</span>&nbsp;<span class="op" id="3459408">*</span><span class="ident" id="3459409">os</span><span class="op" id="3459411">.</span><span class="ident" id="3459412">File</span><span class="op" id="3459416">,</span>&nbsp;<span class="ident" id="3459418">err</span>&nbsp;<span class="builtintype" id="3459422">error</span><span class="op" id="3459427">)</span>&nbsp;<span class="op" id="3459429">{</span>&nbsp;<span class="keyword" id="3459431">return</span>&nbsp;<span class="ident" id="3459438">l</span><span class="op" id="3459439">.</span><span class="ident" id="3459440">fd</span><span class="op" id="3459442">.</span><span class="ident" id="3459443">dup</span><span class="op" id="3459446">(</span><span class="op" id="3459447">)</span>&nbsp;<span class="op" id="3459449">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="3459452">//&nbsp;ListenTCP&nbsp;announces&nbsp;on&nbsp;the&nbsp;TCP&nbsp;address&nbsp;laddr&nbsp;and&nbsp;returns&nbsp;a&nbsp;TCP</span><br>
<span class="lineno"></span><span class="comment" id="3459518">//&nbsp;listener.&nbsp;&nbsp;Net&nbsp;must&nbsp;be&nbsp;&#34;tcp&#34;,&nbsp;&#34;tcp4&#34;,&nbsp;or&nbsp;&#34;tcp6&#34;.&nbsp;&nbsp;If&nbsp;laddr&nbsp;has&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3459586">//&nbsp;port&nbsp;of&nbsp;0,&nbsp;ListenTCP&nbsp;will&nbsp;choose&nbsp;an&nbsp;available&nbsp;port.&nbsp;&nbsp;The&nbsp;caller&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3459657">//&nbsp;use&nbsp;the&nbsp;Addr&nbsp;method&nbsp;of&nbsp;TCPListener&nbsp;to&nbsp;retrieve&nbsp;the&nbsp;chosen&nbsp;address.</span><br>
<span class="lineno">285</span><span class="keyword" id="3459727">func</span>&nbsp;<span class="ident" id="3459732">ListenTCP</span><span class="op" id="3459741">(</span><span class="ident" id="3459742">net</span>&nbsp;<span class="builtintype" id="3459746">string</span><span class="op" id="3459752">,</span>&nbsp;<span class="ident" id="3459754">laddr</span>&nbsp;<span class="op" id="3459760">*</span><span class="ident" id="3459761">TCPAddr</span><span class="op" id="3459768">)</span>&nbsp;<span class="op" id="3459770">(</span><span class="op" id="3459771">*</span><span class="ident" id="3459772">TCPListener</span><span class="op" id="3459783">,</span>&nbsp;<span class="builtintype" id="3459785">error</span><span class="op" id="3459790">)</span>&nbsp;<span class="op" id="3459792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459795">switch</span>&nbsp;<span class="ident" id="3459802">net</span>&nbsp;<span class="op" id="3459806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459809">case</span>&nbsp;<span class="string" id="3459814">&#34;tcp&#34;</span><span class="op" id="3459819">,</span>&nbsp;<span class="string" id="3459821">&#34;tcp4&#34;</span><span class="op" id="3459827">,</span>&nbsp;<span class="string" id="3459829">&#34;tcp6&#34;</span><span class="op" id="3459835">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459838">default</span><span class="op" id="3459845">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459849">return</span>&nbsp;<span class="ident" id="3459856">nil</span><span class="op" id="3459859">,</span>&nbsp;<span class="op" id="3459861">&amp;</span><span class="ident" id="3459862">OpError</span><span class="op" id="3459869">{</span><span class="ident" id="3459870">Op</span><span class="op" id="3459872">:</span>&nbsp;<span class="string" id="3459874">&#34;listen&#34;</span><span class="op" id="3459882">,</span>&nbsp;<span class="ident" id="3459884">Net</span><span class="op" id="3459887">:</span>&nbsp;<span class="ident" id="3459889">net</span><span class="op" id="3459892">,</span>&nbsp;<span class="ident" id="3459894">Addr</span><span class="op" id="3459898">:</span>&nbsp;<span class="ident" id="3459900">laddr</span><span class="op" id="3459905">,</span>&nbsp;<span class="ident" id="3459907">Err</span><span class="op" id="3459910">:</span>&nbsp;<span class="ident" id="3459912">UnknownNetworkError</span><span class="op" id="3459931">(</span><span class="ident" id="3459932">net</span><span class="op" id="3459935">)</span><span class="op" id="3459936">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3459942">if</span>&nbsp;<span class="ident" id="3459945">laddr</span>&nbsp;<span class="op" id="3459951">==</span>&nbsp;<span class="ident" id="3459954">nil</span>&nbsp;<span class="op" id="3459958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459962">laddr</span>&nbsp;<span class="op" id="3459968">=</span>&nbsp;<span class="op" id="3459970">&amp;</span><span class="ident" id="3459971">TCPAddr</span><span class="op" id="3459978">{</span><span class="op" id="3459979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3459982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3459985">fd</span><span class="op" id="3459987">,</span>&nbsp;<span class="ident" id="3459989">err</span>&nbsp;<span class="op" id="3459993">:=</span>&nbsp;<span class="ident" id="3459996">internetSocket</span><span class="op" id="3460010">(</span><span class="ident" id="3460011">net</span><span class="op" id="3460014">,</span>&nbsp;<span class="ident" id="3460016">laddr</span><span class="op" id="3460021">,</span>&nbsp;<span class="ident" id="3460023">nil</span><span class="op" id="3460026">,</span>&nbsp;<span class="ident" id="3460028">noDeadline</span><span class="op" id="3460038">,</span>&nbsp;<span class="ident" id="3460040">syscall</span><span class="op" id="3460047">.</span><span class="ident" id="3460048">SOCK_STREAM</span><span class="op" id="3460059">,</span>&nbsp;<span class="num" id="3460061">0</span><span class="op" id="3460062">,</span>&nbsp;<span class="string" id="3460064">&#34;listen&#34;</span><span class="op" id="3460072">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460075">if</span>&nbsp;<span class="ident" id="3460078">err</span>&nbsp;<span class="op" id="3460082">!=</span>&nbsp;<span class="ident" id="3460085">nil</span>&nbsp;<span class="op" id="3460089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460093">return</span>&nbsp;<span class="ident" id="3460100">nil</span><span class="op" id="3460103">,</span>&nbsp;<span class="op" id="3460105">&amp;</span><span class="ident" id="3460106">OpError</span><span class="op" id="3460113">{</span><span class="ident" id="3460114">Op</span><span class="op" id="3460116">:</span>&nbsp;<span class="string" id="3460118">&#34;listen&#34;</span><span class="op" id="3460126">,</span>&nbsp;<span class="ident" id="3460128">Net</span><span class="op" id="3460131">:</span>&nbsp;<span class="ident" id="3460133">net</span><span class="op" id="3460136">,</span>&nbsp;<span class="ident" id="3460138">Addr</span><span class="op" id="3460142">:</span>&nbsp;<span class="ident" id="3460144">laddr</span><span class="op" id="3460149">,</span>&nbsp;<span class="ident" id="3460151">Err</span><span class="op" id="3460154">:</span>&nbsp;<span class="ident" id="3460156">err</span><span class="op" id="3460159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3460162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3460165">return</span>&nbsp;<span class="op" id="3460172">&amp;</span><span class="ident" id="3460173">TCPListener</span><span class="op" id="3460184">{</span><span class="ident" id="3460185">fd</span><span class="op" id="3460187">}</span><span class="op" id="3460188">,</span>&nbsp;<span class="ident" id="3460190">nil</span><br>
<span class="lineno"></span><span class="op" id="3460194">}</span>
</div>
</body>
</html>
