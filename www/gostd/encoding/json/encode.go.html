<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>encoding/json</h2>
<ul>
<li><a href="/gostd/encoding/json/bench_test.go.html">bench_test.go</a></li>
<li><a href="/gostd/encoding/json/decode.go.html">decode.go</a></li>
<li><a href="/gostd/encoding/json/decode_test.go.html">decode_test.go</a></li>
<li><a href="/gostd/encoding/json/encode.go.html">encode.go</a></li>
<li><a href="/gostd/encoding/json/encode_test.go.html">encode_test.go</a></li>
<li><a href="/gostd/encoding/json/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/encoding/json/fold.go.html">fold.go</a></li>
<li><a href="/gostd/encoding/json/fold_test.go.html">fold_test.go</a></li>
<li><a href="/gostd/encoding/json/indent.go.html">indent.go</a></li>
<li><a href="/gostd/encoding/json/scanner.go.html">scanner.go</a></li>
<li><a href="/gostd/encoding/json/scanner_test.go.html">scanner_test.go</a></li>
<li><a href="/gostd/encoding/json/stream.go.html">stream.go</a></li>
<li><a href="/gostd/encoding/json/stream_test.go.html">stream_test.go</a></li>
<li><a href="/gostd/encoding/json/tagkey_test.go.html">tagkey_test.go</a></li>
<li><a href="/gostd/encoding/json/tags.go.html">tags.go</a></li>
<li><a href="/gostd/encoding/json/tags_test.go.html">tags_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3261224">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3261280">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3261334">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3261385">//&nbsp;Package&nbsp;json&nbsp;implements&nbsp;encoding&nbsp;and&nbsp;decoding&nbsp;of&nbsp;JSON&nbsp;objects&nbsp;as&nbsp;defined&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3261464">//&nbsp;RFC&nbsp;4627.&nbsp;The&nbsp;mapping&nbsp;between&nbsp;JSON&nbsp;objects&nbsp;and&nbsp;Go&nbsp;values&nbsp;is&nbsp;described</span><br>
<span class="lineno"></span><span class="comment" id="3261537">//&nbsp;in&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;Marshal&nbsp;and&nbsp;Unmarshal&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="3261602">//</span><br>
<span class="lineno"></span><span class="comment" id="3261605">//&nbsp;See&nbsp;&#34;JSON&nbsp;and&nbsp;Go&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno">10</span><span class="comment" id="3261663">//&nbsp;http://golang.org/doc/articles/json_and_go.html</span><br>
<span class="lineno"></span><span class="keyword" id="3261714">package</span>&nbsp;<span class="ident" id="3261722">json</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3261728">import</span>&nbsp;<span class="op" id="3261735">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261738">&#34;bytes&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261747">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261759">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261778">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261786">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261797">&#34;runtime&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261808">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261816">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261827">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261838">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261846">&#34;unicode&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3261857">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="3261872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3261875">//&nbsp;Marshal&nbsp;returns&nbsp;the&nbsp;JSON&nbsp;encoding&nbsp;of&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="3261918">//</span><br>
<span class="lineno">30</span><span class="comment" id="3261921">//&nbsp;Marshal&nbsp;traverses&nbsp;the&nbsp;value&nbsp;v&nbsp;recursively.</span><br>
<span class="lineno"></span><span class="comment" id="3261967">//&nbsp;If&nbsp;an&nbsp;encountered&nbsp;value&nbsp;implements&nbsp;the&nbsp;Marshaler&nbsp;interface</span><br>
<span class="lineno"></span><span class="comment" id="3262029">//&nbsp;and&nbsp;is&nbsp;not&nbsp;a&nbsp;nil&nbsp;pointer,&nbsp;Marshal&nbsp;calls&nbsp;its&nbsp;MarshalJSON&nbsp;method</span><br>
<span class="lineno"></span><span class="comment" id="3262095">//&nbsp;to&nbsp;produce&nbsp;JSON.&nbsp;&nbsp;The&nbsp;nil&nbsp;pointer&nbsp;exception&nbsp;is&nbsp;not&nbsp;strictly&nbsp;necessary</span><br>
<span class="lineno"></span><span class="comment" id="3262168">//&nbsp;but&nbsp;mimics&nbsp;a&nbsp;similar,&nbsp;necessary&nbsp;exception&nbsp;in&nbsp;the&nbsp;behavior&nbsp;of</span><br>
<span class="lineno">35</span><span class="comment" id="3262232">//&nbsp;UnmarshalJSON.</span><br>
<span class="lineno"></span><span class="comment" id="3262250">//</span><br>
<span class="lineno"></span><span class="comment" id="3262253">//&nbsp;Otherwise,&nbsp;Marshal&nbsp;uses&nbsp;the&nbsp;following&nbsp;type-dependent&nbsp;default&nbsp;encodings:</span><br>
<span class="lineno"></span><span class="comment" id="3262328">//</span><br>
<span class="lineno"></span><span class="comment" id="3262331">//&nbsp;Boolean&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;booleans.</span><br>
<span class="lineno">40</span><span class="comment" id="3262374">//</span><br>
<span class="lineno"></span><span class="comment" id="3262377">//&nbsp;Floating&nbsp;point,&nbsp;integer,&nbsp;and&nbsp;Number&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;numbers.</span><br>
<span class="lineno"></span><span class="comment" id="3262447">//</span><br>
<span class="lineno"></span><span class="comment" id="3262450">//&nbsp;String&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;strings&nbsp;coerced&nbsp;to&nbsp;valid&nbsp;UTF-8,</span><br>
<span class="lineno"></span><span class="comment" id="3262514">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune.</span><br>
<span class="lineno">45</span><span class="comment" id="3262576">//&nbsp;The&nbsp;angle&nbsp;brackets&nbsp;&#34;&lt;&#34;&nbsp;and&nbsp;&#34;&gt;&#34;&nbsp;are&nbsp;escaped&nbsp;to&nbsp;&#34;\u003c&#34;&nbsp;and&nbsp;&#34;\u003e&#34;</span><br>
<span class="lineno"></span><span class="comment" id="3262647">//&nbsp;to&nbsp;keep&nbsp;some&nbsp;browsers&nbsp;from&nbsp;misinterpreting&nbsp;JSON&nbsp;output&nbsp;as&nbsp;HTML.</span><br>
<span class="lineno"></span><span class="comment" id="3262714">//&nbsp;Ampersand&nbsp;&#34;&amp;&#34;&nbsp;is&nbsp;also&nbsp;escaped&nbsp;to&nbsp;&#34;\u0026&#34;&nbsp;for&nbsp;the&nbsp;same&nbsp;reason.</span><br>
<span class="lineno"></span><span class="comment" id="3262780">//</span><br>
<span class="lineno"></span><span class="comment" id="3262783">//&nbsp;Array&nbsp;and&nbsp;slice&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;arrays,&nbsp;except&nbsp;that</span><br>
<span class="lineno">50</span><span class="comment" id="3262844">//&nbsp;[]byte&nbsp;encodes&nbsp;as&nbsp;a&nbsp;base64-encoded&nbsp;string,&nbsp;and&nbsp;a&nbsp;nil&nbsp;slice</span><br>
<span class="lineno"></span><span class="comment" id="3262906">//&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3262942">//</span><br>
<span class="lineno"></span><span class="comment" id="3262945">//&nbsp;Struct&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.&nbsp;Each&nbsp;exported&nbsp;struct&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3263013">//&nbsp;becomes&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;object&nbsp;unless</span><br>
<span class="lineno">55</span><span class="comment" id="3263054">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&#39;s&nbsp;tag&nbsp;is&nbsp;&#34;-&#34;,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3263088">//&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;field&nbsp;is&nbsp;empty&nbsp;and&nbsp;its&nbsp;tag&nbsp;specifies&nbsp;the&nbsp;&#34;omitempty&#34;&nbsp;option.</span><br>
<span class="lineno"></span><span class="comment" id="3263160">//&nbsp;The&nbsp;empty&nbsp;values&nbsp;are&nbsp;false,&nbsp;0,&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="3263198">//&nbsp;nil&nbsp;pointer&nbsp;or&nbsp;interface&nbsp;value,&nbsp;and&nbsp;any&nbsp;array,&nbsp;slice,&nbsp;map,&nbsp;or&nbsp;string&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3263273">//&nbsp;length&nbsp;zero.&nbsp;The&nbsp;object&#39;s&nbsp;default&nbsp;key&nbsp;string&nbsp;is&nbsp;the&nbsp;struct&nbsp;field&nbsp;name</span><br>
<span class="lineno">60</span><span class="comment" id="3263346">//&nbsp;but&nbsp;can&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value.&nbsp;The&nbsp;&#34;json&#34;&nbsp;key&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3263421">//&nbsp;the&nbsp;struct&nbsp;field&#39;s&nbsp;tag&nbsp;value&nbsp;is&nbsp;the&nbsp;key&nbsp;name,&nbsp;followed&nbsp;by&nbsp;an&nbsp;optional&nbsp;comma</span><br>
<span class="lineno"></span><span class="comment" id="3263500">//&nbsp;and&nbsp;options.&nbsp;Examples:</span><br>
<span class="lineno"></span><span class="comment" id="3263526">//</span><br>
<span class="lineno"></span><span class="comment" id="3263529">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;is&nbsp;ignored&nbsp;by&nbsp;this&nbsp;package.</span><br>
<span class="lineno">65</span><span class="comment" id="3263571">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;-&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3263597">//</span><br>
<span class="lineno"></span><span class="comment" id="3263600">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3263647">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3263678">//</span><br>
<span class="lineno">70</span><span class="comment" id="3263681">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;myName&#34;&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3263731">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;omitted&nbsp;from&nbsp;the&nbsp;object&nbsp;if&nbsp;its&nbsp;value&nbsp;is&nbsp;empty,</span><br>
<span class="lineno"></span><span class="comment" id="3263799">//&nbsp;&nbsp;&nbsp;//&nbsp;as&nbsp;defined&nbsp;above.</span><br>
<span class="lineno"></span><span class="comment" id="3263825">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;myName,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3263866">//</span><br>
<span class="lineno">75</span><span class="comment" id="3263869">//&nbsp;&nbsp;&nbsp;//&nbsp;Field&nbsp;appears&nbsp;in&nbsp;JSON&nbsp;as&nbsp;key&nbsp;&#34;Field&#34;&nbsp;(the&nbsp;default),&nbsp;but</span><br>
<span class="lineno"></span><span class="comment" id="3263933">//&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;field&nbsp;is&nbsp;skipped&nbsp;if&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="3263972">//&nbsp;&nbsp;&nbsp;//&nbsp;Note&nbsp;the&nbsp;leading&nbsp;comma.</span><br>
<span class="lineno"></span><span class="comment" id="3264004">//&nbsp;&nbsp;&nbsp;Field&nbsp;int&nbsp;`json:&#34;,omitempty&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3264039">//</span><br>
<span class="lineno">80</span><span class="comment" id="3264042">//&nbsp;The&nbsp;&#34;string&#34;&nbsp;option&nbsp;signals&nbsp;that&nbsp;a&nbsp;field&nbsp;is&nbsp;stored&nbsp;as&nbsp;JSON&nbsp;inside&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3264113">//&nbsp;JSON-encoded&nbsp;string.&nbsp;It&nbsp;applies&nbsp;only&nbsp;to&nbsp;fields&nbsp;of&nbsp;string,&nbsp;floating&nbsp;point,</span><br>
<span class="lineno"></span><span class="comment" id="3264190">//&nbsp;or&nbsp;integer&nbsp;types.&nbsp;This&nbsp;extra&nbsp;level&nbsp;of&nbsp;encoding&nbsp;is&nbsp;sometimes&nbsp;used&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3264263">//&nbsp;communicating&nbsp;with&nbsp;JavaScript&nbsp;programs:</span><br>
<span class="lineno"></span><span class="comment" id="3264306">//</span><br>
<span class="lineno">85</span><span class="comment" id="3264309">//&nbsp;&nbsp;&nbsp;&nbsp;Int64String&nbsp;int64&nbsp;`json:&#34;,string&#34;`</span><br>
<span class="lineno"></span><span class="comment" id="3264350">//</span><br>
<span class="lineno"></span><span class="comment" id="3264353">//&nbsp;The&nbsp;key&nbsp;name&nbsp;will&nbsp;be&nbsp;used&nbsp;if&nbsp;it&#39;s&nbsp;a&nbsp;non-empty&nbsp;string&nbsp;consisting&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3264423">//&nbsp;only&nbsp;Unicode&nbsp;letters,&nbsp;digits,&nbsp;dollar&nbsp;signs,&nbsp;percent&nbsp;signs,&nbsp;hyphens,</span><br>
<span class="lineno"></span><span class="comment" id="3264494">//&nbsp;underscores&nbsp;and&nbsp;slashes.</span><br>
<span class="lineno">90</span><span class="comment" id="3264522">//</span><br>
<span class="lineno"></span><span class="comment" id="3264525">//&nbsp;Anonymous&nbsp;struct&nbsp;fields&nbsp;are&nbsp;usually&nbsp;marshaled&nbsp;as&nbsp;if&nbsp;their&nbsp;inner&nbsp;exported&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="3264608">//&nbsp;were&nbsp;fields&nbsp;in&nbsp;the&nbsp;outer&nbsp;struct,&nbsp;subject&nbsp;to&nbsp;the&nbsp;usual&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;amended</span><br>
<span class="lineno"></span><span class="comment" id="3264693">//&nbsp;as&nbsp;described&nbsp;in&nbsp;the&nbsp;next&nbsp;paragraph.</span><br>
<span class="lineno"></span><span class="comment" id="3264732">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;with&nbsp;a&nbsp;name&nbsp;given&nbsp;in&nbsp;its&nbsp;JSON&nbsp;tag&nbsp;is&nbsp;treated&nbsp;as</span><br>
<span class="lineno">95</span><span class="comment" id="3264809">//&nbsp;having&nbsp;that&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3264859">//&nbsp;An&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;of&nbsp;interface&nbsp;type&nbsp;is&nbsp;treated&nbsp;the&nbsp;same&nbsp;as&nbsp;having</span><br>
<span class="lineno"></span><span class="comment" id="3264936">//&nbsp;that&nbsp;type&nbsp;as&nbsp;its&nbsp;name,&nbsp;rather&nbsp;than&nbsp;being&nbsp;anonymous.</span><br>
<span class="lineno"></span><span class="comment" id="3264991">//</span><br>
<span class="lineno"></span><span class="comment" id="3264994">//&nbsp;The&nbsp;Go&nbsp;visibility&nbsp;rules&nbsp;for&nbsp;struct&nbsp;fields&nbsp;are&nbsp;amended&nbsp;for&nbsp;JSON&nbsp;when</span><br>
<span class="lineno">100</span><span class="comment" id="3265065">//&nbsp;deciding&nbsp;which&nbsp;field&nbsp;to&nbsp;marshal&nbsp;or&nbsp;unmarshal.&nbsp;If&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="3265127">//&nbsp;multiple&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level,&nbsp;and&nbsp;that&nbsp;level&nbsp;is&nbsp;the&nbsp;least</span><br>
<span class="lineno"></span><span class="comment" id="3265193">//&nbsp;nested&nbsp;(and&nbsp;would&nbsp;therefore&nbsp;be&nbsp;the&nbsp;nesting&nbsp;level&nbsp;selected&nbsp;by&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3265261">//&nbsp;usual&nbsp;Go&nbsp;rules),&nbsp;the&nbsp;following&nbsp;extra&nbsp;rules&nbsp;apply:</span><br>
<span class="lineno"></span><span class="comment" id="3265314">//</span><br>
<span class="lineno">105</span><span class="comment" id="3265317">//&nbsp;1)&nbsp;Of&nbsp;those&nbsp;fields,&nbsp;if&nbsp;any&nbsp;are&nbsp;JSON-tagged,&nbsp;only&nbsp;tagged&nbsp;fields&nbsp;are&nbsp;considered,</span><br>
<span class="lineno"></span><span class="comment" id="3265399">//&nbsp;even&nbsp;if&nbsp;there&nbsp;are&nbsp;multiple&nbsp;untagged&nbsp;fields&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;conflict.</span><br>
<span class="lineno"></span><span class="comment" id="3265476">//&nbsp;2)&nbsp;If&nbsp;there&nbsp;is&nbsp;exactly&nbsp;one&nbsp;field&nbsp;(tagged&nbsp;or&nbsp;not&nbsp;according&nbsp;to&nbsp;the&nbsp;first&nbsp;rule),&nbsp;that&nbsp;is&nbsp;selected.</span><br>
<span class="lineno"></span><span class="comment" id="3265575">//&nbsp;3)&nbsp;Otherwise&nbsp;there&nbsp;are&nbsp;multiple&nbsp;fields,&nbsp;and&nbsp;all&nbsp;are&nbsp;ignored;&nbsp;no&nbsp;error&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="comment" id="3265656">//</span><br>
<span class="lineno">110</span><span class="comment" id="3265659">//&nbsp;Handling&nbsp;of&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;is&nbsp;new&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span><span class="comment" id="3265716">//&nbsp;Prior&nbsp;to&nbsp;Go&nbsp;1.1,&nbsp;anonymous&nbsp;struct&nbsp;fields&nbsp;were&nbsp;ignored.&nbsp;To&nbsp;force&nbsp;ignoring&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3265795">//&nbsp;an&nbsp;anonymous&nbsp;struct&nbsp;field&nbsp;in&nbsp;both&nbsp;current&nbsp;and&nbsp;earlier&nbsp;versions,&nbsp;give&nbsp;the&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="3265877">//&nbsp;a&nbsp;JSON&nbsp;tag&nbsp;of&nbsp;&#34;-&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3265899">//</span><br>
<span class="lineno">115</span><span class="comment" id="3265902">//&nbsp;Map&nbsp;values&nbsp;encode&nbsp;as&nbsp;JSON&nbsp;objects.</span><br>
<span class="lineno"></span><span class="comment" id="3265940">//&nbsp;The&nbsp;map&#39;s&nbsp;key&nbsp;type&nbsp;must&nbsp;be&nbsp;string;&nbsp;the&nbsp;object&nbsp;keys&nbsp;are&nbsp;used&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3266012">//&nbsp;as&nbsp;map&nbsp;keys.</span><br>
<span class="lineno"></span><span class="comment" id="3266028">//</span><br>
<span class="lineno"></span><span class="comment" id="3266031">//&nbsp;Pointer&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;pointed&nbsp;to.</span><br>
<span class="lineno">120</span><span class="comment" id="3266081">//&nbsp;A&nbsp;nil&nbsp;pointer&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3266131">//</span><br>
<span class="lineno"></span><span class="comment" id="3266134">//&nbsp;Interface&nbsp;values&nbsp;encode&nbsp;as&nbsp;the&nbsp;value&nbsp;contained&nbsp;in&nbsp;the&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3266202">//&nbsp;A&nbsp;nil&nbsp;interface&nbsp;value&nbsp;encodes&nbsp;as&nbsp;the&nbsp;null&nbsp;JSON&nbsp;object.</span><br>
<span class="lineno"></span><span class="comment" id="3266260">//</span><br>
<span class="lineno">125</span><span class="comment" id="3266263">//&nbsp;Channel,&nbsp;complex,&nbsp;and&nbsp;function&nbsp;values&nbsp;cannot&nbsp;be&nbsp;encoded&nbsp;in&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="comment" id="3266331">//&nbsp;Attempting&nbsp;to&nbsp;encode&nbsp;such&nbsp;a&nbsp;value&nbsp;causes&nbsp;Marshal&nbsp;to&nbsp;return</span><br>
<span class="lineno"></span><span class="comment" id="3266393">//&nbsp;an&nbsp;UnsupportedTypeError.</span><br>
<span class="lineno"></span><span class="comment" id="3266421">//</span><br>
<span class="lineno"></span><span class="comment" id="3266424">//&nbsp;JSON&nbsp;cannot&nbsp;represent&nbsp;cyclic&nbsp;data&nbsp;structures&nbsp;and&nbsp;Marshal&nbsp;does&nbsp;not</span><br>
<span class="lineno">130</span><span class="comment" id="3266493">//&nbsp;handle&nbsp;them.&nbsp;&nbsp;Passing&nbsp;cyclic&nbsp;structures&nbsp;to&nbsp;Marshal&nbsp;will&nbsp;result&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3266562">//&nbsp;an&nbsp;infinite&nbsp;recursion.</span><br>
<span class="lineno"></span><span class="comment" id="3266588">//</span><br>
<span class="lineno"></span><span class="keyword" id="3266591">func</span>&nbsp;<span class="ident" id="3266596">Marshal</span><span class="op" id="3266603">(</span><span class="ident" id="3266604">v</span>&nbsp;<span class="keyword" id="3266606">interface</span><span class="op" id="3266615">{</span><span class="op" id="3266616">}</span><span class="op" id="3266617">)</span>&nbsp;<span class="op" id="3266619">(</span><span class="op" id="3266620">[</span><span class="op" id="3266621">]</span><span class="builtintype" id="3266622">byte</span><span class="op" id="3266626">,</span>&nbsp;<span class="builtintype" id="3266628">error</span><span class="op" id="3266633">)</span>&nbsp;<span class="op" id="3266635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3266638">e</span>&nbsp;<span class="op" id="3266640">:=</span>&nbsp;<span class="op" id="3266643">&amp;</span><span class="ident" id="3266644">encodeState</span><span class="op" id="3266655">{</span><span class="op" id="3266656">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3266659">err</span>&nbsp;<span class="op" id="3266663">:=</span>&nbsp;<span class="ident" id="3266666">e</span><span class="op" id="3266667">.</span><span class="ident" id="3266668">marshal</span><span class="op" id="3266675">(</span><span class="ident" id="3266676">v</span><span class="op" id="3266677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266680">if</span>&nbsp;<span class="ident" id="3266683">err</span>&nbsp;<span class="op" id="3266687">!=</span>&nbsp;<span class="ident" id="3266690">nil</span>&nbsp;<span class="op" id="3266694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266698">return</span>&nbsp;<span class="ident" id="3266705">nil</span><span class="op" id="3266708">,</span>&nbsp;<span class="ident" id="3266710">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3266715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266718">return</span>&nbsp;<span class="ident" id="3266725">e</span><span class="op" id="3266726">.</span><span class="ident" id="3266727">Bytes</span><span class="op" id="3266732">(</span><span class="op" id="3266733">)</span><span class="op" id="3266734">,</span>&nbsp;<span class="ident" id="3266736">nil</span><br>
<span class="lineno">140</span><span class="op" id="3266740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3266743">//&nbsp;MarshalIndent&nbsp;is&nbsp;like&nbsp;Marshal&nbsp;but&nbsp;applies&nbsp;Indent&nbsp;to&nbsp;format&nbsp;the&nbsp;output.</span><br>
<span class="lineno"></span><span class="keyword" id="3266817">func</span>&nbsp;<span class="ident" id="3266822">MarshalIndent</span><span class="op" id="3266835">(</span><span class="ident" id="3266836">v</span>&nbsp;<span class="keyword" id="3266838">interface</span><span class="op" id="3266847">{</span><span class="op" id="3266848">}</span><span class="op" id="3266849">,</span>&nbsp;<span class="ident" id="3266851">prefix</span><span class="op" id="3266857">,</span>&nbsp;<span class="ident" id="3266859">indent</span>&nbsp;<span class="builtintype" id="3266866">string</span><span class="op" id="3266872">)</span>&nbsp;<span class="op" id="3266874">(</span><span class="op" id="3266875">[</span><span class="op" id="3266876">]</span><span class="builtintype" id="3266877">byte</span><span class="op" id="3266881">,</span>&nbsp;<span class="builtintype" id="3266883">error</span><span class="op" id="3266888">)</span>&nbsp;<span class="op" id="3266890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3266893">b</span><span class="op" id="3266894">,</span>&nbsp;<span class="ident" id="3266896">err</span>&nbsp;<span class="op" id="3266900">:=</span>&nbsp;<span class="ident" id="3266903">Marshal</span><span class="op" id="3266910">(</span><span class="ident" id="3266911">v</span><span class="op" id="3266912">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266915">if</span>&nbsp;<span class="ident" id="3266918">err</span>&nbsp;<span class="op" id="3266922">!=</span>&nbsp;<span class="ident" id="3266925">nil</span>&nbsp;<span class="op" id="3266929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266933">return</span>&nbsp;<span class="ident" id="3266940">nil</span><span class="op" id="3266943">,</span>&nbsp;<span class="ident" id="3266945">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3266950">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3266953">var</span>&nbsp;<span class="ident" id="3266957">buf</span>&nbsp;<span class="ident" id="3266961">bytes</span><span class="op" id="3266966">.</span><span class="ident" id="3266967">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3266975">err</span>&nbsp;<span class="op" id="3266979">=</span>&nbsp;<span class="ident" id="3266981">Indent</span><span class="op" id="3266987">(</span><span class="op" id="3266988">&amp;</span><span class="ident" id="3266989">buf</span><span class="op" id="3266992">,</span>&nbsp;<span class="ident" id="3266994">b</span><span class="op" id="3266995">,</span>&nbsp;<span class="ident" id="3266997">prefix</span><span class="op" id="3267003">,</span>&nbsp;<span class="ident" id="3267005">indent</span><span class="op" id="3267011">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267014">if</span>&nbsp;<span class="ident" id="3267017">err</span>&nbsp;<span class="op" id="3267021">!=</span>&nbsp;<span class="ident" id="3267024">nil</span>&nbsp;<span class="op" id="3267028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267032">return</span>&nbsp;<span class="ident" id="3267039">nil</span><span class="op" id="3267042">,</span>&nbsp;<span class="ident" id="3267044">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3267049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267052">return</span>&nbsp;<span class="ident" id="3267059">buf</span><span class="op" id="3267062">.</span><span class="ident" id="3267063">Bytes</span><span class="op" id="3267068">(</span><span class="op" id="3267069">)</span><span class="op" id="3267070">,</span>&nbsp;<span class="ident" id="3267072">nil</span><br>
<span class="lineno"></span><span class="op" id="3267076">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3267079">//&nbsp;HTMLEscape&nbsp;appends&nbsp;to&nbsp;dst&nbsp;the&nbsp;JSON-encoded&nbsp;src&nbsp;with&nbsp;&lt;,&nbsp;&gt;,&nbsp;&amp;,&nbsp;U+2028&nbsp;and&nbsp;U+2029</span><br>
<span class="lineno"></span><span class="comment" id="3267161">//&nbsp;characters&nbsp;inside&nbsp;string&nbsp;literals&nbsp;changed&nbsp;to&nbsp;\u003c,&nbsp;\u003e,&nbsp;\u0026,&nbsp;\u2028,&nbsp;\u2029</span><br>
<span class="lineno"></span><span class="comment" id="3267248">//&nbsp;so&nbsp;that&nbsp;the&nbsp;JSON&nbsp;will&nbsp;be&nbsp;safe&nbsp;to&nbsp;embed&nbsp;inside&nbsp;HTML&nbsp;&lt;script&gt;&nbsp;tags.</span><br>
<span class="lineno"></span><span class="comment" id="3267317">//&nbsp;For&nbsp;historical&nbsp;reasons,&nbsp;web&nbsp;browsers&nbsp;don&#39;t&nbsp;honor&nbsp;standard&nbsp;HTML</span><br>
<span class="lineno">160</span><span class="comment" id="3267383">//&nbsp;escaping&nbsp;within&nbsp;&lt;script&gt;&nbsp;tags,&nbsp;so&nbsp;an&nbsp;alternative&nbsp;JSON&nbsp;encoding&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3267454">//&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3267466">func</span>&nbsp;<span class="ident" id="3267471">HTMLEscape</span><span class="op" id="3267481">(</span><span class="ident" id="3267482">dst</span>&nbsp;<span class="op" id="3267486">*</span><span class="ident" id="3267487">bytes</span><span class="op" id="3267492">.</span><span class="ident" id="3267493">Buffer</span><span class="op" id="3267499">,</span>&nbsp;<span class="ident" id="3267501">src</span>&nbsp;<span class="op" id="3267505">[</span><span class="op" id="3267506">]</span><span class="builtintype" id="3267507">byte</span><span class="op" id="3267511">)</span>&nbsp;<span class="op" id="3267513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3267516">//&nbsp;The&nbsp;characters&nbsp;can&nbsp;only&nbsp;appear&nbsp;in&nbsp;string&nbsp;literals,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3267571">//&nbsp;so&nbsp;just&nbsp;scan&nbsp;the&nbsp;string&nbsp;one&nbsp;byte&nbsp;at&nbsp;a&nbsp;time.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267619">start</span>&nbsp;<span class="op" id="3267625">:=</span>&nbsp;<span class="num" id="3267628">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267631">for</span>&nbsp;<span class="ident" id="3267635">i</span><span class="op" id="3267636">,</span>&nbsp;<span class="ident" id="3267638">c</span>&nbsp;<span class="op" id="3267640">:=</span>&nbsp;<span class="keyword" id="3267643">range</span>&nbsp;<span class="ident" id="3267649">src</span>&nbsp;<span class="op" id="3267653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267657">if</span>&nbsp;<span class="ident" id="3267660">c</span>&nbsp;<span class="op" id="3267662">==</span>&nbsp;<span class="string" id="3267665">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3267669">||</span>&nbsp;<span class="ident" id="3267672">c</span>&nbsp;<span class="op" id="3267674">==</span>&nbsp;<span class="string" id="3267677">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3267681">||</span>&nbsp;<span class="ident" id="3267684">c</span>&nbsp;<span class="op" id="3267686">==</span>&nbsp;<span class="string" id="3267689">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3267693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267698">if</span>&nbsp;<span class="ident" id="3267701">start</span>&nbsp;<span class="op" id="3267707">&lt;</span>&nbsp;<span class="ident" id="3267709">i</span>&nbsp;<span class="op" id="3267711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267717">dst</span><span class="op" id="3267720">.</span><span class="ident" id="3267721">Write</span><span class="op" id="3267726">(</span><span class="ident" id="3267727">src</span><span class="op" id="3267730">[</span><span class="ident" id="3267731">start</span><span class="op" id="3267736">:</span><span class="ident" id="3267737">i</span><span class="op" id="3267738">]</span><span class="op" id="3267739">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3267744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267749">dst</span><span class="op" id="3267752">.</span><span class="ident" id="3267753">WriteString</span><span class="op" id="3267764">(</span><span class="string" id="3267765">`\u00`</span><span class="op" id="3267771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267776">dst</span><span class="op" id="3267779">.</span><span class="ident" id="3267780">WriteByte</span><span class="op" id="3267789">(</span><span class="ident" id="3267790">hex</span><span class="op" id="3267793">[</span><span class="ident" id="3267794">c</span><span class="op" id="3267795">&gt;&gt;</span><span class="num" id="3267797">4</span><span class="op" id="3267798">]</span><span class="op" id="3267799">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267804">dst</span><span class="op" id="3267807">.</span><span class="ident" id="3267808">WriteByte</span><span class="op" id="3267817">(</span><span class="ident" id="3267818">hex</span><span class="op" id="3267821">[</span><span class="ident" id="3267822">c</span><span class="op" id="3267823">&amp;</span><span class="num" id="3267824">0xF</span><span class="op" id="3267827">]</span><span class="op" id="3267828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3267833">start</span>&nbsp;<span class="op" id="3267839">=</span>&nbsp;<span class="ident" id="3267841">i</span>&nbsp;<span class="op" id="3267843">+</span>&nbsp;<span class="num" id="3267845">1</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3267849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3267853">//&nbsp;Convert&nbsp;U+2028&nbsp;and&nbsp;U+2029&nbsp;(E2&nbsp;80&nbsp;A8&nbsp;and&nbsp;E2&nbsp;80&nbsp;A9).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267909">if</span>&nbsp;<span class="ident" id="3267912">c</span>&nbsp;<span class="op" id="3267914">==</span>&nbsp;<span class="num" id="3267917">0xE2</span>&nbsp;<span class="op" id="3267922">&amp;&amp;</span>&nbsp;<span class="ident" id="3267925">i</span><span class="op" id="3267926">+</span><span class="num" id="3267927">2</span>&nbsp;<span class="op" id="3267929">&lt;</span>&nbsp;<span class="builtinfunc" id="3267931">len</span><span class="op" id="3267934">(</span><span class="ident" id="3267935">src</span><span class="op" id="3267938">)</span>&nbsp;<span class="op" id="3267940">&amp;&amp;</span>&nbsp;<span class="ident" id="3267943">src</span><span class="op" id="3267946">[</span><span class="ident" id="3267947">i</span><span class="op" id="3267948">+</span><span class="num" id="3267949">1</span><span class="op" id="3267950">]</span>&nbsp;<span class="op" id="3267952">==</span>&nbsp;<span class="num" id="3267955">0x80</span>&nbsp;<span class="op" id="3267960">&amp;&amp;</span>&nbsp;<span class="ident" id="3267963">src</span><span class="op" id="3267966">[</span><span class="ident" id="3267967">i</span><span class="op" id="3267968">+</span><span class="num" id="3267969">2</span><span class="op" id="3267970">]</span><span class="op" id="3267971">&amp;^</span><span class="num" id="3267973">1</span>&nbsp;<span class="op" id="3267975">==</span>&nbsp;<span class="num" id="3267978">0xA8</span>&nbsp;<span class="op" id="3267983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3267988">if</span>&nbsp;<span class="ident" id="3267991">start</span>&nbsp;<span class="op" id="3267997">&lt;</span>&nbsp;<span class="ident" id="3267999">i</span>&nbsp;<span class="op" id="3268001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268007">dst</span><span class="op" id="3268010">.</span><span class="ident" id="3268011">Write</span><span class="op" id="3268016">(</span><span class="ident" id="3268017">src</span><span class="op" id="3268020">[</span><span class="ident" id="3268021">start</span><span class="op" id="3268026">:</span><span class="ident" id="3268027">i</span><span class="op" id="3268028">]</span><span class="op" id="3268029">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3268034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268039">dst</span><span class="op" id="3268042">.</span><span class="ident" id="3268043">WriteString</span><span class="op" id="3268054">(</span><span class="string" id="3268055">`\u202`</span><span class="op" id="3268062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268067">dst</span><span class="op" id="3268070">.</span><span class="ident" id="3268071">WriteByte</span><span class="op" id="3268080">(</span><span class="ident" id="3268081">hex</span><span class="op" id="3268084">[</span><span class="ident" id="3268085">src</span><span class="op" id="3268088">[</span><span class="ident" id="3268089">i</span><span class="op" id="3268090">+</span><span class="num" id="3268091">2</span><span class="op" id="3268092">]</span><span class="op" id="3268093">&amp;</span><span class="num" id="3268094">0xF</span><span class="op" id="3268097">]</span><span class="op" id="3268098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268103">start</span>&nbsp;<span class="op" id="3268109">=</span>&nbsp;<span class="ident" id="3268111">i</span>&nbsp;<span class="op" id="3268113">+</span>&nbsp;<span class="num" id="3268115">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3268119">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3268122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3268125">if</span>&nbsp;<span class="ident" id="3268128">start</span>&nbsp;<span class="op" id="3268134">&lt;</span>&nbsp;<span class="builtinfunc" id="3268136">len</span><span class="op" id="3268139">(</span><span class="ident" id="3268140">src</span><span class="op" id="3268143">)</span>&nbsp;<span class="op" id="3268145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268149">dst</span><span class="op" id="3268152">.</span><span class="ident" id="3268153">Write</span><span class="op" id="3268158">(</span><span class="ident" id="3268159">src</span><span class="op" id="3268162">[</span><span class="ident" id="3268163">start</span><span class="op" id="3268168">:</span><span class="op" id="3268169">]</span><span class="op" id="3268170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3268173">}</span><br>
<span class="lineno"></span><span class="op" id="3268175">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3268178">//&nbsp;Marshaler&nbsp;is&nbsp;the&nbsp;interface&nbsp;implemented&nbsp;by&nbsp;objects&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3268236">//&nbsp;can&nbsp;marshal&nbsp;themselves&nbsp;into&nbsp;valid&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="3268279">type</span>&nbsp;<span class="ident" id="3268284">Marshaler</span>&nbsp;<span class="keyword" id="3268294">interface</span>&nbsp;<span class="op" id="3268304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268307">MarshalJSON</span><span class="op" id="3268318">(</span><span class="op" id="3268319">)</span>&nbsp;<span class="op" id="3268321">(</span><span class="op" id="3268322">[</span><span class="op" id="3268323">]</span><span class="builtintype" id="3268324">byte</span><span class="op" id="3268328">,</span>&nbsp;<span class="builtintype" id="3268330">error</span><span class="op" id="3268335">)</span><br>
<span class="lineno">195</span><span class="op" id="3268337">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3268340">//&nbsp;An&nbsp;UnsupportedTypeError&nbsp;is&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when&nbsp;attempting</span><br>
<span class="lineno"></span><span class="comment" id="3268406">//&nbsp;to&nbsp;encode&nbsp;an&nbsp;unsupported&nbsp;value&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3268446">type</span>&nbsp;<span class="ident" id="3268451">UnsupportedTypeError</span>&nbsp;<span class="keyword" id="3268472">struct</span>&nbsp;<span class="op" id="3268479">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268482">Type</span>&nbsp;<span class="ident" id="3268487">reflect</span><span class="op" id="3268494">.</span><span class="ident" id="3268495">Type</span><br>
<span class="lineno"></span><span class="op" id="3268500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3268503">func</span>&nbsp;<span class="op" id="3268508">(</span><span class="ident" id="3268509">e</span>&nbsp;<span class="op" id="3268511">*</span><span class="ident" id="3268512">UnsupportedTypeError</span><span class="op" id="3268532">)</span>&nbsp;<span class="ident" id="3268534">Error</span><span class="op" id="3268539">(</span><span class="op" id="3268540">)</span>&nbsp;<span class="builtintype" id="3268542">string</span>&nbsp;<span class="op" id="3268549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3268552">return</span>&nbsp;<span class="string" id="3268559">&#34;json:&nbsp;unsupported&nbsp;type:&nbsp;&#34;</span>&nbsp;<span class="op" id="3268586">+</span>&nbsp;<span class="ident" id="3268588">e</span><span class="op" id="3268589">.</span><span class="ident" id="3268590">Type</span><span class="op" id="3268594">.</span><span class="ident" id="3268595">String</span><span class="op" id="3268601">(</span><span class="op" id="3268602">)</span><br>
<span class="lineno">205</span><span class="op" id="3268604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3268607">type</span>&nbsp;<span class="ident" id="3268612">UnsupportedValueError</span>&nbsp;<span class="keyword" id="3268634">struct</span>&nbsp;<span class="op" id="3268641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268644">Value</span>&nbsp;<span class="ident" id="3268650">reflect</span><span class="op" id="3268657">.</span><span class="ident" id="3268658">Value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3268665">Str</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3268671">string</span><br>
<span class="lineno">210</span><span class="op" id="3268678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3268681">func</span>&nbsp;<span class="op" id="3268686">(</span><span class="ident" id="3268687">e</span>&nbsp;<span class="op" id="3268689">*</span><span class="ident" id="3268690">UnsupportedValueError</span><span class="op" id="3268711">)</span>&nbsp;<span class="ident" id="3268713">Error</span><span class="op" id="3268718">(</span><span class="op" id="3268719">)</span>&nbsp;<span class="builtintype" id="3268721">string</span>&nbsp;<span class="op" id="3268728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3268731">return</span>&nbsp;<span class="string" id="3268738">&#34;json:&nbsp;unsupported&nbsp;value:&nbsp;&#34;</span>&nbsp;<span class="op" id="3268766">+</span>&nbsp;<span class="ident" id="3268768">e</span><span class="op" id="3268769">.</span><span class="ident" id="3268770">Str</span><br>
<span class="lineno"></span><span class="op" id="3268774">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="3268777">//&nbsp;Before&nbsp;Go&nbsp;1.2,&nbsp;an&nbsp;InvalidUTF8Error&nbsp;was&nbsp;returned&nbsp;by&nbsp;Marshal&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="3268844">//&nbsp;attempting&nbsp;to&nbsp;encode&nbsp;a&nbsp;string&nbsp;value&nbsp;with&nbsp;invalid&nbsp;UTF-8&nbsp;sequences.</span><br>
<span class="lineno"></span><span class="comment" id="3268913">//&nbsp;As&nbsp;of&nbsp;Go&nbsp;1.2,&nbsp;Marshal&nbsp;instead&nbsp;coerces&nbsp;the&nbsp;string&nbsp;to&nbsp;valid&nbsp;UTF-8&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3268983">//&nbsp;replacing&nbsp;invalid&nbsp;bytes&nbsp;with&nbsp;the&nbsp;Unicode&nbsp;replacement&nbsp;rune&nbsp;U+FFFD.</span><br>
<span class="lineno">220</span><span class="comment" id="3269052">//&nbsp;This&nbsp;error&nbsp;is&nbsp;no&nbsp;longer&nbsp;generated&nbsp;but&nbsp;is&nbsp;kept&nbsp;for&nbsp;backwards&nbsp;compatibility</span><br>
<span class="lineno"></span><span class="comment" id="3269129">//&nbsp;with&nbsp;programs&nbsp;that&nbsp;might&nbsp;mention&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="3269169">type</span>&nbsp;<span class="ident" id="3269174">InvalidUTF8Error</span>&nbsp;<span class="keyword" id="3269191">struct</span>&nbsp;<span class="op" id="3269198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269201">S</span>&nbsp;<span class="builtintype" id="3269203">string</span>&nbsp;<span class="comment" id="3269210">//&nbsp;the&nbsp;whole&nbsp;string&nbsp;value&nbsp;that&nbsp;caused&nbsp;the&nbsp;error</span><br>
<span class="lineno"></span><span class="op" id="3269258">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3269261">func</span>&nbsp;<span class="op" id="3269266">(</span><span class="ident" id="3269267">e</span>&nbsp;<span class="op" id="3269269">*</span><span class="ident" id="3269270">InvalidUTF8Error</span><span class="op" id="3269286">)</span>&nbsp;<span class="ident" id="3269288">Error</span><span class="op" id="3269293">(</span><span class="op" id="3269294">)</span>&nbsp;<span class="builtintype" id="3269296">string</span>&nbsp;<span class="op" id="3269303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269306">return</span>&nbsp;<span class="string" id="3269313">&#34;json:&nbsp;invalid&nbsp;UTF-8&nbsp;in&nbsp;string:&nbsp;&#34;</span>&nbsp;<span class="op" id="3269347">+</span>&nbsp;<span class="ident" id="3269349">strconv</span><span class="op" id="3269356">.</span><span class="ident" id="3269357">Quote</span><span class="op" id="3269362">(</span><span class="ident" id="3269363">e</span><span class="op" id="3269364">.</span><span class="ident" id="3269365">S</span><span class="op" id="3269366">)</span><br>
<span class="lineno"></span><span class="op" id="3269368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="keyword" id="3269371">type</span>&nbsp;<span class="ident" id="3269376">MarshalerError</span>&nbsp;<span class="keyword" id="3269391">struct</span>&nbsp;<span class="op" id="3269398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269401">Type</span>&nbsp;<span class="ident" id="3269406">reflect</span><span class="op" id="3269413">.</span><span class="ident" id="3269414">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269420">Err</span>&nbsp;&nbsp;<span class="builtintype" id="3269425">error</span><br>
<span class="lineno"></span><span class="op" id="3269431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span><span class="keyword" id="3269434">func</span>&nbsp;<span class="op" id="3269439">(</span><span class="ident" id="3269440">e</span>&nbsp;<span class="op" id="3269442">*</span><span class="ident" id="3269443">MarshalerError</span><span class="op" id="3269457">)</span>&nbsp;<span class="ident" id="3269459">Error</span><span class="op" id="3269464">(</span><span class="op" id="3269465">)</span>&nbsp;<span class="builtintype" id="3269467">string</span>&nbsp;<span class="op" id="3269474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269477">return</span>&nbsp;<span class="string" id="3269484">&#34;json:&nbsp;error&nbsp;calling&nbsp;MarshalJSON&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3269528">+</span>&nbsp;<span class="ident" id="3269530">e</span><span class="op" id="3269531">.</span><span class="ident" id="3269532">Type</span><span class="op" id="3269536">.</span><span class="ident" id="3269537">String</span><span class="op" id="3269543">(</span><span class="op" id="3269544">)</span>&nbsp;<span class="op" id="3269546">+</span>&nbsp;<span class="string" id="3269548">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="3269553">+</span>&nbsp;<span class="ident" id="3269555">e</span><span class="op" id="3269556">.</span><span class="ident" id="3269557">Err</span><span class="op" id="3269560">.</span><span class="ident" id="3269561">Error</span><span class="op" id="3269566">(</span><span class="op" id="3269567">)</span><br>
<span class="lineno"></span><span class="op" id="3269569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3269572">var</span>&nbsp;<span class="ident" id="3269576">hex</span>&nbsp;<span class="op" id="3269580">=</span>&nbsp;<span class="string" id="3269582">&#34;0123456789abcdef&#34;</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span><span class="comment" id="3269602">//&nbsp;An&nbsp;encodeState&nbsp;encodes&nbsp;JSON&nbsp;into&nbsp;a&nbsp;bytes.Buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3269654">type</span>&nbsp;<span class="ident" id="3269659">encodeState</span>&nbsp;<span class="keyword" id="3269671">struct</span>&nbsp;<span class="op" id="3269678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269681">bytes</span><span class="op" id="3269686">.</span><span class="ident" id="3269687">Buffer</span>&nbsp;<span class="comment" id="3269694">//&nbsp;accumulated&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269717">scratch</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3269730">[</span><span class="num" id="3269731">64</span><span class="op" id="3269733">]</span><span class="builtintype" id="3269734">byte</span><br>
<span class="lineno">245</span><span class="op" id="3269739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3269742">var</span>&nbsp;<span class="ident" id="3269746">encodeStatePool</span>&nbsp;<span class="ident" id="3269762">sync</span><span class="op" id="3269766">.</span><span class="ident" id="3269767">Pool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3269773">func</span>&nbsp;<span class="ident" id="3269778">newEncodeState</span><span class="op" id="3269792">(</span><span class="op" id="3269793">)</span>&nbsp;<span class="op" id="3269795">*</span><span class="ident" id="3269796">encodeState</span>&nbsp;<span class="op" id="3269808">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269811">if</span>&nbsp;<span class="ident" id="3269814">v</span>&nbsp;<span class="op" id="3269816">:=</span>&nbsp;<span class="ident" id="3269819">encodeStatePool</span><span class="op" id="3269834">.</span><span class="ident" id="3269835">Get</span><span class="op" id="3269838">(</span><span class="op" id="3269839">)</span><span class="op" id="3269840">;</span>&nbsp;<span class="ident" id="3269842">v</span>&nbsp;<span class="op" id="3269844">!=</span>&nbsp;<span class="ident" id="3269847">nil</span>&nbsp;<span class="op" id="3269851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269855">e</span>&nbsp;<span class="op" id="3269857">:=</span>&nbsp;<span class="ident" id="3269860">v</span><span class="op" id="3269861">.</span><span class="op" id="3269862">(</span><span class="op" id="3269863">*</span><span class="ident" id="3269864">encodeState</span><span class="op" id="3269875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3269879">e</span><span class="op" id="3269880">.</span><span class="ident" id="3269881">Reset</span><span class="op" id="3269886">(</span><span class="op" id="3269887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269891">return</span>&nbsp;<span class="ident" id="3269898">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3269901">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269904">return</span>&nbsp;<span class="builtinfunc" id="3269911">new</span><span class="op" id="3269914">(</span><span class="ident" id="3269915">encodeState</span><span class="op" id="3269926">)</span><br>
<span class="lineno"></span><span class="op" id="3269928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3269931">func</span>&nbsp;<span class="op" id="3269936">(</span><span class="ident" id="3269937">e</span>&nbsp;<span class="op" id="3269939">*</span><span class="ident" id="3269940">encodeState</span><span class="op" id="3269951">)</span>&nbsp;<span class="ident" id="3269953">marshal</span><span class="op" id="3269960">(</span><span class="ident" id="3269961">v</span>&nbsp;<span class="keyword" id="3269963">interface</span><span class="op" id="3269972">{</span><span class="op" id="3269973">}</span><span class="op" id="3269974">)</span>&nbsp;<span class="op" id="3269976">(</span><span class="ident" id="3269977">err</span>&nbsp;<span class="builtintype" id="3269981">error</span><span class="op" id="3269986">)</span>&nbsp;<span class="op" id="3269988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3269991">defer</span>&nbsp;<span class="keyword" id="3269997">func</span><span class="op" id="3270001">(</span><span class="op" id="3270002">)</span>&nbsp;<span class="op" id="3270004">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270008">if</span>&nbsp;<span class="ident" id="3270011">r</span>&nbsp;<span class="op" id="3270013">:=</span>&nbsp;<span class="builtinfunc" id="3270016">recover</span><span class="op" id="3270023">(</span><span class="op" id="3270024">)</span><span class="op" id="3270025">;</span>&nbsp;<span class="ident" id="3270027">r</span>&nbsp;<span class="op" id="3270029">!=</span>&nbsp;<span class="ident" id="3270032">nil</span>&nbsp;<span class="op" id="3270036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270041">if</span>&nbsp;<span class="ident" id="3270044">_</span><span class="op" id="3270045">,</span>&nbsp;<span class="ident" id="3270047">ok</span>&nbsp;<span class="op" id="3270050">:=</span>&nbsp;<span class="ident" id="3270053">r</span><span class="op" id="3270054">.</span><span class="op" id="3270055">(</span><span class="ident" id="3270056">runtime</span><span class="op" id="3270063">.</span><span class="ident" id="3270064">Error</span><span class="op" id="3270069">)</span><span class="op" id="3270070">;</span>&nbsp;<span class="ident" id="3270072">ok</span>&nbsp;<span class="op" id="3270075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3270081">panic</span><span class="op" id="3270086">(</span><span class="ident" id="3270087">r</span><span class="op" id="3270088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3270093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270098">if</span>&nbsp;<span class="ident" id="3270101">s</span><span class="op" id="3270102">,</span>&nbsp;<span class="ident" id="3270104">ok</span>&nbsp;<span class="op" id="3270107">:=</span>&nbsp;<span class="ident" id="3270110">r</span><span class="op" id="3270111">.</span><span class="op" id="3270112">(</span><span class="builtintype" id="3270113">string</span><span class="op" id="3270119">)</span><span class="op" id="3270120">;</span>&nbsp;<span class="ident" id="3270122">ok</span>&nbsp;<span class="op" id="3270125">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3270131">panic</span><span class="op" id="3270136">(</span><span class="ident" id="3270137">s</span><span class="op" id="3270138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3270143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3270148">err</span>&nbsp;<span class="op" id="3270152">=</span>&nbsp;<span class="ident" id="3270154">r</span><span class="op" id="3270155">.</span><span class="op" id="3270156">(</span><span class="builtintype" id="3270157">error</span><span class="op" id="3270162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3270166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3270169">}</span><span class="op" id="3270170">(</span><span class="op" id="3270171">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3270174">e</span><span class="op" id="3270175">.</span><span class="ident" id="3270176">reflectValue</span><span class="op" id="3270188">(</span><span class="ident" id="3270189">reflect</span><span class="op" id="3270196">.</span><span class="ident" id="3270197">ValueOf</span><span class="op" id="3270204">(</span><span class="ident" id="3270205">v</span><span class="op" id="3270206">)</span><span class="op" id="3270207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270210">return</span>&nbsp;<span class="ident" id="3270217">nil</span><br>
<span class="lineno"></span><span class="op" id="3270221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3270224">func</span>&nbsp;<span class="op" id="3270229">(</span><span class="ident" id="3270230">e</span>&nbsp;<span class="op" id="3270232">*</span><span class="ident" id="3270233">encodeState</span><span class="op" id="3270244">)</span>&nbsp;<span class="builtintype" id="3270246">error</span><span class="op" id="3270251">(</span><span class="ident" id="3270252">err</span>&nbsp;<span class="builtintype" id="3270256">error</span><span class="op" id="3270261">)</span>&nbsp;<span class="op" id="3270263">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3270266">panic</span><span class="op" id="3270271">(</span><span class="ident" id="3270272">err</span><span class="op" id="3270275">)</span><br>
<span class="lineno"></span><span class="op" id="3270277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3270280">var</span>&nbsp;<span class="ident" id="3270284">byteSliceType</span>&nbsp;<span class="op" id="3270298">=</span>&nbsp;<span class="ident" id="3270300">reflect</span><span class="op" id="3270307">.</span><span class="ident" id="3270308">TypeOf</span><span class="op" id="3270314">(</span><span class="op" id="3270315">[</span><span class="op" id="3270316">]</span><span class="builtintype" id="3270317">byte</span><span class="op" id="3270321">(</span><span class="ident" id="3270322">nil</span><span class="op" id="3270325">)</span><span class="op" id="3270326">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="keyword" id="3270329">func</span>&nbsp;<span class="ident" id="3270334">isEmptyValue</span><span class="op" id="3270346">(</span><span class="ident" id="3270347">v</span>&nbsp;<span class="ident" id="3270349">reflect</span><span class="op" id="3270356">.</span><span class="ident" id="3270357">Value</span><span class="op" id="3270362">)</span>&nbsp;<span class="builtintype" id="3270364">bool</span>&nbsp;<span class="op" id="3270369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270372">switch</span>&nbsp;<span class="ident" id="3270379">v</span><span class="op" id="3270380">.</span><span class="ident" id="3270381">Kind</span><span class="op" id="3270385">(</span><span class="op" id="3270386">)</span>&nbsp;<span class="op" id="3270388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270391">case</span>&nbsp;<span class="ident" id="3270396">reflect</span><span class="op" id="3270403">.</span><span class="ident" id="3270404">Array</span><span class="op" id="3270409">,</span>&nbsp;<span class="ident" id="3270411">reflect</span><span class="op" id="3270418">.</span><span class="ident" id="3270419">Map</span><span class="op" id="3270422">,</span>&nbsp;<span class="ident" id="3270424">reflect</span><span class="op" id="3270431">.</span><span class="ident" id="3270432">Slice</span><span class="op" id="3270437">,</span>&nbsp;<span class="ident" id="3270439">reflect</span><span class="op" id="3270446">.</span><span class="ident" id="3270447">String</span><span class="op" id="3270453">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270457">return</span>&nbsp;<span class="ident" id="3270464">v</span><span class="op" id="3270465">.</span><span class="ident" id="3270466">Len</span><span class="op" id="3270469">(</span><span class="op" id="3270470">)</span>&nbsp;<span class="op" id="3270472">==</span>&nbsp;<span class="num" id="3270475">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270478">case</span>&nbsp;<span class="ident" id="3270483">reflect</span><span class="op" id="3270490">.</span><span class="ident" id="3270491">Bool</span><span class="op" id="3270495">:</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270499">return</span>&nbsp;<span class="op" id="3270506">!</span><span class="ident" id="3270507">v</span><span class="op" id="3270508">.</span><span class="ident" id="3270509">Bool</span><span class="op" id="3270513">(</span><span class="op" id="3270514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270517">case</span>&nbsp;<span class="ident" id="3270522">reflect</span><span class="op" id="3270529">.</span><span class="ident" id="3270530">Int</span><span class="op" id="3270533">,</span>&nbsp;<span class="ident" id="3270535">reflect</span><span class="op" id="3270542">.</span><span class="ident" id="3270543">Int8</span><span class="op" id="3270547">,</span>&nbsp;<span class="ident" id="3270549">reflect</span><span class="op" id="3270556">.</span><span class="ident" id="3270557">Int16</span><span class="op" id="3270562">,</span>&nbsp;<span class="ident" id="3270564">reflect</span><span class="op" id="3270571">.</span><span class="ident" id="3270572">Int32</span><span class="op" id="3270577">,</span>&nbsp;<span class="ident" id="3270579">reflect</span><span class="op" id="3270586">.</span><span class="ident" id="3270587">Int64</span><span class="op" id="3270592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270596">return</span>&nbsp;<span class="ident" id="3270603">v</span><span class="op" id="3270604">.</span><span class="ident" id="3270605">Int</span><span class="op" id="3270608">(</span><span class="op" id="3270609">)</span>&nbsp;<span class="op" id="3270611">==</span>&nbsp;<span class="num" id="3270614">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270617">case</span>&nbsp;<span class="ident" id="3270622">reflect</span><span class="op" id="3270629">.</span><span class="ident" id="3270630">Uint</span><span class="op" id="3270634">,</span>&nbsp;<span class="ident" id="3270636">reflect</span><span class="op" id="3270643">.</span><span class="ident" id="3270644">Uint8</span><span class="op" id="3270649">,</span>&nbsp;<span class="ident" id="3270651">reflect</span><span class="op" id="3270658">.</span><span class="ident" id="3270659">Uint16</span><span class="op" id="3270665">,</span>&nbsp;<span class="ident" id="3270667">reflect</span><span class="op" id="3270674">.</span><span class="ident" id="3270675">Uint32</span><span class="op" id="3270681">,</span>&nbsp;<span class="ident" id="3270683">reflect</span><span class="op" id="3270690">.</span><span class="ident" id="3270691">Uint64</span><span class="op" id="3270697">,</span>&nbsp;<span class="ident" id="3270699">reflect</span><span class="op" id="3270706">.</span><span class="ident" id="3270707">Uintptr</span><span class="op" id="3270714">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270718">return</span>&nbsp;<span class="ident" id="3270725">v</span><span class="op" id="3270726">.</span><span class="ident" id="3270727">Uint</span><span class="op" id="3270731">(</span><span class="op" id="3270732">)</span>&nbsp;<span class="op" id="3270734">==</span>&nbsp;<span class="num" id="3270737">0</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270740">case</span>&nbsp;<span class="ident" id="3270745">reflect</span><span class="op" id="3270752">.</span><span class="ident" id="3270753">Float32</span><span class="op" id="3270760">,</span>&nbsp;<span class="ident" id="3270762">reflect</span><span class="op" id="3270769">.</span><span class="ident" id="3270770">Float64</span><span class="op" id="3270777">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270781">return</span>&nbsp;<span class="ident" id="3270788">v</span><span class="op" id="3270789">.</span><span class="ident" id="3270790">Float</span><span class="op" id="3270795">(</span><span class="op" id="3270796">)</span>&nbsp;<span class="op" id="3270798">==</span>&nbsp;<span class="num" id="3270801">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270804">case</span>&nbsp;<span class="ident" id="3270809">reflect</span><span class="op" id="3270816">.</span><span class="ident" id="3270817">Interface</span><span class="op" id="3270826">,</span>&nbsp;<span class="ident" id="3270828">reflect</span><span class="op" id="3270835">.</span><span class="ident" id="3270836">Ptr</span><span class="op" id="3270839">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270843">return</span>&nbsp;<span class="ident" id="3270850">v</span><span class="op" id="3270851">.</span><span class="ident" id="3270852">IsNil</span><span class="op" id="3270857">(</span><span class="op" id="3270858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3270861">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3270864">return</span>&nbsp;<span class="builtintype" id="3270871">false</span><br>
<span class="lineno"></span><span class="op" id="3270877">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3270880">func</span>&nbsp;<span class="op" id="3270885">(</span><span class="ident" id="3270886">e</span>&nbsp;<span class="op" id="3270888">*</span><span class="ident" id="3270889">encodeState</span><span class="op" id="3270900">)</span>&nbsp;<span class="ident" id="3270902">reflectValue</span><span class="op" id="3270914">(</span><span class="ident" id="3270915">v</span>&nbsp;<span class="ident" id="3270917">reflect</span><span class="op" id="3270924">.</span><span class="ident" id="3270925">Value</span><span class="op" id="3270930">)</span>&nbsp;<span class="op" id="3270932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3270935">valueEncoder</span><span class="op" id="3270947">(</span><span class="ident" id="3270948">v</span><span class="op" id="3270949">)</span><span class="op" id="3270950">(</span><span class="ident" id="3270951">e</span><span class="op" id="3270952">,</span>&nbsp;<span class="ident" id="3270954">v</span><span class="op" id="3270955">,</span>&nbsp;<span class="builtintype" id="3270957">false</span><span class="op" id="3270962">)</span><br>
<span class="lineno">300</span><span class="op" id="3270964">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3270967">type</span>&nbsp;<span class="ident" id="3270972">encoderFunc</span>&nbsp;<span class="keyword" id="3270984">func</span><span class="op" id="3270988">(</span><span class="ident" id="3270989">e</span>&nbsp;<span class="op" id="3270991">*</span><span class="ident" id="3270992">encodeState</span><span class="op" id="3271003">,</span>&nbsp;<span class="ident" id="3271005">v</span>&nbsp;<span class="ident" id="3271007">reflect</span><span class="op" id="3271014">.</span><span class="ident" id="3271015">Value</span><span class="op" id="3271020">,</span>&nbsp;<span class="ident" id="3271022">quoted</span>&nbsp;<span class="builtintype" id="3271029">bool</span><span class="op" id="3271033">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3271036">var</span>&nbsp;<span class="ident" id="3271040">encoderCache</span>&nbsp;<span class="keyword" id="3271053">struct</span>&nbsp;<span class="op" id="3271060">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271063">sync</span><span class="op" id="3271067">.</span><span class="ident" id="3271068">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271077">m</span>&nbsp;<span class="keyword" id="3271079">map</span><span class="op" id="3271082">[</span><span class="ident" id="3271083">reflect</span><span class="op" id="3271090">.</span><span class="ident" id="3271091">Type</span><span class="op" id="3271095">]</span><span class="ident" id="3271096">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3271108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3271111">func</span>&nbsp;<span class="ident" id="3271116">valueEncoder</span><span class="op" id="3271128">(</span><span class="ident" id="3271129">v</span>&nbsp;<span class="ident" id="3271131">reflect</span><span class="op" id="3271138">.</span><span class="ident" id="3271139">Value</span><span class="op" id="3271144">)</span>&nbsp;<span class="ident" id="3271146">encoderFunc</span>&nbsp;<span class="op" id="3271158">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271161">if</span>&nbsp;<span class="op" id="3271164">!</span><span class="ident" id="3271165">v</span><span class="op" id="3271166">.</span><span class="ident" id="3271167">IsValid</span><span class="op" id="3271174">(</span><span class="op" id="3271175">)</span>&nbsp;<span class="op" id="3271177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271181">return</span>&nbsp;<span class="ident" id="3271188">invalidValueEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3271209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271212">return</span>&nbsp;<span class="ident" id="3271219">typeEncoder</span><span class="op" id="3271230">(</span><span class="ident" id="3271231">v</span><span class="op" id="3271232">.</span><span class="ident" id="3271233">Type</span><span class="op" id="3271237">(</span><span class="op" id="3271238">)</span><span class="op" id="3271239">)</span><br>
<span class="lineno"></span><span class="op" id="3271241">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span><span class="keyword" id="3271244">func</span>&nbsp;<span class="ident" id="3271249">typeEncoder</span><span class="op" id="3271260">(</span><span class="ident" id="3271261">t</span>&nbsp;<span class="ident" id="3271263">reflect</span><span class="op" id="3271270">.</span><span class="ident" id="3271271">Type</span><span class="op" id="3271275">)</span>&nbsp;<span class="ident" id="3271277">encoderFunc</span>&nbsp;<span class="op" id="3271289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271292">encoderCache</span><span class="op" id="3271304">.</span><span class="ident" id="3271305">RLock</span><span class="op" id="3271310">(</span><span class="op" id="3271311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271314">f</span>&nbsp;<span class="op" id="3271316">:=</span>&nbsp;<span class="ident" id="3271319">encoderCache</span><span class="op" id="3271331">.</span><span class="ident" id="3271332">m</span><span class="op" id="3271333">[</span><span class="ident" id="3271334">t</span><span class="op" id="3271335">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271338">encoderCache</span><span class="op" id="3271350">.</span><span class="ident" id="3271351">RUnlock</span><span class="op" id="3271358">(</span><span class="op" id="3271359">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271362">if</span>&nbsp;<span class="ident" id="3271365">f</span>&nbsp;<span class="op" id="3271367">!=</span>&nbsp;<span class="ident" id="3271370">nil</span>&nbsp;<span class="op" id="3271374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271378">return</span>&nbsp;<span class="ident" id="3271385">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3271388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271392">//&nbsp;To&nbsp;deal&nbsp;with&nbsp;recursive&nbsp;types,&nbsp;populate&nbsp;the&nbsp;map&nbsp;with&nbsp;an</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271451">//&nbsp;indirect&nbsp;func&nbsp;before&nbsp;we&nbsp;build&nbsp;it.&nbsp;This&nbsp;type&nbsp;waits&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271512">//&nbsp;real&nbsp;func&nbsp;(f)&nbsp;to&nbsp;be&nbsp;ready&nbsp;and&nbsp;then&nbsp;calls&nbsp;it.&nbsp;&nbsp;This&nbsp;indirect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271576">//&nbsp;func&nbsp;is&nbsp;only&nbsp;used&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271619">encoderCache</span><span class="op" id="3271631">.</span><span class="ident" id="3271632">Lock</span><span class="op" id="3271636">(</span><span class="op" id="3271637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271640">if</span>&nbsp;<span class="ident" id="3271643">encoderCache</span><span class="op" id="3271655">.</span><span class="ident" id="3271656">m</span>&nbsp;<span class="op" id="3271658">==</span>&nbsp;<span class="ident" id="3271661">nil</span>&nbsp;<span class="op" id="3271665">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271669">encoderCache</span><span class="op" id="3271681">.</span><span class="ident" id="3271682">m</span>&nbsp;<span class="op" id="3271684">=</span>&nbsp;<span class="builtinfunc" id="3271686">make</span><span class="op" id="3271690">(</span><span class="keyword" id="3271691">map</span><span class="op" id="3271694">[</span><span class="ident" id="3271695">reflect</span><span class="op" id="3271702">.</span><span class="ident" id="3271703">Type</span><span class="op" id="3271707">]</span><span class="ident" id="3271708">encoderFunc</span><span class="op" id="3271719">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3271722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3271725">var</span>&nbsp;<span class="ident" id="3271729">wg</span>&nbsp;<span class="ident" id="3271732">sync</span><span class="op" id="3271736">.</span><span class="ident" id="3271737">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271748">wg</span><span class="op" id="3271750">.</span><span class="ident" id="3271751">Add</span><span class="op" id="3271754">(</span><span class="num" id="3271755">1</span><span class="op" id="3271756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271759">encoderCache</span><span class="op" id="3271771">.</span><span class="ident" id="3271772">m</span><span class="op" id="3271773">[</span><span class="ident" id="3271774">t</span><span class="op" id="3271775">]</span>&nbsp;<span class="op" id="3271777">=</span>&nbsp;<span class="keyword" id="3271779">func</span><span class="op" id="3271783">(</span><span class="ident" id="3271784">e</span>&nbsp;<span class="op" id="3271786">*</span><span class="ident" id="3271787">encodeState</span><span class="op" id="3271798">,</span>&nbsp;<span class="ident" id="3271800">v</span>&nbsp;<span class="ident" id="3271802">reflect</span><span class="op" id="3271809">.</span><span class="ident" id="3271810">Value</span><span class="op" id="3271815">,</span>&nbsp;<span class="ident" id="3271817">quoted</span>&nbsp;<span class="builtintype" id="3271824">bool</span><span class="op" id="3271828">)</span>&nbsp;<span class="op" id="3271830">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271834">wg</span><span class="op" id="3271836">.</span><span class="ident" id="3271837">Wait</span><span class="op" id="3271841">(</span><span class="op" id="3271842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271846">f</span><span class="op" id="3271847">(</span><span class="ident" id="3271848">e</span><span class="op" id="3271849">,</span>&nbsp;<span class="ident" id="3271851">v</span><span class="op" id="3271852">,</span>&nbsp;<span class="ident" id="3271854">quoted</span><span class="op" id="3271860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3271863">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271866">encoderCache</span><span class="op" id="3271878">.</span><span class="ident" id="3271879">Unlock</span><span class="op" id="3271885">(</span><span class="op" id="3271886">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271890">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3271923">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3271990">f</span>&nbsp;<span class="op" id="3271992">=</span>&nbsp;<span class="ident" id="3271994">newTypeEncoder</span><span class="op" id="3272008">(</span><span class="ident" id="3272009">t</span><span class="op" id="3272010">,</span>&nbsp;<span class="builtintype" id="3272012">true</span><span class="op" id="3272016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272019">wg</span><span class="op" id="3272021">.</span><span class="ident" id="3272022">Done</span><span class="op" id="3272026">(</span><span class="op" id="3272027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272030">encoderCache</span><span class="op" id="3272042">.</span><span class="ident" id="3272043">Lock</span><span class="op" id="3272047">(</span><span class="op" id="3272048">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272051">encoderCache</span><span class="op" id="3272063">.</span><span class="ident" id="3272064">m</span><span class="op" id="3272065">[</span><span class="ident" id="3272066">t</span><span class="op" id="3272067">]</span>&nbsp;<span class="op" id="3272069">=</span>&nbsp;<span class="ident" id="3272071">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272074">encoderCache</span><span class="op" id="3272086">.</span><span class="ident" id="3272087">Unlock</span><span class="op" id="3272093">(</span><span class="op" id="3272094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272097">return</span>&nbsp;<span class="ident" id="3272104">f</span><br>
<span class="lineno"></span><span class="op" id="3272106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="3272109">var</span>&nbsp;<span class="op" id="3272113">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272116">marshalerType</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3272134">=</span>&nbsp;<span class="ident" id="3272136">reflect</span><span class="op" id="3272143">.</span><span class="ident" id="3272144">TypeOf</span><span class="op" id="3272150">(</span><span class="builtinfunc" id="3272151">new</span><span class="op" id="3272154">(</span><span class="ident" id="3272155">Marshaler</span><span class="op" id="3272164">)</span><span class="op" id="3272165">)</span><span class="op" id="3272166">.</span><span class="ident" id="3272167">Elem</span><span class="op" id="3272171">(</span><span class="op" id="3272172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3272175">textMarshalerType</span>&nbsp;<span class="op" id="3272193">=</span>&nbsp;<span class="ident" id="3272195">reflect</span><span class="op" id="3272202">.</span><span class="ident" id="3272203">TypeOf</span><span class="op" id="3272209">(</span><span class="builtinfunc" id="3272210">new</span><span class="op" id="3272213">(</span><span class="ident" id="3272214">encoding</span><span class="op" id="3272222">.</span><span class="ident" id="3272223">TextMarshaler</span><span class="op" id="3272236">)</span><span class="op" id="3272237">)</span><span class="op" id="3272238">.</span><span class="ident" id="3272239">Elem</span><span class="op" id="3272243">(</span><span class="op" id="3272244">)</span><br>
<span class="lineno"></span><span class="op" id="3272246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span><span class="comment" id="3272249">//&nbsp;newTypeEncoder&nbsp;constructs&nbsp;an&nbsp;encoderFunc&nbsp;for&nbsp;a&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3272305">//&nbsp;The&nbsp;returned&nbsp;encoder&nbsp;only&nbsp;checks&nbsp;CanAddr&nbsp;when&nbsp;allowAddr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="3272373">func</span>&nbsp;<span class="ident" id="3272378">newTypeEncoder</span><span class="op" id="3272392">(</span><span class="ident" id="3272393">t</span>&nbsp;<span class="ident" id="3272395">reflect</span><span class="op" id="3272402">.</span><span class="ident" id="3272403">Type</span><span class="op" id="3272407">,</span>&nbsp;<span class="ident" id="3272409">allowAddr</span>&nbsp;<span class="builtintype" id="3272419">bool</span><span class="op" id="3272423">)</span>&nbsp;<span class="ident" id="3272425">encoderFunc</span>&nbsp;<span class="op" id="3272437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272440">if</span>&nbsp;<span class="ident" id="3272443">t</span><span class="op" id="3272444">.</span><span class="ident" id="3272445">Implements</span><span class="op" id="3272455">(</span><span class="ident" id="3272456">marshalerType</span><span class="op" id="3272469">)</span>&nbsp;<span class="op" id="3272471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272475">return</span>&nbsp;<span class="ident" id="3272482">marshalerEncoder</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272503">if</span>&nbsp;<span class="ident" id="3272506">t</span><span class="op" id="3272507">.</span><span class="ident" id="3272508">Kind</span><span class="op" id="3272512">(</span><span class="op" id="3272513">)</span>&nbsp;<span class="op" id="3272515">!=</span>&nbsp;<span class="ident" id="3272518">reflect</span><span class="op" id="3272525">.</span><span class="ident" id="3272526">Ptr</span>&nbsp;<span class="op" id="3272530">&amp;&amp;</span>&nbsp;<span class="ident" id="3272533">allowAddr</span>&nbsp;<span class="op" id="3272543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272547">if</span>&nbsp;<span class="ident" id="3272550">reflect</span><span class="op" id="3272557">.</span><span class="ident" id="3272558">PtrTo</span><span class="op" id="3272563">(</span><span class="ident" id="3272564">t</span><span class="op" id="3272565">)</span><span class="op" id="3272566">.</span><span class="ident" id="3272567">Implements</span><span class="op" id="3272577">(</span><span class="ident" id="3272578">marshalerType</span><span class="op" id="3272591">)</span>&nbsp;<span class="op" id="3272593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272598">return</span>&nbsp;<span class="ident" id="3272605">newCondAddrEncoder</span><span class="op" id="3272623">(</span><span class="ident" id="3272624">addrMarshalerEncoder</span><span class="op" id="3272644">,</span>&nbsp;<span class="ident" id="3272646">newTypeEncoder</span><span class="op" id="3272660">(</span><span class="ident" id="3272661">t</span><span class="op" id="3272662">,</span>&nbsp;<span class="builtintype" id="3272664">false</span><span class="op" id="3272669">)</span><span class="op" id="3272670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272674">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272681">if</span>&nbsp;<span class="ident" id="3272684">t</span><span class="op" id="3272685">.</span><span class="ident" id="3272686">Implements</span><span class="op" id="3272696">(</span><span class="ident" id="3272697">textMarshalerType</span><span class="op" id="3272714">)</span>&nbsp;<span class="op" id="3272716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272720">return</span>&nbsp;<span class="ident" id="3272727">textMarshalerEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272749">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272752">if</span>&nbsp;<span class="ident" id="3272755">t</span><span class="op" id="3272756">.</span><span class="ident" id="3272757">Kind</span><span class="op" id="3272761">(</span><span class="op" id="3272762">)</span>&nbsp;<span class="op" id="3272764">!=</span>&nbsp;<span class="ident" id="3272767">reflect</span><span class="op" id="3272774">.</span><span class="ident" id="3272775">Ptr</span>&nbsp;<span class="op" id="3272779">&amp;&amp;</span>&nbsp;<span class="ident" id="3272782">allowAddr</span>&nbsp;<span class="op" id="3272792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272796">if</span>&nbsp;<span class="ident" id="3272799">reflect</span><span class="op" id="3272806">.</span><span class="ident" id="3272807">PtrTo</span><span class="op" id="3272812">(</span><span class="ident" id="3272813">t</span><span class="op" id="3272814">)</span><span class="op" id="3272815">.</span><span class="ident" id="3272816">Implements</span><span class="op" id="3272826">(</span><span class="ident" id="3272827">textMarshalerType</span><span class="op" id="3272844">)</span>&nbsp;<span class="op" id="3272846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272851">return</span>&nbsp;<span class="ident" id="3272858">newCondAddrEncoder</span><span class="op" id="3272876">(</span><span class="ident" id="3272877">addrTextMarshalerEncoder</span><span class="op" id="3272901">,</span>&nbsp;<span class="ident" id="3272903">newTypeEncoder</span><span class="op" id="3272917">(</span><span class="ident" id="3272918">t</span><span class="op" id="3272919">,</span>&nbsp;<span class="builtintype" id="3272921">false</span><span class="op" id="3272926">)</span><span class="op" id="3272927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3272934">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272938">switch</span>&nbsp;<span class="ident" id="3272945">t</span><span class="op" id="3272946">.</span><span class="ident" id="3272947">Kind</span><span class="op" id="3272951">(</span><span class="op" id="3272952">)</span>&nbsp;<span class="op" id="3272954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272957">case</span>&nbsp;<span class="ident" id="3272962">reflect</span><span class="op" id="3272969">.</span><span class="ident" id="3272970">Bool</span><span class="op" id="3272974">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272978">return</span>&nbsp;<span class="ident" id="3272985">boolEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3272998">case</span>&nbsp;<span class="ident" id="3273003">reflect</span><span class="op" id="3273010">.</span><span class="ident" id="3273011">Int</span><span class="op" id="3273014">,</span>&nbsp;<span class="ident" id="3273016">reflect</span><span class="op" id="3273023">.</span><span class="ident" id="3273024">Int8</span><span class="op" id="3273028">,</span>&nbsp;<span class="ident" id="3273030">reflect</span><span class="op" id="3273037">.</span><span class="ident" id="3273038">Int16</span><span class="op" id="3273043">,</span>&nbsp;<span class="ident" id="3273045">reflect</span><span class="op" id="3273052">.</span><span class="ident" id="3273053">Int32</span><span class="op" id="3273058">,</span>&nbsp;<span class="ident" id="3273060">reflect</span><span class="op" id="3273067">.</span><span class="ident" id="3273068">Int64</span><span class="op" id="3273073">:</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273077">return</span>&nbsp;<span class="ident" id="3273084">intEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273096">case</span>&nbsp;<span class="ident" id="3273101">reflect</span><span class="op" id="3273108">.</span><span class="ident" id="3273109">Uint</span><span class="op" id="3273113">,</span>&nbsp;<span class="ident" id="3273115">reflect</span><span class="op" id="3273122">.</span><span class="ident" id="3273123">Uint8</span><span class="op" id="3273128">,</span>&nbsp;<span class="ident" id="3273130">reflect</span><span class="op" id="3273137">.</span><span class="ident" id="3273138">Uint16</span><span class="op" id="3273144">,</span>&nbsp;<span class="ident" id="3273146">reflect</span><span class="op" id="3273153">.</span><span class="ident" id="3273154">Uint32</span><span class="op" id="3273160">,</span>&nbsp;<span class="ident" id="3273162">reflect</span><span class="op" id="3273169">.</span><span class="ident" id="3273170">Uint64</span><span class="op" id="3273176">,</span>&nbsp;<span class="ident" id="3273178">reflect</span><span class="op" id="3273185">.</span><span class="ident" id="3273186">Uintptr</span><span class="op" id="3273193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273197">return</span>&nbsp;<span class="ident" id="3273204">uintEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273217">case</span>&nbsp;<span class="ident" id="3273222">reflect</span><span class="op" id="3273229">.</span><span class="ident" id="3273230">Float32</span><span class="op" id="3273237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273241">return</span>&nbsp;<span class="ident" id="3273248">float32Encoder</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273264">case</span>&nbsp;<span class="ident" id="3273269">reflect</span><span class="op" id="3273276">.</span><span class="ident" id="3273277">Float64</span><span class="op" id="3273284">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273288">return</span>&nbsp;<span class="ident" id="3273295">float64Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273311">case</span>&nbsp;<span class="ident" id="3273316">reflect</span><span class="op" id="3273323">.</span><span class="ident" id="3273324">String</span><span class="op" id="3273330">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273334">return</span>&nbsp;<span class="ident" id="3273341">stringEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273356">case</span>&nbsp;<span class="ident" id="3273361">reflect</span><span class="op" id="3273368">.</span><span class="ident" id="3273369">Interface</span><span class="op" id="3273378">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273382">return</span>&nbsp;<span class="ident" id="3273389">interfaceEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273407">case</span>&nbsp;<span class="ident" id="3273412">reflect</span><span class="op" id="3273419">.</span><span class="ident" id="3273420">Struct</span><span class="op" id="3273426">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273430">return</span>&nbsp;<span class="ident" id="3273437">newStructEncoder</span><span class="op" id="3273453">(</span><span class="ident" id="3273454">t</span><span class="op" id="3273455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273458">case</span>&nbsp;<span class="ident" id="3273463">reflect</span><span class="op" id="3273470">.</span><span class="ident" id="3273471">Map</span><span class="op" id="3273474">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273478">return</span>&nbsp;<span class="ident" id="3273485">newMapEncoder</span><span class="op" id="3273498">(</span><span class="ident" id="3273499">t</span><span class="op" id="3273500">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273503">case</span>&nbsp;<span class="ident" id="3273508">reflect</span><span class="op" id="3273515">.</span><span class="ident" id="3273516">Slice</span><span class="op" id="3273521">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273525">return</span>&nbsp;<span class="ident" id="3273532">newSliceEncoder</span><span class="op" id="3273547">(</span><span class="ident" id="3273548">t</span><span class="op" id="3273549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273552">case</span>&nbsp;<span class="ident" id="3273557">reflect</span><span class="op" id="3273564">.</span><span class="ident" id="3273565">Array</span><span class="op" id="3273570">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273574">return</span>&nbsp;<span class="ident" id="3273581">newArrayEncoder</span><span class="op" id="3273596">(</span><span class="ident" id="3273597">t</span><span class="op" id="3273598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273601">case</span>&nbsp;<span class="ident" id="3273606">reflect</span><span class="op" id="3273613">.</span><span class="ident" id="3273614">Ptr</span><span class="op" id="3273617">:</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273621">return</span>&nbsp;<span class="ident" id="3273628">newPtrEncoder</span><span class="op" id="3273641">(</span><span class="ident" id="3273642">t</span><span class="op" id="3273643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273646">default</span><span class="op" id="3273653">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273657">return</span>&nbsp;<span class="ident" id="3273664">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3273688">}</span><br>
<span class="lineno"></span><span class="op" id="3273690">}</span><br>
<span class="lineno">405</span><br>
<span class="lineno"></span><span class="keyword" id="3273693">func</span>&nbsp;<span class="ident" id="3273698">invalidValueEncoder</span><span class="op" id="3273717">(</span><span class="ident" id="3273718">e</span>&nbsp;<span class="op" id="3273720">*</span><span class="ident" id="3273721">encodeState</span><span class="op" id="3273732">,</span>&nbsp;<span class="ident" id="3273734">v</span>&nbsp;<span class="ident" id="3273736">reflect</span><span class="op" id="3273743">.</span><span class="ident" id="3273744">Value</span><span class="op" id="3273749">,</span>&nbsp;<span class="ident" id="3273751">quoted</span>&nbsp;<span class="builtintype" id="3273758">bool</span><span class="op" id="3273762">)</span>&nbsp;<span class="op" id="3273764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273767">e</span><span class="op" id="3273768">.</span><span class="ident" id="3273769">WriteString</span><span class="op" id="3273780">(</span><span class="string" id="3273781">&#34;null&#34;</span><span class="op" id="3273787">)</span><br>
<span class="lineno"></span><span class="op" id="3273789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span><span class="keyword" id="3273792">func</span>&nbsp;<span class="ident" id="3273797">marshalerEncoder</span><span class="op" id="3273813">(</span><span class="ident" id="3273814">e</span>&nbsp;<span class="op" id="3273816">*</span><span class="ident" id="3273817">encodeState</span><span class="op" id="3273828">,</span>&nbsp;<span class="ident" id="3273830">v</span>&nbsp;<span class="ident" id="3273832">reflect</span><span class="op" id="3273839">.</span><span class="ident" id="3273840">Value</span><span class="op" id="3273845">,</span>&nbsp;<span class="ident" id="3273847">quoted</span>&nbsp;<span class="builtintype" id="3273854">bool</span><span class="op" id="3273858">)</span>&nbsp;<span class="op" id="3273860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273863">if</span>&nbsp;<span class="ident" id="3273866">v</span><span class="op" id="3273867">.</span><span class="ident" id="3273868">Kind</span><span class="op" id="3273872">(</span><span class="op" id="3273873">)</span>&nbsp;<span class="op" id="3273875">==</span>&nbsp;<span class="ident" id="3273878">reflect</span><span class="op" id="3273885">.</span><span class="ident" id="3273886">Ptr</span>&nbsp;<span class="op" id="3273890">&amp;&amp;</span>&nbsp;<span class="ident" id="3273893">v</span><span class="op" id="3273894">.</span><span class="ident" id="3273895">IsNil</span><span class="op" id="3273900">(</span><span class="op" id="3273901">)</span>&nbsp;<span class="op" id="3273903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273907">e</span><span class="op" id="3273908">.</span><span class="ident" id="3273909">WriteString</span><span class="op" id="3273920">(</span><span class="string" id="3273921">&#34;null&#34;</span><span class="op" id="3273927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3273931">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3273939">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273942">m</span>&nbsp;<span class="op" id="3273944">:=</span>&nbsp;<span class="ident" id="3273947">v</span><span class="op" id="3273948">.</span><span class="ident" id="3273949">Interface</span><span class="op" id="3273958">(</span><span class="op" id="3273959">)</span><span class="op" id="3273960">.</span><span class="op" id="3273961">(</span><span class="ident" id="3273962">Marshaler</span><span class="op" id="3273971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3273974">b</span><span class="op" id="3273975">,</span>&nbsp;<span class="ident" id="3273977">err</span>&nbsp;<span class="op" id="3273981">:=</span>&nbsp;<span class="ident" id="3273984">m</span><span class="op" id="3273985">.</span><span class="ident" id="3273986">MarshalJSON</span><span class="op" id="3273997">(</span><span class="op" id="3273998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274001">if</span>&nbsp;<span class="ident" id="3274004">err</span>&nbsp;<span class="op" id="3274008">==</span>&nbsp;<span class="ident" id="3274011">nil</span>&nbsp;<span class="op" id="3274015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3274019">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274066">err</span>&nbsp;<span class="op" id="3274070">=</span>&nbsp;<span class="ident" id="3274072">compact</span><span class="op" id="3274079">(</span><span class="op" id="3274080">&amp;</span><span class="ident" id="3274081">e</span><span class="op" id="3274082">.</span><span class="ident" id="3274083">Buffer</span><span class="op" id="3274089">,</span>&nbsp;<span class="ident" id="3274091">b</span><span class="op" id="3274092">,</span>&nbsp;<span class="builtintype" id="3274094">true</span><span class="op" id="3274098">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274104">if</span>&nbsp;<span class="ident" id="3274107">err</span>&nbsp;<span class="op" id="3274111">!=</span>&nbsp;<span class="ident" id="3274114">nil</span>&nbsp;<span class="op" id="3274118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274122">e</span><span class="op" id="3274123">.</span><span class="builtintype" id="3274124">error</span><span class="op" id="3274129">(</span><span class="op" id="3274130">&amp;</span><span class="ident" id="3274131">MarshalerError</span><span class="op" id="3274145">{</span><span class="ident" id="3274146">v</span><span class="op" id="3274147">.</span><span class="ident" id="3274148">Type</span><span class="op" id="3274152">(</span><span class="op" id="3274153">)</span><span class="op" id="3274154">,</span>&nbsp;<span class="ident" id="3274156">err</span><span class="op" id="3274159">}</span><span class="op" id="3274160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274163">}</span><br>
<span class="lineno"></span><span class="op" id="3274165">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="3274168">func</span>&nbsp;<span class="ident" id="3274173">addrMarshalerEncoder</span><span class="op" id="3274193">(</span><span class="ident" id="3274194">e</span>&nbsp;<span class="op" id="3274196">*</span><span class="ident" id="3274197">encodeState</span><span class="op" id="3274208">,</span>&nbsp;<span class="ident" id="3274210">v</span>&nbsp;<span class="ident" id="3274212">reflect</span><span class="op" id="3274219">.</span><span class="ident" id="3274220">Value</span><span class="op" id="3274225">,</span>&nbsp;<span class="ident" id="3274227">quoted</span>&nbsp;<span class="builtintype" id="3274234">bool</span><span class="op" id="3274238">)</span>&nbsp;<span class="op" id="3274240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274243">va</span>&nbsp;<span class="op" id="3274246">:=</span>&nbsp;<span class="ident" id="3274249">v</span><span class="op" id="3274250">.</span><span class="ident" id="3274251">Addr</span><span class="op" id="3274255">(</span><span class="op" id="3274256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274259">if</span>&nbsp;<span class="ident" id="3274262">va</span><span class="op" id="3274264">.</span><span class="ident" id="3274265">IsNil</span><span class="op" id="3274270">(</span><span class="op" id="3274271">)</span>&nbsp;<span class="op" id="3274273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274277">e</span><span class="op" id="3274278">.</span><span class="ident" id="3274279">WriteString</span><span class="op" id="3274290">(</span><span class="string" id="3274291">&#34;null&#34;</span><span class="op" id="3274297">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274301">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274312">m</span>&nbsp;<span class="op" id="3274314">:=</span>&nbsp;<span class="ident" id="3274317">va</span><span class="op" id="3274319">.</span><span class="ident" id="3274320">Interface</span><span class="op" id="3274329">(</span><span class="op" id="3274330">)</span><span class="op" id="3274331">.</span><span class="op" id="3274332">(</span><span class="ident" id="3274333">Marshaler</span><span class="op" id="3274342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274345">b</span><span class="op" id="3274346">,</span>&nbsp;<span class="ident" id="3274348">err</span>&nbsp;<span class="op" id="3274352">:=</span>&nbsp;<span class="ident" id="3274355">m</span><span class="op" id="3274356">.</span><span class="ident" id="3274357">MarshalJSON</span><span class="op" id="3274368">(</span><span class="op" id="3274369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274372">if</span>&nbsp;<span class="ident" id="3274375">err</span>&nbsp;<span class="op" id="3274379">==</span>&nbsp;<span class="ident" id="3274382">nil</span>&nbsp;<span class="op" id="3274386">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3274390">//&nbsp;copy&nbsp;JSON&nbsp;into&nbsp;buffer,&nbsp;checking&nbsp;validity.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274437">err</span>&nbsp;<span class="op" id="3274441">=</span>&nbsp;<span class="ident" id="3274443">compact</span><span class="op" id="3274450">(</span><span class="op" id="3274451">&amp;</span><span class="ident" id="3274452">e</span><span class="op" id="3274453">.</span><span class="ident" id="3274454">Buffer</span><span class="op" id="3274460">,</span>&nbsp;<span class="ident" id="3274462">b</span><span class="op" id="3274463">,</span>&nbsp;<span class="builtintype" id="3274465">true</span><span class="op" id="3274469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274475">if</span>&nbsp;<span class="ident" id="3274478">err</span>&nbsp;<span class="op" id="3274482">!=</span>&nbsp;<span class="ident" id="3274485">nil</span>&nbsp;<span class="op" id="3274489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274493">e</span><span class="op" id="3274494">.</span><span class="builtintype" id="3274495">error</span><span class="op" id="3274500">(</span><span class="op" id="3274501">&amp;</span><span class="ident" id="3274502">MarshalerError</span><span class="op" id="3274516">{</span><span class="ident" id="3274517">v</span><span class="op" id="3274518">.</span><span class="ident" id="3274519">Type</span><span class="op" id="3274523">(</span><span class="op" id="3274524">)</span><span class="op" id="3274525">,</span>&nbsp;<span class="ident" id="3274527">err</span><span class="op" id="3274530">}</span><span class="op" id="3274531">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274534">}</span><br>
<span class="lineno"></span><span class="op" id="3274536">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3274539">func</span>&nbsp;<span class="ident" id="3274544">textMarshalerEncoder</span><span class="op" id="3274564">(</span><span class="ident" id="3274565">e</span>&nbsp;<span class="op" id="3274567">*</span><span class="ident" id="3274568">encodeState</span><span class="op" id="3274579">,</span>&nbsp;<span class="ident" id="3274581">v</span>&nbsp;<span class="ident" id="3274583">reflect</span><span class="op" id="3274590">.</span><span class="ident" id="3274591">Value</span><span class="op" id="3274596">,</span>&nbsp;<span class="ident" id="3274598">quoted</span>&nbsp;<span class="builtintype" id="3274605">bool</span><span class="op" id="3274609">)</span>&nbsp;<span class="op" id="3274611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274614">if</span>&nbsp;<span class="ident" id="3274617">v</span><span class="op" id="3274618">.</span><span class="ident" id="3274619">Kind</span><span class="op" id="3274623">(</span><span class="op" id="3274624">)</span>&nbsp;<span class="op" id="3274626">==</span>&nbsp;<span class="ident" id="3274629">reflect</span><span class="op" id="3274636">.</span><span class="ident" id="3274637">Ptr</span>&nbsp;<span class="op" id="3274641">&amp;&amp;</span>&nbsp;<span class="ident" id="3274644">v</span><span class="op" id="3274645">.</span><span class="ident" id="3274646">IsNil</span><span class="op" id="3274651">(</span><span class="op" id="3274652">)</span>&nbsp;<span class="op" id="3274654">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274658">e</span><span class="op" id="3274659">.</span><span class="ident" id="3274660">WriteString</span><span class="op" id="3274671">(</span><span class="string" id="3274672">&#34;null&#34;</span><span class="op" id="3274678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274682">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274693">m</span>&nbsp;<span class="op" id="3274695">:=</span>&nbsp;<span class="ident" id="3274698">v</span><span class="op" id="3274699">.</span><span class="ident" id="3274700">Interface</span><span class="op" id="3274709">(</span><span class="op" id="3274710">)</span><span class="op" id="3274711">.</span><span class="op" id="3274712">(</span><span class="ident" id="3274713">encoding</span><span class="op" id="3274721">.</span><span class="ident" id="3274722">TextMarshaler</span><span class="op" id="3274735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274738">b</span><span class="op" id="3274739">,</span>&nbsp;<span class="ident" id="3274741">err</span>&nbsp;<span class="op" id="3274745">:=</span>&nbsp;<span class="ident" id="3274748">m</span><span class="op" id="3274749">.</span><span class="ident" id="3274750">MarshalText</span><span class="op" id="3274761">(</span><span class="op" id="3274762">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274765">if</span>&nbsp;<span class="ident" id="3274768">err</span>&nbsp;<span class="op" id="3274772">==</span>&nbsp;<span class="ident" id="3274775">nil</span>&nbsp;<span class="op" id="3274779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274783">_</span><span class="op" id="3274784">,</span>&nbsp;<span class="ident" id="3274786">err</span>&nbsp;<span class="op" id="3274790">=</span>&nbsp;<span class="ident" id="3274792">e</span><span class="op" id="3274793">.</span><span class="ident" id="3274794">stringBytes</span><span class="op" id="3274805">(</span><span class="ident" id="3274806">b</span><span class="op" id="3274807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274813">if</span>&nbsp;<span class="ident" id="3274816">err</span>&nbsp;<span class="op" id="3274820">!=</span>&nbsp;<span class="ident" id="3274823">nil</span>&nbsp;<span class="op" id="3274827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274831">e</span><span class="op" id="3274832">.</span><span class="builtintype" id="3274833">error</span><span class="op" id="3274838">(</span><span class="op" id="3274839">&amp;</span><span class="ident" id="3274840">MarshalerError</span><span class="op" id="3274854">{</span><span class="ident" id="3274855">v</span><span class="op" id="3274856">.</span><span class="ident" id="3274857">Type</span><span class="op" id="3274861">(</span><span class="op" id="3274862">)</span><span class="op" id="3274863">,</span>&nbsp;<span class="ident" id="3274865">err</span><span class="op" id="3274868">}</span><span class="op" id="3274869">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3274872">}</span><br>
<span class="lineno"></span><span class="op" id="3274874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3274877">func</span>&nbsp;<span class="ident" id="3274882">addrTextMarshalerEncoder</span><span class="op" id="3274906">(</span><span class="ident" id="3274907">e</span>&nbsp;<span class="op" id="3274909">*</span><span class="ident" id="3274910">encodeState</span><span class="op" id="3274921">,</span>&nbsp;<span class="ident" id="3274923">v</span>&nbsp;<span class="ident" id="3274925">reflect</span><span class="op" id="3274932">.</span><span class="ident" id="3274933">Value</span><span class="op" id="3274938">,</span>&nbsp;<span class="ident" id="3274940">quoted</span>&nbsp;<span class="builtintype" id="3274947">bool</span><span class="op" id="3274951">)</span>&nbsp;<span class="op" id="3274953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274956">va</span>&nbsp;<span class="op" id="3274959">:=</span>&nbsp;<span class="ident" id="3274962">v</span><span class="op" id="3274963">.</span><span class="ident" id="3274964">Addr</span><span class="op" id="3274968">(</span><span class="op" id="3274969">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3274972">if</span>&nbsp;<span class="ident" id="3274975">va</span><span class="op" id="3274977">.</span><span class="ident" id="3274978">IsNil</span><span class="op" id="3274983">(</span><span class="op" id="3274984">)</span>&nbsp;<span class="op" id="3274986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3274990">e</span><span class="op" id="3274991">.</span><span class="ident" id="3274992">WriteString</span><span class="op" id="3275003">(</span><span class="string" id="3275004">&#34;null&#34;</span><span class="op" id="3275010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275014">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275025">m</span>&nbsp;<span class="op" id="3275027">:=</span>&nbsp;<span class="ident" id="3275030">va</span><span class="op" id="3275032">.</span><span class="ident" id="3275033">Interface</span><span class="op" id="3275042">(</span><span class="op" id="3275043">)</span><span class="op" id="3275044">.</span><span class="op" id="3275045">(</span><span class="ident" id="3275046">encoding</span><span class="op" id="3275054">.</span><span class="ident" id="3275055">TextMarshaler</span><span class="op" id="3275068">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275071">b</span><span class="op" id="3275072">,</span>&nbsp;<span class="ident" id="3275074">err</span>&nbsp;<span class="op" id="3275078">:=</span>&nbsp;<span class="ident" id="3275081">m</span><span class="op" id="3275082">.</span><span class="ident" id="3275083">MarshalText</span><span class="op" id="3275094">(</span><span class="op" id="3275095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275098">if</span>&nbsp;<span class="ident" id="3275101">err</span>&nbsp;<span class="op" id="3275105">==</span>&nbsp;<span class="ident" id="3275108">nil</span>&nbsp;<span class="op" id="3275112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275116">_</span><span class="op" id="3275117">,</span>&nbsp;<span class="ident" id="3275119">err</span>&nbsp;<span class="op" id="3275123">=</span>&nbsp;<span class="ident" id="3275125">e</span><span class="op" id="3275126">.</span><span class="ident" id="3275127">stringBytes</span><span class="op" id="3275138">(</span><span class="ident" id="3275139">b</span><span class="op" id="3275140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275146">if</span>&nbsp;<span class="ident" id="3275149">err</span>&nbsp;<span class="op" id="3275153">!=</span>&nbsp;<span class="ident" id="3275156">nil</span>&nbsp;<span class="op" id="3275160">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275164">e</span><span class="op" id="3275165">.</span><span class="builtintype" id="3275166">error</span><span class="op" id="3275171">(</span><span class="op" id="3275172">&amp;</span><span class="ident" id="3275173">MarshalerError</span><span class="op" id="3275187">{</span><span class="ident" id="3275188">v</span><span class="op" id="3275189">.</span><span class="ident" id="3275190">Type</span><span class="op" id="3275194">(</span><span class="op" id="3275195">)</span><span class="op" id="3275196">,</span>&nbsp;<span class="ident" id="3275198">err</span><span class="op" id="3275201">}</span><span class="op" id="3275202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275205">}</span><br>
<span class="lineno"></span><span class="op" id="3275207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275210">func</span>&nbsp;<span class="ident" id="3275215">boolEncoder</span><span class="op" id="3275226">(</span><span class="ident" id="3275227">e</span>&nbsp;<span class="op" id="3275229">*</span><span class="ident" id="3275230">encodeState</span><span class="op" id="3275241">,</span>&nbsp;<span class="ident" id="3275243">v</span>&nbsp;<span class="ident" id="3275245">reflect</span><span class="op" id="3275252">.</span><span class="ident" id="3275253">Value</span><span class="op" id="3275258">,</span>&nbsp;<span class="ident" id="3275260">quoted</span>&nbsp;<span class="builtintype" id="3275267">bool</span><span class="op" id="3275271">)</span>&nbsp;<span class="op" id="3275273">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275276">if</span>&nbsp;<span class="ident" id="3275279">quoted</span>&nbsp;<span class="op" id="3275286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275290">e</span><span class="op" id="3275291">.</span><span class="ident" id="3275292">WriteByte</span><span class="op" id="3275301">(</span><span class="string" id="3275302">&#39;&#34;&#39;</span><span class="op" id="3275305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275311">if</span>&nbsp;<span class="ident" id="3275314">v</span><span class="op" id="3275315">.</span><span class="ident" id="3275316">Bool</span><span class="op" id="3275320">(</span><span class="op" id="3275321">)</span>&nbsp;<span class="op" id="3275323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275327">e</span><span class="op" id="3275328">.</span><span class="ident" id="3275329">WriteString</span><span class="op" id="3275340">(</span><span class="string" id="3275341">&#34;true&#34;</span><span class="op" id="3275347">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275350">}</span>&nbsp;<span class="keyword" id="3275352">else</span>&nbsp;<span class="op" id="3275357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275361">e</span><span class="op" id="3275362">.</span><span class="ident" id="3275363">WriteString</span><span class="op" id="3275374">(</span><span class="string" id="3275375">&#34;false&#34;</span><span class="op" id="3275382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275388">if</span>&nbsp;<span class="ident" id="3275391">quoted</span>&nbsp;<span class="op" id="3275398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275402">e</span><span class="op" id="3275403">.</span><span class="ident" id="3275404">WriteByte</span><span class="op" id="3275413">(</span><span class="string" id="3275414">&#39;&#34;&#39;</span><span class="op" id="3275417">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275420">}</span><br>
<span class="lineno"></span><span class="op" id="3275422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275425">func</span>&nbsp;<span class="ident" id="3275430">intEncoder</span><span class="op" id="3275440">(</span><span class="ident" id="3275441">e</span>&nbsp;<span class="op" id="3275443">*</span><span class="ident" id="3275444">encodeState</span><span class="op" id="3275455">,</span>&nbsp;<span class="ident" id="3275457">v</span>&nbsp;<span class="ident" id="3275459">reflect</span><span class="op" id="3275466">.</span><span class="ident" id="3275467">Value</span><span class="op" id="3275472">,</span>&nbsp;<span class="ident" id="3275474">quoted</span>&nbsp;<span class="builtintype" id="3275481">bool</span><span class="op" id="3275485">)</span>&nbsp;<span class="op" id="3275487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275490">b</span>&nbsp;<span class="op" id="3275492">:=</span>&nbsp;<span class="ident" id="3275495">strconv</span><span class="op" id="3275502">.</span><span class="ident" id="3275503">AppendInt</span><span class="op" id="3275512">(</span><span class="ident" id="3275513">e</span><span class="op" id="3275514">.</span><span class="ident" id="3275515">scratch</span><span class="op" id="3275522">[</span><span class="op" id="3275523">:</span><span class="num" id="3275524">0</span><span class="op" id="3275525">]</span><span class="op" id="3275526">,</span>&nbsp;<span class="ident" id="3275528">v</span><span class="op" id="3275529">.</span><span class="ident" id="3275530">Int</span><span class="op" id="3275533">(</span><span class="op" id="3275534">)</span><span class="op" id="3275535">,</span>&nbsp;<span class="num" id="3275537">10</span><span class="op" id="3275539">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275542">if</span>&nbsp;<span class="ident" id="3275545">quoted</span>&nbsp;<span class="op" id="3275552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275556">e</span><span class="op" id="3275557">.</span><span class="ident" id="3275558">WriteByte</span><span class="op" id="3275567">(</span><span class="string" id="3275568">&#39;&#34;&#39;</span><span class="op" id="3275571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275577">e</span><span class="op" id="3275578">.</span><span class="ident" id="3275579">Write</span><span class="op" id="3275584">(</span><span class="ident" id="3275585">b</span><span class="op" id="3275586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275589">if</span>&nbsp;<span class="ident" id="3275592">quoted</span>&nbsp;<span class="op" id="3275599">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275603">e</span><span class="op" id="3275604">.</span><span class="ident" id="3275605">WriteByte</span><span class="op" id="3275614">(</span><span class="string" id="3275615">&#39;&#34;&#39;</span><span class="op" id="3275618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275621">}</span><br>
<span class="lineno"></span><span class="op" id="3275623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275626">func</span>&nbsp;<span class="ident" id="3275631">uintEncoder</span><span class="op" id="3275642">(</span><span class="ident" id="3275643">e</span>&nbsp;<span class="op" id="3275645">*</span><span class="ident" id="3275646">encodeState</span><span class="op" id="3275657">,</span>&nbsp;<span class="ident" id="3275659">v</span>&nbsp;<span class="ident" id="3275661">reflect</span><span class="op" id="3275668">.</span><span class="ident" id="3275669">Value</span><span class="op" id="3275674">,</span>&nbsp;<span class="ident" id="3275676">quoted</span>&nbsp;<span class="builtintype" id="3275683">bool</span><span class="op" id="3275687">)</span>&nbsp;<span class="op" id="3275689">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275692">b</span>&nbsp;<span class="op" id="3275694">:=</span>&nbsp;<span class="ident" id="3275697">strconv</span><span class="op" id="3275704">.</span><span class="ident" id="3275705">AppendUint</span><span class="op" id="3275715">(</span><span class="ident" id="3275716">e</span><span class="op" id="3275717">.</span><span class="ident" id="3275718">scratch</span><span class="op" id="3275725">[</span><span class="op" id="3275726">:</span><span class="num" id="3275727">0</span><span class="op" id="3275728">]</span><span class="op" id="3275729">,</span>&nbsp;<span class="ident" id="3275731">v</span><span class="op" id="3275732">.</span><span class="ident" id="3275733">Uint</span><span class="op" id="3275737">(</span><span class="op" id="3275738">)</span><span class="op" id="3275739">,</span>&nbsp;<span class="num" id="3275741">10</span><span class="op" id="3275743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275746">if</span>&nbsp;<span class="ident" id="3275749">quoted</span>&nbsp;<span class="op" id="3275756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275760">e</span><span class="op" id="3275761">.</span><span class="ident" id="3275762">WriteByte</span><span class="op" id="3275771">(</span><span class="string" id="3275772">&#39;&#34;&#39;</span><span class="op" id="3275775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275781">e</span><span class="op" id="3275782">.</span><span class="ident" id="3275783">Write</span><span class="op" id="3275788">(</span><span class="ident" id="3275789">b</span><span class="op" id="3275790">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275793">if</span>&nbsp;<span class="ident" id="3275796">quoted</span>&nbsp;<span class="op" id="3275803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275807">e</span><span class="op" id="3275808">.</span><span class="ident" id="3275809">WriteByte</span><span class="op" id="3275818">(</span><span class="string" id="3275819">&#39;&#34;&#39;</span><span class="op" id="3275822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3275825">}</span><br>
<span class="lineno"></span><span class="op" id="3275827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span><span class="keyword" id="3275830">type</span>&nbsp;<span class="ident" id="3275835">floatEncoder</span>&nbsp;<span class="builtintype" id="3275848">int</span>&nbsp;<span class="comment" id="3275852">//&nbsp;number&nbsp;of&nbsp;bits</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3275871">func</span>&nbsp;<span class="op" id="3275876">(</span><span class="ident" id="3275877">bits</span>&nbsp;<span class="ident" id="3275882">floatEncoder</span><span class="op" id="3275894">)</span>&nbsp;<span class="ident" id="3275896">encode</span><span class="op" id="3275902">(</span><span class="ident" id="3275903">e</span>&nbsp;<span class="op" id="3275905">*</span><span class="ident" id="3275906">encodeState</span><span class="op" id="3275917">,</span>&nbsp;<span class="ident" id="3275919">v</span>&nbsp;<span class="ident" id="3275921">reflect</span><span class="op" id="3275928">.</span><span class="ident" id="3275929">Value</span><span class="op" id="3275934">,</span>&nbsp;<span class="ident" id="3275936">quoted</span>&nbsp;<span class="builtintype" id="3275943">bool</span><span class="op" id="3275947">)</span>&nbsp;<span class="op" id="3275949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3275952">f</span>&nbsp;<span class="op" id="3275954">:=</span>&nbsp;<span class="ident" id="3275957">v</span><span class="op" id="3275958">.</span><span class="ident" id="3275959">Float</span><span class="op" id="3275964">(</span><span class="op" id="3275965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3275968">if</span>&nbsp;<span class="ident" id="3275971">math</span><span class="op" id="3275975">.</span><span class="ident" id="3275976">IsInf</span><span class="op" id="3275981">(</span><span class="ident" id="3275982">f</span><span class="op" id="3275983">,</span>&nbsp;<span class="num" id="3275985">0</span><span class="op" id="3275986">)</span>&nbsp;<span class="op" id="3275988">||</span>&nbsp;<span class="ident" id="3275991">math</span><span class="op" id="3275995">.</span><span class="ident" id="3275996">IsNaN</span><span class="op" id="3276001">(</span><span class="ident" id="3276002">f</span><span class="op" id="3276003">)</span>&nbsp;<span class="op" id="3276005">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276009">e</span><span class="op" id="3276010">.</span><span class="builtintype" id="3276011">error</span><span class="op" id="3276016">(</span><span class="op" id="3276017">&amp;</span><span class="ident" id="3276018">UnsupportedValueError</span><span class="op" id="3276039">{</span><span class="ident" id="3276040">v</span><span class="op" id="3276041">,</span>&nbsp;<span class="ident" id="3276043">strconv</span><span class="op" id="3276050">.</span><span class="ident" id="3276051">FormatFloat</span><span class="op" id="3276062">(</span><span class="ident" id="3276063">f</span><span class="op" id="3276064">,</span>&nbsp;<span class="string" id="3276066">&#39;g&#39;</span><span class="op" id="3276069">,</span>&nbsp;<span class="op" id="3276071">-</span><span class="num" id="3276072">1</span><span class="op" id="3276073">,</span>&nbsp;<span class="builtintype" id="3276075">int</span><span class="op" id="3276078">(</span><span class="ident" id="3276079">bits</span><span class="op" id="3276083">)</span><span class="op" id="3276084">)</span><span class="op" id="3276085">}</span><span class="op" id="3276086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276092">b</span>&nbsp;<span class="op" id="3276094">:=</span>&nbsp;<span class="ident" id="3276097">strconv</span><span class="op" id="3276104">.</span><span class="ident" id="3276105">AppendFloat</span><span class="op" id="3276116">(</span><span class="ident" id="3276117">e</span><span class="op" id="3276118">.</span><span class="ident" id="3276119">scratch</span><span class="op" id="3276126">[</span><span class="op" id="3276127">:</span><span class="num" id="3276128">0</span><span class="op" id="3276129">]</span><span class="op" id="3276130">,</span>&nbsp;<span class="ident" id="3276132">f</span><span class="op" id="3276133">,</span>&nbsp;<span class="string" id="3276135">&#39;g&#39;</span><span class="op" id="3276138">,</span>&nbsp;<span class="op" id="3276140">-</span><span class="num" id="3276141">1</span><span class="op" id="3276142">,</span>&nbsp;<span class="builtintype" id="3276144">int</span><span class="op" id="3276147">(</span><span class="ident" id="3276148">bits</span><span class="op" id="3276152">)</span><span class="op" id="3276153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276156">if</span>&nbsp;<span class="ident" id="3276159">quoted</span>&nbsp;<span class="op" id="3276166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276170">e</span><span class="op" id="3276171">.</span><span class="ident" id="3276172">WriteByte</span><span class="op" id="3276181">(</span><span class="string" id="3276182">&#39;&#34;&#39;</span><span class="op" id="3276185">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276191">e</span><span class="op" id="3276192">.</span><span class="ident" id="3276193">Write</span><span class="op" id="3276198">(</span><span class="ident" id="3276199">b</span><span class="op" id="3276200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276203">if</span>&nbsp;<span class="ident" id="3276206">quoted</span>&nbsp;<span class="op" id="3276213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276217">e</span><span class="op" id="3276218">.</span><span class="ident" id="3276219">WriteByte</span><span class="op" id="3276228">(</span><span class="string" id="3276229">&#39;&#34;&#39;</span><span class="op" id="3276232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276235">}</span><br>
<span class="lineno">525</span><span class="op" id="3276237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3276240">var</span>&nbsp;<span class="op" id="3276244">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276247">float32Encoder</span>&nbsp;<span class="op" id="3276262">=</span>&nbsp;<span class="op" id="3276264">(</span><span class="ident" id="3276265">floatEncoder</span><span class="op" id="3276277">(</span><span class="num" id="3276278">32</span><span class="op" id="3276280">)</span><span class="op" id="3276281">)</span><span class="op" id="3276282">.</span><span class="ident" id="3276283">encode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276291">float64Encoder</span>&nbsp;<span class="op" id="3276306">=</span>&nbsp;<span class="op" id="3276308">(</span><span class="ident" id="3276309">floatEncoder</span><span class="op" id="3276321">(</span><span class="num" id="3276322">64</span><span class="op" id="3276324">)</span><span class="op" id="3276325">)</span><span class="op" id="3276326">.</span><span class="ident" id="3276327">encode</span><br>
<span class="lineno">530</span><span class="op" id="3276334">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3276337">func</span>&nbsp;<span class="ident" id="3276342">stringEncoder</span><span class="op" id="3276355">(</span><span class="ident" id="3276356">e</span>&nbsp;<span class="op" id="3276358">*</span><span class="ident" id="3276359">encodeState</span><span class="op" id="3276370">,</span>&nbsp;<span class="ident" id="3276372">v</span>&nbsp;<span class="ident" id="3276374">reflect</span><span class="op" id="3276381">.</span><span class="ident" id="3276382">Value</span><span class="op" id="3276387">,</span>&nbsp;<span class="ident" id="3276389">quoted</span>&nbsp;<span class="builtintype" id="3276396">bool</span><span class="op" id="3276400">)</span>&nbsp;<span class="op" id="3276402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276405">if</span>&nbsp;<span class="ident" id="3276408">v</span><span class="op" id="3276409">.</span><span class="ident" id="3276410">Type</span><span class="op" id="3276414">(</span><span class="op" id="3276415">)</span>&nbsp;<span class="op" id="3276417">==</span>&nbsp;<span class="ident" id="3276420">numberType</span>&nbsp;<span class="op" id="3276431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276435">numStr</span>&nbsp;<span class="op" id="3276442">:=</span>&nbsp;<span class="ident" id="3276445">v</span><span class="op" id="3276446">.</span><span class="ident" id="3276447">String</span><span class="op" id="3276453">(</span><span class="op" id="3276454">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276458">if</span>&nbsp;<span class="ident" id="3276461">numStr</span>&nbsp;<span class="op" id="3276468">==</span>&nbsp;<span class="string" id="3276471">&#34;&#34;</span>&nbsp;<span class="op" id="3276474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276479">numStr</span>&nbsp;<span class="op" id="3276486">=</span>&nbsp;<span class="string" id="3276488">&#34;0&#34;</span>&nbsp;<span class="comment" id="3276492">//&nbsp;Number&#39;s&nbsp;zero-val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276519">e</span><span class="op" id="3276520">.</span><span class="ident" id="3276521">WriteString</span><span class="op" id="3276532">(</span><span class="ident" id="3276533">numStr</span><span class="op" id="3276539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276543">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276554">if</span>&nbsp;<span class="ident" id="3276557">quoted</span>&nbsp;<span class="op" id="3276564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276568">sb</span><span class="op" id="3276570">,</span>&nbsp;<span class="ident" id="3276572">err</span>&nbsp;<span class="op" id="3276576">:=</span>&nbsp;<span class="ident" id="3276579">Marshal</span><span class="op" id="3276586">(</span><span class="ident" id="3276587">v</span><span class="op" id="3276588">.</span><span class="ident" id="3276589">String</span><span class="op" id="3276595">(</span><span class="op" id="3276596">)</span><span class="op" id="3276597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276601">if</span>&nbsp;<span class="ident" id="3276604">err</span>&nbsp;<span class="op" id="3276608">!=</span>&nbsp;<span class="ident" id="3276611">nil</span>&nbsp;<span class="op" id="3276615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276620">e</span><span class="op" id="3276621">.</span><span class="builtintype" id="3276622">error</span><span class="op" id="3276627">(</span><span class="ident" id="3276628">err</span><span class="op" id="3276631">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276639">e</span><span class="op" id="3276640">.</span><span class="builtintype" id="3276641">string</span><span class="op" id="3276647">(</span><span class="builtintype" id="3276648">string</span><span class="op" id="3276654">(</span><span class="ident" id="3276655">sb</span><span class="op" id="3276657">)</span><span class="op" id="3276658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276661">}</span>&nbsp;<span class="keyword" id="3276663">else</span>&nbsp;<span class="op" id="3276668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276672">e</span><span class="op" id="3276673">.</span><span class="builtintype" id="3276674">string</span><span class="op" id="3276680">(</span><span class="ident" id="3276681">v</span><span class="op" id="3276682">.</span><span class="ident" id="3276683">String</span><span class="op" id="3276689">(</span><span class="op" id="3276690">)</span><span class="op" id="3276691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276694">}</span><br>
<span class="lineno">550</span><span class="op" id="3276696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3276699">func</span>&nbsp;<span class="ident" id="3276704">interfaceEncoder</span><span class="op" id="3276720">(</span><span class="ident" id="3276721">e</span>&nbsp;<span class="op" id="3276723">*</span><span class="ident" id="3276724">encodeState</span><span class="op" id="3276735">,</span>&nbsp;<span class="ident" id="3276737">v</span>&nbsp;<span class="ident" id="3276739">reflect</span><span class="op" id="3276746">.</span><span class="ident" id="3276747">Value</span><span class="op" id="3276752">,</span>&nbsp;<span class="ident" id="3276754">quoted</span>&nbsp;<span class="builtintype" id="3276761">bool</span><span class="op" id="3276765">)</span>&nbsp;<span class="op" id="3276767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276770">if</span>&nbsp;<span class="ident" id="3276773">v</span><span class="op" id="3276774">.</span><span class="ident" id="3276775">IsNil</span><span class="op" id="3276780">(</span><span class="op" id="3276781">)</span>&nbsp;<span class="op" id="3276783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276787">e</span><span class="op" id="3276788">.</span><span class="ident" id="3276789">WriteString</span><span class="op" id="3276800">(</span><span class="string" id="3276801">&#34;null&#34;</span><span class="op" id="3276807">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3276811">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3276819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276822">e</span><span class="op" id="3276823">.</span><span class="ident" id="3276824">reflectValue</span><span class="op" id="3276836">(</span><span class="ident" id="3276837">v</span><span class="op" id="3276838">.</span><span class="ident" id="3276839">Elem</span><span class="op" id="3276843">(</span><span class="op" id="3276844">)</span><span class="op" id="3276845">)</span><br>
<span class="lineno"></span><span class="op" id="3276847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">560</span><span class="keyword" id="3276850">func</span>&nbsp;<span class="ident" id="3276855">unsupportedTypeEncoder</span><span class="op" id="3276877">(</span><span class="ident" id="3276878">e</span>&nbsp;<span class="op" id="3276880">*</span><span class="ident" id="3276881">encodeState</span><span class="op" id="3276892">,</span>&nbsp;<span class="ident" id="3276894">v</span>&nbsp;<span class="ident" id="3276896">reflect</span><span class="op" id="3276903">.</span><span class="ident" id="3276904">Value</span><span class="op" id="3276909">,</span>&nbsp;<span class="ident" id="3276911">quoted</span>&nbsp;<span class="builtintype" id="3276918">bool</span><span class="op" id="3276922">)</span>&nbsp;<span class="op" id="3276924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3276927">e</span><span class="op" id="3276928">.</span><span class="builtintype" id="3276929">error</span><span class="op" id="3276934">(</span><span class="op" id="3276935">&amp;</span><span class="ident" id="3276936">UnsupportedTypeError</span><span class="op" id="3276956">{</span><span class="ident" id="3276957">v</span><span class="op" id="3276958">.</span><span class="ident" id="3276959">Type</span><span class="op" id="3276963">(</span><span class="op" id="3276964">)</span><span class="op" id="3276965">}</span><span class="op" id="3276966">)</span><br>
<span class="lineno"></span><span class="op" id="3276968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3276971">type</span>&nbsp;<span class="ident" id="3276976">structEncoder</span>&nbsp;<span class="keyword" id="3276990">struct</span>&nbsp;<span class="op" id="3276997">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277000">fields</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3277010">[</span><span class="op" id="3277011">]</span><span class="ident" id="3277012">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277019">fieldEncs</span>&nbsp;<span class="op" id="3277029">[</span><span class="op" id="3277030">]</span><span class="ident" id="3277031">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3277043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3277046">func</span>&nbsp;<span class="op" id="3277051">(</span><span class="ident" id="3277052">se</span>&nbsp;<span class="op" id="3277055">*</span><span class="ident" id="3277056">structEncoder</span><span class="op" id="3277069">)</span>&nbsp;<span class="ident" id="3277071">encode</span><span class="op" id="3277077">(</span><span class="ident" id="3277078">e</span>&nbsp;<span class="op" id="3277080">*</span><span class="ident" id="3277081">encodeState</span><span class="op" id="3277092">,</span>&nbsp;<span class="ident" id="3277094">v</span>&nbsp;<span class="ident" id="3277096">reflect</span><span class="op" id="3277103">.</span><span class="ident" id="3277104">Value</span><span class="op" id="3277109">,</span>&nbsp;<span class="ident" id="3277111">quoted</span>&nbsp;<span class="builtintype" id="3277118">bool</span><span class="op" id="3277122">)</span>&nbsp;<span class="op" id="3277124">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277127">e</span><span class="op" id="3277128">.</span><span class="ident" id="3277129">WriteByte</span><span class="op" id="3277138">(</span><span class="string" id="3277139">&#39;{&#39;</span><span class="op" id="3277142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277145">first</span>&nbsp;<span class="op" id="3277151">:=</span>&nbsp;<span class="builtintype" id="3277154">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277160">for</span>&nbsp;<span class="ident" id="3277164">i</span><span class="op" id="3277165">,</span>&nbsp;<span class="ident" id="3277167">f</span>&nbsp;<span class="op" id="3277169">:=</span>&nbsp;<span class="keyword" id="3277172">range</span>&nbsp;<span class="ident" id="3277178">se</span><span class="op" id="3277180">.</span><span class="ident" id="3277181">fields</span>&nbsp;<span class="op" id="3277188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277192">fv</span>&nbsp;<span class="op" id="3277195">:=</span>&nbsp;<span class="ident" id="3277198">fieldByIndex</span><span class="op" id="3277210">(</span><span class="ident" id="3277211">v</span><span class="op" id="3277212">,</span>&nbsp;<span class="ident" id="3277214">f</span><span class="op" id="3277215">.</span><span class="ident" id="3277216">index</span><span class="op" id="3277221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277225">if</span>&nbsp;<span class="op" id="3277228">!</span><span class="ident" id="3277229">fv</span><span class="op" id="3277231">.</span><span class="ident" id="3277232">IsValid</span><span class="op" id="3277239">(</span><span class="op" id="3277240">)</span>&nbsp;<span class="op" id="3277242">||</span>&nbsp;<span class="ident" id="3277245">f</span><span class="op" id="3277246">.</span><span class="ident" id="3277247">omitEmpty</span>&nbsp;<span class="op" id="3277257">&amp;&amp;</span>&nbsp;<span class="ident" id="3277260">isEmptyValue</span><span class="op" id="3277272">(</span><span class="ident" id="3277273">fv</span><span class="op" id="3277275">)</span>&nbsp;<span class="op" id="3277277">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277282">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277297">if</span>&nbsp;<span class="ident" id="3277300">first</span>&nbsp;<span class="op" id="3277306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277311">first</span>&nbsp;<span class="op" id="3277317">=</span>&nbsp;<span class="builtintype" id="3277319">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277327">}</span>&nbsp;<span class="keyword" id="3277329">else</span>&nbsp;<span class="op" id="3277334">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277339">e</span><span class="op" id="3277340">.</span><span class="ident" id="3277341">WriteByte</span><span class="op" id="3277350">(</span><span class="string" id="3277351">&#39;,&#39;</span><span class="op" id="3277354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277362">e</span><span class="op" id="3277363">.</span><span class="builtintype" id="3277364">string</span><span class="op" id="3277370">(</span><span class="ident" id="3277371">f</span><span class="op" id="3277372">.</span><span class="ident" id="3277373">name</span><span class="op" id="3277377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277381">e</span><span class="op" id="3277382">.</span><span class="ident" id="3277383">WriteByte</span><span class="op" id="3277392">(</span><span class="string" id="3277393">&#39;:&#39;</span><span class="op" id="3277396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277400">se</span><span class="op" id="3277402">.</span><span class="ident" id="3277403">fieldEncs</span><span class="op" id="3277412">[</span><span class="ident" id="3277413">i</span><span class="op" id="3277414">]</span><span class="op" id="3277415">(</span><span class="ident" id="3277416">e</span><span class="op" id="3277417">,</span>&nbsp;<span class="ident" id="3277419">fv</span><span class="op" id="3277421">,</span>&nbsp;<span class="ident" id="3277423">f</span><span class="op" id="3277424">.</span><span class="ident" id="3277425">quoted</span><span class="op" id="3277431">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277437">e</span><span class="op" id="3277438">.</span><span class="ident" id="3277439">WriteByte</span><span class="op" id="3277448">(</span><span class="string" id="3277449">&#39;}&#39;</span><span class="op" id="3277452">)</span><br>
<span class="lineno"></span><span class="op" id="3277454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3277457">func</span>&nbsp;<span class="ident" id="3277462">newStructEncoder</span><span class="op" id="3277478">(</span><span class="ident" id="3277479">t</span>&nbsp;<span class="ident" id="3277481">reflect</span><span class="op" id="3277488">.</span><span class="ident" id="3277489">Type</span><span class="op" id="3277493">)</span>&nbsp;<span class="ident" id="3277495">encoderFunc</span>&nbsp;<span class="op" id="3277507">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277510">fields</span>&nbsp;<span class="op" id="3277517">:=</span>&nbsp;<span class="ident" id="3277520">cachedTypeFields</span><span class="op" id="3277536">(</span><span class="ident" id="3277537">t</span><span class="op" id="3277538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277541">se</span>&nbsp;<span class="op" id="3277544">:=</span>&nbsp;<span class="op" id="3277547">&amp;</span><span class="ident" id="3277548">structEncoder</span><span class="op" id="3277561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277565">fields</span><span class="op" id="3277571">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3277576">fields</span><span class="op" id="3277582">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277586">fieldEncs</span><span class="op" id="3277595">:</span>&nbsp;<span class="builtinfunc" id="3277597">make</span><span class="op" id="3277601">(</span><span class="op" id="3277602">[</span><span class="op" id="3277603">]</span><span class="ident" id="3277604">encoderFunc</span><span class="op" id="3277615">,</span>&nbsp;<span class="builtinfunc" id="3277617">len</span><span class="op" id="3277620">(</span><span class="ident" id="3277621">fields</span><span class="op" id="3277627">)</span><span class="op" id="3277628">)</span><span class="op" id="3277629">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277632">}</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277635">for</span>&nbsp;<span class="ident" id="3277639">i</span><span class="op" id="3277640">,</span>&nbsp;<span class="ident" id="3277642">f</span>&nbsp;<span class="op" id="3277644">:=</span>&nbsp;<span class="keyword" id="3277647">range</span>&nbsp;<span class="ident" id="3277653">fields</span>&nbsp;<span class="op" id="3277660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277664">se</span><span class="op" id="3277666">.</span><span class="ident" id="3277667">fieldEncs</span><span class="op" id="3277676">[</span><span class="ident" id="3277677">i</span><span class="op" id="3277678">]</span>&nbsp;<span class="op" id="3277680">=</span>&nbsp;<span class="ident" id="3277682">typeEncoder</span><span class="op" id="3277693">(</span><span class="ident" id="3277694">typeByIndex</span><span class="op" id="3277705">(</span><span class="ident" id="3277706">t</span><span class="op" id="3277707">,</span>&nbsp;<span class="ident" id="3277709">f</span><span class="op" id="3277710">.</span><span class="ident" id="3277711">index</span><span class="op" id="3277716">)</span><span class="op" id="3277717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277720">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277723">return</span>&nbsp;<span class="ident" id="3277730">se</span><span class="op" id="3277732">.</span><span class="ident" id="3277733">encode</span><br>
<span class="lineno"></span><span class="op" id="3277740">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="3277743">type</span>&nbsp;<span class="ident" id="3277748">mapEncoder</span>&nbsp;<span class="keyword" id="3277759">struct</span>&nbsp;<span class="op" id="3277766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277769">elemEnc</span>&nbsp;<span class="ident" id="3277777">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3277789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="keyword" id="3277792">func</span>&nbsp;<span class="op" id="3277797">(</span><span class="ident" id="3277798">me</span>&nbsp;<span class="op" id="3277801">*</span><span class="ident" id="3277802">mapEncoder</span><span class="op" id="3277812">)</span>&nbsp;<span class="ident" id="3277814">encode</span><span class="op" id="3277820">(</span><span class="ident" id="3277821">e</span>&nbsp;<span class="op" id="3277823">*</span><span class="ident" id="3277824">encodeState</span><span class="op" id="3277835">,</span>&nbsp;<span class="ident" id="3277837">v</span>&nbsp;<span class="ident" id="3277839">reflect</span><span class="op" id="3277846">.</span><span class="ident" id="3277847">Value</span><span class="op" id="3277852">,</span>&nbsp;<span class="ident" id="3277854">_</span>&nbsp;<span class="builtintype" id="3277856">bool</span><span class="op" id="3277860">)</span>&nbsp;<span class="op" id="3277862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277865">if</span>&nbsp;<span class="ident" id="3277868">v</span><span class="op" id="3277869">.</span><span class="ident" id="3277870">IsNil</span><span class="op" id="3277875">(</span><span class="op" id="3277876">)</span>&nbsp;<span class="op" id="3277878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277882">e</span><span class="op" id="3277883">.</span><span class="ident" id="3277884">WriteString</span><span class="op" id="3277895">(</span><span class="string" id="3277896">&#34;null&#34;</span><span class="op" id="3277902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277906">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3277914">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277917">e</span><span class="op" id="3277918">.</span><span class="ident" id="3277919">WriteByte</span><span class="op" id="3277928">(</span><span class="string" id="3277929">&#39;{&#39;</span><span class="op" id="3277932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277935">var</span>&nbsp;<span class="ident" id="3277939">sv</span>&nbsp;<span class="ident" id="3277942">stringValues</span>&nbsp;<span class="op" id="3277955">=</span>&nbsp;<span class="ident" id="3277957">v</span><span class="op" id="3277958">.</span><span class="ident" id="3277959">MapKeys</span><span class="op" id="3277966">(</span><span class="op" id="3277967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3277970">sort</span><span class="op" id="3277974">.</span><span class="ident" id="3277975">Sort</span><span class="op" id="3277979">(</span><span class="ident" id="3277980">sv</span><span class="op" id="3277982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3277985">for</span>&nbsp;<span class="ident" id="3277989">i</span><span class="op" id="3277990">,</span>&nbsp;<span class="ident" id="3277992">k</span>&nbsp;<span class="op" id="3277994">:=</span>&nbsp;<span class="keyword" id="3277997">range</span>&nbsp;<span class="ident" id="3278003">sv</span>&nbsp;<span class="op" id="3278006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278010">if</span>&nbsp;<span class="ident" id="3278013">i</span>&nbsp;<span class="op" id="3278015">&gt;</span>&nbsp;<span class="num" id="3278017">0</span>&nbsp;<span class="op" id="3278019">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278024">e</span><span class="op" id="3278025">.</span><span class="ident" id="3278026">WriteByte</span><span class="op" id="3278035">(</span><span class="string" id="3278036">&#39;,&#39;</span><span class="op" id="3278039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278047">e</span><span class="op" id="3278048">.</span><span class="builtintype" id="3278049">string</span><span class="op" id="3278055">(</span><span class="ident" id="3278056">k</span><span class="op" id="3278057">.</span><span class="ident" id="3278058">String</span><span class="op" id="3278064">(</span><span class="op" id="3278065">)</span><span class="op" id="3278066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278070">e</span><span class="op" id="3278071">.</span><span class="ident" id="3278072">WriteByte</span><span class="op" id="3278081">(</span><span class="string" id="3278082">&#39;:&#39;</span><span class="op" id="3278085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278089">me</span><span class="op" id="3278091">.</span><span class="ident" id="3278092">elemEnc</span><span class="op" id="3278099">(</span><span class="ident" id="3278100">e</span><span class="op" id="3278101">,</span>&nbsp;<span class="ident" id="3278103">v</span><span class="op" id="3278104">.</span><span class="ident" id="3278105">MapIndex</span><span class="op" id="3278113">(</span><span class="ident" id="3278114">k</span><span class="op" id="3278115">)</span><span class="op" id="3278116">,</span>&nbsp;<span class="builtintype" id="3278118">false</span><span class="op" id="3278123">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278129">e</span><span class="op" id="3278130">.</span><span class="ident" id="3278131">WriteByte</span><span class="op" id="3278140">(</span><span class="string" id="3278141">&#39;}&#39;</span><span class="op" id="3278144">)</span><br>
<span class="lineno"></span><span class="op" id="3278146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3278149">func</span>&nbsp;<span class="ident" id="3278154">newMapEncoder</span><span class="op" id="3278167">(</span><span class="ident" id="3278168">t</span>&nbsp;<span class="ident" id="3278170">reflect</span><span class="op" id="3278177">.</span><span class="ident" id="3278178">Type</span><span class="op" id="3278182">)</span>&nbsp;<span class="ident" id="3278184">encoderFunc</span>&nbsp;<span class="op" id="3278196">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278199">if</span>&nbsp;<span class="ident" id="3278202">t</span><span class="op" id="3278203">.</span><span class="ident" id="3278204">Key</span><span class="op" id="3278207">(</span><span class="op" id="3278208">)</span><span class="op" id="3278209">.</span><span class="ident" id="3278210">Kind</span><span class="op" id="3278214">(</span><span class="op" id="3278215">)</span>&nbsp;<span class="op" id="3278217">!=</span>&nbsp;<span class="ident" id="3278220">reflect</span><span class="op" id="3278227">.</span><span class="ident" id="3278228">String</span>&nbsp;<span class="op" id="3278235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278239">return</span>&nbsp;<span class="ident" id="3278246">unsupportedTypeEncoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278273">me</span>&nbsp;<span class="op" id="3278276">:=</span>&nbsp;<span class="op" id="3278279">&amp;</span><span class="ident" id="3278280">mapEncoder</span><span class="op" id="3278290">{</span><span class="ident" id="3278291">typeEncoder</span><span class="op" id="3278302">(</span><span class="ident" id="3278303">t</span><span class="op" id="3278304">.</span><span class="ident" id="3278305">Elem</span><span class="op" id="3278309">(</span><span class="op" id="3278310">)</span><span class="op" id="3278311">)</span><span class="op" id="3278312">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278315">return</span>&nbsp;<span class="ident" id="3278322">me</span><span class="op" id="3278324">.</span><span class="ident" id="3278325">encode</span><br>
<span class="lineno">630</span><span class="op" id="3278332">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3278335">func</span>&nbsp;<span class="ident" id="3278340">encodeByteSlice</span><span class="op" id="3278355">(</span><span class="ident" id="3278356">e</span>&nbsp;<span class="op" id="3278358">*</span><span class="ident" id="3278359">encodeState</span><span class="op" id="3278370">,</span>&nbsp;<span class="ident" id="3278372">v</span>&nbsp;<span class="ident" id="3278374">reflect</span><span class="op" id="3278381">.</span><span class="ident" id="3278382">Value</span><span class="op" id="3278387">,</span>&nbsp;<span class="ident" id="3278389">_</span>&nbsp;<span class="builtintype" id="3278391">bool</span><span class="op" id="3278395">)</span>&nbsp;<span class="op" id="3278397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278400">if</span>&nbsp;<span class="ident" id="3278403">v</span><span class="op" id="3278404">.</span><span class="ident" id="3278405">IsNil</span><span class="op" id="3278410">(</span><span class="op" id="3278411">)</span>&nbsp;<span class="op" id="3278413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278417">e</span><span class="op" id="3278418">.</span><span class="ident" id="3278419">WriteString</span><span class="op" id="3278430">(</span><span class="string" id="3278431">&#34;null&#34;</span><span class="op" id="3278437">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278449">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278452">s</span>&nbsp;<span class="op" id="3278454">:=</span>&nbsp;<span class="ident" id="3278457">v</span><span class="op" id="3278458">.</span><span class="ident" id="3278459">Bytes</span><span class="op" id="3278464">(</span><span class="op" id="3278465">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278468">e</span><span class="op" id="3278469">.</span><span class="ident" id="3278470">WriteByte</span><span class="op" id="3278479">(</span><span class="string" id="3278480">&#39;&#34;&#39;</span><span class="op" id="3278483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3278486">if</span>&nbsp;<span class="builtinfunc" id="3278489">len</span><span class="op" id="3278492">(</span><span class="ident" id="3278493">s</span><span class="op" id="3278494">)</span>&nbsp;<span class="op" id="3278496">&lt;</span>&nbsp;<span class="num" id="3278498">1024</span>&nbsp;<span class="op" id="3278503">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3278507">//&nbsp;for&nbsp;small&nbsp;buffers,&nbsp;using&nbsp;Encode&nbsp;directly&nbsp;is&nbsp;much&nbsp;faster.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278569">dst</span>&nbsp;<span class="op" id="3278573">:=</span>&nbsp;<span class="builtinfunc" id="3278576">make</span><span class="op" id="3278580">(</span><span class="op" id="3278581">[</span><span class="op" id="3278582">]</span><span class="builtintype" id="3278583">byte</span><span class="op" id="3278587">,</span>&nbsp;<span class="ident" id="3278589">base64</span><span class="op" id="3278595">.</span><span class="ident" id="3278596">StdEncoding</span><span class="op" id="3278607">.</span><span class="ident" id="3278608">EncodedLen</span><span class="op" id="3278618">(</span><span class="builtinfunc" id="3278619">len</span><span class="op" id="3278622">(</span><span class="ident" id="3278623">s</span><span class="op" id="3278624">)</span><span class="op" id="3278625">)</span><span class="op" id="3278626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278630">base64</span><span class="op" id="3278636">.</span><span class="ident" id="3278637">StdEncoding</span><span class="op" id="3278648">.</span><span class="ident" id="3278649">Encode</span><span class="op" id="3278655">(</span><span class="ident" id="3278656">dst</span><span class="op" id="3278659">,</span>&nbsp;<span class="ident" id="3278661">s</span><span class="op" id="3278662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278666">e</span><span class="op" id="3278667">.</span><span class="ident" id="3278668">Write</span><span class="op" id="3278673">(</span><span class="ident" id="3278674">dst</span><span class="op" id="3278677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278680">}</span>&nbsp;<span class="keyword" id="3278682">else</span>&nbsp;<span class="op" id="3278687">{</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3278691">//&nbsp;for&nbsp;large&nbsp;buffers,&nbsp;avoid&nbsp;unnecessary&nbsp;extra&nbsp;temporary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3278749">//&nbsp;buffer&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278768">enc</span>&nbsp;<span class="op" id="3278772">:=</span>&nbsp;<span class="ident" id="3278775">base64</span><span class="op" id="3278781">.</span><span class="ident" id="3278782">NewEncoder</span><span class="op" id="3278792">(</span><span class="ident" id="3278793">base64</span><span class="op" id="3278799">.</span><span class="ident" id="3278800">StdEncoding</span><span class="op" id="3278811">,</span>&nbsp;<span class="ident" id="3278813">e</span><span class="op" id="3278814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278818">enc</span><span class="op" id="3278821">.</span><span class="ident" id="3278822">Write</span><span class="op" id="3278827">(</span><span class="ident" id="3278828">s</span><span class="op" id="3278829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278833">enc</span><span class="op" id="3278836">.</span><span class="ident" id="3278837">Close</span><span class="op" id="3278842">(</span><span class="op" id="3278843">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3278846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278849">e</span><span class="op" id="3278850">.</span><span class="ident" id="3278851">WriteByte</span><span class="op" id="3278860">(</span><span class="string" id="3278861">&#39;&#34;&#39;</span><span class="op" id="3278864">)</span><br>
<span class="lineno"></span><span class="op" id="3278866">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3278869">//&nbsp;sliceEncoder&nbsp;just&nbsp;wraps&nbsp;an&nbsp;arrayEncoder,&nbsp;checking&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;value&nbsp;isn&#39;t&nbsp;nil.</span><br>
<span class="lineno">655</span><span class="keyword" id="3278956">type</span>&nbsp;<span class="ident" id="3278961">sliceEncoder</span>&nbsp;<span class="keyword" id="3278974">struct</span>&nbsp;<span class="op" id="3278981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3278984">arrayEnc</span>&nbsp;<span class="ident" id="3278993">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3279005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3279008">func</span>&nbsp;<span class="op" id="3279013">(</span><span class="ident" id="3279014">se</span>&nbsp;<span class="op" id="3279017">*</span><span class="ident" id="3279018">sliceEncoder</span><span class="op" id="3279030">)</span>&nbsp;<span class="ident" id="3279032">encode</span><span class="op" id="3279038">(</span><span class="ident" id="3279039">e</span>&nbsp;<span class="op" id="3279041">*</span><span class="ident" id="3279042">encodeState</span><span class="op" id="3279053">,</span>&nbsp;<span class="ident" id="3279055">v</span>&nbsp;<span class="ident" id="3279057">reflect</span><span class="op" id="3279064">.</span><span class="ident" id="3279065">Value</span><span class="op" id="3279070">,</span>&nbsp;<span class="ident" id="3279072">_</span>&nbsp;<span class="builtintype" id="3279074">bool</span><span class="op" id="3279078">)</span>&nbsp;<span class="op" id="3279080">{</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279083">if</span>&nbsp;<span class="ident" id="3279086">v</span><span class="op" id="3279087">.</span><span class="ident" id="3279088">IsNil</span><span class="op" id="3279093">(</span><span class="op" id="3279094">)</span>&nbsp;<span class="op" id="3279096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279100">e</span><span class="op" id="3279101">.</span><span class="ident" id="3279102">WriteString</span><span class="op" id="3279113">(</span><span class="string" id="3279114">&#34;null&#34;</span><span class="op" id="3279120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279124">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3279132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279135">se</span><span class="op" id="3279137">.</span><span class="ident" id="3279138">arrayEnc</span><span class="op" id="3279146">(</span><span class="ident" id="3279147">e</span><span class="op" id="3279148">,</span>&nbsp;<span class="ident" id="3279150">v</span><span class="op" id="3279151">,</span>&nbsp;<span class="builtintype" id="3279153">false</span><span class="op" id="3279158">)</span><br>
<span class="lineno">665</span><span class="op" id="3279160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3279163">func</span>&nbsp;<span class="ident" id="3279168">newSliceEncoder</span><span class="op" id="3279183">(</span><span class="ident" id="3279184">t</span>&nbsp;<span class="ident" id="3279186">reflect</span><span class="op" id="3279193">.</span><span class="ident" id="3279194">Type</span><span class="op" id="3279198">)</span>&nbsp;<span class="ident" id="3279200">encoderFunc</span>&nbsp;<span class="op" id="3279212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3279215">//&nbsp;Byte&nbsp;slices&nbsp;get&nbsp;special&nbsp;treatment;&nbsp;arrays&nbsp;don&#39;t.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279268">if</span>&nbsp;<span class="ident" id="3279271">t</span><span class="op" id="3279272">.</span><span class="ident" id="3279273">Elem</span><span class="op" id="3279277">(</span><span class="op" id="3279278">)</span><span class="op" id="3279279">.</span><span class="ident" id="3279280">Kind</span><span class="op" id="3279284">(</span><span class="op" id="3279285">)</span>&nbsp;<span class="op" id="3279287">==</span>&nbsp;<span class="ident" id="3279290">reflect</span><span class="op" id="3279297">.</span><span class="ident" id="3279298">Uint8</span>&nbsp;<span class="op" id="3279304">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279308">return</span>&nbsp;<span class="ident" id="3279315">encodeByteSlice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3279332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279335">enc</span>&nbsp;<span class="op" id="3279339">:=</span>&nbsp;<span class="op" id="3279342">&amp;</span><span class="ident" id="3279343">sliceEncoder</span><span class="op" id="3279355">{</span><span class="ident" id="3279356">newArrayEncoder</span><span class="op" id="3279371">(</span><span class="ident" id="3279372">t</span><span class="op" id="3279373">)</span><span class="op" id="3279374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279377">return</span>&nbsp;<span class="ident" id="3279384">enc</span><span class="op" id="3279387">.</span><span class="ident" id="3279388">encode</span><br>
<span class="lineno"></span><span class="op" id="3279395">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="keyword" id="3279398">type</span>&nbsp;<span class="ident" id="3279403">arrayEncoder</span>&nbsp;<span class="keyword" id="3279416">struct</span>&nbsp;<span class="op" id="3279423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279426">elemEnc</span>&nbsp;<span class="ident" id="3279434">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3279446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">680</span><span class="keyword" id="3279449">func</span>&nbsp;<span class="op" id="3279454">(</span><span class="ident" id="3279455">ae</span>&nbsp;<span class="op" id="3279458">*</span><span class="ident" id="3279459">arrayEncoder</span><span class="op" id="3279471">)</span>&nbsp;<span class="ident" id="3279473">encode</span><span class="op" id="3279479">(</span><span class="ident" id="3279480">e</span>&nbsp;<span class="op" id="3279482">*</span><span class="ident" id="3279483">encodeState</span><span class="op" id="3279494">,</span>&nbsp;<span class="ident" id="3279496">v</span>&nbsp;<span class="ident" id="3279498">reflect</span><span class="op" id="3279505">.</span><span class="ident" id="3279506">Value</span><span class="op" id="3279511">,</span>&nbsp;<span class="ident" id="3279513">_</span>&nbsp;<span class="builtintype" id="3279515">bool</span><span class="op" id="3279519">)</span>&nbsp;<span class="op" id="3279521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279524">e</span><span class="op" id="3279525">.</span><span class="ident" id="3279526">WriteByte</span><span class="op" id="3279535">(</span><span class="string" id="3279536">&#39;[&#39;</span><span class="op" id="3279539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279542">n</span>&nbsp;<span class="op" id="3279544">:=</span>&nbsp;<span class="ident" id="3279547">v</span><span class="op" id="3279548">.</span><span class="ident" id="3279549">Len</span><span class="op" id="3279552">(</span><span class="op" id="3279553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279556">for</span>&nbsp;<span class="ident" id="3279560">i</span>&nbsp;<span class="op" id="3279562">:=</span>&nbsp;<span class="num" id="3279565">0</span><span class="op" id="3279566">;</span>&nbsp;<span class="ident" id="3279568">i</span>&nbsp;<span class="op" id="3279570">&lt;</span>&nbsp;<span class="ident" id="3279572">n</span><span class="op" id="3279573">;</span>&nbsp;<span class="ident" id="3279575">i</span><span class="op" id="3279576">++</span>&nbsp;<span class="op" id="3279579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279583">if</span>&nbsp;<span class="ident" id="3279586">i</span>&nbsp;<span class="op" id="3279588">&gt;</span>&nbsp;<span class="num" id="3279590">0</span>&nbsp;<span class="op" id="3279592">{</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279597">e</span><span class="op" id="3279598">.</span><span class="ident" id="3279599">WriteByte</span><span class="op" id="3279608">(</span><span class="string" id="3279609">&#39;,&#39;</span><span class="op" id="3279612">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3279616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279620">ae</span><span class="op" id="3279622">.</span><span class="ident" id="3279623">elemEnc</span><span class="op" id="3279630">(</span><span class="ident" id="3279631">e</span><span class="op" id="3279632">,</span>&nbsp;<span class="ident" id="3279634">v</span><span class="op" id="3279635">.</span><span class="ident" id="3279636">Index</span><span class="op" id="3279641">(</span><span class="ident" id="3279642">i</span><span class="op" id="3279643">)</span><span class="op" id="3279644">,</span>&nbsp;<span class="builtintype" id="3279646">false</span><span class="op" id="3279651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3279654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279657">e</span><span class="op" id="3279658">.</span><span class="ident" id="3279659">WriteByte</span><span class="op" id="3279668">(</span><span class="string" id="3279669">&#39;]&#39;</span><span class="op" id="3279672">)</span><br>
<span class="lineno">690</span><span class="op" id="3279674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3279677">func</span>&nbsp;<span class="ident" id="3279682">newArrayEncoder</span><span class="op" id="3279697">(</span><span class="ident" id="3279698">t</span>&nbsp;<span class="ident" id="3279700">reflect</span><span class="op" id="3279707">.</span><span class="ident" id="3279708">Type</span><span class="op" id="3279712">)</span>&nbsp;<span class="ident" id="3279714">encoderFunc</span>&nbsp;<span class="op" id="3279726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279729">enc</span>&nbsp;<span class="op" id="3279733">:=</span>&nbsp;<span class="op" id="3279736">&amp;</span><span class="ident" id="3279737">arrayEncoder</span><span class="op" id="3279749">{</span><span class="ident" id="3279750">typeEncoder</span><span class="op" id="3279761">(</span><span class="ident" id="3279762">t</span><span class="op" id="3279763">.</span><span class="ident" id="3279764">Elem</span><span class="op" id="3279768">(</span><span class="op" id="3279769">)</span><span class="op" id="3279770">)</span><span class="op" id="3279771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279774">return</span>&nbsp;<span class="ident" id="3279781">enc</span><span class="op" id="3279784">.</span><span class="ident" id="3279785">encode</span><br>
<span class="lineno">695</span><span class="op" id="3279792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3279795">type</span>&nbsp;<span class="ident" id="3279800">ptrEncoder</span>&nbsp;<span class="keyword" id="3279811">struct</span>&nbsp;<span class="op" id="3279818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279821">elemEnc</span>&nbsp;<span class="ident" id="3279829">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3279841">}</span><br>
<span class="lineno">700</span><br>
<span class="lineno"></span><span class="keyword" id="3279844">func</span>&nbsp;<span class="op" id="3279849">(</span><span class="ident" id="3279850">pe</span>&nbsp;<span class="op" id="3279853">*</span><span class="ident" id="3279854">ptrEncoder</span><span class="op" id="3279864">)</span>&nbsp;<span class="ident" id="3279866">encode</span><span class="op" id="3279872">(</span><span class="ident" id="3279873">e</span>&nbsp;<span class="op" id="3279875">*</span><span class="ident" id="3279876">encodeState</span><span class="op" id="3279887">,</span>&nbsp;<span class="ident" id="3279889">v</span>&nbsp;<span class="ident" id="3279891">reflect</span><span class="op" id="3279898">.</span><span class="ident" id="3279899">Value</span><span class="op" id="3279904">,</span>&nbsp;<span class="ident" id="3279906">quoted</span>&nbsp;<span class="builtintype" id="3279913">bool</span><span class="op" id="3279917">)</span>&nbsp;<span class="op" id="3279919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279922">if</span>&nbsp;<span class="ident" id="3279925">v</span><span class="op" id="3279926">.</span><span class="ident" id="3279927">IsNil</span><span class="op" id="3279932">(</span><span class="op" id="3279933">)</span>&nbsp;<span class="op" id="3279935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279939">e</span><span class="op" id="3279940">.</span><span class="ident" id="3279941">WriteString</span><span class="op" id="3279952">(</span><span class="string" id="3279953">&#34;null&#34;</span><span class="op" id="3279959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3279963">return</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3279971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3279974">pe</span><span class="op" id="3279976">.</span><span class="ident" id="3279977">elemEnc</span><span class="op" id="3279984">(</span><span class="ident" id="3279985">e</span><span class="op" id="3279986">,</span>&nbsp;<span class="ident" id="3279988">v</span><span class="op" id="3279989">.</span><span class="ident" id="3279990">Elem</span><span class="op" id="3279994">(</span><span class="op" id="3279995">)</span><span class="op" id="3279996">,</span>&nbsp;<span class="ident" id="3279998">quoted</span><span class="op" id="3280004">)</span><br>
<span class="lineno"></span><span class="op" id="3280006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3280009">func</span>&nbsp;<span class="ident" id="3280014">newPtrEncoder</span><span class="op" id="3280027">(</span><span class="ident" id="3280028">t</span>&nbsp;<span class="ident" id="3280030">reflect</span><span class="op" id="3280037">.</span><span class="ident" id="3280038">Type</span><span class="op" id="3280042">)</span>&nbsp;<span class="ident" id="3280044">encoderFunc</span>&nbsp;<span class="op" id="3280056">{</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3280059">enc</span>&nbsp;<span class="op" id="3280063">:=</span>&nbsp;<span class="op" id="3280066">&amp;</span><span class="ident" id="3280067">ptrEncoder</span><span class="op" id="3280077">{</span><span class="ident" id="3280078">typeEncoder</span><span class="op" id="3280089">(</span><span class="ident" id="3280090">t</span><span class="op" id="3280091">.</span><span class="ident" id="3280092">Elem</span><span class="op" id="3280096">(</span><span class="op" id="3280097">)</span><span class="op" id="3280098">)</span><span class="op" id="3280099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280102">return</span>&nbsp;<span class="ident" id="3280109">enc</span><span class="op" id="3280112">.</span><span class="ident" id="3280113">encode</span><br>
<span class="lineno"></span><span class="op" id="3280120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3280123">type</span>&nbsp;<span class="ident" id="3280128">condAddrEncoder</span>&nbsp;<span class="keyword" id="3280144">struct</span>&nbsp;<span class="op" id="3280151">{</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3280154">canAddrEnc</span><span class="op" id="3280164">,</span>&nbsp;<span class="ident" id="3280166">elseEnc</span>&nbsp;<span class="ident" id="3280174">encoderFunc</span><br>
<span class="lineno"></span><span class="op" id="3280186">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3280189">func</span>&nbsp;<span class="op" id="3280194">(</span><span class="ident" id="3280195">ce</span>&nbsp;<span class="op" id="3280198">*</span><span class="ident" id="3280199">condAddrEncoder</span><span class="op" id="3280214">)</span>&nbsp;<span class="ident" id="3280216">encode</span><span class="op" id="3280222">(</span><span class="ident" id="3280223">e</span>&nbsp;<span class="op" id="3280225">*</span><span class="ident" id="3280226">encodeState</span><span class="op" id="3280237">,</span>&nbsp;<span class="ident" id="3280239">v</span>&nbsp;<span class="ident" id="3280241">reflect</span><span class="op" id="3280248">.</span><span class="ident" id="3280249">Value</span><span class="op" id="3280254">,</span>&nbsp;<span class="ident" id="3280256">quoted</span>&nbsp;<span class="builtintype" id="3280263">bool</span><span class="op" id="3280267">)</span>&nbsp;<span class="op" id="3280269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280272">if</span>&nbsp;<span class="ident" id="3280275">v</span><span class="op" id="3280276">.</span><span class="ident" id="3280277">CanAddr</span><span class="op" id="3280284">(</span><span class="op" id="3280285">)</span>&nbsp;<span class="op" id="3280287">{</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3280291">ce</span><span class="op" id="3280293">.</span><span class="ident" id="3280294">canAddrEnc</span><span class="op" id="3280304">(</span><span class="ident" id="3280305">e</span><span class="op" id="3280306">,</span>&nbsp;<span class="ident" id="3280308">v</span><span class="op" id="3280309">,</span>&nbsp;<span class="ident" id="3280311">quoted</span><span class="op" id="3280317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3280320">}</span>&nbsp;<span class="keyword" id="3280322">else</span>&nbsp;<span class="op" id="3280327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3280331">ce</span><span class="op" id="3280333">.</span><span class="ident" id="3280334">elseEnc</span><span class="op" id="3280341">(</span><span class="ident" id="3280342">e</span><span class="op" id="3280343">,</span>&nbsp;<span class="ident" id="3280345">v</span><span class="op" id="3280346">,</span>&nbsp;<span class="ident" id="3280348">quoted</span><span class="op" id="3280354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3280357">}</span><br>
<span class="lineno"></span><span class="op" id="3280359">}</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="3280362">//&nbsp;newCondAddrEncoder&nbsp;returns&nbsp;an&nbsp;encoder&nbsp;that&nbsp;checks&nbsp;whether&nbsp;its&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3280433">//&nbsp;CanAddr&nbsp;and&nbsp;delegates&nbsp;to&nbsp;canAddrEnc&nbsp;if&nbsp;so,&nbsp;else&nbsp;to&nbsp;elseEnc.</span><br>
<span class="lineno"></span><span class="keyword" id="3280496">func</span>&nbsp;<span class="ident" id="3280501">newCondAddrEncoder</span><span class="op" id="3280519">(</span><span class="ident" id="3280520">canAddrEnc</span><span class="op" id="3280530">,</span>&nbsp;<span class="ident" id="3280532">elseEnc</span>&nbsp;<span class="ident" id="3280540">encoderFunc</span><span class="op" id="3280551">)</span>&nbsp;<span class="ident" id="3280553">encoderFunc</span>&nbsp;<span class="op" id="3280565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3280568">enc</span>&nbsp;<span class="op" id="3280572">:=</span>&nbsp;<span class="op" id="3280575">&amp;</span><span class="ident" id="3280576">condAddrEncoder</span><span class="op" id="3280591">{</span><span class="ident" id="3280592">canAddrEnc</span><span class="op" id="3280602">:</span>&nbsp;<span class="ident" id="3280604">canAddrEnc</span><span class="op" id="3280614">,</span>&nbsp;<span class="ident" id="3280616">elseEnc</span><span class="op" id="3280623">:</span>&nbsp;<span class="ident" id="3280625">elseEnc</span><span class="op" id="3280632">}</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280635">return</span>&nbsp;<span class="ident" id="3280642">enc</span><span class="op" id="3280645">.</span><span class="ident" id="3280646">encode</span><br>
<span class="lineno"></span><span class="op" id="3280653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3280656">func</span>&nbsp;<span class="ident" id="3280661">isValidTag</span><span class="op" id="3280671">(</span><span class="ident" id="3280672">s</span>&nbsp;<span class="builtintype" id="3280674">string</span><span class="op" id="3280680">)</span>&nbsp;<span class="builtintype" id="3280682">bool</span>&nbsp;<span class="op" id="3280687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280690">if</span>&nbsp;<span class="ident" id="3280693">s</span>&nbsp;<span class="op" id="3280695">==</span>&nbsp;<span class="string" id="3280698">&#34;&#34;</span>&nbsp;<span class="op" id="3280701">{</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280705">return</span>&nbsp;<span class="builtintype" id="3280712">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3280719">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280722">for</span>&nbsp;<span class="ident" id="3280726">_</span><span class="op" id="3280727">,</span>&nbsp;<span class="ident" id="3280729">c</span>&nbsp;<span class="op" id="3280731">:=</span>&nbsp;<span class="keyword" id="3280734">range</span>&nbsp;<span class="ident" id="3280740">s</span>&nbsp;<span class="op" id="3280742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280746">switch</span>&nbsp;<span class="op" id="3280753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280757">case</span>&nbsp;<span class="ident" id="3280762">strings</span><span class="op" id="3280769">.</span><span class="ident" id="3280770">ContainsRune</span><span class="op" id="3280782">(</span><span class="string" id="3280783">&#34;!#$%&amp;()*+-./:&lt;=&gt;?@[]^_{|}~&nbsp;&#34;</span><span class="op" id="3280812">,</span>&nbsp;<span class="ident" id="3280814">c</span><span class="op" id="3280815">)</span><span class="op" id="3280816">:</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3280821">//&nbsp;Backslash&nbsp;and&nbsp;quote&nbsp;chars&nbsp;are&nbsp;reserved,&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3280871">//&nbsp;otherwise&nbsp;any&nbsp;punctuation&nbsp;chars&nbsp;are&nbsp;allowed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3280921">//&nbsp;in&nbsp;a&nbsp;tag&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280941">default</span><span class="op" id="3280948">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3280953">if</span>&nbsp;<span class="op" id="3280956">!</span><span class="ident" id="3280957">unicode</span><span class="op" id="3280964">.</span><span class="ident" id="3280965">IsLetter</span><span class="op" id="3280973">(</span><span class="ident" id="3280974">c</span><span class="op" id="3280975">)</span>&nbsp;<span class="op" id="3280977">&amp;&amp;</span>&nbsp;<span class="op" id="3280980">!</span><span class="ident" id="3280981">unicode</span><span class="op" id="3280988">.</span><span class="ident" id="3280989">IsDigit</span><span class="op" id="3280996">(</span><span class="ident" id="3280997">c</span><span class="op" id="3280998">)</span>&nbsp;<span class="op" id="3281000">{</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281006">return</span>&nbsp;<span class="builtintype" id="3281013">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281032">return</span>&nbsp;<span class="builtintype" id="3281039">true</span><br>
<span class="lineno">750</span><span class="op" id="3281044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3281047">func</span>&nbsp;<span class="ident" id="3281052">fieldByIndex</span><span class="op" id="3281064">(</span><span class="ident" id="3281065">v</span>&nbsp;<span class="ident" id="3281067">reflect</span><span class="op" id="3281074">.</span><span class="ident" id="3281075">Value</span><span class="op" id="3281080">,</span>&nbsp;<span class="ident" id="3281082">index</span>&nbsp;<span class="op" id="3281088">[</span><span class="op" id="3281089">]</span><span class="builtintype" id="3281090">int</span><span class="op" id="3281093">)</span>&nbsp;<span class="ident" id="3281095">reflect</span><span class="op" id="3281102">.</span><span class="ident" id="3281103">Value</span>&nbsp;<span class="op" id="3281109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281112">for</span>&nbsp;<span class="ident" id="3281116">_</span><span class="op" id="3281117">,</span>&nbsp;<span class="ident" id="3281119">i</span>&nbsp;<span class="op" id="3281121">:=</span>&nbsp;<span class="keyword" id="3281124">range</span>&nbsp;<span class="ident" id="3281130">index</span>&nbsp;<span class="op" id="3281136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281140">if</span>&nbsp;<span class="ident" id="3281143">v</span><span class="op" id="3281144">.</span><span class="ident" id="3281145">Kind</span><span class="op" id="3281149">(</span><span class="op" id="3281150">)</span>&nbsp;<span class="op" id="3281152">==</span>&nbsp;<span class="ident" id="3281155">reflect</span><span class="op" id="3281162">.</span><span class="ident" id="3281163">Ptr</span>&nbsp;<span class="op" id="3281167">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281172">if</span>&nbsp;<span class="ident" id="3281175">v</span><span class="op" id="3281176">.</span><span class="ident" id="3281177">IsNil</span><span class="op" id="3281182">(</span><span class="op" id="3281183">)</span>&nbsp;<span class="op" id="3281185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281191">return</span>&nbsp;<span class="ident" id="3281198">reflect</span><span class="op" id="3281205">.</span><span class="ident" id="3281206">Value</span><span class="op" id="3281211">{</span><span class="op" id="3281212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3281222">v</span>&nbsp;<span class="op" id="3281224">=</span>&nbsp;<span class="ident" id="3281226">v</span><span class="op" id="3281227">.</span><span class="ident" id="3281228">Elem</span><span class="op" id="3281232">(</span><span class="op" id="3281233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281237">}</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3281241">v</span>&nbsp;<span class="op" id="3281243">=</span>&nbsp;<span class="ident" id="3281245">v</span><span class="op" id="3281246">.</span><span class="ident" id="3281247">Field</span><span class="op" id="3281252">(</span><span class="ident" id="3281253">i</span><span class="op" id="3281254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281257">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281260">return</span>&nbsp;<span class="ident" id="3281267">v</span><br>
<span class="lineno"></span><span class="op" id="3281269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">765</span><span class="keyword" id="3281272">func</span>&nbsp;<span class="ident" id="3281277">typeByIndex</span><span class="op" id="3281288">(</span><span class="ident" id="3281289">t</span>&nbsp;<span class="ident" id="3281291">reflect</span><span class="op" id="3281298">.</span><span class="ident" id="3281299">Type</span><span class="op" id="3281303">,</span>&nbsp;<span class="ident" id="3281305">index</span>&nbsp;<span class="op" id="3281311">[</span><span class="op" id="3281312">]</span><span class="builtintype" id="3281313">int</span><span class="op" id="3281316">)</span>&nbsp;<span class="ident" id="3281318">reflect</span><span class="op" id="3281325">.</span><span class="ident" id="3281326">Type</span>&nbsp;<span class="op" id="3281331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281334">for</span>&nbsp;<span class="ident" id="3281338">_</span><span class="op" id="3281339">,</span>&nbsp;<span class="ident" id="3281341">i</span>&nbsp;<span class="op" id="3281343">:=</span>&nbsp;<span class="keyword" id="3281346">range</span>&nbsp;<span class="ident" id="3281352">index</span>&nbsp;<span class="op" id="3281358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281362">if</span>&nbsp;<span class="ident" id="3281365">t</span><span class="op" id="3281366">.</span><span class="ident" id="3281367">Kind</span><span class="op" id="3281371">(</span><span class="op" id="3281372">)</span>&nbsp;<span class="op" id="3281374">==</span>&nbsp;<span class="ident" id="3281377">reflect</span><span class="op" id="3281384">.</span><span class="ident" id="3281385">Ptr</span>&nbsp;<span class="op" id="3281389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3281394">t</span>&nbsp;<span class="op" id="3281396">=</span>&nbsp;<span class="ident" id="3281398">t</span><span class="op" id="3281399">.</span><span class="ident" id="3281400">Elem</span><span class="op" id="3281404">(</span><span class="op" id="3281405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281409">}</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3281413">t</span>&nbsp;<span class="op" id="3281415">=</span>&nbsp;<span class="ident" id="3281417">t</span><span class="op" id="3281418">.</span><span class="ident" id="3281419">Field</span><span class="op" id="3281424">(</span><span class="ident" id="3281425">i</span><span class="op" id="3281426">)</span><span class="op" id="3281427">.</span><span class="ident" id="3281428">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3281434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3281437">return</span>&nbsp;<span class="ident" id="3281444">t</span><br>
<span class="lineno"></span><span class="op" id="3281446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">775</span><span class="comment" id="3281449">//&nbsp;stringValues&nbsp;is&nbsp;a&nbsp;slice&nbsp;of&nbsp;reflect.Value&nbsp;holding&nbsp;*reflect.StringValue.</span><br>
<span class="lineno"></span><span class="comment" id="3281523">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;methods&nbsp;to&nbsp;sort&nbsp;by&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3281571">type</span>&nbsp;<span class="ident" id="3281576">stringValues</span>&nbsp;<span class="op" id="3281589">[</span><span class="op" id="3281590">]</span><span class="ident" id="3281591">reflect</span><span class="op" id="3281598">.</span><span class="ident" id="3281599">Value</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3281606">func</span>&nbsp;<span class="op" id="3281611">(</span><span class="ident" id="3281612">sv</span>&nbsp;<span class="ident" id="3281615">stringValues</span><span class="op" id="3281627">)</span>&nbsp;<span class="ident" id="3281629">Len</span><span class="op" id="3281632">(</span><span class="op" id="3281633">)</span>&nbsp;<span class="builtintype" id="3281635">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3281649">{</span>&nbsp;<span class="keyword" id="3281651">return</span>&nbsp;<span class="builtinfunc" id="3281658">len</span><span class="op" id="3281661">(</span><span class="ident" id="3281662">sv</span><span class="op" id="3281664">)</span>&nbsp;<span class="op" id="3281666">}</span><br>
<span class="lineno">780</span><span class="keyword" id="3281668">func</span>&nbsp;<span class="op" id="3281673">(</span><span class="ident" id="3281674">sv</span>&nbsp;<span class="ident" id="3281677">stringValues</span><span class="op" id="3281689">)</span>&nbsp;<span class="ident" id="3281691">Swap</span><span class="op" id="3281695">(</span><span class="ident" id="3281696">i</span><span class="op" id="3281697">,</span>&nbsp;<span class="ident" id="3281699">j</span>&nbsp;<span class="builtintype" id="3281701">int</span><span class="op" id="3281704">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3281711">{</span>&nbsp;<span class="ident" id="3281713">sv</span><span class="op" id="3281715">[</span><span class="ident" id="3281716">i</span><span class="op" id="3281717">]</span><span class="op" id="3281718">,</span>&nbsp;<span class="ident" id="3281720">sv</span><span class="op" id="3281722">[</span><span class="ident" id="3281723">j</span><span class="op" id="3281724">]</span>&nbsp;<span class="op" id="3281726">=</span>&nbsp;<span class="ident" id="3281728">sv</span><span class="op" id="3281730">[</span><span class="ident" id="3281731">j</span><span class="op" id="3281732">]</span><span class="op" id="3281733">,</span>&nbsp;<span class="ident" id="3281735">sv</span><span class="op" id="3281737">[</span><span class="ident" id="3281738">i</span><span class="op" id="3281739">]</span>&nbsp;<span class="op" id="3281741">}</span><br>
<span class="lineno"></span><span class="keyword" id="3281743">func</span>&nbsp;<span class="op" id="3281748">(</span><span class="ident" id="3281749">sv</span>&nbsp;<span class="ident" id="3281752">stringValues</span><span class="op" id="3281764">)</span>&nbsp;<span class="ident" id="3281766">Less</span><span class="op" id="3281770">(</span><span class="ident" id="3281771">i</span><span class="op" id="3281772">,</span>&nbsp;<span class="ident" id="3281774">j</span>&nbsp;<span class="builtintype" id="3281776">int</span><span class="op" id="3281779">)</span>&nbsp;<span class="builtintype" id="3281781">bool</span>&nbsp;<span class="op" id="3281786">{</span>&nbsp;<span class="keyword" id="3281788">return</span>&nbsp;<span class="ident" id="3281795">sv</span><span class="op" id="3281797">.</span><span class="ident" id="3281798">get</span><span class="op" id="3281801">(</span><span class="ident" id="3281802">i</span><span class="op" id="3281803">)</span>&nbsp;<span class="op" id="3281805">&lt;</span>&nbsp;<span class="ident" id="3281807">sv</span><span class="op" id="3281809">.</span><span class="ident" id="3281810">get</span><span class="op" id="3281813">(</span><span class="ident" id="3281814">j</span><span class="op" id="3281815">)</span>&nbsp;<span class="op" id="3281817">}</span><br>
<span class="lineno"></span><span class="keyword" id="3281819">func</span>&nbsp;<span class="op" id="3281824">(</span><span class="ident" id="3281825">sv</span>&nbsp;<span class="ident" id="3281828">stringValues</span><span class="op" id="3281840">)</span>&nbsp;<span class="ident" id="3281842">get</span><span class="op" id="3281845">(</span><span class="ident" id="3281846">i</span>&nbsp;<span class="builtintype" id="3281848">int</span><span class="op" id="3281851">)</span>&nbsp;<span class="builtintype" id="3281853">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3281862">{</span>&nbsp;<span class="keyword" id="3281864">return</span>&nbsp;<span class="ident" id="3281871">sv</span><span class="op" id="3281873">[</span><span class="ident" id="3281874">i</span><span class="op" id="3281875">]</span><span class="op" id="3281876">.</span><span class="ident" id="3281877">String</span><span class="op" id="3281883">(</span><span class="op" id="3281884">)</span>&nbsp;<span class="op" id="3281886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3281889">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;stringBytes&nbsp;below.</span><br>
<span class="lineno">785</span><span class="keyword" id="3281935">func</span>&nbsp;<span class="op" id="3281940">(</span><span class="ident" id="3281941">e</span>&nbsp;<span class="op" id="3281943">*</span><span class="ident" id="3281944">encodeState</span><span class="op" id="3281955">)</span>&nbsp;<span class="builtintype" id="3281957">string</span><span class="op" id="3281963">(</span><span class="ident" id="3281964">s</span>&nbsp;<span class="builtintype" id="3281966">string</span><span class="op" id="3281972">)</span>&nbsp;<span class="op" id="3281974">(</span><span class="builtintype" id="3281975">int</span><span class="op" id="3281978">,</span>&nbsp;<span class="builtintype" id="3281980">error</span><span class="op" id="3281985">)</span>&nbsp;<span class="op" id="3281987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3281990">len0</span>&nbsp;<span class="op" id="3281995">:=</span>&nbsp;<span class="ident" id="3281998">e</span><span class="op" id="3281999">.</span><span class="ident" id="3282000">Len</span><span class="op" id="3282003">(</span><span class="op" id="3282004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282007">e</span><span class="op" id="3282008">.</span><span class="ident" id="3282009">WriteByte</span><span class="op" id="3282018">(</span><span class="string" id="3282019">&#39;&#34;&#39;</span><span class="op" id="3282022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282025">start</span>&nbsp;<span class="op" id="3282031">:=</span>&nbsp;<span class="num" id="3282034">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282037">for</span>&nbsp;<span class="ident" id="3282041">i</span>&nbsp;<span class="op" id="3282043">:=</span>&nbsp;<span class="num" id="3282046">0</span><span class="op" id="3282047">;</span>&nbsp;<span class="ident" id="3282049">i</span>&nbsp;<span class="op" id="3282051">&lt;</span>&nbsp;<span class="builtinfunc" id="3282053">len</span><span class="op" id="3282056">(</span><span class="ident" id="3282057">s</span><span class="op" id="3282058">)</span><span class="op" id="3282059">;</span>&nbsp;<span class="op" id="3282061">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282065">if</span>&nbsp;<span class="ident" id="3282068">b</span>&nbsp;<span class="op" id="3282070">:=</span>&nbsp;<span class="ident" id="3282073">s</span><span class="op" id="3282074">[</span><span class="ident" id="3282075">i</span><span class="op" id="3282076">]</span><span class="op" id="3282077">;</span>&nbsp;<span class="ident" id="3282079">b</span>&nbsp;<span class="op" id="3282081">&lt;</span>&nbsp;<span class="ident" id="3282083">utf8</span><span class="op" id="3282087">.</span><span class="ident" id="3282088">RuneSelf</span>&nbsp;<span class="op" id="3282097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282102">if</span>&nbsp;<span class="num" id="3282105">0x20</span>&nbsp;<span class="op" id="3282110">&lt;=</span>&nbsp;<span class="ident" id="3282113">b</span>&nbsp;<span class="op" id="3282115">&amp;&amp;</span>&nbsp;<span class="ident" id="3282118">b</span>&nbsp;<span class="op" id="3282120">!=</span>&nbsp;<span class="string" id="3282123">&#39;\\&#39;</span>&nbsp;<span class="op" id="3282128">&amp;&amp;</span>&nbsp;<span class="ident" id="3282131">b</span>&nbsp;<span class="op" id="3282133">!=</span>&nbsp;<span class="string" id="3282136">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3282140">&amp;&amp;</span>&nbsp;<span class="ident" id="3282143">b</span>&nbsp;<span class="op" id="3282145">!=</span>&nbsp;<span class="string" id="3282148">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3282152">&amp;&amp;</span>&nbsp;<span class="ident" id="3282155">b</span>&nbsp;<span class="op" id="3282157">!=</span>&nbsp;<span class="string" id="3282160">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3282164">&amp;&amp;</span>&nbsp;<span class="ident" id="3282167">b</span>&nbsp;<span class="op" id="3282169">!=</span>&nbsp;<span class="string" id="3282172">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3282176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282182">i</span><span class="op" id="3282183">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282190">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282202">}</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282207">if</span>&nbsp;<span class="ident" id="3282210">start</span>&nbsp;<span class="op" id="3282216">&lt;</span>&nbsp;<span class="ident" id="3282218">i</span>&nbsp;<span class="op" id="3282220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282226">e</span><span class="op" id="3282227">.</span><span class="ident" id="3282228">WriteString</span><span class="op" id="3282239">(</span><span class="ident" id="3282240">s</span><span class="op" id="3282241">[</span><span class="ident" id="3282242">start</span><span class="op" id="3282247">:</span><span class="ident" id="3282248">i</span><span class="op" id="3282249">]</span><span class="op" id="3282250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282255">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282260">switch</span>&nbsp;<span class="ident" id="3282267">b</span>&nbsp;<span class="op" id="3282269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282274">case</span>&nbsp;<span class="string" id="3282279">&#39;\\&#39;</span><span class="op" id="3282283">,</span>&nbsp;<span class="string" id="3282285">&#39;&#34;&#39;</span><span class="op" id="3282288">:</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282294">e</span><span class="op" id="3282295">.</span><span class="ident" id="3282296">WriteByte</span><span class="op" id="3282305">(</span><span class="string" id="3282306">&#39;\\&#39;</span><span class="op" id="3282310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282316">e</span><span class="op" id="3282317">.</span><span class="ident" id="3282318">WriteByte</span><span class="op" id="3282327">(</span><span class="ident" id="3282328">b</span><span class="op" id="3282329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282334">case</span>&nbsp;<span class="string" id="3282339">&#39;\n&#39;</span><span class="op" id="3282343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282349">e</span><span class="op" id="3282350">.</span><span class="ident" id="3282351">WriteByte</span><span class="op" id="3282360">(</span><span class="string" id="3282361">&#39;\\&#39;</span><span class="op" id="3282365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282371">e</span><span class="op" id="3282372">.</span><span class="ident" id="3282373">WriteByte</span><span class="op" id="3282382">(</span><span class="string" id="3282383">&#39;n&#39;</span><span class="op" id="3282386">)</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282391">case</span>&nbsp;<span class="string" id="3282396">&#39;\r&#39;</span><span class="op" id="3282400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282406">e</span><span class="op" id="3282407">.</span><span class="ident" id="3282408">WriteByte</span><span class="op" id="3282417">(</span><span class="string" id="3282418">&#39;\\&#39;</span><span class="op" id="3282422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282428">e</span><span class="op" id="3282429">.</span><span class="ident" id="3282430">WriteByte</span><span class="op" id="3282439">(</span><span class="string" id="3282440">&#39;r&#39;</span><span class="op" id="3282443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282448">case</span>&nbsp;<span class="string" id="3282453">&#39;\t&#39;</span><span class="op" id="3282457">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282463">e</span><span class="op" id="3282464">.</span><span class="ident" id="3282465">WriteByte</span><span class="op" id="3282474">(</span><span class="string" id="3282475">&#39;\\&#39;</span><span class="op" id="3282479">)</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282485">e</span><span class="op" id="3282486">.</span><span class="ident" id="3282487">WriteByte</span><span class="op" id="3282496">(</span><span class="string" id="3282497">&#39;t&#39;</span><span class="op" id="3282500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282505">default</span><span class="op" id="3282512">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282518">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282573">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282639">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3282702">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282761">e</span><span class="op" id="3282762">.</span><span class="ident" id="3282763">WriteString</span><span class="op" id="3282774">(</span><span class="string" id="3282775">`\u00`</span><span class="op" id="3282781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282787">e</span><span class="op" id="3282788">.</span><span class="ident" id="3282789">WriteByte</span><span class="op" id="3282798">(</span><span class="ident" id="3282799">hex</span><span class="op" id="3282802">[</span><span class="ident" id="3282803">b</span><span class="op" id="3282804">&gt;&gt;</span><span class="num" id="3282806">4</span><span class="op" id="3282807">]</span><span class="op" id="3282808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282814">e</span><span class="op" id="3282815">.</span><span class="ident" id="3282816">WriteByte</span><span class="op" id="3282825">(</span><span class="ident" id="3282826">hex</span><span class="op" id="3282829">[</span><span class="ident" id="3282830">b</span><span class="op" id="3282831">&amp;</span><span class="num" id="3282832">0xF</span><span class="op" id="3282835">]</span><span class="op" id="3282836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282841">}</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282846">i</span><span class="op" id="3282847">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282853">start</span>&nbsp;<span class="op" id="3282859">=</span>&nbsp;<span class="ident" id="3282861">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282866">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3282877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282881">c</span><span class="op" id="3282882">,</span>&nbsp;<span class="ident" id="3282884">size</span>&nbsp;<span class="op" id="3282889">:=</span>&nbsp;<span class="ident" id="3282892">utf8</span><span class="op" id="3282896">.</span><span class="ident" id="3282897">DecodeRuneInString</span><span class="op" id="3282915">(</span><span class="ident" id="3282916">s</span><span class="op" id="3282917">[</span><span class="ident" id="3282918">i</span><span class="op" id="3282919">:</span><span class="op" id="3282920">]</span><span class="op" id="3282921">)</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282925">if</span>&nbsp;<span class="ident" id="3282928">c</span>&nbsp;<span class="op" id="3282930">==</span>&nbsp;<span class="ident" id="3282933">utf8</span><span class="op" id="3282937">.</span><span class="ident" id="3282938">RuneError</span>&nbsp;<span class="op" id="3282948">&amp;&amp;</span>&nbsp;<span class="ident" id="3282951">size</span>&nbsp;<span class="op" id="3282956">==</span>&nbsp;<span class="num" id="3282959">1</span>&nbsp;<span class="op" id="3282961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3282966">if</span>&nbsp;<span class="ident" id="3282969">start</span>&nbsp;<span class="op" id="3282975">&lt;</span>&nbsp;<span class="ident" id="3282977">i</span>&nbsp;<span class="op" id="3282979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3282985">e</span><span class="op" id="3282986">.</span><span class="ident" id="3282987">WriteString</span><span class="op" id="3282998">(</span><span class="ident" id="3282999">s</span><span class="op" id="3283000">[</span><span class="ident" id="3283001">start</span><span class="op" id="3283006">:</span><span class="ident" id="3283007">i</span><span class="op" id="3283008">]</span><span class="op" id="3283009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283019">e</span><span class="op" id="3283020">.</span><span class="ident" id="3283021">WriteString</span><span class="op" id="3283032">(</span><span class="string" id="3283033">`\ufffd`</span><span class="op" id="3283041">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283046">i</span>&nbsp;<span class="op" id="3283048">+=</span>&nbsp;<span class="ident" id="3283051">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283059">start</span>&nbsp;<span class="op" id="3283065">=</span>&nbsp;<span class="ident" id="3283067">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283072">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283087">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283118">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283154">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283219">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283290">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283353">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3283400">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283479">if</span>&nbsp;<span class="ident" id="3283482">c</span>&nbsp;<span class="op" id="3283484">==</span>&nbsp;<span class="string" id="3283487">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3283496">||</span>&nbsp;<span class="ident" id="3283499">c</span>&nbsp;<span class="op" id="3283501">==</span>&nbsp;<span class="string" id="3283504">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3283513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283518">if</span>&nbsp;<span class="ident" id="3283521">start</span>&nbsp;<span class="op" id="3283527">&lt;</span>&nbsp;<span class="ident" id="3283529">i</span>&nbsp;<span class="op" id="3283531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283537">e</span><span class="op" id="3283538">.</span><span class="ident" id="3283539">WriteString</span><span class="op" id="3283550">(</span><span class="ident" id="3283551">s</span><span class="op" id="3283552">[</span><span class="ident" id="3283553">start</span><span class="op" id="3283558">:</span><span class="ident" id="3283559">i</span><span class="op" id="3283560">]</span><span class="op" id="3283561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283566">}</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283571">e</span><span class="op" id="3283572">.</span><span class="ident" id="3283573">WriteString</span><span class="op" id="3283584">(</span><span class="string" id="3283585">`\u202`</span><span class="op" id="3283592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283597">e</span><span class="op" id="3283598">.</span><span class="ident" id="3283599">WriteByte</span><span class="op" id="3283608">(</span><span class="ident" id="3283609">hex</span><span class="op" id="3283612">[</span><span class="ident" id="3283613">c</span><span class="op" id="3283614">&amp;</span><span class="num" id="3283615">0xF</span><span class="op" id="3283618">]</span><span class="op" id="3283619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283624">i</span>&nbsp;<span class="op" id="3283626">+=</span>&nbsp;<span class="ident" id="3283629">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283637">start</span>&nbsp;<span class="op" id="3283643">=</span>&nbsp;<span class="ident" id="3283645">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283650">continue</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283665">i</span>&nbsp;<span class="op" id="3283667">+=</span>&nbsp;<span class="ident" id="3283670">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283679">if</span>&nbsp;<span class="ident" id="3283682">start</span>&nbsp;<span class="op" id="3283688">&lt;</span>&nbsp;<span class="builtinfunc" id="3283690">len</span><span class="op" id="3283693">(</span><span class="ident" id="3283694">s</span><span class="op" id="3283695">)</span>&nbsp;<span class="op" id="3283697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283701">e</span><span class="op" id="3283702">.</span><span class="ident" id="3283703">WriteString</span><span class="op" id="3283714">(</span><span class="ident" id="3283715">s</span><span class="op" id="3283716">[</span><span class="ident" id="3283717">start</span><span class="op" id="3283722">:</span><span class="op" id="3283723">]</span><span class="op" id="3283724">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3283727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283730">e</span><span class="op" id="3283731">.</span><span class="ident" id="3283732">WriteByte</span><span class="op" id="3283741">(</span><span class="string" id="3283742">&#39;&#34;&#39;</span><span class="op" id="3283745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283748">return</span>&nbsp;<span class="ident" id="3283755">e</span><span class="op" id="3283756">.</span><span class="ident" id="3283757">Len</span><span class="op" id="3283760">(</span><span class="op" id="3283761">)</span>&nbsp;<span class="op" id="3283763">-</span>&nbsp;<span class="ident" id="3283765">len0</span><span class="op" id="3283769">,</span>&nbsp;<span class="ident" id="3283771">nil</span><br>
<span class="lineno"></span><span class="op" id="3283775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span><span class="comment" id="3283778">//&nbsp;NOTE:&nbsp;keep&nbsp;in&nbsp;sync&nbsp;with&nbsp;string&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="3283819">func</span>&nbsp;<span class="op" id="3283824">(</span><span class="ident" id="3283825">e</span>&nbsp;<span class="op" id="3283827">*</span><span class="ident" id="3283828">encodeState</span><span class="op" id="3283839">)</span>&nbsp;<span class="ident" id="3283841">stringBytes</span><span class="op" id="3283852">(</span><span class="ident" id="3283853">s</span>&nbsp;<span class="op" id="3283855">[</span><span class="op" id="3283856">]</span><span class="builtintype" id="3283857">byte</span><span class="op" id="3283861">)</span>&nbsp;<span class="op" id="3283863">(</span><span class="builtintype" id="3283864">int</span><span class="op" id="3283867">,</span>&nbsp;<span class="builtintype" id="3283869">error</span><span class="op" id="3283874">)</span>&nbsp;<span class="op" id="3283876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283879">len0</span>&nbsp;<span class="op" id="3283884">:=</span>&nbsp;<span class="ident" id="3283887">e</span><span class="op" id="3283888">.</span><span class="ident" id="3283889">Len</span><span class="op" id="3283892">(</span><span class="op" id="3283893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283896">e</span><span class="op" id="3283897">.</span><span class="ident" id="3283898">WriteByte</span><span class="op" id="3283907">(</span><span class="string" id="3283908">&#39;&#34;&#39;</span><span class="op" id="3283911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3283914">start</span>&nbsp;<span class="op" id="3283920">:=</span>&nbsp;<span class="num" id="3283923">0</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283926">for</span>&nbsp;<span class="ident" id="3283930">i</span>&nbsp;<span class="op" id="3283932">:=</span>&nbsp;<span class="num" id="3283935">0</span><span class="op" id="3283936">;</span>&nbsp;<span class="ident" id="3283938">i</span>&nbsp;<span class="op" id="3283940">&lt;</span>&nbsp;<span class="builtinfunc" id="3283942">len</span><span class="op" id="3283945">(</span><span class="ident" id="3283946">s</span><span class="op" id="3283947">)</span><span class="op" id="3283948">;</span>&nbsp;<span class="op" id="3283950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283954">if</span>&nbsp;<span class="ident" id="3283957">b</span>&nbsp;<span class="op" id="3283959">:=</span>&nbsp;<span class="ident" id="3283962">s</span><span class="op" id="3283963">[</span><span class="ident" id="3283964">i</span><span class="op" id="3283965">]</span><span class="op" id="3283966">;</span>&nbsp;<span class="ident" id="3283968">b</span>&nbsp;<span class="op" id="3283970">&lt;</span>&nbsp;<span class="ident" id="3283972">utf8</span><span class="op" id="3283976">.</span><span class="ident" id="3283977">RuneSelf</span>&nbsp;<span class="op" id="3283986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3283991">if</span>&nbsp;<span class="num" id="3283994">0x20</span>&nbsp;<span class="op" id="3283999">&lt;=</span>&nbsp;<span class="ident" id="3284002">b</span>&nbsp;<span class="op" id="3284004">&amp;&amp;</span>&nbsp;<span class="ident" id="3284007">b</span>&nbsp;<span class="op" id="3284009">!=</span>&nbsp;<span class="string" id="3284012">&#39;\\&#39;</span>&nbsp;<span class="op" id="3284017">&amp;&amp;</span>&nbsp;<span class="ident" id="3284020">b</span>&nbsp;<span class="op" id="3284022">!=</span>&nbsp;<span class="string" id="3284025">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="3284029">&amp;&amp;</span>&nbsp;<span class="ident" id="3284032">b</span>&nbsp;<span class="op" id="3284034">!=</span>&nbsp;<span class="string" id="3284037">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="3284041">&amp;&amp;</span>&nbsp;<span class="ident" id="3284044">b</span>&nbsp;<span class="op" id="3284046">!=</span>&nbsp;<span class="string" id="3284049">&#39;&gt;&#39;</span>&nbsp;<span class="op" id="3284053">&amp;&amp;</span>&nbsp;<span class="ident" id="3284056">b</span>&nbsp;<span class="op" id="3284058">!=</span>&nbsp;<span class="string" id="3284061">&#39;&amp;&#39;</span>&nbsp;<span class="op" id="3284065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284071">i</span><span class="op" id="3284072">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284079">continue</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284096">if</span>&nbsp;<span class="ident" id="3284099">start</span>&nbsp;<span class="op" id="3284105">&lt;</span>&nbsp;<span class="ident" id="3284107">i</span>&nbsp;<span class="op" id="3284109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284115">e</span><span class="op" id="3284116">.</span><span class="ident" id="3284117">Write</span><span class="op" id="3284122">(</span><span class="ident" id="3284123">s</span><span class="op" id="3284124">[</span><span class="ident" id="3284125">start</span><span class="op" id="3284130">:</span><span class="ident" id="3284131">i</span><span class="op" id="3284132">]</span><span class="op" id="3284133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284143">switch</span>&nbsp;<span class="ident" id="3284150">b</span>&nbsp;<span class="op" id="3284152">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284157">case</span>&nbsp;<span class="string" id="3284162">&#39;\\&#39;</span><span class="op" id="3284166">,</span>&nbsp;<span class="string" id="3284168">&#39;&#34;&#39;</span><span class="op" id="3284171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284177">e</span><span class="op" id="3284178">.</span><span class="ident" id="3284179">WriteByte</span><span class="op" id="3284188">(</span><span class="string" id="3284189">&#39;\\&#39;</span><span class="op" id="3284193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284199">e</span><span class="op" id="3284200">.</span><span class="ident" id="3284201">WriteByte</span><span class="op" id="3284210">(</span><span class="ident" id="3284211">b</span><span class="op" id="3284212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284217">case</span>&nbsp;<span class="string" id="3284222">&#39;\n&#39;</span><span class="op" id="3284226">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284232">e</span><span class="op" id="3284233">.</span><span class="ident" id="3284234">WriteByte</span><span class="op" id="3284243">(</span><span class="string" id="3284244">&#39;\\&#39;</span><span class="op" id="3284248">)</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284254">e</span><span class="op" id="3284255">.</span><span class="ident" id="3284256">WriteByte</span><span class="op" id="3284265">(</span><span class="string" id="3284266">&#39;n&#39;</span><span class="op" id="3284269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284274">case</span>&nbsp;<span class="string" id="3284279">&#39;\r&#39;</span><span class="op" id="3284283">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284289">e</span><span class="op" id="3284290">.</span><span class="ident" id="3284291">WriteByte</span><span class="op" id="3284300">(</span><span class="string" id="3284301">&#39;\\&#39;</span><span class="op" id="3284305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284311">e</span><span class="op" id="3284312">.</span><span class="ident" id="3284313">WriteByte</span><span class="op" id="3284322">(</span><span class="string" id="3284323">&#39;r&#39;</span><span class="op" id="3284326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284331">case</span>&nbsp;<span class="string" id="3284336">&#39;\t&#39;</span><span class="op" id="3284340">:</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284346">e</span><span class="op" id="3284347">.</span><span class="ident" id="3284348">WriteByte</span><span class="op" id="3284357">(</span><span class="string" id="3284358">&#39;\\&#39;</span><span class="op" id="3284362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284368">e</span><span class="op" id="3284369">.</span><span class="ident" id="3284370">WriteByte</span><span class="op" id="3284379">(</span><span class="string" id="3284380">&#39;t&#39;</span><span class="op" id="3284383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284388">default</span><span class="op" id="3284395">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284401">//&nbsp;This&nbsp;encodes&nbsp;bytes&nbsp;&lt;&nbsp;0x20&nbsp;except&nbsp;for&nbsp;\n&nbsp;and&nbsp;\r,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284456">//&nbsp;as&nbsp;well&nbsp;as&nbsp;&lt;,&nbsp;&gt;,&nbsp;and&nbsp;&amp;.&nbsp;The&nbsp;latter&nbsp;are&nbsp;escaped&nbsp;because&nbsp;they</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284523">//&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;when&nbsp;user-controlled&nbsp;strings</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284586">//&nbsp;are&nbsp;rendered&nbsp;into&nbsp;JSON&nbsp;and&nbsp;served&nbsp;to&nbsp;some&nbsp;browsers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284645">e</span><span class="op" id="3284646">.</span><span class="ident" id="3284647">WriteString</span><span class="op" id="3284658">(</span><span class="string" id="3284659">`\u00`</span><span class="op" id="3284665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284671">e</span><span class="op" id="3284672">.</span><span class="ident" id="3284673">WriteByte</span><span class="op" id="3284682">(</span><span class="ident" id="3284683">hex</span><span class="op" id="3284686">[</span><span class="ident" id="3284687">b</span><span class="op" id="3284688">&gt;&gt;</span><span class="num" id="3284690">4</span><span class="op" id="3284691">]</span><span class="op" id="3284692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284698">e</span><span class="op" id="3284699">.</span><span class="ident" id="3284700">WriteByte</span><span class="op" id="3284709">(</span><span class="ident" id="3284710">hex</span><span class="op" id="3284713">[</span><span class="ident" id="3284714">b</span><span class="op" id="3284715">&amp;</span><span class="num" id="3284716">0xF</span><span class="op" id="3284719">]</span><span class="op" id="3284720">)</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284730">i</span><span class="op" id="3284731">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284737">start</span>&nbsp;<span class="op" id="3284743">=</span>&nbsp;<span class="ident" id="3284745">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284750">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284761">}</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284765">c</span><span class="op" id="3284766">,</span>&nbsp;<span class="ident" id="3284768">size</span>&nbsp;<span class="op" id="3284773">:=</span>&nbsp;<span class="ident" id="3284776">utf8</span><span class="op" id="3284780">.</span><span class="ident" id="3284781">DecodeRune</span><span class="op" id="3284791">(</span><span class="ident" id="3284792">s</span><span class="op" id="3284793">[</span><span class="ident" id="3284794">i</span><span class="op" id="3284795">:</span><span class="op" id="3284796">]</span><span class="op" id="3284797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284801">if</span>&nbsp;<span class="ident" id="3284804">c</span>&nbsp;<span class="op" id="3284806">==</span>&nbsp;<span class="ident" id="3284809">utf8</span><span class="op" id="3284813">.</span><span class="ident" id="3284814">RuneError</span>&nbsp;<span class="op" id="3284824">&amp;&amp;</span>&nbsp;<span class="ident" id="3284827">size</span>&nbsp;<span class="op" id="3284832">==</span>&nbsp;<span class="num" id="3284835">1</span>&nbsp;<span class="op" id="3284837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284842">if</span>&nbsp;<span class="ident" id="3284845">start</span>&nbsp;<span class="op" id="3284851">&lt;</span>&nbsp;<span class="ident" id="3284853">i</span>&nbsp;<span class="op" id="3284855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284861">e</span><span class="op" id="3284862">.</span><span class="ident" id="3284863">Write</span><span class="op" id="3284868">(</span><span class="ident" id="3284869">s</span><span class="op" id="3284870">[</span><span class="ident" id="3284871">start</span><span class="op" id="3284876">:</span><span class="ident" id="3284877">i</span><span class="op" id="3284878">]</span><span class="op" id="3284879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284884">}</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284889">e</span><span class="op" id="3284890">.</span><span class="ident" id="3284891">WriteString</span><span class="op" id="3284902">(</span><span class="string" id="3284903">`\ufffd`</span><span class="op" id="3284911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284916">i</span>&nbsp;<span class="op" id="3284918">+=</span>&nbsp;<span class="ident" id="3284921">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3284929">start</span>&nbsp;<span class="op" id="3284935">=</span>&nbsp;<span class="ident" id="3284937">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3284942">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3284953">}</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284957">//&nbsp;U+2028&nbsp;is&nbsp;LINE&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3284988">//&nbsp;U+2029&nbsp;is&nbsp;PARAGRAPH&nbsp;SEPARATOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285024">//&nbsp;They&nbsp;are&nbsp;both&nbsp;technically&nbsp;valid&nbsp;characters&nbsp;in&nbsp;JSON&nbsp;strings,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285089">//&nbsp;but&nbsp;don&#39;t&nbsp;work&nbsp;in&nbsp;JSONP,&nbsp;which&nbsp;has&nbsp;to&nbsp;be&nbsp;evaluated&nbsp;as&nbsp;JavaScript,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285160">//&nbsp;and&nbsp;can&nbsp;lead&nbsp;to&nbsp;security&nbsp;holes&nbsp;there.&nbsp;It&nbsp;is&nbsp;valid&nbsp;JSON&nbsp;to</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285223">//&nbsp;escape&nbsp;them,&nbsp;so&nbsp;we&nbsp;do&nbsp;so&nbsp;unconditionally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3285270">//&nbsp;See&nbsp;http://timelessrepo.com/json-isnt-a-javascript-subset&nbsp;for&nbsp;discussion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285349">if</span>&nbsp;<span class="ident" id="3285352">c</span>&nbsp;<span class="op" id="3285354">==</span>&nbsp;<span class="string" id="3285357">&#39;\u2028&#39;</span>&nbsp;<span class="op" id="3285366">||</span>&nbsp;<span class="ident" id="3285369">c</span>&nbsp;<span class="op" id="3285371">==</span>&nbsp;<span class="string" id="3285374">&#39;\u2029&#39;</span>&nbsp;<span class="op" id="3285383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285388">if</span>&nbsp;<span class="ident" id="3285391">start</span>&nbsp;<span class="op" id="3285397">&lt;</span>&nbsp;<span class="ident" id="3285399">i</span>&nbsp;<span class="op" id="3285401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285407">e</span><span class="op" id="3285408">.</span><span class="ident" id="3285409">Write</span><span class="op" id="3285414">(</span><span class="ident" id="3285415">s</span><span class="op" id="3285416">[</span><span class="ident" id="3285417">start</span><span class="op" id="3285422">:</span><span class="ident" id="3285423">i</span><span class="op" id="3285424">]</span><span class="op" id="3285425">)</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285435">e</span><span class="op" id="3285436">.</span><span class="ident" id="3285437">WriteString</span><span class="op" id="3285448">(</span><span class="string" id="3285449">`\u202`</span><span class="op" id="3285456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285461">e</span><span class="op" id="3285462">.</span><span class="ident" id="3285463">WriteByte</span><span class="op" id="3285472">(</span><span class="ident" id="3285473">hex</span><span class="op" id="3285476">[</span><span class="ident" id="3285477">c</span><span class="op" id="3285478">&amp;</span><span class="num" id="3285479">0xF</span><span class="op" id="3285482">]</span><span class="op" id="3285483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285488">i</span>&nbsp;<span class="op" id="3285490">+=</span>&nbsp;<span class="ident" id="3285493">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285501">start</span>&nbsp;<span class="op" id="3285507">=</span>&nbsp;<span class="ident" id="3285509">i</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285514">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285529">i</span>&nbsp;<span class="op" id="3285531">+=</span>&nbsp;<span class="ident" id="3285534">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285543">if</span>&nbsp;<span class="ident" id="3285546">start</span>&nbsp;<span class="op" id="3285552">&lt;</span>&nbsp;<span class="builtinfunc" id="3285554">len</span><span class="op" id="3285557">(</span><span class="ident" id="3285558">s</span><span class="op" id="3285559">)</span>&nbsp;<span class="op" id="3285561">{</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285565">e</span><span class="op" id="3285566">.</span><span class="ident" id="3285567">Write</span><span class="op" id="3285572">(</span><span class="ident" id="3285573">s</span><span class="op" id="3285574">[</span><span class="ident" id="3285575">start</span><span class="op" id="3285580">:</span><span class="op" id="3285581">]</span><span class="op" id="3285582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3285585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285588">e</span><span class="op" id="3285589">.</span><span class="ident" id="3285590">WriteByte</span><span class="op" id="3285599">(</span><span class="string" id="3285600">&#39;&#34;&#39;</span><span class="op" id="3285603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3285606">return</span>&nbsp;<span class="ident" id="3285613">e</span><span class="op" id="3285614">.</span><span class="ident" id="3285615">Len</span><span class="op" id="3285618">(</span><span class="op" id="3285619">)</span>&nbsp;<span class="op" id="3285621">-</span>&nbsp;<span class="ident" id="3285623">len0</span><span class="op" id="3285627">,</span>&nbsp;<span class="ident" id="3285629">nil</span><br>
<span class="lineno"></span><span class="op" id="3285633">}</span><br>
<span class="lineno">935</span><br>
<span class="lineno"></span><span class="comment" id="3285636">//&nbsp;A&nbsp;field&nbsp;represents&nbsp;a&nbsp;single&nbsp;field&nbsp;found&nbsp;in&nbsp;a&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="3285692">type</span>&nbsp;<span class="ident" id="3285697">field</span>&nbsp;<span class="keyword" id="3285703">struct</span>&nbsp;<span class="op" id="3285710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285713">name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3285723">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285731">nameBytes</span>&nbsp;<span class="op" id="3285741">[</span><span class="op" id="3285742">]</span><span class="builtintype" id="3285743">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3285764">//&nbsp;[]byte(name)</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285781">equalFold</span>&nbsp;<span class="keyword" id="3285791">func</span><span class="op" id="3285795">(</span><span class="ident" id="3285796">s</span><span class="op" id="3285797">,</span>&nbsp;<span class="ident" id="3285799">t</span>&nbsp;<span class="op" id="3285801">[</span><span class="op" id="3285802">]</span><span class="builtintype" id="3285803">byte</span><span class="op" id="3285807">)</span>&nbsp;<span class="builtintype" id="3285809">bool</span>&nbsp;<span class="comment" id="3285814">//&nbsp;bytes.EqualFold&nbsp;or&nbsp;equivalent</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285849">tag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3285859">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285865">index</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3285875">[</span><span class="op" id="3285876">]</span><span class="builtintype" id="3285877">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285882">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3285892">reflect</span><span class="op" id="3285899">.</span><span class="ident" id="3285900">Type</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285906">omitEmpty</span>&nbsp;<span class="builtintype" id="3285916">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285922">quoted</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3285932">bool</span><br>
<span class="lineno"></span><span class="op" id="3285937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3285940">func</span>&nbsp;<span class="ident" id="3285945">fillField</span><span class="op" id="3285954">(</span><span class="ident" id="3285955">f</span>&nbsp;<span class="ident" id="3285957">field</span><span class="op" id="3285962">)</span>&nbsp;<span class="ident" id="3285964">field</span>&nbsp;<span class="op" id="3285970">{</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3285973">f</span><span class="op" id="3285974">.</span><span class="ident" id="3285975">nameBytes</span>&nbsp;<span class="op" id="3285985">=</span>&nbsp;<span class="op" id="3285987">[</span><span class="op" id="3285988">]</span><span class="builtintype" id="3285989">byte</span><span class="op" id="3285993">(</span><span class="ident" id="3285994">f</span><span class="op" id="3285995">.</span><span class="ident" id="3285996">name</span><span class="op" id="3286000">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3286003">f</span><span class="op" id="3286004">.</span><span class="ident" id="3286005">equalFold</span>&nbsp;<span class="op" id="3286015">=</span>&nbsp;<span class="ident" id="3286017">foldFunc</span><span class="op" id="3286025">(</span><span class="ident" id="3286026">f</span><span class="op" id="3286027">.</span><span class="ident" id="3286028">nameBytes</span><span class="op" id="3286037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286040">return</span>&nbsp;<span class="ident" id="3286047">f</span><br>
<span class="lineno"></span><span class="op" id="3286049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">955</span><span class="comment" id="3286052">//&nbsp;byName&nbsp;sorts&nbsp;field&nbsp;by&nbsp;name,&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;depth,</span><br>
<span class="lineno"></span><span class="comment" id="3286109">//&nbsp;then&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;&#34;name&nbsp;came&nbsp;from&nbsp;json&nbsp;tag&#34;,&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="3286168">//&nbsp;breaking&nbsp;ties&nbsp;with&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3286206">type</span>&nbsp;<span class="ident" id="3286211">byName</span>&nbsp;<span class="op" id="3286218">[</span><span class="op" id="3286219">]</span><span class="ident" id="3286220">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">960</span><span class="keyword" id="3286227">func</span>&nbsp;<span class="op" id="3286232">(</span><span class="ident" id="3286233">x</span>&nbsp;<span class="ident" id="3286235">byName</span><span class="op" id="3286241">)</span>&nbsp;<span class="ident" id="3286243">Len</span><span class="op" id="3286246">(</span><span class="op" id="3286247">)</span>&nbsp;<span class="builtintype" id="3286249">int</span>&nbsp;<span class="op" id="3286253">{</span>&nbsp;<span class="keyword" id="3286255">return</span>&nbsp;<span class="builtinfunc" id="3286262">len</span><span class="op" id="3286265">(</span><span class="ident" id="3286266">x</span><span class="op" id="3286267">)</span>&nbsp;<span class="op" id="3286269">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286272">func</span>&nbsp;<span class="op" id="3286277">(</span><span class="ident" id="3286278">x</span>&nbsp;<span class="ident" id="3286280">byName</span><span class="op" id="3286286">)</span>&nbsp;<span class="ident" id="3286288">Swap</span><span class="op" id="3286292">(</span><span class="ident" id="3286293">i</span><span class="op" id="3286294">,</span>&nbsp;<span class="ident" id="3286296">j</span>&nbsp;<span class="builtintype" id="3286298">int</span><span class="op" id="3286301">)</span>&nbsp;<span class="op" id="3286303">{</span>&nbsp;<span class="ident" id="3286305">x</span><span class="op" id="3286306">[</span><span class="ident" id="3286307">i</span><span class="op" id="3286308">]</span><span class="op" id="3286309">,</span>&nbsp;<span class="ident" id="3286311">x</span><span class="op" id="3286312">[</span><span class="ident" id="3286313">j</span><span class="op" id="3286314">]</span>&nbsp;<span class="op" id="3286316">=</span>&nbsp;<span class="ident" id="3286318">x</span><span class="op" id="3286319">[</span><span class="ident" id="3286320">j</span><span class="op" id="3286321">]</span><span class="op" id="3286322">,</span>&nbsp;<span class="ident" id="3286324">x</span><span class="op" id="3286325">[</span><span class="ident" id="3286326">i</span><span class="op" id="3286327">]</span>&nbsp;<span class="op" id="3286329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286332">func</span>&nbsp;<span class="op" id="3286337">(</span><span class="ident" id="3286338">x</span>&nbsp;<span class="ident" id="3286340">byName</span><span class="op" id="3286346">)</span>&nbsp;<span class="ident" id="3286348">Less</span><span class="op" id="3286352">(</span><span class="ident" id="3286353">i</span><span class="op" id="3286354">,</span>&nbsp;<span class="ident" id="3286356">j</span>&nbsp;<span class="builtintype" id="3286358">int</span><span class="op" id="3286361">)</span>&nbsp;<span class="builtintype" id="3286363">bool</span>&nbsp;<span class="op" id="3286368">{</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286371">if</span>&nbsp;<span class="ident" id="3286374">x</span><span class="op" id="3286375">[</span><span class="ident" id="3286376">i</span><span class="op" id="3286377">]</span><span class="op" id="3286378">.</span><span class="ident" id="3286379">name</span>&nbsp;<span class="op" id="3286384">!=</span>&nbsp;<span class="ident" id="3286387">x</span><span class="op" id="3286388">[</span><span class="ident" id="3286389">j</span><span class="op" id="3286390">]</span><span class="op" id="3286391">.</span><span class="ident" id="3286392">name</span>&nbsp;<span class="op" id="3286397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286401">return</span>&nbsp;<span class="ident" id="3286408">x</span><span class="op" id="3286409">[</span><span class="ident" id="3286410">i</span><span class="op" id="3286411">]</span><span class="op" id="3286412">.</span><span class="ident" id="3286413">name</span>&nbsp;<span class="op" id="3286418">&lt;</span>&nbsp;<span class="ident" id="3286420">x</span><span class="op" id="3286421">[</span><span class="ident" id="3286422">j</span><span class="op" id="3286423">]</span><span class="op" id="3286424">.</span><span class="ident" id="3286425">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286434">if</span>&nbsp;<span class="builtinfunc" id="3286437">len</span><span class="op" id="3286440">(</span><span class="ident" id="3286441">x</span><span class="op" id="3286442">[</span><span class="ident" id="3286443">i</span><span class="op" id="3286444">]</span><span class="op" id="3286445">.</span><span class="ident" id="3286446">index</span><span class="op" id="3286451">)</span>&nbsp;<span class="op" id="3286453">!=</span>&nbsp;<span class="builtinfunc" id="3286456">len</span><span class="op" id="3286459">(</span><span class="ident" id="3286460">x</span><span class="op" id="3286461">[</span><span class="ident" id="3286462">j</span><span class="op" id="3286463">]</span><span class="op" id="3286464">.</span><span class="ident" id="3286465">index</span><span class="op" id="3286470">)</span>&nbsp;<span class="op" id="3286472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286476">return</span>&nbsp;<span class="builtinfunc" id="3286483">len</span><span class="op" id="3286486">(</span><span class="ident" id="3286487">x</span><span class="op" id="3286488">[</span><span class="ident" id="3286489">i</span><span class="op" id="3286490">]</span><span class="op" id="3286491">.</span><span class="ident" id="3286492">index</span><span class="op" id="3286497">)</span>&nbsp;<span class="op" id="3286499">&lt;</span>&nbsp;<span class="builtinfunc" id="3286501">len</span><span class="op" id="3286504">(</span><span class="ident" id="3286505">x</span><span class="op" id="3286506">[</span><span class="ident" id="3286507">j</span><span class="op" id="3286508">]</span><span class="op" id="3286509">.</span><span class="ident" id="3286510">index</span><span class="op" id="3286515">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286521">if</span>&nbsp;<span class="ident" id="3286524">x</span><span class="op" id="3286525">[</span><span class="ident" id="3286526">i</span><span class="op" id="3286527">]</span><span class="op" id="3286528">.</span><span class="ident" id="3286529">tag</span>&nbsp;<span class="op" id="3286533">!=</span>&nbsp;<span class="ident" id="3286536">x</span><span class="op" id="3286537">[</span><span class="ident" id="3286538">j</span><span class="op" id="3286539">]</span><span class="op" id="3286540">.</span><span class="ident" id="3286541">tag</span>&nbsp;<span class="op" id="3286545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286549">return</span>&nbsp;<span class="ident" id="3286556">x</span><span class="op" id="3286557">[</span><span class="ident" id="3286558">i</span><span class="op" id="3286559">]</span><span class="op" id="3286560">.</span><span class="ident" id="3286561">tag</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286569">return</span>&nbsp;<span class="ident" id="3286576">byIndex</span><span class="op" id="3286583">(</span><span class="ident" id="3286584">x</span><span class="op" id="3286585">)</span><span class="op" id="3286586">.</span><span class="ident" id="3286587">Less</span><span class="op" id="3286591">(</span><span class="ident" id="3286592">i</span><span class="op" id="3286593">,</span>&nbsp;<span class="ident" id="3286595">j</span><span class="op" id="3286596">)</span><br>
<span class="lineno">975</span><span class="op" id="3286598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3286601">//&nbsp;byIndex&nbsp;sorts&nbsp;field&nbsp;by&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span><span class="keyword" id="3286643">type</span>&nbsp;<span class="ident" id="3286648">byIndex</span>&nbsp;<span class="op" id="3286656">[</span><span class="op" id="3286657">]</span><span class="ident" id="3286658">field</span><br>
<span class="lineno"></span><br>
<span class="lineno">980</span><span class="keyword" id="3286665">func</span>&nbsp;<span class="op" id="3286670">(</span><span class="ident" id="3286671">x</span>&nbsp;<span class="ident" id="3286673">byIndex</span><span class="op" id="3286680">)</span>&nbsp;<span class="ident" id="3286682">Len</span><span class="op" id="3286685">(</span><span class="op" id="3286686">)</span>&nbsp;<span class="builtintype" id="3286688">int</span>&nbsp;<span class="op" id="3286692">{</span>&nbsp;<span class="keyword" id="3286694">return</span>&nbsp;<span class="builtinfunc" id="3286701">len</span><span class="op" id="3286704">(</span><span class="ident" id="3286705">x</span><span class="op" id="3286706">)</span>&nbsp;<span class="op" id="3286708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286711">func</span>&nbsp;<span class="op" id="3286716">(</span><span class="ident" id="3286717">x</span>&nbsp;<span class="ident" id="3286719">byIndex</span><span class="op" id="3286726">)</span>&nbsp;<span class="ident" id="3286728">Swap</span><span class="op" id="3286732">(</span><span class="ident" id="3286733">i</span><span class="op" id="3286734">,</span>&nbsp;<span class="ident" id="3286736">j</span>&nbsp;<span class="builtintype" id="3286738">int</span><span class="op" id="3286741">)</span>&nbsp;<span class="op" id="3286743">{</span>&nbsp;<span class="ident" id="3286745">x</span><span class="op" id="3286746">[</span><span class="ident" id="3286747">i</span><span class="op" id="3286748">]</span><span class="op" id="3286749">,</span>&nbsp;<span class="ident" id="3286751">x</span><span class="op" id="3286752">[</span><span class="ident" id="3286753">j</span><span class="op" id="3286754">]</span>&nbsp;<span class="op" id="3286756">=</span>&nbsp;<span class="ident" id="3286758">x</span><span class="op" id="3286759">[</span><span class="ident" id="3286760">j</span><span class="op" id="3286761">]</span><span class="op" id="3286762">,</span>&nbsp;<span class="ident" id="3286764">x</span><span class="op" id="3286765">[</span><span class="ident" id="3286766">i</span><span class="op" id="3286767">]</span>&nbsp;<span class="op" id="3286769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3286772">func</span>&nbsp;<span class="op" id="3286777">(</span><span class="ident" id="3286778">x</span>&nbsp;<span class="ident" id="3286780">byIndex</span><span class="op" id="3286787">)</span>&nbsp;<span class="ident" id="3286789">Less</span><span class="op" id="3286793">(</span><span class="ident" id="3286794">i</span><span class="op" id="3286795">,</span>&nbsp;<span class="ident" id="3286797">j</span>&nbsp;<span class="builtintype" id="3286799">int</span><span class="op" id="3286802">)</span>&nbsp;<span class="builtintype" id="3286804">bool</span>&nbsp;<span class="op" id="3286809">{</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286812">for</span>&nbsp;<span class="ident" id="3286816">k</span><span class="op" id="3286817">,</span>&nbsp;<span class="ident" id="3286819">xik</span>&nbsp;<span class="op" id="3286823">:=</span>&nbsp;<span class="keyword" id="3286826">range</span>&nbsp;<span class="ident" id="3286832">x</span><span class="op" id="3286833">[</span><span class="ident" id="3286834">i</span><span class="op" id="3286835">]</span><span class="op" id="3286836">.</span><span class="ident" id="3286837">index</span>&nbsp;<span class="op" id="3286843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286847">if</span>&nbsp;<span class="ident" id="3286850">k</span>&nbsp;<span class="op" id="3286852">&gt;=</span>&nbsp;<span class="builtinfunc" id="3286855">len</span><span class="op" id="3286858">(</span><span class="ident" id="3286859">x</span><span class="op" id="3286860">[</span><span class="ident" id="3286861">j</span><span class="op" id="3286862">]</span><span class="op" id="3286863">.</span><span class="ident" id="3286864">index</span><span class="op" id="3286869">)</span>&nbsp;<span class="op" id="3286871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286876">return</span>&nbsp;<span class="builtintype" id="3286883">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286895">if</span>&nbsp;<span class="ident" id="3286898">xik</span>&nbsp;<span class="op" id="3286902">!=</span>&nbsp;<span class="ident" id="3286905">x</span><span class="op" id="3286906">[</span><span class="ident" id="3286907">j</span><span class="op" id="3286908">]</span><span class="op" id="3286909">.</span><span class="ident" id="3286910">index</span><span class="op" id="3286915">[</span><span class="ident" id="3286916">k</span><span class="op" id="3286917">]</span>&nbsp;<span class="op" id="3286919">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286924">return</span>&nbsp;<span class="ident" id="3286931">xik</span>&nbsp;<span class="op" id="3286935">&lt;</span>&nbsp;<span class="ident" id="3286937">x</span><span class="op" id="3286938">[</span><span class="ident" id="3286939">j</span><span class="op" id="3286940">]</span><span class="op" id="3286941">.</span><span class="ident" id="3286942">index</span><span class="op" id="3286947">[</span><span class="ident" id="3286948">k</span><span class="op" id="3286949">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3286956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3286959">return</span>&nbsp;<span class="builtinfunc" id="3286966">len</span><span class="op" id="3286969">(</span><span class="ident" id="3286970">x</span><span class="op" id="3286971">[</span><span class="ident" id="3286972">i</span><span class="op" id="3286973">]</span><span class="op" id="3286974">.</span><span class="ident" id="3286975">index</span><span class="op" id="3286980">)</span>&nbsp;<span class="op" id="3286982">&lt;</span>&nbsp;<span class="builtinfunc" id="3286984">len</span><span class="op" id="3286987">(</span><span class="ident" id="3286988">x</span><span class="op" id="3286989">[</span><span class="ident" id="3286990">j</span><span class="op" id="3286991">]</span><span class="op" id="3286992">.</span><span class="ident" id="3286993">index</span><span class="op" id="3286998">)</span><br>
<span class="lineno"></span><span class="op" id="3287000">}</span><br>
<span class="lineno">995</span><br>
<span class="lineno"></span><span class="comment" id="3287003">//&nbsp;typeFields&nbsp;returns&nbsp;a&nbsp;list&nbsp;of&nbsp;fields&nbsp;that&nbsp;JSON&nbsp;should&nbsp;recognize&nbsp;for&nbsp;the&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3287089">//&nbsp;The&nbsp;algorithm&nbsp;is&nbsp;breadth-first&nbsp;search&nbsp;over&nbsp;the&nbsp;set&nbsp;of&nbsp;structs&nbsp;to&nbsp;include&nbsp;-&nbsp;the&nbsp;top&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="3287182">//&nbsp;and&nbsp;then&nbsp;any&nbsp;reachable&nbsp;anonymous&nbsp;structs.</span><br>
<span class="lineno"></span><span class="keyword" id="3287227">func</span>&nbsp;<span class="ident" id="3287232">typeFields</span><span class="op" id="3287242">(</span><span class="ident" id="3287243">t</span>&nbsp;<span class="ident" id="3287245">reflect</span><span class="op" id="3287252">.</span><span class="ident" id="3287253">Type</span><span class="op" id="3287257">)</span>&nbsp;<span class="op" id="3287259">[</span><span class="op" id="3287260">]</span><span class="ident" id="3287261">field</span>&nbsp;<span class="op" id="3287267">{</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3287270">//&nbsp;Anonymous&nbsp;fields&nbsp;to&nbsp;explore&nbsp;at&nbsp;the&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287337">current</span>&nbsp;<span class="op" id="3287345">:=</span>&nbsp;<span class="op" id="3287348">[</span><span class="op" id="3287349">]</span><span class="ident" id="3287350">field</span><span class="op" id="3287355">{</span><span class="op" id="3287356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287359">next</span>&nbsp;<span class="op" id="3287364">:=</span>&nbsp;<span class="op" id="3287367">[</span><span class="op" id="3287368">]</span><span class="ident" id="3287369">field</span><span class="op" id="3287374">{</span><span class="op" id="3287375">{</span><span class="ident" id="3287376">typ</span><span class="op" id="3287379">:</span>&nbsp;<span class="ident" id="3287381">t</span><span class="op" id="3287382">}</span><span class="op" id="3287383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3287387">//&nbsp;Count&nbsp;of&nbsp;queued&nbsp;names&nbsp;for&nbsp;current&nbsp;level&nbsp;and&nbsp;the&nbsp;next.</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287445">count</span>&nbsp;<span class="op" id="3287451">:=</span>&nbsp;<span class="keyword" id="3287454">map</span><span class="op" id="3287457">[</span><span class="ident" id="3287458">reflect</span><span class="op" id="3287465">.</span><span class="ident" id="3287466">Type</span><span class="op" id="3287470">]</span><span class="builtintype" id="3287471">int</span><span class="op" id="3287474">{</span><span class="op" id="3287475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287478">nextCount</span>&nbsp;<span class="op" id="3287488">:=</span>&nbsp;<span class="keyword" id="3287491">map</span><span class="op" id="3287494">[</span><span class="ident" id="3287495">reflect</span><span class="op" id="3287502">.</span><span class="ident" id="3287503">Type</span><span class="op" id="3287507">]</span><span class="builtintype" id="3287508">int</span><span class="op" id="3287511">{</span><span class="op" id="3287512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3287516">//&nbsp;Types&nbsp;already&nbsp;visited&nbsp;at&nbsp;an&nbsp;earlier&nbsp;level.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287563">visited</span>&nbsp;<span class="op" id="3287571">:=</span>&nbsp;<span class="keyword" id="3287574">map</span><span class="op" id="3287577">[</span><span class="ident" id="3287578">reflect</span><span class="op" id="3287585">.</span><span class="ident" id="3287586">Type</span><span class="op" id="3287590">]</span><span class="builtintype" id="3287591">bool</span><span class="op" id="3287595">{</span><span class="op" id="3287596">}</span><br>
<span class="lineno">1010</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3287600">//&nbsp;Fields&nbsp;found.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287618">var</span>&nbsp;<span class="ident" id="3287622">fields</span>&nbsp;<span class="op" id="3287629">[</span><span class="op" id="3287630">]</span><span class="ident" id="3287631">field</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287639">for</span>&nbsp;<span class="builtinfunc" id="3287643">len</span><span class="op" id="3287646">(</span><span class="ident" id="3287647">next</span><span class="op" id="3287651">)</span>&nbsp;<span class="op" id="3287653">&gt;</span>&nbsp;<span class="num" id="3287655">0</span>&nbsp;<span class="op" id="3287657">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287661">current</span><span class="op" id="3287668">,</span>&nbsp;<span class="ident" id="3287670">next</span>&nbsp;<span class="op" id="3287675">=</span>&nbsp;<span class="ident" id="3287677">next</span><span class="op" id="3287681">,</span>&nbsp;<span class="ident" id="3287683">current</span><span class="op" id="3287690">[</span><span class="op" id="3287691">:</span><span class="num" id="3287692">0</span><span class="op" id="3287693">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287697">count</span><span class="op" id="3287702">,</span>&nbsp;<span class="ident" id="3287704">nextCount</span>&nbsp;<span class="op" id="3287714">=</span>&nbsp;<span class="ident" id="3287716">nextCount</span><span class="op" id="3287725">,</span>&nbsp;<span class="keyword" id="3287727">map</span><span class="op" id="3287730">[</span><span class="ident" id="3287731">reflect</span><span class="op" id="3287738">.</span><span class="ident" id="3287739">Type</span><span class="op" id="3287743">]</span><span class="builtintype" id="3287744">int</span><span class="op" id="3287747">{</span><span class="op" id="3287748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287753">for</span>&nbsp;<span class="ident" id="3287757">_</span><span class="op" id="3287758">,</span>&nbsp;<span class="ident" id="3287760">f</span>&nbsp;<span class="op" id="3287762">:=</span>&nbsp;<span class="keyword" id="3287765">range</span>&nbsp;<span class="ident" id="3287771">current</span>&nbsp;<span class="op" id="3287779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287784">if</span>&nbsp;<span class="ident" id="3287787">visited</span><span class="op" id="3287794">[</span><span class="ident" id="3287795">f</span><span class="op" id="3287796">.</span><span class="ident" id="3287797">typ</span><span class="op" id="3287800">]</span>&nbsp;<span class="op" id="3287802">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287808">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3287820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287825">visited</span><span class="op" id="3287832">[</span><span class="ident" id="3287833">f</span><span class="op" id="3287834">.</span><span class="ident" id="3287835">typ</span><span class="op" id="3287838">]</span>&nbsp;<span class="op" id="3287840">=</span>&nbsp;<span class="builtintype" id="3287842">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3287851">//&nbsp;Scan&nbsp;f.typ&nbsp;for&nbsp;fields&nbsp;to&nbsp;include.</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287891">for</span>&nbsp;<span class="ident" id="3287895">i</span>&nbsp;<span class="op" id="3287897">:=</span>&nbsp;<span class="num" id="3287900">0</span><span class="op" id="3287901">;</span>&nbsp;<span class="ident" id="3287903">i</span>&nbsp;<span class="op" id="3287905">&lt;</span>&nbsp;<span class="ident" id="3287907">f</span><span class="op" id="3287908">.</span><span class="ident" id="3287909">typ</span><span class="op" id="3287912">.</span><span class="ident" id="3287913">NumField</span><span class="op" id="3287921">(</span><span class="op" id="3287922">)</span><span class="op" id="3287923">;</span>&nbsp;<span class="ident" id="3287925">i</span><span class="op" id="3287926">++</span>&nbsp;<span class="op" id="3287929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3287935">sf</span>&nbsp;<span class="op" id="3287938">:=</span>&nbsp;<span class="ident" id="3287941">f</span><span class="op" id="3287942">.</span><span class="ident" id="3287943">typ</span><span class="op" id="3287946">.</span><span class="ident" id="3287947">Field</span><span class="op" id="3287952">(</span><span class="ident" id="3287953">i</span><span class="op" id="3287954">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3287960">if</span>&nbsp;<span class="ident" id="3287963">sf</span><span class="op" id="3287965">.</span><span class="ident" id="3287966">PkgPath</span>&nbsp;<span class="op" id="3287974">!=</span>&nbsp;<span class="string" id="3287977">&#34;&#34;</span>&nbsp;<span class="op" id="3287980">{</span>&nbsp;<span class="comment" id="3287982">//&nbsp;unexported</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288001">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288014">}</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288020">tag</span>&nbsp;<span class="op" id="3288024">:=</span>&nbsp;<span class="ident" id="3288027">sf</span><span class="op" id="3288029">.</span><span class="ident" id="3288030">Tag</span><span class="op" id="3288033">.</span><span class="ident" id="3288034">Get</span><span class="op" id="3288037">(</span><span class="string" id="3288038">&#34;json&#34;</span><span class="op" id="3288044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288050">if</span>&nbsp;<span class="ident" id="3288053">tag</span>&nbsp;<span class="op" id="3288057">==</span>&nbsp;<span class="string" id="3288060">&#34;-&#34;</span>&nbsp;<span class="op" id="3288064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288071">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288090">name</span><span class="op" id="3288094">,</span>&nbsp;<span class="ident" id="3288096">opts</span>&nbsp;<span class="op" id="3288101">:=</span>&nbsp;<span class="ident" id="3288104">parseTag</span><span class="op" id="3288112">(</span><span class="ident" id="3288113">tag</span><span class="op" id="3288116">)</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288122">if</span>&nbsp;<span class="op" id="3288125">!</span><span class="ident" id="3288126">isValidTag</span><span class="op" id="3288136">(</span><span class="ident" id="3288137">name</span><span class="op" id="3288141">)</span>&nbsp;<span class="op" id="3288143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288150">name</span>&nbsp;<span class="op" id="3288155">=</span>&nbsp;<span class="string" id="3288157">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288170">index</span>&nbsp;<span class="op" id="3288176">:=</span>&nbsp;<span class="builtinfunc" id="3288179">make</span><span class="op" id="3288183">(</span><span class="op" id="3288184">[</span><span class="op" id="3288185">]</span><span class="builtintype" id="3288186">int</span><span class="op" id="3288189">,</span>&nbsp;<span class="builtinfunc" id="3288191">len</span><span class="op" id="3288194">(</span><span class="ident" id="3288195">f</span><span class="op" id="3288196">.</span><span class="ident" id="3288197">index</span><span class="op" id="3288202">)</span><span class="op" id="3288203">+</span><span class="num" id="3288204">1</span><span class="op" id="3288205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3288211">copy</span><span class="op" id="3288215">(</span><span class="ident" id="3288216">index</span><span class="op" id="3288221">,</span>&nbsp;<span class="ident" id="3288223">f</span><span class="op" id="3288224">.</span><span class="ident" id="3288225">index</span><span class="op" id="3288230">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288236">index</span><span class="op" id="3288241">[</span><span class="builtinfunc" id="3288242">len</span><span class="op" id="3288245">(</span><span class="ident" id="3288246">f</span><span class="op" id="3288247">.</span><span class="ident" id="3288248">index</span><span class="op" id="3288253">)</span><span class="op" id="3288254">]</span>&nbsp;<span class="op" id="3288256">=</span>&nbsp;<span class="ident" id="3288258">i</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288265">ft</span>&nbsp;<span class="op" id="3288268">:=</span>&nbsp;<span class="ident" id="3288271">sf</span><span class="op" id="3288273">.</span><span class="ident" id="3288274">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288283">if</span>&nbsp;<span class="ident" id="3288286">ft</span><span class="op" id="3288288">.</span><span class="ident" id="3288289">Name</span><span class="op" id="3288293">(</span><span class="op" id="3288294">)</span>&nbsp;<span class="op" id="3288296">==</span>&nbsp;<span class="string" id="3288299">&#34;&#34;</span>&nbsp;<span class="op" id="3288302">&amp;&amp;</span>&nbsp;<span class="ident" id="3288305">ft</span><span class="op" id="3288307">.</span><span class="ident" id="3288308">Kind</span><span class="op" id="3288312">(</span><span class="op" id="3288313">)</span>&nbsp;<span class="op" id="3288315">==</span>&nbsp;<span class="ident" id="3288318">reflect</span><span class="op" id="3288325">.</span><span class="ident" id="3288326">Ptr</span>&nbsp;<span class="op" id="3288330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288337">//&nbsp;Follow&nbsp;pointer.</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288361">ft</span>&nbsp;<span class="op" id="3288364">=</span>&nbsp;<span class="ident" id="3288366">ft</span><span class="op" id="3288368">.</span><span class="ident" id="3288369">Elem</span><span class="op" id="3288373">(</span><span class="op" id="3288374">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288387">//&nbsp;Record&nbsp;found&nbsp;field&nbsp;and&nbsp;index&nbsp;sequence.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288433">if</span>&nbsp;<span class="ident" id="3288436">name</span>&nbsp;<span class="op" id="3288441">!=</span>&nbsp;<span class="string" id="3288444">&#34;&#34;</span>&nbsp;<span class="op" id="3288447">||</span>&nbsp;<span class="op" id="3288450">!</span><span class="ident" id="3288451">sf</span><span class="op" id="3288453">.</span><span class="ident" id="3288454">Anonymous</span>&nbsp;<span class="op" id="3288464">||</span>&nbsp;<span class="ident" id="3288467">ft</span><span class="op" id="3288469">.</span><span class="ident" id="3288470">Kind</span><span class="op" id="3288474">(</span><span class="op" id="3288475">)</span>&nbsp;<span class="op" id="3288477">!=</span>&nbsp;<span class="ident" id="3288480">reflect</span><span class="op" id="3288487">.</span><span class="ident" id="3288488">Struct</span>&nbsp;<span class="op" id="3288495">{</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288502">tagged</span>&nbsp;<span class="op" id="3288509">:=</span>&nbsp;<span class="ident" id="3288512">name</span>&nbsp;<span class="op" id="3288517">!=</span>&nbsp;<span class="string" id="3288520">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288528">if</span>&nbsp;<span class="ident" id="3288531">name</span>&nbsp;<span class="op" id="3288536">==</span>&nbsp;<span class="string" id="3288539">&#34;&#34;</span>&nbsp;<span class="op" id="3288542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288550">name</span>&nbsp;<span class="op" id="3288555">=</span>&nbsp;<span class="ident" id="3288557">sf</span><span class="op" id="3288559">.</span><span class="ident" id="3288560">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288577">fields</span>&nbsp;<span class="op" id="3288584">=</span>&nbsp;<span class="builtinfunc" id="3288586">append</span><span class="op" id="3288592">(</span><span class="ident" id="3288593">fields</span><span class="op" id="3288599">,</span>&nbsp;<span class="ident" id="3288601">fillField</span><span class="op" id="3288610">(</span><span class="ident" id="3288611">field</span><span class="op" id="3288616">{</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288624">name</span><span class="op" id="3288628">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3288635">name</span><span class="op" id="3288639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288647">tag</span><span class="op" id="3288650">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3288658">tagged</span><span class="op" id="3288664">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288672">index</span><span class="op" id="3288677">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3288683">index</span><span class="op" id="3288688">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288696">typ</span><span class="op" id="3288699">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3288707">ft</span><span class="op" id="3288709">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288717">omitEmpty</span><span class="op" id="3288726">:</span>&nbsp;<span class="ident" id="3288728">opts</span><span class="op" id="3288732">.</span><span class="ident" id="3288733">Contains</span><span class="op" id="3288741">(</span><span class="string" id="3288742">&#34;omitempty&#34;</span><span class="op" id="3288753">)</span><span class="op" id="3288754">,</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3288762">quoted</span><span class="op" id="3288768">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3288773">opts</span><span class="op" id="3288777">.</span><span class="ident" id="3288778">Contains</span><span class="op" id="3288786">(</span><span class="string" id="3288787">&#34;string&#34;</span><span class="op" id="3288795">)</span><span class="op" id="3288796">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3288803">}</span><span class="op" id="3288804">)</span><span class="op" id="3288805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3288812">if</span>&nbsp;<span class="ident" id="3288815">count</span><span class="op" id="3288820">[</span><span class="ident" id="3288821">f</span><span class="op" id="3288822">.</span><span class="ident" id="3288823">typ</span><span class="op" id="3288826">]</span>&nbsp;<span class="op" id="3288828">&gt;</span>&nbsp;<span class="num" id="3288830">1</span>&nbsp;<span class="op" id="3288832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288840">//&nbsp;If&nbsp;there&nbsp;were&nbsp;multiple&nbsp;instances,&nbsp;add&nbsp;a&nbsp;second,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288897">//&nbsp;so&nbsp;that&nbsp;the&nbsp;annihilation&nbsp;code&nbsp;will&nbsp;see&nbsp;a&nbsp;duplicate.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3288958">//&nbsp;It&nbsp;only&nbsp;cares&nbsp;about&nbsp;the&nbsp;distinction&nbsp;between&nbsp;1&nbsp;or&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289019">//&nbsp;so&nbsp;don&#39;t&nbsp;bother&nbsp;generating&nbsp;any&nbsp;more&nbsp;copies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289072">fields</span>&nbsp;<span class="op" id="3289079">=</span>&nbsp;<span class="builtinfunc" id="3289081">append</span><span class="op" id="3289087">(</span><span class="ident" id="3289088">fields</span><span class="op" id="3289094">,</span>&nbsp;<span class="ident" id="3289096">fields</span><span class="op" id="3289102">[</span><span class="builtinfunc" id="3289103">len</span><span class="op" id="3289106">(</span><span class="ident" id="3289107">fields</span><span class="op" id="3289113">)</span><span class="op" id="3289114">-</span><span class="num" id="3289115">1</span><span class="op" id="3289116">]</span><span class="op" id="3289117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289124">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289131">continue</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289151">//&nbsp;Record&nbsp;new&nbsp;anonymous&nbsp;struct&nbsp;to&nbsp;explore&nbsp;in&nbsp;next&nbsp;round.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289212">nextCount</span><span class="op" id="3289221">[</span><span class="ident" id="3289222">ft</span><span class="op" id="3289224">]</span><span class="op" id="3289225">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289232">if</span>&nbsp;<span class="ident" id="3289235">nextCount</span><span class="op" id="3289244">[</span><span class="ident" id="3289245">ft</span><span class="op" id="3289247">]</span>&nbsp;<span class="op" id="3289249">==</span>&nbsp;<span class="num" id="3289252">1</span>&nbsp;<span class="op" id="3289254">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289261">next</span>&nbsp;<span class="op" id="3289266">=</span>&nbsp;<span class="builtinfunc" id="3289268">append</span><span class="op" id="3289274">(</span><span class="ident" id="3289275">next</span><span class="op" id="3289279">,</span>&nbsp;<span class="ident" id="3289281">fillField</span><span class="op" id="3289290">(</span><span class="ident" id="3289291">field</span><span class="op" id="3289296">{</span><span class="ident" id="3289297">name</span><span class="op" id="3289301">:</span>&nbsp;<span class="ident" id="3289303">ft</span><span class="op" id="3289305">.</span><span class="ident" id="3289306">Name</span><span class="op" id="3289310">(</span><span class="op" id="3289311">)</span><span class="op" id="3289312">,</span>&nbsp;<span class="ident" id="3289314">index</span><span class="op" id="3289319">:</span>&nbsp;<span class="ident" id="3289321">index</span><span class="op" id="3289326">,</span>&nbsp;<span class="ident" id="3289328">typ</span><span class="op" id="3289331">:</span>&nbsp;<span class="ident" id="3289333">ft</span><span class="op" id="3289335">}</span><span class="op" id="3289336">)</span><span class="op" id="3289337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289352">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3289355">}</span><br>
<span class="lineno">1080</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289359">sort</span><span class="op" id="3289363">.</span><span class="ident" id="3289364">Sort</span><span class="op" id="3289368">(</span><span class="ident" id="3289369">byName</span><span class="op" id="3289375">(</span><span class="ident" id="3289376">fields</span><span class="op" id="3289382">)</span><span class="op" id="3289383">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289387">//&nbsp;Delete&nbsp;all&nbsp;fields&nbsp;that&nbsp;are&nbsp;hidden&nbsp;by&nbsp;the&nbsp;Go&nbsp;rules&nbsp;for&nbsp;embedded&nbsp;fields,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289462">//&nbsp;except&nbsp;that&nbsp;fields&nbsp;with&nbsp;JSON&nbsp;tags&nbsp;are&nbsp;promoted.</span><br>
<span class="lineno">1085</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289515">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;primary&nbsp;order&nbsp;of&nbsp;name,&nbsp;secondary&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289583">//&nbsp;of&nbsp;field&nbsp;index&nbsp;length.&nbsp;Loop&nbsp;over&nbsp;names;&nbsp;for&nbsp;each&nbsp;name,&nbsp;delete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289649">//&nbsp;hidden&nbsp;fields&nbsp;by&nbsp;choosing&nbsp;the&nbsp;one&nbsp;dominant&nbsp;field&nbsp;that&nbsp;survives.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289717">out</span>&nbsp;<span class="op" id="3289721">:=</span>&nbsp;<span class="ident" id="3289724">fields</span><span class="op" id="3289730">[</span><span class="op" id="3289731">:</span><span class="num" id="3289732">0</span><span class="op" id="3289733">]</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289736">for</span>&nbsp;<span class="ident" id="3289740">advance</span><span class="op" id="3289747">,</span>&nbsp;<span class="ident" id="3289749">i</span>&nbsp;<span class="op" id="3289751">:=</span>&nbsp;<span class="num" id="3289754">0</span><span class="op" id="3289755">,</span>&nbsp;<span class="num" id="3289757">0</span><span class="op" id="3289758">;</span>&nbsp;<span class="ident" id="3289760">i</span>&nbsp;<span class="op" id="3289762">&lt;</span>&nbsp;<span class="builtinfunc" id="3289764">len</span><span class="op" id="3289767">(</span><span class="ident" id="3289768">fields</span><span class="op" id="3289774">)</span><span class="op" id="3289775">;</span>&nbsp;<span class="ident" id="3289777">i</span>&nbsp;<span class="op" id="3289779">+=</span>&nbsp;<span class="ident" id="3289782">advance</span>&nbsp;<span class="op" id="3289790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289794">//&nbsp;One&nbsp;iteration&nbsp;per&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3289823">//&nbsp;Find&nbsp;the&nbsp;sequence&nbsp;of&nbsp;fields&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;this&nbsp;first&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289891">fi</span>&nbsp;<span class="op" id="3289894">:=</span>&nbsp;<span class="ident" id="3289897">fields</span><span class="op" id="3289903">[</span><span class="ident" id="3289904">i</span><span class="op" id="3289905">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289909">name</span>&nbsp;<span class="op" id="3289914">:=</span>&nbsp;<span class="ident" id="3289917">fi</span><span class="op" id="3289919">.</span><span class="ident" id="3289920">name</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3289927">for</span>&nbsp;<span class="ident" id="3289931">advance</span>&nbsp;<span class="op" id="3289939">=</span>&nbsp;<span class="num" id="3289941">1</span><span class="op" id="3289942">;</span>&nbsp;<span class="ident" id="3289944">i</span><span class="op" id="3289945">+</span><span class="ident" id="3289946">advance</span>&nbsp;<span class="op" id="3289954">&lt;</span>&nbsp;<span class="builtinfunc" id="3289956">len</span><span class="op" id="3289959">(</span><span class="ident" id="3289960">fields</span><span class="op" id="3289966">)</span><span class="op" id="3289967">;</span>&nbsp;<span class="ident" id="3289969">advance</span><span class="op" id="3289976">++</span>&nbsp;<span class="op" id="3289979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3289984">fj</span>&nbsp;<span class="op" id="3289987">:=</span>&nbsp;<span class="ident" id="3289990">fields</span><span class="op" id="3289996">[</span><span class="ident" id="3289997">i</span><span class="op" id="3289998">+</span><span class="ident" id="3289999">advance</span><span class="op" id="3290006">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290011">if</span>&nbsp;<span class="ident" id="3290014">fj</span><span class="op" id="3290016">.</span><span class="ident" id="3290017">name</span>&nbsp;<span class="op" id="3290022">!=</span>&nbsp;<span class="ident" id="3290025">name</span>&nbsp;<span class="op" id="3290030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290036">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290045">}</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290053">if</span>&nbsp;<span class="ident" id="3290056">advance</span>&nbsp;<span class="op" id="3290064">==</span>&nbsp;<span class="num" id="3290067">1</span>&nbsp;<span class="op" id="3290069">{</span>&nbsp;<span class="comment" id="3290071">//&nbsp;Only&nbsp;one&nbsp;field&nbsp;with&nbsp;this&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290107">out</span>&nbsp;<span class="op" id="3290111">=</span>&nbsp;<span class="builtinfunc" id="3290113">append</span><span class="op" id="3290119">(</span><span class="ident" id="3290120">out</span><span class="op" id="3290123">,</span>&nbsp;<span class="ident" id="3290125">fi</span><span class="op" id="3290127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290132">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290143">}</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290147">dominant</span><span class="op" id="3290155">,</span>&nbsp;<span class="ident" id="3290157">ok</span>&nbsp;<span class="op" id="3290160">:=</span>&nbsp;<span class="ident" id="3290163">dominantField</span><span class="op" id="3290176">(</span><span class="ident" id="3290177">fields</span><span class="op" id="3290183">[</span><span class="ident" id="3290184">i</span>&nbsp;<span class="op" id="3290186">:</span>&nbsp;<span class="ident" id="3290188">i</span><span class="op" id="3290189">+</span><span class="ident" id="3290190">advance</span><span class="op" id="3290197">]</span><span class="op" id="3290198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290202">if</span>&nbsp;<span class="ident" id="3290205">ok</span>&nbsp;<span class="op" id="3290208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290213">out</span>&nbsp;<span class="op" id="3290217">=</span>&nbsp;<span class="builtinfunc" id="3290219">append</span><span class="op" id="3290225">(</span><span class="ident" id="3290226">out</span><span class="op" id="3290229">,</span>&nbsp;<span class="ident" id="3290231">dominant</span><span class="op" id="3290239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3290246">}</span><br>
<span class="lineno">1110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290250">fields</span>&nbsp;<span class="op" id="3290257">=</span>&nbsp;<span class="ident" id="3290259">out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290264">sort</span><span class="op" id="3290268">.</span><span class="ident" id="3290269">Sort</span><span class="op" id="3290273">(</span><span class="ident" id="3290274">byIndex</span><span class="op" id="3290281">(</span><span class="ident" id="3290282">fields</span><span class="op" id="3290288">)</span><span class="op" id="3290289">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290293">return</span>&nbsp;<span class="ident" id="3290300">fields</span><br>
<span class="lineno">1115</span><span class="op" id="3290307">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3290310">//&nbsp;dominantField&nbsp;looks&nbsp;through&nbsp;the&nbsp;fields,&nbsp;all&nbsp;of&nbsp;which&nbsp;are&nbsp;known&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3290379">//&nbsp;have&nbsp;the&nbsp;same&nbsp;name,&nbsp;to&nbsp;find&nbsp;the&nbsp;single&nbsp;field&nbsp;that&nbsp;dominates&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3290446">//&nbsp;others&nbsp;using&nbsp;Go&#39;s&nbsp;embedding&nbsp;rules,&nbsp;modified&nbsp;by&nbsp;the&nbsp;presence&nbsp;of</span><br>
<span class="lineno">1120</span><span class="comment" id="3290512">//&nbsp;JSON&nbsp;tags.&nbsp;If&nbsp;there&nbsp;are&nbsp;multiple&nbsp;top-level&nbsp;fields,&nbsp;the&nbsp;boolean</span><br>
<span class="lineno"></span><span class="comment" id="3290578">//&nbsp;will&nbsp;be&nbsp;false:&nbsp;This&nbsp;condition&nbsp;is&nbsp;an&nbsp;error&nbsp;in&nbsp;Go&nbsp;and&nbsp;we&nbsp;skip&nbsp;all</span><br>
<span class="lineno"></span><span class="comment" id="3290645">//&nbsp;the&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="3290660">func</span>&nbsp;<span class="ident" id="3290665">dominantField</span><span class="op" id="3290678">(</span><span class="ident" id="3290679">fields</span>&nbsp;<span class="op" id="3290686">[</span><span class="op" id="3290687">]</span><span class="ident" id="3290688">field</span><span class="op" id="3290693">)</span>&nbsp;<span class="op" id="3290695">(</span><span class="ident" id="3290696">field</span><span class="op" id="3290701">,</span>&nbsp;<span class="builtintype" id="3290703">bool</span><span class="op" id="3290707">)</span>&nbsp;<span class="op" id="3290709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3290712">//&nbsp;The&nbsp;fields&nbsp;are&nbsp;sorted&nbsp;in&nbsp;increasing&nbsp;index-length&nbsp;order.&nbsp;The&nbsp;winner</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3290783">//&nbsp;must&nbsp;therefore&nbsp;be&nbsp;one&nbsp;with&nbsp;the&nbsp;shortest&nbsp;index&nbsp;length.&nbsp;Drop&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3290850">//&nbsp;longer&nbsp;entries,&nbsp;which&nbsp;is&nbsp;easy:&nbsp;just&nbsp;truncate&nbsp;the&nbsp;slice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290910">length</span>&nbsp;<span class="op" id="3290917">:=</span>&nbsp;<span class="builtinfunc" id="3290920">len</span><span class="op" id="3290923">(</span><span class="ident" id="3290924">fields</span><span class="op" id="3290930">[</span><span class="num" id="3290931">0</span><span class="op" id="3290932">]</span><span class="op" id="3290933">.</span><span class="ident" id="3290934">index</span><span class="op" id="3290939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3290942">tagged</span>&nbsp;<span class="op" id="3290949">:=</span>&nbsp;<span class="op" id="3290952">-</span><span class="num" id="3290953">1</span>&nbsp;<span class="comment" id="3290955">//&nbsp;Index&nbsp;of&nbsp;first&nbsp;tagged&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3290988">for</span>&nbsp;<span class="ident" id="3290992">i</span><span class="op" id="3290993">,</span>&nbsp;<span class="ident" id="3290995">f</span>&nbsp;<span class="op" id="3290997">:=</span>&nbsp;<span class="keyword" id="3291000">range</span>&nbsp;<span class="ident" id="3291006">fields</span>&nbsp;<span class="op" id="3291013">{</span><br>
<span class="lineno">1130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291017">if</span>&nbsp;<span class="builtinfunc" id="3291020">len</span><span class="op" id="3291023">(</span><span class="ident" id="3291024">f</span><span class="op" id="3291025">.</span><span class="ident" id="3291026">index</span><span class="op" id="3291031">)</span>&nbsp;<span class="op" id="3291033">&gt;</span>&nbsp;<span class="ident" id="3291035">length</span>&nbsp;<span class="op" id="3291042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291047">fields</span>&nbsp;<span class="op" id="3291054">=</span>&nbsp;<span class="ident" id="3291056">fields</span><span class="op" id="3291062">[</span><span class="op" id="3291063">:</span><span class="ident" id="3291064">i</span><span class="op" id="3291065">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291070">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291082">if</span>&nbsp;<span class="ident" id="3291085">f</span><span class="op" id="3291086">.</span><span class="ident" id="3291087">tag</span>&nbsp;<span class="op" id="3291091">{</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291096">if</span>&nbsp;<span class="ident" id="3291099">tagged</span>&nbsp;<span class="op" id="3291106">&gt;=</span>&nbsp;<span class="num" id="3291109">0</span>&nbsp;<span class="op" id="3291111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291117">//&nbsp;Multiple&nbsp;tagged&nbsp;fields&nbsp;at&nbsp;the&nbsp;same&nbsp;level:&nbsp;conflict.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291176">//&nbsp;Return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291200">return</span>&nbsp;<span class="ident" id="3291207">field</span><span class="op" id="3291212">{</span><span class="op" id="3291213">}</span><span class="op" id="3291214">,</span>&nbsp;<span class="builtintype" id="3291216">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291225">}</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291230">tagged</span>&nbsp;<span class="op" id="3291237">=</span>&nbsp;<span class="ident" id="3291239">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291249">if</span>&nbsp;<span class="ident" id="3291252">tagged</span>&nbsp;<span class="op" id="3291259">&gt;=</span>&nbsp;<span class="num" id="3291262">0</span>&nbsp;<span class="op" id="3291264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291268">return</span>&nbsp;<span class="ident" id="3291275">fields</span><span class="op" id="3291281">[</span><span class="ident" id="3291282">tagged</span><span class="op" id="3291288">]</span><span class="op" id="3291289">,</span>&nbsp;<span class="builtintype" id="3291291">true</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291297">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291300">//&nbsp;All&nbsp;remaining&nbsp;fields&nbsp;have&nbsp;the&nbsp;same&nbsp;length.&nbsp;If&nbsp;there&#39;s&nbsp;more&nbsp;than&nbsp;one,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291373">//&nbsp;we&nbsp;have&nbsp;a&nbsp;conflict&nbsp;(two&nbsp;fields&nbsp;named&nbsp;&#34;X&#34;&nbsp;at&nbsp;the&nbsp;same&nbsp;level)&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291444">//&nbsp;return&nbsp;no&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291465">if</span>&nbsp;<span class="builtinfunc" id="3291468">len</span><span class="op" id="3291471">(</span><span class="ident" id="3291472">fields</span><span class="op" id="3291478">)</span>&nbsp;<span class="op" id="3291480">&gt;</span>&nbsp;<span class="num" id="3291482">1</span>&nbsp;<span class="op" id="3291484">{</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291488">return</span>&nbsp;<span class="ident" id="3291495">field</span><span class="op" id="3291500">{</span><span class="op" id="3291501">}</span><span class="op" id="3291502">,</span>&nbsp;<span class="builtintype" id="3291504">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291514">return</span>&nbsp;<span class="ident" id="3291521">fields</span><span class="op" id="3291527">[</span><span class="num" id="3291528">0</span><span class="op" id="3291529">]</span><span class="op" id="3291530">,</span>&nbsp;<span class="builtintype" id="3291532">true</span><br>
<span class="lineno"></span><span class="op" id="3291537">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1155</span><span class="keyword" id="3291540">var</span>&nbsp;<span class="ident" id="3291544">fieldCache</span>&nbsp;<span class="keyword" id="3291555">struct</span>&nbsp;<span class="op" id="3291562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291565">sync</span><span class="op" id="3291569">.</span><span class="ident" id="3291570">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291579">m</span>&nbsp;<span class="keyword" id="3291581">map</span><span class="op" id="3291584">[</span><span class="ident" id="3291585">reflect</span><span class="op" id="3291592">.</span><span class="ident" id="3291593">Type</span><span class="op" id="3291597">]</span><span class="op" id="3291598">[</span><span class="op" id="3291599">]</span><span class="ident" id="3291600">field</span><br>
<span class="lineno"></span><span class="op" id="3291606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1160</span><span class="comment" id="3291609">//&nbsp;cachedTypeFields&nbsp;is&nbsp;like&nbsp;typeFields&nbsp;but&nbsp;uses&nbsp;a&nbsp;cache&nbsp;to&nbsp;avoid&nbsp;repeated&nbsp;work.</span><br>
<span class="lineno"></span><span class="keyword" id="3291689">func</span>&nbsp;<span class="ident" id="3291694">cachedTypeFields</span><span class="op" id="3291710">(</span><span class="ident" id="3291711">t</span>&nbsp;<span class="ident" id="3291713">reflect</span><span class="op" id="3291720">.</span><span class="ident" id="3291721">Type</span><span class="op" id="3291725">)</span>&nbsp;<span class="op" id="3291727">[</span><span class="op" id="3291728">]</span><span class="ident" id="3291729">field</span>&nbsp;<span class="op" id="3291735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291738">fieldCache</span><span class="op" id="3291748">.</span><span class="ident" id="3291749">RLock</span><span class="op" id="3291754">(</span><span class="op" id="3291755">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291758">f</span>&nbsp;<span class="op" id="3291760">:=</span>&nbsp;<span class="ident" id="3291763">fieldCache</span><span class="op" id="3291773">.</span><span class="ident" id="3291774">m</span><span class="op" id="3291775">[</span><span class="ident" id="3291776">t</span><span class="op" id="3291777">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291780">fieldCache</span><span class="op" id="3291790">.</span><span class="ident" id="3291791">RUnlock</span><span class="op" id="3291798">(</span><span class="op" id="3291799">)</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291802">if</span>&nbsp;<span class="ident" id="3291805">f</span>&nbsp;<span class="op" id="3291807">!=</span>&nbsp;<span class="ident" id="3291810">nil</span>&nbsp;<span class="op" id="3291814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291818">return</span>&nbsp;<span class="ident" id="3291825">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291832">//&nbsp;Compute&nbsp;fields&nbsp;without&nbsp;lock.</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3291865">//&nbsp;Might&nbsp;duplicate&nbsp;effort&nbsp;but&nbsp;won&#39;t&nbsp;hold&nbsp;other&nbsp;computations&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291932">f</span>&nbsp;<span class="op" id="3291934">=</span>&nbsp;<span class="ident" id="3291936">typeFields</span><span class="op" id="3291946">(</span><span class="ident" id="3291947">t</span><span class="op" id="3291948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3291951">if</span>&nbsp;<span class="ident" id="3291954">f</span>&nbsp;<span class="op" id="3291956">==</span>&nbsp;<span class="ident" id="3291959">nil</span>&nbsp;<span class="op" id="3291963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291967">f</span>&nbsp;<span class="op" id="3291969">=</span>&nbsp;<span class="op" id="3291971">[</span><span class="op" id="3291972">]</span><span class="ident" id="3291973">field</span><span class="op" id="3291978">{</span><span class="op" id="3291979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3291982">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3291986">fieldCache</span><span class="op" id="3291996">.</span><span class="ident" id="3291997">Lock</span><span class="op" id="3292001">(</span><span class="op" id="3292002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292005">if</span>&nbsp;<span class="ident" id="3292008">fieldCache</span><span class="op" id="3292018">.</span><span class="ident" id="3292019">m</span>&nbsp;<span class="op" id="3292021">==</span>&nbsp;<span class="ident" id="3292024">nil</span>&nbsp;<span class="op" id="3292028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292032">fieldCache</span><span class="op" id="3292042">.</span><span class="ident" id="3292043">m</span>&nbsp;<span class="op" id="3292045">=</span>&nbsp;<span class="keyword" id="3292047">map</span><span class="op" id="3292050">[</span><span class="ident" id="3292051">reflect</span><span class="op" id="3292058">.</span><span class="ident" id="3292059">Type</span><span class="op" id="3292063">]</span><span class="op" id="3292064">[</span><span class="op" id="3292065">]</span><span class="ident" id="3292066">field</span><span class="op" id="3292071">{</span><span class="op" id="3292072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3292075">}</span><br>
<span class="lineno">1180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292078">fieldCache</span><span class="op" id="3292088">.</span><span class="ident" id="3292089">m</span><span class="op" id="3292090">[</span><span class="ident" id="3292091">t</span><span class="op" id="3292092">]</span>&nbsp;<span class="op" id="3292094">=</span>&nbsp;<span class="ident" id="3292096">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3292099">fieldCache</span><span class="op" id="3292109">.</span><span class="ident" id="3292110">Unlock</span><span class="op" id="3292116">(</span><span class="op" id="3292117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3292120">return</span>&nbsp;<span class="ident" id="3292127">f</span><br>
<span class="lineno"></span><span class="op" id="3292129">}</span>
</div>
</body>
</html>
