<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="5364664">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5364720">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5364774">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5364825">//&nbsp;Package&nbsp;draw&nbsp;provides&nbsp;image&nbsp;composition&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="5364879">//</span><br>
<span class="lineno"></span><span class="comment" id="5364882">//&nbsp;See&nbsp;&#34;The&nbsp;Go&nbsp;image/draw&nbsp;package&#34;&nbsp;for&nbsp;an&nbsp;introduction&nbsp;to&nbsp;this&nbsp;package:</span><br>
<span class="lineno"></span><span class="comment" id="5364954">//&nbsp;http://golang.org/doc/articles/image_draw.html</span><br>
<span class="lineno"></span><span class="keyword" id="5365004">package</span>&nbsp;<span class="ident" id="5365012">draw</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5365018">import</span>&nbsp;<span class="op" id="5365025">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5365028">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5365037">&#34;image/color&#34;</span><br>
<span class="lineno"></span><span class="op" id="5365051">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="5365054">//&nbsp;m&nbsp;is&nbsp;the&nbsp;maximum&nbsp;color&nbsp;value&nbsp;returned&nbsp;by&nbsp;image.Color.RGBA.</span><br>
<span class="lineno"></span><span class="keyword" id="5365116">const</span>&nbsp;<span class="ident" id="5365122">m</span>&nbsp;<span class="op" id="5365124">=</span>&nbsp;<span class="num" id="5365126">1</span><span class="op" id="5365127">&lt;&lt;</span><span class="num" id="5365129">16</span>&nbsp;<span class="op" id="5365132">-</span>&nbsp;<span class="num" id="5365134">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365137">//&nbsp;Image&nbsp;is&nbsp;an&nbsp;image.Image&nbsp;with&nbsp;a&nbsp;Set&nbsp;method&nbsp;to&nbsp;change&nbsp;a&nbsp;single&nbsp;pixel.</span><br>
<span class="lineno">20</span><span class="keyword" id="5365208">type</span>&nbsp;<span class="ident" id="5365213">Image</span>&nbsp;<span class="keyword" id="5365219">interface</span>&nbsp;<span class="op" id="5365229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365232">image</span><span class="op" id="5365237">.</span><span class="ident" id="5365238">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365245">Set</span><span class="op" id="5365248">(</span><span class="ident" id="5365249">x</span><span class="op" id="5365250">,</span>&nbsp;<span class="ident" id="5365252">y</span>&nbsp;<span class="builtintype" id="5365254">int</span><span class="op" id="5365257">,</span>&nbsp;<span class="ident" id="5365259">c</span>&nbsp;<span class="ident" id="5365261">color</span><span class="op" id="5365266">.</span><span class="ident" id="5365267">Color</span><span class="op" id="5365272">)</span><br>
<span class="lineno"></span><span class="op" id="5365274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="5365277">//&nbsp;Quantizer&nbsp;produces&nbsp;a&nbsp;palette&nbsp;for&nbsp;an&nbsp;image.</span><br>
<span class="lineno"></span><span class="keyword" id="5365323">type</span>&nbsp;<span class="ident" id="5365328">Quantizer</span>&nbsp;<span class="keyword" id="5365338">interface</span>&nbsp;<span class="op" id="5365348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5365351">//&nbsp;Quantize&nbsp;appends&nbsp;up&nbsp;to&nbsp;cap(p)&nbsp;-&nbsp;len(p)&nbsp;colors&nbsp;to&nbsp;p&nbsp;and&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5365422">//&nbsp;updated&nbsp;palette&nbsp;suitable&nbsp;for&nbsp;converting&nbsp;m&nbsp;to&nbsp;a&nbsp;paletted&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365489">Quantize</span><span class="op" id="5365497">(</span><span class="ident" id="5365498">p</span>&nbsp;<span class="ident" id="5365500">color</span><span class="op" id="5365505">.</span><span class="ident" id="5365506">Palette</span><span class="op" id="5365513">,</span>&nbsp;<span class="ident" id="5365515">m</span>&nbsp;<span class="ident" id="5365517">image</span><span class="op" id="5365522">.</span><span class="ident" id="5365523">Image</span><span class="op" id="5365528">)</span>&nbsp;<span class="ident" id="5365530">color</span><span class="op" id="5365535">.</span><span class="ident" id="5365536">Palette</span><br>
<span class="lineno">30</span><span class="op" id="5365544">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365547">//&nbsp;Op&nbsp;is&nbsp;a&nbsp;Porter-Duff&nbsp;compositing&nbsp;operator.</span><br>
<span class="lineno"></span><span class="keyword" id="5365592">type</span>&nbsp;<span class="ident" id="5365597">Op</span>&nbsp;<span class="builtintype" id="5365600">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5365605">const</span>&nbsp;<span class="op" id="5365611">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5365614">//&nbsp;Over&nbsp;specifies&nbsp;``(src&nbsp;in&nbsp;mask)&nbsp;over&nbsp;dst&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365661">Over</span>&nbsp;<span class="ident" id="5365666">Op</span>&nbsp;<span class="op" id="5365669">=</span>&nbsp;<span class="ident" id="5365671">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5365677">//&nbsp;Src&nbsp;specifies&nbsp;``src&nbsp;in&nbsp;mask&#39;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365712">Src</span><br>
<span class="lineno">40</span><span class="op" id="5365716">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365719">//&nbsp;Draw&nbsp;implements&nbsp;the&nbsp;Drawer&nbsp;interface&nbsp;by&nbsp;calling&nbsp;the&nbsp;Draw&nbsp;function&nbsp;with&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5365798">//&nbsp;Op.</span><br>
<span class="lineno"></span><span class="keyword" id="5365805">func</span>&nbsp;<span class="op" id="5365810">(</span><span class="ident" id="5365811">op</span>&nbsp;<span class="ident" id="5365814">Op</span><span class="op" id="5365816">)</span>&nbsp;<span class="ident" id="5365818">Draw</span><span class="op" id="5365822">(</span><span class="ident" id="5365823">dst</span>&nbsp;<span class="ident" id="5365827">Image</span><span class="op" id="5365832">,</span>&nbsp;<span class="ident" id="5365834">r</span>&nbsp;<span class="ident" id="5365836">image</span><span class="op" id="5365841">.</span><span class="ident" id="5365842">Rectangle</span><span class="op" id="5365851">,</span>&nbsp;<span class="ident" id="5365853">src</span>&nbsp;<span class="ident" id="5365857">image</span><span class="op" id="5365862">.</span><span class="ident" id="5365863">Image</span><span class="op" id="5365868">,</span>&nbsp;<span class="ident" id="5365870">sp</span>&nbsp;<span class="ident" id="5365873">image</span><span class="op" id="5365878">.</span><span class="ident" id="5365879">Point</span><span class="op" id="5365884">)</span>&nbsp;<span class="op" id="5365886">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5365889">DrawMask</span><span class="op" id="5365897">(</span><span class="ident" id="5365898">dst</span><span class="op" id="5365901">,</span>&nbsp;<span class="ident" id="5365903">r</span><span class="op" id="5365904">,</span>&nbsp;<span class="ident" id="5365906">src</span><span class="op" id="5365909">,</span>&nbsp;<span class="ident" id="5365911">sp</span><span class="op" id="5365913">,</span>&nbsp;<span class="ident" id="5365915">nil</span><span class="op" id="5365918">,</span>&nbsp;<span class="ident" id="5365920">image</span><span class="op" id="5365925">.</span><span class="ident" id="5365926">Point</span><span class="op" id="5365931">{</span><span class="op" id="5365932">}</span><span class="op" id="5365933">,</span>&nbsp;<span class="ident" id="5365935">op</span><span class="op" id="5365937">)</span><br>
<span class="lineno"></span><span class="op" id="5365939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5365942">//&nbsp;Drawer&nbsp;contains&nbsp;the&nbsp;Draw&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="5365978">type</span>&nbsp;<span class="ident" id="5365983">Drawer</span>&nbsp;<span class="keyword" id="5365990">interface</span>&nbsp;<span class="op" id="5366000">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5366003">//&nbsp;Draw&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5366069">//&nbsp;rectangle&nbsp;r&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;drawing&nbsp;src&nbsp;on&nbsp;dst.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366131">Draw</span><span class="op" id="5366135">(</span><span class="ident" id="5366136">dst</span>&nbsp;<span class="ident" id="5366140">Image</span><span class="op" id="5366145">,</span>&nbsp;<span class="ident" id="5366147">r</span>&nbsp;<span class="ident" id="5366149">image</span><span class="op" id="5366154">.</span><span class="ident" id="5366155">Rectangle</span><span class="op" id="5366164">,</span>&nbsp;<span class="ident" id="5366166">src</span>&nbsp;<span class="ident" id="5366170">image</span><span class="op" id="5366175">.</span><span class="ident" id="5366176">Image</span><span class="op" id="5366181">,</span>&nbsp;<span class="ident" id="5366183">sp</span>&nbsp;<span class="ident" id="5366186">image</span><span class="op" id="5366191">.</span><span class="ident" id="5366192">Point</span><span class="op" id="5366197">)</span><br>
<span class="lineno"></span><span class="op" id="5366199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="5366202">//&nbsp;FloydSteinberg&nbsp;is&nbsp;a&nbsp;Drawer&nbsp;that&nbsp;is&nbsp;the&nbsp;Src&nbsp;Op&nbsp;with&nbsp;Floyd-Steinberg&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5366278">//&nbsp;diffusion.</span><br>
<span class="lineno"></span><span class="keyword" id="5366292">var</span>&nbsp;<span class="ident" id="5366296">FloydSteinberg</span>&nbsp;<span class="ident" id="5366311">Drawer</span>&nbsp;<span class="op" id="5366318">=</span>&nbsp;<span class="ident" id="5366320">floydSteinberg</span><span class="op" id="5366334">{</span><span class="op" id="5366335">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5366338">type</span>&nbsp;<span class="ident" id="5366343">floydSteinberg</span>&nbsp;<span class="keyword" id="5366358">struct</span><span class="op" id="5366364">{</span><span class="op" id="5366365">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5366368">func</span>&nbsp;<span class="op" id="5366373">(</span><span class="ident" id="5366374">floydSteinberg</span><span class="op" id="5366388">)</span>&nbsp;<span class="ident" id="5366390">Draw</span><span class="op" id="5366394">(</span><span class="ident" id="5366395">dst</span>&nbsp;<span class="ident" id="5366399">Image</span><span class="op" id="5366404">,</span>&nbsp;<span class="ident" id="5366406">r</span>&nbsp;<span class="ident" id="5366408">image</span><span class="op" id="5366413">.</span><span class="ident" id="5366414">Rectangle</span><span class="op" id="5366423">,</span>&nbsp;<span class="ident" id="5366425">src</span>&nbsp;<span class="ident" id="5366429">image</span><span class="op" id="5366434">.</span><span class="ident" id="5366435">Image</span><span class="op" id="5366440">,</span>&nbsp;<span class="ident" id="5366442">sp</span>&nbsp;<span class="ident" id="5366445">image</span><span class="op" id="5366450">.</span><span class="ident" id="5366451">Point</span><span class="op" id="5366456">)</span>&nbsp;<span class="op" id="5366458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366461">clip</span><span class="op" id="5366465">(</span><span class="ident" id="5366466">dst</span><span class="op" id="5366469">,</span>&nbsp;<span class="op" id="5366471">&amp;</span><span class="ident" id="5366472">r</span><span class="op" id="5366473">,</span>&nbsp;<span class="ident" id="5366475">src</span><span class="op" id="5366478">,</span>&nbsp;<span class="op" id="5366480">&amp;</span><span class="ident" id="5366481">sp</span><span class="op" id="5366483">,</span>&nbsp;<span class="ident" id="5366485">nil</span><span class="op" id="5366488">,</span>&nbsp;<span class="ident" id="5366490">nil</span><span class="op" id="5366493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366496">if</span>&nbsp;<span class="ident" id="5366499">r</span><span class="op" id="5366500">.</span><span class="ident" id="5366501">Empty</span><span class="op" id="5366506">(</span><span class="op" id="5366507">)</span>&nbsp;<span class="op" id="5366509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366513">return</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366521">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366524">drawPaletted</span><span class="op" id="5366536">(</span><span class="ident" id="5366537">dst</span><span class="op" id="5366540">,</span>&nbsp;<span class="ident" id="5366542">r</span><span class="op" id="5366543">,</span>&nbsp;<span class="ident" id="5366545">src</span><span class="op" id="5366548">,</span>&nbsp;<span class="ident" id="5366550">sp</span><span class="op" id="5366552">,</span>&nbsp;<span class="builtintype" id="5366554">true</span><span class="op" id="5366558">)</span><br>
<span class="lineno"></span><span class="op" id="5366560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5366563">//&nbsp;clip&nbsp;clips&nbsp;r&nbsp;against&nbsp;each&nbsp;image&#39;s&nbsp;bounds&nbsp;(after&nbsp;translating&nbsp;into&nbsp;the</span><br>
<span class="lineno">70</span><span class="comment" id="5366635">//&nbsp;destination&nbsp;image&#39;s&nbsp;co-ordinate&nbsp;space)&nbsp;and&nbsp;shifts&nbsp;the&nbsp;points&nbsp;sp&nbsp;and&nbsp;mp&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="5366712">//&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;change&nbsp;in&nbsp;r.Min.</span><br>
<span class="lineno"></span><span class="keyword" id="5366755">func</span>&nbsp;<span class="ident" id="5366760">clip</span><span class="op" id="5366764">(</span><span class="ident" id="5366765">dst</span>&nbsp;<span class="ident" id="5366769">Image</span><span class="op" id="5366774">,</span>&nbsp;<span class="ident" id="5366776">r</span>&nbsp;<span class="op" id="5366778">*</span><span class="ident" id="5366779">image</span><span class="op" id="5366784">.</span><span class="ident" id="5366785">Rectangle</span><span class="op" id="5366794">,</span>&nbsp;<span class="ident" id="5366796">src</span>&nbsp;<span class="ident" id="5366800">image</span><span class="op" id="5366805">.</span><span class="ident" id="5366806">Image</span><span class="op" id="5366811">,</span>&nbsp;<span class="ident" id="5366813">sp</span>&nbsp;<span class="op" id="5366816">*</span><span class="ident" id="5366817">image</span><span class="op" id="5366822">.</span><span class="ident" id="5366823">Point</span><span class="op" id="5366828">,</span>&nbsp;<span class="ident" id="5366830">mask</span>&nbsp;<span class="ident" id="5366835">image</span><span class="op" id="5366840">.</span><span class="ident" id="5366841">Image</span><span class="op" id="5366846">,</span>&nbsp;<span class="ident" id="5366848">mp</span>&nbsp;<span class="op" id="5366851">*</span><span class="ident" id="5366852">image</span><span class="op" id="5366857">.</span><span class="ident" id="5366858">Point</span><span class="op" id="5366863">)</span>&nbsp;<span class="op" id="5366865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5366868">orig</span>&nbsp;<span class="op" id="5366873">:=</span>&nbsp;<span class="ident" id="5366876">r</span><span class="op" id="5366877">.</span><span class="ident" id="5366878">Min</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366883">*</span><span class="ident" id="5366884">r</span>&nbsp;<span class="op" id="5366886">=</span>&nbsp;<span class="ident" id="5366888">r</span><span class="op" id="5366889">.</span><span class="ident" id="5366890">Intersect</span><span class="op" id="5366899">(</span><span class="ident" id="5366900">dst</span><span class="op" id="5366903">.</span><span class="ident" id="5366904">Bounds</span><span class="op" id="5366910">(</span><span class="op" id="5366911">)</span><span class="op" id="5366912">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366915">*</span><span class="ident" id="5366916">r</span>&nbsp;<span class="op" id="5366918">=</span>&nbsp;<span class="ident" id="5366920">r</span><span class="op" id="5366921">.</span><span class="ident" id="5366922">Intersect</span><span class="op" id="5366931">(</span><span class="ident" id="5366932">src</span><span class="op" id="5366935">.</span><span class="ident" id="5366936">Bounds</span><span class="op" id="5366942">(</span><span class="op" id="5366943">)</span><span class="op" id="5366944">.</span><span class="ident" id="5366945">Add</span><span class="op" id="5366948">(</span><span class="ident" id="5366949">orig</span><span class="op" id="5366953">.</span><span class="ident" id="5366954">Sub</span><span class="op" id="5366957">(</span><span class="op" id="5366958">*</span><span class="ident" id="5366959">sp</span><span class="op" id="5366961">)</span><span class="op" id="5366962">)</span><span class="op" id="5366963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5366966">if</span>&nbsp;<span class="ident" id="5366969">mask</span>&nbsp;<span class="op" id="5366974">!=</span>&nbsp;<span class="ident" id="5366977">nil</span>&nbsp;<span class="op" id="5366981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5366985">*</span><span class="ident" id="5366986">r</span>&nbsp;<span class="op" id="5366988">=</span>&nbsp;<span class="ident" id="5366990">r</span><span class="op" id="5366991">.</span><span class="ident" id="5366992">Intersect</span><span class="op" id="5367001">(</span><span class="ident" id="5367002">mask</span><span class="op" id="5367006">.</span><span class="ident" id="5367007">Bounds</span><span class="op" id="5367013">(</span><span class="op" id="5367014">)</span><span class="op" id="5367015">.</span><span class="ident" id="5367016">Add</span><span class="op" id="5367019">(</span><span class="ident" id="5367020">orig</span><span class="op" id="5367024">.</span><span class="ident" id="5367025">Sub</span><span class="op" id="5367028">(</span><span class="op" id="5367029">*</span><span class="ident" id="5367030">mp</span><span class="op" id="5367032">)</span><span class="op" id="5367033">)</span><span class="op" id="5367034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367040">dx</span>&nbsp;<span class="op" id="5367043">:=</span>&nbsp;<span class="ident" id="5367046">r</span><span class="op" id="5367047">.</span><span class="ident" id="5367048">Min</span><span class="op" id="5367051">.</span><span class="ident" id="5367052">X</span>&nbsp;<span class="op" id="5367054">-</span>&nbsp;<span class="ident" id="5367056">orig</span><span class="op" id="5367060">.</span><span class="ident" id="5367061">X</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367064">dy</span>&nbsp;<span class="op" id="5367067">:=</span>&nbsp;<span class="ident" id="5367070">r</span><span class="op" id="5367071">.</span><span class="ident" id="5367072">Min</span><span class="op" id="5367075">.</span><span class="ident" id="5367076">Y</span>&nbsp;<span class="op" id="5367078">-</span>&nbsp;<span class="ident" id="5367080">orig</span><span class="op" id="5367084">.</span><span class="ident" id="5367085">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367088">if</span>&nbsp;<span class="ident" id="5367091">dx</span>&nbsp;<span class="op" id="5367094">==</span>&nbsp;<span class="num" id="5367097">0</span>&nbsp;<span class="op" id="5367099">&amp;&amp;</span>&nbsp;<span class="ident" id="5367102">dy</span>&nbsp;<span class="op" id="5367105">==</span>&nbsp;<span class="num" id="5367108">0</span>&nbsp;<span class="op" id="5367110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367114">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367125">(</span><span class="op" id="5367126">*</span><span class="ident" id="5367127">sp</span><span class="op" id="5367129">)</span><span class="op" id="5367130">.</span><span class="ident" id="5367131">X</span>&nbsp;<span class="op" id="5367133">+=</span>&nbsp;<span class="ident" id="5367136">dx</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367140">(</span><span class="op" id="5367141">*</span><span class="ident" id="5367142">sp</span><span class="op" id="5367144">)</span><span class="op" id="5367145">.</span><span class="ident" id="5367146">Y</span>&nbsp;<span class="op" id="5367148">+=</span>&nbsp;<span class="ident" id="5367151">dy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367155">(</span><span class="op" id="5367156">*</span><span class="ident" id="5367157">mp</span><span class="op" id="5367159">)</span><span class="op" id="5367160">.</span><span class="ident" id="5367161">X</span>&nbsp;<span class="op" id="5367163">+=</span>&nbsp;<span class="ident" id="5367166">dx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367170">(</span><span class="op" id="5367171">*</span><span class="ident" id="5367172">mp</span><span class="op" id="5367174">)</span><span class="op" id="5367175">.</span><span class="ident" id="5367176">Y</span>&nbsp;<span class="op" id="5367178">+=</span>&nbsp;<span class="ident" id="5367181">dy</span><br>
<span class="lineno"></span><span class="op" id="5367184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="5367187">func</span>&nbsp;<span class="ident" id="5367192">processBackward</span><span class="op" id="5367207">(</span><span class="ident" id="5367208">dst</span>&nbsp;<span class="ident" id="5367212">Image</span><span class="op" id="5367217">,</span>&nbsp;<span class="ident" id="5367219">r</span>&nbsp;<span class="ident" id="5367221">image</span><span class="op" id="5367226">.</span><span class="ident" id="5367227">Rectangle</span><span class="op" id="5367236">,</span>&nbsp;<span class="ident" id="5367238">src</span>&nbsp;<span class="ident" id="5367242">image</span><span class="op" id="5367247">.</span><span class="ident" id="5367248">Image</span><span class="op" id="5367253">,</span>&nbsp;<span class="ident" id="5367255">sp</span>&nbsp;<span class="ident" id="5367258">image</span><span class="op" id="5367263">.</span><span class="ident" id="5367264">Point</span><span class="op" id="5367269">)</span>&nbsp;<span class="builtintype" id="5367271">bool</span>&nbsp;<span class="op" id="5367276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367279">return</span>&nbsp;<span class="ident" id="5367286">image</span><span class="op" id="5367291">.</span><span class="ident" id="5367292">Image</span><span class="op" id="5367297">(</span><span class="ident" id="5367298">dst</span><span class="op" id="5367301">)</span>&nbsp;<span class="op" id="5367303">==</span>&nbsp;<span class="ident" id="5367306">src</span>&nbsp;<span class="op" id="5367310">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367315">r</span><span class="op" id="5367316">.</span><span class="ident" id="5367317">Overlaps</span><span class="op" id="5367325">(</span><span class="ident" id="5367326">r</span><span class="op" id="5367327">.</span><span class="ident" id="5367328">Add</span><span class="op" id="5367331">(</span><span class="ident" id="5367332">sp</span><span class="op" id="5367334">.</span><span class="ident" id="5367335">Sub</span><span class="op" id="5367338">(</span><span class="ident" id="5367339">r</span><span class="op" id="5367340">.</span><span class="ident" id="5367341">Min</span><span class="op" id="5367344">)</span><span class="op" id="5367345">)</span><span class="op" id="5367346">)</span>&nbsp;<span class="op" id="5367348">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367353">(</span><span class="ident" id="5367354">sp</span><span class="op" id="5367356">.</span><span class="ident" id="5367357">Y</span>&nbsp;<span class="op" id="5367359">&lt;</span>&nbsp;<span class="ident" id="5367361">r</span><span class="op" id="5367362">.</span><span class="ident" id="5367363">Min</span><span class="op" id="5367366">.</span><span class="ident" id="5367367">Y</span>&nbsp;<span class="op" id="5367369">||</span>&nbsp;<span class="op" id="5367372">(</span><span class="ident" id="5367373">sp</span><span class="op" id="5367375">.</span><span class="ident" id="5367376">Y</span>&nbsp;<span class="op" id="5367378">==</span>&nbsp;<span class="ident" id="5367381">r</span><span class="op" id="5367382">.</span><span class="ident" id="5367383">Min</span><span class="op" id="5367386">.</span><span class="ident" id="5367387">Y</span>&nbsp;<span class="op" id="5367389">&amp;&amp;</span>&nbsp;<span class="ident" id="5367392">sp</span><span class="op" id="5367394">.</span><span class="ident" id="5367395">X</span>&nbsp;<span class="op" id="5367397">&lt;</span>&nbsp;<span class="ident" id="5367399">r</span><span class="op" id="5367400">.</span><span class="ident" id="5367401">Min</span><span class="op" id="5367404">.</span><span class="ident" id="5367405">X</span><span class="op" id="5367406">)</span><span class="op" id="5367407">)</span><br>
<span class="lineno"></span><span class="op" id="5367409">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="5367412">//&nbsp;Draw&nbsp;calls&nbsp;DrawMask&nbsp;with&nbsp;a&nbsp;nil&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="5367452">func</span>&nbsp;<span class="ident" id="5367457">Draw</span><span class="op" id="5367461">(</span><span class="ident" id="5367462">dst</span>&nbsp;<span class="ident" id="5367466">Image</span><span class="op" id="5367471">,</span>&nbsp;<span class="ident" id="5367473">r</span>&nbsp;<span class="ident" id="5367475">image</span><span class="op" id="5367480">.</span><span class="ident" id="5367481">Rectangle</span><span class="op" id="5367490">,</span>&nbsp;<span class="ident" id="5367492">src</span>&nbsp;<span class="ident" id="5367496">image</span><span class="op" id="5367501">.</span><span class="ident" id="5367502">Image</span><span class="op" id="5367507">,</span>&nbsp;<span class="ident" id="5367509">sp</span>&nbsp;<span class="ident" id="5367512">image</span><span class="op" id="5367517">.</span><span class="ident" id="5367518">Point</span><span class="op" id="5367523">,</span>&nbsp;<span class="ident" id="5367525">op</span>&nbsp;<span class="ident" id="5367528">Op</span><span class="op" id="5367530">)</span>&nbsp;<span class="op" id="5367532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367535">DrawMask</span><span class="op" id="5367543">(</span><span class="ident" id="5367544">dst</span><span class="op" id="5367547">,</span>&nbsp;<span class="ident" id="5367549">r</span><span class="op" id="5367550">,</span>&nbsp;<span class="ident" id="5367552">src</span><span class="op" id="5367555">,</span>&nbsp;<span class="ident" id="5367557">sp</span><span class="op" id="5367559">,</span>&nbsp;<span class="ident" id="5367561">nil</span><span class="op" id="5367564">,</span>&nbsp;<span class="ident" id="5367566">image</span><span class="op" id="5367571">.</span><span class="ident" id="5367572">Point</span><span class="op" id="5367577">{</span><span class="op" id="5367578">}</span><span class="op" id="5367579">,</span>&nbsp;<span class="ident" id="5367581">op</span><span class="op" id="5367583">)</span><br>
<span class="lineno"></span><span class="op" id="5367585">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="5367588">//&nbsp;DrawMask&nbsp;aligns&nbsp;r.Min&nbsp;in&nbsp;dst&nbsp;with&nbsp;sp&nbsp;in&nbsp;src&nbsp;and&nbsp;mp&nbsp;in&nbsp;mask&nbsp;and&nbsp;then&nbsp;replaces&nbsp;the&nbsp;rectangle&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="5367684">//&nbsp;in&nbsp;dst&nbsp;with&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;Porter-Duff&nbsp;composition.&nbsp;A&nbsp;nil&nbsp;mask&nbsp;is&nbsp;treated&nbsp;as&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5367773">func</span>&nbsp;<span class="ident" id="5367778">DrawMask</span><span class="op" id="5367786">(</span><span class="ident" id="5367787">dst</span>&nbsp;<span class="ident" id="5367791">Image</span><span class="op" id="5367796">,</span>&nbsp;<span class="ident" id="5367798">r</span>&nbsp;<span class="ident" id="5367800">image</span><span class="op" id="5367805">.</span><span class="ident" id="5367806">Rectangle</span><span class="op" id="5367815">,</span>&nbsp;<span class="ident" id="5367817">src</span>&nbsp;<span class="ident" id="5367821">image</span><span class="op" id="5367826">.</span><span class="ident" id="5367827">Image</span><span class="op" id="5367832">,</span>&nbsp;<span class="ident" id="5367834">sp</span>&nbsp;<span class="ident" id="5367837">image</span><span class="op" id="5367842">.</span><span class="ident" id="5367843">Point</span><span class="op" id="5367848">,</span>&nbsp;<span class="ident" id="5367850">mask</span>&nbsp;<span class="ident" id="5367855">image</span><span class="op" id="5367860">.</span><span class="ident" id="5367861">Image</span><span class="op" id="5367866">,</span>&nbsp;<span class="ident" id="5367868">mp</span>&nbsp;<span class="ident" id="5367871">image</span><span class="op" id="5367876">.</span><span class="ident" id="5367877">Point</span><span class="op" id="5367882">,</span>&nbsp;<span class="ident" id="5367884">op</span>&nbsp;<span class="ident" id="5367887">Op</span><span class="op" id="5367889">)</span>&nbsp;<span class="op" id="5367891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5367894">clip</span><span class="op" id="5367898">(</span><span class="ident" id="5367899">dst</span><span class="op" id="5367902">,</span>&nbsp;<span class="op" id="5367904">&amp;</span><span class="ident" id="5367905">r</span><span class="op" id="5367906">,</span>&nbsp;<span class="ident" id="5367908">src</span><span class="op" id="5367911">,</span>&nbsp;<span class="op" id="5367913">&amp;</span><span class="ident" id="5367914">sp</span><span class="op" id="5367916">,</span>&nbsp;<span class="ident" id="5367918">mask</span><span class="op" id="5367922">,</span>&nbsp;<span class="op" id="5367924">&amp;</span><span class="ident" id="5367925">mp</span><span class="op" id="5367927">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367930">if</span>&nbsp;<span class="ident" id="5367933">r</span><span class="op" id="5367934">.</span><span class="ident" id="5367935">Empty</span><span class="op" id="5367940">(</span><span class="op" id="5367941">)</span>&nbsp;<span class="op" id="5367943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5367947">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5367955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5367959">//&nbsp;Fast&nbsp;paths&nbsp;for&nbsp;special&nbsp;cases.&nbsp;If&nbsp;none&nbsp;of&nbsp;them&nbsp;apply,&nbsp;then&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;a&nbsp;general&nbsp;but&nbsp;slow&nbsp;implementation.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368072">switch</span>&nbsp;<span class="ident" id="5368079">dst0</span>&nbsp;<span class="op" id="5368084">:=</span>&nbsp;<span class="ident" id="5368087">dst</span><span class="op" id="5368090">.</span><span class="op" id="5368091">(</span><span class="keyword" id="5368092">type</span><span class="op" id="5368096">)</span>&nbsp;<span class="op" id="5368098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368101">case</span>&nbsp;<span class="op" id="5368106">*</span><span class="ident" id="5368107">image</span><span class="op" id="5368112">.</span><span class="ident" id="5368113">RGBA</span><span class="op" id="5368117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368121">if</span>&nbsp;<span class="ident" id="5368124">op</span>&nbsp;<span class="op" id="5368127">==</span>&nbsp;<span class="ident" id="5368130">Over</span>&nbsp;<span class="op" id="5368135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368140">if</span>&nbsp;<span class="ident" id="5368143">mask</span>&nbsp;<span class="op" id="5368148">==</span>&nbsp;<span class="ident" id="5368151">nil</span>&nbsp;<span class="op" id="5368155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368161">switch</span>&nbsp;<span class="ident" id="5368168">src0</span>&nbsp;<span class="op" id="5368173">:=</span>&nbsp;<span class="ident" id="5368176">src</span><span class="op" id="5368179">.</span><span class="op" id="5368180">(</span><span class="keyword" id="5368181">type</span><span class="op" id="5368185">)</span>&nbsp;<span class="op" id="5368187">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368193">case</span>&nbsp;<span class="op" id="5368198">*</span><span class="ident" id="5368199">image</span><span class="op" id="5368204">.</span><span class="ident" id="5368205">Uniform</span><span class="op" id="5368212">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368219">drawFillOver</span><span class="op" id="5368231">(</span><span class="ident" id="5368232">dst0</span><span class="op" id="5368236">,</span>&nbsp;<span class="ident" id="5368238">r</span><span class="op" id="5368239">,</span>&nbsp;<span class="ident" id="5368241">src0</span><span class="op" id="5368245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368252">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368263">case</span>&nbsp;<span class="op" id="5368268">*</span><span class="ident" id="5368269">image</span><span class="op" id="5368274">.</span><span class="ident" id="5368275">RGBA</span><span class="op" id="5368279">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368286">drawCopyOver</span><span class="op" id="5368298">(</span><span class="ident" id="5368299">dst0</span><span class="op" id="5368303">,</span>&nbsp;<span class="ident" id="5368305">r</span><span class="op" id="5368306">,</span>&nbsp;<span class="ident" id="5368308">src0</span><span class="op" id="5368312">,</span>&nbsp;<span class="ident" id="5368314">sp</span><span class="op" id="5368316">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368323">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368334">case</span>&nbsp;<span class="op" id="5368339">*</span><span class="ident" id="5368340">image</span><span class="op" id="5368345">.</span><span class="ident" id="5368346">NRGBA</span><span class="op" id="5368351">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368358">drawNRGBAOver</span><span class="op" id="5368371">(</span><span class="ident" id="5368372">dst0</span><span class="op" id="5368376">,</span>&nbsp;<span class="ident" id="5368378">r</span><span class="op" id="5368379">,</span>&nbsp;<span class="ident" id="5368381">src0</span><span class="op" id="5368385">,</span>&nbsp;<span class="ident" id="5368387">sp</span><span class="op" id="5368389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368396">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368407">case</span>&nbsp;<span class="op" id="5368412">*</span><span class="ident" id="5368413">image</span><span class="op" id="5368418">.</span><span class="ident" id="5368419">YCbCr</span><span class="op" id="5368424">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368431">if</span>&nbsp;<span class="ident" id="5368434">drawYCbCr</span><span class="op" id="5368443">(</span><span class="ident" id="5368444">dst0</span><span class="op" id="5368448">,</span>&nbsp;<span class="ident" id="5368450">r</span><span class="op" id="5368451">,</span>&nbsp;<span class="ident" id="5368453">src0</span><span class="op" id="5368457">,</span>&nbsp;<span class="ident" id="5368459">sp</span><span class="op" id="5368461">)</span>&nbsp;<span class="op" id="5368463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368471">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368494">}</span>&nbsp;<span class="keyword" id="5368496">else</span>&nbsp;<span class="keyword" id="5368501">if</span>&nbsp;<span class="ident" id="5368504">mask0</span><span class="op" id="5368509">,</span>&nbsp;<span class="ident" id="5368511">ok</span>&nbsp;<span class="op" id="5368514">:=</span>&nbsp;<span class="ident" id="5368517">mask</span><span class="op" id="5368521">.</span><span class="op" id="5368522">(</span><span class="op" id="5368523">*</span><span class="ident" id="5368524">image</span><span class="op" id="5368529">.</span><span class="ident" id="5368530">Alpha</span><span class="op" id="5368535">)</span><span class="op" id="5368536">;</span>&nbsp;<span class="ident" id="5368538">ok</span>&nbsp;<span class="op" id="5368541">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368547">switch</span>&nbsp;<span class="ident" id="5368554">src0</span>&nbsp;<span class="op" id="5368559">:=</span>&nbsp;<span class="ident" id="5368562">src</span><span class="op" id="5368565">.</span><span class="op" id="5368566">(</span><span class="keyword" id="5368567">type</span><span class="op" id="5368571">)</span>&nbsp;<span class="op" id="5368573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368579">case</span>&nbsp;<span class="op" id="5368584">*</span><span class="ident" id="5368585">image</span><span class="op" id="5368590">.</span><span class="ident" id="5368591">Uniform</span><span class="op" id="5368598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368605">drawGlyphOver</span><span class="op" id="5368618">(</span><span class="ident" id="5368619">dst0</span><span class="op" id="5368623">,</span>&nbsp;<span class="ident" id="5368625">r</span><span class="op" id="5368626">,</span>&nbsp;<span class="ident" id="5368628">src0</span><span class="op" id="5368632">,</span>&nbsp;<span class="ident" id="5368634">mask0</span><span class="op" id="5368639">,</span>&nbsp;<span class="ident" id="5368641">mp</span><span class="op" id="5368643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368650">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368661">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5368670">}</span>&nbsp;<span class="keyword" id="5368672">else</span>&nbsp;<span class="op" id="5368677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368682">if</span>&nbsp;<span class="ident" id="5368685">mask</span>&nbsp;<span class="op" id="5368690">==</span>&nbsp;<span class="ident" id="5368693">nil</span>&nbsp;<span class="op" id="5368697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368703">switch</span>&nbsp;<span class="ident" id="5368710">src0</span>&nbsp;<span class="op" id="5368715">:=</span>&nbsp;<span class="ident" id="5368718">src</span><span class="op" id="5368721">.</span><span class="op" id="5368722">(</span><span class="keyword" id="5368723">type</span><span class="op" id="5368727">)</span>&nbsp;<span class="op" id="5368729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368735">case</span>&nbsp;<span class="op" id="5368740">*</span><span class="ident" id="5368741">image</span><span class="op" id="5368746">.</span><span class="ident" id="5368747">Uniform</span><span class="op" id="5368754">:</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368761">drawFillSrc</span><span class="op" id="5368772">(</span><span class="ident" id="5368773">dst0</span><span class="op" id="5368777">,</span>&nbsp;<span class="ident" id="5368779">r</span><span class="op" id="5368780">,</span>&nbsp;<span class="ident" id="5368782">src0</span><span class="op" id="5368786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368793">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368804">case</span>&nbsp;<span class="op" id="5368809">*</span><span class="ident" id="5368810">image</span><span class="op" id="5368815">.</span><span class="ident" id="5368816">RGBA</span><span class="op" id="5368820">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368827">drawCopySrc</span><span class="op" id="5368838">(</span><span class="ident" id="5368839">dst0</span><span class="op" id="5368843">,</span>&nbsp;<span class="ident" id="5368845">r</span><span class="op" id="5368846">,</span>&nbsp;<span class="ident" id="5368848">src0</span><span class="op" id="5368852">,</span>&nbsp;<span class="ident" id="5368854">sp</span><span class="op" id="5368856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368863">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368874">case</span>&nbsp;<span class="op" id="5368879">*</span><span class="ident" id="5368880">image</span><span class="op" id="5368885">.</span><span class="ident" id="5368886">NRGBA</span><span class="op" id="5368891">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5368898">drawNRGBASrc</span><span class="op" id="5368910">(</span><span class="ident" id="5368911">dst0</span><span class="op" id="5368915">,</span>&nbsp;<span class="ident" id="5368917">r</span><span class="op" id="5368918">,</span>&nbsp;<span class="ident" id="5368920">src0</span><span class="op" id="5368924">,</span>&nbsp;<span class="ident" id="5368926">sp</span><span class="op" id="5368928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368935">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368946">case</span>&nbsp;<span class="op" id="5368951">*</span><span class="ident" id="5368952">image</span><span class="op" id="5368957">.</span><span class="ident" id="5368958">YCbCr</span><span class="op" id="5368963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5368970">if</span>&nbsp;<span class="ident" id="5368973">drawYCbCr</span><span class="op" id="5368982">(</span><span class="ident" id="5368983">dst0</span><span class="op" id="5368987">,</span>&nbsp;<span class="ident" id="5368989">r</span><span class="op" id="5368990">,</span>&nbsp;<span class="ident" id="5368992">src0</span><span class="op" id="5368996">,</span>&nbsp;<span class="ident" id="5368998">sp</span><span class="op" id="5369000">)</span>&nbsp;<span class="op" id="5369002">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369010">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369037">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369041">drawRGBA</span><span class="op" id="5369049">(</span><span class="ident" id="5369050">dst0</span><span class="op" id="5369054">,</span>&nbsp;<span class="ident" id="5369056">r</span><span class="op" id="5369057">,</span>&nbsp;<span class="ident" id="5369059">src</span><span class="op" id="5369062">,</span>&nbsp;<span class="ident" id="5369064">sp</span><span class="op" id="5369066">,</span>&nbsp;<span class="ident" id="5369068">mask</span><span class="op" id="5369072">,</span>&nbsp;<span class="ident" id="5369074">mp</span><span class="op" id="5369076">,</span>&nbsp;<span class="ident" id="5369078">op</span><span class="op" id="5369080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369084">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369092">case</span>&nbsp;<span class="op" id="5369097">*</span><span class="ident" id="5369098">image</span><span class="op" id="5369103">.</span><span class="ident" id="5369104">Paletted</span><span class="op" id="5369112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369116">if</span>&nbsp;<span class="ident" id="5369119">op</span>&nbsp;<span class="op" id="5369122">==</span>&nbsp;<span class="ident" id="5369125">Src</span>&nbsp;<span class="op" id="5369129">&amp;&amp;</span>&nbsp;<span class="ident" id="5369132">mask</span>&nbsp;<span class="op" id="5369137">==</span>&nbsp;<span class="ident" id="5369140">nil</span>&nbsp;<span class="op" id="5369144">&amp;&amp;</span>&nbsp;<span class="op" id="5369147">!</span><span class="ident" id="5369148">processBackward</span><span class="op" id="5369163">(</span><span class="ident" id="5369164">dst</span><span class="op" id="5369167">,</span>&nbsp;<span class="ident" id="5369169">r</span><span class="op" id="5369170">,</span>&nbsp;<span class="ident" id="5369172">src</span><span class="op" id="5369175">,</span>&nbsp;<span class="ident" id="5369177">sp</span><span class="op" id="5369179">)</span>&nbsp;<span class="op" id="5369181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369186">drawPaletted</span><span class="op" id="5369198">(</span><span class="ident" id="5369199">dst0</span><span class="op" id="5369203">,</span>&nbsp;<span class="ident" id="5369205">r</span><span class="op" id="5369206">,</span>&nbsp;<span class="ident" id="5369208">src</span><span class="op" id="5369211">,</span>&nbsp;<span class="ident" id="5369213">sp</span><span class="op" id="5369215">,</span>&nbsp;<span class="builtintype" id="5369217">false</span><span class="op" id="5369222">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369233">x0</span><span class="op" id="5369235">,</span>&nbsp;<span class="ident" id="5369237">x1</span><span class="op" id="5369239">,</span>&nbsp;<span class="ident" id="5369241">dx</span>&nbsp;<span class="op" id="5369244">:=</span>&nbsp;<span class="ident" id="5369247">r</span><span class="op" id="5369248">.</span><span class="ident" id="5369249">Min</span><span class="op" id="5369252">.</span><span class="ident" id="5369253">X</span><span class="op" id="5369254">,</span>&nbsp;<span class="ident" id="5369256">r</span><span class="op" id="5369257">.</span><span class="ident" id="5369258">Max</span><span class="op" id="5369261">.</span><span class="ident" id="5369262">X</span><span class="op" id="5369263">,</span>&nbsp;<span class="num" id="5369265">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369268">y0</span><span class="op" id="5369270">,</span>&nbsp;<span class="ident" id="5369272">y1</span><span class="op" id="5369274">,</span>&nbsp;<span class="ident" id="5369276">dy</span>&nbsp;<span class="op" id="5369279">:=</span>&nbsp;<span class="ident" id="5369282">r</span><span class="op" id="5369283">.</span><span class="ident" id="5369284">Min</span><span class="op" id="5369287">.</span><span class="ident" id="5369288">Y</span><span class="op" id="5369289">,</span>&nbsp;<span class="ident" id="5369291">r</span><span class="op" id="5369292">.</span><span class="ident" id="5369293">Max</span><span class="op" id="5369296">.</span><span class="ident" id="5369297">Y</span><span class="op" id="5369298">,</span>&nbsp;<span class="num" id="5369300">1</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369303">if</span>&nbsp;<span class="ident" id="5369306">processBackward</span><span class="op" id="5369321">(</span><span class="ident" id="5369322">dst</span><span class="op" id="5369325">,</span>&nbsp;<span class="ident" id="5369327">r</span><span class="op" id="5369328">,</span>&nbsp;<span class="ident" id="5369330">src</span><span class="op" id="5369333">,</span>&nbsp;<span class="ident" id="5369335">sp</span><span class="op" id="5369337">)</span>&nbsp;<span class="op" id="5369339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369343">x0</span><span class="op" id="5369345">,</span>&nbsp;<span class="ident" id="5369347">x1</span><span class="op" id="5369349">,</span>&nbsp;<span class="ident" id="5369351">dx</span>&nbsp;<span class="op" id="5369354">=</span>&nbsp;<span class="ident" id="5369356">x1</span><span class="op" id="5369358">-</span><span class="num" id="5369359">1</span><span class="op" id="5369360">,</span>&nbsp;<span class="ident" id="5369362">x0</span><span class="op" id="5369364">-</span><span class="num" id="5369365">1</span><span class="op" id="5369366">,</span>&nbsp;<span class="op" id="5369368">-</span><span class="num" id="5369369">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369373">y0</span><span class="op" id="5369375">,</span>&nbsp;<span class="ident" id="5369377">y1</span><span class="op" id="5369379">,</span>&nbsp;<span class="ident" id="5369381">dy</span>&nbsp;<span class="op" id="5369384">=</span>&nbsp;<span class="ident" id="5369386">y1</span><span class="op" id="5369388">-</span><span class="num" id="5369389">1</span><span class="op" id="5369390">,</span>&nbsp;<span class="ident" id="5369392">y0</span><span class="op" id="5369394">-</span><span class="num" id="5369395">1</span><span class="op" id="5369396">,</span>&nbsp;<span class="op" id="5369398">-</span><span class="num" id="5369399">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369406">var</span>&nbsp;<span class="ident" id="5369410">out</span>&nbsp;<span class="ident" id="5369414">color</span><span class="op" id="5369419">.</span><span class="ident" id="5369420">RGBA64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369428">sy</span>&nbsp;<span class="op" id="5369431">:=</span>&nbsp;<span class="ident" id="5369434">sp</span><span class="op" id="5369436">.</span><span class="ident" id="5369437">Y</span>&nbsp;<span class="op" id="5369439">+</span>&nbsp;<span class="ident" id="5369441">y0</span>&nbsp;<span class="op" id="5369444">-</span>&nbsp;<span class="ident" id="5369446">r</span><span class="op" id="5369447">.</span><span class="ident" id="5369448">Min</span><span class="op" id="5369451">.</span><span class="ident" id="5369452">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369455">my</span>&nbsp;<span class="op" id="5369458">:=</span>&nbsp;<span class="ident" id="5369461">mp</span><span class="op" id="5369463">.</span><span class="ident" id="5369464">Y</span>&nbsp;<span class="op" id="5369466">+</span>&nbsp;<span class="ident" id="5369468">y0</span>&nbsp;<span class="op" id="5369471">-</span>&nbsp;<span class="ident" id="5369473">r</span><span class="op" id="5369474">.</span><span class="ident" id="5369475">Min</span><span class="op" id="5369478">.</span><span class="ident" id="5369479">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369482">for</span>&nbsp;<span class="ident" id="5369486">y</span>&nbsp;<span class="op" id="5369488">:=</span>&nbsp;<span class="ident" id="5369491">y0</span><span class="op" id="5369493">;</span>&nbsp;<span class="ident" id="5369495">y</span>&nbsp;<span class="op" id="5369497">!=</span>&nbsp;<span class="ident" id="5369500">y1</span><span class="op" id="5369502">;</span>&nbsp;<span class="ident" id="5369504">y</span><span class="op" id="5369505">,</span>&nbsp;<span class="ident" id="5369507">sy</span><span class="op" id="5369509">,</span>&nbsp;<span class="ident" id="5369511">my</span>&nbsp;<span class="op" id="5369514">=</span>&nbsp;<span class="ident" id="5369516">y</span><span class="op" id="5369517">+</span><span class="ident" id="5369518">dy</span><span class="op" id="5369520">,</span>&nbsp;<span class="ident" id="5369522">sy</span><span class="op" id="5369524">+</span><span class="ident" id="5369525">dy</span><span class="op" id="5369527">,</span>&nbsp;<span class="ident" id="5369529">my</span><span class="op" id="5369531">+</span><span class="ident" id="5369532">dy</span>&nbsp;<span class="op" id="5369535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369539">sx</span>&nbsp;<span class="op" id="5369542">:=</span>&nbsp;<span class="ident" id="5369545">sp</span><span class="op" id="5369547">.</span><span class="ident" id="5369548">X</span>&nbsp;<span class="op" id="5369550">+</span>&nbsp;<span class="ident" id="5369552">x0</span>&nbsp;<span class="op" id="5369555">-</span>&nbsp;<span class="ident" id="5369557">r</span><span class="op" id="5369558">.</span><span class="ident" id="5369559">Min</span><span class="op" id="5369562">.</span><span class="ident" id="5369563">X</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369567">mx</span>&nbsp;<span class="op" id="5369570">:=</span>&nbsp;<span class="ident" id="5369573">mp</span><span class="op" id="5369575">.</span><span class="ident" id="5369576">X</span>&nbsp;<span class="op" id="5369578">+</span>&nbsp;<span class="ident" id="5369580">x0</span>&nbsp;<span class="op" id="5369583">-</span>&nbsp;<span class="ident" id="5369585">r</span><span class="op" id="5369586">.</span><span class="ident" id="5369587">Min</span><span class="op" id="5369590">.</span><span class="ident" id="5369591">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369595">for</span>&nbsp;<span class="ident" id="5369599">x</span>&nbsp;<span class="op" id="5369601">:=</span>&nbsp;<span class="ident" id="5369604">x0</span><span class="op" id="5369606">;</span>&nbsp;<span class="ident" id="5369608">x</span>&nbsp;<span class="op" id="5369610">!=</span>&nbsp;<span class="ident" id="5369613">x1</span><span class="op" id="5369615">;</span>&nbsp;<span class="ident" id="5369617">x</span><span class="op" id="5369618">,</span>&nbsp;<span class="ident" id="5369620">sx</span><span class="op" id="5369622">,</span>&nbsp;<span class="ident" id="5369624">mx</span>&nbsp;<span class="op" id="5369627">=</span>&nbsp;<span class="ident" id="5369629">x</span><span class="op" id="5369630">+</span><span class="ident" id="5369631">dx</span><span class="op" id="5369633">,</span>&nbsp;<span class="ident" id="5369635">sx</span><span class="op" id="5369637">+</span><span class="ident" id="5369638">dx</span><span class="op" id="5369640">,</span>&nbsp;<span class="ident" id="5369642">mx</span><span class="op" id="5369644">+</span><span class="ident" id="5369645">dx</span>&nbsp;<span class="op" id="5369648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369653">ma</span>&nbsp;<span class="op" id="5369656">:=</span>&nbsp;<span class="builtintype" id="5369659">uint32</span><span class="op" id="5369665">(</span><span class="ident" id="5369666">m</span><span class="op" id="5369667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369672">if</span>&nbsp;<span class="ident" id="5369675">mask</span>&nbsp;<span class="op" id="5369680">!=</span>&nbsp;<span class="ident" id="5369683">nil</span>&nbsp;<span class="op" id="5369687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369693">_</span><span class="op" id="5369694">,</span>&nbsp;<span class="ident" id="5369696">_</span><span class="op" id="5369697">,</span>&nbsp;<span class="ident" id="5369699">_</span><span class="op" id="5369700">,</span>&nbsp;<span class="ident" id="5369702">ma</span>&nbsp;<span class="op" id="5369705">=</span>&nbsp;<span class="ident" id="5369707">mask</span><span class="op" id="5369711">.</span><span class="ident" id="5369712">At</span><span class="op" id="5369714">(</span><span class="ident" id="5369715">mx</span><span class="op" id="5369717">,</span>&nbsp;<span class="ident" id="5369719">my</span><span class="op" id="5369721">)</span><span class="op" id="5369722">.</span><span class="ident" id="5369723">RGBA</span><span class="op" id="5369727">(</span><span class="op" id="5369728">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369738">switch</span>&nbsp;<span class="op" id="5369745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369750">case</span>&nbsp;<span class="ident" id="5369755">ma</span>&nbsp;<span class="op" id="5369758">==</span>&nbsp;<span class="num" id="5369761">0</span><span class="op" id="5369762">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369768">if</span>&nbsp;<span class="ident" id="5369771">op</span>&nbsp;<span class="op" id="5369774">==</span>&nbsp;<span class="ident" id="5369777">Over</span>&nbsp;<span class="op" id="5369782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5369789">//&nbsp;No-op.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369803">}</span>&nbsp;<span class="keyword" id="5369805">else</span>&nbsp;<span class="op" id="5369810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369817">dst</span><span class="op" id="5369820">.</span><span class="ident" id="5369821">Set</span><span class="op" id="5369824">(</span><span class="ident" id="5369825">x</span><span class="op" id="5369826">,</span>&nbsp;<span class="ident" id="5369828">y</span><span class="op" id="5369829">,</span>&nbsp;<span class="ident" id="5369831">color</span><span class="op" id="5369836">.</span><span class="ident" id="5369837">Transparent</span><span class="op" id="5369848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5369854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369859">case</span>&nbsp;<span class="ident" id="5369864">ma</span>&nbsp;<span class="op" id="5369867">==</span>&nbsp;<span class="ident" id="5369870">m</span>&nbsp;<span class="op" id="5369872">&amp;&amp;</span>&nbsp;<span class="ident" id="5369875">op</span>&nbsp;<span class="op" id="5369878">==</span>&nbsp;<span class="ident" id="5369881">Src</span><span class="op" id="5369884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369890">dst</span><span class="op" id="5369893">.</span><span class="ident" id="5369894">Set</span><span class="op" id="5369897">(</span><span class="ident" id="5369898">x</span><span class="op" id="5369899">,</span>&nbsp;<span class="ident" id="5369901">y</span><span class="op" id="5369902">,</span>&nbsp;<span class="ident" id="5369904">src</span><span class="op" id="5369907">.</span><span class="ident" id="5369908">At</span><span class="op" id="5369910">(</span><span class="ident" id="5369911">sx</span><span class="op" id="5369913">,</span>&nbsp;<span class="ident" id="5369915">sy</span><span class="op" id="5369917">)</span><span class="op" id="5369918">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369923">default</span><span class="op" id="5369930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5369936">sr</span><span class="op" id="5369938">,</span>&nbsp;<span class="ident" id="5369940">sg</span><span class="op" id="5369942">,</span>&nbsp;<span class="ident" id="5369944">sb</span><span class="op" id="5369946">,</span>&nbsp;<span class="ident" id="5369948">sa</span>&nbsp;<span class="op" id="5369951">:=</span>&nbsp;<span class="ident" id="5369954">src</span><span class="op" id="5369957">.</span><span class="ident" id="5369958">At</span><span class="op" id="5369960">(</span><span class="ident" id="5369961">sx</span><span class="op" id="5369963">,</span>&nbsp;<span class="ident" id="5369965">sy</span><span class="op" id="5369967">)</span><span class="op" id="5369968">.</span><span class="ident" id="5369969">RGBA</span><span class="op" id="5369973">(</span><span class="op" id="5369974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5369980">if</span>&nbsp;<span class="ident" id="5369983">op</span>&nbsp;<span class="op" id="5369986">==</span>&nbsp;<span class="ident" id="5369989">Over</span>&nbsp;<span class="op" id="5369994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370001">dr</span><span class="op" id="5370003">,</span>&nbsp;<span class="ident" id="5370005">dg</span><span class="op" id="5370007">,</span>&nbsp;<span class="ident" id="5370009">db</span><span class="op" id="5370011">,</span>&nbsp;<span class="ident" id="5370013">da</span>&nbsp;<span class="op" id="5370016">:=</span>&nbsp;<span class="ident" id="5370019">dst</span><span class="op" id="5370022">.</span><span class="ident" id="5370023">At</span><span class="op" id="5370025">(</span><span class="ident" id="5370026">x</span><span class="op" id="5370027">,</span>&nbsp;<span class="ident" id="5370029">y</span><span class="op" id="5370030">)</span><span class="op" id="5370031">.</span><span class="ident" id="5370032">RGBA</span><span class="op" id="5370036">(</span><span class="op" id="5370037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370044">a</span>&nbsp;<span class="op" id="5370046">:=</span>&nbsp;<span class="ident" id="5370049">m</span>&nbsp;<span class="op" id="5370051">-</span>&nbsp;<span class="op" id="5370053">(</span><span class="ident" id="5370054">sa</span>&nbsp;<span class="op" id="5370057">*</span>&nbsp;<span class="ident" id="5370059">ma</span>&nbsp;<span class="op" id="5370062">/</span>&nbsp;<span class="ident" id="5370064">m</span><span class="op" id="5370065">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370072">out</span><span class="op" id="5370075">.</span><span class="ident" id="5370076">R</span>&nbsp;<span class="op" id="5370078">=</span>&nbsp;<span class="builtintype" id="5370080">uint16</span><span class="op" id="5370086">(</span><span class="op" id="5370087">(</span><span class="ident" id="5370088">dr</span><span class="op" id="5370090">*</span><span class="ident" id="5370091">a</span>&nbsp;<span class="op" id="5370093">+</span>&nbsp;<span class="ident" id="5370095">sr</span><span class="op" id="5370097">*</span><span class="ident" id="5370098">ma</span><span class="op" id="5370100">)</span>&nbsp;<span class="op" id="5370102">/</span>&nbsp;<span class="ident" id="5370104">m</span><span class="op" id="5370105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370112">out</span><span class="op" id="5370115">.</span><span class="ident" id="5370116">G</span>&nbsp;<span class="op" id="5370118">=</span>&nbsp;<span class="builtintype" id="5370120">uint16</span><span class="op" id="5370126">(</span><span class="op" id="5370127">(</span><span class="ident" id="5370128">dg</span><span class="op" id="5370130">*</span><span class="ident" id="5370131">a</span>&nbsp;<span class="op" id="5370133">+</span>&nbsp;<span class="ident" id="5370135">sg</span><span class="op" id="5370137">*</span><span class="ident" id="5370138">ma</span><span class="op" id="5370140">)</span>&nbsp;<span class="op" id="5370142">/</span>&nbsp;<span class="ident" id="5370144">m</span><span class="op" id="5370145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370152">out</span><span class="op" id="5370155">.</span><span class="ident" id="5370156">B</span>&nbsp;<span class="op" id="5370158">=</span>&nbsp;<span class="builtintype" id="5370160">uint16</span><span class="op" id="5370166">(</span><span class="op" id="5370167">(</span><span class="ident" id="5370168">db</span><span class="op" id="5370170">*</span><span class="ident" id="5370171">a</span>&nbsp;<span class="op" id="5370173">+</span>&nbsp;<span class="ident" id="5370175">sb</span><span class="op" id="5370177">*</span><span class="ident" id="5370178">ma</span><span class="op" id="5370180">)</span>&nbsp;<span class="op" id="5370182">/</span>&nbsp;<span class="ident" id="5370184">m</span><span class="op" id="5370185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370192">out</span><span class="op" id="5370195">.</span><span class="ident" id="5370196">A</span>&nbsp;<span class="op" id="5370198">=</span>&nbsp;<span class="builtintype" id="5370200">uint16</span><span class="op" id="5370206">(</span><span class="op" id="5370207">(</span><span class="ident" id="5370208">da</span><span class="op" id="5370210">*</span><span class="ident" id="5370211">a</span>&nbsp;<span class="op" id="5370213">+</span>&nbsp;<span class="ident" id="5370215">sa</span><span class="op" id="5370217">*</span><span class="ident" id="5370218">ma</span><span class="op" id="5370220">)</span>&nbsp;<span class="op" id="5370222">/</span>&nbsp;<span class="ident" id="5370224">m</span><span class="op" id="5370225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370231">}</span>&nbsp;<span class="keyword" id="5370233">else</span>&nbsp;<span class="op" id="5370238">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370245">out</span><span class="op" id="5370248">.</span><span class="ident" id="5370249">R</span>&nbsp;<span class="op" id="5370251">=</span>&nbsp;<span class="builtintype" id="5370253">uint16</span><span class="op" id="5370259">(</span><span class="ident" id="5370260">sr</span>&nbsp;<span class="op" id="5370263">*</span>&nbsp;<span class="ident" id="5370265">ma</span>&nbsp;<span class="op" id="5370268">/</span>&nbsp;<span class="ident" id="5370270">m</span><span class="op" id="5370271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370278">out</span><span class="op" id="5370281">.</span><span class="ident" id="5370282">G</span>&nbsp;<span class="op" id="5370284">=</span>&nbsp;<span class="builtintype" id="5370286">uint16</span><span class="op" id="5370292">(</span><span class="ident" id="5370293">sg</span>&nbsp;<span class="op" id="5370296">*</span>&nbsp;<span class="ident" id="5370298">ma</span>&nbsp;<span class="op" id="5370301">/</span>&nbsp;<span class="ident" id="5370303">m</span><span class="op" id="5370304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370311">out</span><span class="op" id="5370314">.</span><span class="ident" id="5370315">B</span>&nbsp;<span class="op" id="5370317">=</span>&nbsp;<span class="builtintype" id="5370319">uint16</span><span class="op" id="5370325">(</span><span class="ident" id="5370326">sb</span>&nbsp;<span class="op" id="5370329">*</span>&nbsp;<span class="ident" id="5370331">ma</span>&nbsp;<span class="op" id="5370334">/</span>&nbsp;<span class="ident" id="5370336">m</span><span class="op" id="5370337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370344">out</span><span class="op" id="5370347">.</span><span class="ident" id="5370348">A</span>&nbsp;<span class="op" id="5370350">=</span>&nbsp;<span class="builtintype" id="5370352">uint16</span><span class="op" id="5370358">(</span><span class="ident" id="5370359">sa</span>&nbsp;<span class="op" id="5370362">*</span>&nbsp;<span class="ident" id="5370364">ma</span>&nbsp;<span class="op" id="5370367">/</span>&nbsp;<span class="ident" id="5370369">m</span><span class="op" id="5370370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370376">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370382">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370443">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370508">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370571">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370632">dst</span><span class="op" id="5370635">.</span><span class="ident" id="5370636">Set</span><span class="op" id="5370639">(</span><span class="ident" id="5370640">x</span><span class="op" id="5370641">,</span>&nbsp;<span class="ident" id="5370643">y</span><span class="op" id="5370644">,</span>&nbsp;<span class="op" id="5370646">&amp;</span><span class="ident" id="5370647">out</span><span class="op" id="5370650">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370655">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5370662">}</span><br>
<span class="lineno"></span><span class="op" id="5370664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="5370667">func</span>&nbsp;<span class="ident" id="5370672">drawFillOver</span><span class="op" id="5370684">(</span><span class="ident" id="5370685">dst</span>&nbsp;<span class="op" id="5370689">*</span><span class="ident" id="5370690">image</span><span class="op" id="5370695">.</span><span class="ident" id="5370696">RGBA</span><span class="op" id="5370700">,</span>&nbsp;<span class="ident" id="5370702">r</span>&nbsp;<span class="ident" id="5370704">image</span><span class="op" id="5370709">.</span><span class="ident" id="5370710">Rectangle</span><span class="op" id="5370719">,</span>&nbsp;<span class="ident" id="5370721">src</span>&nbsp;<span class="op" id="5370725">*</span><span class="ident" id="5370726">image</span><span class="op" id="5370731">.</span><span class="ident" id="5370732">Uniform</span><span class="op" id="5370739">)</span>&nbsp;<span class="op" id="5370741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370744">sr</span><span class="op" id="5370746">,</span>&nbsp;<span class="ident" id="5370748">sg</span><span class="op" id="5370750">,</span>&nbsp;<span class="ident" id="5370752">sb</span><span class="op" id="5370754">,</span>&nbsp;<span class="ident" id="5370756">sa</span>&nbsp;<span class="op" id="5370759">:=</span>&nbsp;<span class="ident" id="5370762">src</span><span class="op" id="5370765">.</span><span class="ident" id="5370766">RGBA</span><span class="op" id="5370770">(</span><span class="op" id="5370771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5370774">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370832">a</span>&nbsp;<span class="op" id="5370834">:=</span>&nbsp;<span class="op" id="5370837">(</span><span class="ident" id="5370838">m</span>&nbsp;<span class="op" id="5370840">-</span>&nbsp;<span class="ident" id="5370842">sa</span><span class="op" id="5370844">)</span>&nbsp;<span class="op" id="5370846">*</span>&nbsp;<span class="num" id="5370848">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370855">i0</span>&nbsp;<span class="op" id="5370858">:=</span>&nbsp;<span class="ident" id="5370861">dst</span><span class="op" id="5370864">.</span><span class="ident" id="5370865">PixOffset</span><span class="op" id="5370874">(</span><span class="ident" id="5370875">r</span><span class="op" id="5370876">.</span><span class="ident" id="5370877">Min</span><span class="op" id="5370880">.</span><span class="ident" id="5370881">X</span><span class="op" id="5370882">,</span>&nbsp;<span class="ident" id="5370884">r</span><span class="op" id="5370885">.</span><span class="ident" id="5370886">Min</span><span class="op" id="5370889">.</span><span class="ident" id="5370890">Y</span><span class="op" id="5370891">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370894">i1</span>&nbsp;<span class="op" id="5370897">:=</span>&nbsp;<span class="ident" id="5370900">i0</span>&nbsp;<span class="op" id="5370903">+</span>&nbsp;<span class="ident" id="5370905">r</span><span class="op" id="5370906">.</span><span class="ident" id="5370907">Dx</span><span class="op" id="5370909">(</span><span class="op" id="5370910">)</span><span class="op" id="5370911">*</span><span class="num" id="5370912">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370915">for</span>&nbsp;<span class="ident" id="5370919">y</span>&nbsp;<span class="op" id="5370921">:=</span>&nbsp;<span class="ident" id="5370924">r</span><span class="op" id="5370925">.</span><span class="ident" id="5370926">Min</span><span class="op" id="5370929">.</span><span class="ident" id="5370930">Y</span><span class="op" id="5370931">;</span>&nbsp;<span class="ident" id="5370933">y</span>&nbsp;<span class="op" id="5370935">!=</span>&nbsp;<span class="ident" id="5370938">r</span><span class="op" id="5370939">.</span><span class="ident" id="5370940">Max</span><span class="op" id="5370943">.</span><span class="ident" id="5370944">Y</span><span class="op" id="5370945">;</span>&nbsp;<span class="ident" id="5370947">y</span><span class="op" id="5370948">++</span>&nbsp;<span class="op" id="5370951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5370955">for</span>&nbsp;<span class="ident" id="5370959">i</span>&nbsp;<span class="op" id="5370961">:=</span>&nbsp;<span class="ident" id="5370964">i0</span><span class="op" id="5370966">;</span>&nbsp;<span class="ident" id="5370968">i</span>&nbsp;<span class="op" id="5370970">&lt;</span>&nbsp;<span class="ident" id="5370972">i1</span><span class="op" id="5370974">;</span>&nbsp;<span class="ident" id="5370976">i</span>&nbsp;<span class="op" id="5370978">+=</span>&nbsp;<span class="num" id="5370981">4</span>&nbsp;<span class="op" id="5370983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5370988">dr</span>&nbsp;<span class="op" id="5370991">:=</span>&nbsp;<span class="builtintype" id="5370994">uint32</span><span class="op" id="5371000">(</span><span class="ident" id="5371001">dst</span><span class="op" id="5371004">.</span><span class="ident" id="5371005">Pix</span><span class="op" id="5371008">[</span><span class="ident" id="5371009">i</span><span class="op" id="5371010">+</span><span class="num" id="5371011">0</span><span class="op" id="5371012">]</span><span class="op" id="5371013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371018">dg</span>&nbsp;<span class="op" id="5371021">:=</span>&nbsp;<span class="builtintype" id="5371024">uint32</span><span class="op" id="5371030">(</span><span class="ident" id="5371031">dst</span><span class="op" id="5371034">.</span><span class="ident" id="5371035">Pix</span><span class="op" id="5371038">[</span><span class="ident" id="5371039">i</span><span class="op" id="5371040">+</span><span class="num" id="5371041">1</span><span class="op" id="5371042">]</span><span class="op" id="5371043">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371048">db</span>&nbsp;<span class="op" id="5371051">:=</span>&nbsp;<span class="builtintype" id="5371054">uint32</span><span class="op" id="5371060">(</span><span class="ident" id="5371061">dst</span><span class="op" id="5371064">.</span><span class="ident" id="5371065">Pix</span><span class="op" id="5371068">[</span><span class="ident" id="5371069">i</span><span class="op" id="5371070">+</span><span class="num" id="5371071">2</span><span class="op" id="5371072">]</span><span class="op" id="5371073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371078">da</span>&nbsp;<span class="op" id="5371081">:=</span>&nbsp;<span class="builtintype" id="5371084">uint32</span><span class="op" id="5371090">(</span><span class="ident" id="5371091">dst</span><span class="op" id="5371094">.</span><span class="ident" id="5371095">Pix</span><span class="op" id="5371098">[</span><span class="ident" id="5371099">i</span><span class="op" id="5371100">+</span><span class="num" id="5371101">3</span><span class="op" id="5371102">]</span><span class="op" id="5371103">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371109">dst</span><span class="op" id="5371112">.</span><span class="ident" id="5371113">Pix</span><span class="op" id="5371116">[</span><span class="ident" id="5371117">i</span><span class="op" id="5371118">+</span><span class="num" id="5371119">0</span><span class="op" id="5371120">]</span>&nbsp;<span class="op" id="5371122">=</span>&nbsp;<span class="builtintype" id="5371124">uint8</span><span class="op" id="5371129">(</span><span class="op" id="5371130">(</span><span class="ident" id="5371131">dr</span><span class="op" id="5371133">*</span><span class="ident" id="5371134">a</span><span class="op" id="5371135">/</span><span class="ident" id="5371136">m</span>&nbsp;<span class="op" id="5371138">+</span>&nbsp;<span class="ident" id="5371140">sr</span><span class="op" id="5371142">)</span>&nbsp;<span class="op" id="5371144">&gt;&gt;</span>&nbsp;<span class="num" id="5371147">8</span><span class="op" id="5371148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371153">dst</span><span class="op" id="5371156">.</span><span class="ident" id="5371157">Pix</span><span class="op" id="5371160">[</span><span class="ident" id="5371161">i</span><span class="op" id="5371162">+</span><span class="num" id="5371163">1</span><span class="op" id="5371164">]</span>&nbsp;<span class="op" id="5371166">=</span>&nbsp;<span class="builtintype" id="5371168">uint8</span><span class="op" id="5371173">(</span><span class="op" id="5371174">(</span><span class="ident" id="5371175">dg</span><span class="op" id="5371177">*</span><span class="ident" id="5371178">a</span><span class="op" id="5371179">/</span><span class="ident" id="5371180">m</span>&nbsp;<span class="op" id="5371182">+</span>&nbsp;<span class="ident" id="5371184">sg</span><span class="op" id="5371186">)</span>&nbsp;<span class="op" id="5371188">&gt;&gt;</span>&nbsp;<span class="num" id="5371191">8</span><span class="op" id="5371192">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371197">dst</span><span class="op" id="5371200">.</span><span class="ident" id="5371201">Pix</span><span class="op" id="5371204">[</span><span class="ident" id="5371205">i</span><span class="op" id="5371206">+</span><span class="num" id="5371207">2</span><span class="op" id="5371208">]</span>&nbsp;<span class="op" id="5371210">=</span>&nbsp;<span class="builtintype" id="5371212">uint8</span><span class="op" id="5371217">(</span><span class="op" id="5371218">(</span><span class="ident" id="5371219">db</span><span class="op" id="5371221">*</span><span class="ident" id="5371222">a</span><span class="op" id="5371223">/</span><span class="ident" id="5371224">m</span>&nbsp;<span class="op" id="5371226">+</span>&nbsp;<span class="ident" id="5371228">sb</span><span class="op" id="5371230">)</span>&nbsp;<span class="op" id="5371232">&gt;&gt;</span>&nbsp;<span class="num" id="5371235">8</span><span class="op" id="5371236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371241">dst</span><span class="op" id="5371244">.</span><span class="ident" id="5371245">Pix</span><span class="op" id="5371248">[</span><span class="ident" id="5371249">i</span><span class="op" id="5371250">+</span><span class="num" id="5371251">3</span><span class="op" id="5371252">]</span>&nbsp;<span class="op" id="5371254">=</span>&nbsp;<span class="builtintype" id="5371256">uint8</span><span class="op" id="5371261">(</span><span class="op" id="5371262">(</span><span class="ident" id="5371263">da</span><span class="op" id="5371265">*</span><span class="ident" id="5371266">a</span><span class="op" id="5371267">/</span><span class="ident" id="5371268">m</span>&nbsp;<span class="op" id="5371270">+</span>&nbsp;<span class="ident" id="5371272">sa</span><span class="op" id="5371274">)</span>&nbsp;<span class="op" id="5371276">&gt;&gt;</span>&nbsp;<span class="num" id="5371279">8</span><span class="op" id="5371280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371284">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371288">i0</span>&nbsp;<span class="op" id="5371291">+=</span>&nbsp;<span class="ident" id="5371294">dst</span><span class="op" id="5371297">.</span><span class="ident" id="5371298">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371307">i1</span>&nbsp;<span class="op" id="5371310">+=</span>&nbsp;<span class="ident" id="5371313">dst</span><span class="op" id="5371316">.</span><span class="ident" id="5371317">Stride</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371325">}</span><br>
<span class="lineno"></span><span class="op" id="5371327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5371330">func</span>&nbsp;<span class="ident" id="5371335">drawFillSrc</span><span class="op" id="5371346">(</span><span class="ident" id="5371347">dst</span>&nbsp;<span class="op" id="5371351">*</span><span class="ident" id="5371352">image</span><span class="op" id="5371357">.</span><span class="ident" id="5371358">RGBA</span><span class="op" id="5371362">,</span>&nbsp;<span class="ident" id="5371364">r</span>&nbsp;<span class="ident" id="5371366">image</span><span class="op" id="5371371">.</span><span class="ident" id="5371372">Rectangle</span><span class="op" id="5371381">,</span>&nbsp;<span class="ident" id="5371383">src</span>&nbsp;<span class="op" id="5371387">*</span><span class="ident" id="5371388">image</span><span class="op" id="5371393">.</span><span class="ident" id="5371394">Uniform</span><span class="op" id="5371401">)</span>&nbsp;<span class="op" id="5371403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371406">sr</span><span class="op" id="5371408">,</span>&nbsp;<span class="ident" id="5371410">sg</span><span class="op" id="5371412">,</span>&nbsp;<span class="ident" id="5371414">sb</span><span class="op" id="5371416">,</span>&nbsp;<span class="ident" id="5371418">sa</span>&nbsp;<span class="op" id="5371421">:=</span>&nbsp;<span class="ident" id="5371424">src</span><span class="op" id="5371427">.</span><span class="ident" id="5371428">RGBA</span><span class="op" id="5371432">(</span><span class="op" id="5371433">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371436">//&nbsp;The&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;is&nbsp;faster&nbsp;than&nbsp;a&nbsp;straightforward&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;destination&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371538">//&nbsp;the&nbsp;color,&nbsp;but&nbsp;copy&nbsp;requires&nbsp;a&nbsp;slice&nbsp;source.&nbsp;We&nbsp;therefore&nbsp;use&nbsp;a&nbsp;for&nbsp;loop&nbsp;to&nbsp;fill&nbsp;the&nbsp;first&nbsp;row,&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5371642">//&nbsp;then&nbsp;use&nbsp;the&nbsp;first&nbsp;row&nbsp;as&nbsp;the&nbsp;slice&nbsp;source&nbsp;for&nbsp;the&nbsp;remaining&nbsp;rows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371713">i0</span>&nbsp;<span class="op" id="5371716">:=</span>&nbsp;<span class="ident" id="5371719">dst</span><span class="op" id="5371722">.</span><span class="ident" id="5371723">PixOffset</span><span class="op" id="5371732">(</span><span class="ident" id="5371733">r</span><span class="op" id="5371734">.</span><span class="ident" id="5371735">Min</span><span class="op" id="5371738">.</span><span class="ident" id="5371739">X</span><span class="op" id="5371740">,</span>&nbsp;<span class="ident" id="5371742">r</span><span class="op" id="5371743">.</span><span class="ident" id="5371744">Min</span><span class="op" id="5371747">.</span><span class="ident" id="5371748">Y</span><span class="op" id="5371749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371752">i1</span>&nbsp;<span class="op" id="5371755">:=</span>&nbsp;<span class="ident" id="5371758">i0</span>&nbsp;<span class="op" id="5371761">+</span>&nbsp;<span class="ident" id="5371763">r</span><span class="op" id="5371764">.</span><span class="ident" id="5371765">Dx</span><span class="op" id="5371767">(</span><span class="op" id="5371768">)</span><span class="op" id="5371769">*</span><span class="num" id="5371770">4</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371773">for</span>&nbsp;<span class="ident" id="5371777">i</span>&nbsp;<span class="op" id="5371779">:=</span>&nbsp;<span class="ident" id="5371782">i0</span><span class="op" id="5371784">;</span>&nbsp;<span class="ident" id="5371786">i</span>&nbsp;<span class="op" id="5371788">&lt;</span>&nbsp;<span class="ident" id="5371790">i1</span><span class="op" id="5371792">;</span>&nbsp;<span class="ident" id="5371794">i</span>&nbsp;<span class="op" id="5371796">+=</span>&nbsp;<span class="num" id="5371799">4</span>&nbsp;<span class="op" id="5371801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371805">dst</span><span class="op" id="5371808">.</span><span class="ident" id="5371809">Pix</span><span class="op" id="5371812">[</span><span class="ident" id="5371813">i</span><span class="op" id="5371814">+</span><span class="num" id="5371815">0</span><span class="op" id="5371816">]</span>&nbsp;<span class="op" id="5371818">=</span>&nbsp;<span class="builtintype" id="5371820">uint8</span><span class="op" id="5371825">(</span><span class="ident" id="5371826">sr</span>&nbsp;<span class="op" id="5371829">&gt;&gt;</span>&nbsp;<span class="num" id="5371832">8</span><span class="op" id="5371833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371837">dst</span><span class="op" id="5371840">.</span><span class="ident" id="5371841">Pix</span><span class="op" id="5371844">[</span><span class="ident" id="5371845">i</span><span class="op" id="5371846">+</span><span class="num" id="5371847">1</span><span class="op" id="5371848">]</span>&nbsp;<span class="op" id="5371850">=</span>&nbsp;<span class="builtintype" id="5371852">uint8</span><span class="op" id="5371857">(</span><span class="ident" id="5371858">sg</span>&nbsp;<span class="op" id="5371861">&gt;&gt;</span>&nbsp;<span class="num" id="5371864">8</span><span class="op" id="5371865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371869">dst</span><span class="op" id="5371872">.</span><span class="ident" id="5371873">Pix</span><span class="op" id="5371876">[</span><span class="ident" id="5371877">i</span><span class="op" id="5371878">+</span><span class="num" id="5371879">2</span><span class="op" id="5371880">]</span>&nbsp;<span class="op" id="5371882">=</span>&nbsp;<span class="builtintype" id="5371884">uint8</span><span class="op" id="5371889">(</span><span class="ident" id="5371890">sb</span>&nbsp;<span class="op" id="5371893">&gt;&gt;</span>&nbsp;<span class="num" id="5371896">8</span><span class="op" id="5371897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371901">dst</span><span class="op" id="5371904">.</span><span class="ident" id="5371905">Pix</span><span class="op" id="5371908">[</span><span class="ident" id="5371909">i</span><span class="op" id="5371910">+</span><span class="num" id="5371911">3</span><span class="op" id="5371912">]</span>&nbsp;<span class="op" id="5371914">=</span>&nbsp;<span class="builtintype" id="5371916">uint8</span><span class="op" id="5371921">(</span><span class="ident" id="5371922">sa</span>&nbsp;<span class="op" id="5371925">&gt;&gt;</span>&nbsp;<span class="num" id="5371928">8</span><span class="op" id="5371929">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5371932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5371935">firstRow</span>&nbsp;<span class="op" id="5371944">:=</span>&nbsp;<span class="ident" id="5371947">dst</span><span class="op" id="5371950">.</span><span class="ident" id="5371951">Pix</span><span class="op" id="5371954">[</span><span class="ident" id="5371955">i0</span><span class="op" id="5371957">:</span><span class="ident" id="5371958">i1</span><span class="op" id="5371960">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5371963">for</span>&nbsp;<span class="ident" id="5371967">y</span>&nbsp;<span class="op" id="5371969">:=</span>&nbsp;<span class="ident" id="5371972">r</span><span class="op" id="5371973">.</span><span class="ident" id="5371974">Min</span><span class="op" id="5371977">.</span><span class="ident" id="5371978">Y</span>&nbsp;<span class="op" id="5371980">+</span>&nbsp;<span class="num" id="5371982">1</span><span class="op" id="5371983">;</span>&nbsp;<span class="ident" id="5371985">y</span>&nbsp;<span class="op" id="5371987">&lt;</span>&nbsp;<span class="ident" id="5371989">r</span><span class="op" id="5371990">.</span><span class="ident" id="5371991">Max</span><span class="op" id="5371994">.</span><span class="ident" id="5371995">Y</span><span class="op" id="5371996">;</span>&nbsp;<span class="ident" id="5371998">y</span><span class="op" id="5371999">++</span>&nbsp;<span class="op" id="5372002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372006">i0</span>&nbsp;<span class="op" id="5372009">+=</span>&nbsp;<span class="ident" id="5372012">dst</span><span class="op" id="5372015">.</span><span class="ident" id="5372016">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372025">i1</span>&nbsp;<span class="op" id="5372028">+=</span>&nbsp;<span class="ident" id="5372031">dst</span><span class="op" id="5372034">.</span><span class="ident" id="5372035">Stride</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5372044">copy</span><span class="op" id="5372048">(</span><span class="ident" id="5372049">dst</span><span class="op" id="5372052">.</span><span class="ident" id="5372053">Pix</span><span class="op" id="5372056">[</span><span class="ident" id="5372057">i0</span><span class="op" id="5372059">:</span><span class="ident" id="5372060">i1</span><span class="op" id="5372062">]</span><span class="op" id="5372063">,</span>&nbsp;<span class="ident" id="5372065">firstRow</span><span class="op" id="5372073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372076">}</span><br>
<span class="lineno"></span><span class="op" id="5372078">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5372081">func</span>&nbsp;<span class="ident" id="5372086">drawCopyOver</span><span class="op" id="5372098">(</span><span class="ident" id="5372099">dst</span>&nbsp;<span class="op" id="5372103">*</span><span class="ident" id="5372104">image</span><span class="op" id="5372109">.</span><span class="ident" id="5372110">RGBA</span><span class="op" id="5372114">,</span>&nbsp;<span class="ident" id="5372116">r</span>&nbsp;<span class="ident" id="5372118">image</span><span class="op" id="5372123">.</span><span class="ident" id="5372124">Rectangle</span><span class="op" id="5372133">,</span>&nbsp;<span class="ident" id="5372135">src</span>&nbsp;<span class="op" id="5372139">*</span><span class="ident" id="5372140">image</span><span class="op" id="5372145">.</span><span class="ident" id="5372146">RGBA</span><span class="op" id="5372150">,</span>&nbsp;<span class="ident" id="5372152">sp</span>&nbsp;<span class="ident" id="5372155">image</span><span class="op" id="5372160">.</span><span class="ident" id="5372161">Point</span><span class="op" id="5372166">)</span>&nbsp;<span class="op" id="5372168">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372171">dx</span><span class="op" id="5372173">,</span>&nbsp;<span class="ident" id="5372175">dy</span>&nbsp;<span class="op" id="5372178">:=</span>&nbsp;<span class="ident" id="5372181">r</span><span class="op" id="5372182">.</span><span class="ident" id="5372183">Dx</span><span class="op" id="5372185">(</span><span class="op" id="5372186">)</span><span class="op" id="5372187">,</span>&nbsp;<span class="ident" id="5372189">r</span><span class="op" id="5372190">.</span><span class="ident" id="5372191">Dy</span><span class="op" id="5372193">(</span><span class="op" id="5372194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372197">d0</span>&nbsp;<span class="op" id="5372200">:=</span>&nbsp;<span class="ident" id="5372203">dst</span><span class="op" id="5372206">.</span><span class="ident" id="5372207">PixOffset</span><span class="op" id="5372216">(</span><span class="ident" id="5372217">r</span><span class="op" id="5372218">.</span><span class="ident" id="5372219">Min</span><span class="op" id="5372222">.</span><span class="ident" id="5372223">X</span><span class="op" id="5372224">,</span>&nbsp;<span class="ident" id="5372226">r</span><span class="op" id="5372227">.</span><span class="ident" id="5372228">Min</span><span class="op" id="5372231">.</span><span class="ident" id="5372232">Y</span><span class="op" id="5372233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372236">s0</span>&nbsp;<span class="op" id="5372239">:=</span>&nbsp;<span class="ident" id="5372242">src</span><span class="op" id="5372245">.</span><span class="ident" id="5372246">PixOffset</span><span class="op" id="5372255">(</span><span class="ident" id="5372256">sp</span><span class="op" id="5372258">.</span><span class="ident" id="5372259">X</span><span class="op" id="5372260">,</span>&nbsp;<span class="ident" id="5372262">sp</span><span class="op" id="5372264">.</span><span class="ident" id="5372265">Y</span><span class="op" id="5372266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372269">var</span>&nbsp;<span class="op" id="5372273">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372277">ddelta</span><span class="op" id="5372283">,</span>&nbsp;<span class="ident" id="5372285">sdelta</span>&nbsp;<span class="builtintype" id="5372292">int</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372298">i0</span><span class="op" id="5372300">,</span>&nbsp;<span class="ident" id="5372302">i1</span><span class="op" id="5372304">,</span>&nbsp;<span class="ident" id="5372306">idelta</span>&nbsp;<span class="builtintype" id="5372313">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372321">if</span>&nbsp;<span class="ident" id="5372324">r</span><span class="op" id="5372325">.</span><span class="ident" id="5372326">Min</span><span class="op" id="5372329">.</span><span class="ident" id="5372330">Y</span>&nbsp;<span class="op" id="5372332">&lt;</span>&nbsp;<span class="ident" id="5372334">sp</span><span class="op" id="5372336">.</span><span class="ident" id="5372337">Y</span>&nbsp;<span class="op" id="5372339">||</span>&nbsp;<span class="ident" id="5372342">r</span><span class="op" id="5372343">.</span><span class="ident" id="5372344">Min</span><span class="op" id="5372347">.</span><span class="ident" id="5372348">Y</span>&nbsp;<span class="op" id="5372350">==</span>&nbsp;<span class="ident" id="5372353">sp</span><span class="op" id="5372355">.</span><span class="ident" id="5372356">Y</span>&nbsp;<span class="op" id="5372358">&amp;&amp;</span>&nbsp;<span class="ident" id="5372361">r</span><span class="op" id="5372362">.</span><span class="ident" id="5372363">Min</span><span class="op" id="5372366">.</span><span class="ident" id="5372367">X</span>&nbsp;<span class="op" id="5372369">&lt;=</span>&nbsp;<span class="ident" id="5372372">sp</span><span class="op" id="5372374">.</span><span class="ident" id="5372375">X</span>&nbsp;<span class="op" id="5372377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372381">ddelta</span>&nbsp;<span class="op" id="5372388">=</span>&nbsp;<span class="ident" id="5372390">dst</span><span class="op" id="5372393">.</span><span class="ident" id="5372394">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372403">sdelta</span>&nbsp;<span class="op" id="5372410">=</span>&nbsp;<span class="ident" id="5372412">src</span><span class="op" id="5372415">.</span><span class="ident" id="5372416">Stride</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372425">i0</span><span class="op" id="5372427">,</span>&nbsp;<span class="ident" id="5372429">i1</span><span class="op" id="5372431">,</span>&nbsp;<span class="ident" id="5372433">idelta</span>&nbsp;<span class="op" id="5372440">=</span>&nbsp;<span class="num" id="5372442">0</span><span class="op" id="5372443">,</span>&nbsp;<span class="ident" id="5372445">dx</span><span class="op" id="5372447">*</span><span class="num" id="5372448">4</span><span class="op" id="5372449">,</span>&nbsp;<span class="op" id="5372451">+</span><span class="num" id="5372452">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372455">}</span>&nbsp;<span class="keyword" id="5372457">else</span>&nbsp;<span class="op" id="5372462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372466">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;or&nbsp;equal&nbsp;height&nbsp;but&nbsp;to&nbsp;the&nbsp;left,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5372574">//&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows&nbsp;in&nbsp;right-to-left,&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;left-to-right,&nbsp;top-down.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372674">d0</span>&nbsp;<span class="op" id="5372677">+=</span>&nbsp;<span class="op" id="5372680">(</span><span class="ident" id="5372681">dy</span>&nbsp;<span class="op" id="5372684">-</span>&nbsp;<span class="num" id="5372686">1</span><span class="op" id="5372687">)</span>&nbsp;<span class="op" id="5372689">*</span>&nbsp;<span class="ident" id="5372691">dst</span><span class="op" id="5372694">.</span><span class="ident" id="5372695">Stride</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372704">s0</span>&nbsp;<span class="op" id="5372707">+=</span>&nbsp;<span class="op" id="5372710">(</span><span class="ident" id="5372711">dy</span>&nbsp;<span class="op" id="5372714">-</span>&nbsp;<span class="num" id="5372716">1</span><span class="op" id="5372717">)</span>&nbsp;<span class="op" id="5372719">*</span>&nbsp;<span class="ident" id="5372721">src</span><span class="op" id="5372724">.</span><span class="ident" id="5372725">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372734">ddelta</span>&nbsp;<span class="op" id="5372741">=</span>&nbsp;<span class="op" id="5372743">-</span><span class="ident" id="5372744">dst</span><span class="op" id="5372747">.</span><span class="ident" id="5372748">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372757">sdelta</span>&nbsp;<span class="op" id="5372764">=</span>&nbsp;<span class="op" id="5372766">-</span><span class="ident" id="5372767">src</span><span class="op" id="5372770">.</span><span class="ident" id="5372771">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372780">i0</span><span class="op" id="5372782">,</span>&nbsp;<span class="ident" id="5372784">i1</span><span class="op" id="5372786">,</span>&nbsp;<span class="ident" id="5372788">idelta</span>&nbsp;<span class="op" id="5372795">=</span>&nbsp;<span class="op" id="5372797">(</span><span class="ident" id="5372798">dx</span><span class="op" id="5372800">-</span><span class="num" id="5372801">1</span><span class="op" id="5372802">)</span><span class="op" id="5372803">*</span><span class="num" id="5372804">4</span><span class="op" id="5372805">,</span>&nbsp;<span class="op" id="5372807">-</span><span class="num" id="5372808">4</span><span class="op" id="5372809">,</span>&nbsp;<span class="op" id="5372811">-</span><span class="num" id="5372812">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5372815">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372818">for</span>&nbsp;<span class="op" id="5372822">;</span>&nbsp;<span class="ident" id="5372824">dy</span>&nbsp;<span class="op" id="5372827">&gt;</span>&nbsp;<span class="num" id="5372829">0</span><span class="op" id="5372830">;</span>&nbsp;<span class="ident" id="5372832">dy</span><span class="op" id="5372834">--</span>&nbsp;<span class="op" id="5372837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372841">dpix</span>&nbsp;<span class="op" id="5372846">:=</span>&nbsp;<span class="ident" id="5372849">dst</span><span class="op" id="5372852">.</span><span class="ident" id="5372853">Pix</span><span class="op" id="5372856">[</span><span class="ident" id="5372857">d0</span><span class="op" id="5372859">:</span><span class="op" id="5372860">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372864">spix</span>&nbsp;<span class="op" id="5372869">:=</span>&nbsp;<span class="ident" id="5372872">src</span><span class="op" id="5372875">.</span><span class="ident" id="5372876">Pix</span><span class="op" id="5372879">[</span><span class="ident" id="5372880">s0</span><span class="op" id="5372882">:</span><span class="op" id="5372883">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5372887">for</span>&nbsp;<span class="ident" id="5372891">i</span>&nbsp;<span class="op" id="5372893">:=</span>&nbsp;<span class="ident" id="5372896">i0</span><span class="op" id="5372898">;</span>&nbsp;<span class="ident" id="5372900">i</span>&nbsp;<span class="op" id="5372902">!=</span>&nbsp;<span class="ident" id="5372905">i1</span><span class="op" id="5372907">;</span>&nbsp;<span class="ident" id="5372909">i</span>&nbsp;<span class="op" id="5372911">+=</span>&nbsp;<span class="ident" id="5372914">idelta</span>&nbsp;<span class="op" id="5372921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372926">sr</span>&nbsp;<span class="op" id="5372929">:=</span>&nbsp;<span class="builtintype" id="5372932">uint32</span><span class="op" id="5372938">(</span><span class="ident" id="5372939">spix</span><span class="op" id="5372943">[</span><span class="ident" id="5372944">i</span><span class="op" id="5372945">+</span><span class="num" id="5372946">0</span><span class="op" id="5372947">]</span><span class="op" id="5372948">)</span>&nbsp;<span class="op" id="5372950">*</span>&nbsp;<span class="num" id="5372952">0x101</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372961">sg</span>&nbsp;<span class="op" id="5372964">:=</span>&nbsp;<span class="builtintype" id="5372967">uint32</span><span class="op" id="5372973">(</span><span class="ident" id="5372974">spix</span><span class="op" id="5372978">[</span><span class="ident" id="5372979">i</span><span class="op" id="5372980">+</span><span class="num" id="5372981">1</span><span class="op" id="5372982">]</span><span class="op" id="5372983">)</span>&nbsp;<span class="op" id="5372985">*</span>&nbsp;<span class="num" id="5372987">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5372996">sb</span>&nbsp;<span class="op" id="5372999">:=</span>&nbsp;<span class="builtintype" id="5373002">uint32</span><span class="op" id="5373008">(</span><span class="ident" id="5373009">spix</span><span class="op" id="5373013">[</span><span class="ident" id="5373014">i</span><span class="op" id="5373015">+</span><span class="num" id="5373016">2</span><span class="op" id="5373017">]</span><span class="op" id="5373018">)</span>&nbsp;<span class="op" id="5373020">*</span>&nbsp;<span class="num" id="5373022">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373031">sa</span>&nbsp;<span class="op" id="5373034">:=</span>&nbsp;<span class="builtintype" id="5373037">uint32</span><span class="op" id="5373043">(</span><span class="ident" id="5373044">spix</span><span class="op" id="5373048">[</span><span class="ident" id="5373049">i</span><span class="op" id="5373050">+</span><span class="num" id="5373051">3</span><span class="op" id="5373052">]</span><span class="op" id="5373053">)</span>&nbsp;<span class="op" id="5373055">*</span>&nbsp;<span class="num" id="5373057">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373067">dr</span>&nbsp;<span class="op" id="5373070">:=</span>&nbsp;<span class="builtintype" id="5373073">uint32</span><span class="op" id="5373079">(</span><span class="ident" id="5373080">dpix</span><span class="op" id="5373084">[</span><span class="ident" id="5373085">i</span><span class="op" id="5373086">+</span><span class="num" id="5373087">0</span><span class="op" id="5373088">]</span><span class="op" id="5373089">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373094">dg</span>&nbsp;<span class="op" id="5373097">:=</span>&nbsp;<span class="builtintype" id="5373100">uint32</span><span class="op" id="5373106">(</span><span class="ident" id="5373107">dpix</span><span class="op" id="5373111">[</span><span class="ident" id="5373112">i</span><span class="op" id="5373113">+</span><span class="num" id="5373114">1</span><span class="op" id="5373115">]</span><span class="op" id="5373116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373121">db</span>&nbsp;<span class="op" id="5373124">:=</span>&nbsp;<span class="builtintype" id="5373127">uint32</span><span class="op" id="5373133">(</span><span class="ident" id="5373134">dpix</span><span class="op" id="5373138">[</span><span class="ident" id="5373139">i</span><span class="op" id="5373140">+</span><span class="num" id="5373141">2</span><span class="op" id="5373142">]</span><span class="op" id="5373143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373148">da</span>&nbsp;<span class="op" id="5373151">:=</span>&nbsp;<span class="builtintype" id="5373154">uint32</span><span class="op" id="5373160">(</span><span class="ident" id="5373161">dpix</span><span class="op" id="5373165">[</span><span class="ident" id="5373166">i</span><span class="op" id="5373167">+</span><span class="num" id="5373168">3</span><span class="op" id="5373169">]</span><span class="op" id="5373170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373176">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373236">a</span>&nbsp;<span class="op" id="5373238">:=</span>&nbsp;<span class="op" id="5373241">(</span><span class="ident" id="5373242">m</span>&nbsp;<span class="op" id="5373244">-</span>&nbsp;<span class="ident" id="5373246">sa</span><span class="op" id="5373248">)</span>&nbsp;<span class="op" id="5373250">*</span>&nbsp;<span class="num" id="5373252">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373262">dpix</span><span class="op" id="5373266">[</span><span class="ident" id="5373267">i</span><span class="op" id="5373268">+</span><span class="num" id="5373269">0</span><span class="op" id="5373270">]</span>&nbsp;<span class="op" id="5373272">=</span>&nbsp;<span class="builtintype" id="5373274">uint8</span><span class="op" id="5373279">(</span><span class="op" id="5373280">(</span><span class="ident" id="5373281">dr</span><span class="op" id="5373283">*</span><span class="ident" id="5373284">a</span><span class="op" id="5373285">/</span><span class="ident" id="5373286">m</span>&nbsp;<span class="op" id="5373288">+</span>&nbsp;<span class="ident" id="5373290">sr</span><span class="op" id="5373292">)</span>&nbsp;<span class="op" id="5373294">&gt;&gt;</span>&nbsp;<span class="num" id="5373297">8</span><span class="op" id="5373298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373303">dpix</span><span class="op" id="5373307">[</span><span class="ident" id="5373308">i</span><span class="op" id="5373309">+</span><span class="num" id="5373310">1</span><span class="op" id="5373311">]</span>&nbsp;<span class="op" id="5373313">=</span>&nbsp;<span class="builtintype" id="5373315">uint8</span><span class="op" id="5373320">(</span><span class="op" id="5373321">(</span><span class="ident" id="5373322">dg</span><span class="op" id="5373324">*</span><span class="ident" id="5373325">a</span><span class="op" id="5373326">/</span><span class="ident" id="5373327">m</span>&nbsp;<span class="op" id="5373329">+</span>&nbsp;<span class="ident" id="5373331">sg</span><span class="op" id="5373333">)</span>&nbsp;<span class="op" id="5373335">&gt;&gt;</span>&nbsp;<span class="num" id="5373338">8</span><span class="op" id="5373339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373344">dpix</span><span class="op" id="5373348">[</span><span class="ident" id="5373349">i</span><span class="op" id="5373350">+</span><span class="num" id="5373351">2</span><span class="op" id="5373352">]</span>&nbsp;<span class="op" id="5373354">=</span>&nbsp;<span class="builtintype" id="5373356">uint8</span><span class="op" id="5373361">(</span><span class="op" id="5373362">(</span><span class="ident" id="5373363">db</span><span class="op" id="5373365">*</span><span class="ident" id="5373366">a</span><span class="op" id="5373367">/</span><span class="ident" id="5373368">m</span>&nbsp;<span class="op" id="5373370">+</span>&nbsp;<span class="ident" id="5373372">sb</span><span class="op" id="5373374">)</span>&nbsp;<span class="op" id="5373376">&gt;&gt;</span>&nbsp;<span class="num" id="5373379">8</span><span class="op" id="5373380">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373385">dpix</span><span class="op" id="5373389">[</span><span class="ident" id="5373390">i</span><span class="op" id="5373391">+</span><span class="num" id="5373392">3</span><span class="op" id="5373393">]</span>&nbsp;<span class="op" id="5373395">=</span>&nbsp;<span class="builtintype" id="5373397">uint8</span><span class="op" id="5373402">(</span><span class="op" id="5373403">(</span><span class="ident" id="5373404">da</span><span class="op" id="5373406">*</span><span class="ident" id="5373407">a</span><span class="op" id="5373408">/</span><span class="ident" id="5373409">m</span>&nbsp;<span class="op" id="5373411">+</span>&nbsp;<span class="ident" id="5373413">sa</span><span class="op" id="5373415">)</span>&nbsp;<span class="op" id="5373417">&gt;&gt;</span>&nbsp;<span class="num" id="5373420">8</span><span class="op" id="5373421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373429">d0</span>&nbsp;<span class="op" id="5373432">+=</span>&nbsp;<span class="ident" id="5373435">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373444">s0</span>&nbsp;<span class="op" id="5373447">+=</span>&nbsp;<span class="ident" id="5373450">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373458">}</span><br>
<span class="lineno">305</span><span class="op" id="5373460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5373463">func</span>&nbsp;<span class="ident" id="5373468">drawCopySrc</span><span class="op" id="5373479">(</span><span class="ident" id="5373480">dst</span>&nbsp;<span class="op" id="5373484">*</span><span class="ident" id="5373485">image</span><span class="op" id="5373490">.</span><span class="ident" id="5373491">RGBA</span><span class="op" id="5373495">,</span>&nbsp;<span class="ident" id="5373497">r</span>&nbsp;<span class="ident" id="5373499">image</span><span class="op" id="5373504">.</span><span class="ident" id="5373505">Rectangle</span><span class="op" id="5373514">,</span>&nbsp;<span class="ident" id="5373516">src</span>&nbsp;<span class="op" id="5373520">*</span><span class="ident" id="5373521">image</span><span class="op" id="5373526">.</span><span class="ident" id="5373527">RGBA</span><span class="op" id="5373531">,</span>&nbsp;<span class="ident" id="5373533">sp</span>&nbsp;<span class="ident" id="5373536">image</span><span class="op" id="5373541">.</span><span class="ident" id="5373542">Point</span><span class="op" id="5373547">)</span>&nbsp;<span class="op" id="5373549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373552">n</span><span class="op" id="5373553">,</span>&nbsp;<span class="ident" id="5373555">dy</span>&nbsp;<span class="op" id="5373558">:=</span>&nbsp;<span class="num" id="5373561">4</span><span class="op" id="5373562">*</span><span class="ident" id="5373563">r</span><span class="op" id="5373564">.</span><span class="ident" id="5373565">Dx</span><span class="op" id="5373567">(</span><span class="op" id="5373568">)</span><span class="op" id="5373569">,</span>&nbsp;<span class="ident" id="5373571">r</span><span class="op" id="5373572">.</span><span class="ident" id="5373573">Dy</span><span class="op" id="5373575">(</span><span class="op" id="5373576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373579">d0</span>&nbsp;<span class="op" id="5373582">:=</span>&nbsp;<span class="ident" id="5373585">dst</span><span class="op" id="5373588">.</span><span class="ident" id="5373589">PixOffset</span><span class="op" id="5373598">(</span><span class="ident" id="5373599">r</span><span class="op" id="5373600">.</span><span class="ident" id="5373601">Min</span><span class="op" id="5373604">.</span><span class="ident" id="5373605">X</span><span class="op" id="5373606">,</span>&nbsp;<span class="ident" id="5373608">r</span><span class="op" id="5373609">.</span><span class="ident" id="5373610">Min</span><span class="op" id="5373613">.</span><span class="ident" id="5373614">Y</span><span class="op" id="5373615">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373618">s0</span>&nbsp;<span class="op" id="5373621">:=</span>&nbsp;<span class="ident" id="5373624">src</span><span class="op" id="5373627">.</span><span class="ident" id="5373628">PixOffset</span><span class="op" id="5373637">(</span><span class="ident" id="5373638">sp</span><span class="op" id="5373640">.</span><span class="ident" id="5373641">X</span><span class="op" id="5373642">,</span>&nbsp;<span class="ident" id="5373644">sp</span><span class="op" id="5373646">.</span><span class="ident" id="5373647">Y</span><span class="op" id="5373648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373651">var</span>&nbsp;<span class="ident" id="5373655">ddelta</span><span class="op" id="5373661">,</span>&nbsp;<span class="ident" id="5373663">sdelta</span>&nbsp;<span class="builtintype" id="5373670">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5373675">if</span>&nbsp;<span class="ident" id="5373678">r</span><span class="op" id="5373679">.</span><span class="ident" id="5373680">Min</span><span class="op" id="5373683">.</span><span class="ident" id="5373684">Y</span>&nbsp;<span class="op" id="5373686">&lt;=</span>&nbsp;<span class="ident" id="5373689">sp</span><span class="op" id="5373691">.</span><span class="ident" id="5373692">Y</span>&nbsp;<span class="op" id="5373694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373698">ddelta</span>&nbsp;<span class="op" id="5373705">=</span>&nbsp;<span class="ident" id="5373707">dst</span><span class="op" id="5373710">.</span><span class="ident" id="5373711">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5373720">sdelta</span>&nbsp;<span class="op" id="5373727">=</span>&nbsp;<span class="ident" id="5373729">src</span><span class="op" id="5373732">.</span><span class="ident" id="5373733">Stride</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5373741">}</span>&nbsp;<span class="keyword" id="5373743">else</span>&nbsp;<span class="op" id="5373748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373752">//&nbsp;If&nbsp;the&nbsp;source&nbsp;start&nbsp;point&nbsp;is&nbsp;higher&nbsp;than&nbsp;the&nbsp;destination&nbsp;start&nbsp;point,&nbsp;then&nbsp;we&nbsp;compose&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373852">//&nbsp;in&nbsp;bottom-up&nbsp;order&nbsp;instead&nbsp;of&nbsp;top-down.&nbsp;Unlike&nbsp;the&nbsp;drawCopyOver&nbsp;function,&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5373948">//&nbsp;check&nbsp;the&nbsp;x&nbsp;co-ordinates&nbsp;because&nbsp;the&nbsp;built-in&nbsp;copy&nbsp;function&nbsp;can&nbsp;handle&nbsp;overlapping&nbsp;slices.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374044">d0</span>&nbsp;<span class="op" id="5374047">+=</span>&nbsp;<span class="op" id="5374050">(</span><span class="ident" id="5374051">dy</span>&nbsp;<span class="op" id="5374054">-</span>&nbsp;<span class="num" id="5374056">1</span><span class="op" id="5374057">)</span>&nbsp;<span class="op" id="5374059">*</span>&nbsp;<span class="ident" id="5374061">dst</span><span class="op" id="5374064">.</span><span class="ident" id="5374065">Stride</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374074">s0</span>&nbsp;<span class="op" id="5374077">+=</span>&nbsp;<span class="op" id="5374080">(</span><span class="ident" id="5374081">dy</span>&nbsp;<span class="op" id="5374084">-</span>&nbsp;<span class="num" id="5374086">1</span><span class="op" id="5374087">)</span>&nbsp;<span class="op" id="5374089">*</span>&nbsp;<span class="ident" id="5374091">src</span><span class="op" id="5374094">.</span><span class="ident" id="5374095">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374104">ddelta</span>&nbsp;<span class="op" id="5374111">=</span>&nbsp;<span class="op" id="5374113">-</span><span class="ident" id="5374114">dst</span><span class="op" id="5374117">.</span><span class="ident" id="5374118">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374127">sdelta</span>&nbsp;<span class="op" id="5374134">=</span>&nbsp;<span class="op" id="5374136">-</span><span class="ident" id="5374137">src</span><span class="op" id="5374140">.</span><span class="ident" id="5374141">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374152">for</span>&nbsp;<span class="op" id="5374156">;</span>&nbsp;<span class="ident" id="5374158">dy</span>&nbsp;<span class="op" id="5374161">&gt;</span>&nbsp;<span class="num" id="5374163">0</span><span class="op" id="5374164">;</span>&nbsp;<span class="ident" id="5374166">dy</span><span class="op" id="5374168">--</span>&nbsp;<span class="op" id="5374171">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5374175">copy</span><span class="op" id="5374179">(</span><span class="ident" id="5374180">dst</span><span class="op" id="5374183">.</span><span class="ident" id="5374184">Pix</span><span class="op" id="5374187">[</span><span class="ident" id="5374188">d0</span><span class="op" id="5374190">:</span><span class="ident" id="5374191">d0</span><span class="op" id="5374193">+</span><span class="ident" id="5374194">n</span><span class="op" id="5374195">]</span><span class="op" id="5374196">,</span>&nbsp;<span class="ident" id="5374198">src</span><span class="op" id="5374201">.</span><span class="ident" id="5374202">Pix</span><span class="op" id="5374205">[</span><span class="ident" id="5374206">s0</span><span class="op" id="5374208">:</span><span class="ident" id="5374209">s0</span><span class="op" id="5374211">+</span><span class="ident" id="5374212">n</span><span class="op" id="5374213">]</span><span class="op" id="5374214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374218">d0</span>&nbsp;<span class="op" id="5374221">+=</span>&nbsp;<span class="ident" id="5374224">ddelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374233">s0</span>&nbsp;<span class="op" id="5374236">+=</span>&nbsp;<span class="ident" id="5374239">sdelta</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5374247">}</span><br>
<span class="lineno"></span><span class="op" id="5374249">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="keyword" id="5374252">func</span>&nbsp;<span class="ident" id="5374257">drawNRGBAOver</span><span class="op" id="5374270">(</span><span class="ident" id="5374271">dst</span>&nbsp;<span class="op" id="5374275">*</span><span class="ident" id="5374276">image</span><span class="op" id="5374281">.</span><span class="ident" id="5374282">RGBA</span><span class="op" id="5374286">,</span>&nbsp;<span class="ident" id="5374288">r</span>&nbsp;<span class="ident" id="5374290">image</span><span class="op" id="5374295">.</span><span class="ident" id="5374296">Rectangle</span><span class="op" id="5374305">,</span>&nbsp;<span class="ident" id="5374307">src</span>&nbsp;<span class="op" id="5374311">*</span><span class="ident" id="5374312">image</span><span class="op" id="5374317">.</span><span class="ident" id="5374318">NRGBA</span><span class="op" id="5374323">,</span>&nbsp;<span class="ident" id="5374325">sp</span>&nbsp;<span class="ident" id="5374328">image</span><span class="op" id="5374333">.</span><span class="ident" id="5374334">Point</span><span class="op" id="5374339">)</span>&nbsp;<span class="op" id="5374341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374344">i0</span>&nbsp;<span class="op" id="5374347">:=</span>&nbsp;<span class="op" id="5374350">(</span><span class="ident" id="5374351">r</span><span class="op" id="5374352">.</span><span class="ident" id="5374353">Min</span><span class="op" id="5374356">.</span><span class="ident" id="5374357">X</span>&nbsp;<span class="op" id="5374359">-</span>&nbsp;<span class="ident" id="5374361">dst</span><span class="op" id="5374364">.</span><span class="ident" id="5374365">Rect</span><span class="op" id="5374369">.</span><span class="ident" id="5374370">Min</span><span class="op" id="5374373">.</span><span class="ident" id="5374374">X</span><span class="op" id="5374375">)</span>&nbsp;<span class="op" id="5374377">*</span>&nbsp;<span class="num" id="5374379">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374382">i1</span>&nbsp;<span class="op" id="5374385">:=</span>&nbsp;<span class="op" id="5374388">(</span><span class="ident" id="5374389">r</span><span class="op" id="5374390">.</span><span class="ident" id="5374391">Max</span><span class="op" id="5374394">.</span><span class="ident" id="5374395">X</span>&nbsp;<span class="op" id="5374397">-</span>&nbsp;<span class="ident" id="5374399">dst</span><span class="op" id="5374402">.</span><span class="ident" id="5374403">Rect</span><span class="op" id="5374407">.</span><span class="ident" id="5374408">Min</span><span class="op" id="5374411">.</span><span class="ident" id="5374412">X</span><span class="op" id="5374413">)</span>&nbsp;<span class="op" id="5374415">*</span>&nbsp;<span class="num" id="5374417">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374420">si0</span>&nbsp;<span class="op" id="5374424">:=</span>&nbsp;<span class="op" id="5374427">(</span><span class="ident" id="5374428">sp</span><span class="op" id="5374430">.</span><span class="ident" id="5374431">X</span>&nbsp;<span class="op" id="5374433">-</span>&nbsp;<span class="ident" id="5374435">src</span><span class="op" id="5374438">.</span><span class="ident" id="5374439">Rect</span><span class="op" id="5374443">.</span><span class="ident" id="5374444">Min</span><span class="op" id="5374447">.</span><span class="ident" id="5374448">X</span><span class="op" id="5374449">)</span>&nbsp;<span class="op" id="5374451">*</span>&nbsp;<span class="num" id="5374453">4</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374456">yMax</span>&nbsp;<span class="op" id="5374461">:=</span>&nbsp;<span class="ident" id="5374464">r</span><span class="op" id="5374465">.</span><span class="ident" id="5374466">Max</span><span class="op" id="5374469">.</span><span class="ident" id="5374470">Y</span>&nbsp;<span class="op" id="5374472">-</span>&nbsp;<span class="ident" id="5374474">dst</span><span class="op" id="5374477">.</span><span class="ident" id="5374478">Rect</span><span class="op" id="5374482">.</span><span class="ident" id="5374483">Min</span><span class="op" id="5374486">.</span><span class="ident" id="5374487">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374491">y</span>&nbsp;<span class="op" id="5374493">:=</span>&nbsp;<span class="ident" id="5374496">r</span><span class="op" id="5374497">.</span><span class="ident" id="5374498">Min</span><span class="op" id="5374501">.</span><span class="ident" id="5374502">Y</span>&nbsp;<span class="op" id="5374504">-</span>&nbsp;<span class="ident" id="5374506">dst</span><span class="op" id="5374509">.</span><span class="ident" id="5374510">Rect</span><span class="op" id="5374514">.</span><span class="ident" id="5374515">Min</span><span class="op" id="5374518">.</span><span class="ident" id="5374519">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374522">sy</span>&nbsp;<span class="op" id="5374525">:=</span>&nbsp;<span class="ident" id="5374528">sp</span><span class="op" id="5374530">.</span><span class="ident" id="5374531">Y</span>&nbsp;<span class="op" id="5374533">-</span>&nbsp;<span class="ident" id="5374535">src</span><span class="op" id="5374538">.</span><span class="ident" id="5374539">Rect</span><span class="op" id="5374543">.</span><span class="ident" id="5374544">Min</span><span class="op" id="5374547">.</span><span class="ident" id="5374548">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374551">for</span>&nbsp;<span class="op" id="5374555">;</span>&nbsp;<span class="ident" id="5374557">y</span>&nbsp;<span class="op" id="5374559">!=</span>&nbsp;<span class="ident" id="5374562">yMax</span><span class="op" id="5374566">;</span>&nbsp;<span class="ident" id="5374568">y</span><span class="op" id="5374569">,</span>&nbsp;<span class="ident" id="5374571">sy</span>&nbsp;<span class="op" id="5374574">=</span>&nbsp;<span class="ident" id="5374576">y</span><span class="op" id="5374577">+</span><span class="num" id="5374578">1</span><span class="op" id="5374579">,</span>&nbsp;<span class="ident" id="5374581">sy</span><span class="op" id="5374583">+</span><span class="num" id="5374584">1</span>&nbsp;<span class="op" id="5374586">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374590">dpix</span>&nbsp;<span class="op" id="5374595">:=</span>&nbsp;<span class="ident" id="5374598">dst</span><span class="op" id="5374601">.</span><span class="ident" id="5374602">Pix</span><span class="op" id="5374605">[</span><span class="ident" id="5374606">y</span><span class="op" id="5374607">*</span><span class="ident" id="5374608">dst</span><span class="op" id="5374611">.</span><span class="ident" id="5374612">Stride</span><span class="op" id="5374618">:</span><span class="op" id="5374619">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374623">spix</span>&nbsp;<span class="op" id="5374628">:=</span>&nbsp;<span class="ident" id="5374631">src</span><span class="op" id="5374634">.</span><span class="ident" id="5374635">Pix</span><span class="op" id="5374638">[</span><span class="ident" id="5374639">sy</span><span class="op" id="5374641">*</span><span class="ident" id="5374642">src</span><span class="op" id="5374645">.</span><span class="ident" id="5374646">Stride</span><span class="op" id="5374652">:</span><span class="op" id="5374653">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5374658">for</span>&nbsp;<span class="ident" id="5374662">i</span><span class="op" id="5374663">,</span>&nbsp;<span class="ident" id="5374665">si</span>&nbsp;<span class="op" id="5374668">:=</span>&nbsp;<span class="ident" id="5374671">i0</span><span class="op" id="5374673">,</span>&nbsp;<span class="ident" id="5374675">si0</span><span class="op" id="5374678">;</span>&nbsp;<span class="ident" id="5374680">i</span>&nbsp;<span class="op" id="5374682">&lt;</span>&nbsp;<span class="ident" id="5374684">i1</span><span class="op" id="5374686">;</span>&nbsp;<span class="ident" id="5374688">i</span><span class="op" id="5374689">,</span>&nbsp;<span class="ident" id="5374691">si</span>&nbsp;<span class="op" id="5374694">=</span>&nbsp;<span class="ident" id="5374696">i</span><span class="op" id="5374697">+</span><span class="num" id="5374698">4</span><span class="op" id="5374699">,</span>&nbsp;<span class="ident" id="5374701">si</span><span class="op" id="5374703">+</span><span class="num" id="5374704">4</span>&nbsp;<span class="op" id="5374706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5374711">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374779">sa</span>&nbsp;<span class="op" id="5374782">:=</span>&nbsp;<span class="builtintype" id="5374785">uint32</span><span class="op" id="5374791">(</span><span class="ident" id="5374792">spix</span><span class="op" id="5374796">[</span><span class="ident" id="5374797">si</span><span class="op" id="5374799">+</span><span class="num" id="5374800">3</span><span class="op" id="5374801">]</span><span class="op" id="5374802">)</span>&nbsp;<span class="op" id="5374804">*</span>&nbsp;<span class="num" id="5374806">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374815">sr</span>&nbsp;<span class="op" id="5374818">:=</span>&nbsp;<span class="builtintype" id="5374821">uint32</span><span class="op" id="5374827">(</span><span class="ident" id="5374828">spix</span><span class="op" id="5374832">[</span><span class="ident" id="5374833">si</span><span class="op" id="5374835">+</span><span class="num" id="5374836">0</span><span class="op" id="5374837">]</span><span class="op" id="5374838">)</span>&nbsp;<span class="op" id="5374840">*</span>&nbsp;<span class="ident" id="5374842">sa</span>&nbsp;<span class="op" id="5374845">/</span>&nbsp;<span class="num" id="5374847">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374855">sg</span>&nbsp;<span class="op" id="5374858">:=</span>&nbsp;<span class="builtintype" id="5374861">uint32</span><span class="op" id="5374867">(</span><span class="ident" id="5374868">spix</span><span class="op" id="5374872">[</span><span class="ident" id="5374873">si</span><span class="op" id="5374875">+</span><span class="num" id="5374876">1</span><span class="op" id="5374877">]</span><span class="op" id="5374878">)</span>&nbsp;<span class="op" id="5374880">*</span>&nbsp;<span class="ident" id="5374882">sa</span>&nbsp;<span class="op" id="5374885">/</span>&nbsp;<span class="num" id="5374887">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374895">sb</span>&nbsp;<span class="op" id="5374898">:=</span>&nbsp;<span class="builtintype" id="5374901">uint32</span><span class="op" id="5374907">(</span><span class="ident" id="5374908">spix</span><span class="op" id="5374912">[</span><span class="ident" id="5374913">si</span><span class="op" id="5374915">+</span><span class="num" id="5374916">2</span><span class="op" id="5374917">]</span><span class="op" id="5374918">)</span>&nbsp;<span class="op" id="5374920">*</span>&nbsp;<span class="ident" id="5374922">sa</span>&nbsp;<span class="op" id="5374925">/</span>&nbsp;<span class="num" id="5374927">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374936">dr</span>&nbsp;<span class="op" id="5374939">:=</span>&nbsp;<span class="builtintype" id="5374942">uint32</span><span class="op" id="5374948">(</span><span class="ident" id="5374949">dpix</span><span class="op" id="5374953">[</span><span class="ident" id="5374954">i</span><span class="op" id="5374955">+</span><span class="num" id="5374956">0</span><span class="op" id="5374957">]</span><span class="op" id="5374958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374963">dg</span>&nbsp;<span class="op" id="5374966">:=</span>&nbsp;<span class="builtintype" id="5374969">uint32</span><span class="op" id="5374975">(</span><span class="ident" id="5374976">dpix</span><span class="op" id="5374980">[</span><span class="ident" id="5374981">i</span><span class="op" id="5374982">+</span><span class="num" id="5374983">1</span><span class="op" id="5374984">]</span><span class="op" id="5374985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5374990">db</span>&nbsp;<span class="op" id="5374993">:=</span>&nbsp;<span class="builtintype" id="5374996">uint32</span><span class="op" id="5375002">(</span><span class="ident" id="5375003">dpix</span><span class="op" id="5375007">[</span><span class="ident" id="5375008">i</span><span class="op" id="5375009">+</span><span class="num" id="5375010">2</span><span class="op" id="5375011">]</span><span class="op" id="5375012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375017">da</span>&nbsp;<span class="op" id="5375020">:=</span>&nbsp;<span class="builtintype" id="5375023">uint32</span><span class="op" id="5375029">(</span><span class="ident" id="5375030">dpix</span><span class="op" id="5375034">[</span><span class="ident" id="5375035">i</span><span class="op" id="5375036">+</span><span class="num" id="5375037">3</span><span class="op" id="5375038">]</span><span class="op" id="5375039">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375045">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375105">a</span>&nbsp;<span class="op" id="5375107">:=</span>&nbsp;<span class="op" id="5375110">(</span><span class="ident" id="5375111">m</span>&nbsp;<span class="op" id="5375113">-</span>&nbsp;<span class="ident" id="5375115">sa</span><span class="op" id="5375117">)</span>&nbsp;<span class="op" id="5375119">*</span>&nbsp;<span class="num" id="5375121">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375131">dpix</span><span class="op" id="5375135">[</span><span class="ident" id="5375136">i</span><span class="op" id="5375137">+</span><span class="num" id="5375138">0</span><span class="op" id="5375139">]</span>&nbsp;<span class="op" id="5375141">=</span>&nbsp;<span class="builtintype" id="5375143">uint8</span><span class="op" id="5375148">(</span><span class="op" id="5375149">(</span><span class="ident" id="5375150">dr</span><span class="op" id="5375152">*</span><span class="ident" id="5375153">a</span><span class="op" id="5375154">/</span><span class="ident" id="5375155">m</span>&nbsp;<span class="op" id="5375157">+</span>&nbsp;<span class="ident" id="5375159">sr</span><span class="op" id="5375161">)</span>&nbsp;<span class="op" id="5375163">&gt;&gt;</span>&nbsp;<span class="num" id="5375166">8</span><span class="op" id="5375167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375172">dpix</span><span class="op" id="5375176">[</span><span class="ident" id="5375177">i</span><span class="op" id="5375178">+</span><span class="num" id="5375179">1</span><span class="op" id="5375180">]</span>&nbsp;<span class="op" id="5375182">=</span>&nbsp;<span class="builtintype" id="5375184">uint8</span><span class="op" id="5375189">(</span><span class="op" id="5375190">(</span><span class="ident" id="5375191">dg</span><span class="op" id="5375193">*</span><span class="ident" id="5375194">a</span><span class="op" id="5375195">/</span><span class="ident" id="5375196">m</span>&nbsp;<span class="op" id="5375198">+</span>&nbsp;<span class="ident" id="5375200">sg</span><span class="op" id="5375202">)</span>&nbsp;<span class="op" id="5375204">&gt;&gt;</span>&nbsp;<span class="num" id="5375207">8</span><span class="op" id="5375208">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375213">dpix</span><span class="op" id="5375217">[</span><span class="ident" id="5375218">i</span><span class="op" id="5375219">+</span><span class="num" id="5375220">2</span><span class="op" id="5375221">]</span>&nbsp;<span class="op" id="5375223">=</span>&nbsp;<span class="builtintype" id="5375225">uint8</span><span class="op" id="5375230">(</span><span class="op" id="5375231">(</span><span class="ident" id="5375232">db</span><span class="op" id="5375234">*</span><span class="ident" id="5375235">a</span><span class="op" id="5375236">/</span><span class="ident" id="5375237">m</span>&nbsp;<span class="op" id="5375239">+</span>&nbsp;<span class="ident" id="5375241">sb</span><span class="op" id="5375243">)</span>&nbsp;<span class="op" id="5375245">&gt;&gt;</span>&nbsp;<span class="num" id="5375248">8</span><span class="op" id="5375249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375254">dpix</span><span class="op" id="5375258">[</span><span class="ident" id="5375259">i</span><span class="op" id="5375260">+</span><span class="num" id="5375261">3</span><span class="op" id="5375262">]</span>&nbsp;<span class="op" id="5375264">=</span>&nbsp;<span class="builtintype" id="5375266">uint8</span><span class="op" id="5375271">(</span><span class="op" id="5375272">(</span><span class="ident" id="5375273">da</span><span class="op" id="5375275">*</span><span class="ident" id="5375276">a</span><span class="op" id="5375277">/</span><span class="ident" id="5375278">m</span>&nbsp;<span class="op" id="5375280">+</span>&nbsp;<span class="ident" id="5375282">sa</span><span class="op" id="5375284">)</span>&nbsp;<span class="op" id="5375286">&gt;&gt;</span>&nbsp;<span class="num" id="5375289">8</span><span class="op" id="5375290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5375297">}</span><br>
<span class="lineno"></span><span class="op" id="5375299">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span><span class="keyword" id="5375302">func</span>&nbsp;<span class="ident" id="5375307">drawNRGBASrc</span><span class="op" id="5375319">(</span><span class="ident" id="5375320">dst</span>&nbsp;<span class="op" id="5375324">*</span><span class="ident" id="5375325">image</span><span class="op" id="5375330">.</span><span class="ident" id="5375331">RGBA</span><span class="op" id="5375335">,</span>&nbsp;<span class="ident" id="5375337">r</span>&nbsp;<span class="ident" id="5375339">image</span><span class="op" id="5375344">.</span><span class="ident" id="5375345">Rectangle</span><span class="op" id="5375354">,</span>&nbsp;<span class="ident" id="5375356">src</span>&nbsp;<span class="op" id="5375360">*</span><span class="ident" id="5375361">image</span><span class="op" id="5375366">.</span><span class="ident" id="5375367">NRGBA</span><span class="op" id="5375372">,</span>&nbsp;<span class="ident" id="5375374">sp</span>&nbsp;<span class="ident" id="5375377">image</span><span class="op" id="5375382">.</span><span class="ident" id="5375383">Point</span><span class="op" id="5375388">)</span>&nbsp;<span class="op" id="5375390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375393">i0</span>&nbsp;<span class="op" id="5375396">:=</span>&nbsp;<span class="op" id="5375399">(</span><span class="ident" id="5375400">r</span><span class="op" id="5375401">.</span><span class="ident" id="5375402">Min</span><span class="op" id="5375405">.</span><span class="ident" id="5375406">X</span>&nbsp;<span class="op" id="5375408">-</span>&nbsp;<span class="ident" id="5375410">dst</span><span class="op" id="5375413">.</span><span class="ident" id="5375414">Rect</span><span class="op" id="5375418">.</span><span class="ident" id="5375419">Min</span><span class="op" id="5375422">.</span><span class="ident" id="5375423">X</span><span class="op" id="5375424">)</span>&nbsp;<span class="op" id="5375426">*</span>&nbsp;<span class="num" id="5375428">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375431">i1</span>&nbsp;<span class="op" id="5375434">:=</span>&nbsp;<span class="op" id="5375437">(</span><span class="ident" id="5375438">r</span><span class="op" id="5375439">.</span><span class="ident" id="5375440">Max</span><span class="op" id="5375443">.</span><span class="ident" id="5375444">X</span>&nbsp;<span class="op" id="5375446">-</span>&nbsp;<span class="ident" id="5375448">dst</span><span class="op" id="5375451">.</span><span class="ident" id="5375452">Rect</span><span class="op" id="5375456">.</span><span class="ident" id="5375457">Min</span><span class="op" id="5375460">.</span><span class="ident" id="5375461">X</span><span class="op" id="5375462">)</span>&nbsp;<span class="op" id="5375464">*</span>&nbsp;<span class="num" id="5375466">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375469">si0</span>&nbsp;<span class="op" id="5375473">:=</span>&nbsp;<span class="op" id="5375476">(</span><span class="ident" id="5375477">sp</span><span class="op" id="5375479">.</span><span class="ident" id="5375480">X</span>&nbsp;<span class="op" id="5375482">-</span>&nbsp;<span class="ident" id="5375484">src</span><span class="op" id="5375487">.</span><span class="ident" id="5375488">Rect</span><span class="op" id="5375492">.</span><span class="ident" id="5375493">Min</span><span class="op" id="5375496">.</span><span class="ident" id="5375497">X</span><span class="op" id="5375498">)</span>&nbsp;<span class="op" id="5375500">*</span>&nbsp;<span class="num" id="5375502">4</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375505">yMax</span>&nbsp;<span class="op" id="5375510">:=</span>&nbsp;<span class="ident" id="5375513">r</span><span class="op" id="5375514">.</span><span class="ident" id="5375515">Max</span><span class="op" id="5375518">.</span><span class="ident" id="5375519">Y</span>&nbsp;<span class="op" id="5375521">-</span>&nbsp;<span class="ident" id="5375523">dst</span><span class="op" id="5375526">.</span><span class="ident" id="5375527">Rect</span><span class="op" id="5375531">.</span><span class="ident" id="5375532">Min</span><span class="op" id="5375535">.</span><span class="ident" id="5375536">Y</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375540">y</span>&nbsp;<span class="op" id="5375542">:=</span>&nbsp;<span class="ident" id="5375545">r</span><span class="op" id="5375546">.</span><span class="ident" id="5375547">Min</span><span class="op" id="5375550">.</span><span class="ident" id="5375551">Y</span>&nbsp;<span class="op" id="5375553">-</span>&nbsp;<span class="ident" id="5375555">dst</span><span class="op" id="5375558">.</span><span class="ident" id="5375559">Rect</span><span class="op" id="5375563">.</span><span class="ident" id="5375564">Min</span><span class="op" id="5375567">.</span><span class="ident" id="5375568">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375571">sy</span>&nbsp;<span class="op" id="5375574">:=</span>&nbsp;<span class="ident" id="5375577">sp</span><span class="op" id="5375579">.</span><span class="ident" id="5375580">Y</span>&nbsp;<span class="op" id="5375582">-</span>&nbsp;<span class="ident" id="5375584">src</span><span class="op" id="5375587">.</span><span class="ident" id="5375588">Rect</span><span class="op" id="5375592">.</span><span class="ident" id="5375593">Min</span><span class="op" id="5375596">.</span><span class="ident" id="5375597">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375600">for</span>&nbsp;<span class="op" id="5375604">;</span>&nbsp;<span class="ident" id="5375606">y</span>&nbsp;<span class="op" id="5375608">!=</span>&nbsp;<span class="ident" id="5375611">yMax</span><span class="op" id="5375615">;</span>&nbsp;<span class="ident" id="5375617">y</span><span class="op" id="5375618">,</span>&nbsp;<span class="ident" id="5375620">sy</span>&nbsp;<span class="op" id="5375623">=</span>&nbsp;<span class="ident" id="5375625">y</span><span class="op" id="5375626">+</span><span class="num" id="5375627">1</span><span class="op" id="5375628">,</span>&nbsp;<span class="ident" id="5375630">sy</span><span class="op" id="5375632">+</span><span class="num" id="5375633">1</span>&nbsp;<span class="op" id="5375635">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375639">dpix</span>&nbsp;<span class="op" id="5375644">:=</span>&nbsp;<span class="ident" id="5375647">dst</span><span class="op" id="5375650">.</span><span class="ident" id="5375651">Pix</span><span class="op" id="5375654">[</span><span class="ident" id="5375655">y</span><span class="op" id="5375656">*</span><span class="ident" id="5375657">dst</span><span class="op" id="5375660">.</span><span class="ident" id="5375661">Stride</span><span class="op" id="5375667">:</span><span class="op" id="5375668">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375672">spix</span>&nbsp;<span class="op" id="5375677">:=</span>&nbsp;<span class="ident" id="5375680">src</span><span class="op" id="5375683">.</span><span class="ident" id="5375684">Pix</span><span class="op" id="5375687">[</span><span class="ident" id="5375688">sy</span><span class="op" id="5375690">*</span><span class="ident" id="5375691">src</span><span class="op" id="5375694">.</span><span class="ident" id="5375695">Stride</span><span class="op" id="5375701">:</span><span class="op" id="5375702">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5375707">for</span>&nbsp;<span class="ident" id="5375711">i</span><span class="op" id="5375712">,</span>&nbsp;<span class="ident" id="5375714">si</span>&nbsp;<span class="op" id="5375717">:=</span>&nbsp;<span class="ident" id="5375720">i0</span><span class="op" id="5375722">,</span>&nbsp;<span class="ident" id="5375724">si0</span><span class="op" id="5375727">;</span>&nbsp;<span class="ident" id="5375729">i</span>&nbsp;<span class="op" id="5375731">&lt;</span>&nbsp;<span class="ident" id="5375733">i1</span><span class="op" id="5375735">;</span>&nbsp;<span class="ident" id="5375737">i</span><span class="op" id="5375738">,</span>&nbsp;<span class="ident" id="5375740">si</span>&nbsp;<span class="op" id="5375743">=</span>&nbsp;<span class="ident" id="5375745">i</span><span class="op" id="5375746">+</span><span class="num" id="5375747">4</span><span class="op" id="5375748">,</span>&nbsp;<span class="ident" id="5375750">si</span><span class="op" id="5375752">+</span><span class="num" id="5375753">4</span>&nbsp;<span class="op" id="5375755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5375760">//&nbsp;Convert&nbsp;from&nbsp;non-premultiplied&nbsp;color&nbsp;to&nbsp;pre-multiplied&nbsp;color.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375828">sa</span>&nbsp;<span class="op" id="5375831">:=</span>&nbsp;<span class="builtintype" id="5375834">uint32</span><span class="op" id="5375840">(</span><span class="ident" id="5375841">spix</span><span class="op" id="5375845">[</span><span class="ident" id="5375846">si</span><span class="op" id="5375848">+</span><span class="num" id="5375849">3</span><span class="op" id="5375850">]</span><span class="op" id="5375851">)</span>&nbsp;<span class="op" id="5375853">*</span>&nbsp;<span class="num" id="5375855">0x101</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375864">sr</span>&nbsp;<span class="op" id="5375867">:=</span>&nbsp;<span class="builtintype" id="5375870">uint32</span><span class="op" id="5375876">(</span><span class="ident" id="5375877">spix</span><span class="op" id="5375881">[</span><span class="ident" id="5375882">si</span><span class="op" id="5375884">+</span><span class="num" id="5375885">0</span><span class="op" id="5375886">]</span><span class="op" id="5375887">)</span>&nbsp;<span class="op" id="5375889">*</span>&nbsp;<span class="ident" id="5375891">sa</span>&nbsp;<span class="op" id="5375894">/</span>&nbsp;<span class="num" id="5375896">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375904">sg</span>&nbsp;<span class="op" id="5375907">:=</span>&nbsp;<span class="builtintype" id="5375910">uint32</span><span class="op" id="5375916">(</span><span class="ident" id="5375917">spix</span><span class="op" id="5375921">[</span><span class="ident" id="5375922">si</span><span class="op" id="5375924">+</span><span class="num" id="5375925">1</span><span class="op" id="5375926">]</span><span class="op" id="5375927">)</span>&nbsp;<span class="op" id="5375929">*</span>&nbsp;<span class="ident" id="5375931">sa</span>&nbsp;<span class="op" id="5375934">/</span>&nbsp;<span class="num" id="5375936">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375944">sb</span>&nbsp;<span class="op" id="5375947">:=</span>&nbsp;<span class="builtintype" id="5375950">uint32</span><span class="op" id="5375956">(</span><span class="ident" id="5375957">spix</span><span class="op" id="5375961">[</span><span class="ident" id="5375962">si</span><span class="op" id="5375964">+</span><span class="num" id="5375965">2</span><span class="op" id="5375966">]</span><span class="op" id="5375967">)</span>&nbsp;<span class="op" id="5375969">*</span>&nbsp;<span class="ident" id="5375971">sa</span>&nbsp;<span class="op" id="5375974">/</span>&nbsp;<span class="num" id="5375976">0xff</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5375985">dpix</span><span class="op" id="5375989">[</span><span class="ident" id="5375990">i</span><span class="op" id="5375991">+</span><span class="num" id="5375992">0</span><span class="op" id="5375993">]</span>&nbsp;<span class="op" id="5375995">=</span>&nbsp;<span class="builtintype" id="5375997">uint8</span><span class="op" id="5376002">(</span><span class="ident" id="5376003">sr</span>&nbsp;<span class="op" id="5376006">&gt;&gt;</span>&nbsp;<span class="num" id="5376009">8</span><span class="op" id="5376010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376015">dpix</span><span class="op" id="5376019">[</span><span class="ident" id="5376020">i</span><span class="op" id="5376021">+</span><span class="num" id="5376022">1</span><span class="op" id="5376023">]</span>&nbsp;<span class="op" id="5376025">=</span>&nbsp;<span class="builtintype" id="5376027">uint8</span><span class="op" id="5376032">(</span><span class="ident" id="5376033">sg</span>&nbsp;<span class="op" id="5376036">&gt;&gt;</span>&nbsp;<span class="num" id="5376039">8</span><span class="op" id="5376040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376045">dpix</span><span class="op" id="5376049">[</span><span class="ident" id="5376050">i</span><span class="op" id="5376051">+</span><span class="num" id="5376052">2</span><span class="op" id="5376053">]</span>&nbsp;<span class="op" id="5376055">=</span>&nbsp;<span class="builtintype" id="5376057">uint8</span><span class="op" id="5376062">(</span><span class="ident" id="5376063">sb</span>&nbsp;<span class="op" id="5376066">&gt;&gt;</span>&nbsp;<span class="num" id="5376069">8</span><span class="op" id="5376070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376075">dpix</span><span class="op" id="5376079">[</span><span class="ident" id="5376080">i</span><span class="op" id="5376081">+</span><span class="num" id="5376082">3</span><span class="op" id="5376083">]</span>&nbsp;<span class="op" id="5376085">=</span>&nbsp;<span class="builtintype" id="5376087">uint8</span><span class="op" id="5376092">(</span><span class="ident" id="5376093">sa</span>&nbsp;<span class="op" id="5376096">&gt;&gt;</span>&nbsp;<span class="num" id="5376099">8</span><span class="op" id="5376100">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376104">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376107">}</span><br>
<span class="lineno"></span><span class="op" id="5376109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5376112">func</span>&nbsp;<span class="ident" id="5376117">drawYCbCr</span><span class="op" id="5376126">(</span><span class="ident" id="5376127">dst</span>&nbsp;<span class="op" id="5376131">*</span><span class="ident" id="5376132">image</span><span class="op" id="5376137">.</span><span class="ident" id="5376138">RGBA</span><span class="op" id="5376142">,</span>&nbsp;<span class="ident" id="5376144">r</span>&nbsp;<span class="ident" id="5376146">image</span><span class="op" id="5376151">.</span><span class="ident" id="5376152">Rectangle</span><span class="op" id="5376161">,</span>&nbsp;<span class="ident" id="5376163">src</span>&nbsp;<span class="op" id="5376167">*</span><span class="ident" id="5376168">image</span><span class="op" id="5376173">.</span><span class="ident" id="5376174">YCbCr</span><span class="op" id="5376179">,</span>&nbsp;<span class="ident" id="5376181">sp</span>&nbsp;<span class="ident" id="5376184">image</span><span class="op" id="5376189">.</span><span class="ident" id="5376190">Point</span><span class="op" id="5376195">)</span>&nbsp;<span class="op" id="5376197">(</span><span class="ident" id="5376198">ok</span>&nbsp;<span class="builtintype" id="5376201">bool</span><span class="op" id="5376205">)</span>&nbsp;<span class="op" id="5376207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376210">//&nbsp;An&nbsp;image.YCbCr&nbsp;is&nbsp;always&nbsp;fully&nbsp;opaque,&nbsp;and&nbsp;so&nbsp;if&nbsp;the&nbsp;mask&nbsp;is&nbsp;implicitly&nbsp;nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5376290">//&nbsp;(i.e.&nbsp;fully&nbsp;opaque)&nbsp;then&nbsp;the&nbsp;op&nbsp;is&nbsp;effectively&nbsp;always&nbsp;Src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376353">x0</span>&nbsp;<span class="op" id="5376356">:=</span>&nbsp;<span class="op" id="5376359">(</span><span class="ident" id="5376360">r</span><span class="op" id="5376361">.</span><span class="ident" id="5376362">Min</span><span class="op" id="5376365">.</span><span class="ident" id="5376366">X</span>&nbsp;<span class="op" id="5376368">-</span>&nbsp;<span class="ident" id="5376370">dst</span><span class="op" id="5376373">.</span><span class="ident" id="5376374">Rect</span><span class="op" id="5376378">.</span><span class="ident" id="5376379">Min</span><span class="op" id="5376382">.</span><span class="ident" id="5376383">X</span><span class="op" id="5376384">)</span>&nbsp;<span class="op" id="5376386">*</span>&nbsp;<span class="num" id="5376388">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376391">x1</span>&nbsp;<span class="op" id="5376394">:=</span>&nbsp;<span class="op" id="5376397">(</span><span class="ident" id="5376398">r</span><span class="op" id="5376399">.</span><span class="ident" id="5376400">Max</span><span class="op" id="5376403">.</span><span class="ident" id="5376404">X</span>&nbsp;<span class="op" id="5376406">-</span>&nbsp;<span class="ident" id="5376408">dst</span><span class="op" id="5376411">.</span><span class="ident" id="5376412">Rect</span><span class="op" id="5376416">.</span><span class="ident" id="5376417">Min</span><span class="op" id="5376420">.</span><span class="ident" id="5376421">X</span><span class="op" id="5376422">)</span>&nbsp;<span class="op" id="5376424">*</span>&nbsp;<span class="num" id="5376426">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376429">y0</span>&nbsp;<span class="op" id="5376432">:=</span>&nbsp;<span class="ident" id="5376435">r</span><span class="op" id="5376436">.</span><span class="ident" id="5376437">Min</span><span class="op" id="5376440">.</span><span class="ident" id="5376441">Y</span>&nbsp;<span class="op" id="5376443">-</span>&nbsp;<span class="ident" id="5376445">dst</span><span class="op" id="5376448">.</span><span class="ident" id="5376449">Rect</span><span class="op" id="5376453">.</span><span class="ident" id="5376454">Min</span><span class="op" id="5376457">.</span><span class="ident" id="5376458">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376461">y1</span>&nbsp;<span class="op" id="5376464">:=</span>&nbsp;<span class="ident" id="5376467">r</span><span class="op" id="5376468">.</span><span class="ident" id="5376469">Max</span><span class="op" id="5376472">.</span><span class="ident" id="5376473">Y</span>&nbsp;<span class="op" id="5376475">-</span>&nbsp;<span class="ident" id="5376477">dst</span><span class="op" id="5376480">.</span><span class="ident" id="5376481">Rect</span><span class="op" id="5376485">.</span><span class="ident" id="5376486">Min</span><span class="op" id="5376489">.</span><span class="ident" id="5376490">Y</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376493">switch</span>&nbsp;<span class="ident" id="5376500">src</span><span class="op" id="5376503">.</span><span class="ident" id="5376504">SubsampleRatio</span>&nbsp;<span class="op" id="5376519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376522">case</span>&nbsp;<span class="ident" id="5376527">image</span><span class="op" id="5376532">.</span><span class="ident" id="5376533">YCbCrSubsampleRatio444</span><span class="op" id="5376555">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376559">for</span>&nbsp;<span class="ident" id="5376563">y</span><span class="op" id="5376564">,</span>&nbsp;<span class="ident" id="5376566">sy</span>&nbsp;<span class="op" id="5376569">:=</span>&nbsp;<span class="ident" id="5376572">y0</span><span class="op" id="5376574">,</span>&nbsp;<span class="ident" id="5376576">sp</span><span class="op" id="5376578">.</span><span class="ident" id="5376579">Y</span><span class="op" id="5376580">;</span>&nbsp;<span class="ident" id="5376582">y</span>&nbsp;<span class="op" id="5376584">!=</span>&nbsp;<span class="ident" id="5376587">y1</span><span class="op" id="5376589">;</span>&nbsp;<span class="ident" id="5376591">y</span><span class="op" id="5376592">,</span>&nbsp;<span class="ident" id="5376594">sy</span>&nbsp;<span class="op" id="5376597">=</span>&nbsp;<span class="ident" id="5376599">y</span><span class="op" id="5376600">+</span><span class="num" id="5376601">1</span><span class="op" id="5376602">,</span>&nbsp;<span class="ident" id="5376604">sy</span><span class="op" id="5376606">+</span><span class="num" id="5376607">1</span>&nbsp;<span class="op" id="5376609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376614">dpix</span>&nbsp;<span class="op" id="5376619">:=</span>&nbsp;<span class="ident" id="5376622">dst</span><span class="op" id="5376625">.</span><span class="ident" id="5376626">Pix</span><span class="op" id="5376629">[</span><span class="ident" id="5376630">y</span><span class="op" id="5376631">*</span><span class="ident" id="5376632">dst</span><span class="op" id="5376635">.</span><span class="ident" id="5376636">Stride</span><span class="op" id="5376642">:</span><span class="op" id="5376643">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376648">yi</span>&nbsp;<span class="op" id="5376651">:=</span>&nbsp;<span class="op" id="5376654">(</span><span class="ident" id="5376655">sy</span><span class="op" id="5376657">-</span><span class="ident" id="5376658">src</span><span class="op" id="5376661">.</span><span class="ident" id="5376662">Rect</span><span class="op" id="5376666">.</span><span class="ident" id="5376667">Min</span><span class="op" id="5376670">.</span><span class="ident" id="5376671">Y</span><span class="op" id="5376672">)</span><span class="op" id="5376673">*</span><span class="ident" id="5376674">src</span><span class="op" id="5376677">.</span><span class="ident" id="5376678">YStride</span>&nbsp;<span class="op" id="5376686">+</span>&nbsp;<span class="op" id="5376688">(</span><span class="ident" id="5376689">sp</span><span class="op" id="5376691">.</span><span class="ident" id="5376692">X</span>&nbsp;<span class="op" id="5376694">-</span>&nbsp;<span class="ident" id="5376696">src</span><span class="op" id="5376699">.</span><span class="ident" id="5376700">Rect</span><span class="op" id="5376704">.</span><span class="ident" id="5376705">Min</span><span class="op" id="5376708">.</span><span class="ident" id="5376709">X</span><span class="op" id="5376710">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376715">ci</span>&nbsp;<span class="op" id="5376718">:=</span>&nbsp;<span class="op" id="5376721">(</span><span class="ident" id="5376722">sy</span><span class="op" id="5376724">-</span><span class="ident" id="5376725">src</span><span class="op" id="5376728">.</span><span class="ident" id="5376729">Rect</span><span class="op" id="5376733">.</span><span class="ident" id="5376734">Min</span><span class="op" id="5376737">.</span><span class="ident" id="5376738">Y</span><span class="op" id="5376739">)</span><span class="op" id="5376740">*</span><span class="ident" id="5376741">src</span><span class="op" id="5376744">.</span><span class="ident" id="5376745">CStride</span>&nbsp;<span class="op" id="5376753">+</span>&nbsp;<span class="op" id="5376755">(</span><span class="ident" id="5376756">sp</span><span class="op" id="5376758">.</span><span class="ident" id="5376759">X</span>&nbsp;<span class="op" id="5376761">-</span>&nbsp;<span class="ident" id="5376763">src</span><span class="op" id="5376766">.</span><span class="ident" id="5376767">Rect</span><span class="op" id="5376771">.</span><span class="ident" id="5376772">Min</span><span class="op" id="5376775">.</span><span class="ident" id="5376776">X</span><span class="op" id="5376777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376782">for</span>&nbsp;<span class="ident" id="5376786">x</span>&nbsp;<span class="op" id="5376788">:=</span>&nbsp;<span class="ident" id="5376791">x0</span><span class="op" id="5376793">;</span>&nbsp;<span class="ident" id="5376795">x</span>&nbsp;<span class="op" id="5376797">!=</span>&nbsp;<span class="ident" id="5376800">x1</span><span class="op" id="5376802">;</span>&nbsp;<span class="ident" id="5376804">x</span><span class="op" id="5376805">,</span>&nbsp;<span class="ident" id="5376807">yi</span><span class="op" id="5376809">,</span>&nbsp;<span class="ident" id="5376811">ci</span>&nbsp;<span class="op" id="5376814">=</span>&nbsp;<span class="ident" id="5376816">x</span><span class="op" id="5376817">+</span><span class="num" id="5376818">4</span><span class="op" id="5376819">,</span>&nbsp;<span class="ident" id="5376821">yi</span><span class="op" id="5376823">+</span><span class="num" id="5376824">1</span><span class="op" id="5376825">,</span>&nbsp;<span class="ident" id="5376827">ci</span><span class="op" id="5376829">+</span><span class="num" id="5376830">1</span>&nbsp;<span class="op" id="5376832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376838">rr</span><span class="op" id="5376840">,</span>&nbsp;<span class="ident" id="5376842">gg</span><span class="op" id="5376844">,</span>&nbsp;<span class="ident" id="5376846">bb</span>&nbsp;<span class="op" id="5376849">:=</span>&nbsp;<span class="ident" id="5376852">color</span><span class="op" id="5376857">.</span><span class="ident" id="5376858">YCbCrToRGB</span><span class="op" id="5376868">(</span><span class="ident" id="5376869">src</span><span class="op" id="5376872">.</span><span class="ident" id="5376873">Y</span><span class="op" id="5376874">[</span><span class="ident" id="5376875">yi</span><span class="op" id="5376877">]</span><span class="op" id="5376878">,</span>&nbsp;<span class="ident" id="5376880">src</span><span class="op" id="5376883">.</span><span class="ident" id="5376884">Cb</span><span class="op" id="5376886">[</span><span class="ident" id="5376887">ci</span><span class="op" id="5376889">]</span><span class="op" id="5376890">,</span>&nbsp;<span class="ident" id="5376892">src</span><span class="op" id="5376895">.</span><span class="ident" id="5376896">Cr</span><span class="op" id="5376898">[</span><span class="ident" id="5376899">ci</span><span class="op" id="5376901">]</span><span class="op" id="5376902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376908">dpix</span><span class="op" id="5376912">[</span><span class="ident" id="5376913">x</span><span class="op" id="5376914">+</span><span class="num" id="5376915">0</span><span class="op" id="5376916">]</span>&nbsp;<span class="op" id="5376918">=</span>&nbsp;<span class="ident" id="5376920">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376927">dpix</span><span class="op" id="5376931">[</span><span class="ident" id="5376932">x</span><span class="op" id="5376933">+</span><span class="num" id="5376934">1</span><span class="op" id="5376935">]</span>&nbsp;<span class="op" id="5376937">=</span>&nbsp;<span class="ident" id="5376939">gg</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376946">dpix</span><span class="op" id="5376950">[</span><span class="ident" id="5376951">x</span><span class="op" id="5376952">+</span><span class="num" id="5376953">2</span><span class="op" id="5376954">]</span>&nbsp;<span class="op" id="5376956">=</span>&nbsp;<span class="ident" id="5376958">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5376965">dpix</span><span class="op" id="5376969">[</span><span class="ident" id="5376970">x</span><span class="op" id="5376971">+</span><span class="num" id="5376972">3</span><span class="op" id="5376973">]</span>&nbsp;<span class="op" id="5376975">=</span>&nbsp;<span class="num" id="5376977">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5376988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5376991">case</span>&nbsp;<span class="ident" id="5376996">image</span><span class="op" id="5377001">.</span><span class="ident" id="5377002">YCbCrSubsampleRatio422</span><span class="op" id="5377024">:</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377028">for</span>&nbsp;<span class="ident" id="5377032">y</span><span class="op" id="5377033">,</span>&nbsp;<span class="ident" id="5377035">sy</span>&nbsp;<span class="op" id="5377038">:=</span>&nbsp;<span class="ident" id="5377041">y0</span><span class="op" id="5377043">,</span>&nbsp;<span class="ident" id="5377045">sp</span><span class="op" id="5377047">.</span><span class="ident" id="5377048">Y</span><span class="op" id="5377049">;</span>&nbsp;<span class="ident" id="5377051">y</span>&nbsp;<span class="op" id="5377053">!=</span>&nbsp;<span class="ident" id="5377056">y1</span><span class="op" id="5377058">;</span>&nbsp;<span class="ident" id="5377060">y</span><span class="op" id="5377061">,</span>&nbsp;<span class="ident" id="5377063">sy</span>&nbsp;<span class="op" id="5377066">=</span>&nbsp;<span class="ident" id="5377068">y</span><span class="op" id="5377069">+</span><span class="num" id="5377070">1</span><span class="op" id="5377071">,</span>&nbsp;<span class="ident" id="5377073">sy</span><span class="op" id="5377075">+</span><span class="num" id="5377076">1</span>&nbsp;<span class="op" id="5377078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377083">dpix</span>&nbsp;<span class="op" id="5377088">:=</span>&nbsp;<span class="ident" id="5377091">dst</span><span class="op" id="5377094">.</span><span class="ident" id="5377095">Pix</span><span class="op" id="5377098">[</span><span class="ident" id="5377099">y</span><span class="op" id="5377100">*</span><span class="ident" id="5377101">dst</span><span class="op" id="5377104">.</span><span class="ident" id="5377105">Stride</span><span class="op" id="5377111">:</span><span class="op" id="5377112">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377117">yi</span>&nbsp;<span class="op" id="5377120">:=</span>&nbsp;<span class="op" id="5377123">(</span><span class="ident" id="5377124">sy</span><span class="op" id="5377126">-</span><span class="ident" id="5377127">src</span><span class="op" id="5377130">.</span><span class="ident" id="5377131">Rect</span><span class="op" id="5377135">.</span><span class="ident" id="5377136">Min</span><span class="op" id="5377139">.</span><span class="ident" id="5377140">Y</span><span class="op" id="5377141">)</span><span class="op" id="5377142">*</span><span class="ident" id="5377143">src</span><span class="op" id="5377146">.</span><span class="ident" id="5377147">YStride</span>&nbsp;<span class="op" id="5377155">+</span>&nbsp;<span class="op" id="5377157">(</span><span class="ident" id="5377158">sp</span><span class="op" id="5377160">.</span><span class="ident" id="5377161">X</span>&nbsp;<span class="op" id="5377163">-</span>&nbsp;<span class="ident" id="5377165">src</span><span class="op" id="5377168">.</span><span class="ident" id="5377169">Rect</span><span class="op" id="5377173">.</span><span class="ident" id="5377174">Min</span><span class="op" id="5377177">.</span><span class="ident" id="5377178">X</span><span class="op" id="5377179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377184">ciBase</span>&nbsp;<span class="op" id="5377191">:=</span>&nbsp;<span class="op" id="5377194">(</span><span class="ident" id="5377195">sy</span><span class="op" id="5377197">-</span><span class="ident" id="5377198">src</span><span class="op" id="5377201">.</span><span class="ident" id="5377202">Rect</span><span class="op" id="5377206">.</span><span class="ident" id="5377207">Min</span><span class="op" id="5377210">.</span><span class="ident" id="5377211">Y</span><span class="op" id="5377212">)</span><span class="op" id="5377213">*</span><span class="ident" id="5377214">src</span><span class="op" id="5377217">.</span><span class="ident" id="5377218">CStride</span>&nbsp;<span class="op" id="5377226">-</span>&nbsp;<span class="ident" id="5377228">src</span><span class="op" id="5377231">.</span><span class="ident" id="5377232">Rect</span><span class="op" id="5377236">.</span><span class="ident" id="5377237">Min</span><span class="op" id="5377240">.</span><span class="ident" id="5377241">X</span><span class="op" id="5377242">/</span><span class="num" id="5377243">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377248">for</span>&nbsp;<span class="ident" id="5377252">x</span><span class="op" id="5377253">,</span>&nbsp;<span class="ident" id="5377255">sx</span>&nbsp;<span class="op" id="5377258">:=</span>&nbsp;<span class="ident" id="5377261">x0</span><span class="op" id="5377263">,</span>&nbsp;<span class="ident" id="5377265">sp</span><span class="op" id="5377267">.</span><span class="ident" id="5377268">X</span><span class="op" id="5377269">;</span>&nbsp;<span class="ident" id="5377271">x</span>&nbsp;<span class="op" id="5377273">!=</span>&nbsp;<span class="ident" id="5377276">x1</span><span class="op" id="5377278">;</span>&nbsp;<span class="ident" id="5377280">x</span><span class="op" id="5377281">,</span>&nbsp;<span class="ident" id="5377283">sx</span><span class="op" id="5377285">,</span>&nbsp;<span class="ident" id="5377287">yi</span>&nbsp;<span class="op" id="5377290">=</span>&nbsp;<span class="ident" id="5377292">x</span><span class="op" id="5377293">+</span><span class="num" id="5377294">4</span><span class="op" id="5377295">,</span>&nbsp;<span class="ident" id="5377297">sx</span><span class="op" id="5377299">+</span><span class="num" id="5377300">1</span><span class="op" id="5377301">,</span>&nbsp;<span class="ident" id="5377303">yi</span><span class="op" id="5377305">+</span><span class="num" id="5377306">1</span>&nbsp;<span class="op" id="5377308">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377314">ci</span>&nbsp;<span class="op" id="5377317">:=</span>&nbsp;<span class="ident" id="5377320">ciBase</span>&nbsp;<span class="op" id="5377327">+</span>&nbsp;<span class="ident" id="5377329">sx</span><span class="op" id="5377331">/</span><span class="num" id="5377332">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377338">rr</span><span class="op" id="5377340">,</span>&nbsp;<span class="ident" id="5377342">gg</span><span class="op" id="5377344">,</span>&nbsp;<span class="ident" id="5377346">bb</span>&nbsp;<span class="op" id="5377349">:=</span>&nbsp;<span class="ident" id="5377352">color</span><span class="op" id="5377357">.</span><span class="ident" id="5377358">YCbCrToRGB</span><span class="op" id="5377368">(</span><span class="ident" id="5377369">src</span><span class="op" id="5377372">.</span><span class="ident" id="5377373">Y</span><span class="op" id="5377374">[</span><span class="ident" id="5377375">yi</span><span class="op" id="5377377">]</span><span class="op" id="5377378">,</span>&nbsp;<span class="ident" id="5377380">src</span><span class="op" id="5377383">.</span><span class="ident" id="5377384">Cb</span><span class="op" id="5377386">[</span><span class="ident" id="5377387">ci</span><span class="op" id="5377389">]</span><span class="op" id="5377390">,</span>&nbsp;<span class="ident" id="5377392">src</span><span class="op" id="5377395">.</span><span class="ident" id="5377396">Cr</span><span class="op" id="5377398">[</span><span class="ident" id="5377399">ci</span><span class="op" id="5377401">]</span><span class="op" id="5377402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377408">dpix</span><span class="op" id="5377412">[</span><span class="ident" id="5377413">x</span><span class="op" id="5377414">+</span><span class="num" id="5377415">0</span><span class="op" id="5377416">]</span>&nbsp;<span class="op" id="5377418">=</span>&nbsp;<span class="ident" id="5377420">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377427">dpix</span><span class="op" id="5377431">[</span><span class="ident" id="5377432">x</span><span class="op" id="5377433">+</span><span class="num" id="5377434">1</span><span class="op" id="5377435">]</span>&nbsp;<span class="op" id="5377437">=</span>&nbsp;<span class="ident" id="5377439">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377446">dpix</span><span class="op" id="5377450">[</span><span class="ident" id="5377451">x</span><span class="op" id="5377452">+</span><span class="num" id="5377453">2</span><span class="op" id="5377454">]</span>&nbsp;<span class="op" id="5377456">=</span>&nbsp;<span class="ident" id="5377458">bb</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377465">dpix</span><span class="op" id="5377469">[</span><span class="ident" id="5377470">x</span><span class="op" id="5377471">+</span><span class="num" id="5377472">3</span><span class="op" id="5377473">]</span>&nbsp;<span class="op" id="5377475">=</span>&nbsp;<span class="num" id="5377477">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377491">case</span>&nbsp;<span class="ident" id="5377496">image</span><span class="op" id="5377501">.</span><span class="ident" id="5377502">YCbCrSubsampleRatio420</span><span class="op" id="5377524">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377528">for</span>&nbsp;<span class="ident" id="5377532">y</span><span class="op" id="5377533">,</span>&nbsp;<span class="ident" id="5377535">sy</span>&nbsp;<span class="op" id="5377538">:=</span>&nbsp;<span class="ident" id="5377541">y0</span><span class="op" id="5377543">,</span>&nbsp;<span class="ident" id="5377545">sp</span><span class="op" id="5377547">.</span><span class="ident" id="5377548">Y</span><span class="op" id="5377549">;</span>&nbsp;<span class="ident" id="5377551">y</span>&nbsp;<span class="op" id="5377553">!=</span>&nbsp;<span class="ident" id="5377556">y1</span><span class="op" id="5377558">;</span>&nbsp;<span class="ident" id="5377560">y</span><span class="op" id="5377561">,</span>&nbsp;<span class="ident" id="5377563">sy</span>&nbsp;<span class="op" id="5377566">=</span>&nbsp;<span class="ident" id="5377568">y</span><span class="op" id="5377569">+</span><span class="num" id="5377570">1</span><span class="op" id="5377571">,</span>&nbsp;<span class="ident" id="5377573">sy</span><span class="op" id="5377575">+</span><span class="num" id="5377576">1</span>&nbsp;<span class="op" id="5377578">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377583">dpix</span>&nbsp;<span class="op" id="5377588">:=</span>&nbsp;<span class="ident" id="5377591">dst</span><span class="op" id="5377594">.</span><span class="ident" id="5377595">Pix</span><span class="op" id="5377598">[</span><span class="ident" id="5377599">y</span><span class="op" id="5377600">*</span><span class="ident" id="5377601">dst</span><span class="op" id="5377604">.</span><span class="ident" id="5377605">Stride</span><span class="op" id="5377611">:</span><span class="op" id="5377612">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377617">yi</span>&nbsp;<span class="op" id="5377620">:=</span>&nbsp;<span class="op" id="5377623">(</span><span class="ident" id="5377624">sy</span><span class="op" id="5377626">-</span><span class="ident" id="5377627">src</span><span class="op" id="5377630">.</span><span class="ident" id="5377631">Rect</span><span class="op" id="5377635">.</span><span class="ident" id="5377636">Min</span><span class="op" id="5377639">.</span><span class="ident" id="5377640">Y</span><span class="op" id="5377641">)</span><span class="op" id="5377642">*</span><span class="ident" id="5377643">src</span><span class="op" id="5377646">.</span><span class="ident" id="5377647">YStride</span>&nbsp;<span class="op" id="5377655">+</span>&nbsp;<span class="op" id="5377657">(</span><span class="ident" id="5377658">sp</span><span class="op" id="5377660">.</span><span class="ident" id="5377661">X</span>&nbsp;<span class="op" id="5377663">-</span>&nbsp;<span class="ident" id="5377665">src</span><span class="op" id="5377668">.</span><span class="ident" id="5377669">Rect</span><span class="op" id="5377673">.</span><span class="ident" id="5377674">Min</span><span class="op" id="5377677">.</span><span class="ident" id="5377678">X</span><span class="op" id="5377679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377684">ciBase</span>&nbsp;<span class="op" id="5377691">:=</span>&nbsp;<span class="op" id="5377694">(</span><span class="ident" id="5377695">sy</span><span class="op" id="5377697">/</span><span class="num" id="5377698">2</span><span class="op" id="5377699">-</span><span class="ident" id="5377700">src</span><span class="op" id="5377703">.</span><span class="ident" id="5377704">Rect</span><span class="op" id="5377708">.</span><span class="ident" id="5377709">Min</span><span class="op" id="5377712">.</span><span class="ident" id="5377713">Y</span><span class="op" id="5377714">/</span><span class="num" id="5377715">2</span><span class="op" id="5377716">)</span><span class="op" id="5377717">*</span><span class="ident" id="5377718">src</span><span class="op" id="5377721">.</span><span class="ident" id="5377722">CStride</span>&nbsp;<span class="op" id="5377730">-</span>&nbsp;<span class="ident" id="5377732">src</span><span class="op" id="5377735">.</span><span class="ident" id="5377736">Rect</span><span class="op" id="5377740">.</span><span class="ident" id="5377741">Min</span><span class="op" id="5377744">.</span><span class="ident" id="5377745">X</span><span class="op" id="5377746">/</span><span class="num" id="5377747">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377752">for</span>&nbsp;<span class="ident" id="5377756">x</span><span class="op" id="5377757">,</span>&nbsp;<span class="ident" id="5377759">sx</span>&nbsp;<span class="op" id="5377762">:=</span>&nbsp;<span class="ident" id="5377765">x0</span><span class="op" id="5377767">,</span>&nbsp;<span class="ident" id="5377769">sp</span><span class="op" id="5377771">.</span><span class="ident" id="5377772">X</span><span class="op" id="5377773">;</span>&nbsp;<span class="ident" id="5377775">x</span>&nbsp;<span class="op" id="5377777">!=</span>&nbsp;<span class="ident" id="5377780">x1</span><span class="op" id="5377782">;</span>&nbsp;<span class="ident" id="5377784">x</span><span class="op" id="5377785">,</span>&nbsp;<span class="ident" id="5377787">sx</span><span class="op" id="5377789">,</span>&nbsp;<span class="ident" id="5377791">yi</span>&nbsp;<span class="op" id="5377794">=</span>&nbsp;<span class="ident" id="5377796">x</span><span class="op" id="5377797">+</span><span class="num" id="5377798">4</span><span class="op" id="5377799">,</span>&nbsp;<span class="ident" id="5377801">sx</span><span class="op" id="5377803">+</span><span class="num" id="5377804">1</span><span class="op" id="5377805">,</span>&nbsp;<span class="ident" id="5377807">yi</span><span class="op" id="5377809">+</span><span class="num" id="5377810">1</span>&nbsp;<span class="op" id="5377812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377818">ci</span>&nbsp;<span class="op" id="5377821">:=</span>&nbsp;<span class="ident" id="5377824">ciBase</span>&nbsp;<span class="op" id="5377831">+</span>&nbsp;<span class="ident" id="5377833">sx</span><span class="op" id="5377835">/</span><span class="num" id="5377836">2</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377842">rr</span><span class="op" id="5377844">,</span>&nbsp;<span class="ident" id="5377846">gg</span><span class="op" id="5377848">,</span>&nbsp;<span class="ident" id="5377850">bb</span>&nbsp;<span class="op" id="5377853">:=</span>&nbsp;<span class="ident" id="5377856">color</span><span class="op" id="5377861">.</span><span class="ident" id="5377862">YCbCrToRGB</span><span class="op" id="5377872">(</span><span class="ident" id="5377873">src</span><span class="op" id="5377876">.</span><span class="ident" id="5377877">Y</span><span class="op" id="5377878">[</span><span class="ident" id="5377879">yi</span><span class="op" id="5377881">]</span><span class="op" id="5377882">,</span>&nbsp;<span class="ident" id="5377884">src</span><span class="op" id="5377887">.</span><span class="ident" id="5377888">Cb</span><span class="op" id="5377890">[</span><span class="ident" id="5377891">ci</span><span class="op" id="5377893">]</span><span class="op" id="5377894">,</span>&nbsp;<span class="ident" id="5377896">src</span><span class="op" id="5377899">.</span><span class="ident" id="5377900">Cr</span><span class="op" id="5377902">[</span><span class="ident" id="5377903">ci</span><span class="op" id="5377905">]</span><span class="op" id="5377906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377912">dpix</span><span class="op" id="5377916">[</span><span class="ident" id="5377917">x</span><span class="op" id="5377918">+</span><span class="num" id="5377919">0</span><span class="op" id="5377920">]</span>&nbsp;<span class="op" id="5377922">=</span>&nbsp;<span class="ident" id="5377924">rr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377931">dpix</span><span class="op" id="5377935">[</span><span class="ident" id="5377936">x</span><span class="op" id="5377937">+</span><span class="num" id="5377938">1</span><span class="op" id="5377939">]</span>&nbsp;<span class="op" id="5377941">=</span>&nbsp;<span class="ident" id="5377943">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377950">dpix</span><span class="op" id="5377954">[</span><span class="ident" id="5377955">x</span><span class="op" id="5377956">+</span><span class="num" id="5377957">2</span><span class="op" id="5377958">]</span>&nbsp;<span class="op" id="5377960">=</span>&nbsp;<span class="ident" id="5377962">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5377969">dpix</span><span class="op" id="5377973">[</span><span class="ident" id="5377974">x</span><span class="op" id="5377975">+</span><span class="num" id="5377976">3</span><span class="op" id="5377977">]</span>&nbsp;<span class="op" id="5377979">=</span>&nbsp;<span class="num" id="5377981">255</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5377992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5377995">case</span>&nbsp;<span class="ident" id="5378000">image</span><span class="op" id="5378005">.</span><span class="ident" id="5378006">YCbCrSubsampleRatio440</span><span class="op" id="5378028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378032">for</span>&nbsp;<span class="ident" id="5378036">y</span><span class="op" id="5378037">,</span>&nbsp;<span class="ident" id="5378039">sy</span>&nbsp;<span class="op" id="5378042">:=</span>&nbsp;<span class="ident" id="5378045">y0</span><span class="op" id="5378047">,</span>&nbsp;<span class="ident" id="5378049">sp</span><span class="op" id="5378051">.</span><span class="ident" id="5378052">Y</span><span class="op" id="5378053">;</span>&nbsp;<span class="ident" id="5378055">y</span>&nbsp;<span class="op" id="5378057">!=</span>&nbsp;<span class="ident" id="5378060">y1</span><span class="op" id="5378062">;</span>&nbsp;<span class="ident" id="5378064">y</span><span class="op" id="5378065">,</span>&nbsp;<span class="ident" id="5378067">sy</span>&nbsp;<span class="op" id="5378070">=</span>&nbsp;<span class="ident" id="5378072">y</span><span class="op" id="5378073">+</span><span class="num" id="5378074">1</span><span class="op" id="5378075">,</span>&nbsp;<span class="ident" id="5378077">sy</span><span class="op" id="5378079">+</span><span class="num" id="5378080">1</span>&nbsp;<span class="op" id="5378082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378087">dpix</span>&nbsp;<span class="op" id="5378092">:=</span>&nbsp;<span class="ident" id="5378095">dst</span><span class="op" id="5378098">.</span><span class="ident" id="5378099">Pix</span><span class="op" id="5378102">[</span><span class="ident" id="5378103">y</span><span class="op" id="5378104">*</span><span class="ident" id="5378105">dst</span><span class="op" id="5378108">.</span><span class="ident" id="5378109">Stride</span><span class="op" id="5378115">:</span><span class="op" id="5378116">]</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378121">yi</span>&nbsp;<span class="op" id="5378124">:=</span>&nbsp;<span class="op" id="5378127">(</span><span class="ident" id="5378128">sy</span><span class="op" id="5378130">-</span><span class="ident" id="5378131">src</span><span class="op" id="5378134">.</span><span class="ident" id="5378135">Rect</span><span class="op" id="5378139">.</span><span class="ident" id="5378140">Min</span><span class="op" id="5378143">.</span><span class="ident" id="5378144">Y</span><span class="op" id="5378145">)</span><span class="op" id="5378146">*</span><span class="ident" id="5378147">src</span><span class="op" id="5378150">.</span><span class="ident" id="5378151">YStride</span>&nbsp;<span class="op" id="5378159">+</span>&nbsp;<span class="op" id="5378161">(</span><span class="ident" id="5378162">sp</span><span class="op" id="5378164">.</span><span class="ident" id="5378165">X</span>&nbsp;<span class="op" id="5378167">-</span>&nbsp;<span class="ident" id="5378169">src</span><span class="op" id="5378172">.</span><span class="ident" id="5378173">Rect</span><span class="op" id="5378177">.</span><span class="ident" id="5378178">Min</span><span class="op" id="5378181">.</span><span class="ident" id="5378182">X</span><span class="op" id="5378183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378188">ci</span>&nbsp;<span class="op" id="5378191">:=</span>&nbsp;<span class="op" id="5378194">(</span><span class="ident" id="5378195">sy</span><span class="op" id="5378197">/</span><span class="num" id="5378198">2</span><span class="op" id="5378199">-</span><span class="ident" id="5378200">src</span><span class="op" id="5378203">.</span><span class="ident" id="5378204">Rect</span><span class="op" id="5378208">.</span><span class="ident" id="5378209">Min</span><span class="op" id="5378212">.</span><span class="ident" id="5378213">Y</span><span class="op" id="5378214">/</span><span class="num" id="5378215">2</span><span class="op" id="5378216">)</span><span class="op" id="5378217">*</span><span class="ident" id="5378218">src</span><span class="op" id="5378221">.</span><span class="ident" id="5378222">CStride</span>&nbsp;<span class="op" id="5378230">+</span>&nbsp;<span class="op" id="5378232">(</span><span class="ident" id="5378233">sp</span><span class="op" id="5378235">.</span><span class="ident" id="5378236">X</span>&nbsp;<span class="op" id="5378238">-</span>&nbsp;<span class="ident" id="5378240">src</span><span class="op" id="5378243">.</span><span class="ident" id="5378244">Rect</span><span class="op" id="5378248">.</span><span class="ident" id="5378249">Min</span><span class="op" id="5378252">.</span><span class="ident" id="5378253">X</span><span class="op" id="5378254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378259">for</span>&nbsp;<span class="ident" id="5378263">x</span>&nbsp;<span class="op" id="5378265">:=</span>&nbsp;<span class="ident" id="5378268">x0</span><span class="op" id="5378270">;</span>&nbsp;<span class="ident" id="5378272">x</span>&nbsp;<span class="op" id="5378274">!=</span>&nbsp;<span class="ident" id="5378277">x1</span><span class="op" id="5378279">;</span>&nbsp;<span class="ident" id="5378281">x</span><span class="op" id="5378282">,</span>&nbsp;<span class="ident" id="5378284">yi</span><span class="op" id="5378286">,</span>&nbsp;<span class="ident" id="5378288">ci</span>&nbsp;<span class="op" id="5378291">=</span>&nbsp;<span class="ident" id="5378293">x</span><span class="op" id="5378294">+</span><span class="num" id="5378295">4</span><span class="op" id="5378296">,</span>&nbsp;<span class="ident" id="5378298">yi</span><span class="op" id="5378300">+</span><span class="num" id="5378301">1</span><span class="op" id="5378302">,</span>&nbsp;<span class="ident" id="5378304">ci</span><span class="op" id="5378306">+</span><span class="num" id="5378307">1</span>&nbsp;<span class="op" id="5378309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378315">rr</span><span class="op" id="5378317">,</span>&nbsp;<span class="ident" id="5378319">gg</span><span class="op" id="5378321">,</span>&nbsp;<span class="ident" id="5378323">bb</span>&nbsp;<span class="op" id="5378326">:=</span>&nbsp;<span class="ident" id="5378329">color</span><span class="op" id="5378334">.</span><span class="ident" id="5378335">YCbCrToRGB</span><span class="op" id="5378345">(</span><span class="ident" id="5378346">src</span><span class="op" id="5378349">.</span><span class="ident" id="5378350">Y</span><span class="op" id="5378351">[</span><span class="ident" id="5378352">yi</span><span class="op" id="5378354">]</span><span class="op" id="5378355">,</span>&nbsp;<span class="ident" id="5378357">src</span><span class="op" id="5378360">.</span><span class="ident" id="5378361">Cb</span><span class="op" id="5378363">[</span><span class="ident" id="5378364">ci</span><span class="op" id="5378366">]</span><span class="op" id="5378367">,</span>&nbsp;<span class="ident" id="5378369">src</span><span class="op" id="5378372">.</span><span class="ident" id="5378373">Cr</span><span class="op" id="5378375">[</span><span class="ident" id="5378376">ci</span><span class="op" id="5378378">]</span><span class="op" id="5378379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378385">dpix</span><span class="op" id="5378389">[</span><span class="ident" id="5378390">x</span><span class="op" id="5378391">+</span><span class="num" id="5378392">0</span><span class="op" id="5378393">]</span>&nbsp;<span class="op" id="5378395">=</span>&nbsp;<span class="ident" id="5378397">rr</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378404">dpix</span><span class="op" id="5378408">[</span><span class="ident" id="5378409">x</span><span class="op" id="5378410">+</span><span class="num" id="5378411">1</span><span class="op" id="5378412">]</span>&nbsp;<span class="op" id="5378414">=</span>&nbsp;<span class="ident" id="5378416">gg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378423">dpix</span><span class="op" id="5378427">[</span><span class="ident" id="5378428">x</span><span class="op" id="5378429">+</span><span class="num" id="5378430">2</span><span class="op" id="5378431">]</span>&nbsp;<span class="op" id="5378433">=</span>&nbsp;<span class="ident" id="5378435">bb</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378442">dpix</span><span class="op" id="5378446">[</span><span class="ident" id="5378447">x</span><span class="op" id="5378448">+</span><span class="num" id="5378449">3</span><span class="op" id="5378450">]</span>&nbsp;<span class="op" id="5378452">=</span>&nbsp;<span class="num" id="5378454">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378465">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378468">default</span><span class="op" id="5378475">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378479">return</span>&nbsp;<span class="builtintype" id="5378486">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378496">return</span>&nbsp;<span class="builtintype" id="5378503">true</span><br>
<span class="lineno"></span><span class="op" id="5378508">}</span><br>
<span class="lineno">460</span><br>
<span class="lineno"></span><span class="keyword" id="5378511">func</span>&nbsp;<span class="ident" id="5378516">drawGlyphOver</span><span class="op" id="5378529">(</span><span class="ident" id="5378530">dst</span>&nbsp;<span class="op" id="5378534">*</span><span class="ident" id="5378535">image</span><span class="op" id="5378540">.</span><span class="ident" id="5378541">RGBA</span><span class="op" id="5378545">,</span>&nbsp;<span class="ident" id="5378547">r</span>&nbsp;<span class="ident" id="5378549">image</span><span class="op" id="5378554">.</span><span class="ident" id="5378555">Rectangle</span><span class="op" id="5378564">,</span>&nbsp;<span class="ident" id="5378566">src</span>&nbsp;<span class="op" id="5378570">*</span><span class="ident" id="5378571">image</span><span class="op" id="5378576">.</span><span class="ident" id="5378577">Uniform</span><span class="op" id="5378584">,</span>&nbsp;<span class="ident" id="5378586">mask</span>&nbsp;<span class="op" id="5378591">*</span><span class="ident" id="5378592">image</span><span class="op" id="5378597">.</span><span class="ident" id="5378598">Alpha</span><span class="op" id="5378603">,</span>&nbsp;<span class="ident" id="5378605">mp</span>&nbsp;<span class="ident" id="5378608">image</span><span class="op" id="5378613">.</span><span class="ident" id="5378614">Point</span><span class="op" id="5378619">)</span>&nbsp;<span class="op" id="5378621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378624">i0</span>&nbsp;<span class="op" id="5378627">:=</span>&nbsp;<span class="ident" id="5378630">dst</span><span class="op" id="5378633">.</span><span class="ident" id="5378634">PixOffset</span><span class="op" id="5378643">(</span><span class="ident" id="5378644">r</span><span class="op" id="5378645">.</span><span class="ident" id="5378646">Min</span><span class="op" id="5378649">.</span><span class="ident" id="5378650">X</span><span class="op" id="5378651">,</span>&nbsp;<span class="ident" id="5378653">r</span><span class="op" id="5378654">.</span><span class="ident" id="5378655">Min</span><span class="op" id="5378658">.</span><span class="ident" id="5378659">Y</span><span class="op" id="5378660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378663">i1</span>&nbsp;<span class="op" id="5378666">:=</span>&nbsp;<span class="ident" id="5378669">i0</span>&nbsp;<span class="op" id="5378672">+</span>&nbsp;<span class="ident" id="5378674">r</span><span class="op" id="5378675">.</span><span class="ident" id="5378676">Dx</span><span class="op" id="5378678">(</span><span class="op" id="5378679">)</span><span class="op" id="5378680">*</span><span class="num" id="5378681">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378684">mi0</span>&nbsp;<span class="op" id="5378688">:=</span>&nbsp;<span class="ident" id="5378691">mask</span><span class="op" id="5378695">.</span><span class="ident" id="5378696">PixOffset</span><span class="op" id="5378705">(</span><span class="ident" id="5378706">mp</span><span class="op" id="5378708">.</span><span class="ident" id="5378709">X</span><span class="op" id="5378710">,</span>&nbsp;<span class="ident" id="5378712">mp</span><span class="op" id="5378714">.</span><span class="ident" id="5378715">Y</span><span class="op" id="5378716">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378719">sr</span><span class="op" id="5378721">,</span>&nbsp;<span class="ident" id="5378723">sg</span><span class="op" id="5378725">,</span>&nbsp;<span class="ident" id="5378727">sb</span><span class="op" id="5378729">,</span>&nbsp;<span class="ident" id="5378731">sa</span>&nbsp;<span class="op" id="5378734">:=</span>&nbsp;<span class="ident" id="5378737">src</span><span class="op" id="5378740">.</span><span class="ident" id="5378741">RGBA</span><span class="op" id="5378745">(</span><span class="op" id="5378746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378749">for</span>&nbsp;<span class="ident" id="5378753">y</span><span class="op" id="5378754">,</span>&nbsp;<span class="ident" id="5378756">my</span>&nbsp;<span class="op" id="5378759">:=</span>&nbsp;<span class="ident" id="5378762">r</span><span class="op" id="5378763">.</span><span class="ident" id="5378764">Min</span><span class="op" id="5378767">.</span><span class="ident" id="5378768">Y</span><span class="op" id="5378769">,</span>&nbsp;<span class="ident" id="5378771">mp</span><span class="op" id="5378773">.</span><span class="ident" id="5378774">Y</span><span class="op" id="5378775">;</span>&nbsp;<span class="ident" id="5378777">y</span>&nbsp;<span class="op" id="5378779">!=</span>&nbsp;<span class="ident" id="5378782">r</span><span class="op" id="5378783">.</span><span class="ident" id="5378784">Max</span><span class="op" id="5378787">.</span><span class="ident" id="5378788">Y</span><span class="op" id="5378789">;</span>&nbsp;<span class="ident" id="5378791">y</span><span class="op" id="5378792">,</span>&nbsp;<span class="ident" id="5378794">my</span>&nbsp;<span class="op" id="5378797">=</span>&nbsp;<span class="ident" id="5378799">y</span><span class="op" id="5378800">+</span><span class="num" id="5378801">1</span><span class="op" id="5378802">,</span>&nbsp;<span class="ident" id="5378804">my</span><span class="op" id="5378806">+</span><span class="num" id="5378807">1</span>&nbsp;<span class="op" id="5378809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378813">for</span>&nbsp;<span class="ident" id="5378817">i</span><span class="op" id="5378818">,</span>&nbsp;<span class="ident" id="5378820">mi</span>&nbsp;<span class="op" id="5378823">:=</span>&nbsp;<span class="ident" id="5378826">i0</span><span class="op" id="5378828">,</span>&nbsp;<span class="ident" id="5378830">mi0</span><span class="op" id="5378833">;</span>&nbsp;<span class="ident" id="5378835">i</span>&nbsp;<span class="op" id="5378837">&lt;</span>&nbsp;<span class="ident" id="5378839">i1</span><span class="op" id="5378841">;</span>&nbsp;<span class="ident" id="5378843">i</span><span class="op" id="5378844">,</span>&nbsp;<span class="ident" id="5378846">mi</span>&nbsp;<span class="op" id="5378849">=</span>&nbsp;<span class="ident" id="5378851">i</span><span class="op" id="5378852">+</span><span class="num" id="5378853">4</span><span class="op" id="5378854">,</span>&nbsp;<span class="ident" id="5378856">mi</span><span class="op" id="5378858">+</span><span class="num" id="5378859">1</span>&nbsp;<span class="op" id="5378861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378866">ma</span>&nbsp;<span class="op" id="5378869">:=</span>&nbsp;<span class="builtintype" id="5378872">uint32</span><span class="op" id="5378878">(</span><span class="ident" id="5378879">mask</span><span class="op" id="5378883">.</span><span class="ident" id="5378884">Pix</span><span class="op" id="5378887">[</span><span class="ident" id="5378888">mi</span><span class="op" id="5378890">]</span><span class="op" id="5378891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378896">if</span>&nbsp;<span class="ident" id="5378899">ma</span>&nbsp;<span class="op" id="5378902">==</span>&nbsp;<span class="num" id="5378905">0</span>&nbsp;<span class="op" id="5378907">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5378913">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5378925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378930">ma</span>&nbsp;<span class="op" id="5378933">|=</span>&nbsp;<span class="ident" id="5378936">ma</span>&nbsp;<span class="op" id="5378939">&lt;&lt;</span>&nbsp;<span class="num" id="5378942">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378948">dr</span>&nbsp;<span class="op" id="5378951">:=</span>&nbsp;<span class="builtintype" id="5378954">uint32</span><span class="op" id="5378960">(</span><span class="ident" id="5378961">dst</span><span class="op" id="5378964">.</span><span class="ident" id="5378965">Pix</span><span class="op" id="5378968">[</span><span class="ident" id="5378969">i</span><span class="op" id="5378970">+</span><span class="num" id="5378971">0</span><span class="op" id="5378972">]</span><span class="op" id="5378973">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5378978">dg</span>&nbsp;<span class="op" id="5378981">:=</span>&nbsp;<span class="builtintype" id="5378984">uint32</span><span class="op" id="5378990">(</span><span class="ident" id="5378991">dst</span><span class="op" id="5378994">.</span><span class="ident" id="5378995">Pix</span><span class="op" id="5378998">[</span><span class="ident" id="5378999">i</span><span class="op" id="5379000">+</span><span class="num" id="5379001">1</span><span class="op" id="5379002">]</span><span class="op" id="5379003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379008">db</span>&nbsp;<span class="op" id="5379011">:=</span>&nbsp;<span class="builtintype" id="5379014">uint32</span><span class="op" id="5379020">(</span><span class="ident" id="5379021">dst</span><span class="op" id="5379024">.</span><span class="ident" id="5379025">Pix</span><span class="op" id="5379028">[</span><span class="ident" id="5379029">i</span><span class="op" id="5379030">+</span><span class="num" id="5379031">2</span><span class="op" id="5379032">]</span><span class="op" id="5379033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379038">da</span>&nbsp;<span class="op" id="5379041">:=</span>&nbsp;<span class="builtintype" id="5379044">uint32</span><span class="op" id="5379050">(</span><span class="ident" id="5379051">dst</span><span class="op" id="5379054">.</span><span class="ident" id="5379055">Pix</span><span class="op" id="5379058">[</span><span class="ident" id="5379059">i</span><span class="op" id="5379060">+</span><span class="num" id="5379061">3</span><span class="op" id="5379062">]</span><span class="op" id="5379063">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5379069">//&nbsp;The&nbsp;0x101&nbsp;is&nbsp;here&nbsp;for&nbsp;the&nbsp;same&nbsp;reason&nbsp;as&nbsp;in&nbsp;drawRGBA.</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379129">a</span>&nbsp;<span class="op" id="5379131">:=</span>&nbsp;<span class="op" id="5379134">(</span><span class="ident" id="5379135">m</span>&nbsp;<span class="op" id="5379137">-</span>&nbsp;<span class="op" id="5379139">(</span><span class="ident" id="5379140">sa</span>&nbsp;<span class="op" id="5379143">*</span>&nbsp;<span class="ident" id="5379145">ma</span>&nbsp;<span class="op" id="5379148">/</span>&nbsp;<span class="ident" id="5379150">m</span><span class="op" id="5379151">)</span><span class="op" id="5379152">)</span>&nbsp;<span class="op" id="5379154">*</span>&nbsp;<span class="num" id="5379156">0x101</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379166">dst</span><span class="op" id="5379169">.</span><span class="ident" id="5379170">Pix</span><span class="op" id="5379173">[</span><span class="ident" id="5379174">i</span><span class="op" id="5379175">+</span><span class="num" id="5379176">0</span><span class="op" id="5379177">]</span>&nbsp;<span class="op" id="5379179">=</span>&nbsp;<span class="builtintype" id="5379181">uint8</span><span class="op" id="5379186">(</span><span class="op" id="5379187">(</span><span class="ident" id="5379188">dr</span><span class="op" id="5379190">*</span><span class="ident" id="5379191">a</span>&nbsp;<span class="op" id="5379193">+</span>&nbsp;<span class="ident" id="5379195">sr</span><span class="op" id="5379197">*</span><span class="ident" id="5379198">ma</span><span class="op" id="5379200">)</span>&nbsp;<span class="op" id="5379202">/</span>&nbsp;<span class="ident" id="5379204">m</span>&nbsp;<span class="op" id="5379206">&gt;&gt;</span>&nbsp;<span class="num" id="5379209">8</span><span class="op" id="5379210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379215">dst</span><span class="op" id="5379218">.</span><span class="ident" id="5379219">Pix</span><span class="op" id="5379222">[</span><span class="ident" id="5379223">i</span><span class="op" id="5379224">+</span><span class="num" id="5379225">1</span><span class="op" id="5379226">]</span>&nbsp;<span class="op" id="5379228">=</span>&nbsp;<span class="builtintype" id="5379230">uint8</span><span class="op" id="5379235">(</span><span class="op" id="5379236">(</span><span class="ident" id="5379237">dg</span><span class="op" id="5379239">*</span><span class="ident" id="5379240">a</span>&nbsp;<span class="op" id="5379242">+</span>&nbsp;<span class="ident" id="5379244">sg</span><span class="op" id="5379246">*</span><span class="ident" id="5379247">ma</span><span class="op" id="5379249">)</span>&nbsp;<span class="op" id="5379251">/</span>&nbsp;<span class="ident" id="5379253">m</span>&nbsp;<span class="op" id="5379255">&gt;&gt;</span>&nbsp;<span class="num" id="5379258">8</span><span class="op" id="5379259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379264">dst</span><span class="op" id="5379267">.</span><span class="ident" id="5379268">Pix</span><span class="op" id="5379271">[</span><span class="ident" id="5379272">i</span><span class="op" id="5379273">+</span><span class="num" id="5379274">2</span><span class="op" id="5379275">]</span>&nbsp;<span class="op" id="5379277">=</span>&nbsp;<span class="builtintype" id="5379279">uint8</span><span class="op" id="5379284">(</span><span class="op" id="5379285">(</span><span class="ident" id="5379286">db</span><span class="op" id="5379288">*</span><span class="ident" id="5379289">a</span>&nbsp;<span class="op" id="5379291">+</span>&nbsp;<span class="ident" id="5379293">sb</span><span class="op" id="5379295">*</span><span class="ident" id="5379296">ma</span><span class="op" id="5379298">)</span>&nbsp;<span class="op" id="5379300">/</span>&nbsp;<span class="ident" id="5379302">m</span>&nbsp;<span class="op" id="5379304">&gt;&gt;</span>&nbsp;<span class="num" id="5379307">8</span><span class="op" id="5379308">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379313">dst</span><span class="op" id="5379316">.</span><span class="ident" id="5379317">Pix</span><span class="op" id="5379320">[</span><span class="ident" id="5379321">i</span><span class="op" id="5379322">+</span><span class="num" id="5379323">3</span><span class="op" id="5379324">]</span>&nbsp;<span class="op" id="5379326">=</span>&nbsp;<span class="builtintype" id="5379328">uint8</span><span class="op" id="5379333">(</span><span class="op" id="5379334">(</span><span class="ident" id="5379335">da</span><span class="op" id="5379337">*</span><span class="ident" id="5379338">a</span>&nbsp;<span class="op" id="5379340">+</span>&nbsp;<span class="ident" id="5379342">sa</span><span class="op" id="5379344">*</span><span class="ident" id="5379345">ma</span><span class="op" id="5379347">)</span>&nbsp;<span class="op" id="5379349">/</span>&nbsp;<span class="ident" id="5379351">m</span>&nbsp;<span class="op" id="5379353">&gt;&gt;</span>&nbsp;<span class="num" id="5379356">8</span><span class="op" id="5379357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379365">i0</span>&nbsp;<span class="op" id="5379368">+=</span>&nbsp;<span class="ident" id="5379371">dst</span><span class="op" id="5379374">.</span><span class="ident" id="5379375">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379384">i1</span>&nbsp;<span class="op" id="5379387">+=</span>&nbsp;<span class="ident" id="5379390">dst</span><span class="op" id="5379393">.</span><span class="ident" id="5379394">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379403">mi0</span>&nbsp;<span class="op" id="5379407">+=</span>&nbsp;<span class="ident" id="5379410">mask</span><span class="op" id="5379414">.</span><span class="ident" id="5379415">Stride</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379423">}</span><br>
<span class="lineno"></span><span class="op" id="5379425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5379428">func</span>&nbsp;<span class="ident" id="5379433">drawRGBA</span><span class="op" id="5379441">(</span><span class="ident" id="5379442">dst</span>&nbsp;<span class="op" id="5379446">*</span><span class="ident" id="5379447">image</span><span class="op" id="5379452">.</span><span class="ident" id="5379453">RGBA</span><span class="op" id="5379457">,</span>&nbsp;<span class="ident" id="5379459">r</span>&nbsp;<span class="ident" id="5379461">image</span><span class="op" id="5379466">.</span><span class="ident" id="5379467">Rectangle</span><span class="op" id="5379476">,</span>&nbsp;<span class="ident" id="5379478">src</span>&nbsp;<span class="ident" id="5379482">image</span><span class="op" id="5379487">.</span><span class="ident" id="5379488">Image</span><span class="op" id="5379493">,</span>&nbsp;<span class="ident" id="5379495">sp</span>&nbsp;<span class="ident" id="5379498">image</span><span class="op" id="5379503">.</span><span class="ident" id="5379504">Point</span><span class="op" id="5379509">,</span>&nbsp;<span class="ident" id="5379511">mask</span>&nbsp;<span class="ident" id="5379516">image</span><span class="op" id="5379521">.</span><span class="ident" id="5379522">Image</span><span class="op" id="5379527">,</span>&nbsp;<span class="ident" id="5379529">mp</span>&nbsp;<span class="ident" id="5379532">image</span><span class="op" id="5379537">.</span><span class="ident" id="5379538">Point</span><span class="op" id="5379543">,</span>&nbsp;<span class="ident" id="5379545">op</span>&nbsp;<span class="ident" id="5379548">Op</span><span class="op" id="5379550">)</span>&nbsp;<span class="op" id="5379552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379555">x0</span><span class="op" id="5379557">,</span>&nbsp;<span class="ident" id="5379559">x1</span><span class="op" id="5379561">,</span>&nbsp;<span class="ident" id="5379563">dx</span>&nbsp;<span class="op" id="5379566">:=</span>&nbsp;<span class="ident" id="5379569">r</span><span class="op" id="5379570">.</span><span class="ident" id="5379571">Min</span><span class="op" id="5379574">.</span><span class="ident" id="5379575">X</span><span class="op" id="5379576">,</span>&nbsp;<span class="ident" id="5379578">r</span><span class="op" id="5379579">.</span><span class="ident" id="5379580">Max</span><span class="op" id="5379583">.</span><span class="ident" id="5379584">X</span><span class="op" id="5379585">,</span>&nbsp;<span class="num" id="5379587">1</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379590">y0</span><span class="op" id="5379592">,</span>&nbsp;<span class="ident" id="5379594">y1</span><span class="op" id="5379596">,</span>&nbsp;<span class="ident" id="5379598">dy</span>&nbsp;<span class="op" id="5379601">:=</span>&nbsp;<span class="ident" id="5379604">r</span><span class="op" id="5379605">.</span><span class="ident" id="5379606">Min</span><span class="op" id="5379609">.</span><span class="ident" id="5379610">Y</span><span class="op" id="5379611">,</span>&nbsp;<span class="ident" id="5379613">r</span><span class="op" id="5379614">.</span><span class="ident" id="5379615">Max</span><span class="op" id="5379618">.</span><span class="ident" id="5379619">Y</span><span class="op" id="5379620">,</span>&nbsp;<span class="num" id="5379622">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379625">if</span>&nbsp;<span class="ident" id="5379628">image</span><span class="op" id="5379633">.</span><span class="ident" id="5379634">Image</span><span class="op" id="5379639">(</span><span class="ident" id="5379640">dst</span><span class="op" id="5379643">)</span>&nbsp;<span class="op" id="5379645">==</span>&nbsp;<span class="ident" id="5379648">src</span>&nbsp;<span class="op" id="5379652">&amp;&amp;</span>&nbsp;<span class="ident" id="5379655">r</span><span class="op" id="5379656">.</span><span class="ident" id="5379657">Overlaps</span><span class="op" id="5379665">(</span><span class="ident" id="5379666">r</span><span class="op" id="5379667">.</span><span class="ident" id="5379668">Add</span><span class="op" id="5379671">(</span><span class="ident" id="5379672">sp</span><span class="op" id="5379674">.</span><span class="ident" id="5379675">Sub</span><span class="op" id="5379678">(</span><span class="ident" id="5379679">r</span><span class="op" id="5379680">.</span><span class="ident" id="5379681">Min</span><span class="op" id="5379684">)</span><span class="op" id="5379685">)</span><span class="op" id="5379686">)</span>&nbsp;<span class="op" id="5379688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379692">if</span>&nbsp;<span class="ident" id="5379695">sp</span><span class="op" id="5379697">.</span><span class="ident" id="5379698">Y</span>&nbsp;<span class="op" id="5379700">&lt;</span>&nbsp;<span class="ident" id="5379702">r</span><span class="op" id="5379703">.</span><span class="ident" id="5379704">Min</span><span class="op" id="5379707">.</span><span class="ident" id="5379708">Y</span>&nbsp;<span class="op" id="5379710">||</span>&nbsp;<span class="ident" id="5379713">sp</span><span class="op" id="5379715">.</span><span class="ident" id="5379716">Y</span>&nbsp;<span class="op" id="5379718">==</span>&nbsp;<span class="ident" id="5379721">r</span><span class="op" id="5379722">.</span><span class="ident" id="5379723">Min</span><span class="op" id="5379726">.</span><span class="ident" id="5379727">Y</span>&nbsp;<span class="op" id="5379729">&amp;&amp;</span>&nbsp;<span class="ident" id="5379732">sp</span><span class="op" id="5379734">.</span><span class="ident" id="5379735">X</span>&nbsp;<span class="op" id="5379737">&lt;</span>&nbsp;<span class="ident" id="5379739">r</span><span class="op" id="5379740">.</span><span class="ident" id="5379741">Min</span><span class="op" id="5379744">.</span><span class="ident" id="5379745">X</span>&nbsp;<span class="op" id="5379747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379752">x0</span><span class="op" id="5379754">,</span>&nbsp;<span class="ident" id="5379756">x1</span><span class="op" id="5379758">,</span>&nbsp;<span class="ident" id="5379760">dx</span>&nbsp;<span class="op" id="5379763">=</span>&nbsp;<span class="ident" id="5379765">x1</span><span class="op" id="5379767">-</span><span class="num" id="5379768">1</span><span class="op" id="5379769">,</span>&nbsp;<span class="ident" id="5379771">x0</span><span class="op" id="5379773">-</span><span class="num" id="5379774">1</span><span class="op" id="5379775">,</span>&nbsp;<span class="op" id="5379777">-</span><span class="num" id="5379778">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379783">y0</span><span class="op" id="5379785">,</span>&nbsp;<span class="ident" id="5379787">y1</span><span class="op" id="5379789">,</span>&nbsp;<span class="ident" id="5379791">dy</span>&nbsp;<span class="op" id="5379794">=</span>&nbsp;<span class="ident" id="5379796">y1</span><span class="op" id="5379798">-</span><span class="num" id="5379799">1</span><span class="op" id="5379800">,</span>&nbsp;<span class="ident" id="5379802">y0</span><span class="op" id="5379804">-</span><span class="num" id="5379805">1</span><span class="op" id="5379806">,</span>&nbsp;<span class="op" id="5379808">-</span><span class="num" id="5379809">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5379816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379820">sy</span>&nbsp;<span class="op" id="5379823">:=</span>&nbsp;<span class="ident" id="5379826">sp</span><span class="op" id="5379828">.</span><span class="ident" id="5379829">Y</span>&nbsp;<span class="op" id="5379831">+</span>&nbsp;<span class="ident" id="5379833">y0</span>&nbsp;<span class="op" id="5379836">-</span>&nbsp;<span class="ident" id="5379838">r</span><span class="op" id="5379839">.</span><span class="ident" id="5379840">Min</span><span class="op" id="5379843">.</span><span class="ident" id="5379844">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379847">my</span>&nbsp;<span class="op" id="5379850">:=</span>&nbsp;<span class="ident" id="5379853">mp</span><span class="op" id="5379855">.</span><span class="ident" id="5379856">Y</span>&nbsp;<span class="op" id="5379858">+</span>&nbsp;<span class="ident" id="5379860">y0</span>&nbsp;<span class="op" id="5379863">-</span>&nbsp;<span class="ident" id="5379865">r</span><span class="op" id="5379866">.</span><span class="ident" id="5379867">Min</span><span class="op" id="5379870">.</span><span class="ident" id="5379871">Y</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379874">sx0</span>&nbsp;<span class="op" id="5379878">:=</span>&nbsp;<span class="ident" id="5379881">sp</span><span class="op" id="5379883">.</span><span class="ident" id="5379884">X</span>&nbsp;<span class="op" id="5379886">+</span>&nbsp;<span class="ident" id="5379888">x0</span>&nbsp;<span class="op" id="5379891">-</span>&nbsp;<span class="ident" id="5379893">r</span><span class="op" id="5379894">.</span><span class="ident" id="5379895">Min</span><span class="op" id="5379898">.</span><span class="ident" id="5379899">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379902">mx0</span>&nbsp;<span class="op" id="5379906">:=</span>&nbsp;<span class="ident" id="5379909">mp</span><span class="op" id="5379911">.</span><span class="ident" id="5379912">X</span>&nbsp;<span class="op" id="5379914">+</span>&nbsp;<span class="ident" id="5379916">x0</span>&nbsp;<span class="op" id="5379919">-</span>&nbsp;<span class="ident" id="5379921">r</span><span class="op" id="5379922">.</span><span class="ident" id="5379923">Min</span><span class="op" id="5379926">.</span><span class="ident" id="5379927">X</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379930">sx1</span>&nbsp;<span class="op" id="5379934">:=</span>&nbsp;<span class="ident" id="5379937">sx0</span>&nbsp;<span class="op" id="5379941">+</span>&nbsp;<span class="op" id="5379943">(</span><span class="ident" id="5379944">x1</span>&nbsp;<span class="op" id="5379947">-</span>&nbsp;<span class="ident" id="5379949">x0</span><span class="op" id="5379951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379954">i0</span>&nbsp;<span class="op" id="5379957">:=</span>&nbsp;<span class="ident" id="5379960">dst</span><span class="op" id="5379963">.</span><span class="ident" id="5379964">PixOffset</span><span class="op" id="5379973">(</span><span class="ident" id="5379974">x0</span><span class="op" id="5379976">,</span>&nbsp;<span class="ident" id="5379978">y0</span><span class="op" id="5379980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5379983">di</span>&nbsp;<span class="op" id="5379986">:=</span>&nbsp;<span class="ident" id="5379989">dx</span>&nbsp;<span class="op" id="5379992">*</span>&nbsp;<span class="num" id="5379994">4</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5379997">for</span>&nbsp;<span class="ident" id="5380001">y</span>&nbsp;<span class="op" id="5380003">:=</span>&nbsp;<span class="ident" id="5380006">y0</span><span class="op" id="5380008">;</span>&nbsp;<span class="ident" id="5380010">y</span>&nbsp;<span class="op" id="5380012">!=</span>&nbsp;<span class="ident" id="5380015">y1</span><span class="op" id="5380017">;</span>&nbsp;<span class="ident" id="5380019">y</span><span class="op" id="5380020">,</span>&nbsp;<span class="ident" id="5380022">sy</span><span class="op" id="5380024">,</span>&nbsp;<span class="ident" id="5380026">my</span>&nbsp;<span class="op" id="5380029">=</span>&nbsp;<span class="ident" id="5380031">y</span><span class="op" id="5380032">+</span><span class="ident" id="5380033">dy</span><span class="op" id="5380035">,</span>&nbsp;<span class="ident" id="5380037">sy</span><span class="op" id="5380039">+</span><span class="ident" id="5380040">dy</span><span class="op" id="5380042">,</span>&nbsp;<span class="ident" id="5380044">my</span><span class="op" id="5380046">+</span><span class="ident" id="5380047">dy</span>&nbsp;<span class="op" id="5380050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380054">for</span>&nbsp;<span class="ident" id="5380058">i</span><span class="op" id="5380059">,</span>&nbsp;<span class="ident" id="5380061">sx</span><span class="op" id="5380063">,</span>&nbsp;<span class="ident" id="5380065">mx</span>&nbsp;<span class="op" id="5380068">:=</span>&nbsp;<span class="ident" id="5380071">i0</span><span class="op" id="5380073">,</span>&nbsp;<span class="ident" id="5380075">sx0</span><span class="op" id="5380078">,</span>&nbsp;<span class="ident" id="5380080">mx0</span><span class="op" id="5380083">;</span>&nbsp;<span class="ident" id="5380085">sx</span>&nbsp;<span class="op" id="5380088">!=</span>&nbsp;<span class="ident" id="5380091">sx1</span><span class="op" id="5380094">;</span>&nbsp;<span class="ident" id="5380096">i</span><span class="op" id="5380097">,</span>&nbsp;<span class="ident" id="5380099">sx</span><span class="op" id="5380101">,</span>&nbsp;<span class="ident" id="5380103">mx</span>&nbsp;<span class="op" id="5380106">=</span>&nbsp;<span class="ident" id="5380108">i</span><span class="op" id="5380109">+</span><span class="ident" id="5380110">di</span><span class="op" id="5380112">,</span>&nbsp;<span class="ident" id="5380114">sx</span><span class="op" id="5380116">+</span><span class="ident" id="5380117">dx</span><span class="op" id="5380119">,</span>&nbsp;<span class="ident" id="5380121">mx</span><span class="op" id="5380123">+</span><span class="ident" id="5380124">dx</span>&nbsp;<span class="op" id="5380127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380132">ma</span>&nbsp;<span class="op" id="5380135">:=</span>&nbsp;<span class="builtintype" id="5380138">uint32</span><span class="op" id="5380144">(</span><span class="ident" id="5380145">m</span><span class="op" id="5380146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380151">if</span>&nbsp;<span class="ident" id="5380154">mask</span>&nbsp;<span class="op" id="5380159">!=</span>&nbsp;<span class="ident" id="5380162">nil</span>&nbsp;<span class="op" id="5380166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380172">_</span><span class="op" id="5380173">,</span>&nbsp;<span class="ident" id="5380175">_</span><span class="op" id="5380176">,</span>&nbsp;<span class="ident" id="5380178">_</span><span class="op" id="5380179">,</span>&nbsp;<span class="ident" id="5380181">ma</span>&nbsp;<span class="op" id="5380184">=</span>&nbsp;<span class="ident" id="5380186">mask</span><span class="op" id="5380190">.</span><span class="ident" id="5380191">At</span><span class="op" id="5380193">(</span><span class="ident" id="5380194">mx</span><span class="op" id="5380196">,</span>&nbsp;<span class="ident" id="5380198">my</span><span class="op" id="5380200">)</span><span class="op" id="5380201">.</span><span class="ident" id="5380202">RGBA</span><span class="op" id="5380206">(</span><span class="op" id="5380207">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5380212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380217">sr</span><span class="op" id="5380219">,</span>&nbsp;<span class="ident" id="5380221">sg</span><span class="op" id="5380223">,</span>&nbsp;<span class="ident" id="5380225">sb</span><span class="op" id="5380227">,</span>&nbsp;<span class="ident" id="5380229">sa</span>&nbsp;<span class="op" id="5380232">:=</span>&nbsp;<span class="ident" id="5380235">src</span><span class="op" id="5380238">.</span><span class="ident" id="5380239">At</span><span class="op" id="5380241">(</span><span class="ident" id="5380242">sx</span><span class="op" id="5380244">,</span>&nbsp;<span class="ident" id="5380246">sy</span><span class="op" id="5380248">)</span><span class="op" id="5380249">.</span><span class="ident" id="5380250">RGBA</span><span class="op" id="5380254">(</span><span class="op" id="5380255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5380260">if</span>&nbsp;<span class="ident" id="5380263">op</span>&nbsp;<span class="op" id="5380266">==</span>&nbsp;<span class="ident" id="5380269">Over</span>&nbsp;<span class="op" id="5380274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380280">dr</span>&nbsp;<span class="op" id="5380283">:=</span>&nbsp;<span class="builtintype" id="5380286">uint32</span><span class="op" id="5380292">(</span><span class="ident" id="5380293">dst</span><span class="op" id="5380296">.</span><span class="ident" id="5380297">Pix</span><span class="op" id="5380300">[</span><span class="ident" id="5380301">i</span><span class="op" id="5380302">+</span><span class="num" id="5380303">0</span><span class="op" id="5380304">]</span><span class="op" id="5380305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380311">dg</span>&nbsp;<span class="op" id="5380314">:=</span>&nbsp;<span class="builtintype" id="5380317">uint32</span><span class="op" id="5380323">(</span><span class="ident" id="5380324">dst</span><span class="op" id="5380327">.</span><span class="ident" id="5380328">Pix</span><span class="op" id="5380331">[</span><span class="ident" id="5380332">i</span><span class="op" id="5380333">+</span><span class="num" id="5380334">1</span><span class="op" id="5380335">]</span><span class="op" id="5380336">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380342">db</span>&nbsp;<span class="op" id="5380345">:=</span>&nbsp;<span class="builtintype" id="5380348">uint32</span><span class="op" id="5380354">(</span><span class="ident" id="5380355">dst</span><span class="op" id="5380358">.</span><span class="ident" id="5380359">Pix</span><span class="op" id="5380362">[</span><span class="ident" id="5380363">i</span><span class="op" id="5380364">+</span><span class="num" id="5380365">2</span><span class="op" id="5380366">]</span><span class="op" id="5380367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380373">da</span>&nbsp;<span class="op" id="5380376">:=</span>&nbsp;<span class="builtintype" id="5380379">uint32</span><span class="op" id="5380385">(</span><span class="ident" id="5380386">dst</span><span class="op" id="5380389">.</span><span class="ident" id="5380390">Pix</span><span class="op" id="5380393">[</span><span class="ident" id="5380394">i</span><span class="op" id="5380395">+</span><span class="num" id="5380396">3</span><span class="op" id="5380397">]</span><span class="op" id="5380398">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380405">//&nbsp;dr,&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da&nbsp;are&nbsp;all&nbsp;8-bit&nbsp;color&nbsp;at&nbsp;the&nbsp;moment,&nbsp;ranging&nbsp;in&nbsp;[0,255].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380485">//&nbsp;We&nbsp;work&nbsp;in&nbsp;16-bit&nbsp;color,&nbsp;and&nbsp;so&nbsp;would&nbsp;normally&nbsp;do:</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380543">//&nbsp;dr&nbsp;|=&nbsp;dr&nbsp;&lt;&lt;&nbsp;8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380564">//&nbsp;and&nbsp;similarly&nbsp;for&nbsp;dg,&nbsp;db&nbsp;and&nbsp;da,&nbsp;but&nbsp;instead&nbsp;we&nbsp;multiply&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380630">//&nbsp;(which&nbsp;is&nbsp;a&nbsp;16-bit&nbsp;color,&nbsp;ranging&nbsp;in&nbsp;[0,65535])&nbsp;by&nbsp;0x101.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5380695">//&nbsp;This&nbsp;yields&nbsp;the&nbsp;same&nbsp;result,&nbsp;but&nbsp;is&nbsp;fewer&nbsp;arithmetic&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380767">a</span>&nbsp;<span class="op" id="5380769">:=</span>&nbsp;<span class="op" id="5380772">(</span><span class="ident" id="5380773">m</span>&nbsp;<span class="op" id="5380775">-</span>&nbsp;<span class="op" id="5380777">(</span><span class="ident" id="5380778">sa</span>&nbsp;<span class="op" id="5380781">*</span>&nbsp;<span class="ident" id="5380783">ma</span>&nbsp;<span class="op" id="5380786">/</span>&nbsp;<span class="ident" id="5380788">m</span><span class="op" id="5380789">)</span><span class="op" id="5380790">)</span>&nbsp;<span class="op" id="5380792">*</span>&nbsp;<span class="num" id="5380794">0x101</span><br>
<span class="lineno">530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380805">dst</span><span class="op" id="5380808">.</span><span class="ident" id="5380809">Pix</span><span class="op" id="5380812">[</span><span class="ident" id="5380813">i</span><span class="op" id="5380814">+</span><span class="num" id="5380815">0</span><span class="op" id="5380816">]</span>&nbsp;<span class="op" id="5380818">=</span>&nbsp;<span class="builtintype" id="5380820">uint8</span><span class="op" id="5380825">(</span><span class="op" id="5380826">(</span><span class="ident" id="5380827">dr</span><span class="op" id="5380829">*</span><span class="ident" id="5380830">a</span>&nbsp;<span class="op" id="5380832">+</span>&nbsp;<span class="ident" id="5380834">sr</span><span class="op" id="5380836">*</span><span class="ident" id="5380837">ma</span><span class="op" id="5380839">)</span>&nbsp;<span class="op" id="5380841">/</span>&nbsp;<span class="ident" id="5380843">m</span>&nbsp;<span class="op" id="5380845">&gt;&gt;</span>&nbsp;<span class="num" id="5380848">8</span><span class="op" id="5380849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380855">dst</span><span class="op" id="5380858">.</span><span class="ident" id="5380859">Pix</span><span class="op" id="5380862">[</span><span class="ident" id="5380863">i</span><span class="op" id="5380864">+</span><span class="num" id="5380865">1</span><span class="op" id="5380866">]</span>&nbsp;<span class="op" id="5380868">=</span>&nbsp;<span class="builtintype" id="5380870">uint8</span><span class="op" id="5380875">(</span><span class="op" id="5380876">(</span><span class="ident" id="5380877">dg</span><span class="op" id="5380879">*</span><span class="ident" id="5380880">a</span>&nbsp;<span class="op" id="5380882">+</span>&nbsp;<span class="ident" id="5380884">sg</span><span class="op" id="5380886">*</span><span class="ident" id="5380887">ma</span><span class="op" id="5380889">)</span>&nbsp;<span class="op" id="5380891">/</span>&nbsp;<span class="ident" id="5380893">m</span>&nbsp;<span class="op" id="5380895">&gt;&gt;</span>&nbsp;<span class="num" id="5380898">8</span><span class="op" id="5380899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380905">dst</span><span class="op" id="5380908">.</span><span class="ident" id="5380909">Pix</span><span class="op" id="5380912">[</span><span class="ident" id="5380913">i</span><span class="op" id="5380914">+</span><span class="num" id="5380915">2</span><span class="op" id="5380916">]</span>&nbsp;<span class="op" id="5380918">=</span>&nbsp;<span class="builtintype" id="5380920">uint8</span><span class="op" id="5380925">(</span><span class="op" id="5380926">(</span><span class="ident" id="5380927">db</span><span class="op" id="5380929">*</span><span class="ident" id="5380930">a</span>&nbsp;<span class="op" id="5380932">+</span>&nbsp;<span class="ident" id="5380934">sb</span><span class="op" id="5380936">*</span><span class="ident" id="5380937">ma</span><span class="op" id="5380939">)</span>&nbsp;<span class="op" id="5380941">/</span>&nbsp;<span class="ident" id="5380943">m</span>&nbsp;<span class="op" id="5380945">&gt;&gt;</span>&nbsp;<span class="num" id="5380948">8</span><span class="op" id="5380949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5380955">dst</span><span class="op" id="5380958">.</span><span class="ident" id="5380959">Pix</span><span class="op" id="5380962">[</span><span class="ident" id="5380963">i</span><span class="op" id="5380964">+</span><span class="num" id="5380965">3</span><span class="op" id="5380966">]</span>&nbsp;<span class="op" id="5380968">=</span>&nbsp;<span class="builtintype" id="5380970">uint8</span><span class="op" id="5380975">(</span><span class="op" id="5380976">(</span><span class="ident" id="5380977">da</span><span class="op" id="5380979">*</span><span class="ident" id="5380980">a</span>&nbsp;<span class="op" id="5380982">+</span>&nbsp;<span class="ident" id="5380984">sa</span><span class="op" id="5380986">*</span><span class="ident" id="5380987">ma</span><span class="op" id="5380989">)</span>&nbsp;<span class="op" id="5380991">/</span>&nbsp;<span class="ident" id="5380993">m</span>&nbsp;<span class="op" id="5380995">&gt;&gt;</span>&nbsp;<span class="num" id="5380998">8</span><span class="op" id="5380999">)</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381005">}</span>&nbsp;<span class="keyword" id="5381007">else</span>&nbsp;<span class="op" id="5381012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381018">dst</span><span class="op" id="5381021">.</span><span class="ident" id="5381022">Pix</span><span class="op" id="5381025">[</span><span class="ident" id="5381026">i</span><span class="op" id="5381027">+</span><span class="num" id="5381028">0</span><span class="op" id="5381029">]</span>&nbsp;<span class="op" id="5381031">=</span>&nbsp;<span class="builtintype" id="5381033">uint8</span><span class="op" id="5381038">(</span><span class="ident" id="5381039">sr</span>&nbsp;<span class="op" id="5381042">*</span>&nbsp;<span class="ident" id="5381044">ma</span>&nbsp;<span class="op" id="5381047">/</span>&nbsp;<span class="ident" id="5381049">m</span>&nbsp;<span class="op" id="5381051">&gt;&gt;</span>&nbsp;<span class="num" id="5381054">8</span><span class="op" id="5381055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381061">dst</span><span class="op" id="5381064">.</span><span class="ident" id="5381065">Pix</span><span class="op" id="5381068">[</span><span class="ident" id="5381069">i</span><span class="op" id="5381070">+</span><span class="num" id="5381071">1</span><span class="op" id="5381072">]</span>&nbsp;<span class="op" id="5381074">=</span>&nbsp;<span class="builtintype" id="5381076">uint8</span><span class="op" id="5381081">(</span><span class="ident" id="5381082">sg</span>&nbsp;<span class="op" id="5381085">*</span>&nbsp;<span class="ident" id="5381087">ma</span>&nbsp;<span class="op" id="5381090">/</span>&nbsp;<span class="ident" id="5381092">m</span>&nbsp;<span class="op" id="5381094">&gt;&gt;</span>&nbsp;<span class="num" id="5381097">8</span><span class="op" id="5381098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381104">dst</span><span class="op" id="5381107">.</span><span class="ident" id="5381108">Pix</span><span class="op" id="5381111">[</span><span class="ident" id="5381112">i</span><span class="op" id="5381113">+</span><span class="num" id="5381114">2</span><span class="op" id="5381115">]</span>&nbsp;<span class="op" id="5381117">=</span>&nbsp;<span class="builtintype" id="5381119">uint8</span><span class="op" id="5381124">(</span><span class="ident" id="5381125">sb</span>&nbsp;<span class="op" id="5381128">*</span>&nbsp;<span class="ident" id="5381130">ma</span>&nbsp;<span class="op" id="5381133">/</span>&nbsp;<span class="ident" id="5381135">m</span>&nbsp;<span class="op" id="5381137">&gt;&gt;</span>&nbsp;<span class="num" id="5381140">8</span><span class="op" id="5381141">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381147">dst</span><span class="op" id="5381150">.</span><span class="ident" id="5381151">Pix</span><span class="op" id="5381154">[</span><span class="ident" id="5381155">i</span><span class="op" id="5381156">+</span><span class="num" id="5381157">3</span><span class="op" id="5381158">]</span>&nbsp;<span class="op" id="5381160">=</span>&nbsp;<span class="builtintype" id="5381162">uint8</span><span class="op" id="5381167">(</span><span class="ident" id="5381168">sa</span>&nbsp;<span class="op" id="5381171">*</span>&nbsp;<span class="ident" id="5381173">ma</span>&nbsp;<span class="op" id="5381176">/</span>&nbsp;<span class="ident" id="5381178">m</span>&nbsp;<span class="op" id="5381180">&gt;&gt;</span>&nbsp;<span class="num" id="5381183">8</span><span class="op" id="5381184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381197">i0</span>&nbsp;<span class="op" id="5381200">+=</span>&nbsp;<span class="ident" id="5381203">dy</span>&nbsp;<span class="op" id="5381206">*</span>&nbsp;<span class="ident" id="5381208">dst</span><span class="op" id="5381211">.</span><span class="ident" id="5381212">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381220">}</span><br>
<span class="lineno">545</span><span class="op" id="5381222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5381225">//&nbsp;clamp&nbsp;clamps&nbsp;i&nbsp;to&nbsp;the&nbsp;interval&nbsp;[0,&nbsp;0xffff].</span><br>
<span class="lineno"></span><span class="keyword" id="5381272">func</span>&nbsp;<span class="ident" id="5381277">clamp</span><span class="op" id="5381282">(</span><span class="ident" id="5381283">i</span>&nbsp;<span class="builtintype" id="5381285">int32</span><span class="op" id="5381290">)</span>&nbsp;<span class="builtintype" id="5381292">int32</span>&nbsp;<span class="op" id="5381298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381301">if</span>&nbsp;<span class="ident" id="5381304">i</span>&nbsp;<span class="op" id="5381306">&lt;</span>&nbsp;<span class="num" id="5381308">0</span>&nbsp;<span class="op" id="5381310">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381314">return</span>&nbsp;<span class="num" id="5381321">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381324">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381327">if</span>&nbsp;<span class="ident" id="5381330">i</span>&nbsp;<span class="op" id="5381332">&gt;</span>&nbsp;<span class="num" id="5381334">0xffff</span>&nbsp;<span class="op" id="5381341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381345">return</span>&nbsp;<span class="num" id="5381352">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5381360">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381363">return</span>&nbsp;<span class="ident" id="5381370">i</span><br>
<span class="lineno"></span><span class="op" id="5381372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5381375">func</span>&nbsp;<span class="ident" id="5381380">drawPaletted</span><span class="op" id="5381392">(</span><span class="ident" id="5381393">dst</span>&nbsp;<span class="ident" id="5381397">Image</span><span class="op" id="5381402">,</span>&nbsp;<span class="ident" id="5381404">r</span>&nbsp;<span class="ident" id="5381406">image</span><span class="op" id="5381411">.</span><span class="ident" id="5381412">Rectangle</span><span class="op" id="5381421">,</span>&nbsp;<span class="ident" id="5381423">src</span>&nbsp;<span class="ident" id="5381427">image</span><span class="op" id="5381432">.</span><span class="ident" id="5381433">Image</span><span class="op" id="5381438">,</span>&nbsp;<span class="ident" id="5381440">sp</span>&nbsp;<span class="ident" id="5381443">image</span><span class="op" id="5381448">.</span><span class="ident" id="5381449">Point</span><span class="op" id="5381454">,</span>&nbsp;<span class="ident" id="5381456">floydSteinberg</span>&nbsp;<span class="builtintype" id="5381471">bool</span><span class="op" id="5381475">)</span>&nbsp;<span class="op" id="5381477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381480">//&nbsp;TODO(nigeltao):&nbsp;handle&nbsp;the&nbsp;case&nbsp;where&nbsp;the&nbsp;dst&nbsp;and&nbsp;src&nbsp;overlap.</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381547">//&nbsp;Does&nbsp;it&nbsp;even&nbsp;make&nbsp;sense&nbsp;to&nbsp;try&nbsp;and&nbsp;do&nbsp;Floyd-Steinberg&nbsp;whilst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381612">//&nbsp;walking&nbsp;the&nbsp;image&nbsp;backward&nbsp;(right-to-left&nbsp;bottom-to-top)?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381675">//&nbsp;If&nbsp;dst&nbsp;is&nbsp;an&nbsp;*image.Paletted,&nbsp;we&nbsp;have&nbsp;a&nbsp;fast&nbsp;path&nbsp;for&nbsp;dst.Set&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381745">//&nbsp;dst.At.&nbsp;The&nbsp;dst.Set&nbsp;equivalent&nbsp;is&nbsp;a&nbsp;batch&nbsp;version&nbsp;of&nbsp;the&nbsp;algorithm</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381816">//&nbsp;used&nbsp;by&nbsp;color.Palette&#39;s&nbsp;Index&nbsp;method&nbsp;in&nbsp;image/color/color.go,&nbsp;plus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5381887">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error&nbsp;diffusion.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5381933">palette</span><span class="op" id="5381940">,</span>&nbsp;<span class="ident" id="5381942">pix</span><span class="op" id="5381945">,</span>&nbsp;<span class="ident" id="5381947">stride</span>&nbsp;<span class="op" id="5381954">:=</span>&nbsp;<span class="op" id="5381957">[</span><span class="op" id="5381958">]</span><span class="op" id="5381959">[</span><span class="num" id="5381960">3</span><span class="op" id="5381961">]</span><span class="builtintype" id="5381962">int32</span><span class="op" id="5381967">(</span><span class="ident" id="5381968">nil</span><span class="op" id="5381971">)</span><span class="op" id="5381972">,</span>&nbsp;<span class="op" id="5381974">[</span><span class="op" id="5381975">]</span><span class="builtintype" id="5381976">byte</span><span class="op" id="5381980">(</span><span class="ident" id="5381981">nil</span><span class="op" id="5381984">)</span><span class="op" id="5381985">,</span>&nbsp;<span class="num" id="5381987">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5381990">if</span>&nbsp;<span class="ident" id="5381993">p</span><span class="op" id="5381994">,</span>&nbsp;<span class="ident" id="5381996">ok</span>&nbsp;<span class="op" id="5381999">:=</span>&nbsp;<span class="ident" id="5382002">dst</span><span class="op" id="5382005">.</span><span class="op" id="5382006">(</span><span class="op" id="5382007">*</span><span class="ident" id="5382008">image</span><span class="op" id="5382013">.</span><span class="ident" id="5382014">Paletted</span><span class="op" id="5382022">)</span><span class="op" id="5382023">;</span>&nbsp;<span class="ident" id="5382025">ok</span>&nbsp;<span class="op" id="5382028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382032">palette</span>&nbsp;<span class="op" id="5382040">=</span>&nbsp;<span class="builtinfunc" id="5382042">make</span><span class="op" id="5382046">(</span><span class="op" id="5382047">[</span><span class="op" id="5382048">]</span><span class="op" id="5382049">[</span><span class="num" id="5382050">3</span><span class="op" id="5382051">]</span><span class="builtintype" id="5382052">int32</span><span class="op" id="5382057">,</span>&nbsp;<span class="builtinfunc" id="5382059">len</span><span class="op" id="5382062">(</span><span class="ident" id="5382063">p</span><span class="op" id="5382064">.</span><span class="ident" id="5382065">Palette</span><span class="op" id="5382072">)</span><span class="op" id="5382073">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382077">for</span>&nbsp;<span class="ident" id="5382081">i</span><span class="op" id="5382082">,</span>&nbsp;<span class="ident" id="5382084">col</span>&nbsp;<span class="op" id="5382088">:=</span>&nbsp;<span class="keyword" id="5382091">range</span>&nbsp;<span class="ident" id="5382097">p</span><span class="op" id="5382098">.</span><span class="ident" id="5382099">Palette</span>&nbsp;<span class="op" id="5382107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382112">r</span><span class="op" id="5382113">,</span>&nbsp;<span class="ident" id="5382115">g</span><span class="op" id="5382116">,</span>&nbsp;<span class="ident" id="5382118">b</span><span class="op" id="5382119">,</span>&nbsp;<span class="ident" id="5382121">_</span>&nbsp;<span class="op" id="5382123">:=</span>&nbsp;<span class="ident" id="5382126">col</span><span class="op" id="5382129">.</span><span class="ident" id="5382130">RGBA</span><span class="op" id="5382134">(</span><span class="op" id="5382135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382140">palette</span><span class="op" id="5382147">[</span><span class="ident" id="5382148">i</span><span class="op" id="5382149">]</span><span class="op" id="5382150">[</span><span class="num" id="5382151">0</span><span class="op" id="5382152">]</span>&nbsp;<span class="op" id="5382154">=</span>&nbsp;<span class="builtintype" id="5382156">int32</span><span class="op" id="5382161">(</span><span class="ident" id="5382162">r</span><span class="op" id="5382163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382168">palette</span><span class="op" id="5382175">[</span><span class="ident" id="5382176">i</span><span class="op" id="5382177">]</span><span class="op" id="5382178">[</span><span class="num" id="5382179">1</span><span class="op" id="5382180">]</span>&nbsp;<span class="op" id="5382182">=</span>&nbsp;<span class="builtintype" id="5382184">int32</span><span class="op" id="5382189">(</span><span class="ident" id="5382190">g</span><span class="op" id="5382191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382196">palette</span><span class="op" id="5382203">[</span><span class="ident" id="5382204">i</span><span class="op" id="5382205">]</span><span class="op" id="5382206">[</span><span class="num" id="5382207">2</span><span class="op" id="5382208">]</span>&nbsp;<span class="op" id="5382210">=</span>&nbsp;<span class="builtintype" id="5382212">int32</span><span class="op" id="5382217">(</span><span class="ident" id="5382218">b</span><span class="op" id="5382219">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382227">pix</span><span class="op" id="5382230">,</span>&nbsp;<span class="ident" id="5382232">stride</span>&nbsp;<span class="op" id="5382239">=</span>&nbsp;<span class="ident" id="5382241">p</span><span class="op" id="5382242">.</span><span class="ident" id="5382243">Pix</span><span class="op" id="5382246">[</span><span class="ident" id="5382247">p</span><span class="op" id="5382248">.</span><span class="ident" id="5382249">PixOffset</span><span class="op" id="5382258">(</span><span class="ident" id="5382259">r</span><span class="op" id="5382260">.</span><span class="ident" id="5382261">Min</span><span class="op" id="5382264">.</span><span class="ident" id="5382265">X</span><span class="op" id="5382266">,</span>&nbsp;<span class="ident" id="5382268">r</span><span class="op" id="5382269">.</span><span class="ident" id="5382270">Min</span><span class="op" id="5382273">.</span><span class="ident" id="5382274">Y</span><span class="op" id="5382275">)</span><span class="op" id="5382276">:</span><span class="op" id="5382277">]</span><span class="op" id="5382278">,</span>&nbsp;<span class="ident" id="5382280">p</span><span class="op" id="5382281">.</span><span class="ident" id="5382282">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382294">//&nbsp;quantErrorCurr&nbsp;and&nbsp;quantErrorNext&nbsp;are&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382369">//&nbsp;errors&nbsp;that&nbsp;have&nbsp;been&nbsp;propagated&nbsp;to&nbsp;the&nbsp;pixels&nbsp;in&nbsp;the&nbsp;current&nbsp;and&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382444">//&nbsp;rows.&nbsp;The&nbsp;+2&nbsp;simplifies&nbsp;calculation&nbsp;near&nbsp;the&nbsp;edges.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382500">var</span>&nbsp;<span class="ident" id="5382504">quantErrorCurr</span><span class="op" id="5382518">,</span>&nbsp;<span class="ident" id="5382520">quantErrorNext</span>&nbsp;<span class="op" id="5382535">[</span><span class="op" id="5382536">]</span><span class="op" id="5382537">[</span><span class="num" id="5382538">3</span><span class="op" id="5382539">]</span><span class="builtintype" id="5382540">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382547">if</span>&nbsp;<span class="ident" id="5382550">floydSteinberg</span>&nbsp;<span class="op" id="5382565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382569">quantErrorCurr</span>&nbsp;<span class="op" id="5382584">=</span>&nbsp;<span class="builtinfunc" id="5382586">make</span><span class="op" id="5382590">(</span><span class="op" id="5382591">[</span><span class="op" id="5382592">]</span><span class="op" id="5382593">[</span><span class="num" id="5382594">3</span><span class="op" id="5382595">]</span><span class="builtintype" id="5382596">int32</span><span class="op" id="5382601">,</span>&nbsp;<span class="ident" id="5382603">r</span><span class="op" id="5382604">.</span><span class="ident" id="5382605">Dx</span><span class="op" id="5382607">(</span><span class="op" id="5382608">)</span><span class="op" id="5382609">+</span><span class="num" id="5382610">2</span><span class="op" id="5382611">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382615">quantErrorNext</span>&nbsp;<span class="op" id="5382630">=</span>&nbsp;<span class="builtinfunc" id="5382632">make</span><span class="op" id="5382636">(</span><span class="op" id="5382637">[</span><span class="op" id="5382638">]</span><span class="op" id="5382639">[</span><span class="num" id="5382640">3</span><span class="op" id="5382641">]</span><span class="builtintype" id="5382642">int32</span><span class="op" id="5382647">,</span>&nbsp;<span class="ident" id="5382649">r</span><span class="op" id="5382650">.</span><span class="ident" id="5382651">Dx</span><span class="op" id="5382653">(</span><span class="op" id="5382654">)</span><span class="op" id="5382655">+</span><span class="num" id="5382656">2</span><span class="op" id="5382657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5382660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382664">//&nbsp;Loop&nbsp;over&nbsp;each&nbsp;source&nbsp;pixel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382697">out</span>&nbsp;<span class="op" id="5382701">:=</span>&nbsp;<span class="ident" id="5382704">color</span><span class="op" id="5382709">.</span><span class="ident" id="5382710">RGBA64</span><span class="op" id="5382716">{</span><span class="ident" id="5382717">A</span><span class="op" id="5382718">:</span>&nbsp;<span class="num" id="5382720">0xffff</span><span class="op" id="5382726">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382729">for</span>&nbsp;<span class="ident" id="5382733">y</span>&nbsp;<span class="op" id="5382735">:=</span>&nbsp;<span class="num" id="5382738">0</span><span class="op" id="5382739">;</span>&nbsp;<span class="ident" id="5382741">y</span>&nbsp;<span class="op" id="5382743">!=</span>&nbsp;<span class="ident" id="5382746">r</span><span class="op" id="5382747">.</span><span class="ident" id="5382748">Dy</span><span class="op" id="5382750">(</span><span class="op" id="5382751">)</span><span class="op" id="5382752">;</span>&nbsp;<span class="ident" id="5382754">y</span><span class="op" id="5382755">++</span>&nbsp;<span class="op" id="5382758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382762">for</span>&nbsp;<span class="ident" id="5382766">x</span>&nbsp;<span class="op" id="5382768">:=</span>&nbsp;<span class="num" id="5382771">0</span><span class="op" id="5382772">;</span>&nbsp;<span class="ident" id="5382774">x</span>&nbsp;<span class="op" id="5382776">!=</span>&nbsp;<span class="ident" id="5382779">r</span><span class="op" id="5382780">.</span><span class="ident" id="5382781">Dx</span><span class="op" id="5382783">(</span><span class="op" id="5382784">)</span><span class="op" id="5382785">;</span>&nbsp;<span class="ident" id="5382787">x</span><span class="op" id="5382788">++</span>&nbsp;<span class="op" id="5382791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382796">//&nbsp;er,&nbsp;eg&nbsp;and&nbsp;eb&nbsp;are&nbsp;the&nbsp;pixel&#39;s&nbsp;R,G,B&nbsp;values&nbsp;plus&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5382854">//&nbsp;optional&nbsp;Floyd-Steinberg&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382892">sr</span><span class="op" id="5382894">,</span>&nbsp;<span class="ident" id="5382896">sg</span><span class="op" id="5382898">,</span>&nbsp;<span class="ident" id="5382900">sb</span><span class="op" id="5382902">,</span>&nbsp;<span class="ident" id="5382904">_</span>&nbsp;<span class="op" id="5382906">:=</span>&nbsp;<span class="ident" id="5382909">src</span><span class="op" id="5382912">.</span><span class="ident" id="5382913">At</span><span class="op" id="5382915">(</span><span class="ident" id="5382916">sp</span><span class="op" id="5382918">.</span><span class="ident" id="5382919">X</span><span class="op" id="5382920">+</span><span class="ident" id="5382921">x</span><span class="op" id="5382922">,</span>&nbsp;<span class="ident" id="5382924">sp</span><span class="op" id="5382926">.</span><span class="ident" id="5382927">Y</span><span class="op" id="5382928">+</span><span class="ident" id="5382929">y</span><span class="op" id="5382930">)</span><span class="op" id="5382931">.</span><span class="ident" id="5382932">RGBA</span><span class="op" id="5382936">(</span><span class="op" id="5382937">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5382942">er</span><span class="op" id="5382944">,</span>&nbsp;<span class="ident" id="5382946">eg</span><span class="op" id="5382948">,</span>&nbsp;<span class="ident" id="5382950">eb</span>&nbsp;<span class="op" id="5382953">:=</span>&nbsp;<span class="builtintype" id="5382956">int32</span><span class="op" id="5382961">(</span><span class="ident" id="5382962">sr</span><span class="op" id="5382964">)</span><span class="op" id="5382965">,</span>&nbsp;<span class="builtintype" id="5382967">int32</span><span class="op" id="5382972">(</span><span class="ident" id="5382973">sg</span><span class="op" id="5382975">)</span><span class="op" id="5382976">,</span>&nbsp;<span class="builtintype" id="5382978">int32</span><span class="op" id="5382983">(</span><span class="ident" id="5382984">sb</span><span class="op" id="5382986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5382991">if</span>&nbsp;<span class="ident" id="5382994">floydSteinberg</span>&nbsp;<span class="op" id="5383009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383015">er</span>&nbsp;<span class="op" id="5383018">=</span>&nbsp;<span class="ident" id="5383020">clamp</span><span class="op" id="5383025">(</span><span class="ident" id="5383026">er</span>&nbsp;<span class="op" id="5383029">+</span>&nbsp;<span class="ident" id="5383031">quantErrorCurr</span><span class="op" id="5383045">[</span><span class="ident" id="5383046">x</span><span class="op" id="5383047">+</span><span class="num" id="5383048">1</span><span class="op" id="5383049">]</span><span class="op" id="5383050">[</span><span class="num" id="5383051">0</span><span class="op" id="5383052">]</span><span class="op" id="5383053">/</span><span class="num" id="5383054">16</span><span class="op" id="5383056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383062">eg</span>&nbsp;<span class="op" id="5383065">=</span>&nbsp;<span class="ident" id="5383067">clamp</span><span class="op" id="5383072">(</span><span class="ident" id="5383073">eg</span>&nbsp;<span class="op" id="5383076">+</span>&nbsp;<span class="ident" id="5383078">quantErrorCurr</span><span class="op" id="5383092">[</span><span class="ident" id="5383093">x</span><span class="op" id="5383094">+</span><span class="num" id="5383095">1</span><span class="op" id="5383096">]</span><span class="op" id="5383097">[</span><span class="num" id="5383098">1</span><span class="op" id="5383099">]</span><span class="op" id="5383100">/</span><span class="num" id="5383101">16</span><span class="op" id="5383103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383109">eb</span>&nbsp;<span class="op" id="5383112">=</span>&nbsp;<span class="ident" id="5383114">clamp</span><span class="op" id="5383119">(</span><span class="ident" id="5383120">eb</span>&nbsp;<span class="op" id="5383123">+</span>&nbsp;<span class="ident" id="5383125">quantErrorCurr</span><span class="op" id="5383139">[</span><span class="ident" id="5383140">x</span><span class="op" id="5383141">+</span><span class="num" id="5383142">1</span><span class="op" id="5383143">]</span><span class="op" id="5383144">[</span><span class="num" id="5383145">2</span><span class="op" id="5383146">]</span><span class="op" id="5383147">/</span><span class="num" id="5383148">16</span><span class="op" id="5383150">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383155">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383161">if</span>&nbsp;<span class="ident" id="5383164">palette</span>&nbsp;<span class="op" id="5383172">!=</span>&nbsp;<span class="ident" id="5383175">nil</span>&nbsp;<span class="op" id="5383179">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383185">//&nbsp;Find&nbsp;the&nbsp;closest&nbsp;palette&nbsp;color&nbsp;in&nbsp;Euclidean&nbsp;R,G,B&nbsp;space:&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383253">//&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;sum-squared-difference.&nbsp;We&nbsp;shift&nbsp;by&nbsp;1&nbsp;bit</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383321">//&nbsp;to&nbsp;avoid&nbsp;potential&nbsp;uint32&nbsp;overflow&nbsp;in&nbsp;sum-squared-difference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5383390">//&nbsp;TODO(nigeltao):&nbsp;consider&nbsp;smarter&nbsp;algorithms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383442">bestIndex</span><span class="op" id="5383451">,</span>&nbsp;<span class="ident" id="5383453">bestSSD</span>&nbsp;<span class="op" id="5383461">:=</span>&nbsp;<span class="num" id="5383464">0</span><span class="op" id="5383465">,</span>&nbsp;<span class="builtintype" id="5383467">uint32</span><span class="op" id="5383473">(</span><span class="num" id="5383474">1</span><span class="op" id="5383475">&lt;&lt;</span><span class="num" id="5383477">32</span><span class="op" id="5383479">-</span><span class="num" id="5383480">1</span><span class="op" id="5383481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383487">for</span>&nbsp;<span class="ident" id="5383491">index</span><span class="op" id="5383496">,</span>&nbsp;<span class="ident" id="5383498">p</span>&nbsp;<span class="op" id="5383500">:=</span>&nbsp;<span class="keyword" id="5383503">range</span>&nbsp;<span class="ident" id="5383509">palette</span>&nbsp;<span class="op" id="5383517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383524">delta</span>&nbsp;<span class="op" id="5383530">:=</span>&nbsp;<span class="op" id="5383533">(</span><span class="ident" id="5383534">er</span>&nbsp;<span class="op" id="5383537">-</span>&nbsp;<span class="ident" id="5383539">p</span><span class="op" id="5383540">[</span><span class="num" id="5383541">0</span><span class="op" id="5383542">]</span><span class="op" id="5383543">)</span>&nbsp;<span class="op" id="5383545">&gt;&gt;</span>&nbsp;<span class="num" id="5383548">1</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383555">ssd</span>&nbsp;<span class="op" id="5383559">:=</span>&nbsp;<span class="builtintype" id="5383562">uint32</span><span class="op" id="5383568">(</span><span class="ident" id="5383569">delta</span>&nbsp;<span class="op" id="5383575">*</span>&nbsp;<span class="ident" id="5383577">delta</span><span class="op" id="5383582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383589">delta</span>&nbsp;<span class="op" id="5383595">=</span>&nbsp;<span class="op" id="5383597">(</span><span class="ident" id="5383598">eg</span>&nbsp;<span class="op" id="5383601">-</span>&nbsp;<span class="ident" id="5383603">p</span><span class="op" id="5383604">[</span><span class="num" id="5383605">1</span><span class="op" id="5383606">]</span><span class="op" id="5383607">)</span>&nbsp;<span class="op" id="5383609">&gt;&gt;</span>&nbsp;<span class="num" id="5383612">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383619">ssd</span>&nbsp;<span class="op" id="5383623">+=</span>&nbsp;<span class="builtintype" id="5383626">uint32</span><span class="op" id="5383632">(</span><span class="ident" id="5383633">delta</span>&nbsp;<span class="op" id="5383639">*</span>&nbsp;<span class="ident" id="5383641">delta</span><span class="op" id="5383646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383653">delta</span>&nbsp;<span class="op" id="5383659">=</span>&nbsp;<span class="op" id="5383661">(</span><span class="ident" id="5383662">eb</span>&nbsp;<span class="op" id="5383665">-</span>&nbsp;<span class="ident" id="5383667">p</span><span class="op" id="5383668">[</span><span class="num" id="5383669">2</span><span class="op" id="5383670">]</span><span class="op" id="5383671">)</span>&nbsp;<span class="op" id="5383673">&gt;&gt;</span>&nbsp;<span class="num" id="5383676">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383683">ssd</span>&nbsp;<span class="op" id="5383687">+=</span>&nbsp;<span class="builtintype" id="5383690">uint32</span><span class="op" id="5383696">(</span><span class="ident" id="5383697">delta</span>&nbsp;<span class="op" id="5383703">*</span>&nbsp;<span class="ident" id="5383705">delta</span><span class="op" id="5383710">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383717">if</span>&nbsp;<span class="ident" id="5383720">ssd</span>&nbsp;<span class="op" id="5383724">&lt;</span>&nbsp;<span class="ident" id="5383726">bestSSD</span>&nbsp;<span class="op" id="5383734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383742">bestIndex</span><span class="op" id="5383751">,</span>&nbsp;<span class="ident" id="5383753">bestSSD</span>&nbsp;<span class="op" id="5383761">=</span>&nbsp;<span class="ident" id="5383763">index</span><span class="op" id="5383768">,</span>&nbsp;<span class="ident" id="5383770">ssd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383780">if</span>&nbsp;<span class="ident" id="5383783">ssd</span>&nbsp;<span class="op" id="5383787">==</span>&nbsp;<span class="num" id="5383790">0</span>&nbsp;<span class="op" id="5383792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383801">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383813">}</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383832">pix</span><span class="op" id="5383835">[</span><span class="ident" id="5383836">y</span><span class="op" id="5383837">*</span><span class="ident" id="5383838">stride</span><span class="op" id="5383844">+</span><span class="ident" id="5383845">x</span><span class="op" id="5383846">]</span>&nbsp;<span class="op" id="5383848">=</span>&nbsp;<span class="builtintype" id="5383850">byte</span><span class="op" id="5383854">(</span><span class="ident" id="5383855">bestIndex</span><span class="op" id="5383864">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383871">if</span>&nbsp;<span class="op" id="5383874">!</span><span class="ident" id="5383875">floydSteinberg</span>&nbsp;<span class="op" id="5383890">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5383897">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5383910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383916">er</span>&nbsp;<span class="op" id="5383919">-=</span>&nbsp;<span class="builtintype" id="5383922">int32</span><span class="op" id="5383927">(</span><span class="ident" id="5383928">palette</span><span class="op" id="5383935">[</span><span class="ident" id="5383936">bestIndex</span><span class="op" id="5383945">]</span><span class="op" id="5383946">[</span><span class="num" id="5383947">0</span><span class="op" id="5383948">]</span><span class="op" id="5383949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383955">eg</span>&nbsp;<span class="op" id="5383958">-=</span>&nbsp;<span class="builtintype" id="5383961">int32</span><span class="op" id="5383966">(</span><span class="ident" id="5383967">palette</span><span class="op" id="5383974">[</span><span class="ident" id="5383975">bestIndex</span><span class="op" id="5383984">]</span><span class="op" id="5383985">[</span><span class="num" id="5383986">1</span><span class="op" id="5383987">]</span><span class="op" id="5383988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5383994">eb</span>&nbsp;<span class="op" id="5383997">-=</span>&nbsp;<span class="builtintype" id="5384000">int32</span><span class="op" id="5384005">(</span><span class="ident" id="5384006">palette</span><span class="op" id="5384013">[</span><span class="ident" id="5384014">bestIndex</span><span class="op" id="5384023">]</span><span class="op" id="5384024">[</span><span class="num" id="5384025">2</span><span class="op" id="5384026">]</span><span class="op" id="5384027">)</span><br>
<span class="lineno">630</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384033">}</span>&nbsp;<span class="keyword" id="5384035">else</span>&nbsp;<span class="op" id="5384040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384046">out</span><span class="op" id="5384049">.</span><span class="ident" id="5384050">R</span>&nbsp;<span class="op" id="5384052">=</span>&nbsp;<span class="builtintype" id="5384054">uint16</span><span class="op" id="5384060">(</span><span class="ident" id="5384061">er</span><span class="op" id="5384063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384069">out</span><span class="op" id="5384072">.</span><span class="ident" id="5384073">G</span>&nbsp;<span class="op" id="5384075">=</span>&nbsp;<span class="builtintype" id="5384077">uint16</span><span class="op" id="5384083">(</span><span class="ident" id="5384084">eg</span><span class="op" id="5384086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384092">out</span><span class="op" id="5384095">.</span><span class="ident" id="5384096">B</span>&nbsp;<span class="op" id="5384098">=</span>&nbsp;<span class="builtintype" id="5384100">uint16</span><span class="op" id="5384106">(</span><span class="ident" id="5384107">eb</span><span class="op" id="5384109">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384115">//&nbsp;The&nbsp;third&nbsp;argument&nbsp;is&nbsp;&amp;out&nbsp;instead&nbsp;of&nbsp;out&nbsp;(and&nbsp;out&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384176">//&nbsp;declared&nbsp;outside&nbsp;of&nbsp;the&nbsp;inner&nbsp;loop)&nbsp;to&nbsp;avoid&nbsp;the&nbsp;implicit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384241">//&nbsp;conversion&nbsp;to&nbsp;color.Color&nbsp;here&nbsp;allocating&nbsp;memory&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384304">//&nbsp;inner&nbsp;loop&nbsp;if&nbsp;sizeof(color.RGBA64)&nbsp;&gt;&nbsp;sizeof(uintptr).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384365">dst</span><span class="op" id="5384368">.</span><span class="ident" id="5384369">Set</span><span class="op" id="5384372">(</span><span class="ident" id="5384373">r</span><span class="op" id="5384374">.</span><span class="ident" id="5384375">Min</span><span class="op" id="5384378">.</span><span class="ident" id="5384379">X</span><span class="op" id="5384380">+</span><span class="ident" id="5384381">x</span><span class="op" id="5384382">,</span>&nbsp;<span class="ident" id="5384384">r</span><span class="op" id="5384385">.</span><span class="ident" id="5384386">Min</span><span class="op" id="5384389">.</span><span class="ident" id="5384390">Y</span><span class="op" id="5384391">+</span><span class="ident" id="5384392">y</span><span class="op" id="5384393">,</span>&nbsp;<span class="op" id="5384395">&amp;</span><span class="ident" id="5384396">out</span><span class="op" id="5384399">)</span><br>
<span class="lineno">640</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384406">if</span>&nbsp;<span class="op" id="5384409">!</span><span class="ident" id="5384410">floydSteinberg</span>&nbsp;<span class="op" id="5384425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5384432">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384451">sr</span><span class="op" id="5384453">,</span>&nbsp;<span class="ident" id="5384455">sg</span><span class="op" id="5384457">,</span>&nbsp;<span class="ident" id="5384459">sb</span><span class="op" id="5384461">,</span>&nbsp;<span class="ident" id="5384463">_</span>&nbsp;<span class="op" id="5384465">=</span>&nbsp;<span class="ident" id="5384467">dst</span><span class="op" id="5384470">.</span><span class="ident" id="5384471">At</span><span class="op" id="5384473">(</span><span class="ident" id="5384474">r</span><span class="op" id="5384475">.</span><span class="ident" id="5384476">Min</span><span class="op" id="5384479">.</span><span class="ident" id="5384480">X</span><span class="op" id="5384481">+</span><span class="ident" id="5384482">x</span><span class="op" id="5384483">,</span>&nbsp;<span class="ident" id="5384485">r</span><span class="op" id="5384486">.</span><span class="ident" id="5384487">Min</span><span class="op" id="5384490">.</span><span class="ident" id="5384491">Y</span><span class="op" id="5384492">+</span><span class="ident" id="5384493">y</span><span class="op" id="5384494">)</span><span class="op" id="5384495">.</span><span class="ident" id="5384496">RGBA</span><span class="op" id="5384500">(</span><span class="op" id="5384501">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384507">er</span>&nbsp;<span class="op" id="5384510">-=</span>&nbsp;<span class="builtintype" id="5384513">int32</span><span class="op" id="5384518">(</span><span class="ident" id="5384519">sr</span><span class="op" id="5384521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384527">eg</span>&nbsp;<span class="op" id="5384530">-=</span>&nbsp;<span class="builtintype" id="5384533">int32</span><span class="op" id="5384538">(</span><span class="ident" id="5384539">sg</span><span class="op" id="5384541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384547">eb</span>&nbsp;<span class="op" id="5384550">-=</span>&nbsp;<span class="builtintype" id="5384553">int32</span><span class="op" id="5384558">(</span><span class="ident" id="5384559">sb</span><span class="op" id="5384561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5384566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5384572">//&nbsp;Propagate&nbsp;the&nbsp;Floyd-Steinberg&nbsp;quantization&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384628">quantErrorNext</span><span class="op" id="5384642">[</span><span class="ident" id="5384643">x</span><span class="op" id="5384644">+</span><span class="num" id="5384645">0</span><span class="op" id="5384646">]</span><span class="op" id="5384647">[</span><span class="num" id="5384648">0</span><span class="op" id="5384649">]</span>&nbsp;<span class="op" id="5384651">+=</span>&nbsp;<span class="ident" id="5384654">er</span>&nbsp;<span class="op" id="5384657">*</span>&nbsp;<span class="num" id="5384659">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384664">quantErrorNext</span><span class="op" id="5384678">[</span><span class="ident" id="5384679">x</span><span class="op" id="5384680">+</span><span class="num" id="5384681">0</span><span class="op" id="5384682">]</span><span class="op" id="5384683">[</span><span class="num" id="5384684">1</span><span class="op" id="5384685">]</span>&nbsp;<span class="op" id="5384687">+=</span>&nbsp;<span class="ident" id="5384690">eg</span>&nbsp;<span class="op" id="5384693">*</span>&nbsp;<span class="num" id="5384695">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384700">quantErrorNext</span><span class="op" id="5384714">[</span><span class="ident" id="5384715">x</span><span class="op" id="5384716">+</span><span class="num" id="5384717">0</span><span class="op" id="5384718">]</span><span class="op" id="5384719">[</span><span class="num" id="5384720">2</span><span class="op" id="5384721">]</span>&nbsp;<span class="op" id="5384723">+=</span>&nbsp;<span class="ident" id="5384726">eb</span>&nbsp;<span class="op" id="5384729">*</span>&nbsp;<span class="num" id="5384731">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384736">quantErrorNext</span><span class="op" id="5384750">[</span><span class="ident" id="5384751">x</span><span class="op" id="5384752">+</span><span class="num" id="5384753">1</span><span class="op" id="5384754">]</span><span class="op" id="5384755">[</span><span class="num" id="5384756">0</span><span class="op" id="5384757">]</span>&nbsp;<span class="op" id="5384759">+=</span>&nbsp;<span class="ident" id="5384762">er</span>&nbsp;<span class="op" id="5384765">*</span>&nbsp;<span class="num" id="5384767">5</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384772">quantErrorNext</span><span class="op" id="5384786">[</span><span class="ident" id="5384787">x</span><span class="op" id="5384788">+</span><span class="num" id="5384789">1</span><span class="op" id="5384790">]</span><span class="op" id="5384791">[</span><span class="num" id="5384792">1</span><span class="op" id="5384793">]</span>&nbsp;<span class="op" id="5384795">+=</span>&nbsp;<span class="ident" id="5384798">eg</span>&nbsp;<span class="op" id="5384801">*</span>&nbsp;<span class="num" id="5384803">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384808">quantErrorNext</span><span class="op" id="5384822">[</span><span class="ident" id="5384823">x</span><span class="op" id="5384824">+</span><span class="num" id="5384825">1</span><span class="op" id="5384826">]</span><span class="op" id="5384827">[</span><span class="num" id="5384828">2</span><span class="op" id="5384829">]</span>&nbsp;<span class="op" id="5384831">+=</span>&nbsp;<span class="ident" id="5384834">eb</span>&nbsp;<span class="op" id="5384837">*</span>&nbsp;<span class="num" id="5384839">5</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384844">quantErrorNext</span><span class="op" id="5384858">[</span><span class="ident" id="5384859">x</span><span class="op" id="5384860">+</span><span class="num" id="5384861">2</span><span class="op" id="5384862">]</span><span class="op" id="5384863">[</span><span class="num" id="5384864">0</span><span class="op" id="5384865">]</span>&nbsp;<span class="op" id="5384867">+=</span>&nbsp;<span class="ident" id="5384870">er</span>&nbsp;<span class="op" id="5384873">*</span>&nbsp;<span class="num" id="5384875">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384880">quantErrorNext</span><span class="op" id="5384894">[</span><span class="ident" id="5384895">x</span><span class="op" id="5384896">+</span><span class="num" id="5384897">2</span><span class="op" id="5384898">]</span><span class="op" id="5384899">[</span><span class="num" id="5384900">1</span><span class="op" id="5384901">]</span>&nbsp;<span class="op" id="5384903">+=</span>&nbsp;<span class="ident" id="5384906">eg</span>&nbsp;<span class="op" id="5384909">*</span>&nbsp;<span class="num" id="5384911">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384916">quantErrorNext</span><span class="op" id="5384930">[</span><span class="ident" id="5384931">x</span><span class="op" id="5384932">+</span><span class="num" id="5384933">2</span><span class="op" id="5384934">]</span><span class="op" id="5384935">[</span><span class="num" id="5384936">2</span><span class="op" id="5384937">]</span>&nbsp;<span class="op" id="5384939">+=</span>&nbsp;<span class="ident" id="5384942">eb</span>&nbsp;<span class="op" id="5384945">*</span>&nbsp;<span class="num" id="5384947">1</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384952">quantErrorCurr</span><span class="op" id="5384966">[</span><span class="ident" id="5384967">x</span><span class="op" id="5384968">+</span><span class="num" id="5384969">2</span><span class="op" id="5384970">]</span><span class="op" id="5384971">[</span><span class="num" id="5384972">0</span><span class="op" id="5384973">]</span>&nbsp;<span class="op" id="5384975">+=</span>&nbsp;<span class="ident" id="5384978">er</span>&nbsp;<span class="op" id="5384981">*</span>&nbsp;<span class="num" id="5384983">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5384988">quantErrorCurr</span><span class="op" id="5385002">[</span><span class="ident" id="5385003">x</span><span class="op" id="5385004">+</span><span class="num" id="5385005">2</span><span class="op" id="5385006">]</span><span class="op" id="5385007">[</span><span class="num" id="5385008">1</span><span class="op" id="5385009">]</span>&nbsp;<span class="op" id="5385011">+=</span>&nbsp;<span class="ident" id="5385014">eg</span>&nbsp;<span class="op" id="5385017">*</span>&nbsp;<span class="num" id="5385019">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385024">quantErrorCurr</span><span class="op" id="5385038">[</span><span class="ident" id="5385039">x</span><span class="op" id="5385040">+</span><span class="num" id="5385041">2</span><span class="op" id="5385042">]</span><span class="op" id="5385043">[</span><span class="num" id="5385044">2</span><span class="op" id="5385045">]</span>&nbsp;<span class="op" id="5385047">+=</span>&nbsp;<span class="ident" id="5385050">eb</span>&nbsp;<span class="op" id="5385053">*</span>&nbsp;<span class="num" id="5385055">7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5385064">//&nbsp;Recycle&nbsp;the&nbsp;quantization&nbsp;error&nbsp;buffers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385109">if</span>&nbsp;<span class="ident" id="5385112">floydSteinberg</span>&nbsp;<span class="op" id="5385127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385132">quantErrorCurr</span><span class="op" id="5385146">,</span>&nbsp;<span class="ident" id="5385148">quantErrorNext</span>&nbsp;<span class="op" id="5385163">=</span>&nbsp;<span class="ident" id="5385165">quantErrorNext</span><span class="op" id="5385179">,</span>&nbsp;<span class="ident" id="5385181">quantErrorCurr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5385199">for</span>&nbsp;<span class="ident" id="5385203">i</span>&nbsp;<span class="op" id="5385205">:=</span>&nbsp;<span class="keyword" id="5385208">range</span>&nbsp;<span class="ident" id="5385214">quantErrorNext</span>&nbsp;<span class="op" id="5385229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5385235">quantErrorNext</span><span class="op" id="5385249">[</span><span class="ident" id="5385250">i</span><span class="op" id="5385251">]</span>&nbsp;<span class="op" id="5385253">=</span>&nbsp;<span class="op" id="5385255">[</span><span class="num" id="5385256">3</span><span class="op" id="5385257">]</span><span class="builtintype" id="5385258">int32</span><span class="op" id="5385263">{</span><span class="op" id="5385264">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385269">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5385276">}</span><br>
<span class="lineno"></span><span class="op" id="5385278">}</span>
</div>
</body>
</html>
