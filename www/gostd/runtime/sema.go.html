<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1623183">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1623238">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1623292">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1623343">//&nbsp;Semaphore&nbsp;implementation&nbsp;exposed&nbsp;to&nbsp;Go.</span><br>
<span class="lineno"></span><span class="comment" id="1623386">//&nbsp;Intended&nbsp;use&nbsp;is&nbsp;provide&nbsp;a&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1623432">//&nbsp;primitive&nbsp;that&nbsp;can&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;contended&nbsp;case</span><br>
<span class="lineno"></span><span class="comment" id="1623484">//&nbsp;of&nbsp;other&nbsp;synchronization&nbsp;primitives.</span><br>
<span class="lineno"></span><span class="comment" id="1623524">//&nbsp;Thus&nbsp;it&nbsp;targets&nbsp;the&nbsp;same&nbsp;goal&nbsp;as&nbsp;Linux&#39;s&nbsp;futex,</span><br>
<span class="lineno">10</span><span class="comment" id="1623575">//&nbsp;but&nbsp;it&nbsp;has&nbsp;much&nbsp;simpler&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="1623613">//</span><br>
<span class="lineno"></span><span class="comment" id="1623616">//&nbsp;That&nbsp;is,&nbsp;don&#39;t&nbsp;think&nbsp;of&nbsp;these&nbsp;as&nbsp;semaphores.</span><br>
<span class="lineno"></span><span class="comment" id="1623664">//&nbsp;Think&nbsp;of&nbsp;them&nbsp;as&nbsp;a&nbsp;way&nbsp;to&nbsp;implement&nbsp;sleep&nbsp;and&nbsp;wakeup</span><br>
<span class="lineno"></span><span class="comment" id="1623720">//&nbsp;such&nbsp;that&nbsp;every&nbsp;sleep&nbsp;is&nbsp;paired&nbsp;with&nbsp;a&nbsp;single&nbsp;wakeup,</span><br>
<span class="lineno">15</span><span class="comment" id="1623777">//&nbsp;even&nbsp;if,&nbsp;due&nbsp;to&nbsp;races,&nbsp;the&nbsp;wakeup&nbsp;happens&nbsp;before&nbsp;the&nbsp;sleep.</span><br>
<span class="lineno"></span><span class="comment" id="1623840">//</span><br>
<span class="lineno"></span><span class="comment" id="1623843">//&nbsp;See&nbsp;Mullender&nbsp;and&nbsp;Cox,&nbsp;``Semaphores&nbsp;in&nbsp;Plan&nbsp;9,&#39;&#39;</span><br>
<span class="lineno"></span><span class="comment" id="1623895">//&nbsp;http://swtch.com/semaphore.pdf</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="keyword" id="1623930">package</span>&nbsp;<span class="ident" id="1623938">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1623947">import</span>&nbsp;<span class="string" id="1623954">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1623964">//&nbsp;Asynchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Mutex.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1624007">type</span>&nbsp;<span class="ident" id="1624012">semaRoot</span>&nbsp;<span class="keyword" id="1624021">struct</span>&nbsp;<span class="op" id="1624028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624031">lock</span>&nbsp;&nbsp;<span class="ident" id="1624037">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624044">head</span>&nbsp;&nbsp;<span class="op" id="1624050">*</span><span class="ident" id="1624051">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624058">tail</span>&nbsp;&nbsp;<span class="op" id="1624064">*</span><span class="ident" id="1624065">sudog</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624072">nwait</span>&nbsp;<span class="builtintype" id="1624078">uint32</span>&nbsp;<span class="comment" id="1624085">//&nbsp;Number&nbsp;of&nbsp;waiters.&nbsp;Read&nbsp;w/o&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="op" id="1624126">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1624129">//&nbsp;Prime&nbsp;to&nbsp;not&nbsp;correlate&nbsp;with&nbsp;any&nbsp;user&nbsp;patterns.</span><br>
<span class="lineno"></span><span class="keyword" id="1624179">const</span>&nbsp;<span class="ident" id="1624185">semTabSize</span>&nbsp;<span class="op" id="1624196">=</span>&nbsp;<span class="num" id="1624198">251</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1624203">var</span>&nbsp;<span class="ident" id="1624207">semtable</span>&nbsp;<span class="op" id="1624216">[</span><span class="ident" id="1624217">semTabSize</span><span class="op" id="1624227">]</span><span class="keyword" id="1624228">struct</span>&nbsp;<span class="op" id="1624235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624238">root</span>&nbsp;<span class="ident" id="1624243">semaRoot</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624253">pad</span>&nbsp;&nbsp;<span class="op" id="1624258">[</span><span class="ident" id="1624259">_CacheLineSize</span>&nbsp;<span class="op" id="1624274">-</span>&nbsp;<span class="ident" id="1624276">unsafe</span><span class="op" id="1624282">.</span><span class="ident" id="1624283">Sizeof</span><span class="op" id="1624289">(</span><span class="ident" id="1624290">semaRoot</span><span class="op" id="1624298">{</span><span class="op" id="1624299">}</span><span class="op" id="1624300">)</span><span class="op" id="1624301">]</span><span class="builtintype" id="1624302">byte</span><br>
<span class="lineno"></span><span class="op" id="1624307">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="1624310">//&nbsp;Called&nbsp;from&nbsp;sync/net&nbsp;packages.</span><br>
<span class="lineno"></span><span class="keyword" id="1624344">func</span>&nbsp;<span class="ident" id="1624349">asyncsemacquire</span><span class="op" id="1624364">(</span><span class="ident" id="1624365">addr</span>&nbsp;<span class="op" id="1624370">*</span><span class="builtintype" id="1624371">uint32</span><span class="op" id="1624377">)</span>&nbsp;<span class="op" id="1624379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624382">semacquire</span><span class="op" id="1624392">(</span><span class="ident" id="1624393">addr</span><span class="op" id="1624397">,</span>&nbsp;<span class="builtintype" id="1624399">true</span><span class="op" id="1624403">)</span><br>
<span class="lineno"></span><span class="op" id="1624405">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="1624408">func</span>&nbsp;<span class="ident" id="1624413">asyncsemrelease</span><span class="op" id="1624428">(</span><span class="ident" id="1624429">addr</span>&nbsp;<span class="op" id="1624434">*</span><span class="builtintype" id="1624435">uint32</span><span class="op" id="1624441">)</span>&nbsp;<span class="op" id="1624443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624446">semrelease</span><span class="op" id="1624456">(</span><span class="ident" id="1624457">addr</span><span class="op" id="1624461">)</span><br>
<span class="lineno"></span><span class="op" id="1624463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="1624466">//&nbsp;Called&nbsp;from&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1624490">func</span>&nbsp;<span class="ident" id="1624495">semacquire</span><span class="op" id="1624505">(</span><span class="ident" id="1624506">addr</span>&nbsp;<span class="op" id="1624511">*</span><span class="builtintype" id="1624512">uint32</span><span class="op" id="1624518">,</span>&nbsp;<span class="ident" id="1624520">profile</span>&nbsp;<span class="builtintype" id="1624528">bool</span><span class="op" id="1624532">)</span>&nbsp;<span class="op" id="1624534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624537">gp</span>&nbsp;<span class="op" id="1624540">:=</span>&nbsp;<span class="ident" id="1624543">getg</span><span class="op" id="1624547">(</span><span class="op" id="1624548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624551">if</span>&nbsp;<span class="ident" id="1624554">gp</span>&nbsp;<span class="op" id="1624557">!=</span>&nbsp;<span class="ident" id="1624560">gp</span><span class="op" id="1624562">.</span><span class="ident" id="1624563">m</span><span class="op" id="1624564">.</span><span class="ident" id="1624565">curg</span>&nbsp;<span class="op" id="1624570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624574">gothrow</span><span class="op" id="1624581">(</span><span class="string" id="1624582">&#34;semacquire&nbsp;not&nbsp;on&nbsp;the&nbsp;G&nbsp;stack&#34;</span><span class="op" id="1624613">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624616">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624620">//&nbsp;Easy&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624635">if</span>&nbsp;<span class="ident" id="1624638">cansemacquire</span><span class="op" id="1624651">(</span><span class="ident" id="1624652">addr</span><span class="op" id="1624656">)</span>&nbsp;<span class="op" id="1624658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624662">return</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1624670">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624674">//&nbsp;Harder&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624691">//&nbsp;&nbsp;&nbsp;&nbspincrement&nbsp;waiter&nbsp;count</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624718">//&nbsp;&nbsp;&nbsp;&nbsptry&nbsp;cansemacquire&nbsp;one&nbsp;more&nbsp;time,&nbsp;return&nbsp;if&nbsp;succeeded</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624775">//&nbsp;&nbsp;&nbsp;&nbspenqueue&nbsp;itself&nbsp;as&nbsp;a&nbsp;waiter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624806">//&nbsp;&nbsp;&nbsp;&nbspsleep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1624816">//&nbsp;&nbsp;&nbsp;&nbsp(waiter&nbsp;descriptor&nbsp;is&nbsp;dequeued&nbsp;by&nbsp;signaler)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624864">s</span>&nbsp;<span class="op" id="1624866">:=</span>&nbsp;<span class="ident" id="1624869">acquireSudog</span><span class="op" id="1624881">(</span><span class="op" id="1624882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624885">root</span>&nbsp;<span class="op" id="1624890">:=</span>&nbsp;<span class="ident" id="1624893">semroot</span><span class="op" id="1624900">(</span><span class="ident" id="1624901">addr</span><span class="op" id="1624905">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624908">t0</span>&nbsp;<span class="op" id="1624911">:=</span>&nbsp;<span class="ident" id="1624914">int64</span><span class="op" id="1624919">(</span><span class="num" id="1624920">0</span><span class="op" id="1624921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624924">s</span><span class="op" id="1624925">.</span><span class="ident" id="1624926">releasetime</span>&nbsp;<span class="op" id="1624938">=</span>&nbsp;<span class="num" id="1624940">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1624943">if</span>&nbsp;<span class="ident" id="1624946">profile</span>&nbsp;<span class="op" id="1624954">&amp;&amp;</span>&nbsp;<span class="ident" id="1624957">blockprofilerate</span>&nbsp;<span class="op" id="1624974">&gt;</span>&nbsp;<span class="num" id="1624976">0</span>&nbsp;<span class="op" id="1624978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1624982">t0</span>&nbsp;<span class="op" id="1624985">=</span>&nbsp;<span class="ident" id="1624987">cputicks</span><span class="op" id="1624995">(</span><span class="op" id="1624996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625000">s</span><span class="op" id="1625001">.</span><span class="ident" id="1625002">releasetime</span>&nbsp;<span class="op" id="1625014">=</span>&nbsp;<span class="op" id="1625016">-</span><span class="num" id="1625017">1</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625020">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625023">for</span>&nbsp;<span class="op" id="1625027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625031">lock</span><span class="op" id="1625035">(</span><span class="op" id="1625036">&amp;</span><span class="ident" id="1625037">root</span><span class="op" id="1625041">.</span><span class="ident" id="1625042">lock</span><span class="op" id="1625046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625050">//&nbsp;Add&nbsp;ourselves&nbsp;to&nbsp;nwait&nbsp;to&nbsp;disable&nbsp;&#34;easy&nbsp;case&#34;&nbsp;in&nbsp;semrelease.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625116">xadd</span><span class="op" id="1625120">(</span><span class="op" id="1625121">&amp;</span><span class="ident" id="1625122">root</span><span class="op" id="1625126">.</span><span class="ident" id="1625127">nwait</span><span class="op" id="1625132">,</span>&nbsp;<span class="num" id="1625134">1</span><span class="op" id="1625135">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625139">//&nbsp;Check&nbsp;cansemacquire&nbsp;to&nbsp;avoid&nbsp;missed&nbsp;wakeup.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625188">if</span>&nbsp;<span class="ident" id="1625191">cansemacquire</span><span class="op" id="1625204">(</span><span class="ident" id="1625205">addr</span><span class="op" id="1625209">)</span>&nbsp;<span class="op" id="1625211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625216">xadd</span><span class="op" id="1625220">(</span><span class="op" id="1625221">&amp;</span><span class="ident" id="1625222">root</span><span class="op" id="1625226">.</span><span class="ident" id="1625227">nwait</span><span class="op" id="1625232">,</span>&nbsp;<span class="op" id="1625234">-</span><span class="num" id="1625235">1</span><span class="op" id="1625236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625241">unlock</span><span class="op" id="1625247">(</span><span class="op" id="1625248">&amp;</span><span class="ident" id="1625249">root</span><span class="op" id="1625253">.</span><span class="ident" id="1625254">lock</span><span class="op" id="1625258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625263">break</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625271">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625275">//&nbsp;Any&nbsp;semrelease&nbsp;after&nbsp;the&nbsp;cansemacquire&nbsp;knows&nbsp;we&#39;re&nbsp;waiting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625339">//&nbsp;(we&nbsp;set&nbsp;nwait&nbsp;above),&nbsp;so&nbsp;go&nbsp;to&nbsp;sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625382">root</span><span class="op" id="1625386">.</span><span class="ident" id="1625387">queue</span><span class="op" id="1625392">(</span><span class="ident" id="1625393">addr</span><span class="op" id="1625397">,</span>&nbsp;<span class="ident" id="1625399">s</span><span class="op" id="1625400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625404">goparkunlock</span><span class="op" id="1625416">(</span><span class="op" id="1625417">&amp;</span><span class="ident" id="1625418">root</span><span class="op" id="1625422">.</span><span class="ident" id="1625423">lock</span><span class="op" id="1625427">,</span>&nbsp;<span class="string" id="1625429">&#34;semacquire&#34;</span><span class="op" id="1625441">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625445">if</span>&nbsp;<span class="ident" id="1625448">cansemacquire</span><span class="op" id="1625461">(</span><span class="ident" id="1625462">addr</span><span class="op" id="1625466">)</span>&nbsp;<span class="op" id="1625468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625473">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625487">if</span>&nbsp;<span class="ident" id="1625490">s</span><span class="op" id="1625491">.</span><span class="ident" id="1625492">releasetime</span>&nbsp;<span class="op" id="1625504">&gt;</span>&nbsp;<span class="num" id="1625506">0</span>&nbsp;<span class="op" id="1625508">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625512">blockevent</span><span class="op" id="1625522">(</span><span class="ident" id="1625523">int64</span><span class="op" id="1625528">(</span><span class="ident" id="1625529">s</span><span class="op" id="1625530">.</span><span class="ident" id="1625531">releasetime</span><span class="op" id="1625542">)</span><span class="op" id="1625543">-</span><span class="ident" id="1625544">t0</span><span class="op" id="1625546">,</span>&nbsp;<span class="num" id="1625548">3</span><span class="op" id="1625549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625555">releaseSudog</span><span class="op" id="1625567">(</span><span class="ident" id="1625568">s</span><span class="op" id="1625569">)</span><br>
<span class="lineno"></span><span class="op" id="1625571">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="1625574">func</span>&nbsp;<span class="ident" id="1625579">semrelease</span><span class="op" id="1625589">(</span><span class="ident" id="1625590">addr</span>&nbsp;<span class="op" id="1625595">*</span><span class="builtintype" id="1625596">uint32</span><span class="op" id="1625602">)</span>&nbsp;<span class="op" id="1625604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625607">root</span>&nbsp;<span class="op" id="1625612">:=</span>&nbsp;<span class="ident" id="1625615">semroot</span><span class="op" id="1625622">(</span><span class="ident" id="1625623">addr</span><span class="op" id="1625627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625630">xadd</span><span class="op" id="1625634">(</span><span class="ident" id="1625635">addr</span><span class="op" id="1625639">,</span>&nbsp;<span class="num" id="1625641">1</span><span class="op" id="1625642">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625646">//&nbsp;Easy&nbsp;case:&nbsp;no&nbsp;waiters?</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625673">//&nbsp;This&nbsp;check&nbsp;must&nbsp;happen&nbsp;after&nbsp;the&nbsp;xadd,&nbsp;to&nbsp;avoid&nbsp;a&nbsp;missed&nbsp;wakeup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625741">//&nbsp;(see&nbsp;loop&nbsp;in&nbsp;semacquire).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625771">if</span>&nbsp;<span class="ident" id="1625774">atomicload</span><span class="op" id="1625784">(</span><span class="op" id="1625785">&amp;</span><span class="ident" id="1625786">root</span><span class="op" id="1625790">.</span><span class="ident" id="1625791">nwait</span><span class="op" id="1625796">)</span>&nbsp;<span class="op" id="1625798">==</span>&nbsp;<span class="num" id="1625801">0</span>&nbsp;<span class="op" id="1625803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625807">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1625815">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625819">//&nbsp;Harder&nbsp;case:&nbsp;search&nbsp;for&nbsp;a&nbsp;waiter&nbsp;and&nbsp;wake&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625869">lock</span><span class="op" id="1625873">(</span><span class="op" id="1625874">&amp;</span><span class="ident" id="1625875">root</span><span class="op" id="1625879">.</span><span class="ident" id="1625880">lock</span><span class="op" id="1625884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1625887">if</span>&nbsp;<span class="ident" id="1625890">atomicload</span><span class="op" id="1625900">(</span><span class="op" id="1625901">&amp;</span><span class="ident" id="1625902">root</span><span class="op" id="1625906">.</span><span class="ident" id="1625907">nwait</span><span class="op" id="1625912">)</span>&nbsp;<span class="op" id="1625914">==</span>&nbsp;<span class="num" id="1625917">0</span>&nbsp;<span class="op" id="1625919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625923">//&nbsp;The&nbsp;count&nbsp;is&nbsp;already&nbsp;consumed&nbsp;by&nbsp;another&nbsp;goroutine,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625980">//&nbsp;so&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;up&nbsp;another&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626026">unlock</span><span class="op" id="1626032">(</span><span class="op" id="1626033">&amp;</span><span class="ident" id="1626034">root</span><span class="op" id="1626038">.</span><span class="ident" id="1626039">lock</span><span class="op" id="1626043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626047">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626058">s</span>&nbsp;<span class="op" id="1626060">:=</span>&nbsp;<span class="ident" id="1626063">root</span><span class="op" id="1626067">.</span><span class="ident" id="1626068">head</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626074">for</span>&nbsp;<span class="op" id="1626078">;</span>&nbsp;<span class="ident" id="1626080">s</span>&nbsp;<span class="op" id="1626082">!=</span>&nbsp;<span class="ident" id="1626085">nil</span><span class="op" id="1626088">;</span>&nbsp;<span class="ident" id="1626090">s</span>&nbsp;<span class="op" id="1626092">=</span>&nbsp;<span class="ident" id="1626094">s</span><span class="op" id="1626095">.</span><span class="ident" id="1626096">next</span>&nbsp;<span class="op" id="1626101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626105">if</span>&nbsp;<span class="ident" id="1626108">s</span><span class="op" id="1626109">.</span><span class="ident" id="1626110">elem</span>&nbsp;<span class="op" id="1626115">==</span>&nbsp;<span class="ident" id="1626118">unsafe</span><span class="op" id="1626124">.</span><span class="ident" id="1626125">Pointer</span><span class="op" id="1626132">(</span><span class="ident" id="1626133">addr</span><span class="op" id="1626137">)</span>&nbsp;<span class="op" id="1626139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626144">xadd</span><span class="op" id="1626148">(</span><span class="op" id="1626149">&amp;</span><span class="ident" id="1626150">root</span><span class="op" id="1626154">.</span><span class="ident" id="1626155">nwait</span><span class="op" id="1626160">,</span>&nbsp;<span class="op" id="1626162">-</span><span class="num" id="1626163">1</span><span class="op" id="1626164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626169">root</span><span class="op" id="1626173">.</span><span class="ident" id="1626174">dequeue</span><span class="op" id="1626181">(</span><span class="ident" id="1626182">s</span><span class="op" id="1626183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626188">break</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626202">unlock</span><span class="op" id="1626208">(</span><span class="op" id="1626209">&amp;</span><span class="ident" id="1626210">root</span><span class="op" id="1626214">.</span><span class="ident" id="1626215">lock</span><span class="op" id="1626219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626222">if</span>&nbsp;<span class="ident" id="1626225">s</span>&nbsp;<span class="op" id="1626227">!=</span>&nbsp;<span class="ident" id="1626230">nil</span>&nbsp;<span class="op" id="1626234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626238">if</span>&nbsp;<span class="ident" id="1626241">s</span><span class="op" id="1626242">.</span><span class="ident" id="1626243">releasetime</span>&nbsp;<span class="op" id="1626255">!=</span>&nbsp;<span class="num" id="1626258">0</span>&nbsp;<span class="op" id="1626260">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626265">s</span><span class="op" id="1626266">.</span><span class="ident" id="1626267">releasetime</span>&nbsp;<span class="op" id="1626279">=</span>&nbsp;<span class="ident" id="1626281">cputicks</span><span class="op" id="1626289">(</span><span class="op" id="1626290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626298">goready</span><span class="op" id="1626305">(</span><span class="ident" id="1626306">s</span><span class="op" id="1626307">.</span><span class="ident" id="1626308">g</span><span class="op" id="1626309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626312">}</span><br>
<span class="lineno"></span><span class="op" id="1626314">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="1626317">func</span>&nbsp;<span class="ident" id="1626322">semroot</span><span class="op" id="1626329">(</span><span class="ident" id="1626330">addr</span>&nbsp;<span class="op" id="1626335">*</span><span class="builtintype" id="1626336">uint32</span><span class="op" id="1626342">)</span>&nbsp;<span class="op" id="1626344">*</span><span class="ident" id="1626345">semaRoot</span>&nbsp;<span class="op" id="1626354">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626357">return</span>&nbsp;<span class="op" id="1626364">&amp;</span><span class="ident" id="1626365">semtable</span><span class="op" id="1626373">[</span><span class="op" id="1626374">(</span><span class="builtintype" id="1626375">uintptr</span><span class="op" id="1626382">(</span><span class="ident" id="1626383">unsafe</span><span class="op" id="1626389">.</span><span class="ident" id="1626390">Pointer</span><span class="op" id="1626397">(</span><span class="ident" id="1626398">addr</span><span class="op" id="1626402">)</span><span class="op" id="1626403">)</span><span class="op" id="1626404">&gt;&gt;</span><span class="num" id="1626406">3</span><span class="op" id="1626407">)</span><span class="op" id="1626408">%</span><span class="ident" id="1626409">semTabSize</span><span class="op" id="1626419">]</span><span class="op" id="1626420">.</span><span class="ident" id="1626421">root</span><br>
<span class="lineno"></span><span class="op" id="1626426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="1626429">func</span>&nbsp;<span class="ident" id="1626434">cansemacquire</span><span class="op" id="1626447">(</span><span class="ident" id="1626448">addr</span>&nbsp;<span class="op" id="1626453">*</span><span class="builtintype" id="1626454">uint32</span><span class="op" id="1626460">)</span>&nbsp;<span class="builtintype" id="1626462">bool</span>&nbsp;<span class="op" id="1626467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626470">for</span>&nbsp;<span class="op" id="1626474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626478">v</span>&nbsp;<span class="op" id="1626480">:=</span>&nbsp;<span class="ident" id="1626483">atomicload</span><span class="op" id="1626493">(</span><span class="ident" id="1626494">addr</span><span class="op" id="1626498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626502">if</span>&nbsp;<span class="ident" id="1626505">v</span>&nbsp;<span class="op" id="1626507">==</span>&nbsp;<span class="num" id="1626510">0</span>&nbsp;<span class="op" id="1626512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626517">return</span>&nbsp;<span class="builtintype" id="1626524">false</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626536">if</span>&nbsp;<span class="ident" id="1626539">cas</span><span class="op" id="1626542">(</span><span class="ident" id="1626543">addr</span><span class="op" id="1626547">,</span>&nbsp;<span class="ident" id="1626549">v</span><span class="op" id="1626550">,</span>&nbsp;<span class="ident" id="1626552">v</span><span class="op" id="1626553">-</span><span class="num" id="1626554">1</span><span class="op" id="1626555">)</span>&nbsp;<span class="op" id="1626557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626562">return</span>&nbsp;<span class="builtintype" id="1626569">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626579">}</span><br>
<span class="lineno">150</span><span class="op" id="1626581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1626584">func</span>&nbsp;<span class="op" id="1626589">(</span><span class="ident" id="1626590">root</span>&nbsp;<span class="op" id="1626595">*</span><span class="ident" id="1626596">semaRoot</span><span class="op" id="1626604">)</span>&nbsp;<span class="ident" id="1626606">queue</span><span class="op" id="1626611">(</span><span class="ident" id="1626612">addr</span>&nbsp;<span class="op" id="1626617">*</span><span class="builtintype" id="1626618">uint32</span><span class="op" id="1626624">,</span>&nbsp;<span class="ident" id="1626626">s</span>&nbsp;<span class="op" id="1626628">*</span><span class="ident" id="1626629">sudog</span><span class="op" id="1626634">)</span>&nbsp;<span class="op" id="1626636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626639">s</span><span class="op" id="1626640">.</span><span class="ident" id="1626641">g</span>&nbsp;<span class="op" id="1626643">=</span>&nbsp;<span class="ident" id="1626645">getg</span><span class="op" id="1626649">(</span><span class="op" id="1626650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626653">s</span><span class="op" id="1626654">.</span><span class="ident" id="1626655">elem</span>&nbsp;<span class="op" id="1626660">=</span>&nbsp;<span class="ident" id="1626662">unsafe</span><span class="op" id="1626668">.</span><span class="ident" id="1626669">Pointer</span><span class="op" id="1626676">(</span><span class="ident" id="1626677">addr</span><span class="op" id="1626681">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626684">s</span><span class="op" id="1626685">.</span><span class="ident" id="1626686">next</span>&nbsp;<span class="op" id="1626691">=</span>&nbsp;<span class="ident" id="1626693">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626698">s</span><span class="op" id="1626699">.</span><span class="ident" id="1626700">prev</span>&nbsp;<span class="op" id="1626705">=</span>&nbsp;<span class="ident" id="1626707">root</span><span class="op" id="1626711">.</span><span class="ident" id="1626712">tail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626718">if</span>&nbsp;<span class="ident" id="1626721">root</span><span class="op" id="1626725">.</span><span class="ident" id="1626726">tail</span>&nbsp;<span class="op" id="1626731">!=</span>&nbsp;<span class="ident" id="1626734">nil</span>&nbsp;<span class="op" id="1626738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626742">root</span><span class="op" id="1626746">.</span><span class="ident" id="1626747">tail</span><span class="op" id="1626751">.</span><span class="ident" id="1626752">next</span>&nbsp;<span class="op" id="1626757">=</span>&nbsp;<span class="ident" id="1626759">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626762">}</span>&nbsp;<span class="keyword" id="1626764">else</span>&nbsp;<span class="op" id="1626769">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626773">root</span><span class="op" id="1626777">.</span><span class="ident" id="1626778">head</span>&nbsp;<span class="op" id="1626783">=</span>&nbsp;<span class="ident" id="1626785">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626791">root</span><span class="op" id="1626795">.</span><span class="ident" id="1626796">tail</span>&nbsp;<span class="op" id="1626801">=</span>&nbsp;<span class="ident" id="1626803">s</span><br>
<span class="lineno"></span><span class="op" id="1626805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="1626808">func</span>&nbsp;<span class="op" id="1626813">(</span><span class="ident" id="1626814">root</span>&nbsp;<span class="op" id="1626819">*</span><span class="ident" id="1626820">semaRoot</span><span class="op" id="1626828">)</span>&nbsp;<span class="ident" id="1626830">dequeue</span><span class="op" id="1626837">(</span><span class="ident" id="1626838">s</span>&nbsp;<span class="op" id="1626840">*</span><span class="ident" id="1626841">sudog</span><span class="op" id="1626846">)</span>&nbsp;<span class="op" id="1626848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626851">if</span>&nbsp;<span class="ident" id="1626854">s</span><span class="op" id="1626855">.</span><span class="ident" id="1626856">next</span>&nbsp;<span class="op" id="1626861">!=</span>&nbsp;<span class="ident" id="1626864">nil</span>&nbsp;<span class="op" id="1626868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626872">s</span><span class="op" id="1626873">.</span><span class="ident" id="1626874">next</span><span class="op" id="1626878">.</span><span class="ident" id="1626879">prev</span>&nbsp;<span class="op" id="1626884">=</span>&nbsp;<span class="ident" id="1626886">s</span><span class="op" id="1626887">.</span><span class="ident" id="1626888">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626894">}</span>&nbsp;<span class="keyword" id="1626896">else</span>&nbsp;<span class="op" id="1626901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626905">root</span><span class="op" id="1626909">.</span><span class="ident" id="1626910">tail</span>&nbsp;<span class="op" id="1626915">=</span>&nbsp;<span class="ident" id="1626917">s</span><span class="op" id="1626918">.</span><span class="ident" id="1626919">prev</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1626928">if</span>&nbsp;<span class="ident" id="1626931">s</span><span class="op" id="1626932">.</span><span class="ident" id="1626933">prev</span>&nbsp;<span class="op" id="1626938">!=</span>&nbsp;<span class="ident" id="1626941">nil</span>&nbsp;<span class="op" id="1626945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626949">s</span><span class="op" id="1626950">.</span><span class="ident" id="1626951">prev</span><span class="op" id="1626955">.</span><span class="ident" id="1626956">next</span>&nbsp;<span class="op" id="1626961">=</span>&nbsp;<span class="ident" id="1626963">s</span><span class="op" id="1626964">.</span><span class="ident" id="1626965">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1626971">}</span>&nbsp;<span class="keyword" id="1626973">else</span>&nbsp;<span class="op" id="1626978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626982">root</span><span class="op" id="1626986">.</span><span class="ident" id="1626987">head</span>&nbsp;<span class="op" id="1626992">=</span>&nbsp;<span class="ident" id="1626994">s</span><span class="op" id="1626995">.</span><span class="ident" id="1626996">next</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627005">s</span><span class="op" id="1627006">.</span><span class="ident" id="1627007">elem</span>&nbsp;<span class="op" id="1627012">=</span>&nbsp;<span class="ident" id="1627014">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627019">s</span><span class="op" id="1627020">.</span><span class="ident" id="1627021">next</span>&nbsp;<span class="op" id="1627026">=</span>&nbsp;<span class="ident" id="1627028">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627033">s</span><span class="op" id="1627034">.</span><span class="ident" id="1627035">prev</span>&nbsp;<span class="op" id="1627040">=</span>&nbsp;<span class="ident" id="1627042">nil</span><br>
<span class="lineno"></span><span class="op" id="1627046">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="1627049">//&nbsp;Synchronous&nbsp;semaphore&nbsp;for&nbsp;sync.Cond.</span><br>
<span class="lineno"></span><span class="keyword" id="1627089">type</span>&nbsp;<span class="ident" id="1627094">syncSema</span>&nbsp;<span class="keyword" id="1627103">struct</span>&nbsp;<span class="op" id="1627110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627113">lock</span>&nbsp;<span class="ident" id="1627118">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627125">head</span>&nbsp;<span class="op" id="1627130">*</span><span class="ident" id="1627131">sudog</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627138">tail</span>&nbsp;<span class="op" id="1627143">*</span><span class="ident" id="1627144">sudog</span><br>
<span class="lineno"></span><span class="op" id="1627150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1627153">//&nbsp;Syncsemacquire&nbsp;waits&nbsp;for&nbsp;a&nbsp;pairing&nbsp;syncsemrelease&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1627231">func</span>&nbsp;<span class="ident" id="1627236">syncsemacquire</span><span class="op" id="1627250">(</span><span class="ident" id="1627251">s</span>&nbsp;<span class="op" id="1627253">*</span><span class="ident" id="1627254">syncSema</span><span class="op" id="1627262">)</span>&nbsp;<span class="op" id="1627264">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627267">lock</span><span class="op" id="1627271">(</span><span class="op" id="1627272">&amp;</span><span class="ident" id="1627273">s</span><span class="op" id="1627274">.</span><span class="ident" id="1627275">lock</span><span class="op" id="1627279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627282">if</span>&nbsp;<span class="ident" id="1627285">s</span><span class="op" id="1627286">.</span><span class="ident" id="1627287">head</span>&nbsp;<span class="op" id="1627292">!=</span>&nbsp;<span class="ident" id="1627295">nil</span>&nbsp;<span class="op" id="1627299">&amp;&amp;</span>&nbsp;<span class="ident" id="1627302">s</span><span class="op" id="1627303">.</span><span class="ident" id="1627304">head</span><span class="op" id="1627308">.</span><span class="ident" id="1627309">nrelease</span>&nbsp;<span class="op" id="1627318">&gt;</span>&nbsp;<span class="num" id="1627320">0</span>&nbsp;<span class="op" id="1627322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627326">//&nbsp;Have&nbsp;pending&nbsp;release,&nbsp;consume&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627365">var</span>&nbsp;<span class="ident" id="1627369">wake</span>&nbsp;<span class="op" id="1627374">*</span><span class="ident" id="1627375">sudog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627383">s</span><span class="op" id="1627384">.</span><span class="ident" id="1627385">head</span><span class="op" id="1627389">.</span><span class="ident" id="1627390">nrelease</span><span class="op" id="1627398">--</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627403">if</span>&nbsp;<span class="ident" id="1627406">s</span><span class="op" id="1627407">.</span><span class="ident" id="1627408">head</span><span class="op" id="1627412">.</span><span class="ident" id="1627413">nrelease</span>&nbsp;<span class="op" id="1627422">==</span>&nbsp;<span class="num" id="1627425">0</span>&nbsp;<span class="op" id="1627427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627432">wake</span>&nbsp;<span class="op" id="1627437">=</span>&nbsp;<span class="ident" id="1627439">s</span><span class="op" id="1627440">.</span><span class="ident" id="1627441">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627449">s</span><span class="op" id="1627450">.</span><span class="ident" id="1627451">head</span>&nbsp;<span class="op" id="1627456">=</span>&nbsp;<span class="ident" id="1627458">wake</span><span class="op" id="1627462">.</span><span class="ident" id="1627463">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627471">if</span>&nbsp;<span class="ident" id="1627474">s</span><span class="op" id="1627475">.</span><span class="ident" id="1627476">head</span>&nbsp;<span class="op" id="1627481">==</span>&nbsp;<span class="ident" id="1627484">nil</span>&nbsp;<span class="op" id="1627488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627494">s</span><span class="op" id="1627495">.</span><span class="ident" id="1627496">tail</span>&nbsp;<span class="op" id="1627501">=</span>&nbsp;<span class="ident" id="1627503">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627510">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627518">unlock</span><span class="op" id="1627524">(</span><span class="op" id="1627525">&amp;</span><span class="ident" id="1627526">s</span><span class="op" id="1627527">.</span><span class="ident" id="1627528">lock</span><span class="op" id="1627532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627536">if</span>&nbsp;<span class="ident" id="1627539">wake</span>&nbsp;<span class="op" id="1627544">!=</span>&nbsp;<span class="ident" id="1627547">nil</span>&nbsp;<span class="op" id="1627551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627556">wake</span><span class="op" id="1627560">.</span><span class="ident" id="1627561">next</span>&nbsp;<span class="op" id="1627566">=</span>&nbsp;<span class="ident" id="1627568">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627575">goready</span><span class="op" id="1627582">(</span><span class="ident" id="1627583">wake</span><span class="op" id="1627587">.</span><span class="ident" id="1627588">g</span><span class="op" id="1627589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627596">}</span>&nbsp;<span class="keyword" id="1627598">else</span>&nbsp;<span class="op" id="1627603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627607">//&nbsp;Enqueue&nbsp;itself.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627628">w</span>&nbsp;<span class="op" id="1627630">:=</span>&nbsp;<span class="ident" id="1627633">acquireSudog</span><span class="op" id="1627645">(</span><span class="op" id="1627646">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627650">w</span><span class="op" id="1627651">.</span><span class="ident" id="1627652">g</span>&nbsp;<span class="op" id="1627654">=</span>&nbsp;<span class="ident" id="1627656">getg</span><span class="op" id="1627660">(</span><span class="op" id="1627661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627665">w</span><span class="op" id="1627666">.</span><span class="ident" id="1627667">nrelease</span>&nbsp;<span class="op" id="1627676">=</span>&nbsp;<span class="op" id="1627678">-</span><span class="num" id="1627679">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627683">w</span><span class="op" id="1627684">.</span><span class="ident" id="1627685">next</span>&nbsp;<span class="op" id="1627690">=</span>&nbsp;<span class="ident" id="1627692">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627698">w</span><span class="op" id="1627699">.</span><span class="ident" id="1627700">releasetime</span>&nbsp;<span class="op" id="1627712">=</span>&nbsp;<span class="num" id="1627714">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627718">t0</span>&nbsp;<span class="op" id="1627721">:=</span>&nbsp;<span class="ident" id="1627724">int64</span><span class="op" id="1627729">(</span><span class="num" id="1627730">0</span><span class="op" id="1627731">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627735">if</span>&nbsp;<span class="ident" id="1627738">blockprofilerate</span>&nbsp;<span class="op" id="1627755">&gt;</span>&nbsp;<span class="num" id="1627757">0</span>&nbsp;<span class="op" id="1627759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627764">t0</span>&nbsp;<span class="op" id="1627767">=</span>&nbsp;<span class="ident" id="1627769">cputicks</span><span class="op" id="1627777">(</span><span class="op" id="1627778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627783">w</span><span class="op" id="1627784">.</span><span class="ident" id="1627785">releasetime</span>&nbsp;<span class="op" id="1627797">=</span>&nbsp;<span class="op" id="1627799">-</span><span class="num" id="1627800">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627808">if</span>&nbsp;<span class="ident" id="1627811">s</span><span class="op" id="1627812">.</span><span class="ident" id="1627813">tail</span>&nbsp;<span class="op" id="1627818">==</span>&nbsp;<span class="ident" id="1627821">nil</span>&nbsp;<span class="op" id="1627825">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627830">s</span><span class="op" id="1627831">.</span><span class="ident" id="1627832">head</span>&nbsp;<span class="op" id="1627837">=</span>&nbsp;<span class="ident" id="1627839">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627843">}</span>&nbsp;<span class="keyword" id="1627845">else</span>&nbsp;<span class="op" id="1627850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627855">s</span><span class="op" id="1627856">.</span><span class="ident" id="1627857">tail</span><span class="op" id="1627861">.</span><span class="ident" id="1627862">next</span>&nbsp;<span class="op" id="1627867">=</span>&nbsp;<span class="ident" id="1627869">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627877">s</span><span class="op" id="1627878">.</span><span class="ident" id="1627879">tail</span>&nbsp;<span class="op" id="1627884">=</span>&nbsp;<span class="ident" id="1627886">w</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627890">goparkunlock</span><span class="op" id="1627902">(</span><span class="op" id="1627903">&amp;</span><span class="ident" id="1627904">s</span><span class="op" id="1627905">.</span><span class="ident" id="1627906">lock</span><span class="op" id="1627910">,</span>&nbsp;<span class="string" id="1627912">&#34;semacquire&#34;</span><span class="op" id="1627924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627928">if</span>&nbsp;<span class="ident" id="1627931">t0</span>&nbsp;<span class="op" id="1627934">!=</span>&nbsp;<span class="num" id="1627937">0</span>&nbsp;<span class="op" id="1627939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627944">blockevent</span><span class="op" id="1627954">(</span><span class="ident" id="1627955">int64</span><span class="op" id="1627960">(</span><span class="ident" id="1627961">w</span><span class="op" id="1627962">.</span><span class="ident" id="1627963">releasetime</span><span class="op" id="1627974">)</span><span class="op" id="1627975">-</span><span class="ident" id="1627976">t0</span><span class="op" id="1627978">,</span>&nbsp;<span class="num" id="1627980">2</span><span class="op" id="1627981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627989">releaseSudog</span><span class="op" id="1628001">(</span><span class="ident" id="1628002">w</span><span class="op" id="1628003">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628006">}</span><br>
<span class="lineno"></span><span class="op" id="1628008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1628011">//&nbsp;Syncsemrelease&nbsp;waits&nbsp;for&nbsp;n&nbsp;pairing&nbsp;syncsemacquire&nbsp;on&nbsp;the&nbsp;same&nbsp;semaphore&nbsp;s.</span><br>
<span class="lineno"></span><span class="keyword" id="1628089">func</span>&nbsp;<span class="ident" id="1628094">syncsemrelease</span><span class="op" id="1628108">(</span><span class="ident" id="1628109">s</span>&nbsp;<span class="op" id="1628111">*</span><span class="ident" id="1628112">syncSema</span><span class="op" id="1628120">,</span>&nbsp;<span class="ident" id="1628122">n</span>&nbsp;<span class="builtintype" id="1628124">uint32</span><span class="op" id="1628130">)</span>&nbsp;<span class="op" id="1628132">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628135">lock</span><span class="op" id="1628139">(</span><span class="op" id="1628140">&amp;</span><span class="ident" id="1628141">s</span><span class="op" id="1628142">.</span><span class="ident" id="1628143">lock</span><span class="op" id="1628147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628150">for</span>&nbsp;<span class="ident" id="1628154">n</span>&nbsp;<span class="op" id="1628156">&gt;</span>&nbsp;<span class="num" id="1628158">0</span>&nbsp;<span class="op" id="1628160">&amp;&amp;</span>&nbsp;<span class="ident" id="1628163">s</span><span class="op" id="1628164">.</span><span class="ident" id="1628165">head</span>&nbsp;<span class="op" id="1628170">!=</span>&nbsp;<span class="ident" id="1628173">nil</span>&nbsp;<span class="op" id="1628177">&amp;&amp;</span>&nbsp;<span class="ident" id="1628180">s</span><span class="op" id="1628181">.</span><span class="ident" id="1628182">head</span><span class="op" id="1628186">.</span><span class="ident" id="1628187">nrelease</span>&nbsp;<span class="op" id="1628196">&lt;</span>&nbsp;<span class="num" id="1628198">0</span>&nbsp;<span class="op" id="1628200">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628204">//&nbsp;Have&nbsp;pending&nbsp;acquire,&nbsp;satisfy&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628243">wake</span>&nbsp;<span class="op" id="1628248">:=</span>&nbsp;<span class="ident" id="1628251">s</span><span class="op" id="1628252">.</span><span class="ident" id="1628253">head</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628260">s</span><span class="op" id="1628261">.</span><span class="ident" id="1628262">head</span>&nbsp;<span class="op" id="1628267">=</span>&nbsp;<span class="ident" id="1628269">wake</span><span class="op" id="1628273">.</span><span class="ident" id="1628274">next</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628281">if</span>&nbsp;<span class="ident" id="1628284">s</span><span class="op" id="1628285">.</span><span class="ident" id="1628286">head</span>&nbsp;<span class="op" id="1628291">==</span>&nbsp;<span class="ident" id="1628294">nil</span>&nbsp;<span class="op" id="1628298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628303">s</span><span class="op" id="1628304">.</span><span class="ident" id="1628305">tail</span>&nbsp;<span class="op" id="1628310">=</span>&nbsp;<span class="ident" id="1628312">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628322">if</span>&nbsp;<span class="ident" id="1628325">wake</span><span class="op" id="1628329">.</span><span class="ident" id="1628330">releasetime</span>&nbsp;<span class="op" id="1628342">!=</span>&nbsp;<span class="num" id="1628345">0</span>&nbsp;<span class="op" id="1628347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628352">wake</span><span class="op" id="1628356">.</span><span class="ident" id="1628357">releasetime</span>&nbsp;<span class="op" id="1628369">=</span>&nbsp;<span class="ident" id="1628371">cputicks</span><span class="op" id="1628379">(</span><span class="op" id="1628380">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628388">wake</span><span class="op" id="1628392">.</span><span class="ident" id="1628393">next</span>&nbsp;<span class="op" id="1628398">=</span>&nbsp;<span class="ident" id="1628400">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628406">goready</span><span class="op" id="1628413">(</span><span class="ident" id="1628414">wake</span><span class="op" id="1628418">.</span><span class="ident" id="1628419">g</span><span class="op" id="1628420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628424">n</span><span class="op" id="1628425">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628429">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628432">if</span>&nbsp;<span class="ident" id="1628435">n</span>&nbsp;<span class="op" id="1628437">&gt;</span>&nbsp;<span class="num" id="1628439">0</span>&nbsp;<span class="op" id="1628441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628445">//&nbsp;enqueue&nbsp;itself</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628465">w</span>&nbsp;<span class="op" id="1628467">:=</span>&nbsp;<span class="ident" id="1628470">acquireSudog</span><span class="op" id="1628482">(</span><span class="op" id="1628483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628487">w</span><span class="op" id="1628488">.</span><span class="ident" id="1628489">g</span>&nbsp;<span class="op" id="1628491">=</span>&nbsp;<span class="ident" id="1628493">getg</span><span class="op" id="1628497">(</span><span class="op" id="1628498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628502">w</span><span class="op" id="1628503">.</span><span class="ident" id="1628504">nrelease</span>&nbsp;<span class="op" id="1628513">=</span>&nbsp;<span class="builtintype" id="1628515">int32</span><span class="op" id="1628520">(</span><span class="ident" id="1628521">n</span><span class="op" id="1628522">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628526">w</span><span class="op" id="1628527">.</span><span class="ident" id="1628528">next</span>&nbsp;<span class="op" id="1628533">=</span>&nbsp;<span class="ident" id="1628535">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628541">w</span><span class="op" id="1628542">.</span><span class="ident" id="1628543">releasetime</span>&nbsp;<span class="op" id="1628555">=</span>&nbsp;<span class="num" id="1628557">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628561">if</span>&nbsp;<span class="ident" id="1628564">s</span><span class="op" id="1628565">.</span><span class="ident" id="1628566">tail</span>&nbsp;<span class="op" id="1628571">==</span>&nbsp;<span class="ident" id="1628574">nil</span>&nbsp;<span class="op" id="1628578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628583">s</span><span class="op" id="1628584">.</span><span class="ident" id="1628585">head</span>&nbsp;<span class="op" id="1628590">=</span>&nbsp;<span class="ident" id="1628592">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628596">}</span>&nbsp;<span class="keyword" id="1628598">else</span>&nbsp;<span class="op" id="1628603">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628608">s</span><span class="op" id="1628609">.</span><span class="ident" id="1628610">tail</span><span class="op" id="1628614">.</span><span class="ident" id="1628615">next</span>&nbsp;<span class="op" id="1628620">=</span>&nbsp;<span class="ident" id="1628622">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628630">s</span><span class="op" id="1628631">.</span><span class="ident" id="1628632">tail</span>&nbsp;<span class="op" id="1628637">=</span>&nbsp;<span class="ident" id="1628639">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628643">goparkunlock</span><span class="op" id="1628655">(</span><span class="op" id="1628656">&amp;</span><span class="ident" id="1628657">s</span><span class="op" id="1628658">.</span><span class="ident" id="1628659">lock</span><span class="op" id="1628663">,</span>&nbsp;<span class="string" id="1628665">&#34;semarelease&#34;</span><span class="op" id="1628678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628682">releaseSudog</span><span class="op" id="1628694">(</span><span class="ident" id="1628695">w</span><span class="op" id="1628696">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628699">}</span>&nbsp;<span class="keyword" id="1628701">else</span>&nbsp;<span class="op" id="1628706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628710">unlock</span><span class="op" id="1628716">(</span><span class="op" id="1628717">&amp;</span><span class="ident" id="1628718">s</span><span class="op" id="1628719">.</span><span class="ident" id="1628720">lock</span><span class="op" id="1628724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628727">}</span><br>
<span class="lineno"></span><span class="op" id="1628729">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1628732">func</span>&nbsp;<span class="ident" id="1628737">syncsemcheck</span><span class="op" id="1628749">(</span><span class="ident" id="1628750">sz</span>&nbsp;<span class="builtintype" id="1628753">uintptr</span><span class="op" id="1628760">)</span>&nbsp;<span class="op" id="1628762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628765">if</span>&nbsp;<span class="ident" id="1628768">sz</span>&nbsp;<span class="op" id="1628771">!=</span>&nbsp;<span class="ident" id="1628774">unsafe</span><span class="op" id="1628780">.</span><span class="ident" id="1628781">Sizeof</span><span class="op" id="1628787">(</span><span class="ident" id="1628788">syncSema</span><span class="op" id="1628796">{</span><span class="op" id="1628797">}</span><span class="op" id="1628798">)</span>&nbsp;<span class="op" id="1628800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1628804">print</span><span class="op" id="1628809">(</span><span class="string" id="1628810">&#34;runtime:&nbsp;bad&nbsp;syncSema&nbsp;size&nbsp;-&nbsp;sync=&#34;</span><span class="op" id="1628846">,</span>&nbsp;<span class="ident" id="1628848">sz</span><span class="op" id="1628850">,</span>&nbsp;<span class="string" id="1628852">&#34;&nbsp;runtime=&#34;</span><span class="op" id="1628863">,</span>&nbsp;<span class="ident" id="1628865">unsafe</span><span class="op" id="1628871">.</span><span class="ident" id="1628872">Sizeof</span><span class="op" id="1628878">(</span><span class="ident" id="1628879">syncSema</span><span class="op" id="1628887">{</span><span class="op" id="1628888">}</span><span class="op" id="1628889">)</span><span class="op" id="1628890">,</span>&nbsp;<span class="string" id="1628892">&#34;\n&#34;</span><span class="op" id="1628896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628900">gothrow</span><span class="op" id="1628907">(</span><span class="string" id="1628908">&#34;bad&nbsp;syncSema&nbsp;size&#34;</span><span class="op" id="1628927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628930">}</span><br>
<span class="lineno">275</span><span class="op" id="1628932">}</span>
</div>
</body>
</html>
