<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3226829">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3226884">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3226938">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3226989">package</span>&nbsp;<span class="ident" id="3226997">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3227002">import</span>&nbsp;<span class="op" id="3227009">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3227012">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3227018">&#34;reflect&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3227029">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3227036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3227039">//&nbsp;An&nbsp;Encoder&nbsp;manages&nbsp;the&nbsp;transmission&nbsp;of&nbsp;type&nbsp;and&nbsp;data&nbsp;information&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3227114">//&nbsp;other&nbsp;side&nbsp;of&nbsp;a&nbsp;connection.</span><br>
<span class="lineno">15</span><span class="keyword" id="3227145">type</span>&nbsp;<span class="ident" id="3227150">Encoder</span>&nbsp;<span class="keyword" id="3227158">struct</span>&nbsp;<span class="op" id="3227165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227168">mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3227179">sync</span><span class="op" id="3227183">.</span><span class="ident" id="3227184">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3227203">//&nbsp;each&nbsp;item&nbsp;must&nbsp;be&nbsp;sent&nbsp;atomically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227241">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3227252">[</span><span class="op" id="3227253">]</span><span class="ident" id="3227254">io</span><span class="op" id="3227256">.</span><span class="ident" id="3227257">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3227276">//&nbsp;where&nbsp;to&nbsp;send&nbsp;the&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227303">sent</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3227314">map</span><span class="op" id="3227317">[</span><span class="ident" id="3227318">reflect</span><span class="op" id="3227325">.</span><span class="ident" id="3227326">Type</span><span class="op" id="3227330">]</span><span class="ident" id="3227331">typeId</span>&nbsp;<span class="comment" id="3227338">//&nbsp;which&nbsp;types&nbsp;we&#39;ve&nbsp;already&nbsp;sent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227373">countState</span>&nbsp;<span class="op" id="3227384">*</span><span class="ident" id="3227385">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3227408">//&nbsp;stage&nbsp;for&nbsp;writing&nbsp;counts</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227437">freeList</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3227448">*</span><span class="ident" id="3227449">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3227472">//&nbsp;list&nbsp;of&nbsp;free&nbsp;encoderStates;&nbsp;avoids&nbsp;reallocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227524">byteBuf</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3227535">encBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3227559">//&nbsp;buffer&nbsp;for&nbsp;top-level&nbsp;encoderState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227597">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3227608">error</span><br>
<span class="lineno"></span><span class="op" id="3227614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3227617">//&nbsp;Before&nbsp;we&nbsp;encode&nbsp;a&nbsp;message,&nbsp;we&nbsp;reserve&nbsp;space&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3227684">//&nbsp;buffer&nbsp;in&nbsp;which&nbsp;to&nbsp;encode&nbsp;its&nbsp;length.&nbsp;This&nbsp;means&nbsp;we&nbsp;can&nbsp;use&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3227751">//&nbsp;buffer&nbsp;to&nbsp;assemble&nbsp;the&nbsp;message&nbsp;without&nbsp;another&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3227813">const</span>&nbsp;<span class="ident" id="3227819">maxLength</span>&nbsp;<span class="op" id="3227829">=</span>&nbsp;<span class="num" id="3227831">9</span>&nbsp;<span class="comment" id="3227833">//&nbsp;Maximum&nbsp;size&nbsp;of&nbsp;an&nbsp;encoded&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="3227871">var</span>&nbsp;<span class="ident" id="3227875">spaceForLength</span>&nbsp;<span class="op" id="3227890">=</span>&nbsp;<span class="builtinfunc" id="3227892">make</span><span class="op" id="3227896">(</span><span class="op" id="3227897">[</span><span class="op" id="3227898">]</span><span class="builtintype" id="3227899">byte</span><span class="op" id="3227903">,</span>&nbsp;<span class="ident" id="3227905">maxLength</span><span class="op" id="3227914">)</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment" id="3227917">//&nbsp;NewEncoder&nbsp;returns&nbsp;a&nbsp;new&nbsp;encoder&nbsp;that&nbsp;will&nbsp;transmit&nbsp;on&nbsp;the&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3227990">func</span>&nbsp;<span class="ident" id="3227995">NewEncoder</span><span class="op" id="3228005">(</span><span class="ident" id="3228006">w</span>&nbsp;<span class="ident" id="3228008">io</span><span class="op" id="3228010">.</span><span class="ident" id="3228011">Writer</span><span class="op" id="3228017">)</span>&nbsp;<span class="op" id="3228019">*</span><span class="ident" id="3228020">Encoder</span>&nbsp;<span class="op" id="3228028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228031">enc</span>&nbsp;<span class="op" id="3228035">:=</span>&nbsp;<span class="builtinfunc" id="3228038">new</span><span class="op" id="3228041">(</span><span class="ident" id="3228042">Encoder</span><span class="op" id="3228049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228052">enc</span><span class="op" id="3228055">.</span><span class="ident" id="3228056">w</span>&nbsp;<span class="op" id="3228058">=</span>&nbsp;<span class="op" id="3228060">[</span><span class="op" id="3228061">]</span><span class="ident" id="3228062">io</span><span class="op" id="3228064">.</span><span class="ident" id="3228065">Writer</span><span class="op" id="3228071">{</span><span class="ident" id="3228072">w</span><span class="op" id="3228073">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228076">enc</span><span class="op" id="3228079">.</span><span class="ident" id="3228080">sent</span>&nbsp;<span class="op" id="3228085">=</span>&nbsp;<span class="builtinfunc" id="3228087">make</span><span class="op" id="3228091">(</span><span class="keyword" id="3228092">map</span><span class="op" id="3228095">[</span><span class="ident" id="3228096">reflect</span><span class="op" id="3228103">.</span><span class="ident" id="3228104">Type</span><span class="op" id="3228108">]</span><span class="ident" id="3228109">typeId</span><span class="op" id="3228115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228118">enc</span><span class="op" id="3228121">.</span><span class="ident" id="3228122">countState</span>&nbsp;<span class="op" id="3228133">=</span>&nbsp;<span class="ident" id="3228135">enc</span><span class="op" id="3228138">.</span><span class="ident" id="3228139">newEncoderState</span><span class="op" id="3228154">(</span><span class="builtinfunc" id="3228155">new</span><span class="op" id="3228158">(</span><span class="ident" id="3228159">encBuffer</span><span class="op" id="3228168">)</span><span class="op" id="3228169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228172">return</span>&nbsp;<span class="ident" id="3228179">enc</span><br>
<span class="lineno"></span><span class="op" id="3228183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3228186">//&nbsp;writer()&nbsp;returns&nbsp;the&nbsp;innermost&nbsp;writer&nbsp;the&nbsp;encoder&nbsp;is&nbsp;using</span><br>
<span class="lineno"></span><span class="keyword" id="3228248">func</span>&nbsp;<span class="op" id="3228253">(</span><span class="ident" id="3228254">enc</span>&nbsp;<span class="op" id="3228258">*</span><span class="ident" id="3228259">Encoder</span><span class="op" id="3228266">)</span>&nbsp;<span class="ident" id="3228268">writer</span><span class="op" id="3228274">(</span><span class="op" id="3228275">)</span>&nbsp;<span class="ident" id="3228277">io</span><span class="op" id="3228279">.</span><span class="ident" id="3228280">Writer</span>&nbsp;<span class="op" id="3228287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228290">return</span>&nbsp;<span class="ident" id="3228297">enc</span><span class="op" id="3228300">.</span><span class="ident" id="3228301">w</span><span class="op" id="3228302">[</span><span class="builtinfunc" id="3228303">len</span><span class="op" id="3228306">(</span><span class="ident" id="3228307">enc</span><span class="op" id="3228310">.</span><span class="ident" id="3228311">w</span><span class="op" id="3228312">)</span><span class="op" id="3228313">-</span><span class="num" id="3228314">1</span><span class="op" id="3228315">]</span><br>
<span class="lineno"></span><span class="op" id="3228317">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3228320">//&nbsp;pushWriter&nbsp;adds&nbsp;a&nbsp;writer&nbsp;to&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno"></span><span class="keyword" id="3228364">func</span>&nbsp;<span class="op" id="3228369">(</span><span class="ident" id="3228370">enc</span>&nbsp;<span class="op" id="3228374">*</span><span class="ident" id="3228375">Encoder</span><span class="op" id="3228382">)</span>&nbsp;<span class="ident" id="3228384">pushWriter</span><span class="op" id="3228394">(</span><span class="ident" id="3228395">w</span>&nbsp;<span class="ident" id="3228397">io</span><span class="op" id="3228399">.</span><span class="ident" id="3228400">Writer</span><span class="op" id="3228406">)</span>&nbsp;<span class="op" id="3228408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228411">enc</span><span class="op" id="3228414">.</span><span class="ident" id="3228415">w</span>&nbsp;<span class="op" id="3228417">=</span>&nbsp;<span class="builtinfunc" id="3228419">append</span><span class="op" id="3228425">(</span><span class="ident" id="3228426">enc</span><span class="op" id="3228429">.</span><span class="ident" id="3228430">w</span><span class="op" id="3228431">,</span>&nbsp;<span class="ident" id="3228433">w</span><span class="op" id="3228434">)</span><br>
<span class="lineno"></span><span class="op" id="3228436">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3228439">//&nbsp;popWriter&nbsp;pops&nbsp;the&nbsp;innermost&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3228479">func</span>&nbsp;<span class="op" id="3228484">(</span><span class="ident" id="3228485">enc</span>&nbsp;<span class="op" id="3228489">*</span><span class="ident" id="3228490">Encoder</span><span class="op" id="3228497">)</span>&nbsp;<span class="ident" id="3228499">popWriter</span><span class="op" id="3228508">(</span><span class="op" id="3228509">)</span>&nbsp;<span class="op" id="3228511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228514">enc</span><span class="op" id="3228517">.</span><span class="ident" id="3228518">w</span>&nbsp;<span class="op" id="3228520">=</span>&nbsp;<span class="ident" id="3228522">enc</span><span class="op" id="3228525">.</span><span class="ident" id="3228526">w</span><span class="op" id="3228527">[</span><span class="num" id="3228528">0</span>&nbsp;<span class="op" id="3228530">:</span>&nbsp;<span class="builtinfunc" id="3228532">len</span><span class="op" id="3228535">(</span><span class="ident" id="3228536">enc</span><span class="op" id="3228539">.</span><span class="ident" id="3228540">w</span><span class="op" id="3228541">)</span><span class="op" id="3228542">-</span><span class="num" id="3228543">1</span><span class="op" id="3228544">]</span><br>
<span class="lineno"></span><span class="op" id="3228546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="3228549">func</span>&nbsp;<span class="op" id="3228554">(</span><span class="ident" id="3228555">enc</span>&nbsp;<span class="op" id="3228559">*</span><span class="ident" id="3228560">Encoder</span><span class="op" id="3228567">)</span>&nbsp;<span class="ident" id="3228569">setError</span><span class="op" id="3228577">(</span><span class="ident" id="3228578">err</span>&nbsp;<span class="builtintype" id="3228582">error</span><span class="op" id="3228587">)</span>&nbsp;<span class="op" id="3228589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228592">if</span>&nbsp;<span class="ident" id="3228595">enc</span><span class="op" id="3228598">.</span><span class="ident" id="3228599">err</span>&nbsp;<span class="op" id="3228603">==</span>&nbsp;<span class="ident" id="3228606">nil</span>&nbsp;<span class="op" id="3228610">{</span>&nbsp;<span class="comment" id="3228612">//&nbsp;remember&nbsp;the&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228637">enc</span><span class="op" id="3228640">.</span><span class="ident" id="3228641">err</span>&nbsp;<span class="op" id="3228645">=</span>&nbsp;<span class="ident" id="3228647">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228652">}</span><br>
<span class="lineno"></span><span class="op" id="3228654">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3228657">//&nbsp;writeMessage&nbsp;sends&nbsp;the&nbsp;data&nbsp;item&nbsp;preceded&nbsp;by&nbsp;a&nbsp;unsigned&nbsp;count&nbsp;of&nbsp;its&nbsp;length.</span><br>
<span class="lineno"></span><span class="keyword" id="3228737">func</span>&nbsp;<span class="op" id="3228742">(</span><span class="ident" id="3228743">enc</span>&nbsp;<span class="op" id="3228747">*</span><span class="ident" id="3228748">Encoder</span><span class="op" id="3228755">)</span>&nbsp;<span class="ident" id="3228757">writeMessage</span><span class="op" id="3228769">(</span><span class="ident" id="3228770">w</span>&nbsp;<span class="ident" id="3228772">io</span><span class="op" id="3228774">.</span><span class="ident" id="3228775">Writer</span><span class="op" id="3228781">,</span>&nbsp;<span class="ident" id="3228783">b</span>&nbsp;<span class="op" id="3228785">*</span><span class="ident" id="3228786">encBuffer</span><span class="op" id="3228795">)</span>&nbsp;<span class="op" id="3228797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3228800">//&nbsp;Space&nbsp;has&nbsp;been&nbsp;reserved&nbsp;for&nbsp;the&nbsp;length&nbsp;at&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3228871">//&nbsp;This&nbsp;is&nbsp;a&nbsp;little&nbsp;dirty:&nbsp;we&nbsp;grab&nbsp;the&nbsp;slice&nbsp;from&nbsp;the&nbsp;bytes.Buffer&nbsp;and&nbsp;massage</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3228951">//&nbsp;it&nbsp;by&nbsp;hand.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228967">message</span>&nbsp;<span class="op" id="3228975">:=</span>&nbsp;<span class="ident" id="3228978">b</span><span class="op" id="3228979">.</span><span class="ident" id="3228980">Bytes</span><span class="op" id="3228985">(</span><span class="op" id="3228986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228989">messageLen</span>&nbsp;<span class="op" id="3229000">:=</span>&nbsp;<span class="builtinfunc" id="3229003">len</span><span class="op" id="3229006">(</span><span class="ident" id="3229007">message</span><span class="op" id="3229014">)</span>&nbsp;<span class="op" id="3229016">-</span>&nbsp;<span class="ident" id="3229018">maxLength</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229029">//&nbsp;Encode&nbsp;the&nbsp;length.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229052">enc</span><span class="op" id="3229055">.</span><span class="ident" id="3229056">countState</span><span class="op" id="3229066">.</span><span class="ident" id="3229067">b</span><span class="op" id="3229068">.</span><span class="ident" id="3229069">Reset</span><span class="op" id="3229074">(</span><span class="op" id="3229075">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229078">enc</span><span class="op" id="3229081">.</span><span class="ident" id="3229082">countState</span><span class="op" id="3229092">.</span><span class="ident" id="3229093">encodeUint</span><span class="op" id="3229103">(</span><span class="ident" id="3229104">uint64</span><span class="op" id="3229110">(</span><span class="ident" id="3229111">messageLen</span><span class="op" id="3229121">)</span><span class="op" id="3229122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229125">//&nbsp;Copy&nbsp;the&nbsp;length&nbsp;to&nbsp;be&nbsp;a&nbsp;prefix&nbsp;of&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229176">offset</span>&nbsp;<span class="op" id="3229183">:=</span>&nbsp;<span class="ident" id="3229186">maxLength</span>&nbsp;<span class="op" id="3229196">-</span>&nbsp;<span class="ident" id="3229198">enc</span><span class="op" id="3229201">.</span><span class="ident" id="3229202">countState</span><span class="op" id="3229212">.</span><span class="ident" id="3229213">b</span><span class="op" id="3229214">.</span><span class="ident" id="3229215">Len</span><span class="op" id="3229218">(</span><span class="op" id="3229219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3229222">copy</span><span class="op" id="3229226">(</span><span class="ident" id="3229227">message</span><span class="op" id="3229234">[</span><span class="ident" id="3229235">offset</span><span class="op" id="3229241">:</span><span class="op" id="3229242">]</span><span class="op" id="3229243">,</span>&nbsp;<span class="ident" id="3229245">enc</span><span class="op" id="3229248">.</span><span class="ident" id="3229249">countState</span><span class="op" id="3229259">.</span><span class="ident" id="3229260">b</span><span class="op" id="3229261">.</span><span class="ident" id="3229262">Bytes</span><span class="op" id="3229267">(</span><span class="op" id="3229268">)</span><span class="op" id="3229269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229272">//&nbsp;Write&nbsp;the&nbsp;data.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229292">_</span><span class="op" id="3229293">,</span>&nbsp;<span class="ident" id="3229295">err</span>&nbsp;<span class="op" id="3229299">:=</span>&nbsp;<span class="ident" id="3229302">w</span><span class="op" id="3229303">.</span><span class="ident" id="3229304">Write</span><span class="op" id="3229309">(</span><span class="ident" id="3229310">message</span><span class="op" id="3229317">[</span><span class="ident" id="3229318">offset</span><span class="op" id="3229324">:</span><span class="op" id="3229325">]</span><span class="op" id="3229326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229329">//&nbsp;Drain&nbsp;the&nbsp;buffer&nbsp;and&nbsp;restore&nbsp;the&nbsp;space&nbsp;at&nbsp;the&nbsp;front&nbsp;for&nbsp;the&nbsp;count&nbsp;of&nbsp;the&nbsp;next&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229420">b</span><span class="op" id="3229421">.</span><span class="ident" id="3229422">Reset</span><span class="op" id="3229427">(</span><span class="op" id="3229428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229431">b</span><span class="op" id="3229432">.</span><span class="ident" id="3229433">Write</span><span class="op" id="3229438">(</span><span class="ident" id="3229439">spaceForLength</span><span class="op" id="3229453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229456">if</span>&nbsp;<span class="ident" id="3229459">err</span>&nbsp;<span class="op" id="3229463">!=</span>&nbsp;<span class="ident" id="3229466">nil</span>&nbsp;<span class="op" id="3229470">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229474">enc</span><span class="op" id="3229477">.</span><span class="ident" id="3229478">setError</span><span class="op" id="3229486">(</span><span class="ident" id="3229487">err</span><span class="op" id="3229490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229493">}</span><br>
<span class="lineno"></span><span class="op" id="3229495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3229498">//&nbsp;sendActualType&nbsp;sends&nbsp;the&nbsp;requested&nbsp;type,&nbsp;without&nbsp;further&nbsp;investigation,&nbsp;unless</span><br>
<span class="lineno">85</span><span class="comment" id="3229580">//&nbsp;it&#39;s&nbsp;been&nbsp;sent&nbsp;before.</span><br>
<span class="lineno"></span><span class="keyword" id="3229606">func</span>&nbsp;<span class="op" id="3229611">(</span><span class="ident" id="3229612">enc</span>&nbsp;<span class="op" id="3229616">*</span><span class="ident" id="3229617">Encoder</span><span class="op" id="3229624">)</span>&nbsp;<span class="ident" id="3229626">sendActualType</span><span class="op" id="3229640">(</span><span class="ident" id="3229641">w</span>&nbsp;<span class="ident" id="3229643">io</span><span class="op" id="3229645">.</span><span class="ident" id="3229646">Writer</span><span class="op" id="3229652">,</span>&nbsp;<span class="ident" id="3229654">state</span>&nbsp;<span class="op" id="3229660">*</span><span class="ident" id="3229661">encoderState</span><span class="op" id="3229673">,</span>&nbsp;<span class="ident" id="3229675">ut</span>&nbsp;<span class="op" id="3229678">*</span><span class="ident" id="3229679">userTypeInfo</span><span class="op" id="3229691">,</span>&nbsp;<span class="ident" id="3229693">actual</span>&nbsp;<span class="ident" id="3229700">reflect</span><span class="op" id="3229707">.</span><span class="ident" id="3229708">Type</span><span class="op" id="3229712">)</span>&nbsp;<span class="op" id="3229714">(</span><span class="ident" id="3229715">sent</span>&nbsp;<span class="builtintype" id="3229720">bool</span><span class="op" id="3229724">)</span>&nbsp;<span class="op" id="3229726">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229729">if</span>&nbsp;<span class="ident" id="3229732">_</span><span class="op" id="3229733">,</span>&nbsp;<span class="ident" id="3229735">alreadySent</span>&nbsp;<span class="op" id="3229747">:=</span>&nbsp;<span class="ident" id="3229750">enc</span><span class="op" id="3229753">.</span><span class="ident" id="3229754">sent</span><span class="op" id="3229758">[</span><span class="ident" id="3229759">actual</span><span class="op" id="3229765">]</span><span class="op" id="3229766">;</span>&nbsp;<span class="ident" id="3229768">alreadySent</span>&nbsp;<span class="op" id="3229780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229784">return</span>&nbsp;<span class="ident" id="3229791">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229798">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229801">info</span><span class="op" id="3229805">,</span>&nbsp;<span class="ident" id="3229807">err</span>&nbsp;<span class="op" id="3229811">:=</span>&nbsp;<span class="ident" id="3229814">getTypeInfo</span><span class="op" id="3229825">(</span><span class="ident" id="3229826">ut</span><span class="op" id="3229828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229831">if</span>&nbsp;<span class="ident" id="3229834">err</span>&nbsp;<span class="op" id="3229838">!=</span>&nbsp;<span class="ident" id="3229841">nil</span>&nbsp;<span class="op" id="3229845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229849">enc</span><span class="op" id="3229852">.</span><span class="ident" id="3229853">setError</span><span class="op" id="3229861">(</span><span class="ident" id="3229862">err</span><span class="op" id="3229865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229869">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229877">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229880">//&nbsp;Send&nbsp;the&nbsp;pair&nbsp;(-id,&nbsp;type)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229910">//&nbsp;Id:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229918">state</span><span class="op" id="3229923">.</span><span class="ident" id="3229924">encodeInt</span><span class="op" id="3229933">(</span><span class="op" id="3229934">-</span><span class="ident" id="3229935">int64</span><span class="op" id="3229940">(</span><span class="ident" id="3229941">info</span><span class="op" id="3229945">.</span><span class="ident" id="3229946">id</span><span class="op" id="3229948">)</span><span class="op" id="3229949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3229952">//&nbsp;Type:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229962">enc</span><span class="op" id="3229965">.</span><span class="ident" id="3229966">encode</span><span class="op" id="3229972">(</span><span class="ident" id="3229973">state</span><span class="op" id="3229978">.</span><span class="ident" id="3229979">b</span><span class="op" id="3229980">,</span>&nbsp;<span class="ident" id="3229982">reflect</span><span class="op" id="3229989">.</span><span class="ident" id="3229990">ValueOf</span><span class="op" id="3229997">(</span><span class="ident" id="3229998">info</span><span class="op" id="3230002">.</span><span class="ident" id="3230003">wire</span><span class="op" id="3230007">)</span><span class="op" id="3230008">,</span>&nbsp;<span class="ident" id="3230010">wireTypeUserInfo</span><span class="op" id="3230026">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230029">enc</span><span class="op" id="3230032">.</span><span class="ident" id="3230033">writeMessage</span><span class="op" id="3230045">(</span><span class="ident" id="3230046">w</span><span class="op" id="3230047">,</span>&nbsp;<span class="ident" id="3230049">state</span><span class="op" id="3230054">.</span><span class="ident" id="3230055">b</span><span class="op" id="3230056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230059">if</span>&nbsp;<span class="ident" id="3230062">enc</span><span class="op" id="3230065">.</span><span class="ident" id="3230066">err</span>&nbsp;<span class="op" id="3230070">!=</span>&nbsp;<span class="ident" id="3230073">nil</span>&nbsp;<span class="op" id="3230077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230081">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230093">//&nbsp;Remember&nbsp;we&#39;ve&nbsp;sent&nbsp;this&nbsp;type,&nbsp;both&nbsp;what&nbsp;the&nbsp;user&nbsp;gave&nbsp;us&nbsp;and&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230174">enc</span><span class="op" id="3230177">.</span><span class="ident" id="3230178">sent</span><span class="op" id="3230182">[</span><span class="ident" id="3230183">ut</span><span class="op" id="3230185">.</span><span class="ident" id="3230186">base</span><span class="op" id="3230190">]</span>&nbsp;<span class="op" id="3230192">=</span>&nbsp;<span class="ident" id="3230194">info</span><span class="op" id="3230198">.</span><span class="ident" id="3230199">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230203">if</span>&nbsp;<span class="ident" id="3230206">ut</span><span class="op" id="3230208">.</span><span class="ident" id="3230209">user</span>&nbsp;<span class="op" id="3230214">!=</span>&nbsp;<span class="ident" id="3230217">ut</span><span class="op" id="3230219">.</span><span class="ident" id="3230220">base</span>&nbsp;<span class="op" id="3230225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230229">enc</span><span class="op" id="3230232">.</span><span class="ident" id="3230233">sent</span><span class="op" id="3230237">[</span><span class="ident" id="3230238">ut</span><span class="op" id="3230240">.</span><span class="ident" id="3230241">user</span><span class="op" id="3230245">]</span>&nbsp;<span class="op" id="3230247">=</span>&nbsp;<span class="ident" id="3230249">info</span><span class="op" id="3230253">.</span><span class="ident" id="3230254">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230258">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230261">//&nbsp;Now&nbsp;send&nbsp;the&nbsp;inner&nbsp;types</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230290">switch</span>&nbsp;<span class="ident" id="3230297">st</span>&nbsp;<span class="op" id="3230300">:=</span>&nbsp;<span class="ident" id="3230303">actual</span><span class="op" id="3230309">;</span>&nbsp;<span class="ident" id="3230311">st</span><span class="op" id="3230313">.</span><span class="ident" id="3230314">Kind</span><span class="op" id="3230318">(</span><span class="op" id="3230319">)</span>&nbsp;<span class="op" id="3230321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230324">case</span>&nbsp;<span class="ident" id="3230329">reflect</span><span class="op" id="3230336">.</span><span class="ident" id="3230337">Struct</span><span class="op" id="3230343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230347">for</span>&nbsp;<span class="ident" id="3230351">i</span>&nbsp;<span class="op" id="3230353">:=</span>&nbsp;<span class="num" id="3230356">0</span><span class="op" id="3230357">;</span>&nbsp;<span class="ident" id="3230359">i</span>&nbsp;<span class="op" id="3230361">&lt;</span>&nbsp;<span class="ident" id="3230363">st</span><span class="op" id="3230365">.</span><span class="ident" id="3230366">NumField</span><span class="op" id="3230374">(</span><span class="op" id="3230375">)</span><span class="op" id="3230376">;</span>&nbsp;<span class="ident" id="3230378">i</span><span class="op" id="3230379">++</span>&nbsp;<span class="op" id="3230382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230387">if</span>&nbsp;<span class="ident" id="3230390">isExported</span><span class="op" id="3230400">(</span><span class="ident" id="3230401">st</span><span class="op" id="3230403">.</span><span class="ident" id="3230404">Field</span><span class="op" id="3230409">(</span><span class="ident" id="3230410">i</span><span class="op" id="3230411">)</span><span class="op" id="3230412">.</span><span class="ident" id="3230413">Name</span><span class="op" id="3230417">)</span>&nbsp;<span class="op" id="3230419">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230425">enc</span><span class="op" id="3230428">.</span><span class="ident" id="3230429">sendType</span><span class="op" id="3230437">(</span><span class="ident" id="3230438">w</span><span class="op" id="3230439">,</span>&nbsp;<span class="ident" id="3230441">state</span><span class="op" id="3230446">,</span>&nbsp;<span class="ident" id="3230448">st</span><span class="op" id="3230450">.</span><span class="ident" id="3230451">Field</span><span class="op" id="3230456">(</span><span class="ident" id="3230457">i</span><span class="op" id="3230458">)</span><span class="op" id="3230459">.</span><span class="ident" id="3230460">Type</span><span class="op" id="3230464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230473">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230476">case</span>&nbsp;<span class="ident" id="3230481">reflect</span><span class="op" id="3230488">.</span><span class="ident" id="3230489">Array</span><span class="op" id="3230494">,</span>&nbsp;<span class="ident" id="3230496">reflect</span><span class="op" id="3230503">.</span><span class="ident" id="3230504">Slice</span><span class="op" id="3230509">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230513">enc</span><span class="op" id="3230516">.</span><span class="ident" id="3230517">sendType</span><span class="op" id="3230525">(</span><span class="ident" id="3230526">w</span><span class="op" id="3230527">,</span>&nbsp;<span class="ident" id="3230529">state</span><span class="op" id="3230534">,</span>&nbsp;<span class="ident" id="3230536">st</span><span class="op" id="3230538">.</span><span class="ident" id="3230539">Elem</span><span class="op" id="3230543">(</span><span class="op" id="3230544">)</span><span class="op" id="3230545">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230548">case</span>&nbsp;<span class="ident" id="3230553">reflect</span><span class="op" id="3230560">.</span><span class="ident" id="3230561">Map</span><span class="op" id="3230564">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230568">enc</span><span class="op" id="3230571">.</span><span class="ident" id="3230572">sendType</span><span class="op" id="3230580">(</span><span class="ident" id="3230581">w</span><span class="op" id="3230582">,</span>&nbsp;<span class="ident" id="3230584">state</span><span class="op" id="3230589">,</span>&nbsp;<span class="ident" id="3230591">st</span><span class="op" id="3230593">.</span><span class="ident" id="3230594">Key</span><span class="op" id="3230597">(</span><span class="op" id="3230598">)</span><span class="op" id="3230599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230603">enc</span><span class="op" id="3230606">.</span><span class="ident" id="3230607">sendType</span><span class="op" id="3230615">(</span><span class="ident" id="3230616">w</span><span class="op" id="3230617">,</span>&nbsp;<span class="ident" id="3230619">state</span><span class="op" id="3230624">,</span>&nbsp;<span class="ident" id="3230626">st</span><span class="op" id="3230628">.</span><span class="ident" id="3230629">Elem</span><span class="op" id="3230633">(</span><span class="op" id="3230634">)</span><span class="op" id="3230635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230641">return</span>&nbsp;<span class="ident" id="3230648">true</span><br>
<span class="lineno">125</span><span class="op" id="3230653">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3230656">//&nbsp;sendType&nbsp;sends&nbsp;the&nbsp;type&nbsp;info&nbsp;to&nbsp;the&nbsp;other&nbsp;side,&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3230721">func</span>&nbsp;<span class="op" id="3230726">(</span><span class="ident" id="3230727">enc</span>&nbsp;<span class="op" id="3230731">*</span><span class="ident" id="3230732">Encoder</span><span class="op" id="3230739">)</span>&nbsp;<span class="ident" id="3230741">sendType</span><span class="op" id="3230749">(</span><span class="ident" id="3230750">w</span>&nbsp;<span class="ident" id="3230752">io</span><span class="op" id="3230754">.</span><span class="ident" id="3230755">Writer</span><span class="op" id="3230761">,</span>&nbsp;<span class="ident" id="3230763">state</span>&nbsp;<span class="op" id="3230769">*</span><span class="ident" id="3230770">encoderState</span><span class="op" id="3230782">,</span>&nbsp;<span class="ident" id="3230784">origt</span>&nbsp;<span class="ident" id="3230790">reflect</span><span class="op" id="3230797">.</span><span class="ident" id="3230798">Type</span><span class="op" id="3230802">)</span>&nbsp;<span class="op" id="3230804">(</span><span class="ident" id="3230805">sent</span>&nbsp;<span class="builtintype" id="3230810">bool</span><span class="op" id="3230814">)</span>&nbsp;<span class="op" id="3230816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230819">ut</span>&nbsp;<span class="op" id="3230822">:=</span>&nbsp;<span class="ident" id="3230825">userType</span><span class="op" id="3230833">(</span><span class="ident" id="3230834">origt</span><span class="op" id="3230839">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230842">if</span>&nbsp;<span class="ident" id="3230845">ut</span><span class="op" id="3230847">.</span><span class="ident" id="3230848">externalEnc</span>&nbsp;<span class="op" id="3230860">!=</span>&nbsp;<span class="num" id="3230863">0</span>&nbsp;<span class="op" id="3230865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230869">//&nbsp;The&nbsp;rules&nbsp;are&nbsp;different:&nbsp;regardless&nbsp;of&nbsp;the&nbsp;underlying&nbsp;type&#39;s&nbsp;representation,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230951">//&nbsp;we&nbsp;need&nbsp;to&nbsp;tell&nbsp;the&nbsp;other&nbsp;side&nbsp;that&nbsp;the&nbsp;base&nbsp;type&nbsp;is&nbsp;a&nbsp;GobEncoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231023">return</span>&nbsp;<span class="ident" id="3231030">enc</span><span class="op" id="3231033">.</span><span class="ident" id="3231034">sendActualType</span><span class="op" id="3231048">(</span><span class="ident" id="3231049">w</span><span class="op" id="3231050">,</span>&nbsp;<span class="ident" id="3231052">state</span><span class="op" id="3231057">,</span>&nbsp;<span class="ident" id="3231059">ut</span><span class="op" id="3231061">,</span>&nbsp;<span class="ident" id="3231063">ut</span><span class="op" id="3231065">.</span><span class="ident" id="3231066">base</span><span class="op" id="3231070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231073">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231077">//&nbsp;It&#39;s&nbsp;a&nbsp;concrete&nbsp;value,&nbsp;so&nbsp;drill&nbsp;down&nbsp;to&nbsp;the&nbsp;base&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231136">switch</span>&nbsp;<span class="ident" id="3231143">rt</span>&nbsp;<span class="op" id="3231146">:=</span>&nbsp;<span class="ident" id="3231149">ut</span><span class="op" id="3231151">.</span><span class="ident" id="3231152">base</span><span class="op" id="3231156">;</span>&nbsp;<span class="ident" id="3231158">rt</span><span class="op" id="3231160">.</span><span class="ident" id="3231161">Kind</span><span class="op" id="3231165">(</span><span class="op" id="3231166">)</span>&nbsp;<span class="op" id="3231168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231171">default</span><span class="op" id="3231178">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231182">//&nbsp;Basic&nbsp;types&nbsp;and&nbsp;interfaces&nbsp;do&nbsp;not&nbsp;need&nbsp;to&nbsp;be&nbsp;described.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231243">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231251">case</span>&nbsp;<span class="ident" id="3231256">reflect</span><span class="op" id="3231263">.</span><span class="ident" id="3231264">Slice</span><span class="op" id="3231269">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231273">//&nbsp;If&nbsp;it&#39;s&nbsp;[]uint8,&nbsp;don&#39;t&nbsp;send;&nbsp;it&#39;s&nbsp;considered&nbsp;basic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231330">if</span>&nbsp;<span class="ident" id="3231333">rt</span><span class="op" id="3231335">.</span><span class="ident" id="3231336">Elem</span><span class="op" id="3231340">(</span><span class="op" id="3231341">)</span><span class="op" id="3231342">.</span><span class="ident" id="3231343">Kind</span><span class="op" id="3231347">(</span><span class="op" id="3231348">)</span>&nbsp;<span class="op" id="3231350">==</span>&nbsp;<span class="ident" id="3231353">reflect</span><span class="op" id="3231360">.</span><span class="ident" id="3231361">Uint8</span>&nbsp;<span class="op" id="3231367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231372">return</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231385">//&nbsp;Otherwise&nbsp;we&nbsp;do&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231412">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231419">case</span>&nbsp;<span class="ident" id="3231424">reflect</span><span class="op" id="3231431">.</span><span class="ident" id="3231432">Array</span><span class="op" id="3231437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231441">//&nbsp;arrays&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;element&nbsp;types.</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231510">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231517">case</span>&nbsp;<span class="ident" id="3231522">reflect</span><span class="op" id="3231529">.</span><span class="ident" id="3231530">Map</span><span class="op" id="3231533">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231537">//&nbsp;maps&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;lengths&nbsp;and&nbsp;key/value&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231606">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231613">case</span>&nbsp;<span class="ident" id="3231618">reflect</span><span class="op" id="3231625">.</span><span class="ident" id="3231626">Struct</span><span class="op" id="3231632">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231636">//&nbsp;structs&nbsp;must&nbsp;be&nbsp;sent&nbsp;so&nbsp;we&nbsp;know&nbsp;their&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231687">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231694">case</span>&nbsp;<span class="ident" id="3231699">reflect</span><span class="op" id="3231706">.</span><span class="ident" id="3231707">Chan</span><span class="op" id="3231711">,</span>&nbsp;<span class="ident" id="3231713">reflect</span><span class="op" id="3231720">.</span><span class="ident" id="3231721">Func</span><span class="op" id="3231725">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3231729">//&nbsp;If&nbsp;we&nbsp;get&nbsp;here,&nbsp;it&#39;s&nbsp;a&nbsp;field&nbsp;of&nbsp;a&nbsp;struct;&nbsp;ignore&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231787">return</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231799">return</span>&nbsp;<span class="ident" id="3231806">enc</span><span class="op" id="3231809">.</span><span class="ident" id="3231810">sendActualType</span><span class="op" id="3231824">(</span><span class="ident" id="3231825">w</span><span class="op" id="3231826">,</span>&nbsp;<span class="ident" id="3231828">state</span><span class="op" id="3231833">,</span>&nbsp;<span class="ident" id="3231835">ut</span><span class="op" id="3231837">,</span>&nbsp;<span class="ident" id="3231839">ut</span><span class="op" id="3231841">.</span><span class="ident" id="3231842">base</span><span class="op" id="3231846">)</span><br>
<span class="lineno"></span><span class="op" id="3231848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3231851">//&nbsp;Encode&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;empty&nbsp;interface&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="3231927">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="3232007">func</span>&nbsp;<span class="op" id="3232012">(</span><span class="ident" id="3232013">enc</span>&nbsp;<span class="op" id="3232017">*</span><span class="ident" id="3232018">Encoder</span><span class="op" id="3232025">)</span>&nbsp;<span class="ident" id="3232027">Encode</span><span class="op" id="3232033">(</span><span class="ident" id="3232034">e</span>&nbsp;<span class="keyword" id="3232036">interface</span><span class="op" id="3232045">{</span><span class="op" id="3232046">}</span><span class="op" id="3232047">)</span>&nbsp;<span class="builtintype" id="3232049">error</span>&nbsp;<span class="op" id="3232055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232058">return</span>&nbsp;<span class="ident" id="3232065">enc</span><span class="op" id="3232068">.</span><span class="ident" id="3232069">EncodeValue</span><span class="op" id="3232080">(</span><span class="ident" id="3232081">reflect</span><span class="op" id="3232088">.</span><span class="ident" id="3232089">ValueOf</span><span class="op" id="3232096">(</span><span class="ident" id="3232097">e</span><span class="op" id="3232098">)</span><span class="op" id="3232099">)</span><br>
<span class="lineno"></span><span class="op" id="3232101">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="comment" id="3232104">//&nbsp;sendTypeDescriptor&nbsp;makes&nbsp;sure&nbsp;the&nbsp;remote&nbsp;side&nbsp;knows&nbsp;about&nbsp;this&nbsp;type.</span><br>
<span class="lineno"></span><span class="comment" id="3232176">//&nbsp;It&nbsp;will&nbsp;send&nbsp;a&nbsp;descriptor&nbsp;if&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;time&nbsp;the&nbsp;type&nbsp;has&nbsp;been</span><br>
<span class="lineno"></span><span class="comment" id="3232249">//&nbsp;sent.</span><br>
<span class="lineno"></span><span class="keyword" id="3232258">func</span>&nbsp;<span class="op" id="3232263">(</span><span class="ident" id="3232264">enc</span>&nbsp;<span class="op" id="3232268">*</span><span class="ident" id="3232269">Encoder</span><span class="op" id="3232276">)</span>&nbsp;<span class="ident" id="3232278">sendTypeDescriptor</span><span class="op" id="3232296">(</span><span class="ident" id="3232297">w</span>&nbsp;<span class="ident" id="3232299">io</span><span class="op" id="3232301">.</span><span class="ident" id="3232302">Writer</span><span class="op" id="3232308">,</span>&nbsp;<span class="ident" id="3232310">state</span>&nbsp;<span class="op" id="3232316">*</span><span class="ident" id="3232317">encoderState</span><span class="op" id="3232329">,</span>&nbsp;<span class="ident" id="3232331">ut</span>&nbsp;<span class="op" id="3232334">*</span><span class="ident" id="3232335">userTypeInfo</span><span class="op" id="3232347">)</span>&nbsp;<span class="op" id="3232349">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232352">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;type&nbsp;is&nbsp;known&nbsp;to&nbsp;the&nbsp;other&nbsp;side.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232403">//&nbsp;First,&nbsp;have&nbsp;we&nbsp;already&nbsp;sent&nbsp;this&nbsp;type?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232446">rt</span>&nbsp;<span class="op" id="3232449">:=</span>&nbsp;<span class="ident" id="3232452">ut</span><span class="op" id="3232454">.</span><span class="ident" id="3232455">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232461">if</span>&nbsp;<span class="ident" id="3232464">ut</span><span class="op" id="3232466">.</span><span class="ident" id="3232467">externalEnc</span>&nbsp;<span class="op" id="3232479">!=</span>&nbsp;<span class="num" id="3232482">0</span>&nbsp;<span class="op" id="3232484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232488">rt</span>&nbsp;<span class="op" id="3232491">=</span>&nbsp;<span class="ident" id="3232493">ut</span><span class="op" id="3232495">.</span><span class="ident" id="3232496">user</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232502">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232505">if</span>&nbsp;<span class="ident" id="3232508">_</span><span class="op" id="3232509">,</span>&nbsp;<span class="ident" id="3232511">alreadySent</span>&nbsp;<span class="op" id="3232523">:=</span>&nbsp;<span class="ident" id="3232526">enc</span><span class="op" id="3232529">.</span><span class="ident" id="3232530">sent</span><span class="op" id="3232534">[</span><span class="ident" id="3232535">rt</span><span class="op" id="3232537">]</span><span class="op" id="3232538">;</span>&nbsp;<span class="op" id="3232540">!</span><span class="ident" id="3232541">alreadySent</span>&nbsp;<span class="op" id="3232553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232557">//&nbsp;No,&nbsp;so&nbsp;send&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232578">sent</span>&nbsp;<span class="op" id="3232583">:=</span>&nbsp;<span class="ident" id="3232586">enc</span><span class="op" id="3232589">.</span><span class="ident" id="3232590">sendType</span><span class="op" id="3232598">(</span><span class="ident" id="3232599">w</span><span class="op" id="3232600">,</span>&nbsp;<span class="ident" id="3232602">state</span><span class="op" id="3232607">,</span>&nbsp;<span class="ident" id="3232609">rt</span><span class="op" id="3232611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232615">if</span>&nbsp;<span class="ident" id="3232618">enc</span><span class="op" id="3232621">.</span><span class="ident" id="3232622">err</span>&nbsp;<span class="op" id="3232626">!=</span>&nbsp;<span class="ident" id="3232629">nil</span>&nbsp;<span class="op" id="3232633">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232638">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232651">//&nbsp;If&nbsp;the&nbsp;type&nbsp;info&nbsp;has&nbsp;still&nbsp;not&nbsp;been&nbsp;transmitted,&nbsp;it&nbsp;means&nbsp;we&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232722">//&nbsp;a&nbsp;singleton&nbsp;basic&nbsp;type&nbsp;(int,&nbsp;[]byte&nbsp;etc.)&nbsp;at&nbsp;top&nbsp;level.&nbsp;&nbsp;We&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232793">//&nbsp;need&nbsp;to&nbsp;send&nbsp;the&nbsp;type&nbsp;info&nbsp;but&nbsp;we&nbsp;do&nbsp;need&nbsp;to&nbsp;update&nbsp;enc.sent.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232860">if</span>&nbsp;<span class="op" id="3232863">!</span><span class="ident" id="3232864">sent</span>&nbsp;<span class="op" id="3232869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232874">info</span><span class="op" id="3232878">,</span>&nbsp;<span class="ident" id="3232880">err</span>&nbsp;<span class="op" id="3232884">:=</span>&nbsp;<span class="ident" id="3232887">getTypeInfo</span><span class="op" id="3232898">(</span><span class="ident" id="3232899">ut</span><span class="op" id="3232901">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232906">if</span>&nbsp;<span class="ident" id="3232909">err</span>&nbsp;<span class="op" id="3232913">!=</span>&nbsp;<span class="ident" id="3232916">nil</span>&nbsp;<span class="op" id="3232920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232926">enc</span><span class="op" id="3232929">.</span><span class="ident" id="3232930">setError</span><span class="op" id="3232938">(</span><span class="ident" id="3232939">err</span><span class="op" id="3232942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232948">return</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232963">enc</span><span class="op" id="3232966">.</span><span class="ident" id="3232967">sent</span><span class="op" id="3232971">[</span><span class="ident" id="3232972">rt</span><span class="op" id="3232974">]</span>&nbsp;<span class="op" id="3232976">=</span>&nbsp;<span class="ident" id="3232978">info</span><span class="op" id="3232982">.</span><span class="ident" id="3232983">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232991">}</span><br>
<span class="lineno"></span><span class="op" id="3232993">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3232996">//&nbsp;sendTypeId&nbsp;sends&nbsp;the&nbsp;id,&nbsp;which&nbsp;must&nbsp;have&nbsp;already&nbsp;been&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3233062">func</span>&nbsp;<span class="op" id="3233067">(</span><span class="ident" id="3233068">enc</span>&nbsp;<span class="op" id="3233072">*</span><span class="ident" id="3233073">Encoder</span><span class="op" id="3233080">)</span>&nbsp;<span class="ident" id="3233082">sendTypeId</span><span class="op" id="3233092">(</span><span class="ident" id="3233093">state</span>&nbsp;<span class="op" id="3233099">*</span><span class="ident" id="3233100">encoderState</span><span class="op" id="3233112">,</span>&nbsp;<span class="ident" id="3233114">ut</span>&nbsp;<span class="op" id="3233117">*</span><span class="ident" id="3233118">userTypeInfo</span><span class="op" id="3233130">)</span>&nbsp;<span class="op" id="3233132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233135">//&nbsp;Identify&nbsp;the&nbsp;type&nbsp;of&nbsp;this&nbsp;top-level&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233182">state</span><span class="op" id="3233187">.</span><span class="ident" id="3233188">encodeInt</span><span class="op" id="3233197">(</span><span class="ident" id="3233198">int64</span><span class="op" id="3233203">(</span><span class="ident" id="3233204">enc</span><span class="op" id="3233207">.</span><span class="ident" id="3233208">sent</span><span class="op" id="3233212">[</span><span class="ident" id="3233213">ut</span><span class="op" id="3233215">.</span><span class="ident" id="3233216">base</span><span class="op" id="3233220">]</span><span class="op" id="3233221">)</span><span class="op" id="3233222">)</span><br>
<span class="lineno">205</span><span class="op" id="3233224">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3233227">//&nbsp;EncodeValue&nbsp;transmits&nbsp;the&nbsp;data&nbsp;item&nbsp;represented&nbsp;by&nbsp;the&nbsp;reflection&nbsp;value,</span><br>
<span class="lineno"></span><span class="comment" id="3233303">//&nbsp;guaranteeing&nbsp;that&nbsp;all&nbsp;necessary&nbsp;type&nbsp;information&nbsp;has&nbsp;been&nbsp;transmitted&nbsp;first.</span><br>
<span class="lineno"></span><span class="keyword" id="3233383">func</span>&nbsp;<span class="op" id="3233388">(</span><span class="ident" id="3233389">enc</span>&nbsp;<span class="op" id="3233393">*</span><span class="ident" id="3233394">Encoder</span><span class="op" id="3233401">)</span>&nbsp;<span class="ident" id="3233403">EncodeValue</span><span class="op" id="3233414">(</span><span class="ident" id="3233415">value</span>&nbsp;<span class="ident" id="3233421">reflect</span><span class="op" id="3233428">.</span><span class="ident" id="3233429">Value</span><span class="op" id="3233434">)</span>&nbsp;<span class="builtintype" id="3233436">error</span>&nbsp;<span class="op" id="3233442">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233445">//&nbsp;Gobs&nbsp;contain&nbsp;values.&nbsp;They&nbsp;cannot&nbsp;represent&nbsp;nil&nbsp;pointers,&nbsp;which</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233512">//&nbsp;have&nbsp;no&nbsp;value&nbsp;to&nbsp;encode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233541">if</span>&nbsp;<span class="ident" id="3233544">value</span><span class="op" id="3233549">.</span><span class="ident" id="3233550">Kind</span><span class="op" id="3233554">(</span><span class="op" id="3233555">)</span>&nbsp;<span class="op" id="3233557">==</span>&nbsp;<span class="ident" id="3233560">reflect</span><span class="op" id="3233567">.</span><span class="ident" id="3233568">Ptr</span>&nbsp;<span class="op" id="3233572">&amp;&amp;</span>&nbsp;<span class="ident" id="3233575">value</span><span class="op" id="3233580">.</span><span class="ident" id="3233581">IsNil</span><span class="op" id="3233586">(</span><span class="op" id="3233587">)</span>&nbsp;<span class="op" id="3233589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3233593">panic</span><span class="op" id="3233598">(</span><span class="string" id="3233599">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="3233641">+</span>&nbsp;<span class="ident" id="3233643">value</span><span class="op" id="3233648">.</span><span class="ident" id="3233649">Type</span><span class="op" id="3233653">(</span><span class="op" id="3233654">)</span><span class="op" id="3233655">.</span><span class="ident" id="3233656">String</span><span class="op" id="3233662">(</span><span class="op" id="3233663">)</span><span class="op" id="3233664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233667">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233671">//&nbsp;Make&nbsp;sure&nbsp;we&#39;re&nbsp;single-threaded&nbsp;through&nbsp;here,&nbsp;so&nbsp;multiple</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233733">//&nbsp;goroutines&nbsp;can&nbsp;share&nbsp;an&nbsp;encoder.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233770">enc</span><span class="op" id="3233773">.</span><span class="ident" id="3233774">mutex</span><span class="op" id="3233779">.</span><span class="ident" id="3233780">Lock</span><span class="op" id="3233784">(</span><span class="op" id="3233785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233788">defer</span>&nbsp;<span class="ident" id="3233794">enc</span><span class="op" id="3233797">.</span><span class="ident" id="3233798">mutex</span><span class="op" id="3233803">.</span><span class="ident" id="3233804">Unlock</span><span class="op" id="3233810">(</span><span class="op" id="3233811">)</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3233815">//&nbsp;Remove&nbsp;any&nbsp;nested&nbsp;writers&nbsp;remaining&nbsp;due&nbsp;to&nbsp;previous&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233879">enc</span><span class="op" id="3233882">.</span><span class="ident" id="3233883">w</span>&nbsp;<span class="op" id="3233885">=</span>&nbsp;<span class="ident" id="3233887">enc</span><span class="op" id="3233890">.</span><span class="ident" id="3233891">w</span><span class="op" id="3233892">[</span><span class="num" id="3233893">0</span><span class="op" id="3233894">:</span><span class="num" id="3233895">1</span><span class="op" id="3233896">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233900">ut</span><span class="op" id="3233902">,</span>&nbsp;<span class="ident" id="3233904">err</span>&nbsp;<span class="op" id="3233908">:=</span>&nbsp;<span class="ident" id="3233911">validUserType</span><span class="op" id="3233924">(</span><span class="ident" id="3233925">value</span><span class="op" id="3233930">.</span><span class="ident" id="3233931">Type</span><span class="op" id="3233935">(</span><span class="op" id="3233936">)</span><span class="op" id="3233937">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233940">if</span>&nbsp;<span class="ident" id="3233943">err</span>&nbsp;<span class="op" id="3233947">!=</span>&nbsp;<span class="ident" id="3233950">nil</span>&nbsp;<span class="op" id="3233954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233958">return</span>&nbsp;<span class="ident" id="3233965">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233970">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233974">enc</span><span class="op" id="3233977">.</span><span class="ident" id="3233978">err</span>&nbsp;<span class="op" id="3233982">=</span>&nbsp;<span class="ident" id="3233984">nil</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233989">enc</span><span class="op" id="3233992">.</span><span class="ident" id="3233993">byteBuf</span><span class="op" id="3234000">.</span><span class="ident" id="3234001">Reset</span><span class="op" id="3234006">(</span><span class="op" id="3234007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234010">enc</span><span class="op" id="3234013">.</span><span class="ident" id="3234014">byteBuf</span><span class="op" id="3234021">.</span><span class="ident" id="3234022">Write</span><span class="op" id="3234027">(</span><span class="ident" id="3234028">spaceForLength</span><span class="op" id="3234042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234045">state</span>&nbsp;<span class="op" id="3234051">:=</span>&nbsp;<span class="ident" id="3234054">enc</span><span class="op" id="3234057">.</span><span class="ident" id="3234058">newEncoderState</span><span class="op" id="3234073">(</span><span class="op" id="3234074">&amp;</span><span class="ident" id="3234075">enc</span><span class="op" id="3234078">.</span><span class="ident" id="3234079">byteBuf</span><span class="op" id="3234086">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234090">enc</span><span class="op" id="3234093">.</span><span class="ident" id="3234094">sendTypeDescriptor</span><span class="op" id="3234112">(</span><span class="ident" id="3234113">enc</span><span class="op" id="3234116">.</span><span class="ident" id="3234117">writer</span><span class="op" id="3234123">(</span><span class="op" id="3234124">)</span><span class="op" id="3234125">,</span>&nbsp;<span class="ident" id="3234127">state</span><span class="op" id="3234132">,</span>&nbsp;<span class="ident" id="3234134">ut</span><span class="op" id="3234136">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234139">enc</span><span class="op" id="3234142">.</span><span class="ident" id="3234143">sendTypeId</span><span class="op" id="3234153">(</span><span class="ident" id="3234154">state</span><span class="op" id="3234159">,</span>&nbsp;<span class="ident" id="3234161">ut</span><span class="op" id="3234163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234166">if</span>&nbsp;<span class="ident" id="3234169">enc</span><span class="op" id="3234172">.</span><span class="ident" id="3234173">err</span>&nbsp;<span class="op" id="3234177">!=</span>&nbsp;<span class="ident" id="3234180">nil</span>&nbsp;<span class="op" id="3234184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234188">return</span>&nbsp;<span class="ident" id="3234195">enc</span><span class="op" id="3234198">.</span><span class="ident" id="3234199">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234204">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3234208">//&nbsp;Encode&nbsp;the&nbsp;object.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234231">enc</span><span class="op" id="3234234">.</span><span class="ident" id="3234235">encode</span><span class="op" id="3234241">(</span><span class="ident" id="3234242">state</span><span class="op" id="3234247">.</span><span class="ident" id="3234248">b</span><span class="op" id="3234249">,</span>&nbsp;<span class="ident" id="3234251">value</span><span class="op" id="3234256">,</span>&nbsp;<span class="ident" id="3234258">ut</span><span class="op" id="3234260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234263">if</span>&nbsp;<span class="ident" id="3234266">enc</span><span class="op" id="3234269">.</span><span class="ident" id="3234270">err</span>&nbsp;<span class="op" id="3234274">==</span>&nbsp;<span class="ident" id="3234277">nil</span>&nbsp;<span class="op" id="3234281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234285">enc</span><span class="op" id="3234288">.</span><span class="ident" id="3234289">writeMessage</span><span class="op" id="3234301">(</span><span class="ident" id="3234302">enc</span><span class="op" id="3234305">.</span><span class="ident" id="3234306">writer</span><span class="op" id="3234312">(</span><span class="op" id="3234313">)</span><span class="op" id="3234314">,</span>&nbsp;<span class="ident" id="3234316">state</span><span class="op" id="3234321">.</span><span class="ident" id="3234322">b</span><span class="op" id="3234323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234326">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234330">enc</span><span class="op" id="3234333">.</span><span class="ident" id="3234334">freeEncoderState</span><span class="op" id="3234350">(</span><span class="ident" id="3234351">state</span><span class="op" id="3234356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234359">return</span>&nbsp;<span class="ident" id="3234366">enc</span><span class="op" id="3234369">.</span><span class="ident" id="3234370">err</span><br>
<span class="lineno"></span><span class="op" id="3234374">}</span>
</div>
</body>
</html>
