<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>text/template/parse</h2>
<ul>
<li><a href="/gostd/text/template/parse/lex.go.html">lex.go</a></li>
<li><a href="/gostd/text/template/parse/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/text/template/parse/node.go.html">node.go</a></li>
<li><a href="/gostd/text/template/parse/parse.go.html">parse.go</a></li>
<li><a href="/gostd/text/template/parse/parse_test.go.html">parse_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3493600">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3493655">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3493709">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3493760">//&nbsp;Package&nbsp;parse&nbsp;builds&nbsp;parse&nbsp;trees&nbsp;for&nbsp;templates&nbsp;as&nbsp;defined&nbsp;by&nbsp;text/template</span><br>
<span class="lineno"></span><span class="comment" id="3493838">//&nbsp;and&nbsp;html/template.&nbsp;Clients&nbsp;should&nbsp;use&nbsp;those&nbsp;packages&nbsp;to&nbsp;construct&nbsp;templates</span><br>
<span class="lineno"></span><span class="comment" id="3493917">//&nbsp;rather&nbsp;than&nbsp;this&nbsp;one,&nbsp;which&nbsp;provides&nbsp;shared&nbsp;internal&nbsp;data&nbsp;structures&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="3493993">//&nbsp;intended&nbsp;for&nbsp;general&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3494022">package</span>&nbsp;<span class="ident" id="3494030">parse</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="3494037">import</span>&nbsp;<span class="op" id="3494044">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3494047">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3494056">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3494063">&#34;runtime&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3494074">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3494085">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="3494095">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3494098">//&nbsp;Tree&nbsp;is&nbsp;the&nbsp;representation&nbsp;of&nbsp;a&nbsp;single&nbsp;parsed&nbsp;template.</span><br>
<span class="lineno">20</span><span class="keyword" id="3494157">type</span>&nbsp;<span class="ident" id="3494162">Tree</span>&nbsp;<span class="keyword" id="3494167">struct</span>&nbsp;<span class="op" id="3494174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494177">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3494187">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3494197">//&nbsp;name&nbsp;of&nbsp;the&nbsp;template&nbsp;represented&nbsp;by&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494247">ParseName</span>&nbsp;<span class="builtintype" id="3494257">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3494267">//&nbsp;name&nbsp;of&nbsp;the&nbsp;top-level&nbsp;template&nbsp;during&nbsp;parsing,&nbsp;for&nbsp;error&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494338">Root</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494348">*</span><span class="ident" id="3494349">ListNode</span>&nbsp;<span class="comment" id="3494358">//&nbsp;top-level&nbsp;root&nbsp;of&nbsp;the&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494390">text</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3494400">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3494410">//&nbsp;text&nbsp;parsed&nbsp;to&nbsp;create&nbsp;the&nbsp;template&nbsp;(or&nbsp;its&nbsp;parent)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3494465">//&nbsp;Parsing&nbsp;only;&nbsp;cleared&nbsp;after&nbsp;parse.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494504">funcs</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494514">[</span><span class="op" id="3494515">]</span><span class="keyword" id="3494516">map</span><span class="op" id="3494519">[</span><span class="builtintype" id="3494520">string</span><span class="op" id="3494526">]</span><span class="keyword" id="3494527">interface</span><span class="op" id="3494536">{</span><span class="op" id="3494537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494540">lex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494550">*</span><span class="ident" id="3494551">lexer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494558">token</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494568">[</span><span class="num" id="3494569">3</span><span class="op" id="3494570">]</span><span class="ident" id="3494571">item</span>&nbsp;<span class="comment" id="3494576">//&nbsp;three-token&nbsp;lookahead&nbsp;for&nbsp;parser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494614">peekCount</span>&nbsp;<span class="builtintype" id="3494624">int</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494629">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3494639">[</span><span class="op" id="3494640">]</span><span class="builtintype" id="3494641">string</span>&nbsp;<span class="comment" id="3494648">//&nbsp;variables&nbsp;defined&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span><span class="op" id="3494684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3494687">//&nbsp;Copy&nbsp;returns&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;Tree.&nbsp;Any&nbsp;parsing&nbsp;state&nbsp;is&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="3494755">func</span>&nbsp;<span class="op" id="3494760">(</span><span class="ident" id="3494761">t</span>&nbsp;<span class="op" id="3494763">*</span><span class="ident" id="3494764">Tree</span><span class="op" id="3494768">)</span>&nbsp;<span class="ident" id="3494770">Copy</span><span class="op" id="3494774">(</span><span class="op" id="3494775">)</span>&nbsp;<span class="op" id="3494777">*</span><span class="ident" id="3494778">Tree</span>&nbsp;<span class="op" id="3494783">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494786">if</span>&nbsp;<span class="ident" id="3494789">t</span>&nbsp;<span class="op" id="3494791">==</span>&nbsp;<span class="ident" id="3494794">nil</span>&nbsp;<span class="op" id="3494798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494802">return</span>&nbsp;<span class="ident" id="3494809">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3494814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3494817">return</span>&nbsp;<span class="op" id="3494824">&amp;</span><span class="ident" id="3494825">Tree</span><span class="op" id="3494829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494833">Name</span><span class="op" id="3494837">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494844">t</span><span class="op" id="3494845">.</span><span class="ident" id="3494846">Name</span><span class="op" id="3494850">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494854">ParseName</span><span class="op" id="3494863">:</span>&nbsp;<span class="ident" id="3494865">t</span><span class="op" id="3494866">.</span><span class="ident" id="3494867">ParseName</span><span class="op" id="3494876">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494880">Root</span><span class="op" id="3494884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494891">t</span><span class="op" id="3494892">.</span><span class="ident" id="3494893">Root</span><span class="op" id="3494897">.</span><span class="ident" id="3494898">CopyList</span><span class="op" id="3494906">(</span><span class="op" id="3494907">)</span><span class="op" id="3494908">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3494912">text</span><span class="op" id="3494916">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3494923">t</span><span class="op" id="3494924">.</span><span class="ident" id="3494925">text</span><span class="op" id="3494929">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3494932">}</span><br>
<span class="lineno"></span><span class="op" id="3494934">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3494937">//&nbsp;Parse&nbsp;returns&nbsp;a&nbsp;map&nbsp;from&nbsp;template&nbsp;name&nbsp;to&nbsp;parse.Tree,&nbsp;created&nbsp;by&nbsp;parsing&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3495017">//&nbsp;templates&nbsp;described&nbsp;in&nbsp;the&nbsp;argument&nbsp;string.&nbsp;The&nbsp;top-level&nbsp;template&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3495095">//&nbsp;given&nbsp;the&nbsp;specified&nbsp;name.&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;encountered,&nbsp;parsing&nbsp;stops&nbsp;and&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="3495173">//&nbsp;empty&nbsp;map&nbsp;is&nbsp;returned&nbsp;with&nbsp;the&nbsp;error.</span><br>
<span class="lineno">50</span><span class="keyword" id="3495214">func</span>&nbsp;<span class="ident" id="3495219">Parse</span><span class="op" id="3495224">(</span><span class="ident" id="3495225">name</span><span class="op" id="3495229">,</span>&nbsp;<span class="ident" id="3495231">text</span><span class="op" id="3495235">,</span>&nbsp;<span class="ident" id="3495237">leftDelim</span><span class="op" id="3495246">,</span>&nbsp;<span class="ident" id="3495248">rightDelim</span>&nbsp;<span class="builtintype" id="3495259">string</span><span class="op" id="3495265">,</span>&nbsp;<span class="ident" id="3495267">funcs</span>&nbsp;<span class="op" id="3495273">...</span><span class="keyword" id="3495276">map</span><span class="op" id="3495279">[</span><span class="builtintype" id="3495280">string</span><span class="op" id="3495286">]</span><span class="keyword" id="3495287">interface</span><span class="op" id="3495296">{</span><span class="op" id="3495297">}</span><span class="op" id="3495298">)</span>&nbsp;<span class="op" id="3495300">(</span><span class="ident" id="3495301">treeSet</span>&nbsp;<span class="keyword" id="3495309">map</span><span class="op" id="3495312">[</span><span class="builtintype" id="3495313">string</span><span class="op" id="3495319">]</span><span class="op" id="3495320">*</span><span class="ident" id="3495321">Tree</span><span class="op" id="3495325">,</span>&nbsp;<span class="ident" id="3495327">err</span>&nbsp;<span class="builtintype" id="3495331">error</span><span class="op" id="3495336">)</span>&nbsp;<span class="op" id="3495338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495341">treeSet</span>&nbsp;<span class="op" id="3495349">=</span>&nbsp;<span class="builtinfunc" id="3495351">make</span><span class="op" id="3495355">(</span><span class="keyword" id="3495356">map</span><span class="op" id="3495359">[</span><span class="builtintype" id="3495360">string</span><span class="op" id="3495366">]</span><span class="op" id="3495367">*</span><span class="ident" id="3495368">Tree</span><span class="op" id="3495372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495375">t</span>&nbsp;<span class="op" id="3495377">:=</span>&nbsp;<span class="ident" id="3495380">New</span><span class="op" id="3495383">(</span><span class="ident" id="3495384">name</span><span class="op" id="3495388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495391">t</span><span class="op" id="3495392">.</span><span class="ident" id="3495393">text</span>&nbsp;<span class="op" id="3495398">=</span>&nbsp;<span class="ident" id="3495400">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495406">_</span><span class="op" id="3495407">,</span>&nbsp;<span class="ident" id="3495409">err</span>&nbsp;<span class="op" id="3495413">=</span>&nbsp;<span class="ident" id="3495415">t</span><span class="op" id="3495416">.</span><span class="ident" id="3495417">Parse</span><span class="op" id="3495422">(</span><span class="ident" id="3495423">text</span><span class="op" id="3495427">,</span>&nbsp;<span class="ident" id="3495429">leftDelim</span><span class="op" id="3495438">,</span>&nbsp;<span class="ident" id="3495440">rightDelim</span><span class="op" id="3495450">,</span>&nbsp;<span class="ident" id="3495452">treeSet</span><span class="op" id="3495459">,</span>&nbsp;<span class="ident" id="3495461">funcs</span><span class="op" id="3495466">...</span><span class="op" id="3495469">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495472">return</span><br>
<span class="lineno"></span><span class="op" id="3495479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3495482">//&nbsp;next&nbsp;returns&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3495514">func</span>&nbsp;<span class="op" id="3495519">(</span><span class="ident" id="3495520">t</span>&nbsp;<span class="op" id="3495522">*</span><span class="ident" id="3495523">Tree</span><span class="op" id="3495527">)</span>&nbsp;<span class="ident" id="3495529">next</span><span class="op" id="3495533">(</span><span class="op" id="3495534">)</span>&nbsp;<span class="ident" id="3495536">item</span>&nbsp;<span class="op" id="3495541">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495544">if</span>&nbsp;<span class="ident" id="3495547">t</span><span class="op" id="3495548">.</span><span class="ident" id="3495549">peekCount</span>&nbsp;<span class="op" id="3495559">&gt;</span>&nbsp;<span class="num" id="3495561">0</span>&nbsp;<span class="op" id="3495563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495567">t</span><span class="op" id="3495568">.</span><span class="ident" id="3495569">peekCount</span><span class="op" id="3495578">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3495582">}</span>&nbsp;<span class="keyword" id="3495584">else</span>&nbsp;<span class="op" id="3495589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495593">t</span><span class="op" id="3495594">.</span><span class="ident" id="3495595">token</span><span class="op" id="3495600">[</span><span class="num" id="3495601">0</span><span class="op" id="3495602">]</span>&nbsp;<span class="op" id="3495604">=</span>&nbsp;<span class="ident" id="3495606">t</span><span class="op" id="3495607">.</span><span class="ident" id="3495608">lex</span><span class="op" id="3495611">.</span><span class="ident" id="3495612">nextItem</span><span class="op" id="3495620">(</span><span class="op" id="3495621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3495624">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3495627">return</span>&nbsp;<span class="ident" id="3495634">t</span><span class="op" id="3495635">.</span><span class="ident" id="3495636">token</span><span class="op" id="3495641">[</span><span class="ident" id="3495642">t</span><span class="op" id="3495643">.</span><span class="ident" id="3495644">peekCount</span><span class="op" id="3495653">]</span><br>
<span class="lineno"></span><span class="op" id="3495655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3495658">//&nbsp;backup&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;one&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3495705">func</span>&nbsp;<span class="op" id="3495710">(</span><span class="ident" id="3495711">t</span>&nbsp;<span class="op" id="3495713">*</span><span class="ident" id="3495714">Tree</span><span class="op" id="3495718">)</span>&nbsp;<span class="ident" id="3495720">backup</span><span class="op" id="3495726">(</span><span class="op" id="3495727">)</span>&nbsp;<span class="op" id="3495729">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495732">t</span><span class="op" id="3495733">.</span><span class="ident" id="3495734">peekCount</span><span class="op" id="3495743">++</span><br>
<span class="lineno"></span><span class="op" id="3495746">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3495749">//&nbsp;backup2&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;two&nbsp;tokens.</span><br>
<span class="lineno"></span><span class="comment" id="3495798">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno">75</span><span class="keyword" id="3495836">func</span>&nbsp;<span class="op" id="3495841">(</span><span class="ident" id="3495842">t</span>&nbsp;<span class="op" id="3495844">*</span><span class="ident" id="3495845">Tree</span><span class="op" id="3495849">)</span>&nbsp;<span class="ident" id="3495851">backup2</span><span class="op" id="3495858">(</span><span class="ident" id="3495859">t1</span>&nbsp;<span class="ident" id="3495862">item</span><span class="op" id="3495866">)</span>&nbsp;<span class="op" id="3495868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495871">t</span><span class="op" id="3495872">.</span><span class="ident" id="3495873">token</span><span class="op" id="3495878">[</span><span class="num" id="3495879">1</span><span class="op" id="3495880">]</span>&nbsp;<span class="op" id="3495882">=</span>&nbsp;<span class="ident" id="3495884">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3495888">t</span><span class="op" id="3495889">.</span><span class="ident" id="3495890">peekCount</span>&nbsp;<span class="op" id="3495900">=</span>&nbsp;<span class="num" id="3495902">2</span><br>
<span class="lineno"></span><span class="op" id="3495904">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="comment" id="3495907">//&nbsp;backup3&nbsp;backs&nbsp;the&nbsp;input&nbsp;stream&nbsp;up&nbsp;three&nbsp;tokens</span><br>
<span class="lineno"></span><span class="comment" id="3495957">//&nbsp;The&nbsp;zeroth&nbsp;token&nbsp;is&nbsp;already&nbsp;there.</span><br>
<span class="lineno"></span><span class="keyword" id="3495995">func</span>&nbsp;<span class="op" id="3496000">(</span><span class="ident" id="3496001">t</span>&nbsp;<span class="op" id="3496003">*</span><span class="ident" id="3496004">Tree</span><span class="op" id="3496008">)</span>&nbsp;<span class="ident" id="3496010">backup3</span><span class="op" id="3496017">(</span><span class="ident" id="3496018">t2</span><span class="op" id="3496020">,</span>&nbsp;<span class="ident" id="3496022">t1</span>&nbsp;<span class="ident" id="3496025">item</span><span class="op" id="3496029">)</span>&nbsp;<span class="op" id="3496031">{</span>&nbsp;<span class="comment" id="3496033">//&nbsp;Reverse&nbsp;order:&nbsp;we&#39;re&nbsp;pushing&nbsp;back.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496072">t</span><span class="op" id="3496073">.</span><span class="ident" id="3496074">token</span><span class="op" id="3496079">[</span><span class="num" id="3496080">1</span><span class="op" id="3496081">]</span>&nbsp;<span class="op" id="3496083">=</span>&nbsp;<span class="ident" id="3496085">t1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496089">t</span><span class="op" id="3496090">.</span><span class="ident" id="3496091">token</span><span class="op" id="3496096">[</span><span class="num" id="3496097">2</span><span class="op" id="3496098">]</span>&nbsp;<span class="op" id="3496100">=</span>&nbsp;<span class="ident" id="3496102">t2</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496106">t</span><span class="op" id="3496107">.</span><span class="ident" id="3496108">peekCount</span>&nbsp;<span class="op" id="3496118">=</span>&nbsp;<span class="num" id="3496120">3</span><br>
<span class="lineno"></span><span class="op" id="3496122">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3496125">//&nbsp;peek&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3496178">func</span>&nbsp;<span class="op" id="3496183">(</span><span class="ident" id="3496184">t</span>&nbsp;<span class="op" id="3496186">*</span><span class="ident" id="3496187">Tree</span><span class="op" id="3496191">)</span>&nbsp;<span class="ident" id="3496193">peek</span><span class="op" id="3496197">(</span><span class="op" id="3496198">)</span>&nbsp;<span class="ident" id="3496200">item</span>&nbsp;<span class="op" id="3496205">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496208">if</span>&nbsp;<span class="ident" id="3496211">t</span><span class="op" id="3496212">.</span><span class="ident" id="3496213">peekCount</span>&nbsp;<span class="op" id="3496223">&gt;</span>&nbsp;<span class="num" id="3496225">0</span>&nbsp;<span class="op" id="3496227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496231">return</span>&nbsp;<span class="ident" id="3496238">t</span><span class="op" id="3496239">.</span><span class="ident" id="3496240">token</span><span class="op" id="3496245">[</span><span class="ident" id="3496246">t</span><span class="op" id="3496247">.</span><span class="ident" id="3496248">peekCount</span><span class="op" id="3496257">-</span><span class="num" id="3496258">1</span><span class="op" id="3496259">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496262">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496265">t</span><span class="op" id="3496266">.</span><span class="ident" id="3496267">peekCount</span>&nbsp;<span class="op" id="3496277">=</span>&nbsp;<span class="num" id="3496279">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496282">t</span><span class="op" id="3496283">.</span><span class="ident" id="3496284">token</span><span class="op" id="3496289">[</span><span class="num" id="3496290">0</span><span class="op" id="3496291">]</span>&nbsp;<span class="op" id="3496293">=</span>&nbsp;<span class="ident" id="3496295">t</span><span class="op" id="3496296">.</span><span class="ident" id="3496297">lex</span><span class="op" id="3496300">.</span><span class="ident" id="3496301">nextItem</span><span class="op" id="3496309">(</span><span class="op" id="3496310">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496313">return</span>&nbsp;<span class="ident" id="3496320">t</span><span class="op" id="3496321">.</span><span class="ident" id="3496322">token</span><span class="op" id="3496327">[</span><span class="num" id="3496328">0</span><span class="op" id="3496329">]</span><br>
<span class="lineno"></span><span class="op" id="3496331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3496334">//&nbsp;nextNonSpace&nbsp;returns&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno"></span><span class="keyword" id="3496384">func</span>&nbsp;<span class="op" id="3496389">(</span><span class="ident" id="3496390">t</span>&nbsp;<span class="op" id="3496392">*</span><span class="ident" id="3496393">Tree</span><span class="op" id="3496397">)</span>&nbsp;<span class="ident" id="3496399">nextNonSpace</span><span class="op" id="3496411">(</span><span class="op" id="3496412">)</span>&nbsp;<span class="op" id="3496414">(</span><span class="ident" id="3496415">token</span>&nbsp;<span class="ident" id="3496421">item</span><span class="op" id="3496425">)</span>&nbsp;<span class="op" id="3496427">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496430">for</span>&nbsp;<span class="op" id="3496434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496438">token</span>&nbsp;<span class="op" id="3496444">=</span>&nbsp;<span class="ident" id="3496446">t</span><span class="op" id="3496447">.</span><span class="ident" id="3496448">next</span><span class="op" id="3496452">(</span><span class="op" id="3496453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496457">if</span>&nbsp;<span class="ident" id="3496460">token</span><span class="op" id="3496465">.</span><span class="ident" id="3496466">typ</span>&nbsp;<span class="op" id="3496470">!=</span>&nbsp;<span class="ident" id="3496473">itemSpace</span>&nbsp;<span class="op" id="3496483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496488">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496496">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496502">return</span>&nbsp;<span class="ident" id="3496509">token</span><br>
<span class="lineno"></span><span class="op" id="3496515">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3496518">//&nbsp;peekNonSpace&nbsp;returns&nbsp;but&nbsp;does&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;non-space&nbsp;token.</span><br>
<span class="lineno">110</span><span class="keyword" id="3496589">func</span>&nbsp;<span class="op" id="3496594">(</span><span class="ident" id="3496595">t</span>&nbsp;<span class="op" id="3496597">*</span><span class="ident" id="3496598">Tree</span><span class="op" id="3496602">)</span>&nbsp;<span class="ident" id="3496604">peekNonSpace</span><span class="op" id="3496616">(</span><span class="op" id="3496617">)</span>&nbsp;<span class="op" id="3496619">(</span><span class="ident" id="3496620">token</span>&nbsp;<span class="ident" id="3496626">item</span><span class="op" id="3496630">)</span>&nbsp;<span class="op" id="3496632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496635">for</span>&nbsp;<span class="op" id="3496639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496643">token</span>&nbsp;<span class="op" id="3496649">=</span>&nbsp;<span class="ident" id="3496651">t</span><span class="op" id="3496652">.</span><span class="ident" id="3496653">next</span><span class="op" id="3496657">(</span><span class="op" id="3496658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496662">if</span>&nbsp;<span class="ident" id="3496665">token</span><span class="op" id="3496670">.</span><span class="ident" id="3496671">typ</span>&nbsp;<span class="op" id="3496675">!=</span>&nbsp;<span class="ident" id="3496678">itemSpace</span>&nbsp;<span class="op" id="3496688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496693">break</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496704">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496707">t</span><span class="op" id="3496708">.</span><span class="ident" id="3496709">backup</span><span class="op" id="3496715">(</span><span class="op" id="3496716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496719">return</span>&nbsp;<span class="ident" id="3496726">token</span><br>
<span class="lineno"></span><span class="op" id="3496732">}</span><br>
<span class="lineno">120</span><br>
<span class="lineno"></span><span class="comment" id="3496735">//&nbsp;Parsing.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3496748">//&nbsp;New&nbsp;allocates&nbsp;a&nbsp;new&nbsp;parse&nbsp;tree&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="3496803">func</span>&nbsp;<span class="ident" id="3496808">New</span><span class="op" id="3496811">(</span><span class="ident" id="3496812">name</span>&nbsp;<span class="builtintype" id="3496817">string</span><span class="op" id="3496823">,</span>&nbsp;<span class="ident" id="3496825">funcs</span>&nbsp;<span class="op" id="3496831">...</span><span class="keyword" id="3496834">map</span><span class="op" id="3496837">[</span><span class="builtintype" id="3496838">string</span><span class="op" id="3496844">]</span><span class="keyword" id="3496845">interface</span><span class="op" id="3496854">{</span><span class="op" id="3496855">}</span><span class="op" id="3496856">)</span>&nbsp;<span class="op" id="3496858">*</span><span class="ident" id="3496859">Tree</span>&nbsp;<span class="op" id="3496864">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3496867">return</span>&nbsp;<span class="op" id="3496874">&amp;</span><span class="ident" id="3496875">Tree</span><span class="op" id="3496879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496883">Name</span><span class="op" id="3496887">:</span>&nbsp;&nbsp;<span class="ident" id="3496890">name</span><span class="op" id="3496894">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3496898">funcs</span><span class="op" id="3496903">:</span>&nbsp;<span class="ident" id="3496905">funcs</span><span class="op" id="3496910">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3496913">}</span><br>
<span class="lineno"></span><span class="op" id="3496915">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="3496918">//&nbsp;ErrorContext&nbsp;returns&nbsp;a&nbsp;textual&nbsp;representation&nbsp;of&nbsp;the&nbsp;location&nbsp;of&nbsp;the&nbsp;node&nbsp;in&nbsp;the&nbsp;input&nbsp;text.</span><br>
<span class="lineno"></span><span class="comment" id="3497014">//&nbsp;The&nbsp;receiver&nbsp;is&nbsp;only&nbsp;used&nbsp;when&nbsp;the&nbsp;node&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;tree&nbsp;inside,</span><br>
<span class="lineno"></span><span class="comment" id="3497101">//&nbsp;which&nbsp;can&nbsp;occur&nbsp;in&nbsp;old&nbsp;code.</span><br>
<span class="lineno"></span><span class="keyword" id="3497133">func</span>&nbsp;<span class="op" id="3497138">(</span><span class="ident" id="3497139">t</span>&nbsp;<span class="op" id="3497141">*</span><span class="ident" id="3497142">Tree</span><span class="op" id="3497146">)</span>&nbsp;<span class="ident" id="3497148">ErrorContext</span><span class="op" id="3497160">(</span><span class="ident" id="3497161">n</span>&nbsp;<span class="ident" id="3497163">Node</span><span class="op" id="3497167">)</span>&nbsp;<span class="op" id="3497169">(</span><span class="ident" id="3497170">location</span><span class="op" id="3497178">,</span>&nbsp;<span class="ident" id="3497180">context</span>&nbsp;<span class="builtintype" id="3497188">string</span><span class="op" id="3497194">)</span>&nbsp;<span class="op" id="3497196">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497199">pos</span>&nbsp;<span class="op" id="3497203">:=</span>&nbsp;<span class="builtintype" id="3497206">int</span><span class="op" id="3497209">(</span><span class="ident" id="3497210">n</span><span class="op" id="3497211">.</span><span class="ident" id="3497212">Position</span><span class="op" id="3497220">(</span><span class="op" id="3497221">)</span><span class="op" id="3497222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497225">tree</span>&nbsp;<span class="op" id="3497230">:=</span>&nbsp;<span class="ident" id="3497233">n</span><span class="op" id="3497234">.</span><span class="ident" id="3497235">tree</span><span class="op" id="3497239">(</span><span class="op" id="3497240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3497243">if</span>&nbsp;<span class="ident" id="3497246">tree</span>&nbsp;<span class="op" id="3497251">==</span>&nbsp;<span class="ident" id="3497254">nil</span>&nbsp;<span class="op" id="3497258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497262">tree</span>&nbsp;<span class="op" id="3497267">=</span>&nbsp;<span class="ident" id="3497269">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3497272">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497275">text</span>&nbsp;<span class="op" id="3497280">:=</span>&nbsp;<span class="ident" id="3497283">tree</span><span class="op" id="3497287">.</span><span class="ident" id="3497288">text</span><span class="op" id="3497292">[</span><span class="op" id="3497293">:</span><span class="ident" id="3497294">pos</span><span class="op" id="3497297">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497300">byteNum</span>&nbsp;<span class="op" id="3497308">:=</span>&nbsp;<span class="ident" id="3497311">strings</span><span class="op" id="3497318">.</span><span class="ident" id="3497319">LastIndex</span><span class="op" id="3497328">(</span><span class="ident" id="3497329">text</span><span class="op" id="3497333">,</span>&nbsp;<span class="string" id="3497335">&#34;\n&#34;</span><span class="op" id="3497339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3497342">if</span>&nbsp;<span class="ident" id="3497345">byteNum</span>&nbsp;<span class="op" id="3497353">==</span>&nbsp;<span class="op" id="3497356">-</span><span class="num" id="3497357">1</span>&nbsp;<span class="op" id="3497359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497363">byteNum</span>&nbsp;<span class="op" id="3497371">=</span>&nbsp;<span class="ident" id="3497373">pos</span>&nbsp;<span class="comment" id="3497377">//&nbsp;On&nbsp;first&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3497396">}</span>&nbsp;<span class="keyword" id="3497398">else</span>&nbsp;<span class="op" id="3497403">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497407">byteNum</span><span class="op" id="3497414">++</span>&nbsp;<span class="comment" id="3497417">//&nbsp;After&nbsp;the&nbsp;newline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497441">byteNum</span>&nbsp;<span class="op" id="3497449">=</span>&nbsp;<span class="ident" id="3497451">pos</span>&nbsp;<span class="op" id="3497455">-</span>&nbsp;<span class="ident" id="3497457">byteNum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3497466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497469">lineNum</span>&nbsp;<span class="op" id="3497477">:=</span>&nbsp;<span class="num" id="3497480">1</span>&nbsp;<span class="op" id="3497482">+</span>&nbsp;<span class="ident" id="3497484">strings</span><span class="op" id="3497491">.</span><span class="ident" id="3497492">Count</span><span class="op" id="3497497">(</span><span class="ident" id="3497498">text</span><span class="op" id="3497502">,</span>&nbsp;<span class="string" id="3497504">&#34;\n&#34;</span><span class="op" id="3497508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497511">context</span>&nbsp;<span class="op" id="3497519">=</span>&nbsp;<span class="ident" id="3497521">n</span><span class="op" id="3497522">.</span><span class="ident" id="3497523">String</span><span class="op" id="3497529">(</span><span class="op" id="3497530">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3497533">if</span>&nbsp;<span class="builtinfunc" id="3497536">len</span><span class="op" id="3497539">(</span><span class="ident" id="3497540">context</span><span class="op" id="3497547">)</span>&nbsp;<span class="op" id="3497549">&gt;</span>&nbsp;<span class="num" id="3497551">20</span>&nbsp;<span class="op" id="3497554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497558">context</span>&nbsp;<span class="op" id="3497566">=</span>&nbsp;<span class="ident" id="3497568">fmt</span><span class="op" id="3497571">.</span><span class="ident" id="3497572">Sprintf</span><span class="op" id="3497579">(</span><span class="string" id="3497580">&#34;%.20s...&#34;</span><span class="op" id="3497590">,</span>&nbsp;<span class="ident" id="3497592">context</span><span class="op" id="3497599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3497602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3497605">return</span>&nbsp;<span class="ident" id="3497612">fmt</span><span class="op" id="3497615">.</span><span class="ident" id="3497616">Sprintf</span><span class="op" id="3497623">(</span><span class="string" id="3497624">&#34;%s:%d:%d&#34;</span><span class="op" id="3497634">,</span>&nbsp;<span class="ident" id="3497636">tree</span><span class="op" id="3497640">.</span><span class="ident" id="3497641">ParseName</span><span class="op" id="3497650">,</span>&nbsp;<span class="ident" id="3497652">lineNum</span><span class="op" id="3497659">,</span>&nbsp;<span class="ident" id="3497661">byteNum</span><span class="op" id="3497668">)</span><span class="op" id="3497669">,</span>&nbsp;<span class="ident" id="3497671">context</span><br>
<span class="lineno"></span><span class="op" id="3497679">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3497682">//&nbsp;errorf&nbsp;formats&nbsp;the&nbsp;error&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3497737">func</span>&nbsp;<span class="op" id="3497742">(</span><span class="ident" id="3497743">t</span>&nbsp;<span class="op" id="3497745">*</span><span class="ident" id="3497746">Tree</span><span class="op" id="3497750">)</span>&nbsp;<span class="ident" id="3497752">errorf</span><span class="op" id="3497758">(</span><span class="ident" id="3497759">format</span>&nbsp;<span class="builtintype" id="3497766">string</span><span class="op" id="3497772">,</span>&nbsp;<span class="ident" id="3497774">args</span>&nbsp;<span class="op" id="3497779">...</span><span class="keyword" id="3497782">interface</span><span class="op" id="3497791">{</span><span class="op" id="3497792">}</span><span class="op" id="3497793">)</span>&nbsp;<span class="op" id="3497795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497798">t</span><span class="op" id="3497799">.</span><span class="ident" id="3497800">Root</span>&nbsp;<span class="op" id="3497805">=</span>&nbsp;<span class="ident" id="3497807">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3497812">format</span>&nbsp;<span class="op" id="3497819">=</span>&nbsp;<span class="ident" id="3497821">fmt</span><span class="op" id="3497824">.</span><span class="ident" id="3497825">Sprintf</span><span class="op" id="3497832">(</span><span class="string" id="3497833">&#34;template:&nbsp;%s:%d:&nbsp;%s&#34;</span><span class="op" id="3497854">,</span>&nbsp;<span class="ident" id="3497856">t</span><span class="op" id="3497857">.</span><span class="ident" id="3497858">ParseName</span><span class="op" id="3497867">,</span>&nbsp;<span class="ident" id="3497869">t</span><span class="op" id="3497870">.</span><span class="ident" id="3497871">lex</span><span class="op" id="3497874">.</span><span class="ident" id="3497875">lineNumber</span><span class="op" id="3497885">(</span><span class="op" id="3497886">)</span><span class="op" id="3497887">,</span>&nbsp;<span class="ident" id="3497889">format</span><span class="op" id="3497895">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3497898">panic</span><span class="op" id="3497903">(</span><span class="ident" id="3497904">fmt</span><span class="op" id="3497907">.</span><span class="ident" id="3497908">Errorf</span><span class="op" id="3497914">(</span><span class="ident" id="3497915">format</span><span class="op" id="3497921">,</span>&nbsp;<span class="ident" id="3497923">args</span><span class="op" id="3497927">...</span><span class="op" id="3497930">)</span><span class="op" id="3497931">)</span><br>
<span class="lineno"></span><span class="op" id="3497933">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3497936">//&nbsp;error&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3497968">func</span>&nbsp;<span class="op" id="3497973">(</span><span class="ident" id="3497974">t</span>&nbsp;<span class="op" id="3497976">*</span><span class="ident" id="3497977">Tree</span><span class="op" id="3497981">)</span>&nbsp;<span class="builtintype" id="3497983">error</span><span class="op" id="3497988">(</span><span class="ident" id="3497989">err</span>&nbsp;<span class="builtintype" id="3497993">error</span><span class="op" id="3497998">)</span>&nbsp;<span class="op" id="3498000">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498003">t</span><span class="op" id="3498004">.</span><span class="ident" id="3498005">errorf</span><span class="op" id="3498011">(</span><span class="string" id="3498012">&#34;%s&#34;</span><span class="op" id="3498016">,</span>&nbsp;<span class="ident" id="3498018">err</span><span class="op" id="3498021">)</span><br>
<span class="lineno"></span><span class="op" id="3498023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3498026">//&nbsp;expect&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;the&nbsp;required&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3498101">func</span>&nbsp;<span class="op" id="3498106">(</span><span class="ident" id="3498107">t</span>&nbsp;<span class="op" id="3498109">*</span><span class="ident" id="3498110">Tree</span><span class="op" id="3498114">)</span>&nbsp;<span class="ident" id="3498116">expect</span><span class="op" id="3498122">(</span><span class="ident" id="3498123">expected</span>&nbsp;<span class="ident" id="3498132">itemType</span><span class="op" id="3498140">,</span>&nbsp;<span class="ident" id="3498142">context</span>&nbsp;<span class="builtintype" id="3498150">string</span><span class="op" id="3498156">)</span>&nbsp;<span class="ident" id="3498158">item</span>&nbsp;<span class="op" id="3498163">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498166">token</span>&nbsp;<span class="op" id="3498172">:=</span>&nbsp;<span class="ident" id="3498175">t</span><span class="op" id="3498176">.</span><span class="ident" id="3498177">nextNonSpace</span><span class="op" id="3498189">(</span><span class="op" id="3498190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498193">if</span>&nbsp;<span class="ident" id="3498196">token</span><span class="op" id="3498201">.</span><span class="ident" id="3498202">typ</span>&nbsp;<span class="op" id="3498206">!=</span>&nbsp;<span class="ident" id="3498209">expected</span>&nbsp;<span class="op" id="3498218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498222">t</span><span class="op" id="3498223">.</span><span class="ident" id="3498224">unexpected</span><span class="op" id="3498234">(</span><span class="ident" id="3498235">token</span><span class="op" id="3498240">,</span>&nbsp;<span class="ident" id="3498242">context</span><span class="op" id="3498249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3498252">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498255">return</span>&nbsp;<span class="ident" id="3498262">token</span><br>
<span class="lineno">175</span><span class="op" id="3498268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3498271">//&nbsp;expectOneOf&nbsp;consumes&nbsp;the&nbsp;next&nbsp;token&nbsp;and&nbsp;guarantees&nbsp;it&nbsp;has&nbsp;one&nbsp;of&nbsp;the&nbsp;required&nbsp;types.</span><br>
<span class="lineno"></span><span class="keyword" id="3498359">func</span>&nbsp;<span class="op" id="3498364">(</span><span class="ident" id="3498365">t</span>&nbsp;<span class="op" id="3498367">*</span><span class="ident" id="3498368">Tree</span><span class="op" id="3498372">)</span>&nbsp;<span class="ident" id="3498374">expectOneOf</span><span class="op" id="3498385">(</span><span class="ident" id="3498386">expected1</span><span class="op" id="3498395">,</span>&nbsp;<span class="ident" id="3498397">expected2</span>&nbsp;<span class="ident" id="3498407">itemType</span><span class="op" id="3498415">,</span>&nbsp;<span class="ident" id="3498417">context</span>&nbsp;<span class="builtintype" id="3498425">string</span><span class="op" id="3498431">)</span>&nbsp;<span class="ident" id="3498433">item</span>&nbsp;<span class="op" id="3498438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498441">token</span>&nbsp;<span class="op" id="3498447">:=</span>&nbsp;<span class="ident" id="3498450">t</span><span class="op" id="3498451">.</span><span class="ident" id="3498452">nextNonSpace</span><span class="op" id="3498464">(</span><span class="op" id="3498465">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498468">if</span>&nbsp;<span class="ident" id="3498471">token</span><span class="op" id="3498476">.</span><span class="ident" id="3498477">typ</span>&nbsp;<span class="op" id="3498481">!=</span>&nbsp;<span class="ident" id="3498484">expected1</span>&nbsp;<span class="op" id="3498494">&amp;&amp;</span>&nbsp;<span class="ident" id="3498497">token</span><span class="op" id="3498502">.</span><span class="ident" id="3498503">typ</span>&nbsp;<span class="op" id="3498507">!=</span>&nbsp;<span class="ident" id="3498510">expected2</span>&nbsp;<span class="op" id="3498520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498524">t</span><span class="op" id="3498525">.</span><span class="ident" id="3498526">unexpected</span><span class="op" id="3498536">(</span><span class="ident" id="3498537">token</span><span class="op" id="3498542">,</span>&nbsp;<span class="ident" id="3498544">context</span><span class="op" id="3498551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3498554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498557">return</span>&nbsp;<span class="ident" id="3498564">token</span><br>
<span class="lineno"></span><span class="op" id="3498570">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="comment" id="3498573">//&nbsp;unexpected&nbsp;complains&nbsp;about&nbsp;the&nbsp;token&nbsp;and&nbsp;terminates&nbsp;processing.</span><br>
<span class="lineno"></span><span class="keyword" id="3498640">func</span>&nbsp;<span class="op" id="3498645">(</span><span class="ident" id="3498646">t</span>&nbsp;<span class="op" id="3498648">*</span><span class="ident" id="3498649">Tree</span><span class="op" id="3498653">)</span>&nbsp;<span class="ident" id="3498655">unexpected</span><span class="op" id="3498665">(</span><span class="ident" id="3498666">token</span>&nbsp;<span class="ident" id="3498672">item</span><span class="op" id="3498676">,</span>&nbsp;<span class="ident" id="3498678">context</span>&nbsp;<span class="builtintype" id="3498686">string</span><span class="op" id="3498692">)</span>&nbsp;<span class="op" id="3498694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498697">t</span><span class="op" id="3498698">.</span><span class="ident" id="3498699">errorf</span><span class="op" id="3498705">(</span><span class="string" id="3498706">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3498727">,</span>&nbsp;<span class="ident" id="3498729">token</span><span class="op" id="3498734">,</span>&nbsp;<span class="ident" id="3498736">context</span><span class="op" id="3498743">)</span><br>
<span class="lineno"></span><span class="op" id="3498745">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="3498748">//&nbsp;recover&nbsp;is&nbsp;the&nbsp;handler&nbsp;that&nbsp;turns&nbsp;panics&nbsp;into&nbsp;returns&nbsp;from&nbsp;the&nbsp;top&nbsp;level&nbsp;of&nbsp;Parse.</span><br>
<span class="lineno"></span><span class="keyword" id="3498834">func</span>&nbsp;<span class="op" id="3498839">(</span><span class="ident" id="3498840">t</span>&nbsp;<span class="op" id="3498842">*</span><span class="ident" id="3498843">Tree</span><span class="op" id="3498847">)</span>&nbsp;<span class="builtinfunc" id="3498849">recover</span><span class="op" id="3498856">(</span><span class="ident" id="3498857">errp</span>&nbsp;<span class="op" id="3498862">*</span><span class="builtintype" id="3498863">error</span><span class="op" id="3498868">)</span>&nbsp;<span class="op" id="3498870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498873">e</span>&nbsp;<span class="op" id="3498875">:=</span>&nbsp;<span class="builtinfunc" id="3498878">recover</span><span class="op" id="3498885">(</span><span class="op" id="3498886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498889">if</span>&nbsp;<span class="ident" id="3498892">e</span>&nbsp;<span class="op" id="3498894">!=</span>&nbsp;<span class="ident" id="3498897">nil</span>&nbsp;<span class="op" id="3498901">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498905">if</span>&nbsp;<span class="ident" id="3498908">_</span><span class="op" id="3498909">,</span>&nbsp;<span class="ident" id="3498911">ok</span>&nbsp;<span class="op" id="3498914">:=</span>&nbsp;<span class="ident" id="3498917">e</span><span class="op" id="3498918">.</span><span class="op" id="3498919">(</span><span class="ident" id="3498920">runtime</span><span class="op" id="3498927">.</span><span class="ident" id="3498928">Error</span><span class="op" id="3498933">)</span><span class="op" id="3498934">;</span>&nbsp;<span class="ident" id="3498936">ok</span>&nbsp;<span class="op" id="3498939">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3498944">panic</span><span class="op" id="3498949">(</span><span class="ident" id="3498950">e</span><span class="op" id="3498951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3498955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3498959">if</span>&nbsp;<span class="ident" id="3498962">t</span>&nbsp;<span class="op" id="3498964">!=</span>&nbsp;<span class="ident" id="3498967">nil</span>&nbsp;<span class="op" id="3498971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3498976">t</span><span class="op" id="3498977">.</span><span class="ident" id="3498978">stopParse</span><span class="op" id="3498987">(</span><span class="op" id="3498988">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3498992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3498996">*</span><span class="ident" id="3498997">errp</span>&nbsp;<span class="op" id="3499002">=</span>&nbsp;<span class="ident" id="3499004">e</span><span class="op" id="3499005">.</span><span class="op" id="3499006">(</span><span class="builtintype" id="3499007">error</span><span class="op" id="3499012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3499015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3499018">return</span><br>
<span class="lineno"></span><span class="op" id="3499025">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="comment" id="3499028">//&nbsp;startParse&nbsp;initializes&nbsp;the&nbsp;parser,&nbsp;using&nbsp;the&nbsp;lexer.</span><br>
<span class="lineno"></span><span class="keyword" id="3499083">func</span>&nbsp;<span class="op" id="3499088">(</span><span class="ident" id="3499089">t</span>&nbsp;<span class="op" id="3499091">*</span><span class="ident" id="3499092">Tree</span><span class="op" id="3499096">)</span>&nbsp;<span class="ident" id="3499098">startParse</span><span class="op" id="3499108">(</span><span class="ident" id="3499109">funcs</span>&nbsp;<span class="op" id="3499115">[</span><span class="op" id="3499116">]</span><span class="keyword" id="3499117">map</span><span class="op" id="3499120">[</span><span class="builtintype" id="3499121">string</span><span class="op" id="3499127">]</span><span class="keyword" id="3499128">interface</span><span class="op" id="3499137">{</span><span class="op" id="3499138">}</span><span class="op" id="3499139">,</span>&nbsp;<span class="ident" id="3499141">lex</span>&nbsp;<span class="op" id="3499145">*</span><span class="ident" id="3499146">lexer</span><span class="op" id="3499151">)</span>&nbsp;<span class="op" id="3499153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499156">t</span><span class="op" id="3499157">.</span><span class="ident" id="3499158">Root</span>&nbsp;<span class="op" id="3499163">=</span>&nbsp;<span class="ident" id="3499165">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499170">t</span><span class="op" id="3499171">.</span><span class="ident" id="3499172">lex</span>&nbsp;<span class="op" id="3499176">=</span>&nbsp;<span class="ident" id="3499178">lex</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499183">t</span><span class="op" id="3499184">.</span><span class="ident" id="3499185">vars</span>&nbsp;<span class="op" id="3499190">=</span>&nbsp;<span class="op" id="3499192">[</span><span class="op" id="3499193">]</span><span class="builtintype" id="3499194">string</span><span class="op" id="3499200">{</span><span class="string" id="3499201">&#34;$&#34;</span><span class="op" id="3499204">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499207">t</span><span class="op" id="3499208">.</span><span class="ident" id="3499209">funcs</span>&nbsp;<span class="op" id="3499215">=</span>&nbsp;<span class="ident" id="3499217">funcs</span><br>
<span class="lineno"></span><span class="op" id="3499223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3499226">//&nbsp;stopParse&nbsp;terminates&nbsp;parsing.</span><br>
<span class="lineno">215</span><span class="keyword" id="3499259">func</span>&nbsp;<span class="op" id="3499264">(</span><span class="ident" id="3499265">t</span>&nbsp;<span class="op" id="3499267">*</span><span class="ident" id="3499268">Tree</span><span class="op" id="3499272">)</span>&nbsp;<span class="ident" id="3499274">stopParse</span><span class="op" id="3499283">(</span><span class="op" id="3499284">)</span>&nbsp;<span class="op" id="3499286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499289">t</span><span class="op" id="3499290">.</span><span class="ident" id="3499291">lex</span>&nbsp;<span class="op" id="3499295">=</span>&nbsp;<span class="ident" id="3499297">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499302">t</span><span class="op" id="3499303">.</span><span class="ident" id="3499304">vars</span>&nbsp;<span class="op" id="3499309">=</span>&nbsp;<span class="ident" id="3499311">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499316">t</span><span class="op" id="3499317">.</span><span class="ident" id="3499318">funcs</span>&nbsp;<span class="op" id="3499324">=</span>&nbsp;<span class="ident" id="3499326">nil</span><br>
<span class="lineno"></span><span class="op" id="3499330">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="comment" id="3499333">//&nbsp;Parse&nbsp;parses&nbsp;the&nbsp;template&nbsp;definition&nbsp;string&nbsp;to&nbsp;construct&nbsp;a&nbsp;representation&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3499413">//&nbsp;the&nbsp;template&nbsp;for&nbsp;execution.&nbsp;If&nbsp;either&nbsp;action&nbsp;delimiter&nbsp;string&nbsp;is&nbsp;empty,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3499492">//&nbsp;default&nbsp;(&#34;{{&#34;&nbsp;or&nbsp;&#34;}}&#34;)&nbsp;is&nbsp;used.&nbsp;Embedded&nbsp;template&nbsp;definitions&nbsp;are&nbsp;added&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3499570">//&nbsp;the&nbsp;treeSet&nbsp;map.</span><br>
<span class="lineno">225</span><span class="keyword" id="3499590">func</span>&nbsp;<span class="op" id="3499595">(</span><span class="ident" id="3499596">t</span>&nbsp;<span class="op" id="3499598">*</span><span class="ident" id="3499599">Tree</span><span class="op" id="3499603">)</span>&nbsp;<span class="ident" id="3499605">Parse</span><span class="op" id="3499610">(</span><span class="ident" id="3499611">text</span><span class="op" id="3499615">,</span>&nbsp;<span class="ident" id="3499617">leftDelim</span><span class="op" id="3499626">,</span>&nbsp;<span class="ident" id="3499628">rightDelim</span>&nbsp;<span class="builtintype" id="3499639">string</span><span class="op" id="3499645">,</span>&nbsp;<span class="ident" id="3499647">treeSet</span>&nbsp;<span class="keyword" id="3499655">map</span><span class="op" id="3499658">[</span><span class="builtintype" id="3499659">string</span><span class="op" id="3499665">]</span><span class="op" id="3499666">*</span><span class="ident" id="3499667">Tree</span><span class="op" id="3499671">,</span>&nbsp;<span class="ident" id="3499673">funcs</span>&nbsp;<span class="op" id="3499679">...</span><span class="keyword" id="3499682">map</span><span class="op" id="3499685">[</span><span class="builtintype" id="3499686">string</span><span class="op" id="3499692">]</span><span class="keyword" id="3499693">interface</span><span class="op" id="3499702">{</span><span class="op" id="3499703">}</span><span class="op" id="3499704">)</span>&nbsp;<span class="op" id="3499706">(</span><span class="ident" id="3499707">tree</span>&nbsp;<span class="op" id="3499712">*</span><span class="ident" id="3499713">Tree</span><span class="op" id="3499717">,</span>&nbsp;<span class="ident" id="3499719">err</span>&nbsp;<span class="builtintype" id="3499723">error</span><span class="op" id="3499728">)</span>&nbsp;<span class="op" id="3499730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3499733">defer</span>&nbsp;<span class="ident" id="3499739">t</span><span class="op" id="3499740">.</span><span class="builtinfunc" id="3499741">recover</span><span class="op" id="3499748">(</span><span class="op" id="3499749">&amp;</span><span class="ident" id="3499750">err</span><span class="op" id="3499753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499756">t</span><span class="op" id="3499757">.</span><span class="ident" id="3499758">ParseName</span>&nbsp;<span class="op" id="3499768">=</span>&nbsp;<span class="ident" id="3499770">t</span><span class="op" id="3499771">.</span><span class="ident" id="3499772">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499778">t</span><span class="op" id="3499779">.</span><span class="ident" id="3499780">startParse</span><span class="op" id="3499790">(</span><span class="ident" id="3499791">funcs</span><span class="op" id="3499796">,</span>&nbsp;<span class="ident" id="3499798">lex</span><span class="op" id="3499801">(</span><span class="ident" id="3499802">t</span><span class="op" id="3499803">.</span><span class="ident" id="3499804">Name</span><span class="op" id="3499808">,</span>&nbsp;<span class="ident" id="3499810">text</span><span class="op" id="3499814">,</span>&nbsp;<span class="ident" id="3499816">leftDelim</span><span class="op" id="3499825">,</span>&nbsp;<span class="ident" id="3499827">rightDelim</span><span class="op" id="3499837">)</span><span class="op" id="3499838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499841">t</span><span class="op" id="3499842">.</span><span class="ident" id="3499843">text</span>&nbsp;<span class="op" id="3499848">=</span>&nbsp;<span class="ident" id="3499850">text</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499856">t</span><span class="op" id="3499857">.</span><span class="ident" id="3499858">parse</span><span class="op" id="3499863">(</span><span class="ident" id="3499864">treeSet</span><span class="op" id="3499871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499874">t</span><span class="op" id="3499875">.</span><span class="ident" id="3499876">add</span><span class="op" id="3499879">(</span><span class="ident" id="3499880">treeSet</span><span class="op" id="3499887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3499890">t</span><span class="op" id="3499891">.</span><span class="ident" id="3499892">stopParse</span><span class="op" id="3499901">(</span><span class="op" id="3499902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3499905">return</span>&nbsp;<span class="ident" id="3499912">t</span><span class="op" id="3499913">,</span>&nbsp;<span class="ident" id="3499915">nil</span><br>
<span class="lineno"></span><span class="op" id="3499919">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3499922">//&nbsp;add&nbsp;adds&nbsp;tree&nbsp;to&nbsp;the&nbsp;treeSet.</span><br>
<span class="lineno"></span><span class="keyword" id="3499955">func</span>&nbsp;<span class="op" id="3499960">(</span><span class="ident" id="3499961">t</span>&nbsp;<span class="op" id="3499963">*</span><span class="ident" id="3499964">Tree</span><span class="op" id="3499968">)</span>&nbsp;<span class="ident" id="3499970">add</span><span class="op" id="3499973">(</span><span class="ident" id="3499974">treeSet</span>&nbsp;<span class="keyword" id="3499982">map</span><span class="op" id="3499985">[</span><span class="builtintype" id="3499986">string</span><span class="op" id="3499992">]</span><span class="op" id="3499993">*</span><span class="ident" id="3499994">Tree</span><span class="op" id="3499998">)</span>&nbsp;<span class="op" id="3500000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3500003">tree</span>&nbsp;<span class="op" id="3500008">:=</span>&nbsp;<span class="ident" id="3500011">treeSet</span><span class="op" id="3500018">[</span><span class="ident" id="3500019">t</span><span class="op" id="3500020">.</span><span class="ident" id="3500021">Name</span><span class="op" id="3500025">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500028">if</span>&nbsp;<span class="ident" id="3500031">tree</span>&nbsp;<span class="op" id="3500036">==</span>&nbsp;<span class="ident" id="3500039">nil</span>&nbsp;<span class="op" id="3500043">||</span>&nbsp;<span class="ident" id="3500046">IsEmptyTree</span><span class="op" id="3500057">(</span><span class="ident" id="3500058">tree</span><span class="op" id="3500062">.</span><span class="ident" id="3500063">Root</span><span class="op" id="3500067">)</span>&nbsp;<span class="op" id="3500069">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3500073">treeSet</span><span class="op" id="3500080">[</span><span class="ident" id="3500081">t</span><span class="op" id="3500082">.</span><span class="ident" id="3500083">Name</span><span class="op" id="3500087">]</span>&nbsp;<span class="op" id="3500089">=</span>&nbsp;<span class="ident" id="3500091">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500095">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3500103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500106">if</span>&nbsp;<span class="op" id="3500109">!</span><span class="ident" id="3500110">IsEmptyTree</span><span class="op" id="3500121">(</span><span class="ident" id="3500122">t</span><span class="op" id="3500123">.</span><span class="ident" id="3500124">Root</span><span class="op" id="3500128">)</span>&nbsp;<span class="op" id="3500130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3500134">t</span><span class="op" id="3500135">.</span><span class="ident" id="3500136">errorf</span><span class="op" id="3500142">(</span><span class="string" id="3500143">&#34;template:&nbsp;multiple&nbsp;definition&nbsp;of&nbsp;template&nbsp;%q&#34;</span><span class="op" id="3500189">,</span>&nbsp;<span class="ident" id="3500191">t</span><span class="op" id="3500192">.</span><span class="ident" id="3500193">Name</span><span class="op" id="3500197">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3500200">}</span><br>
<span class="lineno"></span><span class="op" id="3500202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3500205">//&nbsp;IsEmptyTree&nbsp;reports&nbsp;whether&nbsp;this&nbsp;tree&nbsp;(node)&nbsp;is&nbsp;empty&nbsp;of&nbsp;everything&nbsp;but&nbsp;space.</span><br>
<span class="lineno"></span><span class="keyword" id="3500287">func</span>&nbsp;<span class="ident" id="3500292">IsEmptyTree</span><span class="op" id="3500303">(</span><span class="ident" id="3500304">n</span>&nbsp;<span class="ident" id="3500306">Node</span><span class="op" id="3500310">)</span>&nbsp;<span class="builtintype" id="3500312">bool</span>&nbsp;<span class="op" id="3500317">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500320">switch</span>&nbsp;<span class="ident" id="3500327">n</span>&nbsp;<span class="op" id="3500329">:=</span>&nbsp;<span class="ident" id="3500332">n</span><span class="op" id="3500333">.</span><span class="op" id="3500334">(</span><span class="keyword" id="3500335">type</span><span class="op" id="3500339">)</span>&nbsp;<span class="op" id="3500341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500344">case</span>&nbsp;<span class="ident" id="3500349">nil</span><span class="op" id="3500352">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500356">return</span>&nbsp;<span class="builtintype" id="3500363">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500369">case</span>&nbsp;<span class="op" id="3500374">*</span><span class="ident" id="3500375">ActionNode</span><span class="op" id="3500385">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500388">case</span>&nbsp;<span class="op" id="3500393">*</span><span class="ident" id="3500394">IfNode</span><span class="op" id="3500400">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500403">case</span>&nbsp;<span class="op" id="3500408">*</span><span class="ident" id="3500409">ListNode</span><span class="op" id="3500417">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500421">for</span>&nbsp;<span class="ident" id="3500425">_</span><span class="op" id="3500426">,</span>&nbsp;<span class="ident" id="3500428">node</span>&nbsp;<span class="op" id="3500433">:=</span>&nbsp;<span class="keyword" id="3500436">range</span>&nbsp;<span class="ident" id="3500442">n</span><span class="op" id="3500443">.</span><span class="ident" id="3500444">Nodes</span>&nbsp;<span class="op" id="3500450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500455">if</span>&nbsp;<span class="op" id="3500458">!</span><span class="ident" id="3500459">IsEmptyTree</span><span class="op" id="3500470">(</span><span class="ident" id="3500471">node</span><span class="op" id="3500475">)</span>&nbsp;<span class="op" id="3500477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500483">return</span>&nbsp;<span class="builtintype" id="3500490">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3500499">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3500503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500507">return</span>&nbsp;<span class="builtintype" id="3500514">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500520">case</span>&nbsp;<span class="op" id="3500525">*</span><span class="ident" id="3500526">RangeNode</span><span class="op" id="3500535">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500538">case</span>&nbsp;<span class="op" id="3500543">*</span><span class="ident" id="3500544">TemplateNode</span><span class="op" id="3500556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500559">case</span>&nbsp;<span class="op" id="3500564">*</span><span class="ident" id="3500565">TextNode</span><span class="op" id="3500573">:</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500577">return</span>&nbsp;<span class="builtinfunc" id="3500584">len</span><span class="op" id="3500587">(</span><span class="ident" id="3500588">bytes</span><span class="op" id="3500593">.</span><span class="ident" id="3500594">TrimSpace</span><span class="op" id="3500603">(</span><span class="ident" id="3500604">n</span><span class="op" id="3500605">.</span><span class="ident" id="3500606">Text</span><span class="op" id="3500610">)</span><span class="op" id="3500611">)</span>&nbsp;<span class="op" id="3500613">==</span>&nbsp;<span class="num" id="3500616">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500619">case</span>&nbsp;<span class="op" id="3500624">*</span><span class="ident" id="3500625">WithNode</span><span class="op" id="3500633">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500636">default</span><span class="op" id="3500643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3500647">panic</span><span class="op" id="3500652">(</span><span class="string" id="3500653">&#34;unknown&nbsp;node:&nbsp;&#34;</span>&nbsp;<span class="op" id="3500670">+</span>&nbsp;<span class="ident" id="3500672">n</span><span class="op" id="3500673">.</span><span class="ident" id="3500674">String</span><span class="op" id="3500680">(</span><span class="op" id="3500681">)</span><span class="op" id="3500682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3500685">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500688">return</span>&nbsp;<span class="builtintype" id="3500695">false</span><br>
<span class="lineno"></span><span class="op" id="3500701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3500704">//&nbsp;parse&nbsp;is&nbsp;the&nbsp;top-level&nbsp;parser&nbsp;for&nbsp;a&nbsp;template,&nbsp;essentially&nbsp;the&nbsp;same</span><br>
<span class="lineno"></span><span class="comment" id="3500774">//&nbsp;as&nbsp;itemList&nbsp;except&nbsp;it&nbsp;also&nbsp;parses&nbsp;{{define}}&nbsp;actions.</span><br>
<span class="lineno">275</span><span class="comment" id="3500831">//&nbsp;It&nbsp;runs&nbsp;to&nbsp;EOF.</span><br>
<span class="lineno"></span><span class="keyword" id="3500850">func</span>&nbsp;<span class="op" id="3500855">(</span><span class="ident" id="3500856">t</span>&nbsp;<span class="op" id="3500858">*</span><span class="ident" id="3500859">Tree</span><span class="op" id="3500863">)</span>&nbsp;<span class="ident" id="3500865">parse</span><span class="op" id="3500870">(</span><span class="ident" id="3500871">treeSet</span>&nbsp;<span class="keyword" id="3500879">map</span><span class="op" id="3500882">[</span><span class="builtintype" id="3500883">string</span><span class="op" id="3500889">]</span><span class="op" id="3500890">*</span><span class="ident" id="3500891">Tree</span><span class="op" id="3500895">)</span>&nbsp;<span class="op" id="3500897">(</span><span class="ident" id="3500898">next</span>&nbsp;<span class="ident" id="3500903">Node</span><span class="op" id="3500907">)</span>&nbsp;<span class="op" id="3500909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3500912">t</span><span class="op" id="3500913">.</span><span class="ident" id="3500914">Root</span>&nbsp;<span class="op" id="3500919">=</span>&nbsp;<span class="ident" id="3500921">t</span><span class="op" id="3500922">.</span><span class="ident" id="3500923">newList</span><span class="op" id="3500930">(</span><span class="ident" id="3500931">t</span><span class="op" id="3500932">.</span><span class="ident" id="3500933">peek</span><span class="op" id="3500937">(</span><span class="op" id="3500938">)</span><span class="op" id="3500939">.</span><span class="ident" id="3500940">pos</span><span class="op" id="3500943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500946">for</span>&nbsp;<span class="ident" id="3500950">t</span><span class="op" id="3500951">.</span><span class="ident" id="3500952">peek</span><span class="op" id="3500956">(</span><span class="op" id="3500957">)</span><span class="op" id="3500958">.</span><span class="ident" id="3500959">typ</span>&nbsp;<span class="op" id="3500963">!=</span>&nbsp;<span class="ident" id="3500966">itemEOF</span>&nbsp;<span class="op" id="3500974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3500978">if</span>&nbsp;<span class="ident" id="3500981">t</span><span class="op" id="3500982">.</span><span class="ident" id="3500983">peek</span><span class="op" id="3500987">(</span><span class="op" id="3500988">)</span><span class="op" id="3500989">.</span><span class="ident" id="3500990">typ</span>&nbsp;<span class="op" id="3500994">==</span>&nbsp;<span class="ident" id="3500997">itemLeftDelim</span>&nbsp;<span class="op" id="3501011">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501016">delim</span>&nbsp;<span class="op" id="3501022">:=</span>&nbsp;<span class="ident" id="3501025">t</span><span class="op" id="3501026">.</span><span class="ident" id="3501027">next</span><span class="op" id="3501031">(</span><span class="op" id="3501032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501037">if</span>&nbsp;<span class="ident" id="3501040">t</span><span class="op" id="3501041">.</span><span class="ident" id="3501042">nextNonSpace</span><span class="op" id="3501054">(</span><span class="op" id="3501055">)</span><span class="op" id="3501056">.</span><span class="ident" id="3501057">typ</span>&nbsp;<span class="op" id="3501061">==</span>&nbsp;<span class="ident" id="3501064">itemDefine</span>&nbsp;<span class="op" id="3501075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501081">newT</span>&nbsp;<span class="op" id="3501086">:=</span>&nbsp;<span class="ident" id="3501089">New</span><span class="op" id="3501092">(</span><span class="string" id="3501093">&#34;definition&#34;</span><span class="op" id="3501105">)</span>&nbsp;<span class="comment" id="3501107">//&nbsp;name&nbsp;will&nbsp;be&nbsp;updated&nbsp;once&nbsp;we&nbsp;know&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501152">newT</span><span class="op" id="3501156">.</span><span class="ident" id="3501157">text</span>&nbsp;<span class="op" id="3501162">=</span>&nbsp;<span class="ident" id="3501164">t</span><span class="op" id="3501165">.</span><span class="ident" id="3501166">text</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501175">newT</span><span class="op" id="3501179">.</span><span class="ident" id="3501180">ParseName</span>&nbsp;<span class="op" id="3501190">=</span>&nbsp;<span class="ident" id="3501192">t</span><span class="op" id="3501193">.</span><span class="ident" id="3501194">ParseName</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501208">newT</span><span class="op" id="3501212">.</span><span class="ident" id="3501213">startParse</span><span class="op" id="3501223">(</span><span class="ident" id="3501224">t</span><span class="op" id="3501225">.</span><span class="ident" id="3501226">funcs</span><span class="op" id="3501231">,</span>&nbsp;<span class="ident" id="3501233">t</span><span class="op" id="3501234">.</span><span class="ident" id="3501235">lex</span><span class="op" id="3501238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501244">newT</span><span class="op" id="3501248">.</span><span class="ident" id="3501249">parseDefinition</span><span class="op" id="3501264">(</span><span class="ident" id="3501265">treeSet</span><span class="op" id="3501272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501278">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3501290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501295">t</span><span class="op" id="3501296">.</span><span class="ident" id="3501297">backup2</span><span class="op" id="3501304">(</span><span class="ident" id="3501305">delim</span><span class="op" id="3501310">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3501314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501318">n</span>&nbsp;<span class="op" id="3501320">:=</span>&nbsp;<span class="ident" id="3501323">t</span><span class="op" id="3501324">.</span><span class="ident" id="3501325">textOrAction</span><span class="op" id="3501337">(</span><span class="op" id="3501338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501342">if</span>&nbsp;<span class="ident" id="3501345">n</span><span class="op" id="3501346">.</span><span class="ident" id="3501347">Type</span><span class="op" id="3501351">(</span><span class="op" id="3501352">)</span>&nbsp;<span class="op" id="3501354">==</span>&nbsp;<span class="ident" id="3501357">nodeEnd</span>&nbsp;<span class="op" id="3501365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501370">t</span><span class="op" id="3501371">.</span><span class="ident" id="3501372">errorf</span><span class="op" id="3501378">(</span><span class="string" id="3501379">&#34;unexpected&nbsp;%s&#34;</span><span class="op" id="3501394">,</span>&nbsp;<span class="ident" id="3501396">n</span><span class="op" id="3501397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3501401">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501405">t</span><span class="op" id="3501406">.</span><span class="ident" id="3501407">Root</span><span class="op" id="3501411">.</span><span class="builtinfunc" id="3501412">append</span><span class="op" id="3501418">(</span><span class="ident" id="3501419">n</span><span class="op" id="3501420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3501423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501426">return</span>&nbsp;<span class="ident" id="3501433">nil</span><br>
<span class="lineno"></span><span class="op" id="3501437">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="3501440">//&nbsp;parseDefinition&nbsp;parses&nbsp;a&nbsp;{{define}}&nbsp;...&nbsp;&nbsp;{{end}}&nbsp;template&nbsp;definition&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3501516">//&nbsp;installs&nbsp;the&nbsp;definition&nbsp;in&nbsp;the&nbsp;treeSet&nbsp;map.&nbsp;&nbsp;The&nbsp;&#34;define&#34;&nbsp;keyword&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="3501597">//&nbsp;been&nbsp;scanned.</span><br>
<span class="lineno"></span><span class="keyword" id="3501614">func</span>&nbsp;<span class="op" id="3501619">(</span><span class="ident" id="3501620">t</span>&nbsp;<span class="op" id="3501622">*</span><span class="ident" id="3501623">Tree</span><span class="op" id="3501627">)</span>&nbsp;<span class="ident" id="3501629">parseDefinition</span><span class="op" id="3501644">(</span><span class="ident" id="3501645">treeSet</span>&nbsp;<span class="keyword" id="3501653">map</span><span class="op" id="3501656">[</span><span class="builtintype" id="3501657">string</span><span class="op" id="3501663">]</span><span class="op" id="3501664">*</span><span class="ident" id="3501665">Tree</span><span class="op" id="3501669">)</span>&nbsp;<span class="op" id="3501671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501674">const</span>&nbsp;<span class="ident" id="3501680">context</span>&nbsp;<span class="op" id="3501688">=</span>&nbsp;<span class="string" id="3501690">&#34;define&nbsp;clause&#34;</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501707">name</span>&nbsp;<span class="op" id="3501712">:=</span>&nbsp;<span class="ident" id="3501715">t</span><span class="op" id="3501716">.</span><span class="ident" id="3501717">expectOneOf</span><span class="op" id="3501728">(</span><span class="ident" id="3501729">itemString</span><span class="op" id="3501739">,</span>&nbsp;<span class="ident" id="3501741">itemRawString</span><span class="op" id="3501754">,</span>&nbsp;<span class="ident" id="3501756">context</span><span class="op" id="3501763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501766">var</span>&nbsp;<span class="ident" id="3501770">err</span>&nbsp;<span class="builtintype" id="3501774">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501781">t</span><span class="op" id="3501782">.</span><span class="ident" id="3501783">Name</span><span class="op" id="3501787">,</span>&nbsp;<span class="ident" id="3501789">err</span>&nbsp;<span class="op" id="3501793">=</span>&nbsp;<span class="ident" id="3501795">strconv</span><span class="op" id="3501802">.</span><span class="ident" id="3501803">Unquote</span><span class="op" id="3501810">(</span><span class="ident" id="3501811">name</span><span class="op" id="3501815">.</span><span class="ident" id="3501816">val</span><span class="op" id="3501819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501822">if</span>&nbsp;<span class="ident" id="3501825">err</span>&nbsp;<span class="op" id="3501829">!=</span>&nbsp;<span class="ident" id="3501832">nil</span>&nbsp;<span class="op" id="3501836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501840">t</span><span class="op" id="3501841">.</span><span class="builtintype" id="3501842">error</span><span class="op" id="3501847">(</span><span class="ident" id="3501848">err</span><span class="op" id="3501851">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3501854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501857">t</span><span class="op" id="3501858">.</span><span class="ident" id="3501859">expect</span><span class="op" id="3501865">(</span><span class="ident" id="3501866">itemRightDelim</span><span class="op" id="3501880">,</span>&nbsp;<span class="ident" id="3501882">context</span><span class="op" id="3501889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501892">var</span>&nbsp;<span class="ident" id="3501896">end</span>&nbsp;<span class="ident" id="3501900">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501906">t</span><span class="op" id="3501907">.</span><span class="ident" id="3501908">Root</span><span class="op" id="3501912">,</span>&nbsp;<span class="ident" id="3501914">end</span>&nbsp;<span class="op" id="3501918">=</span>&nbsp;<span class="ident" id="3501920">t</span><span class="op" id="3501921">.</span><span class="ident" id="3501922">itemList</span><span class="op" id="3501930">(</span><span class="op" id="3501931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3501934">if</span>&nbsp;<span class="ident" id="3501937">end</span><span class="op" id="3501940">.</span><span class="ident" id="3501941">Type</span><span class="op" id="3501945">(</span><span class="op" id="3501946">)</span>&nbsp;<span class="op" id="3501948">!=</span>&nbsp;<span class="ident" id="3501951">nodeEnd</span>&nbsp;<span class="op" id="3501959">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3501963">t</span><span class="op" id="3501964">.</span><span class="ident" id="3501965">errorf</span><span class="op" id="3501971">(</span><span class="string" id="3501972">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3501993">,</span>&nbsp;<span class="ident" id="3501995">end</span><span class="op" id="3501998">,</span>&nbsp;<span class="ident" id="3502000">context</span><span class="op" id="3502007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3502010">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502013">t</span><span class="op" id="3502014">.</span><span class="ident" id="3502015">add</span><span class="op" id="3502018">(</span><span class="ident" id="3502019">treeSet</span><span class="op" id="3502026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502029">t</span><span class="op" id="3502030">.</span><span class="ident" id="3502031">stopParse</span><span class="op" id="3502040">(</span><span class="op" id="3502041">)</span><br>
<span class="lineno"></span><span class="op" id="3502043">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span><span class="comment" id="3502046">//&nbsp;itemList:</span><br>
<span class="lineno"></span><span class="comment" id="3502059">//&nbsp;&nbsp;&nbsp;&nbsptextOrAction*</span><br>
<span class="lineno"></span><span class="comment" id="3502076">//&nbsp;Terminates&nbsp;at&nbsp;{{end}}&nbsp;or&nbsp;{{else}},&nbsp;returned&nbsp;separately.</span><br>
<span class="lineno"></span><span class="keyword" id="3502135">func</span>&nbsp;<span class="op" id="3502140">(</span><span class="ident" id="3502141">t</span>&nbsp;<span class="op" id="3502143">*</span><span class="ident" id="3502144">Tree</span><span class="op" id="3502148">)</span>&nbsp;<span class="ident" id="3502150">itemList</span><span class="op" id="3502158">(</span><span class="op" id="3502159">)</span>&nbsp;<span class="op" id="3502161">(</span><span class="ident" id="3502162">list</span>&nbsp;<span class="op" id="3502167">*</span><span class="ident" id="3502168">ListNode</span><span class="op" id="3502176">,</span>&nbsp;<span class="ident" id="3502178">next</span>&nbsp;<span class="ident" id="3502183">Node</span><span class="op" id="3502187">)</span>&nbsp;<span class="op" id="3502189">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502192">list</span>&nbsp;<span class="op" id="3502197">=</span>&nbsp;<span class="ident" id="3502199">t</span><span class="op" id="3502200">.</span><span class="ident" id="3502201">newList</span><span class="op" id="3502208">(</span><span class="ident" id="3502209">t</span><span class="op" id="3502210">.</span><span class="ident" id="3502211">peekNonSpace</span><span class="op" id="3502223">(</span><span class="op" id="3502224">)</span><span class="op" id="3502225">.</span><span class="ident" id="3502226">pos</span><span class="op" id="3502229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502232">for</span>&nbsp;<span class="ident" id="3502236">t</span><span class="op" id="3502237">.</span><span class="ident" id="3502238">peekNonSpace</span><span class="op" id="3502250">(</span><span class="op" id="3502251">)</span><span class="op" id="3502252">.</span><span class="ident" id="3502253">typ</span>&nbsp;<span class="op" id="3502257">!=</span>&nbsp;<span class="ident" id="3502260">itemEOF</span>&nbsp;<span class="op" id="3502268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502272">n</span>&nbsp;<span class="op" id="3502274">:=</span>&nbsp;<span class="ident" id="3502277">t</span><span class="op" id="3502278">.</span><span class="ident" id="3502279">textOrAction</span><span class="op" id="3502291">(</span><span class="op" id="3502292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502296">switch</span>&nbsp;<span class="ident" id="3502303">n</span><span class="op" id="3502304">.</span><span class="ident" id="3502305">Type</span><span class="op" id="3502309">(</span><span class="op" id="3502310">)</span>&nbsp;<span class="op" id="3502312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502316">case</span>&nbsp;<span class="ident" id="3502321">nodeEnd</span><span class="op" id="3502328">,</span>&nbsp;<span class="ident" id="3502330">nodeElse</span><span class="op" id="3502338">:</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502343">return</span>&nbsp;<span class="ident" id="3502350">list</span><span class="op" id="3502354">,</span>&nbsp;<span class="ident" id="3502356">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3502360">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502364">list</span><span class="op" id="3502368">.</span><span class="builtinfunc" id="3502369">append</span><span class="op" id="3502375">(</span><span class="ident" id="3502376">n</span><span class="op" id="3502377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3502380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502383">t</span><span class="op" id="3502384">.</span><span class="ident" id="3502385">errorf</span><span class="op" id="3502391">(</span><span class="string" id="3502392">&#34;unexpected&nbsp;EOF&#34;</span><span class="op" id="3502408">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502411">return</span><br>
<span class="lineno"></span><span class="op" id="3502418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3502421">//&nbsp;textOrAction:</span><br>
<span class="lineno"></span><span class="comment" id="3502438">//&nbsp;&nbsp;&nbsp;&nbsptext&nbsp;|&nbsp;action</span><br>
<span class="lineno">340</span><span class="keyword" id="3502455">func</span>&nbsp;<span class="op" id="3502460">(</span><span class="ident" id="3502461">t</span>&nbsp;<span class="op" id="3502463">*</span><span class="ident" id="3502464">Tree</span><span class="op" id="3502468">)</span>&nbsp;<span class="ident" id="3502470">textOrAction</span><span class="op" id="3502482">(</span><span class="op" id="3502483">)</span>&nbsp;<span class="ident" id="3502485">Node</span>&nbsp;<span class="op" id="3502490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502493">switch</span>&nbsp;<span class="ident" id="3502500">token</span>&nbsp;<span class="op" id="3502506">:=</span>&nbsp;<span class="ident" id="3502509">t</span><span class="op" id="3502510">.</span><span class="ident" id="3502511">nextNonSpace</span><span class="op" id="3502523">(</span><span class="op" id="3502524">)</span><span class="op" id="3502525">;</span>&nbsp;<span class="ident" id="3502527">token</span><span class="op" id="3502532">.</span><span class="ident" id="3502533">typ</span>&nbsp;<span class="op" id="3502537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502540">case</span>&nbsp;<span class="ident" id="3502545">itemText</span><span class="op" id="3502553">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502557">return</span>&nbsp;<span class="ident" id="3502564">t</span><span class="op" id="3502565">.</span><span class="ident" id="3502566">newText</span><span class="op" id="3502573">(</span><span class="ident" id="3502574">token</span><span class="op" id="3502579">.</span><span class="ident" id="3502580">pos</span><span class="op" id="3502583">,</span>&nbsp;<span class="ident" id="3502585">token</span><span class="op" id="3502590">.</span><span class="ident" id="3502591">val</span><span class="op" id="3502594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502597">case</span>&nbsp;<span class="ident" id="3502602">itemLeftDelim</span><span class="op" id="3502615">:</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502619">return</span>&nbsp;<span class="ident" id="3502626">t</span><span class="op" id="3502627">.</span><span class="ident" id="3502628">action</span><span class="op" id="3502634">(</span><span class="op" id="3502635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502638">default</span><span class="op" id="3502645">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3502649">t</span><span class="op" id="3502650">.</span><span class="ident" id="3502651">unexpected</span><span class="op" id="3502661">(</span><span class="ident" id="3502662">token</span><span class="op" id="3502667">,</span>&nbsp;<span class="string" id="3502669">&#34;input&#34;</span><span class="op" id="3502676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3502679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502682">return</span>&nbsp;<span class="ident" id="3502689">nil</span><br>
<span class="lineno">350</span><span class="op" id="3502693">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3502696">//&nbsp;Action:</span><br>
<span class="lineno"></span><span class="comment" id="3502707">//&nbsp;&nbsp;&nbsp;&nbspcontrol</span><br>
<span class="lineno"></span><span class="comment" id="3502718">//&nbsp;&nbsp;&nbsp;&nbspcommand&nbsp;(&#34;|&#34;&nbsp;command)*</span><br>
<span class="lineno">355</span><span class="comment" id="3502744">//&nbsp;Left&nbsp;delim&nbsp;is&nbsp;past.&nbsp;Now&nbsp;get&nbsp;actions.</span><br>
<span class="lineno"></span><span class="comment" id="3502784">//&nbsp;First&nbsp;word&nbsp;could&nbsp;be&nbsp;a&nbsp;keyword&nbsp;such&nbsp;as&nbsp;range.</span><br>
<span class="lineno"></span><span class="keyword" id="3502832">func</span>&nbsp;<span class="op" id="3502837">(</span><span class="ident" id="3502838">t</span>&nbsp;<span class="op" id="3502840">*</span><span class="ident" id="3502841">Tree</span><span class="op" id="3502845">)</span>&nbsp;<span class="ident" id="3502847">action</span><span class="op" id="3502853">(</span><span class="op" id="3502854">)</span>&nbsp;<span class="op" id="3502856">(</span><span class="ident" id="3502857">n</span>&nbsp;<span class="ident" id="3502859">Node</span><span class="op" id="3502863">)</span>&nbsp;<span class="op" id="3502865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502868">switch</span>&nbsp;<span class="ident" id="3502875">token</span>&nbsp;<span class="op" id="3502881">:=</span>&nbsp;<span class="ident" id="3502884">t</span><span class="op" id="3502885">.</span><span class="ident" id="3502886">nextNonSpace</span><span class="op" id="3502898">(</span><span class="op" id="3502899">)</span><span class="op" id="3502900">;</span>&nbsp;<span class="ident" id="3502902">token</span><span class="op" id="3502907">.</span><span class="ident" id="3502908">typ</span>&nbsp;<span class="op" id="3502912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502915">case</span>&nbsp;<span class="ident" id="3502920">itemElse</span><span class="op" id="3502928">:</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502932">return</span>&nbsp;<span class="ident" id="3502939">t</span><span class="op" id="3502940">.</span><span class="ident" id="3502941">elseControl</span><span class="op" id="3502952">(</span><span class="op" id="3502953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502956">case</span>&nbsp;<span class="ident" id="3502961">itemEnd</span><span class="op" id="3502968">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502972">return</span>&nbsp;<span class="ident" id="3502979">t</span><span class="op" id="3502980">.</span><span class="ident" id="3502981">endControl</span><span class="op" id="3502991">(</span><span class="op" id="3502992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3502995">case</span>&nbsp;<span class="ident" id="3503000">itemIf</span><span class="op" id="3503006">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503010">return</span>&nbsp;<span class="ident" id="3503017">t</span><span class="op" id="3503018">.</span><span class="ident" id="3503019">ifControl</span><span class="op" id="3503028">(</span><span class="op" id="3503029">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503032">case</span>&nbsp;<span class="ident" id="3503037">itemRange</span><span class="op" id="3503046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503050">return</span>&nbsp;<span class="ident" id="3503057">t</span><span class="op" id="3503058">.</span><span class="ident" id="3503059">rangeControl</span><span class="op" id="3503071">(</span><span class="op" id="3503072">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503075">case</span>&nbsp;<span class="ident" id="3503080">itemTemplate</span><span class="op" id="3503092">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503096">return</span>&nbsp;<span class="ident" id="3503103">t</span><span class="op" id="3503104">.</span><span class="ident" id="3503105">templateControl</span><span class="op" id="3503120">(</span><span class="op" id="3503121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503124">case</span>&nbsp;<span class="ident" id="3503129">itemWith</span><span class="op" id="3503137">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503141">return</span>&nbsp;<span class="ident" id="3503148">t</span><span class="op" id="3503149">.</span><span class="ident" id="3503150">withControl</span><span class="op" id="3503161">(</span><span class="op" id="3503162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3503165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3503168">t</span><span class="op" id="3503169">.</span><span class="ident" id="3503170">backup</span><span class="op" id="3503176">(</span><span class="op" id="3503177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503180">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503232">return</span>&nbsp;<span class="ident" id="3503239">t</span><span class="op" id="3503240">.</span><span class="ident" id="3503241">newAction</span><span class="op" id="3503250">(</span><span class="ident" id="3503251">t</span><span class="op" id="3503252">.</span><span class="ident" id="3503253">peek</span><span class="op" id="3503257">(</span><span class="op" id="3503258">)</span><span class="op" id="3503259">.</span><span class="ident" id="3503260">pos</span><span class="op" id="3503263">,</span>&nbsp;<span class="ident" id="3503265">t</span><span class="op" id="3503266">.</span><span class="ident" id="3503267">lex</span><span class="op" id="3503270">.</span><span class="ident" id="3503271">lineNumber</span><span class="op" id="3503281">(</span><span class="op" id="3503282">)</span><span class="op" id="3503283">,</span>&nbsp;<span class="ident" id="3503285">t</span><span class="op" id="3503286">.</span><span class="ident" id="3503287">pipeline</span><span class="op" id="3503295">(</span><span class="string" id="3503296">&#34;command&#34;</span><span class="op" id="3503305">)</span><span class="op" id="3503306">)</span><br>
<span class="lineno">375</span><span class="op" id="3503308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3503311">//&nbsp;Pipeline:</span><br>
<span class="lineno"></span><span class="comment" id="3503324">//&nbsp;&nbsp;&nbsp;&nbspdeclarations?&nbsp;command&nbsp;(&#39;|&#39;&nbsp;command)*</span><br>
<span class="lineno"></span><span class="keyword" id="3503364">func</span>&nbsp;<span class="op" id="3503369">(</span><span class="ident" id="3503370">t</span>&nbsp;<span class="op" id="3503372">*</span><span class="ident" id="3503373">Tree</span><span class="op" id="3503377">)</span>&nbsp;<span class="ident" id="3503379">pipeline</span><span class="op" id="3503387">(</span><span class="ident" id="3503388">context</span>&nbsp;<span class="builtintype" id="3503396">string</span><span class="op" id="3503402">)</span>&nbsp;<span class="op" id="3503404">(</span><span class="ident" id="3503405">pipe</span>&nbsp;<span class="op" id="3503410">*</span><span class="ident" id="3503411">PipeNode</span><span class="op" id="3503419">)</span>&nbsp;<span class="op" id="3503421">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503424">var</span>&nbsp;<span class="ident" id="3503428">decl</span>&nbsp;<span class="op" id="3503433">[</span><span class="op" id="3503434">]</span><span class="op" id="3503435">*</span><span class="ident" id="3503436">VariableNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3503450">pos</span>&nbsp;<span class="op" id="3503454">:=</span>&nbsp;<span class="ident" id="3503457">t</span><span class="op" id="3503458">.</span><span class="ident" id="3503459">peekNonSpace</span><span class="op" id="3503471">(</span><span class="op" id="3503472">)</span><span class="op" id="3503473">.</span><span class="ident" id="3503474">pos</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503479">//&nbsp;Are&nbsp;there&nbsp;declarations?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503507">for</span>&nbsp;<span class="op" id="3503511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503515">if</span>&nbsp;<span class="ident" id="3503518">v</span>&nbsp;<span class="op" id="3503520">:=</span>&nbsp;<span class="ident" id="3503523">t</span><span class="op" id="3503524">.</span><span class="ident" id="3503525">peekNonSpace</span><span class="op" id="3503537">(</span><span class="op" id="3503538">)</span><span class="op" id="3503539">;</span>&nbsp;<span class="ident" id="3503541">v</span><span class="op" id="3503542">.</span><span class="ident" id="3503543">typ</span>&nbsp;<span class="op" id="3503547">==</span>&nbsp;<span class="ident" id="3503550">itemVariable</span>&nbsp;<span class="op" id="3503563">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3503568">t</span><span class="op" id="3503569">.</span><span class="ident" id="3503570">next</span><span class="op" id="3503574">(</span><span class="op" id="3503575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503580">//&nbsp;Since&nbsp;space&nbsp;is&nbsp;a&nbsp;token,&nbsp;we&nbsp;need&nbsp;3-token&nbsp;look-ahead&nbsp;here&nbsp;in&nbsp;the&nbsp;worst&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503661">//&nbsp;in&nbsp;&#34;$x&nbsp;foo&#34;&nbsp;we&nbsp;need&nbsp;to&nbsp;read&nbsp;&#34;foo&#34;&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;&#34;:=&#34;)&nbsp;to&nbsp;know&nbsp;that&nbsp;$x&nbsp;is&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503744">//&nbsp;argument&nbsp;variable&nbsp;rather&nbsp;than&nbsp;a&nbsp;declaration.&nbsp;So&nbsp;remember&nbsp;the&nbsp;token</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3503817">//&nbsp;adjacent&nbsp;to&nbsp;the&nbsp;variable&nbsp;so&nbsp;we&nbsp;can&nbsp;push&nbsp;it&nbsp;back&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3503885">tokenAfterVariable</span>&nbsp;<span class="op" id="3503904">:=</span>&nbsp;<span class="ident" id="3503907">t</span><span class="op" id="3503908">.</span><span class="ident" id="3503909">peek</span><span class="op" id="3503913">(</span><span class="op" id="3503914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3503919">if</span>&nbsp;<span class="ident" id="3503922">next</span>&nbsp;<span class="op" id="3503927">:=</span>&nbsp;<span class="ident" id="3503930">t</span><span class="op" id="3503931">.</span><span class="ident" id="3503932">peekNonSpace</span><span class="op" id="3503944">(</span><span class="op" id="3503945">)</span><span class="op" id="3503946">;</span>&nbsp;<span class="ident" id="3503948">next</span><span class="op" id="3503952">.</span><span class="ident" id="3503953">typ</span>&nbsp;<span class="op" id="3503957">==</span>&nbsp;<span class="ident" id="3503960">itemColonEquals</span>&nbsp;<span class="op" id="3503976">||</span>&nbsp;<span class="op" id="3503979">(</span><span class="ident" id="3503980">next</span><span class="op" id="3503984">.</span><span class="ident" id="3503985">typ</span>&nbsp;<span class="op" id="3503989">==</span>&nbsp;<span class="ident" id="3503992">itemChar</span>&nbsp;<span class="op" id="3504001">&amp;&amp;</span>&nbsp;<span class="ident" id="3504004">next</span><span class="op" id="3504008">.</span><span class="ident" id="3504009">val</span>&nbsp;<span class="op" id="3504013">==</span>&nbsp;<span class="string" id="3504016">&#34;,&#34;</span><span class="op" id="3504019">)</span>&nbsp;<span class="op" id="3504021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504027">t</span><span class="op" id="3504028">.</span><span class="ident" id="3504029">nextNonSpace</span><span class="op" id="3504041">(</span><span class="op" id="3504042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504048">variable</span>&nbsp;<span class="op" id="3504057">:=</span>&nbsp;<span class="ident" id="3504060">t</span><span class="op" id="3504061">.</span><span class="ident" id="3504062">newVariable</span><span class="op" id="3504073">(</span><span class="ident" id="3504074">v</span><span class="op" id="3504075">.</span><span class="ident" id="3504076">pos</span><span class="op" id="3504079">,</span>&nbsp;<span class="ident" id="3504081">v</span><span class="op" id="3504082">.</span><span class="ident" id="3504083">val</span><span class="op" id="3504086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504092">decl</span>&nbsp;<span class="op" id="3504097">=</span>&nbsp;<span class="builtinfunc" id="3504099">append</span><span class="op" id="3504105">(</span><span class="ident" id="3504106">decl</span><span class="op" id="3504110">,</span>&nbsp;<span class="ident" id="3504112">variable</span><span class="op" id="3504120">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504126">t</span><span class="op" id="3504127">.</span><span class="ident" id="3504128">vars</span>&nbsp;<span class="op" id="3504133">=</span>&nbsp;<span class="builtinfunc" id="3504135">append</span><span class="op" id="3504141">(</span><span class="ident" id="3504142">t</span><span class="op" id="3504143">.</span><span class="ident" id="3504144">vars</span><span class="op" id="3504148">,</span>&nbsp;<span class="ident" id="3504150">v</span><span class="op" id="3504151">.</span><span class="ident" id="3504152">val</span><span class="op" id="3504155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504161">if</span>&nbsp;<span class="ident" id="3504164">next</span><span class="op" id="3504168">.</span><span class="ident" id="3504169">typ</span>&nbsp;<span class="op" id="3504173">==</span>&nbsp;<span class="ident" id="3504176">itemChar</span>&nbsp;<span class="op" id="3504185">&amp;&amp;</span>&nbsp;<span class="ident" id="3504188">next</span><span class="op" id="3504192">.</span><span class="ident" id="3504193">val</span>&nbsp;<span class="op" id="3504197">==</span>&nbsp;<span class="string" id="3504200">&#34;,&#34;</span>&nbsp;<span class="op" id="3504204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504211">if</span>&nbsp;<span class="ident" id="3504214">context</span>&nbsp;<span class="op" id="3504222">==</span>&nbsp;<span class="string" id="3504225">&#34;range&#34;</span>&nbsp;<span class="op" id="3504233">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3504236">len</span><span class="op" id="3504239">(</span><span class="ident" id="3504240">decl</span><span class="op" id="3504244">)</span>&nbsp;<span class="op" id="3504246">&lt;</span>&nbsp;<span class="num" id="3504248">2</span>&nbsp;<span class="op" id="3504250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504258">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504272">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504279">t</span><span class="op" id="3504280">.</span><span class="ident" id="3504281">errorf</span><span class="op" id="3504287">(</span><span class="string" id="3504288">&#34;too&nbsp;many&nbsp;declarations&nbsp;in&nbsp;%s&#34;</span><span class="op" id="3504317">,</span>&nbsp;<span class="ident" id="3504319">context</span><span class="op" id="3504326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504337">}</span>&nbsp;<span class="keyword" id="3504339">else</span>&nbsp;<span class="keyword" id="3504344">if</span>&nbsp;<span class="ident" id="3504347">tokenAfterVariable</span><span class="op" id="3504365">.</span><span class="ident" id="3504366">typ</span>&nbsp;<span class="op" id="3504370">==</span>&nbsp;<span class="ident" id="3504373">itemSpace</span>&nbsp;<span class="op" id="3504383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504389">t</span><span class="op" id="3504390">.</span><span class="ident" id="3504391">backup3</span><span class="op" id="3504398">(</span><span class="ident" id="3504399">v</span><span class="op" id="3504400">,</span>&nbsp;<span class="ident" id="3504402">tokenAfterVariable</span><span class="op" id="3504420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504425">}</span>&nbsp;<span class="keyword" id="3504427">else</span>&nbsp;<span class="op" id="3504432">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504438">t</span><span class="op" id="3504439">.</span><span class="ident" id="3504440">backup2</span><span class="op" id="3504447">(</span><span class="ident" id="3504448">v</span><span class="op" id="3504449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504454">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504462">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504469">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504472">pipe</span>&nbsp;<span class="op" id="3504477">=</span>&nbsp;<span class="ident" id="3504479">t</span><span class="op" id="3504480">.</span><span class="ident" id="3504481">newPipeline</span><span class="op" id="3504492">(</span><span class="ident" id="3504493">pos</span><span class="op" id="3504496">,</span>&nbsp;<span class="ident" id="3504498">t</span><span class="op" id="3504499">.</span><span class="ident" id="3504500">lex</span><span class="op" id="3504503">.</span><span class="ident" id="3504504">lineNumber</span><span class="op" id="3504514">(</span><span class="op" id="3504515">)</span><span class="op" id="3504516">,</span>&nbsp;<span class="ident" id="3504518">decl</span><span class="op" id="3504522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504525">for</span>&nbsp;<span class="op" id="3504529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504533">switch</span>&nbsp;<span class="ident" id="3504540">token</span>&nbsp;<span class="op" id="3504546">:=</span>&nbsp;<span class="ident" id="3504549">t</span><span class="op" id="3504550">.</span><span class="ident" id="3504551">nextNonSpace</span><span class="op" id="3504563">(</span><span class="op" id="3504564">)</span><span class="op" id="3504565">;</span>&nbsp;<span class="ident" id="3504567">token</span><span class="op" id="3504572">.</span><span class="ident" id="3504573">typ</span>&nbsp;<span class="op" id="3504577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504581">case</span>&nbsp;<span class="ident" id="3504586">itemRightDelim</span><span class="op" id="3504600">,</span>&nbsp;<span class="ident" id="3504602">itemRightParen</span><span class="op" id="3504616">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504621">if</span>&nbsp;<span class="builtinfunc" id="3504624">len</span><span class="op" id="3504627">(</span><span class="ident" id="3504628">pipe</span><span class="op" id="3504632">.</span><span class="ident" id="3504633">Cmds</span><span class="op" id="3504637">)</span>&nbsp;<span class="op" id="3504639">==</span>&nbsp;<span class="num" id="3504642">0</span>&nbsp;<span class="op" id="3504644">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504650">t</span><span class="op" id="3504651">.</span><span class="ident" id="3504652">errorf</span><span class="op" id="3504658">(</span><span class="string" id="3504659">&#34;missing&nbsp;value&nbsp;for&nbsp;%s&#34;</span><span class="op" id="3504681">,</span>&nbsp;<span class="ident" id="3504683">context</span><span class="op" id="3504690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504700">if</span>&nbsp;<span class="ident" id="3504703">token</span><span class="op" id="3504708">.</span><span class="ident" id="3504709">typ</span>&nbsp;<span class="op" id="3504713">==</span>&nbsp;<span class="ident" id="3504716">itemRightParen</span>&nbsp;<span class="op" id="3504731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504737">t</span><span class="op" id="3504738">.</span><span class="ident" id="3504739">backup</span><span class="op" id="3504745">(</span><span class="op" id="3504746">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3504751">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504756">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504765">case</span>&nbsp;<span class="ident" id="3504770">itemBool</span><span class="op" id="3504778">,</span>&nbsp;<span class="ident" id="3504780">itemCharConstant</span><span class="op" id="3504796">,</span>&nbsp;<span class="ident" id="3504798">itemComplex</span><span class="op" id="3504809">,</span>&nbsp;<span class="ident" id="3504811">itemDot</span><span class="op" id="3504818">,</span>&nbsp;<span class="ident" id="3504820">itemField</span><span class="op" id="3504829">,</span>&nbsp;<span class="ident" id="3504831">itemIdentifier</span><span class="op" id="3504845">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504850">itemNumber</span><span class="op" id="3504860">,</span>&nbsp;<span class="ident" id="3504862">itemNil</span><span class="op" id="3504869">,</span>&nbsp;<span class="ident" id="3504871">itemRawString</span><span class="op" id="3504884">,</span>&nbsp;<span class="ident" id="3504886">itemString</span><span class="op" id="3504896">,</span>&nbsp;<span class="ident" id="3504898">itemVariable</span><span class="op" id="3504910">,</span>&nbsp;<span class="ident" id="3504912">itemLeftParen</span><span class="op" id="3504925">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504930">t</span><span class="op" id="3504931">.</span><span class="ident" id="3504932">backup</span><span class="op" id="3504938">(</span><span class="op" id="3504939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504944">pipe</span><span class="op" id="3504948">.</span><span class="builtinfunc" id="3504949">append</span><span class="op" id="3504955">(</span><span class="ident" id="3504956">t</span><span class="op" id="3504957">.</span><span class="ident" id="3504958">command</span><span class="op" id="3504965">(</span><span class="op" id="3504966">)</span><span class="op" id="3504967">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3504971">default</span><span class="op" id="3504978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3504983">t</span><span class="op" id="3504984">.</span><span class="ident" id="3504985">unexpected</span><span class="op" id="3504995">(</span><span class="ident" id="3504996">token</span><span class="op" id="3505001">,</span>&nbsp;<span class="ident" id="3505003">context</span><span class="op" id="3505010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3505014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3505017">}</span><br>
<span class="lineno"></span><span class="op" id="3505019">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="3505022">func</span>&nbsp;<span class="op" id="3505027">(</span><span class="ident" id="3505028">t</span>&nbsp;<span class="op" id="3505030">*</span><span class="ident" id="3505031">Tree</span><span class="op" id="3505035">)</span>&nbsp;<span class="ident" id="3505037">parseControl</span><span class="op" id="3505049">(</span><span class="ident" id="3505050">allowElseIf</span>&nbsp;<span class="builtintype" id="3505062">bool</span><span class="op" id="3505066">,</span>&nbsp;<span class="ident" id="3505068">context</span>&nbsp;<span class="builtintype" id="3505076">string</span><span class="op" id="3505082">)</span>&nbsp;<span class="op" id="3505084">(</span><span class="ident" id="3505085">pos</span>&nbsp;<span class="ident" id="3505089">Pos</span><span class="op" id="3505092">,</span>&nbsp;<span class="ident" id="3505094">line</span>&nbsp;<span class="builtintype" id="3505099">int</span><span class="op" id="3505102">,</span>&nbsp;<span class="ident" id="3505104">pipe</span>&nbsp;<span class="op" id="3505109">*</span><span class="ident" id="3505110">PipeNode</span><span class="op" id="3505118">,</span>&nbsp;<span class="ident" id="3505120">list</span><span class="op" id="3505124">,</span>&nbsp;<span class="ident" id="3505126">elseList</span>&nbsp;<span class="op" id="3505135">*</span><span class="ident" id="3505136">ListNode</span><span class="op" id="3505144">)</span>&nbsp;<span class="op" id="3505146">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505149">defer</span>&nbsp;<span class="ident" id="3505155">t</span><span class="op" id="3505156">.</span><span class="ident" id="3505157">popVars</span><span class="op" id="3505164">(</span><span class="builtinfunc" id="3505165">len</span><span class="op" id="3505168">(</span><span class="ident" id="3505169">t</span><span class="op" id="3505170">.</span><span class="ident" id="3505171">vars</span><span class="op" id="3505175">)</span><span class="op" id="3505176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505179">line</span>&nbsp;<span class="op" id="3505184">=</span>&nbsp;<span class="ident" id="3505186">t</span><span class="op" id="3505187">.</span><span class="ident" id="3505188">lex</span><span class="op" id="3505191">.</span><span class="ident" id="3505192">lineNumber</span><span class="op" id="3505202">(</span><span class="op" id="3505203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505206">pipe</span>&nbsp;<span class="op" id="3505211">=</span>&nbsp;<span class="ident" id="3505213">t</span><span class="op" id="3505214">.</span><span class="ident" id="3505215">pipeline</span><span class="op" id="3505223">(</span><span class="ident" id="3505224">context</span><span class="op" id="3505231">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505234">var</span>&nbsp;<span class="ident" id="3505238">next</span>&nbsp;<span class="ident" id="3505243">Node</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505249">list</span><span class="op" id="3505253">,</span>&nbsp;<span class="ident" id="3505255">next</span>&nbsp;<span class="op" id="3505260">=</span>&nbsp;<span class="ident" id="3505262">t</span><span class="op" id="3505263">.</span><span class="ident" id="3505264">itemList</span><span class="op" id="3505272">(</span><span class="op" id="3505273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505276">switch</span>&nbsp;<span class="ident" id="3505283">next</span><span class="op" id="3505287">.</span><span class="ident" id="3505288">Type</span><span class="op" id="3505292">(</span><span class="op" id="3505293">)</span>&nbsp;<span class="op" id="3505295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505298">case</span>&nbsp;<span class="ident" id="3505303">nodeEnd</span><span class="op" id="3505310">:</span>&nbsp;<span class="comment" id="3505312">//done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505320">case</span>&nbsp;<span class="ident" id="3505325">nodeElse</span><span class="op" id="3505333">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505337">if</span>&nbsp;<span class="ident" id="3505340">allowElseIf</span>&nbsp;<span class="op" id="3505352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505357">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.&nbsp;If&nbsp;the&nbsp;&#34;else&#34;&nbsp;is&nbsp;followed&nbsp;immediately&nbsp;by&nbsp;an&nbsp;&#34;if&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505441">//&nbsp;the&nbsp;elseControl&nbsp;will&nbsp;have&nbsp;left&nbsp;the&nbsp;&#34;if&#34;&nbsp;token&nbsp;pending.&nbsp;Treat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505508">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else&nbsp;if&nbsp;b}}_{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505545">//&nbsp;as</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505554">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;a}}_{{else}}{{if&nbsp;b}}_{{end}}{{end}}.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505602">//&nbsp;To&nbsp;do&nbsp;this,&nbsp;parse&nbsp;the&nbsp;if&nbsp;as&nbsp;usual&nbsp;and&nbsp;stop&nbsp;at&nbsp;it&nbsp;{{end}};&nbsp;the&nbsp;subsequent{{end}}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505688">//&nbsp;is&nbsp;assumed.&nbsp;This&nbsp;technique&nbsp;works&nbsp;even&nbsp;for&nbsp;long&nbsp;if-else-if&nbsp;chains.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505760">//&nbsp;TODO:&nbsp;Should&nbsp;we&nbsp;allow&nbsp;else-if&nbsp;in&nbsp;with&nbsp;and&nbsp;range?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3505815">if</span>&nbsp;<span class="ident" id="3505818">t</span><span class="op" id="3505819">.</span><span class="ident" id="3505820">peek</span><span class="op" id="3505824">(</span><span class="op" id="3505825">)</span><span class="op" id="3505826">.</span><span class="ident" id="3505827">typ</span>&nbsp;<span class="op" id="3505831">==</span>&nbsp;<span class="ident" id="3505834">itemIf</span>&nbsp;<span class="op" id="3505841">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505847">t</span><span class="op" id="3505848">.</span><span class="ident" id="3505849">next</span><span class="op" id="3505853">(</span><span class="op" id="3505854">)</span>&nbsp;<span class="comment" id="3505856">//&nbsp;Consume&nbsp;the&nbsp;&#34;if&#34;&nbsp;token.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505887">elseList</span>&nbsp;<span class="op" id="3505896">=</span>&nbsp;<span class="ident" id="3505898">t</span><span class="op" id="3505899">.</span><span class="ident" id="3505900">newList</span><span class="op" id="3505907">(</span><span class="ident" id="3505908">next</span><span class="op" id="3505912">.</span><span class="ident" id="3505913">Position</span><span class="op" id="3505921">(</span><span class="op" id="3505922">)</span><span class="op" id="3505923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3505929">elseList</span><span class="op" id="3505937">.</span><span class="builtinfunc" id="3505938">append</span><span class="op" id="3505944">(</span><span class="ident" id="3505945">t</span><span class="op" id="3505946">.</span><span class="ident" id="3505947">ifControl</span><span class="op" id="3505956">(</span><span class="op" id="3505957">)</span><span class="op" id="3505958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3505964">//&nbsp;Do&nbsp;not&nbsp;consume&nbsp;the&nbsp;next&nbsp;item&nbsp;-&nbsp;only&nbsp;one&nbsp;{{end}}&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506029">break</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3506038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3506042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506046">elseList</span><span class="op" id="3506054">,</span>&nbsp;<span class="ident" id="3506056">next</span>&nbsp;<span class="op" id="3506061">=</span>&nbsp;<span class="ident" id="3506063">t</span><span class="op" id="3506064">.</span><span class="ident" id="3506065">itemList</span><span class="op" id="3506073">(</span><span class="op" id="3506074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506078">if</span>&nbsp;<span class="ident" id="3506081">next</span><span class="op" id="3506085">.</span><span class="ident" id="3506086">Type</span><span class="op" id="3506090">(</span><span class="op" id="3506091">)</span>&nbsp;<span class="op" id="3506093">!=</span>&nbsp;<span class="ident" id="3506096">nodeEnd</span>&nbsp;<span class="op" id="3506104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3506109">t</span><span class="op" id="3506110">.</span><span class="ident" id="3506111">errorf</span><span class="op" id="3506117">(</span><span class="string" id="3506118">&#34;expected&nbsp;end;&nbsp;found&nbsp;%s&#34;</span><span class="op" id="3506142">,</span>&nbsp;<span class="ident" id="3506144">next</span><span class="op" id="3506148">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3506152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3506155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506158">return</span>&nbsp;<span class="ident" id="3506165">pipe</span><span class="op" id="3506169">.</span><span class="ident" id="3506170">Position</span><span class="op" id="3506178">(</span><span class="op" id="3506179">)</span><span class="op" id="3506180">,</span>&nbsp;<span class="ident" id="3506182">line</span><span class="op" id="3506186">,</span>&nbsp;<span class="ident" id="3506188">pipe</span><span class="op" id="3506192">,</span>&nbsp;<span class="ident" id="3506194">list</span><span class="op" id="3506198">,</span>&nbsp;<span class="ident" id="3506200">elseList</span><br>
<span class="lineno"></span><span class="op" id="3506209">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span><span class="comment" id="3506212">//&nbsp;If:</span><br>
<span class="lineno"></span><span class="comment" id="3506219">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506255">//&nbsp;&nbsp;&nbsp;&nbsp{{if&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506309">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3506332">func</span>&nbsp;<span class="op" id="3506337">(</span><span class="ident" id="3506338">t</span>&nbsp;<span class="op" id="3506340">*</span><span class="ident" id="3506341">Tree</span><span class="op" id="3506345">)</span>&nbsp;<span class="ident" id="3506347">ifControl</span><span class="op" id="3506356">(</span><span class="op" id="3506357">)</span>&nbsp;<span class="ident" id="3506359">Node</span>&nbsp;<span class="op" id="3506364">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506367">return</span>&nbsp;<span class="ident" id="3506374">t</span><span class="op" id="3506375">.</span><span class="ident" id="3506376">newIf</span><span class="op" id="3506381">(</span><span class="ident" id="3506382">t</span><span class="op" id="3506383">.</span><span class="ident" id="3506384">parseControl</span><span class="op" id="3506396">(</span><span class="builtintype" id="3506397">true</span><span class="op" id="3506401">,</span>&nbsp;<span class="string" id="3506403">&#34;if&#34;</span><span class="op" id="3506407">)</span><span class="op" id="3506408">)</span><br>
<span class="lineno"></span><span class="op" id="3506410">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506413">//&nbsp;Range:</span><br>
<span class="lineno"></span><span class="comment" id="3506423">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno">475</span><span class="comment" id="3506462">//&nbsp;&nbsp;&nbsp;&nbsp{{range&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506519">//&nbsp;Range&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3506545">func</span>&nbsp;<span class="op" id="3506550">(</span><span class="ident" id="3506551">t</span>&nbsp;<span class="op" id="3506553">*</span><span class="ident" id="3506554">Tree</span><span class="op" id="3506558">)</span>&nbsp;<span class="ident" id="3506560">rangeControl</span><span class="op" id="3506572">(</span><span class="op" id="3506573">)</span>&nbsp;<span class="ident" id="3506575">Node</span>&nbsp;<span class="op" id="3506580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506583">return</span>&nbsp;<span class="ident" id="3506590">t</span><span class="op" id="3506591">.</span><span class="ident" id="3506592">newRange</span><span class="op" id="3506600">(</span><span class="ident" id="3506601">t</span><span class="op" id="3506602">.</span><span class="ident" id="3506603">parseControl</span><span class="op" id="3506615">(</span><span class="builtintype" id="3506616">false</span><span class="op" id="3506621">,</span>&nbsp;<span class="string" id="3506623">&#34;range&#34;</span><span class="op" id="3506630">)</span><span class="op" id="3506631">)</span><br>
<span class="lineno"></span><span class="op" id="3506633">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="3506636">//&nbsp;With:</span><br>
<span class="lineno"></span><span class="comment" id="3506645">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506683">//&nbsp;&nbsp;&nbsp;&nbsp{{with&nbsp;pipeline}}&nbsp;itemList&nbsp;{{else}}&nbsp;itemList&nbsp;{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506739">//&nbsp;If&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno">485</span><span class="keyword" id="3506762">func</span>&nbsp;<span class="op" id="3506767">(</span><span class="ident" id="3506768">t</span>&nbsp;<span class="op" id="3506770">*</span><span class="ident" id="3506771">Tree</span><span class="op" id="3506775">)</span>&nbsp;<span class="ident" id="3506777">withControl</span><span class="op" id="3506788">(</span><span class="op" id="3506789">)</span>&nbsp;<span class="ident" id="3506791">Node</span>&nbsp;<span class="op" id="3506796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506799">return</span>&nbsp;<span class="ident" id="3506806">t</span><span class="op" id="3506807">.</span><span class="ident" id="3506808">newWith</span><span class="op" id="3506815">(</span><span class="ident" id="3506816">t</span><span class="op" id="3506817">.</span><span class="ident" id="3506818">parseControl</span><span class="op" id="3506830">(</span><span class="builtintype" id="3506831">false</span><span class="op" id="3506836">,</span>&nbsp;<span class="string" id="3506838">&#34;with&#34;</span><span class="op" id="3506844">)</span><span class="op" id="3506845">)</span><br>
<span class="lineno"></span><span class="op" id="3506847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3506850">//&nbsp;End:</span><br>
<span class="lineno">490</span><span class="comment" id="3506858">//&nbsp;&nbsp;&nbsp;&nbsp{{end}}</span><br>
<span class="lineno"></span><span class="comment" id="3506869">//&nbsp;End&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3506893">func</span>&nbsp;<span class="op" id="3506898">(</span><span class="ident" id="3506899">t</span>&nbsp;<span class="op" id="3506901">*</span><span class="ident" id="3506902">Tree</span><span class="op" id="3506906">)</span>&nbsp;<span class="ident" id="3506908">endControl</span><span class="op" id="3506918">(</span><span class="op" id="3506919">)</span>&nbsp;<span class="ident" id="3506921">Node</span>&nbsp;<span class="op" id="3506926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3506929">return</span>&nbsp;<span class="ident" id="3506936">t</span><span class="op" id="3506937">.</span><span class="ident" id="3506938">newEnd</span><span class="op" id="3506944">(</span><span class="ident" id="3506945">t</span><span class="op" id="3506946">.</span><span class="ident" id="3506947">expect</span><span class="op" id="3506953">(</span><span class="ident" id="3506954">itemRightDelim</span><span class="op" id="3506968">,</span>&nbsp;<span class="string" id="3506970">&#34;end&#34;</span><span class="op" id="3506975">)</span><span class="op" id="3506976">.</span><span class="ident" id="3506977">pos</span><span class="op" id="3506980">)</span><br>
<span class="lineno"></span><span class="op" id="3506982">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span><span class="comment" id="3506985">//&nbsp;Else:</span><br>
<span class="lineno"></span><span class="comment" id="3506994">//&nbsp;&nbsp;&nbsp;&nbsp{{else}}</span><br>
<span class="lineno"></span><span class="comment" id="3507006">//&nbsp;Else&nbsp;keyword&nbsp;is&nbsp;past.</span><br>
<span class="lineno"></span><span class="keyword" id="3507031">func</span>&nbsp;<span class="op" id="3507036">(</span><span class="ident" id="3507037">t</span>&nbsp;<span class="op" id="3507039">*</span><span class="ident" id="3507040">Tree</span><span class="op" id="3507044">)</span>&nbsp;<span class="ident" id="3507046">elseControl</span><span class="op" id="3507057">(</span><span class="op" id="3507058">)</span>&nbsp;<span class="ident" id="3507060">Node</span>&nbsp;<span class="op" id="3507065">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507068">//&nbsp;Special&nbsp;case&nbsp;for&nbsp;&#34;else&nbsp;if&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507100">peek</span>&nbsp;<span class="op" id="3507105">:=</span>&nbsp;<span class="ident" id="3507108">t</span><span class="op" id="3507109">.</span><span class="ident" id="3507110">peekNonSpace</span><span class="op" id="3507122">(</span><span class="op" id="3507123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507126">if</span>&nbsp;<span class="ident" id="3507129">peek</span><span class="op" id="3507133">.</span><span class="ident" id="3507134">typ</span>&nbsp;<span class="op" id="3507138">==</span>&nbsp;<span class="ident" id="3507141">itemIf</span>&nbsp;<span class="op" id="3507148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507152">//&nbsp;We&nbsp;see&nbsp;&#34;{{else&nbsp;if&nbsp;...&nbsp;&#34;&nbsp;but&nbsp;in&nbsp;effect&nbsp;rewrite&nbsp;it&nbsp;to&nbsp;{{else}}{{if&nbsp;...&nbsp;&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507229">return</span>&nbsp;<span class="ident" id="3507236">t</span><span class="op" id="3507237">.</span><span class="ident" id="3507238">newElse</span><span class="op" id="3507245">(</span><span class="ident" id="3507246">peek</span><span class="op" id="3507250">.</span><span class="ident" id="3507251">pos</span><span class="op" id="3507254">,</span>&nbsp;<span class="ident" id="3507256">t</span><span class="op" id="3507257">.</span><span class="ident" id="3507258">lex</span><span class="op" id="3507261">.</span><span class="ident" id="3507262">lineNumber</span><span class="op" id="3507272">(</span><span class="op" id="3507273">)</span><span class="op" id="3507274">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507280">return</span>&nbsp;<span class="ident" id="3507287">t</span><span class="op" id="3507288">.</span><span class="ident" id="3507289">newElse</span><span class="op" id="3507296">(</span><span class="ident" id="3507297">t</span><span class="op" id="3507298">.</span><span class="ident" id="3507299">expect</span><span class="op" id="3507305">(</span><span class="ident" id="3507306">itemRightDelim</span><span class="op" id="3507320">,</span>&nbsp;<span class="string" id="3507322">&#34;else&#34;</span><span class="op" id="3507328">)</span><span class="op" id="3507329">.</span><span class="ident" id="3507330">pos</span><span class="op" id="3507333">,</span>&nbsp;<span class="ident" id="3507335">t</span><span class="op" id="3507336">.</span><span class="ident" id="3507337">lex</span><span class="op" id="3507340">.</span><span class="ident" id="3507341">lineNumber</span><span class="op" id="3507351">(</span><span class="op" id="3507352">)</span><span class="op" id="3507353">)</span><br>
<span class="lineno"></span><span class="op" id="3507355">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3507358">//&nbsp;Template:</span><br>
<span class="lineno">510</span><span class="comment" id="3507371">//&nbsp;&nbsp;&nbsp;&nbsp{{template&nbsp;stringValue&nbsp;pipeline}}</span><br>
<span class="lineno"></span><span class="comment" id="3507408">//&nbsp;Template&nbsp;keyword&nbsp;is&nbsp;past.&nbsp;&nbsp;The&nbsp;name&nbsp;must&nbsp;be&nbsp;something&nbsp;that&nbsp;can&nbsp;evaluate</span><br>
<span class="lineno"></span><span class="comment" id="3507483">//&nbsp;to&nbsp;a&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3507499">func</span>&nbsp;<span class="op" id="3507504">(</span><span class="ident" id="3507505">t</span>&nbsp;<span class="op" id="3507507">*</span><span class="ident" id="3507508">Tree</span><span class="op" id="3507512">)</span>&nbsp;<span class="ident" id="3507514">templateControl</span><span class="op" id="3507529">(</span><span class="op" id="3507530">)</span>&nbsp;<span class="ident" id="3507532">Node</span>&nbsp;<span class="op" id="3507537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507540">var</span>&nbsp;<span class="ident" id="3507544">name</span>&nbsp;<span class="builtintype" id="3507549">string</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507557">token</span>&nbsp;<span class="op" id="3507563">:=</span>&nbsp;<span class="ident" id="3507566">t</span><span class="op" id="3507567">.</span><span class="ident" id="3507568">nextNonSpace</span><span class="op" id="3507580">(</span><span class="op" id="3507581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507584">switch</span>&nbsp;<span class="ident" id="3507591">token</span><span class="op" id="3507596">.</span><span class="ident" id="3507597">typ</span>&nbsp;<span class="op" id="3507601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507604">case</span>&nbsp;<span class="ident" id="3507609">itemString</span><span class="op" id="3507619">,</span>&nbsp;<span class="ident" id="3507621">itemRawString</span><span class="op" id="3507634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507638">s</span><span class="op" id="3507639">,</span>&nbsp;<span class="ident" id="3507641">err</span>&nbsp;<span class="op" id="3507645">:=</span>&nbsp;<span class="ident" id="3507648">strconv</span><span class="op" id="3507655">.</span><span class="ident" id="3507656">Unquote</span><span class="op" id="3507663">(</span><span class="ident" id="3507664">token</span><span class="op" id="3507669">.</span><span class="ident" id="3507670">val</span><span class="op" id="3507673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507677">if</span>&nbsp;<span class="ident" id="3507680">err</span>&nbsp;<span class="op" id="3507684">!=</span>&nbsp;<span class="ident" id="3507687">nil</span>&nbsp;<span class="op" id="3507691">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507696">t</span><span class="op" id="3507697">.</span><span class="builtintype" id="3507698">error</span><span class="op" id="3507703">(</span><span class="ident" id="3507704">err</span><span class="op" id="3507707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507715">name</span>&nbsp;<span class="op" id="3507720">=</span>&nbsp;<span class="ident" id="3507722">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507725">default</span><span class="op" id="3507732">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507736">t</span><span class="op" id="3507737">.</span><span class="ident" id="3507738">unexpected</span><span class="op" id="3507748">(</span><span class="ident" id="3507749">token</span><span class="op" id="3507754">,</span>&nbsp;<span class="string" id="3507756">&#34;template&nbsp;invocation&#34;</span><span class="op" id="3507777">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507783">var</span>&nbsp;<span class="ident" id="3507787">pipe</span>&nbsp;<span class="op" id="3507792">*</span><span class="ident" id="3507793">PipeNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507803">if</span>&nbsp;<span class="ident" id="3507806">t</span><span class="op" id="3507807">.</span><span class="ident" id="3507808">nextNonSpace</span><span class="op" id="3507820">(</span><span class="op" id="3507821">)</span><span class="op" id="3507822">.</span><span class="ident" id="3507823">typ</span>&nbsp;<span class="op" id="3507827">!=</span>&nbsp;<span class="ident" id="3507830">itemRightDelim</span>&nbsp;<span class="op" id="3507845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507849">t</span><span class="op" id="3507850">.</span><span class="ident" id="3507851">backup</span><span class="op" id="3507857">(</span><span class="op" id="3507858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3507862">//&nbsp;Do&nbsp;not&nbsp;pop&nbsp;variables;&nbsp;they&nbsp;persist&nbsp;until&nbsp;&#34;end&#34;.</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3507915">pipe</span>&nbsp;<span class="op" id="3507920">=</span>&nbsp;<span class="ident" id="3507922">t</span><span class="op" id="3507923">.</span><span class="ident" id="3507924">pipeline</span><span class="op" id="3507932">(</span><span class="string" id="3507933">&#34;template&#34;</span><span class="op" id="3507943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3507946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3507949">return</span>&nbsp;<span class="ident" id="3507956">t</span><span class="op" id="3507957">.</span><span class="ident" id="3507958">newTemplate</span><span class="op" id="3507969">(</span><span class="ident" id="3507970">token</span><span class="op" id="3507975">.</span><span class="ident" id="3507976">pos</span><span class="op" id="3507979">,</span>&nbsp;<span class="ident" id="3507981">t</span><span class="op" id="3507982">.</span><span class="ident" id="3507983">lex</span><span class="op" id="3507986">.</span><span class="ident" id="3507987">lineNumber</span><span class="op" id="3507997">(</span><span class="op" id="3507998">)</span><span class="op" id="3507999">,</span>&nbsp;<span class="ident" id="3508001">name</span><span class="op" id="3508005">,</span>&nbsp;<span class="ident" id="3508007">pipe</span><span class="op" id="3508011">)</span><br>
<span class="lineno"></span><span class="op" id="3508013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment" id="3508016">//&nbsp;command:</span><br>
<span class="lineno"></span><span class="comment" id="3508028">//&nbsp;&nbsp;&nbsp;&nbspoperand&nbsp;(space&nbsp;operand)*</span><br>
<span class="lineno"></span><span class="comment" id="3508056">//&nbsp;space-separated&nbsp;arguments&nbsp;up&nbsp;to&nbsp;a&nbsp;pipeline&nbsp;character&nbsp;or&nbsp;right&nbsp;delimiter.</span><br>
<span class="lineno"></span><span class="comment" id="3508132">//&nbsp;we&nbsp;consume&nbsp;the&nbsp;pipe&nbsp;character&nbsp;but&nbsp;leave&nbsp;the&nbsp;right&nbsp;delim&nbsp;to&nbsp;terminate&nbsp;the&nbsp;action.</span><br>
<span class="lineno"></span><span class="keyword" id="3508216">func</span>&nbsp;<span class="op" id="3508221">(</span><span class="ident" id="3508222">t</span>&nbsp;<span class="op" id="3508224">*</span><span class="ident" id="3508225">Tree</span><span class="op" id="3508229">)</span>&nbsp;<span class="ident" id="3508231">command</span><span class="op" id="3508238">(</span><span class="op" id="3508239">)</span>&nbsp;<span class="op" id="3508241">*</span><span class="ident" id="3508242">CommandNode</span>&nbsp;<span class="op" id="3508254">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508257">cmd</span>&nbsp;<span class="op" id="3508261">:=</span>&nbsp;<span class="ident" id="3508264">t</span><span class="op" id="3508265">.</span><span class="ident" id="3508266">newCommand</span><span class="op" id="3508276">(</span><span class="ident" id="3508277">t</span><span class="op" id="3508278">.</span><span class="ident" id="3508279">peekNonSpace</span><span class="op" id="3508291">(</span><span class="op" id="3508292">)</span><span class="op" id="3508293">.</span><span class="ident" id="3508294">pos</span><span class="op" id="3508297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508300">for</span>&nbsp;<span class="op" id="3508304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508308">t</span><span class="op" id="3508309">.</span><span class="ident" id="3508310">peekNonSpace</span><span class="op" id="3508322">(</span><span class="op" id="3508323">)</span>&nbsp;<span class="comment" id="3508325">//&nbsp;skip&nbsp;leading&nbsp;spaces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508351">operand</span>&nbsp;<span class="op" id="3508359">:=</span>&nbsp;<span class="ident" id="3508362">t</span><span class="op" id="3508363">.</span><span class="ident" id="3508364">operand</span><span class="op" id="3508371">(</span><span class="op" id="3508372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508376">if</span>&nbsp;<span class="ident" id="3508379">operand</span>&nbsp;<span class="op" id="3508387">!=</span>&nbsp;<span class="ident" id="3508390">nil</span>&nbsp;<span class="op" id="3508394">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508399">cmd</span><span class="op" id="3508402">.</span><span class="builtinfunc" id="3508403">append</span><span class="op" id="3508409">(</span><span class="ident" id="3508410">operand</span><span class="op" id="3508417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508425">switch</span>&nbsp;<span class="ident" id="3508432">token</span>&nbsp;<span class="op" id="3508438">:=</span>&nbsp;<span class="ident" id="3508441">t</span><span class="op" id="3508442">.</span><span class="ident" id="3508443">next</span><span class="op" id="3508447">(</span><span class="op" id="3508448">)</span><span class="op" id="3508449">;</span>&nbsp;<span class="ident" id="3508451">token</span><span class="op" id="3508456">.</span><span class="ident" id="3508457">typ</span>&nbsp;<span class="op" id="3508461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508465">case</span>&nbsp;<span class="ident" id="3508470">itemSpace</span><span class="op" id="3508479">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508484">continue</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508495">case</span>&nbsp;<span class="ident" id="3508500">itemError</span><span class="op" id="3508509">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508514">t</span><span class="op" id="3508515">.</span><span class="ident" id="3508516">errorf</span><span class="op" id="3508522">(</span><span class="string" id="3508523">&#34;%s&#34;</span><span class="op" id="3508527">,</span>&nbsp;<span class="ident" id="3508529">token</span><span class="op" id="3508534">.</span><span class="ident" id="3508535">val</span><span class="op" id="3508538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508542">case</span>&nbsp;<span class="ident" id="3508547">itemRightDelim</span><span class="op" id="3508561">,</span>&nbsp;<span class="ident" id="3508563">itemRightParen</span><span class="op" id="3508577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508582">t</span><span class="op" id="3508583">.</span><span class="ident" id="3508584">backup</span><span class="op" id="3508590">(</span><span class="op" id="3508591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508595">case</span>&nbsp;<span class="ident" id="3508600">itemPipe</span><span class="op" id="3508608">:</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508612">default</span><span class="op" id="3508619">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508624">t</span><span class="op" id="3508625">.</span><span class="ident" id="3508626">errorf</span><span class="op" id="3508632">(</span><span class="string" id="3508633">&#34;unexpected&nbsp;%s&nbsp;in&nbsp;operand;&nbsp;missing&nbsp;space?&#34;</span><span class="op" id="3508675">,</span>&nbsp;<span class="ident" id="3508677">token</span><span class="op" id="3508682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508690">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508697">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508700">if</span>&nbsp;<span class="builtinfunc" id="3508703">len</span><span class="op" id="3508706">(</span><span class="ident" id="3508707">cmd</span><span class="op" id="3508710">.</span><span class="ident" id="3508711">Args</span><span class="op" id="3508715">)</span>&nbsp;<span class="op" id="3508717">==</span>&nbsp;<span class="num" id="3508720">0</span>&nbsp;<span class="op" id="3508722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508726">t</span><span class="op" id="3508727">.</span><span class="ident" id="3508728">errorf</span><span class="op" id="3508734">(</span><span class="string" id="3508735">&#34;empty&nbsp;command&#34;</span><span class="op" id="3508750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3508753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3508756">return</span>&nbsp;<span class="ident" id="3508763">cmd</span><br>
<span class="lineno"></span><span class="op" id="3508767">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span><span class="comment" id="3508770">//&nbsp;operand:</span><br>
<span class="lineno"></span><span class="comment" id="3508782">//&nbsp;&nbsp;&nbsp;&nbspterm&nbsp;.Field*</span><br>
<span class="lineno"></span><span class="comment" id="3508798">//&nbsp;An&nbsp;operand&nbsp;is&nbsp;a&nbsp;space-separated&nbsp;component&nbsp;of&nbsp;a&nbsp;command,</span><br>
<span class="lineno"></span><span class="comment" id="3508857">//&nbsp;a&nbsp;term&nbsp;possibly&nbsp;followed&nbsp;by&nbsp;field&nbsp;accesses.</span><br>
<span class="lineno">570</span><span class="comment" id="3508904">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;an&nbsp;operand.</span><br>
<span class="lineno"></span><span class="keyword" id="3508959">func</span>&nbsp;<span class="op" id="3508964">(</span><span class="ident" id="3508965">t</span>&nbsp;<span class="op" id="3508967">*</span><span class="ident" id="3508968">Tree</span><span class="op" id="3508972">)</span>&nbsp;<span class="ident" id="3508974">operand</span><span class="op" id="3508981">(</span><span class="op" id="3508982">)</span>&nbsp;<span class="ident" id="3508984">Node</span>&nbsp;<span class="op" id="3508989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3508992">node</span>&nbsp;<span class="op" id="3508997">:=</span>&nbsp;<span class="ident" id="3509000">t</span><span class="op" id="3509001">.</span><span class="ident" id="3509002">term</span><span class="op" id="3509006">(</span><span class="op" id="3509007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509010">if</span>&nbsp;<span class="ident" id="3509013">node</span>&nbsp;<span class="op" id="3509018">==</span>&nbsp;<span class="ident" id="3509021">nil</span>&nbsp;<span class="op" id="3509025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509029">return</span>&nbsp;<span class="ident" id="3509036">nil</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509044">if</span>&nbsp;<span class="ident" id="3509047">t</span><span class="op" id="3509048">.</span><span class="ident" id="3509049">peek</span><span class="op" id="3509053">(</span><span class="op" id="3509054">)</span><span class="op" id="3509055">.</span><span class="ident" id="3509056">typ</span>&nbsp;<span class="op" id="3509060">==</span>&nbsp;<span class="ident" id="3509063">itemField</span>&nbsp;<span class="op" id="3509073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509077">chain</span>&nbsp;<span class="op" id="3509083">:=</span>&nbsp;<span class="ident" id="3509086">t</span><span class="op" id="3509087">.</span><span class="ident" id="3509088">newChain</span><span class="op" id="3509096">(</span><span class="ident" id="3509097">t</span><span class="op" id="3509098">.</span><span class="ident" id="3509099">peek</span><span class="op" id="3509103">(</span><span class="op" id="3509104">)</span><span class="op" id="3509105">.</span><span class="ident" id="3509106">pos</span><span class="op" id="3509109">,</span>&nbsp;<span class="ident" id="3509111">node</span><span class="op" id="3509115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509119">for</span>&nbsp;<span class="ident" id="3509123">t</span><span class="op" id="3509124">.</span><span class="ident" id="3509125">peek</span><span class="op" id="3509129">(</span><span class="op" id="3509130">)</span><span class="op" id="3509131">.</span><span class="ident" id="3509132">typ</span>&nbsp;<span class="op" id="3509136">==</span>&nbsp;<span class="ident" id="3509139">itemField</span>&nbsp;<span class="op" id="3509149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509154">chain</span><span class="op" id="3509159">.</span><span class="ident" id="3509160">Add</span><span class="op" id="3509163">(</span><span class="ident" id="3509164">t</span><span class="op" id="3509165">.</span><span class="ident" id="3509166">next</span><span class="op" id="3509170">(</span><span class="op" id="3509171">)</span><span class="op" id="3509172">.</span><span class="ident" id="3509173">val</span><span class="op" id="3509176">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509184">//&nbsp;Compatibility&nbsp;with&nbsp;original&nbsp;API:&nbsp;If&nbsp;the&nbsp;term&nbsp;is&nbsp;of&nbsp;type&nbsp;NodeField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509255">//&nbsp;or&nbsp;NodeVariable,&nbsp;just&nbsp;put&nbsp;more&nbsp;fields&nbsp;on&nbsp;the&nbsp;original.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509315">//&nbsp;Otherwise,&nbsp;keep&nbsp;the&nbsp;Chain&nbsp;node.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3509352">//&nbsp;TODO:&nbsp;Switch&nbsp;to&nbsp;Chains&nbsp;always&nbsp;when&nbsp;we&nbsp;can.</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509400">switch</span>&nbsp;<span class="ident" id="3509407">node</span><span class="op" id="3509411">.</span><span class="ident" id="3509412">Type</span><span class="op" id="3509416">(</span><span class="op" id="3509417">)</span>&nbsp;<span class="op" id="3509419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509423">case</span>&nbsp;<span class="ident" id="3509428">NodeField</span><span class="op" id="3509437">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509442">node</span>&nbsp;<span class="op" id="3509447">=</span>&nbsp;<span class="ident" id="3509449">t</span><span class="op" id="3509450">.</span><span class="ident" id="3509451">newField</span><span class="op" id="3509459">(</span><span class="ident" id="3509460">chain</span><span class="op" id="3509465">.</span><span class="ident" id="3509466">Position</span><span class="op" id="3509474">(</span><span class="op" id="3509475">)</span><span class="op" id="3509476">,</span>&nbsp;<span class="ident" id="3509478">chain</span><span class="op" id="3509483">.</span><span class="ident" id="3509484">String</span><span class="op" id="3509490">(</span><span class="op" id="3509491">)</span><span class="op" id="3509492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509496">case</span>&nbsp;<span class="ident" id="3509501">NodeVariable</span><span class="op" id="3509513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509518">node</span>&nbsp;<span class="op" id="3509523">=</span>&nbsp;<span class="ident" id="3509525">t</span><span class="op" id="3509526">.</span><span class="ident" id="3509527">newVariable</span><span class="op" id="3509538">(</span><span class="ident" id="3509539">chain</span><span class="op" id="3509544">.</span><span class="ident" id="3509545">Position</span><span class="op" id="3509553">(</span><span class="op" id="3509554">)</span><span class="op" id="3509555">,</span>&nbsp;<span class="ident" id="3509557">chain</span><span class="op" id="3509562">.</span><span class="ident" id="3509563">String</span><span class="op" id="3509569">(</span><span class="op" id="3509570">)</span><span class="op" id="3509571">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509575">default</span><span class="op" id="3509582">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509587">node</span>&nbsp;<span class="op" id="3509592">=</span>&nbsp;<span class="ident" id="3509594">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3509605">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509608">return</span>&nbsp;<span class="ident" id="3509615">node</span><br>
<span class="lineno">595</span><span class="op" id="3509620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3509623">//&nbsp;term:</span><br>
<span class="lineno"></span><span class="comment" id="3509632">//&nbsp;&nbsp;&nbsp;&nbspliteral&nbsp;(number,&nbsp;string,&nbsp;nil,&nbsp;boolean)</span><br>
<span class="lineno"></span><span class="comment" id="3509674">//&nbsp;&nbsp;&nbsp;&nbspfunction&nbsp;(identifier)</span><br>
<span class="lineno">600</span><span class="comment" id="3509699">//&nbsp;&nbsp;&nbsp;&nbsp.</span><br>
<span class="lineno"></span><span class="comment" id="3509704">//&nbsp;&nbsp;&nbsp;&nbsp.Field</span><br>
<span class="lineno"></span><span class="comment" id="3509714">//&nbsp;&nbsp;&nbsp;&nbsp$</span><br>
<span class="lineno"></span><span class="comment" id="3509719">//&nbsp;&nbsp;&nbsp;&nbsp&#39;(&#39;&nbsp;pipeline&nbsp;&#39;)&#39;</span><br>
<span class="lineno"></span><span class="comment" id="3509739">//&nbsp;A&nbsp;term&nbsp;is&nbsp;a&nbsp;simple&nbsp;&#34;expression&#34;.</span><br>
<span class="lineno">605</span><span class="comment" id="3509775">//&nbsp;A&nbsp;nil&nbsp;return&nbsp;means&nbsp;the&nbsp;next&nbsp;item&nbsp;is&nbsp;not&nbsp;a&nbsp;term.</span><br>
<span class="lineno"></span><span class="keyword" id="3509826">func</span>&nbsp;<span class="op" id="3509831">(</span><span class="ident" id="3509832">t</span>&nbsp;<span class="op" id="3509834">*</span><span class="ident" id="3509835">Tree</span><span class="op" id="3509839">)</span>&nbsp;<span class="ident" id="3509841">term</span><span class="op" id="3509845">(</span><span class="op" id="3509846">)</span>&nbsp;<span class="ident" id="3509848">Node</span>&nbsp;<span class="op" id="3509853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509856">switch</span>&nbsp;<span class="ident" id="3509863">token</span>&nbsp;<span class="op" id="3509869">:=</span>&nbsp;<span class="ident" id="3509872">t</span><span class="op" id="3509873">.</span><span class="ident" id="3509874">nextNonSpace</span><span class="op" id="3509886">(</span><span class="op" id="3509887">)</span><span class="op" id="3509888">;</span>&nbsp;<span class="ident" id="3509890">token</span><span class="op" id="3509895">.</span><span class="ident" id="3509896">typ</span>&nbsp;<span class="op" id="3509900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509903">case</span>&nbsp;<span class="ident" id="3509908">itemError</span><span class="op" id="3509917">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3509921">t</span><span class="op" id="3509922">.</span><span class="ident" id="3509923">errorf</span><span class="op" id="3509929">(</span><span class="string" id="3509930">&#34;%s&#34;</span><span class="op" id="3509934">,</span>&nbsp;<span class="ident" id="3509936">token</span><span class="op" id="3509941">.</span><span class="ident" id="3509942">val</span><span class="op" id="3509945">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509948">case</span>&nbsp;<span class="ident" id="3509953">itemIdentifier</span><span class="op" id="3509967">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3509971">if</span>&nbsp;<span class="op" id="3509974">!</span><span class="ident" id="3509975">t</span><span class="op" id="3509976">.</span><span class="ident" id="3509977">hasFunction</span><span class="op" id="3509988">(</span><span class="ident" id="3509989">token</span><span class="op" id="3509994">.</span><span class="ident" id="3509995">val</span><span class="op" id="3509998">)</span>&nbsp;<span class="op" id="3510000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510005">t</span><span class="op" id="3510006">.</span><span class="ident" id="3510007">errorf</span><span class="op" id="3510013">(</span><span class="string" id="3510014">&#34;function&nbsp;%q&nbsp;not&nbsp;defined&#34;</span><span class="op" id="3510039">,</span>&nbsp;<span class="ident" id="3510041">token</span><span class="op" id="3510046">.</span><span class="ident" id="3510047">val</span><span class="op" id="3510050">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510054">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510058">return</span>&nbsp;<span class="ident" id="3510065">NewIdentifier</span><span class="op" id="3510078">(</span><span class="ident" id="3510079">token</span><span class="op" id="3510084">.</span><span class="ident" id="3510085">val</span><span class="op" id="3510088">)</span><span class="op" id="3510089">.</span><span class="ident" id="3510090">SetTree</span><span class="op" id="3510097">(</span><span class="ident" id="3510098">t</span><span class="op" id="3510099">)</span><span class="op" id="3510100">.</span><span class="ident" id="3510101">SetPos</span><span class="op" id="3510107">(</span><span class="ident" id="3510108">token</span><span class="op" id="3510113">.</span><span class="ident" id="3510114">pos</span><span class="op" id="3510117">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510120">case</span>&nbsp;<span class="ident" id="3510125">itemDot</span><span class="op" id="3510132">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510136">return</span>&nbsp;<span class="ident" id="3510143">t</span><span class="op" id="3510144">.</span><span class="ident" id="3510145">newDot</span><span class="op" id="3510151">(</span><span class="ident" id="3510152">token</span><span class="op" id="3510157">.</span><span class="ident" id="3510158">pos</span><span class="op" id="3510161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510164">case</span>&nbsp;<span class="ident" id="3510169">itemNil</span><span class="op" id="3510176">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510180">return</span>&nbsp;<span class="ident" id="3510187">t</span><span class="op" id="3510188">.</span><span class="ident" id="3510189">newNil</span><span class="op" id="3510195">(</span><span class="ident" id="3510196">token</span><span class="op" id="3510201">.</span><span class="ident" id="3510202">pos</span><span class="op" id="3510205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510208">case</span>&nbsp;<span class="ident" id="3510213">itemVariable</span><span class="op" id="3510225">:</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510229">return</span>&nbsp;<span class="ident" id="3510236">t</span><span class="op" id="3510237">.</span><span class="ident" id="3510238">useVar</span><span class="op" id="3510244">(</span><span class="ident" id="3510245">token</span><span class="op" id="3510250">.</span><span class="ident" id="3510251">pos</span><span class="op" id="3510254">,</span>&nbsp;<span class="ident" id="3510256">token</span><span class="op" id="3510261">.</span><span class="ident" id="3510262">val</span><span class="op" id="3510265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510268">case</span>&nbsp;<span class="ident" id="3510273">itemField</span><span class="op" id="3510282">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510286">return</span>&nbsp;<span class="ident" id="3510293">t</span><span class="op" id="3510294">.</span><span class="ident" id="3510295">newField</span><span class="op" id="3510303">(</span><span class="ident" id="3510304">token</span><span class="op" id="3510309">.</span><span class="ident" id="3510310">pos</span><span class="op" id="3510313">,</span>&nbsp;<span class="ident" id="3510315">token</span><span class="op" id="3510320">.</span><span class="ident" id="3510321">val</span><span class="op" id="3510324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510327">case</span>&nbsp;<span class="ident" id="3510332">itemBool</span><span class="op" id="3510340">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510344">return</span>&nbsp;<span class="ident" id="3510351">t</span><span class="op" id="3510352">.</span><span class="ident" id="3510353">newBool</span><span class="op" id="3510360">(</span><span class="ident" id="3510361">token</span><span class="op" id="3510366">.</span><span class="ident" id="3510367">pos</span><span class="op" id="3510370">,</span>&nbsp;<span class="ident" id="3510372">token</span><span class="op" id="3510377">.</span><span class="ident" id="3510378">val</span>&nbsp;<span class="op" id="3510382">==</span>&nbsp;<span class="string" id="3510385">&#34;true&#34;</span><span class="op" id="3510391">)</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510394">case</span>&nbsp;<span class="ident" id="3510399">itemCharConstant</span><span class="op" id="3510415">,</span>&nbsp;<span class="ident" id="3510417">itemComplex</span><span class="op" id="3510428">,</span>&nbsp;<span class="ident" id="3510430">itemNumber</span><span class="op" id="3510440">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510444">number</span><span class="op" id="3510450">,</span>&nbsp;<span class="ident" id="3510452">err</span>&nbsp;<span class="op" id="3510456">:=</span>&nbsp;<span class="ident" id="3510459">t</span><span class="op" id="3510460">.</span><span class="ident" id="3510461">newNumber</span><span class="op" id="3510470">(</span><span class="ident" id="3510471">token</span><span class="op" id="3510476">.</span><span class="ident" id="3510477">pos</span><span class="op" id="3510480">,</span>&nbsp;<span class="ident" id="3510482">token</span><span class="op" id="3510487">.</span><span class="ident" id="3510488">val</span><span class="op" id="3510491">,</span>&nbsp;<span class="ident" id="3510493">token</span><span class="op" id="3510498">.</span><span class="ident" id="3510499">typ</span><span class="op" id="3510502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510506">if</span>&nbsp;<span class="ident" id="3510509">err</span>&nbsp;<span class="op" id="3510513">!=</span>&nbsp;<span class="ident" id="3510516">nil</span>&nbsp;<span class="op" id="3510520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510525">t</span><span class="op" id="3510526">.</span><span class="builtintype" id="3510527">error</span><span class="op" id="3510532">(</span><span class="ident" id="3510533">err</span><span class="op" id="3510536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510540">}</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510544">return</span>&nbsp;<span class="ident" id="3510551">number</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510559">case</span>&nbsp;<span class="ident" id="3510564">itemLeftParen</span><span class="op" id="3510577">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510581">pipe</span>&nbsp;<span class="op" id="3510586">:=</span>&nbsp;<span class="ident" id="3510589">t</span><span class="op" id="3510590">.</span><span class="ident" id="3510591">pipeline</span><span class="op" id="3510599">(</span><span class="string" id="3510600">&#34;parenthesized&nbsp;pipeline&#34;</span><span class="op" id="3510624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510628">if</span>&nbsp;<span class="ident" id="3510631">token</span>&nbsp;<span class="op" id="3510637">:=</span>&nbsp;<span class="ident" id="3510640">t</span><span class="op" id="3510641">.</span><span class="ident" id="3510642">next</span><span class="op" id="3510646">(</span><span class="op" id="3510647">)</span><span class="op" id="3510648">;</span>&nbsp;<span class="ident" id="3510650">token</span><span class="op" id="3510655">.</span><span class="ident" id="3510656">typ</span>&nbsp;<span class="op" id="3510660">!=</span>&nbsp;<span class="ident" id="3510663">itemRightParen</span>&nbsp;<span class="op" id="3510678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510683">t</span><span class="op" id="3510684">.</span><span class="ident" id="3510685">errorf</span><span class="op" id="3510691">(</span><span class="string" id="3510692">&#34;unclosed&nbsp;right&nbsp;paren:&nbsp;unexpected&nbsp;%s&#34;</span><span class="op" id="3510729">,</span>&nbsp;<span class="ident" id="3510731">token</span><span class="op" id="3510736">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510744">return</span>&nbsp;<span class="ident" id="3510751">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510757">case</span>&nbsp;<span class="ident" id="3510762">itemString</span><span class="op" id="3510772">,</span>&nbsp;<span class="ident" id="3510774">itemRawString</span><span class="op" id="3510787">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510791">s</span><span class="op" id="3510792">,</span>&nbsp;<span class="ident" id="3510794">err</span>&nbsp;<span class="op" id="3510798">:=</span>&nbsp;<span class="ident" id="3510801">strconv</span><span class="op" id="3510808">.</span><span class="ident" id="3510809">Unquote</span><span class="op" id="3510816">(</span><span class="ident" id="3510817">token</span><span class="op" id="3510822">.</span><span class="ident" id="3510823">val</span><span class="op" id="3510826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510830">if</span>&nbsp;<span class="ident" id="3510833">err</span>&nbsp;<span class="op" id="3510837">!=</span>&nbsp;<span class="ident" id="3510840">nil</span>&nbsp;<span class="op" id="3510844">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510849">t</span><span class="op" id="3510850">.</span><span class="builtintype" id="3510851">error</span><span class="op" id="3510856">(</span><span class="ident" id="3510857">err</span><span class="op" id="3510860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510868">return</span>&nbsp;<span class="ident" id="3510875">t</span><span class="op" id="3510876">.</span><span class="ident" id="3510877">newString</span><span class="op" id="3510886">(</span><span class="ident" id="3510887">token</span><span class="op" id="3510892">.</span><span class="ident" id="3510893">pos</span><span class="op" id="3510896">,</span>&nbsp;<span class="ident" id="3510898">token</span><span class="op" id="3510903">.</span><span class="ident" id="3510904">val</span><span class="op" id="3510907">,</span>&nbsp;<span class="ident" id="3510909">s</span><span class="op" id="3510910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3510913">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3510916">t</span><span class="op" id="3510917">.</span><span class="ident" id="3510918">backup</span><span class="op" id="3510924">(</span><span class="op" id="3510925">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3510928">return</span>&nbsp;<span class="ident" id="3510935">nil</span><br>
<span class="lineno"></span><span class="op" id="3510939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3510942">//&nbsp;hasFunction&nbsp;reports&nbsp;if&nbsp;a&nbsp;function&nbsp;name&nbsp;exists&nbsp;in&nbsp;the&nbsp;Tree&#39;s&nbsp;maps.</span><br>
<span class="lineno"></span><span class="keyword" id="3511011">func</span>&nbsp;<span class="op" id="3511016">(</span><span class="ident" id="3511017">t</span>&nbsp;<span class="op" id="3511019">*</span><span class="ident" id="3511020">Tree</span><span class="op" id="3511024">)</span>&nbsp;<span class="ident" id="3511026">hasFunction</span><span class="op" id="3511037">(</span><span class="ident" id="3511038">name</span>&nbsp;<span class="builtintype" id="3511043">string</span><span class="op" id="3511049">)</span>&nbsp;<span class="builtintype" id="3511051">bool</span>&nbsp;<span class="op" id="3511056">{</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511059">for</span>&nbsp;<span class="ident" id="3511063">_</span><span class="op" id="3511064">,</span>&nbsp;<span class="ident" id="3511066">funcMap</span>&nbsp;<span class="op" id="3511074">:=</span>&nbsp;<span class="keyword" id="3511077">range</span>&nbsp;<span class="ident" id="3511083">t</span><span class="op" id="3511084">.</span><span class="ident" id="3511085">funcs</span>&nbsp;<span class="op" id="3511091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511095">if</span>&nbsp;<span class="ident" id="3511098">funcMap</span>&nbsp;<span class="op" id="3511106">==</span>&nbsp;<span class="ident" id="3511109">nil</span>&nbsp;<span class="op" id="3511113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511118">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511133">if</span>&nbsp;<span class="ident" id="3511136">funcMap</span><span class="op" id="3511143">[</span><span class="ident" id="3511144">name</span><span class="op" id="3511148">]</span>&nbsp;<span class="op" id="3511150">!=</span>&nbsp;<span class="ident" id="3511153">nil</span>&nbsp;<span class="op" id="3511157">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511162">return</span>&nbsp;<span class="builtintype" id="3511169">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511182">return</span>&nbsp;<span class="builtintype" id="3511189">false</span><br>
<span class="lineno"></span><span class="op" id="3511195">}</span><br>
<span class="lineno">660</span><br>
<span class="lineno"></span><span class="comment" id="3511198">//&nbsp;popVars&nbsp;trims&nbsp;the&nbsp;variable&nbsp;list&nbsp;to&nbsp;the&nbsp;specified&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="3511257">func</span>&nbsp;<span class="op" id="3511262">(</span><span class="ident" id="3511263">t</span>&nbsp;<span class="op" id="3511265">*</span><span class="ident" id="3511266">Tree</span><span class="op" id="3511270">)</span>&nbsp;<span class="ident" id="3511272">popVars</span><span class="op" id="3511279">(</span><span class="ident" id="3511280">n</span>&nbsp;<span class="builtintype" id="3511282">int</span><span class="op" id="3511285">)</span>&nbsp;<span class="op" id="3511287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511290">t</span><span class="op" id="3511291">.</span><span class="ident" id="3511292">vars</span>&nbsp;<span class="op" id="3511297">=</span>&nbsp;<span class="ident" id="3511299">t</span><span class="op" id="3511300">.</span><span class="ident" id="3511301">vars</span><span class="op" id="3511305">[</span><span class="op" id="3511306">:</span><span class="ident" id="3511307">n</span><span class="op" id="3511308">]</span><br>
<span class="lineno"></span><span class="op" id="3511310">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3511313">//&nbsp;useVar&nbsp;returns&nbsp;a&nbsp;node&nbsp;for&nbsp;a&nbsp;variable&nbsp;reference.&nbsp;It&nbsp;errors&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3511381">//&nbsp;variable&nbsp;is&nbsp;not&nbsp;defined.</span><br>
<span class="lineno"></span><span class="keyword" id="3511409">func</span>&nbsp;<span class="op" id="3511414">(</span><span class="ident" id="3511415">t</span>&nbsp;<span class="op" id="3511417">*</span><span class="ident" id="3511418">Tree</span><span class="op" id="3511422">)</span>&nbsp;<span class="ident" id="3511424">useVar</span><span class="op" id="3511430">(</span><span class="ident" id="3511431">pos</span>&nbsp;<span class="ident" id="3511435">Pos</span><span class="op" id="3511438">,</span>&nbsp;<span class="ident" id="3511440">name</span>&nbsp;<span class="builtintype" id="3511445">string</span><span class="op" id="3511451">)</span>&nbsp;<span class="ident" id="3511453">Node</span>&nbsp;<span class="op" id="3511458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511461">v</span>&nbsp;<span class="op" id="3511463">:=</span>&nbsp;<span class="ident" id="3511466">t</span><span class="op" id="3511467">.</span><span class="ident" id="3511468">newVariable</span><span class="op" id="3511479">(</span><span class="ident" id="3511480">pos</span><span class="op" id="3511483">,</span>&nbsp;<span class="ident" id="3511485">name</span><span class="op" id="3511489">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511492">for</span>&nbsp;<span class="ident" id="3511496">_</span><span class="op" id="3511497">,</span>&nbsp;<span class="ident" id="3511499">varName</span>&nbsp;<span class="op" id="3511507">:=</span>&nbsp;<span class="keyword" id="3511510">range</span>&nbsp;<span class="ident" id="3511516">t</span><span class="op" id="3511517">.</span><span class="ident" id="3511518">vars</span>&nbsp;<span class="op" id="3511523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511527">if</span>&nbsp;<span class="ident" id="3511530">varName</span>&nbsp;<span class="op" id="3511538">==</span>&nbsp;<span class="ident" id="3511541">v</span><span class="op" id="3511542">.</span><span class="ident" id="3511543">Ident</span><span class="op" id="3511548">[</span><span class="num" id="3511549">0</span><span class="op" id="3511550">]</span>&nbsp;<span class="op" id="3511552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511557">return</span>&nbsp;<span class="ident" id="3511564">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3511571">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3511574">t</span><span class="op" id="3511575">.</span><span class="ident" id="3511576">errorf</span><span class="op" id="3511582">(</span><span class="string" id="3511583">&#34;undefined&nbsp;variable&nbsp;%q&#34;</span><span class="op" id="3511606">,</span>&nbsp;<span class="ident" id="3511608">v</span><span class="op" id="3511609">.</span><span class="ident" id="3511610">Ident</span><span class="op" id="3511615">[</span><span class="num" id="3511616">0</span><span class="op" id="3511617">]</span><span class="op" id="3511618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3511621">return</span>&nbsp;<span class="ident" id="3511628">nil</span><br>
<span class="lineno"></span><span class="op" id="3511632">}</span>
</div>
</body>
</html>
