<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;Package&nbsp;rsa&nbsp;implements&nbsp;RSA&nbsp;encryption&nbsp;as&nbsp;specified&nbsp;in&nbsp;PKCS#1.</span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">rsa</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/rand&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;hash&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math/big&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">bigZero</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">bigOne</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="num">1</span><span class="op">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;PublicKey&nbsp;represents&nbsp;the&nbsp;public&nbsp;part&nbsp;of&nbsp;an&nbsp;RSA&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PublicKey</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">N</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;modulus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">E</span>&nbsp;<span class="builtintype">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;public&nbsp;exponent</span><br>
<span class="lineno">25</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errPublicModulus</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;missing&nbsp;public&nbsp;modulus&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errPublicExponentSmall</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;public&nbsp;exponent&nbsp;too&nbsp;small&#34;</span><span class="op">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">errPublicExponentLarge</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;public&nbsp;exponent&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;checkPub&nbsp;sanity&nbsp;checks&nbsp;the&nbsp;public&nbsp;key&nbsp;before&nbsp;we&nbsp;use&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;We&nbsp;require&nbsp;pub.E&nbsp;to&nbsp;fit&nbsp;into&nbsp;a&nbsp;32-bit&nbsp;integer&nbsp;so&nbsp;that&nbsp;we</span><br>
<span class="lineno">35</span><span class="comment">//&nbsp;do&nbsp;not&nbsp;have&nbsp;different&nbsp;behavior&nbsp;depending&nbsp;on&nbsp;whether</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;int&nbsp;is&nbsp;32&nbsp;or&nbsp;64&nbsp;bits.&nbsp;See&nbsp;also</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;http://www.imperialviolet.org/2012/03/16/rsae.html.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">checkPub</span><span class="op">(</span><span class="ident">pub</span>&nbsp;<span class="op">*</span><span class="ident">PublicKey</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errPublicModulus</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">E</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errPublicExponentSmall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">E</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">31</span><span class="op">-</span><span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errPublicExponentLarge</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;PrivateKey&nbsp;represents&nbsp;an&nbsp;RSA&nbsp;key</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">PrivateKey</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">PublicKey</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;public&nbsp;part.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">D</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;private&nbsp;exponent</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Primes</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;prime&nbsp;factors&nbsp;of&nbsp;N,&nbsp;has&nbsp;&gt;=&nbsp;2&nbsp;elements.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Precomputed&nbsp;contains&nbsp;precomputed&nbsp;values&nbsp;that&nbsp;speed&nbsp;up&nbsp;private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;operations,&nbsp;if&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Precomputed</span>&nbsp;<span class="ident">PrecomputedValues</span><br>
<span class="lineno">60</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Public&nbsp;returns&nbsp;the&nbsp;public&nbsp;key&nbsp;corresponding&nbsp;to&nbsp;priv.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">)</span>&nbsp;<span class="ident">Public</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="ident">crypto</span><span class="op">.</span><span class="ident">PublicKey</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">priv</span><span class="op">.</span><span class="ident">PublicKey</span><br>
<span class="lineno">65</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Sign&nbsp;signs&nbsp;msg&nbsp;with&nbsp;priv,&nbsp;reading&nbsp;randomness&nbsp;from&nbsp;rand.&nbsp;If&nbsp;opts&nbsp;is&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;*PSSOptions&nbsp;then&nbsp;the&nbsp;PSS&nbsp;algorithm&nbsp;will&nbsp;be&nbsp;used,&nbsp;otherwise&nbsp;PKCS#1&nbsp;v1.5&nbsp;will</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;be&nbsp;used.&nbsp;This&nbsp;method&nbsp;is&nbsp;intended&nbsp;to&nbsp;support&nbsp;keys&nbsp;where&nbsp;the&nbsp;private&nbsp;part&nbsp;is</span><br>
<span class="lineno">70</span><span class="comment">//&nbsp;kept&nbsp;in,&nbsp;for&nbsp;example,&nbsp;a&nbsp;hardware&nbsp;module.&nbsp;Common&nbsp;uses&nbsp;should&nbsp;use&nbsp;the&nbsp;Sign*</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;functions&nbsp;in&nbsp;this&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">)</span>&nbsp;<span class="ident">Sign</span><span class="op">(</span><span class="ident">rand</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">opts</span>&nbsp;<span class="ident">crypto</span><span class="op">.</span><span class="ident">SignerOpts</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pssOpts</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">opts</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">PSSOptions</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">SignPSS</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">,</span>&nbsp;<span class="ident">pssOpts</span><span class="op">.</span><span class="ident">Hash</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">,</span>&nbsp;<span class="ident">pssOpts</span><span class="op">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">SignPKCS1v15</span><span class="op">(</span><span class="ident">rand</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">,</span>&nbsp;<span class="ident">opts</span><span class="op">.</span><span class="ident">HashFunc</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword">type</span>&nbsp;<span class="ident">PrecomputedValues</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Dp</span><span class="op">,</span>&nbsp;<span class="ident">Dq</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;D&nbsp;mod&nbsp;(P-1)&nbsp;(or&nbsp;mod&nbsp;Q-1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Qinv</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;Q^-1&nbsp;mod&nbsp;P</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;CRTValues&nbsp;is&nbsp;used&nbsp;for&nbsp;the&nbsp;3rd&nbsp;and&nbsp;subsequent&nbsp;primes.&nbsp;Due&nbsp;to&nbsp;a</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;historical&nbsp;accident,&nbsp;the&nbsp;CRT&nbsp;for&nbsp;the&nbsp;first&nbsp;two&nbsp;primes&nbsp;is&nbsp;handled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;differently&nbsp;in&nbsp;PKCS#1&nbsp;and&nbsp;interoperability&nbsp;is&nbsp;sufficiently</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;important&nbsp;that&nbsp;we&nbsp;mirror&nbsp;this.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">CRTValues</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="ident">CRTValue</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;CRTValue&nbsp;contains&nbsp;the&nbsp;precomputed&nbsp;chinese&nbsp;remainder&nbsp;theorem&nbsp;values.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">CRTValue</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Exp</span>&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;D&nbsp;mod&nbsp;(prime-1).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Coeff</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;R·Coeff&nbsp;≡&nbsp;1&nbsp;mod&nbsp;Prime.</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">R</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="comment">//&nbsp;product&nbsp;of&nbsp;primes&nbsp;prior&nbsp;to&nbsp;this&nbsp;(inc&nbsp;p&nbsp;and&nbsp;q).</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Validate&nbsp;performs&nbsp;basic&nbsp;sanity&nbsp;checks&nbsp;on&nbsp;the&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;returns&nbsp;nil&nbsp;if&nbsp;the&nbsp;key&nbsp;is&nbsp;valid,&nbsp;or&nbsp;else&nbsp;an&nbsp;error&nbsp;describing&nbsp;a&nbsp;problem.</span><br>
<span class="lineno">100</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">)</span>&nbsp;<span class="ident">Validate</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">checkPub</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">priv</span><span class="op">.</span><span class="ident">PublicKey</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;prime&nbsp;factors&nbsp;are&nbsp;actually&nbsp;prime.&nbsp;Note&nbsp;that&nbsp;this&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;just&nbsp;a&nbsp;sanity&nbsp;check.&nbsp;Since&nbsp;the&nbsp;random&nbsp;witnesses&nbsp;chosen&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;ProbablyPrime&nbsp;are&nbsp;deterministic,&nbsp;given&nbsp;the&nbsp;candidate&nbsp;number,&nbsp;it&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;easy&nbsp;for&nbsp;an&nbsp;attack&nbsp;to&nbsp;generate&nbsp;composites&nbsp;that&nbsp;pass&nbsp;this&nbsp;test.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">prime</span><span class="op">.</span><span class="ident">ProbablyPrime</span><span class="op">(</span><span class="num">20</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;prime&nbsp;factor&nbsp;is&nbsp;composite&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;that&nbsp;Πprimes&nbsp;==&nbsp;n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">modulus</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">modulus</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">modulus</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">modulus</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;invalid&nbsp;modulus&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Check&nbsp;that&nbsp;de&nbsp;≡&nbsp;1&nbsp;mod&nbsp;p-1,&nbsp;for&nbsp;each&nbsp;prime.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;implies&nbsp;that&nbsp;e&nbsp;is&nbsp;coprime&nbsp;to&nbsp;each&nbsp;p-1&nbsp;as&nbsp;e&nbsp;has&nbsp;a&nbsp;multiplicative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;inverse.&nbsp;Therefore&nbsp;e&nbsp;is&nbsp;coprime&nbsp;to&nbsp;lcm(p-1,q-1,r-1,...)&nbsp;=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;exponent(ℤ/nℤ).&nbsp;It&nbsp;also&nbsp;implies&nbsp;that&nbsp;a^de&nbsp;≡&nbsp;a&nbsp;mod&nbsp;p&nbsp;as&nbsp;a^(p-1)&nbsp;≡&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;mod&nbsp;p.&nbsp;Thus&nbsp;a^de&nbsp;≡&nbsp;a&nbsp;mod&nbsp;n&nbsp;for&nbsp;all&nbsp;a&nbsp;coprime&nbsp;to&nbsp;n,&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">congruence</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">de</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">SetInt64</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">E</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">de</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">de</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pminus1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">prime</span><span class="op">,</span>&nbsp;<span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">congruence</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">de</span><span class="op">,</span>&nbsp;<span class="ident">pminus1</span><span class="op">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">congruence</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;invalid&nbsp;exponents&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">140</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GenerateKey&nbsp;generates&nbsp;an&nbsp;RSA&nbsp;keypair&nbsp;of&nbsp;the&nbsp;given&nbsp;bit&nbsp;size&nbsp;using&nbsp;the</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;random&nbsp;source&nbsp;random&nbsp;(for&nbsp;example,&nbsp;crypto/rand.Reader).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">GenerateKey</span><span class="op">(</span><span class="ident">random</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">GenerateMultiPrimeKey</span><span class="op">(</span><span class="ident">random</span><span class="op">,</span>&nbsp;<span class="num">2</span><span class="op">,</span>&nbsp;<span class="ident">bits</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GenerateMultiPrimeKey&nbsp;generates&nbsp;a&nbsp;multi-prime&nbsp;RSA&nbsp;keypair&nbsp;of&nbsp;the&nbsp;given&nbsp;bit</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;size&nbsp;and&nbsp;the&nbsp;given&nbsp;random&nbsp;source,&nbsp;as&nbsp;suggested&nbsp;in&nbsp;[1].&nbsp;Although&nbsp;the&nbsp;public</span><br>
<span class="lineno">150</span><span class="comment">//&nbsp;keys&nbsp;are&nbsp;compatible&nbsp;(actually,&nbsp;indistinguishable)&nbsp;from&nbsp;the&nbsp;2-prime&nbsp;case,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;private&nbsp;keys&nbsp;are&nbsp;not.&nbsp;Thus&nbsp;it&nbsp;may&nbsp;not&nbsp;be&nbsp;possible&nbsp;to&nbsp;export&nbsp;multi-prime</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;private&nbsp;keys&nbsp;in&nbsp;certain&nbsp;formats&nbsp;or&nbsp;to&nbsp;subsequently&nbsp;import&nbsp;them&nbsp;into&nbsp;other</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">155</span><span class="comment">//&nbsp;Table&nbsp;1&nbsp;in&nbsp;[2]&nbsp;suggests&nbsp;maximum&nbsp;numbers&nbsp;of&nbsp;primes&nbsp;for&nbsp;a&nbsp;given&nbsp;size.</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;[1]&nbsp;US&nbsp;patent&nbsp;4405829&nbsp;(1972,&nbsp;expired)</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;[2]&nbsp;http://www.cacr.math.uwaterloo.ca/techreports/2006/cacr2006-16.pdf</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">GenerateMultiPrimeKey</span><span class="op">(</span><span class="ident">random</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">nprimes</span>&nbsp;<span class="builtintype">int</span><span class="op">,</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">PrivateKey</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">E</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">65537</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nprimes</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;GenerateMultiPrimeKey:&nbsp;nprimes&nbsp;must&nbsp;be&nbsp;&gt;=&nbsp;2&#34;</span><span class="op">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">primes</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">nprimes</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident">NextSetOfPrimes</span><span class="op">:</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">todo</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;crypto/rand&nbsp;should&nbsp;set&nbsp;the&nbsp;top&nbsp;two&nbsp;bits&nbsp;in&nbsp;each&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Thus&nbsp;each&nbsp;prime&nbsp;has&nbsp;the&nbsp;form</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;p_i&nbsp;=&nbsp;2^bitlen(p_i)&nbsp;×&nbsp;0.11...&nbsp;(in&nbsp;base&nbsp;2).</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;And&nbsp;the&nbsp;product&nbsp;is:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;P&nbsp;=&nbsp;2^todo&nbsp;×&nbsp;α</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;where&nbsp;α&nbsp;is&nbsp;the&nbsp;product&nbsp;of&nbsp;nprimes&nbsp;numbers&nbsp;of&nbsp;the&nbsp;form&nbsp;0.11...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;α&nbsp;&lt;&nbsp;1/2&nbsp;(which&nbsp;can&nbsp;happen&nbsp;for&nbsp;nprimes&nbsp;&gt;&nbsp;2),&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;shift&nbsp;todo&nbsp;to&nbsp;compensate&nbsp;for&nbsp;lost&nbsp;bits:&nbsp;the&nbsp;mean&nbsp;value&nbsp;of&nbsp;0.11...</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;is&nbsp;7/8,&nbsp;so&nbsp;todo&nbsp;+&nbsp;shift&nbsp;-&nbsp;nprimes&nbsp;*&nbsp;log2(7/8)&nbsp;~=&nbsp;bits&nbsp;-&nbsp;1/2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;will&nbsp;give&nbsp;good&nbsp;results.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">nprimes</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">7</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">todo</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="op">(</span><span class="ident">nprimes</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">2</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">5</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">nprimes</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">primes</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rand</span><span class="op">.</span><span class="ident">Prime</span><span class="op">(</span><span class="ident">random</span><span class="op">,</span>&nbsp;<span class="ident">todo</span><span class="op">/</span><span class="op">(</span><span class="ident">nprimes</span><span class="op">-</span><span class="ident">i</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">todo</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="ident">primes</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Make&nbsp;sure&nbsp;that&nbsp;primes&nbsp;is&nbsp;pairwise&nbsp;unequal.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">primes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">i</span><span class="op">;</span>&nbsp;<span class="ident">j</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prime</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">primes</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span>&nbsp;<span class="ident">NextSetOfPrimes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">totient</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pminus1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">primes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">n</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pminus1</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">prime</span><span class="op">,</span>&nbsp;<span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">totient</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">totient</span><span class="op">,</span>&nbsp;<span class="ident">pminus1</span><span class="op">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;should&nbsp;never&nbsp;happen&nbsp;for&nbsp;nprimes&nbsp;==&nbsp;2&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;crypto/rand&nbsp;should&nbsp;set&nbsp;the&nbsp;top&nbsp;two&nbsp;bits&nbsp;in&nbsp;each&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;For&nbsp;nprimes&nbsp;&gt;&nbsp;2&nbsp;we&nbsp;hope&nbsp;it&nbsp;does&nbsp;not&nbsp;happen&nbsp;often.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span>&nbsp;<span class="ident">NextSetOfPrimes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">D</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">E</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">GCD</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">,</span>&nbsp;<span class="ident">totient</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">g</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">totient</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">primes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">n</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precompute</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;incCounter&nbsp;increments&nbsp;a&nbsp;four&nbsp;byte,&nbsp;big-endian&nbsp;counter.</span><br>
<span class="lineno">240</span><span class="keyword">func</span>&nbsp;<span class="ident">incCounter</span><span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">3</span><span class="op">]</span><span class="op">++</span><span class="op">;</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">3</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">2</span><span class="op">]</span><span class="op">++</span><span class="op">;</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">2</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">++</span><span class="op">;</span>&nbsp;<span class="ident">c</span><span class="op">[</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">++</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mgf1XOR&nbsp;XORs&nbsp;the&nbsp;bytes&nbsp;in&nbsp;out&nbsp;with&nbsp;a&nbsp;mask&nbsp;generated&nbsp;using&nbsp;the&nbsp;MGF1&nbsp;function</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;specified&nbsp;in&nbsp;PKCS#1&nbsp;v2.1.</span><br>
<span class="lineno">255</span><span class="keyword">func</span>&nbsp;<span class="ident">mgf1XOR</span><span class="op">(</span><span class="ident">out</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">hash</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Hash</span><span class="op">,</span>&nbsp;<span class="ident">seed</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">counter</span>&nbsp;<span class="op">[</span><span class="num">4</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">digest</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">seed</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">counter</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="num">4</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">digest</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Sum</span><span class="op">(</span><span class="ident">digest</span><span class="op">[</span><span class="op">:</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">digest</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">done</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span><span class="op">[</span><span class="ident">done</span><span class="op">]</span>&nbsp;<span class="op">^=</span>&nbsp;<span class="ident">digest</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">done</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">incCounter</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">counter</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrMessageTooLong&nbsp;is&nbsp;returned&nbsp;when&nbsp;attempting&nbsp;to&nbsp;encrypt&nbsp;a&nbsp;message&nbsp;which&nbsp;is</span><br>
<span class="lineno">275</span><span class="comment">//&nbsp;too&nbsp;large&nbsp;for&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;public&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrMessageTooLong</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;message&nbsp;too&nbsp;long&nbsp;for&nbsp;RSA&nbsp;public&nbsp;key&nbsp;size&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">encrypt</span><span class="op">(</span><span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">pub</span>&nbsp;<span class="op">*</span><span class="ident">PublicKey</span><span class="op">,</span>&nbsp;<span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">E</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">e</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">c</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;EncryptOAEP&nbsp;encrypts&nbsp;the&nbsp;given&nbsp;message&nbsp;with&nbsp;RSA-OAEP.</span><br>
<span class="lineno">285</span><span class="comment">//&nbsp;The&nbsp;message&nbsp;must&nbsp;be&nbsp;no&nbsp;longer&nbsp;than&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;public&nbsp;modulus&nbsp;less</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;twice&nbsp;the&nbsp;hash&nbsp;length&nbsp;plus&nbsp;2.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">EncryptOAEP</span><span class="op">(</span><span class="ident">hash</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Hash</span><span class="op">,</span>&nbsp;<span class="ident">random</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">pub</span>&nbsp;<span class="op">*</span><span class="ident">PublicKey</span><span class="op">,</span>&nbsp;<span class="ident">msg</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">label</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">out</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">checkPub</span><span class="op">(</span><span class="ident">pub</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">pub</span><span class="op">.</span><span class="ident">N</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">7</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">msg</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">k</span><span class="op">-</span><span class="num">2</span><span class="op">*</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">-</span><span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrMessageTooLong</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">label</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lHash</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Sum</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">em</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seed</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">em</span><span class="op">[</span><span class="num">1</span>&nbsp;<span class="op">:</span>&nbsp;<span class="num">1</span><span class="op">+</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">db</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">em</span><span class="op">[</span><span class="num">1</span><span class="op">+</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">db</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">lHash</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">db</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">db</span><span class="op">)</span><span class="op">-</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">msg</span><span class="op">)</span><span class="op">-</span><span class="num">1</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">db</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">db</span><span class="op">)</span><span class="op">-</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">msg</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">msg</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">ReadFull</span><span class="op">(</span><span class="ident">random</span><span class="op">,</span>&nbsp;<span class="ident">seed</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mgf1XOR</span><span class="op">(</span><span class="ident">db</span><span class="op">,</span>&nbsp;<span class="ident">hash</span><span class="op">,</span>&nbsp;<span class="ident">seed</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mgf1XOR</span><span class="op">(</span><span class="ident">seed</span><span class="op">,</span>&nbsp;<span class="ident">hash</span><span class="op">,</span>&nbsp;<span class="ident">db</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">em</span><span class="op">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">encrypt</span><span class="op">(</span><span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">pub</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;the&nbsp;output&nbsp;is&nbsp;too&nbsp;small,&nbsp;we&nbsp;need&nbsp;to&nbsp;left-pad&nbsp;with&nbsp;zeros.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">t</span><span class="op">[</span><span class="ident">k</span><span class="op">-</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">out</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrDecryption&nbsp;represents&nbsp;a&nbsp;failure&nbsp;to&nbsp;decrypt&nbsp;a&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;deliberately&nbsp;vague&nbsp;to&nbsp;avoid&nbsp;adaptive&nbsp;attacks.</span><br>
<span class="lineno">335</span><span class="keyword">var</span>&nbsp;<span class="ident">ErrDecryption</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;decryption&nbsp;error&#34;</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;ErrVerification&nbsp;represents&nbsp;a&nbsp;failure&nbsp;to&nbsp;verify&nbsp;a&nbsp;signature.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;It&nbsp;is&nbsp;deliberately&nbsp;vague&nbsp;to&nbsp;avoid&nbsp;adaptive&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">ErrVerification</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;crypto/rsa:&nbsp;verification&nbsp;error&#34;</span><span class="op">)</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;modInverse&nbsp;returns&nbsp;ia,&nbsp;the&nbsp;inverse&nbsp;of&nbsp;a&nbsp;in&nbsp;the&nbsp;multiplicative&nbsp;group&nbsp;of&nbsp;prime</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;order&nbsp;n.&nbsp;It&nbsp;requires&nbsp;that&nbsp;a&nbsp;be&nbsp;a&nbsp;member&nbsp;of&nbsp;the&nbsp;group&nbsp;(i.e.&nbsp;less&nbsp;than&nbsp;n).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">modInverse</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">ia</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">y</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">g</span><span class="op">.</span><span class="ident">GCD</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">g</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;In&nbsp;this&nbsp;case,&nbsp;a&nbsp;and&nbsp;n&nbsp;aren&#39;t&nbsp;coprime&nbsp;and&nbsp;we&nbsp;cannot&nbsp;calculate</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;the&nbsp;inverse.&nbsp;This&nbsp;happens&nbsp;because&nbsp;the&nbsp;values&nbsp;of&nbsp;n&nbsp;are&nbsp;nearly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;prime&nbsp;(being&nbsp;the&nbsp;product&nbsp;of&nbsp;two&nbsp;primes)&nbsp;rather&nbsp;than&nbsp;truly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;prime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">bigOne</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;0&nbsp;is&nbsp;not&nbsp;the&nbsp;multiplicative&nbsp;inverse&nbsp;of&nbsp;any&nbsp;element&nbsp;so,&nbsp;if&nbsp;x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&lt;&nbsp;1,&nbsp;then&nbsp;x&nbsp;is&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">n</span><span class="op">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">365</span><span class="comment">//&nbsp;Precompute&nbsp;performs&nbsp;some&nbsp;calculations&nbsp;that&nbsp;speed&nbsp;up&nbsp;private&nbsp;key&nbsp;operations</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;in&nbsp;the&nbsp;future.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">)</span>&nbsp;<span class="ident">Precompute</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dq</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dq</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dq</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Qinv</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">ModInverse</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">CRTValues</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="ident">CRTValue</span><span class="op">,</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">)</span><span class="op">-</span><span class="num">2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">2</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">values</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">&amp;</span><span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">CRTValues</span><span class="op">[</span><span class="ident">i</span><span class="op">-</span><span class="num">2</span><span class="op">]</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">values</span><span class="op">.</span><span class="ident">Exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">prime</span><span class="op">,</span>&nbsp;<span class="ident">bigOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">values</span><span class="op">.</span><span class="ident">Exp</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">values</span><span class="op">.</span><span class="ident">Exp</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">values</span><span class="op">.</span><span class="ident">R</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">values</span><span class="op">.</span><span class="ident">Coeff</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">ModInverse</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;decrypt&nbsp;performs&nbsp;an&nbsp;RSA&nbsp;decryption,&nbsp;resulting&nbsp;in&nbsp;a&nbsp;plaintext&nbsp;integer.&nbsp;If&nbsp;a</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;random&nbsp;source&nbsp;is&nbsp;given,&nbsp;RSA&nbsp;blinding&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">decrypt</span><span class="op">(</span><span class="ident">random</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">c</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">m</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(agl):&nbsp;can&nbsp;we&nbsp;get&nbsp;away&nbsp;with&nbsp;reusing&nbsp;blinds?</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ir</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">random</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Blinding&nbsp;enabled.&nbsp;Blinding&nbsp;involves&nbsp;multiplying&nbsp;c&nbsp;by&nbsp;r^e.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Then&nbsp;the&nbsp;decryption&nbsp;operation&nbsp;performs&nbsp;(m^e&nbsp;*&nbsp;r^e)^d&nbsp;mod&nbsp;n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;which&nbsp;equals&nbsp;mr&nbsp;mod&nbsp;n.&nbsp;The&nbsp;factor&nbsp;of&nbsp;r&nbsp;can&nbsp;then&nbsp;be&nbsp;removed</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;multiplying&nbsp;by&nbsp;the&nbsp;multiplicative&nbsp;inverse&nbsp;of&nbsp;r.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rand</span><span class="op">.</span><span class="ident">Int</span><span class="op">(</span><span class="ident">random</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">bigZero</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">bigOne</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="builtintype">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ir</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">modInverse</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bigE</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">big</span><span class="op">.</span><span class="ident">NewInt</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">E</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rpowe</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">bigE</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cCopy</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">c</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cCopy</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">cCopy</span><span class="op">,</span>&nbsp;<span class="ident">rpowe</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">cCopy</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">cCopy</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">cCopy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">D</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;the&nbsp;precalculated&nbsp;values&nbsp;needed&nbsp;for&nbsp;the&nbsp;CRT.</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dp</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Dq</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">m2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">Qinv</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">1</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">m2</span><span class="op">)</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">values</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Precomputed</span><span class="op">.</span><span class="ident">CRTValues</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">prime</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">Primes</span><span class="op">[</span><span class="num">2</span><span class="op">+</span><span class="ident">i</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Exp</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">values</span><span class="op">.</span><span class="ident">Exp</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">m2</span><span class="op">,</span>&nbsp;<span class="ident">m</span><span class="op">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">m2</span><span class="op">,</span>&nbsp;<span class="ident">values</span><span class="op">.</span><span class="ident">Coeff</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">m2</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">m2</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">m2</span><span class="op">,</span>&nbsp;<span class="ident">prime</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m2</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">m2</span><span class="op">,</span>&nbsp;<span class="ident">values</span><span class="op">.</span><span class="ident">R</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">m2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ir</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Unblind.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">ir</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">.</span><span class="ident">Mod</span><span class="op">(</span><span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">470</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;DecryptOAEP&nbsp;decrypts&nbsp;ciphertext&nbsp;using&nbsp;RSA-OAEP.</span><br>
<span class="lineno">475</span><span class="comment">//&nbsp;If&nbsp;random&nbsp;!=&nbsp;nil,&nbsp;DecryptOAEP&nbsp;uses&nbsp;RSA&nbsp;blinding&nbsp;to&nbsp;avoid&nbsp;timing&nbsp;side-channel&nbsp;attacks.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">DecryptOAEP</span><span class="op">(</span><span class="ident">hash</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Hash</span><span class="op">,</span>&nbsp;<span class="ident">random</span>&nbsp;<span class="ident">io</span><span class="op">.</span><span class="ident">Reader</span><span class="op">,</span>&nbsp;<span class="ident">priv</span>&nbsp;<span class="op">*</span><span class="ident">PrivateKey</span><span class="op">,</span>&nbsp;<span class="ident">ciphertext</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">label</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">msg</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">checkPub</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">priv</span><span class="op">.</span><span class="ident">PublicKey</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">(</span><span class="ident">priv</span><span class="op">.</span><span class="ident">N</span><span class="op">.</span><span class="ident">BitLen</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">7</span><span class="op">)</span>&nbsp;<span class="op">/</span>&nbsp;<span class="num">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">k</span>&nbsp;<span class="op">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">k</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">*</span><span class="num">2</span><span class="op">+</span><span class="num">2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrDecryption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">big</span><span class="op">.</span><span class="ident">Int</span><span class="op">)</span><span class="op">.</span><span class="ident">SetBytes</span><span class="op">(</span><span class="ident">ciphertext</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">m</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">decrypt</span><span class="op">(</span><span class="ident">random</span><span class="op">,</span>&nbsp;<span class="ident">priv</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">label</span><span class="op">)</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lHash</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Sum</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">hash</span><span class="op">.</span><span class="ident">Reset</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Converting&nbsp;the&nbsp;plaintext&nbsp;number&nbsp;to&nbsp;bytes&nbsp;will&nbsp;strip&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;leading&nbsp;zeros&nbsp;so&nbsp;we&nbsp;may&nbsp;have&nbsp;to&nbsp;left&nbsp;pad.&nbsp;We&nbsp;do&nbsp;this&nbsp;unconditionally</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;to&nbsp;avoid&nbsp;leaking&nbsp;timing&nbsp;information.&nbsp;(Although&nbsp;we&nbsp;still&nbsp;probably</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;leak&nbsp;the&nbsp;number&nbsp;of&nbsp;leading&nbsp;zeros.&nbsp;It&#39;s&nbsp;not&nbsp;clear&nbsp;that&nbsp;we&nbsp;can&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;anything&nbsp;about&nbsp;this.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">em</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">leftPad</span><span class="op">(</span><span class="ident">m</span><span class="op">.</span><span class="ident">Bytes</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">k</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">firstByteIsZero</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeByteEq</span><span class="op">(</span><span class="ident">em</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">seed</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">em</span><span class="op">[</span><span class="num">1</span>&nbsp;<span class="op">:</span>&nbsp;<span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="num">1</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">db</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">em</span><span class="op">[</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mgf1XOR</span><span class="op">(</span><span class="ident">seed</span><span class="op">,</span>&nbsp;<span class="ident">hash</span><span class="op">,</span>&nbsp;<span class="ident">db</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mgf1XOR</span><span class="op">(</span><span class="ident">db</span><span class="op">,</span>&nbsp;<span class="ident">hash</span><span class="op">,</span>&nbsp;<span class="ident">seed</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lHash2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">db</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;We&nbsp;have&nbsp;to&nbsp;validate&nbsp;the&nbsp;plaintext&nbsp;in&nbsp;constant&nbsp;time&nbsp;in&nbsp;order&nbsp;to&nbsp;avoid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;attacks&nbsp;like:&nbsp;J.&nbsp;Manger.&nbsp;A&nbsp;Chosen&nbsp;Ciphertext&nbsp;Attack&nbsp;on&nbsp;RSA&nbsp;Optimal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Asymmetric&nbsp;Encryption&nbsp;Padding&nbsp;(OAEP)&nbsp;as&nbsp;Standardized&nbsp;in&nbsp;PKCS&nbsp;#1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;v2.0.&nbsp;In&nbsp;J.&nbsp;Kilian,&nbsp;editor,&nbsp;Advances&nbsp;in&nbsp;Cryptology.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lHash2Good</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeCompare</span><span class="op">(</span><span class="ident">lHash</span><span class="op">,</span>&nbsp;<span class="ident">lHash2</span><span class="op">)</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;remainder&nbsp;of&nbsp;the&nbsp;plaintext&nbsp;must&nbsp;be&nbsp;zero&nbsp;or&nbsp;more&nbsp;0x00,&nbsp;followed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;by&nbsp;0x01,&nbsp;followed&nbsp;by&nbsp;the&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;lookingForIndex:&nbsp;1&nbsp;iff&nbsp;we&nbsp;are&nbsp;still&nbsp;looking&nbsp;for&nbsp;the&nbsp;0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;index:&nbsp;the&nbsp;offset&nbsp;of&nbsp;the&nbsp;first&nbsp;0x01&nbsp;byte</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;invalid:&nbsp;1&nbsp;iff&nbsp;we&nbsp;saw&nbsp;a&nbsp;non-zero&nbsp;byte&nbsp;before&nbsp;the&nbsp;0x01.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">lookingForIndex</span><span class="op">,</span>&nbsp;<span class="ident">index</span><span class="op">,</span>&nbsp;<span class="ident">invalid</span>&nbsp;<span class="builtintype">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lookingForIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rest</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">db</span><span class="op">[</span><span class="ident">hash</span><span class="op">.</span><span class="ident">Size</span><span class="op">(</span><span class="op">)</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">rest</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">i</span><span class="op">++</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">equals0</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeByteEq</span><span class="op">(</span><span class="ident">rest</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">equals1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeByteEq</span><span class="op">(</span><span class="ident">rest</span><span class="op">[</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">index</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeSelect</span><span class="op">(</span><span class="ident">lookingForIndex</span><span class="op">&amp;</span><span class="ident">equals1</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">index</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lookingForIndex</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeSelect</span><span class="op">(</span><span class="ident">equals1</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">lookingForIndex</span><span class="op">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">invalid</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">subtle</span><span class="op">.</span><span class="ident">ConstantTimeSelect</span><span class="op">(</span><span class="ident">lookingForIndex</span><span class="op">&amp;^</span><span class="ident">equals0</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">,</span>&nbsp;<span class="ident">invalid</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">firstByteIsZero</span><span class="op">&amp;</span><span class="ident">lHash2Good</span><span class="op">&amp;^</span><span class="ident">invalid</span><span class="op">&amp;^</span><span class="ident">lookingForIndex</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ErrDecryption</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">msg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">rest</span><span class="op">[</span><span class="ident">index</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno">545</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;leftPad&nbsp;returns&nbsp;a&nbsp;new&nbsp;slice&nbsp;of&nbsp;length&nbsp;size.&nbsp;The&nbsp;contents&nbsp;of&nbsp;input&nbsp;are&nbsp;right</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;aligned&nbsp;in&nbsp;the&nbsp;new&nbsp;slice.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">leftPad</span><span class="op">(</span><span class="ident">input</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">out</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">input</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="ident">size</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">out</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">size</span><span class="op">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">copy</span><span class="op">(</span><span class="ident">out</span><span class="op">[</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">out</span><span class="op">)</span><span class="op">-</span><span class="ident">n</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">input</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
