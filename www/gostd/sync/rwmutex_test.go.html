<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html" class="current">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1134604">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1134659">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1134713">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1134764">//&nbsp;GOMAXPROCS=10&nbsp;go&nbsp;test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1134790">package</span>&nbsp;<span class="ident" id="1134798">sync_test</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1134809">import</span>&nbsp;<span class="op" id="1134816">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1134819">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1134826">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1134837">.</span>&nbsp;<span class="string" id="1134839">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1134847">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1134862">&#34;testing&#34;</span><br>
<span class="lineno">15</span><span class="op" id="1134872">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1134875">func</span>&nbsp;<span class="ident" id="1134880">parallelReader</span><span class="op" id="1134894">(</span><span class="ident" id="1134895">m</span>&nbsp;<span class="op" id="1134897">*</span><span class="ident" id="1134898">RWMutex</span><span class="op" id="1134905">,</span>&nbsp;<span class="ident" id="1134907">clocked</span><span class="op" id="1134914">,</span>&nbsp;<span class="ident" id="1134916">cunlock</span><span class="op" id="1134923">,</span>&nbsp;<span class="ident" id="1134925">cdone</span>&nbsp;<span class="keyword" id="1134931">chan</span>&nbsp;<span class="builtintype" id="1134936">bool</span><span class="op" id="1134940">)</span>&nbsp;<span class="op" id="1134942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1134945">m</span><span class="op" id="1134946">.</span><span class="ident" id="1134947">RLock</span><span class="op" id="1134952">(</span><span class="op" id="1134953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1134956">clocked</span>&nbsp;<span class="op" id="1134964">&lt;-</span>&nbsp;<span class="builtintype" id="1134967">true</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1134973">&lt;-</span><span class="ident" id="1134975">cunlock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1134984">m</span><span class="op" id="1134985">.</span><span class="ident" id="1134986">RUnlock</span><span class="op" id="1134993">(</span><span class="op" id="1134994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1134997">cdone</span>&nbsp;<span class="op" id="1135003">&lt;-</span>&nbsp;<span class="builtintype" id="1135006">true</span><br>
<span class="lineno"></span><span class="op" id="1135011">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="1135014">func</span>&nbsp;<span class="ident" id="1135019">doTestParallelReaders</span><span class="op" id="1135040">(</span><span class="ident" id="1135041">numReaders</span><span class="op" id="1135051">,</span>&nbsp;<span class="ident" id="1135053">gomaxprocs</span>&nbsp;<span class="builtintype" id="1135064">int</span><span class="op" id="1135067">)</span>&nbsp;<span class="op" id="1135069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135072">runtime</span><span class="op" id="1135079">.</span><span class="ident" id="1135080">GOMAXPROCS</span><span class="op" id="1135090">(</span><span class="ident" id="1135091">gomaxprocs</span><span class="op" id="1135101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135104">var</span>&nbsp;<span class="ident" id="1135108">m</span>&nbsp;<span class="ident" id="1135110">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135119">clocked</span>&nbsp;<span class="op" id="1135127">:=</span>&nbsp;<span class="builtinfunc" id="1135130">make</span><span class="op" id="1135134">(</span><span class="keyword" id="1135135">chan</span>&nbsp;<span class="builtintype" id="1135140">bool</span><span class="op" id="1135144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135147">cunlock</span>&nbsp;<span class="op" id="1135155">:=</span>&nbsp;<span class="builtinfunc" id="1135158">make</span><span class="op" id="1135162">(</span><span class="keyword" id="1135163">chan</span>&nbsp;<span class="builtintype" id="1135168">bool</span><span class="op" id="1135172">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135175">cdone</span>&nbsp;<span class="op" id="1135181">:=</span>&nbsp;<span class="builtinfunc" id="1135184">make</span><span class="op" id="1135188">(</span><span class="keyword" id="1135189">chan</span>&nbsp;<span class="builtintype" id="1135194">bool</span><span class="op" id="1135198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135201">for</span>&nbsp;<span class="ident" id="1135205">i</span>&nbsp;<span class="op" id="1135207">:=</span>&nbsp;<span class="num" id="1135210">0</span><span class="op" id="1135211">;</span>&nbsp;<span class="ident" id="1135213">i</span>&nbsp;<span class="op" id="1135215">&lt;</span>&nbsp;<span class="ident" id="1135217">numReaders</span><span class="op" id="1135227">;</span>&nbsp;<span class="ident" id="1135229">i</span><span class="op" id="1135230">++</span>&nbsp;<span class="op" id="1135233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135237">go</span>&nbsp;<span class="ident" id="1135240">parallelReader</span><span class="op" id="1135254">(</span><span class="op" id="1135255">&amp;</span><span class="ident" id="1135256">m</span><span class="op" id="1135257">,</span>&nbsp;<span class="ident" id="1135259">clocked</span><span class="op" id="1135266">,</span>&nbsp;<span class="ident" id="1135268">cunlock</span><span class="op" id="1135275">,</span>&nbsp;<span class="ident" id="1135277">cdone</span><span class="op" id="1135282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1135288">//&nbsp;Wait&nbsp;for&nbsp;all&nbsp;parallel&nbsp;RLock()s&nbsp;to&nbsp;succeed.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135335">for</span>&nbsp;<span class="ident" id="1135339">i</span>&nbsp;<span class="op" id="1135341">:=</span>&nbsp;<span class="num" id="1135344">0</span><span class="op" id="1135345">;</span>&nbsp;<span class="ident" id="1135347">i</span>&nbsp;<span class="op" id="1135349">&lt;</span>&nbsp;<span class="ident" id="1135351">numReaders</span><span class="op" id="1135361">;</span>&nbsp;<span class="ident" id="1135363">i</span><span class="op" id="1135364">++</span>&nbsp;<span class="op" id="1135367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135371">&lt;-</span><span class="ident" id="1135373">clocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135385">for</span>&nbsp;<span class="ident" id="1135389">i</span>&nbsp;<span class="op" id="1135391">:=</span>&nbsp;<span class="num" id="1135394">0</span><span class="op" id="1135395">;</span>&nbsp;<span class="ident" id="1135397">i</span>&nbsp;<span class="op" id="1135399">&lt;</span>&nbsp;<span class="ident" id="1135401">numReaders</span><span class="op" id="1135411">;</span>&nbsp;<span class="ident" id="1135413">i</span><span class="op" id="1135414">++</span>&nbsp;<span class="op" id="1135417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135421">cunlock</span>&nbsp;<span class="op" id="1135429">&lt;-</span>&nbsp;<span class="builtintype" id="1135432">true</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1135441">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;goroutines&nbsp;to&nbsp;finish.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135480">for</span>&nbsp;<span class="ident" id="1135484">i</span>&nbsp;<span class="op" id="1135486">:=</span>&nbsp;<span class="num" id="1135489">0</span><span class="op" id="1135490">;</span>&nbsp;<span class="ident" id="1135492">i</span>&nbsp;<span class="op" id="1135494">&lt;</span>&nbsp;<span class="ident" id="1135496">numReaders</span><span class="op" id="1135506">;</span>&nbsp;<span class="ident" id="1135508">i</span><span class="op" id="1135509">++</span>&nbsp;<span class="op" id="1135512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135516">&lt;-</span><span class="ident" id="1135518">cdone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135525">}</span><br>
<span class="lineno">45</span><span class="op" id="1135527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1135530">func</span>&nbsp;<span class="ident" id="1135535">TestParallelReaders</span><span class="op" id="1135554">(</span><span class="ident" id="1135555">t</span>&nbsp;<span class="op" id="1135557">*</span><span class="ident" id="1135558">testing</span><span class="op" id="1135565">.</span><span class="ident" id="1135566">T</span><span class="op" id="1135567">)</span>&nbsp;<span class="op" id="1135569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135572">defer</span>&nbsp;<span class="ident" id="1135578">runtime</span><span class="op" id="1135585">.</span><span class="ident" id="1135586">GOMAXPROCS</span><span class="op" id="1135596">(</span><span class="ident" id="1135597">runtime</span><span class="op" id="1135604">.</span><span class="ident" id="1135605">GOMAXPROCS</span><span class="op" id="1135615">(</span><span class="op" id="1135616">-</span><span class="num" id="1135617">1</span><span class="op" id="1135618">)</span><span class="op" id="1135619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135622">doTestParallelReaders</span><span class="op" id="1135643">(</span><span class="num" id="1135644">1</span><span class="op" id="1135645">,</span>&nbsp;<span class="num" id="1135647">4</span><span class="op" id="1135648">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135651">doTestParallelReaders</span><span class="op" id="1135672">(</span><span class="num" id="1135673">3</span><span class="op" id="1135674">,</span>&nbsp;<span class="num" id="1135676">4</span><span class="op" id="1135677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135680">doTestParallelReaders</span><span class="op" id="1135701">(</span><span class="num" id="1135702">4</span><span class="op" id="1135703">,</span>&nbsp;<span class="num" id="1135705">2</span><span class="op" id="1135706">)</span><br>
<span class="lineno"></span><span class="op" id="1135708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1135711">func</span>&nbsp;<span class="ident" id="1135716">reader</span><span class="op" id="1135722">(</span><span class="ident" id="1135723">rwm</span>&nbsp;<span class="op" id="1135727">*</span><span class="ident" id="1135728">RWMutex</span><span class="op" id="1135735">,</span>&nbsp;<span class="ident" id="1135737">num_iterations</span>&nbsp;<span class="builtintype" id="1135752">int</span><span class="op" id="1135755">,</span>&nbsp;<span class="ident" id="1135757">activity</span>&nbsp;<span class="op" id="1135766">*</span><span class="builtintype" id="1135767">int32</span><span class="op" id="1135772">,</span>&nbsp;<span class="ident" id="1135774">cdone</span>&nbsp;<span class="keyword" id="1135780">chan</span>&nbsp;<span class="builtintype" id="1135785">bool</span><span class="op" id="1135789">)</span>&nbsp;<span class="op" id="1135791">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135794">for</span>&nbsp;<span class="ident" id="1135798">i</span>&nbsp;<span class="op" id="1135800">:=</span>&nbsp;<span class="num" id="1135803">0</span><span class="op" id="1135804">;</span>&nbsp;<span class="ident" id="1135806">i</span>&nbsp;<span class="op" id="1135808">&lt;</span>&nbsp;<span class="ident" id="1135810">num_iterations</span><span class="op" id="1135824">;</span>&nbsp;<span class="ident" id="1135826">i</span><span class="op" id="1135827">++</span>&nbsp;<span class="op" id="1135830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135834">rwm</span><span class="op" id="1135837">.</span><span class="ident" id="1135838">RLock</span><span class="op" id="1135843">(</span><span class="op" id="1135844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135848">n</span>&nbsp;<span class="op" id="1135850">:=</span>&nbsp;<span class="ident" id="1135853">atomic</span><span class="op" id="1135859">.</span><span class="ident" id="1135860">AddInt32</span><span class="op" id="1135868">(</span><span class="ident" id="1135869">activity</span><span class="op" id="1135877">,</span>&nbsp;<span class="num" id="1135879">1</span><span class="op" id="1135880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135884">if</span>&nbsp;<span class="ident" id="1135887">n</span>&nbsp;<span class="op" id="1135889">&lt;</span>&nbsp;<span class="num" id="1135891">1</span>&nbsp;<span class="op" id="1135893">||</span>&nbsp;<span class="ident" id="1135896">n</span>&nbsp;<span class="op" id="1135898">&gt;=</span>&nbsp;<span class="num" id="1135901">10000</span>&nbsp;<span class="op" id="1135907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1135912">panic</span><span class="op" id="1135917">(</span><span class="ident" id="1135918">fmt</span><span class="op" id="1135921">.</span><span class="ident" id="1135922">Sprintf</span><span class="op" id="1135929">(</span><span class="string" id="1135930">&#34;wlock(%d)\n&#34;</span><span class="op" id="1135943">,</span>&nbsp;<span class="ident" id="1135945">n</span><span class="op" id="1135946">)</span><span class="op" id="1135947">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1135955">for</span>&nbsp;<span class="ident" id="1135959">i</span>&nbsp;<span class="op" id="1135961">:=</span>&nbsp;<span class="num" id="1135964">0</span><span class="op" id="1135965">;</span>&nbsp;<span class="ident" id="1135967">i</span>&nbsp;<span class="op" id="1135969">&lt;</span>&nbsp;<span class="num" id="1135971">100</span><span class="op" id="1135974">;</span>&nbsp;<span class="ident" id="1135976">i</span><span class="op" id="1135977">++</span>&nbsp;<span class="op" id="1135980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1135984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1135988">atomic</span><span class="op" id="1135994">.</span><span class="ident" id="1135995">AddInt32</span><span class="op" id="1136003">(</span><span class="ident" id="1136004">activity</span><span class="op" id="1136012">,</span>&nbsp;<span class="op" id="1136014">-</span><span class="num" id="1136015">1</span><span class="op" id="1136016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136020">rwm</span><span class="op" id="1136023">.</span><span class="ident" id="1136024">RUnlock</span><span class="op" id="1136031">(</span><span class="op" id="1136032">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136038">cdone</span>&nbsp;<span class="op" id="1136044">&lt;-</span>&nbsp;<span class="builtintype" id="1136047">true</span><br>
<span class="lineno"></span><span class="op" id="1136052">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1136055">func</span>&nbsp;<span class="ident" id="1136060">writer</span><span class="op" id="1136066">(</span><span class="ident" id="1136067">rwm</span>&nbsp;<span class="op" id="1136071">*</span><span class="ident" id="1136072">RWMutex</span><span class="op" id="1136079">,</span>&nbsp;<span class="ident" id="1136081">num_iterations</span>&nbsp;<span class="builtintype" id="1136096">int</span><span class="op" id="1136099">,</span>&nbsp;<span class="ident" id="1136101">activity</span>&nbsp;<span class="op" id="1136110">*</span><span class="builtintype" id="1136111">int32</span><span class="op" id="1136116">,</span>&nbsp;<span class="ident" id="1136118">cdone</span>&nbsp;<span class="keyword" id="1136124">chan</span>&nbsp;<span class="builtintype" id="1136129">bool</span><span class="op" id="1136133">)</span>&nbsp;<span class="op" id="1136135">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136138">for</span>&nbsp;<span class="ident" id="1136142">i</span>&nbsp;<span class="op" id="1136144">:=</span>&nbsp;<span class="num" id="1136147">0</span><span class="op" id="1136148">;</span>&nbsp;<span class="ident" id="1136150">i</span>&nbsp;<span class="op" id="1136152">&lt;</span>&nbsp;<span class="ident" id="1136154">num_iterations</span><span class="op" id="1136168">;</span>&nbsp;<span class="ident" id="1136170">i</span><span class="op" id="1136171">++</span>&nbsp;<span class="op" id="1136174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136178">rwm</span><span class="op" id="1136181">.</span><span class="ident" id="1136182">Lock</span><span class="op" id="1136186">(</span><span class="op" id="1136187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136191">n</span>&nbsp;<span class="op" id="1136193">:=</span>&nbsp;<span class="ident" id="1136196">atomic</span><span class="op" id="1136202">.</span><span class="ident" id="1136203">AddInt32</span><span class="op" id="1136211">(</span><span class="ident" id="1136212">activity</span><span class="op" id="1136220">,</span>&nbsp;<span class="num" id="1136222">10000</span><span class="op" id="1136227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136231">if</span>&nbsp;<span class="ident" id="1136234">n</span>&nbsp;<span class="op" id="1136236">!=</span>&nbsp;<span class="num" id="1136239">10000</span>&nbsp;<span class="op" id="1136245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="1136250">panic</span><span class="op" id="1136255">(</span><span class="ident" id="1136256">fmt</span><span class="op" id="1136259">.</span><span class="ident" id="1136260">Sprintf</span><span class="op" id="1136267">(</span><span class="string" id="1136268">&#34;wlock(%d)\n&#34;</span><span class="op" id="1136281">,</span>&nbsp;<span class="ident" id="1136283">n</span><span class="op" id="1136284">)</span><span class="op" id="1136285">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136293">for</span>&nbsp;<span class="ident" id="1136297">i</span>&nbsp;<span class="op" id="1136299">:=</span>&nbsp;<span class="num" id="1136302">0</span><span class="op" id="1136303">;</span>&nbsp;<span class="ident" id="1136305">i</span>&nbsp;<span class="op" id="1136307">&lt;</span>&nbsp;<span class="num" id="1136309">100</span><span class="op" id="1136312">;</span>&nbsp;<span class="ident" id="1136314">i</span><span class="op" id="1136315">++</span>&nbsp;<span class="op" id="1136318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136326">atomic</span><span class="op" id="1136332">.</span><span class="ident" id="1136333">AddInt32</span><span class="op" id="1136341">(</span><span class="ident" id="1136342">activity</span><span class="op" id="1136350">,</span>&nbsp;<span class="op" id="1136352">-</span><span class="num" id="1136353">10000</span><span class="op" id="1136358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136362">rwm</span><span class="op" id="1136365">.</span><span class="ident" id="1136366">Unlock</span><span class="op" id="1136372">(</span><span class="op" id="1136373">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136379">cdone</span>&nbsp;<span class="op" id="1136385">&lt;-</span>&nbsp;<span class="builtintype" id="1136388">true</span><br>
<span class="lineno"></span><span class="op" id="1136393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1136396">func</span>&nbsp;<span class="ident" id="1136401">HammerRWMutex</span><span class="op" id="1136414">(</span><span class="ident" id="1136415">gomaxprocs</span><span class="op" id="1136425">,</span>&nbsp;<span class="ident" id="1136427">numReaders</span><span class="op" id="1136437">,</span>&nbsp;<span class="ident" id="1136439">num_iterations</span>&nbsp;<span class="builtintype" id="1136454">int</span><span class="op" id="1136457">)</span>&nbsp;<span class="op" id="1136459">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136462">runtime</span><span class="op" id="1136469">.</span><span class="ident" id="1136470">GOMAXPROCS</span><span class="op" id="1136480">(</span><span class="ident" id="1136481">gomaxprocs</span><span class="op" id="1136491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1136494">//&nbsp;Number&nbsp;of&nbsp;active&nbsp;readers&nbsp;+&nbsp;10000&nbsp;*&nbsp;number&nbsp;of&nbsp;active&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136559">var</span>&nbsp;<span class="ident" id="1136563">activity</span>&nbsp;<span class="builtintype" id="1136572">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136579">var</span>&nbsp;<span class="ident" id="1136583">rwm</span>&nbsp;<span class="ident" id="1136587">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1136596">cdone</span>&nbsp;<span class="op" id="1136602">:=</span>&nbsp;<span class="builtinfunc" id="1136605">make</span><span class="op" id="1136609">(</span><span class="keyword" id="1136610">chan</span>&nbsp;<span class="builtintype" id="1136615">bool</span><span class="op" id="1136619">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136622">go</span>&nbsp;<span class="ident" id="1136625">writer</span><span class="op" id="1136631">(</span><span class="op" id="1136632">&amp;</span><span class="ident" id="1136633">rwm</span><span class="op" id="1136636">,</span>&nbsp;<span class="ident" id="1136638">num_iterations</span><span class="op" id="1136652">,</span>&nbsp;<span class="op" id="1136654">&amp;</span><span class="ident" id="1136655">activity</span><span class="op" id="1136663">,</span>&nbsp;<span class="ident" id="1136665">cdone</span><span class="op" id="1136670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136673">var</span>&nbsp;<span class="ident" id="1136677">i</span>&nbsp;<span class="builtintype" id="1136679">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136684">for</span>&nbsp;<span class="ident" id="1136688">i</span>&nbsp;<span class="op" id="1136690">=</span>&nbsp;<span class="num" id="1136692">0</span><span class="op" id="1136693">;</span>&nbsp;<span class="ident" id="1136695">i</span>&nbsp;<span class="op" id="1136697">&lt;</span>&nbsp;<span class="ident" id="1136699">numReaders</span><span class="op" id="1136709">/</span><span class="num" id="1136710">2</span><span class="op" id="1136711">;</span>&nbsp;<span class="ident" id="1136713">i</span><span class="op" id="1136714">++</span>&nbsp;<span class="op" id="1136717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136721">go</span>&nbsp;<span class="ident" id="1136724">reader</span><span class="op" id="1136730">(</span><span class="op" id="1136731">&amp;</span><span class="ident" id="1136732">rwm</span><span class="op" id="1136735">,</span>&nbsp;<span class="ident" id="1136737">num_iterations</span><span class="op" id="1136751">,</span>&nbsp;<span class="op" id="1136753">&amp;</span><span class="ident" id="1136754">activity</span><span class="op" id="1136762">,</span>&nbsp;<span class="ident" id="1136764">cdone</span><span class="op" id="1136769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136772">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136775">go</span>&nbsp;<span class="ident" id="1136778">writer</span><span class="op" id="1136784">(</span><span class="op" id="1136785">&amp;</span><span class="ident" id="1136786">rwm</span><span class="op" id="1136789">,</span>&nbsp;<span class="ident" id="1136791">num_iterations</span><span class="op" id="1136805">,</span>&nbsp;<span class="op" id="1136807">&amp;</span><span class="ident" id="1136808">activity</span><span class="op" id="1136816">,</span>&nbsp;<span class="ident" id="1136818">cdone</span><span class="op" id="1136823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136826">for</span>&nbsp;<span class="op" id="1136830">;</span>&nbsp;<span class="ident" id="1136832">i</span>&nbsp;<span class="op" id="1136834">&lt;</span>&nbsp;<span class="ident" id="1136836">numReaders</span><span class="op" id="1136846">;</span>&nbsp;<span class="ident" id="1136848">i</span><span class="op" id="1136849">++</span>&nbsp;<span class="op" id="1136852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136856">go</span>&nbsp;<span class="ident" id="1136859">reader</span><span class="op" id="1136865">(</span><span class="op" id="1136866">&amp;</span><span class="ident" id="1136867">rwm</span><span class="op" id="1136870">,</span>&nbsp;<span class="ident" id="1136872">num_iterations</span><span class="op" id="1136886">,</span>&nbsp;<span class="op" id="1136888">&amp;</span><span class="ident" id="1136889">activity</span><span class="op" id="1136897">,</span>&nbsp;<span class="ident" id="1136899">cdone</span><span class="op" id="1136904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1136907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1136910">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;2&nbsp;writers&nbsp;and&nbsp;all&nbsp;readers&nbsp;to&nbsp;finish.</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1136964">for</span>&nbsp;<span class="ident" id="1136968">i</span>&nbsp;<span class="op" id="1136970">:=</span>&nbsp;<span class="num" id="1136973">0</span><span class="op" id="1136974">;</span>&nbsp;<span class="ident" id="1136976">i</span>&nbsp;<span class="op" id="1136978">&lt;</span>&nbsp;<span class="num" id="1136980">2</span><span class="op" id="1136981">+</span><span class="ident" id="1136982">numReaders</span><span class="op" id="1136992">;</span>&nbsp;<span class="ident" id="1136994">i</span><span class="op" id="1136995">++</span>&nbsp;<span class="op" id="1136998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137002">&lt;-</span><span class="ident" id="1137004">cdone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137011">}</span><br>
<span class="lineno"></span><span class="op" id="1137013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1137016">func</span>&nbsp;<span class="ident" id="1137021">TestRWMutex</span><span class="op" id="1137032">(</span><span class="ident" id="1137033">t</span>&nbsp;<span class="op" id="1137035">*</span><span class="ident" id="1137036">testing</span><span class="op" id="1137043">.</span><span class="ident" id="1137044">T</span><span class="op" id="1137045">)</span>&nbsp;<span class="op" id="1137047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137050">defer</span>&nbsp;<span class="ident" id="1137056">runtime</span><span class="op" id="1137063">.</span><span class="ident" id="1137064">GOMAXPROCS</span><span class="op" id="1137074">(</span><span class="ident" id="1137075">runtime</span><span class="op" id="1137082">.</span><span class="ident" id="1137083">GOMAXPROCS</span><span class="op" id="1137093">(</span><span class="op" id="1137094">-</span><span class="num" id="1137095">1</span><span class="op" id="1137096">)</span><span class="op" id="1137097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137100">n</span>&nbsp;<span class="op" id="1137102">:=</span>&nbsp;<span class="num" id="1137105">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137111">if</span>&nbsp;<span class="ident" id="1137114">testing</span><span class="op" id="1137121">.</span><span class="ident" id="1137122">Short</span><span class="op" id="1137127">(</span><span class="op" id="1137128">)</span>&nbsp;<span class="op" id="1137130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137134">n</span>&nbsp;<span class="op" id="1137136">=</span>&nbsp;<span class="num" id="1137138">5</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137144">HammerRWMutex</span><span class="op" id="1137157">(</span><span class="num" id="1137158">1</span><span class="op" id="1137159">,</span>&nbsp;<span class="num" id="1137161">1</span><span class="op" id="1137162">,</span>&nbsp;<span class="ident" id="1137164">n</span><span class="op" id="1137165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137168">HammerRWMutex</span><span class="op" id="1137181">(</span><span class="num" id="1137182">1</span><span class="op" id="1137183">,</span>&nbsp;<span class="num" id="1137185">3</span><span class="op" id="1137186">,</span>&nbsp;<span class="ident" id="1137188">n</span><span class="op" id="1137189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137192">HammerRWMutex</span><span class="op" id="1137205">(</span><span class="num" id="1137206">1</span><span class="op" id="1137207">,</span>&nbsp;<span class="num" id="1137209">10</span><span class="op" id="1137211">,</span>&nbsp;<span class="ident" id="1137213">n</span><span class="op" id="1137214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137217">HammerRWMutex</span><span class="op" id="1137230">(</span><span class="num" id="1137231">4</span><span class="op" id="1137232">,</span>&nbsp;<span class="num" id="1137234">1</span><span class="op" id="1137235">,</span>&nbsp;<span class="ident" id="1137237">n</span><span class="op" id="1137238">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137241">HammerRWMutex</span><span class="op" id="1137254">(</span><span class="num" id="1137255">4</span><span class="op" id="1137256">,</span>&nbsp;<span class="num" id="1137258">3</span><span class="op" id="1137259">,</span>&nbsp;<span class="ident" id="1137261">n</span><span class="op" id="1137262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137265">HammerRWMutex</span><span class="op" id="1137278">(</span><span class="num" id="1137279">4</span><span class="op" id="1137280">,</span>&nbsp;<span class="num" id="1137282">10</span><span class="op" id="1137284">,</span>&nbsp;<span class="ident" id="1137286">n</span><span class="op" id="1137287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137290">HammerRWMutex</span><span class="op" id="1137303">(</span><span class="num" id="1137304">10</span><span class="op" id="1137306">,</span>&nbsp;<span class="num" id="1137308">1</span><span class="op" id="1137309">,</span>&nbsp;<span class="ident" id="1137311">n</span><span class="op" id="1137312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137315">HammerRWMutex</span><span class="op" id="1137328">(</span><span class="num" id="1137329">10</span><span class="op" id="1137331">,</span>&nbsp;<span class="num" id="1137333">3</span><span class="op" id="1137334">,</span>&nbsp;<span class="ident" id="1137336">n</span><span class="op" id="1137337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137340">HammerRWMutex</span><span class="op" id="1137353">(</span><span class="num" id="1137354">10</span><span class="op" id="1137356">,</span>&nbsp;<span class="num" id="1137358">10</span><span class="op" id="1137360">,</span>&nbsp;<span class="ident" id="1137362">n</span><span class="op" id="1137363">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137366">HammerRWMutex</span><span class="op" id="1137379">(</span><span class="num" id="1137380">10</span><span class="op" id="1137382">,</span>&nbsp;<span class="num" id="1137384">5</span><span class="op" id="1137385">,</span>&nbsp;<span class="ident" id="1137387">n</span><span class="op" id="1137388">)</span><br>
<span class="lineno"></span><span class="op" id="1137390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1137393">func</span>&nbsp;<span class="ident" id="1137398">TestRLocker</span><span class="op" id="1137409">(</span><span class="ident" id="1137410">t</span>&nbsp;<span class="op" id="1137412">*</span><span class="ident" id="1137413">testing</span><span class="op" id="1137420">.</span><span class="ident" id="1137421">T</span><span class="op" id="1137422">)</span>&nbsp;<span class="op" id="1137424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137427">var</span>&nbsp;<span class="ident" id="1137431">wl</span>&nbsp;<span class="ident" id="1137434">RWMutex</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137443">var</span>&nbsp;<span class="ident" id="1137447">rl</span>&nbsp;<span class="ident" id="1137450">Locker</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137458">wlocked</span>&nbsp;<span class="op" id="1137466">:=</span>&nbsp;<span class="builtinfunc" id="1137469">make</span><span class="op" id="1137473">(</span><span class="keyword" id="1137474">chan</span>&nbsp;<span class="builtintype" id="1137479">bool</span><span class="op" id="1137483">,</span>&nbsp;<span class="num" id="1137485">1</span><span class="op" id="1137486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137489">rlocked</span>&nbsp;<span class="op" id="1137497">:=</span>&nbsp;<span class="builtinfunc" id="1137500">make</span><span class="op" id="1137504">(</span><span class="keyword" id="1137505">chan</span>&nbsp;<span class="builtintype" id="1137510">bool</span><span class="op" id="1137514">,</span>&nbsp;<span class="num" id="1137516">1</span><span class="op" id="1137517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137520">rl</span>&nbsp;<span class="op" id="1137523">=</span>&nbsp;<span class="ident" id="1137525">wl</span><span class="op" id="1137527">.</span><span class="ident" id="1137528">RLocker</span><span class="op" id="1137535">(</span><span class="op" id="1137536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137539">n</span>&nbsp;<span class="op" id="1137541">:=</span>&nbsp;<span class="num" id="1137544">10</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137548">go</span>&nbsp;<span class="keyword" id="1137551">func</span><span class="op" id="1137555">(</span><span class="op" id="1137556">)</span>&nbsp;<span class="op" id="1137558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137562">for</span>&nbsp;<span class="ident" id="1137566">i</span>&nbsp;<span class="op" id="1137568">:=</span>&nbsp;<span class="num" id="1137571">0</span><span class="op" id="1137572">;</span>&nbsp;<span class="ident" id="1137574">i</span>&nbsp;<span class="op" id="1137576">&lt;</span>&nbsp;<span class="ident" id="1137578">n</span><span class="op" id="1137579">;</span>&nbsp;<span class="ident" id="1137581">i</span><span class="op" id="1137582">++</span>&nbsp;<span class="op" id="1137585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137590">rl</span><span class="op" id="1137592">.</span><span class="ident" id="1137593">Lock</span><span class="op" id="1137597">(</span><span class="op" id="1137598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137603">rl</span><span class="op" id="1137605">.</span><span class="ident" id="1137606">Lock</span><span class="op" id="1137610">(</span><span class="op" id="1137611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137616">rlocked</span>&nbsp;<span class="op" id="1137624">&lt;-</span>&nbsp;<span class="builtintype" id="1137627">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137635">wl</span><span class="op" id="1137637">.</span><span class="ident" id="1137638">Lock</span><span class="op" id="1137642">(</span><span class="op" id="1137643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137648">wlocked</span>&nbsp;<span class="op" id="1137656">&lt;-</span>&nbsp;<span class="builtintype" id="1137659">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137669">}</span><span class="op" id="1137670">(</span><span class="op" id="1137671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137674">for</span>&nbsp;<span class="ident" id="1137678">i</span>&nbsp;<span class="op" id="1137680">:=</span>&nbsp;<span class="num" id="1137683">0</span><span class="op" id="1137684">;</span>&nbsp;<span class="ident" id="1137686">i</span>&nbsp;<span class="op" id="1137688">&lt;</span>&nbsp;<span class="ident" id="1137690">n</span><span class="op" id="1137691">;</span>&nbsp;<span class="ident" id="1137693">i</span><span class="op" id="1137694">++</span>&nbsp;<span class="op" id="1137697">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137701">&lt;-</span><span class="ident" id="1137703">rlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137713">rl</span><span class="op" id="1137715">.</span><span class="ident" id="1137716">Unlock</span><span class="op" id="1137722">(</span><span class="op" id="1137723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137727">select</span>&nbsp;<span class="op" id="1137734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137738">case</span>&nbsp;<span class="op" id="1137743">&lt;-</span><span class="ident" id="1137745">wlocked</span><span class="op" id="1137752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137757">t</span><span class="op" id="1137758">.</span><span class="ident" id="1137759">Fatal</span><span class="op" id="1137764">(</span><span class="string" id="1137765">&#34;RLocker()&nbsp;didn&#39;t&nbsp;read-lock&nbsp;it&#34;</span><span class="op" id="1137796">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137800">default</span><span class="op" id="1137807">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137811">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137815">rl</span><span class="op" id="1137817">.</span><span class="ident" id="1137818">Unlock</span><span class="op" id="1137824">(</span><span class="op" id="1137825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137829">&lt;-</span><span class="ident" id="1137831">wlocked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137841">select</span>&nbsp;<span class="op" id="1137848">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137852">case</span>&nbsp;<span class="op" id="1137857">&lt;-</span><span class="ident" id="1137859">rlocked</span><span class="op" id="1137866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137871">t</span><span class="op" id="1137872">.</span><span class="ident" id="1137873">Fatal</span><span class="op" id="1137878">(</span><span class="string" id="1137879">&#34;RLocker()&nbsp;didn&#39;t&nbsp;respect&nbsp;the&nbsp;write&nbsp;lock&#34;</span><span class="op" id="1137920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137924">default</span><span class="op" id="1137931">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1137939">wl</span><span class="op" id="1137941">.</span><span class="ident" id="1137942">Unlock</span><span class="op" id="1137948">(</span><span class="op" id="1137949">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1137952">}</span><br>
<span class="lineno"></span><span class="op" id="1137954">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1137957">func</span>&nbsp;<span class="ident" id="1137962">TestUnlockPanic</span><span class="op" id="1137977">(</span><span class="ident" id="1137978">t</span>&nbsp;<span class="op" id="1137980">*</span><span class="ident" id="1137981">testing</span><span class="op" id="1137988">.</span><span class="ident" id="1137989">T</span><span class="op" id="1137990">)</span>&nbsp;<span class="op" id="1137992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1137995">defer</span>&nbsp;<span class="keyword" id="1138001">func</span><span class="op" id="1138005">(</span><span class="op" id="1138006">)</span>&nbsp;<span class="op" id="1138008">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138012">if</span>&nbsp;<span class="builtinfunc" id="1138015">recover</span><span class="op" id="1138022">(</span><span class="op" id="1138023">)</span>&nbsp;<span class="op" id="1138025">==</span>&nbsp;<span class="builtintype" id="1138028">nil</span>&nbsp;<span class="op" id="1138032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138037">t</span><span class="op" id="1138038">.</span><span class="ident" id="1138039">Fatalf</span><span class="op" id="1138045">(</span><span class="string" id="1138046">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&nbsp;did&nbsp;not&nbsp;panic&#34;</span><span class="op" id="1138088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138095">}</span><span class="op" id="1138096">(</span><span class="op" id="1138097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138100">var</span>&nbsp;<span class="ident" id="1138104">mu</span>&nbsp;<span class="ident" id="1138107">RWMutex</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138116">mu</span><span class="op" id="1138118">.</span><span class="ident" id="1138119">Unlock</span><span class="op" id="1138125">(</span><span class="op" id="1138126">)</span><br>
<span class="lineno"></span><span class="op" id="1138128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1138131">func</span>&nbsp;<span class="ident" id="1138136">TestUnlockPanic2</span><span class="op" id="1138152">(</span><span class="ident" id="1138153">t</span>&nbsp;<span class="op" id="1138155">*</span><span class="ident" id="1138156">testing</span><span class="op" id="1138163">.</span><span class="ident" id="1138164">T</span><span class="op" id="1138165">)</span>&nbsp;<span class="op" id="1138167">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138170">defer</span>&nbsp;<span class="keyword" id="1138176">func</span><span class="op" id="1138180">(</span><span class="op" id="1138181">)</span>&nbsp;<span class="op" id="1138183">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138187">if</span>&nbsp;<span class="builtinfunc" id="1138190">recover</span><span class="op" id="1138197">(</span><span class="op" id="1138198">)</span>&nbsp;<span class="op" id="1138200">==</span>&nbsp;<span class="builtintype" id="1138203">nil</span>&nbsp;<span class="op" id="1138207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138212">t</span><span class="op" id="1138213">.</span><span class="ident" id="1138214">Fatalf</span><span class="op" id="1138220">(</span><span class="string" id="1138221">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&nbsp;did&nbsp;not&nbsp;panic&#34;</span><span class="op" id="1138263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138270">}</span><span class="op" id="1138271">(</span><span class="op" id="1138272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138275">var</span>&nbsp;<span class="ident" id="1138279">mu</span>&nbsp;<span class="ident" id="1138282">RWMutex</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138291">mu</span><span class="op" id="1138293">.</span><span class="ident" id="1138294">RLock</span><span class="op" id="1138299">(</span><span class="op" id="1138300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138303">mu</span><span class="op" id="1138305">.</span><span class="ident" id="1138306">Unlock</span><span class="op" id="1138312">(</span><span class="op" id="1138313">)</span><br>
<span class="lineno"></span><span class="op" id="1138315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1138318">func</span>&nbsp;<span class="ident" id="1138323">TestRUnlockPanic</span><span class="op" id="1138339">(</span><span class="ident" id="1138340">t</span>&nbsp;<span class="op" id="1138342">*</span><span class="ident" id="1138343">testing</span><span class="op" id="1138350">.</span><span class="ident" id="1138351">T</span><span class="op" id="1138352">)</span>&nbsp;<span class="op" id="1138354">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138357">defer</span>&nbsp;<span class="keyword" id="1138363">func</span><span class="op" id="1138367">(</span><span class="op" id="1138368">)</span>&nbsp;<span class="op" id="1138370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138374">if</span>&nbsp;<span class="builtinfunc" id="1138377">recover</span><span class="op" id="1138384">(</span><span class="op" id="1138385">)</span>&nbsp;<span class="op" id="1138387">==</span>&nbsp;<span class="builtintype" id="1138390">nil</span>&nbsp;<span class="op" id="1138394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138399">t</span><span class="op" id="1138400">.</span><span class="ident" id="1138401">Fatalf</span><span class="op" id="1138407">(</span><span class="string" id="1138408">&#34;read&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&nbsp;did&nbsp;not&nbsp;panic&#34;</span><span class="op" id="1138455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138462">}</span><span class="op" id="1138463">(</span><span class="op" id="1138464">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138467">var</span>&nbsp;<span class="ident" id="1138471">mu</span>&nbsp;<span class="ident" id="1138474">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138483">mu</span><span class="op" id="1138485">.</span><span class="ident" id="1138486">RUnlock</span><span class="op" id="1138493">(</span><span class="op" id="1138494">)</span><br>
<span class="lineno"></span><span class="op" id="1138496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1138499">func</span>&nbsp;<span class="ident" id="1138504">TestRUnlockPanic2</span><span class="op" id="1138521">(</span><span class="ident" id="1138522">t</span>&nbsp;<span class="op" id="1138524">*</span><span class="ident" id="1138525">testing</span><span class="op" id="1138532">.</span><span class="ident" id="1138533">T</span><span class="op" id="1138534">)</span>&nbsp;<span class="op" id="1138536">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138539">defer</span>&nbsp;<span class="keyword" id="1138545">func</span><span class="op" id="1138549">(</span><span class="op" id="1138550">)</span>&nbsp;<span class="op" id="1138552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138556">if</span>&nbsp;<span class="builtinfunc" id="1138559">recover</span><span class="op" id="1138566">(</span><span class="op" id="1138567">)</span>&nbsp;<span class="op" id="1138569">==</span>&nbsp;<span class="builtintype" id="1138572">nil</span>&nbsp;<span class="op" id="1138576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138581">t</span><span class="op" id="1138582">.</span><span class="ident" id="1138583">Fatalf</span><span class="op" id="1138589">(</span><span class="string" id="1138590">&#34;read&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&nbsp;did&nbsp;not&nbsp;panic&#34;</span><span class="op" id="1138637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138644">}</span><span class="op" id="1138645">(</span><span class="op" id="1138646">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138649">var</span>&nbsp;<span class="ident" id="1138653">mu</span>&nbsp;<span class="ident" id="1138656">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138665">mu</span><span class="op" id="1138667">.</span><span class="ident" id="1138668">Lock</span><span class="op" id="1138672">(</span><span class="op" id="1138673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138676">mu</span><span class="op" id="1138678">.</span><span class="ident" id="1138679">RUnlock</span><span class="op" id="1138686">(</span><span class="op" id="1138687">)</span><br>
<span class="lineno"></span><span class="op" id="1138689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="1138692">func</span>&nbsp;<span class="ident" id="1138697">BenchmarkRWMutexUncontended</span><span class="op" id="1138724">(</span><span class="ident" id="1138725">b</span>&nbsp;<span class="op" id="1138727">*</span><span class="ident" id="1138728">testing</span><span class="op" id="1138735">.</span><span class="ident" id="1138736">B</span><span class="op" id="1138737">)</span>&nbsp;<span class="op" id="1138739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138742">type</span>&nbsp;<span class="ident" id="1138747">PaddedRWMutex</span>&nbsp;<span class="keyword" id="1138761">struct</span>&nbsp;<span class="op" id="1138768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138772">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138782">pad</span>&nbsp;<span class="op" id="1138786">[</span><span class="num" id="1138787">32</span><span class="op" id="1138789">]</span><span class="builtintype" id="1138790">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138798">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138801">b</span><span class="op" id="1138802">.</span><span class="ident" id="1138803">RunParallel</span><span class="op" id="1138814">(</span><span class="keyword" id="1138815">func</span><span class="op" id="1138819">(</span><span class="ident" id="1138820">pb</span>&nbsp;<span class="op" id="1138823">*</span><span class="ident" id="1138824">testing</span><span class="op" id="1138831">.</span><span class="ident" id="1138832">PB</span><span class="op" id="1138834">)</span>&nbsp;<span class="op" id="1138836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138840">var</span>&nbsp;<span class="ident" id="1138844">rwm</span>&nbsp;<span class="ident" id="1138848">PaddedRWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1138864">for</span>&nbsp;<span class="ident" id="1138868">pb</span><span class="op" id="1138870">.</span><span class="ident" id="1138871">Next</span><span class="op" id="1138875">(</span><span class="op" id="1138876">)</span>&nbsp;<span class="op" id="1138878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138883">rwm</span><span class="op" id="1138886">.</span><span class="ident" id="1138887">RLock</span><span class="op" id="1138892">(</span><span class="op" id="1138893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138898">rwm</span><span class="op" id="1138901">.</span><span class="ident" id="1138902">RLock</span><span class="op" id="1138907">(</span><span class="op" id="1138908">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138913">rwm</span><span class="op" id="1138916">.</span><span class="ident" id="1138917">RUnlock</span><span class="op" id="1138924">(</span><span class="op" id="1138925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138930">rwm</span><span class="op" id="1138933">.</span><span class="ident" id="1138934">RUnlock</span><span class="op" id="1138941">(</span><span class="op" id="1138942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138947">rwm</span><span class="op" id="1138950">.</span><span class="ident" id="1138951">Lock</span><span class="op" id="1138955">(</span><span class="op" id="1138956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1138961">rwm</span><span class="op" id="1138964">.</span><span class="ident" id="1138965">Unlock</span><span class="op" id="1138971">(</span><span class="op" id="1138972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138976">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1138979">}</span><span class="op" id="1138980">)</span><br>
<span class="lineno"></span><span class="op" id="1138982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1138985">func</span>&nbsp;<span class="ident" id="1138990">benchmarkRWMutex</span><span class="op" id="1139006">(</span><span class="ident" id="1139007">b</span>&nbsp;<span class="op" id="1139009">*</span><span class="ident" id="1139010">testing</span><span class="op" id="1139017">.</span><span class="ident" id="1139018">B</span><span class="op" id="1139019">,</span>&nbsp;<span class="ident" id="1139021">localWork</span><span class="op" id="1139030">,</span>&nbsp;<span class="ident" id="1139032">writeRatio</span>&nbsp;<span class="builtintype" id="1139043">int</span><span class="op" id="1139046">)</span>&nbsp;<span class="op" id="1139048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1139051">var</span>&nbsp;<span class="ident" id="1139055">rwm</span>&nbsp;<span class="ident" id="1139059">RWMutex</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139068">b</span><span class="op" id="1139069">.</span><span class="ident" id="1139070">RunParallel</span><span class="op" id="1139081">(</span><span class="keyword" id="1139082">func</span><span class="op" id="1139086">(</span><span class="ident" id="1139087">pb</span>&nbsp;<span class="op" id="1139090">*</span><span class="ident" id="1139091">testing</span><span class="op" id="1139098">.</span><span class="ident" id="1139099">PB</span><span class="op" id="1139101">)</span>&nbsp;<span class="op" id="1139103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139107">foo</span>&nbsp;<span class="op" id="1139111">:=</span>&nbsp;<span class="num" id="1139114">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1139118">for</span>&nbsp;<span class="ident" id="1139122">pb</span><span class="op" id="1139124">.</span><span class="ident" id="1139125">Next</span><span class="op" id="1139129">(</span><span class="op" id="1139130">)</span>&nbsp;<span class="op" id="1139132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139137">foo</span><span class="op" id="1139140">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1139146">if</span>&nbsp;<span class="ident" id="1139149">foo</span><span class="op" id="1139152">%</span><span class="ident" id="1139153">writeRatio</span>&nbsp;<span class="op" id="1139164">==</span>&nbsp;<span class="num" id="1139167">0</span>&nbsp;<span class="op" id="1139169">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139175">rwm</span><span class="op" id="1139178">.</span><span class="ident" id="1139179">Lock</span><span class="op" id="1139183">(</span><span class="op" id="1139184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139190">rwm</span><span class="op" id="1139193">.</span><span class="ident" id="1139194">Unlock</span><span class="op" id="1139200">(</span><span class="op" id="1139201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1139206">}</span>&nbsp;<span class="keyword" id="1139208">else</span>&nbsp;<span class="op" id="1139213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139219">rwm</span><span class="op" id="1139222">.</span><span class="ident" id="1139223">RLock</span><span class="op" id="1139228">(</span><span class="op" id="1139229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1139235">for</span>&nbsp;<span class="ident" id="1139239">i</span>&nbsp;<span class="op" id="1139241">:=</span>&nbsp;<span class="num" id="1139244">0</span><span class="op" id="1139245">;</span>&nbsp;<span class="ident" id="1139247">i</span>&nbsp;<span class="op" id="1139249">!=</span>&nbsp;<span class="ident" id="1139252">localWork</span><span class="op" id="1139261">;</span>&nbsp;<span class="ident" id="1139263">i</span>&nbsp;<span class="op" id="1139265">+=</span>&nbsp;<span class="num" id="1139268">1</span>&nbsp;<span class="op" id="1139270">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139277">foo</span>&nbsp;<span class="op" id="1139281">*=</span>&nbsp;<span class="num" id="1139284">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139291">foo</span>&nbsp;<span class="op" id="1139295">/=</span>&nbsp;<span class="num" id="1139298">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1139304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139310">rwm</span><span class="op" id="1139313">.</span><span class="ident" id="1139314">RUnlock</span><span class="op" id="1139321">(</span><span class="op" id="1139322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1139327">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1139331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139335">_</span>&nbsp;<span class="op" id="1139337">=</span>&nbsp;<span class="ident" id="1139339">foo</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1139344">}</span><span class="op" id="1139345">)</span><br>
<span class="lineno"></span><span class="op" id="1139347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span><span class="keyword" id="1139350">func</span>&nbsp;<span class="ident" id="1139355">BenchmarkRWMutexWrite100</span><span class="op" id="1139379">(</span><span class="ident" id="1139380">b</span>&nbsp;<span class="op" id="1139382">*</span><span class="ident" id="1139383">testing</span><span class="op" id="1139390">.</span><span class="ident" id="1139391">B</span><span class="op" id="1139392">)</span>&nbsp;<span class="op" id="1139394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139397">benchmarkRWMutex</span><span class="op" id="1139413">(</span><span class="ident" id="1139414">b</span><span class="op" id="1139415">,</span>&nbsp;<span class="num" id="1139417">0</span><span class="op" id="1139418">,</span>&nbsp;<span class="num" id="1139420">100</span><span class="op" id="1139423">)</span><br>
<span class="lineno"></span><span class="op" id="1139425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1139428">func</span>&nbsp;<span class="ident" id="1139433">BenchmarkRWMutexWrite10</span><span class="op" id="1139456">(</span><span class="ident" id="1139457">b</span>&nbsp;<span class="op" id="1139459">*</span><span class="ident" id="1139460">testing</span><span class="op" id="1139467">.</span><span class="ident" id="1139468">B</span><span class="op" id="1139469">)</span>&nbsp;<span class="op" id="1139471">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139474">benchmarkRWMutex</span><span class="op" id="1139490">(</span><span class="ident" id="1139491">b</span><span class="op" id="1139492">,</span>&nbsp;<span class="num" id="1139494">0</span><span class="op" id="1139495">,</span>&nbsp;<span class="num" id="1139497">10</span><span class="op" id="1139499">)</span><br>
<span class="lineno"></span><span class="op" id="1139501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1139504">func</span>&nbsp;<span class="ident" id="1139509">BenchmarkRWMutexWorkWrite100</span><span class="op" id="1139537">(</span><span class="ident" id="1139538">b</span>&nbsp;<span class="op" id="1139540">*</span><span class="ident" id="1139541">testing</span><span class="op" id="1139548">.</span><span class="ident" id="1139549">B</span><span class="op" id="1139550">)</span>&nbsp;<span class="op" id="1139552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139555">benchmarkRWMutex</span><span class="op" id="1139571">(</span><span class="ident" id="1139572">b</span><span class="op" id="1139573">,</span>&nbsp;<span class="num" id="1139575">100</span><span class="op" id="1139578">,</span>&nbsp;<span class="num" id="1139580">100</span><span class="op" id="1139583">)</span><br>
<span class="lineno">250</span><span class="op" id="1139585">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1139588">func</span>&nbsp;<span class="ident" id="1139593">BenchmarkRWMutexWorkWrite10</span><span class="op" id="1139620">(</span><span class="ident" id="1139621">b</span>&nbsp;<span class="op" id="1139623">*</span><span class="ident" id="1139624">testing</span><span class="op" id="1139631">.</span><span class="ident" id="1139632">B</span><span class="op" id="1139633">)</span>&nbsp;<span class="op" id="1139635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1139638">benchmarkRWMutex</span><span class="op" id="1139654">(</span><span class="ident" id="1139655">b</span><span class="op" id="1139656">,</span>&nbsp;<span class="num" id="1139658">100</span><span class="op" id="1139661">,</span>&nbsp;<span class="num" id="1139663">10</span><span class="op" id="1139665">)</span><br>
<span class="lineno"></span><span class="op" id="1139667">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
