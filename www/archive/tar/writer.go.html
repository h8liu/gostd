<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6039870">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6039925">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6039979">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6040030">package</span>&nbsp;<span class="ident" id="6040038">tar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6040043">//&nbsp;TODO(dsymonds):</span><br>
<span class="lineno"></span><span class="comment" id="6040062">//&nbsp;-&nbsp;catch&nbsp;more&nbsp;errors&nbsp;(no&nbsp;first&nbsp;header,&nbsp;etc.)</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="6040110">import</span>&nbsp;<span class="op" id="6040117">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040120">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040129">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040139">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040146">&#34;io&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040152">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040158">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040166">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040177">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6040188">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="6040195">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6040198">var</span>&nbsp;<span class="op" id="6040202">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040205">ErrWriteTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6040224">=</span>&nbsp;<span class="ident" id="6040226">errors</span><span class="op" id="6040232">.</span><span class="ident" id="6040233">New</span><span class="op" id="6040236">(</span><span class="string" id="6040237">&#34;archive/tar:&nbsp;write&nbsp;too&nbsp;long&#34;</span><span class="op" id="6040266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040269">ErrFieldTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6040288">=</span>&nbsp;<span class="ident" id="6040290">errors</span><span class="op" id="6040296">.</span><span class="ident" id="6040297">New</span><span class="op" id="6040300">(</span><span class="string" id="6040301">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&#34;</span><span class="op" id="6040337">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040340">ErrWriteAfterClose</span>&nbsp;<span class="op" id="6040359">=</span>&nbsp;<span class="ident" id="6040361">errors</span><span class="op" id="6040367">.</span><span class="ident" id="6040368">New</span><span class="op" id="6040371">(</span><span class="string" id="6040372">&#34;archive/tar:&nbsp;write&nbsp;after&nbsp;close&#34;</span><span class="op" id="6040404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040407">errNameTooLong</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6040426">=</span>&nbsp;<span class="ident" id="6040428">errors</span><span class="op" id="6040434">.</span><span class="ident" id="6040435">New</span><span class="op" id="6040438">(</span><span class="string" id="6040439">&#34;archive/tar:&nbsp;name&nbsp;too&nbsp;long&#34;</span><span class="op" id="6040467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040470">errInvalidHeader</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6040489">=</span>&nbsp;<span class="ident" id="6040491">errors</span><span class="op" id="6040497">.</span><span class="ident" id="6040498">New</span><span class="op" id="6040501">(</span><span class="string" id="6040502">&#34;archive/tar:&nbsp;header&nbsp;field&nbsp;too&nbsp;long&nbsp;or&nbsp;contains&nbsp;invalid&nbsp;values&#34;</span><span class="op" id="6040565">)</span><br>
<span class="lineno"></span><span class="op" id="6040567">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="comment" id="6040570">//&nbsp;A&nbsp;Writer&nbsp;provides&nbsp;sequential&nbsp;writing&nbsp;of&nbsp;a&nbsp;tar&nbsp;archive&nbsp;in&nbsp;POSIX.1&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6040646">//&nbsp;A&nbsp;tar&nbsp;archive&nbsp;consists&nbsp;of&nbsp;a&nbsp;sequence&nbsp;of&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="6040696">//&nbsp;Call&nbsp;WriteHeader&nbsp;to&nbsp;begin&nbsp;a&nbsp;new&nbsp;file,&nbsp;and&nbsp;then&nbsp;call&nbsp;Write&nbsp;to&nbsp;supply&nbsp;that&nbsp;file&#39;s&nbsp;data,</span><br>
<span class="lineno"></span><span class="comment" id="6040785">//&nbsp;writing&nbsp;at&nbsp;most&nbsp;hdr.Size&nbsp;bytes&nbsp;in&nbsp;total.</span><br>
<span class="lineno"></span><span class="keyword" id="6040829">type</span>&nbsp;<span class="ident" id="6040834">Writer</span>&nbsp;<span class="keyword" id="6040841">struct</span>&nbsp;<span class="op" id="6040848">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040851">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6040862">io</span><span class="op" id="6040864">.</span><span class="ident" id="6040865">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040873">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6040884">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040891">nb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6040902">int64</span>&nbsp;<span class="comment" id="6040908">//&nbsp;number&nbsp;of&nbsp;unwritten&nbsp;bytes&nbsp;for&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6040961">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6040972">int64</span>&nbsp;<span class="comment" id="6040978">//&nbsp;amount&nbsp;of&nbsp;padding&nbsp;to&nbsp;write&nbsp;after&nbsp;current&nbsp;file&nbsp;entry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041034">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6041045">bool</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041051">usedBinary</span>&nbsp;<span class="builtintype" id="6041062">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041078">//&nbsp;whether&nbsp;the&nbsp;binary&nbsp;numeric&nbsp;field&nbsp;extension&nbsp;was&nbsp;used</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041134">preferPax</span>&nbsp;&nbsp;<span class="builtintype" id="6041145">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6041161">//&nbsp;use&nbsp;pax&nbsp;header&nbsp;instead&nbsp;of&nbsp;binary&nbsp;numeric&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041213">hdrBuff</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6041224">[</span><span class="ident" id="6041225">blockSize</span><span class="op" id="6041234">]</span><span class="builtintype" id="6041235">byte</span>&nbsp;<span class="comment" id="6041240">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;regular&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041303">paxHdrBuff</span>&nbsp;<span class="op" id="6041314">[</span><span class="ident" id="6041315">blockSize</span><span class="op" id="6041324">]</span><span class="builtintype" id="6041325">byte</span>&nbsp;<span class="comment" id="6041330">//&nbsp;buffer&nbsp;to&nbsp;use&nbsp;in&nbsp;writeHeader&nbsp;when&nbsp;writing&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span><span class="op" id="6041388">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="6041391">//&nbsp;NewWriter&nbsp;creates&nbsp;a&nbsp;new&nbsp;Writer&nbsp;writing&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6041439">func</span>&nbsp;<span class="ident" id="6041444">NewWriter</span><span class="op" id="6041453">(</span><span class="ident" id="6041454">w</span>&nbsp;<span class="ident" id="6041456">io</span><span class="op" id="6041458">.</span><span class="ident" id="6041459">Writer</span><span class="op" id="6041465">)</span>&nbsp;<span class="op" id="6041467">*</span><span class="ident" id="6041468">Writer</span>&nbsp;<span class="op" id="6041475">{</span>&nbsp;<span class="keyword" id="6041477">return</span>&nbsp;<span class="op" id="6041484">&amp;</span><span class="ident" id="6041485">Writer</span><span class="op" id="6041491">{</span><span class="ident" id="6041492">w</span><span class="op" id="6041493">:</span>&nbsp;<span class="ident" id="6041495">w</span><span class="op" id="6041496">}</span>&nbsp;<span class="op" id="6041498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6041501">//&nbsp;Flush&nbsp;finishes&nbsp;writing&nbsp;the&nbsp;current&nbsp;file&nbsp;(optional).</span><br>
<span class="lineno">50</span><span class="keyword" id="6041556">func</span>&nbsp;<span class="op" id="6041561">(</span><span class="ident" id="6041562">tw</span>&nbsp;<span class="op" id="6041565">*</span><span class="ident" id="6041566">Writer</span><span class="op" id="6041572">)</span>&nbsp;<span class="ident" id="6041574">Flush</span><span class="op" id="6041579">(</span><span class="op" id="6041580">)</span>&nbsp;<span class="builtintype" id="6041582">error</span>&nbsp;<span class="op" id="6041588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041591">if</span>&nbsp;<span class="ident" id="6041594">tw</span><span class="op" id="6041596">.</span><span class="ident" id="6041597">nb</span>&nbsp;<span class="op" id="6041600">&gt;</span>&nbsp;<span class="num" id="6041602">0</span>&nbsp;<span class="op" id="6041604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041608">tw</span><span class="op" id="6041610">.</span><span class="ident" id="6041611">err</span>&nbsp;<span class="op" id="6041615">=</span>&nbsp;<span class="ident" id="6041617">fmt</span><span class="op" id="6041620">.</span><span class="ident" id="6041621">Errorf</span><span class="op" id="6041627">(</span><span class="string" id="6041628">&#34;archive/tar:&nbsp;missed&nbsp;writing&nbsp;%d&nbsp;bytes&#34;</span><span class="op" id="6041666">,</span>&nbsp;<span class="ident" id="6041668">tw</span><span class="op" id="6041670">.</span><span class="ident" id="6041671">nb</span><span class="op" id="6041673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041677">return</span>&nbsp;<span class="ident" id="6041684">tw</span><span class="op" id="6041686">.</span><span class="ident" id="6041687">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041692">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041696">n</span>&nbsp;<span class="op" id="6041698">:=</span>&nbsp;<span class="ident" id="6041701">tw</span><span class="op" id="6041703">.</span><span class="ident" id="6041704">nb</span>&nbsp;<span class="op" id="6041707">+</span>&nbsp;<span class="ident" id="6041709">tw</span><span class="op" id="6041711">.</span><span class="ident" id="6041712">pad</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041717">for</span>&nbsp;<span class="ident" id="6041721">n</span>&nbsp;<span class="op" id="6041723">&gt;</span>&nbsp;<span class="num" id="6041725">0</span>&nbsp;<span class="op" id="6041727">&amp;&amp;</span>&nbsp;<span class="ident" id="6041730">tw</span><span class="op" id="6041732">.</span><span class="ident" id="6041733">err</span>&nbsp;<span class="op" id="6041737">==</span>&nbsp;<span class="ident" id="6041740">nil</span>&nbsp;<span class="op" id="6041744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041748">nr</span>&nbsp;<span class="op" id="6041751">:=</span>&nbsp;<span class="ident" id="6041754">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041758">if</span>&nbsp;<span class="ident" id="6041761">nr</span>&nbsp;<span class="op" id="6041764">&gt;</span>&nbsp;<span class="ident" id="6041766">blockSize</span>&nbsp;<span class="op" id="6041776">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041781">nr</span>&nbsp;<span class="op" id="6041784">=</span>&nbsp;<span class="ident" id="6041786">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041802">var</span>&nbsp;<span class="ident" id="6041806">nw</span>&nbsp;<span class="builtintype" id="6041809">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041815">nw</span><span class="op" id="6041817">,</span>&nbsp;<span class="ident" id="6041819">tw</span><span class="op" id="6041821">.</span><span class="ident" id="6041822">err</span>&nbsp;<span class="op" id="6041826">=</span>&nbsp;<span class="ident" id="6041828">tw</span><span class="op" id="6041830">.</span><span class="ident" id="6041831">w</span><span class="op" id="6041832">.</span><span class="ident" id="6041833">Write</span><span class="op" id="6041838">(</span><span class="ident" id="6041839">zeroBlock</span><span class="op" id="6041848">[</span><span class="num" id="6041849">0</span><span class="op" id="6041850">:</span><span class="ident" id="6041851">nr</span><span class="op" id="6041853">]</span><span class="op" id="6041854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041858">n</span>&nbsp;<span class="op" id="6041860">-=</span>&nbsp;<span class="ident" id="6041863">int64</span><span class="op" id="6041868">(</span><span class="ident" id="6041869">nw</span><span class="op" id="6041871">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6041874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041877">tw</span><span class="op" id="6041879">.</span><span class="ident" id="6041880">nb</span>&nbsp;<span class="op" id="6041883">=</span>&nbsp;<span class="num" id="6041885">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6041888">tw</span><span class="op" id="6041890">.</span><span class="ident" id="6041891">pad</span>&nbsp;<span class="op" id="6041895">=</span>&nbsp;<span class="num" id="6041897">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6041900">return</span>&nbsp;<span class="ident" id="6041907">tw</span><span class="op" id="6041909">.</span><span class="ident" id="6041910">err</span><br>
<span class="lineno"></span><span class="op" id="6041914">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="6041917">//&nbsp;Write&nbsp;s&nbsp;into&nbsp;b,&nbsp;terminating&nbsp;it&nbsp;with&nbsp;a&nbsp;NUL&nbsp;if&nbsp;there&nbsp;is&nbsp;room.</span><br>
<span class="lineno"></span><span class="comment" id="6041980">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;allowPax&nbsp;is&nbsp;true&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6042074">func</span>&nbsp;<span class="op" id="6042079">(</span><span class="ident" id="6042080">tw</span>&nbsp;<span class="op" id="6042083">*</span><span class="ident" id="6042084">Writer</span><span class="op" id="6042090">)</span>&nbsp;<span class="ident" id="6042092">cString</span><span class="op" id="6042099">(</span><span class="ident" id="6042100">b</span>&nbsp;<span class="op" id="6042102">[</span><span class="op" id="6042103">]</span><span class="builtintype" id="6042104">byte</span><span class="op" id="6042108">,</span>&nbsp;<span class="ident" id="6042110">s</span>&nbsp;<span class="builtintype" id="6042112">string</span><span class="op" id="6042118">,</span>&nbsp;<span class="ident" id="6042120">allowPax</span>&nbsp;<span class="builtintype" id="6042129">bool</span><span class="op" id="6042133">,</span>&nbsp;<span class="ident" id="6042135">paxKeyword</span>&nbsp;<span class="builtintype" id="6042146">string</span><span class="op" id="6042152">,</span>&nbsp;<span class="ident" id="6042154">paxHeaders</span>&nbsp;<span class="keyword" id="6042165">map</span><span class="op" id="6042168">[</span><span class="builtintype" id="6042169">string</span><span class="op" id="6042175">]</span><span class="builtintype" id="6042176">string</span><span class="op" id="6042182">)</span>&nbsp;<span class="op" id="6042184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042187">needsPaxHeader</span>&nbsp;<span class="op" id="6042202">:=</span>&nbsp;<span class="ident" id="6042205">allowPax</span>&nbsp;<span class="op" id="6042214">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6042217">len</span><span class="op" id="6042220">(</span><span class="ident" id="6042221">s</span><span class="op" id="6042222">)</span>&nbsp;<span class="op" id="6042224">&gt;</span>&nbsp;<span class="builtinfunc" id="6042226">len</span><span class="op" id="6042229">(</span><span class="ident" id="6042230">b</span><span class="op" id="6042231">)</span>&nbsp;<span class="op" id="6042233">||</span>&nbsp;<span class="op" id="6042236">!</span><span class="ident" id="6042237">isASCII</span><span class="op" id="6042244">(</span><span class="ident" id="6042245">s</span><span class="op" id="6042246">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042249">if</span>&nbsp;<span class="ident" id="6042252">needsPaxHeader</span>&nbsp;<span class="op" id="6042267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042271">paxHeaders</span><span class="op" id="6042281">[</span><span class="ident" id="6042282">paxKeyword</span><span class="op" id="6042292">]</span>&nbsp;<span class="op" id="6042294">=</span>&nbsp;<span class="ident" id="6042296">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042300">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042311">if</span>&nbsp;<span class="builtinfunc" id="6042314">len</span><span class="op" id="6042317">(</span><span class="ident" id="6042318">s</span><span class="op" id="6042319">)</span>&nbsp;<span class="op" id="6042321">&gt;</span>&nbsp;<span class="builtinfunc" id="6042323">len</span><span class="op" id="6042326">(</span><span class="ident" id="6042327">b</span><span class="op" id="6042328">)</span>&nbsp;<span class="op" id="6042330">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042334">if</span>&nbsp;<span class="ident" id="6042337">tw</span><span class="op" id="6042339">.</span><span class="ident" id="6042340">err</span>&nbsp;<span class="op" id="6042344">==</span>&nbsp;<span class="ident" id="6042347">nil</span>&nbsp;<span class="op" id="6042351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042356">tw</span><span class="op" id="6042358">.</span><span class="ident" id="6042359">err</span>&nbsp;<span class="op" id="6042363">=</span>&nbsp;<span class="ident" id="6042365">ErrFieldTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042383">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042387">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042395">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042398">ascii</span>&nbsp;<span class="op" id="6042404">:=</span>&nbsp;<span class="ident" id="6042407">toASCII</span><span class="op" id="6042414">(</span><span class="ident" id="6042415">s</span><span class="op" id="6042416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6042419">copy</span><span class="op" id="6042423">(</span><span class="ident" id="6042424">b</span><span class="op" id="6042425">,</span>&nbsp;<span class="ident" id="6042427">ascii</span><span class="op" id="6042432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042435">if</span>&nbsp;<span class="builtinfunc" id="6042438">len</span><span class="op" id="6042441">(</span><span class="ident" id="6042442">ascii</span><span class="op" id="6042447">)</span>&nbsp;<span class="op" id="6042449">&lt;</span>&nbsp;<span class="builtinfunc" id="6042451">len</span><span class="op" id="6042454">(</span><span class="ident" id="6042455">b</span><span class="op" id="6042456">)</span>&nbsp;<span class="op" id="6042458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042462">b</span><span class="op" id="6042463">[</span><span class="builtinfunc" id="6042464">len</span><span class="op" id="6042467">(</span><span class="ident" id="6042468">ascii</span><span class="op" id="6042473">)</span><span class="op" id="6042474">]</span>&nbsp;<span class="op" id="6042476">=</span>&nbsp;<span class="num" id="6042478">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042481">}</span><br>
<span class="lineno">90</span><span class="op" id="6042483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6042486">//&nbsp;Encode&nbsp;x&nbsp;as&nbsp;an&nbsp;octal&nbsp;ASCII&nbsp;string&nbsp;and&nbsp;write&nbsp;it&nbsp;into&nbsp;b&nbsp;with&nbsp;leading&nbsp;zeros.</span><br>
<span class="lineno"></span><span class="keyword" id="6042563">func</span>&nbsp;<span class="op" id="6042568">(</span><span class="ident" id="6042569">tw</span>&nbsp;<span class="op" id="6042572">*</span><span class="ident" id="6042573">Writer</span><span class="op" id="6042579">)</span>&nbsp;<span class="ident" id="6042581">octal</span><span class="op" id="6042586">(</span><span class="ident" id="6042587">b</span>&nbsp;<span class="op" id="6042589">[</span><span class="op" id="6042590">]</span><span class="builtintype" id="6042591">byte</span><span class="op" id="6042595">,</span>&nbsp;<span class="ident" id="6042597">x</span>&nbsp;<span class="ident" id="6042599">int64</span><span class="op" id="6042604">)</span>&nbsp;<span class="op" id="6042606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042609">s</span>&nbsp;<span class="op" id="6042611">:=</span>&nbsp;<span class="ident" id="6042614">strconv</span><span class="op" id="6042621">.</span><span class="ident" id="6042622">FormatInt</span><span class="op" id="6042631">(</span><span class="ident" id="6042632">x</span><span class="op" id="6042633">,</span>&nbsp;<span class="num" id="6042635">8</span><span class="op" id="6042636">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6042639">//&nbsp;leading&nbsp;zeros,&nbsp;but&nbsp;leave&nbsp;room&nbsp;for&nbsp;a&nbsp;NUL.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6042684">for</span>&nbsp;<span class="builtinfunc" id="6042688">len</span><span class="op" id="6042691">(</span><span class="ident" id="6042692">s</span><span class="op" id="6042693">)</span><span class="op" id="6042694">+</span><span class="num" id="6042695">1</span>&nbsp;<span class="op" id="6042697">&lt;</span>&nbsp;<span class="builtinfunc" id="6042699">len</span><span class="op" id="6042702">(</span><span class="ident" id="6042703">b</span><span class="op" id="6042704">)</span>&nbsp;<span class="op" id="6042706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042710">s</span>&nbsp;<span class="op" id="6042712">=</span>&nbsp;<span class="string" id="6042714">&#34;0&#34;</span>&nbsp;<span class="op" id="6042718">+</span>&nbsp;<span class="ident" id="6042720">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6042723">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6042726">tw</span><span class="op" id="6042728">.</span><span class="ident" id="6042729">cString</span><span class="op" id="6042736">(</span><span class="ident" id="6042737">b</span><span class="op" id="6042738">,</span>&nbsp;<span class="ident" id="6042740">s</span><span class="op" id="6042741">,</span>&nbsp;<span class="ident" id="6042743">false</span><span class="op" id="6042748">,</span>&nbsp;<span class="ident" id="6042750">paxNone</span><span class="op" id="6042757">,</span>&nbsp;<span class="ident" id="6042759">nil</span><span class="op" id="6042762">)</span><br>
<span class="lineno">100</span><span class="op" id="6042764">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6042767">//&nbsp;Write&nbsp;x&nbsp;into&nbsp;b,&nbsp;either&nbsp;as&nbsp;octal&nbsp;or&nbsp;as&nbsp;binary&nbsp;(GNUtar/star&nbsp;extension).</span><br>
<span class="lineno"></span><span class="comment" id="6042840">//&nbsp;If&nbsp;the&nbsp;value&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;writingPax&nbsp;is&nbsp;enabled&nbsp;both&nbsp;for&nbsp;the&nbsp;field&nbsp;and&nbsp;the&nbsp;add&nbsp;a&nbsp;paxheader&nbsp;record&nbsp;instead</span><br>
<span class="lineno"></span><span class="keyword" id="6042966">func</span>&nbsp;<span class="op" id="6042971">(</span><span class="ident" id="6042972">tw</span>&nbsp;<span class="op" id="6042975">*</span><span class="ident" id="6042976">Writer</span><span class="op" id="6042982">)</span>&nbsp;<span class="ident" id="6042984">numeric</span><span class="op" id="6042991">(</span><span class="ident" id="6042992">b</span>&nbsp;<span class="op" id="6042994">[</span><span class="op" id="6042995">]</span><span class="builtintype" id="6042996">byte</span><span class="op" id="6043000">,</span>&nbsp;<span class="ident" id="6043002">x</span>&nbsp;<span class="ident" id="6043004">int64</span><span class="op" id="6043009">,</span>&nbsp;<span class="ident" id="6043011">allowPax</span>&nbsp;<span class="builtintype" id="6043020">bool</span><span class="op" id="6043024">,</span>&nbsp;<span class="ident" id="6043026">paxKeyword</span>&nbsp;<span class="builtintype" id="6043037">string</span><span class="op" id="6043043">,</span>&nbsp;<span class="ident" id="6043045">paxHeaders</span>&nbsp;<span class="keyword" id="6043056">map</span><span class="op" id="6043059">[</span><span class="builtintype" id="6043060">string</span><span class="op" id="6043066">]</span><span class="builtintype" id="6043067">string</span><span class="op" id="6043073">)</span>&nbsp;<span class="op" id="6043075">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043078">//&nbsp;Try&nbsp;octal&nbsp;first.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043099">s</span>&nbsp;<span class="op" id="6043101">:=</span>&nbsp;<span class="ident" id="6043104">strconv</span><span class="op" id="6043111">.</span><span class="ident" id="6043112">FormatInt</span><span class="op" id="6043121">(</span><span class="ident" id="6043122">x</span><span class="op" id="6043123">,</span>&nbsp;<span class="num" id="6043125">8</span><span class="op" id="6043126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043129">if</span>&nbsp;<span class="builtinfunc" id="6043132">len</span><span class="op" id="6043135">(</span><span class="ident" id="6043136">s</span><span class="op" id="6043137">)</span>&nbsp;<span class="op" id="6043139">&lt;</span>&nbsp;<span class="builtinfunc" id="6043141">len</span><span class="op" id="6043144">(</span><span class="ident" id="6043145">b</span><span class="op" id="6043146">)</span>&nbsp;<span class="op" id="6043148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043152">tw</span><span class="op" id="6043154">.</span><span class="ident" id="6043155">octal</span><span class="op" id="6043160">(</span><span class="ident" id="6043161">b</span><span class="op" id="6043162">,</span>&nbsp;<span class="ident" id="6043164">x</span><span class="op" id="6043165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043169">return</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043181">//&nbsp;If&nbsp;it&nbsp;is&nbsp;too&nbsp;long&nbsp;for&nbsp;octal,&nbsp;and&nbsp;pax&nbsp;is&nbsp;preferred,&nbsp;use&nbsp;a&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043253">if</span>&nbsp;<span class="ident" id="6043256">allowPax</span>&nbsp;<span class="op" id="6043265">&amp;&amp;</span>&nbsp;<span class="ident" id="6043268">tw</span><span class="op" id="6043270">.</span><span class="ident" id="6043271">preferPax</span>&nbsp;<span class="op" id="6043281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043285">tw</span><span class="op" id="6043287">.</span><span class="ident" id="6043288">octal</span><span class="op" id="6043293">(</span><span class="ident" id="6043294">b</span><span class="op" id="6043295">,</span>&nbsp;<span class="num" id="6043297">0</span><span class="op" id="6043298">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043302">s</span>&nbsp;<span class="op" id="6043304">:=</span>&nbsp;<span class="ident" id="6043307">strconv</span><span class="op" id="6043314">.</span><span class="ident" id="6043315">FormatInt</span><span class="op" id="6043324">(</span><span class="ident" id="6043325">x</span><span class="op" id="6043326">,</span>&nbsp;<span class="num" id="6043328">10</span><span class="op" id="6043330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043334">paxHeaders</span><span class="op" id="6043344">[</span><span class="ident" id="6043345">paxKeyword</span><span class="op" id="6043355">]</span>&nbsp;<span class="op" id="6043357">=</span>&nbsp;<span class="ident" id="6043359">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043363">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043375">//&nbsp;Too&nbsp;big:&nbsp;use&nbsp;binary&nbsp;(big-endian).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043413">tw</span><span class="op" id="6043415">.</span><span class="ident" id="6043416">usedBinary</span>&nbsp;<span class="op" id="6043427">=</span>&nbsp;<span class="ident" id="6043429">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043435">for</span>&nbsp;<span class="ident" id="6043439">i</span>&nbsp;<span class="op" id="6043441">:=</span>&nbsp;<span class="builtinfunc" id="6043444">len</span><span class="op" id="6043447">(</span><span class="ident" id="6043448">b</span><span class="op" id="6043449">)</span>&nbsp;<span class="op" id="6043451">-</span>&nbsp;<span class="num" id="6043453">1</span><span class="op" id="6043454">;</span>&nbsp;<span class="ident" id="6043456">x</span>&nbsp;<span class="op" id="6043458">&gt;</span>&nbsp;<span class="num" id="6043460">0</span>&nbsp;<span class="op" id="6043462">&amp;&amp;</span>&nbsp;<span class="ident" id="6043465">i</span>&nbsp;<span class="op" id="6043467">&gt;=</span>&nbsp;<span class="num" id="6043470">0</span><span class="op" id="6043471">;</span>&nbsp;<span class="ident" id="6043473">i</span><span class="op" id="6043474">--</span>&nbsp;<span class="op" id="6043477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043481">b</span><span class="op" id="6043482">[</span><span class="ident" id="6043483">i</span><span class="op" id="6043484">]</span>&nbsp;<span class="op" id="6043486">=</span>&nbsp;<span class="builtintype" id="6043488">byte</span><span class="op" id="6043492">(</span><span class="ident" id="6043493">x</span><span class="op" id="6043494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043498">x</span>&nbsp;<span class="op" id="6043500">&gt;&gt;=</span>&nbsp;<span class="num" id="6043504">8</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6043507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043510">b</span><span class="op" id="6043511">[</span><span class="num" id="6043512">0</span><span class="op" id="6043513">]</span>&nbsp;<span class="op" id="6043515">|=</span>&nbsp;<span class="num" id="6043518">0x80</span>&nbsp;<span class="comment" id="6043523">//&nbsp;highest&nbsp;bit&nbsp;indicates&nbsp;binary&nbsp;format</span><br>
<span class="lineno"></span><span class="op" id="6043562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6043565">var</span>&nbsp;<span class="op" id="6043569">(</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043572">minTime</span>&nbsp;<span class="op" id="6043580">=</span>&nbsp;<span class="ident" id="6043582">time</span><span class="op" id="6043586">.</span><span class="ident" id="6043587">Unix</span><span class="op" id="6043591">(</span><span class="num" id="6043592">0</span><span class="op" id="6043593">,</span>&nbsp;<span class="num" id="6043595">0</span><span class="op" id="6043596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6043599">//&nbsp;There&nbsp;is&nbsp;room&nbsp;for&nbsp;11&nbsp;octal&nbsp;digits&nbsp;(33&nbsp;bits)&nbsp;of&nbsp;mtime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6043657">maxTime</span>&nbsp;<span class="op" id="6043665">=</span>&nbsp;<span class="ident" id="6043667">minTime</span><span class="op" id="6043674">.</span><span class="ident" id="6043675">Add</span><span class="op" id="6043678">(</span><span class="op" id="6043679">(</span><span class="num" id="6043680">1</span><span class="op" id="6043681">&lt;&lt;</span><span class="num" id="6043683">33</span>&nbsp;<span class="op" id="6043686">-</span>&nbsp;<span class="num" id="6043688">1</span><span class="op" id="6043689">)</span>&nbsp;<span class="op" id="6043691">*</span>&nbsp;<span class="ident" id="6043693">time</span><span class="op" id="6043697">.</span><span class="ident" id="6043698">Second</span><span class="op" id="6043704">)</span><br>
<span class="lineno"></span><span class="op" id="6043706">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="comment" id="6043709">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6043779">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6043837">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno"></span><span class="keyword" id="6043894">func</span>&nbsp;<span class="op" id="6043899">(</span><span class="ident" id="6043900">tw</span>&nbsp;<span class="op" id="6043903">*</span><span class="ident" id="6043904">Writer</span><span class="op" id="6043910">)</span>&nbsp;<span class="ident" id="6043912">WriteHeader</span><span class="op" id="6043923">(</span><span class="ident" id="6043924">hdr</span>&nbsp;<span class="op" id="6043928">*</span><span class="ident" id="6043929">Header</span><span class="op" id="6043935">)</span>&nbsp;<span class="builtintype" id="6043937">error</span>&nbsp;<span class="op" id="6043943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6043946">return</span>&nbsp;<span class="ident" id="6043953">tw</span><span class="op" id="6043955">.</span><span class="ident" id="6043956">writeHeader</span><span class="op" id="6043967">(</span><span class="ident" id="6043968">hdr</span><span class="op" id="6043971">,</span>&nbsp;<span class="ident" id="6043973">true</span><span class="op" id="6043977">)</span><br>
<span class="lineno">140</span><span class="op" id="6043979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6043982">//&nbsp;WriteHeader&nbsp;writes&nbsp;hdr&nbsp;and&nbsp;prepares&nbsp;to&nbsp;accept&nbsp;the&nbsp;file&#39;s&nbsp;contents.</span><br>
<span class="lineno"></span><span class="comment" id="6044052">//&nbsp;WriteHeader&nbsp;calls&nbsp;Flush&nbsp;if&nbsp;it&nbsp;is&nbsp;not&nbsp;the&nbsp;first&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="6044110">//&nbsp;Calling&nbsp;after&nbsp;a&nbsp;Close&nbsp;will&nbsp;return&nbsp;ErrWriteAfterClose.</span><br>
<span class="lineno">145</span><span class="comment" id="6044167">//&nbsp;As&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;internally&nbsp;by&nbsp;writePax&nbsp;header&nbsp;to&nbsp;allow&nbsp;it&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="6044240">//&nbsp;suppress&nbsp;writing&nbsp;the&nbsp;pax&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6044276">func</span>&nbsp;<span class="op" id="6044281">(</span><span class="ident" id="6044282">tw</span>&nbsp;<span class="op" id="6044285">*</span><span class="ident" id="6044286">Writer</span><span class="op" id="6044292">)</span>&nbsp;<span class="ident" id="6044294">writeHeader</span><span class="op" id="6044305">(</span><span class="ident" id="6044306">hdr</span>&nbsp;<span class="op" id="6044310">*</span><span class="ident" id="6044311">Header</span><span class="op" id="6044317">,</span>&nbsp;<span class="ident" id="6044319">allowPax</span>&nbsp;<span class="builtintype" id="6044328">bool</span><span class="op" id="6044332">)</span>&nbsp;<span class="builtintype" id="6044334">error</span>&nbsp;<span class="op" id="6044340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044343">if</span>&nbsp;<span class="ident" id="6044346">tw</span><span class="op" id="6044348">.</span><span class="ident" id="6044349">closed</span>&nbsp;<span class="op" id="6044356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044360">return</span>&nbsp;<span class="ident" id="6044367">ErrWriteAfterClose</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044390">if</span>&nbsp;<span class="ident" id="6044393">tw</span><span class="op" id="6044395">.</span><span class="ident" id="6044396">err</span>&nbsp;<span class="op" id="6044400">==</span>&nbsp;<span class="ident" id="6044403">nil</span>&nbsp;<span class="op" id="6044407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044411">tw</span><span class="op" id="6044413">.</span><span class="ident" id="6044414">Flush</span><span class="op" id="6044419">(</span><span class="op" id="6044420">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044426">if</span>&nbsp;<span class="ident" id="6044429">tw</span><span class="op" id="6044431">.</span><span class="ident" id="6044432">err</span>&nbsp;<span class="op" id="6044436">!=</span>&nbsp;<span class="ident" id="6044439">nil</span>&nbsp;<span class="op" id="6044443">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044447">return</span>&nbsp;<span class="ident" id="6044454">tw</span><span class="op" id="6044456">.</span><span class="ident" id="6044457">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6044462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044466">//&nbsp;a&nbsp;map&nbsp;to&nbsp;hold&nbsp;pax&nbsp;header&nbsp;records,&nbsp;if&nbsp;any&nbsp;are&nbsp;needed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6044522">paxHeaders</span>&nbsp;<span class="op" id="6044533">:=</span>&nbsp;<span class="builtinfunc" id="6044536">make</span><span class="op" id="6044540">(</span><span class="keyword" id="6044541">map</span><span class="op" id="6044544">[</span><span class="builtintype" id="6044545">string</span><span class="op" id="6044551">]</span><span class="builtintype" id="6044552">string</span><span class="op" id="6044558">)</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044562">//&nbsp;TODO(shanemhansen):&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;PAX&nbsp;headers&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044623">//&nbsp;subsecond&nbsp;time&nbsp;resolution,&nbsp;but&nbsp;for&nbsp;now&nbsp;let&#39;s&nbsp;just&nbsp;capture</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044685">//&nbsp;too&nbsp;long&nbsp;fields&nbsp;or&nbsp;non&nbsp;ascii&nbsp;characters</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6044730">var</span>&nbsp;<span class="ident" id="6044734">header</span>&nbsp;<span class="op" id="6044741">[</span><span class="op" id="6044742">]</span><span class="builtintype" id="6044743">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044750">//&nbsp;We&nbsp;need&nbsp;to&nbsp;select&nbsp;which&nbsp;scratch&nbsp;buffer&nbsp;to&nbsp;use&nbsp;carefully,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044811">//&nbsp;since&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;recursively&nbsp;to&nbsp;write&nbsp;PAX&nbsp;headers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044877">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;true,&nbsp;this&nbsp;is&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;and&nbsp;we&nbsp;will&nbsp;use&nbsp;hdrBuff.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6044959">//&nbsp;If&nbsp;allowPax&nbsp;is&nbsp;false,&nbsp;we&nbsp;are&nbsp;being&nbsp;called&nbsp;by&nbsp;writePAXHeader,&nbsp;and&nbsp;hdrBuff&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045039">//&nbsp;already&nbsp;being&nbsp;used&nbsp;by&nbsp;the&nbsp;non-recursive&nbsp;call,&nbsp;so&nbsp;we&nbsp;must&nbsp;use&nbsp;paxHdrBuff.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045116">header</span>&nbsp;<span class="op" id="6045123">=</span>&nbsp;<span class="ident" id="6045125">tw</span><span class="op" id="6045127">.</span><span class="ident" id="6045128">hdrBuff</span><span class="op" id="6045135">[</span><span class="op" id="6045136">:</span><span class="op" id="6045137">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045140">if</span>&nbsp;<span class="op" id="6045143">!</span><span class="ident" id="6045144">allowPax</span>&nbsp;<span class="op" id="6045153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045157">header</span>&nbsp;<span class="op" id="6045164">=</span>&nbsp;<span class="ident" id="6045166">tw</span><span class="op" id="6045168">.</span><span class="ident" id="6045169">paxHdrBuff</span><span class="op" id="6045179">[</span><span class="op" id="6045180">:</span><span class="op" id="6045181">]</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6045187">copy</span><span class="op" id="6045191">(</span><span class="ident" id="6045192">header</span><span class="op" id="6045198">,</span>&nbsp;<span class="ident" id="6045200">zeroBlock</span><span class="op" id="6045209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045212">s</span>&nbsp;<span class="op" id="6045214">:=</span>&nbsp;<span class="ident" id="6045217">slicer</span><span class="op" id="6045223">(</span><span class="ident" id="6045224">header</span><span class="op" id="6045230">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045234">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;filename&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045362">pathHeaderBytes</span>&nbsp;<span class="op" id="6045378">:=</span>&nbsp;<span class="ident" id="6045381">s</span><span class="op" id="6045382">.</span><span class="ident" id="6045383">next</span><span class="op" id="6045387">(</span><span class="ident" id="6045388">fileNameSize</span><span class="op" id="6045400">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045404">tw</span><span class="op" id="6045406">.</span><span class="ident" id="6045407">cString</span><span class="op" id="6045414">(</span><span class="ident" id="6045415">pathHeaderBytes</span><span class="op" id="6045430">,</span>&nbsp;<span class="ident" id="6045432">hdr</span><span class="op" id="6045435">.</span><span class="ident" id="6045436">Name</span><span class="op" id="6045440">,</span>&nbsp;<span class="ident" id="6045442">true</span><span class="op" id="6045446">,</span>&nbsp;<span class="ident" id="6045448">paxPath</span><span class="op" id="6045455">,</span>&nbsp;<span class="ident" id="6045457">paxHeaders</span><span class="op" id="6045467">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6045471">//&nbsp;Handle&nbsp;out&nbsp;of&nbsp;range&nbsp;ModTime&nbsp;carefully.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045514">var</span>&nbsp;<span class="ident" id="6045518">modTime</span>&nbsp;<span class="ident" id="6045526">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6045533">if</span>&nbsp;<span class="op" id="6045536">!</span><span class="ident" id="6045537">hdr</span><span class="op" id="6045540">.</span><span class="ident" id="6045541">ModTime</span><span class="op" id="6045548">.</span><span class="ident" id="6045549">Before</span><span class="op" id="6045555">(</span><span class="ident" id="6045556">minTime</span><span class="op" id="6045563">)</span>&nbsp;<span class="op" id="6045565">&amp;&amp;</span>&nbsp;<span class="op" id="6045568">!</span><span class="ident" id="6045569">hdr</span><span class="op" id="6045572">.</span><span class="ident" id="6045573">ModTime</span><span class="op" id="6045580">.</span><span class="ident" id="6045581">After</span><span class="op" id="6045586">(</span><span class="ident" id="6045587">maxTime</span><span class="op" id="6045594">)</span>&nbsp;<span class="op" id="6045596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045600">modTime</span>&nbsp;<span class="op" id="6045608">=</span>&nbsp;<span class="ident" id="6045610">hdr</span><span class="op" id="6045613">.</span><span class="ident" id="6045614">ModTime</span><span class="op" id="6045621">.</span><span class="ident" id="6045622">Unix</span><span class="op" id="6045626">(</span><span class="op" id="6045627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6045630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045634">tw</span><span class="op" id="6045636">.</span><span class="ident" id="6045637">octal</span><span class="op" id="6045642">(</span><span class="ident" id="6045643">s</span><span class="op" id="6045644">.</span><span class="ident" id="6045645">next</span><span class="op" id="6045649">(</span><span class="num" id="6045650">8</span><span class="op" id="6045651">)</span><span class="op" id="6045652">,</span>&nbsp;<span class="ident" id="6045654">hdr</span><span class="op" id="6045657">.</span><span class="ident" id="6045658">Mode</span><span class="op" id="6045662">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6045698">//&nbsp;100:108</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045710">tw</span><span class="op" id="6045712">.</span><span class="ident" id="6045713">numeric</span><span class="op" id="6045720">(</span><span class="ident" id="6045721">s</span><span class="op" id="6045722">.</span><span class="ident" id="6045723">next</span><span class="op" id="6045727">(</span><span class="num" id="6045728">8</span><span class="op" id="6045729">)</span><span class="op" id="6045730">,</span>&nbsp;<span class="ident" id="6045732">int64</span><span class="op" id="6045737">(</span><span class="ident" id="6045738">hdr</span><span class="op" id="6045741">.</span><span class="ident" id="6045742">Uid</span><span class="op" id="6045745">)</span><span class="op" id="6045746">,</span>&nbsp;<span class="ident" id="6045748">true</span><span class="op" id="6045752">,</span>&nbsp;<span class="ident" id="6045754">paxUid</span><span class="op" id="6045760">,</span>&nbsp;<span class="ident" id="6045762">paxHeaders</span><span class="op" id="6045772">)</span>&nbsp;<span class="comment" id="6045774">//&nbsp;108:116</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045786">tw</span><span class="op" id="6045788">.</span><span class="ident" id="6045789">numeric</span><span class="op" id="6045796">(</span><span class="ident" id="6045797">s</span><span class="op" id="6045798">.</span><span class="ident" id="6045799">next</span><span class="op" id="6045803">(</span><span class="num" id="6045804">8</span><span class="op" id="6045805">)</span><span class="op" id="6045806">,</span>&nbsp;<span class="ident" id="6045808">int64</span><span class="op" id="6045813">(</span><span class="ident" id="6045814">hdr</span><span class="op" id="6045817">.</span><span class="ident" id="6045818">Gid</span><span class="op" id="6045821">)</span><span class="op" id="6045822">,</span>&nbsp;<span class="ident" id="6045824">true</span><span class="op" id="6045828">,</span>&nbsp;<span class="ident" id="6045830">paxGid</span><span class="op" id="6045836">,</span>&nbsp;<span class="ident" id="6045838">paxHeaders</span><span class="op" id="6045848">)</span>&nbsp;<span class="comment" id="6045850">//&nbsp;116:124</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045862">tw</span><span class="op" id="6045864">.</span><span class="ident" id="6045865">numeric</span><span class="op" id="6045872">(</span><span class="ident" id="6045873">s</span><span class="op" id="6045874">.</span><span class="ident" id="6045875">next</span><span class="op" id="6045879">(</span><span class="num" id="6045880">12</span><span class="op" id="6045882">)</span><span class="op" id="6045883">,</span>&nbsp;<span class="ident" id="6045885">hdr</span><span class="op" id="6045888">.</span><span class="ident" id="6045889">Size</span><span class="op" id="6045893">,</span>&nbsp;<span class="ident" id="6045895">true</span><span class="op" id="6045899">,</span>&nbsp;<span class="ident" id="6045901">paxSize</span><span class="op" id="6045908">,</span>&nbsp;<span class="ident" id="6045910">paxHeaders</span><span class="op" id="6045920">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6045926">//&nbsp;124:136</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6045938">tw</span><span class="op" id="6045940">.</span><span class="ident" id="6045941">numeric</span><span class="op" id="6045948">(</span><span class="ident" id="6045949">s</span><span class="op" id="6045950">.</span><span class="ident" id="6045951">next</span><span class="op" id="6045955">(</span><span class="num" id="6045956">12</span><span class="op" id="6045958">)</span><span class="op" id="6045959">,</span>&nbsp;<span class="ident" id="6045961">modTime</span><span class="op" id="6045968">,</span>&nbsp;<span class="ident" id="6045970">false</span><span class="op" id="6045975">,</span>&nbsp;<span class="ident" id="6045977">paxNone</span><span class="op" id="6045984">,</span>&nbsp;<span class="ident" id="6045986">nil</span><span class="op" id="6045989">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046002">//&nbsp;136:148&nbsp;---&nbsp;consider&nbsp;using&nbsp;pax&nbsp;for&nbsp;finer&nbsp;granularity</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046059">s</span><span class="op" id="6046060">.</span><span class="ident" id="6046061">next</span><span class="op" id="6046065">(</span><span class="num" id="6046066">8</span><span class="op" id="6046067">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046123">//&nbsp;chksum&nbsp;(148:156)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046144">s</span><span class="op" id="6046145">.</span><span class="ident" id="6046146">next</span><span class="op" id="6046150">(</span><span class="num" id="6046151">1</span><span class="op" id="6046152">)</span><span class="op" id="6046153">[</span><span class="num" id="6046154">0</span><span class="op" id="6046155">]</span>&nbsp;<span class="op" id="6046157">=</span>&nbsp;<span class="ident" id="6046159">hdr</span><span class="op" id="6046162">.</span><span class="ident" id="6046163">Typeflag</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046208">//&nbsp;156:157</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046221">tw</span><span class="op" id="6046223">.</span><span class="ident" id="6046224">cString</span><span class="op" id="6046231">(</span><span class="ident" id="6046232">s</span><span class="op" id="6046233">.</span><span class="ident" id="6046234">next</span><span class="op" id="6046238">(</span><span class="num" id="6046239">100</span><span class="op" id="6046242">)</span><span class="op" id="6046243">,</span>&nbsp;<span class="ident" id="6046245">hdr</span><span class="op" id="6046248">.</span><span class="ident" id="6046249">Linkname</span><span class="op" id="6046257">,</span>&nbsp;<span class="ident" id="6046259">true</span><span class="op" id="6046263">,</span>&nbsp;<span class="ident" id="6046265">paxLinkpath</span><span class="op" id="6046276">,</span>&nbsp;<span class="ident" id="6046278">paxHeaders</span><span class="op" id="6046288">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6046292">copy</span><span class="op" id="6046296">(</span><span class="ident" id="6046297">s</span><span class="op" id="6046298">.</span><span class="ident" id="6046299">next</span><span class="op" id="6046303">(</span><span class="num" id="6046304">8</span><span class="op" id="6046305">)</span><span class="op" id="6046306">,</span>&nbsp;<span class="op" id="6046308">[</span><span class="op" id="6046309">]</span><span class="builtintype" id="6046310">byte</span><span class="op" id="6046314">(</span><span class="string" id="6046315">&#34;ustar\x0000&#34;</span><span class="op" id="6046328">)</span><span class="op" id="6046329">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046354">//&nbsp;257:265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046366">tw</span><span class="op" id="6046368">.</span><span class="ident" id="6046369">cString</span><span class="op" id="6046376">(</span><span class="ident" id="6046377">s</span><span class="op" id="6046378">.</span><span class="ident" id="6046379">next</span><span class="op" id="6046383">(</span><span class="num" id="6046384">32</span><span class="op" id="6046386">)</span><span class="op" id="6046387">,</span>&nbsp;<span class="ident" id="6046389">hdr</span><span class="op" id="6046392">.</span><span class="ident" id="6046393">Uname</span><span class="op" id="6046398">,</span>&nbsp;<span class="ident" id="6046400">true</span><span class="op" id="6046404">,</span>&nbsp;<span class="ident" id="6046406">paxUname</span><span class="op" id="6046414">,</span>&nbsp;<span class="ident" id="6046416">paxHeaders</span><span class="op" id="6046426">)</span>&nbsp;<span class="comment" id="6046428">//&nbsp;265:297</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046440">tw</span><span class="op" id="6046442">.</span><span class="ident" id="6046443">cString</span><span class="op" id="6046450">(</span><span class="ident" id="6046451">s</span><span class="op" id="6046452">.</span><span class="ident" id="6046453">next</span><span class="op" id="6046457">(</span><span class="num" id="6046458">32</span><span class="op" id="6046460">)</span><span class="op" id="6046461">,</span>&nbsp;<span class="ident" id="6046463">hdr</span><span class="op" id="6046466">.</span><span class="ident" id="6046467">Gname</span><span class="op" id="6046472">,</span>&nbsp;<span class="ident" id="6046474">true</span><span class="op" id="6046478">,</span>&nbsp;<span class="ident" id="6046480">paxGname</span><span class="op" id="6046488">,</span>&nbsp;<span class="ident" id="6046490">paxHeaders</span><span class="op" id="6046500">)</span>&nbsp;<span class="comment" id="6046502">//&nbsp;297:329</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046514">tw</span><span class="op" id="6046516">.</span><span class="ident" id="6046517">numeric</span><span class="op" id="6046524">(</span><span class="ident" id="6046525">s</span><span class="op" id="6046526">.</span><span class="ident" id="6046527">next</span><span class="op" id="6046531">(</span><span class="num" id="6046532">8</span><span class="op" id="6046533">)</span><span class="op" id="6046534">,</span>&nbsp;<span class="ident" id="6046536">hdr</span><span class="op" id="6046539">.</span><span class="ident" id="6046540">Devmajor</span><span class="op" id="6046548">,</span>&nbsp;<span class="ident" id="6046550">false</span><span class="op" id="6046555">,</span>&nbsp;<span class="ident" id="6046557">paxNone</span><span class="op" id="6046564">,</span>&nbsp;<span class="ident" id="6046566">nil</span><span class="op" id="6046569">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046576">//&nbsp;329:337</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046588">tw</span><span class="op" id="6046590">.</span><span class="ident" id="6046591">numeric</span><span class="op" id="6046598">(</span><span class="ident" id="6046599">s</span><span class="op" id="6046600">.</span><span class="ident" id="6046601">next</span><span class="op" id="6046605">(</span><span class="num" id="6046606">8</span><span class="op" id="6046607">)</span><span class="op" id="6046608">,</span>&nbsp;<span class="ident" id="6046610">hdr</span><span class="op" id="6046613">.</span><span class="ident" id="6046614">Devminor</span><span class="op" id="6046622">,</span>&nbsp;<span class="ident" id="6046624">false</span><span class="op" id="6046629">,</span>&nbsp;<span class="ident" id="6046631">paxNone</span><span class="op" id="6046638">,</span>&nbsp;<span class="ident" id="6046640">nil</span><span class="op" id="6046643">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6046650">//&nbsp;337:345</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046663">//&nbsp;keep&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;prefix&nbsp;to&nbsp;allow&nbsp;to&nbsp;overwrite&nbsp;it&nbsp;later&nbsp;if&nbsp;we&nbsp;detect&nbsp;that&nbsp;we&nbsp;can&nbsp;use&nbsp;ustar&nbsp;longnames&nbsp;instead&nbsp;of&nbsp;pax</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046789">prefixHeaderBytes</span>&nbsp;<span class="op" id="6046807">:=</span>&nbsp;<span class="ident" id="6046810">s</span><span class="op" id="6046811">.</span><span class="ident" id="6046812">next</span><span class="op" id="6046816">(</span><span class="num" id="6046817">155</span><span class="op" id="6046820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6046823">tw</span><span class="op" id="6046825">.</span><span class="ident" id="6046826">cString</span><span class="op" id="6046833">(</span><span class="ident" id="6046834">prefixHeaderBytes</span><span class="op" id="6046851">,</span>&nbsp;<span class="string" id="6046853">&#34;&#34;</span><span class="op" id="6046855">,</span>&nbsp;<span class="ident" id="6046857">false</span><span class="op" id="6046862">,</span>&nbsp;<span class="ident" id="6046864">paxNone</span><span class="op" id="6046871">,</span>&nbsp;<span class="ident" id="6046873">nil</span><span class="op" id="6046876">)</span>&nbsp;<span class="comment" id="6046878">//&nbsp;345:500&nbsp;&nbsp;prefix</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6046899">//&nbsp;Use&nbsp;the&nbsp;GNU&nbsp;magic&nbsp;instead&nbsp;of&nbsp;POSIX&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;any&nbsp;GNU&nbsp;extensions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6046975">if</span>&nbsp;<span class="ident" id="6046978">tw</span><span class="op" id="6046980">.</span><span class="ident" id="6046981">usedBinary</span>&nbsp;<span class="op" id="6046992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6046996">copy</span><span class="op" id="6047000">(</span><span class="ident" id="6047001">header</span><span class="op" id="6047007">[</span><span class="num" id="6047008">257</span><span class="op" id="6047011">:</span><span class="num" id="6047012">265</span><span class="op" id="6047015">]</span><span class="op" id="6047016">,</span>&nbsp;<span class="op" id="6047018">[</span><span class="op" id="6047019">]</span><span class="builtintype" id="6047020">byte</span><span class="op" id="6047024">(</span><span class="string" id="6047025">&#34;ustar&nbsp;&nbsp;\x00&#34;</span><span class="op" id="6047038">)</span><span class="op" id="6047039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047042">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047046">_</span><span class="op" id="6047047">,</span>&nbsp;<span class="ident" id="6047049">paxPathUsed</span>&nbsp;<span class="op" id="6047061">:=</span>&nbsp;<span class="ident" id="6047064">paxHeaders</span><span class="op" id="6047074">[</span><span class="ident" id="6047075">paxPath</span><span class="op" id="6047082">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047085">//&nbsp;try&nbsp;to&nbsp;use&nbsp;a&nbsp;ustar&nbsp;header&nbsp;when&nbsp;only&nbsp;the&nbsp;name&nbsp;is&nbsp;too&nbsp;long</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047146">if</span>&nbsp;<span class="op" id="6047149">!</span><span class="ident" id="6047150">tw</span><span class="op" id="6047152">.</span><span class="ident" id="6047153">preferPax</span>&nbsp;<span class="op" id="6047163">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="6047166">len</span><span class="op" id="6047169">(</span><span class="ident" id="6047170">paxHeaders</span><span class="op" id="6047180">)</span>&nbsp;<span class="op" id="6047182">==</span>&nbsp;<span class="num" id="6047185">1</span>&nbsp;<span class="op" id="6047187">&amp;&amp;</span>&nbsp;<span class="ident" id="6047190">paxPathUsed</span>&nbsp;<span class="op" id="6047202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047206">suffix</span>&nbsp;<span class="op" id="6047213">:=</span>&nbsp;<span class="ident" id="6047216">hdr</span><span class="op" id="6047219">.</span><span class="ident" id="6047220">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047227">prefix</span>&nbsp;<span class="op" id="6047234">:=</span>&nbsp;<span class="string" id="6047237">&#34;&#34;</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047242">if</span>&nbsp;<span class="builtinfunc" id="6047245">len</span><span class="op" id="6047248">(</span><span class="ident" id="6047249">hdr</span><span class="op" id="6047252">.</span><span class="ident" id="6047253">Name</span><span class="op" id="6047257">)</span>&nbsp;<span class="op" id="6047259">&gt;</span>&nbsp;<span class="ident" id="6047261">fileNameSize</span>&nbsp;<span class="op" id="6047274">&amp;&amp;</span>&nbsp;<span class="ident" id="6047277">isASCII</span><span class="op" id="6047284">(</span><span class="ident" id="6047285">hdr</span><span class="op" id="6047288">.</span><span class="ident" id="6047289">Name</span><span class="op" id="6047293">)</span>&nbsp;<span class="op" id="6047295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047300">var</span>&nbsp;<span class="ident" id="6047304">err</span>&nbsp;<span class="builtintype" id="6047308">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047317">prefix</span><span class="op" id="6047323">,</span>&nbsp;<span class="ident" id="6047325">suffix</span><span class="op" id="6047331">,</span>&nbsp;<span class="ident" id="6047333">err</span>&nbsp;<span class="op" id="6047337">=</span>&nbsp;<span class="ident" id="6047339">tw</span><span class="op" id="6047341">.</span><span class="ident" id="6047342">splitUSTARLongName</span><span class="op" id="6047360">(</span><span class="ident" id="6047361">hdr</span><span class="op" id="6047364">.</span><span class="ident" id="6047365">Name</span><span class="op" id="6047369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047374">if</span>&nbsp;<span class="ident" id="6047377">err</span>&nbsp;<span class="op" id="6047381">==</span>&nbsp;<span class="ident" id="6047384">nil</span>&nbsp;<span class="op" id="6047388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047394">//&nbsp;ok&nbsp;we&nbsp;can&nbsp;use&nbsp;a&nbsp;ustar&nbsp;long&nbsp;name&nbsp;instead&nbsp;of&nbsp;pax,&nbsp;now&nbsp;correct&nbsp;the&nbsp;fields</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047473">//&nbsp;remove&nbsp;the&nbsp;path&nbsp;field&nbsp;from&nbsp;the&nbsp;pax&nbsp;header.&nbsp;this&nbsp;will&nbsp;suppress&nbsp;the&nbsp;pax&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6047557">delete</span><span class="op" id="6047563">(</span><span class="ident" id="6047564">paxHeaders</span><span class="op" id="6047574">,</span>&nbsp;<span class="ident" id="6047576">paxPath</span><span class="op" id="6047583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047590">//&nbsp;update&nbsp;the&nbsp;path&nbsp;fields</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047620">tw</span><span class="op" id="6047622">.</span><span class="ident" id="6047623">cString</span><span class="op" id="6047630">(</span><span class="ident" id="6047631">pathHeaderBytes</span><span class="op" id="6047646">,</span>&nbsp;<span class="ident" id="6047648">suffix</span><span class="op" id="6047654">,</span>&nbsp;<span class="ident" id="6047656">false</span><span class="op" id="6047661">,</span>&nbsp;<span class="ident" id="6047663">paxNone</span><span class="op" id="6047670">,</span>&nbsp;<span class="ident" id="6047672">nil</span><span class="op" id="6047675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6047681">tw</span><span class="op" id="6047683">.</span><span class="ident" id="6047684">cString</span><span class="op" id="6047691">(</span><span class="ident" id="6047692">prefixHeaderBytes</span><span class="op" id="6047709">,</span>&nbsp;<span class="ident" id="6047711">prefix</span><span class="op" id="6047717">,</span>&nbsp;<span class="ident" id="6047719">false</span><span class="op" id="6047724">,</span>&nbsp;<span class="ident" id="6047726">paxNone</span><span class="op" id="6047733">,</span>&nbsp;<span class="ident" id="6047735">nil</span><span class="op" id="6047738">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047745">//&nbsp;Use&nbsp;the&nbsp;ustar&nbsp;magic&nbsp;if&nbsp;we&nbsp;used&nbsp;ustar&nbsp;long&nbsp;names.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6047801">if</span>&nbsp;<span class="builtinfunc" id="6047804">len</span><span class="op" id="6047807">(</span><span class="ident" id="6047808">prefix</span><span class="op" id="6047814">)</span>&nbsp;<span class="op" id="6047816">&gt;</span>&nbsp;<span class="num" id="6047818">0</span>&nbsp;<span class="op" id="6047820">&amp;&amp;</span>&nbsp;<span class="op" id="6047823">!</span><span class="ident" id="6047824">tw</span><span class="op" id="6047826">.</span><span class="ident" id="6047827">usedBinary</span>&nbsp;<span class="op" id="6047838">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6047845">copy</span><span class="op" id="6047849">(</span><span class="ident" id="6047850">header</span><span class="op" id="6047856">[</span><span class="num" id="6047857">257</span><span class="op" id="6047860">:</span><span class="num" id="6047861">265</span><span class="op" id="6047864">]</span><span class="op" id="6047865">,</span>&nbsp;<span class="op" id="6047867">[</span><span class="op" id="6047868">]</span><span class="builtintype" id="6047869">byte</span><span class="op" id="6047873">(</span><span class="string" id="6047874">&#34;ustar\x00&#34;</span><span class="op" id="6047885">)</span><span class="op" id="6047886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6047904">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047908">//&nbsp;The&nbsp;chksum&nbsp;field&nbsp;is&nbsp;terminated&nbsp;by&nbsp;a&nbsp;NUL&nbsp;and&nbsp;a&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6047965">//&nbsp;This&nbsp;is&nbsp;different&nbsp;from&nbsp;the&nbsp;other&nbsp;octal&nbsp;fields.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048016">chksum</span><span class="op" id="6048022">,</span>&nbsp;<span class="ident" id="6048024">_</span>&nbsp;<span class="op" id="6048026">:=</span>&nbsp;<span class="ident" id="6048029">checksum</span><span class="op" id="6048037">(</span><span class="ident" id="6048038">header</span><span class="op" id="6048044">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048047">tw</span><span class="op" id="6048049">.</span><span class="ident" id="6048050">octal</span><span class="op" id="6048055">(</span><span class="ident" id="6048056">header</span><span class="op" id="6048062">[</span><span class="num" id="6048063">148</span><span class="op" id="6048066">:</span><span class="num" id="6048067">155</span><span class="op" id="6048070">]</span><span class="op" id="6048071">,</span>&nbsp;<span class="ident" id="6048073">chksum</span><span class="op" id="6048079">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048082">header</span><span class="op" id="6048088">[</span><span class="num" id="6048089">155</span><span class="op" id="6048092">]</span>&nbsp;<span class="op" id="6048094">=</span>&nbsp;<span class="string" id="6048096">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048102">if</span>&nbsp;<span class="ident" id="6048105">tw</span><span class="op" id="6048107">.</span><span class="ident" id="6048108">err</span>&nbsp;<span class="op" id="6048112">!=</span>&nbsp;<span class="ident" id="6048115">nil</span>&nbsp;<span class="op" id="6048119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6048123">//&nbsp;problem&nbsp;with&nbsp;header;&nbsp;probably&nbsp;integer&nbsp;too&nbsp;big&nbsp;for&nbsp;a&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048187">return</span>&nbsp;<span class="ident" id="6048194">tw</span><span class="op" id="6048196">.</span><span class="ident" id="6048197">err</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048206">if</span>&nbsp;<span class="ident" id="6048209">allowPax</span>&nbsp;<span class="op" id="6048218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048222">for</span>&nbsp;<span class="ident" id="6048226">k</span><span class="op" id="6048227">,</span>&nbsp;<span class="ident" id="6048229">v</span>&nbsp;<span class="op" id="6048231">:=</span>&nbsp;<span class="keyword" id="6048234">range</span>&nbsp;<span class="ident" id="6048240">hdr</span><span class="op" id="6048243">.</span><span class="ident" id="6048244">Xattrs</span>&nbsp;<span class="op" id="6048251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048256">paxHeaders</span><span class="op" id="6048266">[</span><span class="ident" id="6048267">paxXattr</span><span class="op" id="6048275">+</span><span class="ident" id="6048276">k</span><span class="op" id="6048277">]</span>&nbsp;<span class="op" id="6048279">=</span>&nbsp;<span class="ident" id="6048281">v</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048292">if</span>&nbsp;<span class="builtinfunc" id="6048295">len</span><span class="op" id="6048298">(</span><span class="ident" id="6048299">paxHeaders</span><span class="op" id="6048309">)</span>&nbsp;<span class="op" id="6048311">&gt;</span>&nbsp;<span class="num" id="6048313">0</span>&nbsp;<span class="op" id="6048315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048319">if</span>&nbsp;<span class="op" id="6048322">!</span><span class="ident" id="6048323">allowPax</span>&nbsp;<span class="op" id="6048332">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048337">return</span>&nbsp;<span class="ident" id="6048344">errInvalidHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048363">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048367">if</span>&nbsp;<span class="ident" id="6048370">err</span>&nbsp;<span class="op" id="6048374">:=</span>&nbsp;<span class="ident" id="6048377">tw</span><span class="op" id="6048379">.</span><span class="ident" id="6048380">writePAXHeader</span><span class="op" id="6048394">(</span><span class="ident" id="6048395">hdr</span><span class="op" id="6048398">,</span>&nbsp;<span class="ident" id="6048400">paxHeaders</span><span class="op" id="6048410">)</span><span class="op" id="6048411">;</span>&nbsp;<span class="ident" id="6048413">err</span>&nbsp;<span class="op" id="6048417">!=</span>&nbsp;<span class="ident" id="6048420">nil</span>&nbsp;<span class="op" id="6048424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048429">return</span>&nbsp;<span class="ident" id="6048436">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048442">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048448">tw</span><span class="op" id="6048450">.</span><span class="ident" id="6048451">nb</span>&nbsp;<span class="op" id="6048454">=</span>&nbsp;<span class="ident" id="6048456">int64</span><span class="op" id="6048461">(</span><span class="ident" id="6048462">hdr</span><span class="op" id="6048465">.</span><span class="ident" id="6048466">Size</span><span class="op" id="6048470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048473">tw</span><span class="op" id="6048475">.</span><span class="ident" id="6048476">pad</span>&nbsp;<span class="op" id="6048480">=</span>&nbsp;<span class="op" id="6048482">(</span><span class="ident" id="6048483">blockSize</span>&nbsp;<span class="op" id="6048493">-</span>&nbsp;<span class="op" id="6048495">(</span><span class="ident" id="6048496">tw</span><span class="op" id="6048498">.</span><span class="ident" id="6048499">nb</span>&nbsp;<span class="op" id="6048502">%</span>&nbsp;<span class="ident" id="6048504">blockSize</span><span class="op" id="6048513">)</span><span class="op" id="6048514">)</span>&nbsp;<span class="op" id="6048516">%</span>&nbsp;<span class="ident" id="6048518">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048530">_</span><span class="op" id="6048531">,</span>&nbsp;<span class="ident" id="6048533">tw</span><span class="op" id="6048535">.</span><span class="ident" id="6048536">err</span>&nbsp;<span class="op" id="6048540">=</span>&nbsp;<span class="ident" id="6048542">tw</span><span class="op" id="6048544">.</span><span class="ident" id="6048545">w</span><span class="op" id="6048546">.</span><span class="ident" id="6048547">Write</span><span class="op" id="6048552">(</span><span class="ident" id="6048553">header</span><span class="op" id="6048559">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048562">return</span>&nbsp;<span class="ident" id="6048569">tw</span><span class="op" id="6048571">.</span><span class="ident" id="6048572">err</span><br>
<span class="lineno"></span><span class="op" id="6048576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6048579">//&nbsp;writeUSTARLongName&nbsp;splits&nbsp;a&nbsp;USTAR&nbsp;long&nbsp;name&nbsp;hdr.Name.</span><br>
<span class="lineno"></span><span class="comment" id="6048636">//&nbsp;name&nbsp;must&nbsp;be&nbsp;&lt;&nbsp;256&nbsp;characters.&nbsp;errNameTooLong&nbsp;is&nbsp;returned</span><br>
<span class="lineno">275</span><span class="comment" id="6048697">//&nbsp;if&nbsp;hdr.Name&nbsp;can&#39;t&nbsp;be&nbsp;split.&nbsp;The&nbsp;splitting&nbsp;heuristic</span><br>
<span class="lineno"></span><span class="comment" id="6048752">//&nbsp;is&nbsp;compatible&nbsp;with&nbsp;gnu&nbsp;tar.</span><br>
<span class="lineno"></span><span class="keyword" id="6048783">func</span>&nbsp;<span class="op" id="6048788">(</span><span class="ident" id="6048789">tw</span>&nbsp;<span class="op" id="6048792">*</span><span class="ident" id="6048793">Writer</span><span class="op" id="6048799">)</span>&nbsp;<span class="ident" id="6048801">splitUSTARLongName</span><span class="op" id="6048819">(</span><span class="ident" id="6048820">name</span>&nbsp;<span class="builtintype" id="6048825">string</span><span class="op" id="6048831">)</span>&nbsp;<span class="op" id="6048833">(</span><span class="ident" id="6048834">prefix</span><span class="op" id="6048840">,</span>&nbsp;<span class="ident" id="6048842">suffix</span>&nbsp;<span class="builtintype" id="6048849">string</span><span class="op" id="6048855">,</span>&nbsp;<span class="ident" id="6048857">err</span>&nbsp;<span class="builtintype" id="6048861">error</span><span class="op" id="6048866">)</span>&nbsp;<span class="op" id="6048868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048871">length</span>&nbsp;<span class="op" id="6048878">:=</span>&nbsp;<span class="builtinfunc" id="6048881">len</span><span class="op" id="6048884">(</span><span class="ident" id="6048885">name</span><span class="op" id="6048889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6048892">if</span>&nbsp;<span class="ident" id="6048895">length</span>&nbsp;<span class="op" id="6048902">&gt;</span>&nbsp;<span class="ident" id="6048904">fileNamePrefixSize</span><span class="op" id="6048922">+</span><span class="num" id="6048923">1</span>&nbsp;<span class="op" id="6048925">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048929">length</span>&nbsp;<span class="op" id="6048936">=</span>&nbsp;<span class="ident" id="6048938">fileNamePrefixSize</span>&nbsp;<span class="op" id="6048957">+</span>&nbsp;<span class="num" id="6048959">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6048962">}</span>&nbsp;<span class="keyword" id="6048964">else</span>&nbsp;<span class="keyword" id="6048969">if</span>&nbsp;<span class="ident" id="6048972">name</span><span class="op" id="6048976">[</span><span class="ident" id="6048977">length</span><span class="op" id="6048983">-</span><span class="num" id="6048984">1</span><span class="op" id="6048985">]</span>&nbsp;<span class="op" id="6048987">==</span>&nbsp;<span class="string" id="6048990">&#39;/&#39;</span>&nbsp;<span class="op" id="6048994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6048998">length</span><span class="op" id="6049004">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049008">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049011">i</span>&nbsp;<span class="op" id="6049013">:=</span>&nbsp;<span class="ident" id="6049016">strings</span><span class="op" id="6049023">.</span><span class="ident" id="6049024">LastIndex</span><span class="op" id="6049033">(</span><span class="ident" id="6049034">name</span><span class="op" id="6049038">[</span><span class="op" id="6049039">:</span><span class="ident" id="6049040">length</span><span class="op" id="6049046">]</span><span class="op" id="6049047">,</span>&nbsp;<span class="string" id="6049049">&#34;/&#34;</span><span class="op" id="6049052">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049055">//&nbsp;nlen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;name&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049113">//&nbsp;plen&nbsp;contains&nbsp;the&nbsp;resulting&nbsp;length&nbsp;in&nbsp;the&nbsp;prefix&nbsp;field.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049173">nlen</span>&nbsp;<span class="op" id="6049178">:=</span>&nbsp;<span class="builtinfunc" id="6049181">len</span><span class="op" id="6049184">(</span><span class="ident" id="6049185">name</span><span class="op" id="6049189">)</span>&nbsp;<span class="op" id="6049191">-</span>&nbsp;<span class="ident" id="6049193">i</span>&nbsp;<span class="op" id="6049195">-</span>&nbsp;<span class="num" id="6049197">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049200">plen</span>&nbsp;<span class="op" id="6049205">:=</span>&nbsp;<span class="ident" id="6049208">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049211">if</span>&nbsp;<span class="ident" id="6049214">i</span>&nbsp;<span class="op" id="6049216">&lt;=</span>&nbsp;<span class="num" id="6049219">0</span>&nbsp;<span class="op" id="6049221">||</span>&nbsp;<span class="ident" id="6049224">nlen</span>&nbsp;<span class="op" id="6049229">&gt;</span>&nbsp;<span class="ident" id="6049231">fileNameSize</span>&nbsp;<span class="op" id="6049244">||</span>&nbsp;<span class="ident" id="6049247">nlen</span>&nbsp;<span class="op" id="6049252">==</span>&nbsp;<span class="num" id="6049255">0</span>&nbsp;<span class="op" id="6049257">||</span>&nbsp;<span class="ident" id="6049260">plen</span>&nbsp;<span class="op" id="6049265">&gt;</span>&nbsp;<span class="ident" id="6049267">fileNamePrefixSize</span>&nbsp;<span class="op" id="6049286">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049290">err</span>&nbsp;<span class="op" id="6049294">=</span>&nbsp;<span class="ident" id="6049296">errNameTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049313">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6049321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049324">prefix</span><span class="op" id="6049330">,</span>&nbsp;<span class="ident" id="6049332">suffix</span>&nbsp;<span class="op" id="6049339">=</span>&nbsp;<span class="ident" id="6049341">name</span><span class="op" id="6049345">[</span><span class="op" id="6049346">:</span><span class="ident" id="6049347">i</span><span class="op" id="6049348">]</span><span class="op" id="6049349">,</span>&nbsp;<span class="ident" id="6049351">name</span><span class="op" id="6049355">[</span><span class="ident" id="6049356">i</span><span class="op" id="6049357">+</span><span class="num" id="6049358">1</span><span class="op" id="6049359">:</span><span class="op" id="6049360">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049363">return</span><br>
<span class="lineno">295</span><span class="op" id="6049370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6049373">//&nbsp;writePaxHeader&nbsp;writes&nbsp;an&nbsp;extended&nbsp;pax&nbsp;header&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6049428">//&nbsp;archive.</span><br>
<span class="lineno"></span><span class="keyword" id="6049440">func</span>&nbsp;<span class="op" id="6049445">(</span><span class="ident" id="6049446">tw</span>&nbsp;<span class="op" id="6049449">*</span><span class="ident" id="6049450">Writer</span><span class="op" id="6049456">)</span>&nbsp;<span class="ident" id="6049458">writePAXHeader</span><span class="op" id="6049472">(</span><span class="ident" id="6049473">hdr</span>&nbsp;<span class="op" id="6049477">*</span><span class="ident" id="6049478">Header</span><span class="op" id="6049484">,</span>&nbsp;<span class="ident" id="6049486">paxHeaders</span>&nbsp;<span class="keyword" id="6049497">map</span><span class="op" id="6049500">[</span><span class="builtintype" id="6049501">string</span><span class="op" id="6049507">]</span><span class="builtintype" id="6049508">string</span><span class="op" id="6049514">)</span>&nbsp;<span class="builtintype" id="6049516">error</span>&nbsp;<span class="op" id="6049522">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049525">//&nbsp;Prepare&nbsp;extended&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049553">ext</span>&nbsp;<span class="op" id="6049557">:=</span>&nbsp;<span class="builtinfunc" id="6049560">new</span><span class="op" id="6049563">(</span><span class="ident" id="6049564">Header</span><span class="op" id="6049570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049573">ext</span><span class="op" id="6049576">.</span><span class="ident" id="6049577">Typeflag</span>&nbsp;<span class="op" id="6049586">=</span>&nbsp;<span class="ident" id="6049588">TypeXHeader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049601">//&nbsp;Setting&nbsp;ModTime&nbsp;is&nbsp;required&nbsp;for&nbsp;reader&nbsp;parsing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049655">//&nbsp;succeed,&nbsp;and&nbsp;seems&nbsp;harmless&nbsp;enough.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049695">ext</span><span class="op" id="6049698">.</span><span class="ident" id="6049699">ModTime</span>&nbsp;<span class="op" id="6049707">=</span>&nbsp;<span class="ident" id="6049709">hdr</span><span class="op" id="6049712">.</span><span class="ident" id="6049713">ModTime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049722">//&nbsp;The&nbsp;spec&nbsp;asks&nbsp;that&nbsp;we&nbsp;namespace&nbsp;our&nbsp;pseudo&nbsp;files</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6049775">//&nbsp;with&nbsp;the&nbsp;current&nbsp;pid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049801">pid</span>&nbsp;<span class="op" id="6049805">:=</span>&nbsp;<span class="ident" id="6049808">os</span><span class="op" id="6049810">.</span><span class="ident" id="6049811">Getpid</span><span class="op" id="6049817">(</span><span class="op" id="6049818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049821">dir</span><span class="op" id="6049824">,</span>&nbsp;<span class="ident" id="6049826">file</span>&nbsp;<span class="op" id="6049831">:=</span>&nbsp;<span class="ident" id="6049834">path</span><span class="op" id="6049838">.</span><span class="ident" id="6049839">Split</span><span class="op" id="6049844">(</span><span class="ident" id="6049845">hdr</span><span class="op" id="6049848">.</span><span class="ident" id="6049849">Name</span><span class="op" id="6049853">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049856">fullName</span>&nbsp;<span class="op" id="6049865">:=</span>&nbsp;<span class="ident" id="6049868">path</span><span class="op" id="6049872">.</span><span class="ident" id="6049873">Join</span><span class="op" id="6049877">(</span><span class="ident" id="6049878">dir</span><span class="op" id="6049881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049885">fmt</span><span class="op" id="6049888">.</span><span class="ident" id="6049889">Sprintf</span><span class="op" id="6049896">(</span><span class="string" id="6049897">&#34;PaxHeaders.%d&#34;</span><span class="op" id="6049912">,</span>&nbsp;<span class="ident" id="6049914">pid</span><span class="op" id="6049917">)</span><span class="op" id="6049918">,</span>&nbsp;<span class="ident" id="6049920">file</span><span class="op" id="6049924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049928">ascii</span>&nbsp;<span class="op" id="6049934">:=</span>&nbsp;<span class="ident" id="6049937">toASCII</span><span class="op" id="6049944">(</span><span class="ident" id="6049945">fullName</span><span class="op" id="6049953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6049956">if</span>&nbsp;<span class="builtinfunc" id="6049959">len</span><span class="op" id="6049962">(</span><span class="ident" id="6049963">ascii</span><span class="op" id="6049968">)</span>&nbsp;<span class="op" id="6049970">&gt;</span>&nbsp;<span class="num" id="6049972">100</span>&nbsp;<span class="op" id="6049976">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6049980">ascii</span>&nbsp;<span class="op" id="6049986">=</span>&nbsp;<span class="ident" id="6049988">ascii</span><span class="op" id="6049993">[</span><span class="op" id="6049994">:</span><span class="num" id="6049995">100</span><span class="op" id="6049998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050004">ext</span><span class="op" id="6050007">.</span><span class="ident" id="6050008">Name</span>&nbsp;<span class="op" id="6050013">=</span>&nbsp;<span class="ident" id="6050015">ascii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050022">//&nbsp;Construct&nbsp;the&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050045">var</span>&nbsp;<span class="ident" id="6050049">buf</span>&nbsp;<span class="ident" id="6050053">bytes</span><span class="op" id="6050058">.</span><span class="ident" id="6050059">Buffer</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050068">for</span>&nbsp;<span class="ident" id="6050072">k</span><span class="op" id="6050073">,</span>&nbsp;<span class="ident" id="6050075">v</span>&nbsp;<span class="op" id="6050077">:=</span>&nbsp;<span class="keyword" id="6050080">range</span>&nbsp;<span class="ident" id="6050086">paxHeaders</span>&nbsp;<span class="op" id="6050097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050101">fmt</span><span class="op" id="6050104">.</span><span class="ident" id="6050105">Fprint</span><span class="op" id="6050111">(</span><span class="op" id="6050112">&amp;</span><span class="ident" id="6050113">buf</span><span class="op" id="6050116">,</span>&nbsp;<span class="ident" id="6050118">paxHeader</span><span class="op" id="6050127">(</span><span class="ident" id="6050128">k</span><span class="op" id="6050129">+</span><span class="string" id="6050130">&#34;=&#34;</span><span class="op" id="6050133">+</span><span class="ident" id="6050134">v</span><span class="op" id="6050135">)</span><span class="op" id="6050136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050143">ext</span><span class="op" id="6050146">.</span><span class="ident" id="6050147">Size</span>&nbsp;<span class="op" id="6050152">=</span>&nbsp;<span class="ident" id="6050154">int64</span><span class="op" id="6050159">(</span><span class="builtinfunc" id="6050160">len</span><span class="op" id="6050163">(</span><span class="ident" id="6050164">buf</span><span class="op" id="6050167">.</span><span class="ident" id="6050168">Bytes</span><span class="op" id="6050173">(</span><span class="op" id="6050174">)</span><span class="op" id="6050175">)</span><span class="op" id="6050176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050179">if</span>&nbsp;<span class="ident" id="6050182">err</span>&nbsp;<span class="op" id="6050186">:=</span>&nbsp;<span class="ident" id="6050189">tw</span><span class="op" id="6050191">.</span><span class="ident" id="6050192">writeHeader</span><span class="op" id="6050203">(</span><span class="ident" id="6050204">ext</span><span class="op" id="6050207">,</span>&nbsp;<span class="ident" id="6050209">false</span><span class="op" id="6050214">)</span><span class="op" id="6050215">;</span>&nbsp;<span class="ident" id="6050217">err</span>&nbsp;<span class="op" id="6050221">!=</span>&nbsp;<span class="ident" id="6050224">nil</span>&nbsp;<span class="op" id="6050228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050232">return</span>&nbsp;<span class="ident" id="6050239">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050247">if</span>&nbsp;<span class="ident" id="6050250">_</span><span class="op" id="6050251">,</span>&nbsp;<span class="ident" id="6050253">err</span>&nbsp;<span class="op" id="6050257">:=</span>&nbsp;<span class="ident" id="6050260">tw</span><span class="op" id="6050262">.</span><span class="ident" id="6050263">Write</span><span class="op" id="6050268">(</span><span class="ident" id="6050269">buf</span><span class="op" id="6050272">.</span><span class="ident" id="6050273">Bytes</span><span class="op" id="6050278">(</span><span class="op" id="6050279">)</span><span class="op" id="6050280">)</span><span class="op" id="6050281">;</span>&nbsp;<span class="ident" id="6050283">err</span>&nbsp;<span class="op" id="6050287">!=</span>&nbsp;<span class="ident" id="6050290">nil</span>&nbsp;<span class="op" id="6050294">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050298">return</span>&nbsp;<span class="ident" id="6050305">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050313">if</span>&nbsp;<span class="ident" id="6050316">err</span>&nbsp;<span class="op" id="6050320">:=</span>&nbsp;<span class="ident" id="6050323">tw</span><span class="op" id="6050325">.</span><span class="ident" id="6050326">Flush</span><span class="op" id="6050331">(</span><span class="op" id="6050332">)</span><span class="op" id="6050333">;</span>&nbsp;<span class="ident" id="6050335">err</span>&nbsp;<span class="op" id="6050339">!=</span>&nbsp;<span class="ident" id="6050342">nil</span>&nbsp;<span class="op" id="6050346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050350">return</span>&nbsp;<span class="ident" id="6050357">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050362">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050365">return</span>&nbsp;<span class="ident" id="6050372">nil</span><br>
<span class="lineno"></span><span class="op" id="6050376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6050379">//&nbsp;paxHeader&nbsp;formats&nbsp;a&nbsp;single&nbsp;pax&nbsp;record,&nbsp;prefixing&nbsp;it&nbsp;with&nbsp;the&nbsp;appropriate&nbsp;length</span><br>
<span class="lineno"></span><span class="keyword" id="6050462">func</span>&nbsp;<span class="ident" id="6050467">paxHeader</span><span class="op" id="6050476">(</span><span class="ident" id="6050477">msg</span>&nbsp;<span class="builtintype" id="6050481">string</span><span class="op" id="6050487">)</span>&nbsp;<span class="builtintype" id="6050489">string</span>&nbsp;<span class="op" id="6050496">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050499">const</span>&nbsp;<span class="ident" id="6050505">padding</span>&nbsp;<span class="op" id="6050513">=</span>&nbsp;<span class="num" id="6050515">2</span>&nbsp;<span class="comment" id="6050517">//&nbsp;Extra&nbsp;padding&nbsp;for&nbsp;space&nbsp;and&nbsp;newline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050557">size</span>&nbsp;<span class="op" id="6050562">:=</span>&nbsp;<span class="builtinfunc" id="6050565">len</span><span class="op" id="6050568">(</span><span class="ident" id="6050569">msg</span><span class="op" id="6050572">)</span>&nbsp;<span class="op" id="6050574">+</span>&nbsp;<span class="ident" id="6050576">padding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050585">size</span>&nbsp;<span class="op" id="6050590">+=</span>&nbsp;<span class="builtinfunc" id="6050593">len</span><span class="op" id="6050596">(</span><span class="ident" id="6050597">strconv</span><span class="op" id="6050604">.</span><span class="ident" id="6050605">Itoa</span><span class="op" id="6050609">(</span><span class="ident" id="6050610">size</span><span class="op" id="6050614">)</span><span class="op" id="6050615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050618">record</span>&nbsp;<span class="op" id="6050625">:=</span>&nbsp;<span class="ident" id="6050628">fmt</span><span class="op" id="6050631">.</span><span class="ident" id="6050632">Sprintf</span><span class="op" id="6050639">(</span><span class="string" id="6050640">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6050649">,</span>&nbsp;<span class="ident" id="6050651">size</span><span class="op" id="6050655">,</span>&nbsp;<span class="ident" id="6050657">msg</span><span class="op" id="6050660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050663">if</span>&nbsp;<span class="builtinfunc" id="6050666">len</span><span class="op" id="6050669">(</span><span class="ident" id="6050670">record</span><span class="op" id="6050676">)</span>&nbsp;<span class="op" id="6050678">!=</span>&nbsp;<span class="ident" id="6050681">size</span>&nbsp;<span class="op" id="6050686">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050690">//&nbsp;Final&nbsp;adjustment&nbsp;if&nbsp;adding&nbsp;size&nbsp;increased</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6050737">//&nbsp;the&nbsp;number&nbsp;of&nbsp;digits&nbsp;in&nbsp;size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050771">size</span>&nbsp;<span class="op" id="6050776">=</span>&nbsp;<span class="builtinfunc" id="6050778">len</span><span class="op" id="6050781">(</span><span class="ident" id="6050782">record</span><span class="op" id="6050788">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6050792">record</span>&nbsp;<span class="op" id="6050799">=</span>&nbsp;<span class="ident" id="6050801">fmt</span><span class="op" id="6050804">.</span><span class="ident" id="6050805">Sprintf</span><span class="op" id="6050812">(</span><span class="string" id="6050813">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="6050822">,</span>&nbsp;<span class="ident" id="6050824">size</span><span class="op" id="6050828">,</span>&nbsp;<span class="ident" id="6050830">msg</span><span class="op" id="6050833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6050836">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6050839">return</span>&nbsp;<span class="ident" id="6050846">record</span><br>
<span class="lineno"></span><span class="op" id="6050853">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6050856">//&nbsp;Write&nbsp;writes&nbsp;to&nbsp;the&nbsp;current&nbsp;entry&nbsp;in&nbsp;the&nbsp;tar&nbsp;archive.</span><br>
<span class="lineno"></span><span class="comment" id="6050913">//&nbsp;Write&nbsp;returns&nbsp;the&nbsp;error&nbsp;ErrWriteTooLong&nbsp;if&nbsp;more&nbsp;than</span><br>
<span class="lineno">355</span><span class="comment" id="6050969">//&nbsp;hdr.Size&nbsp;bytes&nbsp;are&nbsp;written&nbsp;after&nbsp;WriteHeader.</span><br>
<span class="lineno"></span><span class="keyword" id="6051018">func</span>&nbsp;<span class="op" id="6051023">(</span><span class="ident" id="6051024">tw</span>&nbsp;<span class="op" id="6051027">*</span><span class="ident" id="6051028">Writer</span><span class="op" id="6051034">)</span>&nbsp;<span class="ident" id="6051036">Write</span><span class="op" id="6051041">(</span><span class="ident" id="6051042">b</span>&nbsp;<span class="op" id="6051044">[</span><span class="op" id="6051045">]</span><span class="builtintype" id="6051046">byte</span><span class="op" id="6051050">)</span>&nbsp;<span class="op" id="6051052">(</span><span class="ident" id="6051053">n</span>&nbsp;<span class="builtintype" id="6051055">int</span><span class="op" id="6051058">,</span>&nbsp;<span class="ident" id="6051060">err</span>&nbsp;<span class="builtintype" id="6051064">error</span><span class="op" id="6051069">)</span>&nbsp;<span class="op" id="6051071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051074">if</span>&nbsp;<span class="ident" id="6051077">tw</span><span class="op" id="6051079">.</span><span class="ident" id="6051080">closed</span>&nbsp;<span class="op" id="6051087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051091">err</span>&nbsp;<span class="op" id="6051095">=</span>&nbsp;<span class="ident" id="6051097">ErrWriteTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051115">return</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051126">overwrite</span>&nbsp;<span class="op" id="6051136">:=</span>&nbsp;<span class="ident" id="6051139">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051146">if</span>&nbsp;<span class="ident" id="6051149">int64</span><span class="op" id="6051154">(</span><span class="builtinfunc" id="6051155">len</span><span class="op" id="6051158">(</span><span class="ident" id="6051159">b</span><span class="op" id="6051160">)</span><span class="op" id="6051161">)</span>&nbsp;<span class="op" id="6051163">&gt;</span>&nbsp;<span class="ident" id="6051165">tw</span><span class="op" id="6051167">.</span><span class="ident" id="6051168">nb</span>&nbsp;<span class="op" id="6051171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051175">b</span>&nbsp;<span class="op" id="6051177">=</span>&nbsp;<span class="ident" id="6051179">b</span><span class="op" id="6051180">[</span><span class="num" id="6051181">0</span><span class="op" id="6051182">:</span><span class="ident" id="6051183">tw</span><span class="op" id="6051185">.</span><span class="ident" id="6051186">nb</span><span class="op" id="6051188">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051192">overwrite</span>&nbsp;<span class="op" id="6051202">=</span>&nbsp;<span class="ident" id="6051204">true</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051213">n</span><span class="op" id="6051214">,</span>&nbsp;<span class="ident" id="6051216">err</span>&nbsp;<span class="op" id="6051220">=</span>&nbsp;<span class="ident" id="6051222">tw</span><span class="op" id="6051224">.</span><span class="ident" id="6051225">w</span><span class="op" id="6051226">.</span><span class="ident" id="6051227">Write</span><span class="op" id="6051232">(</span><span class="ident" id="6051233">b</span><span class="op" id="6051234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051237">tw</span><span class="op" id="6051239">.</span><span class="ident" id="6051240">nb</span>&nbsp;<span class="op" id="6051243">-=</span>&nbsp;<span class="ident" id="6051246">int64</span><span class="op" id="6051251">(</span><span class="ident" id="6051252">n</span><span class="op" id="6051253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051256">if</span>&nbsp;<span class="ident" id="6051259">err</span>&nbsp;<span class="op" id="6051263">==</span>&nbsp;<span class="ident" id="6051266">nil</span>&nbsp;<span class="op" id="6051270">&amp;&amp;</span>&nbsp;<span class="ident" id="6051273">overwrite</span>&nbsp;<span class="op" id="6051283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051287">err</span>&nbsp;<span class="op" id="6051291">=</span>&nbsp;<span class="ident" id="6051293">ErrWriteTooLong</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051311">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051322">tw</span><span class="op" id="6051324">.</span><span class="ident" id="6051325">err</span>&nbsp;<span class="op" id="6051329">=</span>&nbsp;<span class="ident" id="6051331">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051336">return</span><br>
<span class="lineno"></span><span class="op" id="6051343">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="comment" id="6051346">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;tar&nbsp;archive,&nbsp;flushing&nbsp;any&nbsp;unwritten</span><br>
<span class="lineno"></span><span class="comment" id="6051402">//&nbsp;data&nbsp;to&nbsp;the&nbsp;underlying&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="6051436">func</span>&nbsp;<span class="op" id="6051441">(</span><span class="ident" id="6051442">tw</span>&nbsp;<span class="op" id="6051445">*</span><span class="ident" id="6051446">Writer</span><span class="op" id="6051452">)</span>&nbsp;<span class="ident" id="6051454">Close</span><span class="op" id="6051459">(</span><span class="op" id="6051460">)</span>&nbsp;<span class="builtintype" id="6051462">error</span>&nbsp;<span class="op" id="6051468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051471">if</span>&nbsp;<span class="ident" id="6051474">tw</span><span class="op" id="6051476">.</span><span class="ident" id="6051477">err</span>&nbsp;<span class="op" id="6051481">!=</span>&nbsp;<span class="ident" id="6051484">nil</span>&nbsp;<span class="op" id="6051488">||</span>&nbsp;<span class="ident" id="6051491">tw</span><span class="op" id="6051493">.</span><span class="ident" id="6051494">closed</span>&nbsp;<span class="op" id="6051501">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051505">return</span>&nbsp;<span class="ident" id="6051512">tw</span><span class="op" id="6051514">.</span><span class="ident" id="6051515">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051523">tw</span><span class="op" id="6051525">.</span><span class="ident" id="6051526">Flush</span><span class="op" id="6051531">(</span><span class="op" id="6051532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051535">tw</span><span class="op" id="6051537">.</span><span class="ident" id="6051538">closed</span>&nbsp;<span class="op" id="6051545">=</span>&nbsp;<span class="ident" id="6051547">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051553">if</span>&nbsp;<span class="ident" id="6051556">tw</span><span class="op" id="6051558">.</span><span class="ident" id="6051559">err</span>&nbsp;<span class="op" id="6051563">!=</span>&nbsp;<span class="ident" id="6051566">nil</span>&nbsp;<span class="op" id="6051570">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051574">return</span>&nbsp;<span class="ident" id="6051581">tw</span><span class="op" id="6051583">.</span><span class="ident" id="6051584">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051589">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6051593">//&nbsp;trailer:&nbsp;two&nbsp;zero&nbsp;blocks</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051622">for</span>&nbsp;<span class="ident" id="6051626">i</span>&nbsp;<span class="op" id="6051628">:=</span>&nbsp;<span class="num" id="6051631">0</span><span class="op" id="6051632">;</span>&nbsp;<span class="ident" id="6051634">i</span>&nbsp;<span class="op" id="6051636">&lt;</span>&nbsp;<span class="num" id="6051638">2</span><span class="op" id="6051639">;</span>&nbsp;<span class="ident" id="6051641">i</span><span class="op" id="6051642">++</span>&nbsp;<span class="op" id="6051645">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6051649">_</span><span class="op" id="6051650">,</span>&nbsp;<span class="ident" id="6051652">tw</span><span class="op" id="6051654">.</span><span class="ident" id="6051655">err</span>&nbsp;<span class="op" id="6051659">=</span>&nbsp;<span class="ident" id="6051661">tw</span><span class="op" id="6051663">.</span><span class="ident" id="6051664">w</span><span class="op" id="6051665">.</span><span class="ident" id="6051666">Write</span><span class="op" id="6051671">(</span><span class="ident" id="6051672">zeroBlock</span><span class="op" id="6051681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051685">if</span>&nbsp;<span class="ident" id="6051688">tw</span><span class="op" id="6051690">.</span><span class="ident" id="6051691">err</span>&nbsp;<span class="op" id="6051695">!=</span>&nbsp;<span class="ident" id="6051698">nil</span>&nbsp;<span class="op" id="6051702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051707">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6051718">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6051721">return</span>&nbsp;<span class="ident" id="6051728">tw</span><span class="op" id="6051730">.</span><span class="ident" id="6051731">err</span><br>
<span class="lineno"></span><span class="op" id="6051735">}</span>
</div>
</body>
</html>
