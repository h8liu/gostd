<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html" class="current">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1754039">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1754094">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1754148">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1754199">//&nbsp;+build&nbsp;dragonfly&nbsp;freebsd&nbsp;linux</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1754234">package</span>&nbsp;<span class="ident" id="1754242">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1754251">import</span>&nbsp;<span class="string" id="1754258">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1754268">//&nbsp;This&nbsp;implementation&nbsp;depends&nbsp;on&nbsp;OS-specific&nbsp;implementations&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="1754333">//</span><br>
<span class="lineno"></span><span class="comment" id="1754336">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexsleep(uint32&nbsp;*addr,&nbsp;uint32&nbsp;val,&nbsp;int64&nbsp;ns)</span><br>
<span class="lineno"></span><span class="comment" id="1754395">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspAtomically,</span><br>
<span class="lineno">15</span><span class="comment" id="1754411">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspif(*addr&nbsp;==&nbsp;val)&nbsp;sleep</span><br>
<span class="lineno"></span><span class="comment" id="1754439">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspMight&nbsp;be&nbsp;woken&nbsp;up&nbsp;spuriously;&nbsp;that&#39;s&nbsp;allowed.</span><br>
<span class="lineno"></span><span class="comment" id="1754489">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspDon&#39;t&nbsp;sleep&nbsp;longer&nbsp;than&nbsp;ns;&nbsp;ns&nbsp;&lt;&nbsp;0&nbsp;means&nbsp;forever.</span><br>
<span class="lineno"></span><span class="comment" id="1754543">//</span><br>
<span class="lineno"></span><span class="comment" id="1754546">//&nbsp;&nbsp;&nbsp;&nbspruntime路futexwakeup(uint32&nbsp;*addr,&nbsp;uint32&nbsp;cnt)</span><br>
<span class="lineno">20</span><span class="comment" id="1754596">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbspIf&nbsp;any&nbsp;procs&nbsp;are&nbsp;sleeping&nbsp;on&nbsp;addr,&nbsp;wake&nbsp;up&nbsp;at&nbsp;most&nbsp;cnt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1754657">const</span>&nbsp;<span class="op" id="1754663">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754666">mutex_unlocked</span>&nbsp;<span class="op" id="1754681">=</span>&nbsp;<span class="num" id="1754683">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754686">mutex_locked</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1754701">=</span>&nbsp;<span class="num" id="1754703">1</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754706">mutex_sleeping</span>&nbsp;<span class="op" id="1754721">=</span>&nbsp;<span class="num" id="1754723">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754727">active_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1754743">=</span>&nbsp;<span class="num" id="1754745">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754748">active_spin_cnt</span>&nbsp;<span class="op" id="1754764">=</span>&nbsp;<span class="num" id="1754766">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1754770">passive_spin</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1754786">=</span>&nbsp;<span class="num" id="1754788">1</span><br>
<span class="lineno">30</span><span class="op" id="1754790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1754793">//&nbsp;Possible&nbsp;lock&nbsp;states&nbsp;are&nbsp;mutex_unlocked,&nbsp;mutex_locked&nbsp;and&nbsp;mutex_sleeping.</span><br>
<span class="lineno"></span><span class="comment" id="1754870">//&nbsp;mutex_sleeping&nbsp;means&nbsp;that&nbsp;there&nbsp;is&nbsp;presumably&nbsp;at&nbsp;least&nbsp;one&nbsp;sleeping&nbsp;thread.</span><br>
<span class="lineno"></span><span class="comment" id="1754949">//&nbsp;Note&nbsp;that&nbsp;there&nbsp;can&nbsp;be&nbsp;spinning&nbsp;threads&nbsp;during&nbsp;all&nbsp;states&nbsp;-&nbsp;they&nbsp;do&nbsp;not</span><br>
<span class="lineno">35</span><span class="comment" id="1755024">//&nbsp;affect&nbsp;mutex&#39;s&nbsp;state.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1755050">func</span>&nbsp;<span class="ident" id="1755055">futexsleep</span><span class="op" id="1755065">(</span><span class="ident" id="1755066">addr</span>&nbsp;<span class="op" id="1755071">*</span><span class="builtintype" id="1755072">uint32</span><span class="op" id="1755078">,</span>&nbsp;<span class="ident" id="1755080">val</span>&nbsp;<span class="builtintype" id="1755084">uint32</span><span class="op" id="1755090">,</span>&nbsp;<span class="ident" id="1755092">ns</span>&nbsp;<span class="ident" id="1755095">int64</span><span class="op" id="1755100">)</span><br>
<span class="lineno"></span><span class="keyword" id="1755102">func</span>&nbsp;<span class="ident" id="1755107">futexwakeup</span><span class="op" id="1755118">(</span><span class="ident" id="1755119">addr</span>&nbsp;<span class="op" id="1755124">*</span><span class="builtintype" id="1755125">uint32</span><span class="op" id="1755131">,</span>&nbsp;<span class="ident" id="1755133">cnt</span>&nbsp;<span class="builtintype" id="1755137">uint32</span><span class="op" id="1755143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="1755146">//&nbsp;We&nbsp;use&nbsp;the&nbsp;uintptr&nbsp;mutex.key&nbsp;and&nbsp;note.key&nbsp;as&nbsp;a&nbsp;uint32.</span><br>
<span class="lineno"></span><span class="keyword" id="1755204">func</span>&nbsp;<span class="ident" id="1755209">key32</span><span class="op" id="1755214">(</span><span class="ident" id="1755215">p</span>&nbsp;<span class="op" id="1755217">*</span><span class="builtintype" id="1755218">uintptr</span><span class="op" id="1755225">)</span>&nbsp;<span class="op" id="1755227">*</span><span class="builtintype" id="1755228">uint32</span>&nbsp;<span class="op" id="1755235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755238">return</span>&nbsp;<span class="op" id="1755245">(</span><span class="op" id="1755246">*</span><span class="builtintype" id="1755247">uint32</span><span class="op" id="1755253">)</span><span class="op" id="1755254">(</span><span class="ident" id="1755255">unsafe</span><span class="op" id="1755261">.</span><span class="ident" id="1755262">Pointer</span><span class="op" id="1755269">(</span><span class="ident" id="1755270">p</span><span class="op" id="1755271">)</span><span class="op" id="1755272">)</span><br>
<span class="lineno"></span><span class="op" id="1755274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1755277">func</span>&nbsp;<span class="ident" id="1755282">lock</span><span class="op" id="1755286">(</span><span class="ident" id="1755287">l</span>&nbsp;<span class="op" id="1755289">*</span><span class="ident" id="1755290">mutex</span><span class="op" id="1755295">)</span>&nbsp;<span class="op" id="1755297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755300">gp</span>&nbsp;<span class="op" id="1755303">:=</span>&nbsp;<span class="ident" id="1755306">getg</span><span class="op" id="1755310">(</span><span class="op" id="1755311">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755315">if</span>&nbsp;<span class="ident" id="1755318">gp</span><span class="op" id="1755320">.</span><span class="ident" id="1755321">m</span><span class="op" id="1755322">.</span><span class="ident" id="1755323">locks</span>&nbsp;<span class="op" id="1755329">&lt;</span>&nbsp;<span class="num" id="1755331">0</span>&nbsp;<span class="op" id="1755333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755337">gothrow</span><span class="op" id="1755344">(</span><span class="string" id="1755345">&#34;runtime路lock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1755372">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1755375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755378">gp</span><span class="op" id="1755380">.</span><span class="ident" id="1755381">m</span><span class="op" id="1755382">.</span><span class="ident" id="1755383">locks</span><span class="op" id="1755388">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755393">//&nbsp;Speculative&nbsp;grab&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755424">v</span>&nbsp;<span class="op" id="1755426">:=</span>&nbsp;<span class="ident" id="1755429">xchg</span><span class="op" id="1755433">(</span><span class="ident" id="1755434">key32</span><span class="op" id="1755439">(</span><span class="op" id="1755440">&amp;</span><span class="ident" id="1755441">l</span><span class="op" id="1755442">.</span><span class="ident" id="1755443">key</span><span class="op" id="1755446">)</span><span class="op" id="1755447">,</span>&nbsp;<span class="ident" id="1755449">mutex_locked</span><span class="op" id="1755461">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755464">if</span>&nbsp;<span class="ident" id="1755467">v</span>&nbsp;<span class="op" id="1755469">==</span>&nbsp;<span class="ident" id="1755472">mutex_unlocked</span>&nbsp;<span class="op" id="1755487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755491">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1755499">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755503">//&nbsp;wait&nbsp;is&nbsp;either&nbsp;MUTEX_LOCKED&nbsp;or&nbsp;MUTEX_SLEEPING</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755553">//&nbsp;depending&nbsp;on&nbsp;whether&nbsp;there&nbsp;is&nbsp;a&nbsp;thread&nbsp;sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755605">//&nbsp;on&nbsp;this&nbsp;mutex.&nbsp;&nbsp;If&nbsp;we&nbsp;ever&nbsp;change&nbsp;l-&gt;key&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755655">//&nbsp;MUTEX_SLEEPING&nbsp;to&nbsp;some&nbsp;other&nbsp;value,&nbsp;we&nbsp;must&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755706">//&nbsp;careful&nbsp;to&nbsp;change&nbsp;it&nbsp;back&nbsp;to&nbsp;MUTEX_SLEEPING&nbsp;before</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755761">//&nbsp;returning,&nbsp;to&nbsp;ensure&nbsp;that&nbsp;the&nbsp;sleeping&nbsp;thread&nbsp;gets</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755816">//&nbsp;its&nbsp;wakeup&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755837">wait</span>&nbsp;<span class="op" id="1755842">:=</span>&nbsp;<span class="ident" id="1755845">v</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755849">//&nbsp;On&nbsp;uniprocessors,&nbsp;no&nbsp;point&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1755890">//&nbsp;On&nbsp;multiprocessors,&nbsp;spin&nbsp;for&nbsp;ACTIVE_SPIN&nbsp;attempts.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755945">spin</span>&nbsp;<span class="op" id="1755950">:=</span>&nbsp;<span class="num" id="1755953">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755956">if</span>&nbsp;<span class="ident" id="1755959">ncpu</span>&nbsp;<span class="op" id="1755964">&gt;</span>&nbsp;<span class="num" id="1755966">1</span>&nbsp;<span class="op" id="1755968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1755972">spin</span>&nbsp;<span class="op" id="1755977">=</span>&nbsp;<span class="ident" id="1755979">active_spin</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1755992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1755995">for</span>&nbsp;<span class="op" id="1755999">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1756003">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;spinning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756032">for</span>&nbsp;<span class="ident" id="1756036">i</span>&nbsp;<span class="op" id="1756038">:=</span>&nbsp;<span class="num" id="1756041">0</span><span class="op" id="1756042">;</span>&nbsp;<span class="ident" id="1756044">i</span>&nbsp;<span class="op" id="1756046">&lt;</span>&nbsp;<span class="ident" id="1756048">spin</span><span class="op" id="1756052">;</span>&nbsp;<span class="ident" id="1756054">i</span><span class="op" id="1756055">++</span>&nbsp;<span class="op" id="1756058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756063">for</span>&nbsp;<span class="ident" id="1756067">l</span><span class="op" id="1756068">.</span><span class="ident" id="1756069">key</span>&nbsp;<span class="op" id="1756073">==</span>&nbsp;<span class="ident" id="1756076">mutex_unlocked</span>&nbsp;<span class="op" id="1756091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756097">if</span>&nbsp;<span class="ident" id="1756100">cas</span><span class="op" id="1756103">(</span><span class="ident" id="1756104">key32</span><span class="op" id="1756109">(</span><span class="op" id="1756110">&amp;</span><span class="ident" id="1756111">l</span><span class="op" id="1756112">.</span><span class="ident" id="1756113">key</span><span class="op" id="1756116">)</span><span class="op" id="1756117">,</span>&nbsp;<span class="ident" id="1756119">mutex_unlocked</span><span class="op" id="1756133">,</span>&nbsp;<span class="ident" id="1756135">wait</span><span class="op" id="1756139">)</span>&nbsp;<span class="op" id="1756141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756148">return</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756169">procyield</span><span class="op" id="1756178">(</span><span class="ident" id="1756179">active_spin_cnt</span><span class="op" id="1756194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1756203">//&nbsp;Try&nbsp;for&nbsp;lock,&nbsp;rescheduling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756236">for</span>&nbsp;<span class="ident" id="1756240">i</span>&nbsp;<span class="op" id="1756242">:=</span>&nbsp;<span class="num" id="1756245">0</span><span class="op" id="1756246">;</span>&nbsp;<span class="ident" id="1756248">i</span>&nbsp;<span class="op" id="1756250">&lt;</span>&nbsp;<span class="ident" id="1756252">passive_spin</span><span class="op" id="1756264">;</span>&nbsp;<span class="ident" id="1756266">i</span><span class="op" id="1756267">++</span>&nbsp;<span class="op" id="1756270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756275">for</span>&nbsp;<span class="ident" id="1756279">l</span><span class="op" id="1756280">.</span><span class="ident" id="1756281">key</span>&nbsp;<span class="op" id="1756285">==</span>&nbsp;<span class="ident" id="1756288">mutex_unlocked</span>&nbsp;<span class="op" id="1756303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756309">if</span>&nbsp;<span class="ident" id="1756312">cas</span><span class="op" id="1756315">(</span><span class="ident" id="1756316">key32</span><span class="op" id="1756321">(</span><span class="op" id="1756322">&amp;</span><span class="ident" id="1756323">l</span><span class="op" id="1756324">.</span><span class="ident" id="1756325">key</span><span class="op" id="1756328">)</span><span class="op" id="1756329">,</span>&nbsp;<span class="ident" id="1756331">mutex_unlocked</span><span class="op" id="1756345">,</span>&nbsp;<span class="ident" id="1756347">wait</span><span class="op" id="1756351">)</span>&nbsp;<span class="op" id="1756353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756360">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756381">osyield</span><span class="op" id="1756388">(</span><span class="op" id="1756389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1756398">//&nbsp;Sleep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756410">v</span>&nbsp;<span class="op" id="1756412">=</span>&nbsp;<span class="ident" id="1756414">xchg</span><span class="op" id="1756418">(</span><span class="ident" id="1756419">key32</span><span class="op" id="1756424">(</span><span class="op" id="1756425">&amp;</span><span class="ident" id="1756426">l</span><span class="op" id="1756427">.</span><span class="ident" id="1756428">key</span><span class="op" id="1756431">)</span><span class="op" id="1756432">,</span>&nbsp;<span class="ident" id="1756434">mutex_sleeping</span><span class="op" id="1756448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756452">if</span>&nbsp;<span class="ident" id="1756455">v</span>&nbsp;<span class="op" id="1756457">==</span>&nbsp;<span class="ident" id="1756460">mutex_unlocked</span>&nbsp;<span class="op" id="1756475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756480">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756489">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756493">wait</span>&nbsp;<span class="op" id="1756498">=</span>&nbsp;<span class="ident" id="1756500">mutex_sleeping</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756517">futexsleep</span><span class="op" id="1756527">(</span><span class="ident" id="1756528">key32</span><span class="op" id="1756533">(</span><span class="op" id="1756534">&amp;</span><span class="ident" id="1756535">l</span><span class="op" id="1756536">.</span><span class="ident" id="1756537">key</span><span class="op" id="1756540">)</span><span class="op" id="1756541">,</span>&nbsp;<span class="ident" id="1756543">mutex_sleeping</span><span class="op" id="1756557">,</span>&nbsp;<span class="op" id="1756559">-</span><span class="num" id="1756560">1</span><span class="op" id="1756561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756564">}</span><br>
<span class="lineno"></span><span class="op" id="1756566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="1756569">func</span>&nbsp;<span class="ident" id="1756574">unlock</span><span class="op" id="1756580">(</span><span class="ident" id="1756581">l</span>&nbsp;<span class="op" id="1756583">*</span><span class="ident" id="1756584">mutex</span><span class="op" id="1756589">)</span>&nbsp;<span class="op" id="1756591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756594">v</span>&nbsp;<span class="op" id="1756596">:=</span>&nbsp;<span class="ident" id="1756599">xchg</span><span class="op" id="1756603">(</span><span class="ident" id="1756604">key32</span><span class="op" id="1756609">(</span><span class="op" id="1756610">&amp;</span><span class="ident" id="1756611">l</span><span class="op" id="1756612">.</span><span class="ident" id="1756613">key</span><span class="op" id="1756616">)</span><span class="op" id="1756617">,</span>&nbsp;<span class="ident" id="1756619">mutex_unlocked</span><span class="op" id="1756633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756636">if</span>&nbsp;<span class="ident" id="1756639">v</span>&nbsp;<span class="op" id="1756641">==</span>&nbsp;<span class="ident" id="1756644">mutex_unlocked</span>&nbsp;<span class="op" id="1756659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756663">gothrow</span><span class="op" id="1756670">(</span><span class="string" id="1756671">&#34;unlock&nbsp;of&nbsp;unlocked&nbsp;lock&#34;</span><span class="op" id="1756696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756699">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756702">if</span>&nbsp;<span class="ident" id="1756705">v</span>&nbsp;<span class="op" id="1756707">==</span>&nbsp;<span class="ident" id="1756710">mutex_sleeping</span>&nbsp;<span class="op" id="1756725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756729">futexwakeup</span><span class="op" id="1756740">(</span><span class="ident" id="1756741">key32</span><span class="op" id="1756746">(</span><span class="op" id="1756747">&amp;</span><span class="ident" id="1756748">l</span><span class="op" id="1756749">.</span><span class="ident" id="1756750">key</span><span class="op" id="1756753">)</span><span class="op" id="1756754">,</span>&nbsp;<span class="num" id="1756756">1</span><span class="op" id="1756757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756764">gp</span>&nbsp;<span class="op" id="1756767">:=</span>&nbsp;<span class="ident" id="1756770">getg</span><span class="op" id="1756774">(</span><span class="op" id="1756775">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756778">gp</span><span class="op" id="1756780">.</span><span class="ident" id="1756781">m</span><span class="op" id="1756782">.</span><span class="ident" id="1756783">locks</span><span class="op" id="1756788">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756792">if</span>&nbsp;<span class="ident" id="1756795">gp</span><span class="op" id="1756797">.</span><span class="ident" id="1756798">m</span><span class="op" id="1756799">.</span><span class="ident" id="1756800">locks</span>&nbsp;<span class="op" id="1756806">&lt;</span>&nbsp;<span class="num" id="1756808">0</span>&nbsp;<span class="op" id="1756810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756814">gothrow</span><span class="op" id="1756821">(</span><span class="string" id="1756822">&#34;runtime路unlock:&nbsp;lock&nbsp;count&#34;</span><span class="op" id="1756851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1756857">if</span>&nbsp;<span class="ident" id="1756860">gp</span><span class="op" id="1756862">.</span><span class="ident" id="1756863">m</span><span class="op" id="1756864">.</span><span class="ident" id="1756865">locks</span>&nbsp;<span class="op" id="1756871">==</span>&nbsp;<span class="num" id="1756874">0</span>&nbsp;<span class="op" id="1756876">&amp;&amp;</span>&nbsp;<span class="ident" id="1756879">gp</span><span class="op" id="1756881">.</span><span class="ident" id="1756882">preempt</span>&nbsp;<span class="op" id="1756890">{</span>&nbsp;<span class="comment" id="1756892">//&nbsp;restore&nbsp;the&nbsp;preemption&nbsp;request&nbsp;in&nbsp;case&nbsp;we&#39;ve&nbsp;cleared&nbsp;it&nbsp;in&nbsp;newstack</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1756965">gp</span><span class="op" id="1756967">.</span><span class="ident" id="1756968">stackguard0</span>&nbsp;<span class="op" id="1756980">=</span>&nbsp;<span class="ident" id="1756982">stackPreempt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1756996">}</span><br>
<span class="lineno"></span><span class="op" id="1756998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1757001">//&nbsp;One-time&nbsp;notifications.</span><br>
<span class="lineno">125</span><span class="keyword" id="1757028">func</span>&nbsp;<span class="ident" id="1757033">noteclear</span><span class="op" id="1757042">(</span><span class="ident" id="1757043">n</span>&nbsp;<span class="op" id="1757045">*</span><span class="ident" id="1757046">note</span><span class="op" id="1757050">)</span>&nbsp;<span class="op" id="1757052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757055">n</span><span class="op" id="1757056">.</span><span class="ident" id="1757057">key</span>&nbsp;<span class="op" id="1757061">=</span>&nbsp;<span class="num" id="1757063">0</span><br>
<span class="lineno"></span><span class="op" id="1757065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1757068">func</span>&nbsp;<span class="ident" id="1757073">notewakeup</span><span class="op" id="1757083">(</span><span class="ident" id="1757084">n</span>&nbsp;<span class="op" id="1757086">*</span><span class="ident" id="1757087">note</span><span class="op" id="1757091">)</span>&nbsp;<span class="op" id="1757093">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757096">old</span>&nbsp;<span class="op" id="1757100">:=</span>&nbsp;<span class="ident" id="1757103">xchg</span><span class="op" id="1757107">(</span><span class="ident" id="1757108">key32</span><span class="op" id="1757113">(</span><span class="op" id="1757114">&amp;</span><span class="ident" id="1757115">n</span><span class="op" id="1757116">.</span><span class="ident" id="1757117">key</span><span class="op" id="1757120">)</span><span class="op" id="1757121">,</span>&nbsp;<span class="num" id="1757123">1</span><span class="op" id="1757124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757127">if</span>&nbsp;<span class="ident" id="1757130">old</span>&nbsp;<span class="op" id="1757134">!=</span>&nbsp;<span class="num" id="1757137">0</span>&nbsp;<span class="op" id="1757139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1757143">print</span><span class="op" id="1757148">(</span><span class="string" id="1757149">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&nbsp;(&#34;</span><span class="op" id="1757179">,</span>&nbsp;<span class="ident" id="1757181">old</span><span class="op" id="1757184">,</span>&nbsp;<span class="string" id="1757186">&#34;)\n&#34;</span><span class="op" id="1757191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757195">gothrow</span><span class="op" id="1757202">(</span><span class="string" id="1757203">&#34;notewakeup&nbsp;-&nbsp;double&nbsp;wakeup&#34;</span><span class="op" id="1757231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757234">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757237">futexwakeup</span><span class="op" id="1757248">(</span><span class="ident" id="1757249">key32</span><span class="op" id="1757254">(</span><span class="op" id="1757255">&amp;</span><span class="ident" id="1757256">n</span><span class="op" id="1757257">.</span><span class="ident" id="1757258">key</span><span class="op" id="1757261">)</span><span class="op" id="1757262">,</span>&nbsp;<span class="num" id="1757264">1</span><span class="op" id="1757265">)</span><br>
<span class="lineno"></span><span class="op" id="1757267">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1757270">func</span>&nbsp;<span class="ident" id="1757275">notesleep</span><span class="op" id="1757284">(</span><span class="ident" id="1757285">n</span>&nbsp;<span class="op" id="1757287">*</span><span class="ident" id="1757288">note</span><span class="op" id="1757292">)</span>&nbsp;<span class="op" id="1757294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757297">gp</span>&nbsp;<span class="op" id="1757300">:=</span>&nbsp;<span class="ident" id="1757303">getg</span><span class="op" id="1757307">(</span><span class="op" id="1757308">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757311">if</span>&nbsp;<span class="ident" id="1757314">gp</span>&nbsp;<span class="op" id="1757317">!=</span>&nbsp;<span class="ident" id="1757320">gp</span><span class="op" id="1757322">.</span><span class="ident" id="1757323">m</span><span class="op" id="1757324">.</span><span class="ident" id="1757325">g0</span>&nbsp;<span class="op" id="1757328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757332">gothrow</span><span class="op" id="1757339">(</span><span class="string" id="1757340">&#34;notesleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1757361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757364">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757367">for</span>&nbsp;<span class="ident" id="1757371">atomicload</span><span class="op" id="1757381">(</span><span class="ident" id="1757382">key32</span><span class="op" id="1757387">(</span><span class="op" id="1757388">&amp;</span><span class="ident" id="1757389">n</span><span class="op" id="1757390">.</span><span class="ident" id="1757391">key</span><span class="op" id="1757394">)</span><span class="op" id="1757395">)</span>&nbsp;<span class="op" id="1757397">==</span>&nbsp;<span class="num" id="1757400">0</span>&nbsp;<span class="op" id="1757402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757406">gp</span><span class="op" id="1757408">.</span><span class="ident" id="1757409">m</span><span class="op" id="1757410">.</span><span class="ident" id="1757411">blocked</span>&nbsp;<span class="op" id="1757419">=</span>&nbsp;<span class="builtintype" id="1757421">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757428">futexsleep</span><span class="op" id="1757438">(</span><span class="ident" id="1757439">key32</span><span class="op" id="1757444">(</span><span class="op" id="1757445">&amp;</span><span class="ident" id="1757446">n</span><span class="op" id="1757447">.</span><span class="ident" id="1757448">key</span><span class="op" id="1757451">)</span><span class="op" id="1757452">,</span>&nbsp;<span class="num" id="1757454">0</span><span class="op" id="1757455">,</span>&nbsp;<span class="op" id="1757457">-</span><span class="num" id="1757458">1</span><span class="op" id="1757459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757463">gp</span><span class="op" id="1757465">.</span><span class="ident" id="1757466">m</span><span class="op" id="1757467">.</span><span class="ident" id="1757468">blocked</span>&nbsp;<span class="op" id="1757476">=</span>&nbsp;<span class="builtintype" id="1757478">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757485">}</span><br>
<span class="lineno"></span><span class="op" id="1757487">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="1757490">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1757503">func</span>&nbsp;<span class="ident" id="1757508">notetsleep_internal</span><span class="op" id="1757527">(</span><span class="ident" id="1757528">n</span>&nbsp;<span class="op" id="1757530">*</span><span class="ident" id="1757531">note</span><span class="op" id="1757535">,</span>&nbsp;<span class="ident" id="1757537">ns</span>&nbsp;<span class="ident" id="1757540">int64</span><span class="op" id="1757545">)</span>&nbsp;<span class="builtintype" id="1757547">bool</span>&nbsp;<span class="op" id="1757552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757555">gp</span>&nbsp;<span class="op" id="1757558">:=</span>&nbsp;<span class="ident" id="1757561">getg</span><span class="op" id="1757565">(</span><span class="op" id="1757566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757570">if</span>&nbsp;<span class="ident" id="1757573">ns</span>&nbsp;<span class="op" id="1757576">&lt;</span>&nbsp;<span class="num" id="1757578">0</span>&nbsp;<span class="op" id="1757580">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757584">for</span>&nbsp;<span class="ident" id="1757588">atomicload</span><span class="op" id="1757598">(</span><span class="ident" id="1757599">key32</span><span class="op" id="1757604">(</span><span class="op" id="1757605">&amp;</span><span class="ident" id="1757606">n</span><span class="op" id="1757607">.</span><span class="ident" id="1757608">key</span><span class="op" id="1757611">)</span><span class="op" id="1757612">)</span>&nbsp;<span class="op" id="1757614">==</span>&nbsp;<span class="num" id="1757617">0</span>&nbsp;<span class="op" id="1757619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757624">gp</span><span class="op" id="1757626">.</span><span class="ident" id="1757627">m</span><span class="op" id="1757628">.</span><span class="ident" id="1757629">blocked</span>&nbsp;<span class="op" id="1757637">=</span>&nbsp;<span class="builtintype" id="1757639">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757647">futexsleep</span><span class="op" id="1757657">(</span><span class="ident" id="1757658">key32</span><span class="op" id="1757663">(</span><span class="op" id="1757664">&amp;</span><span class="ident" id="1757665">n</span><span class="op" id="1757666">.</span><span class="ident" id="1757667">key</span><span class="op" id="1757670">)</span><span class="op" id="1757671">,</span>&nbsp;<span class="num" id="1757673">0</span><span class="op" id="1757674">,</span>&nbsp;<span class="op" id="1757676">-</span><span class="num" id="1757677">1</span><span class="op" id="1757678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757683">gp</span><span class="op" id="1757685">.</span><span class="ident" id="1757686">m</span><span class="op" id="1757687">.</span><span class="ident" id="1757688">blocked</span>&nbsp;<span class="op" id="1757696">=</span>&nbsp;<span class="builtintype" id="1757698">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757706">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757710">return</span>&nbsp;<span class="builtintype" id="1757717">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757723">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757727">if</span>&nbsp;<span class="ident" id="1757730">atomicload</span><span class="op" id="1757740">(</span><span class="ident" id="1757741">key32</span><span class="op" id="1757746">(</span><span class="op" id="1757747">&amp;</span><span class="ident" id="1757748">n</span><span class="op" id="1757749">.</span><span class="ident" id="1757750">key</span><span class="op" id="1757753">)</span><span class="op" id="1757754">)</span>&nbsp;<span class="op" id="1757756">!=</span>&nbsp;<span class="num" id="1757759">0</span>&nbsp;<span class="op" id="1757761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757765">return</span>&nbsp;<span class="builtintype" id="1757772">true</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757782">deadline</span>&nbsp;<span class="op" id="1757791">:=</span>&nbsp;<span class="ident" id="1757794">nanotime</span><span class="op" id="1757802">(</span><span class="op" id="1757803">)</span>&nbsp;<span class="op" id="1757805">+</span>&nbsp;<span class="ident" id="1757807">ns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757811">for</span>&nbsp;<span class="op" id="1757815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757819">gp</span><span class="op" id="1757821">.</span><span class="ident" id="1757822">m</span><span class="op" id="1757823">.</span><span class="ident" id="1757824">blocked</span>&nbsp;<span class="op" id="1757832">=</span>&nbsp;<span class="builtintype" id="1757834">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757841">futexsleep</span><span class="op" id="1757851">(</span><span class="ident" id="1757852">key32</span><span class="op" id="1757857">(</span><span class="op" id="1757858">&amp;</span><span class="ident" id="1757859">n</span><span class="op" id="1757860">.</span><span class="ident" id="1757861">key</span><span class="op" id="1757864">)</span><span class="op" id="1757865">,</span>&nbsp;<span class="num" id="1757867">0</span><span class="op" id="1757868">,</span>&nbsp;<span class="ident" id="1757870">ns</span><span class="op" id="1757872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757876">gp</span><span class="op" id="1757878">.</span><span class="ident" id="1757879">m</span><span class="op" id="1757880">.</span><span class="ident" id="1757881">blocked</span>&nbsp;<span class="op" id="1757889">=</span>&nbsp;<span class="builtintype" id="1757891">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757899">if</span>&nbsp;<span class="ident" id="1757902">atomicload</span><span class="op" id="1757912">(</span><span class="ident" id="1757913">key32</span><span class="op" id="1757918">(</span><span class="op" id="1757919">&amp;</span><span class="ident" id="1757920">n</span><span class="op" id="1757921">.</span><span class="ident" id="1757922">key</span><span class="op" id="1757925">)</span><span class="op" id="1757926">)</span>&nbsp;<span class="op" id="1757928">!=</span>&nbsp;<span class="num" id="1757931">0</span>&nbsp;<span class="op" id="1757933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757938">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1757946">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1757950">now</span>&nbsp;<span class="op" id="1757954">:=</span>&nbsp;<span class="ident" id="1757957">nanotime</span><span class="op" id="1757965">(</span><span class="op" id="1757966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757970">if</span>&nbsp;<span class="ident" id="1757973">now</span>&nbsp;<span class="op" id="1757977">&gt;=</span>&nbsp;<span class="ident" id="1757980">deadline</span>&nbsp;<span class="op" id="1757989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1757994">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1758002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758006">ns</span>&nbsp;<span class="op" id="1758009">=</span>&nbsp;<span class="ident" id="1758011">deadline</span>&nbsp;<span class="op" id="1758020">-</span>&nbsp;<span class="ident" id="1758022">now</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1758027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1758030">return</span>&nbsp;<span class="ident" id="1758037">atomicload</span><span class="op" id="1758047">(</span><span class="ident" id="1758048">key32</span><span class="op" id="1758053">(</span><span class="op" id="1758054">&amp;</span><span class="ident" id="1758055">n</span><span class="op" id="1758056">.</span><span class="ident" id="1758057">key</span><span class="op" id="1758060">)</span><span class="op" id="1758061">)</span>&nbsp;<span class="op" id="1758063">!=</span>&nbsp;<span class="num" id="1758066">0</span><br>
<span class="lineno"></span><span class="op" id="1758068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1758071">func</span>&nbsp;<span class="ident" id="1758076">notetsleep</span><span class="op" id="1758086">(</span><span class="ident" id="1758087">n</span>&nbsp;<span class="op" id="1758089">*</span><span class="ident" id="1758090">note</span><span class="op" id="1758094">,</span>&nbsp;<span class="ident" id="1758096">ns</span>&nbsp;<span class="ident" id="1758099">int64</span><span class="op" id="1758104">)</span>&nbsp;<span class="builtintype" id="1758106">bool</span>&nbsp;<span class="op" id="1758111">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758114">gp</span>&nbsp;<span class="op" id="1758117">:=</span>&nbsp;<span class="ident" id="1758120">getg</span><span class="op" id="1758124">(</span><span class="op" id="1758125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1758128">if</span>&nbsp;<span class="ident" id="1758131">gp</span>&nbsp;<span class="op" id="1758134">!=</span>&nbsp;<span class="ident" id="1758137">gp</span><span class="op" id="1758139">.</span><span class="ident" id="1758140">m</span><span class="op" id="1758141">.</span><span class="ident" id="1758142">g0</span>&nbsp;<span class="op" id="1758145">&amp;&amp;</span>&nbsp;<span class="ident" id="1758148">gp</span><span class="op" id="1758150">.</span><span class="ident" id="1758151">m</span><span class="op" id="1758152">.</span><span class="ident" id="1758153">gcing</span>&nbsp;<span class="op" id="1758159">==</span>&nbsp;<span class="num" id="1758162">0</span>&nbsp;<span class="op" id="1758164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758168">gothrow</span><span class="op" id="1758175">(</span><span class="string" id="1758176">&#34;notetsleep&nbsp;not&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1758198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1758201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1758205">return</span>&nbsp;<span class="ident" id="1758212">notetsleep_internal</span><span class="op" id="1758231">(</span><span class="ident" id="1758232">n</span><span class="op" id="1758233">,</span>&nbsp;<span class="ident" id="1758235">ns</span><span class="op" id="1758237">)</span><br>
<span class="lineno"></span><span class="op" id="1758239">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1758242">//&nbsp;same&nbsp;as&nbsp;runtime路notetsleep,&nbsp;but&nbsp;called&nbsp;on&nbsp;user&nbsp;g&nbsp;(not&nbsp;g0)</span><br>
<span class="lineno"></span><span class="comment" id="1758304">//&nbsp;calls&nbsp;only&nbsp;nosplit&nbsp;functions&nbsp;between&nbsp;entersyscallblock/exitsyscall</span><br>
<span class="lineno">195</span><span class="keyword" id="1758374">func</span>&nbsp;<span class="ident" id="1758379">notetsleepg</span><span class="op" id="1758390">(</span><span class="ident" id="1758391">n</span>&nbsp;<span class="op" id="1758393">*</span><span class="ident" id="1758394">note</span><span class="op" id="1758398">,</span>&nbsp;<span class="ident" id="1758400">ns</span>&nbsp;<span class="ident" id="1758403">int64</span><span class="op" id="1758408">)</span>&nbsp;<span class="builtintype" id="1758410">bool</span>&nbsp;<span class="op" id="1758415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758418">gp</span>&nbsp;<span class="op" id="1758421">:=</span>&nbsp;<span class="ident" id="1758424">getg</span><span class="op" id="1758428">(</span><span class="op" id="1758429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1758432">if</span>&nbsp;<span class="ident" id="1758435">gp</span>&nbsp;<span class="op" id="1758438">==</span>&nbsp;<span class="ident" id="1758441">gp</span><span class="op" id="1758443">.</span><span class="ident" id="1758444">m</span><span class="op" id="1758445">.</span><span class="ident" id="1758446">g0</span>&nbsp;<span class="op" id="1758449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758453">gothrow</span><span class="op" id="1758460">(</span><span class="string" id="1758461">&#34;notetsleepg&nbsp;on&nbsp;g0&#34;</span><span class="op" id="1758480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1758483">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758487">entersyscallblock</span><span class="op" id="1758504">(</span><span class="op" id="1758505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758508">ok</span>&nbsp;<span class="op" id="1758511">:=</span>&nbsp;<span class="ident" id="1758514">notetsleep_internal</span><span class="op" id="1758533">(</span><span class="ident" id="1758534">n</span><span class="op" id="1758535">,</span>&nbsp;<span class="ident" id="1758537">ns</span><span class="op" id="1758539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1758542">exitsyscall</span><span class="op" id="1758553">(</span><span class="op" id="1758554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1758557">return</span>&nbsp;<span class="ident" id="1758564">ok</span><br>
<span class="lineno">205</span><span class="op" id="1758567">}</span>
</div>
</body>
</html>
