<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3881604">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3881659">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3881713">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3881764">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3881810">package</span>&nbsp;<span class="ident" id="3881818">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3881823">import</span>&nbsp;<span class="op" id="3881830">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881833">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881842">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881859">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881876">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881891">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881901">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881908">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881914">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881921">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3881929">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="3881936">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3881939">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3881982">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3882023">type</span>&nbsp;<span class="ident" id="3882028">Conn</span>&nbsp;<span class="keyword" id="3882033">struct</span>&nbsp;<span class="op" id="3882040">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882043">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882056">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882065">net</span><span class="op" id="3882068">.</span><span class="ident" id="3882069">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882075">isClient</span>&nbsp;<span class="builtintype" id="3882084">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882091">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882149">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882167">sync</span><span class="op" id="3882171">.</span><span class="ident" id="3882172">Mutex</span>&nbsp;<span class="comment" id="3882178">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882229">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882247">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882258">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882293">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882311">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882322">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882338">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882356">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882367">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882399">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3882417">*</span><span class="ident" id="3882418">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882428">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882468">handshakeComplete</span>&nbsp;<span class="builtintype" id="3882486">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882492">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882510">bool</span>&nbsp;<span class="comment" id="3882515">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882568">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3882586">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882594">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3882612">[</span><span class="op" id="3882613">]</span><span class="builtintype" id="3882614">byte</span>&nbsp;<span class="comment" id="3882619">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882645">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="3882663">[</span><span class="op" id="3882664">]</span><span class="op" id="3882665">*</span><span class="ident" id="3882666">x509</span><span class="op" id="3882670">.</span><span class="ident" id="3882671">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882684">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882753">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882802">verifiedChains</span>&nbsp;<span class="op" id="3882817">[</span><span class="op" id="3882818">]</span><span class="op" id="3882819">[</span><span class="op" id="3882820">]</span><span class="op" id="3882821">*</span><span class="ident" id="3882822">x509</span><span class="op" id="3882826">.</span><span class="ident" id="3882827">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882840">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3882913">serverName</span>&nbsp;<span class="builtintype" id="3882924">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882932">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3882999">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883062">firstFinished</span>&nbsp;<span class="op" id="3883076">[</span><span class="num" id="3883077">12</span><span class="op" id="3883079">]</span><span class="builtintype" id="3883080">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883087">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3883110">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883118">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="3883141">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3883148">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883165">in</span><span class="op" id="3883167">,</span>&nbsp;<span class="ident" id="3883169">out</span>&nbsp;&nbsp;<span class="ident" id="3883174">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3883187">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883212">rawInput</span>&nbsp;<span class="op" id="3883221">*</span><span class="ident" id="3883222">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3883234">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883268">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3883277">*</span><span class="ident" id="3883278">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3883290">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883330">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883339">bytes</span><span class="op" id="3883344">.</span><span class="ident" id="3883345">Buffer</span>&nbsp;<span class="comment" id="3883352">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3883391">tmp</span>&nbsp;<span class="op" id="3883395">[</span><span class="num" id="3883396">16</span><span class="op" id="3883398">]</span><span class="builtintype" id="3883399">byte</span><br>
<span class="lineno"></span><span class="op" id="3883404">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3883407">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="3883438">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="3883487">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3883520">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3883568">func</span>&nbsp;<span class="op" id="3883573">(</span><span class="ident" id="3883574">c</span>&nbsp;<span class="op" id="3883576">*</span><span class="ident" id="3883577">Conn</span><span class="op" id="3883581">)</span>&nbsp;<span class="ident" id="3883583">LocalAddr</span><span class="op" id="3883592">(</span><span class="op" id="3883593">)</span>&nbsp;<span class="ident" id="3883595">net</span><span class="op" id="3883598">.</span><span class="ident" id="3883599">Addr</span>&nbsp;<span class="op" id="3883604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3883607">return</span>&nbsp;<span class="ident" id="3883614">c</span><span class="op" id="3883615">.</span><span class="ident" id="3883616">conn</span><span class="op" id="3883620">.</span><span class="ident" id="3883621">LocalAddr</span><span class="op" id="3883630">(</span><span class="op" id="3883631">)</span><br>
<span class="lineno"></span><span class="op" id="3883633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="3883636">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="3883686">func</span>&nbsp;<span class="op" id="3883691">(</span><span class="ident" id="3883692">c</span>&nbsp;<span class="op" id="3883694">*</span><span class="ident" id="3883695">Conn</span><span class="op" id="3883699">)</span>&nbsp;<span class="ident" id="3883701">RemoteAddr</span><span class="op" id="3883711">(</span><span class="op" id="3883712">)</span>&nbsp;<span class="ident" id="3883714">net</span><span class="op" id="3883717">.</span><span class="ident" id="3883718">Addr</span>&nbsp;<span class="op" id="3883723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3883726">return</span>&nbsp;<span class="ident" id="3883733">c</span><span class="op" id="3883734">.</span><span class="ident" id="3883735">conn</span><span class="op" id="3883739">.</span><span class="ident" id="3883740">RemoteAddr</span><span class="op" id="3883750">(</span><span class="op" id="3883751">)</span><br>
<span class="lineno"></span><span class="op" id="3883753">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="3883756">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3883837">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="3883899">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3884006">func</span>&nbsp;<span class="op" id="3884011">(</span><span class="ident" id="3884012">c</span>&nbsp;<span class="op" id="3884014">*</span><span class="ident" id="3884015">Conn</span><span class="op" id="3884019">)</span>&nbsp;<span class="ident" id="3884021">SetDeadline</span><span class="op" id="3884032">(</span><span class="ident" id="3884033">t</span>&nbsp;<span class="ident" id="3884035">time</span><span class="op" id="3884039">.</span><span class="ident" id="3884040">Time</span><span class="op" id="3884044">)</span>&nbsp;<span class="builtintype" id="3884046">error</span>&nbsp;<span class="op" id="3884052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3884055">return</span>&nbsp;<span class="ident" id="3884062">c</span><span class="op" id="3884063">.</span><span class="ident" id="3884064">conn</span><span class="op" id="3884068">.</span><span class="ident" id="3884069">SetDeadline</span><span class="op" id="3884080">(</span><span class="ident" id="3884081">t</span><span class="op" id="3884082">)</span><br>
<span class="lineno">80</span><span class="op" id="3884084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884087">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3884159">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3884211">func</span>&nbsp;<span class="op" id="3884216">(</span><span class="ident" id="3884217">c</span>&nbsp;<span class="op" id="3884219">*</span><span class="ident" id="3884220">Conn</span><span class="op" id="3884224">)</span>&nbsp;<span class="ident" id="3884226">SetReadDeadline</span><span class="op" id="3884241">(</span><span class="ident" id="3884242">t</span>&nbsp;<span class="ident" id="3884244">time</span><span class="op" id="3884248">.</span><span class="ident" id="3884249">Time</span><span class="op" id="3884253">)</span>&nbsp;<span class="builtintype" id="3884255">error</span>&nbsp;<span class="op" id="3884261">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3884264">return</span>&nbsp;<span class="ident" id="3884271">c</span><span class="op" id="3884272">.</span><span class="ident" id="3884273">conn</span><span class="op" id="3884277">.</span><span class="ident" id="3884278">SetReadDeadline</span><span class="op" id="3884293">(</span><span class="ident" id="3884294">t</span><span class="op" id="3884295">)</span><br>
<span class="lineno"></span><span class="op" id="3884297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3884300">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3884374">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="3884427">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3884534">func</span>&nbsp;<span class="op" id="3884539">(</span><span class="ident" id="3884540">c</span>&nbsp;<span class="op" id="3884542">*</span><span class="ident" id="3884543">Conn</span><span class="op" id="3884547">)</span>&nbsp;<span class="ident" id="3884549">SetWriteDeadline</span><span class="op" id="3884565">(</span><span class="ident" id="3884566">t</span>&nbsp;<span class="ident" id="3884568">time</span><span class="op" id="3884572">.</span><span class="ident" id="3884573">Time</span><span class="op" id="3884577">)</span>&nbsp;<span class="builtintype" id="3884579">error</span>&nbsp;<span class="op" id="3884585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3884588">return</span>&nbsp;<span class="ident" id="3884595">c</span><span class="op" id="3884596">.</span><span class="ident" id="3884597">conn</span><span class="op" id="3884601">.</span><span class="ident" id="3884602">SetWriteDeadline</span><span class="op" id="3884618">(</span><span class="ident" id="3884619">t</span><span class="op" id="3884620">)</span><br>
<span class="lineno"></span><span class="op" id="3884622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3884625">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="3884684">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="3884728">type</span>&nbsp;<span class="ident" id="3884733">halfConn</span>&nbsp;<span class="keyword" id="3884742">struct</span>&nbsp;<span class="op" id="3884749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884752">sync</span><span class="op" id="3884756">.</span><span class="ident" id="3884757">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884765">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3884773">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3884785">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884811">version</span>&nbsp;<span class="builtintype" id="3884819">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3884831">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884852">cipher</span>&nbsp;&nbsp;<span class="keyword" id="3884860">interface</span><span class="op" id="3884869">{</span><span class="op" id="3884870">}</span>&nbsp;<span class="comment" id="3884872">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884893">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884901">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884914">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3884922">[</span><span class="num" id="3884923">8</span><span class="op" id="3884924">]</span><span class="builtintype" id="3884925">byte</span>&nbsp;<span class="comment" id="3884930">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884957">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3884965">*</span><span class="ident" id="3884966">block</span>&nbsp;&nbsp;<span class="comment" id="3884973">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3884998">nextCipher</span>&nbsp;<span class="keyword" id="3885009">interface</span><span class="op" id="3885018">{</span><span class="op" id="3885019">}</span>&nbsp;<span class="comment" id="3885021">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885047">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885058">macFunction</span>&nbsp;<span class="comment" id="3885070">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3885094">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885149">inDigestBuf</span><span class="op" id="3885160">,</span>&nbsp;<span class="ident" id="3885162">outDigestBuf</span>&nbsp;<span class="op" id="3885175">[</span><span class="op" id="3885176">]</span><span class="builtintype" id="3885177">byte</span><br>
<span class="lineno"></span><span class="op" id="3885182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885185">func</span>&nbsp;<span class="op" id="3885190">(</span><span class="ident" id="3885191">hc</span>&nbsp;<span class="op" id="3885194">*</span><span class="ident" id="3885195">halfConn</span><span class="op" id="3885203">)</span>&nbsp;<span class="ident" id="3885205">setErrorLocked</span><span class="op" id="3885219">(</span><span class="ident" id="3885220">err</span>&nbsp;<span class="builtintype" id="3885224">error</span><span class="op" id="3885229">)</span>&nbsp;<span class="builtintype" id="3885231">error</span>&nbsp;<span class="op" id="3885237">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885240">hc</span><span class="op" id="3885242">.</span><span class="ident" id="3885243">err</span>&nbsp;<span class="op" id="3885247">=</span>&nbsp;<span class="ident" id="3885249">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885254">return</span>&nbsp;<span class="ident" id="3885261">err</span><br>
<span class="lineno"></span><span class="op" id="3885265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3885268">func</span>&nbsp;<span class="op" id="3885273">(</span><span class="ident" id="3885274">hc</span>&nbsp;<span class="op" id="3885277">*</span><span class="ident" id="3885278">halfConn</span><span class="op" id="3885286">)</span>&nbsp;<span class="builtintype" id="3885288">error</span><span class="op" id="3885293">(</span><span class="op" id="3885294">)</span>&nbsp;<span class="builtintype" id="3885296">error</span>&nbsp;<span class="op" id="3885302">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885305">hc</span><span class="op" id="3885307">.</span><span class="ident" id="3885308">Lock</span><span class="op" id="3885312">(</span><span class="op" id="3885313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885316">err</span>&nbsp;<span class="op" id="3885320">:=</span>&nbsp;<span class="ident" id="3885323">hc</span><span class="op" id="3885325">.</span><span class="ident" id="3885326">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885331">hc</span><span class="op" id="3885333">.</span><span class="ident" id="3885334">Unlock</span><span class="op" id="3885340">(</span><span class="op" id="3885341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885344">return</span>&nbsp;<span class="ident" id="3885351">err</span><br>
<span class="lineno"></span><span class="op" id="3885355">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="3885358">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="3885414">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3885462">func</span>&nbsp;<span class="op" id="3885467">(</span><span class="ident" id="3885468">hc</span>&nbsp;<span class="op" id="3885471">*</span><span class="ident" id="3885472">halfConn</span><span class="op" id="3885480">)</span>&nbsp;<span class="ident" id="3885482">prepareCipherSpec</span><span class="op" id="3885499">(</span><span class="ident" id="3885500">version</span>&nbsp;<span class="builtintype" id="3885508">uint16</span><span class="op" id="3885514">,</span>&nbsp;<span class="ident" id="3885516">cipher</span>&nbsp;<span class="keyword" id="3885523">interface</span><span class="op" id="3885532">{</span><span class="op" id="3885533">}</span><span class="op" id="3885534">,</span>&nbsp;<span class="ident" id="3885536">mac</span>&nbsp;<span class="ident" id="3885540">macFunction</span><span class="op" id="3885551">)</span>&nbsp;<span class="op" id="3885553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885556">hc</span><span class="op" id="3885558">.</span><span class="ident" id="3885559">version</span>&nbsp;<span class="op" id="3885567">=</span>&nbsp;<span class="ident" id="3885569">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885578">hc</span><span class="op" id="3885580">.</span><span class="ident" id="3885581">nextCipher</span>&nbsp;<span class="op" id="3885592">=</span>&nbsp;<span class="ident" id="3885594">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885602">hc</span><span class="op" id="3885604">.</span><span class="ident" id="3885605">nextMac</span>&nbsp;<span class="op" id="3885613">=</span>&nbsp;<span class="ident" id="3885615">mac</span><br>
<span class="lineno"></span><span class="op" id="3885619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3885622">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="3885680">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="3885735">func</span>&nbsp;<span class="op" id="3885740">(</span><span class="ident" id="3885741">hc</span>&nbsp;<span class="op" id="3885744">*</span><span class="ident" id="3885745">halfConn</span><span class="op" id="3885753">)</span>&nbsp;<span class="ident" id="3885755">changeCipherSpec</span><span class="op" id="3885771">(</span><span class="op" id="3885772">)</span>&nbsp;<span class="builtintype" id="3885774">error</span>&nbsp;<span class="op" id="3885780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885783">if</span>&nbsp;<span class="ident" id="3885786">hc</span><span class="op" id="3885788">.</span><span class="ident" id="3885789">nextCipher</span>&nbsp;<span class="op" id="3885800">==</span>&nbsp;<span class="ident" id="3885803">nil</span>&nbsp;<span class="op" id="3885807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885811">return</span>&nbsp;<span class="ident" id="3885818">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885838">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885841">hc</span><span class="op" id="3885843">.</span><span class="ident" id="3885844">cipher</span>&nbsp;<span class="op" id="3885851">=</span>&nbsp;<span class="ident" id="3885853">hc</span><span class="op" id="3885855">.</span><span class="ident" id="3885856">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885868">hc</span><span class="op" id="3885870">.</span><span class="ident" id="3885871">mac</span>&nbsp;<span class="op" id="3885875">=</span>&nbsp;<span class="ident" id="3885877">hc</span><span class="op" id="3885879">.</span><span class="ident" id="3885880">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885889">hc</span><span class="op" id="3885891">.</span><span class="ident" id="3885892">nextCipher</span>&nbsp;<span class="op" id="3885903">=</span>&nbsp;<span class="ident" id="3885905">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885910">hc</span><span class="op" id="3885912">.</span><span class="ident" id="3885913">nextMac</span>&nbsp;<span class="op" id="3885921">=</span>&nbsp;<span class="ident" id="3885923">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885928">for</span>&nbsp;<span class="ident" id="3885932">i</span>&nbsp;<span class="op" id="3885934">:=</span>&nbsp;<span class="keyword" id="3885937">range</span>&nbsp;<span class="ident" id="3885943">hc</span><span class="op" id="3885945">.</span><span class="ident" id="3885946">seq</span>&nbsp;<span class="op" id="3885950">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3885954">hc</span><span class="op" id="3885956">.</span><span class="ident" id="3885957">seq</span><span class="op" id="3885960">[</span><span class="ident" id="3885961">i</span><span class="op" id="3885962">]</span>&nbsp;<span class="op" id="3885964">=</span>&nbsp;<span class="num" id="3885966">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3885969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3885972">return</span>&nbsp;<span class="ident" id="3885979">nil</span><br>
<span class="lineno"></span><span class="op" id="3885983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="3885986">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="3886028">func</span>&nbsp;<span class="op" id="3886033">(</span><span class="ident" id="3886034">hc</span>&nbsp;<span class="op" id="3886037">*</span><span class="ident" id="3886038">halfConn</span><span class="op" id="3886046">)</span>&nbsp;<span class="ident" id="3886048">incSeq</span><span class="op" id="3886054">(</span><span class="op" id="3886055">)</span>&nbsp;<span class="op" id="3886057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886060">for</span>&nbsp;<span class="ident" id="3886064">i</span>&nbsp;<span class="op" id="3886066">:=</span>&nbsp;<span class="num" id="3886069">7</span><span class="op" id="3886070">;</span>&nbsp;<span class="ident" id="3886072">i</span>&nbsp;<span class="op" id="3886074">&gt;=</span>&nbsp;<span class="num" id="3886077">0</span><span class="op" id="3886078">;</span>&nbsp;<span class="ident" id="3886080">i</span><span class="op" id="3886081">--</span>&nbsp;<span class="op" id="3886084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886088">hc</span><span class="op" id="3886090">.</span><span class="ident" id="3886091">seq</span><span class="op" id="3886094">[</span><span class="ident" id="3886095">i</span><span class="op" id="3886096">]</span><span class="op" id="3886097">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886102">if</span>&nbsp;<span class="ident" id="3886105">hc</span><span class="op" id="3886107">.</span><span class="ident" id="3886108">seq</span><span class="op" id="3886111">[</span><span class="ident" id="3886112">i</span><span class="op" id="3886113">]</span>&nbsp;<span class="op" id="3886115">!=</span>&nbsp;<span class="num" id="3886118">0</span>&nbsp;<span class="op" id="3886120">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886125">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886137">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886141">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886186">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886232">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3886265">panic</span><span class="op" id="3886270">(</span><span class="string" id="3886271">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="3886304">)</span><br>
<span class="lineno"></span><span class="op" id="3886306">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3886309">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="3886357">func</span>&nbsp;<span class="op" id="3886362">(</span><span class="ident" id="3886363">hc</span>&nbsp;<span class="op" id="3886366">*</span><span class="ident" id="3886367">halfConn</span><span class="op" id="3886375">)</span>&nbsp;<span class="ident" id="3886377">resetSeq</span><span class="op" id="3886385">(</span><span class="op" id="3886386">)</span>&nbsp;<span class="op" id="3886388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886391">for</span>&nbsp;<span class="ident" id="3886395">i</span>&nbsp;<span class="op" id="3886397">:=</span>&nbsp;<span class="keyword" id="3886400">range</span>&nbsp;<span class="ident" id="3886406">hc</span><span class="op" id="3886408">.</span><span class="ident" id="3886409">seq</span>&nbsp;<span class="op" id="3886413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886417">hc</span><span class="op" id="3886419">.</span><span class="ident" id="3886420">seq</span><span class="op" id="3886423">[</span><span class="ident" id="3886424">i</span><span class="op" id="3886425">]</span>&nbsp;<span class="op" id="3886427">=</span>&nbsp;<span class="num" id="3886429">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886432">}</span><br>
<span class="lineno">170</span><span class="op" id="3886434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3886437">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3886517">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3886594">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="3886654">func</span>&nbsp;<span class="ident" id="3886659">removePadding</span><span class="op" id="3886672">(</span><span class="ident" id="3886673">payload</span>&nbsp;<span class="op" id="3886681">[</span><span class="op" id="3886682">]</span><span class="builtintype" id="3886683">byte</span><span class="op" id="3886687">)</span>&nbsp;<span class="op" id="3886689">(</span><span class="op" id="3886690">[</span><span class="op" id="3886691">]</span><span class="builtintype" id="3886692">byte</span><span class="op" id="3886696">,</span>&nbsp;<span class="builtintype" id="3886698">byte</span><span class="op" id="3886702">)</span>&nbsp;<span class="op" id="3886704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886707">if</span>&nbsp;<span class="builtinfunc" id="3886710">len</span><span class="op" id="3886713">(</span><span class="ident" id="3886714">payload</span><span class="op" id="3886721">)</span>&nbsp;<span class="op" id="3886723">&lt;</span>&nbsp;<span class="num" id="3886725">1</span>&nbsp;<span class="op" id="3886727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3886731">return</span>&nbsp;<span class="ident" id="3886738">payload</span><span class="op" id="3886745">,</span>&nbsp;<span class="num" id="3886747">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3886750">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886754">paddingLen</span>&nbsp;<span class="op" id="3886765">:=</span>&nbsp;<span class="ident" id="3886768">payload</span><span class="op" id="3886775">[</span><span class="builtinfunc" id="3886776">len</span><span class="op" id="3886779">(</span><span class="ident" id="3886780">payload</span><span class="op" id="3886787">)</span><span class="op" id="3886788">-</span><span class="num" id="3886789">1</span><span class="op" id="3886790">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886793">t</span>&nbsp;<span class="op" id="3886795">:=</span>&nbsp;<span class="builtintype" id="3886798">uint</span><span class="op" id="3886802">(</span><span class="builtinfunc" id="3886803">len</span><span class="op" id="3886806">(</span><span class="ident" id="3886807">payload</span><span class="op" id="3886814">)</span><span class="op" id="3886815">-</span><span class="num" id="3886816">1</span><span class="op" id="3886817">)</span>&nbsp;<span class="op" id="3886819">-</span>&nbsp;<span class="builtintype" id="3886821">uint</span><span class="op" id="3886825">(</span><span class="ident" id="3886826">paddingLen</span><span class="op" id="3886836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886839">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886905">good</span>&nbsp;<span class="op" id="3886910">:=</span>&nbsp;<span class="builtintype" id="3886913">byte</span><span class="op" id="3886917">(</span><span class="builtintype" id="3886918">int32</span><span class="op" id="3886923">(</span><span class="op" id="3886924">^</span><span class="ident" id="3886925">t</span><span class="op" id="3886926">)</span>&nbsp;<span class="op" id="3886928">&gt;&gt;</span>&nbsp;<span class="num" id="3886931">31</span><span class="op" id="3886933">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3886937">toCheck</span>&nbsp;<span class="op" id="3886945">:=</span>&nbsp;<span class="num" id="3886948">255</span>&nbsp;<span class="comment" id="3886952">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3886992">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887062">if</span>&nbsp;<span class="ident" id="3887065">toCheck</span><span class="op" id="3887072">+</span><span class="num" id="3887073">1</span>&nbsp;<span class="op" id="3887075">&gt;</span>&nbsp;<span class="builtinfunc" id="3887077">len</span><span class="op" id="3887080">(</span><span class="ident" id="3887081">payload</span><span class="op" id="3887088">)</span>&nbsp;<span class="op" id="3887090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887094">toCheck</span>&nbsp;<span class="op" id="3887102">=</span>&nbsp;<span class="builtinfunc" id="3887104">len</span><span class="op" id="3887107">(</span><span class="ident" id="3887108">payload</span><span class="op" id="3887115">)</span>&nbsp;<span class="op" id="3887117">-</span>&nbsp;<span class="num" id="3887119">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887122">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887126">for</span>&nbsp;<span class="ident" id="3887130">i</span>&nbsp;<span class="op" id="3887132">:=</span>&nbsp;<span class="num" id="3887135">0</span><span class="op" id="3887136">;</span>&nbsp;<span class="ident" id="3887138">i</span>&nbsp;<span class="op" id="3887140">&lt;</span>&nbsp;<span class="ident" id="3887142">toCheck</span><span class="op" id="3887149">;</span>&nbsp;<span class="ident" id="3887151">i</span><span class="op" id="3887152">++</span>&nbsp;<span class="op" id="3887155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887159">t</span>&nbsp;<span class="op" id="3887161">:=</span>&nbsp;<span class="builtintype" id="3887164">uint</span><span class="op" id="3887168">(</span><span class="ident" id="3887169">paddingLen</span><span class="op" id="3887179">)</span>&nbsp;<span class="op" id="3887181">-</span>&nbsp;<span class="builtintype" id="3887183">uint</span><span class="op" id="3887187">(</span><span class="ident" id="3887188">i</span><span class="op" id="3887189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3887193">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887243">mask</span>&nbsp;<span class="op" id="3887248">:=</span>&nbsp;<span class="builtintype" id="3887251">byte</span><span class="op" id="3887255">(</span><span class="builtintype" id="3887256">int32</span><span class="op" id="3887261">(</span><span class="op" id="3887262">^</span><span class="ident" id="3887263">t</span><span class="op" id="3887264">)</span>&nbsp;<span class="op" id="3887266">&gt;&gt;</span>&nbsp;<span class="num" id="3887269">31</span><span class="op" id="3887271">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887275">b</span>&nbsp;<span class="op" id="3887277">:=</span>&nbsp;<span class="ident" id="3887280">payload</span><span class="op" id="3887287">[</span><span class="builtinfunc" id="3887288">len</span><span class="op" id="3887291">(</span><span class="ident" id="3887292">payload</span><span class="op" id="3887299">)</span><span class="op" id="3887300">-</span><span class="num" id="3887301">1</span><span class="op" id="3887302">-</span><span class="ident" id="3887303">i</span><span class="op" id="3887304">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887308">good</span>&nbsp;<span class="op" id="3887313">&amp;^=</span>&nbsp;<span class="ident" id="3887317">mask</span><span class="op" id="3887321">&amp;</span><span class="ident" id="3887322">paddingLen</span>&nbsp;<span class="op" id="3887333">^</span>&nbsp;<span class="ident" id="3887335">mask</span><span class="op" id="3887339">&amp;</span><span class="ident" id="3887340">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887343">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3887347">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3887416">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887434">good</span>&nbsp;<span class="op" id="3887439">&amp;=</span>&nbsp;<span class="ident" id="3887442">good</span>&nbsp;<span class="op" id="3887447">&lt;&lt;</span>&nbsp;<span class="num" id="3887450">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887453">good</span>&nbsp;<span class="op" id="3887458">&amp;=</span>&nbsp;<span class="ident" id="3887461">good</span>&nbsp;<span class="op" id="3887466">&lt;&lt;</span>&nbsp;<span class="num" id="3887469">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887472">good</span>&nbsp;<span class="op" id="3887477">&amp;=</span>&nbsp;<span class="ident" id="3887480">good</span>&nbsp;<span class="op" id="3887485">&lt;&lt;</span>&nbsp;<span class="num" id="3887488">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887491">good</span>&nbsp;<span class="op" id="3887496">=</span>&nbsp;<span class="builtintype" id="3887498">uint8</span><span class="op" id="3887503">(</span><span class="builtintype" id="3887504">int8</span><span class="op" id="3887508">(</span><span class="ident" id="3887509">good</span><span class="op" id="3887513">)</span>&nbsp;<span class="op" id="3887515">&gt;&gt;</span>&nbsp;<span class="num" id="3887518">7</span><span class="op" id="3887519">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887523">toRemove</span>&nbsp;<span class="op" id="3887532">:=</span>&nbsp;<span class="ident" id="3887535">good</span><span class="op" id="3887539">&amp;</span><span class="ident" id="3887540">paddingLen</span>&nbsp;<span class="op" id="3887551">+</span>&nbsp;<span class="num" id="3887553">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887556">return</span>&nbsp;<span class="ident" id="3887563">payload</span><span class="op" id="3887570">[</span><span class="op" id="3887571">:</span><span class="builtinfunc" id="3887572">len</span><span class="op" id="3887575">(</span><span class="ident" id="3887576">payload</span><span class="op" id="3887583">)</span><span class="op" id="3887584">-</span><span class="builtintype" id="3887585">int</span><span class="op" id="3887588">(</span><span class="ident" id="3887589">toRemove</span><span class="op" id="3887597">)</span><span class="op" id="3887598">]</span><span class="op" id="3887599">,</span>&nbsp;<span class="ident" id="3887601">good</span><br>
<span class="lineno"></span><span class="op" id="3887606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="3887609">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3887687">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="3887762">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="3887799">func</span>&nbsp;<span class="ident" id="3887804">removePaddingSSL30</span><span class="op" id="3887822">(</span><span class="ident" id="3887823">payload</span>&nbsp;<span class="op" id="3887831">[</span><span class="op" id="3887832">]</span><span class="builtintype" id="3887833">byte</span><span class="op" id="3887837">)</span>&nbsp;<span class="op" id="3887839">(</span><span class="op" id="3887840">[</span><span class="op" id="3887841">]</span><span class="builtintype" id="3887842">byte</span><span class="op" id="3887846">,</span>&nbsp;<span class="builtintype" id="3887848">byte</span><span class="op" id="3887852">)</span>&nbsp;<span class="op" id="3887854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887857">if</span>&nbsp;<span class="builtinfunc" id="3887860">len</span><span class="op" id="3887863">(</span><span class="ident" id="3887864">payload</span><span class="op" id="3887871">)</span>&nbsp;<span class="op" id="3887873">&lt;</span>&nbsp;<span class="num" id="3887875">1</span>&nbsp;<span class="op" id="3887877">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887881">return</span>&nbsp;<span class="ident" id="3887888">payload</span><span class="op" id="3887895">,</span>&nbsp;<span class="num" id="3887897">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3887900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3887904">paddingLen</span>&nbsp;<span class="op" id="3887915">:=</span>&nbsp;<span class="builtintype" id="3887918">int</span><span class="op" id="3887921">(</span><span class="ident" id="3887922">payload</span><span class="op" id="3887929">[</span><span class="builtinfunc" id="3887930">len</span><span class="op" id="3887933">(</span><span class="ident" id="3887934">payload</span><span class="op" id="3887941">)</span><span class="op" id="3887942">-</span><span class="num" id="3887943">1</span><span class="op" id="3887944">]</span><span class="op" id="3887945">)</span>&nbsp;<span class="op" id="3887947">+</span>&nbsp;<span class="num" id="3887949">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887952">if</span>&nbsp;<span class="ident" id="3887955">paddingLen</span>&nbsp;<span class="op" id="3887966">&gt;</span>&nbsp;<span class="builtinfunc" id="3887968">len</span><span class="op" id="3887971">(</span><span class="ident" id="3887972">payload</span><span class="op" id="3887979">)</span>&nbsp;<span class="op" id="3887981">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3887985">return</span>&nbsp;<span class="ident" id="3887992">payload</span><span class="op" id="3887999">,</span>&nbsp;<span class="num" id="3888001">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888004">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888008">return</span>&nbsp;<span class="ident" id="3888015">payload</span><span class="op" id="3888022">[</span><span class="op" id="3888023">:</span><span class="builtinfunc" id="3888024">len</span><span class="op" id="3888027">(</span><span class="ident" id="3888028">payload</span><span class="op" id="3888035">)</span><span class="op" id="3888036">-</span><span class="ident" id="3888037">paddingLen</span><span class="op" id="3888047">]</span><span class="op" id="3888048">,</span>&nbsp;<span class="num" id="3888050">255</span><br>
<span class="lineno"></span><span class="op" id="3888054">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="3888057">func</span>&nbsp;<span class="ident" id="3888062">roundUp</span><span class="op" id="3888069">(</span><span class="ident" id="3888070">a</span><span class="op" id="3888071">,</span>&nbsp;<span class="ident" id="3888073">b</span>&nbsp;<span class="builtintype" id="3888075">int</span><span class="op" id="3888078">)</span>&nbsp;<span class="builtintype" id="3888080">int</span>&nbsp;<span class="op" id="3888084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888087">return</span>&nbsp;<span class="ident" id="3888094">a</span>&nbsp;<span class="op" id="3888096">+</span>&nbsp;<span class="op" id="3888098">(</span><span class="ident" id="3888099">b</span><span class="op" id="3888100">-</span><span class="ident" id="3888101">a</span><span class="op" id="3888102">%</span><span class="ident" id="3888103">b</span><span class="op" id="3888104">)</span><span class="op" id="3888105">%</span><span class="ident" id="3888106">b</span><br>
<span class="lineno"></span><span class="op" id="3888108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="3888111">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="3888185">type</span>&nbsp;<span class="ident" id="3888190">cbcMode</span>&nbsp;<span class="keyword" id="3888198">interface</span>&nbsp;<span class="op" id="3888208">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888211">cipher</span><span class="op" id="3888217">.</span><span class="ident" id="3888218">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888229">SetIV</span><span class="op" id="3888234">(</span><span class="op" id="3888235">[</span><span class="op" id="3888236">]</span><span class="builtintype" id="3888237">byte</span><span class="op" id="3888241">)</span><br>
<span class="lineno"></span><span class="op" id="3888243">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="3888246">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3888321">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3888401">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="3888471">func</span>&nbsp;<span class="op" id="3888476">(</span><span class="ident" id="3888477">hc</span>&nbsp;<span class="op" id="3888480">*</span><span class="ident" id="3888481">halfConn</span><span class="op" id="3888489">)</span>&nbsp;<span class="ident" id="3888491">decrypt</span><span class="op" id="3888498">(</span><span class="ident" id="3888499">b</span>&nbsp;<span class="op" id="3888501">*</span><span class="ident" id="3888502">block</span><span class="op" id="3888507">)</span>&nbsp;<span class="op" id="3888509">(</span><span class="ident" id="3888510">ok</span>&nbsp;<span class="builtintype" id="3888513">bool</span><span class="op" id="3888517">,</span>&nbsp;<span class="ident" id="3888519">prefixLen</span>&nbsp;<span class="builtintype" id="3888529">int</span><span class="op" id="3888532">,</span>&nbsp;<span class="ident" id="3888534">alertValue</span>&nbsp;<span class="ident" id="3888545">alert</span><span class="op" id="3888550">)</span>&nbsp;<span class="op" id="3888552">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3888555">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888576">payload</span>&nbsp;<span class="op" id="3888584">:=</span>&nbsp;<span class="ident" id="3888587">b</span><span class="op" id="3888588">.</span><span class="ident" id="3888589">data</span><span class="op" id="3888593">[</span><span class="ident" id="3888594">recordHeaderLen</span><span class="op" id="3888609">:</span><span class="op" id="3888610">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888614">macSize</span>&nbsp;<span class="op" id="3888622">:=</span>&nbsp;<span class="num" id="3888625">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888628">if</span>&nbsp;<span class="ident" id="3888631">hc</span><span class="op" id="3888633">.</span><span class="ident" id="3888634">mac</span>&nbsp;<span class="op" id="3888638">!=</span>&nbsp;<span class="ident" id="3888641">nil</span>&nbsp;<span class="op" id="3888645">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888649">macSize</span>&nbsp;<span class="op" id="3888657">=</span>&nbsp;<span class="ident" id="3888659">hc</span><span class="op" id="3888661">.</span><span class="ident" id="3888662">mac</span><span class="op" id="3888665">.</span><span class="ident" id="3888666">Size</span><span class="op" id="3888670">(</span><span class="op" id="3888671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888678">paddingGood</span>&nbsp;<span class="op" id="3888690">:=</span>&nbsp;<span class="builtintype" id="3888693">byte</span><span class="op" id="3888697">(</span><span class="num" id="3888698">255</span><span class="op" id="3888701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888704">explicitIVLen</span>&nbsp;<span class="op" id="3888718">:=</span>&nbsp;<span class="num" id="3888721">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3888725">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888737">if</span>&nbsp;<span class="ident" id="3888740">hc</span><span class="op" id="3888742">.</span><span class="ident" id="3888743">cipher</span>&nbsp;<span class="op" id="3888750">!=</span>&nbsp;<span class="ident" id="3888753">nil</span>&nbsp;<span class="op" id="3888757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888761">switch</span>&nbsp;<span class="ident" id="3888768">c</span>&nbsp;<span class="op" id="3888770">:=</span>&nbsp;<span class="ident" id="3888773">hc</span><span class="op" id="3888775">.</span><span class="ident" id="3888776">cipher</span><span class="op" id="3888782">.</span><span class="op" id="3888783">(</span><span class="keyword" id="3888784">type</span><span class="op" id="3888788">)</span>&nbsp;<span class="op" id="3888790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888794">case</span>&nbsp;<span class="ident" id="3888799">cipher</span><span class="op" id="3888805">.</span><span class="ident" id="3888806">Stream</span><span class="op" id="3888812">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888817">c</span><span class="op" id="3888818">.</span><span class="ident" id="3888819">XORKeyStream</span><span class="op" id="3888831">(</span><span class="ident" id="3888832">payload</span><span class="op" id="3888839">,</span>&nbsp;<span class="ident" id="3888841">payload</span><span class="op" id="3888848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888852">case</span>&nbsp;<span class="ident" id="3888857">cipher</span><span class="op" id="3888863">.</span><span class="ident" id="3888864">AEAD</span><span class="op" id="3888868">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888873">explicitIVLen</span>&nbsp;<span class="op" id="3888887">=</span>&nbsp;<span class="num" id="3888889">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888894">if</span>&nbsp;<span class="builtinfunc" id="3888897">len</span><span class="op" id="3888900">(</span><span class="ident" id="3888901">payload</span><span class="op" id="3888908">)</span>&nbsp;<span class="op" id="3888910">&lt;</span>&nbsp;<span class="ident" id="3888912">explicitIVLen</span>&nbsp;<span class="op" id="3888926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3888932">return</span>&nbsp;<span class="builtintype" id="3888939">false</span><span class="op" id="3888944">,</span>&nbsp;<span class="num" id="3888946">0</span><span class="op" id="3888947">,</span>&nbsp;<span class="ident" id="3888949">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3888970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888975">nonce</span>&nbsp;<span class="op" id="3888981">:=</span>&nbsp;<span class="ident" id="3888984">payload</span><span class="op" id="3888991">[</span><span class="op" id="3888992">:</span><span class="num" id="3888993">8</span><span class="op" id="3888994">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3888999">payload</span>&nbsp;<span class="op" id="3889007">=</span>&nbsp;<span class="ident" id="3889009">payload</span><span class="op" id="3889016">[</span><span class="num" id="3889017">8</span><span class="op" id="3889018">:</span><span class="op" id="3889019">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889025">var</span>&nbsp;<span class="ident" id="3889029">additionalData</span>&nbsp;<span class="op" id="3889044">[</span><span class="num" id="3889045">13</span><span class="op" id="3889047">]</span><span class="builtintype" id="3889048">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3889056">copy</span><span class="op" id="3889060">(</span><span class="ident" id="3889061">additionalData</span><span class="op" id="3889075">[</span><span class="op" id="3889076">:</span><span class="op" id="3889077">]</span><span class="op" id="3889078">,</span>&nbsp;<span class="ident" id="3889080">hc</span><span class="op" id="3889082">.</span><span class="ident" id="3889083">seq</span><span class="op" id="3889086">[</span><span class="op" id="3889087">:</span><span class="op" id="3889088">]</span><span class="op" id="3889089">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3889094">copy</span><span class="op" id="3889098">(</span><span class="ident" id="3889099">additionalData</span><span class="op" id="3889113">[</span><span class="num" id="3889114">8</span><span class="op" id="3889115">:</span><span class="op" id="3889116">]</span><span class="op" id="3889117">,</span>&nbsp;<span class="ident" id="3889119">b</span><span class="op" id="3889120">.</span><span class="ident" id="3889121">data</span><span class="op" id="3889125">[</span><span class="op" id="3889126">:</span><span class="num" id="3889127">3</span><span class="op" id="3889128">]</span><span class="op" id="3889129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889134">n</span>&nbsp;<span class="op" id="3889136">:=</span>&nbsp;<span class="builtinfunc" id="3889139">len</span><span class="op" id="3889142">(</span><span class="ident" id="3889143">payload</span><span class="op" id="3889150">)</span>&nbsp;<span class="op" id="3889152">-</span>&nbsp;<span class="ident" id="3889154">c</span><span class="op" id="3889155">.</span><span class="ident" id="3889156">Overhead</span><span class="op" id="3889164">(</span><span class="op" id="3889165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889170">additionalData</span><span class="op" id="3889184">[</span><span class="num" id="3889185">11</span><span class="op" id="3889187">]</span>&nbsp;<span class="op" id="3889189">=</span>&nbsp;<span class="builtintype" id="3889191">byte</span><span class="op" id="3889195">(</span><span class="ident" id="3889196">n</span>&nbsp;<span class="op" id="3889198">&gt;&gt;</span>&nbsp;<span class="num" id="3889201">8</span><span class="op" id="3889202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889207">additionalData</span><span class="op" id="3889221">[</span><span class="num" id="3889222">12</span><span class="op" id="3889224">]</span>&nbsp;<span class="op" id="3889226">=</span>&nbsp;<span class="builtintype" id="3889228">byte</span><span class="op" id="3889232">(</span><span class="ident" id="3889233">n</span><span class="op" id="3889234">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889239">var</span>&nbsp;<span class="ident" id="3889243">err</span>&nbsp;<span class="builtintype" id="3889247">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889256">payload</span><span class="op" id="3889263">,</span>&nbsp;<span class="ident" id="3889265">err</span>&nbsp;<span class="op" id="3889269">=</span>&nbsp;<span class="ident" id="3889271">c</span><span class="op" id="3889272">.</span><span class="ident" id="3889273">Open</span><span class="op" id="3889277">(</span><span class="ident" id="3889278">payload</span><span class="op" id="3889285">[</span><span class="op" id="3889286">:</span><span class="num" id="3889287">0</span><span class="op" id="3889288">]</span><span class="op" id="3889289">,</span>&nbsp;<span class="ident" id="3889291">nonce</span><span class="op" id="3889296">,</span>&nbsp;<span class="ident" id="3889298">payload</span><span class="op" id="3889305">,</span>&nbsp;<span class="ident" id="3889307">additionalData</span><span class="op" id="3889321">[</span><span class="op" id="3889322">:</span><span class="op" id="3889323">]</span><span class="op" id="3889324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889329">if</span>&nbsp;<span class="ident" id="3889332">err</span>&nbsp;<span class="op" id="3889336">!=</span>&nbsp;<span class="ident" id="3889339">nil</span>&nbsp;<span class="op" id="3889343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889349">return</span>&nbsp;<span class="builtintype" id="3889356">false</span><span class="op" id="3889361">,</span>&nbsp;<span class="num" id="3889363">0</span><span class="op" id="3889364">,</span>&nbsp;<span class="ident" id="3889366">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3889387">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889392">b</span><span class="op" id="3889393">.</span><span class="ident" id="3889394">resize</span><span class="op" id="3889400">(</span><span class="ident" id="3889401">recordHeaderLen</span>&nbsp;<span class="op" id="3889417">+</span>&nbsp;<span class="ident" id="3889419">explicitIVLen</span>&nbsp;<span class="op" id="3889433">+</span>&nbsp;<span class="builtinfunc" id="3889435">len</span><span class="op" id="3889438">(</span><span class="ident" id="3889439">payload</span><span class="op" id="3889446">)</span><span class="op" id="3889447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889451">case</span>&nbsp;<span class="ident" id="3889456">cbcMode</span><span class="op" id="3889463">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889468">blockSize</span>&nbsp;<span class="op" id="3889478">:=</span>&nbsp;<span class="ident" id="3889481">c</span><span class="op" id="3889482">.</span><span class="ident" id="3889483">BlockSize</span><span class="op" id="3889492">(</span><span class="op" id="3889493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889498">if</span>&nbsp;<span class="ident" id="3889501">hc</span><span class="op" id="3889503">.</span><span class="ident" id="3889504">version</span>&nbsp;<span class="op" id="3889512">&gt;=</span>&nbsp;<span class="ident" id="3889515">VersionTLS11</span>&nbsp;<span class="op" id="3889528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889534">explicitIVLen</span>&nbsp;<span class="op" id="3889548">=</span>&nbsp;<span class="ident" id="3889550">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3889563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889569">if</span>&nbsp;<span class="builtinfunc" id="3889572">len</span><span class="op" id="3889575">(</span><span class="ident" id="3889576">payload</span><span class="op" id="3889583">)</span><span class="op" id="3889584">%</span><span class="ident" id="3889585">blockSize</span>&nbsp;<span class="op" id="3889595">!=</span>&nbsp;<span class="num" id="3889598">0</span>&nbsp;<span class="op" id="3889600">||</span>&nbsp;<span class="builtinfunc" id="3889603">len</span><span class="op" id="3889606">(</span><span class="ident" id="3889607">payload</span><span class="op" id="3889614">)</span>&nbsp;<span class="op" id="3889616">&lt;</span>&nbsp;<span class="ident" id="3889618">roundUp</span><span class="op" id="3889625">(</span><span class="ident" id="3889626">explicitIVLen</span><span class="op" id="3889639">+</span><span class="ident" id="3889640">macSize</span><span class="op" id="3889647">+</span><span class="num" id="3889648">1</span><span class="op" id="3889649">,</span>&nbsp;<span class="ident" id="3889651">blockSize</span><span class="op" id="3889660">)</span>&nbsp;<span class="op" id="3889662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889668">return</span>&nbsp;<span class="builtintype" id="3889675">false</span><span class="op" id="3889680">,</span>&nbsp;<span class="num" id="3889682">0</span><span class="op" id="3889683">,</span>&nbsp;<span class="ident" id="3889685">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3889706">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889712">if</span>&nbsp;<span class="ident" id="3889715">explicitIVLen</span>&nbsp;<span class="op" id="3889729">&gt;</span>&nbsp;<span class="num" id="3889731">0</span>&nbsp;<span class="op" id="3889733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889739">c</span><span class="op" id="3889740">.</span><span class="ident" id="3889741">SetIV</span><span class="op" id="3889746">(</span><span class="ident" id="3889747">payload</span><span class="op" id="3889754">[</span><span class="op" id="3889755">:</span><span class="ident" id="3889756">explicitIVLen</span><span class="op" id="3889769">]</span><span class="op" id="3889770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889776">payload</span>&nbsp;<span class="op" id="3889784">=</span>&nbsp;<span class="ident" id="3889786">payload</span><span class="op" id="3889793">[</span><span class="ident" id="3889794">explicitIVLen</span><span class="op" id="3889807">:</span><span class="op" id="3889808">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3889813">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889818">c</span><span class="op" id="3889819">.</span><span class="ident" id="3889820">CryptBlocks</span><span class="op" id="3889831">(</span><span class="ident" id="3889832">payload</span><span class="op" id="3889839">,</span>&nbsp;<span class="ident" id="3889841">payload</span><span class="op" id="3889848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3889853">if</span>&nbsp;<span class="ident" id="3889856">hc</span><span class="op" id="3889858">.</span><span class="ident" id="3889859">version</span>&nbsp;<span class="op" id="3889867">==</span>&nbsp;<span class="ident" id="3889870">VersionSSL30</span>&nbsp;<span class="op" id="3889883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889889">payload</span><span class="op" id="3889896">,</span>&nbsp;<span class="ident" id="3889898">paddingGood</span>&nbsp;<span class="op" id="3889910">=</span>&nbsp;<span class="ident" id="3889912">removePaddingSSL30</span><span class="op" id="3889930">(</span><span class="ident" id="3889931">payload</span><span class="op" id="3889938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3889943">}</span>&nbsp;<span class="keyword" id="3889945">else</span>&nbsp;<span class="op" id="3889950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3889956">payload</span><span class="op" id="3889963">,</span>&nbsp;<span class="ident" id="3889965">paddingGood</span>&nbsp;<span class="op" id="3889977">=</span>&nbsp;<span class="ident" id="3889979">removePadding</span><span class="op" id="3889992">(</span><span class="ident" id="3889993">payload</span><span class="op" id="3890000">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3890005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890010">b</span><span class="op" id="3890011">.</span><span class="ident" id="3890012">resize</span><span class="op" id="3890018">(</span><span class="ident" id="3890019">recordHeaderLen</span>&nbsp;<span class="op" id="3890035">+</span>&nbsp;<span class="ident" id="3890037">explicitIVLen</span>&nbsp;<span class="op" id="3890051">+</span>&nbsp;<span class="builtinfunc" id="3890053">len</span><span class="op" id="3890056">(</span><span class="ident" id="3890057">payload</span><span class="op" id="3890064">)</span><span class="op" id="3890065">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890071">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890130">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890187">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890244">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890300">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890350">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890408">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890428">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890434">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890490">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3890520">default</span><span class="op" id="3890527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3890532">panic</span><span class="op" id="3890537">(</span><span class="string" id="3890538">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3890559">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3890563">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3890566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890570">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3890591">if</span>&nbsp;<span class="ident" id="3890594">hc</span><span class="op" id="3890596">.</span><span class="ident" id="3890597">mac</span>&nbsp;<span class="op" id="3890601">!=</span>&nbsp;<span class="ident" id="3890604">nil</span>&nbsp;<span class="op" id="3890608">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3890612">if</span>&nbsp;<span class="builtinfunc" id="3890615">len</span><span class="op" id="3890618">(</span><span class="ident" id="3890619">payload</span><span class="op" id="3890626">)</span>&nbsp;<span class="op" id="3890628">&lt;</span>&nbsp;<span class="ident" id="3890630">macSize</span>&nbsp;<span class="op" id="3890638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3890643">return</span>&nbsp;<span class="builtintype" id="3890650">false</span><span class="op" id="3890655">,</span>&nbsp;<span class="num" id="3890657">0</span><span class="op" id="3890658">,</span>&nbsp;<span class="ident" id="3890660">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3890680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3890685">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890720">n</span>&nbsp;<span class="op" id="3890722">:=</span>&nbsp;<span class="builtinfunc" id="3890725">len</span><span class="op" id="3890728">(</span><span class="ident" id="3890729">payload</span><span class="op" id="3890736">)</span>&nbsp;<span class="op" id="3890738">-</span>&nbsp;<span class="ident" id="3890740">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890750">b</span><span class="op" id="3890751">.</span><span class="ident" id="3890752">data</span><span class="op" id="3890756">[</span><span class="num" id="3890757">3</span><span class="op" id="3890758">]</span>&nbsp;<span class="op" id="3890760">=</span>&nbsp;<span class="builtintype" id="3890762">byte</span><span class="op" id="3890766">(</span><span class="ident" id="3890767">n</span>&nbsp;<span class="op" id="3890769">&gt;&gt;</span>&nbsp;<span class="num" id="3890772">8</span><span class="op" id="3890773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890777">b</span><span class="op" id="3890778">.</span><span class="ident" id="3890779">data</span><span class="op" id="3890783">[</span><span class="num" id="3890784">4</span><span class="op" id="3890785">]</span>&nbsp;<span class="op" id="3890787">=</span>&nbsp;<span class="builtintype" id="3890789">byte</span><span class="op" id="3890793">(</span><span class="ident" id="3890794">n</span><span class="op" id="3890795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890799">b</span><span class="op" id="3890800">.</span><span class="ident" id="3890801">resize</span><span class="op" id="3890807">(</span><span class="ident" id="3890808">recordHeaderLen</span>&nbsp;<span class="op" id="3890824">+</span>&nbsp;<span class="ident" id="3890826">explicitIVLen</span>&nbsp;<span class="op" id="3890840">+</span>&nbsp;<span class="ident" id="3890842">n</span><span class="op" id="3890843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890847">remoteMAC</span>&nbsp;<span class="op" id="3890857">:=</span>&nbsp;<span class="ident" id="3890860">payload</span><span class="op" id="3890867">[</span><span class="ident" id="3890868">n</span><span class="op" id="3890869">:</span><span class="op" id="3890870">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3890874">localMAC</span>&nbsp;<span class="op" id="3890883">:=</span>&nbsp;<span class="ident" id="3890886">hc</span><span class="op" id="3890888">.</span><span class="ident" id="3890889">mac</span><span class="op" id="3890892">.</span><span class="ident" id="3890893">MAC</span><span class="op" id="3890896">(</span><span class="ident" id="3890897">hc</span><span class="op" id="3890899">.</span><span class="ident" id="3890900">inDigestBuf</span><span class="op" id="3890911">,</span>&nbsp;<span class="ident" id="3890913">hc</span><span class="op" id="3890915">.</span><span class="ident" id="3890916">seq</span><span class="op" id="3890919">[</span><span class="num" id="3890920">0</span><span class="op" id="3890921">:</span><span class="op" id="3890922">]</span><span class="op" id="3890923">,</span>&nbsp;<span class="ident" id="3890925">b</span><span class="op" id="3890926">.</span><span class="ident" id="3890927">data</span><span class="op" id="3890931">[</span><span class="op" id="3890932">:</span><span class="ident" id="3890933">recordHeaderLen</span><span class="op" id="3890948">]</span><span class="op" id="3890949">,</span>&nbsp;<span class="ident" id="3890951">payload</span><span class="op" id="3890958">[</span><span class="op" id="3890959">:</span><span class="ident" id="3890960">n</span><span class="op" id="3890961">]</span><span class="op" id="3890962">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3890967">if</span>&nbsp;<span class="ident" id="3890970">subtle</span><span class="op" id="3890976">.</span><span class="ident" id="3890977">ConstantTimeCompare</span><span class="op" id="3890996">(</span><span class="ident" id="3890997">localMAC</span><span class="op" id="3891005">,</span>&nbsp;<span class="ident" id="3891007">remoteMAC</span><span class="op" id="3891016">)</span>&nbsp;<span class="op" id="3891018">!=</span>&nbsp;<span class="num" id="3891021">1</span>&nbsp;<span class="op" id="3891023">||</span>&nbsp;<span class="ident" id="3891026">paddingGood</span>&nbsp;<span class="op" id="3891038">!=</span>&nbsp;<span class="num" id="3891041">255</span>&nbsp;<span class="op" id="3891045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3891050">return</span>&nbsp;<span class="builtintype" id="3891057">false</span><span class="op" id="3891062">,</span>&nbsp;<span class="num" id="3891064">0</span><span class="op" id="3891065">,</span>&nbsp;<span class="ident" id="3891067">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3891087">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891091">hc</span><span class="op" id="3891093">.</span><span class="ident" id="3891094">inDigestBuf</span>&nbsp;<span class="op" id="3891106">=</span>&nbsp;<span class="ident" id="3891108">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3891118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891121">hc</span><span class="op" id="3891123">.</span><span class="ident" id="3891124">incSeq</span><span class="op" id="3891130">(</span><span class="op" id="3891131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3891135">return</span>&nbsp;<span class="builtintype" id="3891142">true</span><span class="op" id="3891146">,</span>&nbsp;<span class="ident" id="3891148">recordHeaderLen</span>&nbsp;<span class="op" id="3891164">+</span>&nbsp;<span class="ident" id="3891166">explicitIVLen</span><span class="op" id="3891179">,</span>&nbsp;<span class="num" id="3891181">0</span><br>
<span class="lineno">335</span><span class="op" id="3891183">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3891186">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="3891264">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="3891339">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="3891419">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3891495">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="3891510">func</span>&nbsp;<span class="ident" id="3891515">padToBlockSize</span><span class="op" id="3891529">(</span><span class="ident" id="3891530">payload</span>&nbsp;<span class="op" id="3891538">[</span><span class="op" id="3891539">]</span><span class="builtintype" id="3891540">byte</span><span class="op" id="3891544">,</span>&nbsp;<span class="ident" id="3891546">blockSize</span>&nbsp;<span class="builtintype" id="3891556">int</span><span class="op" id="3891559">)</span>&nbsp;<span class="op" id="3891561">(</span><span class="ident" id="3891562">prefix</span><span class="op" id="3891568">,</span>&nbsp;<span class="ident" id="3891570">finalBlock</span>&nbsp;<span class="op" id="3891581">[</span><span class="op" id="3891582">]</span><span class="builtintype" id="3891583">byte</span><span class="op" id="3891587">)</span>&nbsp;<span class="op" id="3891589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891592">overrun</span>&nbsp;<span class="op" id="3891600">:=</span>&nbsp;<span class="builtinfunc" id="3891603">len</span><span class="op" id="3891606">(</span><span class="ident" id="3891607">payload</span><span class="op" id="3891614">)</span>&nbsp;<span class="op" id="3891616">%</span>&nbsp;<span class="ident" id="3891618">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891629">paddingLen</span>&nbsp;<span class="op" id="3891640">:=</span>&nbsp;<span class="ident" id="3891643">blockSize</span>&nbsp;<span class="op" id="3891653">-</span>&nbsp;<span class="ident" id="3891655">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891664">prefix</span>&nbsp;<span class="op" id="3891671">=</span>&nbsp;<span class="ident" id="3891673">payload</span><span class="op" id="3891680">[</span><span class="op" id="3891681">:</span><span class="builtinfunc" id="3891682">len</span><span class="op" id="3891685">(</span><span class="ident" id="3891686">payload</span><span class="op" id="3891693">)</span><span class="op" id="3891694">-</span><span class="ident" id="3891695">overrun</span><span class="op" id="3891702">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891705">finalBlock</span>&nbsp;<span class="op" id="3891716">=</span>&nbsp;<span class="builtinfunc" id="3891718">make</span><span class="op" id="3891722">(</span><span class="op" id="3891723">[</span><span class="op" id="3891724">]</span><span class="builtintype" id="3891725">byte</span><span class="op" id="3891729">,</span>&nbsp;<span class="ident" id="3891731">blockSize</span><span class="op" id="3891740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3891743">copy</span><span class="op" id="3891747">(</span><span class="ident" id="3891748">finalBlock</span><span class="op" id="3891758">,</span>&nbsp;<span class="ident" id="3891760">payload</span><span class="op" id="3891767">[</span><span class="builtinfunc" id="3891768">len</span><span class="op" id="3891771">(</span><span class="ident" id="3891772">payload</span><span class="op" id="3891779">)</span><span class="op" id="3891780">-</span><span class="ident" id="3891781">overrun</span><span class="op" id="3891788">:</span><span class="op" id="3891789">]</span><span class="op" id="3891790">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3891793">for</span>&nbsp;<span class="ident" id="3891797">i</span>&nbsp;<span class="op" id="3891799">:=</span>&nbsp;<span class="ident" id="3891802">overrun</span><span class="op" id="3891809">;</span>&nbsp;<span class="ident" id="3891811">i</span>&nbsp;<span class="op" id="3891813">&lt;</span>&nbsp;<span class="ident" id="3891815">blockSize</span><span class="op" id="3891824">;</span>&nbsp;<span class="ident" id="3891826">i</span><span class="op" id="3891827">++</span>&nbsp;<span class="op" id="3891830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3891834">finalBlock</span><span class="op" id="3891844">[</span><span class="ident" id="3891845">i</span><span class="op" id="3891846">]</span>&nbsp;<span class="op" id="3891848">=</span>&nbsp;<span class="builtintype" id="3891850">byte</span><span class="op" id="3891854">(</span><span class="ident" id="3891855">paddingLen</span>&nbsp;<span class="op" id="3891866">-</span>&nbsp;<span class="num" id="3891868">1</span><span class="op" id="3891869">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3891872">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3891875">return</span><br>
<span class="lineno"></span><span class="op" id="3891882">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3891885">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="3891929">func</span>&nbsp;<span class="op" id="3891934">(</span><span class="ident" id="3891935">hc</span>&nbsp;<span class="op" id="3891938">*</span><span class="ident" id="3891939">halfConn</span><span class="op" id="3891947">)</span>&nbsp;<span class="ident" id="3891949">encrypt</span><span class="op" id="3891956">(</span><span class="ident" id="3891957">b</span>&nbsp;<span class="op" id="3891959">*</span><span class="ident" id="3891960">block</span><span class="op" id="3891965">,</span>&nbsp;<span class="ident" id="3891967">explicitIVLen</span>&nbsp;<span class="builtintype" id="3891981">int</span><span class="op" id="3891984">)</span>&nbsp;<span class="op" id="3891986">(</span><span class="builtintype" id="3891987">bool</span><span class="op" id="3891991">,</span>&nbsp;<span class="ident" id="3891993">alert</span><span class="op" id="3891998">)</span>&nbsp;<span class="op" id="3892000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3892003">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892011">if</span>&nbsp;<span class="ident" id="3892014">hc</span><span class="op" id="3892016">.</span><span class="ident" id="3892017">mac</span>&nbsp;<span class="op" id="3892021">!=</span>&nbsp;<span class="ident" id="3892024">nil</span>&nbsp;<span class="op" id="3892028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892032">mac</span>&nbsp;<span class="op" id="3892036">:=</span>&nbsp;<span class="ident" id="3892039">hc</span><span class="op" id="3892041">.</span><span class="ident" id="3892042">mac</span><span class="op" id="3892045">.</span><span class="ident" id="3892046">MAC</span><span class="op" id="3892049">(</span><span class="ident" id="3892050">hc</span><span class="op" id="3892052">.</span><span class="ident" id="3892053">outDigestBuf</span><span class="op" id="3892065">,</span>&nbsp;<span class="ident" id="3892067">hc</span><span class="op" id="3892069">.</span><span class="ident" id="3892070">seq</span><span class="op" id="3892073">[</span><span class="num" id="3892074">0</span><span class="op" id="3892075">:</span><span class="op" id="3892076">]</span><span class="op" id="3892077">,</span>&nbsp;<span class="ident" id="3892079">b</span><span class="op" id="3892080">.</span><span class="ident" id="3892081">data</span><span class="op" id="3892085">[</span><span class="op" id="3892086">:</span><span class="ident" id="3892087">recordHeaderLen</span><span class="op" id="3892102">]</span><span class="op" id="3892103">,</span>&nbsp;<span class="ident" id="3892105">b</span><span class="op" id="3892106">.</span><span class="ident" id="3892107">data</span><span class="op" id="3892111">[</span><span class="ident" id="3892112">recordHeaderLen</span><span class="op" id="3892127">+</span><span class="ident" id="3892128">explicitIVLen</span><span class="op" id="3892141">:</span><span class="op" id="3892142">]</span><span class="op" id="3892143">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892148">n</span>&nbsp;<span class="op" id="3892150">:=</span>&nbsp;<span class="builtinfunc" id="3892153">len</span><span class="op" id="3892156">(</span><span class="ident" id="3892157">b</span><span class="op" id="3892158">.</span><span class="ident" id="3892159">data</span><span class="op" id="3892163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892167">b</span><span class="op" id="3892168">.</span><span class="ident" id="3892169">resize</span><span class="op" id="3892175">(</span><span class="ident" id="3892176">n</span>&nbsp;<span class="op" id="3892178">+</span>&nbsp;<span class="builtinfunc" id="3892180">len</span><span class="op" id="3892183">(</span><span class="ident" id="3892184">mac</span><span class="op" id="3892187">)</span><span class="op" id="3892188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3892192">copy</span><span class="op" id="3892196">(</span><span class="ident" id="3892197">b</span><span class="op" id="3892198">.</span><span class="ident" id="3892199">data</span><span class="op" id="3892203">[</span><span class="ident" id="3892204">n</span><span class="op" id="3892205">:</span><span class="op" id="3892206">]</span><span class="op" id="3892207">,</span>&nbsp;<span class="ident" id="3892209">mac</span><span class="op" id="3892212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892216">hc</span><span class="op" id="3892218">.</span><span class="ident" id="3892219">outDigestBuf</span>&nbsp;<span class="op" id="3892232">=</span>&nbsp;<span class="ident" id="3892234">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3892239">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892243">payload</span>&nbsp;<span class="op" id="3892251">:=</span>&nbsp;<span class="ident" id="3892254">b</span><span class="op" id="3892255">.</span><span class="ident" id="3892256">data</span><span class="op" id="3892260">[</span><span class="ident" id="3892261">recordHeaderLen</span><span class="op" id="3892276">:</span><span class="op" id="3892277">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3892281">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892293">if</span>&nbsp;<span class="ident" id="3892296">hc</span><span class="op" id="3892298">.</span><span class="ident" id="3892299">cipher</span>&nbsp;<span class="op" id="3892306">!=</span>&nbsp;<span class="ident" id="3892309">nil</span>&nbsp;<span class="op" id="3892313">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892317">switch</span>&nbsp;<span class="ident" id="3892324">c</span>&nbsp;<span class="op" id="3892326">:=</span>&nbsp;<span class="ident" id="3892329">hc</span><span class="op" id="3892331">.</span><span class="ident" id="3892332">cipher</span><span class="op" id="3892338">.</span><span class="op" id="3892339">(</span><span class="keyword" id="3892340">type</span><span class="op" id="3892344">)</span>&nbsp;<span class="op" id="3892346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892350">case</span>&nbsp;<span class="ident" id="3892355">cipher</span><span class="op" id="3892361">.</span><span class="ident" id="3892362">Stream</span><span class="op" id="3892368">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892373">c</span><span class="op" id="3892374">.</span><span class="ident" id="3892375">XORKeyStream</span><span class="op" id="3892387">(</span><span class="ident" id="3892388">payload</span><span class="op" id="3892395">,</span>&nbsp;<span class="ident" id="3892397">payload</span><span class="op" id="3892404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892408">case</span>&nbsp;<span class="ident" id="3892413">cipher</span><span class="op" id="3892419">.</span><span class="ident" id="3892420">AEAD</span><span class="op" id="3892424">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892429">payloadLen</span>&nbsp;<span class="op" id="3892440">:=</span>&nbsp;<span class="builtinfunc" id="3892443">len</span><span class="op" id="3892446">(</span><span class="ident" id="3892447">b</span><span class="op" id="3892448">.</span><span class="ident" id="3892449">data</span><span class="op" id="3892453">)</span>&nbsp;<span class="op" id="3892455">-</span>&nbsp;<span class="ident" id="3892457">recordHeaderLen</span>&nbsp;<span class="op" id="3892473">-</span>&nbsp;<span class="ident" id="3892475">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892492">b</span><span class="op" id="3892493">.</span><span class="ident" id="3892494">resize</span><span class="op" id="3892500">(</span><span class="builtinfunc" id="3892501">len</span><span class="op" id="3892504">(</span><span class="ident" id="3892505">b</span><span class="op" id="3892506">.</span><span class="ident" id="3892507">data</span><span class="op" id="3892511">)</span>&nbsp;<span class="op" id="3892513">+</span>&nbsp;<span class="ident" id="3892515">c</span><span class="op" id="3892516">.</span><span class="ident" id="3892517">Overhead</span><span class="op" id="3892525">(</span><span class="op" id="3892526">)</span><span class="op" id="3892527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892532">nonce</span>&nbsp;<span class="op" id="3892538">:=</span>&nbsp;<span class="ident" id="3892541">b</span><span class="op" id="3892542">.</span><span class="ident" id="3892543">data</span><span class="op" id="3892547">[</span><span class="ident" id="3892548">recordHeaderLen</span>&nbsp;<span class="op" id="3892564">:</span>&nbsp;<span class="ident" id="3892566">recordHeaderLen</span><span class="op" id="3892581">+</span><span class="ident" id="3892582">explicitIVLen</span><span class="op" id="3892595">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892600">payload</span>&nbsp;<span class="op" id="3892608">:=</span>&nbsp;<span class="ident" id="3892611">b</span><span class="op" id="3892612">.</span><span class="ident" id="3892613">data</span><span class="op" id="3892617">[</span><span class="ident" id="3892618">recordHeaderLen</span><span class="op" id="3892633">+</span><span class="ident" id="3892634">explicitIVLen</span><span class="op" id="3892647">:</span><span class="op" id="3892648">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892653">payload</span>&nbsp;<span class="op" id="3892661">=</span>&nbsp;<span class="ident" id="3892663">payload</span><span class="op" id="3892670">[</span><span class="op" id="3892671">:</span><span class="ident" id="3892672">payloadLen</span><span class="op" id="3892682">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892688">var</span>&nbsp;<span class="ident" id="3892692">additionalData</span>&nbsp;<span class="op" id="3892707">[</span><span class="num" id="3892708">13</span><span class="op" id="3892710">]</span><span class="builtintype" id="3892711">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3892719">copy</span><span class="op" id="3892723">(</span><span class="ident" id="3892724">additionalData</span><span class="op" id="3892738">[</span><span class="op" id="3892739">:</span><span class="op" id="3892740">]</span><span class="op" id="3892741">,</span>&nbsp;<span class="ident" id="3892743">hc</span><span class="op" id="3892745">.</span><span class="ident" id="3892746">seq</span><span class="op" id="3892749">[</span><span class="op" id="3892750">:</span><span class="op" id="3892751">]</span><span class="op" id="3892752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3892757">copy</span><span class="op" id="3892761">(</span><span class="ident" id="3892762">additionalData</span><span class="op" id="3892776">[</span><span class="num" id="3892777">8</span><span class="op" id="3892778">:</span><span class="op" id="3892779">]</span><span class="op" id="3892780">,</span>&nbsp;<span class="ident" id="3892782">b</span><span class="op" id="3892783">.</span><span class="ident" id="3892784">data</span><span class="op" id="3892788">[</span><span class="op" id="3892789">:</span><span class="num" id="3892790">3</span><span class="op" id="3892791">]</span><span class="op" id="3892792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892797">additionalData</span><span class="op" id="3892811">[</span><span class="num" id="3892812">11</span><span class="op" id="3892814">]</span>&nbsp;<span class="op" id="3892816">=</span>&nbsp;<span class="builtintype" id="3892818">byte</span><span class="op" id="3892822">(</span><span class="ident" id="3892823">payloadLen</span>&nbsp;<span class="op" id="3892834">&gt;&gt;</span>&nbsp;<span class="num" id="3892837">8</span><span class="op" id="3892838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892843">additionalData</span><span class="op" id="3892857">[</span><span class="num" id="3892858">12</span><span class="op" id="3892860">]</span>&nbsp;<span class="op" id="3892862">=</span>&nbsp;<span class="builtintype" id="3892864">byte</span><span class="op" id="3892868">(</span><span class="ident" id="3892869">payloadLen</span><span class="op" id="3892879">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892885">c</span><span class="op" id="3892886">.</span><span class="ident" id="3892887">Seal</span><span class="op" id="3892891">(</span><span class="ident" id="3892892">payload</span><span class="op" id="3892899">[</span><span class="op" id="3892900">:</span><span class="num" id="3892901">0</span><span class="op" id="3892902">]</span><span class="op" id="3892903">,</span>&nbsp;<span class="ident" id="3892905">nonce</span><span class="op" id="3892910">,</span>&nbsp;<span class="ident" id="3892912">payload</span><span class="op" id="3892919">,</span>&nbsp;<span class="ident" id="3892921">additionalData</span><span class="op" id="3892935">[</span><span class="op" id="3892936">:</span><span class="op" id="3892937">]</span><span class="op" id="3892938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892942">case</span>&nbsp;<span class="ident" id="3892947">cbcMode</span><span class="op" id="3892954">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3892959">blockSize</span>&nbsp;<span class="op" id="3892969">:=</span>&nbsp;<span class="ident" id="3892972">c</span><span class="op" id="3892973">.</span><span class="ident" id="3892974">BlockSize</span><span class="op" id="3892983">(</span><span class="op" id="3892984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3892989">if</span>&nbsp;<span class="ident" id="3892992">explicitIVLen</span>&nbsp;<span class="op" id="3893006">&gt;</span>&nbsp;<span class="num" id="3893008">0</span>&nbsp;<span class="op" id="3893010">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893016">c</span><span class="op" id="3893017">.</span><span class="ident" id="3893018">SetIV</span><span class="op" id="3893023">(</span><span class="ident" id="3893024">payload</span><span class="op" id="3893031">[</span><span class="op" id="3893032">:</span><span class="ident" id="3893033">explicitIVLen</span><span class="op" id="3893046">]</span><span class="op" id="3893047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893053">payload</span>&nbsp;<span class="op" id="3893061">=</span>&nbsp;<span class="ident" id="3893063">payload</span><span class="op" id="3893070">[</span><span class="ident" id="3893071">explicitIVLen</span><span class="op" id="3893084">:</span><span class="op" id="3893085">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893090">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893095">prefix</span><span class="op" id="3893101">,</span>&nbsp;<span class="ident" id="3893103">finalBlock</span>&nbsp;<span class="op" id="3893114">:=</span>&nbsp;<span class="ident" id="3893117">padToBlockSize</span><span class="op" id="3893131">(</span><span class="ident" id="3893132">payload</span><span class="op" id="3893139">,</span>&nbsp;<span class="ident" id="3893141">blockSize</span><span class="op" id="3893150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893155">b</span><span class="op" id="3893156">.</span><span class="ident" id="3893157">resize</span><span class="op" id="3893163">(</span><span class="ident" id="3893164">recordHeaderLen</span>&nbsp;<span class="op" id="3893180">+</span>&nbsp;<span class="ident" id="3893182">explicitIVLen</span>&nbsp;<span class="op" id="3893196">+</span>&nbsp;<span class="builtinfunc" id="3893198">len</span><span class="op" id="3893201">(</span><span class="ident" id="3893202">prefix</span><span class="op" id="3893208">)</span>&nbsp;<span class="op" id="3893210">+</span>&nbsp;<span class="builtinfunc" id="3893212">len</span><span class="op" id="3893215">(</span><span class="ident" id="3893216">finalBlock</span><span class="op" id="3893226">)</span><span class="op" id="3893227">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893232">c</span><span class="op" id="3893233">.</span><span class="ident" id="3893234">CryptBlocks</span><span class="op" id="3893245">(</span><span class="ident" id="3893246">b</span><span class="op" id="3893247">.</span><span class="ident" id="3893248">data</span><span class="op" id="3893252">[</span><span class="ident" id="3893253">recordHeaderLen</span><span class="op" id="3893268">+</span><span class="ident" id="3893269">explicitIVLen</span><span class="op" id="3893282">:</span><span class="op" id="3893283">]</span><span class="op" id="3893284">,</span>&nbsp;<span class="ident" id="3893286">prefix</span><span class="op" id="3893292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893297">c</span><span class="op" id="3893298">.</span><span class="ident" id="3893299">CryptBlocks</span><span class="op" id="3893310">(</span><span class="ident" id="3893311">b</span><span class="op" id="3893312">.</span><span class="ident" id="3893313">data</span><span class="op" id="3893317">[</span><span class="ident" id="3893318">recordHeaderLen</span><span class="op" id="3893333">+</span><span class="ident" id="3893334">explicitIVLen</span><span class="op" id="3893347">+</span><span class="builtinfunc" id="3893348">len</span><span class="op" id="3893351">(</span><span class="ident" id="3893352">prefix</span><span class="op" id="3893358">)</span><span class="op" id="3893359">:</span><span class="op" id="3893360">]</span><span class="op" id="3893361">,</span>&nbsp;<span class="ident" id="3893363">finalBlock</span><span class="op" id="3893373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893377">default</span><span class="op" id="3893384">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3893389">panic</span><span class="op" id="3893394">(</span><span class="string" id="3893395">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="3893416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893420">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3893427">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893490">n</span>&nbsp;<span class="op" id="3893492">:=</span>&nbsp;<span class="builtinfunc" id="3893495">len</span><span class="op" id="3893498">(</span><span class="ident" id="3893499">b</span><span class="op" id="3893500">.</span><span class="ident" id="3893501">data</span><span class="op" id="3893505">)</span>&nbsp;<span class="op" id="3893507">-</span>&nbsp;<span class="ident" id="3893509">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893526">b</span><span class="op" id="3893527">.</span><span class="ident" id="3893528">data</span><span class="op" id="3893532">[</span><span class="num" id="3893533">3</span><span class="op" id="3893534">]</span>&nbsp;<span class="op" id="3893536">=</span>&nbsp;<span class="builtintype" id="3893538">byte</span><span class="op" id="3893542">(</span><span class="ident" id="3893543">n</span>&nbsp;<span class="op" id="3893545">&gt;&gt;</span>&nbsp;<span class="num" id="3893548">8</span><span class="op" id="3893549">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893552">b</span><span class="op" id="3893553">.</span><span class="ident" id="3893554">data</span><span class="op" id="3893558">[</span><span class="num" id="3893559">4</span><span class="op" id="3893560">]</span>&nbsp;<span class="op" id="3893562">=</span>&nbsp;<span class="builtintype" id="3893564">byte</span><span class="op" id="3893568">(</span><span class="ident" id="3893569">n</span><span class="op" id="3893570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893573">hc</span><span class="op" id="3893575">.</span><span class="ident" id="3893576">incSeq</span><span class="op" id="3893582">(</span><span class="op" id="3893583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893587">return</span>&nbsp;<span class="builtintype" id="3893594">true</span><span class="op" id="3893598">,</span>&nbsp;<span class="num" id="3893600">0</span><br>
<span class="lineno"></span><span class="op" id="3893602">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="3893605">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="3893641">type</span>&nbsp;<span class="ident" id="3893646">block</span>&nbsp;<span class="keyword" id="3893652">struct</span>&nbsp;<span class="op" id="3893659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893662">data</span>&nbsp;<span class="op" id="3893667">[</span><span class="op" id="3893668">]</span><span class="builtintype" id="3893669">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893675">off</span>&nbsp;&nbsp;<span class="builtintype" id="3893680">int</span>&nbsp;<span class="comment" id="3893684">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893703">link</span>&nbsp;<span class="op" id="3893708">*</span><span class="ident" id="3893709">block</span><br>
<span class="lineno"></span><span class="op" id="3893715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3893718">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3893779">func</span>&nbsp;<span class="op" id="3893784">(</span><span class="ident" id="3893785">b</span>&nbsp;<span class="op" id="3893787">*</span><span class="ident" id="3893788">block</span><span class="op" id="3893793">)</span>&nbsp;<span class="ident" id="3893795">resize</span><span class="op" id="3893801">(</span><span class="ident" id="3893802">n</span>&nbsp;<span class="builtintype" id="3893804">int</span><span class="op" id="3893807">)</span>&nbsp;<span class="op" id="3893809">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893812">if</span>&nbsp;<span class="ident" id="3893815">n</span>&nbsp;<span class="op" id="3893817">&gt;</span>&nbsp;<span class="builtinfunc" id="3893819">cap</span><span class="op" id="3893822">(</span><span class="ident" id="3893823">b</span><span class="op" id="3893824">.</span><span class="ident" id="3893825">data</span><span class="op" id="3893829">)</span>&nbsp;<span class="op" id="3893831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893835">b</span><span class="op" id="3893836">.</span><span class="ident" id="3893837">reserve</span><span class="op" id="3893844">(</span><span class="ident" id="3893845">n</span><span class="op" id="3893846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3893849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3893852">b</span><span class="op" id="3893853">.</span><span class="ident" id="3893854">data</span>&nbsp;<span class="op" id="3893859">=</span>&nbsp;<span class="ident" id="3893861">b</span><span class="op" id="3893862">.</span><span class="ident" id="3893863">data</span><span class="op" id="3893867">[</span><span class="num" id="3893868">0</span><span class="op" id="3893869">:</span><span class="ident" id="3893870">n</span><span class="op" id="3893871">]</span><br>
<span class="lineno"></span><span class="op" id="3893873">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="3893876">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="3893950">func</span>&nbsp;<span class="op" id="3893955">(</span><span class="ident" id="3893956">b</span>&nbsp;<span class="op" id="3893958">*</span><span class="ident" id="3893959">block</span><span class="op" id="3893964">)</span>&nbsp;<span class="ident" id="3893966">reserve</span><span class="op" id="3893973">(</span><span class="ident" id="3893974">n</span>&nbsp;<span class="builtintype" id="3893976">int</span><span class="op" id="3893979">)</span>&nbsp;<span class="op" id="3893981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3893984">if</span>&nbsp;<span class="builtinfunc" id="3893987">cap</span><span class="op" id="3893990">(</span><span class="ident" id="3893991">b</span><span class="op" id="3893992">.</span><span class="ident" id="3893993">data</span><span class="op" id="3893997">)</span>&nbsp;<span class="op" id="3893999">&gt;=</span>&nbsp;<span class="ident" id="3894002">n</span>&nbsp;<span class="op" id="3894004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894008">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894019">m</span>&nbsp;<span class="op" id="3894021">:=</span>&nbsp;<span class="builtinfunc" id="3894024">cap</span><span class="op" id="3894027">(</span><span class="ident" id="3894028">b</span><span class="op" id="3894029">.</span><span class="ident" id="3894030">data</span><span class="op" id="3894034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894037">if</span>&nbsp;<span class="ident" id="3894040">m</span>&nbsp;<span class="op" id="3894042">==</span>&nbsp;<span class="num" id="3894045">0</span>&nbsp;<span class="op" id="3894047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894051">m</span>&nbsp;<span class="op" id="3894053">=</span>&nbsp;<span class="num" id="3894055">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894061">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894064">for</span>&nbsp;<span class="ident" id="3894068">m</span>&nbsp;<span class="op" id="3894070">&lt;</span>&nbsp;<span class="ident" id="3894072">n</span>&nbsp;<span class="op" id="3894074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894078">m</span>&nbsp;<span class="op" id="3894080">*=</span>&nbsp;<span class="num" id="3894083">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894089">data</span>&nbsp;<span class="op" id="3894094">:=</span>&nbsp;<span class="builtinfunc" id="3894097">make</span><span class="op" id="3894101">(</span><span class="op" id="3894102">[</span><span class="op" id="3894103">]</span><span class="builtintype" id="3894104">byte</span><span class="op" id="3894108">,</span>&nbsp;<span class="builtinfunc" id="3894110">len</span><span class="op" id="3894113">(</span><span class="ident" id="3894114">b</span><span class="op" id="3894115">.</span><span class="ident" id="3894116">data</span><span class="op" id="3894120">)</span><span class="op" id="3894121">,</span>&nbsp;<span class="ident" id="3894123">m</span><span class="op" id="3894124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3894127">copy</span><span class="op" id="3894131">(</span><span class="ident" id="3894132">data</span><span class="op" id="3894136">,</span>&nbsp;<span class="ident" id="3894138">b</span><span class="op" id="3894139">.</span><span class="ident" id="3894140">data</span><span class="op" id="3894144">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894147">b</span><span class="op" id="3894148">.</span><span class="ident" id="3894149">data</span>&nbsp;<span class="op" id="3894154">=</span>&nbsp;<span class="ident" id="3894156">data</span><br>
<span class="lineno"></span><span class="op" id="3894161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3894164">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="3894235">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="3894264">func</span>&nbsp;<span class="op" id="3894269">(</span><span class="ident" id="3894270">b</span>&nbsp;<span class="op" id="3894272">*</span><span class="ident" id="3894273">block</span><span class="op" id="3894278">)</span>&nbsp;<span class="ident" id="3894280">readFromUntil</span><span class="op" id="3894293">(</span><span class="ident" id="3894294">r</span>&nbsp;<span class="ident" id="3894296">io</span><span class="op" id="3894298">.</span><span class="ident" id="3894299">Reader</span><span class="op" id="3894305">,</span>&nbsp;<span class="ident" id="3894307">n</span>&nbsp;<span class="builtintype" id="3894309">int</span><span class="op" id="3894312">)</span>&nbsp;<span class="builtintype" id="3894314">error</span>&nbsp;<span class="op" id="3894320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894323">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894338">if</span>&nbsp;<span class="builtinfunc" id="3894341">len</span><span class="op" id="3894344">(</span><span class="ident" id="3894345">b</span><span class="op" id="3894346">.</span><span class="ident" id="3894347">data</span><span class="op" id="3894351">)</span>&nbsp;<span class="op" id="3894353">&gt;=</span>&nbsp;<span class="ident" id="3894356">n</span>&nbsp;<span class="op" id="3894358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894362">return</span>&nbsp;<span class="ident" id="3894369">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894374">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894378">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894406">b</span><span class="op" id="3894407">.</span><span class="ident" id="3894408">reserve</span><span class="op" id="3894415">(</span><span class="ident" id="3894416">n</span><span class="op" id="3894417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894420">for</span>&nbsp;<span class="op" id="3894424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894428">m</span><span class="op" id="3894429">,</span>&nbsp;<span class="ident" id="3894431">err</span>&nbsp;<span class="op" id="3894435">:=</span>&nbsp;<span class="ident" id="3894438">r</span><span class="op" id="3894439">.</span><span class="ident" id="3894440">Read</span><span class="op" id="3894444">(</span><span class="ident" id="3894445">b</span><span class="op" id="3894446">.</span><span class="ident" id="3894447">data</span><span class="op" id="3894451">[</span><span class="builtinfunc" id="3894452">len</span><span class="op" id="3894455">(</span><span class="ident" id="3894456">b</span><span class="op" id="3894457">.</span><span class="ident" id="3894458">data</span><span class="op" id="3894462">)</span><span class="op" id="3894463">:</span><span class="builtinfunc" id="3894464">cap</span><span class="op" id="3894467">(</span><span class="ident" id="3894468">b</span><span class="op" id="3894469">.</span><span class="ident" id="3894470">data</span><span class="op" id="3894474">)</span><span class="op" id="3894475">]</span><span class="op" id="3894476">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894480">b</span><span class="op" id="3894481">.</span><span class="ident" id="3894482">data</span>&nbsp;<span class="op" id="3894487">=</span>&nbsp;<span class="ident" id="3894489">b</span><span class="op" id="3894490">.</span><span class="ident" id="3894491">data</span><span class="op" id="3894495">[</span><span class="num" id="3894496">0</span>&nbsp;<span class="op" id="3894498">:</span>&nbsp;<span class="builtinfunc" id="3894500">len</span><span class="op" id="3894503">(</span><span class="ident" id="3894504">b</span><span class="op" id="3894505">.</span><span class="ident" id="3894506">data</span><span class="op" id="3894510">)</span><span class="op" id="3894511">+</span><span class="ident" id="3894512">m</span><span class="op" id="3894513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894517">if</span>&nbsp;<span class="builtinfunc" id="3894520">len</span><span class="op" id="3894523">(</span><span class="ident" id="3894524">b</span><span class="op" id="3894525">.</span><span class="ident" id="3894526">data</span><span class="op" id="3894530">)</span>&nbsp;<span class="op" id="3894532">&gt;=</span>&nbsp;<span class="ident" id="3894535">n</span>&nbsp;<span class="op" id="3894537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894542">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3894588">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894638">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894650">if</span>&nbsp;<span class="ident" id="3894653">err</span>&nbsp;<span class="op" id="3894657">!=</span>&nbsp;<span class="ident" id="3894660">nil</span>&nbsp;<span class="op" id="3894664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894669">return</span>&nbsp;<span class="ident" id="3894676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894685">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894688">return</span>&nbsp;<span class="ident" id="3894695">nil</span><br>
<span class="lineno"></span><span class="op" id="3894699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3894702">func</span>&nbsp;<span class="op" id="3894707">(</span><span class="ident" id="3894708">b</span>&nbsp;<span class="op" id="3894710">*</span><span class="ident" id="3894711">block</span><span class="op" id="3894716">)</span>&nbsp;<span class="ident" id="3894718">Read</span><span class="op" id="3894722">(</span><span class="ident" id="3894723">p</span>&nbsp;<span class="op" id="3894725">[</span><span class="op" id="3894726">]</span><span class="builtintype" id="3894727">byte</span><span class="op" id="3894731">)</span>&nbsp;<span class="op" id="3894733">(</span><span class="ident" id="3894734">n</span>&nbsp;<span class="builtintype" id="3894736">int</span><span class="op" id="3894739">,</span>&nbsp;<span class="ident" id="3894741">err</span>&nbsp;<span class="builtintype" id="3894745">error</span><span class="op" id="3894750">)</span>&nbsp;<span class="op" id="3894752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894755">n</span>&nbsp;<span class="op" id="3894757">=</span>&nbsp;<span class="builtinfunc" id="3894759">copy</span><span class="op" id="3894763">(</span><span class="ident" id="3894764">p</span><span class="op" id="3894765">,</span>&nbsp;<span class="ident" id="3894767">b</span><span class="op" id="3894768">.</span><span class="ident" id="3894769">data</span><span class="op" id="3894773">[</span><span class="ident" id="3894774">b</span><span class="op" id="3894775">.</span><span class="ident" id="3894776">off</span><span class="op" id="3894779">:</span><span class="op" id="3894780">]</span><span class="op" id="3894781">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894784">b</span><span class="op" id="3894785">.</span><span class="ident" id="3894786">off</span>&nbsp;<span class="op" id="3894790">+=</span>&nbsp;<span class="ident" id="3894793">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894796">return</span><br>
<span class="lineno"></span><span class="op" id="3894803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3894806">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="3894874">func</span>&nbsp;<span class="op" id="3894879">(</span><span class="ident" id="3894880">hc</span>&nbsp;<span class="op" id="3894883">*</span><span class="ident" id="3894884">halfConn</span><span class="op" id="3894892">)</span>&nbsp;<span class="ident" id="3894894">newBlock</span><span class="op" id="3894902">(</span><span class="op" id="3894903">)</span>&nbsp;<span class="op" id="3894905">*</span><span class="ident" id="3894906">block</span>&nbsp;<span class="op" id="3894912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894915">b</span>&nbsp;<span class="op" id="3894917">:=</span>&nbsp;<span class="ident" id="3894920">hc</span><span class="op" id="3894922">.</span><span class="ident" id="3894923">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894930">if</span>&nbsp;<span class="ident" id="3894933">b</span>&nbsp;<span class="op" id="3894935">==</span>&nbsp;<span class="ident" id="3894938">nil</span>&nbsp;<span class="op" id="3894942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3894946">return</span>&nbsp;<span class="builtinfunc" id="3894953">new</span><span class="op" id="3894956">(</span><span class="ident" id="3894957">block</span><span class="op" id="3894962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3894965">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894968">hc</span><span class="op" id="3894970">.</span><span class="ident" id="3894971">bfree</span>&nbsp;<span class="op" id="3894977">=</span>&nbsp;<span class="ident" id="3894979">b</span><span class="op" id="3894980">.</span><span class="ident" id="3894981">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3894987">b</span><span class="op" id="3894988">.</span><span class="ident" id="3894989">link</span>&nbsp;<span class="op" id="3894994">=</span>&nbsp;<span class="ident" id="3894996">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895001">b</span><span class="op" id="3895002">.</span><span class="ident" id="3895003">resize</span><span class="op" id="3895009">(</span><span class="num" id="3895010">0</span><span class="op" id="3895011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895014">return</span>&nbsp;<span class="ident" id="3895021">b</span><br>
<span class="lineno"></span><span class="op" id="3895023">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="3895026">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="3895074">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3895140">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="3895202">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="3895229">func</span>&nbsp;<span class="op" id="3895234">(</span><span class="ident" id="3895235">hc</span>&nbsp;<span class="op" id="3895238">*</span><span class="ident" id="3895239">halfConn</span><span class="op" id="3895247">)</span>&nbsp;<span class="ident" id="3895249">freeBlock</span><span class="op" id="3895258">(</span><span class="ident" id="3895259">b</span>&nbsp;<span class="op" id="3895261">*</span><span class="ident" id="3895262">block</span><span class="op" id="3895267">)</span>&nbsp;<span class="op" id="3895269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895272">b</span><span class="op" id="3895273">.</span><span class="ident" id="3895274">link</span>&nbsp;<span class="op" id="3895279">=</span>&nbsp;<span class="ident" id="3895281">hc</span><span class="op" id="3895283">.</span><span class="ident" id="3895284">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895291">hc</span><span class="op" id="3895293">.</span><span class="ident" id="3895294">bfree</span>&nbsp;<span class="op" id="3895300">=</span>&nbsp;<span class="ident" id="3895302">b</span><br>
<span class="lineno"></span><span class="op" id="3895304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="3895307">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="3895361">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3895407">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3895460">func</span>&nbsp;<span class="op" id="3895465">(</span><span class="ident" id="3895466">hc</span>&nbsp;<span class="op" id="3895469">*</span><span class="ident" id="3895470">halfConn</span><span class="op" id="3895478">)</span>&nbsp;<span class="ident" id="3895480">splitBlock</span><span class="op" id="3895490">(</span><span class="ident" id="3895491">b</span>&nbsp;<span class="op" id="3895493">*</span><span class="ident" id="3895494">block</span><span class="op" id="3895499">,</span>&nbsp;<span class="ident" id="3895501">n</span>&nbsp;<span class="builtintype" id="3895503">int</span><span class="op" id="3895506">)</span>&nbsp;<span class="op" id="3895508">(</span><span class="op" id="3895509">*</span><span class="ident" id="3895510">block</span><span class="op" id="3895515">,</span>&nbsp;<span class="op" id="3895517">*</span><span class="ident" id="3895518">block</span><span class="op" id="3895523">)</span>&nbsp;<span class="op" id="3895525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895528">if</span>&nbsp;<span class="builtinfunc" id="3895531">len</span><span class="op" id="3895534">(</span><span class="ident" id="3895535">b</span><span class="op" id="3895536">.</span><span class="ident" id="3895537">data</span><span class="op" id="3895541">)</span>&nbsp;<span class="op" id="3895543">&lt;=</span>&nbsp;<span class="ident" id="3895546">n</span>&nbsp;<span class="op" id="3895548">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895552">return</span>&nbsp;<span class="ident" id="3895559">b</span><span class="op" id="3895560">,</span>&nbsp;<span class="ident" id="3895562">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3895567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895570">bb</span>&nbsp;<span class="op" id="3895573">:=</span>&nbsp;<span class="ident" id="3895576">hc</span><span class="op" id="3895578">.</span><span class="ident" id="3895579">newBlock</span><span class="op" id="3895587">(</span><span class="op" id="3895588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895591">bb</span><span class="op" id="3895593">.</span><span class="ident" id="3895594">resize</span><span class="op" id="3895600">(</span><span class="builtinfunc" id="3895601">len</span><span class="op" id="3895604">(</span><span class="ident" id="3895605">b</span><span class="op" id="3895606">.</span><span class="ident" id="3895607">data</span><span class="op" id="3895611">)</span>&nbsp;<span class="op" id="3895613">-</span>&nbsp;<span class="ident" id="3895615">n</span><span class="op" id="3895616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3895619">copy</span><span class="op" id="3895623">(</span><span class="ident" id="3895624">bb</span><span class="op" id="3895626">.</span><span class="ident" id="3895627">data</span><span class="op" id="3895631">,</span>&nbsp;<span class="ident" id="3895633">b</span><span class="op" id="3895634">.</span><span class="ident" id="3895635">data</span><span class="op" id="3895639">[</span><span class="ident" id="3895640">n</span><span class="op" id="3895641">:</span><span class="op" id="3895642">]</span><span class="op" id="3895643">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3895646">b</span><span class="op" id="3895647">.</span><span class="ident" id="3895648">data</span>&nbsp;<span class="op" id="3895653">=</span>&nbsp;<span class="ident" id="3895655">b</span><span class="op" id="3895656">.</span><span class="ident" id="3895657">data</span><span class="op" id="3895661">[</span><span class="num" id="3895662">0</span><span class="op" id="3895663">:</span><span class="ident" id="3895664">n</span><span class="op" id="3895665">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3895668">return</span>&nbsp;<span class="ident" id="3895675">b</span><span class="op" id="3895676">,</span>&nbsp;<span class="ident" id="3895678">bb</span><br>
<span class="lineno"></span><span class="op" id="3895681">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3895684">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="3895744">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3895783">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="3895819">func</span>&nbsp;<span class="op" id="3895824">(</span><span class="ident" id="3895825">c</span>&nbsp;<span class="op" id="3895827">*</span><span class="ident" id="3895828">Conn</span><span class="op" id="3895832">)</span>&nbsp;<span class="ident" id="3895834">readRecord</span><span class="op" id="3895844">(</span><span class="ident" id="3895845">want</span>&nbsp;<span class="ident" id="3895850">recordType</span><span class="op" id="3895860">)</span>&nbsp;<span class="builtintype" id="3895862">error</span>&nbsp;<span class="op" id="3895868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3895871">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3895915">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3895966">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896028">switch</span>&nbsp;<span class="ident" id="3896035">want</span>&nbsp;<span class="op" id="3896040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896043">default</span><span class="op" id="3896050">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896054">c</span><span class="op" id="3896055">.</span><span class="ident" id="3896056">sendAlert</span><span class="op" id="3896065">(</span><span class="ident" id="3896066">alertInternalError</span><span class="op" id="3896084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896088">return</span>&nbsp;<span class="ident" id="3896095">c</span><span class="op" id="3896096">.</span><span class="ident" id="3896097">in</span><span class="op" id="3896099">.</span><span class="ident" id="3896100">setErrorLocked</span><span class="op" id="3896114">(</span><span class="ident" id="3896115">errors</span><span class="op" id="3896121">.</span><span class="ident" id="3896122">New</span><span class="op" id="3896125">(</span><span class="string" id="3896126">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="3896162">)</span><span class="op" id="3896163">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896166">case</span>&nbsp;<span class="ident" id="3896171">recordTypeHandshake</span><span class="op" id="3896190">,</span>&nbsp;<span class="ident" id="3896192">recordTypeChangeCipherSpec</span><span class="op" id="3896218">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896222">if</span>&nbsp;<span class="ident" id="3896225">c</span><span class="op" id="3896226">.</span><span class="ident" id="3896227">handshakeComplete</span>&nbsp;<span class="op" id="3896245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896250">c</span><span class="op" id="3896251">.</span><span class="ident" id="3896252">sendAlert</span><span class="op" id="3896261">(</span><span class="ident" id="3896262">alertInternalError</span><span class="op" id="3896280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896285">return</span>&nbsp;<span class="ident" id="3896292">c</span><span class="op" id="3896293">.</span><span class="ident" id="3896294">in</span><span class="op" id="3896296">.</span><span class="ident" id="3896297">setErrorLocked</span><span class="op" id="3896311">(</span><span class="ident" id="3896312">errors</span><span class="op" id="3896318">.</span><span class="ident" id="3896319">New</span><span class="op" id="3896322">(</span><span class="string" id="3896323">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3896394">)</span><span class="op" id="3896395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896399">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896402">case</span>&nbsp;<span class="ident" id="3896407">recordTypeApplicationData</span><span class="op" id="3896432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896436">if</span>&nbsp;<span class="op" id="3896439">!</span><span class="ident" id="3896440">c</span><span class="op" id="3896441">.</span><span class="ident" id="3896442">handshakeComplete</span>&nbsp;<span class="op" id="3896460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896465">c</span><span class="op" id="3896466">.</span><span class="ident" id="3896467">sendAlert</span><span class="op" id="3896476">(</span><span class="ident" id="3896477">alertInternalError</span><span class="op" id="3896495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896500">return</span>&nbsp;<span class="ident" id="3896507">c</span><span class="op" id="3896508">.</span><span class="ident" id="3896509">in</span><span class="op" id="3896511">.</span><span class="ident" id="3896512">setErrorLocked</span><span class="op" id="3896526">(</span><span class="ident" id="3896527">errors</span><span class="op" id="3896533">.</span><span class="ident" id="3896534">New</span><span class="op" id="3896537">(</span><span class="string" id="3896538">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="3896604">)</span><span class="op" id="3896605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896609">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="3896615">Again</span><span class="op" id="3896620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896623">if</span>&nbsp;<span class="ident" id="3896626">c</span><span class="op" id="3896627">.</span><span class="ident" id="3896628">rawInput</span>&nbsp;<span class="op" id="3896637">==</span>&nbsp;<span class="ident" id="3896640">nil</span>&nbsp;<span class="op" id="3896644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896648">c</span><span class="op" id="3896649">.</span><span class="ident" id="3896650">rawInput</span>&nbsp;<span class="op" id="3896659">=</span>&nbsp;<span class="ident" id="3896661">c</span><span class="op" id="3896662">.</span><span class="ident" id="3896663">in</span><span class="op" id="3896665">.</span><span class="ident" id="3896666">newBlock</span><span class="op" id="3896674">(</span><span class="op" id="3896675">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3896678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3896681">b</span>&nbsp;<span class="op" id="3896683">:=</span>&nbsp;<span class="ident" id="3896686">c</span><span class="op" id="3896687">.</span><span class="ident" id="3896688">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896699">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3896725">if</span>&nbsp;<span class="ident" id="3896728">err</span>&nbsp;<span class="op" id="3896732">:=</span>&nbsp;<span class="ident" id="3896735">b</span><span class="op" id="3896736">.</span><span class="ident" id="3896737">readFromUntil</span><span class="op" id="3896750">(</span><span class="ident" id="3896751">c</span><span class="op" id="3896752">.</span><span class="ident" id="3896753">conn</span><span class="op" id="3896757">,</span>&nbsp;<span class="ident" id="3896759">recordHeaderLen</span><span class="op" id="3896774">)</span><span class="op" id="3896775">;</span>&nbsp;<span class="ident" id="3896777">err</span>&nbsp;<span class="op" id="3896781">!=</span>&nbsp;<span class="ident" id="3896784">nil</span>&nbsp;<span class="op" id="3896788">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896792">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896850">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896904">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896939">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896963">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3896995">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897002">if</span>&nbsp;<span class="ident" id="3897005">e</span><span class="op" id="3897006">,</span>&nbsp;<span class="ident" id="3897008">ok</span>&nbsp;<span class="op" id="3897011">:=</span>&nbsp;<span class="ident" id="3897014">err</span><span class="op" id="3897017">.</span><span class="op" id="3897018">(</span><span class="ident" id="3897019">net</span><span class="op" id="3897022">.</span><span class="ident" id="3897023">Error</span><span class="op" id="3897028">)</span><span class="op" id="3897029">;</span>&nbsp;<span class="op" id="3897031">!</span><span class="ident" id="3897032">ok</span>&nbsp;<span class="op" id="3897035">||</span>&nbsp;<span class="op" id="3897038">!</span><span class="ident" id="3897039">e</span><span class="op" id="3897040">.</span><span class="ident" id="3897041">Temporary</span><span class="op" id="3897050">(</span><span class="op" id="3897051">)</span>&nbsp;<span class="op" id="3897053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897058">c</span><span class="op" id="3897059">.</span><span class="ident" id="3897060">in</span><span class="op" id="3897062">.</span><span class="ident" id="3897063">setErrorLocked</span><span class="op" id="3897077">(</span><span class="ident" id="3897078">err</span><span class="op" id="3897081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897089">return</span>&nbsp;<span class="ident" id="3897096">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897104">typ</span>&nbsp;<span class="op" id="3897108">:=</span>&nbsp;<span class="ident" id="3897111">recordType</span><span class="op" id="3897121">(</span><span class="ident" id="3897122">b</span><span class="op" id="3897123">.</span><span class="ident" id="3897124">data</span><span class="op" id="3897128">[</span><span class="num" id="3897129">0</span><span class="op" id="3897130">]</span><span class="op" id="3897131">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3897135">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3897204">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3897277">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3897349">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897370">if</span>&nbsp;<span class="ident" id="3897373">want</span>&nbsp;<span class="op" id="3897378">==</span>&nbsp;<span class="ident" id="3897381">recordTypeHandshake</span>&nbsp;<span class="op" id="3897401">&amp;&amp;</span>&nbsp;<span class="ident" id="3897404">typ</span>&nbsp;<span class="op" id="3897408">==</span>&nbsp;<span class="num" id="3897411">0x80</span>&nbsp;<span class="op" id="3897416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897420">c</span><span class="op" id="3897421">.</span><span class="ident" id="3897422">sendAlert</span><span class="op" id="3897431">(</span><span class="ident" id="3897432">alertProtocolVersion</span><span class="op" id="3897452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897456">return</span>&nbsp;<span class="ident" id="3897463">c</span><span class="op" id="3897464">.</span><span class="ident" id="3897465">in</span><span class="op" id="3897467">.</span><span class="ident" id="3897468">setErrorLocked</span><span class="op" id="3897482">(</span><span class="ident" id="3897483">errors</span><span class="op" id="3897489">.</span><span class="ident" id="3897490">New</span><span class="op" id="3897493">(</span><span class="string" id="3897494">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="3897537">)</span><span class="op" id="3897538">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897545">vers</span>&nbsp;<span class="op" id="3897550">:=</span>&nbsp;<span class="builtintype" id="3897553">uint16</span><span class="op" id="3897559">(</span><span class="ident" id="3897560">b</span><span class="op" id="3897561">.</span><span class="ident" id="3897562">data</span><span class="op" id="3897566">[</span><span class="num" id="3897567">1</span><span class="op" id="3897568">]</span><span class="op" id="3897569">)</span><span class="op" id="3897570">&lt;&lt;</span><span class="num" id="3897572">8</span>&nbsp;<span class="op" id="3897574">|</span>&nbsp;<span class="builtintype" id="3897576">uint16</span><span class="op" id="3897582">(</span><span class="ident" id="3897583">b</span><span class="op" id="3897584">.</span><span class="ident" id="3897585">data</span><span class="op" id="3897589">[</span><span class="num" id="3897590">2</span><span class="op" id="3897591">]</span><span class="op" id="3897592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897595">n</span>&nbsp;<span class="op" id="3897597">:=</span>&nbsp;<span class="builtintype" id="3897600">int</span><span class="op" id="3897603">(</span><span class="ident" id="3897604">b</span><span class="op" id="3897605">.</span><span class="ident" id="3897606">data</span><span class="op" id="3897610">[</span><span class="num" id="3897611">3</span><span class="op" id="3897612">]</span><span class="op" id="3897613">)</span><span class="op" id="3897614">&lt;&lt;</span><span class="num" id="3897616">8</span>&nbsp;<span class="op" id="3897618">|</span>&nbsp;<span class="builtintype" id="3897620">int</span><span class="op" id="3897623">(</span><span class="ident" id="3897624">b</span><span class="op" id="3897625">.</span><span class="ident" id="3897626">data</span><span class="op" id="3897630">[</span><span class="num" id="3897631">4</span><span class="op" id="3897632">]</span><span class="op" id="3897633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897636">if</span>&nbsp;<span class="ident" id="3897639">c</span><span class="op" id="3897640">.</span><span class="ident" id="3897641">haveVers</span>&nbsp;<span class="op" id="3897650">&amp;&amp;</span>&nbsp;<span class="ident" id="3897653">vers</span>&nbsp;<span class="op" id="3897658">!=</span>&nbsp;<span class="ident" id="3897661">c</span><span class="op" id="3897662">.</span><span class="ident" id="3897663">vers</span>&nbsp;<span class="op" id="3897668">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897672">c</span><span class="op" id="3897673">.</span><span class="ident" id="3897674">sendAlert</span><span class="op" id="3897683">(</span><span class="ident" id="3897684">alertProtocolVersion</span><span class="op" id="3897704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897708">return</span>&nbsp;<span class="ident" id="3897715">c</span><span class="op" id="3897716">.</span><span class="ident" id="3897717">in</span><span class="op" id="3897719">.</span><span class="ident" id="3897720">setErrorLocked</span><span class="op" id="3897734">(</span><span class="ident" id="3897735">fmt</span><span class="op" id="3897738">.</span><span class="ident" id="3897739">Errorf</span><span class="op" id="3897745">(</span><span class="string" id="3897746">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="3897810">,</span>&nbsp;<span class="ident" id="3897812">vers</span><span class="op" id="3897816">,</span>&nbsp;<span class="ident" id="3897818">c</span><span class="op" id="3897819">.</span><span class="ident" id="3897820">vers</span><span class="op" id="3897824">)</span><span class="op" id="3897825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897831">if</span>&nbsp;<span class="ident" id="3897834">n</span>&nbsp;<span class="op" id="3897836">&gt;</span>&nbsp;<span class="ident" id="3897838">maxCiphertext</span>&nbsp;<span class="op" id="3897852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3897856">c</span><span class="op" id="3897857">.</span><span class="ident" id="3897858">sendAlert</span><span class="op" id="3897867">(</span><span class="ident" id="3897868">alertRecordOverflow</span><span class="op" id="3897887">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897891">return</span>&nbsp;<span class="ident" id="3897898">c</span><span class="op" id="3897899">.</span><span class="ident" id="3897900">in</span><span class="op" id="3897902">.</span><span class="ident" id="3897903">setErrorLocked</span><span class="op" id="3897917">(</span><span class="ident" id="3897918">fmt</span><span class="op" id="3897921">.</span><span class="ident" id="3897922">Errorf</span><span class="op" id="3897928">(</span><span class="string" id="3897929">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="3897976">,</span>&nbsp;<span class="ident" id="3897978">n</span><span class="op" id="3897979">)</span><span class="op" id="3897980">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3897983">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3897986">if</span>&nbsp;<span class="op" id="3897989">!</span><span class="ident" id="3897990">c</span><span class="op" id="3897991">.</span><span class="ident" id="3897992">haveVers</span>&nbsp;<span class="op" id="3898001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898005">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898046">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898083">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898140">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898177">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898233">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898282">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898338">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898367">if</span>&nbsp;<span class="op" id="3898370">(</span><span class="ident" id="3898371">typ</span>&nbsp;<span class="op" id="3898375">!=</span>&nbsp;<span class="ident" id="3898378">recordTypeAlert</span>&nbsp;<span class="op" id="3898394">&amp;&amp;</span>&nbsp;<span class="ident" id="3898397">typ</span>&nbsp;<span class="op" id="3898401">!=</span>&nbsp;<span class="ident" id="3898404">want</span><span class="op" id="3898408">)</span>&nbsp;<span class="op" id="3898410">||</span>&nbsp;<span class="ident" id="3898413">vers</span>&nbsp;<span class="op" id="3898418">&gt;=</span>&nbsp;<span class="num" id="3898421">0x1000</span>&nbsp;<span class="op" id="3898428">||</span>&nbsp;<span class="ident" id="3898431">n</span>&nbsp;<span class="op" id="3898433">&gt;=</span>&nbsp;<span class="num" id="3898436">0x3000</span>&nbsp;<span class="op" id="3898443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898448">c</span><span class="op" id="3898449">.</span><span class="ident" id="3898450">sendAlert</span><span class="op" id="3898459">(</span><span class="ident" id="3898460">alertUnexpectedMessage</span><span class="op" id="3898482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898487">return</span>&nbsp;<span class="ident" id="3898494">c</span><span class="op" id="3898495">.</span><span class="ident" id="3898496">in</span><span class="op" id="3898498">.</span><span class="ident" id="3898499">setErrorLocked</span><span class="op" id="3898513">(</span><span class="ident" id="3898514">fmt</span><span class="op" id="3898517">.</span><span class="ident" id="3898518">Errorf</span><span class="op" id="3898524">(</span><span class="string" id="3898525">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="3898579">)</span><span class="op" id="3898580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898584">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898590">if</span>&nbsp;<span class="ident" id="3898593">err</span>&nbsp;<span class="op" id="3898597">:=</span>&nbsp;<span class="ident" id="3898600">b</span><span class="op" id="3898601">.</span><span class="ident" id="3898602">readFromUntil</span><span class="op" id="3898615">(</span><span class="ident" id="3898616">c</span><span class="op" id="3898617">.</span><span class="ident" id="3898618">conn</span><span class="op" id="3898622">,</span>&nbsp;<span class="ident" id="3898624">recordHeaderLen</span><span class="op" id="3898639">+</span><span class="ident" id="3898640">n</span><span class="op" id="3898641">)</span><span class="op" id="3898642">;</span>&nbsp;<span class="ident" id="3898644">err</span>&nbsp;<span class="op" id="3898648">!=</span>&nbsp;<span class="ident" id="3898651">nil</span>&nbsp;<span class="op" id="3898655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898659">if</span>&nbsp;<span class="ident" id="3898662">err</span>&nbsp;<span class="op" id="3898666">==</span>&nbsp;<span class="ident" id="3898669">io</span><span class="op" id="3898671">.</span><span class="ident" id="3898672">EOF</span>&nbsp;<span class="op" id="3898676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898681">err</span>&nbsp;<span class="op" id="3898685">=</span>&nbsp;<span class="ident" id="3898687">io</span><span class="op" id="3898689">.</span><span class="ident" id="3898690">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898709">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898713">if</span>&nbsp;<span class="ident" id="3898716">e</span><span class="op" id="3898717">,</span>&nbsp;<span class="ident" id="3898719">ok</span>&nbsp;<span class="op" id="3898722">:=</span>&nbsp;<span class="ident" id="3898725">err</span><span class="op" id="3898728">.</span><span class="op" id="3898729">(</span><span class="ident" id="3898730">net</span><span class="op" id="3898733">.</span><span class="ident" id="3898734">Error</span><span class="op" id="3898739">)</span><span class="op" id="3898740">;</span>&nbsp;<span class="op" id="3898742">!</span><span class="ident" id="3898743">ok</span>&nbsp;<span class="op" id="3898746">||</span>&nbsp;<span class="op" id="3898749">!</span><span class="ident" id="3898750">e</span><span class="op" id="3898751">.</span><span class="ident" id="3898752">Temporary</span><span class="op" id="3898761">(</span><span class="op" id="3898762">)</span>&nbsp;<span class="op" id="3898764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898769">c</span><span class="op" id="3898770">.</span><span class="ident" id="3898771">in</span><span class="op" id="3898773">.</span><span class="ident" id="3898774">setErrorLocked</span><span class="op" id="3898788">(</span><span class="ident" id="3898789">err</span><span class="op" id="3898792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898800">return</span>&nbsp;<span class="ident" id="3898807">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898812">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3898816">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898837">b</span><span class="op" id="3898838">,</span>&nbsp;<span class="ident" id="3898840">c</span><span class="op" id="3898841">.</span><span class="ident" id="3898842">rawInput</span>&nbsp;<span class="op" id="3898851">=</span>&nbsp;<span class="ident" id="3898853">c</span><span class="op" id="3898854">.</span><span class="ident" id="3898855">in</span><span class="op" id="3898857">.</span><span class="ident" id="3898858">splitBlock</span><span class="op" id="3898868">(</span><span class="ident" id="3898869">b</span><span class="op" id="3898870">,</span>&nbsp;<span class="ident" id="3898872">recordHeaderLen</span><span class="op" id="3898887">+</span><span class="ident" id="3898888">n</span><span class="op" id="3898889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898892">ok</span><span class="op" id="3898894">,</span>&nbsp;<span class="ident" id="3898896">off</span><span class="op" id="3898899">,</span>&nbsp;<span class="ident" id="3898901">err</span>&nbsp;<span class="op" id="3898905">:=</span>&nbsp;<span class="ident" id="3898908">c</span><span class="op" id="3898909">.</span><span class="ident" id="3898910">in</span><span class="op" id="3898912">.</span><span class="ident" id="3898913">decrypt</span><span class="op" id="3898920">(</span><span class="ident" id="3898921">b</span><span class="op" id="3898922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3898925">if</span>&nbsp;<span class="op" id="3898928">!</span><span class="ident" id="3898929">ok</span>&nbsp;<span class="op" id="3898932">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898936">c</span><span class="op" id="3898937">.</span><span class="ident" id="3898938">in</span><span class="op" id="3898940">.</span><span class="ident" id="3898941">setErrorLocked</span><span class="op" id="3898955">(</span><span class="ident" id="3898956">c</span><span class="op" id="3898957">.</span><span class="ident" id="3898958">sendAlert</span><span class="op" id="3898967">(</span><span class="ident" id="3898968">err</span><span class="op" id="3898971">)</span><span class="op" id="3898972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3898975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898978">b</span><span class="op" id="3898979">.</span><span class="ident" id="3898980">off</span>&nbsp;<span class="op" id="3898984">=</span>&nbsp;<span class="ident" id="3898986">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3898991">data</span>&nbsp;<span class="op" id="3898996">:=</span>&nbsp;<span class="ident" id="3898999">b</span><span class="op" id="3899000">.</span><span class="ident" id="3899001">data</span><span class="op" id="3899005">[</span><span class="ident" id="3899006">b</span><span class="op" id="3899007">.</span><span class="ident" id="3899008">off</span><span class="op" id="3899011">:</span><span class="op" id="3899012">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899015">if</span>&nbsp;<span class="builtinfunc" id="3899018">len</span><span class="op" id="3899021">(</span><span class="ident" id="3899022">data</span><span class="op" id="3899026">)</span>&nbsp;<span class="op" id="3899028">&gt;</span>&nbsp;<span class="ident" id="3899030">maxPlaintext</span>&nbsp;<span class="op" id="3899043">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899047">err</span>&nbsp;<span class="op" id="3899051">:=</span>&nbsp;<span class="ident" id="3899054">c</span><span class="op" id="3899055">.</span><span class="ident" id="3899056">sendAlert</span><span class="op" id="3899065">(</span><span class="ident" id="3899066">alertRecordOverflow</span><span class="op" id="3899085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899089">c</span><span class="op" id="3899090">.</span><span class="ident" id="3899091">in</span><span class="op" id="3899093">.</span><span class="ident" id="3899094">freeBlock</span><span class="op" id="3899103">(</span><span class="ident" id="3899104">b</span><span class="op" id="3899105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899109">return</span>&nbsp;<span class="ident" id="3899116">c</span><span class="op" id="3899117">.</span><span class="ident" id="3899118">in</span><span class="op" id="3899120">.</span><span class="ident" id="3899121">setErrorLocked</span><span class="op" id="3899135">(</span><span class="ident" id="3899136">err</span><span class="op" id="3899139">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899142">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899146">switch</span>&nbsp;<span class="ident" id="3899153">typ</span>&nbsp;<span class="op" id="3899157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899160">default</span><span class="op" id="3899167">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899171">c</span><span class="op" id="3899172">.</span><span class="ident" id="3899173">in</span><span class="op" id="3899175">.</span><span class="ident" id="3899176">setErrorLocked</span><span class="op" id="3899190">(</span><span class="ident" id="3899191">c</span><span class="op" id="3899192">.</span><span class="ident" id="3899193">sendAlert</span><span class="op" id="3899202">(</span><span class="ident" id="3899203">alertUnexpectedMessage</span><span class="op" id="3899225">)</span><span class="op" id="3899226">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899230">case</span>&nbsp;<span class="ident" id="3899235">recordTypeAlert</span><span class="op" id="3899250">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899254">if</span>&nbsp;<span class="builtinfunc" id="3899257">len</span><span class="op" id="3899260">(</span><span class="ident" id="3899261">data</span><span class="op" id="3899265">)</span>&nbsp;<span class="op" id="3899267">!=</span>&nbsp;<span class="num" id="3899270">2</span>&nbsp;<span class="op" id="3899272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899277">c</span><span class="op" id="3899278">.</span><span class="ident" id="3899279">in</span><span class="op" id="3899281">.</span><span class="ident" id="3899282">setErrorLocked</span><span class="op" id="3899296">(</span><span class="ident" id="3899297">c</span><span class="op" id="3899298">.</span><span class="ident" id="3899299">sendAlert</span><span class="op" id="3899308">(</span><span class="ident" id="3899309">alertUnexpectedMessage</span><span class="op" id="3899331">)</span><span class="op" id="3899332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899337">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899349">if</span>&nbsp;<span class="ident" id="3899352">alert</span><span class="op" id="3899357">(</span><span class="ident" id="3899358">data</span><span class="op" id="3899362">[</span><span class="num" id="3899363">1</span><span class="op" id="3899364">]</span><span class="op" id="3899365">)</span>&nbsp;<span class="op" id="3899367">==</span>&nbsp;<span class="ident" id="3899370">alertCloseNotify</span>&nbsp;<span class="op" id="3899387">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899392">c</span><span class="op" id="3899393">.</span><span class="ident" id="3899394">in</span><span class="op" id="3899396">.</span><span class="ident" id="3899397">setErrorLocked</span><span class="op" id="3899411">(</span><span class="ident" id="3899412">io</span><span class="op" id="3899414">.</span><span class="ident" id="3899415">EOF</span><span class="op" id="3899418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899423">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899435">switch</span>&nbsp;<span class="ident" id="3899442">data</span><span class="op" id="3899446">[</span><span class="num" id="3899447">0</span><span class="op" id="3899448">]</span>&nbsp;<span class="op" id="3899450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899454">case</span>&nbsp;<span class="ident" id="3899459">alertLevelWarning</span><span class="op" id="3899476">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3899481">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899505">c</span><span class="op" id="3899506">.</span><span class="ident" id="3899507">in</span><span class="op" id="3899509">.</span><span class="ident" id="3899510">freeBlock</span><span class="op" id="3899519">(</span><span class="ident" id="3899520">b</span><span class="op" id="3899521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899526">goto</span>&nbsp;<span class="ident" id="3899531">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899539">case</span>&nbsp;<span class="ident" id="3899544">alertLevelError</span><span class="op" id="3899559">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899564">c</span><span class="op" id="3899565">.</span><span class="ident" id="3899566">in</span><span class="op" id="3899568">.</span><span class="ident" id="3899569">setErrorLocked</span><span class="op" id="3899583">(</span><span class="op" id="3899584">&amp;</span><span class="ident" id="3899585">net</span><span class="op" id="3899588">.</span><span class="ident" id="3899589">OpError</span><span class="op" id="3899596">{</span><span class="ident" id="3899597">Op</span><span class="op" id="3899599">:</span>&nbsp;<span class="string" id="3899601">&#34;remote&nbsp;error&#34;</span><span class="op" id="3899615">,</span>&nbsp;<span class="ident" id="3899617">Err</span><span class="op" id="3899620">:</span>&nbsp;<span class="ident" id="3899622">alert</span><span class="op" id="3899627">(</span><span class="ident" id="3899628">data</span><span class="op" id="3899632">[</span><span class="num" id="3899633">1</span><span class="op" id="3899634">]</span><span class="op" id="3899635">)</span><span class="op" id="3899636">}</span><span class="op" id="3899637">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899641">default</span><span class="op" id="3899648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899653">c</span><span class="op" id="3899654">.</span><span class="ident" id="3899655">in</span><span class="op" id="3899657">.</span><span class="ident" id="3899658">setErrorLocked</span><span class="op" id="3899672">(</span><span class="ident" id="3899673">c</span><span class="op" id="3899674">.</span><span class="ident" id="3899675">sendAlert</span><span class="op" id="3899684">(</span><span class="ident" id="3899685">alertUnexpectedMessage</span><span class="op" id="3899707">)</span><span class="op" id="3899708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899716">case</span>&nbsp;<span class="ident" id="3899721">recordTypeChangeCipherSpec</span><span class="op" id="3899747">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899751">if</span>&nbsp;<span class="ident" id="3899754">typ</span>&nbsp;<span class="op" id="3899758">!=</span>&nbsp;<span class="ident" id="3899761">want</span>&nbsp;<span class="op" id="3899766">||</span>&nbsp;<span class="builtinfunc" id="3899769">len</span><span class="op" id="3899772">(</span><span class="ident" id="3899773">data</span><span class="op" id="3899777">)</span>&nbsp;<span class="op" id="3899779">!=</span>&nbsp;<span class="num" id="3899782">1</span>&nbsp;<span class="op" id="3899784">||</span>&nbsp;<span class="ident" id="3899787">data</span><span class="op" id="3899791">[</span><span class="num" id="3899792">0</span><span class="op" id="3899793">]</span>&nbsp;<span class="op" id="3899795">!=</span>&nbsp;<span class="num" id="3899798">1</span>&nbsp;<span class="op" id="3899800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899805">c</span><span class="op" id="3899806">.</span><span class="ident" id="3899807">in</span><span class="op" id="3899809">.</span><span class="ident" id="3899810">setErrorLocked</span><span class="op" id="3899824">(</span><span class="ident" id="3899825">c</span><span class="op" id="3899826">.</span><span class="ident" id="3899827">sendAlert</span><span class="op" id="3899836">(</span><span class="ident" id="3899837">alertUnexpectedMessage</span><span class="op" id="3899859">)</span><span class="op" id="3899860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899865">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899873">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899877">err</span>&nbsp;<span class="op" id="3899881">:=</span>&nbsp;<span class="ident" id="3899884">c</span><span class="op" id="3899885">.</span><span class="ident" id="3899886">in</span><span class="op" id="3899888">.</span><span class="ident" id="3899889">changeCipherSpec</span><span class="op" id="3899905">(</span><span class="op" id="3899906">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899910">if</span>&nbsp;<span class="ident" id="3899913">err</span>&nbsp;<span class="op" id="3899917">!=</span>&nbsp;<span class="ident" id="3899920">nil</span>&nbsp;<span class="op" id="3899924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3899929">c</span><span class="op" id="3899930">.</span><span class="ident" id="3899931">in</span><span class="op" id="3899933">.</span><span class="ident" id="3899934">setErrorLocked</span><span class="op" id="3899948">(</span><span class="ident" id="3899949">c</span><span class="op" id="3899950">.</span><span class="ident" id="3899951">sendAlert</span><span class="op" id="3899960">(</span><span class="ident" id="3899961">err</span><span class="op" id="3899964">.</span><span class="op" id="3899965">(</span><span class="ident" id="3899966">alert</span><span class="op" id="3899971">)</span><span class="op" id="3899972">)</span><span class="op" id="3899973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3899977">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3899981">case</span>&nbsp;<span class="ident" id="3899986">recordTypeApplicationData</span><span class="op" id="3900011">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900015">if</span>&nbsp;<span class="ident" id="3900018">typ</span>&nbsp;<span class="op" id="3900022">!=</span>&nbsp;<span class="ident" id="3900025">want</span>&nbsp;<span class="op" id="3900030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900035">c</span><span class="op" id="3900036">.</span><span class="ident" id="3900037">in</span><span class="op" id="3900039">.</span><span class="ident" id="3900040">setErrorLocked</span><span class="op" id="3900054">(</span><span class="ident" id="3900055">c</span><span class="op" id="3900056">.</span><span class="ident" id="3900057">sendAlert</span><span class="op" id="3900066">(</span><span class="ident" id="3900067">alertUnexpectedMessage</span><span class="op" id="3900089">)</span><span class="op" id="3900090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900095">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900107">c</span><span class="op" id="3900108">.</span><span class="ident" id="3900109">input</span>&nbsp;<span class="op" id="3900115">=</span>&nbsp;<span class="ident" id="3900117">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900121">b</span>&nbsp;<span class="op" id="3900123">=</span>&nbsp;<span class="ident" id="3900125">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900131">case</span>&nbsp;<span class="ident" id="3900136">recordTypeHandshake</span><span class="op" id="3900155">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3900159">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900218">if</span>&nbsp;<span class="ident" id="3900221">typ</span>&nbsp;<span class="op" id="3900225">!=</span>&nbsp;<span class="ident" id="3900228">want</span>&nbsp;<span class="op" id="3900233">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900238">return</span>&nbsp;<span class="ident" id="3900245">c</span><span class="op" id="3900246">.</span><span class="ident" id="3900247">in</span><span class="op" id="3900249">.</span><span class="ident" id="3900250">setErrorLocked</span><span class="op" id="3900264">(</span><span class="ident" id="3900265">c</span><span class="op" id="3900266">.</span><span class="ident" id="3900267">sendAlert</span><span class="op" id="3900276">(</span><span class="ident" id="3900277">alertNoRenegotiation</span><span class="op" id="3900297">)</span><span class="op" id="3900298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900306">c</span><span class="op" id="3900307">.</span><span class="ident" id="3900308">hand</span><span class="op" id="3900312">.</span><span class="ident" id="3900313">Write</span><span class="op" id="3900318">(</span><span class="ident" id="3900319">data</span><span class="op" id="3900323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900330">if</span>&nbsp;<span class="ident" id="3900333">b</span>&nbsp;<span class="op" id="3900335">!=</span>&nbsp;<span class="ident" id="3900338">nil</span>&nbsp;<span class="op" id="3900342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900346">c</span><span class="op" id="3900347">.</span><span class="ident" id="3900348">in</span><span class="op" id="3900350">.</span><span class="ident" id="3900351">freeBlock</span><span class="op" id="3900360">(</span><span class="ident" id="3900361">b</span><span class="op" id="3900362">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900368">return</span>&nbsp;<span class="ident" id="3900375">c</span><span class="op" id="3900376">.</span><span class="ident" id="3900377">in</span><span class="op" id="3900379">.</span><span class="ident" id="3900380">err</span><br>
<span class="lineno"></span><span class="op" id="3900384">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="3900387">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="3900427">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3900448">func</span>&nbsp;<span class="op" id="3900453">(</span><span class="ident" id="3900454">c</span>&nbsp;<span class="op" id="3900456">*</span><span class="ident" id="3900457">Conn</span><span class="op" id="3900461">)</span>&nbsp;<span class="ident" id="3900463">sendAlertLocked</span><span class="op" id="3900478">(</span><span class="ident" id="3900479">err</span>&nbsp;<span class="ident" id="3900483">alert</span><span class="op" id="3900488">)</span>&nbsp;<span class="builtintype" id="3900490">error</span>&nbsp;<span class="op" id="3900496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900499">switch</span>&nbsp;<span class="ident" id="3900506">err</span>&nbsp;<span class="op" id="3900510">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900513">case</span>&nbsp;<span class="ident" id="3900518">alertNoRenegotiation</span><span class="op" id="3900538">,</span>&nbsp;<span class="ident" id="3900540">alertCloseNotify</span><span class="op" id="3900556">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900560">c</span><span class="op" id="3900561">.</span><span class="ident" id="3900562">tmp</span><span class="op" id="3900565">[</span><span class="num" id="3900566">0</span><span class="op" id="3900567">]</span>&nbsp;<span class="op" id="3900569">=</span>&nbsp;<span class="ident" id="3900571">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900590">default</span><span class="op" id="3900597">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900601">c</span><span class="op" id="3900602">.</span><span class="ident" id="3900603">tmp</span><span class="op" id="3900606">[</span><span class="num" id="3900607">0</span><span class="op" id="3900608">]</span>&nbsp;<span class="op" id="3900610">=</span>&nbsp;<span class="ident" id="3900612">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900629">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900632">c</span><span class="op" id="3900633">.</span><span class="ident" id="3900634">tmp</span><span class="op" id="3900637">[</span><span class="num" id="3900638">1</span><span class="op" id="3900639">]</span>&nbsp;<span class="op" id="3900641">=</span>&nbsp;<span class="builtintype" id="3900643">byte</span><span class="op" id="3900647">(</span><span class="ident" id="3900648">err</span><span class="op" id="3900651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900654">c</span><span class="op" id="3900655">.</span><span class="ident" id="3900656">writeRecord</span><span class="op" id="3900667">(</span><span class="ident" id="3900668">recordTypeAlert</span><span class="op" id="3900683">,</span>&nbsp;<span class="ident" id="3900685">c</span><span class="op" id="3900686">.</span><span class="ident" id="3900687">tmp</span><span class="op" id="3900690">[</span><span class="num" id="3900691">0</span><span class="op" id="3900692">:</span><span class="num" id="3900693">2</span><span class="op" id="3900694">]</span><span class="op" id="3900695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3900698">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900759">if</span>&nbsp;<span class="ident" id="3900762">err</span>&nbsp;<span class="op" id="3900766">!=</span>&nbsp;<span class="ident" id="3900769">alertCloseNotify</span>&nbsp;<span class="op" id="3900786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900790">return</span>&nbsp;<span class="ident" id="3900797">c</span><span class="op" id="3900798">.</span><span class="ident" id="3900799">out</span><span class="op" id="3900802">.</span><span class="ident" id="3900803">setErrorLocked</span><span class="op" id="3900817">(</span><span class="op" id="3900818">&amp;</span><span class="ident" id="3900819">net</span><span class="op" id="3900822">.</span><span class="ident" id="3900823">OpError</span><span class="op" id="3900830">{</span><span class="ident" id="3900831">Op</span><span class="op" id="3900833">:</span>&nbsp;<span class="string" id="3900835">&#34;local&nbsp;error&#34;</span><span class="op" id="3900848">,</span>&nbsp;<span class="ident" id="3900850">Err</span><span class="op" id="3900853">:</span>&nbsp;<span class="ident" id="3900855">err</span><span class="op" id="3900858">}</span><span class="op" id="3900859">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3900862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900865">return</span>&nbsp;<span class="ident" id="3900872">nil</span><br>
<span class="lineno"></span><span class="op" id="3900876">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3900879">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="3900919">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="3900939">func</span>&nbsp;<span class="op" id="3900944">(</span><span class="ident" id="3900945">c</span>&nbsp;<span class="op" id="3900947">*</span><span class="ident" id="3900948">Conn</span><span class="op" id="3900952">)</span>&nbsp;<span class="ident" id="3900954">sendAlert</span><span class="op" id="3900963">(</span><span class="ident" id="3900964">err</span>&nbsp;<span class="ident" id="3900968">alert</span><span class="op" id="3900973">)</span>&nbsp;<span class="builtintype" id="3900975">error</span>&nbsp;<span class="op" id="3900981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3900984">c</span><span class="op" id="3900985">.</span><span class="ident" id="3900986">out</span><span class="op" id="3900989">.</span><span class="ident" id="3900990">Lock</span><span class="op" id="3900994">(</span><span class="op" id="3900995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3900998">defer</span>&nbsp;<span class="ident" id="3901004">c</span><span class="op" id="3901005">.</span><span class="ident" id="3901006">out</span><span class="op" id="3901009">.</span><span class="ident" id="3901010">Unlock</span><span class="op" id="3901016">(</span><span class="op" id="3901017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901020">return</span>&nbsp;<span class="ident" id="3901027">c</span><span class="op" id="3901028">.</span><span class="ident" id="3901029">sendAlertLocked</span><span class="op" id="3901044">(</span><span class="ident" id="3901045">err</span><span class="op" id="3901048">)</span><br>
<span class="lineno">690</span><span class="op" id="3901050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3901053">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="3901120">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3901177">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="3901198">func</span>&nbsp;<span class="op" id="3901203">(</span><span class="ident" id="3901204">c</span>&nbsp;<span class="op" id="3901206">*</span><span class="ident" id="3901207">Conn</span><span class="op" id="3901211">)</span>&nbsp;<span class="ident" id="3901213">writeRecord</span><span class="op" id="3901224">(</span><span class="ident" id="3901225">typ</span>&nbsp;<span class="ident" id="3901229">recordType</span><span class="op" id="3901239">,</span>&nbsp;<span class="ident" id="3901241">data</span>&nbsp;<span class="op" id="3901246">[</span><span class="op" id="3901247">]</span><span class="builtintype" id="3901248">byte</span><span class="op" id="3901252">)</span>&nbsp;<span class="op" id="3901254">(</span><span class="ident" id="3901255">n</span>&nbsp;<span class="builtintype" id="3901257">int</span><span class="op" id="3901260">,</span>&nbsp;<span class="ident" id="3901262">err</span>&nbsp;<span class="builtintype" id="3901266">error</span><span class="op" id="3901271">)</span>&nbsp;<span class="op" id="3901273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901276">b</span>&nbsp;<span class="op" id="3901278">:=</span>&nbsp;<span class="ident" id="3901281">c</span><span class="op" id="3901282">.</span><span class="ident" id="3901283">out</span><span class="op" id="3901286">.</span><span class="ident" id="3901287">newBlock</span><span class="op" id="3901295">(</span><span class="op" id="3901296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901299">for</span>&nbsp;<span class="builtinfunc" id="3901303">len</span><span class="op" id="3901306">(</span><span class="ident" id="3901307">data</span><span class="op" id="3901311">)</span>&nbsp;<span class="op" id="3901313">&gt;</span>&nbsp;<span class="num" id="3901315">0</span>&nbsp;<span class="op" id="3901317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901321">m</span>&nbsp;<span class="op" id="3901323">:=</span>&nbsp;<span class="builtinfunc" id="3901326">len</span><span class="op" id="3901329">(</span><span class="ident" id="3901330">data</span><span class="op" id="3901334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901338">if</span>&nbsp;<span class="ident" id="3901341">m</span>&nbsp;<span class="op" id="3901343">&gt;</span>&nbsp;<span class="ident" id="3901345">maxPlaintext</span>&nbsp;<span class="op" id="3901358">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901363">m</span>&nbsp;<span class="op" id="3901365">=</span>&nbsp;<span class="ident" id="3901367">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901386">explicitIVLen</span>&nbsp;<span class="op" id="3901400">:=</span>&nbsp;<span class="num" id="3901403">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901407">explicitIVIsSeq</span>&nbsp;<span class="op" id="3901423">:=</span>&nbsp;<span class="builtintype" id="3901426">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901435">var</span>&nbsp;<span class="ident" id="3901439">cbc</span>&nbsp;<span class="ident" id="3901443">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901453">if</span>&nbsp;<span class="ident" id="3901456">c</span><span class="op" id="3901457">.</span><span class="ident" id="3901458">out</span><span class="op" id="3901461">.</span><span class="ident" id="3901462">version</span>&nbsp;<span class="op" id="3901470">&gt;=</span>&nbsp;<span class="ident" id="3901473">VersionTLS11</span>&nbsp;<span class="op" id="3901486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901491">var</span>&nbsp;<span class="ident" id="3901495">ok</span>&nbsp;<span class="builtintype" id="3901498">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901506">if</span>&nbsp;<span class="ident" id="3901509">cbc</span><span class="op" id="3901512">,</span>&nbsp;<span class="ident" id="3901514">ok</span>&nbsp;<span class="op" id="3901517">=</span>&nbsp;<span class="ident" id="3901519">c</span><span class="op" id="3901520">.</span><span class="ident" id="3901521">out</span><span class="op" id="3901524">.</span><span class="ident" id="3901525">cipher</span><span class="op" id="3901531">.</span><span class="op" id="3901532">(</span><span class="ident" id="3901533">cbcMode</span><span class="op" id="3901540">)</span><span class="op" id="3901541">;</span>&nbsp;<span class="ident" id="3901543">ok</span>&nbsp;<span class="op" id="3901546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901552">explicitIVLen</span>&nbsp;<span class="op" id="3901566">=</span>&nbsp;<span class="ident" id="3901568">cbc</span><span class="op" id="3901571">.</span><span class="ident" id="3901572">BlockSize</span><span class="op" id="3901581">(</span><span class="op" id="3901582">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901595">if</span>&nbsp;<span class="ident" id="3901598">explicitIVLen</span>&nbsp;<span class="op" id="3901612">==</span>&nbsp;<span class="num" id="3901615">0</span>&nbsp;<span class="op" id="3901617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3901622">if</span>&nbsp;<span class="ident" id="3901625">_</span><span class="op" id="3901626">,</span>&nbsp;<span class="ident" id="3901628">ok</span>&nbsp;<span class="op" id="3901631">:=</span>&nbsp;<span class="ident" id="3901634">c</span><span class="op" id="3901635">.</span><span class="ident" id="3901636">out</span><span class="op" id="3901639">.</span><span class="ident" id="3901640">cipher</span><span class="op" id="3901646">.</span><span class="op" id="3901647">(</span><span class="ident" id="3901648">cipher</span><span class="op" id="3901654">.</span><span class="ident" id="3901655">AEAD</span><span class="op" id="3901659">)</span><span class="op" id="3901660">;</span>&nbsp;<span class="ident" id="3901662">ok</span>&nbsp;<span class="op" id="3901665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901671">explicitIVLen</span>&nbsp;<span class="op" id="3901685">=</span>&nbsp;<span class="num" id="3901687">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901693">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901739">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901786">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901836">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901883">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3901934">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901955">explicitIVIsSeq</span>&nbsp;<span class="op" id="3901971">=</span>&nbsp;<span class="builtintype" id="3901973">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3901985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3901989">b</span><span class="op" id="3901990">.</span><span class="ident" id="3901991">resize</span><span class="op" id="3901997">(</span><span class="ident" id="3901998">recordHeaderLen</span>&nbsp;<span class="op" id="3902014">+</span>&nbsp;<span class="ident" id="3902016">explicitIVLen</span>&nbsp;<span class="op" id="3902030">+</span>&nbsp;<span class="ident" id="3902032">m</span><span class="op" id="3902033">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902037">b</span><span class="op" id="3902038">.</span><span class="ident" id="3902039">data</span><span class="op" id="3902043">[</span><span class="num" id="3902044">0</span><span class="op" id="3902045">]</span>&nbsp;<span class="op" id="3902047">=</span>&nbsp;<span class="builtintype" id="3902049">byte</span><span class="op" id="3902053">(</span><span class="ident" id="3902054">typ</span><span class="op" id="3902057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902061">vers</span>&nbsp;<span class="op" id="3902066">:=</span>&nbsp;<span class="ident" id="3902069">c</span><span class="op" id="3902070">.</span><span class="ident" id="3902071">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902078">if</span>&nbsp;<span class="ident" id="3902081">vers</span>&nbsp;<span class="op" id="3902086">==</span>&nbsp;<span class="num" id="3902089">0</span>&nbsp;<span class="op" id="3902091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902096">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902149">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902205">vers</span>&nbsp;<span class="op" id="3902210">=</span>&nbsp;<span class="ident" id="3902212">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902227">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902231">b</span><span class="op" id="3902232">.</span><span class="ident" id="3902233">data</span><span class="op" id="3902237">[</span><span class="num" id="3902238">1</span><span class="op" id="3902239">]</span>&nbsp;<span class="op" id="3902241">=</span>&nbsp;<span class="builtintype" id="3902243">byte</span><span class="op" id="3902247">(</span><span class="ident" id="3902248">vers</span>&nbsp;<span class="op" id="3902253">&gt;&gt;</span>&nbsp;<span class="num" id="3902256">8</span><span class="op" id="3902257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902261">b</span><span class="op" id="3902262">.</span><span class="ident" id="3902263">data</span><span class="op" id="3902267">[</span><span class="num" id="3902268">2</span><span class="op" id="3902269">]</span>&nbsp;<span class="op" id="3902271">=</span>&nbsp;<span class="builtintype" id="3902273">byte</span><span class="op" id="3902277">(</span><span class="ident" id="3902278">vers</span><span class="op" id="3902282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902286">b</span><span class="op" id="3902287">.</span><span class="ident" id="3902288">data</span><span class="op" id="3902292">[</span><span class="num" id="3902293">3</span><span class="op" id="3902294">]</span>&nbsp;<span class="op" id="3902296">=</span>&nbsp;<span class="builtintype" id="3902298">byte</span><span class="op" id="3902302">(</span><span class="ident" id="3902303">m</span>&nbsp;<span class="op" id="3902305">&gt;&gt;</span>&nbsp;<span class="num" id="3902308">8</span><span class="op" id="3902309">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902313">b</span><span class="op" id="3902314">.</span><span class="ident" id="3902315">data</span><span class="op" id="3902319">[</span><span class="num" id="3902320">4</span><span class="op" id="3902321">]</span>&nbsp;<span class="op" id="3902323">=</span>&nbsp;<span class="builtintype" id="3902325">byte</span><span class="op" id="3902329">(</span><span class="ident" id="3902330">m</span><span class="op" id="3902331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902335">if</span>&nbsp;<span class="ident" id="3902338">explicitIVLen</span>&nbsp;<span class="op" id="3902352">&gt;</span>&nbsp;<span class="num" id="3902354">0</span>&nbsp;<span class="op" id="3902356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902361">explicitIV</span>&nbsp;<span class="op" id="3902372">:=</span>&nbsp;<span class="ident" id="3902375">b</span><span class="op" id="3902376">.</span><span class="ident" id="3902377">data</span><span class="op" id="3902381">[</span><span class="ident" id="3902382">recordHeaderLen</span>&nbsp;<span class="op" id="3902398">:</span>&nbsp;<span class="ident" id="3902400">recordHeaderLen</span><span class="op" id="3902415">+</span><span class="ident" id="3902416">explicitIVLen</span><span class="op" id="3902429">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902434">if</span>&nbsp;<span class="ident" id="3902437">explicitIVIsSeq</span>&nbsp;<span class="op" id="3902453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3902459">copy</span><span class="op" id="3902463">(</span><span class="ident" id="3902464">explicitIV</span><span class="op" id="3902474">,</span>&nbsp;<span class="ident" id="3902476">c</span><span class="op" id="3902477">.</span><span class="ident" id="3902478">out</span><span class="op" id="3902481">.</span><span class="ident" id="3902482">seq</span><span class="op" id="3902485">[</span><span class="op" id="3902486">:</span><span class="op" id="3902487">]</span><span class="op" id="3902488">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902493">}</span>&nbsp;<span class="keyword" id="3902495">else</span>&nbsp;<span class="op" id="3902500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902506">if</span>&nbsp;<span class="ident" id="3902509">_</span><span class="op" id="3902510">,</span>&nbsp;<span class="ident" id="3902512">err</span>&nbsp;<span class="op" id="3902516">=</span>&nbsp;<span class="ident" id="3902518">io</span><span class="op" id="3902520">.</span><span class="ident" id="3902521">ReadFull</span><span class="op" id="3902529">(</span><span class="ident" id="3902530">c</span><span class="op" id="3902531">.</span><span class="ident" id="3902532">config</span><span class="op" id="3902538">.</span><span class="ident" id="3902539">rand</span><span class="op" id="3902543">(</span><span class="op" id="3902544">)</span><span class="op" id="3902545">,</span>&nbsp;<span class="ident" id="3902547">explicitIV</span><span class="op" id="3902557">)</span><span class="op" id="3902558">;</span>&nbsp;<span class="ident" id="3902560">err</span>&nbsp;<span class="op" id="3902564">!=</span>&nbsp;<span class="ident" id="3902567">nil</span>&nbsp;<span class="op" id="3902571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902578">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902593">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3902601">copy</span><span class="op" id="3902605">(</span><span class="ident" id="3902606">b</span><span class="op" id="3902607">.</span><span class="ident" id="3902608">data</span><span class="op" id="3902612">[</span><span class="ident" id="3902613">recordHeaderLen</span><span class="op" id="3902628">+</span><span class="ident" id="3902629">explicitIVLen</span><span class="op" id="3902642">:</span><span class="op" id="3902643">]</span><span class="op" id="3902644">,</span>&nbsp;<span class="ident" id="3902646">data</span><span class="op" id="3902650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902654">c</span><span class="op" id="3902655">.</span><span class="ident" id="3902656">out</span><span class="op" id="3902659">.</span><span class="ident" id="3902660">encrypt</span><span class="op" id="3902667">(</span><span class="ident" id="3902668">b</span><span class="op" id="3902669">,</span>&nbsp;<span class="ident" id="3902671">explicitIVLen</span><span class="op" id="3902684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902688">_</span><span class="op" id="3902689">,</span>&nbsp;<span class="ident" id="3902691">err</span>&nbsp;<span class="op" id="3902695">=</span>&nbsp;<span class="ident" id="3902697">c</span><span class="op" id="3902698">.</span><span class="ident" id="3902699">conn</span><span class="op" id="3902703">.</span><span class="ident" id="3902704">Write</span><span class="op" id="3902709">(</span><span class="ident" id="3902710">b</span><span class="op" id="3902711">.</span><span class="ident" id="3902712">data</span><span class="op" id="3902716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902720">if</span>&nbsp;<span class="ident" id="3902723">err</span>&nbsp;<span class="op" id="3902727">!=</span>&nbsp;<span class="ident" id="3902730">nil</span>&nbsp;<span class="op" id="3902734">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902739">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902751">n</span>&nbsp;<span class="op" id="3902753">+=</span>&nbsp;<span class="ident" id="3902756">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902760">data</span>&nbsp;<span class="op" id="3902765">=</span>&nbsp;<span class="ident" id="3902767">data</span><span class="op" id="3902771">[</span><span class="ident" id="3902772">m</span><span class="op" id="3902773">:</span><span class="op" id="3902774">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3902777">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902780">c</span><span class="op" id="3902781">.</span><span class="ident" id="3902782">out</span><span class="op" id="3902785">.</span><span class="ident" id="3902786">freeBlock</span><span class="op" id="3902795">(</span><span class="ident" id="3902796">b</span><span class="op" id="3902797">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902801">if</span>&nbsp;<span class="ident" id="3902804">typ</span>&nbsp;<span class="op" id="3902808">==</span>&nbsp;<span class="ident" id="3902811">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="3902838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902842">err</span>&nbsp;<span class="op" id="3902846">=</span>&nbsp;<span class="ident" id="3902848">c</span><span class="op" id="3902849">.</span><span class="ident" id="3902850">out</span><span class="op" id="3902853">.</span><span class="ident" id="3902854">changeCipherSpec</span><span class="op" id="3902870">(</span><span class="op" id="3902871">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3902875">if</span>&nbsp;<span class="ident" id="3902878">err</span>&nbsp;<span class="op" id="3902882">!=</span>&nbsp;<span class="ident" id="3902885">nil</span>&nbsp;<span class="op" id="3902889">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902894">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3902932">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3902975">c</span><span class="op" id="3902976">.</span><span class="ident" id="3902977">tmp</span><span class="op" id="3902980">[</span><span class="num" id="3902981">0</span><span class="op" id="3902982">]</span>&nbsp;<span class="op" id="3902984">=</span>&nbsp;<span class="ident" id="3902986">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903005">c</span><span class="op" id="3903006">.</span><span class="ident" id="3903007">tmp</span><span class="op" id="3903010">[</span><span class="num" id="3903011">1</span><span class="op" id="3903012">]</span>&nbsp;<span class="op" id="3903014">=</span>&nbsp;<span class="builtintype" id="3903016">byte</span><span class="op" id="3903020">(</span><span class="ident" id="3903021">err</span><span class="op" id="3903024">.</span><span class="op" id="3903025">(</span><span class="ident" id="3903026">alert</span><span class="op" id="3903031">)</span><span class="op" id="3903032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903037">c</span><span class="op" id="3903038">.</span><span class="ident" id="3903039">writeRecord</span><span class="op" id="3903050">(</span><span class="ident" id="3903051">recordTypeAlert</span><span class="op" id="3903066">,</span>&nbsp;<span class="ident" id="3903068">c</span><span class="op" id="3903069">.</span><span class="ident" id="3903070">tmp</span><span class="op" id="3903073">[</span><span class="num" id="3903074">0</span><span class="op" id="3903075">:</span><span class="num" id="3903076">2</span><span class="op" id="3903077">]</span><span class="op" id="3903078">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903083">return</span>&nbsp;<span class="ident" id="3903090">n</span><span class="op" id="3903091">,</span>&nbsp;<span class="ident" id="3903093">c</span><span class="op" id="3903094">.</span><span class="ident" id="3903095">out</span><span class="op" id="3903098">.</span><span class="ident" id="3903099">setErrorLocked</span><span class="op" id="3903113">(</span><span class="op" id="3903114">&amp;</span><span class="ident" id="3903115">net</span><span class="op" id="3903118">.</span><span class="ident" id="3903119">OpError</span><span class="op" id="3903126">{</span><span class="ident" id="3903127">Op</span><span class="op" id="3903129">:</span>&nbsp;<span class="string" id="3903131">&#34;local&nbsp;error&#34;</span><span class="op" id="3903144">,</span>&nbsp;<span class="ident" id="3903146">Err</span><span class="op" id="3903149">:</span>&nbsp;<span class="ident" id="3903151">err</span><span class="op" id="3903154">}</span><span class="op" id="3903155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903165">return</span><br>
<span class="lineno"></span><span class="op" id="3903172">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="3903175">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3903230">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="3903251">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="3903287">func</span>&nbsp;<span class="op" id="3903292">(</span><span class="ident" id="3903293">c</span>&nbsp;<span class="op" id="3903295">*</span><span class="ident" id="3903296">Conn</span><span class="op" id="3903300">)</span>&nbsp;<span class="ident" id="3903302">readHandshake</span><span class="op" id="3903315">(</span><span class="op" id="3903316">)</span>&nbsp;<span class="op" id="3903318">(</span><span class="keyword" id="3903319">interface</span><span class="op" id="3903328">{</span><span class="op" id="3903329">}</span><span class="op" id="3903330">,</span>&nbsp;<span class="builtintype" id="3903332">error</span><span class="op" id="3903337">)</span>&nbsp;<span class="op" id="3903339">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903342">for</span>&nbsp;<span class="ident" id="3903346">c</span><span class="op" id="3903347">.</span><span class="ident" id="3903348">hand</span><span class="op" id="3903352">.</span><span class="ident" id="3903353">Len</span><span class="op" id="3903356">(</span><span class="op" id="3903357">)</span>&nbsp;<span class="op" id="3903359">&lt;</span>&nbsp;<span class="num" id="3903361">4</span>&nbsp;<span class="op" id="3903363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903367">if</span>&nbsp;<span class="ident" id="3903370">err</span>&nbsp;<span class="op" id="3903374">:=</span>&nbsp;<span class="ident" id="3903377">c</span><span class="op" id="3903378">.</span><span class="ident" id="3903379">in</span><span class="op" id="3903381">.</span><span class="ident" id="3903382">err</span><span class="op" id="3903385">;</span>&nbsp;<span class="ident" id="3903387">err</span>&nbsp;<span class="op" id="3903391">!=</span>&nbsp;<span class="ident" id="3903394">nil</span>&nbsp;<span class="op" id="3903398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903403">return</span>&nbsp;<span class="ident" id="3903410">nil</span><span class="op" id="3903413">,</span>&nbsp;<span class="ident" id="3903415">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903425">if</span>&nbsp;<span class="ident" id="3903428">err</span>&nbsp;<span class="op" id="3903432">:=</span>&nbsp;<span class="ident" id="3903435">c</span><span class="op" id="3903436">.</span><span class="ident" id="3903437">readRecord</span><span class="op" id="3903447">(</span><span class="ident" id="3903448">recordTypeHandshake</span><span class="op" id="3903467">)</span><span class="op" id="3903468">;</span>&nbsp;<span class="ident" id="3903470">err</span>&nbsp;<span class="op" id="3903474">!=</span>&nbsp;<span class="ident" id="3903477">nil</span>&nbsp;<span class="op" id="3903481">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903486">return</span>&nbsp;<span class="ident" id="3903493">nil</span><span class="op" id="3903496">,</span>&nbsp;<span class="ident" id="3903498">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903511">data</span>&nbsp;<span class="op" id="3903516">:=</span>&nbsp;<span class="ident" id="3903519">c</span><span class="op" id="3903520">.</span><span class="ident" id="3903521">hand</span><span class="op" id="3903525">.</span><span class="ident" id="3903526">Bytes</span><span class="op" id="3903531">(</span><span class="op" id="3903532">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903535">n</span>&nbsp;<span class="op" id="3903537">:=</span>&nbsp;<span class="builtintype" id="3903540">int</span><span class="op" id="3903543">(</span><span class="ident" id="3903544">data</span><span class="op" id="3903548">[</span><span class="num" id="3903549">1</span><span class="op" id="3903550">]</span><span class="op" id="3903551">)</span><span class="op" id="3903552">&lt;&lt;</span><span class="num" id="3903554">16</span>&nbsp;<span class="op" id="3903557">|</span>&nbsp;<span class="builtintype" id="3903559">int</span><span class="op" id="3903562">(</span><span class="ident" id="3903563">data</span><span class="op" id="3903567">[</span><span class="num" id="3903568">2</span><span class="op" id="3903569">]</span><span class="op" id="3903570">)</span><span class="op" id="3903571">&lt;&lt;</span><span class="num" id="3903573">8</span>&nbsp;<span class="op" id="3903575">|</span>&nbsp;<span class="builtintype" id="3903577">int</span><span class="op" id="3903580">(</span><span class="ident" id="3903581">data</span><span class="op" id="3903585">[</span><span class="num" id="3903586">3</span><span class="op" id="3903587">]</span><span class="op" id="3903588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903591">if</span>&nbsp;<span class="ident" id="3903594">n</span>&nbsp;<span class="op" id="3903596">&gt;</span>&nbsp;<span class="ident" id="3903598">maxHandshake</span>&nbsp;<span class="op" id="3903611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903615">return</span>&nbsp;<span class="ident" id="3903622">nil</span><span class="op" id="3903625">,</span>&nbsp;<span class="ident" id="3903627">c</span><span class="op" id="3903628">.</span><span class="ident" id="3903629">in</span><span class="op" id="3903631">.</span><span class="ident" id="3903632">setErrorLocked</span><span class="op" id="3903646">(</span><span class="ident" id="3903647">c</span><span class="op" id="3903648">.</span><span class="ident" id="3903649">sendAlert</span><span class="op" id="3903658">(</span><span class="ident" id="3903659">alertInternalError</span><span class="op" id="3903677">)</span><span class="op" id="3903678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903681">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903684">for</span>&nbsp;<span class="ident" id="3903688">c</span><span class="op" id="3903689">.</span><span class="ident" id="3903690">hand</span><span class="op" id="3903694">.</span><span class="ident" id="3903695">Len</span><span class="op" id="3903698">(</span><span class="op" id="3903699">)</span>&nbsp;<span class="op" id="3903701">&lt;</span>&nbsp;<span class="num" id="3903703">4</span><span class="op" id="3903704">+</span><span class="ident" id="3903705">n</span>&nbsp;<span class="op" id="3903707">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903711">if</span>&nbsp;<span class="ident" id="3903714">err</span>&nbsp;<span class="op" id="3903718">:=</span>&nbsp;<span class="ident" id="3903721">c</span><span class="op" id="3903722">.</span><span class="ident" id="3903723">in</span><span class="op" id="3903725">.</span><span class="ident" id="3903726">err</span><span class="op" id="3903729">;</span>&nbsp;<span class="ident" id="3903731">err</span>&nbsp;<span class="op" id="3903735">!=</span>&nbsp;<span class="ident" id="3903738">nil</span>&nbsp;<span class="op" id="3903742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903747">return</span>&nbsp;<span class="ident" id="3903754">nil</span><span class="op" id="3903757">,</span>&nbsp;<span class="ident" id="3903759">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903769">if</span>&nbsp;<span class="ident" id="3903772">err</span>&nbsp;<span class="op" id="3903776">:=</span>&nbsp;<span class="ident" id="3903779">c</span><span class="op" id="3903780">.</span><span class="ident" id="3903781">readRecord</span><span class="op" id="3903791">(</span><span class="ident" id="3903792">recordTypeHandshake</span><span class="op" id="3903811">)</span><span class="op" id="3903812">;</span>&nbsp;<span class="ident" id="3903814">err</span>&nbsp;<span class="op" id="3903818">!=</span>&nbsp;<span class="ident" id="3903821">nil</span>&nbsp;<span class="op" id="3903825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903830">return</span>&nbsp;<span class="ident" id="3903837">nil</span><span class="op" id="3903840">,</span>&nbsp;<span class="ident" id="3903842">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3903851">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903854">data</span>&nbsp;<span class="op" id="3903859">=</span>&nbsp;<span class="ident" id="3903861">c</span><span class="op" id="3903862">.</span><span class="ident" id="3903863">hand</span><span class="op" id="3903867">.</span><span class="ident" id="3903868">Next</span><span class="op" id="3903872">(</span><span class="num" id="3903873">4</span>&nbsp;<span class="op" id="3903875">+</span>&nbsp;<span class="ident" id="3903877">n</span><span class="op" id="3903878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903881">var</span>&nbsp;<span class="ident" id="3903885">m</span>&nbsp;<span class="ident" id="3903887">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903905">switch</span>&nbsp;<span class="ident" id="3903912">data</span><span class="op" id="3903916">[</span><span class="num" id="3903917">0</span><span class="op" id="3903918">]</span>&nbsp;<span class="op" id="3903920">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903923">case</span>&nbsp;<span class="ident" id="3903928">typeClientHello</span><span class="op" id="3903943">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903947">m</span>&nbsp;<span class="op" id="3903949">=</span>&nbsp;<span class="builtinfunc" id="3903951">new</span><span class="op" id="3903954">(</span><span class="ident" id="3903955">clientHelloMsg</span><span class="op" id="3903969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3903972">case</span>&nbsp;<span class="ident" id="3903977">typeServerHello</span><span class="op" id="3903992">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3903996">m</span>&nbsp;<span class="op" id="3903998">=</span>&nbsp;<span class="builtinfunc" id="3904000">new</span><span class="op" id="3904003">(</span><span class="ident" id="3904004">serverHelloMsg</span><span class="op" id="3904018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904021">case</span>&nbsp;<span class="ident" id="3904026">typeNewSessionTicket</span><span class="op" id="3904046">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904050">m</span>&nbsp;<span class="op" id="3904052">=</span>&nbsp;<span class="builtinfunc" id="3904054">new</span><span class="op" id="3904057">(</span><span class="ident" id="3904058">newSessionTicketMsg</span><span class="op" id="3904077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904080">case</span>&nbsp;<span class="ident" id="3904085">typeCertificate</span><span class="op" id="3904100">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904104">m</span>&nbsp;<span class="op" id="3904106">=</span>&nbsp;<span class="builtinfunc" id="3904108">new</span><span class="op" id="3904111">(</span><span class="ident" id="3904112">certificateMsg</span><span class="op" id="3904126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904129">case</span>&nbsp;<span class="ident" id="3904134">typeCertificateRequest</span><span class="op" id="3904156">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904160">m</span>&nbsp;<span class="op" id="3904162">=</span>&nbsp;<span class="op" id="3904164">&amp;</span><span class="ident" id="3904165">certificateRequestMsg</span><span class="op" id="3904186">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904191">hasSignatureAndHash</span><span class="op" id="3904210">:</span>&nbsp;<span class="ident" id="3904212">c</span><span class="op" id="3904213">.</span><span class="ident" id="3904214">vers</span>&nbsp;<span class="op" id="3904219">&gt;=</span>&nbsp;<span class="ident" id="3904222">VersionTLS12</span><span class="op" id="3904234">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3904238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904241">case</span>&nbsp;<span class="ident" id="3904246">typeCertificateStatus</span><span class="op" id="3904267">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904271">m</span>&nbsp;<span class="op" id="3904273">=</span>&nbsp;<span class="builtinfunc" id="3904275">new</span><span class="op" id="3904278">(</span><span class="ident" id="3904279">certificateStatusMsg</span><span class="op" id="3904299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904302">case</span>&nbsp;<span class="ident" id="3904307">typeServerKeyExchange</span><span class="op" id="3904328">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904332">m</span>&nbsp;<span class="op" id="3904334">=</span>&nbsp;<span class="builtinfunc" id="3904336">new</span><span class="op" id="3904339">(</span><span class="ident" id="3904340">serverKeyExchangeMsg</span><span class="op" id="3904360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904363">case</span>&nbsp;<span class="ident" id="3904368">typeServerHelloDone</span><span class="op" id="3904387">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904391">m</span>&nbsp;<span class="op" id="3904393">=</span>&nbsp;<span class="builtinfunc" id="3904395">new</span><span class="op" id="3904398">(</span><span class="ident" id="3904399">serverHelloDoneMsg</span><span class="op" id="3904417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904420">case</span>&nbsp;<span class="ident" id="3904425">typeClientKeyExchange</span><span class="op" id="3904446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904450">m</span>&nbsp;<span class="op" id="3904452">=</span>&nbsp;<span class="builtinfunc" id="3904454">new</span><span class="op" id="3904457">(</span><span class="ident" id="3904458">clientKeyExchangeMsg</span><span class="op" id="3904478">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904481">case</span>&nbsp;<span class="ident" id="3904486">typeCertificateVerify</span><span class="op" id="3904507">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904511">m</span>&nbsp;<span class="op" id="3904513">=</span>&nbsp;<span class="op" id="3904515">&amp;</span><span class="ident" id="3904516">certificateVerifyMsg</span><span class="op" id="3904536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904541">hasSignatureAndHash</span><span class="op" id="3904560">:</span>&nbsp;<span class="ident" id="3904562">c</span><span class="op" id="3904563">.</span><span class="ident" id="3904564">vers</span>&nbsp;<span class="op" id="3904569">&gt;=</span>&nbsp;<span class="ident" id="3904572">VersionTLS12</span><span class="op" id="3904584">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3904588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904591">case</span>&nbsp;<span class="ident" id="3904596">typeNextProtocol</span><span class="op" id="3904612">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904616">m</span>&nbsp;<span class="op" id="3904618">=</span>&nbsp;<span class="builtinfunc" id="3904620">new</span><span class="op" id="3904623">(</span><span class="ident" id="3904624">nextProtoMsg</span><span class="op" id="3904636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904639">case</span>&nbsp;<span class="ident" id="3904644">typeFinished</span><span class="op" id="3904656">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904660">m</span>&nbsp;<span class="op" id="3904662">=</span>&nbsp;<span class="builtinfunc" id="3904664">new</span><span class="op" id="3904667">(</span><span class="ident" id="3904668">finishedMsg</span><span class="op" id="3904679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904682">default</span><span class="op" id="3904689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904693">return</span>&nbsp;<span class="ident" id="3904700">nil</span><span class="op" id="3904703">,</span>&nbsp;<span class="ident" id="3904705">c</span><span class="op" id="3904706">.</span><span class="ident" id="3904707">in</span><span class="op" id="3904709">.</span><span class="ident" id="3904710">setErrorLocked</span><span class="op" id="3904724">(</span><span class="ident" id="3904725">c</span><span class="op" id="3904726">.</span><span class="ident" id="3904727">sendAlert</span><span class="op" id="3904736">(</span><span class="ident" id="3904737">alertUnexpectedMessage</span><span class="op" id="3904759">)</span><span class="op" id="3904760">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3904763">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3904767">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3904807">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3904857">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3904912">data</span>&nbsp;<span class="op" id="3904917">=</span>&nbsp;<span class="builtinfunc" id="3904919">append</span><span class="op" id="3904925">(</span><span class="op" id="3904926">[</span><span class="op" id="3904927">]</span><span class="builtintype" id="3904928">byte</span><span class="op" id="3904932">(</span><span class="ident" id="3904933">nil</span><span class="op" id="3904936">)</span><span class="op" id="3904937">,</span>&nbsp;<span class="ident" id="3904939">data</span><span class="op" id="3904943">...</span><span class="op" id="3904946">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904950">if</span>&nbsp;<span class="op" id="3904953">!</span><span class="ident" id="3904954">m</span><span class="op" id="3904955">.</span><span class="ident" id="3904956">unmarshal</span><span class="op" id="3904965">(</span><span class="ident" id="3904966">data</span><span class="op" id="3904970">)</span>&nbsp;<span class="op" id="3904972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3904976">return</span>&nbsp;<span class="ident" id="3904983">nil</span><span class="op" id="3904986">,</span>&nbsp;<span class="ident" id="3904988">c</span><span class="op" id="3904989">.</span><span class="ident" id="3904990">in</span><span class="op" id="3904992">.</span><span class="ident" id="3904993">setErrorLocked</span><span class="op" id="3905007">(</span><span class="ident" id="3905008">c</span><span class="op" id="3905009">.</span><span class="ident" id="3905010">sendAlert</span><span class="op" id="3905019">(</span><span class="ident" id="3905020">alertUnexpectedMessage</span><span class="op" id="3905042">)</span><span class="op" id="3905043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3905046">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905049">return</span>&nbsp;<span class="ident" id="3905056">m</span><span class="op" id="3905057">,</span>&nbsp;<span class="ident" id="3905059">nil</span><br>
<span class="lineno"></span><span class="op" id="3905063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3905066">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3905106">func</span>&nbsp;<span class="op" id="3905111">(</span><span class="ident" id="3905112">c</span>&nbsp;<span class="op" id="3905114">*</span><span class="ident" id="3905115">Conn</span><span class="op" id="3905119">)</span>&nbsp;<span class="ident" id="3905121">Write</span><span class="op" id="3905126">(</span><span class="ident" id="3905127">b</span>&nbsp;<span class="op" id="3905129">[</span><span class="op" id="3905130">]</span><span class="builtintype" id="3905131">byte</span><span class="op" id="3905135">)</span>&nbsp;<span class="op" id="3905137">(</span><span class="builtintype" id="3905138">int</span><span class="op" id="3905141">,</span>&nbsp;<span class="builtintype" id="3905143">error</span><span class="op" id="3905148">)</span>&nbsp;<span class="op" id="3905150">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905153">if</span>&nbsp;<span class="ident" id="3905156">err</span>&nbsp;<span class="op" id="3905160">:=</span>&nbsp;<span class="ident" id="3905163">c</span><span class="op" id="3905164">.</span><span class="ident" id="3905165">Handshake</span><span class="op" id="3905174">(</span><span class="op" id="3905175">)</span><span class="op" id="3905176">;</span>&nbsp;<span class="ident" id="3905178">err</span>&nbsp;<span class="op" id="3905182">!=</span>&nbsp;<span class="ident" id="3905185">nil</span>&nbsp;<span class="op" id="3905189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905193">return</span>&nbsp;<span class="num" id="3905200">0</span><span class="op" id="3905201">,</span>&nbsp;<span class="ident" id="3905203">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3905208">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3905212">c</span><span class="op" id="3905213">.</span><span class="ident" id="3905214">out</span><span class="op" id="3905217">.</span><span class="ident" id="3905218">Lock</span><span class="op" id="3905222">(</span><span class="op" id="3905223">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905226">defer</span>&nbsp;<span class="ident" id="3905232">c</span><span class="op" id="3905233">.</span><span class="ident" id="3905234">out</span><span class="op" id="3905237">.</span><span class="ident" id="3905238">Unlock</span><span class="op" id="3905244">(</span><span class="op" id="3905245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905249">if</span>&nbsp;<span class="ident" id="3905252">err</span>&nbsp;<span class="op" id="3905256">:=</span>&nbsp;<span class="ident" id="3905259">c</span><span class="op" id="3905260">.</span><span class="ident" id="3905261">out</span><span class="op" id="3905264">.</span><span class="ident" id="3905265">err</span><span class="op" id="3905268">;</span>&nbsp;<span class="ident" id="3905270">err</span>&nbsp;<span class="op" id="3905274">!=</span>&nbsp;<span class="ident" id="3905277">nil</span>&nbsp;<span class="op" id="3905281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905285">return</span>&nbsp;<span class="num" id="3905292">0</span><span class="op" id="3905293">,</span>&nbsp;<span class="ident" id="3905295">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3905300">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905304">if</span>&nbsp;<span class="op" id="3905307">!</span><span class="ident" id="3905308">c</span><span class="op" id="3905309">.</span><span class="ident" id="3905310">handshakeComplete</span>&nbsp;<span class="op" id="3905328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905332">return</span>&nbsp;<span class="num" id="3905339">0</span><span class="op" id="3905340">,</span>&nbsp;<span class="ident" id="3905342">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3905362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905366">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905428">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905493">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905554">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905615">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905619">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905664">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3905720">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905785">var</span>&nbsp;<span class="ident" id="3905789">m</span>&nbsp;<span class="builtintype" id="3905791">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905796">if</span>&nbsp;<span class="builtinfunc" id="3905799">len</span><span class="op" id="3905802">(</span><span class="ident" id="3905803">b</span><span class="op" id="3905804">)</span>&nbsp;<span class="op" id="3905806">&gt;</span>&nbsp;<span class="num" id="3905808">1</span>&nbsp;<span class="op" id="3905810">&amp;&amp;</span>&nbsp;<span class="ident" id="3905813">c</span><span class="op" id="3905814">.</span><span class="ident" id="3905815">vers</span>&nbsp;<span class="op" id="3905820">&lt;=</span>&nbsp;<span class="ident" id="3905823">VersionTLS10</span>&nbsp;<span class="op" id="3905836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905840">if</span>&nbsp;<span class="ident" id="3905843">_</span><span class="op" id="3905844">,</span>&nbsp;<span class="ident" id="3905846">ok</span>&nbsp;<span class="op" id="3905849">:=</span>&nbsp;<span class="ident" id="3905852">c</span><span class="op" id="3905853">.</span><span class="ident" id="3905854">out</span><span class="op" id="3905857">.</span><span class="ident" id="3905858">cipher</span><span class="op" id="3905864">.</span><span class="op" id="3905865">(</span><span class="ident" id="3905866">cipher</span><span class="op" id="3905872">.</span><span class="ident" id="3905873">BlockMode</span><span class="op" id="3905882">)</span><span class="op" id="3905883">;</span>&nbsp;<span class="ident" id="3905885">ok</span>&nbsp;<span class="op" id="3905888">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3905893">n</span><span class="op" id="3905894">,</span>&nbsp;<span class="ident" id="3905896">err</span>&nbsp;<span class="op" id="3905900">:=</span>&nbsp;<span class="ident" id="3905903">c</span><span class="op" id="3905904">.</span><span class="ident" id="3905905">writeRecord</span><span class="op" id="3905916">(</span><span class="ident" id="3905917">recordTypeApplicationData</span><span class="op" id="3905942">,</span>&nbsp;<span class="ident" id="3905944">b</span><span class="op" id="3905945">[</span><span class="op" id="3905946">:</span><span class="num" id="3905947">1</span><span class="op" id="3905948">]</span><span class="op" id="3905949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905954">if</span>&nbsp;<span class="ident" id="3905957">err</span>&nbsp;<span class="op" id="3905961">!=</span>&nbsp;<span class="ident" id="3905964">nil</span>&nbsp;<span class="op" id="3905968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3905974">return</span>&nbsp;<span class="ident" id="3905981">n</span><span class="op" id="3905982">,</span>&nbsp;<span class="ident" id="3905984">c</span><span class="op" id="3905985">.</span><span class="ident" id="3905986">out</span><span class="op" id="3905989">.</span><span class="ident" id="3905990">setErrorLocked</span><span class="op" id="3906004">(</span><span class="ident" id="3906005">err</span><span class="op" id="3906008">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906013">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906018">m</span><span class="op" id="3906019">,</span>&nbsp;<span class="ident" id="3906021">b</span>&nbsp;<span class="op" id="3906023">=</span>&nbsp;<span class="num" id="3906025">1</span><span class="op" id="3906026">,</span>&nbsp;<span class="ident" id="3906028">b</span><span class="op" id="3906029">[</span><span class="num" id="3906030">1</span><span class="op" id="3906031">:</span><span class="op" id="3906032">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906036">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906039">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906043">n</span><span class="op" id="3906044">,</span>&nbsp;<span class="ident" id="3906046">err</span>&nbsp;<span class="op" id="3906050">:=</span>&nbsp;<span class="ident" id="3906053">c</span><span class="op" id="3906054">.</span><span class="ident" id="3906055">writeRecord</span><span class="op" id="3906066">(</span><span class="ident" id="3906067">recordTypeApplicationData</span><span class="op" id="3906092">,</span>&nbsp;<span class="ident" id="3906094">b</span><span class="op" id="3906095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906098">return</span>&nbsp;<span class="ident" id="3906105">n</span>&nbsp;<span class="op" id="3906107">+</span>&nbsp;<span class="ident" id="3906109">m</span><span class="op" id="3906110">,</span>&nbsp;<span class="ident" id="3906112">c</span><span class="op" id="3906113">.</span><span class="ident" id="3906114">out</span><span class="op" id="3906117">.</span><span class="ident" id="3906118">setErrorLocked</span><span class="op" id="3906132">(</span><span class="ident" id="3906133">err</span><span class="op" id="3906136">)</span><br>
<span class="lineno"></span><span class="op" id="3906138">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3906141">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="3906219">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="3906285">func</span>&nbsp;<span class="op" id="3906290">(</span><span class="ident" id="3906291">c</span>&nbsp;<span class="op" id="3906293">*</span><span class="ident" id="3906294">Conn</span><span class="op" id="3906298">)</span>&nbsp;<span class="ident" id="3906300">Read</span><span class="op" id="3906304">(</span><span class="ident" id="3906305">b</span>&nbsp;<span class="op" id="3906307">[</span><span class="op" id="3906308">]</span><span class="builtintype" id="3906309">byte</span><span class="op" id="3906313">)</span>&nbsp;<span class="op" id="3906315">(</span><span class="ident" id="3906316">n</span>&nbsp;<span class="builtintype" id="3906318">int</span><span class="op" id="3906321">,</span>&nbsp;<span class="ident" id="3906323">err</span>&nbsp;<span class="builtintype" id="3906327">error</span><span class="op" id="3906332">)</span>&nbsp;<span class="op" id="3906334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906337">if</span>&nbsp;<span class="ident" id="3906340">err</span>&nbsp;<span class="op" id="3906344">=</span>&nbsp;<span class="ident" id="3906346">c</span><span class="op" id="3906347">.</span><span class="ident" id="3906348">Handshake</span><span class="op" id="3906357">(</span><span class="op" id="3906358">)</span><span class="op" id="3906359">;</span>&nbsp;<span class="ident" id="3906361">err</span>&nbsp;<span class="op" id="3906365">!=</span>&nbsp;<span class="ident" id="3906368">nil</span>&nbsp;<span class="op" id="3906372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906376">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906384">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906387">if</span>&nbsp;<span class="builtinfunc" id="3906390">len</span><span class="op" id="3906393">(</span><span class="ident" id="3906394">b</span><span class="op" id="3906395">)</span>&nbsp;<span class="op" id="3906397">==</span>&nbsp;<span class="num" id="3906400">0</span>&nbsp;<span class="op" id="3906402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3906406">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3906465">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906518">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3906526">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3906530">c</span><span class="op" id="3906531">.</span><span class="ident" id="3906532">in</span><span class="op" id="3906534">.</span><span class="ident" id="3906535">Lock</span><span class="op" id="3906539">(</span><span class="op" id="3906540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906543">defer</span>&nbsp;<span class="ident" id="3906549">c</span><span class="op" id="3906550">.</span><span class="ident" id="3906551">in</span><span class="op" id="3906553">.</span><span class="ident" id="3906554">Unlock</span><span class="op" id="3906560">(</span><span class="op" id="3906561">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3906565">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3906635">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906703">const</span>&nbsp;<span class="ident" id="3906709">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="3906736">=</span>&nbsp;<span class="num" id="3906738">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906743">for</span>&nbsp;<span class="ident" id="3906747">emptyRecordCount</span>&nbsp;<span class="op" id="3906764">:=</span>&nbsp;<span class="num" id="3906767">0</span><span class="op" id="3906768">;</span>&nbsp;<span class="ident" id="3906770">emptyRecordCount</span>&nbsp;<span class="op" id="3906787">&lt;=</span>&nbsp;<span class="ident" id="3906790">maxConsecutiveEmptyRecords</span><span class="op" id="3906816">;</span>&nbsp;<span class="ident" id="3906818">emptyRecordCount</span><span class="op" id="3906834">++</span>&nbsp;<span class="op" id="3906837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906841">for</span>&nbsp;<span class="ident" id="3906845">c</span><span class="op" id="3906846">.</span><span class="ident" id="3906847">input</span>&nbsp;<span class="op" id="3906853">==</span>&nbsp;<span class="ident" id="3906856">nil</span>&nbsp;<span class="op" id="3906860">&amp;&amp;</span>&nbsp;<span class="ident" id="3906863">c</span><span class="op" id="3906864">.</span><span class="ident" id="3906865">in</span><span class="op" id="3906867">.</span><span class="ident" id="3906868">err</span>&nbsp;<span class="op" id="3906872">==</span>&nbsp;<span class="ident" id="3906875">nil</span>&nbsp;<span class="op" id="3906879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906884">if</span>&nbsp;<span class="ident" id="3906887">err</span>&nbsp;<span class="op" id="3906891">:=</span>&nbsp;<span class="ident" id="3906894">c</span><span class="op" id="3906895">.</span><span class="ident" id="3906896">readRecord</span><span class="op" id="3906906">(</span><span class="ident" id="3906907">recordTypeApplicationData</span><span class="op" id="3906932">)</span><span class="op" id="3906933">;</span>&nbsp;<span class="ident" id="3906935">err</span>&nbsp;<span class="op" id="3906939">!=</span>&nbsp;<span class="ident" id="3906942">nil</span>&nbsp;<span class="op" id="3906946">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3906952">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3906983">return</span>&nbsp;<span class="num" id="3906990">0</span><span class="op" id="3906991">,</span>&nbsp;<span class="ident" id="3906993">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3907008">if</span>&nbsp;<span class="ident" id="3907011">err</span>&nbsp;<span class="op" id="3907015">:=</span>&nbsp;<span class="ident" id="3907018">c</span><span class="op" id="3907019">.</span><span class="ident" id="3907020">in</span><span class="op" id="3907022">.</span><span class="ident" id="3907023">err</span><span class="op" id="3907026">;</span>&nbsp;<span class="ident" id="3907028">err</span>&nbsp;<span class="op" id="3907032">!=</span>&nbsp;<span class="ident" id="3907035">nil</span>&nbsp;<span class="op" id="3907039">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3907044">return</span>&nbsp;<span class="num" id="3907051">0</span><span class="op" id="3907052">,</span>&nbsp;<span class="ident" id="3907054">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907060">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907065">n</span><span class="op" id="3907066">,</span>&nbsp;<span class="ident" id="3907068">err</span>&nbsp;<span class="op" id="3907072">=</span>&nbsp;<span class="ident" id="3907074">c</span><span class="op" id="3907075">.</span><span class="ident" id="3907076">input</span><span class="op" id="3907081">.</span><span class="ident" id="3907082">Read</span><span class="op" id="3907086">(</span><span class="ident" id="3907087">b</span><span class="op" id="3907088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3907092">if</span>&nbsp;<span class="ident" id="3907095">c</span><span class="op" id="3907096">.</span><span class="ident" id="3907097">input</span><span class="op" id="3907102">.</span><span class="ident" id="3907103">off</span>&nbsp;<span class="op" id="3907107">&gt;=</span>&nbsp;<span class="builtinfunc" id="3907110">len</span><span class="op" id="3907113">(</span><span class="ident" id="3907114">c</span><span class="op" id="3907115">.</span><span class="ident" id="3907116">input</span><span class="op" id="3907121">.</span><span class="ident" id="3907122">data</span><span class="op" id="3907126">)</span>&nbsp;<span class="op" id="3907128">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907133">c</span><span class="op" id="3907134">.</span><span class="ident" id="3907135">in</span><span class="op" id="3907137">.</span><span class="ident" id="3907138">freeBlock</span><span class="op" id="3907147">(</span><span class="ident" id="3907148">c</span><span class="op" id="3907149">.</span><span class="ident" id="3907150">input</span><span class="op" id="3907155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907160">c</span><span class="op" id="3907161">.</span><span class="ident" id="3907162">input</span>&nbsp;<span class="op" id="3907168">=</span>&nbsp;<span class="ident" id="3907170">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907176">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907181">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907238">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907297">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907350">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907404">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907457">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907513">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907570">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907620">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907634">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3907683">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3907721">if</span>&nbsp;<span class="ident" id="3907724">ri</span>&nbsp;<span class="op" id="3907727">:=</span>&nbsp;<span class="ident" id="3907730">c</span><span class="op" id="3907731">.</span><span class="ident" id="3907732">rawInput</span><span class="op" id="3907740">;</span>&nbsp;<span class="ident" id="3907742">ri</span>&nbsp;<span class="op" id="3907745">!=</span>&nbsp;<span class="ident" id="3907748">nil</span>&nbsp;<span class="op" id="3907752">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907758">n</span>&nbsp;<span class="op" id="3907760">!=</span>&nbsp;<span class="num" id="3907763">0</span>&nbsp;<span class="op" id="3907765">&amp;&amp;</span>&nbsp;<span class="ident" id="3907768">err</span>&nbsp;<span class="op" id="3907772">==</span>&nbsp;<span class="ident" id="3907775">nil</span>&nbsp;<span class="op" id="3907779">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907785">c</span><span class="op" id="3907786">.</span><span class="ident" id="3907787">input</span>&nbsp;<span class="op" id="3907793">==</span>&nbsp;<span class="ident" id="3907796">nil</span>&nbsp;<span class="op" id="3907800">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3907803">len</span><span class="op" id="3907806">(</span><span class="ident" id="3907807">ri</span><span class="op" id="3907809">.</span><span class="ident" id="3907810">data</span><span class="op" id="3907814">)</span>&nbsp;<span class="op" id="3907816">&gt;</span>&nbsp;<span class="num" id="3907818">0</span>&nbsp;<span class="op" id="3907820">&amp;&amp;</span>&nbsp;<span class="ident" id="3907823">recordType</span><span class="op" id="3907833">(</span><span class="ident" id="3907834">ri</span><span class="op" id="3907836">.</span><span class="ident" id="3907837">data</span><span class="op" id="3907841">[</span><span class="num" id="3907842">0</span><span class="op" id="3907843">]</span><span class="op" id="3907844">)</span>&nbsp;<span class="op" id="3907846">==</span>&nbsp;<span class="ident" id="3907849">recordTypeAlert</span>&nbsp;<span class="op" id="3907865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3907870">if</span>&nbsp;<span class="ident" id="3907873">recErr</span>&nbsp;<span class="op" id="3907880">:=</span>&nbsp;<span class="ident" id="3907883">c</span><span class="op" id="3907884">.</span><span class="ident" id="3907885">readRecord</span><span class="op" id="3907895">(</span><span class="ident" id="3907896">recordTypeApplicationData</span><span class="op" id="3907921">)</span><span class="op" id="3907922">;</span>&nbsp;<span class="ident" id="3907924">recErr</span>&nbsp;<span class="op" id="3907931">!=</span>&nbsp;<span class="ident" id="3907934">nil</span>&nbsp;<span class="op" id="3907938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3907944">err</span>&nbsp;<span class="op" id="3907948">=</span>&nbsp;<span class="ident" id="3907950">recErr</span>&nbsp;<span class="comment" id="3907957">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3907997">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908002">if</span>&nbsp;<span class="ident" id="3908005">n</span>&nbsp;<span class="op" id="3908007">!=</span>&nbsp;<span class="num" id="3908010">0</span>&nbsp;<span class="op" id="3908012">||</span>&nbsp;<span class="ident" id="3908015">err</span>&nbsp;<span class="op" id="3908019">!=</span>&nbsp;<span class="ident" id="3908022">nil</span>&nbsp;<span class="op" id="3908026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908031">return</span>&nbsp;<span class="ident" id="3908038">n</span><span class="op" id="3908039">,</span>&nbsp;<span class="ident" id="3908041">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908050">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908054">return</span>&nbsp;<span class="num" id="3908061">0</span><span class="op" id="3908062">,</span>&nbsp;<span class="ident" id="3908064">io</span><span class="op" id="3908066">.</span><span class="ident" id="3908067">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="3908081">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="3908084">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3908116">func</span>&nbsp;<span class="op" id="3908121">(</span><span class="ident" id="3908122">c</span>&nbsp;<span class="op" id="3908124">*</span><span class="ident" id="3908125">Conn</span><span class="op" id="3908129">)</span>&nbsp;<span class="ident" id="3908131">Close</span><span class="op" id="3908136">(</span><span class="op" id="3908137">)</span>&nbsp;<span class="builtintype" id="3908139">error</span>&nbsp;<span class="op" id="3908145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908148">var</span>&nbsp;<span class="ident" id="3908152">alertErr</span>&nbsp;<span class="builtintype" id="3908161">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3908169">c</span><span class="op" id="3908170">.</span><span class="ident" id="3908171">handshakeMutex</span><span class="op" id="3908185">.</span><span class="ident" id="3908186">Lock</span><span class="op" id="3908190">(</span><span class="op" id="3908191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908194">defer</span>&nbsp;<span class="ident" id="3908200">c</span><span class="op" id="3908201">.</span><span class="ident" id="3908202">handshakeMutex</span><span class="op" id="3908216">.</span><span class="ident" id="3908217">Unlock</span><span class="op" id="3908223">(</span><span class="op" id="3908224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908227">if</span>&nbsp;<span class="ident" id="3908230">c</span><span class="op" id="3908231">.</span><span class="ident" id="3908232">handshakeComplete</span>&nbsp;<span class="op" id="3908250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3908254">alertErr</span>&nbsp;<span class="op" id="3908263">=</span>&nbsp;<span class="ident" id="3908265">c</span><span class="op" id="3908266">.</span><span class="ident" id="3908267">sendAlert</span><span class="op" id="3908276">(</span><span class="ident" id="3908277">alertCloseNotify</span><span class="op" id="3908293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908296">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908300">if</span>&nbsp;<span class="ident" id="3908303">err</span>&nbsp;<span class="op" id="3908307">:=</span>&nbsp;<span class="ident" id="3908310">c</span><span class="op" id="3908311">.</span><span class="ident" id="3908312">conn</span><span class="op" id="3908316">.</span><span class="ident" id="3908317">Close</span><span class="op" id="3908322">(</span><span class="op" id="3908323">)</span><span class="op" id="3908324">;</span>&nbsp;<span class="ident" id="3908326">err</span>&nbsp;<span class="op" id="3908330">!=</span>&nbsp;<span class="ident" id="3908333">nil</span>&nbsp;<span class="op" id="3908337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908341">return</span>&nbsp;<span class="ident" id="3908348">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908356">return</span>&nbsp;<span class="ident" id="3908363">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="3908372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3908375">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="3908424">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="3908464">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="3908517">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="3908584">func</span>&nbsp;<span class="op" id="3908589">(</span><span class="ident" id="3908590">c</span>&nbsp;<span class="op" id="3908592">*</span><span class="ident" id="3908593">Conn</span><span class="op" id="3908597">)</span>&nbsp;<span class="ident" id="3908599">Handshake</span><span class="op" id="3908608">(</span><span class="op" id="3908609">)</span>&nbsp;<span class="builtintype" id="3908611">error</span>&nbsp;<span class="op" id="3908617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3908620">c</span><span class="op" id="3908621">.</span><span class="ident" id="3908622">handshakeMutex</span><span class="op" id="3908636">.</span><span class="ident" id="3908637">Lock</span><span class="op" id="3908641">(</span><span class="op" id="3908642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908645">defer</span>&nbsp;<span class="ident" id="3908651">c</span><span class="op" id="3908652">.</span><span class="ident" id="3908653">handshakeMutex</span><span class="op" id="3908667">.</span><span class="ident" id="3908668">Unlock</span><span class="op" id="3908674">(</span><span class="op" id="3908675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908678">if</span>&nbsp;<span class="ident" id="3908681">err</span>&nbsp;<span class="op" id="3908685">:=</span>&nbsp;<span class="ident" id="3908688">c</span><span class="op" id="3908689">.</span><span class="ident" id="3908690">handshakeErr</span><span class="op" id="3908702">;</span>&nbsp;<span class="ident" id="3908704">err</span>&nbsp;<span class="op" id="3908708">!=</span>&nbsp;<span class="ident" id="3908711">nil</span>&nbsp;<span class="op" id="3908715">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908719">return</span>&nbsp;<span class="ident" id="3908726">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908734">if</span>&nbsp;<span class="ident" id="3908737">c</span><span class="op" id="3908738">.</span><span class="ident" id="3908739">handshakeComplete</span>&nbsp;<span class="op" id="3908757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908761">return</span>&nbsp;<span class="ident" id="3908768">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908773">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908777">if</span>&nbsp;<span class="ident" id="3908780">c</span><span class="op" id="3908781">.</span><span class="ident" id="3908782">isClient</span>&nbsp;<span class="op" id="3908791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3908795">c</span><span class="op" id="3908796">.</span><span class="ident" id="3908797">handshakeErr</span>&nbsp;<span class="op" id="3908810">=</span>&nbsp;<span class="ident" id="3908812">c</span><span class="op" id="3908813">.</span><span class="ident" id="3908814">clientHandshake</span><span class="op" id="3908829">(</span><span class="op" id="3908830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908833">}</span>&nbsp;<span class="keyword" id="3908835">else</span>&nbsp;<span class="op" id="3908840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3908844">c</span><span class="op" id="3908845">.</span><span class="ident" id="3908846">handshakeErr</span>&nbsp;<span class="op" id="3908859">=</span>&nbsp;<span class="ident" id="3908861">c</span><span class="op" id="3908862">.</span><span class="ident" id="3908863">serverHandshake</span><span class="op" id="3908878">(</span><span class="op" id="3908879">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3908882">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3908885">return</span>&nbsp;<span class="ident" id="3908892">c</span><span class="op" id="3908893">.</span><span class="ident" id="3908894">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="3908907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3908910">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="3908977">func</span>&nbsp;<span class="op" id="3908982">(</span><span class="ident" id="3908983">c</span>&nbsp;<span class="op" id="3908985">*</span><span class="ident" id="3908986">Conn</span><span class="op" id="3908990">)</span>&nbsp;<span class="ident" id="3908992">ConnectionState</span><span class="op" id="3909007">(</span><span class="op" id="3909008">)</span>&nbsp;<span class="ident" id="3909010">ConnectionState</span>&nbsp;<span class="op" id="3909026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909029">c</span><span class="op" id="3909030">.</span><span class="ident" id="3909031">handshakeMutex</span><span class="op" id="3909045">.</span><span class="ident" id="3909046">Lock</span><span class="op" id="3909050">(</span><span class="op" id="3909051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909054">defer</span>&nbsp;<span class="ident" id="3909060">c</span><span class="op" id="3909061">.</span><span class="ident" id="3909062">handshakeMutex</span><span class="op" id="3909076">.</span><span class="ident" id="3909077">Unlock</span><span class="op" id="3909083">(</span><span class="op" id="3909084">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909088">var</span>&nbsp;<span class="ident" id="3909092">state</span>&nbsp;<span class="ident" id="3909098">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909115">state</span><span class="op" id="3909120">.</span><span class="ident" id="3909121">HandshakeComplete</span>&nbsp;<span class="op" id="3909139">=</span>&nbsp;<span class="ident" id="3909141">c</span><span class="op" id="3909142">.</span><span class="ident" id="3909143">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909162">if</span>&nbsp;<span class="ident" id="3909165">c</span><span class="op" id="3909166">.</span><span class="ident" id="3909167">handshakeComplete</span>&nbsp;<span class="op" id="3909185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909189">state</span><span class="op" id="3909194">.</span><span class="ident" id="3909195">Version</span>&nbsp;<span class="op" id="3909203">=</span>&nbsp;<span class="ident" id="3909205">c</span><span class="op" id="3909206">.</span><span class="ident" id="3909207">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909214">state</span><span class="op" id="3909219">.</span><span class="ident" id="3909220">NegotiatedProtocol</span>&nbsp;<span class="op" id="3909239">=</span>&nbsp;<span class="ident" id="3909241">c</span><span class="op" id="3909242">.</span><span class="ident" id="3909243">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909260">state</span><span class="op" id="3909265">.</span><span class="ident" id="3909266">DidResume</span>&nbsp;<span class="op" id="3909276">=</span>&nbsp;<span class="ident" id="3909278">c</span><span class="op" id="3909279">.</span><span class="ident" id="3909280">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909292">state</span><span class="op" id="3909297">.</span><span class="ident" id="3909298">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="3909325">=</span>&nbsp;<span class="op" id="3909327">!</span><span class="ident" id="3909328">c</span><span class="op" id="3909329">.</span><span class="ident" id="3909330">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909355">state</span><span class="op" id="3909360">.</span><span class="ident" id="3909361">CipherSuite</span>&nbsp;<span class="op" id="3909373">=</span>&nbsp;<span class="ident" id="3909375">c</span><span class="op" id="3909376">.</span><span class="ident" id="3909377">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909391">state</span><span class="op" id="3909396">.</span><span class="ident" id="3909397">PeerCertificates</span>&nbsp;<span class="op" id="3909414">=</span>&nbsp;<span class="ident" id="3909416">c</span><span class="op" id="3909417">.</span><span class="ident" id="3909418">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909437">state</span><span class="op" id="3909442">.</span><span class="ident" id="3909443">VerifiedChains</span>&nbsp;<span class="op" id="3909458">=</span>&nbsp;<span class="ident" id="3909460">c</span><span class="op" id="3909461">.</span><span class="ident" id="3909462">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909479">state</span><span class="op" id="3909484">.</span><span class="ident" id="3909485">ServerName</span>&nbsp;<span class="op" id="3909496">=</span>&nbsp;<span class="ident" id="3909498">c</span><span class="op" id="3909499">.</span><span class="ident" id="3909500">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909513">if</span>&nbsp;<span class="op" id="3909516">!</span><span class="ident" id="3909517">c</span><span class="op" id="3909518">.</span><span class="ident" id="3909519">didResume</span>&nbsp;<span class="op" id="3909529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909534">state</span><span class="op" id="3909539">.</span><span class="ident" id="3909540">TLSUnique</span>&nbsp;<span class="op" id="3909550">=</span>&nbsp;<span class="ident" id="3909552">c</span><span class="op" id="3909553">.</span><span class="ident" id="3909554">firstFinished</span><span class="op" id="3909567">[</span><span class="op" id="3909568">:</span><span class="op" id="3909569">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3909573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3909576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909580">return</span>&nbsp;<span class="ident" id="3909587">state</span><br>
<span class="lineno"></span><span class="op" id="3909593">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3909596">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="3909670">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="3909715">func</span>&nbsp;<span class="op" id="3909720">(</span><span class="ident" id="3909721">c</span>&nbsp;<span class="op" id="3909723">*</span><span class="ident" id="3909724">Conn</span><span class="op" id="3909728">)</span>&nbsp;<span class="ident" id="3909730">OCSPResponse</span><span class="op" id="3909742">(</span><span class="op" id="3909743">)</span>&nbsp;<span class="op" id="3909745">[</span><span class="op" id="3909746">]</span><span class="builtintype" id="3909747">byte</span>&nbsp;<span class="op" id="3909752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3909755">c</span><span class="op" id="3909756">.</span><span class="ident" id="3909757">handshakeMutex</span><span class="op" id="3909771">.</span><span class="ident" id="3909772">Lock</span><span class="op" id="3909776">(</span><span class="op" id="3909777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909780">defer</span>&nbsp;<span class="ident" id="3909786">c</span><span class="op" id="3909787">.</span><span class="ident" id="3909788">handshakeMutex</span><span class="op" id="3909802">.</span><span class="ident" id="3909803">Unlock</span><span class="op" id="3909809">(</span><span class="op" id="3909810">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3909814">return</span>&nbsp;<span class="ident" id="3909821">c</span><span class="op" id="3909822">.</span><span class="ident" id="3909823">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="3909836">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3909839">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3909909">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3909984">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="3910011">func</span>&nbsp;<span class="op" id="3910016">(</span><span class="ident" id="3910017">c</span>&nbsp;<span class="op" id="3910019">*</span><span class="ident" id="3910020">Conn</span><span class="op" id="3910024">)</span>&nbsp;<span class="ident" id="3910026">VerifyHostname</span><span class="op" id="3910040">(</span><span class="ident" id="3910041">host</span>&nbsp;<span class="builtintype" id="3910046">string</span><span class="op" id="3910052">)</span>&nbsp;<span class="builtintype" id="3910054">error</span>&nbsp;<span class="op" id="3910060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3910063">c</span><span class="op" id="3910064">.</span><span class="ident" id="3910065">handshakeMutex</span><span class="op" id="3910079">.</span><span class="ident" id="3910080">Lock</span><span class="op" id="3910084">(</span><span class="op" id="3910085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910088">defer</span>&nbsp;<span class="ident" id="3910094">c</span><span class="op" id="3910095">.</span><span class="ident" id="3910096">handshakeMutex</span><span class="op" id="3910110">.</span><span class="ident" id="3910111">Unlock</span><span class="op" id="3910117">(</span><span class="op" id="3910118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910121">if</span>&nbsp;<span class="op" id="3910124">!</span><span class="ident" id="3910125">c</span><span class="op" id="3910126">.</span><span class="ident" id="3910127">isClient</span>&nbsp;<span class="op" id="3910136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910140">return</span>&nbsp;<span class="ident" id="3910147">errors</span><span class="op" id="3910153">.</span><span class="ident" id="3910154">New</span><span class="op" id="3910157">(</span><span class="string" id="3910158">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="3910211">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910217">if</span>&nbsp;<span class="op" id="3910220">!</span><span class="ident" id="3910221">c</span><span class="op" id="3910222">.</span><span class="ident" id="3910223">handshakeComplete</span>&nbsp;<span class="op" id="3910241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910245">return</span>&nbsp;<span class="ident" id="3910252">errors</span><span class="op" id="3910258">.</span><span class="ident" id="3910259">New</span><span class="op" id="3910262">(</span><span class="string" id="3910263">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="3910306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3910309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3910312">return</span>&nbsp;<span class="ident" id="3910319">c</span><span class="op" id="3910320">.</span><span class="ident" id="3910321">peerCertificates</span><span class="op" id="3910337">[</span><span class="num" id="3910338">0</span><span class="op" id="3910339">]</span><span class="op" id="3910340">.</span><span class="ident" id="3910341">VerifyHostname</span><span class="op" id="3910355">(</span><span class="ident" id="3910356">host</span><span class="op" id="3910360">)</span><br>
<span class="lineno">1030</span><span class="op" id="3910362">}</span>
</div>
</body>
</html>
