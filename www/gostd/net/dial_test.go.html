<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8341163">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8341218">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8341272">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8341323">package</span>&nbsp;<span class="ident" id="8341331">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8341336">import</span>&nbsp;<span class="op" id="8341343">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341346">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341355">&#34;flag&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341363">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341370">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341376">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341382">&#34;os/exec&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341393">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341404">&#34;regexp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341414">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341425">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341436">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341444">&#34;testing&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8341455">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8341462">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8341465">func</span>&nbsp;<span class="ident" id="8341470">newLocalListener</span><span class="op" id="8341486">(</span><span class="ident" id="8341487">t</span>&nbsp;<span class="op" id="8341489">*</span><span class="ident" id="8341490">testing</span><span class="op" id="8341497">.</span><span class="ident" id="8341498">T</span><span class="op" id="8341499">)</span>&nbsp;<span class="ident" id="8341501">Listener</span>&nbsp;<span class="op" id="8341510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341513">ln</span><span class="op" id="8341515">,</span>&nbsp;<span class="ident" id="8341517">err</span>&nbsp;<span class="op" id="8341521">:=</span>&nbsp;<span class="ident" id="8341524">Listen</span><span class="op" id="8341530">(</span><span class="string" id="8341531">&#34;tcp&#34;</span><span class="op" id="8341536">,</span>&nbsp;<span class="string" id="8341538">&#34;127.0.0.1:0&#34;</span><span class="op" id="8341551">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341554">if</span>&nbsp;<span class="ident" id="8341557">err</span>&nbsp;<span class="op" id="8341561">!=</span>&nbsp;<span class="ident" id="8341564">nil</span>&nbsp;<span class="op" id="8341568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341572">ln</span><span class="op" id="8341574">,</span>&nbsp;<span class="ident" id="8341576">err</span>&nbsp;<span class="op" id="8341580">=</span>&nbsp;<span class="ident" id="8341582">Listen</span><span class="op" id="8341588">(</span><span class="string" id="8341589">&#34;tcp6&#34;</span><span class="op" id="8341595">,</span>&nbsp;<span class="string" id="8341597">&#34;[::1]:0&#34;</span><span class="op" id="8341606">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341612">if</span>&nbsp;<span class="ident" id="8341615">err</span>&nbsp;<span class="op" id="8341619">!=</span>&nbsp;<span class="ident" id="8341622">nil</span>&nbsp;<span class="op" id="8341626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341630">t</span><span class="op" id="8341631">.</span><span class="ident" id="8341632">Fatal</span><span class="op" id="8341637">(</span><span class="ident" id="8341638">err</span><span class="op" id="8341641">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341647">return</span>&nbsp;<span class="ident" id="8341654">ln</span><br>
<span class="lineno"></span><span class="op" id="8341657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8341660">func</span>&nbsp;<span class="ident" id="8341665">TestDialTimeout</span><span class="op" id="8341680">(</span><span class="ident" id="8341681">t</span>&nbsp;<span class="op" id="8341683">*</span><span class="ident" id="8341684">testing</span><span class="op" id="8341691">.</span><span class="ident" id="8341692">T</span><span class="op" id="8341693">)</span>&nbsp;<span class="op" id="8341695">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341698">origBacklog</span>&nbsp;<span class="op" id="8341710">:=</span>&nbsp;<span class="ident" id="8341713">listenerBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341730">defer</span>&nbsp;<span class="keyword" id="8341736">func</span><span class="op" id="8341740">(</span><span class="op" id="8341741">)</span>&nbsp;<span class="op" id="8341743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341747">listenerBacklog</span>&nbsp;<span class="op" id="8341763">=</span>&nbsp;<span class="ident" id="8341765">origBacklog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8341778">}</span><span class="op" id="8341779">(</span><span class="op" id="8341780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341783">listenerBacklog</span>&nbsp;<span class="op" id="8341799">=</span>&nbsp;<span class="num" id="8341801">1</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341805">ln</span>&nbsp;<span class="op" id="8341808">:=</span>&nbsp;<span class="ident" id="8341811">newLocalListener</span><span class="op" id="8341827">(</span><span class="ident" id="8341828">t</span><span class="op" id="8341829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8341832">defer</span>&nbsp;<span class="ident" id="8341838">ln</span><span class="op" id="8341840">.</span><span class="ident" id="8341841">Close</span><span class="op" id="8341846">(</span><span class="op" id="8341847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341851">errc</span>&nbsp;<span class="op" id="8341856">:=</span>&nbsp;<span class="builtinfunc" id="8341859">make</span><span class="op" id="8341863">(</span><span class="keyword" id="8341864">chan</span>&nbsp;<span class="builtintype" id="8341869">error</span><span class="op" id="8341874">)</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8341878">numConns</span>&nbsp;<span class="op" id="8341887">:=</span>&nbsp;<span class="ident" id="8341890">listenerBacklog</span>&nbsp;<span class="op" id="8341906">+</span>&nbsp;<span class="num" id="8341908">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8341914">//&nbsp;TODO(bradfitz):&nbsp;It&#39;s&nbsp;hard&nbsp;to&nbsp;test&nbsp;this&nbsp;in&nbsp;a&nbsp;portable</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8341971">//&nbsp;way.&nbsp;This&nbsp;is&nbsp;unfortunate,&nbsp;but&nbsp;works&nbsp;for&nbsp;now.</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342020">switch</span>&nbsp;<span class="ident" id="8342027">runtime</span><span class="op" id="8342034">.</span><span class="ident" id="8342035">GOOS</span>&nbsp;<span class="op" id="8342040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342043">case</span>&nbsp;<span class="string" id="8342048">&#34;linux&#34;</span><span class="op" id="8342055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342059">//&nbsp;The&nbsp;kernel&nbsp;will&nbsp;start&nbsp;accepting&nbsp;TCP&nbsp;connections&nbsp;before&nbsp;userspace</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342129">//&nbsp;gets&nbsp;a&nbsp;chance&nbsp;to&nbsp;not&nbsp;accept&nbsp;them,&nbsp;so&nbsp;fire&nbsp;off&nbsp;a&nbsp;bunch&nbsp;to&nbsp;fill&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342199">//&nbsp;the&nbsp;kernel&#39;s&nbsp;backlog.&nbsp;&nbsp;Then&nbsp;we&nbsp;test&nbsp;we&nbsp;get&nbsp;a&nbsp;failure&nbsp;after&nbsp;that.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342269">for</span>&nbsp;<span class="ident" id="8342273">i</span>&nbsp;<span class="op" id="8342275">:=</span>&nbsp;<span class="num" id="8342278">0</span><span class="op" id="8342279">;</span>&nbsp;<span class="ident" id="8342281">i</span>&nbsp;<span class="op" id="8342283">&lt;</span>&nbsp;<span class="ident" id="8342285">numConns</span><span class="op" id="8342293">;</span>&nbsp;<span class="ident" id="8342295">i</span><span class="op" id="8342296">++</span>&nbsp;<span class="op" id="8342299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342304">go</span>&nbsp;<span class="keyword" id="8342307">func</span><span class="op" id="8342311">(</span><span class="op" id="8342312">)</span>&nbsp;<span class="op" id="8342314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342320">_</span><span class="op" id="8342321">,</span>&nbsp;<span class="ident" id="8342323">err</span>&nbsp;<span class="op" id="8342327">:=</span>&nbsp;<span class="ident" id="8342330">DialTimeout</span><span class="op" id="8342341">(</span><span class="string" id="8342342">&#34;tcp&#34;</span><span class="op" id="8342347">,</span>&nbsp;<span class="ident" id="8342349">ln</span><span class="op" id="8342351">.</span><span class="ident" id="8342352">Addr</span><span class="op" id="8342356">(</span><span class="op" id="8342357">)</span><span class="op" id="8342358">.</span><span class="ident" id="8342359">String</span><span class="op" id="8342365">(</span><span class="op" id="8342366">)</span><span class="op" id="8342367">,</span>&nbsp;<span class="num" id="8342369">200</span><span class="op" id="8342372">*</span><span class="ident" id="8342373">time</span><span class="op" id="8342377">.</span><span class="ident" id="8342378">Millisecond</span><span class="op" id="8342389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8342395">errc</span>&nbsp;<span class="op" id="8342400">&lt;-</span>&nbsp;<span class="ident" id="8342403">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342410">}</span><span class="op" id="8342411">(</span><span class="op" id="8342412">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8342416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8342419">case</span>&nbsp;<span class="string" id="8342424">&#34;darwin&#34;</span><span class="op" id="8342432">,</span>&nbsp;<span class="string" id="8342434">&#34;plan9&#34;</span><span class="op" id="8342441">,</span>&nbsp;<span class="string" id="8342443">&#34;windows&#34;</span><span class="op" id="8342452">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342456">//&nbsp;At&nbsp;least&nbsp;OS&nbsp;X&nbsp;10.7&nbsp;seems&nbsp;to&nbsp;accept&nbsp;any&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342510">//&nbsp;connections,&nbsp;ignoring&nbsp;listen&#39;s&nbsp;backlog,&nbsp;so&nbsp;resort</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342565">//&nbsp;to&nbsp;connecting&nbsp;to&nbsp;a&nbsp;hopefully-dead&nbsp;127/8&nbsp;address.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342619">//&nbsp;Same&nbsp;for&nbsp;windows.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342642">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342647">//&nbsp;Use&nbsp;an&nbsp;IANA&nbsp;reserved&nbsp;port&nbsp;(49151)&nbsp;instead&nbsp;of&nbsp;80,&nbsp;because</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342709">//&nbsp;on&nbsp;our&nbsp;386&nbsp;builder,&nbsp;this&nbsp;Dial&nbsp;succeeds,&nbsp;connecting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342765">//&nbsp;to&nbsp;an&nbsp;IIS&nbsp;web&nbsp;server&nbsp;somewhere.&nbsp;&nbsp;The&nbsp;data&nbsp;center</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342819">//&nbsp;or&nbsp;VM&nbsp;or&nbsp;firewall&nbsp;must&nbsp;be&nbsp;stealing&nbsp;the&nbsp;TCP&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342879">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342884">//&nbsp;IANA&nbsp;Service&nbsp;Name&nbsp;and&nbsp;Transport&nbsp;Protocol&nbsp;Port&nbsp;Number&nbsp;Registry</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8342951">//&nbsp;&lt;http://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xml&gt;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343048">go</span>&nbsp;<span class="keyword" id="8343051">func</span><span class="op" id="8343055">(</span><span class="op" id="8343056">)</span>&nbsp;<span class="op" id="8343058">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343063">c</span><span class="op" id="8343064">,</span>&nbsp;<span class="ident" id="8343066">err</span>&nbsp;<span class="op" id="8343070">:=</span>&nbsp;<span class="ident" id="8343073">DialTimeout</span><span class="op" id="8343084">(</span><span class="string" id="8343085">&#34;tcp&#34;</span><span class="op" id="8343090">,</span>&nbsp;<span class="string" id="8343092">&#34;127.0.71.111:49151&#34;</span><span class="op" id="8343112">,</span>&nbsp;<span class="num" id="8343114">200</span><span class="op" id="8343117">*</span><span class="ident" id="8343118">time</span><span class="op" id="8343122">.</span><span class="ident" id="8343123">Millisecond</span><span class="op" id="8343134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343139">if</span>&nbsp;<span class="ident" id="8343142">err</span>&nbsp;<span class="op" id="8343146">==</span>&nbsp;<span class="ident" id="8343149">nil</span>&nbsp;<span class="op" id="8343153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343159">err</span>&nbsp;<span class="op" id="8343163">=</span>&nbsp;<span class="ident" id="8343165">fmt</span><span class="op" id="8343168">.</span><span class="ident" id="8343169">Errorf</span><span class="op" id="8343175">(</span><span class="string" id="8343176">&#34;unexpected:&nbsp;connected&nbsp;to&nbsp;%s!&#34;</span><span class="op" id="8343206">,</span>&nbsp;<span class="ident" id="8343208">c</span><span class="op" id="8343209">.</span><span class="ident" id="8343210">RemoteAddr</span><span class="op" id="8343220">(</span><span class="op" id="8343221">)</span><span class="op" id="8343222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343228">c</span><span class="op" id="8343229">.</span><span class="ident" id="8343230">Close</span><span class="op" id="8343235">(</span><span class="op" id="8343236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343241">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343246">errc</span>&nbsp;<span class="op" id="8343251">&lt;-</span>&nbsp;<span class="ident" id="8343254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343260">}</span><span class="op" id="8343261">(</span><span class="op" id="8343262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343265">default</span><span class="op" id="8343272">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343276">//&nbsp;TODO(bradfitz):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343297">//&nbsp;OpenBSD&nbsp;may&nbsp;have&nbsp;a&nbsp;reject&nbsp;route&nbsp;to&nbsp;127/8&nbsp;except&nbsp;127.0.0.1/32</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343363">//&nbsp;by&nbsp;default.&nbsp;FreeBSD&nbsp;likely&nbsp;works,&nbsp;but&nbsp;is&nbsp;untested.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343419">//&nbsp;TODO(rsc):</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8343435">//&nbsp;The&nbsp;timeout&nbsp;never&nbsp;happens&nbsp;on&nbsp;Windows.&nbsp;&nbsp;Why?&nbsp;&nbsp;Issue&nbsp;3016.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343497">t</span><span class="op" id="8343498">.</span><span class="ident" id="8343499">Skipf</span><span class="op" id="8343504">(</span><span class="string" id="8343505">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q;&nbsp;untested.&#34;</span><span class="op" id="8343537">,</span>&nbsp;<span class="ident" id="8343539">runtime</span><span class="op" id="8343546">.</span><span class="ident" id="8343547">GOOS</span><span class="op" id="8343551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343554">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343558">connected</span>&nbsp;<span class="op" id="8343568">:=</span>&nbsp;<span class="num" id="8343571">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343574">for</span>&nbsp;<span class="op" id="8343578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343582">select</span>&nbsp;<span class="op" id="8343589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343593">case</span>&nbsp;<span class="op" id="8343598">&lt;-</span><span class="ident" id="8343600">time</span><span class="op" id="8343604">.</span><span class="ident" id="8343605">After</span><span class="op" id="8343610">(</span><span class="num" id="8343611">15</span>&nbsp;<span class="op" id="8343614">*</span>&nbsp;<span class="ident" id="8343616">time</span><span class="op" id="8343620">.</span><span class="ident" id="8343621">Second</span><span class="op" id="8343627">)</span><span class="op" id="8343628">:</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343633">t</span><span class="op" id="8343634">.</span><span class="ident" id="8343635">Fatal</span><span class="op" id="8343640">(</span><span class="string" id="8343641">&#34;too&nbsp;slow&#34;</span><span class="op" id="8343651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343655">case</span>&nbsp;<span class="ident" id="8343660">err</span>&nbsp;<span class="op" id="8343664">:=</span>&nbsp;<span class="op" id="8343667">&lt;-</span><span class="ident" id="8343669">errc</span><span class="op" id="8343673">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343678">if</span>&nbsp;<span class="ident" id="8343681">err</span>&nbsp;<span class="op" id="8343685">==</span>&nbsp;<span class="ident" id="8343688">nil</span>&nbsp;<span class="op" id="8343692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343698">connected</span><span class="op" id="8343707">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343714">if</span>&nbsp;<span class="ident" id="8343717">connected</span>&nbsp;<span class="op" id="8343727">==</span>&nbsp;<span class="ident" id="8343730">numConns</span>&nbsp;<span class="op" id="8343739">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343746">t</span><span class="op" id="8343747">.</span><span class="ident" id="8343748">Fatal</span><span class="op" id="8343753">(</span><span class="string" id="8343754">&#34;all&nbsp;connections&nbsp;connected;&nbsp;expected&nbsp;some&nbsp;to&nbsp;time&nbsp;out&#34;</span><span class="op" id="8343808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343819">}</span>&nbsp;<span class="keyword" id="8343821">else</span>&nbsp;<span class="op" id="8343826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343832">terr</span><span class="op" id="8343836">,</span>&nbsp;<span class="ident" id="8343838">ok</span>&nbsp;<span class="op" id="8343841">:=</span>&nbsp;<span class="ident" id="8343844">err</span><span class="op" id="8343847">.</span><span class="op" id="8343848">(</span><span class="ident" id="8343849">timeout</span><span class="op" id="8343856">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343862">if</span>&nbsp;<span class="op" id="8343865">!</span><span class="ident" id="8343866">ok</span>&nbsp;<span class="op" id="8343869">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343876">t</span><span class="op" id="8343877">.</span><span class="ident" id="8343878">Fatalf</span><span class="op" id="8343884">(</span><span class="string" id="8343885">&#34;got&nbsp;error&nbsp;%q;&nbsp;want&nbsp;error&nbsp;with&nbsp;timeout&nbsp;interface&#34;</span><span class="op" id="8343934">,</span>&nbsp;<span class="ident" id="8343936">err</span><span class="op" id="8343939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8343945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8343951">if</span>&nbsp;<span class="op" id="8343954">!</span><span class="ident" id="8343955">terr</span><span class="op" id="8343959">.</span><span class="ident" id="8343960">Timeout</span><span class="op" id="8343967">(</span><span class="op" id="8343968">)</span>&nbsp;<span class="op" id="8343970">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8343977">t</span><span class="op" id="8343978">.</span><span class="ident" id="8343979">Fatalf</span><span class="op" id="8343985">(</span><span class="string" id="8343986">&#34;got&nbsp;error&nbsp;%q;&nbsp;not&nbsp;a&nbsp;timeout&#34;</span><span class="op" id="8344015">,</span>&nbsp;<span class="ident" id="8344017">err</span><span class="op" id="8344020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344026">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344032">//&nbsp;Pass.&nbsp;We&nbsp;saw&nbsp;a&nbsp;timeout&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344069">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344086">}</span><br>
<span class="lineno">115</span><span class="op" id="8344088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8344091">func</span>&nbsp;<span class="ident" id="8344096">TestSelfConnect</span><span class="op" id="8344111">(</span><span class="ident" id="8344112">t</span>&nbsp;<span class="op" id="8344114">*</span><span class="ident" id="8344115">testing</span><span class="op" id="8344122">.</span><span class="ident" id="8344123">T</span><span class="op" id="8344124">)</span>&nbsp;<span class="op" id="8344126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344129">if</span>&nbsp;<span class="ident" id="8344132">runtime</span><span class="op" id="8344139">.</span><span class="ident" id="8344140">GOOS</span>&nbsp;<span class="op" id="8344145">==</span>&nbsp;<span class="string" id="8344148">&#34;windows&#34;</span>&nbsp;<span class="op" id="8344158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344162">//&nbsp;TODO(brainman):&nbsp;do&nbsp;not&nbsp;know&nbsp;why&nbsp;it&nbsp;hangs.</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344209">t</span><span class="op" id="8344210">.</span><span class="ident" id="8344211">Skip</span><span class="op" id="8344215">(</span><span class="string" id="8344216">&#34;skipping&nbsp;known-broken&nbsp;test&nbsp;on&nbsp;windows&#34;</span><span class="op" id="8344255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344258">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344262">//&nbsp;Test&nbsp;that&nbsp;Dial&nbsp;does&nbsp;not&nbsp;honor&nbsp;self-connects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344311">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;DialTCP.</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344344">//&nbsp;Find&nbsp;a&nbsp;port&nbsp;that&nbsp;would&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;local&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344399">l</span><span class="op" id="8344400">,</span>&nbsp;<span class="ident" id="8344402">err</span>&nbsp;<span class="op" id="8344406">:=</span>&nbsp;<span class="ident" id="8344409">Listen</span><span class="op" id="8344415">(</span><span class="string" id="8344416">&#34;tcp&#34;</span><span class="op" id="8344421">,</span>&nbsp;<span class="string" id="8344423">&#34;127.0.0.1:0&#34;</span><span class="op" id="8344436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344439">if</span>&nbsp;<span class="ident" id="8344442">err</span>&nbsp;<span class="op" id="8344446">!=</span>&nbsp;<span class="ident" id="8344449">nil</span>&nbsp;<span class="op" id="8344453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344457">t</span><span class="op" id="8344458">.</span><span class="ident" id="8344459">Fatal</span><span class="op" id="8344464">(</span><span class="ident" id="8344465">err</span><span class="op" id="8344468">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344474">c</span><span class="op" id="8344475">,</span>&nbsp;<span class="ident" id="8344477">err</span>&nbsp;<span class="op" id="8344481">:=</span>&nbsp;<span class="ident" id="8344484">Dial</span><span class="op" id="8344488">(</span><span class="string" id="8344489">&#34;tcp&#34;</span><span class="op" id="8344494">,</span>&nbsp;<span class="ident" id="8344496">l</span><span class="op" id="8344497">.</span><span class="ident" id="8344498">Addr</span><span class="op" id="8344502">(</span><span class="op" id="8344503">)</span><span class="op" id="8344504">.</span><span class="ident" id="8344505">String</span><span class="op" id="8344511">(</span><span class="op" id="8344512">)</span><span class="op" id="8344513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344516">if</span>&nbsp;<span class="ident" id="8344519">err</span>&nbsp;<span class="op" id="8344523">!=</span>&nbsp;<span class="ident" id="8344526">nil</span>&nbsp;<span class="op" id="8344530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344534">t</span><span class="op" id="8344535">.</span><span class="ident" id="8344536">Fatal</span><span class="op" id="8344541">(</span><span class="ident" id="8344542">err</span><span class="op" id="8344545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344548">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344551">addr</span>&nbsp;<span class="op" id="8344556">:=</span>&nbsp;<span class="ident" id="8344559">c</span><span class="op" id="8344560">.</span><span class="ident" id="8344561">LocalAddr</span><span class="op" id="8344570">(</span><span class="op" id="8344571">)</span><span class="op" id="8344572">.</span><span class="ident" id="8344573">String</span><span class="op" id="8344579">(</span><span class="op" id="8344580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344583">c</span><span class="op" id="8344584">.</span><span class="ident" id="8344585">Close</span><span class="op" id="8344590">(</span><span class="op" id="8344591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344594">l</span><span class="op" id="8344595">.</span><span class="ident" id="8344596">Close</span><span class="op" id="8344601">(</span><span class="op" id="8344602">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344606">//&nbsp;Try&nbsp;to&nbsp;connect&nbsp;to&nbsp;that&nbsp;address&nbsp;repeatedly.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344653">n</span>&nbsp;<span class="op" id="8344655">:=</span>&nbsp;<span class="num" id="8344658">100000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344666">if</span>&nbsp;<span class="ident" id="8344669">testing</span><span class="op" id="8344676">.</span><span class="ident" id="8344677">Short</span><span class="op" id="8344682">(</span><span class="op" id="8344683">)</span>&nbsp;<span class="op" id="8344685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344689">n</span>&nbsp;<span class="op" id="8344691">=</span>&nbsp;<span class="num" id="8344693">1000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344702">switch</span>&nbsp;<span class="ident" id="8344709">runtime</span><span class="op" id="8344716">.</span><span class="ident" id="8344717">GOOS</span>&nbsp;<span class="op" id="8344722">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344725">case</span>&nbsp;<span class="string" id="8344730">&#34;darwin&#34;</span><span class="op" id="8344738">,</span>&nbsp;<span class="string" id="8344740">&#34;dragonfly&#34;</span><span class="op" id="8344751">,</span>&nbsp;<span class="string" id="8344753">&#34;freebsd&#34;</span><span class="op" id="8344762">,</span>&nbsp;<span class="string" id="8344764">&#34;netbsd&#34;</span><span class="op" id="8344772">,</span>&nbsp;<span class="string" id="8344774">&#34;openbsd&#34;</span><span class="op" id="8344783">,</span>&nbsp;<span class="string" id="8344785">&#34;plan9&#34;</span><span class="op" id="8344792">,</span>&nbsp;<span class="string" id="8344794">&#34;solaris&#34;</span><span class="op" id="8344803">,</span>&nbsp;<span class="string" id="8344805">&#34;windows&#34;</span><span class="op" id="8344814">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344818">//&nbsp;Non-Linux&nbsp;systems&nbsp;take&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;figure</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8344868">//&nbsp;out&nbsp;that&nbsp;there&nbsp;is&nbsp;nothing&nbsp;listening&nbsp;on&nbsp;localhost.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344923">n</span>&nbsp;<span class="op" id="8344925">=</span>&nbsp;<span class="num" id="8344927">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8344932">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8344935">for</span>&nbsp;<span class="ident" id="8344939">i</span>&nbsp;<span class="op" id="8344941">:=</span>&nbsp;<span class="num" id="8344944">0</span><span class="op" id="8344945">;</span>&nbsp;<span class="ident" id="8344947">i</span>&nbsp;<span class="op" id="8344949">&lt;</span>&nbsp;<span class="ident" id="8344951">n</span><span class="op" id="8344952">;</span>&nbsp;<span class="ident" id="8344954">i</span><span class="op" id="8344955">++</span>&nbsp;<span class="op" id="8344958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8344962">c</span><span class="op" id="8344963">,</span>&nbsp;<span class="ident" id="8344965">err</span>&nbsp;<span class="op" id="8344969">:=</span>&nbsp;<span class="ident" id="8344972">DialTimeout</span><span class="op" id="8344983">(</span><span class="string" id="8344984">&#34;tcp&#34;</span><span class="op" id="8344989">,</span>&nbsp;<span class="ident" id="8344991">addr</span><span class="op" id="8344995">,</span>&nbsp;<span class="ident" id="8344997">time</span><span class="op" id="8345001">.</span><span class="ident" id="8345002">Millisecond</span><span class="op" id="8345013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8345017">if</span>&nbsp;<span class="ident" id="8345020">err</span>&nbsp;<span class="op" id="8345024">==</span>&nbsp;<span class="ident" id="8345027">nil</span>&nbsp;<span class="op" id="8345031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8345036">if</span>&nbsp;<span class="ident" id="8345039">c</span><span class="op" id="8345040">.</span><span class="ident" id="8345041">LocalAddr</span><span class="op" id="8345050">(</span><span class="op" id="8345051">)</span><span class="op" id="8345052">.</span><span class="ident" id="8345053">String</span><span class="op" id="8345059">(</span><span class="op" id="8345060">)</span>&nbsp;<span class="op" id="8345062">==</span>&nbsp;<span class="ident" id="8345065">addr</span>&nbsp;<span class="op" id="8345070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345076">t</span><span class="op" id="8345077">.</span><span class="ident" id="8345078">Errorf</span><span class="op" id="8345084">(</span><span class="string" id="8345085">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;self-connect&#34;</span><span class="op" id="8345112">,</span>&nbsp;<span class="ident" id="8345114">i</span><span class="op" id="8345115">,</span>&nbsp;<span class="ident" id="8345117">addr</span><span class="op" id="8345121">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345126">}</span>&nbsp;<span class="keyword" id="8345128">else</span>&nbsp;<span class="op" id="8345133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345139">t</span><span class="op" id="8345140">.</span><span class="ident" id="8345141">Logf</span><span class="op" id="8345145">(</span><span class="string" id="8345146">&#34;#%d:&nbsp;Dial&nbsp;%q&nbsp;succeeded&nbsp;-&nbsp;possibly&nbsp;racing&nbsp;with&nbsp;other&nbsp;listener&#34;</span><span class="op" id="8345208">,</span>&nbsp;<span class="ident" id="8345210">i</span><span class="op" id="8345211">,</span>&nbsp;<span class="ident" id="8345213">addr</span><span class="op" id="8345217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345227">c</span><span class="op" id="8345228">.</span><span class="ident" id="8345229">Close</span><span class="op" id="8345234">(</span><span class="op" id="8345235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345239">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345242">}</span><br>
<span class="lineno"></span><span class="op" id="8345244">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8345247">var</span>&nbsp;<span class="ident" id="8345251">runErrorTest</span>&nbsp;<span class="op" id="8345264">=</span>&nbsp;<span class="ident" id="8345266">flag</span><span class="op" id="8345270">.</span><span class="ident" id="8345271">Bool</span><span class="op" id="8345275">(</span><span class="string" id="8345276">&#34;run_error_test&#34;</span><span class="op" id="8345292">,</span>&nbsp;<span class="builtintype" id="8345294">false</span><span class="op" id="8345299">,</span>&nbsp;<span class="string" id="8345301">&#34;let&nbsp;TestDialError&nbsp;check&nbsp;for&nbsp;dns&nbsp;errors&#34;</span><span class="op" id="8345341">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="keyword" id="8345344">type</span>&nbsp;<span class="ident" id="8345349">DialErrorTest</span>&nbsp;<span class="keyword" id="8345363">struct</span>&nbsp;<span class="op" id="8345370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345373">Net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8345381">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345389">Raddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8345397">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8345405">Pattern</span>&nbsp;<span class="builtintype" id="8345413">string</span><br>
<span class="lineno"></span><span class="op" id="8345420">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="8345423">var</span>&nbsp;<span class="ident" id="8345427">dialErrorTests</span>&nbsp;<span class="op" id="8345442">=</span>&nbsp;<span class="op" id="8345444">[</span><span class="op" id="8345445">]</span><span class="ident" id="8345446">DialErrorTest</span><span class="op" id="8345459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345466">&#34;datakit&#34;</span><span class="op" id="8345475">,</span>&nbsp;<span class="string" id="8345477">&#34;mh/astro/r70&#34;</span><span class="op" id="8345491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345495">&#34;dial&nbsp;datakit&nbsp;mh/astro/r70:&nbsp;unknown&nbsp;network&nbsp;datakit&#34;</span><span class="op" id="8345547">,</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345550">}</span><span class="op" id="8345551">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345558">&#34;tcp&#34;</span><span class="op" id="8345563">,</span>&nbsp;<span class="string" id="8345565">&#34;127.0.0.1:☺&#34;</span><span class="op" id="8345580">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345584">&#34;dial&nbsp;tcp&nbsp;127.0.0.1:☺:&nbsp;unknown&nbsp;port&nbsp;tcp/☺&#34;</span><span class="op" id="8345630">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345633">}</span><span class="op" id="8345634">,</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345641">&#34;tcp&#34;</span><span class="op" id="8345646">,</span>&nbsp;<span class="string" id="8345648">&#34;no-such-name.google.com.:80&#34;</span><span class="op" id="8345677">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345681">&#34;dial&nbsp;tcp&nbsp;no-such-name.google.com.:80:&nbsp;lookup&nbsp;no-such-name.google.com.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8345770">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345773">}</span><span class="op" id="8345774">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345777">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345781">&#34;tcp&#34;</span><span class="op" id="8345786">,</span>&nbsp;<span class="string" id="8345788">&#34;no-such-name.no-such-top-level-domain.:80&#34;</span><span class="op" id="8345831">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345835">&#34;dial&nbsp;tcp&nbsp;no-such-name.no-such-top-level-domain.:80:&nbsp;lookup&nbsp;no-such-name.no-such-top-level-domain.(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)&#34;</span><span class="op" id="8345952">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345955">}</span><span class="op" id="8345956">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8345959">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345963">&#34;tcp&#34;</span><span class="op" id="8345968">,</span>&nbsp;<span class="string" id="8345970">&#34;no-such-name:80&#34;</span><span class="op" id="8345987">,</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8345991">`dial&nbsp;tcp&nbsp;no-such-name:80:&nbsp;lookup&nbsp;no-such-name\.(.*\.)?(&nbsp;on&nbsp;.*)?:&nbsp;no&nbsp;(.*)`</span><span class="op" id="8346065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346068">}</span><span class="op" id="8346069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346076">&#34;tcp&#34;</span><span class="op" id="8346081">,</span>&nbsp;<span class="string" id="8346083">&#34;mh/astro/r70:http&#34;</span><span class="op" id="8346102">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346106">&#34;dial&nbsp;tcp&nbsp;mh/astro/r70:http:&nbsp;lookup&nbsp;mh/astro/r70:&nbsp;invalid&nbsp;domain&nbsp;name&#34;</span><span class="op" id="8346176">,</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346179">}</span><span class="op" id="8346180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346187">&#34;unix&#34;</span><span class="op" id="8346193">,</span>&nbsp;<span class="string" id="8346195">&#34;/etc/file-not-found&#34;</span><span class="op" id="8346216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346220">&#34;dial&nbsp;unix&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8346278">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346281">}</span><span class="op" id="8346282">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346289">&#34;unix&#34;</span><span class="op" id="8346295">,</span>&nbsp;<span class="string" id="8346297">&#34;/etc/&#34;</span><span class="op" id="8346304">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346308">&#34;dial&nbsp;unix&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8346396">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346399">}</span><span class="op" id="8346400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346403">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346407">&#34;unixpacket&#34;</span><span class="op" id="8346419">,</span>&nbsp;<span class="string" id="8346421">&#34;/etc/file-not-found&#34;</span><span class="op" id="8346442">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346446">&#34;dial&nbsp;unixpacket&nbsp;/etc/file-not-found:&nbsp;no&nbsp;such&nbsp;file&nbsp;or&nbsp;directory&#34;</span><span class="op" id="8346510">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346513">}</span><span class="op" id="8346514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346521">&#34;unixpacket&#34;</span><span class="op" id="8346533">,</span>&nbsp;<span class="string" id="8346535">&#34;/etc/&#34;</span><span class="op" id="8346542">,</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8346546">&#34;dial&nbsp;unixpacket&nbsp;/etc/:&nbsp;(permission&nbsp;denied|socket&nbsp;operation&nbsp;on&nbsp;non-socket|connection&nbsp;refused)&#34;</span><span class="op" id="8346640">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346643">}</span><span class="op" id="8346644">,</span><br>
<span class="lineno"></span><span class="op" id="8346646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8346649">var</span>&nbsp;<span class="ident" id="8346653">duplicateErrorPattern</span>&nbsp;<span class="op" id="8346675">=</span>&nbsp;<span class="string" id="8346677">`dial&nbsp;(.*)&nbsp;dial&nbsp;(.*)`</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="8346700">func</span>&nbsp;<span class="ident" id="8346705">TestDialError</span><span class="op" id="8346718">(</span><span class="ident" id="8346719">t</span>&nbsp;<span class="op" id="8346721">*</span><span class="ident" id="8346722">testing</span><span class="op" id="8346729">.</span><span class="ident" id="8346730">T</span><span class="op" id="8346731">)</span>&nbsp;<span class="op" id="8346733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8346736">if</span>&nbsp;<span class="op" id="8346739">!</span><span class="op" id="8346740">*</span><span class="ident" id="8346741">runErrorTest</span>&nbsp;<span class="op" id="8346754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8346758">t</span><span class="op" id="8346759">.</span><span class="ident" id="8346760">Logf</span><span class="op" id="8346764">(</span><span class="string" id="8346765">&#34;test&nbsp;disabled;&nbsp;use&nbsp;-run_error_test&nbsp;to&nbsp;enable&#34;</span><span class="op" id="8346811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8346815">return</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346823">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8346826">for</span>&nbsp;<span class="ident" id="8346830">i</span><span class="op" id="8346831">,</span>&nbsp;<span class="ident" id="8346833">tt</span>&nbsp;<span class="op" id="8346836">:=</span>&nbsp;<span class="keyword" id="8346839">range</span>&nbsp;<span class="ident" id="8346845">dialErrorTests</span>&nbsp;<span class="op" id="8346860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8346864">c</span><span class="op" id="8346865">,</span>&nbsp;<span class="ident" id="8346867">err</span>&nbsp;<span class="op" id="8346871">:=</span>&nbsp;<span class="ident" id="8346874">Dial</span><span class="op" id="8346878">(</span><span class="ident" id="8346879">tt</span><span class="op" id="8346881">.</span><span class="ident" id="8346882">Net</span><span class="op" id="8346885">,</span>&nbsp;<span class="ident" id="8346887">tt</span><span class="op" id="8346889">.</span><span class="ident" id="8346890">Raddr</span><span class="op" id="8346895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8346899">if</span>&nbsp;<span class="ident" id="8346902">c</span>&nbsp;<span class="op" id="8346904">!=</span>&nbsp;<span class="ident" id="8346907">nil</span>&nbsp;<span class="op" id="8346911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8346916">c</span><span class="op" id="8346917">.</span><span class="ident" id="8346918">Close</span><span class="op" id="8346923">(</span><span class="op" id="8346924">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8346928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8346932">if</span>&nbsp;<span class="ident" id="8346935">err</span>&nbsp;<span class="op" id="8346939">==</span>&nbsp;<span class="ident" id="8346942">nil</span>&nbsp;<span class="op" id="8346946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8346951">t</span><span class="op" id="8346952">.</span><span class="ident" id="8346953">Errorf</span><span class="op" id="8346959">(</span><span class="string" id="8346960">&#34;#%d:&nbsp;nil&nbsp;error,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8346996">,</span>&nbsp;<span class="ident" id="8346998">i</span><span class="op" id="8346999">,</span>&nbsp;<span class="ident" id="8347001">tt</span><span class="op" id="8347003">.</span><span class="ident" id="8347004">Pattern</span><span class="op" id="8347011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347016">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347027">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347031">s</span>&nbsp;<span class="op" id="8347033">:=</span>&nbsp;<span class="ident" id="8347036">err</span><span class="op" id="8347039">.</span><span class="ident" id="8347040">Error</span><span class="op" id="8347045">(</span><span class="op" id="8347046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347050">match</span><span class="op" id="8347055">,</span>&nbsp;<span class="ident" id="8347057">_</span>&nbsp;<span class="op" id="8347059">:=</span>&nbsp;<span class="ident" id="8347062">regexp</span><span class="op" id="8347068">.</span><span class="ident" id="8347069">MatchString</span><span class="op" id="8347080">(</span><span class="ident" id="8347081">tt</span><span class="op" id="8347083">.</span><span class="ident" id="8347084">Pattern</span><span class="op" id="8347091">,</span>&nbsp;<span class="ident" id="8347093">s</span><span class="op" id="8347094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347098">if</span>&nbsp;<span class="op" id="8347101">!</span><span class="ident" id="8347102">match</span>&nbsp;<span class="op" id="8347108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347113">t</span><span class="op" id="8347114">.</span><span class="ident" id="8347115">Errorf</span><span class="op" id="8347121">(</span><span class="string" id="8347122">&#34;#%d:&nbsp;%q,&nbsp;want&nbsp;match&nbsp;for&nbsp;%#q&#34;</span><span class="op" id="8347151">,</span>&nbsp;<span class="ident" id="8347153">i</span><span class="op" id="8347154">,</span>&nbsp;<span class="ident" id="8347156">s</span><span class="op" id="8347157">,</span>&nbsp;<span class="ident" id="8347159">tt</span><span class="op" id="8347161">.</span><span class="ident" id="8347162">Pattern</span><span class="op" id="8347169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347173">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347177">match</span><span class="op" id="8347182">,</span>&nbsp;<span class="ident" id="8347184">_</span>&nbsp;<span class="op" id="8347186">=</span>&nbsp;<span class="ident" id="8347188">regexp</span><span class="op" id="8347194">.</span><span class="ident" id="8347195">MatchString</span><span class="op" id="8347206">(</span><span class="ident" id="8347207">duplicateErrorPattern</span><span class="op" id="8347228">,</span>&nbsp;<span class="ident" id="8347230">s</span><span class="op" id="8347231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347235">if</span>&nbsp;<span class="ident" id="8347238">match</span>&nbsp;<span class="op" id="8347244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347249">t</span><span class="op" id="8347250">.</span><span class="ident" id="8347251">Errorf</span><span class="op" id="8347257">(</span><span class="string" id="8347258">&#34;#%d:&nbsp;%q,&nbsp;duplicate&nbsp;error&nbsp;return&nbsp;from&nbsp;Dial&#34;</span><span class="op" id="8347301">,</span>&nbsp;<span class="ident" id="8347303">i</span><span class="op" id="8347304">,</span>&nbsp;<span class="ident" id="8347306">s</span><span class="op" id="8347307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347314">}</span><br>
<span class="lineno">240</span><span class="op" id="8347316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8347319">var</span>&nbsp;<span class="ident" id="8347323">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8347352">=</span>&nbsp;<span class="op" id="8347354">[</span><span class="op" id="8347355">]</span><span class="keyword" id="8347356">struct</span>&nbsp;<span class="op" id="8347363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347366">net</span>&nbsp;&nbsp;<span class="builtintype" id="8347371">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347379">addr</span>&nbsp;<span class="builtintype" id="8347384">string</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347392">err</span>&nbsp;&nbsp;<span class="builtintype" id="8347397">error</span><br>
<span class="lineno"></span><span class="op" id="8347403">}</span><span class="op" id="8347404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347407">{</span><span class="string" id="8347408">&#34;foo&#34;</span><span class="op" id="8347413">,</span>&nbsp;<span class="string" id="8347415">&#34;bar&#34;</span><span class="op" id="8347420">,</span>&nbsp;<span class="op" id="8347422">&amp;</span><span class="ident" id="8347423">OpError</span><span class="op" id="8347430">{</span><span class="ident" id="8347431">Op</span><span class="op" id="8347433">:</span>&nbsp;<span class="string" id="8347435">&#34;dial&#34;</span><span class="op" id="8347441">,</span>&nbsp;<span class="ident" id="8347443">Net</span><span class="op" id="8347446">:</span>&nbsp;<span class="string" id="8347448">&#34;foo&#34;</span><span class="op" id="8347453">,</span>&nbsp;<span class="ident" id="8347455">Addr</span><span class="op" id="8347459">:</span>&nbsp;<span class="ident" id="8347461">nil</span><span class="op" id="8347464">,</span>&nbsp;<span class="ident" id="8347466">Err</span><span class="op" id="8347469">:</span>&nbsp;<span class="ident" id="8347471">UnknownNetworkError</span><span class="op" id="8347490">(</span><span class="string" id="8347491">&#34;foo&#34;</span><span class="op" id="8347496">)</span><span class="op" id="8347497">}</span><span class="op" id="8347498">}</span><span class="op" id="8347499">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347502">{</span><span class="string" id="8347503">&#34;baz&#34;</span><span class="op" id="8347508">,</span>&nbsp;<span class="string" id="8347510">&#34;&#34;</span><span class="op" id="8347512">,</span>&nbsp;<span class="op" id="8347514">&amp;</span><span class="ident" id="8347515">OpError</span><span class="op" id="8347522">{</span><span class="ident" id="8347523">Op</span><span class="op" id="8347525">:</span>&nbsp;<span class="string" id="8347527">&#34;listen&#34;</span><span class="op" id="8347535">,</span>&nbsp;<span class="ident" id="8347537">Net</span><span class="op" id="8347540">:</span>&nbsp;<span class="string" id="8347542">&#34;baz&#34;</span><span class="op" id="8347547">,</span>&nbsp;<span class="ident" id="8347549">Addr</span><span class="op" id="8347553">:</span>&nbsp;<span class="ident" id="8347555">nil</span><span class="op" id="8347558">,</span>&nbsp;<span class="ident" id="8347560">Err</span><span class="op" id="8347563">:</span>&nbsp;<span class="ident" id="8347565">UnknownNetworkError</span><span class="op" id="8347584">(</span><span class="string" id="8347585">&#34;baz&#34;</span><span class="op" id="8347590">)</span><span class="op" id="8347591">}</span><span class="op" id="8347592">}</span><span class="op" id="8347593">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347596">{</span><span class="string" id="8347597">&#34;tcp&#34;</span><span class="op" id="8347602">,</span>&nbsp;<span class="string" id="8347604">&#34;&#34;</span><span class="op" id="8347606">,</span>&nbsp;<span class="op" id="8347608">&amp;</span><span class="ident" id="8347609">OpError</span><span class="op" id="8347616">{</span><span class="ident" id="8347617">Op</span><span class="op" id="8347619">:</span>&nbsp;<span class="string" id="8347621">&#34;dial&#34;</span><span class="op" id="8347627">,</span>&nbsp;<span class="ident" id="8347629">Net</span><span class="op" id="8347632">:</span>&nbsp;<span class="string" id="8347634">&#34;tcp&#34;</span><span class="op" id="8347639">,</span>&nbsp;<span class="ident" id="8347641">Addr</span><span class="op" id="8347645">:</span>&nbsp;<span class="ident" id="8347647">nil</span><span class="op" id="8347650">,</span>&nbsp;<span class="ident" id="8347652">Err</span><span class="op" id="8347655">:</span>&nbsp;<span class="ident" id="8347657">errMissingAddress</span><span class="op" id="8347674">}</span><span class="op" id="8347675">}</span><span class="op" id="8347676">,</span><br>
<span class="lineno">250</span><span class="op" id="8347678">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8347681">func</span>&nbsp;<span class="ident" id="8347686">TestInvalidDialAndListenArgs</span><span class="op" id="8347714">(</span><span class="ident" id="8347715">t</span>&nbsp;<span class="op" id="8347717">*</span><span class="ident" id="8347718">testing</span><span class="op" id="8347725">.</span><span class="ident" id="8347726">T</span><span class="op" id="8347727">)</span>&nbsp;<span class="op" id="8347729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347732">for</span>&nbsp;<span class="ident" id="8347736">_</span><span class="op" id="8347737">,</span>&nbsp;<span class="ident" id="8347739">tt</span>&nbsp;<span class="op" id="8347742">:=</span>&nbsp;<span class="keyword" id="8347745">range</span>&nbsp;<span class="ident" id="8347751">invalidDialAndListenArgTests</span>&nbsp;<span class="op" id="8347780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347784">var</span>&nbsp;<span class="ident" id="8347788">err</span>&nbsp;<span class="builtintype" id="8347792">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347800">switch</span>&nbsp;<span class="ident" id="8347807">tt</span><span class="op" id="8347809">.</span><span class="ident" id="8347810">err</span><span class="op" id="8347813">.</span><span class="op" id="8347814">(</span><span class="op" id="8347815">*</span><span class="ident" id="8347816">OpError</span><span class="op" id="8347823">)</span><span class="op" id="8347824">.</span><span class="ident" id="8347825">Op</span>&nbsp;<span class="op" id="8347828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347832">case</span>&nbsp;<span class="string" id="8347837">&#34;dial&#34;</span><span class="op" id="8347843">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347848">_</span><span class="op" id="8347849">,</span>&nbsp;<span class="ident" id="8347851">err</span>&nbsp;<span class="op" id="8347855">=</span>&nbsp;<span class="ident" id="8347857">Dial</span><span class="op" id="8347861">(</span><span class="ident" id="8347862">tt</span><span class="op" id="8347864">.</span><span class="ident" id="8347865">net</span><span class="op" id="8347868">,</span>&nbsp;<span class="ident" id="8347870">tt</span><span class="op" id="8347872">.</span><span class="ident" id="8347873">addr</span><span class="op" id="8347877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347881">case</span>&nbsp;<span class="string" id="8347886">&#34;listen&#34;</span><span class="op" id="8347894">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347899">_</span><span class="op" id="8347900">,</span>&nbsp;<span class="ident" id="8347902">err</span>&nbsp;<span class="op" id="8347906">=</span>&nbsp;<span class="ident" id="8347908">Listen</span><span class="op" id="8347914">(</span><span class="ident" id="8347915">tt</span><span class="op" id="8347917">.</span><span class="ident" id="8347918">net</span><span class="op" id="8347921">,</span>&nbsp;<span class="ident" id="8347923">tt</span><span class="op" id="8347925">.</span><span class="ident" id="8347926">addr</span><span class="op" id="8347930">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8347934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8347938">if</span>&nbsp;<span class="op" id="8347941">!</span><span class="ident" id="8347942">reflect</span><span class="op" id="8347949">.</span><span class="ident" id="8347950">DeepEqual</span><span class="op" id="8347959">(</span><span class="ident" id="8347960">tt</span><span class="op" id="8347962">.</span><span class="ident" id="8347963">err</span><span class="op" id="8347966">,</span>&nbsp;<span class="ident" id="8347968">err</span><span class="op" id="8347971">)</span>&nbsp;<span class="op" id="8347973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8347978">t</span><span class="op" id="8347979">.</span><span class="ident" id="8347980">Fatalf</span><span class="op" id="8347986">(</span><span class="string" id="8347987">&#34;got&nbsp;%#v;&nbsp;expected&nbsp;%#v&#34;</span><span class="op" id="8348010">,</span>&nbsp;<span class="ident" id="8348012">err</span><span class="op" id="8348015">,</span>&nbsp;<span class="ident" id="8348017">tt</span><span class="op" id="8348019">.</span><span class="ident" id="8348020">err</span><span class="op" id="8348023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348030">}</span><br>
<span class="lineno">265</span><span class="op" id="8348032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8348035">func</span>&nbsp;<span class="ident" id="8348040">TestDialTimeoutFDLeak</span><span class="op" id="8348061">(</span><span class="ident" id="8348062">t</span>&nbsp;<span class="op" id="8348064">*</span><span class="ident" id="8348065">testing</span><span class="op" id="8348072">.</span><span class="ident" id="8348073">T</span><span class="op" id="8348074">)</span>&nbsp;<span class="op" id="8348076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348079">if</span>&nbsp;<span class="ident" id="8348082">runtime</span><span class="op" id="8348089">.</span><span class="ident" id="8348090">GOOS</span>&nbsp;<span class="op" id="8348095">!=</span>&nbsp;<span class="string" id="8348098">&#34;linux&#34;</span>&nbsp;<span class="op" id="8348106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8348110">//&nbsp;TODO(bradfitz):&nbsp;test&nbsp;on&nbsp;other&nbsp;platforms</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348155">t</span><span class="op" id="8348156">.</span><span class="ident" id="8348157">Skipf</span><span class="op" id="8348162">(</span><span class="string" id="8348163">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8348184">,</span>&nbsp;<span class="ident" id="8348186">runtime</span><span class="op" id="8348193">.</span><span class="ident" id="8348194">GOOS</span><span class="op" id="8348198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348205">ln</span>&nbsp;<span class="op" id="8348208">:=</span>&nbsp;<span class="ident" id="8348211">newLocalListener</span><span class="op" id="8348227">(</span><span class="ident" id="8348228">t</span><span class="op" id="8348229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348232">defer</span>&nbsp;<span class="ident" id="8348238">ln</span><span class="op" id="8348240">.</span><span class="ident" id="8348241">Close</span><span class="op" id="8348246">(</span><span class="op" id="8348247">)</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348251">type</span>&nbsp;<span class="ident" id="8348256">connErr</span>&nbsp;<span class="keyword" id="8348264">struct</span>&nbsp;<span class="op" id="8348271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348275">conn</span>&nbsp;<span class="ident" id="8348280">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348287">err</span>&nbsp;&nbsp;<span class="builtintype" id="8348292">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348299">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348302">dials</span>&nbsp;<span class="op" id="8348308">:=</span>&nbsp;<span class="ident" id="8348311">listenerBacklog</span>&nbsp;<span class="op" id="8348327">+</span>&nbsp;<span class="num" id="8348329">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8348334">//&nbsp;used&nbsp;to&nbsp;be&nbsp;listenerBacklog&nbsp;+&nbsp;5,&nbsp;but&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;unreliable,&nbsp;issue&nbsp;4384.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348414">maxGoodConnect</span>&nbsp;<span class="op" id="8348429">:=</span>&nbsp;<span class="ident" id="8348432">listenerBacklog</span>&nbsp;<span class="op" id="8348448">+</span>&nbsp;<span class="ident" id="8348450">runtime</span><span class="op" id="8348457">.</span><span class="ident" id="8348458">NumCPU</span><span class="op" id="8348464">(</span><span class="op" id="8348465">)</span><span class="op" id="8348466">*</span><span class="num" id="8348467">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348471">resc</span>&nbsp;<span class="op" id="8348476">:=</span>&nbsp;<span class="builtinfunc" id="8348479">make</span><span class="op" id="8348483">(</span><span class="keyword" id="8348484">chan</span>&nbsp;<span class="ident" id="8348489">connErr</span><span class="op" id="8348496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348499">for</span>&nbsp;<span class="ident" id="8348503">i</span>&nbsp;<span class="op" id="8348505">:=</span>&nbsp;<span class="num" id="8348508">0</span><span class="op" id="8348509">;</span>&nbsp;<span class="ident" id="8348511">i</span>&nbsp;<span class="op" id="8348513">&lt;</span>&nbsp;<span class="ident" id="8348515">dials</span><span class="op" id="8348520">;</span>&nbsp;<span class="ident" id="8348522">i</span><span class="op" id="8348523">++</span>&nbsp;<span class="op" id="8348526">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348530">go</span>&nbsp;<span class="keyword" id="8348533">func</span><span class="op" id="8348537">(</span><span class="op" id="8348538">)</span>&nbsp;<span class="op" id="8348540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348545">conn</span><span class="op" id="8348549">,</span>&nbsp;<span class="ident" id="8348551">err</span>&nbsp;<span class="op" id="8348555">:=</span>&nbsp;<span class="ident" id="8348558">DialTimeout</span><span class="op" id="8348569">(</span><span class="string" id="8348570">&#34;tcp&#34;</span><span class="op" id="8348575">,</span>&nbsp;<span class="ident" id="8348577">ln</span><span class="op" id="8348579">.</span><span class="ident" id="8348580">Addr</span><span class="op" id="8348584">(</span><span class="op" id="8348585">)</span><span class="op" id="8348586">.</span><span class="ident" id="8348587">String</span><span class="op" id="8348593">(</span><span class="op" id="8348594">)</span><span class="op" id="8348595">,</span>&nbsp;<span class="num" id="8348597">500</span><span class="op" id="8348600">*</span><span class="ident" id="8348601">time</span><span class="op" id="8348605">.</span><span class="ident" id="8348606">Millisecond</span><span class="op" id="8348617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348622">resc</span>&nbsp;<span class="op" id="8348627">&lt;-</span>&nbsp;<span class="ident" id="8348630">connErr</span><span class="op" id="8348637">{</span><span class="ident" id="8348638">conn</span><span class="op" id="8348642">,</span>&nbsp;<span class="ident" id="8348644">err</span><span class="op" id="8348647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348651">}</span><span class="op" id="8348652">(</span><span class="op" id="8348653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348656">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348660">var</span>&nbsp;<span class="ident" id="8348664">firstErr</span>&nbsp;<span class="builtintype" id="8348673">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348681">var</span>&nbsp;<span class="ident" id="8348685">ngood</span>&nbsp;<span class="builtintype" id="8348691">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348696">var</span>&nbsp;<span class="ident" id="8348700">toClose</span>&nbsp;<span class="op" id="8348708">[</span><span class="op" id="8348709">]</span><span class="ident" id="8348710">io</span><span class="op" id="8348712">.</span><span class="ident" id="8348713">Closer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348721">for</span>&nbsp;<span class="ident" id="8348725">i</span>&nbsp;<span class="op" id="8348727">:=</span>&nbsp;<span class="num" id="8348730">0</span><span class="op" id="8348731">;</span>&nbsp;<span class="ident" id="8348733">i</span>&nbsp;<span class="op" id="8348735">&lt;</span>&nbsp;<span class="ident" id="8348737">dials</span><span class="op" id="8348742">;</span>&nbsp;<span class="ident" id="8348744">i</span><span class="op" id="8348745">++</span>&nbsp;<span class="op" id="8348748">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348752">ce</span>&nbsp;<span class="op" id="8348755">:=</span>&nbsp;<span class="op" id="8348758">&lt;-</span><span class="ident" id="8348760">resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348767">if</span>&nbsp;<span class="ident" id="8348770">ce</span><span class="op" id="8348772">.</span><span class="ident" id="8348773">err</span>&nbsp;<span class="op" id="8348777">==</span>&nbsp;<span class="ident" id="8348780">nil</span>&nbsp;<span class="op" id="8348784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348789">ngood</span><span class="op" id="8348794">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348800">if</span>&nbsp;<span class="ident" id="8348803">ngood</span>&nbsp;<span class="op" id="8348809">&gt;</span>&nbsp;<span class="ident" id="8348811">maxGoodConnect</span>&nbsp;<span class="op" id="8348826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348832">t</span><span class="op" id="8348833">.</span><span class="ident" id="8348834">Errorf</span><span class="op" id="8348840">(</span><span class="string" id="8348841">&#34;%d&nbsp;good&nbsp;connects;&nbsp;expected&nbsp;at&nbsp;most&nbsp;%d&#34;</span><span class="op" id="8348880">,</span>&nbsp;<span class="ident" id="8348882">ngood</span><span class="op" id="8348887">,</span>&nbsp;<span class="ident" id="8348889">maxGoodConnect</span><span class="op" id="8348903">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348913">toClose</span>&nbsp;<span class="op" id="8348921">=</span>&nbsp;<span class="builtinfunc" id="8348923">append</span><span class="op" id="8348929">(</span><span class="ident" id="8348930">toClose</span><span class="op" id="8348937">,</span>&nbsp;<span class="ident" id="8348939">ce</span><span class="op" id="8348941">.</span><span class="ident" id="8348942">conn</span><span class="op" id="8348946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348951">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8348962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8348966">err</span>&nbsp;<span class="op" id="8348970">:=</span>&nbsp;<span class="ident" id="8348973">ce</span><span class="op" id="8348975">.</span><span class="ident" id="8348976">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8348982">if</span>&nbsp;<span class="ident" id="8348985">firstErr</span>&nbsp;<span class="op" id="8348994">==</span>&nbsp;<span class="string" id="8348997">&#34;&#34;</span>&nbsp;<span class="op" id="8349000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349005">firstErr</span>&nbsp;<span class="op" id="8349014">=</span>&nbsp;<span class="ident" id="8349016">err</span><span class="op" id="8349019">.</span><span class="ident" id="8349020">Error</span><span class="op" id="8349025">(</span><span class="op" id="8349026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349030">}</span>&nbsp;<span class="keyword" id="8349032">else</span>&nbsp;<span class="keyword" id="8349037">if</span>&nbsp;<span class="ident" id="8349040">err</span><span class="op" id="8349043">.</span><span class="ident" id="8349044">Error</span><span class="op" id="8349049">(</span><span class="op" id="8349050">)</span>&nbsp;<span class="op" id="8349052">!=</span>&nbsp;<span class="ident" id="8349055">firstErr</span>&nbsp;<span class="op" id="8349064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349069">t</span><span class="op" id="8349070">.</span><span class="ident" id="8349071">Fatalf</span><span class="op" id="8349077">(</span><span class="string" id="8349078">&#34;inconsistent&nbsp;error&nbsp;messages:&nbsp;first&nbsp;was&nbsp;%q,&nbsp;then&nbsp;later&nbsp;%q&#34;</span><span class="op" id="8349136">,</span>&nbsp;<span class="ident" id="8349138">firstErr</span><span class="op" id="8349146">,</span>&nbsp;<span class="ident" id="8349148">err</span><span class="op" id="8349151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349155">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349158">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349161">for</span>&nbsp;<span class="ident" id="8349165">_</span><span class="op" id="8349166">,</span>&nbsp;<span class="ident" id="8349168">c</span>&nbsp;<span class="op" id="8349170">:=</span>&nbsp;<span class="keyword" id="8349173">range</span>&nbsp;<span class="ident" id="8349179">toClose</span>&nbsp;<span class="op" id="8349187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349191">c</span><span class="op" id="8349192">.</span><span class="ident" id="8349193">Close</span><span class="op" id="8349198">(</span><span class="op" id="8349199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349205">for</span>&nbsp;<span class="ident" id="8349209">i</span>&nbsp;<span class="op" id="8349211">:=</span>&nbsp;<span class="num" id="8349214">0</span><span class="op" id="8349215">;</span>&nbsp;<span class="ident" id="8349217">i</span>&nbsp;<span class="op" id="8349219">&lt;</span>&nbsp;<span class="num" id="8349221">100</span><span class="op" id="8349224">;</span>&nbsp;<span class="ident" id="8349226">i</span><span class="op" id="8349227">++</span>&nbsp;<span class="op" id="8349230">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349234">if</span>&nbsp;<span class="ident" id="8349237">got</span>&nbsp;<span class="op" id="8349241">:=</span>&nbsp;<span class="ident" id="8349244">numFD</span><span class="op" id="8349249">(</span><span class="op" id="8349250">)</span><span class="op" id="8349251">;</span>&nbsp;<span class="ident" id="8349253">got</span>&nbsp;<span class="op" id="8349257">&lt;</span>&nbsp;<span class="ident" id="8349259">dials</span>&nbsp;<span class="op" id="8349265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8349270">//&nbsp;Test&nbsp;passes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349302">time</span><span class="op" id="8349306">.</span><span class="ident" id="8349307">Sleep</span><span class="op" id="8349312">(</span><span class="num" id="8349313">10</span>&nbsp;<span class="op" id="8349316">*</span>&nbsp;<span class="ident" id="8349318">time</span><span class="op" id="8349322">.</span><span class="ident" id="8349323">Millisecond</span><span class="op" id="8349334">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349340">if</span>&nbsp;<span class="ident" id="8349343">got</span>&nbsp;<span class="op" id="8349347">:=</span>&nbsp;<span class="ident" id="8349350">numFD</span><span class="op" id="8349355">(</span><span class="op" id="8349356">)</span><span class="op" id="8349357">;</span>&nbsp;<span class="ident" id="8349359">got</span>&nbsp;<span class="op" id="8349363">&gt;=</span>&nbsp;<span class="ident" id="8349366">dials</span>&nbsp;<span class="op" id="8349372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349376">t</span><span class="op" id="8349377">.</span><span class="ident" id="8349378">Errorf</span><span class="op" id="8349384">(</span><span class="string" id="8349385">&#34;num&nbsp;fds&nbsp;after&nbsp;%d&nbsp;timeouts&nbsp;=&nbsp;%d;&nbsp;want&nbsp;&lt;%d&#34;</span><span class="op" id="8349427">,</span>&nbsp;<span class="ident" id="8349429">dials</span><span class="op" id="8349434">,</span>&nbsp;<span class="ident" id="8349436">got</span><span class="op" id="8349439">,</span>&nbsp;<span class="ident" id="8349441">dials</span><span class="op" id="8349446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349449">}</span><br>
<span class="lineno"></span><span class="op" id="8349451">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="8349454">func</span>&nbsp;<span class="ident" id="8349459">numTCP</span><span class="op" id="8349465">(</span><span class="op" id="8349466">)</span>&nbsp;<span class="op" id="8349468">(</span><span class="ident" id="8349469">ntcp</span><span class="op" id="8349473">,</span>&nbsp;<span class="ident" id="8349475">nopen</span><span class="op" id="8349480">,</span>&nbsp;<span class="ident" id="8349482">nclose</span>&nbsp;<span class="builtintype" id="8349489">int</span><span class="op" id="8349492">,</span>&nbsp;<span class="ident" id="8349494">err</span>&nbsp;<span class="builtintype" id="8349498">error</span><span class="op" id="8349503">)</span>&nbsp;<span class="op" id="8349505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349508">lsof</span><span class="op" id="8349512">,</span>&nbsp;<span class="ident" id="8349514">err</span>&nbsp;<span class="op" id="8349518">:=</span>&nbsp;<span class="ident" id="8349521">exec</span><span class="op" id="8349525">.</span><span class="ident" id="8349526">Command</span><span class="op" id="8349533">(</span><span class="string" id="8349534">&#34;lsof&#34;</span><span class="op" id="8349540">,</span>&nbsp;<span class="string" id="8349542">&#34;-n&#34;</span><span class="op" id="8349546">,</span>&nbsp;<span class="string" id="8349548">&#34;-p&#34;</span><span class="op" id="8349552">,</span>&nbsp;<span class="ident" id="8349554">strconv</span><span class="op" id="8349561">.</span><span class="ident" id="8349562">Itoa</span><span class="op" id="8349566">(</span><span class="ident" id="8349567">os</span><span class="op" id="8349569">.</span><span class="ident" id="8349570">Getpid</span><span class="op" id="8349576">(</span><span class="op" id="8349577">)</span><span class="op" id="8349578">)</span><span class="op" id="8349579">)</span><span class="op" id="8349580">.</span><span class="ident" id="8349581">Output</span><span class="op" id="8349587">(</span><span class="op" id="8349588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349591">if</span>&nbsp;<span class="ident" id="8349594">err</span>&nbsp;<span class="op" id="8349598">!=</span>&nbsp;<span class="ident" id="8349601">nil</span>&nbsp;<span class="op" id="8349605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349609">return</span>&nbsp;<span class="num" id="8349616">0</span><span class="op" id="8349617">,</span>&nbsp;<span class="num" id="8349619">0</span><span class="op" id="8349620">,</span>&nbsp;<span class="num" id="8349622">0</span><span class="op" id="8349623">,</span>&nbsp;<span class="ident" id="8349625">err</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349633">ntcp</span>&nbsp;<span class="op" id="8349638">+=</span>&nbsp;<span class="ident" id="8349641">bytes</span><span class="op" id="8349646">.</span><span class="ident" id="8349647">Count</span><span class="op" id="8349652">(</span><span class="ident" id="8349653">lsof</span><span class="op" id="8349657">,</span>&nbsp;<span class="op" id="8349659">[</span><span class="op" id="8349660">]</span><span class="builtintype" id="8349661">byte</span><span class="op" id="8349665">(</span><span class="string" id="8349666">&#34;TCP&#34;</span><span class="op" id="8349671">)</span><span class="op" id="8349672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349675">for</span>&nbsp;<span class="ident" id="8349679">_</span><span class="op" id="8349680">,</span>&nbsp;<span class="ident" id="8349682">state</span>&nbsp;<span class="op" id="8349688">:=</span>&nbsp;<span class="keyword" id="8349691">range</span>&nbsp;<span class="op" id="8349697">[</span><span class="op" id="8349698">]</span><span class="builtintype" id="8349699">string</span><span class="op" id="8349705">{</span><span class="string" id="8349706">&#34;LISTEN&#34;</span><span class="op" id="8349714">,</span>&nbsp;<span class="string" id="8349716">&#34;SYN_SENT&#34;</span><span class="op" id="8349726">,</span>&nbsp;<span class="string" id="8349728">&#34;SYN_RECEIVED&#34;</span><span class="op" id="8349742">,</span>&nbsp;<span class="string" id="8349744">&#34;ESTABLISHED&#34;</span><span class="op" id="8349757">}</span>&nbsp;<span class="op" id="8349759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349763">nopen</span>&nbsp;<span class="op" id="8349769">+=</span>&nbsp;<span class="ident" id="8349772">bytes</span><span class="op" id="8349777">.</span><span class="ident" id="8349778">Count</span><span class="op" id="8349783">(</span><span class="ident" id="8349784">lsof</span><span class="op" id="8349788">,</span>&nbsp;<span class="op" id="8349790">[</span><span class="op" id="8349791">]</span><span class="builtintype" id="8349792">byte</span><span class="op" id="8349796">(</span><span class="ident" id="8349797">state</span><span class="op" id="8349802">)</span><span class="op" id="8349803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349806">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349809">for</span>&nbsp;<span class="ident" id="8349813">_</span><span class="op" id="8349814">,</span>&nbsp;<span class="ident" id="8349816">state</span>&nbsp;<span class="op" id="8349822">:=</span>&nbsp;<span class="keyword" id="8349825">range</span>&nbsp;<span class="op" id="8349831">[</span><span class="op" id="8349832">]</span><span class="builtintype" id="8349833">string</span><span class="op" id="8349839">{</span><span class="string" id="8349840">&#34;CLOSED&#34;</span><span class="op" id="8349848">,</span>&nbsp;<span class="string" id="8349850">&#34;CLOSE_WAIT&#34;</span><span class="op" id="8349862">,</span>&nbsp;<span class="string" id="8349864">&#34;LAST_ACK&#34;</span><span class="op" id="8349874">,</span>&nbsp;<span class="string" id="8349876">&#34;FIN_WAIT_1&#34;</span><span class="op" id="8349888">,</span>&nbsp;<span class="string" id="8349890">&#34;FIN_WAIT_2&#34;</span><span class="op" id="8349902">,</span>&nbsp;<span class="string" id="8349904">&#34;CLOSING&#34;</span><span class="op" id="8349913">,</span>&nbsp;<span class="string" id="8349915">&#34;TIME_WAIT&#34;</span><span class="op" id="8349926">}</span>&nbsp;<span class="op" id="8349928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8349932">nclose</span>&nbsp;<span class="op" id="8349939">+=</span>&nbsp;<span class="ident" id="8349942">bytes</span><span class="op" id="8349947">.</span><span class="ident" id="8349948">Count</span><span class="op" id="8349953">(</span><span class="ident" id="8349954">lsof</span><span class="op" id="8349958">,</span>&nbsp;<span class="op" id="8349960">[</span><span class="op" id="8349961">]</span><span class="builtintype" id="8349962">byte</span><span class="op" id="8349966">(</span><span class="ident" id="8349967">state</span><span class="op" id="8349972">)</span><span class="op" id="8349973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8349976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8349979">return</span>&nbsp;<span class="ident" id="8349986">ntcp</span><span class="op" id="8349990">,</span>&nbsp;<span class="ident" id="8349992">nopen</span><span class="op" id="8349997">,</span>&nbsp;<span class="ident" id="8349999">nclose</span><span class="op" id="8350005">,</span>&nbsp;<span class="ident" id="8350007">nil</span><br>
<span class="lineno"></span><span class="op" id="8350011">}</span><br>
<span class="lineno">340</span><br>
<span class="lineno"></span><span class="keyword" id="8350014">func</span>&nbsp;<span class="ident" id="8350019">TestDialMultiFDLeak</span><span class="op" id="8350038">(</span><span class="ident" id="8350039">t</span>&nbsp;<span class="op" id="8350041">*</span><span class="ident" id="8350042">testing</span><span class="op" id="8350049">.</span><span class="ident" id="8350050">T</span><span class="op" id="8350051">)</span>&nbsp;<span class="op" id="8350053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350056">t</span><span class="op" id="8350057">.</span><span class="ident" id="8350058">Skip</span><span class="op" id="8350062">(</span><span class="string" id="8350063">&#34;flaky&nbsp;test&nbsp;-&nbsp;golang.org/issue/8764&#34;</span><span class="op" id="8350099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350103">if</span>&nbsp;<span class="op" id="8350106">!</span><span class="ident" id="8350107">supportsIPv4</span>&nbsp;<span class="op" id="8350120">||</span>&nbsp;<span class="op" id="8350123">!</span><span class="ident" id="8350124">supportsIPv6</span>&nbsp;<span class="op" id="8350137">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350141">t</span><span class="op" id="8350142">.</span><span class="ident" id="8350143">Skip</span><span class="op" id="8350147">(</span><span class="string" id="8350148">&#34;neither&nbsp;ipv4&nbsp;nor&nbsp;ipv6&nbsp;is&nbsp;supported&#34;</span><span class="op" id="8350184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350191">halfDeadServer</span>&nbsp;<span class="op" id="8350206">:=</span>&nbsp;<span class="keyword" id="8350209">func</span><span class="op" id="8350213">(</span><span class="ident" id="8350214">dss</span>&nbsp;<span class="op" id="8350218">*</span><span class="ident" id="8350219">dualStackServer</span><span class="op" id="8350234">,</span>&nbsp;<span class="ident" id="8350236">ln</span>&nbsp;<span class="ident" id="8350239">Listener</span><span class="op" id="8350247">)</span>&nbsp;<span class="op" id="8350249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350253">for</span>&nbsp;<span class="op" id="8350257">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350262">if</span>&nbsp;<span class="ident" id="8350265">c</span><span class="op" id="8350266">,</span>&nbsp;<span class="ident" id="8350268">err</span>&nbsp;<span class="op" id="8350272">:=</span>&nbsp;<span class="ident" id="8350275">ln</span><span class="op" id="8350277">.</span><span class="ident" id="8350278">Accept</span><span class="op" id="8350284">(</span><span class="op" id="8350285">)</span><span class="op" id="8350286">;</span>&nbsp;<span class="ident" id="8350288">err</span>&nbsp;<span class="op" id="8350292">!=</span>&nbsp;<span class="ident" id="8350295">nil</span>&nbsp;<span class="op" id="8350299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350305">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350315">}</span>&nbsp;<span class="keyword" id="8350317">else</span>&nbsp;<span class="op" id="8350322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350328">//&nbsp;It&nbsp;just&nbsp;keeps&nbsp;established</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350361">//&nbsp;connections&nbsp;like&nbsp;a&nbsp;half-dead&nbsp;server</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350404">//&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350417">dss</span><span class="op" id="8350420">.</span><span class="ident" id="8350421">putConn</span><span class="op" id="8350428">(</span><span class="ident" id="8350429">c</span><span class="op" id="8350430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350442">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350445">dss</span><span class="op" id="8350448">,</span>&nbsp;<span class="ident" id="8350450">err</span>&nbsp;<span class="op" id="8350454">:=</span>&nbsp;<span class="ident" id="8350457">newDualStackServer</span><span class="op" id="8350475">(</span><span class="op" id="8350476">[</span><span class="op" id="8350477">]</span><span class="ident" id="8350478">streamListener</span><span class="op" id="8350492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350496">{</span><span class="ident" id="8350497">net</span><span class="op" id="8350500">:</span>&nbsp;<span class="string" id="8350502">&#34;tcp4&#34;</span><span class="op" id="8350508">,</span>&nbsp;<span class="ident" id="8350510">addr</span><span class="op" id="8350514">:</span>&nbsp;<span class="string" id="8350516">&#34;127.0.0.1&#34;</span><span class="op" id="8350527">}</span><span class="op" id="8350528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350532">{</span><span class="ident" id="8350533">net</span><span class="op" id="8350536">:</span>&nbsp;<span class="string" id="8350538">&#34;tcp6&#34;</span><span class="op" id="8350544">,</span>&nbsp;<span class="ident" id="8350546">addr</span><span class="op" id="8350550">:</span>&nbsp;<span class="string" id="8350552">&#34;[::1]&#34;</span><span class="op" id="8350559">}</span><span class="op" id="8350560">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350563">}</span><span class="op" id="8350564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350567">if</span>&nbsp;<span class="ident" id="8350570">err</span>&nbsp;<span class="op" id="8350574">!=</span>&nbsp;<span class="ident" id="8350577">nil</span>&nbsp;<span class="op" id="8350581">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350585">t</span><span class="op" id="8350586">.</span><span class="ident" id="8350587">Fatalf</span><span class="op" id="8350593">(</span><span class="string" id="8350594">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8350625">,</span>&nbsp;<span class="ident" id="8350627">err</span><span class="op" id="8350630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350636">defer</span>&nbsp;<span class="ident" id="8350642">dss</span><span class="op" id="8350645">.</span><span class="ident" id="8350646">teardown</span><span class="op" id="8350654">(</span><span class="op" id="8350655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350658">if</span>&nbsp;<span class="ident" id="8350661">err</span>&nbsp;<span class="op" id="8350665">:=</span>&nbsp;<span class="ident" id="8350668">dss</span><span class="op" id="8350671">.</span><span class="ident" id="8350672">buildup</span><span class="op" id="8350679">(</span><span class="ident" id="8350680">halfDeadServer</span><span class="op" id="8350694">)</span><span class="op" id="8350695">;</span>&nbsp;<span class="ident" id="8350697">err</span>&nbsp;<span class="op" id="8350701">!=</span>&nbsp;<span class="ident" id="8350704">nil</span>&nbsp;<span class="op" id="8350708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350712">t</span><span class="op" id="8350713">.</span><span class="ident" id="8350714">Fatalf</span><span class="op" id="8350720">(</span><span class="string" id="8350721">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8350757">,</span>&nbsp;<span class="ident" id="8350759">err</span><span class="op" id="8350762">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350765">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350769">_</span><span class="op" id="8350770">,</span>&nbsp;<span class="ident" id="8350772">before</span><span class="op" id="8350778">,</span>&nbsp;<span class="ident" id="8350780">_</span><span class="op" id="8350781">,</span>&nbsp;<span class="ident" id="8350783">err</span>&nbsp;<span class="op" id="8350787">:=</span>&nbsp;<span class="ident" id="8350790">numTCP</span><span class="op" id="8350796">(</span><span class="op" id="8350797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350800">if</span>&nbsp;<span class="ident" id="8350803">err</span>&nbsp;<span class="op" id="8350807">!=</span>&nbsp;<span class="ident" id="8350810">nil</span>&nbsp;<span class="op" id="8350814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350818">t</span><span class="op" id="8350819">.</span><span class="ident" id="8350820">Skipf</span><span class="op" id="8350825">(</span><span class="string" id="8350826">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8350876">,</span>&nbsp;<span class="ident" id="8350878">err</span><span class="op" id="8350881">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8350884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8350888">var</span>&nbsp;<span class="ident" id="8350892">wg</span>&nbsp;<span class="ident" id="8350895">sync</span><span class="op" id="8350899">.</span><span class="ident" id="8350900">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350911">portnum</span><span class="op" id="8350918">,</span>&nbsp;<span class="ident" id="8350920">_</span><span class="op" id="8350921">,</span>&nbsp;<span class="ident" id="8350923">_</span>&nbsp;<span class="op" id="8350925">:=</span>&nbsp;<span class="ident" id="8350928">dtoi</span><span class="op" id="8350932">(</span><span class="ident" id="8350933">dss</span><span class="op" id="8350936">.</span><span class="ident" id="8350937">port</span><span class="op" id="8350941">,</span>&nbsp;<span class="num" id="8350943">0</span><span class="op" id="8350944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8350947">ras</span>&nbsp;<span class="op" id="8350951">:=</span>&nbsp;<span class="ident" id="8350954">addrList</span><span class="op" id="8350962">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8350966">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;fail&nbsp;to&nbsp;connect,&nbsp;see&nbsp;RFC&nbsp;6890.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351019">&amp;</span><span class="ident" id="8351020">TCPAddr</span><span class="op" id="8351027">{</span><span class="ident" id="8351028">IP</span><span class="op" id="8351030">:</span>&nbsp;<span class="ident" id="8351032">IPv4</span><span class="op" id="8351036">(</span><span class="num" id="8351037">198</span><span class="op" id="8351040">,</span>&nbsp;<span class="num" id="8351042">18</span><span class="op" id="8351044">,</span>&nbsp;<span class="num" id="8351046">0</span><span class="op" id="8351047">,</span>&nbsp;<span class="num" id="8351049">254</span><span class="op" id="8351052">)</span><span class="op" id="8351053">,</span>&nbsp;<span class="ident" id="8351055">Port</span><span class="op" id="8351059">:</span>&nbsp;<span class="ident" id="8351061">portnum</span><span class="op" id="8351068">}</span><span class="op" id="8351069">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351073">&amp;</span><span class="ident" id="8351074">TCPAddr</span><span class="op" id="8351081">{</span><span class="ident" id="8351082">IP</span><span class="op" id="8351084">:</span>&nbsp;<span class="ident" id="8351086">ParseIP</span><span class="op" id="8351093">(</span><span class="string" id="8351094">&#34;2001:2::254&#34;</span><span class="op" id="8351107">)</span><span class="op" id="8351108">,</span>&nbsp;<span class="ident" id="8351110">Port</span><span class="op" id="8351114">:</span>&nbsp;<span class="ident" id="8351116">portnum</span><span class="op" id="8351123">}</span><span class="op" id="8351124">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8351129">//&nbsp;Winner&nbsp;candidates&nbsp;of&nbsp;this&nbsp;race.</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351166">&amp;</span><span class="ident" id="8351167">TCPAddr</span><span class="op" id="8351174">{</span><span class="ident" id="8351175">IP</span><span class="op" id="8351177">:</span>&nbsp;<span class="ident" id="8351179">IPv4</span><span class="op" id="8351183">(</span><span class="num" id="8351184">127</span><span class="op" id="8351187">,</span>&nbsp;<span class="num" id="8351189">0</span><span class="op" id="8351190">,</span>&nbsp;<span class="num" id="8351192">0</span><span class="op" id="8351193">,</span>&nbsp;<span class="num" id="8351195">1</span><span class="op" id="8351196">)</span><span class="op" id="8351197">,</span>&nbsp;<span class="ident" id="8351199">Port</span><span class="op" id="8351203">:</span>&nbsp;<span class="ident" id="8351205">portnum</span><span class="op" id="8351212">}</span><span class="op" id="8351213">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351217">&amp;</span><span class="ident" id="8351218">TCPAddr</span><span class="op" id="8351225">{</span><span class="ident" id="8351226">IP</span><span class="op" id="8351228">:</span>&nbsp;<span class="ident" id="8351230">IPv6loopback</span><span class="op" id="8351242">,</span>&nbsp;<span class="ident" id="8351244">Port</span><span class="op" id="8351248">:</span>&nbsp;<span class="ident" id="8351250">portnum</span><span class="op" id="8351257">}</span><span class="op" id="8351258">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8351263">//&nbsp;Losers&nbsp;that&nbsp;will&nbsp;have&nbsp;established&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351315">&amp;</span><span class="ident" id="8351316">TCPAddr</span><span class="op" id="8351323">{</span><span class="ident" id="8351324">IP</span><span class="op" id="8351326">:</span>&nbsp;<span class="ident" id="8351328">IPv4</span><span class="op" id="8351332">(</span><span class="num" id="8351333">127</span><span class="op" id="8351336">,</span>&nbsp;<span class="num" id="8351338">0</span><span class="op" id="8351339">,</span>&nbsp;<span class="num" id="8351341">0</span><span class="op" id="8351342">,</span>&nbsp;<span class="num" id="8351344">1</span><span class="op" id="8351345">)</span><span class="op" id="8351346">,</span>&nbsp;<span class="ident" id="8351348">Port</span><span class="op" id="8351352">:</span>&nbsp;<span class="ident" id="8351354">portnum</span><span class="op" id="8351361">}</span><span class="op" id="8351362">,</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351366">&amp;</span><span class="ident" id="8351367">TCPAddr</span><span class="op" id="8351374">{</span><span class="ident" id="8351375">IP</span><span class="op" id="8351377">:</span>&nbsp;<span class="ident" id="8351379">IPv6loopback</span><span class="op" id="8351391">,</span>&nbsp;<span class="ident" id="8351393">Port</span><span class="op" id="8351397">:</span>&nbsp;<span class="ident" id="8351399">portnum</span><span class="op" id="8351406">}</span><span class="op" id="8351407">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351413">const</span>&nbsp;<span class="ident" id="8351419">T1</span>&nbsp;<span class="op" id="8351422">=</span>&nbsp;<span class="num" id="8351424">10</span>&nbsp;<span class="op" id="8351427">*</span>&nbsp;<span class="ident" id="8351429">time</span><span class="op" id="8351433">.</span><span class="ident" id="8351434">Millisecond</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351447">const</span>&nbsp;<span class="ident" id="8351453">T2</span>&nbsp;<span class="op" id="8351456">=</span>&nbsp;<span class="num" id="8351458">2</span>&nbsp;<span class="op" id="8351460">*</span>&nbsp;<span class="ident" id="8351462">T1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351466">const</span>&nbsp;<span class="ident" id="8351472">N</span>&nbsp;<span class="op" id="8351474">=</span>&nbsp;<span class="num" id="8351476">10</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351480">for</span>&nbsp;<span class="ident" id="8351484">i</span>&nbsp;<span class="op" id="8351486">:=</span>&nbsp;<span class="num" id="8351489">0</span><span class="op" id="8351490">;</span>&nbsp;<span class="ident" id="8351492">i</span>&nbsp;<span class="op" id="8351494">&lt;</span>&nbsp;<span class="ident" id="8351496">N</span><span class="op" id="8351497">;</span>&nbsp;<span class="ident" id="8351499">i</span><span class="op" id="8351500">++</span>&nbsp;<span class="op" id="8351503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351507">wg</span><span class="op" id="8351509">.</span><span class="ident" id="8351510">Add</span><span class="op" id="8351513">(</span><span class="num" id="8351514">1</span><span class="op" id="8351515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351519">go</span>&nbsp;<span class="keyword" id="8351522">func</span><span class="op" id="8351526">(</span><span class="op" id="8351527">)</span>&nbsp;<span class="op" id="8351529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351534">defer</span>&nbsp;<span class="ident" id="8351540">wg</span><span class="op" id="8351542">.</span><span class="ident" id="8351543">Done</span><span class="op" id="8351547">(</span><span class="op" id="8351548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351553">if</span>&nbsp;<span class="ident" id="8351556">c</span><span class="op" id="8351557">,</span>&nbsp;<span class="ident" id="8351559">err</span>&nbsp;<span class="op" id="8351563">:=</span>&nbsp;<span class="ident" id="8351566">dialMulti</span><span class="op" id="8351575">(</span><span class="string" id="8351576">&#34;tcp&#34;</span><span class="op" id="8351581">,</span>&nbsp;<span class="string" id="8351583">&#34;fast&nbsp;failover&nbsp;test&#34;</span><span class="op" id="8351603">,</span>&nbsp;<span class="ident" id="8351605">nil</span><span class="op" id="8351608">,</span>&nbsp;<span class="ident" id="8351610">ras</span><span class="op" id="8351613">,</span>&nbsp;<span class="ident" id="8351615">time</span><span class="op" id="8351619">.</span><span class="ident" id="8351620">Now</span><span class="op" id="8351623">(</span><span class="op" id="8351624">)</span><span class="op" id="8351625">.</span><span class="ident" id="8351626">Add</span><span class="op" id="8351629">(</span><span class="ident" id="8351630">T1</span><span class="op" id="8351632">)</span><span class="op" id="8351633">)</span><span class="op" id="8351634">;</span>&nbsp;<span class="ident" id="8351636">err</span>&nbsp;<span class="op" id="8351640">==</span>&nbsp;<span class="ident" id="8351643">nil</span>&nbsp;<span class="op" id="8351647">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351653">c</span><span class="op" id="8351654">.</span><span class="ident" id="8351655">Close</span><span class="op" id="8351660">(</span><span class="op" id="8351661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351670">}</span><span class="op" id="8351671">(</span><span class="op" id="8351672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351678">wg</span><span class="op" id="8351680">.</span><span class="ident" id="8351681">Wait</span><span class="op" id="8351685">(</span><span class="op" id="8351686">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351689">time</span><span class="op" id="8351693">.</span><span class="ident" id="8351694">Sleep</span><span class="op" id="8351699">(</span><span class="ident" id="8351700">T2</span><span class="op" id="8351702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351706">ntcp</span><span class="op" id="8351710">,</span>&nbsp;<span class="ident" id="8351712">after</span><span class="op" id="8351717">,</span>&nbsp;<span class="ident" id="8351719">nclose</span><span class="op" id="8351725">,</span>&nbsp;<span class="ident" id="8351727">err</span>&nbsp;<span class="op" id="8351731">:=</span>&nbsp;<span class="ident" id="8351734">numTCP</span><span class="op" id="8351740">(</span><span class="op" id="8351741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351744">if</span>&nbsp;<span class="ident" id="8351747">err</span>&nbsp;<span class="op" id="8351751">!=</span>&nbsp;<span class="ident" id="8351754">nil</span>&nbsp;<span class="op" id="8351758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351762">t</span><span class="op" id="8351763">.</span><span class="ident" id="8351764">Skipf</span><span class="op" id="8351769">(</span><span class="string" id="8351770">&#34;skipping&nbsp;test;&nbsp;error&nbsp;finding&nbsp;or&nbsp;running&nbsp;lsof:&nbsp;%v&#34;</span><span class="op" id="8351820">,</span>&nbsp;<span class="ident" id="8351822">err</span><span class="op" id="8351825">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8351828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351831">t</span><span class="op" id="8351832">.</span><span class="ident" id="8351833">Logf</span><span class="op" id="8351837">(</span><span class="string" id="8351838">&#34;tcp&nbsp;sessions:&nbsp;%v,&nbsp;open&nbsp;sessions:&nbsp;%v,&nbsp;closing&nbsp;sessions:&nbsp;%v&#34;</span><span class="op" id="8351897">,</span>&nbsp;<span class="ident" id="8351899">ntcp</span><span class="op" id="8351903">,</span>&nbsp;<span class="ident" id="8351905">after</span><span class="op" id="8351910">,</span>&nbsp;<span class="ident" id="8351912">nclose</span><span class="op" id="8351918">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8351922">if</span>&nbsp;<span class="ident" id="8351925">after</span>&nbsp;<span class="op" id="8351931">!=</span>&nbsp;<span class="ident" id="8351934">before</span>&nbsp;<span class="op" id="8351941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8351945">t</span><span class="op" id="8351946">.</span><span class="ident" id="8351947">Fatalf</span><span class="op" id="8351953">(</span><span class="string" id="8351954">&#34;got&nbsp;%v&nbsp;open&nbsp;sessions;&nbsp;expected&nbsp;%v&#34;</span><span class="op" id="8351989">,</span>&nbsp;<span class="ident" id="8351991">after</span><span class="op" id="8351996">,</span>&nbsp;<span class="ident" id="8351998">before</span><span class="op" id="8352004">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352007">}</span><br>
<span class="lineno"></span><span class="op" id="8352009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8352012">func</span>&nbsp;<span class="ident" id="8352017">numFD</span><span class="op" id="8352022">(</span><span class="op" id="8352023">)</span>&nbsp;<span class="builtintype" id="8352025">int</span>&nbsp;<span class="op" id="8352029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352032">if</span>&nbsp;<span class="ident" id="8352035">runtime</span><span class="op" id="8352042">.</span><span class="ident" id="8352043">GOOS</span>&nbsp;<span class="op" id="8352048">==</span>&nbsp;<span class="string" id="8352051">&#34;linux&#34;</span>&nbsp;<span class="op" id="8352059">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352063">f</span><span class="op" id="8352064">,</span>&nbsp;<span class="ident" id="8352066">err</span>&nbsp;<span class="op" id="8352070">:=</span>&nbsp;<span class="ident" id="8352073">os</span><span class="op" id="8352075">.</span><span class="ident" id="8352076">Open</span><span class="op" id="8352080">(</span><span class="string" id="8352081">&#34;/proc/self/fd&#34;</span><span class="op" id="8352096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352100">if</span>&nbsp;<span class="ident" id="8352103">err</span>&nbsp;<span class="op" id="8352107">!=</span>&nbsp;<span class="ident" id="8352110">nil</span>&nbsp;<span class="op" id="8352114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8352119">panic</span><span class="op" id="8352124">(</span><span class="ident" id="8352125">err</span><span class="op" id="8352128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352136">defer</span>&nbsp;<span class="ident" id="8352142">f</span><span class="op" id="8352143">.</span><span class="ident" id="8352144">Close</span><span class="op" id="8352149">(</span><span class="op" id="8352150">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352154">names</span><span class="op" id="8352159">,</span>&nbsp;<span class="ident" id="8352161">err</span>&nbsp;<span class="op" id="8352165">:=</span>&nbsp;<span class="ident" id="8352168">f</span><span class="op" id="8352169">.</span><span class="ident" id="8352170">Readdirnames</span><span class="op" id="8352182">(</span><span class="num" id="8352183">0</span><span class="op" id="8352184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352188">if</span>&nbsp;<span class="ident" id="8352191">err</span>&nbsp;<span class="op" id="8352195">!=</span>&nbsp;<span class="ident" id="8352198">nil</span>&nbsp;<span class="op" id="8352202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8352207">panic</span><span class="op" id="8352212">(</span><span class="ident" id="8352213">err</span><span class="op" id="8352216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352224">return</span>&nbsp;<span class="builtinfunc" id="8352231">len</span><span class="op" id="8352234">(</span><span class="ident" id="8352235">names</span><span class="op" id="8352240">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352243">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8352246">//&nbsp;All&nbsp;tests&nbsp;using&nbsp;this&nbsp;should&nbsp;be&nbsp;skipped&nbsp;anyway,&nbsp;but:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="8352302">panic</span><span class="op" id="8352307">(</span><span class="string" id="8352308">&#34;numFDs&nbsp;not&nbsp;implemented&nbsp;on&nbsp;&#34;</span>&nbsp;<span class="op" id="8352337">+</span>&nbsp;<span class="ident" id="8352339">runtime</span><span class="op" id="8352346">.</span><span class="ident" id="8352347">GOOS</span><span class="op" id="8352351">)</span><br>
<span class="lineno"></span><span class="op" id="8352353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="8352356">func</span>&nbsp;<span class="ident" id="8352361">TestDialer</span><span class="op" id="8352371">(</span><span class="ident" id="8352372">t</span>&nbsp;<span class="op" id="8352374">*</span><span class="ident" id="8352375">testing</span><span class="op" id="8352382">.</span><span class="ident" id="8352383">T</span><span class="op" id="8352384">)</span>&nbsp;<span class="op" id="8352386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352389">ln</span><span class="op" id="8352391">,</span>&nbsp;<span class="ident" id="8352393">err</span>&nbsp;<span class="op" id="8352397">:=</span>&nbsp;<span class="ident" id="8352400">Listen</span><span class="op" id="8352406">(</span><span class="string" id="8352407">&#34;tcp4&#34;</span><span class="op" id="8352413">,</span>&nbsp;<span class="string" id="8352415">&#34;127.0.0.1:0&#34;</span><span class="op" id="8352428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352431">if</span>&nbsp;<span class="ident" id="8352434">err</span>&nbsp;<span class="op" id="8352438">!=</span>&nbsp;<span class="ident" id="8352441">nil</span>&nbsp;<span class="op" id="8352445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352449">t</span><span class="op" id="8352450">.</span><span class="ident" id="8352451">Fatalf</span><span class="op" id="8352457">(</span><span class="string" id="8352458">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8352477">,</span>&nbsp;<span class="ident" id="8352479">err</span><span class="op" id="8352482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352485">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352488">defer</span>&nbsp;<span class="ident" id="8352494">ln</span><span class="op" id="8352496">.</span><span class="ident" id="8352497">Close</span><span class="op" id="8352502">(</span><span class="op" id="8352503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352506">ch</span>&nbsp;<span class="op" id="8352509">:=</span>&nbsp;<span class="builtinfunc" id="8352512">make</span><span class="op" id="8352516">(</span><span class="keyword" id="8352517">chan</span>&nbsp;<span class="builtintype" id="8352522">error</span><span class="op" id="8352527">,</span>&nbsp;<span class="num" id="8352529">1</span><span class="op" id="8352530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352533">go</span>&nbsp;<span class="keyword" id="8352536">func</span><span class="op" id="8352540">(</span><span class="op" id="8352541">)</span>&nbsp;<span class="op" id="8352543">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352547">c</span><span class="op" id="8352548">,</span>&nbsp;<span class="ident" id="8352550">err</span>&nbsp;<span class="op" id="8352554">:=</span>&nbsp;<span class="ident" id="8352557">ln</span><span class="op" id="8352559">.</span><span class="ident" id="8352560">Accept</span><span class="op" id="8352566">(</span><span class="op" id="8352567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352571">if</span>&nbsp;<span class="ident" id="8352574">err</span>&nbsp;<span class="op" id="8352578">!=</span>&nbsp;<span class="ident" id="8352581">nil</span>&nbsp;<span class="op" id="8352585">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352590">ch</span>&nbsp;<span class="op" id="8352593">&lt;-</span>&nbsp;<span class="ident" id="8352596">fmt</span><span class="op" id="8352599">.</span><span class="ident" id="8352600">Errorf</span><span class="op" id="8352606">(</span><span class="string" id="8352607">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8352626">,</span>&nbsp;<span class="ident" id="8352628">err</span><span class="op" id="8352631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352636">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352645">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352649">defer</span>&nbsp;<span class="ident" id="8352655">c</span><span class="op" id="8352656">.</span><span class="ident" id="8352657">Close</span><span class="op" id="8352662">(</span><span class="op" id="8352663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352667">ch</span>&nbsp;<span class="op" id="8352670">&lt;-</span>&nbsp;<span class="ident" id="8352673">nil</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352678">}</span><span class="op" id="8352679">(</span><span class="op" id="8352680">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352684">laddr</span><span class="op" id="8352689">,</span>&nbsp;<span class="ident" id="8352691">err</span>&nbsp;<span class="op" id="8352695">:=</span>&nbsp;<span class="ident" id="8352698">ResolveTCPAddr</span><span class="op" id="8352712">(</span><span class="string" id="8352713">&#34;tcp4&#34;</span><span class="op" id="8352719">,</span>&nbsp;<span class="string" id="8352721">&#34;127.0.0.1:0&#34;</span><span class="op" id="8352734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352737">if</span>&nbsp;<span class="ident" id="8352740">err</span>&nbsp;<span class="op" id="8352744">!=</span>&nbsp;<span class="ident" id="8352747">nil</span>&nbsp;<span class="op" id="8352751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352755">t</span><span class="op" id="8352756">.</span><span class="ident" id="8352757">Fatalf</span><span class="op" id="8352763">(</span><span class="string" id="8352764">&#34;ResolveTCPAddr&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8352791">,</span>&nbsp;<span class="ident" id="8352793">err</span><span class="op" id="8352796">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352802">d</span>&nbsp;<span class="op" id="8352804">:=</span>&nbsp;<span class="op" id="8352807">&amp;</span><span class="ident" id="8352808">Dialer</span><span class="op" id="8352814">{</span><span class="ident" id="8352815">LocalAddr</span><span class="op" id="8352824">:</span>&nbsp;<span class="ident" id="8352826">laddr</span><span class="op" id="8352831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352834">c</span><span class="op" id="8352835">,</span>&nbsp;<span class="ident" id="8352837">err</span>&nbsp;<span class="op" id="8352841">:=</span>&nbsp;<span class="ident" id="8352844">d</span><span class="op" id="8352845">.</span><span class="ident" id="8352846">Dial</span><span class="op" id="8352850">(</span><span class="string" id="8352851">&#34;tcp4&#34;</span><span class="op" id="8352857">,</span>&nbsp;<span class="ident" id="8352859">ln</span><span class="op" id="8352861">.</span><span class="ident" id="8352862">Addr</span><span class="op" id="8352866">(</span><span class="op" id="8352867">)</span><span class="op" id="8352868">.</span><span class="ident" id="8352869">String</span><span class="op" id="8352875">(</span><span class="op" id="8352876">)</span><span class="op" id="8352877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352880">if</span>&nbsp;<span class="ident" id="8352883">err</span>&nbsp;<span class="op" id="8352887">!=</span>&nbsp;<span class="ident" id="8352890">nil</span>&nbsp;<span class="op" id="8352894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352898">t</span><span class="op" id="8352899">.</span><span class="ident" id="8352900">Fatalf</span><span class="op" id="8352906">(</span><span class="string" id="8352907">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8352924">,</span>&nbsp;<span class="ident" id="8352926">err</span><span class="op" id="8352929">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8352932">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352935">defer</span>&nbsp;<span class="ident" id="8352941">c</span><span class="op" id="8352942">.</span><span class="ident" id="8352943">Close</span><span class="op" id="8352948">(</span><span class="op" id="8352949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352952">c</span><span class="op" id="8352953">.</span><span class="ident" id="8352954">Read</span><span class="op" id="8352958">(</span><span class="builtinfunc" id="8352959">make</span><span class="op" id="8352963">(</span><span class="op" id="8352964">[</span><span class="op" id="8352965">]</span><span class="builtintype" id="8352966">byte</span><span class="op" id="8352970">,</span>&nbsp;<span class="num" id="8352972">1</span><span class="op" id="8352973">)</span><span class="op" id="8352974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8352977">err</span>&nbsp;<span class="op" id="8352981">=</span>&nbsp;<span class="op" id="8352983">&lt;-</span><span class="ident" id="8352985">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8352989">if</span>&nbsp;<span class="ident" id="8352992">err</span>&nbsp;<span class="op" id="8352996">!=</span>&nbsp;<span class="ident" id="8352999">nil</span>&nbsp;<span class="op" id="8353003">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353007">t</span><span class="op" id="8353008">.</span><span class="ident" id="8353009">Error</span><span class="op" id="8353014">(</span><span class="ident" id="8353015">err</span><span class="op" id="8353018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353021">}</span><br>
<span class="lineno"></span><span class="op" id="8353023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8353026">func</span>&nbsp;<span class="ident" id="8353031">TestDialDualStackLocalhost</span><span class="op" id="8353057">(</span><span class="ident" id="8353058">t</span>&nbsp;<span class="op" id="8353060">*</span><span class="ident" id="8353061">testing</span><span class="op" id="8353068">.</span><span class="ident" id="8353069">T</span><span class="op" id="8353070">)</span>&nbsp;<span class="op" id="8353072">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353075">switch</span>&nbsp;<span class="ident" id="8353082">runtime</span><span class="op" id="8353089">.</span><span class="ident" id="8353090">GOOS</span>&nbsp;<span class="op" id="8353095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353098">case</span>&nbsp;<span class="string" id="8353103">&#34;nacl&#34;</span><span class="op" id="8353109">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353113">t</span><span class="op" id="8353114">.</span><span class="ident" id="8353115">Skipf</span><span class="op" id="8353120">(</span><span class="string" id="8353121">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op" id="8353142">,</span>&nbsp;<span class="ident" id="8353144">runtime</span><span class="op" id="8353151">.</span><span class="ident" id="8353152">GOOS</span><span class="op" id="8353156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353159">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353163">if</span>&nbsp;<span class="ident" id="8353166">ips</span><span class="op" id="8353169">,</span>&nbsp;<span class="ident" id="8353171">err</span>&nbsp;<span class="op" id="8353175">:=</span>&nbsp;<span class="ident" id="8353178">LookupIP</span><span class="op" id="8353186">(</span><span class="string" id="8353187">&#34;localhost&#34;</span><span class="op" id="8353198">)</span><span class="op" id="8353199">;</span>&nbsp;<span class="ident" id="8353201">err</span>&nbsp;<span class="op" id="8353205">!=</span>&nbsp;<span class="ident" id="8353208">nil</span>&nbsp;<span class="op" id="8353212">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353216">t</span><span class="op" id="8353217">.</span><span class="ident" id="8353218">Fatalf</span><span class="op" id="8353224">(</span><span class="string" id="8353225">&#34;LookupIP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8353246">,</span>&nbsp;<span class="ident" id="8353248">err</span><span class="op" id="8353251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353254">}</span>&nbsp;<span class="keyword" id="8353256">else</span>&nbsp;<span class="keyword" id="8353261">if</span>&nbsp;<span class="builtinfunc" id="8353264">len</span><span class="op" id="8353267">(</span><span class="ident" id="8353268">ips</span><span class="op" id="8353271">)</span>&nbsp;<span class="op" id="8353273">&lt;</span>&nbsp;<span class="num" id="8353275">2</span>&nbsp;<span class="op" id="8353277">||</span>&nbsp;<span class="op" id="8353280">!</span><span class="ident" id="8353281">supportsIPv4</span>&nbsp;<span class="op" id="8353294">||</span>&nbsp;<span class="op" id="8353297">!</span><span class="ident" id="8353298">supportsIPv6</span>&nbsp;<span class="op" id="8353311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353315">t</span><span class="op" id="8353316">.</span><span class="ident" id="8353317">Skip</span><span class="op" id="8353321">(</span><span class="string" id="8353322">&#34;localhost&nbsp;doesn&#39;t&nbsp;have&nbsp;a&nbsp;pair&nbsp;of&nbsp;different&nbsp;address&nbsp;family&nbsp;IP&nbsp;addresses&#34;</span><span class="op" id="8353394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353397">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353401">touchAndByeServer</span>&nbsp;<span class="op" id="8353419">:=</span>&nbsp;<span class="keyword" id="8353422">func</span><span class="op" id="8353426">(</span><span class="ident" id="8353427">dss</span>&nbsp;<span class="op" id="8353431">*</span><span class="ident" id="8353432">dualStackServer</span><span class="op" id="8353447">,</span>&nbsp;<span class="ident" id="8353449">ln</span>&nbsp;<span class="ident" id="8353452">Listener</span><span class="op" id="8353460">)</span>&nbsp;<span class="op" id="8353462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353466">for</span>&nbsp;<span class="op" id="8353470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353475">if</span>&nbsp;<span class="ident" id="8353478">c</span><span class="op" id="8353479">,</span>&nbsp;<span class="ident" id="8353481">err</span>&nbsp;<span class="op" id="8353485">:=</span>&nbsp;<span class="ident" id="8353488">ln</span><span class="op" id="8353490">.</span><span class="ident" id="8353491">Accept</span><span class="op" id="8353497">(</span><span class="op" id="8353498">)</span><span class="op" id="8353499">;</span>&nbsp;<span class="ident" id="8353501">err</span>&nbsp;<span class="op" id="8353505">!=</span>&nbsp;<span class="ident" id="8353508">nil</span>&nbsp;<span class="op" id="8353512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353518">return</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353528">}</span>&nbsp;<span class="keyword" id="8353530">else</span>&nbsp;<span class="op" id="8353535">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353541">c</span><span class="op" id="8353542">.</span><span class="ident" id="8353543">Close</span><span class="op" id="8353548">(</span><span class="op" id="8353549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353561">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353564">dss</span><span class="op" id="8353567">,</span>&nbsp;<span class="ident" id="8353569">err</span>&nbsp;<span class="op" id="8353573">:=</span>&nbsp;<span class="ident" id="8353576">newDualStackServer</span><span class="op" id="8353594">(</span><span class="op" id="8353595">[</span><span class="op" id="8353596">]</span><span class="ident" id="8353597">streamListener</span><span class="op" id="8353611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353615">{</span><span class="ident" id="8353616">net</span><span class="op" id="8353619">:</span>&nbsp;<span class="string" id="8353621">&#34;tcp4&#34;</span><span class="op" id="8353627">,</span>&nbsp;<span class="ident" id="8353629">addr</span><span class="op" id="8353633">:</span>&nbsp;<span class="string" id="8353635">&#34;127.0.0.1&#34;</span><span class="op" id="8353646">}</span><span class="op" id="8353647">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353651">{</span><span class="ident" id="8353652">net</span><span class="op" id="8353655">:</span>&nbsp;<span class="string" id="8353657">&#34;tcp6&#34;</span><span class="op" id="8353663">,</span>&nbsp;<span class="ident" id="8353665">addr</span><span class="op" id="8353669">:</span>&nbsp;<span class="string" id="8353671">&#34;[::1]&#34;</span><span class="op" id="8353678">}</span><span class="op" id="8353679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353682">}</span><span class="op" id="8353683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353686">if</span>&nbsp;<span class="ident" id="8353689">err</span>&nbsp;<span class="op" id="8353693">!=</span>&nbsp;<span class="ident" id="8353696">nil</span>&nbsp;<span class="op" id="8353700">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353704">t</span><span class="op" id="8353705">.</span><span class="ident" id="8353706">Fatalf</span><span class="op" id="8353712">(</span><span class="string" id="8353713">&#34;newDualStackServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8353744">,</span>&nbsp;<span class="ident" id="8353746">err</span><span class="op" id="8353749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353755">defer</span>&nbsp;<span class="ident" id="8353761">dss</span><span class="op" id="8353764">.</span><span class="ident" id="8353765">teardown</span><span class="op" id="8353773">(</span><span class="op" id="8353774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353777">if</span>&nbsp;<span class="ident" id="8353780">err</span>&nbsp;<span class="op" id="8353784">:=</span>&nbsp;<span class="ident" id="8353787">dss</span><span class="op" id="8353790">.</span><span class="ident" id="8353791">buildup</span><span class="op" id="8353798">(</span><span class="ident" id="8353799">touchAndByeServer</span><span class="op" id="8353816">)</span><span class="op" id="8353817">;</span>&nbsp;<span class="ident" id="8353819">err</span>&nbsp;<span class="op" id="8353823">!=</span>&nbsp;<span class="ident" id="8353826">nil</span>&nbsp;<span class="op" id="8353830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353834">t</span><span class="op" id="8353835">.</span><span class="ident" id="8353836">Fatalf</span><span class="op" id="8353842">(</span><span class="string" id="8353843">&#34;dualStackServer.buildup&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8353879">,</span>&nbsp;<span class="ident" id="8353881">err</span><span class="op" id="8353884">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8353887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8353891">d</span>&nbsp;<span class="op" id="8353893">:=</span>&nbsp;<span class="op" id="8353896">&amp;</span><span class="ident" id="8353897">Dialer</span><span class="op" id="8353903">{</span><span class="ident" id="8353904">DualStack</span><span class="op" id="8353913">:</span>&nbsp;<span class="builtintype" id="8353915">true</span><span class="op" id="8353919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353922">for</span>&nbsp;<span class="keyword" id="8353926">range</span>&nbsp;<span class="ident" id="8353932">dss</span><span class="op" id="8353935">.</span><span class="ident" id="8353936">lns</span>&nbsp;<span class="op" id="8353940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8353944">if</span>&nbsp;<span class="ident" id="8353947">c</span><span class="op" id="8353948">,</span>&nbsp;<span class="ident" id="8353950">err</span>&nbsp;<span class="op" id="8353954">:=</span>&nbsp;<span class="ident" id="8353957">d</span><span class="op" id="8353958">.</span><span class="ident" id="8353959">Dial</span><span class="op" id="8353963">(</span><span class="string" id="8353964">&#34;tcp&#34;</span><span class="op" id="8353969">,</span>&nbsp;<span class="string" id="8353971">&#34;localhost:&#34;</span><span class="op" id="8353983">+</span><span class="ident" id="8353984">dss</span><span class="op" id="8353987">.</span><span class="ident" id="8353988">port</span><span class="op" id="8353992">)</span><span class="op" id="8353993">;</span>&nbsp;<span class="ident" id="8353995">err</span>&nbsp;<span class="op" id="8353999">!=</span>&nbsp;<span class="ident" id="8354002">nil</span>&nbsp;<span class="op" id="8354006">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354011">t</span><span class="op" id="8354012">.</span><span class="ident" id="8354013">Errorf</span><span class="op" id="8354019">(</span><span class="string" id="8354020">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8354037">,</span>&nbsp;<span class="ident" id="8354039">err</span><span class="op" id="8354042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354046">}</span>&nbsp;<span class="keyword" id="8354048">else</span>&nbsp;<span class="op" id="8354053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354058">if</span>&nbsp;<span class="ident" id="8354061">addr</span>&nbsp;<span class="op" id="8354066">:=</span>&nbsp;<span class="ident" id="8354069">c</span><span class="op" id="8354070">.</span><span class="ident" id="8354071">LocalAddr</span><span class="op" id="8354080">(</span><span class="op" id="8354081">)</span><span class="op" id="8354082">.</span><span class="op" id="8354083">(</span><span class="op" id="8354084">*</span><span class="ident" id="8354085">TCPAddr</span><span class="op" id="8354092">)</span><span class="op" id="8354093">;</span>&nbsp;<span class="ident" id="8354095">addr</span><span class="op" id="8354099">.</span><span class="ident" id="8354100">IP</span><span class="op" id="8354102">.</span><span class="ident" id="8354103">To4</span><span class="op" id="8354106">(</span><span class="op" id="8354107">)</span>&nbsp;<span class="op" id="8354109">!=</span>&nbsp;<span class="ident" id="8354112">nil</span>&nbsp;<span class="op" id="8354116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354122">dss</span><span class="op" id="8354125">.</span><span class="ident" id="8354126">teardownNetwork</span><span class="op" id="8354141">(</span><span class="string" id="8354142">&#34;tcp4&#34;</span><span class="op" id="8354148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354153">}</span>&nbsp;<span class="keyword" id="8354155">else</span>&nbsp;<span class="keyword" id="8354160">if</span>&nbsp;<span class="ident" id="8354163">addr</span><span class="op" id="8354167">.</span><span class="ident" id="8354168">IP</span><span class="op" id="8354170">.</span><span class="ident" id="8354171">To16</span><span class="op" id="8354175">(</span><span class="op" id="8354176">)</span>&nbsp;<span class="op" id="8354178">!=</span>&nbsp;<span class="ident" id="8354181">nil</span>&nbsp;<span class="op" id="8354185">&amp;&amp;</span>&nbsp;<span class="ident" id="8354188">addr</span><span class="op" id="8354192">.</span><span class="ident" id="8354193">IP</span><span class="op" id="8354195">.</span><span class="ident" id="8354196">To4</span><span class="op" id="8354199">(</span><span class="op" id="8354200">)</span>&nbsp;<span class="op" id="8354202">==</span>&nbsp;<span class="ident" id="8354205">nil</span>&nbsp;<span class="op" id="8354209">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354215">dss</span><span class="op" id="8354218">.</span><span class="ident" id="8354219">teardownNetwork</span><span class="op" id="8354234">(</span><span class="string" id="8354235">&#34;tcp6&#34;</span><span class="op" id="8354241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354251">c</span><span class="op" id="8354252">.</span><span class="ident" id="8354253">Close</span><span class="op" id="8354258">(</span><span class="op" id="8354259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354263">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354266">}</span><br>
<span class="lineno">515</span><span class="op" id="8354268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8354271">func</span>&nbsp;<span class="ident" id="8354276">TestDialerKeepAlive</span><span class="op" id="8354295">(</span><span class="ident" id="8354296">t</span>&nbsp;<span class="op" id="8354298">*</span><span class="ident" id="8354299">testing</span><span class="op" id="8354306">.</span><span class="ident" id="8354307">T</span><span class="op" id="8354308">)</span>&nbsp;<span class="op" id="8354310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354313">ln</span>&nbsp;<span class="op" id="8354316">:=</span>&nbsp;<span class="ident" id="8354319">newLocalListener</span><span class="op" id="8354335">(</span><span class="ident" id="8354336">t</span><span class="op" id="8354337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354340">defer</span>&nbsp;<span class="ident" id="8354346">ln</span><span class="op" id="8354348">.</span><span class="ident" id="8354349">Close</span><span class="op" id="8354354">(</span><span class="op" id="8354355">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354358">defer</span>&nbsp;<span class="keyword" id="8354364">func</span><span class="op" id="8354368">(</span><span class="op" id="8354369">)</span>&nbsp;<span class="op" id="8354371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354375">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8354396">=</span>&nbsp;<span class="keyword" id="8354398">func</span><span class="op" id="8354402">(</span><span class="op" id="8354403">)</span>&nbsp;<span class="op" id="8354405">{</span><span class="op" id="8354406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354409">}</span><span class="op" id="8354410">(</span><span class="op" id="8354411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354414">go</span>&nbsp;<span class="keyword" id="8354417">func</span><span class="op" id="8354421">(</span><span class="op" id="8354422">)</span>&nbsp;<span class="op" id="8354424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354428">for</span>&nbsp;<span class="op" id="8354432">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354437">c</span><span class="op" id="8354438">,</span>&nbsp;<span class="ident" id="8354440">err</span>&nbsp;<span class="op" id="8354444">:=</span>&nbsp;<span class="ident" id="8354447">ln</span><span class="op" id="8354449">.</span><span class="ident" id="8354450">Accept</span><span class="op" id="8354456">(</span><span class="op" id="8354457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354462">if</span>&nbsp;<span class="ident" id="8354465">err</span>&nbsp;<span class="op" id="8354469">!=</span>&nbsp;<span class="ident" id="8354472">nil</span>&nbsp;<span class="op" id="8354476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354482">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354497">c</span><span class="op" id="8354498">.</span><span class="ident" id="8354499">Close</span><span class="op" id="8354504">(</span><span class="op" id="8354505">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354512">}</span><span class="op" id="8354513">(</span><span class="op" id="8354514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354517">for</span>&nbsp;<span class="ident" id="8354521">_</span><span class="op" id="8354522">,</span>&nbsp;<span class="ident" id="8354524">keepAlive</span>&nbsp;<span class="op" id="8354534">:=</span>&nbsp;<span class="keyword" id="8354537">range</span>&nbsp;<span class="op" id="8354543">[</span><span class="op" id="8354544">]</span><span class="builtintype" id="8354545">bool</span><span class="op" id="8354549">{</span><span class="builtintype" id="8354550">false</span><span class="op" id="8354555">,</span>&nbsp;<span class="builtintype" id="8354557">true</span><span class="op" id="8354561">}</span>&nbsp;<span class="op" id="8354563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354567">got</span>&nbsp;<span class="op" id="8354571">:=</span>&nbsp;<span class="builtintype" id="8354574">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354582">testHookSetKeepAlive</span>&nbsp;<span class="op" id="8354603">=</span>&nbsp;<span class="keyword" id="8354605">func</span><span class="op" id="8354609">(</span><span class="op" id="8354610">)</span>&nbsp;<span class="op" id="8354612">{</span>&nbsp;<span class="ident" id="8354614">got</span>&nbsp;<span class="op" id="8354618">=</span>&nbsp;<span class="builtintype" id="8354620">true</span>&nbsp;<span class="op" id="8354625">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354629">var</span>&nbsp;<span class="ident" id="8354633">d</span>&nbsp;<span class="ident" id="8354635">Dialer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354644">if</span>&nbsp;<span class="ident" id="8354647">keepAlive</span>&nbsp;<span class="op" id="8354657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354662">d</span><span class="op" id="8354663">.</span><span class="ident" id="8354664">KeepAlive</span>&nbsp;<span class="op" id="8354674">=</span>&nbsp;<span class="num" id="8354676">30</span>&nbsp;<span class="op" id="8354679">*</span>&nbsp;<span class="ident" id="8354681">time</span><span class="op" id="8354685">.</span><span class="ident" id="8354686">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354699">c</span><span class="op" id="8354700">,</span>&nbsp;<span class="ident" id="8354702">err</span>&nbsp;<span class="op" id="8354706">:=</span>&nbsp;<span class="ident" id="8354709">d</span><span class="op" id="8354710">.</span><span class="ident" id="8354711">Dial</span><span class="op" id="8354715">(</span><span class="string" id="8354716">&#34;tcp&#34;</span><span class="op" id="8354721">,</span>&nbsp;<span class="ident" id="8354723">ln</span><span class="op" id="8354725">.</span><span class="ident" id="8354726">Addr</span><span class="op" id="8354730">(</span><span class="op" id="8354731">)</span><span class="op" id="8354732">.</span><span class="ident" id="8354733">String</span><span class="op" id="8354739">(</span><span class="op" id="8354740">)</span><span class="op" id="8354741">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354745">if</span>&nbsp;<span class="ident" id="8354748">err</span>&nbsp;<span class="op" id="8354752">!=</span>&nbsp;<span class="ident" id="8354755">nil</span>&nbsp;<span class="op" id="8354759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354764">t</span><span class="op" id="8354765">.</span><span class="ident" id="8354766">Fatal</span><span class="op" id="8354771">(</span><span class="ident" id="8354772">err</span><span class="op" id="8354775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354783">c</span><span class="op" id="8354784">.</span><span class="ident" id="8354785">Close</span><span class="op" id="8354790">(</span><span class="op" id="8354791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8354795">if</span>&nbsp;<span class="ident" id="8354798">got</span>&nbsp;<span class="op" id="8354802">!=</span>&nbsp;<span class="ident" id="8354805">keepAlive</span>&nbsp;<span class="op" id="8354815">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8354820">t</span><span class="op" id="8354821">.</span><span class="ident" id="8354822">Errorf</span><span class="op" id="8354828">(</span><span class="string" id="8354829">&#34;Dialer.KeepAlive&nbsp;=&nbsp;%v:&nbsp;SetKeepAlive&nbsp;called&nbsp;=&nbsp;%v,&nbsp;want&nbsp;%v&#34;</span><span class="op" id="8354887">,</span>&nbsp;<span class="ident" id="8354889">d</span><span class="op" id="8354890">.</span><span class="ident" id="8354891">KeepAlive</span><span class="op" id="8354900">,</span>&nbsp;<span class="ident" id="8354902">got</span><span class="op" id="8354905">,</span>&nbsp;<span class="op" id="8354907">!</span><span class="ident" id="8354908">got</span><span class="op" id="8354911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8354918">}</span><br>
<span class="lineno"></span><span class="op" id="8354920">}</span>
</div>
</body>
</html>
