<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1442816">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1442871">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1442925">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1442976">package</span>&nbsp;<span class="ident" id="1442984">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1442990">import</span>&nbsp;<span class="op" id="1442997">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1443000">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1443015">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1443024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443027">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1443083">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1443141">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1443164">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1443209">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1443256">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1443278">type</span>&nbsp;<span class="ident" id="1443283">RWMutex</span>&nbsp;<span class="keyword" id="1443291">struct</span>&nbsp;<span class="op" id="1443298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443301">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1443313">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1443320">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443358">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1443370">uint32</span>&nbsp;<span class="comment" id="1443377">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443434">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1443446">uint32</span>&nbsp;<span class="comment" id="1443453">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443510">readerCount</span>&nbsp;<span class="builtintype" id="1443522">int32</span>&nbsp;&nbsp;<span class="comment" id="1443529">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443559">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1443571">int32</span>&nbsp;&nbsp;<span class="comment" id="1443578">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1443609">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1443612">const</span>&nbsp;<span class="ident" id="1443618">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1443636">=</span>&nbsp;<span class="num" id="1443638">1</span>&nbsp;<span class="op" id="1443640">&lt;&lt;</span>&nbsp;<span class="num" id="1443643">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443647">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1443678">func</span>&nbsp;<span class="op" id="1443683">(</span><span class="ident" id="1443684">rw</span>&nbsp;<span class="op" id="1443687">*</span><span class="ident" id="1443688">RWMutex</span><span class="op" id="1443695">)</span>&nbsp;<span class="ident" id="1443697">RLock</span><span class="op" id="1443702">(</span><span class="op" id="1443703">)</span>&nbsp;<span class="op" id="1443705">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443708">if</span>&nbsp;<span class="ident" id="1443711">raceenabled</span>&nbsp;<span class="op" id="1443723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443727">_</span>&nbsp;<span class="op" id="1443729">=</span>&nbsp;<span class="ident" id="1443731">rw</span><span class="op" id="1443733">.</span><span class="ident" id="1443734">w</span><span class="op" id="1443735">.</span><span class="ident" id="1443736">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443744">raceDisable</span><span class="op" id="1443755">(</span><span class="op" id="1443756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443762">if</span>&nbsp;<span class="ident" id="1443765">atomic</span><span class="op" id="1443771">.</span><span class="ident" id="1443772">AddInt32</span><span class="op" id="1443780">(</span><span class="op" id="1443781">&amp;</span><span class="ident" id="1443782">rw</span><span class="op" id="1443784">.</span><span class="ident" id="1443785">readerCount</span><span class="op" id="1443796">,</span>&nbsp;<span class="num" id="1443798">1</span><span class="op" id="1443799">)</span>&nbsp;<span class="op" id="1443801">&lt;</span>&nbsp;<span class="num" id="1443803">0</span>&nbsp;<span class="op" id="1443805">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1443809">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443848">runtime_Semacquire</span><span class="op" id="1443866">(</span><span class="op" id="1443867">&amp;</span><span class="ident" id="1443868">rw</span><span class="op" id="1443870">.</span><span class="ident" id="1443871">readerSem</span><span class="op" id="1443880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1443886">if</span>&nbsp;<span class="ident" id="1443889">raceenabled</span>&nbsp;<span class="op" id="1443901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443905">raceEnable</span><span class="op" id="1443915">(</span><span class="op" id="1443916">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1443920">raceAcquire</span><span class="op" id="1443931">(</span><span class="ident" id="1443932">unsafe</span><span class="op" id="1443938">.</span><span class="ident" id="1443939">Pointer</span><span class="op" id="1443946">(</span><span class="op" id="1443947">&amp;</span><span class="ident" id="1443948">rw</span><span class="op" id="1443950">.</span><span class="ident" id="1443951">readerSem</span><span class="op" id="1443960">)</span><span class="op" id="1443961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1443964">}</span><br>
<span class="lineno"></span><span class="op" id="1443966">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1443969">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1444008">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1444058">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1444116">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1444140">func</span>&nbsp;<span class="op" id="1444145">(</span><span class="ident" id="1444146">rw</span>&nbsp;<span class="op" id="1444149">*</span><span class="ident" id="1444150">RWMutex</span><span class="op" id="1444157">)</span>&nbsp;<span class="ident" id="1444159">RUnlock</span><span class="op" id="1444166">(</span><span class="op" id="1444167">)</span>&nbsp;<span class="op" id="1444169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444172">if</span>&nbsp;<span class="ident" id="1444175">raceenabled</span>&nbsp;<span class="op" id="1444187">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444191">_</span>&nbsp;<span class="op" id="1444193">=</span>&nbsp;<span class="ident" id="1444195">rw</span><span class="op" id="1444197">.</span><span class="ident" id="1444198">w</span><span class="op" id="1444199">.</span><span class="ident" id="1444200">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444208">raceReleaseMerge</span><span class="op" id="1444224">(</span><span class="ident" id="1444225">unsafe</span><span class="op" id="1444231">.</span><span class="ident" id="1444232">Pointer</span><span class="op" id="1444239">(</span><span class="op" id="1444240">&amp;</span><span class="ident" id="1444241">rw</span><span class="op" id="1444243">.</span><span class="ident" id="1444244">writerSem</span><span class="op" id="1444253">)</span><span class="op" id="1444254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444258">raceDisable</span><span class="op" id="1444269">(</span><span class="op" id="1444270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444276">if</span>&nbsp;<span class="ident" id="1444279">r</span>&nbsp;<span class="op" id="1444281">:=</span>&nbsp;<span class="ident" id="1444284">atomic</span><span class="op" id="1444290">.</span><span class="ident" id="1444291">AddInt32</span><span class="op" id="1444299">(</span><span class="op" id="1444300">&amp;</span><span class="ident" id="1444301">rw</span><span class="op" id="1444303">.</span><span class="ident" id="1444304">readerCount</span><span class="op" id="1444315">,</span>&nbsp;<span class="op" id="1444317">-</span><span class="num" id="1444318">1</span><span class="op" id="1444319">)</span><span class="op" id="1444320">;</span>&nbsp;<span class="ident" id="1444322">r</span>&nbsp;<span class="op" id="1444324">&lt;</span>&nbsp;<span class="num" id="1444326">0</span>&nbsp;<span class="op" id="1444328">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444332">if</span>&nbsp;<span class="ident" id="1444335">r</span><span class="op" id="1444336">+</span><span class="num" id="1444337">1</span>&nbsp;<span class="op" id="1444339">==</span>&nbsp;<span class="num" id="1444342">0</span>&nbsp;<span class="op" id="1444344">||</span>&nbsp;<span class="ident" id="1444347">r</span><span class="op" id="1444348">+</span><span class="num" id="1444349">1</span>&nbsp;<span class="op" id="1444351">==</span>&nbsp;<span class="op" id="1444354">-</span><span class="ident" id="1444355">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1444373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444378">raceEnable</span><span class="op" id="1444388">(</span><span class="op" id="1444389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1444394">panic</span><span class="op" id="1444399">(</span><span class="string" id="1444400">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1444435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444443">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444469">if</span>&nbsp;<span class="ident" id="1444472">atomic</span><span class="op" id="1444478">.</span><span class="ident" id="1444479">AddInt32</span><span class="op" id="1444487">(</span><span class="op" id="1444488">&amp;</span><span class="ident" id="1444489">rw</span><span class="op" id="1444491">.</span><span class="ident" id="1444492">readerWait</span><span class="op" id="1444502">,</span>&nbsp;<span class="op" id="1444504">-</span><span class="num" id="1444505">1</span><span class="op" id="1444506">)</span>&nbsp;<span class="op" id="1444508">==</span>&nbsp;<span class="num" id="1444511">0</span>&nbsp;<span class="op" id="1444513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444518">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444561">runtime_Semrelease</span><span class="op" id="1444579">(</span><span class="op" id="1444580">&amp;</span><span class="ident" id="1444581">rw</span><span class="op" id="1444583">.</span><span class="ident" id="1444584">writerSem</span><span class="op" id="1444593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444600">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444603">if</span>&nbsp;<span class="ident" id="1444606">raceenabled</span>&nbsp;<span class="op" id="1444618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444622">raceEnable</span><span class="op" id="1444632">(</span><span class="op" id="1444633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444636">}</span><br>
<span class="lineno"></span><span class="op" id="1444638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1444641">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1444671">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1444728">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1444772">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1444829">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1444888">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1444901">func</span>&nbsp;<span class="op" id="1444906">(</span><span class="ident" id="1444907">rw</span>&nbsp;<span class="op" id="1444910">*</span><span class="ident" id="1444911">RWMutex</span><span class="op" id="1444918">)</span>&nbsp;<span class="ident" id="1444920">Lock</span><span class="op" id="1444924">(</span><span class="op" id="1444925">)</span>&nbsp;<span class="op" id="1444927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1444930">if</span>&nbsp;<span class="ident" id="1444933">raceenabled</span>&nbsp;<span class="op" id="1444945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444949">_</span>&nbsp;<span class="op" id="1444951">=</span>&nbsp;<span class="ident" id="1444953">rw</span><span class="op" id="1444955">.</span><span class="ident" id="1444956">w</span><span class="op" id="1444957">.</span><span class="ident" id="1444958">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1444966">raceDisable</span><span class="op" id="1444977">(</span><span class="op" id="1444978">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1444981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1444984">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445035">rw</span><span class="op" id="1445037">.</span><span class="ident" id="1445038">w</span><span class="op" id="1445039">.</span><span class="ident" id="1445040">Lock</span><span class="op" id="1445044">(</span><span class="op" id="1445045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445048">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445099">r</span>&nbsp;<span class="op" id="1445101">:=</span>&nbsp;<span class="ident" id="1445104">atomic</span><span class="op" id="1445110">.</span><span class="ident" id="1445111">AddInt32</span><span class="op" id="1445119">(</span><span class="op" id="1445120">&amp;</span><span class="ident" id="1445121">rw</span><span class="op" id="1445123">.</span><span class="ident" id="1445124">readerCount</span><span class="op" id="1445135">,</span>&nbsp;<span class="op" id="1445137">-</span><span class="ident" id="1445138">rwmutexMaxReaders</span><span class="op" id="1445155">)</span>&nbsp;<span class="op" id="1445157">+</span>&nbsp;<span class="ident" id="1445159">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445178">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445207">if</span>&nbsp;<span class="ident" id="1445210">r</span>&nbsp;<span class="op" id="1445212">!=</span>&nbsp;<span class="num" id="1445215">0</span>&nbsp;<span class="op" id="1445217">&amp;&amp;</span>&nbsp;<span class="ident" id="1445220">atomic</span><span class="op" id="1445226">.</span><span class="ident" id="1445227">AddInt32</span><span class="op" id="1445235">(</span><span class="op" id="1445236">&amp;</span><span class="ident" id="1445237">rw</span><span class="op" id="1445239">.</span><span class="ident" id="1445240">readerWait</span><span class="op" id="1445250">,</span>&nbsp;<span class="ident" id="1445252">r</span><span class="op" id="1445253">)</span>&nbsp;<span class="op" id="1445255">!=</span>&nbsp;<span class="num" id="1445258">0</span>&nbsp;<span class="op" id="1445260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445264">runtime_Semacquire</span><span class="op" id="1445282">(</span><span class="op" id="1445283">&amp;</span><span class="ident" id="1445284">rw</span><span class="op" id="1445286">.</span><span class="ident" id="1445287">writerSem</span><span class="op" id="1445296">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445302">if</span>&nbsp;<span class="ident" id="1445305">raceenabled</span>&nbsp;<span class="op" id="1445317">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445321">raceEnable</span><span class="op" id="1445331">(</span><span class="op" id="1445332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445336">raceAcquire</span><span class="op" id="1445347">(</span><span class="ident" id="1445348">unsafe</span><span class="op" id="1445354">.</span><span class="ident" id="1445355">Pointer</span><span class="op" id="1445362">(</span><span class="op" id="1445363">&amp;</span><span class="ident" id="1445364">rw</span><span class="op" id="1445366">.</span><span class="ident" id="1445367">readerSem</span><span class="op" id="1445376">)</span><span class="op" id="1445377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445381">raceAcquire</span><span class="op" id="1445392">(</span><span class="ident" id="1445393">unsafe</span><span class="op" id="1445399">.</span><span class="ident" id="1445400">Pointer</span><span class="op" id="1445407">(</span><span class="op" id="1445408">&amp;</span><span class="ident" id="1445409">rw</span><span class="op" id="1445411">.</span><span class="ident" id="1445412">writerSem</span><span class="op" id="1445421">)</span><span class="op" id="1445422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445425">}</span><br>
<span class="lineno"></span><span class="op" id="1445427">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1445430">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1445497">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1445543">//</span><br>
<span class="lineno"></span><span class="comment" id="1445546">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1445619">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1445685">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1445742">func</span>&nbsp;<span class="op" id="1445747">(</span><span class="ident" id="1445748">rw</span>&nbsp;<span class="op" id="1445751">*</span><span class="ident" id="1445752">RWMutex</span><span class="op" id="1445759">)</span>&nbsp;<span class="ident" id="1445761">Unlock</span><span class="op" id="1445767">(</span><span class="op" id="1445768">)</span>&nbsp;<span class="op" id="1445770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1445773">if</span>&nbsp;<span class="ident" id="1445776">raceenabled</span>&nbsp;<span class="op" id="1445788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445792">_</span>&nbsp;<span class="op" id="1445794">=</span>&nbsp;<span class="ident" id="1445796">rw</span><span class="op" id="1445798">.</span><span class="ident" id="1445799">w</span><span class="op" id="1445800">.</span><span class="ident" id="1445801">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445809">raceRelease</span><span class="op" id="1445820">(</span><span class="ident" id="1445821">unsafe</span><span class="op" id="1445827">.</span><span class="ident" id="1445828">Pointer</span><span class="op" id="1445835">(</span><span class="op" id="1445836">&amp;</span><span class="ident" id="1445837">rw</span><span class="op" id="1445839">.</span><span class="ident" id="1445840">readerSem</span><span class="op" id="1445849">)</span><span class="op" id="1445850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445854">raceRelease</span><span class="op" id="1445865">(</span><span class="ident" id="1445866">unsafe</span><span class="op" id="1445872">.</span><span class="ident" id="1445873">Pointer</span><span class="op" id="1445880">(</span><span class="op" id="1445881">&amp;</span><span class="ident" id="1445882">rw</span><span class="op" id="1445884">.</span><span class="ident" id="1445885">writerSem</span><span class="op" id="1445894">)</span><span class="op" id="1445895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445899">raceDisable</span><span class="op" id="1445910">(</span><span class="op" id="1445911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1445914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1445918">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1445969">r</span>&nbsp;<span class="op" id="1445971">:=</span>&nbsp;<span class="ident" id="1445974">atomic</span><span class="op" id="1445980">.</span><span class="ident" id="1445981">AddInt32</span><span class="op" id="1445989">(</span><span class="op" id="1445990">&amp;</span><span class="ident" id="1445991">rw</span><span class="op" id="1445993">.</span><span class="ident" id="1445994">readerCount</span><span class="op" id="1446005">,</span>&nbsp;<span class="ident" id="1446007">rwmutexMaxReaders</span><span class="op" id="1446024">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446027">if</span>&nbsp;<span class="ident" id="1446030">r</span>&nbsp;<span class="op" id="1446032">&gt;=</span>&nbsp;<span class="ident" id="1446035">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1446053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446057">raceEnable</span><span class="op" id="1446067">(</span><span class="op" id="1446068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1446072">panic</span><span class="op" id="1446077">(</span><span class="string" id="1446078">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1446112">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446118">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446155">for</span>&nbsp;<span class="ident" id="1446159">i</span>&nbsp;<span class="op" id="1446161">:=</span>&nbsp;<span class="num" id="1446164">0</span><span class="op" id="1446165">;</span>&nbsp;<span class="ident" id="1446167">i</span>&nbsp;<span class="op" id="1446169">&lt;</span>&nbsp;<span class="builtintype" id="1446171">int</span><span class="op" id="1446174">(</span><span class="ident" id="1446175">r</span><span class="op" id="1446176">)</span><span class="op" id="1446177">;</span>&nbsp;<span class="ident" id="1446179">i</span><span class="op" id="1446180">++</span>&nbsp;<span class="op" id="1446183">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446187">runtime_Semrelease</span><span class="op" id="1446205">(</span><span class="op" id="1446206">&amp;</span><span class="ident" id="1446207">rw</span><span class="op" id="1446209">.</span><span class="ident" id="1446210">readerSem</span><span class="op" id="1446219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446222">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1446225">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446261">rw</span><span class="op" id="1446263">.</span><span class="ident" id="1446264">w</span><span class="op" id="1446265">.</span><span class="ident" id="1446266">Unlock</span><span class="op" id="1446272">(</span><span class="op" id="1446273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446276">if</span>&nbsp;<span class="ident" id="1446279">raceenabled</span>&nbsp;<span class="op" id="1446291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1446295">raceEnable</span><span class="op" id="1446305">(</span><span class="op" id="1446306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1446309">}</span><br>
<span class="lineno">125</span><span class="op" id="1446311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1446314">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1446368">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1446435">func</span>&nbsp;<span class="op" id="1446440">(</span><span class="ident" id="1446441">rw</span>&nbsp;<span class="op" id="1446444">*</span><span class="ident" id="1446445">RWMutex</span><span class="op" id="1446452">)</span>&nbsp;<span class="ident" id="1446454">RLocker</span><span class="op" id="1446461">(</span><span class="op" id="1446462">)</span>&nbsp;<span class="ident" id="1446464">Locker</span>&nbsp;<span class="op" id="1446471">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1446474">return</span>&nbsp;<span class="op" id="1446481">(</span><span class="op" id="1446482">*</span><span class="ident" id="1446483">rlocker</span><span class="op" id="1446490">)</span><span class="op" id="1446491">(</span><span class="ident" id="1446492">rw</span><span class="op" id="1446494">)</span><br>
<span class="lineno"></span><span class="op" id="1446496">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1446499">type</span>&nbsp;<span class="ident" id="1446504">rlocker</span>&nbsp;<span class="ident" id="1446512">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1446521">func</span>&nbsp;<span class="op" id="1446526">(</span><span class="ident" id="1446527">r</span>&nbsp;<span class="op" id="1446529">*</span><span class="ident" id="1446530">rlocker</span><span class="op" id="1446537">)</span>&nbsp;<span class="ident" id="1446539">Lock</span><span class="op" id="1446543">(</span><span class="op" id="1446544">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1446548">{</span>&nbsp;<span class="op" id="1446550">(</span><span class="op" id="1446551">*</span><span class="ident" id="1446552">RWMutex</span><span class="op" id="1446559">)</span><span class="op" id="1446560">(</span><span class="ident" id="1446561">r</span><span class="op" id="1446562">)</span><span class="op" id="1446563">.</span><span class="ident" id="1446564">RLock</span><span class="op" id="1446569">(</span><span class="op" id="1446570">)</span>&nbsp;<span class="op" id="1446572">}</span><br>
<span class="lineno"></span><span class="keyword" id="1446574">func</span>&nbsp;<span class="op" id="1446579">(</span><span class="ident" id="1446580">r</span>&nbsp;<span class="op" id="1446582">*</span><span class="ident" id="1446583">rlocker</span><span class="op" id="1446590">)</span>&nbsp;<span class="ident" id="1446592">Unlock</span><span class="op" id="1446598">(</span><span class="op" id="1446599">)</span>&nbsp;<span class="op" id="1446601">{</span>&nbsp;<span class="op" id="1446603">(</span><span class="op" id="1446604">*</span><span class="ident" id="1446605">RWMutex</span><span class="op" id="1446612">)</span><span class="op" id="1446613">(</span><span class="ident" id="1446614">r</span><span class="op" id="1446615">)</span><span class="op" id="1446616">.</span><span class="ident" id="1446617">RUnlock</span><span class="op" id="1446624">(</span><span class="op" id="1446625">)</span>&nbsp;<span class="op" id="1446627">}</span>
</div>
</body>
</html>
