<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html" class="current">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5152079">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5152135">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5152189">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5152240">package</span>&nbsp;<span class="ident" id="5152248">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5152256">import</span>&nbsp;<span class="op" id="5152263">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5152266">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5152275">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5152292">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5152300">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5152310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5152313">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="5152345">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="5152411">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="5152483">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="5152537">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="5152585">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5152653">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="5152721">type</span>&nbsp;<span class="ident" id="5152726">onePassProg</span>&nbsp;<span class="keyword" id="5152738">struct</span>&nbsp;<span class="op" id="5152745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152748">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5152755">[</span><span class="op" id="5152756">]</span><span class="ident" id="5152757">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152770">Start</span>&nbsp;&nbsp;<span class="builtintype" id="5152777">int</span>&nbsp;<span class="comment" id="5152781">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5152812">NumCap</span>&nbsp;<span class="builtintype" id="5152819">int</span>&nbsp;<span class="comment" id="5152823">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="5152860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5152863">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="5152946">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="5153012">type</span>&nbsp;<span class="ident" id="5153017">onePassInst</span>&nbsp;<span class="keyword" id="5153029">struct</span>&nbsp;<span class="op" id="5153036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153039">syntax</span><span class="op" id="5153045">.</span><span class="ident" id="5153046">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153052">Next</span>&nbsp;<span class="op" id="5153057">[</span><span class="op" id="5153058">]</span><span class="builtintype" id="5153059">uint32</span><br>
<span class="lineno"></span><span class="op" id="5153066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5153069">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5153136">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="5153195">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5153264">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="5153325">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="5153343">func</span>&nbsp;<span class="ident" id="5153348">onePassPrefix</span><span class="op" id="5153361">(</span><span class="ident" id="5153362">p</span>&nbsp;<span class="op" id="5153364">*</span><span class="ident" id="5153365">syntax</span><span class="op" id="5153371">.</span><span class="ident" id="5153372">Prog</span><span class="op" id="5153376">)</span>&nbsp;<span class="op" id="5153378">(</span><span class="ident" id="5153379">prefix</span>&nbsp;<span class="builtintype" id="5153386">string</span><span class="op" id="5153392">,</span>&nbsp;<span class="ident" id="5153394">complete</span>&nbsp;<span class="builtintype" id="5153403">bool</span><span class="op" id="5153407">,</span>&nbsp;<span class="ident" id="5153409">pc</span>&nbsp;<span class="builtintype" id="5153412">uint32</span><span class="op" id="5153418">)</span>&nbsp;<span class="op" id="5153420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153423">i</span>&nbsp;<span class="op" id="5153425">:=</span>&nbsp;<span class="op" id="5153428">&amp;</span><span class="ident" id="5153429">p</span><span class="op" id="5153430">.</span><span class="ident" id="5153431">Inst</span><span class="op" id="5153435">[</span><span class="ident" id="5153436">p</span><span class="op" id="5153437">.</span><span class="ident" id="5153438">Start</span><span class="op" id="5153443">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153446">if</span>&nbsp;<span class="ident" id="5153449">i</span><span class="op" id="5153450">.</span><span class="ident" id="5153451">Op</span>&nbsp;<span class="op" id="5153454">!=</span>&nbsp;<span class="ident" id="5153457">syntax</span><span class="op" id="5153463">.</span><span class="ident" id="5153464">InstEmptyWidth</span>&nbsp;<span class="op" id="5153479">||</span>&nbsp;<span class="op" id="5153482">(</span><span class="ident" id="5153483">syntax</span><span class="op" id="5153489">.</span><span class="ident" id="5153490">EmptyOp</span><span class="op" id="5153497">(</span><span class="ident" id="5153498">i</span><span class="op" id="5153499">.</span><span class="ident" id="5153500">Arg</span><span class="op" id="5153503">)</span><span class="op" id="5153504">)</span><span class="op" id="5153505">&amp;</span><span class="ident" id="5153506">syntax</span><span class="op" id="5153512">.</span><span class="ident" id="5153513">EmptyBeginText</span>&nbsp;<span class="op" id="5153528">==</span>&nbsp;<span class="num" id="5153531">0</span>&nbsp;<span class="op" id="5153533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153537">return</span>&nbsp;<span class="string" id="5153544">&#34;&#34;</span><span class="op" id="5153546">,</span>&nbsp;<span class="ident" id="5153548">i</span><span class="op" id="5153549">.</span><span class="ident" id="5153550">Op</span>&nbsp;<span class="op" id="5153553">==</span>&nbsp;<span class="ident" id="5153556">syntax</span><span class="op" id="5153562">.</span><span class="ident" id="5153563">InstMatch</span><span class="op" id="5153572">,</span>&nbsp;<span class="builtintype" id="5153574">uint32</span><span class="op" id="5153580">(</span><span class="ident" id="5153581">p</span><span class="op" id="5153582">.</span><span class="ident" id="5153583">Start</span><span class="op" id="5153588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153591">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153594">pc</span>&nbsp;<span class="op" id="5153597">=</span>&nbsp;<span class="ident" id="5153599">i</span><span class="op" id="5153600">.</span><span class="ident" id="5153601">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153606">i</span>&nbsp;<span class="op" id="5153608">=</span>&nbsp;<span class="op" id="5153610">&amp;</span><span class="ident" id="5153611">p</span><span class="op" id="5153612">.</span><span class="ident" id="5153613">Inst</span><span class="op" id="5153617">[</span><span class="ident" id="5153618">pc</span><span class="op" id="5153620">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153623">for</span>&nbsp;<span class="ident" id="5153627">i</span><span class="op" id="5153628">.</span><span class="ident" id="5153629">Op</span>&nbsp;<span class="op" id="5153632">==</span>&nbsp;<span class="ident" id="5153635">syntax</span><span class="op" id="5153641">.</span><span class="ident" id="5153642">InstNop</span>&nbsp;<span class="op" id="5153650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153654">pc</span>&nbsp;<span class="op" id="5153657">=</span>&nbsp;<span class="ident" id="5153659">i</span><span class="op" id="5153660">.</span><span class="ident" id="5153661">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5153667">i</span>&nbsp;<span class="op" id="5153669">=</span>&nbsp;<span class="op" id="5153671">&amp;</span><span class="ident" id="5153672">p</span><span class="op" id="5153673">.</span><span class="ident" id="5153674">Inst</span><span class="op" id="5153678">[</span><span class="ident" id="5153679">pc</span><span class="op" id="5153681">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5153687">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153738">if</span>&nbsp;<span class="ident" id="5153741">iop</span><span class="op" id="5153744">(</span><span class="ident" id="5153745">i</span><span class="op" id="5153746">)</span>&nbsp;<span class="op" id="5153748">!=</span>&nbsp;<span class="ident" id="5153751">syntax</span><span class="op" id="5153757">.</span><span class="ident" id="5153758">InstRune</span>&nbsp;<span class="op" id="5153767">||</span>&nbsp;<span class="builtinfunc" id="5153770">len</span><span class="op" id="5153773">(</span><span class="ident" id="5153774">i</span><span class="op" id="5153775">.</span><span class="ident" id="5153776">Rune</span><span class="op" id="5153780">)</span>&nbsp;<span class="op" id="5153782">!=</span>&nbsp;<span class="num" id="5153785">1</span>&nbsp;<span class="op" id="5153787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153791">return</span>&nbsp;<span class="string" id="5153798">&#34;&#34;</span><span class="op" id="5153800">,</span>&nbsp;<span class="ident" id="5153802">i</span><span class="op" id="5153803">.</span><span class="ident" id="5153804">Op</span>&nbsp;<span class="op" id="5153807">==</span>&nbsp;<span class="ident" id="5153810">syntax</span><span class="op" id="5153816">.</span><span class="ident" id="5153817">InstMatch</span><span class="op" id="5153826">,</span>&nbsp;<span class="builtintype" id="5153828">uint32</span><span class="op" id="5153834">(</span><span class="ident" id="5153835">p</span><span class="op" id="5153836">.</span><span class="ident" id="5153837">Start</span><span class="op" id="5153842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5153845">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5153849">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153885">var</span>&nbsp;<span class="ident" id="5153889">buf</span>&nbsp;<span class="ident" id="5153893">bytes</span><span class="op" id="5153898">.</span><span class="ident" id="5153899">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5153907">for</span>&nbsp;<span class="ident" id="5153911">iop</span><span class="op" id="5153914">(</span><span class="ident" id="5153915">i</span><span class="op" id="5153916">)</span>&nbsp;<span class="op" id="5153918">==</span>&nbsp;<span class="ident" id="5153921">syntax</span><span class="op" id="5153927">.</span><span class="ident" id="5153928">InstRune</span>&nbsp;<span class="op" id="5153937">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5153940">len</span><span class="op" id="5153943">(</span><span class="ident" id="5153944">i</span><span class="op" id="5153945">.</span><span class="ident" id="5153946">Rune</span><span class="op" id="5153950">)</span>&nbsp;<span class="op" id="5153952">==</span>&nbsp;<span class="num" id="5153955">1</span>&nbsp;<span class="op" id="5153957">&amp;&amp;</span>&nbsp;<span class="ident" id="5153960">syntax</span><span class="op" id="5153966">.</span><span class="ident" id="5153967">Flags</span><span class="op" id="5153972">(</span><span class="ident" id="5153973">i</span><span class="op" id="5153974">.</span><span class="ident" id="5153975">Arg</span><span class="op" id="5153978">)</span><span class="op" id="5153979">&amp;</span><span class="ident" id="5153980">syntax</span><span class="op" id="5153986">.</span><span class="ident" id="5153987">FoldCase</span>&nbsp;<span class="op" id="5153996">==</span>&nbsp;<span class="num" id="5153999">0</span>&nbsp;<span class="op" id="5154001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154005">buf</span><span class="op" id="5154008">.</span><span class="ident" id="5154009">WriteRune</span><span class="op" id="5154018">(</span><span class="ident" id="5154019">i</span><span class="op" id="5154020">.</span><span class="ident" id="5154021">Rune</span><span class="op" id="5154025">[</span><span class="num" id="5154026">0</span><span class="op" id="5154027">]</span><span class="op" id="5154028">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154032">pc</span><span class="op" id="5154034">,</span>&nbsp;<span class="ident" id="5154036">i</span>&nbsp;<span class="op" id="5154038">=</span>&nbsp;<span class="ident" id="5154040">i</span><span class="op" id="5154041">.</span><span class="ident" id="5154042">Out</span><span class="op" id="5154045">,</span>&nbsp;<span class="op" id="5154047">&amp;</span><span class="ident" id="5154048">p</span><span class="op" id="5154049">.</span><span class="ident" id="5154050">Inst</span><span class="op" id="5154054">[</span><span class="ident" id="5154055">i</span><span class="op" id="5154056">.</span><span class="ident" id="5154057">Out</span><span class="op" id="5154060">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154066">return</span>&nbsp;<span class="ident" id="5154073">buf</span><span class="op" id="5154076">.</span><span class="ident" id="5154077">String</span><span class="op" id="5154083">(</span><span class="op" id="5154084">)</span><span class="op" id="5154085">,</span>&nbsp;<span class="ident" id="5154087">i</span><span class="op" id="5154088">.</span><span class="ident" id="5154089">Op</span>&nbsp;<span class="op" id="5154092">==</span>&nbsp;<span class="ident" id="5154095">syntax</span><span class="op" id="5154101">.</span><span class="ident" id="5154102">InstEmptyWidth</span>&nbsp;<span class="op" id="5154117">&amp;&amp;</span>&nbsp;<span class="op" id="5154120">(</span><span class="ident" id="5154121">syntax</span><span class="op" id="5154127">.</span><span class="ident" id="5154128">EmptyOp</span><span class="op" id="5154135">(</span><span class="ident" id="5154136">i</span><span class="op" id="5154137">.</span><span class="ident" id="5154138">Arg</span><span class="op" id="5154141">)</span><span class="op" id="5154142">)</span><span class="op" id="5154143">&amp;</span><span class="ident" id="5154144">syntax</span><span class="op" id="5154150">.</span><span class="ident" id="5154151">EmptyBeginText</span>&nbsp;<span class="op" id="5154166">!=</span>&nbsp;<span class="num" id="5154169">0</span><span class="op" id="5154170">,</span>&nbsp;<span class="ident" id="5154172">pc</span><br>
<span class="lineno"></span><span class="op" id="5154175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="5154178">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5154270">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="5154367">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="5154461">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="5154546">func</span>&nbsp;<span class="ident" id="5154551">onePassNext</span><span class="op" id="5154562">(</span><span class="ident" id="5154563">i</span>&nbsp;<span class="op" id="5154565">*</span><span class="ident" id="5154566">onePassInst</span><span class="op" id="5154577">,</span>&nbsp;<span class="ident" id="5154579">r</span>&nbsp;<span class="builtintype" id="5154581">rune</span><span class="op" id="5154585">)</span>&nbsp;<span class="builtintype" id="5154587">uint32</span>&nbsp;<span class="op" id="5154594">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154597">next</span>&nbsp;<span class="op" id="5154602">:=</span>&nbsp;<span class="ident" id="5154605">i</span><span class="op" id="5154606">.</span><span class="ident" id="5154607">MatchRunePos</span><span class="op" id="5154619">(</span><span class="ident" id="5154620">r</span><span class="op" id="5154621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154624">if</span>&nbsp;<span class="ident" id="5154627">next</span>&nbsp;<span class="op" id="5154632">&gt;=</span>&nbsp;<span class="num" id="5154635">0</span>&nbsp;<span class="op" id="5154637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154641">return</span>&nbsp;<span class="ident" id="5154648">i</span><span class="op" id="5154649">.</span><span class="ident" id="5154650">Next</span><span class="op" id="5154654">[</span><span class="ident" id="5154655">next</span><span class="op" id="5154659">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154662">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154665">if</span>&nbsp;<span class="ident" id="5154668">i</span><span class="op" id="5154669">.</span><span class="ident" id="5154670">Op</span>&nbsp;<span class="op" id="5154673">==</span>&nbsp;<span class="ident" id="5154676">syntax</span><span class="op" id="5154682">.</span><span class="ident" id="5154683">InstAltMatch</span>&nbsp;<span class="op" id="5154696">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154700">return</span>&nbsp;<span class="ident" id="5154707">i</span><span class="op" id="5154708">.</span><span class="ident" id="5154709">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154717">return</span>&nbsp;<span class="num" id="5154724">0</span><br>
<span class="lineno"></span><span class="op" id="5154726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5154729">func</span>&nbsp;<span class="ident" id="5154734">iop</span><span class="op" id="5154737">(</span><span class="ident" id="5154738">i</span>&nbsp;<span class="op" id="5154740">*</span><span class="ident" id="5154741">syntax</span><span class="op" id="5154747">.</span><span class="ident" id="5154748">Inst</span><span class="op" id="5154752">)</span>&nbsp;<span class="ident" id="5154754">syntax</span><span class="op" id="5154760">.</span><span class="ident" id="5154761">InstOp</span>&nbsp;<span class="op" id="5154768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154771">op</span>&nbsp;<span class="op" id="5154774">:=</span>&nbsp;<span class="ident" id="5154777">i</span><span class="op" id="5154778">.</span><span class="ident" id="5154779">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154783">switch</span>&nbsp;<span class="ident" id="5154790">op</span>&nbsp;<span class="op" id="5154793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154796">case</span>&nbsp;<span class="ident" id="5154801">syntax</span><span class="op" id="5154807">.</span><span class="ident" id="5154808">InstRune1</span><span class="op" id="5154817">,</span>&nbsp;<span class="ident" id="5154819">syntax</span><span class="op" id="5154825">.</span><span class="ident" id="5154826">InstRuneAny</span><span class="op" id="5154837">,</span>&nbsp;<span class="ident" id="5154839">syntax</span><span class="op" id="5154845">.</span><span class="ident" id="5154846">InstRuneAnyNotNL</span><span class="op" id="5154862">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154866">op</span>&nbsp;<span class="op" id="5154869">=</span>&nbsp;<span class="ident" id="5154871">syntax</span><span class="op" id="5154877">.</span><span class="ident" id="5154878">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5154888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5154891">return</span>&nbsp;<span class="ident" id="5154898">op</span><br>
<span class="lineno"></span><span class="op" id="5154901">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5154904">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="5154962">type</span>&nbsp;<span class="ident" id="5154967">queueOnePass</span>&nbsp;<span class="keyword" id="5154980">struct</span>&nbsp;<span class="op" id="5154987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5154990">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155006">[</span><span class="op" id="5155007">]</span><span class="builtintype" id="5155008">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155016">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155032">[</span><span class="op" id="5155033">]</span><span class="builtintype" id="5155034">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155042">size</span><span class="op" id="5155046">,</span>&nbsp;<span class="ident" id="5155048">nextIndex</span>&nbsp;<span class="builtintype" id="5155058">uint32</span><br>
<span class="lineno"></span><span class="op" id="5155065">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5155068">func</span>&nbsp;<span class="op" id="5155073">(</span><span class="ident" id="5155074">q</span>&nbsp;<span class="op" id="5155076">*</span><span class="ident" id="5155077">queueOnePass</span><span class="op" id="5155089">)</span>&nbsp;<span class="ident" id="5155091">empty</span><span class="op" id="5155096">(</span><span class="op" id="5155097">)</span>&nbsp;<span class="builtintype" id="5155099">bool</span>&nbsp;<span class="op" id="5155104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155107">return</span>&nbsp;<span class="ident" id="5155114">q</span><span class="op" id="5155115">.</span><span class="ident" id="5155116">nextIndex</span>&nbsp;<span class="op" id="5155126">&gt;=</span>&nbsp;<span class="ident" id="5155129">q</span><span class="op" id="5155130">.</span><span class="ident" id="5155131">size</span><br>
<span class="lineno"></span><span class="op" id="5155136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="5155139">func</span>&nbsp;<span class="op" id="5155144">(</span><span class="ident" id="5155145">q</span>&nbsp;<span class="op" id="5155147">*</span><span class="ident" id="5155148">queueOnePass</span><span class="op" id="5155160">)</span>&nbsp;<span class="ident" id="5155162">next</span><span class="op" id="5155166">(</span><span class="op" id="5155167">)</span>&nbsp;<span class="op" id="5155169">(</span><span class="ident" id="5155170">n</span>&nbsp;<span class="builtintype" id="5155172">uint32</span><span class="op" id="5155178">)</span>&nbsp;<span class="op" id="5155180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155183">n</span>&nbsp;<span class="op" id="5155185">=</span>&nbsp;<span class="ident" id="5155187">q</span><span class="op" id="5155188">.</span><span class="ident" id="5155189">dense</span><span class="op" id="5155194">[</span><span class="ident" id="5155195">q</span><span class="op" id="5155196">.</span><span class="ident" id="5155197">nextIndex</span><span class="op" id="5155206">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155209">q</span><span class="op" id="5155210">.</span><span class="ident" id="5155211">nextIndex</span><span class="op" id="5155220">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155224">return</span><br>
<span class="lineno"></span><span class="op" id="5155231">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5155234">func</span>&nbsp;<span class="op" id="5155239">(</span><span class="ident" id="5155240">q</span>&nbsp;<span class="op" id="5155242">*</span><span class="ident" id="5155243">queueOnePass</span><span class="op" id="5155255">)</span>&nbsp;<span class="ident" id="5155257">clear</span><span class="op" id="5155262">(</span><span class="op" id="5155263">)</span>&nbsp;<span class="op" id="5155265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155268">q</span><span class="op" id="5155269">.</span><span class="ident" id="5155270">size</span>&nbsp;<span class="op" id="5155275">=</span>&nbsp;<span class="num" id="5155277">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155280">q</span><span class="op" id="5155281">.</span><span class="ident" id="5155282">nextIndex</span>&nbsp;<span class="op" id="5155292">=</span>&nbsp;<span class="num" id="5155294">0</span><br>
<span class="lineno"></span><span class="op" id="5155296">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5155299">func</span>&nbsp;<span class="op" id="5155304">(</span><span class="ident" id="5155305">q</span>&nbsp;<span class="op" id="5155307">*</span><span class="ident" id="5155308">queueOnePass</span><span class="op" id="5155320">)</span>&nbsp;<span class="ident" id="5155322">reset</span><span class="op" id="5155327">(</span><span class="op" id="5155328">)</span>&nbsp;<span class="op" id="5155330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155333">q</span><span class="op" id="5155334">.</span><span class="ident" id="5155335">nextIndex</span>&nbsp;<span class="op" id="5155345">=</span>&nbsp;<span class="num" id="5155347">0</span><br>
<span class="lineno"></span><span class="op" id="5155349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="5155352">func</span>&nbsp;<span class="op" id="5155357">(</span><span class="ident" id="5155358">q</span>&nbsp;<span class="op" id="5155360">*</span><span class="ident" id="5155361">queueOnePass</span><span class="op" id="5155373">)</span>&nbsp;<span class="ident" id="5155375">contains</span><span class="op" id="5155383">(</span><span class="ident" id="5155384">u</span>&nbsp;<span class="builtintype" id="5155386">uint32</span><span class="op" id="5155392">)</span>&nbsp;<span class="builtintype" id="5155394">bool</span>&nbsp;<span class="op" id="5155399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155402">if</span>&nbsp;<span class="ident" id="5155405">u</span>&nbsp;<span class="op" id="5155407">&gt;=</span>&nbsp;<span class="builtintype" id="5155410">uint32</span><span class="op" id="5155416">(</span><span class="builtinfunc" id="5155417">len</span><span class="op" id="5155420">(</span><span class="ident" id="5155421">q</span><span class="op" id="5155422">.</span><span class="ident" id="5155423">sparse</span><span class="op" id="5155429">)</span><span class="op" id="5155430">)</span>&nbsp;<span class="op" id="5155432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155436">return</span>&nbsp;<span class="builtintype" id="5155443">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155453">return</span>&nbsp;<span class="ident" id="5155460">q</span><span class="op" id="5155461">.</span><span class="ident" id="5155462">sparse</span><span class="op" id="5155468">[</span><span class="ident" id="5155469">u</span><span class="op" id="5155470">]</span>&nbsp;<span class="op" id="5155472">&lt;</span>&nbsp;<span class="ident" id="5155474">q</span><span class="op" id="5155475">.</span><span class="ident" id="5155476">size</span>&nbsp;<span class="op" id="5155481">&amp;&amp;</span>&nbsp;<span class="ident" id="5155484">q</span><span class="op" id="5155485">.</span><span class="ident" id="5155486">dense</span><span class="op" id="5155491">[</span><span class="ident" id="5155492">q</span><span class="op" id="5155493">.</span><span class="ident" id="5155494">sparse</span><span class="op" id="5155500">[</span><span class="ident" id="5155501">u</span><span class="op" id="5155502">]</span><span class="op" id="5155503">]</span>&nbsp;<span class="op" id="5155505">==</span>&nbsp;<span class="ident" id="5155508">u</span><br>
<span class="lineno">120</span><span class="op" id="5155510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155513">func</span>&nbsp;<span class="op" id="5155518">(</span><span class="ident" id="5155519">q</span>&nbsp;<span class="op" id="5155521">*</span><span class="ident" id="5155522">queueOnePass</span><span class="op" id="5155534">)</span>&nbsp;<span class="ident" id="5155536">insert</span><span class="op" id="5155542">(</span><span class="ident" id="5155543">u</span>&nbsp;<span class="builtintype" id="5155545">uint32</span><span class="op" id="5155551">)</span>&nbsp;<span class="op" id="5155553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155556">if</span>&nbsp;<span class="op" id="5155559">!</span><span class="ident" id="5155560">q</span><span class="op" id="5155561">.</span><span class="ident" id="5155562">contains</span><span class="op" id="5155570">(</span><span class="ident" id="5155571">u</span><span class="op" id="5155572">)</span>&nbsp;<span class="op" id="5155574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155578">q</span><span class="op" id="5155579">.</span><span class="ident" id="5155580">insertNew</span><span class="op" id="5155589">(</span><span class="ident" id="5155590">u</span><span class="op" id="5155591">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155594">}</span><br>
<span class="lineno"></span><span class="op" id="5155596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155599">func</span>&nbsp;<span class="op" id="5155604">(</span><span class="ident" id="5155605">q</span>&nbsp;<span class="op" id="5155607">*</span><span class="ident" id="5155608">queueOnePass</span><span class="op" id="5155620">)</span>&nbsp;<span class="ident" id="5155622">insertNew</span><span class="op" id="5155631">(</span><span class="ident" id="5155632">u</span>&nbsp;<span class="builtintype" id="5155634">uint32</span><span class="op" id="5155640">)</span>&nbsp;<span class="op" id="5155642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155645">if</span>&nbsp;<span class="ident" id="5155648">u</span>&nbsp;<span class="op" id="5155650">&gt;=</span>&nbsp;<span class="builtintype" id="5155653">uint32</span><span class="op" id="5155659">(</span><span class="builtinfunc" id="5155660">len</span><span class="op" id="5155663">(</span><span class="ident" id="5155664">q</span><span class="op" id="5155665">.</span><span class="ident" id="5155666">sparse</span><span class="op" id="5155672">)</span><span class="op" id="5155673">)</span>&nbsp;<span class="op" id="5155675">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155679">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155690">q</span><span class="op" id="5155691">.</span><span class="ident" id="5155692">sparse</span><span class="op" id="5155698">[</span><span class="ident" id="5155699">u</span><span class="op" id="5155700">]</span>&nbsp;<span class="op" id="5155702">=</span>&nbsp;<span class="ident" id="5155704">q</span><span class="op" id="5155705">.</span><span class="ident" id="5155706">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155712">q</span><span class="op" id="5155713">.</span><span class="ident" id="5155714">dense</span><span class="op" id="5155719">[</span><span class="ident" id="5155720">q</span><span class="op" id="5155721">.</span><span class="ident" id="5155722">size</span><span class="op" id="5155726">]</span>&nbsp;<span class="op" id="5155728">=</span>&nbsp;<span class="ident" id="5155730">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155733">q</span><span class="op" id="5155734">.</span><span class="ident" id="5155735">size</span><span class="op" id="5155739">++</span><br>
<span class="lineno">135</span><span class="op" id="5155742">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5155745">func</span>&nbsp;<span class="ident" id="5155750">newQueue</span><span class="op" id="5155758">(</span><span class="ident" id="5155759">size</span>&nbsp;<span class="builtintype" id="5155764">int</span><span class="op" id="5155767">)</span>&nbsp;<span class="op" id="5155769">(</span><span class="ident" id="5155770">q</span>&nbsp;<span class="op" id="5155772">*</span><span class="ident" id="5155773">queueOnePass</span><span class="op" id="5155785">)</span>&nbsp;<span class="op" id="5155787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5155790">return</span>&nbsp;<span class="op" id="5155797">&amp;</span><span class="ident" id="5155798">queueOnePass</span><span class="op" id="5155810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155814">sparse</span><span class="op" id="5155820">:</span>&nbsp;<span class="builtinfunc" id="5155822">make</span><span class="op" id="5155826">(</span><span class="op" id="5155827">[</span><span class="op" id="5155828">]</span><span class="builtintype" id="5155829">uint32</span><span class="op" id="5155835">,</span>&nbsp;<span class="ident" id="5155837">size</span><span class="op" id="5155841">)</span><span class="op" id="5155842">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5155846">dense</span><span class="op" id="5155851">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="5155854">make</span><span class="op" id="5155858">(</span><span class="op" id="5155859">[</span><span class="op" id="5155860">]</span><span class="builtintype" id="5155861">uint32</span><span class="op" id="5155867">,</span>&nbsp;<span class="ident" id="5155869">size</span><span class="op" id="5155873">)</span><span class="op" id="5155874">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5155877">}</span><br>
<span class="lineno"></span><span class="op" id="5155879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5155882">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="5155968">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="5156052">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="5156137">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="5156202">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="5156288">const</span>&nbsp;<span class="ident" id="5156294">mergeFailed</span>&nbsp;<span class="op" id="5156306">=</span>&nbsp;<span class="builtintype" id="5156308">uint32</span><span class="op" id="5156314">(</span><span class="num" id="5156315">0xffffffff</span><span class="op" id="5156325">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="5156328">var</span>&nbsp;<span class="op" id="5156332">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156335">noRune</span>&nbsp;<span class="op" id="5156342">=</span>&nbsp;<span class="op" id="5156344">[</span><span class="op" id="5156345">]</span><span class="builtintype" id="5156346">rune</span><span class="op" id="5156350">{</span><span class="op" id="5156351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156354">noNext</span>&nbsp;<span class="op" id="5156361">=</span>&nbsp;<span class="op" id="5156363">[</span><span class="op" id="5156364">]</span><span class="builtintype" id="5156365">uint32</span><span class="op" id="5156371">{</span><span class="ident" id="5156372">mergeFailed</span><span class="op" id="5156383">}</span><br>
<span class="lineno"></span><span class="op" id="5156385">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="5156388">func</span>&nbsp;<span class="ident" id="5156393">mergeRuneSets</span><span class="op" id="5156406">(</span><span class="ident" id="5156407">leftRunes</span><span class="op" id="5156416">,</span>&nbsp;<span class="ident" id="5156418">rightRunes</span>&nbsp;<span class="op" id="5156429">*</span><span class="op" id="5156430">[</span><span class="op" id="5156431">]</span><span class="builtintype" id="5156432">rune</span><span class="op" id="5156436">,</span>&nbsp;<span class="ident" id="5156438">leftPC</span><span class="op" id="5156444">,</span>&nbsp;<span class="ident" id="5156446">rightPC</span>&nbsp;<span class="builtintype" id="5156454">uint32</span><span class="op" id="5156460">)</span>&nbsp;<span class="op" id="5156462">(</span><span class="op" id="5156463">[</span><span class="op" id="5156464">]</span><span class="builtintype" id="5156465">rune</span><span class="op" id="5156469">,</span>&nbsp;<span class="op" id="5156471">[</span><span class="op" id="5156472">]</span><span class="builtintype" id="5156473">uint32</span><span class="op" id="5156479">)</span>&nbsp;<span class="op" id="5156481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156484">leftLen</span>&nbsp;<span class="op" id="5156492">:=</span>&nbsp;<span class="builtinfunc" id="5156495">len</span><span class="op" id="5156498">(</span><span class="op" id="5156499">*</span><span class="ident" id="5156500">leftRunes</span><span class="op" id="5156509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156512">rightLen</span>&nbsp;<span class="op" id="5156521">:=</span>&nbsp;<span class="builtinfunc" id="5156524">len</span><span class="op" id="5156527">(</span><span class="op" id="5156528">*</span><span class="ident" id="5156529">rightRunes</span><span class="op" id="5156539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156542">if</span>&nbsp;<span class="ident" id="5156545">leftLen</span><span class="op" id="5156552">&amp;</span><span class="num" id="5156553">0x1</span>&nbsp;<span class="op" id="5156557">!=</span>&nbsp;<span class="num" id="5156560">0</span>&nbsp;<span class="op" id="5156562">||</span>&nbsp;<span class="ident" id="5156565">rightLen</span><span class="op" id="5156573">&amp;</span><span class="num" id="5156574">0x1</span>&nbsp;<span class="op" id="5156578">!=</span>&nbsp;<span class="num" id="5156581">0</span>&nbsp;<span class="op" id="5156583">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5156587">panic</span><span class="op" id="5156592">(</span><span class="string" id="5156593">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="5156626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156632">var</span>&nbsp;<span class="op" id="5156636">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156640">lx</span><span class="op" id="5156642">,</span>&nbsp;<span class="ident" id="5156644">rx</span>&nbsp;<span class="builtintype" id="5156647">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156652">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156655">merged</span>&nbsp;<span class="op" id="5156662">:=</span>&nbsp;<span class="builtinfunc" id="5156665">make</span><span class="op" id="5156669">(</span><span class="op" id="5156670">[</span><span class="op" id="5156671">]</span><span class="builtintype" id="5156672">rune</span><span class="op" id="5156676">,</span>&nbsp;<span class="num" id="5156678">0</span><span class="op" id="5156679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156682">next</span>&nbsp;<span class="op" id="5156687">:=</span>&nbsp;<span class="builtinfunc" id="5156690">make</span><span class="op" id="5156694">(</span><span class="op" id="5156695">[</span><span class="op" id="5156696">]</span><span class="builtintype" id="5156697">uint32</span><span class="op" id="5156703">,</span>&nbsp;<span class="num" id="5156705">0</span><span class="op" id="5156706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156709">ok</span>&nbsp;<span class="op" id="5156712">:=</span>&nbsp;<span class="builtintype" id="5156715">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156721">defer</span>&nbsp;<span class="keyword" id="5156727">func</span><span class="op" id="5156731">(</span><span class="op" id="5156732">)</span>&nbsp;<span class="op" id="5156734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156738">if</span>&nbsp;<span class="op" id="5156741">!</span><span class="ident" id="5156742">ok</span>&nbsp;<span class="op" id="5156745">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156750">merged</span>&nbsp;<span class="op" id="5156757">=</span>&nbsp;<span class="builtintype" id="5156759">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156766">next</span>&nbsp;<span class="op" id="5156771">=</span>&nbsp;<span class="builtintype" id="5156773">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156782">}</span><span class="op" id="5156783">(</span><span class="op" id="5156784">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156788">ix</span>&nbsp;<span class="op" id="5156791">:=</span>&nbsp;<span class="op" id="5156794">-</span><span class="num" id="5156795">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156798">extend</span>&nbsp;<span class="op" id="5156805">:=</span>&nbsp;<span class="keyword" id="5156808">func</span><span class="op" id="5156812">(</span><span class="ident" id="5156813">newLow</span>&nbsp;<span class="op" id="5156820">*</span><span class="builtintype" id="5156821">int</span><span class="op" id="5156824">,</span>&nbsp;<span class="ident" id="5156826">newArray</span>&nbsp;<span class="op" id="5156835">*</span><span class="op" id="5156836">[</span><span class="op" id="5156837">]</span><span class="builtintype" id="5156838">rune</span><span class="op" id="5156842">,</span>&nbsp;<span class="ident" id="5156844">pc</span>&nbsp;<span class="builtintype" id="5156847">uint32</span><span class="op" id="5156853">)</span>&nbsp;<span class="builtintype" id="5156855">bool</span>&nbsp;<span class="op" id="5156860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156864">if</span>&nbsp;<span class="ident" id="5156867">ix</span>&nbsp;<span class="op" id="5156870">&gt;</span>&nbsp;<span class="num" id="5156872">0</span>&nbsp;<span class="op" id="5156874">&amp;&amp;</span>&nbsp;<span class="op" id="5156877">(</span><span class="op" id="5156878">*</span><span class="ident" id="5156879">newArray</span><span class="op" id="5156887">)</span><span class="op" id="5156888">[</span><span class="op" id="5156889">*</span><span class="ident" id="5156890">newLow</span><span class="op" id="5156896">]</span>&nbsp;<span class="op" id="5156898">&lt;=</span>&nbsp;<span class="ident" id="5156901">merged</span><span class="op" id="5156907">[</span><span class="ident" id="5156908">ix</span><span class="op" id="5156910">]</span>&nbsp;<span class="op" id="5156912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5156917">return</span>&nbsp;<span class="builtintype" id="5156924">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5156932">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5156936">merged</span>&nbsp;<span class="op" id="5156943">=</span>&nbsp;<span class="builtinfunc" id="5156945">append</span><span class="op" id="5156951">(</span><span class="ident" id="5156952">merged</span><span class="op" id="5156958">,</span>&nbsp;<span class="op" id="5156960">(</span><span class="op" id="5156961">*</span><span class="ident" id="5156962">newArray</span><span class="op" id="5156970">)</span><span class="op" id="5156971">[</span><span class="op" id="5156972">*</span><span class="ident" id="5156973">newLow</span><span class="op" id="5156979">]</span><span class="op" id="5156980">,</span>&nbsp;<span class="op" id="5156982">(</span><span class="op" id="5156983">*</span><span class="ident" id="5156984">newArray</span><span class="op" id="5156992">)</span><span class="op" id="5156993">[</span><span class="op" id="5156994">*</span><span class="ident" id="5156995">newLow</span><span class="op" id="5157001">+</span><span class="num" id="5157002">1</span><span class="op" id="5157003">]</span><span class="op" id="5157004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5157008">*</span><span class="ident" id="5157009">newLow</span>&nbsp;<span class="op" id="5157016">+=</span>&nbsp;<span class="num" id="5157019">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157023">ix</span>&nbsp;<span class="op" id="5157026">+=</span>&nbsp;<span class="num" id="5157029">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157033">next</span>&nbsp;<span class="op" id="5157038">=</span>&nbsp;<span class="builtinfunc" id="5157040">append</span><span class="op" id="5157046">(</span><span class="ident" id="5157047">next</span><span class="op" id="5157051">,</span>&nbsp;<span class="ident" id="5157053">pc</span><span class="op" id="5157055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157059">return</span>&nbsp;<span class="builtintype" id="5157066">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5157072">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157076">for</span>&nbsp;<span class="ident" id="5157080">lx</span>&nbsp;<span class="op" id="5157083">&lt;</span>&nbsp;<span class="ident" id="5157085">leftLen</span>&nbsp;<span class="op" id="5157093">||</span>&nbsp;<span class="ident" id="5157096">rx</span>&nbsp;<span class="op" id="5157099">&lt;</span>&nbsp;<span class="ident" id="5157101">rightLen</span>&nbsp;<span class="op" id="5157110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157114">switch</span>&nbsp;<span class="op" id="5157121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157125">case</span>&nbsp;<span class="ident" id="5157130">rx</span>&nbsp;<span class="op" id="5157133">&gt;=</span>&nbsp;<span class="ident" id="5157136">rightLen</span><span class="op" id="5157144">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157149">ok</span>&nbsp;<span class="op" id="5157152">=</span>&nbsp;<span class="ident" id="5157154">extend</span><span class="op" id="5157160">(</span><span class="op" id="5157161">&amp;</span><span class="ident" id="5157162">lx</span><span class="op" id="5157164">,</span>&nbsp;<span class="ident" id="5157166">leftRunes</span><span class="op" id="5157175">,</span>&nbsp;<span class="ident" id="5157177">leftPC</span><span class="op" id="5157183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157187">case</span>&nbsp;<span class="ident" id="5157192">lx</span>&nbsp;<span class="op" id="5157195">&gt;=</span>&nbsp;<span class="ident" id="5157198">leftLen</span><span class="op" id="5157205">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157210">ok</span>&nbsp;<span class="op" id="5157213">=</span>&nbsp;<span class="ident" id="5157215">extend</span><span class="op" id="5157221">(</span><span class="op" id="5157222">&amp;</span><span class="ident" id="5157223">rx</span><span class="op" id="5157225">,</span>&nbsp;<span class="ident" id="5157227">rightRunes</span><span class="op" id="5157237">,</span>&nbsp;<span class="ident" id="5157239">rightPC</span><span class="op" id="5157246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157250">case</span>&nbsp;<span class="op" id="5157255">(</span><span class="op" id="5157256">*</span><span class="ident" id="5157257">rightRunes</span><span class="op" id="5157267">)</span><span class="op" id="5157268">[</span><span class="ident" id="5157269">rx</span><span class="op" id="5157271">]</span>&nbsp;<span class="op" id="5157273">&lt;</span>&nbsp;<span class="op" id="5157275">(</span><span class="op" id="5157276">*</span><span class="ident" id="5157277">leftRunes</span><span class="op" id="5157286">)</span><span class="op" id="5157287">[</span><span class="ident" id="5157288">lx</span><span class="op" id="5157290">]</span><span class="op" id="5157291">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157296">ok</span>&nbsp;<span class="op" id="5157299">=</span>&nbsp;<span class="ident" id="5157301">extend</span><span class="op" id="5157307">(</span><span class="op" id="5157308">&amp;</span><span class="ident" id="5157309">rx</span><span class="op" id="5157311">,</span>&nbsp;<span class="ident" id="5157313">rightRunes</span><span class="op" id="5157323">,</span>&nbsp;<span class="ident" id="5157325">rightPC</span><span class="op" id="5157332">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157336">default</span><span class="op" id="5157343">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157348">ok</span>&nbsp;<span class="op" id="5157351">=</span>&nbsp;<span class="ident" id="5157353">extend</span><span class="op" id="5157359">(</span><span class="op" id="5157360">&amp;</span><span class="ident" id="5157361">lx</span><span class="op" id="5157363">,</span>&nbsp;<span class="ident" id="5157365">leftRunes</span><span class="op" id="5157374">,</span>&nbsp;<span class="ident" id="5157376">leftPC</span><span class="op" id="5157382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5157386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157390">if</span>&nbsp;<span class="op" id="5157393">!</span><span class="ident" id="5157394">ok</span>&nbsp;<span class="op" id="5157397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157402">return</span>&nbsp;<span class="ident" id="5157409">noRune</span><span class="op" id="5157415">,</span>&nbsp;<span class="ident" id="5157417">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5157426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5157429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157432">return</span>&nbsp;<span class="ident" id="5157439">merged</span><span class="op" id="5157445">,</span>&nbsp;<span class="ident" id="5157447">next</span><br>
<span class="lineno"></span><span class="op" id="5157452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="5157455">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="5157539">func</span>&nbsp;<span class="ident" id="5157544">cleanupOnePass</span><span class="op" id="5157558">(</span><span class="ident" id="5157559">prog</span>&nbsp;<span class="op" id="5157564">*</span><span class="ident" id="5157565">onePassProg</span><span class="op" id="5157576">,</span>&nbsp;<span class="ident" id="5157578">original</span>&nbsp;<span class="op" id="5157587">*</span><span class="ident" id="5157588">syntax</span><span class="op" id="5157594">.</span><span class="ident" id="5157595">Prog</span><span class="op" id="5157599">)</span>&nbsp;<span class="op" id="5157601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157604">for</span>&nbsp;<span class="ident" id="5157608">ix</span><span class="op" id="5157610">,</span>&nbsp;<span class="ident" id="5157612">instOriginal</span>&nbsp;<span class="op" id="5157625">:=</span>&nbsp;<span class="keyword" id="5157628">range</span>&nbsp;<span class="ident" id="5157634">original</span><span class="op" id="5157642">.</span><span class="ident" id="5157643">Inst</span>&nbsp;<span class="op" id="5157648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157652">switch</span>&nbsp;<span class="ident" id="5157659">instOriginal</span><span class="op" id="5157671">.</span><span class="ident" id="5157672">Op</span>&nbsp;<span class="op" id="5157675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157679">case</span>&nbsp;<span class="ident" id="5157684">syntax</span><span class="op" id="5157690">.</span><span class="ident" id="5157691">InstAlt</span><span class="op" id="5157698">,</span>&nbsp;<span class="ident" id="5157700">syntax</span><span class="op" id="5157706">.</span><span class="ident" id="5157707">InstAltMatch</span><span class="op" id="5157719">,</span>&nbsp;<span class="ident" id="5157721">syntax</span><span class="op" id="5157727">.</span><span class="ident" id="5157728">InstRune</span><span class="op" id="5157736">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157740">case</span>&nbsp;<span class="ident" id="5157745">syntax</span><span class="op" id="5157751">.</span><span class="ident" id="5157752">InstCapture</span><span class="op" id="5157763">,</span>&nbsp;<span class="ident" id="5157765">syntax</span><span class="op" id="5157771">.</span><span class="ident" id="5157772">InstEmptyWidth</span><span class="op" id="5157786">,</span>&nbsp;<span class="ident" id="5157788">syntax</span><span class="op" id="5157794">.</span><span class="ident" id="5157795">InstNop</span><span class="op" id="5157802">,</span>&nbsp;<span class="ident" id="5157804">syntax</span><span class="op" id="5157810">.</span><span class="ident" id="5157811">InstMatch</span><span class="op" id="5157820">,</span>&nbsp;<span class="ident" id="5157822">syntax</span><span class="op" id="5157828">.</span><span class="ident" id="5157829">InstFail</span><span class="op" id="5157837">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157842">prog</span><span class="op" id="5157846">.</span><span class="ident" id="5157847">Inst</span><span class="op" id="5157851">[</span><span class="ident" id="5157852">ix</span><span class="op" id="5157854">]</span><span class="op" id="5157855">.</span><span class="ident" id="5157856">Next</span>&nbsp;<span class="op" id="5157861">=</span>&nbsp;<span class="builtintype" id="5157863">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5157869">case</span>&nbsp;<span class="ident" id="5157874">syntax</span><span class="op" id="5157880">.</span><span class="ident" id="5157881">InstRune1</span><span class="op" id="5157890">,</span>&nbsp;<span class="ident" id="5157892">syntax</span><span class="op" id="5157898">.</span><span class="ident" id="5157899">InstRuneAny</span><span class="op" id="5157910">,</span>&nbsp;<span class="ident" id="5157912">syntax</span><span class="op" id="5157918">.</span><span class="ident" id="5157919">InstRuneAnyNotNL</span><span class="op" id="5157935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157940">prog</span><span class="op" id="5157944">.</span><span class="ident" id="5157945">Inst</span><span class="op" id="5157949">[</span><span class="ident" id="5157950">ix</span><span class="op" id="5157952">]</span><span class="op" id="5157953">.</span><span class="ident" id="5157954">Next</span>&nbsp;<span class="op" id="5157959">=</span>&nbsp;<span class="builtintype" id="5157961">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5157968">prog</span><span class="op" id="5157972">.</span><span class="ident" id="5157973">Inst</span><span class="op" id="5157977">[</span><span class="ident" id="5157978">ix</span><span class="op" id="5157980">]</span>&nbsp;<span class="op" id="5157982">=</span>&nbsp;<span class="ident" id="5157984">onePassInst</span><span class="op" id="5157995">{</span><span class="ident" id="5157996">Inst</span><span class="op" id="5158000">:</span>&nbsp;<span class="ident" id="5158002">instOriginal</span><span class="op" id="5158014">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158021">}</span><br>
<span class="lineno"></span><span class="op" id="5158023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5158026">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="5158103">func</span>&nbsp;<span class="ident" id="5158108">onePassCopy</span><span class="op" id="5158119">(</span><span class="ident" id="5158120">prog</span>&nbsp;<span class="op" id="5158125">*</span><span class="ident" id="5158126">syntax</span><span class="op" id="5158132">.</span><span class="ident" id="5158133">Prog</span><span class="op" id="5158137">)</span>&nbsp;<span class="op" id="5158139">*</span><span class="ident" id="5158140">onePassProg</span>&nbsp;<span class="op" id="5158152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158155">p</span>&nbsp;<span class="op" id="5158157">:=</span>&nbsp;<span class="op" id="5158160">&amp;</span><span class="ident" id="5158161">onePassProg</span><span class="op" id="5158172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158176">Start</span><span class="op" id="5158181">:</span>&nbsp;&nbsp;<span class="ident" id="5158184">prog</span><span class="op" id="5158188">.</span><span class="ident" id="5158189">Start</span><span class="op" id="5158194">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158198">NumCap</span><span class="op" id="5158204">:</span>&nbsp;<span class="ident" id="5158206">prog</span><span class="op" id="5158210">.</span><span class="ident" id="5158211">NumCap</span><span class="op" id="5158217">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158220">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158223">for</span>&nbsp;<span class="ident" id="5158227">_</span><span class="op" id="5158228">,</span>&nbsp;<span class="ident" id="5158230">inst</span>&nbsp;<span class="op" id="5158235">:=</span>&nbsp;<span class="keyword" id="5158238">range</span>&nbsp;<span class="ident" id="5158244">prog</span><span class="op" id="5158248">.</span><span class="ident" id="5158249">Inst</span>&nbsp;<span class="op" id="5158254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158258">p</span><span class="op" id="5158259">.</span><span class="ident" id="5158260">Inst</span>&nbsp;<span class="op" id="5158265">=</span>&nbsp;<span class="builtinfunc" id="5158267">append</span><span class="op" id="5158273">(</span><span class="ident" id="5158274">p</span><span class="op" id="5158275">.</span><span class="ident" id="5158276">Inst</span><span class="op" id="5158280">,</span>&nbsp;<span class="ident" id="5158282">onePassInst</span><span class="op" id="5158293">{</span><span class="ident" id="5158294">Inst</span><span class="op" id="5158298">:</span>&nbsp;<span class="ident" id="5158300">inst</span><span class="op" id="5158304">}</span><span class="op" id="5158305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5158308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158312">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158387">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158463">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158499">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158530">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158561">for</span>&nbsp;<span class="ident" id="5158565">pc</span>&nbsp;<span class="op" id="5158568">:=</span>&nbsp;<span class="keyword" id="5158571">range</span>&nbsp;<span class="ident" id="5158577">p</span><span class="op" id="5158578">.</span><span class="ident" id="5158579">Inst</span>&nbsp;<span class="op" id="5158584">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158588">switch</span>&nbsp;<span class="ident" id="5158595">p</span><span class="op" id="5158596">.</span><span class="ident" id="5158597">Inst</span><span class="op" id="5158601">[</span><span class="ident" id="5158602">pc</span><span class="op" id="5158604">]</span><span class="op" id="5158605">.</span><span class="ident" id="5158606">Op</span>&nbsp;<span class="op" id="5158609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158613">default</span><span class="op" id="5158620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158625">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158636">case</span>&nbsp;<span class="ident" id="5158641">syntax</span><span class="op" id="5158647">.</span><span class="ident" id="5158648">InstAlt</span><span class="op" id="5158655">,</span>&nbsp;<span class="ident" id="5158657">syntax</span><span class="op" id="5158663">.</span><span class="ident" id="5158664">InstAltMatch</span><span class="op" id="5158676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158681">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158699">p_A_Other</span>&nbsp;<span class="op" id="5158709">:=</span>&nbsp;<span class="op" id="5158712">&amp;</span><span class="ident" id="5158713">p</span><span class="op" id="5158714">.</span><span class="ident" id="5158715">Inst</span><span class="op" id="5158719">[</span><span class="ident" id="5158720">pc</span><span class="op" id="5158722">]</span><span class="op" id="5158723">.</span><span class="ident" id="5158724">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158731">p_A_Alt</span>&nbsp;<span class="op" id="5158739">:=</span>&nbsp;<span class="op" id="5158742">&amp;</span><span class="ident" id="5158743">p</span><span class="op" id="5158744">.</span><span class="ident" id="5158745">Inst</span><span class="op" id="5158749">[</span><span class="ident" id="5158750">pc</span><span class="op" id="5158752">]</span><span class="op" id="5158753">.</span><span class="ident" id="5158754">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5158761">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158801">instAlt</span>&nbsp;<span class="op" id="5158809">:=</span>&nbsp;<span class="ident" id="5158812">p</span><span class="op" id="5158813">.</span><span class="ident" id="5158814">Inst</span><span class="op" id="5158818">[</span><span class="op" id="5158819">*</span><span class="ident" id="5158820">p_A_Alt</span><span class="op" id="5158827">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158832">if</span>&nbsp;<span class="op" id="5158835">!</span><span class="op" id="5158836">(</span><span class="ident" id="5158837">instAlt</span><span class="op" id="5158844">.</span><span class="ident" id="5158845">Op</span>&nbsp;<span class="op" id="5158848">==</span>&nbsp;<span class="ident" id="5158851">syntax</span><span class="op" id="5158857">.</span><span class="ident" id="5158858">InstAlt</span>&nbsp;<span class="op" id="5158866">||</span>&nbsp;<span class="ident" id="5158869">instAlt</span><span class="op" id="5158876">.</span><span class="ident" id="5158877">Op</span>&nbsp;<span class="op" id="5158880">==</span>&nbsp;<span class="ident" id="5158883">syntax</span><span class="op" id="5158889">.</span><span class="ident" id="5158890">InstAltMatch</span><span class="op" id="5158902">)</span>&nbsp;<span class="op" id="5158904">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158910">p_A_Alt</span><span class="op" id="5158917">,</span>&nbsp;<span class="ident" id="5158919">p_A_Other</span>&nbsp;<span class="op" id="5158929">=</span>&nbsp;<span class="ident" id="5158931">p_A_Other</span><span class="op" id="5158940">,</span>&nbsp;<span class="ident" id="5158942">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5158954">instAlt</span>&nbsp;<span class="op" id="5158962">=</span>&nbsp;<span class="ident" id="5158964">p</span><span class="op" id="5158965">.</span><span class="ident" id="5158966">Inst</span><span class="op" id="5158970">[</span><span class="op" id="5158971">*</span><span class="ident" id="5158972">p_A_Alt</span><span class="op" id="5158979">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5158985">if</span>&nbsp;<span class="op" id="5158988">!</span><span class="op" id="5158989">(</span><span class="ident" id="5158990">instAlt</span><span class="op" id="5158997">.</span><span class="ident" id="5158998">Op</span>&nbsp;<span class="op" id="5159001">==</span>&nbsp;<span class="ident" id="5159004">syntax</span><span class="op" id="5159010">.</span><span class="ident" id="5159011">InstAlt</span>&nbsp;<span class="op" id="5159019">||</span>&nbsp;<span class="ident" id="5159022">instAlt</span><span class="op" id="5159029">.</span><span class="ident" id="5159030">Op</span>&nbsp;<span class="op" id="5159033">==</span>&nbsp;<span class="ident" id="5159036">syntax</span><span class="op" id="5159042">.</span><span class="ident" id="5159043">InstAltMatch</span><span class="op" id="5159055">)</span>&nbsp;<span class="op" id="5159057">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159064">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159077">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159087">instOther</span>&nbsp;<span class="op" id="5159097">:=</span>&nbsp;<span class="ident" id="5159100">p</span><span class="op" id="5159101">.</span><span class="ident" id="5159102">Inst</span><span class="op" id="5159106">[</span><span class="op" id="5159107">*</span><span class="ident" id="5159108">p_A_Other</span><span class="op" id="5159117">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159122">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159184">if</span>&nbsp;<span class="ident" id="5159187">instOther</span><span class="op" id="5159196">.</span><span class="ident" id="5159197">Op</span>&nbsp;<span class="op" id="5159200">==</span>&nbsp;<span class="ident" id="5159203">syntax</span><span class="op" id="5159209">.</span><span class="ident" id="5159210">InstAlt</span>&nbsp;<span class="op" id="5159218">||</span>&nbsp;<span class="ident" id="5159221">instOther</span><span class="op" id="5159230">.</span><span class="ident" id="5159231">Op</span>&nbsp;<span class="op" id="5159234">==</span>&nbsp;<span class="ident" id="5159237">syntax</span><span class="op" id="5159243">.</span><span class="ident" id="5159244">InstAltMatch</span>&nbsp;<span class="op" id="5159257">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159263">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159286">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159298">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159303">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159338">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159371">p_B_Alt</span>&nbsp;<span class="op" id="5159379">:=</span>&nbsp;<span class="op" id="5159382">&amp;</span><span class="ident" id="5159383">p</span><span class="op" id="5159384">.</span><span class="ident" id="5159385">Inst</span><span class="op" id="5159389">[</span><span class="op" id="5159390">*</span><span class="ident" id="5159391">p_A_Alt</span><span class="op" id="5159398">]</span><span class="op" id="5159399">.</span><span class="ident" id="5159400">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159407">p_B_Other</span>&nbsp;<span class="op" id="5159417">:=</span>&nbsp;<span class="op" id="5159420">&amp;</span><span class="ident" id="5159421">p</span><span class="op" id="5159422">.</span><span class="ident" id="5159423">Inst</span><span class="op" id="5159427">[</span><span class="op" id="5159428">*</span><span class="ident" id="5159429">p_A_Alt</span><span class="op" id="5159436">]</span><span class="op" id="5159437">.</span><span class="ident" id="5159438">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159445">patch</span>&nbsp;<span class="op" id="5159451">:=</span>&nbsp;<span class="builtintype" id="5159454">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159463">if</span>&nbsp;<span class="ident" id="5159466">instAlt</span><span class="op" id="5159473">.</span><span class="ident" id="5159474">Out</span>&nbsp;<span class="op" id="5159478">==</span>&nbsp;<span class="builtintype" id="5159481">uint32</span><span class="op" id="5159487">(</span><span class="ident" id="5159488">pc</span><span class="op" id="5159490">)</span>&nbsp;<span class="op" id="5159492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159498">patch</span>&nbsp;<span class="op" id="5159504">=</span>&nbsp;<span class="builtintype" id="5159506">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159514">}</span>&nbsp;<span class="keyword" id="5159516">else</span>&nbsp;<span class="keyword" id="5159521">if</span>&nbsp;<span class="ident" id="5159524">instAlt</span><span class="op" id="5159531">.</span><span class="ident" id="5159532">Arg</span>&nbsp;<span class="op" id="5159536">==</span>&nbsp;<span class="builtintype" id="5159539">uint32</span><span class="op" id="5159545">(</span><span class="ident" id="5159546">pc</span><span class="op" id="5159548">)</span>&nbsp;<span class="op" id="5159550">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159556">patch</span>&nbsp;<span class="op" id="5159562">=</span>&nbsp;<span class="builtintype" id="5159564">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5159573">p_B_Alt</span><span class="op" id="5159580">,</span>&nbsp;<span class="ident" id="5159582">p_B_Other</span>&nbsp;<span class="op" id="5159592">=</span>&nbsp;<span class="ident" id="5159594">p_B_Other</span><span class="op" id="5159603">,</span>&nbsp;<span class="ident" id="5159605">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159621">if</span>&nbsp;<span class="ident" id="5159624">patch</span>&nbsp;<span class="op" id="5159630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159636">*</span><span class="ident" id="5159637">p_B_Alt</span>&nbsp;<span class="op" id="5159645">=</span>&nbsp;<span class="op" id="5159647">*</span><span class="ident" id="5159648">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159667">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5159707">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159740">if</span>&nbsp;<span class="op" id="5159743">*</span><span class="ident" id="5159744">p_A_Other</span>&nbsp;<span class="op" id="5159754">==</span>&nbsp;<span class="op" id="5159757">*</span><span class="ident" id="5159758">p_B_Alt</span>&nbsp;<span class="op" id="5159766">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159772">*</span><span class="ident" id="5159773">p_A_Alt</span>&nbsp;<span class="op" id="5159781">=</span>&nbsp;<span class="op" id="5159783">*</span><span class="ident" id="5159784">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159797">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159801">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5159807">return</span>&nbsp;<span class="ident" id="5159814">p</span><br>
<span class="lineno">280</span><span class="op" id="5159816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5159819">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="5159884">type</span>&nbsp;<span class="ident" id="5159889">runeSlice</span>&nbsp;<span class="op" id="5159899">[</span><span class="op" id="5159900">]</span><span class="builtintype" id="5159901">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="5159907">func</span>&nbsp;<span class="op" id="5159912">(</span><span class="ident" id="5159913">p</span>&nbsp;<span class="ident" id="5159915">runeSlice</span><span class="op" id="5159924">)</span>&nbsp;<span class="ident" id="5159926">Len</span><span class="op" id="5159929">(</span><span class="op" id="5159930">)</span>&nbsp;<span class="builtintype" id="5159932">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5159946">{</span>&nbsp;<span class="keyword" id="5159948">return</span>&nbsp;<span class="builtinfunc" id="5159955">len</span><span class="op" id="5159958">(</span><span class="ident" id="5159959">p</span><span class="op" id="5159960">)</span>&nbsp;<span class="op" id="5159962">}</span><br>
<span class="lineno"></span><span class="keyword" id="5159964">func</span>&nbsp;<span class="op" id="5159969">(</span><span class="ident" id="5159970">p</span>&nbsp;<span class="ident" id="5159972">runeSlice</span><span class="op" id="5159981">)</span>&nbsp;<span class="ident" id="5159983">Less</span><span class="op" id="5159987">(</span><span class="ident" id="5159988">i</span><span class="op" id="5159989">,</span>&nbsp;<span class="ident" id="5159991">j</span>&nbsp;<span class="builtintype" id="5159993">int</span><span class="op" id="5159996">)</span>&nbsp;<span class="builtintype" id="5159998">bool</span>&nbsp;<span class="op" id="5160003">{</span>&nbsp;<span class="keyword" id="5160005">return</span>&nbsp;<span class="ident" id="5160012">p</span><span class="op" id="5160013">[</span><span class="ident" id="5160014">i</span><span class="op" id="5160015">]</span>&nbsp;<span class="op" id="5160017">&lt;</span>&nbsp;<span class="ident" id="5160019">p</span><span class="op" id="5160020">[</span><span class="ident" id="5160021">j</span><span class="op" id="5160022">]</span>&nbsp;<span class="op" id="5160024">}</span><br>
<span class="lineno"></span><span class="keyword" id="5160026">func</span>&nbsp;<span class="op" id="5160031">(</span><span class="ident" id="5160032">p</span>&nbsp;<span class="ident" id="5160034">runeSlice</span><span class="op" id="5160043">)</span>&nbsp;<span class="ident" id="5160045">Swap</span><span class="op" id="5160049">(</span><span class="ident" id="5160050">i</span><span class="op" id="5160051">,</span>&nbsp;<span class="ident" id="5160053">j</span>&nbsp;<span class="builtintype" id="5160055">int</span><span class="op" id="5160058">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160065">{</span>&nbsp;<span class="ident" id="5160067">p</span><span class="op" id="5160068">[</span><span class="ident" id="5160069">i</span><span class="op" id="5160070">]</span><span class="op" id="5160071">,</span>&nbsp;<span class="ident" id="5160073">p</span><span class="op" id="5160074">[</span><span class="ident" id="5160075">j</span><span class="op" id="5160076">]</span>&nbsp;<span class="op" id="5160078">=</span>&nbsp;<span class="ident" id="5160080">p</span><span class="op" id="5160081">[</span><span class="ident" id="5160082">j</span><span class="op" id="5160083">]</span><span class="op" id="5160084">,</span>&nbsp;<span class="ident" id="5160086">p</span><span class="op" id="5160087">[</span><span class="ident" id="5160088">i</span><span class="op" id="5160089">]</span>&nbsp;<span class="op" id="5160091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5160094">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="5160127">func</span>&nbsp;<span class="op" id="5160132">(</span><span class="ident" id="5160133">p</span>&nbsp;<span class="ident" id="5160135">runeSlice</span><span class="op" id="5160144">)</span>&nbsp;<span class="ident" id="5160146">Sort</span><span class="op" id="5160150">(</span><span class="op" id="5160151">)</span>&nbsp;<span class="op" id="5160153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160156">sort</span><span class="op" id="5160160">.</span><span class="ident" id="5160161">Sort</span><span class="op" id="5160165">(</span><span class="ident" id="5160166">p</span><span class="op" id="5160167">)</span><br>
<span class="lineno"></span><span class="op" id="5160169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5160172">var</span>&nbsp;<span class="ident" id="5160176">anyRuneNotNL</span>&nbsp;<span class="op" id="5160189">=</span>&nbsp;<span class="op" id="5160191">[</span><span class="op" id="5160192">]</span><span class="builtintype" id="5160193">rune</span><span class="op" id="5160197">{</span><span class="num" id="5160198">0</span><span class="op" id="5160199">,</span>&nbsp;<span class="string" id="5160201">&#39;\n&#39;</span>&nbsp;<span class="op" id="5160206">-</span>&nbsp;<span class="num" id="5160208">1</span><span class="op" id="5160209">,</span>&nbsp;<span class="string" id="5160211">&#39;\n&#39;</span>&nbsp;<span class="op" id="5160216">+</span>&nbsp;<span class="num" id="5160218">1</span><span class="op" id="5160219">,</span>&nbsp;<span class="ident" id="5160221">unicode</span><span class="op" id="5160228">.</span><span class="ident" id="5160229">MaxRune</span><span class="op" id="5160236">}</span><br>
<span class="lineno">295</span><span class="keyword" id="5160238">var</span>&nbsp;<span class="ident" id="5160242">anyRune</span>&nbsp;<span class="op" id="5160250">=</span>&nbsp;<span class="op" id="5160252">[</span><span class="op" id="5160253">]</span><span class="builtintype" id="5160254">rune</span><span class="op" id="5160258">{</span><span class="num" id="5160259">0</span><span class="op" id="5160260">,</span>&nbsp;<span class="ident" id="5160262">unicode</span><span class="op" id="5160269">.</span><span class="ident" id="5160270">MaxRune</span><span class="op" id="5160277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5160280">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="5160362">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="5160443">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="5160523">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="5160598">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="5160626">func</span>&nbsp;<span class="ident" id="5160631">makeOnePass</span><span class="op" id="5160642">(</span><span class="ident" id="5160643">p</span>&nbsp;<span class="op" id="5160645">*</span><span class="ident" id="5160646">onePassProg</span><span class="op" id="5160657">)</span>&nbsp;<span class="op" id="5160659">*</span><span class="ident" id="5160660">onePassProg</span>&nbsp;<span class="op" id="5160672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5160675">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160765">if</span>&nbsp;<span class="builtinfunc" id="5160768">len</span><span class="op" id="5160771">(</span><span class="ident" id="5160772">p</span><span class="op" id="5160773">.</span><span class="ident" id="5160774">Inst</span><span class="op" id="5160778">)</span>&nbsp;<span class="op" id="5160780">&gt;=</span>&nbsp;<span class="num" id="5160783">1000</span>&nbsp;<span class="op" id="5160788">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160792">return</span>&nbsp;<span class="ident" id="5160799">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160815">var</span>&nbsp;<span class="op" id="5160819">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160823">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5160836">=</span>&nbsp;<span class="ident" id="5160838">newQueue</span><span class="op" id="5160846">(</span><span class="builtinfunc" id="5160847">len</span><span class="op" id="5160850">(</span><span class="ident" id="5160851">p</span><span class="op" id="5160852">.</span><span class="ident" id="5160853">Inst</span><span class="op" id="5160857">)</span><span class="op" id="5160858">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160862">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5160875">=</span>&nbsp;<span class="ident" id="5160877">newQueue</span><span class="op" id="5160885">(</span><span class="builtinfunc" id="5160886">len</span><span class="op" id="5160889">(</span><span class="ident" id="5160890">p</span><span class="op" id="5160891">.</span><span class="ident" id="5160892">Inst</span><span class="op" id="5160896">)</span><span class="op" id="5160897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160901">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160914">func</span><span class="op" id="5160918">(</span><span class="builtintype" id="5160919">uint32</span><span class="op" id="5160925">,</span>&nbsp;<span class="op" id="5160927">*</span><span class="ident" id="5160928">queueOnePass</span><span class="op" id="5160940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160944">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5160957">func</span><span class="op" id="5160961">(</span><span class="builtintype" id="5160962">uint32</span><span class="op" id="5160968">,</span>&nbsp;<span class="keyword" id="5160970">map</span><span class="op" id="5160973">[</span><span class="builtintype" id="5160974">uint32</span><span class="op" id="5160980">]</span><span class="builtintype" id="5160981">bool</span><span class="op" id="5160985">)</span>&nbsp;<span class="builtintype" id="5160987">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5160994">onePassRunes</span>&nbsp;<span class="op" id="5161007">=</span>&nbsp;<span class="builtinfunc" id="5161009">make</span><span class="op" id="5161013">(</span><span class="op" id="5161014">[</span><span class="op" id="5161015">]</span><span class="op" id="5161016">[</span><span class="op" id="5161017">]</span><span class="builtintype" id="5161018">rune</span><span class="op" id="5161022">,</span>&nbsp;<span class="builtinfunc" id="5161024">len</span><span class="op" id="5161027">(</span><span class="ident" id="5161028">p</span><span class="op" id="5161029">.</span><span class="ident" id="5161030">Inst</span><span class="op" id="5161034">)</span><span class="op" id="5161035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161038">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161041">build</span>&nbsp;<span class="op" id="5161047">=</span>&nbsp;<span class="keyword" id="5161049">func</span><span class="op" id="5161053">(</span><span class="ident" id="5161054">pc</span>&nbsp;<span class="builtintype" id="5161057">uint32</span><span class="op" id="5161063">,</span>&nbsp;<span class="ident" id="5161065">q</span>&nbsp;<span class="op" id="5161067">*</span><span class="ident" id="5161068">queueOnePass</span><span class="op" id="5161080">)</span>&nbsp;<span class="op" id="5161082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161086">if</span>&nbsp;<span class="ident" id="5161089">q</span><span class="op" id="5161090">.</span><span class="ident" id="5161091">contains</span><span class="op" id="5161099">(</span><span class="ident" id="5161100">pc</span><span class="op" id="5161102">)</span>&nbsp;<span class="op" id="5161104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161109">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161118">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161122">inst</span>&nbsp;<span class="op" id="5161127">:=</span>&nbsp;<span class="ident" id="5161130">p</span><span class="op" id="5161131">.</span><span class="ident" id="5161132">Inst</span><span class="op" id="5161136">[</span><span class="ident" id="5161137">pc</span><span class="op" id="5161139">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161143">switch</span>&nbsp;<span class="ident" id="5161150">inst</span><span class="op" id="5161154">.</span><span class="ident" id="5161155">Op</span>&nbsp;<span class="op" id="5161158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161162">case</span>&nbsp;<span class="ident" id="5161167">syntax</span><span class="op" id="5161173">.</span><span class="ident" id="5161174">InstAlt</span><span class="op" id="5161181">,</span>&nbsp;<span class="ident" id="5161183">syntax</span><span class="op" id="5161189">.</span><span class="ident" id="5161190">InstAltMatch</span><span class="op" id="5161202">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161207">q</span><span class="op" id="5161208">.</span><span class="ident" id="5161209">insert</span><span class="op" id="5161215">(</span><span class="ident" id="5161216">inst</span><span class="op" id="5161220">.</span><span class="ident" id="5161221">Out</span><span class="op" id="5161224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161229">build</span><span class="op" id="5161234">(</span><span class="ident" id="5161235">inst</span><span class="op" id="5161239">.</span><span class="ident" id="5161240">Out</span><span class="op" id="5161243">,</span>&nbsp;<span class="ident" id="5161245">q</span><span class="op" id="5161246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161251">q</span><span class="op" id="5161252">.</span><span class="ident" id="5161253">insert</span><span class="op" id="5161259">(</span><span class="ident" id="5161260">inst</span><span class="op" id="5161264">.</span><span class="ident" id="5161265">Arg</span><span class="op" id="5161268">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161272">case</span>&nbsp;<span class="ident" id="5161277">syntax</span><span class="op" id="5161283">.</span><span class="ident" id="5161284">InstMatch</span><span class="op" id="5161293">,</span>&nbsp;<span class="ident" id="5161295">syntax</span><span class="op" id="5161301">.</span><span class="ident" id="5161302">InstFail</span><span class="op" id="5161310">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161314">default</span><span class="op" id="5161321">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161326">q</span><span class="op" id="5161327">.</span><span class="ident" id="5161328">insert</span><span class="op" id="5161334">(</span><span class="ident" id="5161335">inst</span><span class="op" id="5161339">.</span><span class="ident" id="5161340">Out</span><span class="op" id="5161343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161347">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161350">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161354">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161434">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161467">check</span>&nbsp;<span class="op" id="5161473">=</span>&nbsp;<span class="keyword" id="5161475">func</span><span class="op" id="5161479">(</span><span class="ident" id="5161480">pc</span>&nbsp;<span class="builtintype" id="5161483">uint32</span><span class="op" id="5161489">,</span>&nbsp;<span class="ident" id="5161491">m</span>&nbsp;<span class="keyword" id="5161493">map</span><span class="op" id="5161496">[</span><span class="builtintype" id="5161497">uint32</span><span class="op" id="5161503">]</span><span class="builtintype" id="5161504">bool</span><span class="op" id="5161508">)</span>&nbsp;<span class="op" id="5161510">(</span><span class="ident" id="5161511">ok</span>&nbsp;<span class="builtintype" id="5161514">bool</span><span class="op" id="5161518">)</span>&nbsp;<span class="op" id="5161520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161524">ok</span>&nbsp;<span class="op" id="5161527">=</span>&nbsp;<span class="builtintype" id="5161529">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161536">inst</span>&nbsp;<span class="op" id="5161541">:=</span>&nbsp;<span class="op" id="5161544">&amp;</span><span class="ident" id="5161545">p</span><span class="op" id="5161546">.</span><span class="ident" id="5161547">Inst</span><span class="op" id="5161551">[</span><span class="ident" id="5161552">pc</span><span class="op" id="5161554">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161558">if</span>&nbsp;<span class="ident" id="5161561">visitQueue</span><span class="op" id="5161571">.</span><span class="ident" id="5161572">contains</span><span class="op" id="5161580">(</span><span class="ident" id="5161581">pc</span><span class="op" id="5161583">)</span>&nbsp;<span class="op" id="5161585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161590">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161603">visitQueue</span><span class="op" id="5161613">.</span><span class="ident" id="5161614">insert</span><span class="op" id="5161620">(</span><span class="ident" id="5161621">pc</span><span class="op" id="5161623">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161627">switch</span>&nbsp;<span class="ident" id="5161634">inst</span><span class="op" id="5161638">.</span><span class="ident" id="5161639">Op</span>&nbsp;<span class="op" id="5161642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161646">case</span>&nbsp;<span class="ident" id="5161651">syntax</span><span class="op" id="5161657">.</span><span class="ident" id="5161658">InstAlt</span><span class="op" id="5161665">,</span>&nbsp;<span class="ident" id="5161667">syntax</span><span class="op" id="5161673">.</span><span class="ident" id="5161674">InstAltMatch</span><span class="op" id="5161686">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161691">ok</span>&nbsp;<span class="op" id="5161694">=</span>&nbsp;<span class="ident" id="5161696">check</span><span class="op" id="5161701">(</span><span class="ident" id="5161702">inst</span><span class="op" id="5161706">.</span><span class="ident" id="5161707">Out</span><span class="op" id="5161710">,</span>&nbsp;<span class="ident" id="5161712">m</span><span class="op" id="5161713">)</span>&nbsp;<span class="op" id="5161715">&amp;&amp;</span>&nbsp;<span class="ident" id="5161718">check</span><span class="op" id="5161723">(</span><span class="ident" id="5161724">inst</span><span class="op" id="5161728">.</span><span class="ident" id="5161729">Arg</span><span class="op" id="5161732">,</span>&nbsp;<span class="ident" id="5161734">m</span><span class="op" id="5161735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161740">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161780">matchOut</span>&nbsp;<span class="op" id="5161789">:=</span>&nbsp;<span class="ident" id="5161792">m</span><span class="op" id="5161793">[</span><span class="ident" id="5161794">inst</span><span class="op" id="5161798">.</span><span class="ident" id="5161799">Out</span><span class="op" id="5161802">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161807">matchArg</span>&nbsp;<span class="op" id="5161816">:=</span>&nbsp;<span class="ident" id="5161819">m</span><span class="op" id="5161820">[</span><span class="ident" id="5161821">inst</span><span class="op" id="5161825">.</span><span class="ident" id="5161826">Arg</span><span class="op" id="5161829">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161834">if</span>&nbsp;<span class="ident" id="5161837">matchOut</span>&nbsp;<span class="op" id="5161846">&amp;&amp;</span>&nbsp;<span class="ident" id="5161849">matchArg</span>&nbsp;<span class="op" id="5161858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161864">ok</span>&nbsp;<span class="op" id="5161867">=</span>&nbsp;<span class="builtintype" id="5161869">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161879">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5161888">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5161893">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5161931">if</span>&nbsp;<span class="ident" id="5161934">matchArg</span>&nbsp;<span class="op" id="5161943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161949">inst</span><span class="op" id="5161953">.</span><span class="ident" id="5161954">Out</span><span class="op" id="5161957">,</span>&nbsp;<span class="ident" id="5161959">inst</span><span class="op" id="5161963">.</span><span class="ident" id="5161964">Arg</span>&nbsp;<span class="op" id="5161968">=</span>&nbsp;<span class="ident" id="5161970">inst</span><span class="op" id="5161974">.</span><span class="ident" id="5161975">Arg</span><span class="op" id="5161978">,</span>&nbsp;<span class="ident" id="5161980">inst</span><span class="op" id="5161984">.</span><span class="ident" id="5161985">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5161993">matchOut</span><span class="op" id="5162001">,</span>&nbsp;<span class="ident" id="5162003">matchArg</span>&nbsp;<span class="op" id="5162012">=</span>&nbsp;<span class="ident" id="5162014">matchArg</span><span class="op" id="5162022">,</span>&nbsp;<span class="ident" id="5162024">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162036">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162041">if</span>&nbsp;<span class="ident" id="5162044">matchOut</span>&nbsp;<span class="op" id="5162053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162059">m</span><span class="op" id="5162060">[</span><span class="ident" id="5162061">pc</span><span class="op" id="5162063">]</span>&nbsp;<span class="op" id="5162065">=</span>&nbsp;<span class="builtintype" id="5162067">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162076">inst</span><span class="op" id="5162080">.</span><span class="ident" id="5162081">Op</span>&nbsp;<span class="op" id="5162084">=</span>&nbsp;<span class="ident" id="5162086">syntax</span><span class="op" id="5162092">.</span><span class="ident" id="5162093">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162115">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162177">onePassRunes</span><span class="op" id="5162189">[</span><span class="ident" id="5162190">pc</span><span class="op" id="5162192">]</span><span class="op" id="5162193">,</span>&nbsp;<span class="ident" id="5162195">inst</span><span class="op" id="5162199">.</span><span class="ident" id="5162200">Next</span>&nbsp;<span class="op" id="5162205">=</span>&nbsp;<span class="ident" id="5162207">mergeRuneSets</span><span class="op" id="5162220">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162226">&amp;</span><span class="ident" id="5162227">onePassRunes</span><span class="op" id="5162239">[</span><span class="ident" id="5162240">inst</span><span class="op" id="5162244">.</span><span class="ident" id="5162245">Out</span><span class="op" id="5162248">]</span><span class="op" id="5162249">,</span>&nbsp;<span class="op" id="5162251">&amp;</span><span class="ident" id="5162252">onePassRunes</span><span class="op" id="5162264">[</span><span class="ident" id="5162265">inst</span><span class="op" id="5162269">.</span><span class="ident" id="5162270">Arg</span><span class="op" id="5162273">]</span><span class="op" id="5162274">,</span>&nbsp;<span class="ident" id="5162276">inst</span><span class="op" id="5162280">.</span><span class="ident" id="5162281">Out</span><span class="op" id="5162284">,</span>&nbsp;<span class="ident" id="5162286">inst</span><span class="op" id="5162290">.</span><span class="ident" id="5162291">Arg</span><span class="op" id="5162294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162299">if</span>&nbsp;<span class="builtinfunc" id="5162302">len</span><span class="op" id="5162305">(</span><span class="ident" id="5162306">inst</span><span class="op" id="5162310">.</span><span class="ident" id="5162311">Next</span><span class="op" id="5162315">)</span>&nbsp;<span class="op" id="5162317">&gt;</span>&nbsp;<span class="num" id="5162319">0</span>&nbsp;<span class="op" id="5162321">&amp;&amp;</span>&nbsp;<span class="ident" id="5162324">inst</span><span class="op" id="5162328">.</span><span class="ident" id="5162329">Next</span><span class="op" id="5162333">[</span><span class="num" id="5162334">0</span><span class="op" id="5162335">]</span>&nbsp;<span class="op" id="5162337">==</span>&nbsp;<span class="ident" id="5162340">mergeFailed</span>&nbsp;<span class="op" id="5162352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162358">ok</span>&nbsp;<span class="op" id="5162361">=</span>&nbsp;<span class="builtintype" id="5162363">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162373">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162386">case</span>&nbsp;<span class="ident" id="5162391">syntax</span><span class="op" id="5162397">.</span><span class="ident" id="5162398">InstCapture</span><span class="op" id="5162409">,</span>&nbsp;<span class="ident" id="5162411">syntax</span><span class="op" id="5162417">.</span><span class="ident" id="5162418">InstNop</span><span class="op" id="5162425">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162430">ok</span>&nbsp;<span class="op" id="5162433">=</span>&nbsp;<span class="ident" id="5162435">check</span><span class="op" id="5162440">(</span><span class="ident" id="5162441">inst</span><span class="op" id="5162445">.</span><span class="ident" id="5162446">Out</span><span class="op" id="5162449">,</span>&nbsp;<span class="ident" id="5162451">m</span><span class="op" id="5162452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162457">m</span><span class="op" id="5162458">[</span><span class="ident" id="5162459">pc</span><span class="op" id="5162461">]</span>&nbsp;<span class="op" id="5162463">=</span>&nbsp;<span class="ident" id="5162465">m</span><span class="op" id="5162466">[</span><span class="ident" id="5162467">inst</span><span class="op" id="5162471">.</span><span class="ident" id="5162472">Out</span><span class="op" id="5162475">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5162480">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162533">onePassRunes</span><span class="op" id="5162545">[</span><span class="ident" id="5162546">pc</span><span class="op" id="5162548">]</span>&nbsp;<span class="op" id="5162550">=</span>&nbsp;<span class="builtinfunc" id="5162552">append</span><span class="op" id="5162558">(</span><span class="op" id="5162559">[</span><span class="op" id="5162560">]</span><span class="builtintype" id="5162561">rune</span><span class="op" id="5162565">{</span><span class="op" id="5162566">}</span><span class="op" id="5162567">,</span>&nbsp;<span class="ident" id="5162569">onePassRunes</span><span class="op" id="5162581">[</span><span class="ident" id="5162582">inst</span><span class="op" id="5162586">.</span><span class="ident" id="5162587">Out</span><span class="op" id="5162590">]</span><span class="op" id="5162591">...</span><span class="op" id="5162594">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162599">inst</span><span class="op" id="5162603">.</span><span class="ident" id="5162604">Next</span>&nbsp;<span class="op" id="5162609">=</span>&nbsp;<span class="op" id="5162611">[</span><span class="op" id="5162612">]</span><span class="builtintype" id="5162613">uint32</span><span class="op" id="5162619">{</span><span class="op" id="5162620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162625">for</span>&nbsp;<span class="ident" id="5162629">i</span>&nbsp;<span class="op" id="5162631">:=</span>&nbsp;<span class="builtinfunc" id="5162634">len</span><span class="op" id="5162637">(</span><span class="ident" id="5162638">onePassRunes</span><span class="op" id="5162650">[</span><span class="ident" id="5162651">pc</span><span class="op" id="5162653">]</span><span class="op" id="5162654">)</span>&nbsp;<span class="op" id="5162656">/</span>&nbsp;<span class="num" id="5162658">2</span><span class="op" id="5162659">;</span>&nbsp;<span class="ident" id="5162661">i</span>&nbsp;<span class="op" id="5162663">&gt;=</span>&nbsp;<span class="num" id="5162666">0</span><span class="op" id="5162667">;</span>&nbsp;<span class="ident" id="5162669">i</span><span class="op" id="5162670">--</span>&nbsp;<span class="op" id="5162673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162679">inst</span><span class="op" id="5162683">.</span><span class="ident" id="5162684">Next</span>&nbsp;<span class="op" id="5162689">=</span>&nbsp;<span class="builtinfunc" id="5162691">append</span><span class="op" id="5162697">(</span><span class="ident" id="5162698">inst</span><span class="op" id="5162702">.</span><span class="ident" id="5162703">Next</span><span class="op" id="5162707">,</span>&nbsp;<span class="ident" id="5162709">inst</span><span class="op" id="5162713">.</span><span class="ident" id="5162714">Out</span><span class="op" id="5162717">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162726">case</span>&nbsp;<span class="ident" id="5162731">syntax</span><span class="op" id="5162737">.</span><span class="ident" id="5162738">InstEmptyWidth</span><span class="op" id="5162752">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162757">ok</span>&nbsp;<span class="op" id="5162760">=</span>&nbsp;<span class="ident" id="5162762">check</span><span class="op" id="5162767">(</span><span class="ident" id="5162768">inst</span><span class="op" id="5162772">.</span><span class="ident" id="5162773">Out</span><span class="op" id="5162776">,</span>&nbsp;<span class="ident" id="5162778">m</span><span class="op" id="5162779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162784">m</span><span class="op" id="5162785">[</span><span class="ident" id="5162786">pc</span><span class="op" id="5162788">]</span>&nbsp;<span class="op" id="5162790">=</span>&nbsp;<span class="ident" id="5162792">m</span><span class="op" id="5162793">[</span><span class="ident" id="5162794">inst</span><span class="op" id="5162798">.</span><span class="ident" id="5162799">Out</span><span class="op" id="5162802">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162807">onePassRunes</span><span class="op" id="5162819">[</span><span class="ident" id="5162820">pc</span><span class="op" id="5162822">]</span>&nbsp;<span class="op" id="5162824">=</span>&nbsp;<span class="builtinfunc" id="5162826">append</span><span class="op" id="5162832">(</span><span class="op" id="5162833">[</span><span class="op" id="5162834">]</span><span class="builtintype" id="5162835">rune</span><span class="op" id="5162839">{</span><span class="op" id="5162840">}</span><span class="op" id="5162841">,</span>&nbsp;<span class="ident" id="5162843">onePassRunes</span><span class="op" id="5162855">[</span><span class="ident" id="5162856">inst</span><span class="op" id="5162860">.</span><span class="ident" id="5162861">Out</span><span class="op" id="5162864">]</span><span class="op" id="5162865">...</span><span class="op" id="5162868">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162873">inst</span><span class="op" id="5162877">.</span><span class="ident" id="5162878">Next</span>&nbsp;<span class="op" id="5162883">=</span>&nbsp;<span class="op" id="5162885">[</span><span class="op" id="5162886">]</span><span class="builtintype" id="5162887">uint32</span><span class="op" id="5162893">{</span><span class="op" id="5162894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5162899">for</span>&nbsp;<span class="ident" id="5162903">i</span>&nbsp;<span class="op" id="5162905">:=</span>&nbsp;<span class="builtinfunc" id="5162908">len</span><span class="op" id="5162911">(</span><span class="ident" id="5162912">onePassRunes</span><span class="op" id="5162924">[</span><span class="ident" id="5162925">pc</span><span class="op" id="5162927">]</span><span class="op" id="5162928">)</span>&nbsp;<span class="op" id="5162930">/</span>&nbsp;<span class="num" id="5162932">2</span><span class="op" id="5162933">;</span>&nbsp;<span class="ident" id="5162935">i</span>&nbsp;<span class="op" id="5162937">&gt;=</span>&nbsp;<span class="num" id="5162940">0</span><span class="op" id="5162941">;</span>&nbsp;<span class="ident" id="5162943">i</span><span class="op" id="5162944">--</span>&nbsp;<span class="op" id="5162947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5162953">inst</span><span class="op" id="5162957">.</span><span class="ident" id="5162958">Next</span>&nbsp;<span class="op" id="5162963">=</span>&nbsp;<span class="builtinfunc" id="5162965">append</span><span class="op" id="5162971">(</span><span class="ident" id="5162972">inst</span><span class="op" id="5162976">.</span><span class="ident" id="5162977">Next</span><span class="op" id="5162981">,</span>&nbsp;<span class="ident" id="5162983">inst</span><span class="op" id="5162987">.</span><span class="ident" id="5162988">Out</span><span class="op" id="5162991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5162996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163000">case</span>&nbsp;<span class="ident" id="5163005">syntax</span><span class="op" id="5163011">.</span><span class="ident" id="5163012">InstMatch</span><span class="op" id="5163021">,</span>&nbsp;<span class="ident" id="5163023">syntax</span><span class="op" id="5163029">.</span><span class="ident" id="5163030">InstFail</span><span class="op" id="5163038">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163043">m</span><span class="op" id="5163044">[</span><span class="ident" id="5163045">pc</span><span class="op" id="5163047">]</span>&nbsp;<span class="op" id="5163049">=</span>&nbsp;<span class="ident" id="5163051">inst</span><span class="op" id="5163055">.</span><span class="ident" id="5163056">Op</span>&nbsp;<span class="op" id="5163059">==</span>&nbsp;<span class="ident" id="5163062">syntax</span><span class="op" id="5163068">.</span><span class="ident" id="5163069">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163082">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163090">case</span>&nbsp;<span class="ident" id="5163095">syntax</span><span class="op" id="5163101">.</span><span class="ident" id="5163102">InstRune</span><span class="op" id="5163110">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163115">ok</span>&nbsp;<span class="op" id="5163118">=</span>&nbsp;<span class="ident" id="5163120">check</span><span class="op" id="5163125">(</span><span class="ident" id="5163126">inst</span><span class="op" id="5163130">.</span><span class="ident" id="5163131">Out</span><span class="op" id="5163134">,</span>&nbsp;<span class="ident" id="5163136">m</span><span class="op" id="5163137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163142">m</span><span class="op" id="5163143">[</span><span class="ident" id="5163144">pc</span><span class="op" id="5163146">]</span>&nbsp;<span class="op" id="5163148">=</span>&nbsp;<span class="builtintype" id="5163150">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163159">if</span>&nbsp;<span class="builtinfunc" id="5163162">len</span><span class="op" id="5163165">(</span><span class="ident" id="5163166">inst</span><span class="op" id="5163170">.</span><span class="ident" id="5163171">Next</span><span class="op" id="5163175">)</span>&nbsp;<span class="op" id="5163177">&gt;</span>&nbsp;<span class="num" id="5163179">0</span>&nbsp;<span class="op" id="5163181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163187">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163196">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163201">if</span>&nbsp;<span class="builtinfunc" id="5163204">len</span><span class="op" id="5163207">(</span><span class="ident" id="5163208">inst</span><span class="op" id="5163212">.</span><span class="ident" id="5163213">Rune</span><span class="op" id="5163217">)</span>&nbsp;<span class="op" id="5163219">==</span>&nbsp;<span class="num" id="5163222">0</span>&nbsp;<span class="op" id="5163224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163230">onePassRunes</span><span class="op" id="5163242">[</span><span class="ident" id="5163243">pc</span><span class="op" id="5163245">]</span>&nbsp;<span class="op" id="5163247">=</span>&nbsp;<span class="op" id="5163249">[</span><span class="op" id="5163250">]</span><span class="builtintype" id="5163251">rune</span><span class="op" id="5163255">{</span><span class="op" id="5163256">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163262">inst</span><span class="op" id="5163266">.</span><span class="ident" id="5163267">Next</span>&nbsp;<span class="op" id="5163272">=</span>&nbsp;<span class="op" id="5163274">[</span><span class="op" id="5163275">]</span><span class="builtintype" id="5163276">uint32</span><span class="op" id="5163282">{</span><span class="ident" id="5163283">inst</span><span class="op" id="5163287">.</span><span class="ident" id="5163288">Out</span><span class="op" id="5163291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163297">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163311">runes</span>&nbsp;<span class="op" id="5163317">:=</span>&nbsp;<span class="builtinfunc" id="5163320">make</span><span class="op" id="5163324">(</span><span class="op" id="5163325">[</span><span class="op" id="5163326">]</span><span class="builtintype" id="5163327">rune</span><span class="op" id="5163331">,</span>&nbsp;<span class="num" id="5163333">0</span><span class="op" id="5163334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163339">if</span>&nbsp;<span class="builtinfunc" id="5163342">len</span><span class="op" id="5163345">(</span><span class="ident" id="5163346">inst</span><span class="op" id="5163350">.</span><span class="ident" id="5163351">Rune</span><span class="op" id="5163355">)</span>&nbsp;<span class="op" id="5163357">==</span>&nbsp;<span class="num" id="5163360">1</span>&nbsp;<span class="op" id="5163362">&amp;&amp;</span>&nbsp;<span class="ident" id="5163365">syntax</span><span class="op" id="5163371">.</span><span class="ident" id="5163372">Flags</span><span class="op" id="5163377">(</span><span class="ident" id="5163378">inst</span><span class="op" id="5163382">.</span><span class="ident" id="5163383">Arg</span><span class="op" id="5163386">)</span><span class="op" id="5163387">&amp;</span><span class="ident" id="5163388">syntax</span><span class="op" id="5163394">.</span><span class="ident" id="5163395">FoldCase</span>&nbsp;<span class="op" id="5163404">!=</span>&nbsp;<span class="num" id="5163407">0</span>&nbsp;<span class="op" id="5163409">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163415">r0</span>&nbsp;<span class="op" id="5163418">:=</span>&nbsp;<span class="ident" id="5163421">inst</span><span class="op" id="5163425">.</span><span class="ident" id="5163426">Rune</span><span class="op" id="5163430">[</span><span class="num" id="5163431">0</span><span class="op" id="5163432">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163438">runes</span>&nbsp;<span class="op" id="5163444">=</span>&nbsp;<span class="builtinfunc" id="5163446">append</span><span class="op" id="5163452">(</span><span class="ident" id="5163453">runes</span><span class="op" id="5163458">,</span>&nbsp;<span class="ident" id="5163460">r0</span><span class="op" id="5163462">,</span>&nbsp;<span class="ident" id="5163464">r0</span><span class="op" id="5163466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163472">for</span>&nbsp;<span class="ident" id="5163476">r1</span>&nbsp;<span class="op" id="5163479">:=</span>&nbsp;<span class="ident" id="5163482">unicode</span><span class="op" id="5163489">.</span><span class="ident" id="5163490">SimpleFold</span><span class="op" id="5163500">(</span><span class="ident" id="5163501">r0</span><span class="op" id="5163503">)</span><span class="op" id="5163504">;</span>&nbsp;<span class="ident" id="5163506">r1</span>&nbsp;<span class="op" id="5163509">!=</span>&nbsp;<span class="ident" id="5163512">r0</span><span class="op" id="5163514">;</span>&nbsp;<span class="ident" id="5163516">r1</span>&nbsp;<span class="op" id="5163519">=</span>&nbsp;<span class="ident" id="5163521">unicode</span><span class="op" id="5163528">.</span><span class="ident" id="5163529">SimpleFold</span><span class="op" id="5163539">(</span><span class="ident" id="5163540">r1</span><span class="op" id="5163542">)</span>&nbsp;<span class="op" id="5163544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163551">runes</span>&nbsp;<span class="op" id="5163557">=</span>&nbsp;<span class="builtinfunc" id="5163559">append</span><span class="op" id="5163565">(</span><span class="ident" id="5163566">runes</span><span class="op" id="5163571">,</span>&nbsp;<span class="ident" id="5163573">r1</span><span class="op" id="5163575">,</span>&nbsp;<span class="ident" id="5163577">r1</span><span class="op" id="5163579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163585">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163591">sort</span><span class="op" id="5163595">.</span><span class="ident" id="5163596">Sort</span><span class="op" id="5163600">(</span><span class="ident" id="5163601">runeSlice</span><span class="op" id="5163610">(</span><span class="ident" id="5163611">runes</span><span class="op" id="5163616">)</span><span class="op" id="5163617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163622">}</span>&nbsp;<span class="keyword" id="5163624">else</span>&nbsp;<span class="op" id="5163629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163635">runes</span>&nbsp;<span class="op" id="5163641">=</span>&nbsp;<span class="builtinfunc" id="5163643">append</span><span class="op" id="5163649">(</span><span class="ident" id="5163650">runes</span><span class="op" id="5163655">,</span>&nbsp;<span class="ident" id="5163657">inst</span><span class="op" id="5163661">.</span><span class="ident" id="5163662">Rune</span><span class="op" id="5163666">...</span><span class="op" id="5163669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163679">onePassRunes</span><span class="op" id="5163691">[</span><span class="ident" id="5163692">pc</span><span class="op" id="5163694">]</span>&nbsp;<span class="op" id="5163696">=</span>&nbsp;<span class="ident" id="5163698">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163707">inst</span><span class="op" id="5163711">.</span><span class="ident" id="5163712">Next</span>&nbsp;<span class="op" id="5163717">=</span>&nbsp;<span class="op" id="5163719">[</span><span class="op" id="5163720">]</span><span class="builtintype" id="5163721">uint32</span><span class="op" id="5163727">{</span><span class="op" id="5163728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163733">for</span>&nbsp;<span class="ident" id="5163737">i</span>&nbsp;<span class="op" id="5163739">:=</span>&nbsp;<span class="builtinfunc" id="5163742">len</span><span class="op" id="5163745">(</span><span class="ident" id="5163746">onePassRunes</span><span class="op" id="5163758">[</span><span class="ident" id="5163759">pc</span><span class="op" id="5163761">]</span><span class="op" id="5163762">)</span>&nbsp;<span class="op" id="5163764">/</span>&nbsp;<span class="num" id="5163766">2</span><span class="op" id="5163767">;</span>&nbsp;<span class="ident" id="5163769">i</span>&nbsp;<span class="op" id="5163771">&gt;=</span>&nbsp;<span class="num" id="5163774">0</span><span class="op" id="5163775">;</span>&nbsp;<span class="ident" id="5163777">i</span><span class="op" id="5163778">--</span>&nbsp;<span class="op" id="5163781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163787">inst</span><span class="op" id="5163791">.</span><span class="ident" id="5163792">Next</span>&nbsp;<span class="op" id="5163797">=</span>&nbsp;<span class="builtinfunc" id="5163799">append</span><span class="op" id="5163805">(</span><span class="ident" id="5163806">inst</span><span class="op" id="5163810">.</span><span class="ident" id="5163811">Next</span><span class="op" id="5163815">,</span>&nbsp;<span class="ident" id="5163817">inst</span><span class="op" id="5163821">.</span><span class="ident" id="5163822">Out</span><span class="op" id="5163825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163830">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163835">inst</span><span class="op" id="5163839">.</span><span class="ident" id="5163840">Op</span>&nbsp;<span class="op" id="5163843">=</span>&nbsp;<span class="ident" id="5163845">syntax</span><span class="op" id="5163851">.</span><span class="ident" id="5163852">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163863">case</span>&nbsp;<span class="ident" id="5163868">syntax</span><span class="op" id="5163874">.</span><span class="ident" id="5163875">InstRune1</span><span class="op" id="5163884">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163889">ok</span>&nbsp;<span class="op" id="5163892">=</span>&nbsp;<span class="ident" id="5163894">check</span><span class="op" id="5163899">(</span><span class="ident" id="5163900">inst</span><span class="op" id="5163904">.</span><span class="ident" id="5163905">Out</span><span class="op" id="5163908">,</span>&nbsp;<span class="ident" id="5163910">m</span><span class="op" id="5163911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163916">m</span><span class="op" id="5163917">[</span><span class="ident" id="5163918">pc</span><span class="op" id="5163920">]</span>&nbsp;<span class="op" id="5163922">=</span>&nbsp;<span class="builtintype" id="5163924">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163933">if</span>&nbsp;<span class="builtinfunc" id="5163936">len</span><span class="op" id="5163939">(</span><span class="ident" id="5163940">inst</span><span class="op" id="5163944">.</span><span class="ident" id="5163945">Next</span><span class="op" id="5163949">)</span>&nbsp;<span class="op" id="5163951">&gt;</span>&nbsp;<span class="num" id="5163953">0</span>&nbsp;<span class="op" id="5163955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5163961">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5163970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5163975">runes</span>&nbsp;<span class="op" id="5163981">:=</span>&nbsp;<span class="op" id="5163984">[</span><span class="op" id="5163985">]</span><span class="builtintype" id="5163986">rune</span><span class="op" id="5163990">{</span><span class="op" id="5163991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5163996">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164027">if</span>&nbsp;<span class="ident" id="5164030">syntax</span><span class="op" id="5164036">.</span><span class="ident" id="5164037">Flags</span><span class="op" id="5164042">(</span><span class="ident" id="5164043">inst</span><span class="op" id="5164047">.</span><span class="ident" id="5164048">Arg</span><span class="op" id="5164051">)</span><span class="op" id="5164052">&amp;</span><span class="ident" id="5164053">syntax</span><span class="op" id="5164059">.</span><span class="ident" id="5164060">FoldCase</span>&nbsp;<span class="op" id="5164069">!=</span>&nbsp;<span class="num" id="5164072">0</span>&nbsp;<span class="op" id="5164074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164080">r0</span>&nbsp;<span class="op" id="5164083">:=</span>&nbsp;<span class="ident" id="5164086">inst</span><span class="op" id="5164090">.</span><span class="ident" id="5164091">Rune</span><span class="op" id="5164095">[</span><span class="num" id="5164096">0</span><span class="op" id="5164097">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164103">runes</span>&nbsp;<span class="op" id="5164109">=</span>&nbsp;<span class="builtinfunc" id="5164111">append</span><span class="op" id="5164117">(</span><span class="ident" id="5164118">runes</span><span class="op" id="5164123">,</span>&nbsp;<span class="ident" id="5164125">r0</span><span class="op" id="5164127">,</span>&nbsp;<span class="ident" id="5164129">r0</span><span class="op" id="5164131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164137">for</span>&nbsp;<span class="ident" id="5164141">r1</span>&nbsp;<span class="op" id="5164144">:=</span>&nbsp;<span class="ident" id="5164147">unicode</span><span class="op" id="5164154">.</span><span class="ident" id="5164155">SimpleFold</span><span class="op" id="5164165">(</span><span class="ident" id="5164166">r0</span><span class="op" id="5164168">)</span><span class="op" id="5164169">;</span>&nbsp;<span class="ident" id="5164171">r1</span>&nbsp;<span class="op" id="5164174">!=</span>&nbsp;<span class="ident" id="5164177">r0</span><span class="op" id="5164179">;</span>&nbsp;<span class="ident" id="5164181">r1</span>&nbsp;<span class="op" id="5164184">=</span>&nbsp;<span class="ident" id="5164186">unicode</span><span class="op" id="5164193">.</span><span class="ident" id="5164194">SimpleFold</span><span class="op" id="5164204">(</span><span class="ident" id="5164205">r1</span><span class="op" id="5164207">)</span>&nbsp;<span class="op" id="5164209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164216">runes</span>&nbsp;<span class="op" id="5164222">=</span>&nbsp;<span class="builtinfunc" id="5164224">append</span><span class="op" id="5164230">(</span><span class="ident" id="5164231">runes</span><span class="op" id="5164236">,</span>&nbsp;<span class="ident" id="5164238">r1</span><span class="op" id="5164240">,</span>&nbsp;<span class="ident" id="5164242">r1</span><span class="op" id="5164244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164256">sort</span><span class="op" id="5164260">.</span><span class="ident" id="5164261">Sort</span><span class="op" id="5164265">(</span><span class="ident" id="5164266">runeSlice</span><span class="op" id="5164275">(</span><span class="ident" id="5164276">runes</span><span class="op" id="5164281">)</span><span class="op" id="5164282">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164287">}</span>&nbsp;<span class="keyword" id="5164289">else</span>&nbsp;<span class="op" id="5164294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164300">runes</span>&nbsp;<span class="op" id="5164306">=</span>&nbsp;<span class="builtinfunc" id="5164308">append</span><span class="op" id="5164314">(</span><span class="ident" id="5164315">runes</span><span class="op" id="5164320">,</span>&nbsp;<span class="ident" id="5164322">inst</span><span class="op" id="5164326">.</span><span class="ident" id="5164327">Rune</span><span class="op" id="5164331">[</span><span class="num" id="5164332">0</span><span class="op" id="5164333">]</span><span class="op" id="5164334">,</span>&nbsp;<span class="ident" id="5164336">inst</span><span class="op" id="5164340">.</span><span class="ident" id="5164341">Rune</span><span class="op" id="5164345">[</span><span class="num" id="5164346">0</span><span class="op" id="5164347">]</span><span class="op" id="5164348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164358">onePassRunes</span><span class="op" id="5164370">[</span><span class="ident" id="5164371">pc</span><span class="op" id="5164373">]</span>&nbsp;<span class="op" id="5164375">=</span>&nbsp;<span class="ident" id="5164377">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164386">inst</span><span class="op" id="5164390">.</span><span class="ident" id="5164391">Next</span>&nbsp;<span class="op" id="5164396">=</span>&nbsp;<span class="op" id="5164398">[</span><span class="op" id="5164399">]</span><span class="builtintype" id="5164400">uint32</span><span class="op" id="5164406">{</span><span class="op" id="5164407">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164412">for</span>&nbsp;<span class="ident" id="5164416">i</span>&nbsp;<span class="op" id="5164418">:=</span>&nbsp;<span class="builtinfunc" id="5164421">len</span><span class="op" id="5164424">(</span><span class="ident" id="5164425">onePassRunes</span><span class="op" id="5164437">[</span><span class="ident" id="5164438">pc</span><span class="op" id="5164440">]</span><span class="op" id="5164441">)</span>&nbsp;<span class="op" id="5164443">/</span>&nbsp;<span class="num" id="5164445">2</span><span class="op" id="5164446">;</span>&nbsp;<span class="ident" id="5164448">i</span>&nbsp;<span class="op" id="5164450">&gt;=</span>&nbsp;<span class="num" id="5164453">0</span><span class="op" id="5164454">;</span>&nbsp;<span class="ident" id="5164456">i</span><span class="op" id="5164457">--</span>&nbsp;<span class="op" id="5164460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164466">inst</span><span class="op" id="5164470">.</span><span class="ident" id="5164471">Next</span>&nbsp;<span class="op" id="5164476">=</span>&nbsp;<span class="builtinfunc" id="5164478">append</span><span class="op" id="5164484">(</span><span class="ident" id="5164485">inst</span><span class="op" id="5164489">.</span><span class="ident" id="5164490">Next</span><span class="op" id="5164494">,</span>&nbsp;<span class="ident" id="5164496">inst</span><span class="op" id="5164500">.</span><span class="ident" id="5164501">Out</span><span class="op" id="5164504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164514">inst</span><span class="op" id="5164518">.</span><span class="ident" id="5164519">Op</span>&nbsp;<span class="op" id="5164522">=</span>&nbsp;<span class="ident" id="5164524">syntax</span><span class="op" id="5164530">.</span><span class="ident" id="5164531">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164542">case</span>&nbsp;<span class="ident" id="5164547">syntax</span><span class="op" id="5164553">.</span><span class="ident" id="5164554">InstRuneAny</span><span class="op" id="5164565">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164570">ok</span>&nbsp;<span class="op" id="5164573">=</span>&nbsp;<span class="ident" id="5164575">check</span><span class="op" id="5164580">(</span><span class="ident" id="5164581">inst</span><span class="op" id="5164585">.</span><span class="ident" id="5164586">Out</span><span class="op" id="5164589">,</span>&nbsp;<span class="ident" id="5164591">m</span><span class="op" id="5164592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164597">m</span><span class="op" id="5164598">[</span><span class="ident" id="5164599">pc</span><span class="op" id="5164601">]</span>&nbsp;<span class="op" id="5164603">=</span>&nbsp;<span class="builtintype" id="5164605">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164614">if</span>&nbsp;<span class="builtinfunc" id="5164617">len</span><span class="op" id="5164620">(</span><span class="ident" id="5164621">inst</span><span class="op" id="5164625">.</span><span class="ident" id="5164626">Next</span><span class="op" id="5164630">)</span>&nbsp;<span class="op" id="5164632">&gt;</span>&nbsp;<span class="num" id="5164634">0</span>&nbsp;<span class="op" id="5164636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164642">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164651">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164656">onePassRunes</span><span class="op" id="5164668">[</span><span class="ident" id="5164669">pc</span><span class="op" id="5164671">]</span>&nbsp;<span class="op" id="5164673">=</span>&nbsp;<span class="builtinfunc" id="5164675">append</span><span class="op" id="5164681">(</span><span class="op" id="5164682">[</span><span class="op" id="5164683">]</span><span class="builtintype" id="5164684">rune</span><span class="op" id="5164688">{</span><span class="op" id="5164689">}</span><span class="op" id="5164690">,</span>&nbsp;<span class="ident" id="5164692">anyRune</span><span class="op" id="5164699">...</span><span class="op" id="5164702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164707">inst</span><span class="op" id="5164711">.</span><span class="ident" id="5164712">Next</span>&nbsp;<span class="op" id="5164717">=</span>&nbsp;<span class="op" id="5164719">[</span><span class="op" id="5164720">]</span><span class="builtintype" id="5164721">uint32</span><span class="op" id="5164727">{</span><span class="ident" id="5164728">inst</span><span class="op" id="5164732">.</span><span class="ident" id="5164733">Out</span><span class="op" id="5164736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164740">case</span>&nbsp;<span class="ident" id="5164745">syntax</span><span class="op" id="5164751">.</span><span class="ident" id="5164752">InstRuneAnyNotNL</span><span class="op" id="5164768">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164773">ok</span>&nbsp;<span class="op" id="5164776">=</span>&nbsp;<span class="ident" id="5164778">check</span><span class="op" id="5164783">(</span><span class="ident" id="5164784">inst</span><span class="op" id="5164788">.</span><span class="ident" id="5164789">Out</span><span class="op" id="5164792">,</span>&nbsp;<span class="ident" id="5164794">m</span><span class="op" id="5164795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164800">m</span><span class="op" id="5164801">[</span><span class="ident" id="5164802">pc</span><span class="op" id="5164804">]</span>&nbsp;<span class="op" id="5164806">=</span>&nbsp;<span class="builtintype" id="5164808">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164817">if</span>&nbsp;<span class="builtinfunc" id="5164820">len</span><span class="op" id="5164823">(</span><span class="ident" id="5164824">inst</span><span class="op" id="5164828">.</span><span class="ident" id="5164829">Next</span><span class="op" id="5164833">)</span>&nbsp;<span class="op" id="5164835">&gt;</span>&nbsp;<span class="num" id="5164837">0</span>&nbsp;<span class="op" id="5164839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164845">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5164854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164859">onePassRunes</span><span class="op" id="5164871">[</span><span class="ident" id="5164872">pc</span><span class="op" id="5164874">]</span>&nbsp;<span class="op" id="5164876">=</span>&nbsp;<span class="builtinfunc" id="5164878">append</span><span class="op" id="5164884">(</span><span class="op" id="5164885">[</span><span class="op" id="5164886">]</span><span class="builtintype" id="5164887">rune</span><span class="op" id="5164891">{</span><span class="op" id="5164892">}</span><span class="op" id="5164893">,</span>&nbsp;<span class="ident" id="5164895">anyRuneNotNL</span><span class="op" id="5164907">...</span><span class="op" id="5164910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164915">inst</span><span class="op" id="5164919">.</span><span class="ident" id="5164920">Next</span>&nbsp;<span class="op" id="5164925">=</span>&nbsp;<span class="op" id="5164927">[</span><span class="op" id="5164928">]</span><span class="builtintype" id="5164929">uint32</span><span class="op" id="5164935">{</span><span class="op" id="5164936">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5164941">for</span>&nbsp;<span class="ident" id="5164945">i</span>&nbsp;<span class="op" id="5164947">:=</span>&nbsp;<span class="builtinfunc" id="5164950">len</span><span class="op" id="5164953">(</span><span class="ident" id="5164954">onePassRunes</span><span class="op" id="5164966">[</span><span class="ident" id="5164967">pc</span><span class="op" id="5164969">]</span><span class="op" id="5164970">)</span>&nbsp;<span class="op" id="5164972">/</span>&nbsp;<span class="num" id="5164974">2</span><span class="op" id="5164975">;</span>&nbsp;<span class="ident" id="5164977">i</span>&nbsp;<span class="op" id="5164979">&gt;=</span>&nbsp;<span class="num" id="5164982">0</span><span class="op" id="5164983">;</span>&nbsp;<span class="ident" id="5164985">i</span><span class="op" id="5164986">--</span>&nbsp;<span class="op" id="5164989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5164995">inst</span><span class="op" id="5164999">.</span><span class="ident" id="5165000">Next</span>&nbsp;<span class="op" id="5165005">=</span>&nbsp;<span class="builtinfunc" id="5165007">append</span><span class="op" id="5165013">(</span><span class="ident" id="5165014">inst</span><span class="op" id="5165018">.</span><span class="ident" id="5165019">Next</span><span class="op" id="5165023">,</span>&nbsp;<span class="ident" id="5165025">inst</span><span class="op" id="5165029">.</span><span class="ident" id="5165030">Out</span><span class="op" id="5165033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165046">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165058">instQueue</span><span class="op" id="5165067">.</span><span class="ident" id="5165068">clear</span><span class="op" id="5165073">(</span><span class="op" id="5165074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165077">instQueue</span><span class="op" id="5165086">.</span><span class="ident" id="5165087">insert</span><span class="op" id="5165093">(</span><span class="builtintype" id="5165094">uint32</span><span class="op" id="5165100">(</span><span class="ident" id="5165101">p</span><span class="op" id="5165102">.</span><span class="ident" id="5165103">Start</span><span class="op" id="5165108">)</span><span class="op" id="5165109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165112">m</span>&nbsp;<span class="op" id="5165114">:=</span>&nbsp;<span class="builtinfunc" id="5165117">make</span><span class="op" id="5165121">(</span><span class="keyword" id="5165122">map</span><span class="op" id="5165125">[</span><span class="builtintype" id="5165126">uint32</span><span class="op" id="5165132">]</span><span class="builtintype" id="5165133">bool</span><span class="op" id="5165137">,</span>&nbsp;<span class="builtinfunc" id="5165139">len</span><span class="op" id="5165142">(</span><span class="ident" id="5165143">p</span><span class="op" id="5165144">.</span><span class="ident" id="5165145">Inst</span><span class="op" id="5165149">)</span><span class="op" id="5165150">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165153">for</span>&nbsp;<span class="op" id="5165157">!</span><span class="ident" id="5165158">instQueue</span><span class="op" id="5165167">.</span><span class="ident" id="5165168">empty</span><span class="op" id="5165173">(</span><span class="op" id="5165174">)</span>&nbsp;<span class="op" id="5165176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165180">pc</span>&nbsp;<span class="op" id="5165183">:=</span>&nbsp;<span class="ident" id="5165186">instQueue</span><span class="op" id="5165195">.</span><span class="ident" id="5165196">next</span><span class="op" id="5165200">(</span><span class="op" id="5165201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165205">inst</span>&nbsp;<span class="op" id="5165210">:=</span>&nbsp;<span class="ident" id="5165213">p</span><span class="op" id="5165214">.</span><span class="ident" id="5165215">Inst</span><span class="op" id="5165219">[</span><span class="ident" id="5165220">pc</span><span class="op" id="5165222">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165226">visitQueue</span><span class="op" id="5165236">.</span><span class="ident" id="5165237">clear</span><span class="op" id="5165242">(</span><span class="op" id="5165243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165247">if</span>&nbsp;<span class="op" id="5165250">!</span><span class="ident" id="5165251">check</span><span class="op" id="5165256">(</span><span class="builtintype" id="5165257">uint32</span><span class="op" id="5165263">(</span><span class="ident" id="5165264">pc</span><span class="op" id="5165266">)</span><span class="op" id="5165267">,</span>&nbsp;<span class="ident" id="5165269">m</span><span class="op" id="5165270">)</span>&nbsp;<span class="op" id="5165272">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165277">p</span>&nbsp;<span class="op" id="5165279">=</span>&nbsp;<span class="ident" id="5165281">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165295">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165307">switch</span>&nbsp;<span class="ident" id="5165314">inst</span><span class="op" id="5165318">.</span><span class="ident" id="5165319">Op</span>&nbsp;<span class="op" id="5165322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165326">case</span>&nbsp;<span class="ident" id="5165331">syntax</span><span class="op" id="5165337">.</span><span class="ident" id="5165338">InstAlt</span><span class="op" id="5165345">,</span>&nbsp;<span class="ident" id="5165347">syntax</span><span class="op" id="5165353">.</span><span class="ident" id="5165354">InstAltMatch</span><span class="op" id="5165366">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165371">instQueue</span><span class="op" id="5165380">.</span><span class="ident" id="5165381">insert</span><span class="op" id="5165387">(</span><span class="ident" id="5165388">inst</span><span class="op" id="5165392">.</span><span class="ident" id="5165393">Out</span><span class="op" id="5165396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165401">instQueue</span><span class="op" id="5165410">.</span><span class="ident" id="5165411">insert</span><span class="op" id="5165417">(</span><span class="ident" id="5165418">inst</span><span class="op" id="5165422">.</span><span class="ident" id="5165423">Arg</span><span class="op" id="5165426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165430">case</span>&nbsp;<span class="ident" id="5165435">syntax</span><span class="op" id="5165441">.</span><span class="ident" id="5165442">InstCapture</span><span class="op" id="5165453">,</span>&nbsp;<span class="ident" id="5165455">syntax</span><span class="op" id="5165461">.</span><span class="ident" id="5165462">InstEmptyWidth</span><span class="op" id="5165476">,</span>&nbsp;<span class="ident" id="5165478">syntax</span><span class="op" id="5165484">.</span><span class="ident" id="5165485">InstNop</span><span class="op" id="5165492">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165497">instQueue</span><span class="op" id="5165506">.</span><span class="ident" id="5165507">insert</span><span class="op" id="5165513">(</span><span class="ident" id="5165514">inst</span><span class="op" id="5165518">.</span><span class="ident" id="5165519">Out</span><span class="op" id="5165522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165526">case</span>&nbsp;<span class="ident" id="5165531">syntax</span><span class="op" id="5165537">.</span><span class="ident" id="5165538">InstMatch</span><span class="op" id="5165547">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165551">case</span>&nbsp;<span class="ident" id="5165556">syntax</span><span class="op" id="5165562">.</span><span class="ident" id="5165563">InstFail</span><span class="op" id="5165571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165575">case</span>&nbsp;<span class="ident" id="5165580">syntax</span><span class="op" id="5165586">.</span><span class="ident" id="5165587">InstRune</span><span class="op" id="5165595">,</span>&nbsp;<span class="ident" id="5165597">syntax</span><span class="op" id="5165603">.</span><span class="ident" id="5165604">InstRune1</span><span class="op" id="5165613">,</span>&nbsp;<span class="ident" id="5165615">syntax</span><span class="op" id="5165621">.</span><span class="ident" id="5165622">InstRuneAny</span><span class="op" id="5165633">,</span>&nbsp;<span class="ident" id="5165635">syntax</span><span class="op" id="5165641">.</span><span class="ident" id="5165642">InstRuneAnyNotNL</span><span class="op" id="5165658">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165662">default</span><span class="op" id="5165669">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165673">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165676">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165679">if</span>&nbsp;<span class="ident" id="5165682">p</span>&nbsp;<span class="op" id="5165684">!=</span>&nbsp;<span class="ident" id="5165687">notOnePass</span>&nbsp;<span class="op" id="5165698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165702">for</span>&nbsp;<span class="ident" id="5165706">i</span>&nbsp;<span class="op" id="5165708">:=</span>&nbsp;<span class="keyword" id="5165711">range</span>&nbsp;<span class="ident" id="5165717">p</span><span class="op" id="5165718">.</span><span class="ident" id="5165719">Inst</span>&nbsp;<span class="op" id="5165724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165729">p</span><span class="op" id="5165730">.</span><span class="ident" id="5165731">Inst</span><span class="op" id="5165735">[</span><span class="ident" id="5165736">i</span><span class="op" id="5165737">]</span><span class="op" id="5165738">.</span><span class="ident" id="5165739">Rune</span>&nbsp;<span class="op" id="5165744">=</span>&nbsp;<span class="ident" id="5165746">onePassRunes</span><span class="op" id="5165758">[</span><span class="ident" id="5165759">i</span><span class="op" id="5165760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5165767">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165770">return</span>&nbsp;<span class="ident" id="5165777">p</span><br>
<span class="lineno"></span><span class="op" id="5165779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5165782">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="5165850">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="5165887">func</span>&nbsp;<span class="ident" id="5165892">walk</span><span class="op" id="5165896">(</span><span class="ident" id="5165897">prog</span>&nbsp;<span class="op" id="5165902">*</span><span class="ident" id="5165903">syntax</span><span class="op" id="5165909">.</span><span class="ident" id="5165910">Prog</span><span class="op" id="5165914">,</span>&nbsp;<span class="ident" id="5165916">funcs</span>&nbsp;<span class="op" id="5165922">...</span><span class="keyword" id="5165925">func</span><span class="op" id="5165929">(</span><span class="ident" id="5165930">ip</span><span class="op" id="5165932">,</span>&nbsp;<span class="ident" id="5165934">next</span>&nbsp;<span class="builtintype" id="5165939">uint32</span><span class="op" id="5165945">)</span><span class="op" id="5165946">)</span>&nbsp;<span class="op" id="5165948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5165951">var</span>&nbsp;<span class="ident" id="5165955">walk1</span>&nbsp;<span class="keyword" id="5165961">func</span><span class="op" id="5165965">(</span><span class="builtintype" id="5165966">uint32</span><span class="op" id="5165972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5165975">progQueue</span>&nbsp;<span class="op" id="5165985">:=</span>&nbsp;<span class="ident" id="5165988">newQueue</span><span class="op" id="5165996">(</span><span class="builtinfunc" id="5165997">len</span><span class="op" id="5166000">(</span><span class="ident" id="5166001">prog</span><span class="op" id="5166005">.</span><span class="ident" id="5166006">Inst</span><span class="op" id="5166010">)</span><span class="op" id="5166011">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166014">walk1</span>&nbsp;<span class="op" id="5166020">=</span>&nbsp;<span class="keyword" id="5166022">func</span><span class="op" id="5166026">(</span><span class="ident" id="5166027">ip</span>&nbsp;<span class="builtintype" id="5166030">uint32</span><span class="op" id="5166036">)</span>&nbsp;<span class="op" id="5166038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166042">if</span>&nbsp;<span class="ident" id="5166045">progQueue</span><span class="op" id="5166054">.</span><span class="ident" id="5166055">contains</span><span class="op" id="5166063">(</span><span class="ident" id="5166064">ip</span><span class="op" id="5166066">)</span>&nbsp;<span class="op" id="5166068">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166073">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166086">progQueue</span><span class="op" id="5166095">.</span><span class="ident" id="5166096">insert</span><span class="op" id="5166102">(</span><span class="ident" id="5166103">ip</span><span class="op" id="5166105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166109">inst</span>&nbsp;<span class="op" id="5166114">:=</span>&nbsp;<span class="ident" id="5166117">prog</span><span class="op" id="5166121">.</span><span class="ident" id="5166122">Inst</span><span class="op" id="5166126">[</span><span class="ident" id="5166127">ip</span><span class="op" id="5166129">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166133">switch</span>&nbsp;<span class="ident" id="5166140">inst</span><span class="op" id="5166144">.</span><span class="ident" id="5166145">Op</span>&nbsp;<span class="op" id="5166148">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166152">case</span>&nbsp;<span class="ident" id="5166157">syntax</span><span class="op" id="5166163">.</span><span class="ident" id="5166164">InstAlt</span><span class="op" id="5166171">,</span>&nbsp;<span class="ident" id="5166173">syntax</span><span class="op" id="5166179">.</span><span class="ident" id="5166180">InstAltMatch</span><span class="op" id="5166192">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166197">for</span>&nbsp;<span class="ident" id="5166201">_</span><span class="op" id="5166202">,</span>&nbsp;<span class="ident" id="5166204">f</span>&nbsp;<span class="op" id="5166206">:=</span>&nbsp;<span class="keyword" id="5166209">range</span>&nbsp;<span class="ident" id="5166215">funcs</span>&nbsp;<span class="op" id="5166221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166227">f</span><span class="op" id="5166228">(</span><span class="ident" id="5166229">ip</span><span class="op" id="5166231">,</span>&nbsp;<span class="ident" id="5166233">inst</span><span class="op" id="5166237">.</span><span class="ident" id="5166238">Out</span><span class="op" id="5166241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166247">f</span><span class="op" id="5166248">(</span><span class="ident" id="5166249">ip</span><span class="op" id="5166251">,</span>&nbsp;<span class="ident" id="5166253">inst</span><span class="op" id="5166257">.</span><span class="ident" id="5166258">Arg</span><span class="op" id="5166261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166266">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166271">walk1</span><span class="op" id="5166276">(</span><span class="ident" id="5166277">inst</span><span class="op" id="5166281">.</span><span class="ident" id="5166282">Out</span><span class="op" id="5166285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166290">walk1</span><span class="op" id="5166295">(</span><span class="ident" id="5166296">inst</span><span class="op" id="5166300">.</span><span class="ident" id="5166301">Arg</span><span class="op" id="5166304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166308">default</span><span class="op" id="5166315">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166320">for</span>&nbsp;<span class="ident" id="5166324">_</span><span class="op" id="5166325">,</span>&nbsp;<span class="ident" id="5166327">f</span>&nbsp;<span class="op" id="5166329">:=</span>&nbsp;<span class="keyword" id="5166332">range</span>&nbsp;<span class="ident" id="5166338">funcs</span>&nbsp;<span class="op" id="5166344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166350">f</span><span class="op" id="5166351">(</span><span class="ident" id="5166352">ip</span><span class="op" id="5166354">,</span>&nbsp;<span class="ident" id="5166356">inst</span><span class="op" id="5166360">.</span><span class="ident" id="5166361">Out</span><span class="op" id="5166364">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166374">walk1</span><span class="op" id="5166379">(</span><span class="ident" id="5166380">inst</span><span class="op" id="5166384">.</span><span class="ident" id="5166385">Out</span><span class="op" id="5166388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166398">walk1</span><span class="op" id="5166403">(</span><span class="builtintype" id="5166404">uint32</span><span class="op" id="5166410">(</span><span class="ident" id="5166411">prog</span><span class="op" id="5166415">.</span><span class="ident" id="5166416">Start</span><span class="op" id="5166421">)</span><span class="op" id="5166422">)</span><br>
<span class="lineno">520</span><span class="op" id="5166424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5166427">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="5166496">func</span>&nbsp;<span class="ident" id="5166501">find</span><span class="op" id="5166505">(</span><span class="ident" id="5166506">prog</span>&nbsp;<span class="op" id="5166511">*</span><span class="ident" id="5166512">syntax</span><span class="op" id="5166518">.</span><span class="ident" id="5166519">Prog</span><span class="op" id="5166523">,</span>&nbsp;<span class="ident" id="5166525">f</span>&nbsp;<span class="keyword" id="5166527">func</span><span class="op" id="5166531">(</span><span class="op" id="5166532">*</span><span class="ident" id="5166533">syntax</span><span class="op" id="5166539">.</span><span class="ident" id="5166540">Prog</span><span class="op" id="5166544">,</span>&nbsp;<span class="builtintype" id="5166546">int</span><span class="op" id="5166549">)</span>&nbsp;<span class="builtintype" id="5166551">bool</span><span class="op" id="5166555">)</span>&nbsp;<span class="op" id="5166557">(</span><span class="ident" id="5166558">matches</span>&nbsp;<span class="op" id="5166566">[</span><span class="op" id="5166567">]</span><span class="builtintype" id="5166568">uint32</span><span class="op" id="5166574">)</span>&nbsp;<span class="op" id="5166576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166579">matches</span>&nbsp;<span class="op" id="5166587">=</span>&nbsp;<span class="op" id="5166589">[</span><span class="op" id="5166590">]</span><span class="builtintype" id="5166591">uint32</span><span class="op" id="5166597">{</span><span class="op" id="5166598">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166602">for</span>&nbsp;<span class="ident" id="5166606">ip</span>&nbsp;<span class="op" id="5166609">:=</span>&nbsp;<span class="keyword" id="5166612">range</span>&nbsp;<span class="ident" id="5166618">prog</span><span class="op" id="5166622">.</span><span class="ident" id="5166623">Inst</span>&nbsp;<span class="op" id="5166628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166632">if</span>&nbsp;<span class="ident" id="5166635">f</span><span class="op" id="5166636">(</span><span class="ident" id="5166637">prog</span><span class="op" id="5166641">,</span>&nbsp;<span class="ident" id="5166643">ip</span><span class="op" id="5166645">)</span>&nbsp;<span class="op" id="5166647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5166652">matches</span>&nbsp;<span class="op" id="5166660">=</span>&nbsp;<span class="builtinfunc" id="5166662">append</span><span class="op" id="5166668">(</span><span class="ident" id="5166669">matches</span><span class="op" id="5166676">,</span>&nbsp;<span class="builtintype" id="5166678">uint32</span><span class="op" id="5166684">(</span><span class="ident" id="5166685">ip</span><span class="op" id="5166687">)</span><span class="op" id="5166688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166692">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5166695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5166698">return</span><br>
<span class="lineno"></span><span class="op" id="5166705">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5166708">var</span>&nbsp;<span class="ident" id="5166712">notOnePass</span>&nbsp;<span class="op" id="5166723">*</span><span class="ident" id="5166724">onePassProg</span>&nbsp;<span class="op" id="5166736">=</span>&nbsp;<span class="builtintype" id="5166738">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="5166743">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="5166840">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5166924">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="5167010">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="5167096">func</span>&nbsp;<span class="ident" id="5167101">compileOnePass</span><span class="op" id="5167115">(</span><span class="ident" id="5167116">prog</span>&nbsp;<span class="op" id="5167121">*</span><span class="ident" id="5167122">syntax</span><span class="op" id="5167128">.</span><span class="ident" id="5167129">Prog</span><span class="op" id="5167133">)</span>&nbsp;<span class="op" id="5167135">(</span><span class="ident" id="5167136">p</span>&nbsp;<span class="op" id="5167138">*</span><span class="ident" id="5167139">onePassProg</span><span class="op" id="5167150">)</span>&nbsp;<span class="op" id="5167152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167155">if</span>&nbsp;<span class="ident" id="5167158">prog</span><span class="op" id="5167162">.</span><span class="ident" id="5167163">Start</span>&nbsp;<span class="op" id="5167169">==</span>&nbsp;<span class="num" id="5167172">0</span>&nbsp;<span class="op" id="5167174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167178">return</span>&nbsp;<span class="ident" id="5167185">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167200">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167231">if</span>&nbsp;<span class="ident" id="5167234">prog</span><span class="op" id="5167238">.</span><span class="ident" id="5167239">Inst</span><span class="op" id="5167243">[</span><span class="ident" id="5167244">prog</span><span class="op" id="5167248">.</span><span class="ident" id="5167249">Start</span><span class="op" id="5167254">]</span><span class="op" id="5167255">.</span><span class="ident" id="5167256">Op</span>&nbsp;<span class="op" id="5167259">!=</span>&nbsp;<span class="ident" id="5167262">syntax</span><span class="op" id="5167268">.</span><span class="ident" id="5167269">InstEmptyWidth</span>&nbsp;<span class="op" id="5167284">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167289">syntax</span><span class="op" id="5167295">.</span><span class="ident" id="5167296">EmptyOp</span><span class="op" id="5167303">(</span><span class="ident" id="5167304">prog</span><span class="op" id="5167308">.</span><span class="ident" id="5167309">Inst</span><span class="op" id="5167313">[</span><span class="ident" id="5167314">prog</span><span class="op" id="5167318">.</span><span class="ident" id="5167319">Start</span><span class="op" id="5167324">]</span><span class="op" id="5167325">.</span><span class="ident" id="5167326">Arg</span><span class="op" id="5167329">)</span><span class="op" id="5167330">&amp;</span><span class="ident" id="5167331">syntax</span><span class="op" id="5167337">.</span><span class="ident" id="5167338">EmptyBeginText</span>&nbsp;<span class="op" id="5167353">!=</span>&nbsp;<span class="ident" id="5167356">syntax</span><span class="op" id="5167362">.</span><span class="ident" id="5167363">EmptyBeginText</span>&nbsp;<span class="op" id="5167378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167382">return</span>&nbsp;<span class="ident" id="5167389">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167404">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167468">for</span>&nbsp;<span class="ident" id="5167472">_</span><span class="op" id="5167473">,</span>&nbsp;<span class="ident" id="5167475">inst</span>&nbsp;<span class="op" id="5167480">:=</span>&nbsp;<span class="keyword" id="5167483">range</span>&nbsp;<span class="ident" id="5167489">prog</span><span class="op" id="5167493">.</span><span class="ident" id="5167494">Inst</span>&nbsp;<span class="op" id="5167499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5167503">opOut</span>&nbsp;<span class="op" id="5167509">:=</span>&nbsp;<span class="ident" id="5167512">prog</span><span class="op" id="5167516">.</span><span class="ident" id="5167517">Inst</span><span class="op" id="5167521">[</span><span class="ident" id="5167522">inst</span><span class="op" id="5167526">.</span><span class="ident" id="5167527">Out</span><span class="op" id="5167530">]</span><span class="op" id="5167531">.</span><span class="ident" id="5167532">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167537">switch</span>&nbsp;<span class="ident" id="5167544">inst</span><span class="op" id="5167548">.</span><span class="ident" id="5167549">Op</span>&nbsp;<span class="op" id="5167552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167556">default</span><span class="op" id="5167563">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167568">if</span>&nbsp;<span class="ident" id="5167571">opOut</span>&nbsp;<span class="op" id="5167577">==</span>&nbsp;<span class="ident" id="5167580">syntax</span><span class="op" id="5167586">.</span><span class="ident" id="5167587">InstMatch</span>&nbsp;<span class="op" id="5167597">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167603">return</span>&nbsp;<span class="ident" id="5167610">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167628">case</span>&nbsp;<span class="ident" id="5167633">syntax</span><span class="op" id="5167639">.</span><span class="ident" id="5167640">InstAlt</span><span class="op" id="5167647">,</span>&nbsp;<span class="ident" id="5167649">syntax</span><span class="op" id="5167655">.</span><span class="ident" id="5167656">InstAltMatch</span><span class="op" id="5167668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167673">if</span>&nbsp;<span class="ident" id="5167676">opOut</span>&nbsp;<span class="op" id="5167682">==</span>&nbsp;<span class="ident" id="5167685">syntax</span><span class="op" id="5167691">.</span><span class="ident" id="5167692">InstMatch</span>&nbsp;<span class="op" id="5167702">||</span>&nbsp;<span class="ident" id="5167705">prog</span><span class="op" id="5167709">.</span><span class="ident" id="5167710">Inst</span><span class="op" id="5167714">[</span><span class="ident" id="5167715">inst</span><span class="op" id="5167719">.</span><span class="ident" id="5167720">Arg</span><span class="op" id="5167723">]</span><span class="op" id="5167724">.</span><span class="ident" id="5167725">Op</span>&nbsp;<span class="op" id="5167728">==</span>&nbsp;<span class="ident" id="5167731">syntax</span><span class="op" id="5167737">.</span><span class="ident" id="5167738">InstMatch</span>&nbsp;<span class="op" id="5167748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167754">return</span>&nbsp;<span class="ident" id="5167761">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167775">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167779">case</span>&nbsp;<span class="ident" id="5167784">syntax</span><span class="op" id="5167790">.</span><span class="ident" id="5167791">InstEmptyWidth</span><span class="op" id="5167805">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167810">if</span>&nbsp;<span class="ident" id="5167813">opOut</span>&nbsp;<span class="op" id="5167819">==</span>&nbsp;<span class="ident" id="5167822">syntax</span><span class="op" id="5167828">.</span><span class="ident" id="5167829">InstMatch</span>&nbsp;<span class="op" id="5167839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167845">if</span>&nbsp;<span class="ident" id="5167848">syntax</span><span class="op" id="5167854">.</span><span class="ident" id="5167855">EmptyOp</span><span class="op" id="5167862">(</span><span class="ident" id="5167863">inst</span><span class="op" id="5167867">.</span><span class="ident" id="5167868">Arg</span><span class="op" id="5167871">)</span><span class="op" id="5167872">&amp;</span><span class="ident" id="5167873">syntax</span><span class="op" id="5167879">.</span><span class="ident" id="5167880">EmptyEndText</span>&nbsp;<span class="op" id="5167893">==</span>&nbsp;<span class="ident" id="5167896">syntax</span><span class="op" id="5167902">.</span><span class="ident" id="5167903">EmptyEndText</span>&nbsp;<span class="op" id="5167916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167923">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167936">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5167942">return</span>&nbsp;<span class="ident" id="5167949">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5167970">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5167973">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168032">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168102">p</span>&nbsp;<span class="op" id="5168104">=</span>&nbsp;<span class="ident" id="5168106">onePassCopy</span><span class="op" id="5168117">(</span><span class="ident" id="5168118">prog</span><span class="op" id="5168122">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5168126">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168189">p</span>&nbsp;<span class="op" id="5168191">=</span>&nbsp;<span class="ident" id="5168193">makeOnePass</span><span class="op" id="5168204">(</span><span class="ident" id="5168205">p</span><span class="op" id="5168206">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168210">if</span>&nbsp;<span class="ident" id="5168213">p</span>&nbsp;<span class="op" id="5168215">!=</span>&nbsp;<span class="ident" id="5168218">notOnePass</span>&nbsp;<span class="op" id="5168229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5168233">cleanupOnePass</span><span class="op" id="5168247">(</span><span class="ident" id="5168248">p</span><span class="op" id="5168249">,</span>&nbsp;<span class="ident" id="5168251">prog</span><span class="op" id="5168255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5168258">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5168261">return</span>&nbsp;<span class="ident" id="5168268">p</span><br>
<span class="lineno"></span><span class="op" id="5168270">}</span>
</div>
</body>
</html>
