<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/fcgi</h2>
<ul>
<li><a href="/gostd/net/http/fcgi/child.go.html">child.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi.go.html">fcgi.go</a></li>
<li><a href="/gostd/net/http/fcgi/fcgi_test.go.html">fcgi_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6241972">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6242027">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6242081">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6242132">package</span>&nbsp;<span class="ident" id="6242140">fcgi</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6242146">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;FastCGI&nbsp;from&nbsp;the&nbsp;perspective&nbsp;of&nbsp;a&nbsp;child&nbsp;process.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6242220">import</span>&nbsp;<span class="op" id="6242227">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242230">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242240">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242247">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242253">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242266">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242273">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242285">&#34;net/http/cgi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242301">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242307">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242318">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6242326">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6242333">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6242336">//&nbsp;request&nbsp;holds&nbsp;the&nbsp;state&nbsp;for&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;As&nbsp;soon&nbsp;as&nbsp;it&#39;s&nbsp;complete,</span><br>
<span class="lineno"></span><span class="comment" id="6242417">//&nbsp;it&#39;s&nbsp;converted&nbsp;to&nbsp;an&nbsp;http.Request.</span><br>
<span class="lineno">25</span><span class="keyword" id="6242455">type</span>&nbsp;<span class="ident" id="6242460">request</span>&nbsp;<span class="keyword" id="6242468">struct</span>&nbsp;<span class="op" id="6242475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242478">pw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242488">*</span><span class="ident" id="6242489">io</span><span class="op" id="6242491">.</span><span class="ident" id="6242492">PipeWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242504">reqId</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6242514">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242522">params</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242532">map</span><span class="op" id="6242535">[</span><span class="builtintype" id="6242536">string</span><span class="op" id="6242542">]</span><span class="builtintype" id="6242543">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242551">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6242561">[</span><span class="num" id="6242562">1024</span><span class="op" id="6242566">]</span><span class="builtintype" id="6242567">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242573">rawParams</span>&nbsp;<span class="op" id="6242583">[</span><span class="op" id="6242584">]</span><span class="builtintype" id="6242585">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242591">keepConn</span>&nbsp;&nbsp;<span class="builtintype" id="6242601">bool</span><br>
<span class="lineno"></span><span class="op" id="6242606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6242609">func</span>&nbsp;<span class="ident" id="6242614">newRequest</span><span class="op" id="6242624">(</span><span class="ident" id="6242625">reqId</span>&nbsp;<span class="builtintype" id="6242631">uint16</span><span class="op" id="6242637">,</span>&nbsp;<span class="ident" id="6242639">flags</span>&nbsp;<span class="builtintype" id="6242645">uint8</span><span class="op" id="6242650">)</span>&nbsp;<span class="op" id="6242652">*</span><span class="ident" id="6242653">request</span>&nbsp;<span class="op" id="6242661">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242664">r</span>&nbsp;<span class="op" id="6242666">:=</span>&nbsp;<span class="op" id="6242669">&amp;</span><span class="ident" id="6242670">request</span><span class="op" id="6242677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242681">reqId</span><span class="op" id="6242686">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6242691">reqId</span><span class="op" id="6242696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242700">params</span><span class="op" id="6242706">:</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="6242710">map</span><span class="op" id="6242713">[</span><span class="builtintype" id="6242714">string</span><span class="op" id="6242720">]</span><span class="builtintype" id="6242721">string</span><span class="op" id="6242727">{</span><span class="op" id="6242728">}</span><span class="op" id="6242729">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242733">keepConn</span><span class="op" id="6242741">:</span>&nbsp;<span class="ident" id="6242743">flags</span><span class="op" id="6242748">&amp;</span><span class="ident" id="6242749">flagKeepConn</span>&nbsp;<span class="op" id="6242762">!=</span>&nbsp;<span class="num" id="6242765">0</span><span class="op" id="6242766">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6242769">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242772">r</span><span class="op" id="6242773">.</span><span class="ident" id="6242774">rawParams</span>&nbsp;<span class="op" id="6242784">=</span>&nbsp;<span class="ident" id="6242786">r</span><span class="op" id="6242787">.</span><span class="ident" id="6242788">buf</span><span class="op" id="6242791">[</span><span class="op" id="6242792">:</span><span class="num" id="6242793">0</span><span class="op" id="6242794">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6242797">return</span>&nbsp;<span class="ident" id="6242804">r</span><br>
<span class="lineno"></span><span class="op" id="6242806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6242809">//&nbsp;parseParams&nbsp;reads&nbsp;an&nbsp;encoded&nbsp;[]byte&nbsp;into&nbsp;Params.</span><br>
<span class="lineno">45</span><span class="keyword" id="6242861">func</span>&nbsp;<span class="op" id="6242866">(</span><span class="ident" id="6242867">r</span>&nbsp;<span class="op" id="6242869">*</span><span class="ident" id="6242870">request</span><span class="op" id="6242877">)</span>&nbsp;<span class="ident" id="6242879">parseParams</span><span class="op" id="6242890">(</span><span class="op" id="6242891">)</span>&nbsp;<span class="op" id="6242893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242896">text</span>&nbsp;<span class="op" id="6242901">:=</span>&nbsp;<span class="ident" id="6242904">r</span><span class="op" id="6242905">.</span><span class="ident" id="6242906">rawParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242917">r</span><span class="op" id="6242918">.</span><span class="ident" id="6242919">rawParams</span>&nbsp;<span class="op" id="6242929">=</span>&nbsp;<span class="ident" id="6242931">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6242936">for</span>&nbsp;<span class="builtinfunc" id="6242940">len</span><span class="op" id="6242943">(</span><span class="ident" id="6242944">text</span><span class="op" id="6242948">)</span>&nbsp;<span class="op" id="6242950">&gt;</span>&nbsp;<span class="num" id="6242952">0</span>&nbsp;<span class="op" id="6242954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6242958">keyLen</span><span class="op" id="6242964">,</span>&nbsp;<span class="ident" id="6242966">n</span>&nbsp;<span class="op" id="6242968">:=</span>&nbsp;<span class="ident" id="6242971">readSize</span><span class="op" id="6242979">(</span><span class="ident" id="6242980">text</span><span class="op" id="6242984">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6242988">if</span>&nbsp;<span class="ident" id="6242991">n</span>&nbsp;<span class="op" id="6242993">==</span>&nbsp;<span class="num" id="6242996">0</span>&nbsp;<span class="op" id="6242998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243003">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243012">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243016">text</span>&nbsp;<span class="op" id="6243021">=</span>&nbsp;<span class="ident" id="6243023">text</span><span class="op" id="6243027">[</span><span class="ident" id="6243028">n</span><span class="op" id="6243029">:</span><span class="op" id="6243030">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243034">valLen</span><span class="op" id="6243040">,</span>&nbsp;<span class="ident" id="6243042">n</span>&nbsp;<span class="op" id="6243044">:=</span>&nbsp;<span class="ident" id="6243047">readSize</span><span class="op" id="6243055">(</span><span class="ident" id="6243056">text</span><span class="op" id="6243060">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243064">if</span>&nbsp;<span class="ident" id="6243067">n</span>&nbsp;<span class="op" id="6243069">==</span>&nbsp;<span class="num" id="6243072">0</span>&nbsp;<span class="op" id="6243074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243079">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243092">text</span>&nbsp;<span class="op" id="6243097">=</span>&nbsp;<span class="ident" id="6243099">text</span><span class="op" id="6243103">[</span><span class="ident" id="6243104">n</span><span class="op" id="6243105">:</span><span class="op" id="6243106">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243110">key</span>&nbsp;<span class="op" id="6243114">:=</span>&nbsp;<span class="ident" id="6243117">readString</span><span class="op" id="6243127">(</span><span class="ident" id="6243128">text</span><span class="op" id="6243132">,</span>&nbsp;<span class="ident" id="6243134">keyLen</span><span class="op" id="6243140">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243144">text</span>&nbsp;<span class="op" id="6243149">=</span>&nbsp;<span class="ident" id="6243151">text</span><span class="op" id="6243155">[</span><span class="ident" id="6243156">keyLen</span><span class="op" id="6243162">:</span><span class="op" id="6243163">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243167">val</span>&nbsp;<span class="op" id="6243171">:=</span>&nbsp;<span class="ident" id="6243174">readString</span><span class="op" id="6243184">(</span><span class="ident" id="6243185">text</span><span class="op" id="6243189">,</span>&nbsp;<span class="ident" id="6243191">valLen</span><span class="op" id="6243197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243201">text</span>&nbsp;<span class="op" id="6243206">=</span>&nbsp;<span class="ident" id="6243208">text</span><span class="op" id="6243212">[</span><span class="ident" id="6243213">valLen</span><span class="op" id="6243219">:</span><span class="op" id="6243220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243224">r</span><span class="op" id="6243225">.</span><span class="ident" id="6243226">params</span><span class="op" id="6243232">[</span><span class="ident" id="6243233">key</span><span class="op" id="6243236">]</span>&nbsp;<span class="op" id="6243238">=</span>&nbsp;<span class="ident" id="6243240">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243245">}</span><br>
<span class="lineno">65</span><span class="op" id="6243247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6243250">//&nbsp;response&nbsp;implements&nbsp;http.ResponseWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="6243294">type</span>&nbsp;<span class="ident" id="6243299">response</span>&nbsp;<span class="keyword" id="6243308">struct</span>&nbsp;<span class="op" id="6243315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243318">req</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243330">*</span><span class="ident" id="6243331">request</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243340">header</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243352">http</span><span class="op" id="6243356">.</span><span class="ident" id="6243357">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243365">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6243377">*</span><span class="ident" id="6243378">bufWriter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243389">wroteHeader</span>&nbsp;<span class="builtintype" id="6243401">bool</span><br>
<span class="lineno"></span><span class="op" id="6243406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="6243409">func</span>&nbsp;<span class="ident" id="6243414">newResponse</span><span class="op" id="6243425">(</span><span class="ident" id="6243426">c</span>&nbsp;<span class="op" id="6243428">*</span><span class="ident" id="6243429">child</span><span class="op" id="6243434">,</span>&nbsp;<span class="ident" id="6243436">req</span>&nbsp;<span class="op" id="6243440">*</span><span class="ident" id="6243441">request</span><span class="op" id="6243448">)</span>&nbsp;<span class="op" id="6243450">*</span><span class="ident" id="6243451">response</span>&nbsp;<span class="op" id="6243460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243463">return</span>&nbsp;<span class="op" id="6243470">&amp;</span><span class="ident" id="6243471">response</span><span class="op" id="6243479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243483">req</span><span class="op" id="6243486">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243491">req</span><span class="op" id="6243494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243498">header</span><span class="op" id="6243504">:</span>&nbsp;<span class="ident" id="6243506">http</span><span class="op" id="6243510">.</span><span class="ident" id="6243511">Header</span><span class="op" id="6243517">{</span><span class="op" id="6243518">}</span><span class="op" id="6243519">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243523">w</span><span class="op" id="6243524">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6243531">newWriter</span><span class="op" id="6243540">(</span><span class="ident" id="6243541">c</span><span class="op" id="6243542">.</span><span class="ident" id="6243543">conn</span><span class="op" id="6243547">,</span>&nbsp;<span class="ident" id="6243549">typeStdout</span><span class="op" id="6243559">,</span>&nbsp;<span class="ident" id="6243561">req</span><span class="op" id="6243564">.</span><span class="ident" id="6243565">reqId</span><span class="op" id="6243570">)</span><span class="op" id="6243571">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243574">}</span><br>
<span class="lineno"></span><span class="op" id="6243576">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6243579">func</span>&nbsp;<span class="op" id="6243584">(</span><span class="ident" id="6243585">r</span>&nbsp;<span class="op" id="6243587">*</span><span class="ident" id="6243588">response</span><span class="op" id="6243596">)</span>&nbsp;<span class="ident" id="6243598">Header</span><span class="op" id="6243604">(</span><span class="op" id="6243605">)</span>&nbsp;<span class="ident" id="6243607">http</span><span class="op" id="6243611">.</span><span class="ident" id="6243612">Header</span>&nbsp;<span class="op" id="6243619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243622">return</span>&nbsp;<span class="ident" id="6243629">r</span><span class="op" id="6243630">.</span><span class="ident" id="6243631">header</span><br>
<span class="lineno">85</span><span class="op" id="6243638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6243641">func</span>&nbsp;<span class="op" id="6243646">(</span><span class="ident" id="6243647">r</span>&nbsp;<span class="op" id="6243649">*</span><span class="ident" id="6243650">response</span><span class="op" id="6243658">)</span>&nbsp;<span class="ident" id="6243660">Write</span><span class="op" id="6243665">(</span><span class="ident" id="6243666">data</span>&nbsp;<span class="op" id="6243671">[</span><span class="op" id="6243672">]</span><span class="builtintype" id="6243673">byte</span><span class="op" id="6243677">)</span>&nbsp;<span class="op" id="6243679">(</span><span class="builtintype" id="6243680">int</span><span class="op" id="6243683">,</span>&nbsp;<span class="builtintype" id="6243685">error</span><span class="op" id="6243690">)</span>&nbsp;<span class="op" id="6243692">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243695">if</span>&nbsp;<span class="op" id="6243698">!</span><span class="ident" id="6243699">r</span><span class="op" id="6243700">.</span><span class="ident" id="6243701">wroteHeader</span>&nbsp;<span class="op" id="6243713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243717">r</span><span class="op" id="6243718">.</span><span class="ident" id="6243719">WriteHeader</span><span class="op" id="6243730">(</span><span class="ident" id="6243731">http</span><span class="op" id="6243735">.</span><span class="ident" id="6243736">StatusOK</span><span class="op" id="6243744">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243750">return</span>&nbsp;<span class="ident" id="6243757">r</span><span class="op" id="6243758">.</span><span class="ident" id="6243759">w</span><span class="op" id="6243760">.</span><span class="ident" id="6243761">Write</span><span class="op" id="6243766">(</span><span class="ident" id="6243767">data</span><span class="op" id="6243771">)</span><br>
<span class="lineno"></span><span class="op" id="6243773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6243776">func</span>&nbsp;<span class="op" id="6243781">(</span><span class="ident" id="6243782">r</span>&nbsp;<span class="op" id="6243784">*</span><span class="ident" id="6243785">response</span><span class="op" id="6243793">)</span>&nbsp;<span class="ident" id="6243795">WriteHeader</span><span class="op" id="6243806">(</span><span class="ident" id="6243807">code</span>&nbsp;<span class="builtintype" id="6243812">int</span><span class="op" id="6243815">)</span>&nbsp;<span class="op" id="6243817">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243820">if</span>&nbsp;<span class="ident" id="6243823">r</span><span class="op" id="6243824">.</span><span class="ident" id="6243825">wroteHeader</span>&nbsp;<span class="op" id="6243837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243841">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6243849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243852">r</span><span class="op" id="6243853">.</span><span class="ident" id="6243854">wroteHeader</span>&nbsp;<span class="op" id="6243866">=</span>&nbsp;<span class="builtintype" id="6243868">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6243874">if</span>&nbsp;<span class="ident" id="6243877">code</span>&nbsp;<span class="op" id="6243882">==</span>&nbsp;<span class="ident" id="6243885">http</span><span class="op" id="6243889">.</span><span class="ident" id="6243890">StatusNotModified</span>&nbsp;<span class="op" id="6243908">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6243912">//&nbsp;Must&nbsp;not&nbsp;have&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243937">r</span><span class="op" id="6243938">.</span><span class="ident" id="6243939">header</span><span class="op" id="6243945">.</span><span class="ident" id="6243946">Del</span><span class="op" id="6243949">(</span><span class="string" id="6243950">&#34;Content-Type&#34;</span><span class="op" id="6243964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6243968">r</span><span class="op" id="6243969">.</span><span class="ident" id="6243970">header</span><span class="op" id="6243976">.</span><span class="ident" id="6243977">Del</span><span class="op" id="6243980">(</span><span class="string" id="6243981">&#34;Content-Length&#34;</span><span class="op" id="6243997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244001">r</span><span class="op" id="6244002">.</span><span class="ident" id="6244003">header</span><span class="op" id="6244009">.</span><span class="ident" id="6244010">Del</span><span class="op" id="6244013">(</span><span class="string" id="6244014">&#34;Transfer-Encoding&#34;</span><span class="op" id="6244033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6244036">}</span>&nbsp;<span class="keyword" id="6244038">else</span>&nbsp;<span class="keyword" id="6244043">if</span>&nbsp;<span class="ident" id="6244046">r</span><span class="op" id="6244047">.</span><span class="ident" id="6244048">header</span><span class="op" id="6244054">.</span><span class="ident" id="6244055">Get</span><span class="op" id="6244058">(</span><span class="string" id="6244059">&#34;Content-Type&#34;</span><span class="op" id="6244073">)</span>&nbsp;<span class="op" id="6244075">==</span>&nbsp;<span class="string" id="6244078">&#34;&#34;</span>&nbsp;<span class="op" id="6244081">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244085">r</span><span class="op" id="6244086">.</span><span class="ident" id="6244087">header</span><span class="op" id="6244093">.</span><span class="ident" id="6244094">Set</span><span class="op" id="6244097">(</span><span class="string" id="6244098">&#34;Content-Type&#34;</span><span class="op" id="6244112">,</span>&nbsp;<span class="string" id="6244114">&#34;text/html;&nbsp;charset=utf-8&#34;</span><span class="op" id="6244140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6244143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244147">if</span>&nbsp;<span class="ident" id="6244150">r</span><span class="op" id="6244151">.</span><span class="ident" id="6244152">header</span><span class="op" id="6244158">.</span><span class="ident" id="6244159">Get</span><span class="op" id="6244162">(</span><span class="string" id="6244163">&#34;Date&#34;</span><span class="op" id="6244169">)</span>&nbsp;<span class="op" id="6244171">==</span>&nbsp;<span class="string" id="6244174">&#34;&#34;</span>&nbsp;<span class="op" id="6244177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244181">r</span><span class="op" id="6244182">.</span><span class="ident" id="6244183">header</span><span class="op" id="6244189">.</span><span class="ident" id="6244190">Set</span><span class="op" id="6244193">(</span><span class="string" id="6244194">&#34;Date&#34;</span><span class="op" id="6244200">,</span>&nbsp;<span class="ident" id="6244202">time</span><span class="op" id="6244206">.</span><span class="ident" id="6244207">Now</span><span class="op" id="6244210">(</span><span class="op" id="6244211">)</span><span class="op" id="6244212">.</span><span class="ident" id="6244213">UTC</span><span class="op" id="6244216">(</span><span class="op" id="6244217">)</span><span class="op" id="6244218">.</span><span class="ident" id="6244219">Format</span><span class="op" id="6244225">(</span><span class="ident" id="6244226">http</span><span class="op" id="6244230">.</span><span class="ident" id="6244231">TimeFormat</span><span class="op" id="6244241">)</span><span class="op" id="6244242">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6244245">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244249">fmt</span><span class="op" id="6244252">.</span><span class="ident" id="6244253">Fprintf</span><span class="op" id="6244260">(</span><span class="ident" id="6244261">r</span><span class="op" id="6244262">.</span><span class="ident" id="6244263">w</span><span class="op" id="6244264">,</span>&nbsp;<span class="string" id="6244266">&#34;Status:&nbsp;%d&nbsp;%s\r\n&#34;</span><span class="op" id="6244285">,</span>&nbsp;<span class="ident" id="6244287">code</span><span class="op" id="6244291">,</span>&nbsp;<span class="ident" id="6244293">http</span><span class="op" id="6244297">.</span><span class="ident" id="6244298">StatusText</span><span class="op" id="6244308">(</span><span class="ident" id="6244309">code</span><span class="op" id="6244313">)</span><span class="op" id="6244314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244317">r</span><span class="op" id="6244318">.</span><span class="ident" id="6244319">header</span><span class="op" id="6244325">.</span><span class="ident" id="6244326">Write</span><span class="op" id="6244331">(</span><span class="ident" id="6244332">r</span><span class="op" id="6244333">.</span><span class="ident" id="6244334">w</span><span class="op" id="6244335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244338">r</span><span class="op" id="6244339">.</span><span class="ident" id="6244340">w</span><span class="op" id="6244341">.</span><span class="ident" id="6244342">WriteString</span><span class="op" id="6244353">(</span><span class="string" id="6244354">&#34;\r\n&#34;</span><span class="op" id="6244360">)</span><br>
<span class="lineno">115</span><span class="op" id="6244362">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6244365">func</span>&nbsp;<span class="op" id="6244370">(</span><span class="ident" id="6244371">r</span>&nbsp;<span class="op" id="6244373">*</span><span class="ident" id="6244374">response</span><span class="op" id="6244382">)</span>&nbsp;<span class="ident" id="6244384">Flush</span><span class="op" id="6244389">(</span><span class="op" id="6244390">)</span>&nbsp;<span class="op" id="6244392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244395">if</span>&nbsp;<span class="op" id="6244398">!</span><span class="ident" id="6244399">r</span><span class="op" id="6244400">.</span><span class="ident" id="6244401">wroteHeader</span>&nbsp;<span class="op" id="6244413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244417">r</span><span class="op" id="6244418">.</span><span class="ident" id="6244419">WriteHeader</span><span class="op" id="6244430">(</span><span class="ident" id="6244431">http</span><span class="op" id="6244435">.</span><span class="ident" id="6244436">StatusOK</span><span class="op" id="6244444">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6244447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244450">r</span><span class="op" id="6244451">.</span><span class="ident" id="6244452">w</span><span class="op" id="6244453">.</span><span class="ident" id="6244454">Flush</span><span class="op" id="6244459">(</span><span class="op" id="6244460">)</span><br>
<span class="lineno"></span><span class="op" id="6244462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6244465">func</span>&nbsp;<span class="op" id="6244470">(</span><span class="ident" id="6244471">r</span>&nbsp;<span class="op" id="6244473">*</span><span class="ident" id="6244474">response</span><span class="op" id="6244482">)</span>&nbsp;<span class="ident" id="6244484">Close</span><span class="op" id="6244489">(</span><span class="op" id="6244490">)</span>&nbsp;<span class="builtintype" id="6244492">error</span>&nbsp;<span class="op" id="6244498">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244501">r</span><span class="op" id="6244502">.</span><span class="ident" id="6244503">Flush</span><span class="op" id="6244508">(</span><span class="op" id="6244509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244512">return</span>&nbsp;<span class="ident" id="6244519">r</span><span class="op" id="6244520">.</span><span class="ident" id="6244521">w</span><span class="op" id="6244522">.</span><span class="ident" id="6244523">Close</span><span class="op" id="6244528">(</span><span class="op" id="6244529">)</span><br>
<span class="lineno"></span><span class="op" id="6244531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6244534">type</span>&nbsp;<span class="ident" id="6244539">child</span>&nbsp;<span class="keyword" id="6244545">struct</span>&nbsp;<span class="op" id="6244552">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244555">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6244563">*</span><span class="ident" id="6244564">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244570">handler</span>&nbsp;<span class="ident" id="6244578">http</span><span class="op" id="6244582">.</span><span class="ident" id="6244583">Handler</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244593">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244602">sync</span><span class="op" id="6244606">.</span><span class="ident" id="6244607">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6244622">//&nbsp;protects&nbsp;requests:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244645">requests</span>&nbsp;<span class="keyword" id="6244654">map</span><span class="op" id="6244657">[</span><span class="builtintype" id="6244658">uint16</span><span class="op" id="6244664">]</span><span class="op" id="6244665">*</span><span class="ident" id="6244666">request</span>&nbsp;<span class="comment" id="6244674">//&nbsp;keyed&nbsp;by&nbsp;request&nbsp;ID</span><br>
<span class="lineno">135</span><span class="op" id="6244697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6244700">func</span>&nbsp;<span class="ident" id="6244705">newChild</span><span class="op" id="6244713">(</span><span class="ident" id="6244714">rwc</span>&nbsp;<span class="ident" id="6244718">io</span><span class="op" id="6244720">.</span><span class="ident" id="6244721">ReadWriteCloser</span><span class="op" id="6244736">,</span>&nbsp;<span class="ident" id="6244738">handler</span>&nbsp;<span class="ident" id="6244746">http</span><span class="op" id="6244750">.</span><span class="ident" id="6244751">Handler</span><span class="op" id="6244758">)</span>&nbsp;<span class="op" id="6244760">*</span><span class="ident" id="6244761">child</span>&nbsp;<span class="op" id="6244767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244770">return</span>&nbsp;<span class="op" id="6244777">&amp;</span><span class="ident" id="6244778">child</span><span class="op" id="6244783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244787">conn</span><span class="op" id="6244791">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6244797">newConn</span><span class="op" id="6244804">(</span><span class="ident" id="6244805">rwc</span><span class="op" id="6244808">)</span><span class="op" id="6244809">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244813">handler</span><span class="op" id="6244820">:</span>&nbsp;&nbsp;<span class="ident" id="6244823">handler</span><span class="op" id="6244830">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6244834">requests</span><span class="op" id="6244842">:</span>&nbsp;<span class="builtinfunc" id="6244844">make</span><span class="op" id="6244848">(</span><span class="keyword" id="6244849">map</span><span class="op" id="6244852">[</span><span class="builtintype" id="6244853">uint16</span><span class="op" id="6244859">]</span><span class="op" id="6244860">*</span><span class="ident" id="6244861">request</span><span class="op" id="6244868">)</span><span class="op" id="6244869">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6244872">}</span><br>
<span class="lineno"></span><span class="op" id="6244874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="6244877">func</span>&nbsp;<span class="op" id="6244882">(</span><span class="ident" id="6244883">c</span>&nbsp;<span class="op" id="6244885">*</span><span class="ident" id="6244886">child</span><span class="op" id="6244891">)</span>&nbsp;<span class="ident" id="6244893">serve</span><span class="op" id="6244898">(</span><span class="op" id="6244899">)</span>&nbsp;<span class="op" id="6244901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244904">defer</span>&nbsp;<span class="ident" id="6244910">c</span><span class="op" id="6244911">.</span><span class="ident" id="6244912">conn</span><span class="op" id="6244916">.</span><span class="ident" id="6244917">Close</span><span class="op" id="6244922">(</span><span class="op" id="6244923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244926">var</span>&nbsp;<span class="ident" id="6244930">rec</span>&nbsp;<span class="ident" id="6244934">record</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244942">for</span>&nbsp;<span class="op" id="6244946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244950">if</span>&nbsp;<span class="ident" id="6244953">err</span>&nbsp;<span class="op" id="6244957">:=</span>&nbsp;<span class="ident" id="6244960">rec</span><span class="op" id="6244963">.</span><span class="ident" id="6244964">read</span><span class="op" id="6244968">(</span><span class="ident" id="6244969">c</span><span class="op" id="6244970">.</span><span class="ident" id="6244971">conn</span><span class="op" id="6244975">.</span><span class="ident" id="6244976">rwc</span><span class="op" id="6244979">)</span><span class="op" id="6244980">;</span>&nbsp;<span class="ident" id="6244982">err</span>&nbsp;<span class="op" id="6244986">!=</span>&nbsp;<span class="ident" id="6244989">nil</span>&nbsp;<span class="op" id="6244993">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6244998">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245011">if</span>&nbsp;<span class="ident" id="6245014">err</span>&nbsp;<span class="op" id="6245018">:=</span>&nbsp;<span class="ident" id="6245021">c</span><span class="op" id="6245022">.</span><span class="ident" id="6245023">handleRecord</span><span class="op" id="6245035">(</span><span class="op" id="6245036">&amp;</span><span class="ident" id="6245037">rec</span><span class="op" id="6245040">)</span><span class="op" id="6245041">;</span>&nbsp;<span class="ident" id="6245043">err</span>&nbsp;<span class="op" id="6245047">!=</span>&nbsp;<span class="ident" id="6245050">nil</span>&nbsp;<span class="op" id="6245054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245059">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245068">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245071">}</span><br>
<span class="lineno"></span><span class="op" id="6245073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6245076">var</span>&nbsp;<span class="ident" id="6245080">errCloseConn</span>&nbsp;<span class="op" id="6245093">=</span>&nbsp;<span class="ident" id="6245095">errors</span><span class="op" id="6245101">.</span><span class="ident" id="6245102">New</span><span class="op" id="6245105">(</span><span class="string" id="6245106">&#34;fcgi:&nbsp;connection&nbsp;should&nbsp;be&nbsp;closed&#34;</span><span class="op" id="6245141">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="keyword" id="6245144">var</span>&nbsp;<span class="ident" id="6245148">emptyBody</span>&nbsp;<span class="op" id="6245158">=</span>&nbsp;<span class="ident" id="6245160">ioutil</span><span class="op" id="6245166">.</span><span class="ident" id="6245167">NopCloser</span><span class="op" id="6245176">(</span><span class="ident" id="6245177">strings</span><span class="op" id="6245184">.</span><span class="ident" id="6245185">NewReader</span><span class="op" id="6245194">(</span><span class="string" id="6245195">&#34;&#34;</span><span class="op" id="6245197">)</span><span class="op" id="6245198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6245201">func</span>&nbsp;<span class="op" id="6245206">(</span><span class="ident" id="6245207">c</span>&nbsp;<span class="op" id="6245209">*</span><span class="ident" id="6245210">child</span><span class="op" id="6245215">)</span>&nbsp;<span class="ident" id="6245217">handleRecord</span><span class="op" id="6245229">(</span><span class="ident" id="6245230">rec</span>&nbsp;<span class="op" id="6245234">*</span><span class="ident" id="6245235">record</span><span class="op" id="6245241">)</span>&nbsp;<span class="builtintype" id="6245243">error</span>&nbsp;<span class="op" id="6245249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245252">c</span><span class="op" id="6245253">.</span><span class="ident" id="6245254">mu</span><span class="op" id="6245256">.</span><span class="ident" id="6245257">Lock</span><span class="op" id="6245261">(</span><span class="op" id="6245262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245265">req</span><span class="op" id="6245268">,</span>&nbsp;<span class="ident" id="6245270">ok</span>&nbsp;<span class="op" id="6245273">:=</span>&nbsp;<span class="ident" id="6245276">c</span><span class="op" id="6245277">.</span><span class="ident" id="6245278">requests</span><span class="op" id="6245286">[</span><span class="ident" id="6245287">rec</span><span class="op" id="6245290">.</span><span class="ident" id="6245291">h</span><span class="op" id="6245292">.</span><span class="ident" id="6245293">Id</span><span class="op" id="6245295">]</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245298">c</span><span class="op" id="6245299">.</span><span class="ident" id="6245300">mu</span><span class="op" id="6245302">.</span><span class="ident" id="6245303">Unlock</span><span class="op" id="6245309">(</span><span class="op" id="6245310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245313">if</span>&nbsp;<span class="op" id="6245316">!</span><span class="ident" id="6245317">ok</span>&nbsp;<span class="op" id="6245320">&amp;&amp;</span>&nbsp;<span class="ident" id="6245323">rec</span><span class="op" id="6245326">.</span><span class="ident" id="6245327">h</span><span class="op" id="6245328">.</span><span class="ident" id="6245329">Type</span>&nbsp;<span class="op" id="6245334">!=</span>&nbsp;<span class="ident" id="6245337">typeBeginRequest</span>&nbsp;<span class="op" id="6245354">&amp;&amp;</span>&nbsp;<span class="ident" id="6245357">rec</span><span class="op" id="6245360">.</span><span class="ident" id="6245361">h</span><span class="op" id="6245362">.</span><span class="ident" id="6245363">Type</span>&nbsp;<span class="op" id="6245368">!=</span>&nbsp;<span class="ident" id="6245371">typeGetValues</span>&nbsp;<span class="op" id="6245385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6245389">//&nbsp;The&nbsp;spec&nbsp;says&nbsp;to&nbsp;ignore&nbsp;unknown&nbsp;request&nbsp;IDs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245439">return</span>&nbsp;<span class="ident" id="6245446">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245451">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245455">switch</span>&nbsp;<span class="ident" id="6245462">rec</span><span class="op" id="6245465">.</span><span class="ident" id="6245466">h</span><span class="op" id="6245467">.</span><span class="ident" id="6245468">Type</span>&nbsp;<span class="op" id="6245473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245476">case</span>&nbsp;<span class="ident" id="6245481">typeBeginRequest</span><span class="op" id="6245497">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245501">if</span>&nbsp;<span class="ident" id="6245504">req</span>&nbsp;<span class="op" id="6245508">!=</span>&nbsp;<span class="ident" id="6245511">nil</span>&nbsp;<span class="op" id="6245515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6245520">//&nbsp;The&nbsp;server&nbsp;is&nbsp;trying&nbsp;to&nbsp;begin&nbsp;a&nbsp;request&nbsp;with&nbsp;the&nbsp;same&nbsp;ID</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6245583">//&nbsp;as&nbsp;an&nbsp;in-progress&nbsp;request.&nbsp;This&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245634">return</span>&nbsp;<span class="ident" id="6245641">errors</span><span class="op" id="6245647">.</span><span class="ident" id="6245648">New</span><span class="op" id="6245651">(</span><span class="string" id="6245652">&#34;fcgi:&nbsp;received&nbsp;ID&nbsp;that&nbsp;is&nbsp;already&nbsp;in-flight&#34;</span><span class="op" id="6245697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245706">var</span>&nbsp;<span class="ident" id="6245710">br</span>&nbsp;<span class="ident" id="6245713">beginRequest</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245728">if</span>&nbsp;<span class="ident" id="6245731">err</span>&nbsp;<span class="op" id="6245735">:=</span>&nbsp;<span class="ident" id="6245738">br</span><span class="op" id="6245740">.</span><span class="ident" id="6245741">read</span><span class="op" id="6245745">(</span><span class="ident" id="6245746">rec</span><span class="op" id="6245749">.</span><span class="ident" id="6245750">content</span><span class="op" id="6245757">(</span><span class="op" id="6245758">)</span><span class="op" id="6245759">)</span><span class="op" id="6245760">;</span>&nbsp;<span class="ident" id="6245762">err</span>&nbsp;<span class="op" id="6245766">!=</span>&nbsp;<span class="ident" id="6245769">nil</span>&nbsp;<span class="op" id="6245773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245778">return</span>&nbsp;<span class="ident" id="6245785">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245795">if</span>&nbsp;<span class="ident" id="6245798">br</span><span class="op" id="6245800">.</span><span class="ident" id="6245801">role</span>&nbsp;<span class="op" id="6245806">!=</span>&nbsp;<span class="ident" id="6245809">roleResponder</span>&nbsp;<span class="op" id="6245823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245828">c</span><span class="op" id="6245829">.</span><span class="ident" id="6245830">conn</span><span class="op" id="6245834">.</span><span class="ident" id="6245835">writeEndRequest</span><span class="op" id="6245850">(</span><span class="ident" id="6245851">rec</span><span class="op" id="6245854">.</span><span class="ident" id="6245855">h</span><span class="op" id="6245856">.</span><span class="ident" id="6245857">Id</span><span class="op" id="6245859">,</span>&nbsp;<span class="num" id="6245861">0</span><span class="op" id="6245862">,</span>&nbsp;<span class="ident" id="6245864">statusUnknownRole</span><span class="op" id="6245881">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6245886">return</span>&nbsp;<span class="ident" id="6245893">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6245899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245903">req</span>&nbsp;<span class="op" id="6245907">=</span>&nbsp;<span class="ident" id="6245909">newRequest</span><span class="op" id="6245919">(</span><span class="ident" id="6245920">rec</span><span class="op" id="6245923">.</span><span class="ident" id="6245924">h</span><span class="op" id="6245925">.</span><span class="ident" id="6245926">Id</span><span class="op" id="6245928">,</span>&nbsp;<span class="ident" id="6245930">br</span><span class="op" id="6245932">.</span><span class="ident" id="6245933">flags</span><span class="op" id="6245938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245942">c</span><span class="op" id="6245943">.</span><span class="ident" id="6245944">mu</span><span class="op" id="6245946">.</span><span class="ident" id="6245947">Lock</span><span class="op" id="6245951">(</span><span class="op" id="6245952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245956">c</span><span class="op" id="6245957">.</span><span class="ident" id="6245958">requests</span><span class="op" id="6245966">[</span><span class="ident" id="6245967">rec</span><span class="op" id="6245970">.</span><span class="ident" id="6245971">h</span><span class="op" id="6245972">.</span><span class="ident" id="6245973">Id</span><span class="op" id="6245975">]</span>&nbsp;<span class="op" id="6245977">=</span>&nbsp;<span class="ident" id="6245979">req</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6245985">c</span><span class="op" id="6245986">.</span><span class="ident" id="6245987">mu</span><span class="op" id="6245989">.</span><span class="ident" id="6245990">Unlock</span><span class="op" id="6245996">(</span><span class="op" id="6245997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246001">return</span>&nbsp;<span class="ident" id="6246008">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246013">case</span>&nbsp;<span class="ident" id="6246018">typeParams</span><span class="op" id="6246028">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246032">//&nbsp;NOTE(eds):&nbsp;Technically&nbsp;a&nbsp;key-value&nbsp;pair&nbsp;can&nbsp;straddle&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246103">//&nbsp;between&nbsp;two&nbsp;packets.&nbsp;We&nbsp;buffer&nbsp;until&nbsp;we&#39;ve&nbsp;received&nbsp;all&nbsp;parameters.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246176">if</span>&nbsp;<span class="builtinfunc" id="6246179">len</span><span class="op" id="6246182">(</span><span class="ident" id="6246183">rec</span><span class="op" id="6246186">.</span><span class="ident" id="6246187">content</span><span class="op" id="6246194">(</span><span class="op" id="6246195">)</span><span class="op" id="6246196">)</span>&nbsp;<span class="op" id="6246198">&gt;</span>&nbsp;<span class="num" id="6246200">0</span>&nbsp;<span class="op" id="6246202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246207">req</span><span class="op" id="6246210">.</span><span class="ident" id="6246211">rawParams</span>&nbsp;<span class="op" id="6246221">=</span>&nbsp;<span class="builtinfunc" id="6246223">append</span><span class="op" id="6246229">(</span><span class="ident" id="6246230">req</span><span class="op" id="6246233">.</span><span class="ident" id="6246234">rawParams</span><span class="op" id="6246243">,</span>&nbsp;<span class="ident" id="6246245">rec</span><span class="op" id="6246248">.</span><span class="ident" id="6246249">content</span><span class="op" id="6246256">(</span><span class="op" id="6246257">)</span><span class="op" id="6246258">...</span><span class="op" id="6246261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246266">return</span>&nbsp;<span class="ident" id="6246273">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246283">req</span><span class="op" id="6246286">.</span><span class="ident" id="6246287">parseParams</span><span class="op" id="6246298">(</span><span class="op" id="6246299">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246303">return</span>&nbsp;<span class="ident" id="6246310">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246315">case</span>&nbsp;<span class="ident" id="6246320">typeStdin</span><span class="op" id="6246329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246333">content</span>&nbsp;<span class="op" id="6246341">:=</span>&nbsp;<span class="ident" id="6246344">rec</span><span class="op" id="6246347">.</span><span class="ident" id="6246348">content</span><span class="op" id="6246355">(</span><span class="op" id="6246356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246360">if</span>&nbsp;<span class="ident" id="6246363">req</span><span class="op" id="6246366">.</span><span class="ident" id="6246367">pw</span>&nbsp;<span class="op" id="6246370">==</span>&nbsp;<span class="ident" id="6246373">nil</span>&nbsp;<span class="op" id="6246377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246382">var</span>&nbsp;<span class="ident" id="6246386">body</span>&nbsp;<span class="ident" id="6246391">io</span><span class="op" id="6246393">.</span><span class="ident" id="6246394">ReadCloser</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246408">if</span>&nbsp;<span class="builtinfunc" id="6246411">len</span><span class="op" id="6246414">(</span><span class="ident" id="6246415">content</span><span class="op" id="6246422">)</span>&nbsp;<span class="op" id="6246424">&gt;</span>&nbsp;<span class="num" id="6246426">0</span>&nbsp;<span class="op" id="6246428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246434">//&nbsp;body&nbsp;could&nbsp;be&nbsp;an&nbsp;io.LimitReader,&nbsp;but&nbsp;it&nbsp;shouldn&#39;t&nbsp;matter</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246498">//&nbsp;as&nbsp;long&nbsp;as&nbsp;both&nbsp;sides&nbsp;are&nbsp;behaving.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246541">body</span><span class="op" id="6246545">,</span>&nbsp;<span class="ident" id="6246547">req</span><span class="op" id="6246550">.</span><span class="ident" id="6246551">pw</span>&nbsp;<span class="op" id="6246554">=</span>&nbsp;<span class="ident" id="6246556">io</span><span class="op" id="6246558">.</span><span class="ident" id="6246559">Pipe</span><span class="op" id="6246563">(</span><span class="op" id="6246564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246569">}</span>&nbsp;<span class="keyword" id="6246571">else</span>&nbsp;<span class="op" id="6246576">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246582">body</span>&nbsp;<span class="op" id="6246587">=</span>&nbsp;<span class="ident" id="6246589">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246607">go</span>&nbsp;<span class="ident" id="6246610">c</span><span class="op" id="6246611">.</span><span class="ident" id="6246612">serveRequest</span><span class="op" id="6246624">(</span><span class="ident" id="6246625">req</span><span class="op" id="6246628">,</span>&nbsp;<span class="ident" id="6246630">body</span><span class="op" id="6246634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246638">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246642">if</span>&nbsp;<span class="builtinfunc" id="6246645">len</span><span class="op" id="6246648">(</span><span class="ident" id="6246649">content</span><span class="op" id="6246656">)</span>&nbsp;<span class="op" id="6246658">&gt;</span>&nbsp;<span class="num" id="6246660">0</span>&nbsp;<span class="op" id="6246662">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246667">//&nbsp;TODO(eds):&nbsp;This&nbsp;blocks&nbsp;until&nbsp;the&nbsp;handler&nbsp;reads&nbsp;from&nbsp;the&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6246735">//&nbsp;If&nbsp;the&nbsp;handler&nbsp;takes&nbsp;a&nbsp;long&nbsp;time,&nbsp;it&nbsp;might&nbsp;be&nbsp;a&nbsp;problem.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246798">req</span><span class="op" id="6246801">.</span><span class="ident" id="6246802">pw</span><span class="op" id="6246804">.</span><span class="ident" id="6246805">Write</span><span class="op" id="6246810">(</span><span class="ident" id="6246811">content</span><span class="op" id="6246818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246822">}</span>&nbsp;<span class="keyword" id="6246824">else</span>&nbsp;<span class="keyword" id="6246829">if</span>&nbsp;<span class="ident" id="6246832">req</span><span class="op" id="6246835">.</span><span class="ident" id="6246836">pw</span>&nbsp;<span class="op" id="6246839">!=</span>&nbsp;<span class="ident" id="6246842">nil</span>&nbsp;<span class="op" id="6246846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246851">req</span><span class="op" id="6246854">.</span><span class="ident" id="6246855">pw</span><span class="op" id="6246857">.</span><span class="ident" id="6246858">Close</span><span class="op" id="6246863">(</span><span class="op" id="6246864">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6246868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246872">return</span>&nbsp;<span class="ident" id="6246879">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6246884">case</span>&nbsp;<span class="ident" id="6246889">typeGetValues</span><span class="op" id="6246902">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246906">values</span>&nbsp;<span class="op" id="6246913">:=</span>&nbsp;<span class="keyword" id="6246916">map</span><span class="op" id="6246919">[</span><span class="builtintype" id="6246920">string</span><span class="op" id="6246926">]</span><span class="builtintype" id="6246927">string</span><span class="op" id="6246933">{</span><span class="string" id="6246934">&#34;FCGI_MPXS_CONNS&#34;</span><span class="op" id="6246951">:</span>&nbsp;<span class="string" id="6246953">&#34;1&#34;</span><span class="op" id="6246956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6246960">c</span><span class="op" id="6246961">.</span><span class="ident" id="6246962">conn</span><span class="op" id="6246966">.</span><span class="ident" id="6246967">writePairs</span><span class="op" id="6246977">(</span><span class="ident" id="6246978">typeGetValuesResult</span><span class="op" id="6246997">,</span>&nbsp;<span class="num" id="6246999">0</span><span class="op" id="6247000">,</span>&nbsp;<span class="ident" id="6247002">values</span><span class="op" id="6247008">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247012">return</span>&nbsp;<span class="ident" id="6247019">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247024">case</span>&nbsp;<span class="ident" id="6247029">typeData</span><span class="op" id="6247037">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6247041">//&nbsp;If&nbsp;the&nbsp;filter&nbsp;role&nbsp;is&nbsp;implemented,&nbsp;read&nbsp;the&nbsp;data&nbsp;stream&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247108">return</span>&nbsp;<span class="ident" id="6247115">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247120">case</span>&nbsp;<span class="ident" id="6247125">typeAbortRequest</span><span class="op" id="6247141">:</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6247145">println</span><span class="op" id="6247152">(</span><span class="string" id="6247153">&#34;abort&#34;</span><span class="op" id="6247160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247164">c</span><span class="op" id="6247165">.</span><span class="ident" id="6247166">mu</span><span class="op" id="6247168">.</span><span class="ident" id="6247169">Lock</span><span class="op" id="6247173">(</span><span class="op" id="6247174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6247178">delete</span><span class="op" id="6247184">(</span><span class="ident" id="6247185">c</span><span class="op" id="6247186">.</span><span class="ident" id="6247187">requests</span><span class="op" id="6247195">,</span>&nbsp;<span class="ident" id="6247197">rec</span><span class="op" id="6247200">.</span><span class="ident" id="6247201">h</span><span class="op" id="6247202">.</span><span class="ident" id="6247203">Id</span><span class="op" id="6247205">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247209">c</span><span class="op" id="6247210">.</span><span class="ident" id="6247211">mu</span><span class="op" id="6247213">.</span><span class="ident" id="6247214">Unlock</span><span class="op" id="6247220">(</span><span class="op" id="6247221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247225">c</span><span class="op" id="6247226">.</span><span class="ident" id="6247227">conn</span><span class="op" id="6247231">.</span><span class="ident" id="6247232">writeEndRequest</span><span class="op" id="6247247">(</span><span class="ident" id="6247248">rec</span><span class="op" id="6247251">.</span><span class="ident" id="6247252">h</span><span class="op" id="6247253">.</span><span class="ident" id="6247254">Id</span><span class="op" id="6247256">,</span>&nbsp;<span class="num" id="6247258">0</span><span class="op" id="6247259">,</span>&nbsp;<span class="ident" id="6247261">statusRequestComplete</span><span class="op" id="6247282">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247286">if</span>&nbsp;<span class="op" id="6247289">!</span><span class="ident" id="6247290">req</span><span class="op" id="6247293">.</span><span class="ident" id="6247294">keepConn</span>&nbsp;<span class="op" id="6247303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6247308">//&nbsp;connection&nbsp;will&nbsp;close&nbsp;upon&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247348">return</span>&nbsp;<span class="ident" id="6247355">errCloseConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6247370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247374">return</span>&nbsp;<span class="ident" id="6247381">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247386">default</span><span class="op" id="6247393">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247397">b</span>&nbsp;<span class="op" id="6247399">:=</span>&nbsp;<span class="builtinfunc" id="6247402">make</span><span class="op" id="6247406">(</span><span class="op" id="6247407">[</span><span class="op" id="6247408">]</span><span class="builtintype" id="6247409">byte</span><span class="op" id="6247413">,</span>&nbsp;<span class="num" id="6247415">8</span><span class="op" id="6247416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247420">b</span><span class="op" id="6247421">[</span><span class="num" id="6247422">0</span><span class="op" id="6247423">]</span>&nbsp;<span class="op" id="6247425">=</span>&nbsp;<span class="builtintype" id="6247427">byte</span><span class="op" id="6247431">(</span><span class="ident" id="6247432">rec</span><span class="op" id="6247435">.</span><span class="ident" id="6247436">h</span><span class="op" id="6247437">.</span><span class="ident" id="6247438">Type</span><span class="op" id="6247442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247446">c</span><span class="op" id="6247447">.</span><span class="ident" id="6247448">conn</span><span class="op" id="6247452">.</span><span class="ident" id="6247453">writeRecord</span><span class="op" id="6247464">(</span><span class="ident" id="6247465">typeUnknownType</span><span class="op" id="6247480">,</span>&nbsp;<span class="num" id="6247482">0</span><span class="op" id="6247483">,</span>&nbsp;<span class="ident" id="6247485">b</span><span class="op" id="6247486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247490">return</span>&nbsp;<span class="ident" id="6247497">nil</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6247502">}</span><br>
<span class="lineno"></span><span class="op" id="6247504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6247507">func</span>&nbsp;<span class="op" id="6247512">(</span><span class="ident" id="6247513">c</span>&nbsp;<span class="op" id="6247515">*</span><span class="ident" id="6247516">child</span><span class="op" id="6247521">)</span>&nbsp;<span class="ident" id="6247523">serveRequest</span><span class="op" id="6247535">(</span><span class="ident" id="6247536">req</span>&nbsp;<span class="op" id="6247540">*</span><span class="ident" id="6247541">request</span><span class="op" id="6247548">,</span>&nbsp;<span class="ident" id="6247550">body</span>&nbsp;<span class="ident" id="6247555">io</span><span class="op" id="6247557">.</span><span class="ident" id="6247558">ReadCloser</span><span class="op" id="6247568">)</span>&nbsp;<span class="op" id="6247570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247573">r</span>&nbsp;<span class="op" id="6247575">:=</span>&nbsp;<span class="ident" id="6247578">newResponse</span><span class="op" id="6247589">(</span><span class="ident" id="6247590">c</span><span class="op" id="6247591">,</span>&nbsp;<span class="ident" id="6247593">req</span><span class="op" id="6247596">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247599">httpReq</span><span class="op" id="6247606">,</span>&nbsp;<span class="ident" id="6247608">err</span>&nbsp;<span class="op" id="6247612">:=</span>&nbsp;<span class="ident" id="6247615">cgi</span><span class="op" id="6247618">.</span><span class="ident" id="6247619">RequestFromMap</span><span class="op" id="6247633">(</span><span class="ident" id="6247634">req</span><span class="op" id="6247637">.</span><span class="ident" id="6247638">params</span><span class="op" id="6247644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6247647">if</span>&nbsp;<span class="ident" id="6247650">err</span>&nbsp;<span class="op" id="6247654">!=</span>&nbsp;<span class="ident" id="6247657">nil</span>&nbsp;<span class="op" id="6247661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6247665">//&nbsp;there&nbsp;was&nbsp;an&nbsp;error&nbsp;reading&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247709">r</span><span class="op" id="6247710">.</span><span class="ident" id="6247711">WriteHeader</span><span class="op" id="6247722">(</span><span class="ident" id="6247723">http</span><span class="op" id="6247727">.</span><span class="ident" id="6247728">StatusInternalServerError</span><span class="op" id="6247753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247757">c</span><span class="op" id="6247758">.</span><span class="ident" id="6247759">conn</span><span class="op" id="6247763">.</span><span class="ident" id="6247764">writeRecord</span><span class="op" id="6247775">(</span><span class="ident" id="6247776">typeStderr</span><span class="op" id="6247786">,</span>&nbsp;<span class="ident" id="6247788">req</span><span class="op" id="6247791">.</span><span class="ident" id="6247792">reqId</span><span class="op" id="6247797">,</span>&nbsp;<span class="op" id="6247799">[</span><span class="op" id="6247800">]</span><span class="builtintype" id="6247801">byte</span><span class="op" id="6247805">(</span><span class="ident" id="6247806">err</span><span class="op" id="6247809">.</span><span class="ident" id="6247810">Error</span><span class="op" id="6247815">(</span><span class="op" id="6247816">)</span><span class="op" id="6247817">)</span><span class="op" id="6247818">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6247821">}</span>&nbsp;<span class="keyword" id="6247823">else</span>&nbsp;<span class="op" id="6247828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247832">httpReq</span><span class="op" id="6247839">.</span><span class="ident" id="6247840">Body</span>&nbsp;<span class="op" id="6247845">=</span>&nbsp;<span class="ident" id="6247847">body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247854">c</span><span class="op" id="6247855">.</span><span class="ident" id="6247856">handler</span><span class="op" id="6247863">.</span><span class="ident" id="6247864">ServeHTTP</span><span class="op" id="6247873">(</span><span class="ident" id="6247874">r</span><span class="op" id="6247875">,</span>&nbsp;<span class="ident" id="6247877">httpReq</span><span class="op" id="6247884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6247887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247890">r</span><span class="op" id="6247891">.</span><span class="ident" id="6247892">Close</span><span class="op" id="6247897">(</span><span class="op" id="6247898">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247901">c</span><span class="op" id="6247902">.</span><span class="ident" id="6247903">mu</span><span class="op" id="6247905">.</span><span class="ident" id="6247906">Lock</span><span class="op" id="6247910">(</span><span class="op" id="6247911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6247914">delete</span><span class="op" id="6247920">(</span><span class="ident" id="6247921">c</span><span class="op" id="6247922">.</span><span class="ident" id="6247923">requests</span><span class="op" id="6247931">,</span>&nbsp;<span class="ident" id="6247933">req</span><span class="op" id="6247936">.</span><span class="ident" id="6247937">reqId</span><span class="op" id="6247942">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247945">c</span><span class="op" id="6247946">.</span><span class="ident" id="6247947">mu</span><span class="op" id="6247949">.</span><span class="ident" id="6247950">Unlock</span><span class="op" id="6247956">(</span><span class="op" id="6247957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6247960">c</span><span class="op" id="6247961">.</span><span class="ident" id="6247962">conn</span><span class="op" id="6247966">.</span><span class="ident" id="6247967">writeEndRequest</span><span class="op" id="6247982">(</span><span class="ident" id="6247983">req</span><span class="op" id="6247986">.</span><span class="ident" id="6247987">reqId</span><span class="op" id="6247992">,</span>&nbsp;<span class="num" id="6247994">0</span><span class="op" id="6247995">,</span>&nbsp;<span class="ident" id="6247997">statusRequestComplete</span><span class="op" id="6248018">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248022">//&nbsp;Consume&nbsp;the&nbsp;entire&nbsp;body,&nbsp;so&nbsp;the&nbsp;host&nbsp;isn&#39;t&nbsp;still&nbsp;writing&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248086">//&nbsp;us&nbsp;when&nbsp;we&nbsp;close&nbsp;the&nbsp;socket&nbsp;below&nbsp;in&nbsp;the&nbsp;!keepConn&nbsp;case,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248147">//&nbsp;otherwise&nbsp;we&#39;d&nbsp;send&nbsp;a&nbsp;RST.&nbsp;(golang.org/issue/4183)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248202">//&nbsp;TODO(bradfitz):&nbsp;also&nbsp;bound&nbsp;this&nbsp;copy&nbsp;in&nbsp;time.&nbsp;Or&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248260">//&nbsp;some&nbsp;sort&nbsp;of&nbsp;abort&nbsp;request&nbsp;to&nbsp;the&nbsp;host,&nbsp;so&nbsp;the&nbsp;host</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248316">//&nbsp;can&nbsp;properly&nbsp;cut&nbsp;off&nbsp;the&nbsp;client&nbsp;sending&nbsp;all&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6248374">//&nbsp;For&nbsp;now&nbsp;just&nbsp;bound&nbsp;it&nbsp;a&nbsp;little&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6248413">io</span><span class="op" id="6248415">.</span><span class="ident" id="6248416">CopyN</span><span class="op" id="6248421">(</span><span class="ident" id="6248422">ioutil</span><span class="op" id="6248428">.</span><span class="ident" id="6248429">Discard</span><span class="op" id="6248436">,</span>&nbsp;<span class="ident" id="6248438">body</span><span class="op" id="6248442">,</span>&nbsp;<span class="num" id="6248444">100</span><span class="op" id="6248447">&lt;&lt;</span><span class="num" id="6248449">20</span><span class="op" id="6248451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6248454">body</span><span class="op" id="6248458">.</span><span class="ident" id="6248459">Close</span><span class="op" id="6248464">(</span><span class="op" id="6248465">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248469">if</span>&nbsp;<span class="op" id="6248472">!</span><span class="ident" id="6248473">req</span><span class="op" id="6248476">.</span><span class="ident" id="6248477">keepConn</span>&nbsp;<span class="op" id="6248486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6248490">c</span><span class="op" id="6248491">.</span><span class="ident" id="6248492">conn</span><span class="op" id="6248496">.</span><span class="ident" id="6248497">Close</span><span class="op" id="6248502">(</span><span class="op" id="6248503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6248506">}</span><br>
<span class="lineno"></span><span class="op" id="6248508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span><span class="comment" id="6248511">//&nbsp;Serve&nbsp;accepts&nbsp;incoming&nbsp;FastCGI&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;l,&nbsp;creating&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="6248591">//&nbsp;goroutine&nbsp;for&nbsp;each.&nbsp;The&nbsp;goroutine&nbsp;reads&nbsp;requests&nbsp;and&nbsp;then&nbsp;calls&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="6248666">//&nbsp;to&nbsp;reply&nbsp;to&nbsp;them.</span><br>
<span class="lineno"></span><span class="comment" id="6248687">//&nbsp;If&nbsp;l&nbsp;is&nbsp;nil,&nbsp;Serve&nbsp;accepts&nbsp;connections&nbsp;from&nbsp;os.Stdin.</span><br>
<span class="lineno"></span><span class="comment" id="6248744">//&nbsp;If&nbsp;handler&nbsp;is&nbsp;nil,&nbsp;http.DefaultServeMux&nbsp;is&nbsp;used.</span><br>
<span class="lineno">285</span><span class="keyword" id="6248796">func</span>&nbsp;<span class="ident" id="6248801">Serve</span><span class="op" id="6248806">(</span><span class="ident" id="6248807">l</span>&nbsp;<span class="ident" id="6248809">net</span><span class="op" id="6248812">.</span><span class="ident" id="6248813">Listener</span><span class="op" id="6248821">,</span>&nbsp;<span class="ident" id="6248823">handler</span>&nbsp;<span class="ident" id="6248831">http</span><span class="op" id="6248835">.</span><span class="ident" id="6248836">Handler</span><span class="op" id="6248843">)</span>&nbsp;<span class="builtintype" id="6248845">error</span>&nbsp;<span class="op" id="6248851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248854">if</span>&nbsp;<span class="ident" id="6248857">l</span>&nbsp;<span class="op" id="6248859">==</span>&nbsp;<span class="ident" id="6248862">nil</span>&nbsp;<span class="op" id="6248866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248870">var</span>&nbsp;<span class="ident" id="6248874">err</span>&nbsp;<span class="builtintype" id="6248878">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6248886">l</span><span class="op" id="6248887">,</span>&nbsp;<span class="ident" id="6248889">err</span>&nbsp;<span class="op" id="6248893">=</span>&nbsp;<span class="ident" id="6248895">net</span><span class="op" id="6248898">.</span><span class="ident" id="6248899">FileListener</span><span class="op" id="6248911">(</span><span class="ident" id="6248912">os</span><span class="op" id="6248914">.</span><span class="ident" id="6248915">Stdin</span><span class="op" id="6248920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248924">if</span>&nbsp;<span class="ident" id="6248927">err</span>&nbsp;<span class="op" id="6248931">!=</span>&nbsp;<span class="ident" id="6248934">nil</span>&nbsp;<span class="op" id="6248938">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248943">return</span>&nbsp;<span class="ident" id="6248950">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6248956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248960">defer</span>&nbsp;<span class="ident" id="6248966">l</span><span class="op" id="6248967">.</span><span class="ident" id="6248968">Close</span><span class="op" id="6248973">(</span><span class="op" id="6248974">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6248977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6248980">if</span>&nbsp;<span class="ident" id="6248983">handler</span>&nbsp;<span class="op" id="6248991">==</span>&nbsp;<span class="ident" id="6248994">nil</span>&nbsp;<span class="op" id="6248998">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249002">handler</span>&nbsp;<span class="op" id="6249010">=</span>&nbsp;<span class="ident" id="6249012">http</span><span class="op" id="6249016">.</span><span class="ident" id="6249017">DefaultServeMux</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6249034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6249037">for</span>&nbsp;<span class="op" id="6249041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249045">rw</span><span class="op" id="6249047">,</span>&nbsp;<span class="ident" id="6249049">err</span>&nbsp;<span class="op" id="6249053">:=</span>&nbsp;<span class="ident" id="6249056">l</span><span class="op" id="6249057">.</span><span class="ident" id="6249058">Accept</span><span class="op" id="6249064">(</span><span class="op" id="6249065">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6249069">if</span>&nbsp;<span class="ident" id="6249072">err</span>&nbsp;<span class="op" id="6249076">!=</span>&nbsp;<span class="ident" id="6249079">nil</span>&nbsp;<span class="op" id="6249083">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6249088">return</span>&nbsp;<span class="ident" id="6249095">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6249101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6249105">c</span>&nbsp;<span class="op" id="6249107">:=</span>&nbsp;<span class="ident" id="6249110">newChild</span><span class="op" id="6249118">(</span><span class="ident" id="6249119">rw</span><span class="op" id="6249121">,</span>&nbsp;<span class="ident" id="6249123">handler</span><span class="op" id="6249130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6249134">go</span>&nbsp;<span class="ident" id="6249137">c</span><span class="op" id="6249138">.</span><span class="ident" id="6249139">serve</span><span class="op" id="6249144">(</span><span class="op" id="6249145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6249148">}</span><br>
<span class="lineno">305</span><span class="op" id="6249150">}</span>
</div>
</body>
</html>
