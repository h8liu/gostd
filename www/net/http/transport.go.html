<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3662272">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3662327">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3662381">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3662432">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3662477">//</span><br>
<span class="lineno"></span><span class="comment" id="3662480">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3662547">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3662593">package</span>&nbsp;<span class="ident" id="3662601">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3662607">import</span>&nbsp;<span class="op" id="3662614">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662617">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662626">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662643">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662657">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662667">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662674">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662680">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662687">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662694">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662705">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662711">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662722">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3662730">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3662737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3662740">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3662810">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3662881">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3662952">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3663020">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3663057">var</span>&nbsp;<span class="ident" id="3663061">DefaultTransport</span>&nbsp;<span class="ident" id="3663078">RoundTripper</span>&nbsp;<span class="op" id="3663091">=</span>&nbsp;<span class="op" id="3663093">&amp;</span><span class="ident" id="3663094">Transport</span><span class="op" id="3663103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663106">Proxy</span><span class="op" id="3663111">:</span>&nbsp;<span class="ident" id="3663113">ProxyFromEnvironment</span><span class="op" id="3663133">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663136">Dial</span><span class="op" id="3663140">:</span>&nbsp;<span class="op" id="3663142">(</span><span class="op" id="3663143">&amp;</span><span class="ident" id="3663144">net</span><span class="op" id="3663147">.</span><span class="ident" id="3663148">Dialer</span><span class="op" id="3663154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663158">Timeout</span><span class="op" id="3663165">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3663169">30</span>&nbsp;<span class="op" id="3663172">*</span>&nbsp;<span class="ident" id="3663174">time</span><span class="op" id="3663178">.</span><span class="ident" id="3663179">Second</span><span class="op" id="3663185">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663189">KeepAlive</span><span class="op" id="3663198">:</span>&nbsp;<span class="num" id="3663200">30</span>&nbsp;<span class="op" id="3663203">*</span>&nbsp;<span class="ident" id="3663205">time</span><span class="op" id="3663209">.</span><span class="ident" id="3663210">Second</span><span class="op" id="3663216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3663219">}</span><span class="op" id="3663220">)</span><span class="op" id="3663221">.</span><span class="ident" id="3663222">Dial</span><span class="op" id="3663226">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663229">TLSHandshakeTimeout</span><span class="op" id="3663248">:</span>&nbsp;<span class="num" id="3663250">10</span>&nbsp;<span class="op" id="3663253">*</span>&nbsp;<span class="ident" id="3663255">time</span><span class="op" id="3663259">.</span><span class="ident" id="3663260">Second</span><span class="op" id="3663266">,</span><br>
<span class="lineno">40</span><span class="op" id="3663268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3663271">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3663337">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3663361">const</span>&nbsp;<span class="ident" id="3663367">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3663394">=</span>&nbsp;<span class="num" id="3663396">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3663399">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3663469">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3663537">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3663596">type</span>&nbsp;<span class="ident" id="3663601">Transport</span>&nbsp;<span class="keyword" id="3663611">struct</span>&nbsp;<span class="op" id="3663618">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663621">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663632">sync</span><span class="op" id="3663636">.</span><span class="ident" id="3663637">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663644">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3663655">bool</span>&nbsp;<span class="comment" id="3663660">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663707">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3663718">map</span><span class="op" id="3663721">[</span><span class="ident" id="3663722">connectMethodKey</span><span class="op" id="3663738">]</span><span class="op" id="3663739">[</span><span class="op" id="3663740">]</span><span class="op" id="3663741">*</span><span class="ident" id="3663742">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663755">idleConnCh</span>&nbsp;<span class="keyword" id="3663766">map</span><span class="op" id="3663769">[</span><span class="ident" id="3663770">connectMethodKey</span><span class="op" id="3663786">]</span><span class="keyword" id="3663787">chan</span>&nbsp;<span class="op" id="3663792">*</span><span class="ident" id="3663793">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663807">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663819">sync</span><span class="op" id="3663823">.</span><span class="ident" id="3663824">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663831">reqCanceler</span>&nbsp;<span class="keyword" id="3663843">map</span><span class="op" id="3663846">[</span><span class="op" id="3663847">*</span><span class="ident" id="3663848">Request</span><span class="op" id="3663855">]</span><span class="keyword" id="3663856">func</span><span class="op" id="3663860">(</span><span class="op" id="3663861">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663865">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3663874">sync</span><span class="op" id="3663878">.</span><span class="ident" id="3663879">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3663888">altProto</span>&nbsp;<span class="keyword" id="3663897">map</span><span class="op" id="3663900">[</span><span class="builtintype" id="3663901">string</span><span class="op" id="3663907">]</span><span class="ident" id="3663908">RoundTripper</span>&nbsp;<span class="comment" id="3663921">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3663967">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664028">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664086">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664134">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664195">Proxy</span>&nbsp;<span class="keyword" id="3664201">func</span><span class="op" id="3664205">(</span><span class="op" id="3664206">*</span><span class="ident" id="3664207">Request</span><span class="op" id="3664214">)</span>&nbsp;<span class="op" id="3664216">(</span><span class="op" id="3664217">*</span><span class="ident" id="3664218">url</span><span class="op" id="3664221">.</span><span class="ident" id="3664222">URL</span><span class="op" id="3664225">,</span>&nbsp;<span class="builtintype" id="3664227">error</span><span class="op" id="3664232">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664236">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664298">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664319">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664357">Dial</span>&nbsp;<span class="keyword" id="3664362">func</span><span class="op" id="3664366">(</span><span class="ident" id="3664367">network</span><span class="op" id="3664374">,</span>&nbsp;<span class="ident" id="3664376">addr</span>&nbsp;<span class="builtintype" id="3664381">string</span><span class="op" id="3664387">)</span>&nbsp;<span class="op" id="3664389">(</span><span class="ident" id="3664390">net</span><span class="op" id="3664393">.</span><span class="ident" id="3664394">Conn</span><span class="op" id="3664398">,</span>&nbsp;<span class="builtintype" id="3664400">error</span><span class="op" id="3664405">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664409">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664470">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664522">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664526">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664584">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664588">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664647">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664708">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664772">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664800">DialTLS</span>&nbsp;<span class="keyword" id="3664808">func</span><span class="op" id="3664812">(</span><span class="ident" id="3664813">network</span><span class="op" id="3664820">,</span>&nbsp;<span class="ident" id="3664822">addr</span>&nbsp;<span class="builtintype" id="3664827">string</span><span class="op" id="3664833">)</span>&nbsp;<span class="op" id="3664835">(</span><span class="ident" id="3664836">net</span><span class="op" id="3664839">.</span><span class="ident" id="3664840">Conn</span><span class="op" id="3664844">,</span>&nbsp;<span class="builtintype" id="3664846">error</span><span class="op" id="3664851">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664855">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3664919">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3664978">TLSClientConfig</span>&nbsp;<span class="op" id="3664994">*</span><span class="ident" id="3664995">tls</span><span class="op" id="3664998">.</span><span class="ident" id="3664999">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665008">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665080">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665133">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3665153">time</span><span class="op" id="3665157">.</span><span class="ident" id="3665158">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665169">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665236">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665273">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3665291">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665298">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665359">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665418">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665475">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665536">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665596">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665651">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665705">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665723">DisableCompression</span>&nbsp;<span class="builtintype" id="3665742">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665749">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665813">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665858">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3665898">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3665918">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665924">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3665988">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666049">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666108">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3666170">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3666192">time</span><span class="op" id="3666196">.</span><span class="ident" id="3666197">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666208">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3666259">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3666309">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3666312">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3666378">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3666438">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3666505">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3666573">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3666586">//</span><br>
<span class="lineno"></span><span class="comment" id="3666589">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3666649">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3666711">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3666769">//</span><br>
<span class="lineno">130</span><span class="comment" id="3666772">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3666842">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3666911">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3666938">//</span><br>
<span class="lineno"></span><span class="comment" id="3666941">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3667011">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3667077">func</span>&nbsp;<span class="ident" id="3667082">ProxyFromEnvironment</span><span class="op" id="3667102">(</span><span class="ident" id="3667103">req</span>&nbsp;<span class="op" id="3667107">*</span><span class="ident" id="3667108">Request</span><span class="op" id="3667115">)</span>&nbsp;<span class="op" id="3667117">(</span><span class="op" id="3667118">*</span><span class="ident" id="3667119">url</span><span class="op" id="3667122">.</span><span class="ident" id="3667123">URL</span><span class="op" id="3667126">,</span>&nbsp;<span class="builtintype" id="3667128">error</span><span class="op" id="3667133">)</span>&nbsp;<span class="op" id="3667135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667138">var</span>&nbsp;<span class="ident" id="3667142">proxy</span>&nbsp;<span class="builtintype" id="3667148">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667156">if</span>&nbsp;<span class="ident" id="3667159">req</span><span class="op" id="3667162">.</span><span class="ident" id="3667163">URL</span><span class="op" id="3667166">.</span><span class="ident" id="3667167">Scheme</span>&nbsp;<span class="op" id="3667174">==</span>&nbsp;<span class="string" id="3667177">&#34;https&#34;</span>&nbsp;<span class="op" id="3667185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667189">proxy</span>&nbsp;<span class="op" id="3667195">=</span>&nbsp;<span class="ident" id="3667197">httpsProxyEnv</span><span class="op" id="3667210">.</span><span class="ident" id="3667211">Get</span><span class="op" id="3667214">(</span><span class="op" id="3667215">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667221">if</span>&nbsp;<span class="ident" id="3667224">proxy</span>&nbsp;<span class="op" id="3667230">==</span>&nbsp;<span class="string" id="3667233">&#34;&#34;</span>&nbsp;<span class="op" id="3667236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667240">proxy</span>&nbsp;<span class="op" id="3667246">=</span>&nbsp;<span class="ident" id="3667248">httpProxyEnv</span><span class="op" id="3667260">.</span><span class="ident" id="3667261">Get</span><span class="op" id="3667264">(</span><span class="op" id="3667265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667271">if</span>&nbsp;<span class="ident" id="3667274">proxy</span>&nbsp;<span class="op" id="3667280">==</span>&nbsp;<span class="string" id="3667283">&#34;&#34;</span>&nbsp;<span class="op" id="3667286">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667290">return</span>&nbsp;<span class="ident" id="3667297">nil</span><span class="op" id="3667300">,</span>&nbsp;<span class="ident" id="3667302">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667310">if</span>&nbsp;<span class="op" id="3667313">!</span><span class="ident" id="3667314">useProxy</span><span class="op" id="3667322">(</span><span class="ident" id="3667323">canonicalAddr</span><span class="op" id="3667336">(</span><span class="ident" id="3667337">req</span><span class="op" id="3667340">.</span><span class="ident" id="3667341">URL</span><span class="op" id="3667344">)</span><span class="op" id="3667345">)</span>&nbsp;<span class="op" id="3667347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667351">return</span>&nbsp;<span class="ident" id="3667358">nil</span><span class="op" id="3667361">,</span>&nbsp;<span class="ident" id="3667363">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667368">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3667371">proxyURL</span><span class="op" id="3667379">,</span>&nbsp;<span class="ident" id="3667381">err</span>&nbsp;<span class="op" id="3667385">:=</span>&nbsp;<span class="ident" id="3667388">url</span><span class="op" id="3667391">.</span><span class="ident" id="3667392">Parse</span><span class="op" id="3667397">(</span><span class="ident" id="3667398">proxy</span><span class="op" id="3667403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667406">if</span>&nbsp;<span class="ident" id="3667409">err</span>&nbsp;<span class="op" id="3667413">!=</span>&nbsp;<span class="ident" id="3667416">nil</span>&nbsp;<span class="op" id="3667420">||</span>&nbsp;<span class="op" id="3667423">!</span><span class="ident" id="3667424">strings</span><span class="op" id="3667431">.</span><span class="ident" id="3667432">HasPrefix</span><span class="op" id="3667441">(</span><span class="ident" id="3667442">proxyURL</span><span class="op" id="3667450">.</span><span class="ident" id="3667451">Scheme</span><span class="op" id="3667457">,</span>&nbsp;<span class="string" id="3667459">&#34;http&#34;</span><span class="op" id="3667465">)</span>&nbsp;<span class="op" id="3667467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667471">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667528">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3667579">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667629">if</span>&nbsp;<span class="ident" id="3667632">proxyURL</span><span class="op" id="3667640">,</span>&nbsp;<span class="ident" id="3667642">err</span>&nbsp;<span class="op" id="3667646">:=</span>&nbsp;<span class="ident" id="3667649">url</span><span class="op" id="3667652">.</span><span class="ident" id="3667653">Parse</span><span class="op" id="3667658">(</span><span class="string" id="3667659">&#34;http://&#34;</span>&nbsp;<span class="op" id="3667669">+</span>&nbsp;<span class="ident" id="3667671">proxy</span><span class="op" id="3667676">)</span><span class="op" id="3667677">;</span>&nbsp;<span class="ident" id="3667679">err</span>&nbsp;<span class="op" id="3667683">==</span>&nbsp;<span class="ident" id="3667686">nil</span>&nbsp;<span class="op" id="3667690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667695">return</span>&nbsp;<span class="ident" id="3667702">proxyURL</span><span class="op" id="3667710">,</span>&nbsp;<span class="ident" id="3667712">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667724">if</span>&nbsp;<span class="ident" id="3667727">err</span>&nbsp;<span class="op" id="3667731">!=</span>&nbsp;<span class="ident" id="3667734">nil</span>&nbsp;<span class="op" id="3667738">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667742">return</span>&nbsp;<span class="ident" id="3667749">nil</span><span class="op" id="3667752">,</span>&nbsp;<span class="ident" id="3667754">fmt</span><span class="op" id="3667757">.</span><span class="ident" id="3667758">Errorf</span><span class="op" id="3667764">(</span><span class="string" id="3667765">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3667795">,</span>&nbsp;<span class="ident" id="3667797">proxy</span><span class="op" id="3667802">,</span>&nbsp;<span class="ident" id="3667804">err</span><span class="op" id="3667807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3667810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3667813">return</span>&nbsp;<span class="ident" id="3667820">proxyURL</span><span class="op" id="3667828">,</span>&nbsp;<span class="ident" id="3667830">nil</span><br>
<span class="lineno"></span><span class="op" id="3667834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3667837">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3667899">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3667936">func</span>&nbsp;<span class="ident" id="3667941">ProxyURL</span><span class="op" id="3667949">(</span><span class="ident" id="3667950">fixedURL</span>&nbsp;<span class="op" id="3667959">*</span><span class="ident" id="3667960">url</span><span class="op" id="3667963">.</span><span class="ident" id="3667964">URL</span><span class="op" id="3667967">)</span>&nbsp;<span class="keyword" id="3667969">func</span><span class="op" id="3667973">(</span><span class="op" id="3667974">*</span><span class="ident" id="3667975">Request</span><span class="op" id="3667982">)</span>&nbsp;<span class="op" id="3667984">(</span><span class="op" id="3667985">*</span><span class="ident" id="3667986">url</span><span class="op" id="3667989">.</span><span class="ident" id="3667990">URL</span><span class="op" id="3667993">,</span>&nbsp;<span class="builtintype" id="3667995">error</span><span class="op" id="3668000">)</span>&nbsp;<span class="op" id="3668002">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668005">return</span>&nbsp;<span class="keyword" id="3668012">func</span><span class="op" id="3668016">(</span><span class="op" id="3668017">*</span><span class="ident" id="3668018">Request</span><span class="op" id="3668025">)</span>&nbsp;<span class="op" id="3668027">(</span><span class="op" id="3668028">*</span><span class="ident" id="3668029">url</span><span class="op" id="3668032">.</span><span class="ident" id="3668033">URL</span><span class="op" id="3668036">,</span>&nbsp;<span class="builtintype" id="3668038">error</span><span class="op" id="3668043">)</span>&nbsp;<span class="op" id="3668045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668049">return</span>&nbsp;<span class="ident" id="3668056">fixedURL</span><span class="op" id="3668064">,</span>&nbsp;<span class="ident" id="3668066">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668071">}</span><br>
<span class="lineno"></span><span class="op" id="3668073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668076">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3668137">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3668173">type</span>&nbsp;<span class="ident" id="3668178">transportRequest</span>&nbsp;<span class="keyword" id="3668195">struct</span>&nbsp;<span class="op" id="3668202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668205">*</span><span class="ident" id="3668206">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668221">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668261">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668270">Header</span>&nbsp;<span class="comment" id="3668277">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3668311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3668314">func</span>&nbsp;<span class="op" id="3668319">(</span><span class="ident" id="3668320">tr</span>&nbsp;<span class="op" id="3668323">*</span><span class="ident" id="3668324">transportRequest</span><span class="op" id="3668340">)</span>&nbsp;<span class="ident" id="3668342">extraHeaders</span><span class="op" id="3668354">(</span><span class="op" id="3668355">)</span>&nbsp;<span class="ident" id="3668357">Header</span>&nbsp;<span class="op" id="3668364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668367">if</span>&nbsp;<span class="ident" id="3668370">tr</span><span class="op" id="3668372">.</span><span class="ident" id="3668373">extra</span>&nbsp;<span class="op" id="3668379">==</span>&nbsp;<span class="ident" id="3668382">nil</span>&nbsp;<span class="op" id="3668386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668390">tr</span><span class="op" id="3668392">.</span><span class="ident" id="3668393">extra</span>&nbsp;<span class="op" id="3668399">=</span>&nbsp;<span class="builtinfunc" id="3668401">make</span><span class="op" id="3668405">(</span><span class="ident" id="3668406">Header</span><span class="op" id="3668412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668418">return</span>&nbsp;<span class="ident" id="3668425">tr</span><span class="op" id="3668427">.</span><span class="ident" id="3668428">extra</span><br>
<span class="lineno">185</span><span class="op" id="3668434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668437">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3668489">//</span><br>
<span class="lineno"></span><span class="comment" id="3668492">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3668561">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3668616">func</span>&nbsp;<span class="op" id="3668621">(</span><span class="ident" id="3668622">t</span>&nbsp;<span class="op" id="3668624">*</span><span class="ident" id="3668625">Transport</span><span class="op" id="3668634">)</span>&nbsp;<span class="ident" id="3668636">RoundTrip</span><span class="op" id="3668645">(</span><span class="ident" id="3668646">req</span>&nbsp;<span class="op" id="3668650">*</span><span class="ident" id="3668651">Request</span><span class="op" id="3668658">)</span>&nbsp;<span class="op" id="3668660">(</span><span class="ident" id="3668661">resp</span>&nbsp;<span class="op" id="3668666">*</span><span class="ident" id="3668667">Response</span><span class="op" id="3668675">,</span>&nbsp;<span class="ident" id="3668677">err</span>&nbsp;<span class="builtintype" id="3668681">error</span><span class="op" id="3668686">)</span>&nbsp;<span class="op" id="3668688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668691">if</span>&nbsp;<span class="ident" id="3668694">req</span><span class="op" id="3668697">.</span><span class="ident" id="3668698">URL</span>&nbsp;<span class="op" id="3668702">==</span>&nbsp;<span class="ident" id="3668705">nil</span>&nbsp;<span class="op" id="3668709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668713">req</span><span class="op" id="3668716">.</span><span class="ident" id="3668717">closeBody</span><span class="op" id="3668726">(</span><span class="op" id="3668727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668731">return</span>&nbsp;<span class="ident" id="3668738">nil</span><span class="op" id="3668741">,</span>&nbsp;<span class="ident" id="3668743">errors</span><span class="op" id="3668749">.</span><span class="ident" id="3668750">New</span><span class="op" id="3668753">(</span><span class="string" id="3668754">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3668777">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668783">if</span>&nbsp;<span class="ident" id="3668786">req</span><span class="op" id="3668789">.</span><span class="ident" id="3668790">Header</span>&nbsp;<span class="op" id="3668797">==</span>&nbsp;<span class="ident" id="3668800">nil</span>&nbsp;<span class="op" id="3668804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668808">req</span><span class="op" id="3668811">.</span><span class="ident" id="3668812">closeBody</span><span class="op" id="3668821">(</span><span class="op" id="3668822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668826">return</span>&nbsp;<span class="ident" id="3668833">nil</span><span class="op" id="3668836">,</span>&nbsp;<span class="ident" id="3668838">errors</span><span class="op" id="3668844">.</span><span class="ident" id="3668845">New</span><span class="op" id="3668848">(</span><span class="string" id="3668849">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3668875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3668878">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668881">if</span>&nbsp;<span class="ident" id="3668884">req</span><span class="op" id="3668887">.</span><span class="ident" id="3668888">URL</span><span class="op" id="3668891">.</span><span class="ident" id="3668892">Scheme</span>&nbsp;<span class="op" id="3668899">!=</span>&nbsp;<span class="string" id="3668902">&#34;http&#34;</span>&nbsp;<span class="op" id="3668909">&amp;&amp;</span>&nbsp;<span class="ident" id="3668912">req</span><span class="op" id="3668915">.</span><span class="ident" id="3668916">URL</span><span class="op" id="3668919">.</span><span class="ident" id="3668920">Scheme</span>&nbsp;<span class="op" id="3668927">!=</span>&nbsp;<span class="string" id="3668930">&#34;https&#34;</span>&nbsp;<span class="op" id="3668938">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3668942">t</span><span class="op" id="3668943">.</span><span class="ident" id="3668944">altMu</span><span class="op" id="3668949">.</span><span class="ident" id="3668950">RLock</span><span class="op" id="3668955">(</span><span class="op" id="3668956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668960">var</span>&nbsp;<span class="ident" id="3668964">rt</span>&nbsp;<span class="ident" id="3668967">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3668982">if</span>&nbsp;<span class="ident" id="3668985">t</span><span class="op" id="3668986">.</span><span class="ident" id="3668987">altProto</span>&nbsp;<span class="op" id="3668996">!=</span>&nbsp;<span class="ident" id="3668999">nil</span>&nbsp;<span class="op" id="3669003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669008">rt</span>&nbsp;<span class="op" id="3669011">=</span>&nbsp;<span class="ident" id="3669013">t</span><span class="op" id="3669014">.</span><span class="ident" id="3669015">altProto</span><span class="op" id="3669023">[</span><span class="ident" id="3669024">req</span><span class="op" id="3669027">.</span><span class="ident" id="3669028">URL</span><span class="op" id="3669031">.</span><span class="ident" id="3669032">Scheme</span><span class="op" id="3669038">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669042">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669046">t</span><span class="op" id="3669047">.</span><span class="ident" id="3669048">altMu</span><span class="op" id="3669053">.</span><span class="ident" id="3669054">RUnlock</span><span class="op" id="3669061">(</span><span class="op" id="3669062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669066">if</span>&nbsp;<span class="ident" id="3669069">rt</span>&nbsp;<span class="op" id="3669072">==</span>&nbsp;<span class="ident" id="3669075">nil</span>&nbsp;<span class="op" id="3669079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669084">req</span><span class="op" id="3669087">.</span><span class="ident" id="3669088">closeBody</span><span class="op" id="3669097">(</span><span class="op" id="3669098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669103">return</span>&nbsp;<span class="ident" id="3669110">nil</span><span class="op" id="3669113">,</span>&nbsp;<span class="op" id="3669115">&amp;</span><span class="ident" id="3669116">badStringError</span><span class="op" id="3669130">{</span><span class="string" id="3669131">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3669160">,</span>&nbsp;<span class="ident" id="3669162">req</span><span class="op" id="3669165">.</span><span class="ident" id="3669166">URL</span><span class="op" id="3669169">.</span><span class="ident" id="3669170">Scheme</span><span class="op" id="3669176">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669184">return</span>&nbsp;<span class="ident" id="3669191">rt</span><span class="op" id="3669193">.</span><span class="ident" id="3669194">RoundTrip</span><span class="op" id="3669203">(</span><span class="ident" id="3669204">req</span><span class="op" id="3669207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669213">if</span>&nbsp;<span class="ident" id="3669216">req</span><span class="op" id="3669219">.</span><span class="ident" id="3669220">URL</span><span class="op" id="3669223">.</span><span class="ident" id="3669224">Host</span>&nbsp;<span class="op" id="3669229">==</span>&nbsp;<span class="string" id="3669232">&#34;&#34;</span>&nbsp;<span class="op" id="3669235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669239">req</span><span class="op" id="3669242">.</span><span class="ident" id="3669243">closeBody</span><span class="op" id="3669252">(</span><span class="op" id="3669253">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669257">return</span>&nbsp;<span class="ident" id="3669264">nil</span><span class="op" id="3669267">,</span>&nbsp;<span class="ident" id="3669269">errors</span><span class="op" id="3669275">.</span><span class="ident" id="3669276">New</span><span class="op" id="3669279">(</span><span class="string" id="3669280">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3669310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669316">treq</span>&nbsp;<span class="op" id="3669321">:=</span>&nbsp;<span class="op" id="3669324">&amp;</span><span class="ident" id="3669325">transportRequest</span><span class="op" id="3669341">{</span><span class="ident" id="3669342">Request</span><span class="op" id="3669349">:</span>&nbsp;<span class="ident" id="3669351">req</span><span class="op" id="3669354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669357">cm</span><span class="op" id="3669359">,</span>&nbsp;<span class="ident" id="3669361">err</span>&nbsp;<span class="op" id="3669365">:=</span>&nbsp;<span class="ident" id="3669368">t</span><span class="op" id="3669369">.</span><span class="ident" id="3669370">connectMethodForRequest</span><span class="op" id="3669393">(</span><span class="ident" id="3669394">treq</span><span class="op" id="3669398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669401">if</span>&nbsp;<span class="ident" id="3669404">err</span>&nbsp;<span class="op" id="3669408">!=</span>&nbsp;<span class="ident" id="3669411">nil</span>&nbsp;<span class="op" id="3669415">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669419">req</span><span class="op" id="3669422">.</span><span class="ident" id="3669423">closeBody</span><span class="op" id="3669432">(</span><span class="op" id="3669433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669437">return</span>&nbsp;<span class="ident" id="3669444">nil</span><span class="op" id="3669447">,</span>&nbsp;<span class="ident" id="3669449">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669458">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669519">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669583">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3669647">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669672">pconn</span><span class="op" id="3669677">,</span>&nbsp;<span class="ident" id="3669679">err</span>&nbsp;<span class="op" id="3669683">:=</span>&nbsp;<span class="ident" id="3669686">t</span><span class="op" id="3669687">.</span><span class="ident" id="3669688">getConn</span><span class="op" id="3669695">(</span><span class="ident" id="3669696">req</span><span class="op" id="3669699">,</span>&nbsp;<span class="ident" id="3669701">cm</span><span class="op" id="3669703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669706">if</span>&nbsp;<span class="ident" id="3669709">err</span>&nbsp;<span class="op" id="3669713">!=</span>&nbsp;<span class="ident" id="3669716">nil</span>&nbsp;<span class="op" id="3669720">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669724">t</span><span class="op" id="3669725">.</span><span class="ident" id="3669726">setReqCanceler</span><span class="op" id="3669740">(</span><span class="ident" id="3669741">req</span><span class="op" id="3669744">,</span>&nbsp;<span class="ident" id="3669746">nil</span><span class="op" id="3669749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3669753">req</span><span class="op" id="3669756">.</span><span class="ident" id="3669757">closeBody</span><span class="op" id="3669766">(</span><span class="op" id="3669767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669771">return</span>&nbsp;<span class="ident" id="3669778">nil</span><span class="op" id="3669781">,</span>&nbsp;<span class="ident" id="3669783">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3669788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3669792">return</span>&nbsp;<span class="ident" id="3669799">pconn</span><span class="op" id="3669804">.</span><span class="ident" id="3669805">roundTrip</span><span class="op" id="3669814">(</span><span class="ident" id="3669815">treq</span><span class="op" id="3669819">)</span><br>
<span class="lineno"></span><span class="op" id="3669821">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3669824">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3669882">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3669948">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3670013">//</span><br>
<span class="lineno"></span><span class="comment" id="3670016">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3670077">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3670138">func</span>&nbsp;<span class="op" id="3670143">(</span><span class="ident" id="3670144">t</span>&nbsp;<span class="op" id="3670146">*</span><span class="ident" id="3670147">Transport</span><span class="op" id="3670156">)</span>&nbsp;<span class="ident" id="3670158">RegisterProtocol</span><span class="op" id="3670174">(</span><span class="ident" id="3670175">scheme</span>&nbsp;<span class="builtintype" id="3670182">string</span><span class="op" id="3670188">,</span>&nbsp;<span class="ident" id="3670190">rt</span>&nbsp;<span class="ident" id="3670193">RoundTripper</span><span class="op" id="3670205">)</span>&nbsp;<span class="op" id="3670207">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670210">if</span>&nbsp;<span class="ident" id="3670213">scheme</span>&nbsp;<span class="op" id="3670220">==</span>&nbsp;<span class="string" id="3670223">&#34;http&#34;</span>&nbsp;<span class="op" id="3670230">||</span>&nbsp;<span class="ident" id="3670233">scheme</span>&nbsp;<span class="op" id="3670240">==</span>&nbsp;<span class="string" id="3670243">&#34;https&#34;</span>&nbsp;<span class="op" id="3670251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3670255">panic</span><span class="op" id="3670260">(</span><span class="string" id="3670261">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3670273">+</span>&nbsp;<span class="ident" id="3670275">scheme</span>&nbsp;<span class="op" id="3670282">+</span>&nbsp;<span class="string" id="3670284">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3670305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670311">t</span><span class="op" id="3670312">.</span><span class="ident" id="3670313">altMu</span><span class="op" id="3670318">.</span><span class="ident" id="3670319">Lock</span><span class="op" id="3670323">(</span><span class="op" id="3670324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670327">defer</span>&nbsp;<span class="ident" id="3670333">t</span><span class="op" id="3670334">.</span><span class="ident" id="3670335">altMu</span><span class="op" id="3670340">.</span><span class="ident" id="3670341">Unlock</span><span class="op" id="3670347">(</span><span class="op" id="3670348">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670351">if</span>&nbsp;<span class="ident" id="3670354">t</span><span class="op" id="3670355">.</span><span class="ident" id="3670356">altProto</span>&nbsp;<span class="op" id="3670365">==</span>&nbsp;<span class="ident" id="3670368">nil</span>&nbsp;<span class="op" id="3670372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670376">t</span><span class="op" id="3670377">.</span><span class="ident" id="3670378">altProto</span>&nbsp;<span class="op" id="3670387">=</span>&nbsp;<span class="builtinfunc" id="3670389">make</span><span class="op" id="3670393">(</span><span class="keyword" id="3670394">map</span><span class="op" id="3670397">[</span><span class="builtintype" id="3670398">string</span><span class="op" id="3670404">]</span><span class="ident" id="3670405">RoundTripper</span><span class="op" id="3670417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670423">if</span>&nbsp;<span class="ident" id="3670426">_</span><span class="op" id="3670427">,</span>&nbsp;<span class="ident" id="3670429">exists</span>&nbsp;<span class="op" id="3670436">:=</span>&nbsp;<span class="ident" id="3670439">t</span><span class="op" id="3670440">.</span><span class="ident" id="3670441">altProto</span><span class="op" id="3670449">[</span><span class="ident" id="3670450">scheme</span><span class="op" id="3670456">]</span><span class="op" id="3670457">;</span>&nbsp;<span class="ident" id="3670459">exists</span>&nbsp;<span class="op" id="3670466">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3670470">panic</span><span class="op" id="3670475">(</span><span class="string" id="3670476">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3670488">+</span>&nbsp;<span class="ident" id="3670490">scheme</span>&nbsp;<span class="op" id="3670497">+</span>&nbsp;<span class="string" id="3670499">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3670520">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3670523">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670526">t</span><span class="op" id="3670527">.</span><span class="ident" id="3670528">altProto</span><span class="op" id="3670536">[</span><span class="ident" id="3670537">scheme</span><span class="op" id="3670543">]</span>&nbsp;<span class="op" id="3670545">=</span>&nbsp;<span class="ident" id="3670547">rt</span><br>
<span class="lineno"></span><span class="op" id="3670550">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3670553">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3670622">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3670686">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3670759">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3670770">func</span>&nbsp;<span class="op" id="3670775">(</span><span class="ident" id="3670776">t</span>&nbsp;<span class="op" id="3670778">*</span><span class="ident" id="3670779">Transport</span><span class="op" id="3670788">)</span>&nbsp;<span class="ident" id="3670790">CloseIdleConnections</span><span class="op" id="3670810">(</span><span class="op" id="3670811">)</span>&nbsp;<span class="op" id="3670813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670816">t</span><span class="op" id="3670817">.</span><span class="ident" id="3670818">idleMu</span><span class="op" id="3670824">.</span><span class="ident" id="3670825">Lock</span><span class="op" id="3670829">(</span><span class="op" id="3670830">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670833">m</span>&nbsp;<span class="op" id="3670835">:=</span>&nbsp;<span class="ident" id="3670838">t</span><span class="op" id="3670839">.</span><span class="ident" id="3670840">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670850">t</span><span class="op" id="3670851">.</span><span class="ident" id="3670852">idleConn</span>&nbsp;<span class="op" id="3670861">=</span>&nbsp;<span class="ident" id="3670863">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670868">t</span><span class="op" id="3670869">.</span><span class="ident" id="3670870">idleConnCh</span>&nbsp;<span class="op" id="3670881">=</span>&nbsp;<span class="ident" id="3670883">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670888">t</span><span class="op" id="3670889">.</span><span class="ident" id="3670890">wantIdle</span>&nbsp;<span class="op" id="3670899">=</span>&nbsp;<span class="ident" id="3670901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670907">t</span><span class="op" id="3670908">.</span><span class="ident" id="3670909">idleMu</span><span class="op" id="3670915">.</span><span class="ident" id="3670916">Unlock</span><span class="op" id="3670922">(</span><span class="op" id="3670923">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670926">for</span>&nbsp;<span class="ident" id="3670930">_</span><span class="op" id="3670931">,</span>&nbsp;<span class="ident" id="3670933">conns</span>&nbsp;<span class="op" id="3670939">:=</span>&nbsp;<span class="keyword" id="3670942">range</span>&nbsp;<span class="ident" id="3670948">m</span>&nbsp;<span class="op" id="3670950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3670954">for</span>&nbsp;<span class="ident" id="3670958">_</span><span class="op" id="3670959">,</span>&nbsp;<span class="ident" id="3670961">pconn</span>&nbsp;<span class="op" id="3670967">:=</span>&nbsp;<span class="keyword" id="3670970">range</span>&nbsp;<span class="ident" id="3670976">conns</span>&nbsp;<span class="op" id="3670982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3670987">pconn</span><span class="op" id="3670992">.</span><span class="builtinfunc" id="3670993">close</span><span class="op" id="3670998">(</span><span class="op" id="3670999">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671006">}</span><br>
<span class="lineno">275</span><span class="op" id="3671008">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3671011">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3671072">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3671087">func</span>&nbsp;<span class="op" id="3671092">(</span><span class="ident" id="3671093">t</span>&nbsp;<span class="op" id="3671095">*</span><span class="ident" id="3671096">Transport</span><span class="op" id="3671105">)</span>&nbsp;<span class="ident" id="3671107">CancelRequest</span><span class="op" id="3671120">(</span><span class="ident" id="3671121">req</span>&nbsp;<span class="op" id="3671125">*</span><span class="ident" id="3671126">Request</span><span class="op" id="3671133">)</span>&nbsp;<span class="op" id="3671135">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671138">t</span><span class="op" id="3671139">.</span><span class="ident" id="3671140">reqMu</span><span class="op" id="3671145">.</span><span class="ident" id="3671146">Lock</span><span class="op" id="3671150">(</span><span class="op" id="3671151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671154">cancel</span>&nbsp;<span class="op" id="3671161">:=</span>&nbsp;<span class="ident" id="3671164">t</span><span class="op" id="3671165">.</span><span class="ident" id="3671166">reqCanceler</span><span class="op" id="3671177">[</span><span class="ident" id="3671178">req</span><span class="op" id="3671181">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671184">t</span><span class="op" id="3671185">.</span><span class="ident" id="3671186">reqMu</span><span class="op" id="3671191">.</span><span class="ident" id="3671192">Unlock</span><span class="op" id="3671198">(</span><span class="op" id="3671199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671202">if</span>&nbsp;<span class="ident" id="3671205">cancel</span>&nbsp;<span class="op" id="3671212">!=</span>&nbsp;<span class="ident" id="3671215">nil</span>&nbsp;<span class="op" id="3671219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671223">cancel</span><span class="op" id="3671229">(</span><span class="op" id="3671230">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671233">}</span><br>
<span class="lineno"></span><span class="op" id="3671235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3671238">//</span><br>
<span class="lineno"></span><span class="comment" id="3671241">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3671284">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3671288">var</span>&nbsp;<span class="op" id="3671292">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671295">httpProxyEnv</span>&nbsp;<span class="op" id="3671308">=</span>&nbsp;<span class="op" id="3671310">&amp;</span><span class="ident" id="3671311">envOnce</span><span class="op" id="3671318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671322">names</span><span class="op" id="3671327">:</span>&nbsp;<span class="op" id="3671329">[</span><span class="op" id="3671330">]</span><span class="builtintype" id="3671331">string</span><span class="op" id="3671337">{</span><span class="string" id="3671338">&#34;HTTP_PROXY&#34;</span><span class="op" id="3671350">,</span>&nbsp;<span class="string" id="3671352">&#34;http_proxy&#34;</span><span class="op" id="3671364">}</span><span class="op" id="3671365">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671371">httpsProxyEnv</span>&nbsp;<span class="op" id="3671385">=</span>&nbsp;<span class="op" id="3671387">&amp;</span><span class="ident" id="3671388">envOnce</span><span class="op" id="3671395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671399">names</span><span class="op" id="3671404">:</span>&nbsp;<span class="op" id="3671406">[</span><span class="op" id="3671407">]</span><span class="builtintype" id="3671408">string</span><span class="op" id="3671414">{</span><span class="string" id="3671415">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3671428">,</span>&nbsp;<span class="string" id="3671430">&#34;https_proxy&#34;</span><span class="op" id="3671443">}</span><span class="op" id="3671444">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671447">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671450">noProxyEnv</span>&nbsp;<span class="op" id="3671461">=</span>&nbsp;<span class="op" id="3671463">&amp;</span><span class="ident" id="3671464">envOnce</span><span class="op" id="3671471">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671475">names</span><span class="op" id="3671480">:</span>&nbsp;<span class="op" id="3671482">[</span><span class="op" id="3671483">]</span><span class="builtintype" id="3671484">string</span><span class="op" id="3671490">{</span><span class="string" id="3671491">&#34;NO_PROXY&#34;</span><span class="op" id="3671501">,</span>&nbsp;<span class="string" id="3671503">&#34;no_proxy&#34;</span><span class="op" id="3671513">}</span><span class="op" id="3671514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671517">}</span><br>
<span class="lineno"></span><span class="op" id="3671519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3671522">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3671590">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3671655">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3671674">type</span>&nbsp;<span class="ident" id="3671679">envOnce</span>&nbsp;<span class="keyword" id="3671687">struct</span>&nbsp;<span class="op" id="3671694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671697">names</span>&nbsp;<span class="op" id="3671703">[</span><span class="op" id="3671704">]</span><span class="builtintype" id="3671705">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671713">once</span>&nbsp;&nbsp;<span class="ident" id="3671719">sync</span><span class="op" id="3671723">.</span><span class="ident" id="3671724">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671730">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3671736">string</span><br>
<span class="lineno"></span><span class="op" id="3671743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3671746">func</span>&nbsp;<span class="op" id="3671751">(</span><span class="ident" id="3671752">e</span>&nbsp;<span class="op" id="3671754">*</span><span class="ident" id="3671755">envOnce</span><span class="op" id="3671762">)</span>&nbsp;<span class="ident" id="3671764">Get</span><span class="op" id="3671767">(</span><span class="op" id="3671768">)</span>&nbsp;<span class="builtintype" id="3671770">string</span>&nbsp;<span class="op" id="3671777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671780">e</span><span class="op" id="3671781">.</span><span class="ident" id="3671782">once</span><span class="op" id="3671786">.</span><span class="ident" id="3671787">Do</span><span class="op" id="3671789">(</span><span class="ident" id="3671790">e</span><span class="op" id="3671791">.</span><span class="ident" id="3671792">init</span><span class="op" id="3671796">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671799">return</span>&nbsp;<span class="ident" id="3671806">e</span><span class="op" id="3671807">.</span><span class="ident" id="3671808">val</span><br>
<span class="lineno"></span><span class="op" id="3671812">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3671815">func</span>&nbsp;<span class="op" id="3671820">(</span><span class="ident" id="3671821">e</span>&nbsp;<span class="op" id="3671823">*</span><span class="ident" id="3671824">envOnce</span><span class="op" id="3671831">)</span>&nbsp;<span class="ident" id="3671833">init</span><span class="op" id="3671837">(</span><span class="op" id="3671838">)</span>&nbsp;<span class="op" id="3671840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671843">for</span>&nbsp;<span class="ident" id="3671847">_</span><span class="op" id="3671848">,</span>&nbsp;<span class="ident" id="3671850">n</span>&nbsp;<span class="op" id="3671852">:=</span>&nbsp;<span class="keyword" id="3671855">range</span>&nbsp;<span class="ident" id="3671861">e</span><span class="op" id="3671862">.</span><span class="ident" id="3671863">names</span>&nbsp;<span class="op" id="3671869">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671873">e</span><span class="op" id="3671874">.</span><span class="ident" id="3671875">val</span>&nbsp;<span class="op" id="3671879">=</span>&nbsp;<span class="ident" id="3671881">os</span><span class="op" id="3671883">.</span><span class="ident" id="3671884">Getenv</span><span class="op" id="3671890">(</span><span class="ident" id="3671891">n</span><span class="op" id="3671892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671896">if</span>&nbsp;<span class="ident" id="3671899">e</span><span class="op" id="3671900">.</span><span class="ident" id="3671901">val</span>&nbsp;<span class="op" id="3671905">!=</span>&nbsp;<span class="string" id="3671908">&#34;&#34;</span>&nbsp;<span class="op" id="3671911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3671916">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3671928">}</span><br>
<span class="lineno">325</span><span class="op" id="3671930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3671933">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3671959">func</span>&nbsp;<span class="op" id="3671964">(</span><span class="ident" id="3671965">e</span>&nbsp;<span class="op" id="3671967">*</span><span class="ident" id="3671968">envOnce</span><span class="op" id="3671975">)</span>&nbsp;<span class="ident" id="3671977">reset</span><span class="op" id="3671982">(</span><span class="op" id="3671983">)</span>&nbsp;<span class="op" id="3671985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3671988">e</span><span class="op" id="3671989">.</span><span class="ident" id="3671990">once</span>&nbsp;<span class="op" id="3671995">=</span>&nbsp;<span class="ident" id="3671997">sync</span><span class="op" id="3672001">.</span><span class="ident" id="3672002">Once</span><span class="op" id="3672006">{</span><span class="op" id="3672007">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672010">e</span><span class="op" id="3672011">.</span><span class="ident" id="3672012">val</span>&nbsp;<span class="op" id="3672016">=</span>&nbsp;<span class="string" id="3672018">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3672021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3672024">func</span>&nbsp;<span class="op" id="3672029">(</span><span class="ident" id="3672030">t</span>&nbsp;<span class="op" id="3672032">*</span><span class="ident" id="3672033">Transport</span><span class="op" id="3672042">)</span>&nbsp;<span class="ident" id="3672044">connectMethodForRequest</span><span class="op" id="3672067">(</span><span class="ident" id="3672068">treq</span>&nbsp;<span class="op" id="3672073">*</span><span class="ident" id="3672074">transportRequest</span><span class="op" id="3672090">)</span>&nbsp;<span class="op" id="3672092">(</span><span class="ident" id="3672093">cm</span>&nbsp;<span class="ident" id="3672096">connectMethod</span><span class="op" id="3672109">,</span>&nbsp;<span class="ident" id="3672111">err</span>&nbsp;<span class="builtintype" id="3672115">error</span><span class="op" id="3672120">)</span>&nbsp;<span class="op" id="3672122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672125">cm</span><span class="op" id="3672127">.</span><span class="ident" id="3672128">targetScheme</span>&nbsp;<span class="op" id="3672141">=</span>&nbsp;<span class="ident" id="3672143">treq</span><span class="op" id="3672147">.</span><span class="ident" id="3672148">URL</span><span class="op" id="3672151">.</span><span class="ident" id="3672152">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672160">cm</span><span class="op" id="3672162">.</span><span class="ident" id="3672163">targetAddr</span>&nbsp;<span class="op" id="3672174">=</span>&nbsp;<span class="ident" id="3672176">canonicalAddr</span><span class="op" id="3672189">(</span><span class="ident" id="3672190">treq</span><span class="op" id="3672194">.</span><span class="ident" id="3672195">URL</span><span class="op" id="3672198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672201">if</span>&nbsp;<span class="ident" id="3672204">t</span><span class="op" id="3672205">.</span><span class="ident" id="3672206">Proxy</span>&nbsp;<span class="op" id="3672212">!=</span>&nbsp;<span class="ident" id="3672215">nil</span>&nbsp;<span class="op" id="3672219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672223">cm</span><span class="op" id="3672225">.</span><span class="ident" id="3672226">proxyURL</span><span class="op" id="3672234">,</span>&nbsp;<span class="ident" id="3672236">err</span>&nbsp;<span class="op" id="3672240">=</span>&nbsp;<span class="ident" id="3672242">t</span><span class="op" id="3672243">.</span><span class="ident" id="3672244">Proxy</span><span class="op" id="3672249">(</span><span class="ident" id="3672250">treq</span><span class="op" id="3672254">.</span><span class="ident" id="3672255">Request</span><span class="op" id="3672262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672268">return</span>&nbsp;<span class="ident" id="3672275">cm</span><span class="op" id="3672277">,</span>&nbsp;<span class="ident" id="3672279">err</span><br>
<span class="lineno">340</span><span class="op" id="3672283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672286">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3672345">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3672376">func</span>&nbsp;<span class="op" id="3672381">(</span><span class="ident" id="3672382">cm</span>&nbsp;<span class="op" id="3672385">*</span><span class="ident" id="3672386">connectMethod</span><span class="op" id="3672399">)</span>&nbsp;<span class="ident" id="3672401">proxyAuth</span><span class="op" id="3672410">(</span><span class="op" id="3672411">)</span>&nbsp;<span class="builtintype" id="3672413">string</span>&nbsp;<span class="op" id="3672420">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672423">if</span>&nbsp;<span class="ident" id="3672426">cm</span><span class="op" id="3672428">.</span><span class="ident" id="3672429">proxyURL</span>&nbsp;<span class="op" id="3672438">==</span>&nbsp;<span class="ident" id="3672441">nil</span>&nbsp;<span class="op" id="3672445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672449">return</span>&nbsp;<span class="string" id="3672456">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672460">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672463">if</span>&nbsp;<span class="ident" id="3672466">u</span>&nbsp;<span class="op" id="3672468">:=</span>&nbsp;<span class="ident" id="3672471">cm</span><span class="op" id="3672473">.</span><span class="ident" id="3672474">proxyURL</span><span class="op" id="3672482">.</span><span class="ident" id="3672483">User</span><span class="op" id="3672487">;</span>&nbsp;<span class="ident" id="3672489">u</span>&nbsp;<span class="op" id="3672491">!=</span>&nbsp;<span class="ident" id="3672494">nil</span>&nbsp;<span class="op" id="3672498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672502">username</span>&nbsp;<span class="op" id="3672511">:=</span>&nbsp;<span class="ident" id="3672514">u</span><span class="op" id="3672515">.</span><span class="ident" id="3672516">Username</span><span class="op" id="3672524">(</span><span class="op" id="3672525">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672529">password</span><span class="op" id="3672537">,</span>&nbsp;<span class="ident" id="3672539">_</span>&nbsp;<span class="op" id="3672541">:=</span>&nbsp;<span class="ident" id="3672544">u</span><span class="op" id="3672545">.</span><span class="ident" id="3672546">Password</span><span class="op" id="3672554">(</span><span class="op" id="3672555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672559">return</span>&nbsp;<span class="string" id="3672566">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3672575">+</span>&nbsp;<span class="ident" id="3672577">basicAuth</span><span class="op" id="3672586">(</span><span class="ident" id="3672587">username</span><span class="op" id="3672595">,</span>&nbsp;<span class="ident" id="3672597">password</span><span class="op" id="3672605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672611">return</span>&nbsp;<span class="string" id="3672618">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3672621">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3672624">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3672702">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3672720">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3672788">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3672806">func</span>&nbsp;<span class="op" id="3672811">(</span><span class="ident" id="3672812">t</span>&nbsp;<span class="op" id="3672814">*</span><span class="ident" id="3672815">Transport</span><span class="op" id="3672824">)</span>&nbsp;<span class="ident" id="3672826">putIdleConn</span><span class="op" id="3672837">(</span><span class="ident" id="3672838">pconn</span>&nbsp;<span class="op" id="3672844">*</span><span class="ident" id="3672845">persistConn</span><span class="op" id="3672856">)</span>&nbsp;<span class="builtintype" id="3672858">bool</span>&nbsp;<span class="op" id="3672863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672866">if</span>&nbsp;<span class="ident" id="3672869">t</span><span class="op" id="3672870">.</span><span class="ident" id="3672871">DisableKeepAlives</span>&nbsp;<span class="op" id="3672889">||</span>&nbsp;<span class="ident" id="3672892">t</span><span class="op" id="3672893">.</span><span class="ident" id="3672894">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3672914">&lt;</span>&nbsp;<span class="num" id="3672916">0</span>&nbsp;<span class="op" id="3672918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672922">pconn</span><span class="op" id="3672927">.</span><span class="builtinfunc" id="3672928">close</span><span class="op" id="3672933">(</span><span class="op" id="3672934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672938">return</span>&nbsp;<span class="ident" id="3672945">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672952">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672955">if</span>&nbsp;<span class="ident" id="3672958">pconn</span><span class="op" id="3672963">.</span><span class="ident" id="3672964">isBroken</span><span class="op" id="3672972">(</span><span class="op" id="3672973">)</span>&nbsp;<span class="op" id="3672975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3672979">return</span>&nbsp;<span class="ident" id="3672986">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3672993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3672996">key</span>&nbsp;<span class="op" id="3673000">:=</span>&nbsp;<span class="ident" id="3673003">pconn</span><span class="op" id="3673008">.</span><span class="ident" id="3673009">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673019">max</span>&nbsp;<span class="op" id="3673023">:=</span>&nbsp;<span class="ident" id="3673026">t</span><span class="op" id="3673027">.</span><span class="ident" id="3673028">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673049">if</span>&nbsp;<span class="ident" id="3673052">max</span>&nbsp;<span class="op" id="3673056">==</span>&nbsp;<span class="num" id="3673059">0</span>&nbsp;<span class="op" id="3673061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673065">max</span>&nbsp;<span class="op" id="3673069">=</span>&nbsp;<span class="ident" id="3673071">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673099">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673102">t</span><span class="op" id="3673103">.</span><span class="ident" id="3673104">idleMu</span><span class="op" id="3673110">.</span><span class="ident" id="3673111">Lock</span><span class="op" id="3673115">(</span><span class="op" id="3673116">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673120">waitingDialer</span>&nbsp;<span class="op" id="3673134">:=</span>&nbsp;<span class="ident" id="3673137">t</span><span class="op" id="3673138">.</span><span class="ident" id="3673139">idleConnCh</span><span class="op" id="3673149">[</span><span class="ident" id="3673150">key</span><span class="op" id="3673153">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673156">select</span>&nbsp;<span class="op" id="3673163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673166">case</span>&nbsp;<span class="ident" id="3673171">waitingDialer</span>&nbsp;<span class="op" id="3673185">&lt;-</span>&nbsp;<span class="ident" id="3673188">pconn</span><span class="op" id="3673193">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673197">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673250">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673306">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673352">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673409">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673477">t</span><span class="op" id="3673478">.</span><span class="ident" id="3673479">idleMu</span><span class="op" id="3673485">.</span><span class="ident" id="3673486">Unlock</span><span class="op" id="3673492">(</span><span class="op" id="3673493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673497">return</span>&nbsp;<span class="ident" id="3673504">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673510">default</span><span class="op" id="3673517">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673521">if</span>&nbsp;<span class="ident" id="3673524">waitingDialer</span>&nbsp;<span class="op" id="3673538">!=</span>&nbsp;<span class="ident" id="3673541">nil</span>&nbsp;<span class="op" id="3673545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673550">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3673600">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3673648">delete</span><span class="op" id="3673654">(</span><span class="ident" id="3673655">t</span><span class="op" id="3673656">.</span><span class="ident" id="3673657">idleConnCh</span><span class="op" id="3673667">,</span>&nbsp;<span class="ident" id="3673669">key</span><span class="op" id="3673672">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673679">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673682">if</span>&nbsp;<span class="ident" id="3673685">t</span><span class="op" id="3673686">.</span><span class="ident" id="3673687">wantIdle</span>&nbsp;<span class="op" id="3673696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673700">t</span><span class="op" id="3673701">.</span><span class="ident" id="3673702">idleMu</span><span class="op" id="3673708">.</span><span class="ident" id="3673709">Unlock</span><span class="op" id="3673715">(</span><span class="op" id="3673716">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673720">pconn</span><span class="op" id="3673725">.</span><span class="builtinfunc" id="3673726">close</span><span class="op" id="3673731">(</span><span class="op" id="3673732">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673736">return</span>&nbsp;<span class="ident" id="3673743">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673750">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673753">if</span>&nbsp;<span class="ident" id="3673756">t</span><span class="op" id="3673757">.</span><span class="ident" id="3673758">idleConn</span>&nbsp;<span class="op" id="3673767">==</span>&nbsp;<span class="ident" id="3673770">nil</span>&nbsp;<span class="op" id="3673774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673778">t</span><span class="op" id="3673779">.</span><span class="ident" id="3673780">idleConn</span>&nbsp;<span class="op" id="3673789">=</span>&nbsp;<span class="builtinfunc" id="3673791">make</span><span class="op" id="3673795">(</span><span class="keyword" id="3673796">map</span><span class="op" id="3673799">[</span><span class="ident" id="3673800">connectMethodKey</span><span class="op" id="3673816">]</span><span class="op" id="3673817">[</span><span class="op" id="3673818">]</span><span class="op" id="3673819">*</span><span class="ident" id="3673820">persistConn</span><span class="op" id="3673831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673834">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673837">if</span>&nbsp;<span class="builtinfunc" id="3673840">len</span><span class="op" id="3673843">(</span><span class="ident" id="3673844">t</span><span class="op" id="3673845">.</span><span class="ident" id="3673846">idleConn</span><span class="op" id="3673854">[</span><span class="ident" id="3673855">key</span><span class="op" id="3673858">]</span><span class="op" id="3673859">)</span>&nbsp;<span class="op" id="3673861">&gt;=</span>&nbsp;<span class="ident" id="3673864">max</span>&nbsp;<span class="op" id="3673868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673872">t</span><span class="op" id="3673873">.</span><span class="ident" id="3673874">idleMu</span><span class="op" id="3673880">.</span><span class="ident" id="3673881">Unlock</span><span class="op" id="3673887">(</span><span class="op" id="3673888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673892">pconn</span><span class="op" id="3673897">.</span><span class="builtinfunc" id="3673898">close</span><span class="op" id="3673903">(</span><span class="op" id="3673904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673908">return</span>&nbsp;<span class="ident" id="3673915">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3673922">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673925">for</span>&nbsp;<span class="ident" id="3673929">_</span><span class="op" id="3673930">,</span>&nbsp;<span class="ident" id="3673932">exist</span>&nbsp;<span class="op" id="3673938">:=</span>&nbsp;<span class="keyword" id="3673941">range</span>&nbsp;<span class="ident" id="3673947">t</span><span class="op" id="3673948">.</span><span class="ident" id="3673949">idleConn</span><span class="op" id="3673957">[</span><span class="ident" id="3673958">key</span><span class="op" id="3673961">]</span>&nbsp;<span class="op" id="3673963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3673967">if</span>&nbsp;<span class="ident" id="3673970">exist</span>&nbsp;<span class="op" id="3673976">==</span>&nbsp;<span class="ident" id="3673979">pconn</span>&nbsp;<span class="op" id="3673985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3673990">log</span><span class="op" id="3673993">.</span><span class="ident" id="3673994">Fatalf</span><span class="op" id="3674000">(</span><span class="string" id="3674001">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3674032">,</span>&nbsp;<span class="ident" id="3674034">pconn</span><span class="op" id="3674039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674046">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674049">t</span><span class="op" id="3674050">.</span><span class="ident" id="3674051">idleConn</span><span class="op" id="3674059">[</span><span class="ident" id="3674060">key</span><span class="op" id="3674063">]</span>&nbsp;<span class="op" id="3674065">=</span>&nbsp;<span class="builtinfunc" id="3674067">append</span><span class="op" id="3674073">(</span><span class="ident" id="3674074">t</span><span class="op" id="3674075">.</span><span class="ident" id="3674076">idleConn</span><span class="op" id="3674084">[</span><span class="ident" id="3674085">key</span><span class="op" id="3674088">]</span><span class="op" id="3674089">,</span>&nbsp;<span class="ident" id="3674091">pconn</span><span class="op" id="3674096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674099">t</span><span class="op" id="3674100">.</span><span class="ident" id="3674101">idleMu</span><span class="op" id="3674107">.</span><span class="ident" id="3674108">Unlock</span><span class="op" id="3674114">(</span><span class="op" id="3674115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674118">return</span>&nbsp;<span class="ident" id="3674125">true</span><br>
<span class="lineno"></span><span class="op" id="3674130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3674133">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3674195">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3674249">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3674317">func</span>&nbsp;<span class="op" id="3674322">(</span><span class="ident" id="3674323">t</span>&nbsp;<span class="op" id="3674325">*</span><span class="ident" id="3674326">Transport</span><span class="op" id="3674335">)</span>&nbsp;<span class="ident" id="3674337">getIdleConnCh</span><span class="op" id="3674350">(</span><span class="ident" id="3674351">cm</span>&nbsp;<span class="ident" id="3674354">connectMethod</span><span class="op" id="3674367">)</span>&nbsp;<span class="keyword" id="3674369">chan</span>&nbsp;<span class="op" id="3674374">*</span><span class="ident" id="3674375">persistConn</span>&nbsp;<span class="op" id="3674387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674390">if</span>&nbsp;<span class="ident" id="3674393">t</span><span class="op" id="3674394">.</span><span class="ident" id="3674395">DisableKeepAlives</span>&nbsp;<span class="op" id="3674413">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674417">return</span>&nbsp;<span class="ident" id="3674424">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674432">key</span>&nbsp;<span class="op" id="3674436">:=</span>&nbsp;<span class="ident" id="3674439">cm</span><span class="op" id="3674441">.</span><span class="ident" id="3674442">key</span><span class="op" id="3674445">(</span><span class="op" id="3674446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674449">t</span><span class="op" id="3674450">.</span><span class="ident" id="3674451">idleMu</span><span class="op" id="3674457">.</span><span class="ident" id="3674458">Lock</span><span class="op" id="3674462">(</span><span class="op" id="3674463">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674466">defer</span>&nbsp;<span class="ident" id="3674472">t</span><span class="op" id="3674473">.</span><span class="ident" id="3674474">idleMu</span><span class="op" id="3674480">.</span><span class="ident" id="3674481">Unlock</span><span class="op" id="3674487">(</span><span class="op" id="3674488">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674491">t</span><span class="op" id="3674492">.</span><span class="ident" id="3674493">wantIdle</span>&nbsp;<span class="op" id="3674502">=</span>&nbsp;<span class="ident" id="3674504">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674511">if</span>&nbsp;<span class="ident" id="3674514">t</span><span class="op" id="3674515">.</span><span class="ident" id="3674516">idleConnCh</span>&nbsp;<span class="op" id="3674527">==</span>&nbsp;<span class="ident" id="3674530">nil</span>&nbsp;<span class="op" id="3674534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674538">t</span><span class="op" id="3674539">.</span><span class="ident" id="3674540">idleConnCh</span>&nbsp;<span class="op" id="3674551">=</span>&nbsp;<span class="builtinfunc" id="3674553">make</span><span class="op" id="3674557">(</span><span class="keyword" id="3674558">map</span><span class="op" id="3674561">[</span><span class="ident" id="3674562">connectMethodKey</span><span class="op" id="3674578">]</span><span class="keyword" id="3674579">chan</span>&nbsp;<span class="op" id="3674584">*</span><span class="ident" id="3674585">persistConn</span><span class="op" id="3674596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674602">ch</span><span class="op" id="3674604">,</span>&nbsp;<span class="ident" id="3674606">ok</span>&nbsp;<span class="op" id="3674609">:=</span>&nbsp;<span class="ident" id="3674612">t</span><span class="op" id="3674613">.</span><span class="ident" id="3674614">idleConnCh</span><span class="op" id="3674624">[</span><span class="ident" id="3674625">key</span><span class="op" id="3674628">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674631">if</span>&nbsp;<span class="op" id="3674634">!</span><span class="ident" id="3674635">ok</span>&nbsp;<span class="op" id="3674638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674642">ch</span>&nbsp;<span class="op" id="3674645">=</span>&nbsp;<span class="builtinfunc" id="3674647">make</span><span class="op" id="3674651">(</span><span class="keyword" id="3674652">chan</span>&nbsp;<span class="op" id="3674657">*</span><span class="ident" id="3674658">persistConn</span><span class="op" id="3674669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674673">t</span><span class="op" id="3674674">.</span><span class="ident" id="3674675">idleConnCh</span><span class="op" id="3674685">[</span><span class="ident" id="3674686">key</span><span class="op" id="3674689">]</span>&nbsp;<span class="op" id="3674691">=</span>&nbsp;<span class="ident" id="3674693">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674700">return</span>&nbsp;<span class="ident" id="3674707">ch</span><br>
<span class="lineno">435</span><span class="op" id="3674710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3674713">func</span>&nbsp;<span class="op" id="3674718">(</span><span class="ident" id="3674719">t</span>&nbsp;<span class="op" id="3674721">*</span><span class="ident" id="3674722">Transport</span><span class="op" id="3674731">)</span>&nbsp;<span class="ident" id="3674733">getIdleConn</span><span class="op" id="3674744">(</span><span class="ident" id="3674745">cm</span>&nbsp;<span class="ident" id="3674748">connectMethod</span><span class="op" id="3674761">)</span>&nbsp;<span class="op" id="3674763">(</span><span class="ident" id="3674764">pconn</span>&nbsp;<span class="op" id="3674770">*</span><span class="ident" id="3674771">persistConn</span><span class="op" id="3674782">)</span>&nbsp;<span class="op" id="3674784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674787">key</span>&nbsp;<span class="op" id="3674791">:=</span>&nbsp;<span class="ident" id="3674794">cm</span><span class="op" id="3674796">.</span><span class="ident" id="3674797">key</span><span class="op" id="3674800">(</span><span class="op" id="3674801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674804">t</span><span class="op" id="3674805">.</span><span class="ident" id="3674806">idleMu</span><span class="op" id="3674812">.</span><span class="ident" id="3674813">Lock</span><span class="op" id="3674817">(</span><span class="op" id="3674818">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674821">defer</span>&nbsp;<span class="ident" id="3674827">t</span><span class="op" id="3674828">.</span><span class="ident" id="3674829">idleMu</span><span class="op" id="3674835">.</span><span class="ident" id="3674836">Unlock</span><span class="op" id="3674842">(</span><span class="op" id="3674843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674846">if</span>&nbsp;<span class="ident" id="3674849">t</span><span class="op" id="3674850">.</span><span class="ident" id="3674851">idleConn</span>&nbsp;<span class="op" id="3674860">==</span>&nbsp;<span class="ident" id="3674863">nil</span>&nbsp;<span class="op" id="3674867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674871">return</span>&nbsp;<span class="ident" id="3674878">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674886">for</span>&nbsp;<span class="op" id="3674890">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674894">pconns</span><span class="op" id="3674900">,</span>&nbsp;<span class="ident" id="3674902">ok</span>&nbsp;<span class="op" id="3674905">:=</span>&nbsp;<span class="ident" id="3674908">t</span><span class="op" id="3674909">.</span><span class="ident" id="3674910">idleConn</span><span class="op" id="3674918">[</span><span class="ident" id="3674919">key</span><span class="op" id="3674922">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674926">if</span>&nbsp;<span class="op" id="3674929">!</span><span class="ident" id="3674930">ok</span>&nbsp;<span class="op" id="3674933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674938">return</span>&nbsp;<span class="ident" id="3674945">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3674951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3674955">if</span>&nbsp;<span class="builtinfunc" id="3674958">len</span><span class="op" id="3674961">(</span><span class="ident" id="3674962">pconns</span><span class="op" id="3674968">)</span>&nbsp;<span class="op" id="3674970">==</span>&nbsp;<span class="num" id="3674973">1</span>&nbsp;<span class="op" id="3674975">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3674980">pconn</span>&nbsp;<span class="op" id="3674986">=</span>&nbsp;<span class="ident" id="3674988">pconns</span><span class="op" id="3674994">[</span><span class="num" id="3674995">0</span><span class="op" id="3674996">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3675001">delete</span><span class="op" id="3675007">(</span><span class="ident" id="3675008">t</span><span class="op" id="3675009">.</span><span class="ident" id="3675010">idleConn</span><span class="op" id="3675018">,</span>&nbsp;<span class="ident" id="3675020">key</span><span class="op" id="3675023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675027">}</span>&nbsp;<span class="keyword" id="3675029">else</span>&nbsp;<span class="op" id="3675034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3675039">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3675084">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675103">pconn</span>&nbsp;<span class="op" id="3675109">=</span>&nbsp;<span class="ident" id="3675111">pconns</span><span class="op" id="3675117">[</span><span class="builtinfunc" id="3675118">len</span><span class="op" id="3675121">(</span><span class="ident" id="3675122">pconns</span><span class="op" id="3675128">)</span><span class="op" id="3675129">-</span><span class="num" id="3675130">1</span><span class="op" id="3675131">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675136">t</span><span class="op" id="3675137">.</span><span class="ident" id="3675138">idleConn</span><span class="op" id="3675146">[</span><span class="ident" id="3675147">key</span><span class="op" id="3675150">]</span>&nbsp;<span class="op" id="3675152">=</span>&nbsp;<span class="ident" id="3675154">pconns</span><span class="op" id="3675160">[</span><span class="op" id="3675161">:</span><span class="builtinfunc" id="3675162">len</span><span class="op" id="3675165">(</span><span class="ident" id="3675166">pconns</span><span class="op" id="3675172">)</span><span class="op" id="3675173">-</span><span class="num" id="3675174">1</span><span class="op" id="3675175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675179">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675183">if</span>&nbsp;<span class="op" id="3675186">!</span><span class="ident" id="3675187">pconn</span><span class="op" id="3675192">.</span><span class="ident" id="3675193">isBroken</span><span class="op" id="3675201">(</span><span class="op" id="3675202">)</span>&nbsp;<span class="op" id="3675204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675209">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675221">}</span><br>
<span class="lineno"></span><span class="op" id="3675223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3675226">func</span>&nbsp;<span class="op" id="3675231">(</span><span class="ident" id="3675232">t</span>&nbsp;<span class="op" id="3675234">*</span><span class="ident" id="3675235">Transport</span><span class="op" id="3675244">)</span>&nbsp;<span class="ident" id="3675246">setReqCanceler</span><span class="op" id="3675260">(</span><span class="ident" id="3675261">r</span>&nbsp;<span class="op" id="3675263">*</span><span class="ident" id="3675264">Request</span><span class="op" id="3675271">,</span>&nbsp;<span class="ident" id="3675273">fn</span>&nbsp;<span class="keyword" id="3675276">func</span><span class="op" id="3675280">(</span><span class="op" id="3675281">)</span><span class="op" id="3675282">)</span>&nbsp;<span class="op" id="3675284">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675287">t</span><span class="op" id="3675288">.</span><span class="ident" id="3675289">reqMu</span><span class="op" id="3675294">.</span><span class="ident" id="3675295">Lock</span><span class="op" id="3675299">(</span><span class="op" id="3675300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675303">defer</span>&nbsp;<span class="ident" id="3675309">t</span><span class="op" id="3675310">.</span><span class="ident" id="3675311">reqMu</span><span class="op" id="3675316">.</span><span class="ident" id="3675317">Unlock</span><span class="op" id="3675323">(</span><span class="op" id="3675324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675327">if</span>&nbsp;<span class="ident" id="3675330">t</span><span class="op" id="3675331">.</span><span class="ident" id="3675332">reqCanceler</span>&nbsp;<span class="op" id="3675344">==</span>&nbsp;<span class="ident" id="3675347">nil</span>&nbsp;<span class="op" id="3675351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675355">t</span><span class="op" id="3675356">.</span><span class="ident" id="3675357">reqCanceler</span>&nbsp;<span class="op" id="3675369">=</span>&nbsp;<span class="builtinfunc" id="3675371">make</span><span class="op" id="3675375">(</span><span class="keyword" id="3675376">map</span><span class="op" id="3675379">[</span><span class="op" id="3675380">*</span><span class="ident" id="3675381">Request</span><span class="op" id="3675388">]</span><span class="keyword" id="3675389">func</span><span class="op" id="3675393">(</span><span class="op" id="3675394">)</span><span class="op" id="3675395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675398">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675401">if</span>&nbsp;<span class="ident" id="3675404">fn</span>&nbsp;<span class="op" id="3675407">!=</span>&nbsp;<span class="ident" id="3675410">nil</span>&nbsp;<span class="op" id="3675414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3675418">t</span><span class="op" id="3675419">.</span><span class="ident" id="3675420">reqCanceler</span><span class="op" id="3675431">[</span><span class="ident" id="3675432">r</span><span class="op" id="3675433">]</span>&nbsp;<span class="op" id="3675435">=</span>&nbsp;<span class="ident" id="3675437">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675441">}</span>&nbsp;<span class="keyword" id="3675443">else</span>&nbsp;<span class="op" id="3675448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3675452">delete</span><span class="op" id="3675458">(</span><span class="ident" id="3675459">t</span><span class="op" id="3675460">.</span><span class="ident" id="3675461">reqCanceler</span><span class="op" id="3675472">,</span>&nbsp;<span class="ident" id="3675474">r</span><span class="op" id="3675475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675478">}</span><br>
<span class="lineno">475</span><span class="op" id="3675480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3675483">func</span>&nbsp;<span class="op" id="3675488">(</span><span class="ident" id="3675489">t</span>&nbsp;<span class="op" id="3675491">*</span><span class="ident" id="3675492">Transport</span><span class="op" id="3675501">)</span>&nbsp;<span class="ident" id="3675503">dial</span><span class="op" id="3675507">(</span><span class="ident" id="3675508">network</span><span class="op" id="3675515">,</span>&nbsp;<span class="ident" id="3675517">addr</span>&nbsp;<span class="builtintype" id="3675522">string</span><span class="op" id="3675528">)</span>&nbsp;<span class="op" id="3675530">(</span><span class="ident" id="3675531">c</span>&nbsp;<span class="ident" id="3675533">net</span><span class="op" id="3675536">.</span><span class="ident" id="3675537">Conn</span><span class="op" id="3675541">,</span>&nbsp;<span class="ident" id="3675543">err</span>&nbsp;<span class="builtintype" id="3675547">error</span><span class="op" id="3675552">)</span>&nbsp;<span class="op" id="3675554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675557">if</span>&nbsp;<span class="ident" id="3675560">t</span><span class="op" id="3675561">.</span><span class="ident" id="3675562">Dial</span>&nbsp;<span class="op" id="3675567">!=</span>&nbsp;<span class="ident" id="3675570">nil</span>&nbsp;<span class="op" id="3675574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675578">return</span>&nbsp;<span class="ident" id="3675585">t</span><span class="op" id="3675586">.</span><span class="ident" id="3675587">Dial</span><span class="op" id="3675591">(</span><span class="ident" id="3675592">network</span><span class="op" id="3675599">,</span>&nbsp;<span class="ident" id="3675601">addr</span><span class="op" id="3675605">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3675608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3675611">return</span>&nbsp;<span class="ident" id="3675618">net</span><span class="op" id="3675621">.</span><span class="ident" id="3675622">Dial</span><span class="op" id="3675626">(</span><span class="ident" id="3675627">network</span><span class="op" id="3675634">,</span>&nbsp;<span class="ident" id="3675636">addr</span><span class="op" id="3675640">)</span><br>
<span class="lineno"></span><span class="op" id="3675642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3675645">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3675663">var</span>&nbsp;<span class="ident" id="3675667">prePendingDial</span><span class="op" id="3675681">,</span>&nbsp;<span class="ident" id="3675683">postPendingDial</span>&nbsp;<span class="keyword" id="3675699">func</span><span class="op" id="3675703">(</span><span class="op" id="3675704">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3675707">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3675771">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3675843">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3675919">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3675953">func</span>&nbsp;<span class="op" id="3675958">(</span><span class="ident" id="3675959">t</span>&nbsp;<span class="op" id="3675961">*</span><span class="ident" id="3675962">Transport</span><span class="op" id="3675971">)</span>&nbsp;<span class="ident" id="3675973">getConn</span><span class="op" id="3675980">(</span><span class="ident" id="3675981">req</span>&nbsp;<span class="op" id="3675985">*</span><span class="ident" id="3675986">Request</span><span class="op" id="3675993">,</span>&nbsp;<span class="ident" id="3675995">cm</span>&nbsp;<span class="ident" id="3675998">connectMethod</span><span class="op" id="3676011">)</span>&nbsp;<span class="op" id="3676013">(</span><span class="op" id="3676014">*</span><span class="ident" id="3676015">persistConn</span><span class="op" id="3676026">,</span>&nbsp;<span class="builtintype" id="3676028">error</span><span class="op" id="3676033">)</span>&nbsp;<span class="op" id="3676035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676038">if</span>&nbsp;<span class="ident" id="3676041">pc</span>&nbsp;<span class="op" id="3676044">:=</span>&nbsp;<span class="ident" id="3676047">t</span><span class="op" id="3676048">.</span><span class="ident" id="3676049">getIdleConn</span><span class="op" id="3676060">(</span><span class="ident" id="3676061">cm</span><span class="op" id="3676063">)</span><span class="op" id="3676064">;</span>&nbsp;<span class="ident" id="3676066">pc</span>&nbsp;<span class="op" id="3676069">!=</span>&nbsp;<span class="ident" id="3676072">nil</span>&nbsp;<span class="op" id="3676076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676080">return</span>&nbsp;<span class="ident" id="3676087">pc</span><span class="op" id="3676089">,</span>&nbsp;<span class="ident" id="3676091">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676096">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676100">type</span>&nbsp;<span class="ident" id="3676105">dialRes</span>&nbsp;<span class="keyword" id="3676113">struct</span>&nbsp;<span class="op" id="3676120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676124">pc</span>&nbsp;&nbsp;<span class="op" id="3676128">*</span><span class="ident" id="3676129">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676143">err</span>&nbsp;<span class="builtintype" id="3676147">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676154">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676157">dialc</span>&nbsp;<span class="op" id="3676163">:=</span>&nbsp;<span class="builtinfunc" id="3676166">make</span><span class="op" id="3676170">(</span><span class="keyword" id="3676171">chan</span>&nbsp;<span class="ident" id="3676176">dialRes</span><span class="op" id="3676183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676187">handlePendingDial</span>&nbsp;<span class="op" id="3676205">:=</span>&nbsp;<span class="keyword" id="3676208">func</span><span class="op" id="3676212">(</span><span class="op" id="3676213">)</span>&nbsp;<span class="op" id="3676215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676219">if</span>&nbsp;<span class="ident" id="3676222">prePendingDial</span>&nbsp;<span class="op" id="3676237">!=</span>&nbsp;<span class="ident" id="3676240">nil</span>&nbsp;<span class="op" id="3676244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676249">prePendingDial</span><span class="op" id="3676263">(</span><span class="op" id="3676264">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676272">go</span>&nbsp;<span class="keyword" id="3676275">func</span><span class="op" id="3676279">(</span><span class="op" id="3676280">)</span>&nbsp;<span class="op" id="3676282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676287">if</span>&nbsp;<span class="ident" id="3676290">v</span>&nbsp;<span class="op" id="3676292">:=</span>&nbsp;<span class="op" id="3676295">&lt;-</span><span class="ident" id="3676297">dialc</span><span class="op" id="3676302">;</span>&nbsp;<span class="ident" id="3676304">v</span><span class="op" id="3676305">.</span><span class="ident" id="3676306">err</span>&nbsp;<span class="op" id="3676310">==</span>&nbsp;<span class="ident" id="3676313">nil</span>&nbsp;<span class="op" id="3676317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676323">t</span><span class="op" id="3676324">.</span><span class="ident" id="3676325">putIdleConn</span><span class="op" id="3676336">(</span><span class="ident" id="3676337">v</span><span class="op" id="3676338">.</span><span class="ident" id="3676339">pc</span><span class="op" id="3676341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676346">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676351">if</span>&nbsp;<span class="ident" id="3676354">postPendingDial</span>&nbsp;<span class="op" id="3676370">!=</span>&nbsp;<span class="ident" id="3676373">nil</span>&nbsp;<span class="op" id="3676377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676383">postPendingDial</span><span class="op" id="3676398">(</span><span class="op" id="3676399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676408">}</span><span class="op" id="3676409">(</span><span class="op" id="3676410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676413">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676417">cancelc</span>&nbsp;<span class="op" id="3676425">:=</span>&nbsp;<span class="builtinfunc" id="3676428">make</span><span class="op" id="3676432">(</span><span class="keyword" id="3676433">chan</span>&nbsp;<span class="keyword" id="3676438">struct</span><span class="op" id="3676444">{</span><span class="op" id="3676445">}</span><span class="op" id="3676446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676449">t</span><span class="op" id="3676450">.</span><span class="ident" id="3676451">setReqCanceler</span><span class="op" id="3676465">(</span><span class="ident" id="3676466">req</span><span class="op" id="3676469">,</span>&nbsp;<span class="keyword" id="3676471">func</span><span class="op" id="3676475">(</span><span class="op" id="3676476">)</span>&nbsp;<span class="op" id="3676478">{</span>&nbsp;<span class="builtinfunc" id="3676480">close</span><span class="op" id="3676485">(</span><span class="ident" id="3676486">cancelc</span><span class="op" id="3676493">)</span>&nbsp;<span class="op" id="3676495">}</span><span class="op" id="3676496">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676500">go</span>&nbsp;<span class="keyword" id="3676503">func</span><span class="op" id="3676507">(</span><span class="op" id="3676508">)</span>&nbsp;<span class="op" id="3676510">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676514">pc</span><span class="op" id="3676516">,</span>&nbsp;<span class="ident" id="3676518">err</span>&nbsp;<span class="op" id="3676522">:=</span>&nbsp;<span class="ident" id="3676525">t</span><span class="op" id="3676526">.</span><span class="ident" id="3676527">dialConn</span><span class="op" id="3676535">(</span><span class="ident" id="3676536">cm</span><span class="op" id="3676538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676542">dialc</span>&nbsp;<span class="op" id="3676548">&lt;-</span>&nbsp;<span class="ident" id="3676551">dialRes</span><span class="op" id="3676558">{</span><span class="ident" id="3676559">pc</span><span class="op" id="3676561">,</span>&nbsp;<span class="ident" id="3676563">err</span><span class="op" id="3676566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3676569">}</span><span class="op" id="3676570">(</span><span class="op" id="3676571">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676575">idleConnCh</span>&nbsp;<span class="op" id="3676586">:=</span>&nbsp;<span class="ident" id="3676589">t</span><span class="op" id="3676590">.</span><span class="ident" id="3676591">getIdleConnCh</span><span class="op" id="3676604">(</span><span class="ident" id="3676605">cm</span><span class="op" id="3676607">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676610">select</span>&nbsp;<span class="op" id="3676617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676620">case</span>&nbsp;<span class="ident" id="3676625">v</span>&nbsp;<span class="op" id="3676627">:=</span>&nbsp;<span class="op" id="3676630">&lt;-</span><span class="ident" id="3676632">dialc</span><span class="op" id="3676637">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676641">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676665">return</span>&nbsp;<span class="ident" id="3676672">v</span><span class="op" id="3676673">.</span><span class="ident" id="3676674">pc</span><span class="op" id="3676676">,</span>&nbsp;<span class="ident" id="3676678">v</span><span class="op" id="3676679">.</span><span class="ident" id="3676680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676685">case</span>&nbsp;<span class="ident" id="3676690">pc</span>&nbsp;<span class="op" id="3676693">:=</span>&nbsp;<span class="op" id="3676696">&lt;-</span><span class="ident" id="3676698">idleConnCh</span><span class="op" id="3676708">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676712">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676765">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676816">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676855">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3676905">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676928">handlePendingDial</span><span class="op" id="3676945">(</span><span class="op" id="3676946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676950">return</span>&nbsp;<span class="ident" id="3676957">pc</span><span class="op" id="3676959">,</span>&nbsp;<span class="ident" id="3676961">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3676966">case</span>&nbsp;<span class="op" id="3676971">&lt;-</span><span class="ident" id="3676973">cancelc</span><span class="op" id="3676980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3676984">handlePendingDial</span><span class="op" id="3677001">(</span><span class="op" id="3677002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677006">return</span>&nbsp;<span class="ident" id="3677013">nil</span><span class="op" id="3677016">,</span>&nbsp;<span class="ident" id="3677018">errors</span><span class="op" id="3677024">.</span><span class="ident" id="3677025">New</span><span class="op" id="3677028">(</span><span class="string" id="3677029">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3677086">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677089">}</span><br>
<span class="lineno"></span><span class="op" id="3677091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3677094">func</span>&nbsp;<span class="op" id="3677099">(</span><span class="ident" id="3677100">t</span>&nbsp;<span class="op" id="3677102">*</span><span class="ident" id="3677103">Transport</span><span class="op" id="3677112">)</span>&nbsp;<span class="ident" id="3677114">dialConn</span><span class="op" id="3677122">(</span><span class="ident" id="3677123">cm</span>&nbsp;<span class="ident" id="3677126">connectMethod</span><span class="op" id="3677139">)</span>&nbsp;<span class="op" id="3677141">(</span><span class="op" id="3677142">*</span><span class="ident" id="3677143">persistConn</span><span class="op" id="3677154">,</span>&nbsp;<span class="builtintype" id="3677156">error</span><span class="op" id="3677161">)</span>&nbsp;<span class="op" id="3677163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677166">pconn</span>&nbsp;<span class="op" id="3677172">:=</span>&nbsp;<span class="op" id="3677175">&amp;</span><span class="ident" id="3677176">persistConn</span><span class="op" id="3677187">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677191">t</span><span class="op" id="3677192">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3677203">t</span><span class="op" id="3677204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677208">cacheKey</span><span class="op" id="3677216">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3677220">cm</span><span class="op" id="3677222">.</span><span class="ident" id="3677223">key</span><span class="op" id="3677226">(</span><span class="op" id="3677227">)</span><span class="op" id="3677228">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677232">reqch</span><span class="op" id="3677237">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3677244">make</span><span class="op" id="3677248">(</span><span class="keyword" id="3677249">chan</span>&nbsp;<span class="ident" id="3677254">requestAndChan</span><span class="op" id="3677268">,</span>&nbsp;<span class="num" id="3677270">1</span><span class="op" id="3677271">)</span><span class="op" id="3677272">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677276">writech</span><span class="op" id="3677283">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3677288">make</span><span class="op" id="3677292">(</span><span class="keyword" id="3677293">chan</span>&nbsp;<span class="ident" id="3677298">writeRequest</span><span class="op" id="3677310">,</span>&nbsp;<span class="num" id="3677312">1</span><span class="op" id="3677313">)</span><span class="op" id="3677314">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677318">closech</span><span class="op" id="3677325">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3677330">make</span><span class="op" id="3677334">(</span><span class="keyword" id="3677335">chan</span>&nbsp;<span class="keyword" id="3677340">struct</span><span class="op" id="3677346">{</span><span class="op" id="3677347">}</span><span class="op" id="3677348">)</span><span class="op" id="3677349">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677353">writeErrCh</span><span class="op" id="3677363">:</span>&nbsp;<span class="builtinfunc" id="3677365">make</span><span class="op" id="3677369">(</span><span class="keyword" id="3677370">chan</span>&nbsp;<span class="builtintype" id="3677375">error</span><span class="op" id="3677380">,</span>&nbsp;<span class="num" id="3677382">1</span><span class="op" id="3677383">)</span><span class="op" id="3677384">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677390">tlsDial</span>&nbsp;<span class="op" id="3677398">:=</span>&nbsp;<span class="ident" id="3677401">t</span><span class="op" id="3677402">.</span><span class="ident" id="3677403">DialTLS</span>&nbsp;<span class="op" id="3677411">!=</span>&nbsp;<span class="ident" id="3677414">nil</span>&nbsp;<span class="op" id="3677418">&amp;&amp;</span>&nbsp;<span class="ident" id="3677421">cm</span><span class="op" id="3677423">.</span><span class="ident" id="3677424">targetScheme</span>&nbsp;<span class="op" id="3677437">==</span>&nbsp;<span class="string" id="3677440">&#34;https&#34;</span>&nbsp;<span class="op" id="3677448">&amp;&amp;</span>&nbsp;<span class="ident" id="3677451">cm</span><span class="op" id="3677453">.</span><span class="ident" id="3677454">proxyURL</span>&nbsp;<span class="op" id="3677463">==</span>&nbsp;<span class="ident" id="3677466">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677471">if</span>&nbsp;<span class="ident" id="3677474">tlsDial</span>&nbsp;<span class="op" id="3677482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677486">var</span>&nbsp;<span class="ident" id="3677490">err</span>&nbsp;<span class="builtintype" id="3677494">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677502">pconn</span><span class="op" id="3677507">.</span><span class="ident" id="3677508">conn</span><span class="op" id="3677512">,</span>&nbsp;<span class="ident" id="3677514">err</span>&nbsp;<span class="op" id="3677518">=</span>&nbsp;<span class="ident" id="3677520">t</span><span class="op" id="3677521">.</span><span class="ident" id="3677522">DialTLS</span><span class="op" id="3677529">(</span><span class="string" id="3677530">&#34;tcp&#34;</span><span class="op" id="3677535">,</span>&nbsp;<span class="ident" id="3677537">cm</span><span class="op" id="3677539">.</span><span class="ident" id="3677540">addr</span><span class="op" id="3677544">(</span><span class="op" id="3677545">)</span><span class="op" id="3677546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677550">if</span>&nbsp;<span class="ident" id="3677553">err</span>&nbsp;<span class="op" id="3677557">!=</span>&nbsp;<span class="ident" id="3677560">nil</span>&nbsp;<span class="op" id="3677564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677569">return</span>&nbsp;<span class="ident" id="3677576">nil</span><span class="op" id="3677579">,</span>&nbsp;<span class="ident" id="3677581">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677591">if</span>&nbsp;<span class="ident" id="3677594">tc</span><span class="op" id="3677596">,</span>&nbsp;<span class="ident" id="3677598">ok</span>&nbsp;<span class="op" id="3677601">:=</span>&nbsp;<span class="ident" id="3677604">pconn</span><span class="op" id="3677609">.</span><span class="ident" id="3677610">conn</span><span class="op" id="3677614">.</span><span class="op" id="3677615">(</span><span class="op" id="3677616">*</span><span class="ident" id="3677617">tls</span><span class="op" id="3677620">.</span><span class="ident" id="3677621">Conn</span><span class="op" id="3677625">)</span><span class="op" id="3677626">;</span>&nbsp;<span class="ident" id="3677628">ok</span>&nbsp;<span class="op" id="3677631">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677636">cs</span>&nbsp;<span class="op" id="3677639">:=</span>&nbsp;<span class="ident" id="3677642">tc</span><span class="op" id="3677644">.</span><span class="ident" id="3677645">ConnectionState</span><span class="op" id="3677660">(</span><span class="op" id="3677661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677666">pconn</span><span class="op" id="3677671">.</span><span class="ident" id="3677672">tlsState</span>&nbsp;<span class="op" id="3677681">=</span>&nbsp;<span class="op" id="3677683">&amp;</span><span class="ident" id="3677684">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677692">}</span>&nbsp;<span class="keyword" id="3677694">else</span>&nbsp;<span class="op" id="3677699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677703">conn</span><span class="op" id="3677707">,</span>&nbsp;<span class="ident" id="3677709">err</span>&nbsp;<span class="op" id="3677713">:=</span>&nbsp;<span class="ident" id="3677716">t</span><span class="op" id="3677717">.</span><span class="ident" id="3677718">dial</span><span class="op" id="3677722">(</span><span class="string" id="3677723">&#34;tcp&#34;</span><span class="op" id="3677728">,</span>&nbsp;<span class="ident" id="3677730">cm</span><span class="op" id="3677732">.</span><span class="ident" id="3677733">addr</span><span class="op" id="3677737">(</span><span class="op" id="3677738">)</span><span class="op" id="3677739">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677743">if</span>&nbsp;<span class="ident" id="3677746">err</span>&nbsp;<span class="op" id="3677750">!=</span>&nbsp;<span class="ident" id="3677753">nil</span>&nbsp;<span class="op" id="3677757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677762">if</span>&nbsp;<span class="ident" id="3677765">cm</span><span class="op" id="3677767">.</span><span class="ident" id="3677768">proxyURL</span>&nbsp;<span class="op" id="3677777">!=</span>&nbsp;<span class="ident" id="3677780">nil</span>&nbsp;<span class="op" id="3677784">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677790">err</span>&nbsp;<span class="op" id="3677794">=</span>&nbsp;<span class="ident" id="3677796">fmt</span><span class="op" id="3677799">.</span><span class="ident" id="3677800">Errorf</span><span class="op" id="3677806">(</span><span class="string" id="3677807">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3677847">,</span>&nbsp;<span class="ident" id="3677849">cm</span><span class="op" id="3677851">.</span><span class="ident" id="3677852">proxyURL</span><span class="op" id="3677860">,</span>&nbsp;<span class="ident" id="3677862">err</span><span class="op" id="3677865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677870">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677875">return</span>&nbsp;<span class="ident" id="3677882">nil</span><span class="op" id="3677885">,</span>&nbsp;<span class="ident" id="3677887">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3677897">pconn</span><span class="op" id="3677902">.</span><span class="ident" id="3677903">conn</span>&nbsp;<span class="op" id="3677908">=</span>&nbsp;<span class="ident" id="3677910">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3677916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677920">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677937">switch</span>&nbsp;<span class="op" id="3677944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3677947">case</span>&nbsp;<span class="ident" id="3677952">cm</span><span class="op" id="3677954">.</span><span class="ident" id="3677955">proxyURL</span>&nbsp;<span class="op" id="3677964">==</span>&nbsp;<span class="ident" id="3677967">nil</span><span class="op" id="3677970">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3677974">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678009">case</span>&nbsp;<span class="ident" id="3678014">cm</span><span class="op" id="3678016">.</span><span class="ident" id="3678017">targetScheme</span>&nbsp;<span class="op" id="3678030">==</span>&nbsp;<span class="string" id="3678033">&#34;http&#34;</span><span class="op" id="3678039">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678043">pconn</span><span class="op" id="3678048">.</span><span class="ident" id="3678049">isProxy</span>&nbsp;<span class="op" id="3678057">=</span>&nbsp;<span class="ident" id="3678059">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678066">if</span>&nbsp;<span class="ident" id="3678069">pa</span>&nbsp;<span class="op" id="3678072">:=</span>&nbsp;<span class="ident" id="3678075">cm</span><span class="op" id="3678077">.</span><span class="ident" id="3678078">proxyAuth</span><span class="op" id="3678087">(</span><span class="op" id="3678088">)</span><span class="op" id="3678089">;</span>&nbsp;<span class="ident" id="3678091">pa</span>&nbsp;<span class="op" id="3678094">!=</span>&nbsp;<span class="string" id="3678097">&#34;&#34;</span>&nbsp;<span class="op" id="3678100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678105">pconn</span><span class="op" id="3678110">.</span><span class="ident" id="3678111">mutateHeaderFunc</span>&nbsp;<span class="op" id="3678128">=</span>&nbsp;<span class="keyword" id="3678130">func</span><span class="op" id="3678134">(</span><span class="ident" id="3678135">h</span>&nbsp;<span class="ident" id="3678137">Header</span><span class="op" id="3678143">)</span>&nbsp;<span class="op" id="3678145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678151">h</span><span class="op" id="3678152">.</span><span class="ident" id="3678153">Set</span><span class="op" id="3678156">(</span><span class="string" id="3678157">&#34;Proxy-Authorization&#34;</span><span class="op" id="3678178">,</span>&nbsp;<span class="ident" id="3678180">pa</span><span class="op" id="3678182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678191">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678194">case</span>&nbsp;<span class="ident" id="3678199">cm</span><span class="op" id="3678201">.</span><span class="ident" id="3678202">targetScheme</span>&nbsp;<span class="op" id="3678215">==</span>&nbsp;<span class="string" id="3678218">&#34;https&#34;</span><span class="op" id="3678225">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678229">conn</span>&nbsp;<span class="op" id="3678234">:=</span>&nbsp;<span class="ident" id="3678237">pconn</span><span class="op" id="3678242">.</span><span class="ident" id="3678243">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678250">connectReq</span>&nbsp;<span class="op" id="3678261">:=</span>&nbsp;<span class="op" id="3678264">&amp;</span><span class="ident" id="3678265">Request</span><span class="op" id="3678272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678277">Method</span><span class="op" id="3678283">:</span>&nbsp;<span class="string" id="3678285">&#34;CONNECT&#34;</span><span class="op" id="3678294">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678299">URL</span><span class="op" id="3678302">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3678307">&amp;</span><span class="ident" id="3678308">url</span><span class="op" id="3678311">.</span><span class="ident" id="3678312">URL</span><span class="op" id="3678315">{</span><span class="ident" id="3678316">Opaque</span><span class="op" id="3678322">:</span>&nbsp;<span class="ident" id="3678324">cm</span><span class="op" id="3678326">.</span><span class="ident" id="3678327">targetAddr</span><span class="op" id="3678337">}</span><span class="op" id="3678338">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678343">Host</span><span class="op" id="3678347">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3678351">cm</span><span class="op" id="3678353">.</span><span class="ident" id="3678354">targetAddr</span><span class="op" id="3678364">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678369">Header</span><span class="op" id="3678375">:</span>&nbsp;<span class="builtinfunc" id="3678377">make</span><span class="op" id="3678381">(</span><span class="ident" id="3678382">Header</span><span class="op" id="3678388">)</span><span class="op" id="3678389">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678397">if</span>&nbsp;<span class="ident" id="3678400">pa</span>&nbsp;<span class="op" id="3678403">:=</span>&nbsp;<span class="ident" id="3678406">cm</span><span class="op" id="3678408">.</span><span class="ident" id="3678409">proxyAuth</span><span class="op" id="3678418">(</span><span class="op" id="3678419">)</span><span class="op" id="3678420">;</span>&nbsp;<span class="ident" id="3678422">pa</span>&nbsp;<span class="op" id="3678425">!=</span>&nbsp;<span class="string" id="3678428">&#34;&#34;</span>&nbsp;<span class="op" id="3678431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678436">connectReq</span><span class="op" id="3678446">.</span><span class="ident" id="3678447">Header</span><span class="op" id="3678453">.</span><span class="ident" id="3678454">Set</span><span class="op" id="3678457">(</span><span class="string" id="3678458">&#34;Proxy-Authorization&#34;</span><span class="op" id="3678479">,</span>&nbsp;<span class="ident" id="3678481">pa</span><span class="op" id="3678483">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678491">connectReq</span><span class="op" id="3678501">.</span><span class="ident" id="3678502">Write</span><span class="op" id="3678507">(</span><span class="ident" id="3678508">conn</span><span class="op" id="3678512">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678517">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678537">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678596">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678644">br</span>&nbsp;<span class="op" id="3678647">:=</span>&nbsp;<span class="ident" id="3678650">bufio</span><span class="op" id="3678655">.</span><span class="ident" id="3678656">NewReader</span><span class="op" id="3678665">(</span><span class="ident" id="3678666">conn</span><span class="op" id="3678670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678674">resp</span><span class="op" id="3678678">,</span>&nbsp;<span class="ident" id="3678680">err</span>&nbsp;<span class="op" id="3678684">:=</span>&nbsp;<span class="ident" id="3678687">ReadResponse</span><span class="op" id="3678699">(</span><span class="ident" id="3678700">br</span><span class="op" id="3678702">,</span>&nbsp;<span class="ident" id="3678704">connectReq</span><span class="op" id="3678714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678718">if</span>&nbsp;<span class="ident" id="3678721">err</span>&nbsp;<span class="op" id="3678725">!=</span>&nbsp;<span class="ident" id="3678728">nil</span>&nbsp;<span class="op" id="3678732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678737">conn</span><span class="op" id="3678741">.</span><span class="ident" id="3678742">Close</span><span class="op" id="3678747">(</span><span class="op" id="3678748">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678753">return</span>&nbsp;<span class="ident" id="3678760">nil</span><span class="op" id="3678763">,</span>&nbsp;<span class="ident" id="3678765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678775">if</span>&nbsp;<span class="ident" id="3678778">resp</span><span class="op" id="3678782">.</span><span class="ident" id="3678783">StatusCode</span>&nbsp;<span class="op" id="3678794">!=</span>&nbsp;<span class="num" id="3678797">200</span>&nbsp;<span class="op" id="3678801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678806">f</span>&nbsp;<span class="op" id="3678808">:=</span>&nbsp;<span class="ident" id="3678811">strings</span><span class="op" id="3678818">.</span><span class="ident" id="3678819">SplitN</span><span class="op" id="3678825">(</span><span class="ident" id="3678826">resp</span><span class="op" id="3678830">.</span><span class="ident" id="3678831">Status</span><span class="op" id="3678837">,</span>&nbsp;<span class="string" id="3678839">&#34;&nbsp;&#34;</span><span class="op" id="3678842">,</span>&nbsp;<span class="num" id="3678844">2</span><span class="op" id="3678845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3678850">conn</span><span class="op" id="3678854">.</span><span class="ident" id="3678855">Close</span><span class="op" id="3678860">(</span><span class="op" id="3678861">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678866">return</span>&nbsp;<span class="ident" id="3678873">nil</span><span class="op" id="3678876">,</span>&nbsp;<span class="ident" id="3678878">errors</span><span class="op" id="3678884">.</span><span class="ident" id="3678885">New</span><span class="op" id="3678888">(</span><span class="ident" id="3678889">f</span><span class="op" id="3678890">[</span><span class="num" id="3678891">1</span><span class="op" id="3678892">]</span><span class="op" id="3678893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3678900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3678904">if</span>&nbsp;<span class="ident" id="3678907">cm</span><span class="op" id="3678909">.</span><span class="ident" id="3678910">targetScheme</span>&nbsp;<span class="op" id="3678923">==</span>&nbsp;<span class="string" id="3678926">&#34;https&#34;</span>&nbsp;<span class="op" id="3678934">&amp;&amp;</span>&nbsp;<span class="op" id="3678937">!</span><span class="ident" id="3678938">tlsDial</span>&nbsp;<span class="op" id="3678946">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3678950">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679016">cfg</span>&nbsp;<span class="op" id="3679020">:=</span>&nbsp;<span class="ident" id="3679023">t</span><span class="op" id="3679024">.</span><span class="ident" id="3679025">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679043">if</span>&nbsp;<span class="ident" id="3679046">cfg</span>&nbsp;<span class="op" id="3679050">==</span>&nbsp;<span class="ident" id="3679053">nil</span>&nbsp;<span class="op" id="3679057">||</span>&nbsp;<span class="ident" id="3679060">cfg</span><span class="op" id="3679063">.</span><span class="ident" id="3679064">ServerName</span>&nbsp;<span class="op" id="3679075">==</span>&nbsp;<span class="string" id="3679078">&#34;&#34;</span>&nbsp;<span class="op" id="3679081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679086">host</span>&nbsp;<span class="op" id="3679091">:=</span>&nbsp;<span class="ident" id="3679094">cm</span><span class="op" id="3679096">.</span><span class="ident" id="3679097">tlsHost</span><span class="op" id="3679104">(</span><span class="op" id="3679105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679110">if</span>&nbsp;<span class="ident" id="3679113">cfg</span>&nbsp;<span class="op" id="3679117">==</span>&nbsp;<span class="ident" id="3679120">nil</span>&nbsp;<span class="op" id="3679124">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679130">cfg</span>&nbsp;<span class="op" id="3679134">=</span>&nbsp;<span class="op" id="3679136">&amp;</span><span class="ident" id="3679137">tls</span><span class="op" id="3679140">.</span><span class="ident" id="3679141">Config</span><span class="op" id="3679147">{</span><span class="ident" id="3679148">ServerName</span><span class="op" id="3679158">:</span>&nbsp;<span class="ident" id="3679160">host</span><span class="op" id="3679164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679169">}</span>&nbsp;<span class="keyword" id="3679171">else</span>&nbsp;<span class="op" id="3679176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679182">clone</span>&nbsp;<span class="op" id="3679188">:=</span>&nbsp;<span class="op" id="3679191">*</span><span class="ident" id="3679192">cfg</span>&nbsp;<span class="comment" id="3679196">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679217">clone</span><span class="op" id="3679222">.</span><span class="ident" id="3679223">ServerName</span>&nbsp;<span class="op" id="3679234">=</span>&nbsp;<span class="ident" id="3679236">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679245">cfg</span>&nbsp;<span class="op" id="3679249">=</span>&nbsp;<span class="op" id="3679251">&amp;</span><span class="ident" id="3679252">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679269">plainConn</span>&nbsp;<span class="op" id="3679279">:=</span>&nbsp;<span class="ident" id="3679282">pconn</span><span class="op" id="3679287">.</span><span class="ident" id="3679288">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679295">tlsConn</span>&nbsp;<span class="op" id="3679303">:=</span>&nbsp;<span class="ident" id="3679306">tls</span><span class="op" id="3679309">.</span><span class="ident" id="3679310">Client</span><span class="op" id="3679316">(</span><span class="ident" id="3679317">plainConn</span><span class="op" id="3679326">,</span>&nbsp;<span class="ident" id="3679328">cfg</span><span class="op" id="3679331">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679335">errc</span>&nbsp;<span class="op" id="3679340">:=</span>&nbsp;<span class="builtinfunc" id="3679343">make</span><span class="op" id="3679347">(</span><span class="keyword" id="3679348">chan</span>&nbsp;<span class="builtintype" id="3679353">error</span><span class="op" id="3679358">,</span>&nbsp;<span class="num" id="3679360">2</span><span class="op" id="3679361">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679365">var</span>&nbsp;<span class="ident" id="3679369">timer</span>&nbsp;<span class="op" id="3679375">*</span><span class="ident" id="3679376">time</span><span class="op" id="3679380">.</span><span class="ident" id="3679381">Timer</span>&nbsp;<span class="comment" id="3679387">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679420">if</span>&nbsp;<span class="ident" id="3679423">d</span>&nbsp;<span class="op" id="3679425">:=</span>&nbsp;<span class="ident" id="3679428">t</span><span class="op" id="3679429">.</span><span class="ident" id="3679430">TLSHandshakeTimeout</span><span class="op" id="3679449">;</span>&nbsp;<span class="ident" id="3679451">d</span>&nbsp;<span class="op" id="3679453">!=</span>&nbsp;<span class="num" id="3679456">0</span>&nbsp;<span class="op" id="3679458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679463">timer</span>&nbsp;<span class="op" id="3679469">=</span>&nbsp;<span class="ident" id="3679471">time</span><span class="op" id="3679475">.</span><span class="ident" id="3679476">AfterFunc</span><span class="op" id="3679485">(</span><span class="ident" id="3679486">d</span><span class="op" id="3679487">,</span>&nbsp;<span class="keyword" id="3679489">func</span><span class="op" id="3679493">(</span><span class="op" id="3679494">)</span>&nbsp;<span class="op" id="3679496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679502">errc</span>&nbsp;<span class="op" id="3679507">&lt;-</span>&nbsp;<span class="ident" id="3679510">tlsHandshakeTimeoutError</span><span class="op" id="3679534">{</span><span class="op" id="3679535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679540">}</span><span class="op" id="3679541">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679549">go</span>&nbsp;<span class="keyword" id="3679552">func</span><span class="op" id="3679556">(</span><span class="op" id="3679557">)</span>&nbsp;<span class="op" id="3679559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679564">err</span>&nbsp;<span class="op" id="3679568">:=</span>&nbsp;<span class="ident" id="3679571">tlsConn</span><span class="op" id="3679578">.</span><span class="ident" id="3679579">Handshake</span><span class="op" id="3679588">(</span><span class="op" id="3679589">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679594">if</span>&nbsp;<span class="ident" id="3679597">timer</span>&nbsp;<span class="op" id="3679603">!=</span>&nbsp;<span class="ident" id="3679606">nil</span>&nbsp;<span class="op" id="3679610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679616">timer</span><span class="op" id="3679621">.</span><span class="ident" id="3679622">Stop</span><span class="op" id="3679626">(</span><span class="op" id="3679627">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679637">errc</span>&nbsp;<span class="op" id="3679642">&lt;-</span>&nbsp;<span class="ident" id="3679645">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679651">}</span><span class="op" id="3679652">(</span><span class="op" id="3679653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679657">if</span>&nbsp;<span class="ident" id="3679660">err</span>&nbsp;<span class="op" id="3679664">:=</span>&nbsp;<span class="op" id="3679667">&lt;-</span><span class="ident" id="3679669">errc</span><span class="op" id="3679673">;</span>&nbsp;<span class="ident" id="3679675">err</span>&nbsp;<span class="op" id="3679679">!=</span>&nbsp;<span class="ident" id="3679682">nil</span>&nbsp;<span class="op" id="3679686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679691">plainConn</span><span class="op" id="3679700">.</span><span class="ident" id="3679701">Close</span><span class="op" id="3679706">(</span><span class="op" id="3679707">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679712">return</span>&nbsp;<span class="ident" id="3679719">nil</span><span class="op" id="3679722">,</span>&nbsp;<span class="ident" id="3679724">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679734">if</span>&nbsp;<span class="op" id="3679737">!</span><span class="ident" id="3679738">cfg</span><span class="op" id="3679741">.</span><span class="ident" id="3679742">InsecureSkipVerify</span>&nbsp;<span class="op" id="3679761">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679766">if</span>&nbsp;<span class="ident" id="3679769">err</span>&nbsp;<span class="op" id="3679773">:=</span>&nbsp;<span class="ident" id="3679776">tlsConn</span><span class="op" id="3679783">.</span><span class="ident" id="3679784">VerifyHostname</span><span class="op" id="3679798">(</span><span class="ident" id="3679799">cfg</span><span class="op" id="3679802">.</span><span class="ident" id="3679803">ServerName</span><span class="op" id="3679813">)</span><span class="op" id="3679814">;</span>&nbsp;<span class="ident" id="3679816">err</span>&nbsp;<span class="op" id="3679820">!=</span>&nbsp;<span class="ident" id="3679823">nil</span>&nbsp;<span class="op" id="3679827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679833">plainConn</span><span class="op" id="3679842">.</span><span class="ident" id="3679843">Close</span><span class="op" id="3679848">(</span><span class="op" id="3679849">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3679855">return</span>&nbsp;<span class="ident" id="3679862">nil</span><span class="op" id="3679865">,</span>&nbsp;<span class="ident" id="3679867">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679874">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679882">cs</span>&nbsp;<span class="op" id="3679885">:=</span>&nbsp;<span class="ident" id="3679888">tlsConn</span><span class="op" id="3679895">.</span><span class="ident" id="3679896">ConnectionState</span><span class="op" id="3679911">(</span><span class="op" id="3679912">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679916">pconn</span><span class="op" id="3679921">.</span><span class="ident" id="3679922">tlsState</span>&nbsp;<span class="op" id="3679931">=</span>&nbsp;<span class="op" id="3679933">&amp;</span><span class="ident" id="3679934">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679939">pconn</span><span class="op" id="3679944">.</span><span class="ident" id="3679945">conn</span>&nbsp;<span class="op" id="3679950">=</span>&nbsp;<span class="ident" id="3679952">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3679961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3679965">pconn</span><span class="op" id="3679970">.</span><span class="ident" id="3679971">br</span>&nbsp;<span class="op" id="3679974">=</span>&nbsp;<span class="ident" id="3679976">bufio</span><span class="op" id="3679981">.</span><span class="ident" id="3679982">NewReader</span><span class="op" id="3679991">(</span><span class="ident" id="3679992">noteEOFReader</span><span class="op" id="3680005">{</span><span class="ident" id="3680006">pconn</span><span class="op" id="3680011">.</span><span class="ident" id="3680012">conn</span><span class="op" id="3680016">,</span>&nbsp;<span class="op" id="3680018">&amp;</span><span class="ident" id="3680019">pconn</span><span class="op" id="3680024">.</span><span class="ident" id="3680025">sawEOF</span><span class="op" id="3680031">}</span><span class="op" id="3680032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680035">pconn</span><span class="op" id="3680040">.</span><span class="ident" id="3680041">bw</span>&nbsp;<span class="op" id="3680044">=</span>&nbsp;<span class="ident" id="3680046">bufio</span><span class="op" id="3680051">.</span><span class="ident" id="3680052">NewWriter</span><span class="op" id="3680061">(</span><span class="ident" id="3680062">pconn</span><span class="op" id="3680067">.</span><span class="ident" id="3680068">conn</span><span class="op" id="3680072">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680075">go</span>&nbsp;<span class="ident" id="3680078">pconn</span><span class="op" id="3680083">.</span><span class="ident" id="3680084">readLoop</span><span class="op" id="3680092">(</span><span class="op" id="3680093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680096">go</span>&nbsp;<span class="ident" id="3680099">pconn</span><span class="op" id="3680104">.</span><span class="ident" id="3680105">writeLoop</span><span class="op" id="3680114">(</span><span class="op" id="3680115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680118">return</span>&nbsp;<span class="ident" id="3680125">pconn</span><span class="op" id="3680130">,</span>&nbsp;<span class="ident" id="3680132">nil</span><br>
<span class="lineno"></span><span class="op" id="3680136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3680139">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3680204">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3680267">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3680323">func</span>&nbsp;<span class="ident" id="3680328">useProxy</span><span class="op" id="3680336">(</span><span class="ident" id="3680337">addr</span>&nbsp;<span class="builtintype" id="3680342">string</span><span class="op" id="3680348">)</span>&nbsp;<span class="builtintype" id="3680350">bool</span>&nbsp;<span class="op" id="3680355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680358">if</span>&nbsp;<span class="builtinfunc" id="3680361">len</span><span class="op" id="3680364">(</span><span class="ident" id="3680365">addr</span><span class="op" id="3680369">)</span>&nbsp;<span class="op" id="3680371">==</span>&nbsp;<span class="num" id="3680374">0</span>&nbsp;<span class="op" id="3680376">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680380">return</span>&nbsp;<span class="ident" id="3680387">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680393">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680396">host</span><span class="op" id="3680400">,</span>&nbsp;<span class="ident" id="3680402">_</span><span class="op" id="3680403">,</span>&nbsp;<span class="ident" id="3680405">err</span>&nbsp;<span class="op" id="3680409">:=</span>&nbsp;<span class="ident" id="3680412">net</span><span class="op" id="3680415">.</span><span class="ident" id="3680416">SplitHostPort</span><span class="op" id="3680429">(</span><span class="ident" id="3680430">addr</span><span class="op" id="3680434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680437">if</span>&nbsp;<span class="ident" id="3680440">err</span>&nbsp;<span class="op" id="3680444">!=</span>&nbsp;<span class="ident" id="3680447">nil</span>&nbsp;<span class="op" id="3680451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680455">return</span>&nbsp;<span class="ident" id="3680462">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680472">if</span>&nbsp;<span class="ident" id="3680475">host</span>&nbsp;<span class="op" id="3680480">==</span>&nbsp;<span class="string" id="3680483">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3680495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680499">return</span>&nbsp;<span class="ident" id="3680506">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680516">if</span>&nbsp;<span class="ident" id="3680519">ip</span>&nbsp;<span class="op" id="3680522">:=</span>&nbsp;<span class="ident" id="3680525">net</span><span class="op" id="3680528">.</span><span class="ident" id="3680529">ParseIP</span><span class="op" id="3680536">(</span><span class="ident" id="3680537">host</span><span class="op" id="3680541">)</span><span class="op" id="3680542">;</span>&nbsp;<span class="ident" id="3680544">ip</span>&nbsp;<span class="op" id="3680547">!=</span>&nbsp;<span class="ident" id="3680550">nil</span>&nbsp;<span class="op" id="3680554">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680558">if</span>&nbsp;<span class="ident" id="3680561">ip</span><span class="op" id="3680563">.</span><span class="ident" id="3680564">IsLoopback</span><span class="op" id="3680574">(</span><span class="op" id="3680575">)</span>&nbsp;<span class="op" id="3680577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680582">return</span>&nbsp;<span class="ident" id="3680589">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680604">no_proxy</span>&nbsp;<span class="op" id="3680613">:=</span>&nbsp;<span class="ident" id="3680616">noProxyEnv</span><span class="op" id="3680626">.</span><span class="ident" id="3680627">Get</span><span class="op" id="3680630">(</span><span class="op" id="3680631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680634">if</span>&nbsp;<span class="ident" id="3680637">no_proxy</span>&nbsp;<span class="op" id="3680646">==</span>&nbsp;<span class="string" id="3680649">&#34;*&#34;</span>&nbsp;<span class="op" id="3680653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680657">return</span>&nbsp;<span class="ident" id="3680664">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680675">addr</span>&nbsp;<span class="op" id="3680680">=</span>&nbsp;<span class="ident" id="3680682">strings</span><span class="op" id="3680689">.</span><span class="ident" id="3680690">ToLower</span><span class="op" id="3680697">(</span><span class="ident" id="3680698">strings</span><span class="op" id="3680705">.</span><span class="ident" id="3680706">TrimSpace</span><span class="op" id="3680715">(</span><span class="ident" id="3680716">addr</span><span class="op" id="3680720">)</span><span class="op" id="3680721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680724">if</span>&nbsp;<span class="ident" id="3680727">hasPort</span><span class="op" id="3680734">(</span><span class="ident" id="3680735">addr</span><span class="op" id="3680739">)</span>&nbsp;<span class="op" id="3680741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680745">addr</span>&nbsp;<span class="op" id="3680750">=</span>&nbsp;<span class="ident" id="3680752">addr</span><span class="op" id="3680756">[</span><span class="op" id="3680757">:</span><span class="ident" id="3680758">strings</span><span class="op" id="3680765">.</span><span class="ident" id="3680766">LastIndex</span><span class="op" id="3680775">(</span><span class="ident" id="3680776">addr</span><span class="op" id="3680780">,</span>&nbsp;<span class="string" id="3680782">&#34;:&#34;</span><span class="op" id="3680785">)</span><span class="op" id="3680786">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680793">for</span>&nbsp;<span class="ident" id="3680797">_</span><span class="op" id="3680798">,</span>&nbsp;<span class="ident" id="3680800">p</span>&nbsp;<span class="op" id="3680802">:=</span>&nbsp;<span class="keyword" id="3680805">range</span>&nbsp;<span class="ident" id="3680811">strings</span><span class="op" id="3680818">.</span><span class="ident" id="3680819">Split</span><span class="op" id="3680824">(</span><span class="ident" id="3680825">no_proxy</span><span class="op" id="3680833">,</span>&nbsp;<span class="string" id="3680835">&#34;,&#34;</span><span class="op" id="3680838">)</span>&nbsp;<span class="op" id="3680840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680844">p</span>&nbsp;<span class="op" id="3680846">=</span>&nbsp;<span class="ident" id="3680848">strings</span><span class="op" id="3680855">.</span><span class="ident" id="3680856">ToLower</span><span class="op" id="3680863">(</span><span class="ident" id="3680864">strings</span><span class="op" id="3680871">.</span><span class="ident" id="3680872">TrimSpace</span><span class="op" id="3680881">(</span><span class="ident" id="3680882">p</span><span class="op" id="3680883">)</span><span class="op" id="3680884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680888">if</span>&nbsp;<span class="builtinfunc" id="3680891">len</span><span class="op" id="3680894">(</span><span class="ident" id="3680895">p</span><span class="op" id="3680896">)</span>&nbsp;<span class="op" id="3680898">==</span>&nbsp;<span class="num" id="3680901">0</span>&nbsp;<span class="op" id="3680903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680908">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680919">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680923">if</span>&nbsp;<span class="ident" id="3680926">hasPort</span><span class="op" id="3680933">(</span><span class="ident" id="3680934">p</span><span class="op" id="3680935">)</span>&nbsp;<span class="op" id="3680937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3680942">p</span>&nbsp;<span class="op" id="3680944">=</span>&nbsp;<span class="ident" id="3680946">p</span><span class="op" id="3680947">[</span><span class="op" id="3680948">:</span><span class="ident" id="3680949">strings</span><span class="op" id="3680956">.</span><span class="ident" id="3680957">LastIndex</span><span class="op" id="3680966">(</span><span class="ident" id="3680967">p</span><span class="op" id="3680968">,</span>&nbsp;<span class="string" id="3680970">&#34;:&#34;</span><span class="op" id="3680973">)</span><span class="op" id="3680974">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3680978">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3680982">if</span>&nbsp;<span class="ident" id="3680985">addr</span>&nbsp;<span class="op" id="3680990">==</span>&nbsp;<span class="ident" id="3680993">p</span>&nbsp;<span class="op" id="3680995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681000">return</span>&nbsp;<span class="ident" id="3681007">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681019">if</span>&nbsp;<span class="ident" id="3681022">p</span><span class="op" id="3681023">[</span><span class="num" id="3681024">0</span><span class="op" id="3681025">]</span>&nbsp;<span class="op" id="3681027">==</span>&nbsp;<span class="string" id="3681030">&#39;.&#39;</span>&nbsp;<span class="op" id="3681034">&amp;&amp;</span>&nbsp;<span class="op" id="3681037">(</span><span class="ident" id="3681038">strings</span><span class="op" id="3681045">.</span><span class="ident" id="3681046">HasSuffix</span><span class="op" id="3681055">(</span><span class="ident" id="3681056">addr</span><span class="op" id="3681060">,</span>&nbsp;<span class="ident" id="3681062">p</span><span class="op" id="3681063">)</span>&nbsp;<span class="op" id="3681065">||</span>&nbsp;<span class="ident" id="3681068">addr</span>&nbsp;<span class="op" id="3681073">==</span>&nbsp;<span class="ident" id="3681076">p</span><span class="op" id="3681077">[</span><span class="num" id="3681078">1</span><span class="op" id="3681079">:</span><span class="op" id="3681080">]</span><span class="op" id="3681081">)</span>&nbsp;<span class="op" id="3681083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3681088">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681149">return</span>&nbsp;<span class="ident" id="3681156">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681164">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681168">if</span>&nbsp;<span class="ident" id="3681171">p</span><span class="op" id="3681172">[</span><span class="num" id="3681173">0</span><span class="op" id="3681174">]</span>&nbsp;<span class="op" id="3681176">!=</span>&nbsp;<span class="string" id="3681179">&#39;.&#39;</span>&nbsp;<span class="op" id="3681183">&amp;&amp;</span>&nbsp;<span class="ident" id="3681186">strings</span><span class="op" id="3681193">.</span><span class="ident" id="3681194">HasSuffix</span><span class="op" id="3681203">(</span><span class="ident" id="3681204">addr</span><span class="op" id="3681208">,</span>&nbsp;<span class="ident" id="3681210">p</span><span class="op" id="3681211">)</span>&nbsp;<span class="op" id="3681213">&amp;&amp;</span>&nbsp;<span class="ident" id="3681216">addr</span><span class="op" id="3681220">[</span><span class="builtinfunc" id="3681221">len</span><span class="op" id="3681224">(</span><span class="ident" id="3681225">addr</span><span class="op" id="3681229">)</span><span class="op" id="3681230">-</span><span class="builtinfunc" id="3681231">len</span><span class="op" id="3681234">(</span><span class="ident" id="3681235">p</span><span class="op" id="3681236">)</span><span class="op" id="3681237">-</span><span class="num" id="3681238">1</span><span class="op" id="3681239">]</span>&nbsp;<span class="op" id="3681241">==</span>&nbsp;<span class="string" id="3681244">&#39;.&#39;</span>&nbsp;<span class="op" id="3681248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3681253">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681300">return</span>&nbsp;<span class="ident" id="3681307">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681315">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3681318">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3681321">return</span>&nbsp;<span class="ident" id="3681328">true</span><br>
<span class="lineno"></span><span class="op" id="3681333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3681336">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3681412">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3681467">//</span><br>
<span class="lineno"></span><span class="comment" id="3681470">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3681521">//</span><br>
<span class="lineno"></span><span class="comment" id="3681524">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3681569">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3681628">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3681695">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3681763">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3681837">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3681915">//</span><br>
<span class="lineno">730</span><span class="comment" id="3681918">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3681965">//</span><br>
<span class="lineno"></span><span class="keyword" id="3681968">type</span>&nbsp;<span class="ident" id="3681973">connectMethod</span>&nbsp;<span class="keyword" id="3681987">struct</span>&nbsp;<span class="op" id="3681994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3681997">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3682010">*</span><span class="ident" id="3682011">url</span><span class="op" id="3682014">.</span><span class="ident" id="3682015">URL</span>&nbsp;<span class="comment" id="3682019">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682061">targetScheme</span>&nbsp;<span class="builtintype" id="3682074">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3682083">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682105">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3682118">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3682127">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3682191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3682194">func</span>&nbsp;<span class="op" id="3682199">(</span><span class="ident" id="3682200">cm</span>&nbsp;<span class="op" id="3682203">*</span><span class="ident" id="3682204">connectMethod</span><span class="op" id="3682217">)</span>&nbsp;<span class="ident" id="3682219">key</span><span class="op" id="3682222">(</span><span class="op" id="3682223">)</span>&nbsp;<span class="ident" id="3682225">connectMethodKey</span>&nbsp;<span class="op" id="3682242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682245">proxyStr</span>&nbsp;<span class="op" id="3682254">:=</span>&nbsp;<span class="string" id="3682257">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682261">targetAddr</span>&nbsp;<span class="op" id="3682272">:=</span>&nbsp;<span class="ident" id="3682275">cm</span><span class="op" id="3682277">.</span><span class="ident" id="3682278">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682290">if</span>&nbsp;<span class="ident" id="3682293">cm</span><span class="op" id="3682295">.</span><span class="ident" id="3682296">proxyURL</span>&nbsp;<span class="op" id="3682305">!=</span>&nbsp;<span class="ident" id="3682308">nil</span>&nbsp;<span class="op" id="3682312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682316">proxyStr</span>&nbsp;<span class="op" id="3682325">=</span>&nbsp;<span class="ident" id="3682327">cm</span><span class="op" id="3682329">.</span><span class="ident" id="3682330">proxyURL</span><span class="op" id="3682338">.</span><span class="ident" id="3682339">String</span><span class="op" id="3682345">(</span><span class="op" id="3682346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682350">if</span>&nbsp;<span class="ident" id="3682353">cm</span><span class="op" id="3682355">.</span><span class="ident" id="3682356">targetScheme</span>&nbsp;<span class="op" id="3682369">==</span>&nbsp;<span class="string" id="3682372">&#34;http&#34;</span>&nbsp;<span class="op" id="3682379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682384">targetAddr</span>&nbsp;<span class="op" id="3682395">=</span>&nbsp;<span class="string" id="3682397">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682402">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682408">return</span>&nbsp;<span class="ident" id="3682415">connectMethodKey</span><span class="op" id="3682431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682435">proxy</span><span class="op" id="3682440">:</span>&nbsp;&nbsp;<span class="ident" id="3682443">proxyStr</span><span class="op" id="3682451">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682455">scheme</span><span class="op" id="3682461">:</span>&nbsp;<span class="ident" id="3682463">cm</span><span class="op" id="3682465">.</span><span class="ident" id="3682466">targetScheme</span><span class="op" id="3682478">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682482">addr</span><span class="op" id="3682486">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3682490">targetAddr</span><span class="op" id="3682500">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682503">}</span><br>
<span class="lineno"></span><span class="op" id="3682505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3682508">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3682583">func</span>&nbsp;<span class="op" id="3682588">(</span><span class="ident" id="3682589">cm</span>&nbsp;<span class="op" id="3682592">*</span><span class="ident" id="3682593">connectMethod</span><span class="op" id="3682606">)</span>&nbsp;<span class="ident" id="3682608">addr</span><span class="op" id="3682612">(</span><span class="op" id="3682613">)</span>&nbsp;<span class="builtintype" id="3682615">string</span>&nbsp;<span class="op" id="3682622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682625">if</span>&nbsp;<span class="ident" id="3682628">cm</span><span class="op" id="3682630">.</span><span class="ident" id="3682631">proxyURL</span>&nbsp;<span class="op" id="3682640">!=</span>&nbsp;<span class="ident" id="3682643">nil</span>&nbsp;<span class="op" id="3682647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682651">return</span>&nbsp;<span class="ident" id="3682658">canonicalAddr</span><span class="op" id="3682671">(</span><span class="ident" id="3682672">cm</span><span class="op" id="3682674">.</span><span class="ident" id="3682675">proxyURL</span><span class="op" id="3682683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682689">return</span>&nbsp;<span class="ident" id="3682696">cm</span><span class="op" id="3682698">.</span><span class="ident" id="3682699">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3682710">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3682713">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3682774">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3682794">func</span>&nbsp;<span class="op" id="3682799">(</span><span class="ident" id="3682800">cm</span>&nbsp;<span class="op" id="3682803">*</span><span class="ident" id="3682804">connectMethod</span><span class="op" id="3682817">)</span>&nbsp;<span class="ident" id="3682819">tlsHost</span><span class="op" id="3682826">(</span><span class="op" id="3682827">)</span>&nbsp;<span class="builtintype" id="3682829">string</span>&nbsp;<span class="op" id="3682836">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682839">h</span>&nbsp;<span class="op" id="3682841">:=</span>&nbsp;<span class="ident" id="3682844">cm</span><span class="op" id="3682846">.</span><span class="ident" id="3682847">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682859">if</span>&nbsp;<span class="ident" id="3682862">hasPort</span><span class="op" id="3682869">(</span><span class="ident" id="3682870">h</span><span class="op" id="3682871">)</span>&nbsp;<span class="op" id="3682873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3682877">h</span>&nbsp;<span class="op" id="3682879">=</span>&nbsp;<span class="ident" id="3682881">h</span><span class="op" id="3682882">[</span><span class="op" id="3682883">:</span><span class="ident" id="3682884">strings</span><span class="op" id="3682891">.</span><span class="ident" id="3682892">LastIndex</span><span class="op" id="3682901">(</span><span class="ident" id="3682902">h</span><span class="op" id="3682903">,</span>&nbsp;<span class="string" id="3682905">&#34;:&#34;</span><span class="op" id="3682908">)</span><span class="op" id="3682909">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3682912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3682915">return</span>&nbsp;<span class="ident" id="3682922">h</span><br>
<span class="lineno">770</span><span class="op" id="3682924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3682927">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3682995">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3683066">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3683076">type</span>&nbsp;<span class="ident" id="3683081">connectMethodKey</span>&nbsp;<span class="keyword" id="3683098">struct</span>&nbsp;<span class="op" id="3683105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683108">proxy</span><span class="op" id="3683113">,</span>&nbsp;<span class="ident" id="3683115">scheme</span><span class="op" id="3683121">,</span>&nbsp;<span class="ident" id="3683123">addr</span>&nbsp;<span class="builtintype" id="3683128">string</span><br>
<span class="lineno"></span><span class="op" id="3683135">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3683138">func</span>&nbsp;<span class="op" id="3683143">(</span><span class="ident" id="3683144">k</span>&nbsp;<span class="ident" id="3683146">connectMethodKey</span><span class="op" id="3683162">)</span>&nbsp;<span class="ident" id="3683164">String</span><span class="op" id="3683170">(</span><span class="op" id="3683171">)</span>&nbsp;<span class="builtintype" id="3683173">string</span>&nbsp;<span class="op" id="3683180">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3683183">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3683207">return</span>&nbsp;<span class="ident" id="3683214">fmt</span><span class="op" id="3683217">.</span><span class="ident" id="3683218">Sprintf</span><span class="op" id="3683225">(</span><span class="string" id="3683226">&#34;%s|%s|%s&#34;</span><span class="op" id="3683236">,</span>&nbsp;<span class="ident" id="3683238">k</span><span class="op" id="3683239">.</span><span class="ident" id="3683240">proxy</span><span class="op" id="3683245">,</span>&nbsp;<span class="ident" id="3683247">k</span><span class="op" id="3683248">.</span><span class="ident" id="3683249">scheme</span><span class="op" id="3683255">,</span>&nbsp;<span class="ident" id="3683257">k</span><span class="op" id="3683258">.</span><span class="ident" id="3683259">addr</span><span class="op" id="3683263">)</span><br>
<span class="lineno"></span><span class="op" id="3683265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3683268">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3683328">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3683385">type</span>&nbsp;<span class="ident" id="3683390">persistConn</span>&nbsp;<span class="keyword" id="3683402">struct</span>&nbsp;<span class="op" id="3683409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683412">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3683421">*</span><span class="ident" id="3683422">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683433">cacheKey</span>&nbsp;<span class="ident" id="3683442">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683460">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3683469">net</span><span class="op" id="3683472">.</span><span class="ident" id="3683473">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683479">tlsState</span>&nbsp;<span class="op" id="3683488">*</span><span class="ident" id="3683489">tls</span><span class="op" id="3683492">.</span><span class="ident" id="3683493">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683510">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3683519">*</span><span class="ident" id="3683520">bufio</span><span class="op" id="3683525">.</span><span class="ident" id="3683526">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683539">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683553">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3683562">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683582">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683638">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3683647">*</span><span class="ident" id="3683648">bufio</span><span class="op" id="3683653">.</span><span class="ident" id="3683654">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683667">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683679">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3683688">chan</span>&nbsp;<span class="ident" id="3683693">requestAndChan</span>&nbsp;<span class="comment" id="3683708">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683751">writech</span>&nbsp;&nbsp;<span class="keyword" id="3683760">chan</span>&nbsp;<span class="ident" id="3683765">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3683780">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683824">closech</span>&nbsp;&nbsp;<span class="keyword" id="3683833">chan</span>&nbsp;<span class="keyword" id="3683838">struct</span><span class="op" id="3683844">{</span><span class="op" id="3683845">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3683853">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3683881">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3683890">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3683896">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3683956">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684018">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684082">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684141">writeErrCh</span>&nbsp;<span class="keyword" id="3684152">chan</span>&nbsp;<span class="builtintype" id="3684157">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684165">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3684186">sync</span><span class="op" id="3684190">.</span><span class="ident" id="3684191">Mutex</span>&nbsp;<span class="comment" id="3684197">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684225">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3684246">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684251">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3684272">bool</span>&nbsp;<span class="comment" id="3684277">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684310">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3684331">bool</span>&nbsp;<span class="comment" id="3684336">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684416">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684473">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3684536">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684593">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3684610">func</span><span class="op" id="3684614">(</span><span class="ident" id="3684615">Header</span><span class="op" id="3684621">)</span><br>
<span class="lineno"></span><span class="op" id="3684623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3684626">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3684698">func</span>&nbsp;<span class="op" id="3684703">(</span><span class="ident" id="3684704">pc</span>&nbsp;<span class="op" id="3684707">*</span><span class="ident" id="3684708">persistConn</span><span class="op" id="3684719">)</span>&nbsp;<span class="ident" id="3684721">isBroken</span><span class="op" id="3684729">(</span><span class="op" id="3684730">)</span>&nbsp;<span class="builtintype" id="3684732">bool</span>&nbsp;<span class="op" id="3684737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684740">pc</span><span class="op" id="3684742">.</span><span class="ident" id="3684743">lk</span><span class="op" id="3684745">.</span><span class="ident" id="3684746">Lock</span><span class="op" id="3684750">(</span><span class="op" id="3684751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684754">b</span>&nbsp;<span class="op" id="3684756">:=</span>&nbsp;<span class="ident" id="3684759">pc</span><span class="op" id="3684761">.</span><span class="ident" id="3684762">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684770">pc</span><span class="op" id="3684772">.</span><span class="ident" id="3684773">lk</span><span class="op" id="3684775">.</span><span class="ident" id="3684776">Unlock</span><span class="op" id="3684782">(</span><span class="op" id="3684783">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684786">return</span>&nbsp;<span class="ident" id="3684793">b</span><br>
<span class="lineno">820</span><span class="op" id="3684795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3684798">func</span>&nbsp;<span class="op" id="3684803">(</span><span class="ident" id="3684804">pc</span>&nbsp;<span class="op" id="3684807">*</span><span class="ident" id="3684808">persistConn</span><span class="op" id="3684819">)</span>&nbsp;<span class="ident" id="3684821">cancelRequest</span><span class="op" id="3684834">(</span><span class="op" id="3684835">)</span>&nbsp;<span class="op" id="3684837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3684840">pc</span><span class="op" id="3684842">.</span><span class="ident" id="3684843">conn</span><span class="op" id="3684847">.</span><span class="ident" id="3684848">Close</span><span class="op" id="3684853">(</span><span class="op" id="3684854">)</span><br>
<span class="lineno"></span><span class="op" id="3684856">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3684859">var</span>&nbsp;<span class="ident" id="3684863">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3684884">func</span><span class="op" id="3684888">(</span><span class="builtintype" id="3684889">error</span><span class="op" id="3684894">)</span>&nbsp;<span class="builtintype" id="3684896">bool</span>&nbsp;<span class="comment" id="3684901">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3684927">func</span>&nbsp;<span class="ident" id="3684932">remoteSideClosed</span><span class="op" id="3684948">(</span><span class="ident" id="3684949">err</span>&nbsp;<span class="builtintype" id="3684953">error</span><span class="op" id="3684958">)</span>&nbsp;<span class="builtintype" id="3684960">bool</span>&nbsp;<span class="op" id="3684965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684968">if</span>&nbsp;<span class="ident" id="3684971">err</span>&nbsp;<span class="op" id="3684975">==</span>&nbsp;<span class="ident" id="3684978">io</span><span class="op" id="3684980">.</span><span class="ident" id="3684981">EOF</span>&nbsp;<span class="op" id="3684985">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3684989">return</span>&nbsp;<span class="ident" id="3684996">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685005">if</span>&nbsp;<span class="ident" id="3685008">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3685029">!=</span>&nbsp;<span class="ident" id="3685032">nil</span>&nbsp;<span class="op" id="3685036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685040">return</span>&nbsp;<span class="ident" id="3685047">remoteSideClosedFunc</span><span class="op" id="3685067">(</span><span class="ident" id="3685068">err</span><span class="op" id="3685071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685074">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685077">return</span>&nbsp;<span class="ident" id="3685084">false</span><br>
<span class="lineno"></span><span class="op" id="3685090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3685093">func</span>&nbsp;<span class="op" id="3685098">(</span><span class="ident" id="3685099">pc</span>&nbsp;<span class="op" id="3685102">*</span><span class="ident" id="3685103">persistConn</span><span class="op" id="3685114">)</span>&nbsp;<span class="ident" id="3685116">readLoop</span><span class="op" id="3685124">(</span><span class="op" id="3685125">)</span>&nbsp;<span class="op" id="3685127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685130">alive</span>&nbsp;<span class="op" id="3685136">:=</span>&nbsp;<span class="ident" id="3685139">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685146">for</span>&nbsp;<span class="ident" id="3685150">alive</span>&nbsp;<span class="op" id="3685156">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685160">pb</span><span class="op" id="3685162">,</span>&nbsp;<span class="ident" id="3685164">err</span>&nbsp;<span class="op" id="3685168">:=</span>&nbsp;<span class="ident" id="3685171">pc</span><span class="op" id="3685173">.</span><span class="ident" id="3685174">br</span><span class="op" id="3685176">.</span><span class="ident" id="3685177">Peek</span><span class="op" id="3685181">(</span><span class="num" id="3685182">1</span><span class="op" id="3685183">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685188">pc</span><span class="op" id="3685190">.</span><span class="ident" id="3685191">lk</span><span class="op" id="3685193">.</span><span class="ident" id="3685194">Lock</span><span class="op" id="3685198">(</span><span class="op" id="3685199">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685203">if</span>&nbsp;<span class="ident" id="3685206">pc</span><span class="op" id="3685208">.</span><span class="ident" id="3685209">numExpectedResponses</span>&nbsp;<span class="op" id="3685230">==</span>&nbsp;<span class="num" id="3685233">0</span>&nbsp;<span class="op" id="3685235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685240">if</span>&nbsp;<span class="op" id="3685243">!</span><span class="ident" id="3685244">pc</span><span class="op" id="3685246">.</span><span class="ident" id="3685247">closed</span>&nbsp;<span class="op" id="3685254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685260">pc</span><span class="op" id="3685262">.</span><span class="ident" id="3685263">closeLocked</span><span class="op" id="3685274">(</span><span class="op" id="3685275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685281">if</span>&nbsp;<span class="builtinfunc" id="3685284">len</span><span class="op" id="3685287">(</span><span class="ident" id="3685288">pb</span><span class="op" id="3685290">)</span>&nbsp;<span class="op" id="3685292">&gt;</span>&nbsp;<span class="num" id="3685294">0</span>&nbsp;<span class="op" id="3685296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685303">log</span><span class="op" id="3685306">.</span><span class="ident" id="3685307">Printf</span><span class="op" id="3685313">(</span><span class="string" id="3685314">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3685391">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3685399">string</span><span class="op" id="3685405">(</span><span class="ident" id="3685406">pb</span><span class="op" id="3685408">)</span><span class="op" id="3685409">,</span>&nbsp;<span class="ident" id="3685411">err</span><span class="op" id="3685414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685430">pc</span><span class="op" id="3685432">.</span><span class="ident" id="3685433">lk</span><span class="op" id="3685435">.</span><span class="ident" id="3685436">Unlock</span><span class="op" id="3685442">(</span><span class="op" id="3685443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685448">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685461">pc</span><span class="op" id="3685463">.</span><span class="ident" id="3685464">lk</span><span class="op" id="3685466">.</span><span class="ident" id="3685467">Unlock</span><span class="op" id="3685473">(</span><span class="op" id="3685474">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685479">rc</span>&nbsp;<span class="op" id="3685482">:=</span>&nbsp;<span class="op" id="3685485">&lt;-</span><span class="ident" id="3685487">pc</span><span class="op" id="3685489">.</span><span class="ident" id="3685490">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685499">var</span>&nbsp;<span class="ident" id="3685503">resp</span>&nbsp;<span class="op" id="3685508">*</span><span class="ident" id="3685509">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685520">if</span>&nbsp;<span class="ident" id="3685523">err</span>&nbsp;<span class="op" id="3685527">==</span>&nbsp;<span class="ident" id="3685530">nil</span>&nbsp;<span class="op" id="3685534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685539">resp</span><span class="op" id="3685543">,</span>&nbsp;<span class="ident" id="3685545">err</span>&nbsp;<span class="op" id="3685549">=</span>&nbsp;<span class="ident" id="3685551">ReadResponse</span><span class="op" id="3685563">(</span><span class="ident" id="3685564">pc</span><span class="op" id="3685566">.</span><span class="ident" id="3685567">br</span><span class="op" id="3685569">,</span>&nbsp;<span class="ident" id="3685571">rc</span><span class="op" id="3685573">.</span><span class="ident" id="3685574">req</span><span class="op" id="3685577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685582">if</span>&nbsp;<span class="ident" id="3685585">err</span>&nbsp;<span class="op" id="3685589">==</span>&nbsp;<span class="ident" id="3685592">nil</span>&nbsp;<span class="op" id="3685596">&amp;&amp;</span>&nbsp;<span class="ident" id="3685599">resp</span><span class="op" id="3685603">.</span><span class="ident" id="3685604">StatusCode</span>&nbsp;<span class="op" id="3685615">==</span>&nbsp;<span class="num" id="3685618">100</span>&nbsp;<span class="op" id="3685622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3685628">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3685666">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3685727">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3685787">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3685853">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685901">resp</span><span class="op" id="3685905">,</span>&nbsp;<span class="ident" id="3685907">err</span>&nbsp;<span class="op" id="3685911">=</span>&nbsp;<span class="ident" id="3685913">ReadResponse</span><span class="op" id="3685925">(</span><span class="ident" id="3685926">pc</span><span class="op" id="3685928">.</span><span class="ident" id="3685929">br</span><span class="op" id="3685931">,</span>&nbsp;<span class="ident" id="3685933">rc</span><span class="op" id="3685935">.</span><span class="ident" id="3685936">req</span><span class="op" id="3685939">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3685953">if</span>&nbsp;<span class="ident" id="3685956">resp</span>&nbsp;<span class="op" id="3685961">!=</span>&nbsp;<span class="ident" id="3685964">nil</span>&nbsp;<span class="op" id="3685968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3685973">resp</span><span class="op" id="3685977">.</span><span class="ident" id="3685978">TLS</span>&nbsp;<span class="op" id="3685982">=</span>&nbsp;<span class="ident" id="3685984">pc</span><span class="op" id="3685986">.</span><span class="ident" id="3685987">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3685998">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686003">hasBody</span>&nbsp;<span class="op" id="3686011">:=</span>&nbsp;<span class="ident" id="3686014">resp</span>&nbsp;<span class="op" id="3686019">!=</span>&nbsp;<span class="ident" id="3686022">nil</span>&nbsp;<span class="op" id="3686026">&amp;&amp;</span>&nbsp;<span class="ident" id="3686029">rc</span><span class="op" id="3686031">.</span><span class="ident" id="3686032">req</span><span class="op" id="3686035">.</span><span class="ident" id="3686036">Method</span>&nbsp;<span class="op" id="3686043">!=</span>&nbsp;<span class="string" id="3686046">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3686053">&amp;&amp;</span>&nbsp;<span class="ident" id="3686056">resp</span><span class="op" id="3686060">.</span><span class="ident" id="3686061">ContentLength</span>&nbsp;<span class="op" id="3686075">!=</span>&nbsp;<span class="num" id="3686078">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686083">if</span>&nbsp;<span class="ident" id="3686086">err</span>&nbsp;<span class="op" id="3686090">!=</span>&nbsp;<span class="ident" id="3686093">nil</span>&nbsp;<span class="op" id="3686097">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686102">pc</span><span class="op" id="3686104">.</span><span class="builtinfunc" id="3686105">close</span><span class="op" id="3686110">(</span><span class="op" id="3686111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686115">}</span>&nbsp;<span class="keyword" id="3686117">else</span>&nbsp;<span class="op" id="3686122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686127">if</span>&nbsp;<span class="ident" id="3686130">rc</span><span class="op" id="3686132">.</span><span class="ident" id="3686133">addedGzip</span>&nbsp;<span class="op" id="3686143">&amp;&amp;</span>&nbsp;<span class="ident" id="3686146">hasBody</span>&nbsp;<span class="op" id="3686154">&amp;&amp;</span>&nbsp;<span class="ident" id="3686157">resp</span><span class="op" id="3686161">.</span><span class="ident" id="3686162">Header</span><span class="op" id="3686168">.</span><span class="ident" id="3686169">Get</span><span class="op" id="3686172">(</span><span class="string" id="3686173">&#34;Content-Encoding&#34;</span><span class="op" id="3686191">)</span>&nbsp;<span class="op" id="3686193">==</span>&nbsp;<span class="string" id="3686196">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3686203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686209">resp</span><span class="op" id="3686213">.</span><span class="ident" id="3686214">Header</span><span class="op" id="3686220">.</span><span class="ident" id="3686221">Del</span><span class="op" id="3686224">(</span><span class="string" id="3686225">&#34;Content-Encoding&#34;</span><span class="op" id="3686243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686249">resp</span><span class="op" id="3686253">.</span><span class="ident" id="3686254">Header</span><span class="op" id="3686260">.</span><span class="ident" id="3686261">Del</span><span class="op" id="3686264">(</span><span class="string" id="3686265">&#34;Content-Length&#34;</span><span class="op" id="3686281">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686287">resp</span><span class="op" id="3686291">.</span><span class="ident" id="3686292">ContentLength</span>&nbsp;<span class="op" id="3686306">=</span>&nbsp;<span class="op" id="3686308">-</span><span class="num" id="3686309">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686315">resp</span><span class="op" id="3686319">.</span><span class="ident" id="3686320">Body</span>&nbsp;<span class="op" id="3686325">=</span>&nbsp;<span class="op" id="3686327">&amp;</span><span class="ident" id="3686328">gzipReader</span><span class="op" id="3686338">{</span><span class="ident" id="3686339">body</span><span class="op" id="3686343">:</span>&nbsp;<span class="ident" id="3686345">resp</span><span class="op" id="3686349">.</span><span class="ident" id="3686350">Body</span><span class="op" id="3686354">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686364">resp</span><span class="op" id="3686368">.</span><span class="ident" id="3686369">Body</span>&nbsp;<span class="op" id="3686374">=</span>&nbsp;<span class="op" id="3686376">&amp;</span><span class="ident" id="3686377">bodyEOFSignal</span><span class="op" id="3686390">{</span><span class="ident" id="3686391">body</span><span class="op" id="3686395">:</span>&nbsp;<span class="ident" id="3686397">resp</span><span class="op" id="3686401">.</span><span class="ident" id="3686402">Body</span><span class="op" id="3686406">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686410">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686415">if</span>&nbsp;<span class="ident" id="3686418">err</span>&nbsp;<span class="op" id="3686422">!=</span>&nbsp;<span class="ident" id="3686425">nil</span>&nbsp;<span class="op" id="3686429">||</span>&nbsp;<span class="ident" id="3686432">resp</span><span class="op" id="3686436">.</span><span class="ident" id="3686437">Close</span>&nbsp;<span class="op" id="3686443">||</span>&nbsp;<span class="ident" id="3686446">rc</span><span class="op" id="3686448">.</span><span class="ident" id="3686449">req</span><span class="op" id="3686452">.</span><span class="ident" id="3686453">Close</span>&nbsp;<span class="op" id="3686459">||</span>&nbsp;<span class="ident" id="3686462">resp</span><span class="op" id="3686466">.</span><span class="ident" id="3686467">StatusCode</span>&nbsp;<span class="op" id="3686478">&lt;=</span>&nbsp;<span class="num" id="3686481">199</span>&nbsp;<span class="op" id="3686485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686490">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686559">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686619">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686666">alive</span>&nbsp;<span class="op" id="3686672">=</span>&nbsp;<span class="ident" id="3686674">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686687">var</span>&nbsp;<span class="ident" id="3686691">waitForBodyRead</span>&nbsp;<span class="keyword" id="3686707">chan</span>&nbsp;<span class="builtintype" id="3686712">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686719">if</span>&nbsp;<span class="ident" id="3686722">hasBody</span>&nbsp;<span class="op" id="3686730">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686735">waitForBodyRead</span>&nbsp;<span class="op" id="3686751">=</span>&nbsp;<span class="builtinfunc" id="3686753">make</span><span class="op" id="3686757">(</span><span class="keyword" id="3686758">chan</span>&nbsp;<span class="builtintype" id="3686763">bool</span><span class="op" id="3686767">,</span>&nbsp;<span class="num" id="3686769">2</span><span class="op" id="3686770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686775">resp</span><span class="op" id="3686779">.</span><span class="ident" id="3686780">Body</span><span class="op" id="3686784">.</span><span class="op" id="3686785">(</span><span class="op" id="3686786">*</span><span class="ident" id="3686787">bodyEOFSignal</span><span class="op" id="3686800">)</span><span class="op" id="3686801">.</span><span class="ident" id="3686802">earlyCloseFn</span>&nbsp;<span class="op" id="3686815">=</span>&nbsp;<span class="keyword" id="3686817">func</span><span class="op" id="3686821">(</span><span class="op" id="3686822">)</span>&nbsp;<span class="builtintype" id="3686824">error</span>&nbsp;<span class="op" id="3686830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686836">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686876">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3686915">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686929">waitForBodyRead</span>&nbsp;<span class="op" id="3686945">&lt;-</span>&nbsp;<span class="ident" id="3686948">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3686958">return</span>&nbsp;<span class="ident" id="3686965">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3686972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3686977">resp</span><span class="op" id="3686981">.</span><span class="ident" id="3686982">Body</span><span class="op" id="3686986">.</span><span class="op" id="3686987">(</span><span class="op" id="3686988">*</span><span class="ident" id="3686989">bodyEOFSignal</span><span class="op" id="3687002">)</span><span class="op" id="3687003">.</span><span class="ident" id="3687004">fn</span>&nbsp;<span class="op" id="3687007">=</span>&nbsp;<span class="keyword" id="3687009">func</span><span class="op" id="3687013">(</span><span class="ident" id="3687014">err</span>&nbsp;<span class="builtintype" id="3687018">error</span><span class="op" id="3687023">)</span>&nbsp;<span class="op" id="3687025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687031">waitForBodyRead</span>&nbsp;<span class="op" id="3687047">&lt;-</span>&nbsp;<span class="ident" id="3687050">alive</span>&nbsp;<span class="op" id="3687056">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687064">err</span>&nbsp;<span class="op" id="3687068">==</span>&nbsp;<span class="ident" id="3687071">nil</span>&nbsp;<span class="op" id="3687075">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687083">!</span><span class="ident" id="3687084">pc</span><span class="op" id="3687086">.</span><span class="ident" id="3687087">sawEOF</span>&nbsp;<span class="op" id="3687094">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687102">pc</span><span class="op" id="3687104">.</span><span class="ident" id="3687105">wroteRequest</span><span class="op" id="3687117">(</span><span class="op" id="3687118">)</span>&nbsp;<span class="op" id="3687120">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687128">pc</span><span class="op" id="3687130">.</span><span class="ident" id="3687131">t</span><span class="op" id="3687132">.</span><span class="ident" id="3687133">putIdleConn</span><span class="op" id="3687144">(</span><span class="ident" id="3687145">pc</span><span class="op" id="3687147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687152">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687161">if</span>&nbsp;<span class="ident" id="3687164">alive</span>&nbsp;<span class="op" id="3687170">&amp;&amp;</span>&nbsp;<span class="op" id="3687173">!</span><span class="ident" id="3687174">hasBody</span>&nbsp;<span class="op" id="3687182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687187">alive</span>&nbsp;<span class="op" id="3687193">=</span>&nbsp;<span class="op" id="3687195">!</span><span class="ident" id="3687196">pc</span><span class="op" id="3687198">.</span><span class="ident" id="3687199">sawEOF</span>&nbsp;<span class="op" id="3687206">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687213">pc</span><span class="op" id="3687215">.</span><span class="ident" id="3687216">wroteRequest</span><span class="op" id="3687228">(</span><span class="op" id="3687229">)</span>&nbsp;<span class="op" id="3687231">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687238">pc</span><span class="op" id="3687240">.</span><span class="ident" id="3687241">t</span><span class="op" id="3687242">.</span><span class="ident" id="3687243">putIdleConn</span><span class="op" id="3687254">(</span><span class="ident" id="3687255">pc</span><span class="op" id="3687257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687266">rc</span><span class="op" id="3687268">.</span><span class="ident" id="3687269">ch</span>&nbsp;<span class="op" id="3687272">&lt;-</span>&nbsp;<span class="ident" id="3687275">responseAndError</span><span class="op" id="3687291">{</span><span class="ident" id="3687292">resp</span><span class="op" id="3687296">,</span>&nbsp;<span class="ident" id="3687298">err</span><span class="op" id="3687301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3687306">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3687373">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687434">if</span>&nbsp;<span class="ident" id="3687437">waitForBodyRead</span>&nbsp;<span class="op" id="3687453">!=</span>&nbsp;<span class="ident" id="3687456">nil</span>&nbsp;<span class="op" id="3687460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687465">select</span>&nbsp;<span class="op" id="3687472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687477">case</span>&nbsp;<span class="ident" id="3687482">alive</span>&nbsp;<span class="op" id="3687488">=</span>&nbsp;<span class="op" id="3687490">&lt;-</span><span class="ident" id="3687492">waitForBodyRead</span><span class="op" id="3687507">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687512">case</span>&nbsp;<span class="op" id="3687517">&lt;-</span><span class="ident" id="3687519">pc</span><span class="op" id="3687521">.</span><span class="ident" id="3687522">closech</span><span class="op" id="3687529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687535">alive</span>&nbsp;<span class="op" id="3687541">=</span>&nbsp;<span class="ident" id="3687543">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687556">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687561">pc</span><span class="op" id="3687563">.</span><span class="ident" id="3687564">t</span><span class="op" id="3687565">.</span><span class="ident" id="3687566">setReqCanceler</span><span class="op" id="3687580">(</span><span class="ident" id="3687581">rc</span><span class="op" id="3687583">.</span><span class="ident" id="3687584">req</span><span class="op" id="3687587">,</span>&nbsp;<span class="ident" id="3687589">nil</span><span class="op" id="3687592">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687597">if</span>&nbsp;<span class="op" id="3687600">!</span><span class="ident" id="3687601">alive</span>&nbsp;<span class="op" id="3687607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687612">pc</span><span class="op" id="3687614">.</span><span class="builtinfunc" id="3687615">close</span><span class="op" id="3687620">(</span><span class="op" id="3687621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687625">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687628">}</span><br>
<span class="lineno"></span><span class="op" id="3687630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3687633">func</span>&nbsp;<span class="op" id="3687638">(</span><span class="ident" id="3687639">pc</span>&nbsp;<span class="op" id="3687642">*</span><span class="ident" id="3687643">persistConn</span><span class="op" id="3687654">)</span>&nbsp;<span class="ident" id="3687656">writeLoop</span><span class="op" id="3687665">(</span><span class="op" id="3687666">)</span>&nbsp;<span class="op" id="3687668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687671">for</span>&nbsp;<span class="op" id="3687675">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687679">select</span>&nbsp;<span class="op" id="3687686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687690">case</span>&nbsp;<span class="ident" id="3687695">wr</span>&nbsp;<span class="op" id="3687698">:=</span>&nbsp;<span class="op" id="3687701">&lt;-</span><span class="ident" id="3687703">pc</span><span class="op" id="3687705">.</span><span class="ident" id="3687706">writech</span><span class="op" id="3687713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687718">if</span>&nbsp;<span class="ident" id="3687721">pc</span><span class="op" id="3687723">.</span><span class="ident" id="3687724">isBroken</span><span class="op" id="3687732">(</span><span class="op" id="3687733">)</span>&nbsp;<span class="op" id="3687735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687741">wr</span><span class="op" id="3687743">.</span><span class="ident" id="3687744">ch</span>&nbsp;<span class="op" id="3687747">&lt;-</span>&nbsp;<span class="ident" id="3687750">errors</span><span class="op" id="3687756">.</span><span class="ident" id="3687757">New</span><span class="op" id="3687760">(</span><span class="string" id="3687761">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3687814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687820">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687837">err</span>&nbsp;<span class="op" id="3687841">:=</span>&nbsp;<span class="ident" id="3687844">wr</span><span class="op" id="3687846">.</span><span class="ident" id="3687847">req</span><span class="op" id="3687850">.</span><span class="ident" id="3687851">Request</span><span class="op" id="3687858">.</span><span class="ident" id="3687859">write</span><span class="op" id="3687864">(</span><span class="ident" id="3687865">pc</span><span class="op" id="3687867">.</span><span class="ident" id="3687868">bw</span><span class="op" id="3687870">,</span>&nbsp;<span class="ident" id="3687872">pc</span><span class="op" id="3687874">.</span><span class="ident" id="3687875">isProxy</span><span class="op" id="3687882">,</span>&nbsp;<span class="ident" id="3687884">wr</span><span class="op" id="3687886">.</span><span class="ident" id="3687887">req</span><span class="op" id="3687890">.</span><span class="ident" id="3687891">extra</span><span class="op" id="3687896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687901">if</span>&nbsp;<span class="ident" id="3687904">err</span>&nbsp;<span class="op" id="3687908">==</span>&nbsp;<span class="ident" id="3687911">nil</span>&nbsp;<span class="op" id="3687915">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687921">err</span>&nbsp;<span class="op" id="3687925">=</span>&nbsp;<span class="ident" id="3687927">pc</span><span class="op" id="3687929">.</span><span class="ident" id="3687930">bw</span><span class="op" id="3687932">.</span><span class="ident" id="3687933">Flush</span><span class="op" id="3687938">(</span><span class="op" id="3687939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3687944">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3687949">if</span>&nbsp;<span class="ident" id="3687952">err</span>&nbsp;<span class="op" id="3687956">!=</span>&nbsp;<span class="ident" id="3687959">nil</span>&nbsp;<span class="op" id="3687963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687969">pc</span><span class="op" id="3687971">.</span><span class="ident" id="3687972">markBroken</span><span class="op" id="3687982">(</span><span class="op" id="3687983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3687989">wr</span><span class="op" id="3687991">.</span><span class="ident" id="3687992">req</span><span class="op" id="3687995">.</span><span class="ident" id="3687996">Request</span><span class="op" id="3688003">.</span><span class="ident" id="3688004">closeBody</span><span class="op" id="3688013">(</span><span class="op" id="3688014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3688019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3688024">pc</span><span class="op" id="3688026">.</span><span class="ident" id="3688027">writeErrCh</span>&nbsp;<span class="op" id="3688038">&lt;-</span>&nbsp;<span class="ident" id="3688041">err</span>&nbsp;<span class="comment" id="3688045">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3688094">wr</span><span class="op" id="3688096">.</span><span class="ident" id="3688097">ch</span>&nbsp;<span class="op" id="3688100">&lt;-</span>&nbsp;<span class="ident" id="3688103">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3688115">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688146">case</span>&nbsp;<span class="op" id="3688151">&lt;-</span><span class="ident" id="3688153">pc</span><span class="op" id="3688155">.</span><span class="ident" id="3688156">closech</span><span class="op" id="3688163">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688168">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3688177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3688180">}</span><br>
<span class="lineno">965</span><span class="op" id="3688182">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3688185">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3688266">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3688321">func</span>&nbsp;<span class="op" id="3688326">(</span><span class="ident" id="3688327">pc</span>&nbsp;<span class="op" id="3688330">*</span><span class="ident" id="3688331">persistConn</span><span class="op" id="3688342">)</span>&nbsp;<span class="ident" id="3688344">wroteRequest</span><span class="op" id="3688356">(</span><span class="op" id="3688357">)</span>&nbsp;<span class="builtintype" id="3688359">bool</span>&nbsp;<span class="op" id="3688364">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688367">select</span>&nbsp;<span class="op" id="3688374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688377">case</span>&nbsp;<span class="ident" id="3688382">err</span>&nbsp;<span class="op" id="3688386">:=</span>&nbsp;<span class="op" id="3688389">&lt;-</span><span class="ident" id="3688391">pc</span><span class="op" id="3688393">.</span><span class="ident" id="3688394">writeErrCh</span><span class="op" id="3688404">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688408">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688474">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688503">return</span>&nbsp;<span class="ident" id="3688510">err</span>&nbsp;<span class="op" id="3688514">==</span>&nbsp;<span class="ident" id="3688517">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3688522">default</span><span class="op" id="3688529">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688533">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688596">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688659">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688726">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688781">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688786">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688850">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688915">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3688979">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3689043">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3689074">select</span>&nbsp;<span class="op" id="3689081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3689085">case</span>&nbsp;<span class="ident" id="3689090">err</span>&nbsp;<span class="op" id="3689094">:=</span>&nbsp;<span class="op" id="3689097">&lt;-</span><span class="ident" id="3689099">pc</span><span class="op" id="3689101">.</span><span class="ident" id="3689102">writeErrCh</span><span class="op" id="3689112">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3689117">return</span>&nbsp;<span class="ident" id="3689124">err</span>&nbsp;<span class="op" id="3689128">==</span>&nbsp;<span class="ident" id="3689131">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3689137">case</span>&nbsp;<span class="op" id="3689142">&lt;-</span><span class="ident" id="3689144">time</span><span class="op" id="3689148">.</span><span class="ident" id="3689149">After</span><span class="op" id="3689154">(</span><span class="num" id="3689155">50</span>&nbsp;<span class="op" id="3689158">*</span>&nbsp;<span class="ident" id="3689160">time</span><span class="op" id="3689164">.</span><span class="ident" id="3689165">Millisecond</span><span class="op" id="3689176">)</span><span class="op" id="3689177">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3689182">return</span>&nbsp;<span class="ident" id="3689189">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3689197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3689200">}</span><br>
<span class="lineno"></span><span class="op" id="3689202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3689205">type</span>&nbsp;<span class="ident" id="3689210">responseAndError</span>&nbsp;<span class="keyword" id="3689227">struct</span>&nbsp;<span class="op" id="3689234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689237">res</span>&nbsp;<span class="op" id="3689241">*</span><span class="ident" id="3689242">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689252">err</span>&nbsp;<span class="builtintype" id="3689256">error</span><br>
<span class="lineno"></span><span class="op" id="3689262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3689265">type</span>&nbsp;<span class="ident" id="3689270">requestAndChan</span>&nbsp;<span class="keyword" id="3689285">struct</span>&nbsp;<span class="op" id="3689292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689295">req</span>&nbsp;<span class="op" id="3689299">*</span><span class="ident" id="3689300">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689309">ch</span>&nbsp;&nbsp;<span class="keyword" id="3689313">chan</span>&nbsp;<span class="ident" id="3689318">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3689337">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3689398">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3689455">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689493">addedGzip</span>&nbsp;<span class="builtintype" id="3689503">bool</span><br>
<span class="lineno"></span><span class="op" id="3689508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3689511">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3689572">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3689636">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3689702">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3689712">type</span>&nbsp;<span class="ident" id="3689717">writeRequest</span>&nbsp;<span class="keyword" id="3689730">struct</span>&nbsp;<span class="op" id="3689737">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689740">req</span>&nbsp;<span class="op" id="3689744">*</span><span class="ident" id="3689745">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689763">ch</span>&nbsp;&nbsp;<span class="keyword" id="3689767">chan</span><span class="op" id="3689771">&lt;-</span>&nbsp;<span class="builtintype" id="3689774">error</span><br>
<span class="lineno"></span><span class="op" id="3689780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3689783">type</span>&nbsp;<span class="ident" id="3689788">httpError</span>&nbsp;<span class="keyword" id="3689798">struct</span>&nbsp;<span class="op" id="3689805">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689808">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3689816">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3689824">timeout</span>&nbsp;<span class="builtintype" id="3689832">bool</span><br>
<span class="lineno"></span><span class="op" id="3689837">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3689840">func</span>&nbsp;<span class="op" id="3689845">(</span><span class="ident" id="3689846">e</span>&nbsp;<span class="op" id="3689848">*</span><span class="ident" id="3689849">httpError</span><span class="op" id="3689858">)</span>&nbsp;<span class="ident" id="3689860">Error</span><span class="op" id="3689865">(</span><span class="op" id="3689866">)</span>&nbsp;<span class="builtintype" id="3689868">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3689877">{</span>&nbsp;<span class="keyword" id="3689879">return</span>&nbsp;<span class="ident" id="3689886">e</span><span class="op" id="3689887">.</span><span class="ident" id="3689888">err</span>&nbsp;<span class="op" id="3689892">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3689894">func</span>&nbsp;<span class="op" id="3689899">(</span><span class="ident" id="3689900">e</span>&nbsp;<span class="op" id="3689902">*</span><span class="ident" id="3689903">httpError</span><span class="op" id="3689912">)</span>&nbsp;<span class="ident" id="3689914">Timeout</span><span class="op" id="3689921">(</span><span class="op" id="3689922">)</span>&nbsp;<span class="builtintype" id="3689924">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3689931">{</span>&nbsp;<span class="keyword" id="3689933">return</span>&nbsp;<span class="ident" id="3689940">e</span><span class="op" id="3689941">.</span><span class="ident" id="3689942">timeout</span>&nbsp;<span class="op" id="3689950">}</span><br>
<span class="lineno"></span><span class="keyword" id="3689952">func</span>&nbsp;<span class="op" id="3689957">(</span><span class="ident" id="3689958">e</span>&nbsp;<span class="op" id="3689960">*</span><span class="ident" id="3689961">httpError</span><span class="op" id="3689970">)</span>&nbsp;<span class="ident" id="3689972">Temporary</span><span class="op" id="3689981">(</span><span class="op" id="3689982">)</span>&nbsp;<span class="builtintype" id="3689984">bool</span>&nbsp;<span class="op" id="3689989">{</span>&nbsp;<span class="keyword" id="3689991">return</span>&nbsp;<span class="ident" id="3689998">true</span>&nbsp;<span class="op" id="3690003">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3690006">var</span>&nbsp;<span class="ident" id="3690010">errTimeout</span>&nbsp;<span class="builtintype" id="3690021">error</span>&nbsp;<span class="op" id="3690027">=</span>&nbsp;<span class="op" id="3690029">&amp;</span><span class="ident" id="3690030">httpError</span><span class="op" id="3690039">{</span><span class="ident" id="3690040">err</span><span class="op" id="3690043">:</span>&nbsp;<span class="string" id="3690045">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3690090">,</span>&nbsp;<span class="ident" id="3690092">timeout</span><span class="op" id="3690099">:</span>&nbsp;<span class="ident" id="3690101">true</span><span class="op" id="3690105">}</span><br>
<span class="lineno"></span><span class="keyword" id="3690107">var</span>&nbsp;<span class="ident" id="3690111">errClosed</span>&nbsp;<span class="builtintype" id="3690121">error</span>&nbsp;<span class="op" id="3690127">=</span>&nbsp;<span class="op" id="3690129">&amp;</span><span class="ident" id="3690130">httpError</span><span class="op" id="3690139">{</span><span class="ident" id="3690140">err</span><span class="op" id="3690143">:</span>&nbsp;<span class="string" id="3690145">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3690202">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3690205">func</span>&nbsp;<span class="op" id="3690210">(</span><span class="ident" id="3690211">pc</span>&nbsp;<span class="op" id="3690214">*</span><span class="ident" id="3690215">persistConn</span><span class="op" id="3690226">)</span>&nbsp;<span class="ident" id="3690228">roundTrip</span><span class="op" id="3690237">(</span><span class="ident" id="3690238">req</span>&nbsp;<span class="op" id="3690242">*</span><span class="ident" id="3690243">transportRequest</span><span class="op" id="3690259">)</span>&nbsp;<span class="op" id="3690261">(</span><span class="ident" id="3690262">resp</span>&nbsp;<span class="op" id="3690267">*</span><span class="ident" id="3690268">Response</span><span class="op" id="3690276">,</span>&nbsp;<span class="ident" id="3690278">err</span>&nbsp;<span class="builtintype" id="3690282">error</span><span class="op" id="3690287">)</span>&nbsp;<span class="op" id="3690289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690292">pc</span><span class="op" id="3690294">.</span><span class="ident" id="3690295">t</span><span class="op" id="3690296">.</span><span class="ident" id="3690297">setReqCanceler</span><span class="op" id="3690311">(</span><span class="ident" id="3690312">req</span><span class="op" id="3690315">.</span><span class="ident" id="3690316">Request</span><span class="op" id="3690323">,</span>&nbsp;<span class="ident" id="3690325">pc</span><span class="op" id="3690327">.</span><span class="ident" id="3690328">cancelRequest</span><span class="op" id="3690341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690344">pc</span><span class="op" id="3690346">.</span><span class="ident" id="3690347">lk</span><span class="op" id="3690349">.</span><span class="ident" id="3690350">Lock</span><span class="op" id="3690354">(</span><span class="op" id="3690355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690358">pc</span><span class="op" id="3690360">.</span><span class="ident" id="3690361">numExpectedResponses</span><span class="op" id="3690381">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690385">headerFn</span>&nbsp;<span class="op" id="3690394">:=</span>&nbsp;<span class="ident" id="3690397">pc</span><span class="op" id="3690399">.</span><span class="ident" id="3690400">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690418">pc</span><span class="op" id="3690420">.</span><span class="ident" id="3690421">lk</span><span class="op" id="3690423">.</span><span class="ident" id="3690424">Unlock</span><span class="op" id="3690430">(</span><span class="op" id="3690431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3690435">if</span>&nbsp;<span class="ident" id="3690438">headerFn</span>&nbsp;<span class="op" id="3690447">!=</span>&nbsp;<span class="ident" id="3690450">nil</span>&nbsp;<span class="op" id="3690454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690458">headerFn</span><span class="op" id="3690466">(</span><span class="ident" id="3690467">req</span><span class="op" id="3690470">.</span><span class="ident" id="3690471">extraHeaders</span><span class="op" id="3690483">(</span><span class="op" id="3690484">)</span><span class="op" id="3690485">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3690488">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690492">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690556">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690610">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690667">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690685">requestedGzip</span>&nbsp;<span class="op" id="3690699">:=</span>&nbsp;<span class="ident" id="3690702">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3690709">if</span>&nbsp;<span class="op" id="3690712">!</span><span class="ident" id="3690713">pc</span><span class="op" id="3690715">.</span><span class="ident" id="3690716">t</span><span class="op" id="3690717">.</span><span class="ident" id="3690718">DisableCompression</span>&nbsp;<span class="op" id="3690737">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690742">req</span><span class="op" id="3690745">.</span><span class="ident" id="3690746">Header</span><span class="op" id="3690752">.</span><span class="ident" id="3690753">Get</span><span class="op" id="3690756">(</span><span class="string" id="3690757">&#34;Accept-Encoding&#34;</span><span class="op" id="3690774">)</span>&nbsp;<span class="op" id="3690776">==</span>&nbsp;<span class="string" id="3690779">&#34;&#34;</span>&nbsp;<span class="op" id="3690782">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690787">req</span><span class="op" id="3690790">.</span><span class="ident" id="3690791">Header</span><span class="op" id="3690797">.</span><span class="ident" id="3690798">Get</span><span class="op" id="3690801">(</span><span class="string" id="3690802">&#34;Range&#34;</span><span class="op" id="3690809">)</span>&nbsp;<span class="op" id="3690811">==</span>&nbsp;<span class="string" id="3690814">&#34;&#34;</span>&nbsp;<span class="op" id="3690817">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3690822">req</span><span class="op" id="3690825">.</span><span class="ident" id="3690826">Method</span>&nbsp;<span class="op" id="3690833">!=</span>&nbsp;<span class="string" id="3690836">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3690843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690847">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690909">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3690951">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691006">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691011">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691067">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691095">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691141">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691177">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691182">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691246">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691312">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691358">requestedGzip</span>&nbsp;<span class="op" id="3691372">=</span>&nbsp;<span class="ident" id="3691374">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691381">req</span><span class="op" id="3691384">.</span><span class="ident" id="3691385">extraHeaders</span><span class="op" id="3691397">(</span><span class="op" id="3691398">)</span><span class="op" id="3691399">.</span><span class="ident" id="3691400">Set</span><span class="op" id="3691403">(</span><span class="string" id="3691404">&#34;Accept-Encoding&#34;</span><span class="op" id="3691421">,</span>&nbsp;<span class="string" id="3691423">&#34;gzip&#34;</span><span class="op" id="3691429">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3691432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691436">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691500">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3691564">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691582">writeErrCh</span>&nbsp;<span class="op" id="3691593">:=</span>&nbsp;<span class="builtinfunc" id="3691596">make</span><span class="op" id="3691600">(</span><span class="keyword" id="3691601">chan</span>&nbsp;<span class="builtintype" id="3691606">error</span><span class="op" id="3691611">,</span>&nbsp;<span class="num" id="3691613">1</span><span class="op" id="3691614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691617">pc</span><span class="op" id="3691619">.</span><span class="ident" id="3691620">writech</span>&nbsp;<span class="op" id="3691628">&lt;-</span>&nbsp;<span class="ident" id="3691631">writeRequest</span><span class="op" id="3691643">{</span><span class="ident" id="3691644">req</span><span class="op" id="3691647">,</span>&nbsp;<span class="ident" id="3691649">writeErrCh</span><span class="op" id="3691659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691663">resc</span>&nbsp;<span class="op" id="3691668">:=</span>&nbsp;<span class="builtinfunc" id="3691671">make</span><span class="op" id="3691675">(</span><span class="keyword" id="3691676">chan</span>&nbsp;<span class="ident" id="3691681">responseAndError</span><span class="op" id="3691697">,</span>&nbsp;<span class="num" id="3691699">1</span><span class="op" id="3691700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691703">pc</span><span class="op" id="3691705">.</span><span class="ident" id="3691706">reqch</span>&nbsp;<span class="op" id="3691712">&lt;-</span>&nbsp;<span class="ident" id="3691715">requestAndChan</span><span class="op" id="3691729">{</span><span class="ident" id="3691730">req</span><span class="op" id="3691733">.</span><span class="ident" id="3691734">Request</span><span class="op" id="3691741">,</span>&nbsp;<span class="ident" id="3691743">resc</span><span class="op" id="3691747">,</span>&nbsp;<span class="ident" id="3691749">requestedGzip</span><span class="op" id="3691762">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691766">var</span>&nbsp;<span class="ident" id="3691770">re</span>&nbsp;<span class="ident" id="3691773">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691791">var</span>&nbsp;<span class="ident" id="3691795">pconnDeadCh</span>&nbsp;<span class="op" id="3691807">=</span>&nbsp;<span class="ident" id="3691809">pc</span><span class="op" id="3691811">.</span><span class="ident" id="3691812">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691821">var</span>&nbsp;<span class="ident" id="3691825">failTicker</span>&nbsp;<span class="op" id="3691836">&lt;-</span><span class="keyword" id="3691838">chan</span>&nbsp;<span class="ident" id="3691843">time</span><span class="op" id="3691847">.</span><span class="ident" id="3691848">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691854">var</span>&nbsp;<span class="ident" id="3691858">respHeaderTimer</span>&nbsp;<span class="op" id="3691874">&lt;-</span><span class="keyword" id="3691876">chan</span>&nbsp;<span class="ident" id="3691881">time</span><span class="op" id="3691885">.</span><span class="ident" id="3691886">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3691891">WaitResponse</span><span class="op" id="3691903">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691906">for</span>&nbsp;<span class="op" id="3691910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691914">select</span>&nbsp;<span class="op" id="3691921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691925">case</span>&nbsp;<span class="ident" id="3691930">err</span>&nbsp;<span class="op" id="3691934">:=</span>&nbsp;<span class="op" id="3691937">&lt;-</span><span class="ident" id="3691939">writeErrCh</span><span class="op" id="3691949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3691954">if</span>&nbsp;<span class="ident" id="3691957">err</span>&nbsp;<span class="op" id="3691961">!=</span>&nbsp;<span class="ident" id="3691964">nil</span>&nbsp;<span class="op" id="3691968">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3691974">re</span>&nbsp;<span class="op" id="3691977">=</span>&nbsp;<span class="ident" id="3691979">responseAndError</span><span class="op" id="3691995">{</span><span class="ident" id="3691996">nil</span><span class="op" id="3691999">,</span>&nbsp;<span class="ident" id="3692001">err</span><span class="op" id="3692004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692010">pc</span><span class="op" id="3692012">.</span><span class="builtinfunc" id="3692013">close</span><span class="op" id="3692018">(</span><span class="op" id="3692019">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692025">break</span>&nbsp;<span class="ident" id="3692031">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3692047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692052">if</span>&nbsp;<span class="ident" id="3692055">d</span>&nbsp;<span class="op" id="3692057">:=</span>&nbsp;<span class="ident" id="3692060">pc</span><span class="op" id="3692062">.</span><span class="ident" id="3692063">t</span><span class="op" id="3692064">.</span><span class="ident" id="3692065">ResponseHeaderTimeout</span><span class="op" id="3692086">;</span>&nbsp;<span class="ident" id="3692088">d</span>&nbsp;<span class="op" id="3692090">&gt;</span>&nbsp;<span class="num" id="3692092">0</span>&nbsp;<span class="op" id="3692094">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692100">respHeaderTimer</span>&nbsp;<span class="op" id="3692116">=</span>&nbsp;<span class="ident" id="3692118">time</span><span class="op" id="3692122">.</span><span class="ident" id="3692123">After</span><span class="op" id="3692128">(</span><span class="ident" id="3692129">d</span><span class="op" id="3692130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3692135">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692139">case</span>&nbsp;<span class="op" id="3692144">&lt;-</span><span class="ident" id="3692146">pconnDeadCh</span><span class="op" id="3692157">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692162">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692215">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692275">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692332">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692386">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692445">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692503">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692560">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692594">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692600">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692665">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3692721">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692764">pconnDeadCh</span>&nbsp;<span class="op" id="3692776">=</span>&nbsp;<span class="ident" id="3692778">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3692812">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692833">failTicker</span>&nbsp;<span class="op" id="3692844">=</span>&nbsp;<span class="ident" id="3692846">time</span><span class="op" id="3692850">.</span><span class="ident" id="3692851">After</span><span class="op" id="3692856">(</span><span class="num" id="3692857">100</span>&nbsp;<span class="op" id="3692861">*</span>&nbsp;<span class="ident" id="3692863">time</span><span class="op" id="3692867">.</span><span class="ident" id="3692868">Millisecond</span><span class="op" id="3692879">)</span>&nbsp;<span class="comment" id="3692881">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692918">case</span>&nbsp;<span class="op" id="3692923">&lt;-</span><span class="ident" id="3692925">failTicker</span><span class="op" id="3692935">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3692940">re</span>&nbsp;<span class="op" id="3692943">=</span>&nbsp;<span class="ident" id="3692945">responseAndError</span><span class="op" id="3692961">{</span><span class="ident" id="3692962">err</span><span class="op" id="3692965">:</span>&nbsp;<span class="ident" id="3692967">errClosed</span><span class="op" id="3692976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3692981">break</span>&nbsp;<span class="ident" id="3692987">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693002">case</span>&nbsp;<span class="op" id="3693007">&lt;-</span><span class="ident" id="3693009">respHeaderTimer</span><span class="op" id="3693024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693029">pc</span><span class="op" id="3693031">.</span><span class="builtinfunc" id="3693032">close</span><span class="op" id="3693037">(</span><span class="op" id="3693038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693043">re</span>&nbsp;<span class="op" id="3693046">=</span>&nbsp;<span class="ident" id="3693048">responseAndError</span><span class="op" id="3693064">{</span><span class="ident" id="3693065">err</span><span class="op" id="3693068">:</span>&nbsp;<span class="ident" id="3693070">errTimeout</span><span class="op" id="3693080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693085">break</span>&nbsp;<span class="ident" id="3693091">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693106">case</span>&nbsp;<span class="ident" id="3693111">re</span>&nbsp;<span class="op" id="3693114">=</span>&nbsp;<span class="op" id="3693116">&lt;-</span><span class="ident" id="3693118">resc</span><span class="op" id="3693122">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693127">break</span>&nbsp;<span class="ident" id="3693133">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693155">pc</span><span class="op" id="3693157">.</span><span class="ident" id="3693158">lk</span><span class="op" id="3693160">.</span><span class="ident" id="3693161">Lock</span><span class="op" id="3693165">(</span><span class="op" id="3693166">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693169">pc</span><span class="op" id="3693171">.</span><span class="ident" id="3693172">numExpectedResponses</span><span class="op" id="3693192">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693196">pc</span><span class="op" id="3693198">.</span><span class="ident" id="3693199">lk</span><span class="op" id="3693201">.</span><span class="ident" id="3693202">Unlock</span><span class="op" id="3693208">(</span><span class="op" id="3693209">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693213">if</span>&nbsp;<span class="ident" id="3693216">re</span><span class="op" id="3693218">.</span><span class="ident" id="3693219">err</span>&nbsp;<span class="op" id="3693223">!=</span>&nbsp;<span class="ident" id="3693226">nil</span>&nbsp;<span class="op" id="3693230">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693234">pc</span><span class="op" id="3693236">.</span><span class="ident" id="3693237">t</span><span class="op" id="3693238">.</span><span class="ident" id="3693239">setReqCanceler</span><span class="op" id="3693253">(</span><span class="ident" id="3693254">req</span><span class="op" id="3693257">.</span><span class="ident" id="3693258">Request</span><span class="op" id="3693265">,</span>&nbsp;<span class="ident" id="3693267">nil</span><span class="op" id="3693270">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693276">return</span>&nbsp;<span class="ident" id="3693283">re</span><span class="op" id="3693285">.</span><span class="ident" id="3693286">res</span><span class="op" id="3693289">,</span>&nbsp;<span class="ident" id="3693291">re</span><span class="op" id="3693293">.</span><span class="ident" id="3693294">err</span><br>
<span class="lineno"></span><span class="op" id="3693298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3693301">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3693366">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3693431">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3693481">func</span>&nbsp;<span class="op" id="3693486">(</span><span class="ident" id="3693487">pc</span>&nbsp;<span class="op" id="3693490">*</span><span class="ident" id="3693491">persistConn</span><span class="op" id="3693502">)</span>&nbsp;<span class="ident" id="3693504">markBroken</span><span class="op" id="3693514">(</span><span class="op" id="3693515">)</span>&nbsp;<span class="op" id="3693517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693520">pc</span><span class="op" id="3693522">.</span><span class="ident" id="3693523">lk</span><span class="op" id="3693525">.</span><span class="ident" id="3693526">Lock</span><span class="op" id="3693530">(</span><span class="op" id="3693531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693534">defer</span>&nbsp;<span class="ident" id="3693540">pc</span><span class="op" id="3693542">.</span><span class="ident" id="3693543">lk</span><span class="op" id="3693545">.</span><span class="ident" id="3693546">Unlock</span><span class="op" id="3693552">(</span><span class="op" id="3693553">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693556">pc</span><span class="op" id="3693558">.</span><span class="ident" id="3693559">broken</span>&nbsp;<span class="op" id="3693566">=</span>&nbsp;<span class="ident" id="3693568">true</span><br>
<span class="lineno"></span><span class="op" id="3693573">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3693576">func</span>&nbsp;<span class="op" id="3693581">(</span><span class="ident" id="3693582">pc</span>&nbsp;<span class="op" id="3693585">*</span><span class="ident" id="3693586">persistConn</span><span class="op" id="3693597">)</span>&nbsp;<span class="builtinfunc" id="3693599">close</span><span class="op" id="3693604">(</span><span class="op" id="3693605">)</span>&nbsp;<span class="op" id="3693607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693610">pc</span><span class="op" id="3693612">.</span><span class="ident" id="3693613">lk</span><span class="op" id="3693615">.</span><span class="ident" id="3693616">Lock</span><span class="op" id="3693620">(</span><span class="op" id="3693621">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693624">defer</span>&nbsp;<span class="ident" id="3693630">pc</span><span class="op" id="3693632">.</span><span class="ident" id="3693633">lk</span><span class="op" id="3693635">.</span><span class="ident" id="3693636">Unlock</span><span class="op" id="3693642">(</span><span class="op" id="3693643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693646">pc</span><span class="op" id="3693648">.</span><span class="ident" id="3693649">closeLocked</span><span class="op" id="3693660">(</span><span class="op" id="3693661">)</span><br>
<span class="lineno"></span><span class="op" id="3693663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3693666">func</span>&nbsp;<span class="op" id="3693671">(</span><span class="ident" id="3693672">pc</span>&nbsp;<span class="op" id="3693675">*</span><span class="ident" id="3693676">persistConn</span><span class="op" id="3693687">)</span>&nbsp;<span class="ident" id="3693689">closeLocked</span><span class="op" id="3693700">(</span><span class="op" id="3693701">)</span>&nbsp;<span class="op" id="3693703">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693706">pc</span><span class="op" id="3693708">.</span><span class="ident" id="3693709">broken</span>&nbsp;<span class="op" id="3693716">=</span>&nbsp;<span class="ident" id="3693718">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3693724">if</span>&nbsp;<span class="op" id="3693727">!</span><span class="ident" id="3693728">pc</span><span class="op" id="3693730">.</span><span class="ident" id="3693731">closed</span>&nbsp;<span class="op" id="3693738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693742">pc</span><span class="op" id="3693744">.</span><span class="ident" id="3693745">conn</span><span class="op" id="3693749">.</span><span class="ident" id="3693750">Close</span><span class="op" id="3693755">(</span><span class="op" id="3693756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693760">pc</span><span class="op" id="3693762">.</span><span class="ident" id="3693763">closed</span>&nbsp;<span class="op" id="3693770">=</span>&nbsp;<span class="ident" id="3693772">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3693779">close</span><span class="op" id="3693784">(</span><span class="ident" id="3693785">pc</span><span class="op" id="3693787">.</span><span class="ident" id="3693788">closech</span><span class="op" id="3693795">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3693798">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3693801">pc</span><span class="op" id="3693803">.</span><span class="ident" id="3693804">mutateHeaderFunc</span>&nbsp;<span class="op" id="3693821">=</span>&nbsp;<span class="ident" id="3693823">nil</span><br>
<span class="lineno"></span><span class="op" id="3693827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3693830">var</span>&nbsp;<span class="ident" id="3693834">portMap</span>&nbsp;<span class="op" id="3693842">=</span>&nbsp;<span class="keyword" id="3693844">map</span><span class="op" id="3693847">[</span><span class="builtintype" id="3693848">string</span><span class="op" id="3693854">]</span><span class="builtintype" id="3693855">string</span><span class="op" id="3693861">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693864">&#34;http&#34;</span><span class="op" id="3693870">:</span>&nbsp;&nbsp;<span class="string" id="3693873">&#34;80&#34;</span><span class="op" id="3693877">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3693880">&#34;https&#34;</span><span class="op" id="3693887">:</span>&nbsp;<span class="string" id="3693889">&#34;443&#34;</span><span class="op" id="3693894">,</span><br>
<span class="lineno"></span><span class="op" id="3693896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3693899">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3693966">func</span>&nbsp;<span class="ident" id="3693971">canonicalAddr</span><span class="op" id="3693984">(</span><span class="ident" id="3693985">url</span>&nbsp;<span class="op" id="3693989">*</span><span class="ident" id="3693990">url</span><span class="op" id="3693993">.</span><span class="ident" id="3693994">URL</span><span class="op" id="3693997">)</span>&nbsp;<span class="builtintype" id="3693999">string</span>&nbsp;<span class="op" id="3694006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694009">addr</span>&nbsp;<span class="op" id="3694014">:=</span>&nbsp;<span class="ident" id="3694017">url</span><span class="op" id="3694020">.</span><span class="ident" id="3694021">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694027">if</span>&nbsp;<span class="op" id="3694030">!</span><span class="ident" id="3694031">hasPort</span><span class="op" id="3694038">(</span><span class="ident" id="3694039">addr</span><span class="op" id="3694043">)</span>&nbsp;<span class="op" id="3694045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694049">return</span>&nbsp;<span class="ident" id="3694056">addr</span>&nbsp;<span class="op" id="3694061">+</span>&nbsp;<span class="string" id="3694063">&#34;:&#34;</span>&nbsp;<span class="op" id="3694067">+</span>&nbsp;<span class="ident" id="3694069">portMap</span><span class="op" id="3694076">[</span><span class="ident" id="3694077">url</span><span class="op" id="3694080">.</span><span class="ident" id="3694081">Scheme</span><span class="op" id="3694087">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694090">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694093">return</span>&nbsp;<span class="ident" id="3694100">addr</span><br>
<span class="lineno"></span><span class="op" id="3694105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3694108">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3694177">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3694246">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3694312">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3694377">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3694425">type</span>&nbsp;<span class="ident" id="3694430">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3694444">struct</span>&nbsp;<span class="op" id="3694451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694454">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694467">io</span><span class="op" id="3694469">.</span><span class="ident" id="3694470">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694482">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3694495">sync</span><span class="op" id="3694499">.</span><span class="ident" id="3694500">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3694508">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694538">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3694551">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3694564">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694598">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3694611">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3694624">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694646">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3694659">func</span><span class="op" id="3694663">(</span><span class="builtintype" id="3694664">error</span><span class="op" id="3694669">)</span>&nbsp;&nbsp;<span class="comment" id="3694672">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694709">earlyCloseFn</span>&nbsp;<span class="keyword" id="3694722">func</span><span class="op" id="3694726">(</span><span class="op" id="3694727">)</span>&nbsp;<span class="builtintype" id="3694729">error</span>&nbsp;<span class="comment" id="3694735">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3694786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3694789">func</span>&nbsp;<span class="op" id="3694794">(</span><span class="ident" id="3694795">es</span>&nbsp;<span class="op" id="3694798">*</span><span class="ident" id="3694799">bodyEOFSignal</span><span class="op" id="3694812">)</span>&nbsp;<span class="ident" id="3694814">Read</span><span class="op" id="3694818">(</span><span class="ident" id="3694819">p</span>&nbsp;<span class="op" id="3694821">[</span><span class="op" id="3694822">]</span><span class="builtintype" id="3694823">byte</span><span class="op" id="3694827">)</span>&nbsp;<span class="op" id="3694829">(</span><span class="ident" id="3694830">n</span>&nbsp;<span class="builtintype" id="3694832">int</span><span class="op" id="3694835">,</span>&nbsp;<span class="ident" id="3694837">err</span>&nbsp;<span class="builtintype" id="3694841">error</span><span class="op" id="3694846">)</span>&nbsp;<span class="op" id="3694848">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694851">es</span><span class="op" id="3694853">.</span><span class="ident" id="3694854">mu</span><span class="op" id="3694856">.</span><span class="ident" id="3694857">Lock</span><span class="op" id="3694861">(</span><span class="op" id="3694862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694865">closed</span><span class="op" id="3694871">,</span>&nbsp;<span class="ident" id="3694873">rerr</span>&nbsp;<span class="op" id="3694878">:=</span>&nbsp;<span class="ident" id="3694881">es</span><span class="op" id="3694883">.</span><span class="ident" id="3694884">closed</span><span class="op" id="3694890">,</span>&nbsp;<span class="ident" id="3694892">es</span><span class="op" id="3694894">.</span><span class="ident" id="3694895">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3694901">es</span><span class="op" id="3694903">.</span><span class="ident" id="3694904">mu</span><span class="op" id="3694906">.</span><span class="ident" id="3694907">Unlock</span><span class="op" id="3694913">(</span><span class="op" id="3694914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694917">if</span>&nbsp;<span class="ident" id="3694920">closed</span>&nbsp;<span class="op" id="3694927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694931">return</span>&nbsp;<span class="num" id="3694938">0</span><span class="op" id="3694939">,</span>&nbsp;<span class="ident" id="3694941">errors</span><span class="op" id="3694947">.</span><span class="ident" id="3694948">New</span><span class="op" id="3694951">(</span><span class="string" id="3694952">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="3694988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3694991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3694994">if</span>&nbsp;<span class="ident" id="3694997">rerr</span>&nbsp;<span class="op" id="3695002">!=</span>&nbsp;<span class="ident" id="3695005">nil</span>&nbsp;<span class="op" id="3695009">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695013">return</span>&nbsp;<span class="num" id="3695020">0</span><span class="op" id="3695021">,</span>&nbsp;<span class="ident" id="3695023">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695033">n</span><span class="op" id="3695034">,</span>&nbsp;<span class="ident" id="3695036">err</span>&nbsp;<span class="op" id="3695040">=</span>&nbsp;<span class="ident" id="3695042">es</span><span class="op" id="3695044">.</span><span class="ident" id="3695045">body</span><span class="op" id="3695049">.</span><span class="ident" id="3695050">Read</span><span class="op" id="3695054">(</span><span class="ident" id="3695055">p</span><span class="op" id="3695056">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695059">if</span>&nbsp;<span class="ident" id="3695062">err</span>&nbsp;<span class="op" id="3695066">!=</span>&nbsp;<span class="ident" id="3695069">nil</span>&nbsp;<span class="op" id="3695073">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695077">es</span><span class="op" id="3695079">.</span><span class="ident" id="3695080">mu</span><span class="op" id="3695082">.</span><span class="ident" id="3695083">Lock</span><span class="op" id="3695087">(</span><span class="op" id="3695088">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695092">defer</span>&nbsp;<span class="ident" id="3695098">es</span><span class="op" id="3695100">.</span><span class="ident" id="3695101">mu</span><span class="op" id="3695103">.</span><span class="ident" id="3695104">Unlock</span><span class="op" id="3695110">(</span><span class="op" id="3695111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695115">if</span>&nbsp;<span class="ident" id="3695118">es</span><span class="op" id="3695120">.</span><span class="ident" id="3695121">rerr</span>&nbsp;<span class="op" id="3695126">==</span>&nbsp;<span class="ident" id="3695129">nil</span>&nbsp;<span class="op" id="3695133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695138">es</span><span class="op" id="3695140">.</span><span class="ident" id="3695141">rerr</span>&nbsp;<span class="op" id="3695146">=</span>&nbsp;<span class="ident" id="3695148">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695154">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695158">es</span><span class="op" id="3695160">.</span><span class="ident" id="3695161">condfn</span><span class="op" id="3695167">(</span><span class="ident" id="3695168">err</span><span class="op" id="3695171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695177">return</span><br>
<span class="lineno"></span><span class="op" id="3695184">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="3695187">func</span>&nbsp;<span class="op" id="3695192">(</span><span class="ident" id="3695193">es</span>&nbsp;<span class="op" id="3695196">*</span><span class="ident" id="3695197">bodyEOFSignal</span><span class="op" id="3695210">)</span>&nbsp;<span class="ident" id="3695212">Close</span><span class="op" id="3695217">(</span><span class="op" id="3695218">)</span>&nbsp;<span class="builtintype" id="3695220">error</span>&nbsp;<span class="op" id="3695226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695229">es</span><span class="op" id="3695231">.</span><span class="ident" id="3695232">mu</span><span class="op" id="3695234">.</span><span class="ident" id="3695235">Lock</span><span class="op" id="3695239">(</span><span class="op" id="3695240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695243">defer</span>&nbsp;<span class="ident" id="3695249">es</span><span class="op" id="3695251">.</span><span class="ident" id="3695252">mu</span><span class="op" id="3695254">.</span><span class="ident" id="3695255">Unlock</span><span class="op" id="3695261">(</span><span class="op" id="3695262">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695265">if</span>&nbsp;<span class="ident" id="3695268">es</span><span class="op" id="3695270">.</span><span class="ident" id="3695271">closed</span>&nbsp;<span class="op" id="3695278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695282">return</span>&nbsp;<span class="ident" id="3695289">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695297">es</span><span class="op" id="3695299">.</span><span class="ident" id="3695300">closed</span>&nbsp;<span class="op" id="3695307">=</span>&nbsp;<span class="ident" id="3695309">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695315">if</span>&nbsp;<span class="ident" id="3695318">es</span><span class="op" id="3695320">.</span><span class="ident" id="3695321">earlyCloseFn</span>&nbsp;<span class="op" id="3695334">!=</span>&nbsp;<span class="ident" id="3695337">nil</span>&nbsp;<span class="op" id="3695341">&amp;&amp;</span>&nbsp;<span class="ident" id="3695344">es</span><span class="op" id="3695346">.</span><span class="ident" id="3695347">rerr</span>&nbsp;<span class="op" id="3695352">!=</span>&nbsp;<span class="ident" id="3695355">io</span><span class="op" id="3695357">.</span><span class="ident" id="3695358">EOF</span>&nbsp;<span class="op" id="3695362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695366">return</span>&nbsp;<span class="ident" id="3695373">es</span><span class="op" id="3695375">.</span><span class="ident" id="3695376">earlyCloseFn</span><span class="op" id="3695388">(</span><span class="op" id="3695389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695392">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695395">err</span>&nbsp;<span class="op" id="3695399">:=</span>&nbsp;<span class="ident" id="3695402">es</span><span class="op" id="3695404">.</span><span class="ident" id="3695405">body</span><span class="op" id="3695409">.</span><span class="ident" id="3695410">Close</span><span class="op" id="3695415">(</span><span class="op" id="3695416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695419">es</span><span class="op" id="3695421">.</span><span class="ident" id="3695422">condfn</span><span class="op" id="3695428">(</span><span class="ident" id="3695429">err</span><span class="op" id="3695432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695435">return</span>&nbsp;<span class="ident" id="3695442">err</span><br>
<span class="lineno"></span><span class="op" id="3695446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="3695449">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="3695476">func</span>&nbsp;<span class="op" id="3695481">(</span><span class="ident" id="3695482">es</span>&nbsp;<span class="op" id="3695485">*</span><span class="ident" id="3695486">bodyEOFSignal</span><span class="op" id="3695499">)</span>&nbsp;<span class="ident" id="3695501">condfn</span><span class="op" id="3695507">(</span><span class="ident" id="3695508">err</span>&nbsp;<span class="builtintype" id="3695512">error</span><span class="op" id="3695517">)</span>&nbsp;<span class="op" id="3695519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695522">if</span>&nbsp;<span class="ident" id="3695525">es</span><span class="op" id="3695527">.</span><span class="ident" id="3695528">fn</span>&nbsp;<span class="op" id="3695531">==</span>&nbsp;<span class="ident" id="3695534">nil</span>&nbsp;<span class="op" id="3695538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695542">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695550">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695553">if</span>&nbsp;<span class="ident" id="3695556">err</span>&nbsp;<span class="op" id="3695560">==</span>&nbsp;<span class="ident" id="3695563">io</span><span class="op" id="3695565">.</span><span class="ident" id="3695566">EOF</span>&nbsp;<span class="op" id="3695570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695574">err</span>&nbsp;<span class="op" id="3695578">=</span>&nbsp;<span class="ident" id="3695580">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3695585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695588">es</span><span class="op" id="3695590">.</span><span class="ident" id="3695591">fn</span><span class="op" id="3695593">(</span><span class="ident" id="3695594">err</span><span class="op" id="3695597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695600">es</span><span class="op" id="3695602">.</span><span class="ident" id="3695603">fn</span>&nbsp;<span class="op" id="3695606">=</span>&nbsp;<span class="ident" id="3695608">nil</span><br>
<span class="lineno">1230</span><span class="op" id="3695612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3695615">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="3695668">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="3695717">type</span>&nbsp;<span class="ident" id="3695722">gzipReader</span>&nbsp;<span class="keyword" id="3695733">struct</span>&nbsp;<span class="op" id="3695740">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695743">body</span>&nbsp;<span class="ident" id="3695748">io</span><span class="op" id="3695750">.</span><span class="ident" id="3695751">ReadCloser</span>&nbsp;<span class="comment" id="3695762">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695791">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3695796">io</span><span class="op" id="3695798">.</span><span class="ident" id="3695799">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3695810">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="3695844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3695847">func</span>&nbsp;<span class="op" id="3695852">(</span><span class="ident" id="3695853">gz</span>&nbsp;<span class="op" id="3695856">*</span><span class="ident" id="3695857">gzipReader</span><span class="op" id="3695867">)</span>&nbsp;<span class="ident" id="3695869">Read</span><span class="op" id="3695873">(</span><span class="ident" id="3695874">p</span>&nbsp;<span class="op" id="3695876">[</span><span class="op" id="3695877">]</span><span class="builtintype" id="3695878">byte</span><span class="op" id="3695882">)</span>&nbsp;<span class="op" id="3695884">(</span><span class="ident" id="3695885">n</span>&nbsp;<span class="builtintype" id="3695887">int</span><span class="op" id="3695890">,</span>&nbsp;<span class="ident" id="3695892">err</span>&nbsp;<span class="builtintype" id="3695896">error</span><span class="op" id="3695901">)</span>&nbsp;<span class="op" id="3695903">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695906">if</span>&nbsp;<span class="ident" id="3695909">gz</span><span class="op" id="3695911">.</span><span class="ident" id="3695912">zr</span>&nbsp;<span class="op" id="3695915">==</span>&nbsp;<span class="ident" id="3695918">nil</span>&nbsp;<span class="op" id="3695922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3695926">gz</span><span class="op" id="3695928">.</span><span class="ident" id="3695929">zr</span><span class="op" id="3695931">,</span>&nbsp;<span class="ident" id="3695933">err</span>&nbsp;<span class="op" id="3695937">=</span>&nbsp;<span class="ident" id="3695939">gzip</span><span class="op" id="3695943">.</span><span class="ident" id="3695944">NewReader</span><span class="op" id="3695953">(</span><span class="ident" id="3695954">gz</span><span class="op" id="3695956">.</span><span class="ident" id="3695957">body</span><span class="op" id="3695961">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695965">if</span>&nbsp;<span class="ident" id="3695968">err</span>&nbsp;<span class="op" id="3695972">!=</span>&nbsp;<span class="ident" id="3695975">nil</span>&nbsp;<span class="op" id="3695979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3695984">return</span>&nbsp;<span class="num" id="3695991">0</span><span class="op" id="3695992">,</span>&nbsp;<span class="ident" id="3695994">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696000">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696006">return</span>&nbsp;<span class="ident" id="3696013">gz</span><span class="op" id="3696015">.</span><span class="ident" id="3696016">zr</span><span class="op" id="3696018">.</span><span class="ident" id="3696019">Read</span><span class="op" id="3696023">(</span><span class="ident" id="3696024">p</span><span class="op" id="3696025">)</span><br>
<span class="lineno"></span><span class="op" id="3696027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696030">func</span>&nbsp;<span class="op" id="3696035">(</span><span class="ident" id="3696036">gz</span>&nbsp;<span class="op" id="3696039">*</span><span class="ident" id="3696040">gzipReader</span><span class="op" id="3696050">)</span>&nbsp;<span class="ident" id="3696052">Close</span><span class="op" id="3696057">(</span><span class="op" id="3696058">)</span>&nbsp;<span class="builtintype" id="3696060">error</span>&nbsp;<span class="op" id="3696066">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696069">return</span>&nbsp;<span class="ident" id="3696076">gz</span><span class="op" id="3696078">.</span><span class="ident" id="3696079">body</span><span class="op" id="3696083">.</span><span class="ident" id="3696084">Close</span><span class="op" id="3696089">(</span><span class="op" id="3696090">)</span><br>
<span class="lineno"></span><span class="op" id="3696092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696095">type</span>&nbsp;<span class="ident" id="3696100">readerAndCloser</span>&nbsp;<span class="keyword" id="3696116">struct</span>&nbsp;<span class="op" id="3696123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696126">io</span><span class="op" id="3696128">.</span><span class="ident" id="3696129">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696137">io</span><span class="op" id="3696139">.</span><span class="ident" id="3696140">Closer</span><br>
<span class="lineno"></span><span class="op" id="3696147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696150">type</span>&nbsp;<span class="ident" id="3696155">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="3696180">struct</span><span class="op" id="3696186">{</span><span class="op" id="3696187">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="3696190">func</span>&nbsp;<span class="op" id="3696195">(</span><span class="ident" id="3696196">tlsHandshakeTimeoutError</span><span class="op" id="3696220">)</span>&nbsp;<span class="ident" id="3696222">Timeout</span><span class="op" id="3696229">(</span><span class="op" id="3696230">)</span>&nbsp;<span class="builtintype" id="3696232">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3696239">{</span>&nbsp;<span class="keyword" id="3696241">return</span>&nbsp;<span class="ident" id="3696248">true</span>&nbsp;<span class="op" id="3696253">}</span><br>
<span class="lineno"></span><span class="keyword" id="3696255">func</span>&nbsp;<span class="op" id="3696260">(</span><span class="ident" id="3696261">tlsHandshakeTimeoutError</span><span class="op" id="3696285">)</span>&nbsp;<span class="ident" id="3696287">Temporary</span><span class="op" id="3696296">(</span><span class="op" id="3696297">)</span>&nbsp;<span class="builtintype" id="3696299">bool</span>&nbsp;<span class="op" id="3696304">{</span>&nbsp;<span class="keyword" id="3696306">return</span>&nbsp;<span class="ident" id="3696313">true</span>&nbsp;<span class="op" id="3696318">}</span><br>
<span class="lineno"></span><span class="keyword" id="3696320">func</span>&nbsp;<span class="op" id="3696325">(</span><span class="ident" id="3696326">tlsHandshakeTimeoutError</span><span class="op" id="3696350">)</span>&nbsp;<span class="ident" id="3696352">Error</span><span class="op" id="3696357">(</span><span class="op" id="3696358">)</span>&nbsp;<span class="builtintype" id="3696360">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3696369">{</span>&nbsp;<span class="keyword" id="3696371">return</span>&nbsp;<span class="string" id="3696378">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="3696412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696415">type</span>&nbsp;<span class="ident" id="3696420">noteEOFReader</span>&nbsp;<span class="keyword" id="3696434">struct</span>&nbsp;<span class="op" id="3696441">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696444">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3696451">io</span><span class="op" id="3696453">.</span><span class="ident" id="3696454">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696462">sawEOF</span>&nbsp;<span class="op" id="3696469">*</span><span class="builtintype" id="3696470">bool</span><br>
<span class="lineno"></span><span class="op" id="3696475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3696478">func</span>&nbsp;<span class="op" id="3696483">(</span><span class="ident" id="3696484">nr</span>&nbsp;<span class="ident" id="3696487">noteEOFReader</span><span class="op" id="3696500">)</span>&nbsp;<span class="ident" id="3696502">Read</span><span class="op" id="3696506">(</span><span class="ident" id="3696507">p</span>&nbsp;<span class="op" id="3696509">[</span><span class="op" id="3696510">]</span><span class="builtintype" id="3696511">byte</span><span class="op" id="3696515">)</span>&nbsp;<span class="op" id="3696517">(</span><span class="ident" id="3696518">n</span>&nbsp;<span class="builtintype" id="3696520">int</span><span class="op" id="3696523">,</span>&nbsp;<span class="ident" id="3696525">err</span>&nbsp;<span class="builtintype" id="3696529">error</span><span class="op" id="3696534">)</span>&nbsp;<span class="op" id="3696536">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3696539">n</span><span class="op" id="3696540">,</span>&nbsp;<span class="ident" id="3696542">err</span>&nbsp;<span class="op" id="3696546">=</span>&nbsp;<span class="ident" id="3696548">nr</span><span class="op" id="3696550">.</span><span class="ident" id="3696551">r</span><span class="op" id="3696552">.</span><span class="ident" id="3696553">Read</span><span class="op" id="3696557">(</span><span class="ident" id="3696558">p</span><span class="op" id="3696559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696562">if</span>&nbsp;<span class="ident" id="3696565">err</span>&nbsp;<span class="op" id="3696569">==</span>&nbsp;<span class="ident" id="3696572">io</span><span class="op" id="3696574">.</span><span class="ident" id="3696575">EOF</span>&nbsp;<span class="op" id="3696579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696583">*</span><span class="ident" id="3696584">nr</span><span class="op" id="3696586">.</span><span class="ident" id="3696587">sawEOF</span>&nbsp;<span class="op" id="3696594">=</span>&nbsp;<span class="ident" id="3696596">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3696602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3696605">return</span><br>
<span class="lineno">1275</span><span class="op" id="3696612">}</span>
</div>
</body>
</html>
