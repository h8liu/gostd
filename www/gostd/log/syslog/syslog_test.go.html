<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>log/syslog</h2>
<ul>
<li><a href="/gostd/log/syslog/syslog.go.html">syslog.go</a></li>
<li><a href="/gostd/log/syslog/syslog_test.go.html" class="current">syslog_test.go</a></li>
<li><a href="/gostd/log/syslog/syslog_unix.go.html">syslog_unix.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="7891870">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7891925">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7891979">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7892030">//&nbsp;+build&nbsp;!windows,!nacl,!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7892063">package</span>&nbsp;<span class="ident" id="7892071">syslog</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7892079">import</span>&nbsp;<span class="op" id="7892086">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892089">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892098">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892105">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892111">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892124">&#34;log&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892131">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892138">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892144">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892152">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7892163">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="7892170">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7892173">func</span>&nbsp;<span class="ident" id="7892178">runPktSyslog</span><span class="op" id="7892190">(</span><span class="ident" id="7892191">c</span>&nbsp;<span class="ident" id="7892193">net</span><span class="op" id="7892196">.</span><span class="ident" id="7892197">PacketConn</span><span class="op" id="7892207">,</span>&nbsp;<span class="ident" id="7892209">done</span>&nbsp;<span class="keyword" id="7892214">chan</span><span class="op" id="7892218">&lt;-</span>&nbsp;<span class="builtintype" id="7892221">string</span><span class="op" id="7892227">)</span>&nbsp;<span class="op" id="7892229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892232">var</span>&nbsp;<span class="ident" id="7892236">buf</span>&nbsp;<span class="op" id="7892240">[</span><span class="num" id="7892241">4096</span><span class="op" id="7892245">]</span><span class="builtintype" id="7892246">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892252">var</span>&nbsp;<span class="ident" id="7892256">rcvd</span>&nbsp;<span class="builtintype" id="7892261">string</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892269">ct</span>&nbsp;<span class="op" id="7892272">:=</span>&nbsp;<span class="num" id="7892275">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892278">for</span>&nbsp;<span class="op" id="7892282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892286">var</span>&nbsp;<span class="ident" id="7892290">n</span>&nbsp;<span class="builtintype" id="7892292">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892298">var</span>&nbsp;<span class="ident" id="7892302">err</span>&nbsp;<span class="builtintype" id="7892306">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892315">c</span><span class="op" id="7892316">.</span><span class="ident" id="7892317">SetReadDeadline</span><span class="op" id="7892332">(</span><span class="ident" id="7892333">time</span><span class="op" id="7892337">.</span><span class="ident" id="7892338">Now</span><span class="op" id="7892341">(</span><span class="op" id="7892342">)</span><span class="op" id="7892343">.</span><span class="ident" id="7892344">Add</span><span class="op" id="7892347">(</span><span class="num" id="7892348">100</span>&nbsp;<span class="op" id="7892352">*</span>&nbsp;<span class="ident" id="7892354">time</span><span class="op" id="7892358">.</span><span class="ident" id="7892359">Millisecond</span><span class="op" id="7892370">)</span><span class="op" id="7892371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892375">n</span><span class="op" id="7892376">,</span>&nbsp;<span class="ident" id="7892378">_</span><span class="op" id="7892379">,</span>&nbsp;<span class="ident" id="7892381">err</span>&nbsp;<span class="op" id="7892385">=</span>&nbsp;<span class="ident" id="7892387">c</span><span class="op" id="7892388">.</span><span class="ident" id="7892389">ReadFrom</span><span class="op" id="7892397">(</span><span class="ident" id="7892398">buf</span><span class="op" id="7892401">[</span><span class="op" id="7892402">:</span><span class="op" id="7892403">]</span><span class="op" id="7892404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892408">rcvd</span>&nbsp;<span class="op" id="7892413">+=</span>&nbsp;<span class="builtintype" id="7892416">string</span><span class="op" id="7892422">(</span><span class="ident" id="7892423">buf</span><span class="op" id="7892426">[</span><span class="op" id="7892427">:</span><span class="ident" id="7892428">n</span><span class="op" id="7892429">]</span><span class="op" id="7892430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892434">if</span>&nbsp;<span class="ident" id="7892437">err</span>&nbsp;<span class="op" id="7892441">!=</span>&nbsp;<span class="ident" id="7892444">nil</span>&nbsp;<span class="op" id="7892448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892453">if</span>&nbsp;<span class="ident" id="7892456">oe</span><span class="op" id="7892458">,</span>&nbsp;<span class="ident" id="7892460">ok</span>&nbsp;<span class="op" id="7892463">:=</span>&nbsp;<span class="ident" id="7892466">err</span><span class="op" id="7892469">.</span><span class="op" id="7892470">(</span><span class="op" id="7892471">*</span><span class="ident" id="7892472">net</span><span class="op" id="7892475">.</span><span class="ident" id="7892476">OpError</span><span class="op" id="7892483">)</span><span class="op" id="7892484">;</span>&nbsp;<span class="ident" id="7892486">ok</span>&nbsp;<span class="op" id="7892489">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892495">if</span>&nbsp;<span class="ident" id="7892498">ct</span>&nbsp;<span class="op" id="7892501">&lt;</span>&nbsp;<span class="num" id="7892503">3</span>&nbsp;<span class="op" id="7892505">&amp;&amp;</span>&nbsp;<span class="ident" id="7892508">oe</span><span class="op" id="7892510">.</span><span class="ident" id="7892511">Temporary</span><span class="op" id="7892520">(</span><span class="op" id="7892521">)</span>&nbsp;<span class="op" id="7892523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892530">ct</span><span class="op" id="7892532">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892540">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892558">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892563">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892577">c</span><span class="op" id="7892578">.</span><span class="ident" id="7892579">Close</span><span class="op" id="7892584">(</span><span class="op" id="7892585">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892588">done</span>&nbsp;<span class="op" id="7892593">&lt;-</span>&nbsp;<span class="ident" id="7892596">rcvd</span><br>
<span class="lineno">45</span><span class="op" id="7892601">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7892604">var</span>&nbsp;<span class="ident" id="7892608">crashy</span>&nbsp;<span class="op" id="7892615">=</span>&nbsp;<span class="builtintype" id="7892617">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7892624">func</span>&nbsp;<span class="ident" id="7892629">runStreamSyslog</span><span class="op" id="7892644">(</span><span class="ident" id="7892645">l</span>&nbsp;<span class="ident" id="7892647">net</span><span class="op" id="7892650">.</span><span class="ident" id="7892651">Listener</span><span class="op" id="7892659">,</span>&nbsp;<span class="ident" id="7892661">done</span>&nbsp;<span class="keyword" id="7892666">chan</span><span class="op" id="7892670">&lt;-</span>&nbsp;<span class="builtintype" id="7892673">string</span><span class="op" id="7892679">,</span>&nbsp;<span class="ident" id="7892681">wg</span>&nbsp;<span class="op" id="7892684">*</span><span class="ident" id="7892685">sync</span><span class="op" id="7892689">.</span><span class="ident" id="7892690">WaitGroup</span><span class="op" id="7892699">)</span>&nbsp;<span class="op" id="7892701">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892704">for</span>&nbsp;<span class="op" id="7892708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892712">var</span>&nbsp;<span class="ident" id="7892716">c</span>&nbsp;<span class="ident" id="7892718">net</span><span class="op" id="7892721">.</span><span class="ident" id="7892722">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892729">var</span>&nbsp;<span class="ident" id="7892733">err</span>&nbsp;<span class="builtintype" id="7892737">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892745">if</span>&nbsp;<span class="ident" id="7892748">c</span><span class="op" id="7892749">,</span>&nbsp;<span class="ident" id="7892751">err</span>&nbsp;<span class="op" id="7892755">=</span>&nbsp;<span class="ident" id="7892757">l</span><span class="op" id="7892758">.</span><span class="ident" id="7892759">Accept</span><span class="op" id="7892765">(</span><span class="op" id="7892766">)</span><span class="op" id="7892767">;</span>&nbsp;<span class="ident" id="7892769">err</span>&nbsp;<span class="op" id="7892773">!=</span>&nbsp;<span class="ident" id="7892776">nil</span>&nbsp;<span class="op" id="7892780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892785">return</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7892794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892798">wg</span><span class="op" id="7892800">.</span><span class="ident" id="7892801">Add</span><span class="op" id="7892804">(</span><span class="num" id="7892805">1</span><span class="op" id="7892806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892810">go</span>&nbsp;<span class="keyword" id="7892813">func</span><span class="op" id="7892817">(</span><span class="ident" id="7892818">c</span>&nbsp;<span class="ident" id="7892820">net</span><span class="op" id="7892823">.</span><span class="ident" id="7892824">Conn</span><span class="op" id="7892828">)</span>&nbsp;<span class="op" id="7892830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892835">defer</span>&nbsp;<span class="ident" id="7892841">wg</span><span class="op" id="7892843">.</span><span class="ident" id="7892844">Done</span><span class="op" id="7892848">(</span><span class="op" id="7892849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892854">c</span><span class="op" id="7892855">.</span><span class="ident" id="7892856">SetReadDeadline</span><span class="op" id="7892871">(</span><span class="ident" id="7892872">time</span><span class="op" id="7892876">.</span><span class="ident" id="7892877">Now</span><span class="op" id="7892880">(</span><span class="op" id="7892881">)</span><span class="op" id="7892882">.</span><span class="ident" id="7892883">Add</span><span class="op" id="7892886">(</span><span class="num" id="7892887">5</span>&nbsp;<span class="op" id="7892889">*</span>&nbsp;<span class="ident" id="7892891">time</span><span class="op" id="7892895">.</span><span class="ident" id="7892896">Second</span><span class="op" id="7892902">)</span><span class="op" id="7892903">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892908">b</span>&nbsp;<span class="op" id="7892910">:=</span>&nbsp;<span class="ident" id="7892913">bufio</span><span class="op" id="7892918">.</span><span class="ident" id="7892919">NewReader</span><span class="op" id="7892928">(</span><span class="ident" id="7892929">c</span><span class="op" id="7892930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7892935">for</span>&nbsp;<span class="ident" id="7892939">ct</span>&nbsp;<span class="op" id="7892942">:=</span>&nbsp;<span class="num" id="7892945">1</span><span class="op" id="7892946">;</span>&nbsp;<span class="op" id="7892948">!</span><span class="ident" id="7892949">crashy</span>&nbsp;<span class="op" id="7892956">||</span>&nbsp;<span class="ident" id="7892959">ct</span><span class="op" id="7892961">&amp;</span><span class="num" id="7892962">7</span>&nbsp;<span class="op" id="7892964">!=</span>&nbsp;<span class="num" id="7892967">0</span><span class="op" id="7892968">;</span>&nbsp;<span class="ident" id="7892970">ct</span><span class="op" id="7892972">++</span>&nbsp;<span class="op" id="7892975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7892981">s</span><span class="op" id="7892982">,</span>&nbsp;<span class="ident" id="7892984">err</span>&nbsp;<span class="op" id="7892988">:=</span>&nbsp;<span class="ident" id="7892991">b</span><span class="op" id="7892992">.</span><span class="ident" id="7892993">ReadString</span><span class="op" id="7893003">(</span><span class="string" id="7893004">&#39;\n&#39;</span><span class="op" id="7893008">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893014">if</span>&nbsp;<span class="ident" id="7893017">err</span>&nbsp;<span class="op" id="7893021">!=</span>&nbsp;<span class="ident" id="7893024">nil</span>&nbsp;<span class="op" id="7893028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893035">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893045">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893051">done</span>&nbsp;<span class="op" id="7893056">&lt;-</span>&nbsp;<span class="ident" id="7893059">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893069">c</span><span class="op" id="7893070">.</span><span class="ident" id="7893071">Close</span><span class="op" id="7893076">(</span><span class="op" id="7893077">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893081">}</span><span class="op" id="7893082">(</span><span class="ident" id="7893083">c</span><span class="op" id="7893084">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893087">}</span><br>
<span class="lineno"></span><span class="op" id="7893089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7893092">func</span>&nbsp;<span class="ident" id="7893097">startServer</span><span class="op" id="7893108">(</span><span class="ident" id="7893109">n</span><span class="op" id="7893110">,</span>&nbsp;<span class="ident" id="7893112">la</span>&nbsp;<span class="builtintype" id="7893115">string</span><span class="op" id="7893121">,</span>&nbsp;<span class="ident" id="7893123">done</span>&nbsp;<span class="keyword" id="7893128">chan</span><span class="op" id="7893132">&lt;-</span>&nbsp;<span class="builtintype" id="7893135">string</span><span class="op" id="7893141">)</span>&nbsp;<span class="op" id="7893143">(</span><span class="ident" id="7893144">addr</span>&nbsp;<span class="builtintype" id="7893149">string</span><span class="op" id="7893155">,</span>&nbsp;<span class="ident" id="7893157">sock</span>&nbsp;<span class="ident" id="7893162">io</span><span class="op" id="7893164">.</span><span class="ident" id="7893165">Closer</span><span class="op" id="7893171">,</span>&nbsp;<span class="ident" id="7893173">wg</span>&nbsp;<span class="op" id="7893176">*</span><span class="ident" id="7893177">sync</span><span class="op" id="7893181">.</span><span class="ident" id="7893182">WaitGroup</span><span class="op" id="7893191">)</span>&nbsp;<span class="op" id="7893193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893196">if</span>&nbsp;<span class="ident" id="7893199">n</span>&nbsp;<span class="op" id="7893201">==</span>&nbsp;<span class="string" id="7893204">&#34;udp&#34;</span>&nbsp;<span class="op" id="7893210">||</span>&nbsp;<span class="ident" id="7893213">n</span>&nbsp;<span class="op" id="7893215">==</span>&nbsp;<span class="string" id="7893218">&#34;tcp&#34;</span>&nbsp;<span class="op" id="7893224">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893228">la</span>&nbsp;<span class="op" id="7893231">=</span>&nbsp;<span class="string" id="7893233">&#34;127.0.0.1:0&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893248">}</span>&nbsp;<span class="keyword" id="7893250">else</span>&nbsp;<span class="op" id="7893255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7893259">//&nbsp;unix&nbsp;and&nbsp;unixgram:&nbsp;choose&nbsp;an&nbsp;address&nbsp;if&nbsp;none&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893315">if</span>&nbsp;<span class="ident" id="7893318">la</span>&nbsp;<span class="op" id="7893321">==</span>&nbsp;<span class="string" id="7893324">&#34;&#34;</span>&nbsp;<span class="op" id="7893327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7893332">//&nbsp;use&nbsp;ioutil.TempFile&nbsp;to&nbsp;get&nbsp;a&nbsp;name&nbsp;that&nbsp;is&nbsp;unique</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893387">f</span><span class="op" id="7893388">,</span>&nbsp;<span class="ident" id="7893390">err</span>&nbsp;<span class="op" id="7893394">:=</span>&nbsp;<span class="ident" id="7893397">ioutil</span><span class="op" id="7893403">.</span><span class="ident" id="7893404">TempFile</span><span class="op" id="7893412">(</span><span class="string" id="7893413">&#34;&#34;</span><span class="op" id="7893415">,</span>&nbsp;<span class="string" id="7893417">&#34;syslogtest&#34;</span><span class="op" id="7893429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893434">if</span>&nbsp;<span class="ident" id="7893437">err</span>&nbsp;<span class="op" id="7893441">!=</span>&nbsp;<span class="ident" id="7893444">nil</span>&nbsp;<span class="op" id="7893448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893454">log</span><span class="op" id="7893457">.</span><span class="ident" id="7893458">Fatal</span><span class="op" id="7893463">(</span><span class="string" id="7893464">&#34;TempFile:&nbsp;&#34;</span><span class="op" id="7893476">,</span>&nbsp;<span class="ident" id="7893478">err</span><span class="op" id="7893481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893486">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893491">f</span><span class="op" id="7893492">.</span><span class="ident" id="7893493">Close</span><span class="op" id="7893498">(</span><span class="op" id="7893499">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893504">la</span>&nbsp;<span class="op" id="7893507">=</span>&nbsp;<span class="ident" id="7893509">f</span><span class="op" id="7893510">.</span><span class="ident" id="7893511">Name</span><span class="op" id="7893515">(</span><span class="op" id="7893516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893524">os</span><span class="op" id="7893526">.</span><span class="ident" id="7893527">Remove</span><span class="op" id="7893533">(</span><span class="ident" id="7893534">la</span><span class="op" id="7893536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893543">wg</span>&nbsp;<span class="op" id="7893546">=</span>&nbsp;<span class="builtinfunc" id="7893548">new</span><span class="op" id="7893551">(</span><span class="ident" id="7893552">sync</span><span class="op" id="7893556">.</span><span class="ident" id="7893557">WaitGroup</span><span class="op" id="7893566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893569">if</span>&nbsp;<span class="ident" id="7893572">n</span>&nbsp;<span class="op" id="7893574">==</span>&nbsp;<span class="string" id="7893577">&#34;udp&#34;</span>&nbsp;<span class="op" id="7893583">||</span>&nbsp;<span class="ident" id="7893586">n</span>&nbsp;<span class="op" id="7893588">==</span>&nbsp;<span class="string" id="7893591">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7893602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893606">l</span><span class="op" id="7893607">,</span>&nbsp;<span class="ident" id="7893609">e</span>&nbsp;<span class="op" id="7893611">:=</span>&nbsp;<span class="ident" id="7893614">net</span><span class="op" id="7893617">.</span><span class="ident" id="7893618">ListenPacket</span><span class="op" id="7893630">(</span><span class="ident" id="7893631">n</span><span class="op" id="7893632">,</span>&nbsp;<span class="ident" id="7893634">la</span><span class="op" id="7893636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893640">if</span>&nbsp;<span class="ident" id="7893643">e</span>&nbsp;<span class="op" id="7893645">!=</span>&nbsp;<span class="ident" id="7893648">nil</span>&nbsp;<span class="op" id="7893652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893657">log</span><span class="op" id="7893660">.</span><span class="ident" id="7893661">Fatalf</span><span class="op" id="7893667">(</span><span class="string" id="7893668">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7893692">,</span>&nbsp;<span class="ident" id="7893694">e</span><span class="op" id="7893695">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893703">addr</span>&nbsp;<span class="op" id="7893708">=</span>&nbsp;<span class="ident" id="7893710">l</span><span class="op" id="7893711">.</span><span class="ident" id="7893712">LocalAddr</span><span class="op" id="7893721">(</span><span class="op" id="7893722">)</span><span class="op" id="7893723">.</span><span class="ident" id="7893724">String</span><span class="op" id="7893730">(</span><span class="op" id="7893731">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893735">sock</span>&nbsp;<span class="op" id="7893740">=</span>&nbsp;<span class="ident" id="7893742">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893746">wg</span><span class="op" id="7893748">.</span><span class="ident" id="7893749">Add</span><span class="op" id="7893752">(</span><span class="num" id="7893753">1</span><span class="op" id="7893754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893758">go</span>&nbsp;<span class="keyword" id="7893761">func</span><span class="op" id="7893765">(</span><span class="op" id="7893766">)</span>&nbsp;<span class="op" id="7893768">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893773">defer</span>&nbsp;<span class="ident" id="7893779">wg</span><span class="op" id="7893781">.</span><span class="ident" id="7893782">Done</span><span class="op" id="7893786">(</span><span class="op" id="7893787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893792">runPktSyslog</span><span class="op" id="7893804">(</span><span class="ident" id="7893805">l</span><span class="op" id="7893806">,</span>&nbsp;<span class="ident" id="7893808">done</span><span class="op" id="7893812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893816">}</span><span class="op" id="7893817">(</span><span class="op" id="7893818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893821">}</span>&nbsp;<span class="keyword" id="7893823">else</span>&nbsp;<span class="op" id="7893828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893832">l</span><span class="op" id="7893833">,</span>&nbsp;<span class="ident" id="7893835">e</span>&nbsp;<span class="op" id="7893837">:=</span>&nbsp;<span class="ident" id="7893840">net</span><span class="op" id="7893843">.</span><span class="ident" id="7893844">Listen</span><span class="op" id="7893850">(</span><span class="ident" id="7893851">n</span><span class="op" id="7893852">,</span>&nbsp;<span class="ident" id="7893854">la</span><span class="op" id="7893856">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893860">if</span>&nbsp;<span class="ident" id="7893863">e</span>&nbsp;<span class="op" id="7893865">!=</span>&nbsp;<span class="ident" id="7893868">nil</span>&nbsp;<span class="op" id="7893872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893877">log</span><span class="op" id="7893880">.</span><span class="ident" id="7893881">Fatalf</span><span class="op" id="7893887">(</span><span class="string" id="7893888">&#34;startServer&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7893912">,</span>&nbsp;<span class="ident" id="7893914">e</span><span class="op" id="7893915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7893919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893923">addr</span>&nbsp;<span class="op" id="7893928">=</span>&nbsp;<span class="ident" id="7893930">l</span><span class="op" id="7893931">.</span><span class="ident" id="7893932">Addr</span><span class="op" id="7893936">(</span><span class="op" id="7893937">)</span><span class="op" id="7893938">.</span><span class="ident" id="7893939">String</span><span class="op" id="7893945">(</span><span class="op" id="7893946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893950">sock</span>&nbsp;<span class="op" id="7893955">=</span>&nbsp;<span class="ident" id="7893957">l</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7893961">wg</span><span class="op" id="7893963">.</span><span class="ident" id="7893964">Add</span><span class="op" id="7893967">(</span><span class="num" id="7893968">1</span><span class="op" id="7893969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893973">go</span>&nbsp;<span class="keyword" id="7893976">func</span><span class="op" id="7893980">(</span><span class="op" id="7893981">)</span>&nbsp;<span class="op" id="7893983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7893988">defer</span>&nbsp;<span class="ident" id="7893994">wg</span><span class="op" id="7893996">.</span><span class="ident" id="7893997">Done</span><span class="op" id="7894001">(</span><span class="op" id="7894002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894007">runStreamSyslog</span><span class="op" id="7894022">(</span><span class="ident" id="7894023">l</span><span class="op" id="7894024">,</span>&nbsp;<span class="ident" id="7894026">done</span><span class="op" id="7894030">,</span>&nbsp;<span class="ident" id="7894032">wg</span><span class="op" id="7894034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894038">}</span><span class="op" id="7894039">(</span><span class="op" id="7894040">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894046">return</span><br>
<span class="lineno"></span><span class="op" id="7894053">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7894056">func</span>&nbsp;<span class="ident" id="7894061">TestWithSimulated</span><span class="op" id="7894078">(</span><span class="ident" id="7894079">t</span>&nbsp;<span class="op" id="7894081">*</span><span class="ident" id="7894082">testing</span><span class="op" id="7894089">.</span><span class="ident" id="7894090">T</span><span class="op" id="7894091">)</span>&nbsp;<span class="op" id="7894093">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894096">msg</span>&nbsp;<span class="op" id="7894100">:=</span>&nbsp;<span class="string" id="7894103">&#34;Test&nbsp;123&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894115">transport</span>&nbsp;<span class="op" id="7894125">:=</span>&nbsp;<span class="op" id="7894128">[</span><span class="op" id="7894129">]</span><span class="builtintype" id="7894130">string</span><span class="op" id="7894136">{</span><span class="string" id="7894137">&#34;unix&#34;</span><span class="op" id="7894143">,</span>&nbsp;<span class="string" id="7894145">&#34;unixgram&#34;</span><span class="op" id="7894155">,</span>&nbsp;<span class="string" id="7894157">&#34;udp&#34;</span><span class="op" id="7894162">,</span>&nbsp;<span class="string" id="7894164">&#34;tcp&#34;</span><span class="op" id="7894169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894173">for</span>&nbsp;<span class="ident" id="7894177">_</span><span class="op" id="7894178">,</span>&nbsp;<span class="ident" id="7894180">tr</span>&nbsp;<span class="op" id="7894183">:=</span>&nbsp;<span class="keyword" id="7894186">range</span>&nbsp;<span class="ident" id="7894192">transport</span>&nbsp;<span class="op" id="7894202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894206">done</span>&nbsp;<span class="op" id="7894211">:=</span>&nbsp;<span class="builtinfunc" id="7894214">make</span><span class="op" id="7894218">(</span><span class="keyword" id="7894219">chan</span>&nbsp;<span class="builtintype" id="7894224">string</span><span class="op" id="7894230">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894234">addr</span><span class="op" id="7894238">,</span>&nbsp;<span class="ident" id="7894240">sock</span><span class="op" id="7894244">,</span>&nbsp;<span class="ident" id="7894246">srvWG</span>&nbsp;<span class="op" id="7894252">:=</span>&nbsp;<span class="ident" id="7894255">startServer</span><span class="op" id="7894266">(</span><span class="ident" id="7894267">tr</span><span class="op" id="7894269">,</span>&nbsp;<span class="string" id="7894271">&#34;&#34;</span><span class="op" id="7894273">,</span>&nbsp;<span class="ident" id="7894275">done</span><span class="op" id="7894279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894283">defer</span>&nbsp;<span class="ident" id="7894289">srvWG</span><span class="op" id="7894294">.</span><span class="ident" id="7894295">Wait</span><span class="op" id="7894299">(</span><span class="op" id="7894300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894304">defer</span>&nbsp;<span class="ident" id="7894310">sock</span><span class="op" id="7894314">.</span><span class="ident" id="7894315">Close</span><span class="op" id="7894320">(</span><span class="op" id="7894321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894325">if</span>&nbsp;<span class="ident" id="7894328">tr</span>&nbsp;<span class="op" id="7894331">==</span>&nbsp;<span class="string" id="7894334">&#34;unix&#34;</span>&nbsp;<span class="op" id="7894341">||</span>&nbsp;<span class="ident" id="7894344">tr</span>&nbsp;<span class="op" id="7894347">==</span>&nbsp;<span class="string" id="7894350">&#34;unixgram&#34;</span>&nbsp;<span class="op" id="7894361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894366">defer</span>&nbsp;<span class="ident" id="7894372">os</span><span class="op" id="7894374">.</span><span class="ident" id="7894375">Remove</span><span class="op" id="7894381">(</span><span class="ident" id="7894382">addr</span><span class="op" id="7894386">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894394">s</span><span class="op" id="7894395">,</span>&nbsp;<span class="ident" id="7894397">err</span>&nbsp;<span class="op" id="7894401">:=</span>&nbsp;<span class="ident" id="7894404">Dial</span><span class="op" id="7894408">(</span><span class="ident" id="7894409">tr</span><span class="op" id="7894411">,</span>&nbsp;<span class="ident" id="7894413">addr</span><span class="op" id="7894417">,</span>&nbsp;<span class="ident" id="7894419">LOG_INFO</span><span class="op" id="7894427">|</span><span class="ident" id="7894428">LOG_USER</span><span class="op" id="7894436">,</span>&nbsp;<span class="string" id="7894438">&#34;syslog_test&#34;</span><span class="op" id="7894451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894455">if</span>&nbsp;<span class="ident" id="7894458">err</span>&nbsp;<span class="op" id="7894462">!=</span>&nbsp;<span class="ident" id="7894465">nil</span>&nbsp;<span class="op" id="7894469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894474">t</span><span class="op" id="7894475">.</span><span class="ident" id="7894476">Fatalf</span><span class="op" id="7894482">(</span><span class="string" id="7894483">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7894502">,</span>&nbsp;<span class="ident" id="7894504">err</span><span class="op" id="7894507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894511">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894515">err</span>&nbsp;<span class="op" id="7894519">=</span>&nbsp;<span class="ident" id="7894521">s</span><span class="op" id="7894522">.</span><span class="ident" id="7894523">Info</span><span class="op" id="7894527">(</span><span class="ident" id="7894528">msg</span><span class="op" id="7894531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894535">if</span>&nbsp;<span class="ident" id="7894538">err</span>&nbsp;<span class="op" id="7894542">!=</span>&nbsp;<span class="ident" id="7894545">nil</span>&nbsp;<span class="op" id="7894549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894554">t</span><span class="op" id="7894555">.</span><span class="ident" id="7894556">Fatalf</span><span class="op" id="7894562">(</span><span class="string" id="7894563">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7894579">,</span>&nbsp;<span class="ident" id="7894581">err</span><span class="op" id="7894584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894592">check</span><span class="op" id="7894597">(</span><span class="ident" id="7894598">t</span><span class="op" id="7894599">,</span>&nbsp;<span class="ident" id="7894601">msg</span><span class="op" id="7894604">,</span>&nbsp;<span class="op" id="7894606">&lt;-</span><span class="ident" id="7894608">done</span><span class="op" id="7894612">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894616">s</span><span class="op" id="7894617">.</span><span class="ident" id="7894618">Close</span><span class="op" id="7894623">(</span><span class="op" id="7894624">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894627">}</span><br>
<span class="lineno"></span><span class="op" id="7894629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7894632">func</span>&nbsp;<span class="ident" id="7894637">TestFlap</span><span class="op" id="7894645">(</span><span class="ident" id="7894646">t</span>&nbsp;<span class="op" id="7894648">*</span><span class="ident" id="7894649">testing</span><span class="op" id="7894656">.</span><span class="ident" id="7894657">T</span><span class="op" id="7894658">)</span>&nbsp;<span class="op" id="7894660">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894663">net</span>&nbsp;<span class="op" id="7894667">:=</span>&nbsp;<span class="string" id="7894670">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894678">done</span>&nbsp;<span class="op" id="7894683">:=</span>&nbsp;<span class="builtinfunc" id="7894686">make</span><span class="op" id="7894690">(</span><span class="keyword" id="7894691">chan</span>&nbsp;<span class="builtintype" id="7894696">string</span><span class="op" id="7894702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894705">addr</span><span class="op" id="7894709">,</span>&nbsp;<span class="ident" id="7894711">sock</span><span class="op" id="7894715">,</span>&nbsp;<span class="ident" id="7894717">srvWG</span>&nbsp;<span class="op" id="7894723">:=</span>&nbsp;<span class="ident" id="7894726">startServer</span><span class="op" id="7894737">(</span><span class="ident" id="7894738">net</span><span class="op" id="7894741">,</span>&nbsp;<span class="string" id="7894743">&#34;&#34;</span><span class="op" id="7894745">,</span>&nbsp;<span class="ident" id="7894747">done</span><span class="op" id="7894751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894754">defer</span>&nbsp;<span class="ident" id="7894760">srvWG</span><span class="op" id="7894765">.</span><span class="ident" id="7894766">Wait</span><span class="op" id="7894770">(</span><span class="op" id="7894771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894774">defer</span>&nbsp;<span class="ident" id="7894780">os</span><span class="op" id="7894782">.</span><span class="ident" id="7894783">Remove</span><span class="op" id="7894789">(</span><span class="ident" id="7894790">addr</span><span class="op" id="7894794">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894797">defer</span>&nbsp;<span class="ident" id="7894803">sock</span><span class="op" id="7894807">.</span><span class="ident" id="7894808">Close</span><span class="op" id="7894813">(</span><span class="op" id="7894814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894818">s</span><span class="op" id="7894819">,</span>&nbsp;<span class="ident" id="7894821">err</span>&nbsp;<span class="op" id="7894825">:=</span>&nbsp;<span class="ident" id="7894828">Dial</span><span class="op" id="7894832">(</span><span class="ident" id="7894833">net</span><span class="op" id="7894836">,</span>&nbsp;<span class="ident" id="7894838">addr</span><span class="op" id="7894842">,</span>&nbsp;<span class="ident" id="7894844">LOG_INFO</span><span class="op" id="7894852">|</span><span class="ident" id="7894853">LOG_USER</span><span class="op" id="7894861">,</span>&nbsp;<span class="string" id="7894863">&#34;syslog_test&#34;</span><span class="op" id="7894876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894879">if</span>&nbsp;<span class="ident" id="7894882">err</span>&nbsp;<span class="op" id="7894886">!=</span>&nbsp;<span class="ident" id="7894889">nil</span>&nbsp;<span class="op" id="7894893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894897">t</span><span class="op" id="7894898">.</span><span class="ident" id="7894899">Fatalf</span><span class="op" id="7894905">(</span><span class="string" id="7894906">&#34;Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7894925">,</span>&nbsp;<span class="ident" id="7894927">err</span><span class="op" id="7894930">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7894933">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894936">msg</span>&nbsp;<span class="op" id="7894940">:=</span>&nbsp;<span class="string" id="7894943">&#34;Moo&nbsp;2&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894952">err</span>&nbsp;<span class="op" id="7894956">=</span>&nbsp;<span class="ident" id="7894958">s</span><span class="op" id="7894959">.</span><span class="ident" id="7894960">Info</span><span class="op" id="7894964">(</span><span class="ident" id="7894965">msg</span><span class="op" id="7894968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7894971">if</span>&nbsp;<span class="ident" id="7894974">err</span>&nbsp;<span class="op" id="7894978">!=</span>&nbsp;<span class="ident" id="7894981">nil</span>&nbsp;<span class="op" id="7894985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7894989">t</span><span class="op" id="7894990">.</span><span class="ident" id="7894991">Fatalf</span><span class="op" id="7894997">(</span><span class="string" id="7894998">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7895014">,</span>&nbsp;<span class="ident" id="7895016">err</span><span class="op" id="7895019">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895025">check</span><span class="op" id="7895030">(</span><span class="ident" id="7895031">t</span><span class="op" id="7895032">,</span>&nbsp;<span class="ident" id="7895034">msg</span><span class="op" id="7895037">,</span>&nbsp;<span class="op" id="7895039">&lt;-</span><span class="ident" id="7895041">done</span><span class="op" id="7895045">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7895049">//&nbsp;restart&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895072">_</span><span class="op" id="7895073">,</span>&nbsp;<span class="ident" id="7895075">sock2</span><span class="op" id="7895080">,</span>&nbsp;<span class="ident" id="7895082">srvWG2</span>&nbsp;<span class="op" id="7895089">:=</span>&nbsp;<span class="ident" id="7895092">startServer</span><span class="op" id="7895103">(</span><span class="ident" id="7895104">net</span><span class="op" id="7895107">,</span>&nbsp;<span class="ident" id="7895109">addr</span><span class="op" id="7895113">,</span>&nbsp;<span class="ident" id="7895115">done</span><span class="op" id="7895119">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895122">defer</span>&nbsp;<span class="ident" id="7895128">srvWG2</span><span class="op" id="7895134">.</span><span class="ident" id="7895135">Wait</span><span class="op" id="7895139">(</span><span class="op" id="7895140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895143">defer</span>&nbsp;<span class="ident" id="7895149">sock2</span><span class="op" id="7895154">.</span><span class="ident" id="7895155">Close</span><span class="op" id="7895160">(</span><span class="op" id="7895161">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7895165">//&nbsp;and&nbsp;try&nbsp;retransmitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895192">msg</span>&nbsp;<span class="op" id="7895196">=</span>&nbsp;<span class="string" id="7895198">&#34;Moo&nbsp;3&#34;</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895207">err</span>&nbsp;<span class="op" id="7895211">=</span>&nbsp;<span class="ident" id="7895213">s</span><span class="op" id="7895214">.</span><span class="ident" id="7895215">Info</span><span class="op" id="7895219">(</span><span class="ident" id="7895220">msg</span><span class="op" id="7895223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895226">if</span>&nbsp;<span class="ident" id="7895229">err</span>&nbsp;<span class="op" id="7895233">!=</span>&nbsp;<span class="ident" id="7895236">nil</span>&nbsp;<span class="op" id="7895240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895244">t</span><span class="op" id="7895245">.</span><span class="ident" id="7895246">Fatalf</span><span class="op" id="7895252">(</span><span class="string" id="7895253">&#34;log&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7895269">,</span>&nbsp;<span class="ident" id="7895271">err</span><span class="op" id="7895274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895277">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895280">check</span><span class="op" id="7895285">(</span><span class="ident" id="7895286">t</span><span class="op" id="7895287">,</span>&nbsp;<span class="ident" id="7895289">msg</span><span class="op" id="7895292">,</span>&nbsp;<span class="op" id="7895294">&lt;-</span><span class="ident" id="7895296">done</span><span class="op" id="7895300">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895304">s</span><span class="op" id="7895305">.</span><span class="ident" id="7895306">Close</span><span class="op" id="7895311">(</span><span class="op" id="7895312">)</span><br>
<span class="lineno"></span><span class="op" id="7895314">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7895317">func</span>&nbsp;<span class="ident" id="7895322">TestNew</span><span class="op" id="7895329">(</span><span class="ident" id="7895330">t</span>&nbsp;<span class="op" id="7895332">*</span><span class="ident" id="7895333">testing</span><span class="op" id="7895340">.</span><span class="ident" id="7895341">T</span><span class="op" id="7895342">)</span>&nbsp;<span class="op" id="7895344">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895347">if</span>&nbsp;<span class="ident" id="7895350">LOG_LOCAL7</span>&nbsp;<span class="op" id="7895361">!=</span>&nbsp;<span class="num" id="7895364">23</span><span class="op" id="7895366">&lt;&lt;</span><span class="num" id="7895368">3</span>&nbsp;<span class="op" id="7895370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895374">t</span><span class="op" id="7895375">.</span><span class="ident" id="7895376">Fatalf</span><span class="op" id="7895382">(</span><span class="string" id="7895383">&#34;LOG_LOCAL7&nbsp;has&nbsp;wrong&nbsp;value&#34;</span><span class="op" id="7895411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895417">if</span>&nbsp;<span class="ident" id="7895420">testing</span><span class="op" id="7895427">.</span><span class="ident" id="7895428">Short</span><span class="op" id="7895433">(</span><span class="op" id="7895434">)</span>&nbsp;<span class="op" id="7895436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7895440">//&nbsp;Depends&nbsp;on&nbsp;syslog&nbsp;daemon&nbsp;running,&nbsp;and&nbsp;sometimes&nbsp;it&#39;s&nbsp;not.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895503">t</span><span class="op" id="7895504">.</span><span class="ident" id="7895505">Skip</span><span class="op" id="7895509">(</span><span class="string" id="7895510">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7895546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895553">s</span><span class="op" id="7895554">,</span>&nbsp;<span class="ident" id="7895556">err</span>&nbsp;<span class="op" id="7895560">:=</span>&nbsp;<span class="ident" id="7895563">New</span><span class="op" id="7895566">(</span><span class="ident" id="7895567">LOG_INFO</span><span class="op" id="7895575">|</span><span class="ident" id="7895576">LOG_USER</span><span class="op" id="7895584">,</span>&nbsp;<span class="string" id="7895586">&#34;the_tag&#34;</span><span class="op" id="7895595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895598">if</span>&nbsp;<span class="ident" id="7895601">err</span>&nbsp;<span class="op" id="7895605">!=</span>&nbsp;<span class="ident" id="7895608">nil</span>&nbsp;<span class="op" id="7895612">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895616">t</span><span class="op" id="7895617">.</span><span class="ident" id="7895618">Fatalf</span><span class="op" id="7895624">(</span><span class="string" id="7895625">&#34;New()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7895643">,</span>&nbsp;<span class="ident" id="7895645">err</span><span class="op" id="7895648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895651">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7895654">//&nbsp;Don&#39;t&nbsp;send&nbsp;any&nbsp;messages.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895683">s</span><span class="op" id="7895684">.</span><span class="ident" id="7895685">Close</span><span class="op" id="7895690">(</span><span class="op" id="7895691">)</span><br>
<span class="lineno"></span><span class="op" id="7895693">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="7895696">func</span>&nbsp;<span class="ident" id="7895701">TestNewLogger</span><span class="op" id="7895714">(</span><span class="ident" id="7895715">t</span>&nbsp;<span class="op" id="7895717">*</span><span class="ident" id="7895718">testing</span><span class="op" id="7895725">.</span><span class="ident" id="7895726">T</span><span class="op" id="7895727">)</span>&nbsp;<span class="op" id="7895729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895732">if</span>&nbsp;<span class="ident" id="7895735">testing</span><span class="op" id="7895742">.</span><span class="ident" id="7895743">Short</span><span class="op" id="7895748">(</span><span class="op" id="7895749">)</span>&nbsp;<span class="op" id="7895751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895755">t</span><span class="op" id="7895756">.</span><span class="ident" id="7895757">Skip</span><span class="op" id="7895761">(</span><span class="string" id="7895762">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7895798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895801">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895804">f</span><span class="op" id="7895805">,</span>&nbsp;<span class="ident" id="7895807">err</span>&nbsp;<span class="op" id="7895811">:=</span>&nbsp;<span class="ident" id="7895814">NewLogger</span><span class="op" id="7895823">(</span><span class="ident" id="7895824">LOG_USER</span><span class="op" id="7895832">|</span><span class="ident" id="7895833">LOG_INFO</span><span class="op" id="7895841">,</span>&nbsp;<span class="num" id="7895843">0</span><span class="op" id="7895844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895847">if</span>&nbsp;<span class="ident" id="7895850">f</span>&nbsp;<span class="op" id="7895852">==</span>&nbsp;<span class="ident" id="7895855">nil</span>&nbsp;<span class="op" id="7895859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895863">t</span><span class="op" id="7895864">.</span><span class="ident" id="7895865">Error</span><span class="op" id="7895870">(</span><span class="ident" id="7895871">err</span><span class="op" id="7895874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895877">}</span><br>
<span class="lineno"></span><span class="op" id="7895879">}</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span><span class="keyword" id="7895882">func</span>&nbsp;<span class="ident" id="7895887">TestDial</span><span class="op" id="7895895">(</span><span class="ident" id="7895896">t</span>&nbsp;<span class="op" id="7895898">*</span><span class="ident" id="7895899">testing</span><span class="op" id="7895906">.</span><span class="ident" id="7895907">T</span><span class="op" id="7895908">)</span>&nbsp;<span class="op" id="7895910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7895913">if</span>&nbsp;<span class="ident" id="7895916">testing</span><span class="op" id="7895923">.</span><span class="ident" id="7895924">Short</span><span class="op" id="7895929">(</span><span class="op" id="7895930">)</span>&nbsp;<span class="op" id="7895932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895936">t</span><span class="op" id="7895937">.</span><span class="ident" id="7895938">Skip</span><span class="op" id="7895942">(</span><span class="string" id="7895943">&#34;skipping&nbsp;syslog&nbsp;test&nbsp;during&nbsp;-short&#34;</span><span class="op" id="7895979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7895982">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7895985">f</span><span class="op" id="7895986">,</span>&nbsp;<span class="ident" id="7895988">err</span>&nbsp;<span class="op" id="7895992">:=</span>&nbsp;<span class="ident" id="7895995">Dial</span><span class="op" id="7895999">(</span><span class="string" id="7896000">&#34;&#34;</span><span class="op" id="7896002">,</span>&nbsp;<span class="string" id="7896004">&#34;&#34;</span><span class="op" id="7896006">,</span>&nbsp;<span class="op" id="7896008">(</span><span class="ident" id="7896009">LOG_LOCAL7</span><span class="op" id="7896019">|</span><span class="ident" id="7896020">LOG_DEBUG</span><span class="op" id="7896029">)</span><span class="op" id="7896030">+</span><span class="num" id="7896031">1</span><span class="op" id="7896032">,</span>&nbsp;<span class="string" id="7896034">&#34;syslog_test&#34;</span><span class="op" id="7896047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896050">if</span>&nbsp;<span class="ident" id="7896053">f</span>&nbsp;<span class="op" id="7896055">!=</span>&nbsp;<span class="ident" id="7896058">nil</span>&nbsp;<span class="op" id="7896062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896066">t</span><span class="op" id="7896067">.</span><span class="ident" id="7896068">Fatalf</span><span class="op" id="7896074">(</span><span class="string" id="7896075">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7896109">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896115">f</span><span class="op" id="7896116">,</span>&nbsp;<span class="ident" id="7896118">err</span>&nbsp;<span class="op" id="7896122">=</span>&nbsp;<span class="ident" id="7896124">Dial</span><span class="op" id="7896128">(</span><span class="string" id="7896129">&#34;&#34;</span><span class="op" id="7896131">,</span>&nbsp;<span class="string" id="7896133">&#34;&#34;</span><span class="op" id="7896135">,</span>&nbsp;<span class="op" id="7896137">-</span><span class="num" id="7896138">1</span><span class="op" id="7896139">,</span>&nbsp;<span class="string" id="7896141">&#34;syslog_test&#34;</span><span class="op" id="7896154">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896157">if</span>&nbsp;<span class="ident" id="7896160">f</span>&nbsp;<span class="op" id="7896162">!=</span>&nbsp;<span class="ident" id="7896165">nil</span>&nbsp;<span class="op" id="7896169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896173">t</span><span class="op" id="7896174">.</span><span class="ident" id="7896175">Fatalf</span><span class="op" id="7896181">(</span><span class="string" id="7896182">&#34;Should&nbsp;have&nbsp;trapped&nbsp;bad&nbsp;priority&#34;</span><span class="op" id="7896216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896222">l</span><span class="op" id="7896223">,</span>&nbsp;<span class="ident" id="7896225">err</span>&nbsp;<span class="op" id="7896229">:=</span>&nbsp;<span class="ident" id="7896232">Dial</span><span class="op" id="7896236">(</span><span class="string" id="7896237">&#34;&#34;</span><span class="op" id="7896239">,</span>&nbsp;<span class="string" id="7896241">&#34;&#34;</span><span class="op" id="7896243">,</span>&nbsp;<span class="ident" id="7896245">LOG_USER</span><span class="op" id="7896253">|</span><span class="ident" id="7896254">LOG_ERR</span><span class="op" id="7896261">,</span>&nbsp;<span class="string" id="7896263">&#34;syslog_test&#34;</span><span class="op" id="7896276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896279">if</span>&nbsp;<span class="ident" id="7896282">err</span>&nbsp;<span class="op" id="7896286">!=</span>&nbsp;<span class="ident" id="7896289">nil</span>&nbsp;<span class="op" id="7896293">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896297">t</span><span class="op" id="7896298">.</span><span class="ident" id="7896299">Fatalf</span><span class="op" id="7896305">(</span><span class="string" id="7896306">&#34;Dial()&nbsp;failed:&nbsp;%s&#34;</span><span class="op" id="7896325">,</span>&nbsp;<span class="ident" id="7896327">err</span><span class="op" id="7896330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896336">l</span><span class="op" id="7896337">.</span><span class="ident" id="7896338">Close</span><span class="op" id="7896343">(</span><span class="op" id="7896344">)</span><br>
<span class="lineno"></span><span class="op" id="7896346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="7896349">func</span>&nbsp;<span class="ident" id="7896354">check</span><span class="op" id="7896359">(</span><span class="ident" id="7896360">t</span>&nbsp;<span class="op" id="7896362">*</span><span class="ident" id="7896363">testing</span><span class="op" id="7896370">.</span><span class="ident" id="7896371">T</span><span class="op" id="7896372">,</span>&nbsp;<span class="ident" id="7896374">in</span><span class="op" id="7896376">,</span>&nbsp;<span class="ident" id="7896378">out</span>&nbsp;<span class="builtintype" id="7896382">string</span><span class="op" id="7896388">)</span>&nbsp;<span class="op" id="7896390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896393">tmpl</span>&nbsp;<span class="op" id="7896398">:=</span>&nbsp;<span class="ident" id="7896401">fmt</span><span class="op" id="7896404">.</span><span class="ident" id="7896405">Sprintf</span><span class="op" id="7896412">(</span><span class="string" id="7896413">&#34;&lt;%d&gt;%%s&nbsp;%%s&nbsp;syslog_test[%%d]:&nbsp;%s\n&#34;</span><span class="op" id="7896449">,</span>&nbsp;<span class="ident" id="7896451">LOG_USER</span><span class="op" id="7896459">+</span><span class="ident" id="7896460">LOG_INFO</span><span class="op" id="7896468">,</span>&nbsp;<span class="ident" id="7896470">in</span><span class="op" id="7896472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896475">if</span>&nbsp;<span class="ident" id="7896478">hostname</span><span class="op" id="7896486">,</span>&nbsp;<span class="ident" id="7896488">err</span>&nbsp;<span class="op" id="7896492">:=</span>&nbsp;<span class="ident" id="7896495">os</span><span class="op" id="7896497">.</span><span class="ident" id="7896498">Hostname</span><span class="op" id="7896506">(</span><span class="op" id="7896507">)</span><span class="op" id="7896508">;</span>&nbsp;<span class="ident" id="7896510">err</span>&nbsp;<span class="op" id="7896514">!=</span>&nbsp;<span class="ident" id="7896517">nil</span>&nbsp;<span class="op" id="7896521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896525">t</span><span class="op" id="7896526">.</span><span class="ident" id="7896527">Error</span><span class="op" id="7896532">(</span><span class="string" id="7896533">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7896560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896563">}</span>&nbsp;<span class="keyword" id="7896565">else</span>&nbsp;<span class="op" id="7896570">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896574">var</span>&nbsp;<span class="ident" id="7896578">parsedHostname</span><span class="op" id="7896592">,</span>&nbsp;<span class="ident" id="7896594">timestamp</span>&nbsp;<span class="builtintype" id="7896604">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896613">var</span>&nbsp;<span class="ident" id="7896617">pid</span>&nbsp;<span class="builtintype" id="7896621">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7896627">if</span>&nbsp;<span class="ident" id="7896630">n</span><span class="op" id="7896631">,</span>&nbsp;<span class="ident" id="7896633">err</span>&nbsp;<span class="op" id="7896637">:=</span>&nbsp;<span class="ident" id="7896640">fmt</span><span class="op" id="7896643">.</span><span class="ident" id="7896644">Sscanf</span><span class="op" id="7896650">(</span><span class="ident" id="7896651">out</span><span class="op" id="7896654">,</span>&nbsp;<span class="ident" id="7896656">tmpl</span><span class="op" id="7896660">,</span>&nbsp;<span class="op" id="7896662">&amp;</span><span class="ident" id="7896663">timestamp</span><span class="op" id="7896672">,</span>&nbsp;<span class="op" id="7896674">&amp;</span><span class="ident" id="7896675">parsedHostname</span><span class="op" id="7896689">,</span>&nbsp;<span class="op" id="7896691">&amp;</span><span class="ident" id="7896692">pid</span><span class="op" id="7896695">)</span><span class="op" id="7896696">;</span>&nbsp;<span class="ident" id="7896698">n</span>&nbsp;<span class="op" id="7896700">!=</span>&nbsp;<span class="num" id="7896703">3</span>&nbsp;<span class="op" id="7896705">||</span>&nbsp;<span class="ident" id="7896708">err</span>&nbsp;<span class="op" id="7896712">!=</span>&nbsp;<span class="ident" id="7896715">nil</span>&nbsp;<span class="op" id="7896719">||</span>&nbsp;<span class="ident" id="7896722">hostname</span>&nbsp;<span class="op" id="7896731">!=</span>&nbsp;<span class="ident" id="7896734">parsedHostname</span>&nbsp;<span class="op" id="7896749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896754">t</span><span class="op" id="7896755">.</span><span class="ident" id="7896756">Errorf</span><span class="op" id="7896762">(</span><span class="string" id="7896763">&#34;Got&nbsp;%q,&nbsp;does&nbsp;not&nbsp;match&nbsp;template&nbsp;%q&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7896807">,</span>&nbsp;<span class="ident" id="7896809">out</span><span class="op" id="7896812">,</span>&nbsp;<span class="ident" id="7896814">tmpl</span><span class="op" id="7896818">,</span>&nbsp;<span class="ident" id="7896820">n</span><span class="op" id="7896821">,</span>&nbsp;<span class="ident" id="7896823">err</span><span class="op" id="7896826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896830">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896833">}</span><br>
<span class="lineno"></span><span class="op" id="7896835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7896838">func</span>&nbsp;<span class="ident" id="7896843">TestWrite</span><span class="op" id="7896852">(</span><span class="ident" id="7896853">t</span>&nbsp;<span class="op" id="7896855">*</span><span class="ident" id="7896856">testing</span><span class="op" id="7896863">.</span><span class="ident" id="7896864">T</span><span class="op" id="7896865">)</span>&nbsp;<span class="op" id="7896867">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896870">tests</span>&nbsp;<span class="op" id="7896876">:=</span>&nbsp;<span class="op" id="7896879">[</span><span class="op" id="7896880">]</span><span class="keyword" id="7896881">struct</span>&nbsp;<span class="op" id="7896888">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896892">pri</span>&nbsp;<span class="ident" id="7896896">Priority</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896907">pre</span>&nbsp;<span class="builtintype" id="7896911">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896920">msg</span>&nbsp;<span class="builtintype" id="7896924">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7896933">exp</span>&nbsp;<span class="builtintype" id="7896937">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896945">}</span><span class="op" id="7896946">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7896950">{</span><span class="ident" id="7896951">LOG_USER</span>&nbsp;<span class="op" id="7896960">|</span>&nbsp;<span class="ident" id="7896962">LOG_ERR</span><span class="op" id="7896969">,</span>&nbsp;<span class="string" id="7896971">&#34;syslog_test&#34;</span><span class="op" id="7896984">,</span>&nbsp;<span class="string" id="7896986">&#34;&#34;</span><span class="op" id="7896988">,</span>&nbsp;<span class="string" id="7896990">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;\n&#34;</span><span class="op" id="7897017">}</span><span class="op" id="7897018">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897022">{</span><span class="ident" id="7897023">LOG_USER</span>&nbsp;<span class="op" id="7897032">|</span>&nbsp;<span class="ident" id="7897034">LOG_ERR</span><span class="op" id="7897041">,</span>&nbsp;<span class="string" id="7897043">&#34;syslog_test&#34;</span><span class="op" id="7897056">,</span>&nbsp;<span class="string" id="7897058">&#34;write&nbsp;test&#34;</span><span class="op" id="7897070">,</span>&nbsp;<span class="string" id="7897072">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test\n&#34;</span><span class="op" id="7897109">}</span><span class="op" id="7897110">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7897114">//&nbsp;Write&nbsp;should&nbsp;not&nbsp;add&nbsp;\n&nbsp;if&nbsp;there&nbsp;already&nbsp;is&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897167">{</span><span class="ident" id="7897168">LOG_USER</span>&nbsp;<span class="op" id="7897177">|</span>&nbsp;<span class="ident" id="7897179">LOG_ERR</span><span class="op" id="7897186">,</span>&nbsp;<span class="string" id="7897188">&#34;syslog_test&#34;</span><span class="op" id="7897201">,</span>&nbsp;<span class="string" id="7897203">&#34;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7897219">,</span>&nbsp;<span class="string" id="7897221">&#34;%s&nbsp;%s&nbsp;syslog_test[%d]:&nbsp;write&nbsp;test&nbsp;2\n&#34;</span><span class="op" id="7897260">}</span><span class="op" id="7897261">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897264">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897268">if</span>&nbsp;<span class="ident" id="7897271">hostname</span><span class="op" id="7897279">,</span>&nbsp;<span class="ident" id="7897281">err</span>&nbsp;<span class="op" id="7897285">:=</span>&nbsp;<span class="ident" id="7897288">os</span><span class="op" id="7897290">.</span><span class="ident" id="7897291">Hostname</span><span class="op" id="7897299">(</span><span class="op" id="7897300">)</span><span class="op" id="7897301">;</span>&nbsp;<span class="ident" id="7897303">err</span>&nbsp;<span class="op" id="7897307">!=</span>&nbsp;<span class="ident" id="7897310">nil</span>&nbsp;<span class="op" id="7897314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897318">t</span><span class="op" id="7897319">.</span><span class="ident" id="7897320">Fatalf</span><span class="op" id="7897326">(</span><span class="string" id="7897327">&#34;Error&nbsp;retrieving&nbsp;hostname&#34;</span><span class="op" id="7897354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897357">}</span>&nbsp;<span class="keyword" id="7897359">else</span>&nbsp;<span class="op" id="7897364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897368">for</span>&nbsp;<span class="ident" id="7897372">_</span><span class="op" id="7897373">,</span>&nbsp;<span class="ident" id="7897375">test</span>&nbsp;<span class="op" id="7897380">:=</span>&nbsp;<span class="keyword" id="7897383">range</span>&nbsp;<span class="ident" id="7897389">tests</span>&nbsp;<span class="op" id="7897395">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897400">done</span>&nbsp;<span class="op" id="7897405">:=</span>&nbsp;<span class="builtinfunc" id="7897408">make</span><span class="op" id="7897412">(</span><span class="keyword" id="7897413">chan</span>&nbsp;<span class="builtintype" id="7897418">string</span><span class="op" id="7897424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897429">addr</span><span class="op" id="7897433">,</span>&nbsp;<span class="ident" id="7897435">sock</span><span class="op" id="7897439">,</span>&nbsp;<span class="ident" id="7897441">srvWG</span>&nbsp;<span class="op" id="7897447">:=</span>&nbsp;<span class="ident" id="7897450">startServer</span><span class="op" id="7897461">(</span><span class="string" id="7897462">&#34;udp&#34;</span><span class="op" id="7897467">,</span>&nbsp;<span class="string" id="7897469">&#34;&#34;</span><span class="op" id="7897471">,</span>&nbsp;<span class="ident" id="7897473">done</span><span class="op" id="7897477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897482">defer</span>&nbsp;<span class="ident" id="7897488">srvWG</span><span class="op" id="7897493">.</span><span class="ident" id="7897494">Wait</span><span class="op" id="7897498">(</span><span class="op" id="7897499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897504">defer</span>&nbsp;<span class="ident" id="7897510">sock</span><span class="op" id="7897514">.</span><span class="ident" id="7897515">Close</span><span class="op" id="7897520">(</span><span class="op" id="7897521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897526">l</span><span class="op" id="7897527">,</span>&nbsp;<span class="ident" id="7897529">err</span>&nbsp;<span class="op" id="7897533">:=</span>&nbsp;<span class="ident" id="7897536">Dial</span><span class="op" id="7897540">(</span><span class="string" id="7897541">&#34;udp&#34;</span><span class="op" id="7897546">,</span>&nbsp;<span class="ident" id="7897548">addr</span><span class="op" id="7897552">,</span>&nbsp;<span class="ident" id="7897554">test</span><span class="op" id="7897558">.</span><span class="ident" id="7897559">pri</span><span class="op" id="7897562">,</span>&nbsp;<span class="ident" id="7897564">test</span><span class="op" id="7897568">.</span><span class="ident" id="7897569">pre</span><span class="op" id="7897572">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897577">if</span>&nbsp;<span class="ident" id="7897580">err</span>&nbsp;<span class="op" id="7897584">!=</span>&nbsp;<span class="ident" id="7897587">nil</span>&nbsp;<span class="op" id="7897591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897597">t</span><span class="op" id="7897598">.</span><span class="ident" id="7897599">Fatalf</span><span class="op" id="7897605">(</span><span class="string" id="7897606">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7897632">,</span>&nbsp;<span class="ident" id="7897634">err</span><span class="op" id="7897637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897647">defer</span>&nbsp;<span class="ident" id="7897653">l</span><span class="op" id="7897654">.</span><span class="ident" id="7897655">Close</span><span class="op" id="7897660">(</span><span class="op" id="7897661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897666">_</span><span class="op" id="7897667">,</span>&nbsp;<span class="ident" id="7897669">err</span>&nbsp;<span class="op" id="7897673">=</span>&nbsp;<span class="ident" id="7897675">io</span><span class="op" id="7897677">.</span><span class="ident" id="7897678">WriteString</span><span class="op" id="7897689">(</span><span class="ident" id="7897690">l</span><span class="op" id="7897691">,</span>&nbsp;<span class="ident" id="7897693">test</span><span class="op" id="7897697">.</span><span class="ident" id="7897698">msg</span><span class="op" id="7897701">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897706">if</span>&nbsp;<span class="ident" id="7897709">err</span>&nbsp;<span class="op" id="7897713">!=</span>&nbsp;<span class="ident" id="7897716">nil</span>&nbsp;<span class="op" id="7897720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897726">t</span><span class="op" id="7897727">.</span><span class="ident" id="7897728">Fatalf</span><span class="op" id="7897734">(</span><span class="string" id="7897735">&#34;WriteString()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7897761">,</span>&nbsp;<span class="ident" id="7897763">err</span><span class="op" id="7897766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7897771">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897776">rcvd</span>&nbsp;<span class="op" id="7897781">:=</span>&nbsp;<span class="op" id="7897784">&lt;-</span><span class="ident" id="7897786">done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7897794">test</span><span class="op" id="7897798">.</span><span class="ident" id="7897799">exp</span>&nbsp;<span class="op" id="7897803">=</span>&nbsp;<span class="ident" id="7897805">fmt</span><span class="op" id="7897808">.</span><span class="ident" id="7897809">Sprintf</span><span class="op" id="7897816">(</span><span class="string" id="7897817">&#34;&lt;%d&gt;&#34;</span><span class="op" id="7897823">,</span>&nbsp;<span class="ident" id="7897825">test</span><span class="op" id="7897829">.</span><span class="ident" id="7897830">pri</span><span class="op" id="7897833">)</span>&nbsp;<span class="op" id="7897835">+</span>&nbsp;<span class="ident" id="7897837">test</span><span class="op" id="7897841">.</span><span class="ident" id="7897842">exp</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897849">var</span>&nbsp;<span class="ident" id="7897853">parsedHostname</span><span class="op" id="7897867">,</span>&nbsp;<span class="ident" id="7897869">timestamp</span>&nbsp;<span class="builtintype" id="7897879">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897889">var</span>&nbsp;<span class="ident" id="7897893">pid</span>&nbsp;<span class="builtintype" id="7897897">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7897904">if</span>&nbsp;<span class="ident" id="7897907">n</span><span class="op" id="7897908">,</span>&nbsp;<span class="ident" id="7897910">err</span>&nbsp;<span class="op" id="7897914">:=</span>&nbsp;<span class="ident" id="7897917">fmt</span><span class="op" id="7897920">.</span><span class="ident" id="7897921">Sscanf</span><span class="op" id="7897927">(</span><span class="ident" id="7897928">rcvd</span><span class="op" id="7897932">,</span>&nbsp;<span class="ident" id="7897934">test</span><span class="op" id="7897938">.</span><span class="ident" id="7897939">exp</span><span class="op" id="7897942">,</span>&nbsp;<span class="op" id="7897944">&amp;</span><span class="ident" id="7897945">timestamp</span><span class="op" id="7897954">,</span>&nbsp;<span class="op" id="7897956">&amp;</span><span class="ident" id="7897957">parsedHostname</span><span class="op" id="7897971">,</span>&nbsp;<span class="op" id="7897973">&amp;</span><span class="ident" id="7897974">pid</span><span class="op" id="7897977">)</span><span class="op" id="7897978">;</span>&nbsp;<span class="ident" id="7897980">n</span>&nbsp;<span class="op" id="7897982">!=</span>&nbsp;<span class="num" id="7897985">3</span>&nbsp;<span class="op" id="7897987">||</span>&nbsp;<span class="ident" id="7897990">err</span>&nbsp;<span class="op" id="7897994">!=</span>&nbsp;<span class="ident" id="7897997">nil</span>&nbsp;<span class="op" id="7898001">||</span>&nbsp;<span class="ident" id="7898004">hostname</span>&nbsp;<span class="op" id="7898013">!=</span>&nbsp;<span class="ident" id="7898016">parsedHostname</span>&nbsp;<span class="op" id="7898031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898037">t</span><span class="op" id="7898038">.</span><span class="ident" id="7898039">Errorf</span><span class="op" id="7898045">(</span><span class="string" id="7898046">&#34;s.Info()&nbsp;=&nbsp;&#39;%q&#39;,&nbsp;didn&#39;t&nbsp;match&nbsp;&#39;%q&#39;&nbsp;(%d&nbsp;%s)&#34;</span><span class="op" id="7898090">,</span>&nbsp;<span class="ident" id="7898092">rcvd</span><span class="op" id="7898096">,</span>&nbsp;<span class="ident" id="7898098">test</span><span class="op" id="7898102">.</span><span class="ident" id="7898103">exp</span><span class="op" id="7898106">,</span>&nbsp;<span class="ident" id="7898108">n</span><span class="op" id="7898109">,</span>&nbsp;<span class="ident" id="7898111">err</span><span class="op" id="7898114">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898119">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898126">}</span><br>
<span class="lineno"></span><span class="op" id="7898128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7898131">func</span>&nbsp;<span class="ident" id="7898136">TestConcurrentWrite</span><span class="op" id="7898155">(</span><span class="ident" id="7898156">t</span>&nbsp;<span class="op" id="7898158">*</span><span class="ident" id="7898159">testing</span><span class="op" id="7898166">.</span><span class="ident" id="7898167">T</span><span class="op" id="7898168">)</span>&nbsp;<span class="op" id="7898170">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898173">addr</span><span class="op" id="7898177">,</span>&nbsp;<span class="ident" id="7898179">sock</span><span class="op" id="7898183">,</span>&nbsp;<span class="ident" id="7898185">srvWG</span>&nbsp;<span class="op" id="7898191">:=</span>&nbsp;<span class="ident" id="7898194">startServer</span><span class="op" id="7898205">(</span><span class="string" id="7898206">&#34;udp&#34;</span><span class="op" id="7898211">,</span>&nbsp;<span class="string" id="7898213">&#34;&#34;</span><span class="op" id="7898215">,</span>&nbsp;<span class="builtinfunc" id="7898217">make</span><span class="op" id="7898221">(</span><span class="keyword" id="7898222">chan</span>&nbsp;<span class="builtintype" id="7898227">string</span><span class="op" id="7898233">,</span>&nbsp;<span class="num" id="7898235">1</span><span class="op" id="7898236">)</span><span class="op" id="7898237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898240">defer</span>&nbsp;<span class="ident" id="7898246">srvWG</span><span class="op" id="7898251">.</span><span class="ident" id="7898252">Wait</span><span class="op" id="7898256">(</span><span class="op" id="7898257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898260">defer</span>&nbsp;<span class="ident" id="7898266">sock</span><span class="op" id="7898270">.</span><span class="ident" id="7898271">Close</span><span class="op" id="7898276">(</span><span class="op" id="7898277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898280">w</span><span class="op" id="7898281">,</span>&nbsp;<span class="ident" id="7898283">err</span>&nbsp;<span class="op" id="7898287">:=</span>&nbsp;<span class="ident" id="7898290">Dial</span><span class="op" id="7898294">(</span><span class="string" id="7898295">&#34;udp&#34;</span><span class="op" id="7898300">,</span>&nbsp;<span class="ident" id="7898302">addr</span><span class="op" id="7898306">,</span>&nbsp;<span class="ident" id="7898308">LOG_USER</span><span class="op" id="7898316">|</span><span class="ident" id="7898317">LOG_ERR</span><span class="op" id="7898324">,</span>&nbsp;<span class="string" id="7898326">&#34;how&#39;s&nbsp;it&nbsp;going?&#34;</span><span class="op" id="7898343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898346">if</span>&nbsp;<span class="ident" id="7898349">err</span>&nbsp;<span class="op" id="7898353">!=</span>&nbsp;<span class="ident" id="7898356">nil</span>&nbsp;<span class="op" id="7898360">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898364">t</span><span class="op" id="7898365">.</span><span class="ident" id="7898366">Fatalf</span><span class="op" id="7898372">(</span><span class="string" id="7898373">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7898399">,</span>&nbsp;<span class="ident" id="7898401">err</span><span class="op" id="7898404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898410">var</span>&nbsp;<span class="ident" id="7898414">wg</span>&nbsp;<span class="ident" id="7898417">sync</span><span class="op" id="7898421">.</span><span class="ident" id="7898422">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898433">for</span>&nbsp;<span class="ident" id="7898437">i</span>&nbsp;<span class="op" id="7898439">:=</span>&nbsp;<span class="num" id="7898442">0</span><span class="op" id="7898443">;</span>&nbsp;<span class="ident" id="7898445">i</span>&nbsp;<span class="op" id="7898447">&lt;</span>&nbsp;<span class="num" id="7898449">10</span><span class="op" id="7898451">;</span>&nbsp;<span class="ident" id="7898453">i</span><span class="op" id="7898454">++</span>&nbsp;<span class="op" id="7898457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898461">wg</span><span class="op" id="7898463">.</span><span class="ident" id="7898464">Add</span><span class="op" id="7898467">(</span><span class="num" id="7898468">1</span><span class="op" id="7898469">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898473">go</span>&nbsp;<span class="keyword" id="7898476">func</span><span class="op" id="7898480">(</span><span class="op" id="7898481">)</span>&nbsp;<span class="op" id="7898483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898488">defer</span>&nbsp;<span class="ident" id="7898494">wg</span><span class="op" id="7898496">.</span><span class="ident" id="7898497">Done</span><span class="op" id="7898501">(</span><span class="op" id="7898502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898507">err</span>&nbsp;<span class="op" id="7898511">:=</span>&nbsp;<span class="ident" id="7898514">w</span><span class="op" id="7898515">.</span><span class="ident" id="7898516">Info</span><span class="op" id="7898520">(</span><span class="string" id="7898521">&#34;test&#34;</span><span class="op" id="7898527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898532">if</span>&nbsp;<span class="ident" id="7898535">err</span>&nbsp;<span class="op" id="7898539">!=</span>&nbsp;<span class="ident" id="7898542">nil</span>&nbsp;<span class="op" id="7898546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898552">t</span><span class="op" id="7898553">.</span><span class="ident" id="7898554">Errorf</span><span class="op" id="7898560">(</span><span class="string" id="7898561">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7898580">,</span>&nbsp;<span class="ident" id="7898582">err</span><span class="op" id="7898585">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898591">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898605">}</span><span class="op" id="7898606">(</span><span class="op" id="7898607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7898610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898613">wg</span><span class="op" id="7898615">.</span><span class="ident" id="7898616">Wait</span><span class="op" id="7898620">(</span><span class="op" id="7898621">)</span><br>
<span class="lineno">300</span><span class="op" id="7898623">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7898626">func</span>&nbsp;<span class="ident" id="7898631">TestConcurrentReconnect</span><span class="op" id="7898654">(</span><span class="ident" id="7898655">t</span>&nbsp;<span class="op" id="7898657">*</span><span class="ident" id="7898658">testing</span><span class="op" id="7898665">.</span><span class="ident" id="7898666">T</span><span class="op" id="7898667">)</span>&nbsp;<span class="op" id="7898669">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898672">crashy</span>&nbsp;<span class="op" id="7898679">=</span>&nbsp;<span class="builtintype" id="7898681">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898687">defer</span>&nbsp;<span class="keyword" id="7898693">func</span><span class="op" id="7898697">(</span><span class="op" id="7898698">)</span>&nbsp;<span class="op" id="7898700">{</span>&nbsp;<span class="ident" id="7898702">crashy</span>&nbsp;<span class="op" id="7898709">=</span>&nbsp;<span class="builtintype" id="7898711">false</span>&nbsp;<span class="op" id="7898717">}</span><span class="op" id="7898718">(</span><span class="op" id="7898719">)</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898723">const</span>&nbsp;<span class="ident" id="7898729">N</span>&nbsp;<span class="op" id="7898731">=</span>&nbsp;<span class="num" id="7898733">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898737">const</span>&nbsp;<span class="ident" id="7898743">M</span>&nbsp;<span class="op" id="7898745">=</span>&nbsp;<span class="num" id="7898747">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898752">net</span>&nbsp;<span class="op" id="7898756">:=</span>&nbsp;<span class="string" id="7898759">&#34;unix&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898767">done</span>&nbsp;<span class="op" id="7898772">:=</span>&nbsp;<span class="builtinfunc" id="7898775">make</span><span class="op" id="7898779">(</span><span class="keyword" id="7898780">chan</span>&nbsp;<span class="builtintype" id="7898785">string</span><span class="op" id="7898791">,</span>&nbsp;<span class="ident" id="7898793">N</span><span class="op" id="7898794">*</span><span class="ident" id="7898795">M</span><span class="op" id="7898796">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898799">addr</span><span class="op" id="7898803">,</span>&nbsp;<span class="ident" id="7898805">sock</span><span class="op" id="7898809">,</span>&nbsp;<span class="ident" id="7898811">srvWG</span>&nbsp;<span class="op" id="7898817">:=</span>&nbsp;<span class="ident" id="7898820">startServer</span><span class="op" id="7898831">(</span><span class="ident" id="7898832">net</span><span class="op" id="7898835">,</span>&nbsp;<span class="string" id="7898837">&#34;&#34;</span><span class="op" id="7898839">,</span>&nbsp;<span class="ident" id="7898841">done</span><span class="op" id="7898845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898848">defer</span>&nbsp;<span class="ident" id="7898854">os</span><span class="op" id="7898856">.</span><span class="ident" id="7898857">Remove</span><span class="op" id="7898863">(</span><span class="ident" id="7898864">addr</span><span class="op" id="7898868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898872">//&nbsp;count&nbsp;all&nbsp;the&nbsp;messages&nbsp;arriving</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898908">count</span>&nbsp;<span class="op" id="7898914">:=</span>&nbsp;<span class="builtinfunc" id="7898917">make</span><span class="op" id="7898921">(</span><span class="keyword" id="7898922">chan</span>&nbsp;<span class="builtintype" id="7898927">int</span><span class="op" id="7898930">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898933">go</span>&nbsp;<span class="keyword" id="7898936">func</span><span class="op" id="7898940">(</span><span class="op" id="7898941">)</span>&nbsp;<span class="op" id="7898943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898947">ct</span>&nbsp;<span class="op" id="7898950">:=</span>&nbsp;<span class="num" id="7898953">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7898957">for</span>&nbsp;<span class="keyword" id="7898961">range</span>&nbsp;<span class="ident" id="7898967">done</span>&nbsp;<span class="op" id="7898972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7898977">ct</span><span class="op" id="7898979">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7898985">//&nbsp;we&nbsp;are&nbsp;looking&nbsp;for&nbsp;500&nbsp;out&nbsp;of&nbsp;1000&nbsp;events</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899033">//&nbsp;here&nbsp;because&nbsp;lots&nbsp;of&nbsp;log&nbsp;messages&nbsp;are&nbsp;lost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7899082">//&nbsp;in&nbsp;buffers&nbsp;(kernel&nbsp;and/or&nbsp;bufio)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899121">if</span>&nbsp;<span class="ident" id="7899124">ct</span>&nbsp;<span class="op" id="7899127">&gt;</span>&nbsp;<span class="ident" id="7899129">N</span><span class="op" id="7899130">*</span><span class="ident" id="7899131">M</span><span class="op" id="7899132">/</span><span class="num" id="7899133">2</span>&nbsp;<span class="op" id="7899135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899141">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899150">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899158">count</span>&nbsp;<span class="op" id="7899164">&lt;-</span>&nbsp;<span class="ident" id="7899167">ct</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899171">}</span><span class="op" id="7899172">(</span><span class="op" id="7899173">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899177">var</span>&nbsp;<span class="ident" id="7899181">wg</span>&nbsp;<span class="ident" id="7899184">sync</span><span class="op" id="7899188">.</span><span class="ident" id="7899189">WaitGroup</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899200">wg</span><span class="op" id="7899202">.</span><span class="ident" id="7899203">Add</span><span class="op" id="7899206">(</span><span class="ident" id="7899207">N</span><span class="op" id="7899208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899211">for</span>&nbsp;<span class="ident" id="7899215">i</span>&nbsp;<span class="op" id="7899217">:=</span>&nbsp;<span class="num" id="7899220">0</span><span class="op" id="7899221">;</span>&nbsp;<span class="ident" id="7899223">i</span>&nbsp;<span class="op" id="7899225">&lt;</span>&nbsp;<span class="ident" id="7899227">N</span><span class="op" id="7899228">;</span>&nbsp;<span class="ident" id="7899230">i</span><span class="op" id="7899231">++</span>&nbsp;<span class="op" id="7899234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899238">go</span>&nbsp;<span class="keyword" id="7899241">func</span><span class="op" id="7899245">(</span><span class="op" id="7899246">)</span>&nbsp;<span class="op" id="7899248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899253">defer</span>&nbsp;<span class="ident" id="7899259">wg</span><span class="op" id="7899261">.</span><span class="ident" id="7899262">Done</span><span class="op" id="7899266">(</span><span class="op" id="7899267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899272">w</span><span class="op" id="7899273">,</span>&nbsp;<span class="ident" id="7899275">err</span>&nbsp;<span class="op" id="7899279">:=</span>&nbsp;<span class="ident" id="7899282">Dial</span><span class="op" id="7899286">(</span><span class="ident" id="7899287">net</span><span class="op" id="7899290">,</span>&nbsp;<span class="ident" id="7899292">addr</span><span class="op" id="7899296">,</span>&nbsp;<span class="ident" id="7899298">LOG_USER</span><span class="op" id="7899306">|</span><span class="ident" id="7899307">LOG_ERR</span><span class="op" id="7899314">,</span>&nbsp;<span class="string" id="7899316">&#34;tag&#34;</span><span class="op" id="7899321">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899326">if</span>&nbsp;<span class="ident" id="7899329">err</span>&nbsp;<span class="op" id="7899333">!=</span>&nbsp;<span class="ident" id="7899336">nil</span>&nbsp;<span class="op" id="7899340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899346">t</span><span class="op" id="7899347">.</span><span class="ident" id="7899348">Fatalf</span><span class="op" id="7899354">(</span><span class="string" id="7899355">&#34;syslog.Dial()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899381">,</span>&nbsp;<span class="ident" id="7899383">err</span><span class="op" id="7899386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899396">defer</span>&nbsp;<span class="ident" id="7899402">w</span><span class="op" id="7899403">.</span><span class="ident" id="7899404">Close</span><span class="op" id="7899409">(</span><span class="op" id="7899410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899415">for</span>&nbsp;<span class="ident" id="7899419">i</span>&nbsp;<span class="op" id="7899421">:=</span>&nbsp;<span class="num" id="7899424">0</span><span class="op" id="7899425">;</span>&nbsp;<span class="ident" id="7899427">i</span>&nbsp;<span class="op" id="7899429">&lt;</span>&nbsp;<span class="ident" id="7899431">M</span><span class="op" id="7899432">;</span>&nbsp;<span class="ident" id="7899434">i</span><span class="op" id="7899435">++</span>&nbsp;<span class="op" id="7899438">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899444">err</span>&nbsp;<span class="op" id="7899448">:=</span>&nbsp;<span class="ident" id="7899451">w</span><span class="op" id="7899452">.</span><span class="ident" id="7899453">Info</span><span class="op" id="7899457">(</span><span class="string" id="7899458">&#34;test&#34;</span><span class="op" id="7899464">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899470">if</span>&nbsp;<span class="ident" id="7899473">err</span>&nbsp;<span class="op" id="7899477">!=</span>&nbsp;<span class="ident" id="7899480">nil</span>&nbsp;<span class="op" id="7899484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899491">t</span><span class="op" id="7899492">.</span><span class="ident" id="7899493">Errorf</span><span class="op" id="7899499">(</span><span class="string" id="7899500">&#34;Info()&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7899519">,</span>&nbsp;<span class="ident" id="7899521">err</span><span class="op" id="7899524">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899531">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899542">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899551">}</span><span class="op" id="7899552">(</span><span class="op" id="7899553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899559">wg</span><span class="op" id="7899561">.</span><span class="ident" id="7899562">Wait</span><span class="op" id="7899566">(</span><span class="op" id="7899567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899570">sock</span><span class="op" id="7899574">.</span><span class="ident" id="7899575">Close</span><span class="op" id="7899580">(</span><span class="op" id="7899581">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899584">srvWG</span><span class="op" id="7899589">.</span><span class="ident" id="7899590">Wait</span><span class="op" id="7899594">(</span><span class="op" id="7899595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="7899598">close</span><span class="op" id="7899603">(</span><span class="ident" id="7899604">done</span><span class="op" id="7899608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899612">select</span>&nbsp;<span class="op" id="7899619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899622">case</span>&nbsp;<span class="op" id="7899627">&lt;-</span><span class="ident" id="7899629">count</span><span class="op" id="7899634">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7899637">case</span>&nbsp;<span class="op" id="7899642">&lt;-</span><span class="ident" id="7899644">time</span><span class="op" id="7899648">.</span><span class="ident" id="7899649">After</span><span class="op" id="7899654">(</span><span class="num" id="7899655">100</span>&nbsp;<span class="op" id="7899659">*</span>&nbsp;<span class="ident" id="7899661">time</span><span class="op" id="7899665">.</span><span class="ident" id="7899666">Millisecond</span><span class="op" id="7899677">)</span><span class="op" id="7899678">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7899682">t</span><span class="op" id="7899683">.</span><span class="ident" id="7899684">Error</span><span class="op" id="7899689">(</span><span class="string" id="7899690">&#34;timeout&nbsp;in&nbsp;concurrent&nbsp;reconnect&#34;</span><span class="op" id="7899723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7899726">}</span><br>
<span class="lineno"></span><span class="op" id="7899728">}</span>
</div>
</body>
</html>
