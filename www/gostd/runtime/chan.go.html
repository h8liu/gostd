<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime</h2>
<ul>
<li><a href="/gostd/runtime/alg.go.html">alg.go</a></li>
<li><a href="/gostd/runtime/append_test.go.html">append_test.go</a></li>
<li><a href="/gostd/runtime/arch_amd64.go.html">arch_amd64.go</a></li>
<li><a href="/gostd/runtime/atomic.go.html">atomic.go</a></li>
<li><a href="/gostd/runtime/cgocall.go.html">cgocall.go</a></li>
<li><a href="/gostd/runtime/cgocallback.go.html">cgocallback.go</a></li>
<li><a href="/gostd/runtime/chan.go.html" class="current">chan.go</a></li>
<li><a href="/gostd/runtime/chan_test.go.html">chan_test.go</a></li>
<li><a href="/gostd/runtime/closure_test.go.html">closure_test.go</a></li>
<li><a href="/gostd/runtime/compiler.go.html">compiler.go</a></li>
<li><a href="/gostd/runtime/complex.go.html">complex.go</a></li>
<li><a href="/gostd/runtime/complex_test.go.html">complex_test.go</a></li>
<li><a href="/gostd/runtime/cpuprof.go.html">cpuprof.go</a></li>
<li><a href="/gostd/runtime/crash_test.go.html">crash_test.go</a></li>
<li><a href="/gostd/runtime/debug.go.html">debug.go</a></li>
<li><a href="/gostd/runtime/env_posix.go.html">env_posix.go</a></li>
<li><a href="/gostd/runtime/error.go.html">error.go</a></li>
<li><a href="/gostd/runtime/export_futex_test.go.html">export_futex_test.go</a></li>
<li><a href="/gostd/runtime/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/runtime/extern.go.html">extern.go</a></li>
<li><a href="/gostd/runtime/futex_test.go.html">futex_test.go</a></li>
<li><a href="/gostd/runtime/gc_test.go.html">gc_test.go</a></li>
<li><a href="/gostd/runtime/gcinfo_test.go.html">gcinfo_test.go</a></li>
<li><a href="/gostd/runtime/hash_test.go.html">hash_test.go</a></li>
<li><a href="/gostd/runtime/hashmap.go.html">hashmap.go</a></li>
<li><a href="/gostd/runtime/hashmap_fast.go.html">hashmap_fast.go</a></li>
<li><a href="/gostd/runtime/iface.go.html">iface.go</a></li>
<li><a href="/gostd/runtime/iface_test.go.html">iface_test.go</a></li>
<li><a href="/gostd/runtime/lfstack_test.go.html">lfstack_test.go</a></li>
<li><a href="/gostd/runtime/lock_futex.go.html">lock_futex.go</a></li>
<li><a href="/gostd/runtime/malloc.go.html">malloc.go</a></li>
<li><a href="/gostd/runtime/malloc_test.go.html">malloc_test.go</a></li>
<li><a href="/gostd/runtime/map_test.go.html">map_test.go</a></li>
<li><a href="/gostd/runtime/mapspeed_test.go.html">mapspeed_test.go</a></li>
<li><a href="/gostd/runtime/mem.go.html">mem.go</a></li>
<li><a href="/gostd/runtime/memmove_linux_amd64_test.go.html">memmove_linux_amd64_test.go</a></li>
<li><a href="/gostd/runtime/memmove_test.go.html">memmove_test.go</a></li>
<li><a href="/gostd/runtime/mfinal_test.go.html">mfinal_test.go</a></li>
<li><a href="/gostd/runtime/mgc0.go.html">mgc0.go</a></li>
<li><a href="/gostd/runtime/mprof.go.html">mprof.go</a></li>
<li><a href="/gostd/runtime/netpoll.go.html">netpoll.go</a></li>
<li><a href="/gostd/runtime/netpoll_epoll.go.html">netpoll_epoll.go</a></li>
<li><a href="/gostd/runtime/norace_test.go.html">norace_test.go</a></li>
<li><a href="/gostd/runtime/os_linux.go.html">os_linux.go</a></li>
<li><a href="/gostd/runtime/panic.go.html">panic.go</a></li>
<li><a href="/gostd/runtime/parfor_test.go.html">parfor_test.go</a></li>
<li><a href="/gostd/runtime/print1.go.html">print1.go</a></li>
<li><a href="/gostd/runtime/proc.go.html">proc.go</a></li>
<li><a href="/gostd/runtime/proc_test.go.html">proc_test.go</a></li>
<li><a href="/gostd/runtime/race0.go.html">race0.go</a></li>
<li><a href="/gostd/runtime/rdebug.go.html">rdebug.go</a></li>
<li><a href="/gostd/runtime/rune.go.html">rune.go</a></li>
<li><a href="/gostd/runtime/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/runtime/runtime_linux_test.go.html">runtime_linux_test.go</a></li>
<li><a href="/gostd/runtime/runtime_test.go.html">runtime_test.go</a></li>
<li><a href="/gostd/runtime/runtime_unix_test.go.html">runtime_unix_test.go</a></li>
<li><a href="/gostd/runtime/select.go.html">select.go</a></li>
<li><a href="/gostd/runtime/sema.go.html">sema.go</a></li>
<li><a href="/gostd/runtime/signal_unix.go.html">signal_unix.go</a></li>
<li><a href="/gostd/runtime/sigpanic_unix.go.html">sigpanic_unix.go</a></li>
<li><a href="/gostd/runtime/sigqueue.go.html">sigqueue.go</a></li>
<li><a href="/gostd/runtime/slice.go.html">slice.go</a></li>
<li><a href="/gostd/runtime/softfloat64.go.html">softfloat64.go</a></li>
<li><a href="/gostd/runtime/softfloat64_test.go.html">softfloat64_test.go</a></li>
<li><a href="/gostd/runtime/sqrt.go.html">sqrt.go</a></li>
<li><a href="/gostd/runtime/stack.go.html">stack.go</a></li>
<li><a href="/gostd/runtime/stack_test.go.html">stack_test.go</a></li>
<li><a href="/gostd/runtime/string.go.html">string.go</a></li>
<li><a href="/gostd/runtime/string_test.go.html">string_test.go</a></li>
<li><a href="/gostd/runtime/stubs.go.html">stubs.go</a></li>
<li><a href="/gostd/runtime/symtab.go.html">symtab.go</a></li>
<li><a href="/gostd/runtime/symtab_test.go.html">symtab_test.go</a></li>
<li><a href="/gostd/runtime/time.go.html">time.go</a></li>
<li><a href="/gostd/runtime/traceback.go.html">traceback.go</a></li>
<li><a href="/gostd/runtime/typekind.go.html">typekind.go</a></li>
<li><a href="/gostd/runtime/zgoarch_amd64.go.html">zgoarch_amd64.go</a></li>
<li><a href="/gostd/runtime/zgoos_linux.go.html">zgoos_linux.go</a></li>
<li><a href="/gostd/runtime/zruntime_defs_linux_amd64.go.html">zruntime_defs_linux_amd64.go</a></li>
<li><a href="/gostd/runtime/zversion.go.html">zversion.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1488544">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1488599">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1488653">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1488704">package</span>&nbsp;<span class="ident" id="1488712">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1488721">//&nbsp;This&nbsp;file&nbsp;contains&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Go&nbsp;channels.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1488779">import</span>&nbsp;<span class="string" id="1488786">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1488796">const</span>&nbsp;<span class="op" id="1488802">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488805">maxAlign</span>&nbsp;&nbsp;<span class="op" id="1488815">=</span>&nbsp;<span class="num" id="1488817">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488820">hchanSize</span>&nbsp;<span class="op" id="1488830">=</span>&nbsp;<span class="ident" id="1488832">unsafe</span><span class="op" id="1488838">.</span><span class="ident" id="1488839">Sizeof</span><span class="op" id="1488845">(</span><span class="ident" id="1488846">hchan</span><span class="op" id="1488851">{</span><span class="op" id="1488852">}</span><span class="op" id="1488853">)</span>&nbsp;<span class="op" id="1488855">+</span>&nbsp;<span class="builtintype" id="1488857">uintptr</span><span class="op" id="1488864">(</span><span class="op" id="1488865">-</span><span class="builtintype" id="1488866">int</span><span class="op" id="1488869">(</span><span class="ident" id="1488870">unsafe</span><span class="op" id="1488876">.</span><span class="ident" id="1488877">Sizeof</span><span class="op" id="1488883">(</span><span class="ident" id="1488884">hchan</span><span class="op" id="1488889">{</span><span class="op" id="1488890">}</span><span class="op" id="1488891">)</span><span class="op" id="1488892">)</span><span class="op" id="1488893">&amp;</span><span class="op" id="1488894">(</span><span class="ident" id="1488895">maxAlign</span><span class="op" id="1488903">-</span><span class="num" id="1488904">1</span><span class="op" id="1488905">)</span><span class="op" id="1488906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1488909">debugChan</span>&nbsp;<span class="op" id="1488919">=</span>&nbsp;<span class="builtintype" id="1488921">false</span><br>
<span class="lineno">15</span><span class="op" id="1488927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1488930">//&nbsp;TODO(khr):&nbsp;make&nbsp;hchan.buf&nbsp;an&nbsp;unsafe.Pointer,&nbsp;not&nbsp;a&nbsp;*uint8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1488992">func</span>&nbsp;<span class="ident" id="1488997">makechan</span><span class="op" id="1489005">(</span><span class="ident" id="1489006">t</span>&nbsp;<span class="op" id="1489008">*</span><span class="ident" id="1489009">chantype</span><span class="op" id="1489017">,</span>&nbsp;<span class="ident" id="1489019">size</span>&nbsp;<span class="ident" id="1489024">int64</span><span class="op" id="1489029">)</span>&nbsp;<span class="op" id="1489031">*</span><span class="ident" id="1489032">hchan</span>&nbsp;<span class="op" id="1489038">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489041">elem</span>&nbsp;<span class="op" id="1489046">:=</span>&nbsp;<span class="ident" id="1489049">t</span><span class="op" id="1489050">.</span><span class="ident" id="1489051">elem</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489058">//&nbsp;compiler&nbsp;checks&nbsp;this&nbsp;but&nbsp;be&nbsp;safe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489096">if</span>&nbsp;<span class="ident" id="1489099">elem</span><span class="op" id="1489103">.</span><span class="ident" id="1489104">size</span>&nbsp;<span class="op" id="1489109">&gt;=</span>&nbsp;<span class="num" id="1489112">1</span><span class="op" id="1489113">&lt;&lt;</span><span class="num" id="1489115">16</span>&nbsp;<span class="op" id="1489118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489122">gothrow</span><span class="op" id="1489129">(</span><span class="string" id="1489130">&#34;makechan:&nbsp;invalid&nbsp;channel&nbsp;element&nbsp;type&#34;</span><span class="op" id="1489170">)</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489176">if</span>&nbsp;<span class="ident" id="1489179">hchanSize</span><span class="op" id="1489188">%</span><span class="ident" id="1489189">maxAlign</span>&nbsp;<span class="op" id="1489198">!=</span>&nbsp;<span class="num" id="1489201">0</span>&nbsp;<span class="op" id="1489203">||</span>&nbsp;<span class="ident" id="1489206">elem</span><span class="op" id="1489210">.</span><span class="ident" id="1489211">align</span>&nbsp;<span class="op" id="1489217">&gt;</span>&nbsp;<span class="ident" id="1489219">maxAlign</span>&nbsp;<span class="op" id="1489228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489232">gothrow</span><span class="op" id="1489239">(</span><span class="string" id="1489240">&#34;makechan:&nbsp;bad&nbsp;alignment&#34;</span><span class="op" id="1489265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489271">if</span>&nbsp;<span class="ident" id="1489274">size</span>&nbsp;<span class="op" id="1489279">&lt;</span>&nbsp;<span class="num" id="1489281">0</span>&nbsp;<span class="op" id="1489283">||</span>&nbsp;<span class="ident" id="1489286">int64</span><span class="op" id="1489291">(</span><span class="builtintype" id="1489292">uintptr</span><span class="op" id="1489299">(</span><span class="ident" id="1489300">size</span><span class="op" id="1489304">)</span><span class="op" id="1489305">)</span>&nbsp;<span class="op" id="1489307">!=</span>&nbsp;<span class="ident" id="1489310">size</span>&nbsp;<span class="op" id="1489315">||</span>&nbsp;<span class="op" id="1489318">(</span><span class="ident" id="1489319">elem</span><span class="op" id="1489323">.</span><span class="ident" id="1489324">size</span>&nbsp;<span class="op" id="1489329">&gt;</span>&nbsp;<span class="num" id="1489331">0</span>&nbsp;<span class="op" id="1489333">&amp;&amp;</span>&nbsp;<span class="builtintype" id="1489336">uintptr</span><span class="op" id="1489343">(</span><span class="ident" id="1489344">size</span><span class="op" id="1489348">)</span>&nbsp;<span class="op" id="1489350">&gt;</span>&nbsp;<span class="op" id="1489352">(</span><span class="ident" id="1489353">maxmem</span><span class="op" id="1489359">-</span><span class="ident" id="1489360">hchanSize</span><span class="op" id="1489369">)</span><span class="op" id="1489370">/</span><span class="builtintype" id="1489371">uintptr</span><span class="op" id="1489378">(</span><span class="ident" id="1489379">elem</span><span class="op" id="1489383">.</span><span class="ident" id="1489384">size</span><span class="op" id="1489388">)</span><span class="op" id="1489389">)</span>&nbsp;<span class="op" id="1489391">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1489395">panic</span><span class="op" id="1489400">(</span><span class="string" id="1489401">&#34;makechan:&nbsp;size&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1489430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1489433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489437">var</span>&nbsp;<span class="ident" id="1489441">c</span>&nbsp;<span class="op" id="1489443">*</span><span class="ident" id="1489444">hchan</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489451">if</span>&nbsp;<span class="ident" id="1489454">elem</span><span class="op" id="1489458">.</span><span class="ident" id="1489459">kind</span><span class="op" id="1489463">&amp;</span><span class="ident" id="1489464">kindNoPointers</span>&nbsp;<span class="op" id="1489479">!=</span>&nbsp;<span class="num" id="1489482">0</span>&nbsp;<span class="op" id="1489484">||</span>&nbsp;<span class="ident" id="1489487">size</span>&nbsp;<span class="op" id="1489492">==</span>&nbsp;<span class="num" id="1489495">0</span>&nbsp;<span class="op" id="1489497">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489501">//&nbsp;Allocate&nbsp;memory&nbsp;in&nbsp;one&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489535">//&nbsp;Hchan&nbsp;does&nbsp;not&nbsp;contain&nbsp;pointers&nbsp;interesting&nbsp;for&nbsp;GC&nbsp;in&nbsp;this&nbsp;case:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489605">//&nbsp;buf&nbsp;points&nbsp;into&nbsp;the&nbsp;same&nbsp;allocation,&nbsp;elemtype&nbsp;is&nbsp;persistent.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489671">//&nbsp;SudoG&#39;s&nbsp;are&nbsp;referenced&nbsp;from&nbsp;their&nbsp;owning&nbsp;thread&nbsp;so&nbsp;they&nbsp;can&#39;t&nbsp;be&nbsp;collected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1489752">//&nbsp;TODO(dvyukov,rlh):&nbsp;Rethink&nbsp;when&nbsp;collector&nbsp;can&nbsp;move&nbsp;allocated&nbsp;objects.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489827">c</span>&nbsp;<span class="op" id="1489829">=</span>&nbsp;<span class="op" id="1489831">(</span><span class="op" id="1489832">*</span><span class="ident" id="1489833">hchan</span><span class="op" id="1489838">)</span><span class="op" id="1489839">(</span><span class="ident" id="1489840">mallocgc</span><span class="op" id="1489848">(</span><span class="ident" id="1489849">hchanSize</span><span class="op" id="1489858">+</span><span class="builtintype" id="1489859">uintptr</span><span class="op" id="1489866">(</span><span class="ident" id="1489867">size</span><span class="op" id="1489871">)</span><span class="op" id="1489872">*</span><span class="builtintype" id="1489873">uintptr</span><span class="op" id="1489880">(</span><span class="ident" id="1489881">elem</span><span class="op" id="1489885">.</span><span class="ident" id="1489886">size</span><span class="op" id="1489890">)</span><span class="op" id="1489891">,</span>&nbsp;<span class="ident" id="1489893">nil</span><span class="op" id="1489896">,</span>&nbsp;<span class="ident" id="1489898">flagNoScan</span><span class="op" id="1489908">)</span><span class="op" id="1489909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1489913">if</span>&nbsp;<span class="ident" id="1489916">size</span>&nbsp;<span class="op" id="1489921">&gt;</span>&nbsp;<span class="num" id="1489923">0</span>&nbsp;<span class="op" id="1489925">&amp;&amp;</span>&nbsp;<span class="ident" id="1489928">elem</span><span class="op" id="1489932">.</span><span class="ident" id="1489933">size</span>&nbsp;<span class="op" id="1489938">!=</span>&nbsp;<span class="num" id="1489941">0</span>&nbsp;<span class="op" id="1489943">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1489948">c</span><span class="op" id="1489949">.</span><span class="ident" id="1489950">buf</span>&nbsp;<span class="op" id="1489954">=</span>&nbsp;<span class="op" id="1489956">(</span><span class="op" id="1489957">*</span><span class="builtintype" id="1489958">uint8</span><span class="op" id="1489963">)</span><span class="op" id="1489964">(</span><span class="ident" id="1489965">add</span><span class="op" id="1489968">(</span><span class="ident" id="1489969">unsafe</span><span class="op" id="1489975">.</span><span class="ident" id="1489976">Pointer</span><span class="op" id="1489983">(</span><span class="ident" id="1489984">c</span><span class="op" id="1489985">)</span><span class="op" id="1489986">,</span>&nbsp;<span class="ident" id="1489988">hchanSize</span><span class="op" id="1489997">)</span><span class="op" id="1489998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490002">}</span>&nbsp;<span class="keyword" id="1490004">else</span>&nbsp;<span class="op" id="1490009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490014">c</span><span class="op" id="1490015">.</span><span class="ident" id="1490016">buf</span>&nbsp;<span class="op" id="1490020">=</span>&nbsp;<span class="op" id="1490022">(</span><span class="op" id="1490023">*</span><span class="builtintype" id="1490024">uint8</span><span class="op" id="1490029">)</span><span class="op" id="1490030">(</span><span class="ident" id="1490031">unsafe</span><span class="op" id="1490037">.</span><span class="ident" id="1490038">Pointer</span><span class="op" id="1490045">(</span><span class="ident" id="1490046">c</span><span class="op" id="1490047">)</span><span class="op" id="1490048">)</span>&nbsp;<span class="comment" id="1490050">//&nbsp;race&nbsp;detector&nbsp;uses&nbsp;this&nbsp;location&nbsp;for&nbsp;synchronization</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490111">}</span>&nbsp;<span class="keyword" id="1490113">else</span>&nbsp;<span class="op" id="1490118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490122">c</span>&nbsp;<span class="op" id="1490124">=</span>&nbsp;<span class="builtinfunc" id="1490126">new</span><span class="op" id="1490129">(</span><span class="ident" id="1490130">hchan</span><span class="op" id="1490135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490139">c</span><span class="op" id="1490140">.</span><span class="ident" id="1490141">buf</span>&nbsp;<span class="op" id="1490145">=</span>&nbsp;<span class="op" id="1490147">(</span><span class="op" id="1490148">*</span><span class="builtintype" id="1490149">uint8</span><span class="op" id="1490154">)</span><span class="op" id="1490155">(</span><span class="ident" id="1490156">newarray</span><span class="op" id="1490164">(</span><span class="ident" id="1490165">elem</span><span class="op" id="1490169">,</span>&nbsp;<span class="builtintype" id="1490171">uintptr</span><span class="op" id="1490178">(</span><span class="ident" id="1490179">size</span><span class="op" id="1490183">)</span><span class="op" id="1490184">)</span><span class="op" id="1490185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490188">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490191">c</span><span class="op" id="1490192">.</span><span class="ident" id="1490193">elemsize</span>&nbsp;<span class="op" id="1490202">=</span>&nbsp;<span class="builtintype" id="1490204">uint16</span><span class="op" id="1490210">(</span><span class="ident" id="1490211">elem</span><span class="op" id="1490215">.</span><span class="ident" id="1490216">size</span><span class="op" id="1490220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490223">c</span><span class="op" id="1490224">.</span><span class="ident" id="1490225">elemtype</span>&nbsp;<span class="op" id="1490234">=</span>&nbsp;<span class="ident" id="1490236">elem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490242">c</span><span class="op" id="1490243">.</span><span class="ident" id="1490244">dataqsiz</span>&nbsp;<span class="op" id="1490253">=</span>&nbsp;<span class="builtintype" id="1490255">uint</span><span class="op" id="1490259">(</span><span class="ident" id="1490260">size</span><span class="op" id="1490264">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490268">if</span>&nbsp;<span class="ident" id="1490271">debugChan</span>&nbsp;<span class="op" id="1490281">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1490285">print</span><span class="op" id="1490290">(</span><span class="string" id="1490291">&#34;makechan:&nbsp;chan=&#34;</span><span class="op" id="1490308">,</span>&nbsp;<span class="ident" id="1490310">c</span><span class="op" id="1490311">,</span>&nbsp;<span class="string" id="1490313">&#34;;&nbsp;elemsize=&#34;</span><span class="op" id="1490326">,</span>&nbsp;<span class="ident" id="1490328">elem</span><span class="op" id="1490332">.</span><span class="ident" id="1490333">size</span><span class="op" id="1490337">,</span>&nbsp;<span class="string" id="1490339">&#34;;&nbsp;elemalg=&#34;</span><span class="op" id="1490351">,</span>&nbsp;<span class="ident" id="1490353">elem</span><span class="op" id="1490357">.</span><span class="ident" id="1490358">alg</span><span class="op" id="1490361">,</span>&nbsp;<span class="string" id="1490363">&#34;;&nbsp;dataqsiz=&#34;</span><span class="op" id="1490376">,</span>&nbsp;<span class="ident" id="1490378">size</span><span class="op" id="1490382">,</span>&nbsp;<span class="string" id="1490384">&#34;\n&#34;</span><span class="op" id="1490388">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1490391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490394">return</span>&nbsp;<span class="ident" id="1490401">c</span><br>
<span class="lineno"></span><span class="op" id="1490403">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1490406">//&nbsp;chanbuf(c,&nbsp;i)&nbsp;is&nbsp;pointer&nbsp;to&nbsp;the&nbsp;i&#39;th&nbsp;slot&nbsp;in&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="1490466">func</span>&nbsp;<span class="ident" id="1490471">chanbuf</span><span class="op" id="1490478">(</span><span class="ident" id="1490479">c</span>&nbsp;<span class="op" id="1490481">*</span><span class="ident" id="1490482">hchan</span><span class="op" id="1490487">,</span>&nbsp;<span class="ident" id="1490489">i</span>&nbsp;<span class="builtintype" id="1490491">uint</span><span class="op" id="1490495">)</span>&nbsp;<span class="ident" id="1490497">unsafe</span><span class="op" id="1490503">.</span><span class="ident" id="1490504">Pointer</span>&nbsp;<span class="op" id="1490512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1490515">return</span>&nbsp;<span class="ident" id="1490522">add</span><span class="op" id="1490525">(</span><span class="ident" id="1490526">unsafe</span><span class="op" id="1490532">.</span><span class="ident" id="1490533">Pointer</span><span class="op" id="1490540">(</span><span class="ident" id="1490541">c</span><span class="op" id="1490542">.</span><span class="ident" id="1490543">buf</span><span class="op" id="1490546">)</span><span class="op" id="1490547">,</span>&nbsp;<span class="builtintype" id="1490549">uintptr</span><span class="op" id="1490556">(</span><span class="ident" id="1490557">i</span><span class="op" id="1490558">)</span><span class="op" id="1490559">*</span><span class="builtintype" id="1490560">uintptr</span><span class="op" id="1490567">(</span><span class="ident" id="1490568">c</span><span class="op" id="1490569">.</span><span class="ident" id="1490570">elemsize</span><span class="op" id="1490578">)</span><span class="op" id="1490579">)</span><br>
<span class="lineno"></span><span class="op" id="1490581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1490584">//&nbsp;entry&nbsp;point&nbsp;for&nbsp;c&nbsp;&lt;-&nbsp;x&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1490629">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1490642">func</span>&nbsp;<span class="ident" id="1490647">chansend1</span><span class="op" id="1490656">(</span><span class="ident" id="1490657">t</span>&nbsp;<span class="op" id="1490659">*</span><span class="ident" id="1490660">chantype</span><span class="op" id="1490668">,</span>&nbsp;<span class="ident" id="1490670">c</span>&nbsp;<span class="op" id="1490672">*</span><span class="ident" id="1490673">hchan</span><span class="op" id="1490678">,</span>&nbsp;<span class="ident" id="1490680">elem</span>&nbsp;<span class="ident" id="1490685">unsafe</span><span class="op" id="1490691">.</span><span class="ident" id="1490692">Pointer</span><span class="op" id="1490699">)</span>&nbsp;<span class="op" id="1490701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1490704">chansend</span><span class="op" id="1490712">(</span><span class="ident" id="1490713">t</span><span class="op" id="1490714">,</span>&nbsp;<span class="ident" id="1490716">c</span><span class="op" id="1490717">,</span>&nbsp;<span class="ident" id="1490719">elem</span><span class="op" id="1490723">,</span>&nbsp;<span class="builtintype" id="1490725">true</span><span class="op" id="1490729">,</span>&nbsp;<span class="ident" id="1490731">getcallerpc</span><span class="op" id="1490742">(</span><span class="ident" id="1490743">unsafe</span><span class="op" id="1490749">.</span><span class="ident" id="1490750">Pointer</span><span class="op" id="1490757">(</span><span class="op" id="1490758">&amp;</span><span class="ident" id="1490759">t</span><span class="op" id="1490760">)</span><span class="op" id="1490761">)</span><span class="op" id="1490762">)</span><br>
<span class="lineno"></span><span class="op" id="1490764">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="comment" id="1490767">/*<br>
<span class="lineno"></span>&nbsp;*&nbsp;generic&nbsp;single&nbsp;channel&nbsp;send/recv<br>
<span class="lineno"></span>&nbsp;*&nbsp;If&nbsp;block&nbsp;is&nbsp;not&nbsp;nil,<br>
<span class="lineno"></span>&nbsp;*&nbsp;then&nbsp;the&nbsp;protocol&nbsp;will&nbsp;not<br>
<span class="lineno">75</span>&nbsp;*&nbsp;sleep&nbsp;but&nbsp;return&nbsp;if&nbsp;it&nbsp;could<br>
<span class="lineno"></span>&nbsp;*&nbsp;not&nbsp;complete.<br>
<span class="lineno"></span>&nbsp;*<br>
<span class="lineno"></span>&nbsp;*&nbsp;sleep&nbsp;can&nbsp;wake&nbsp;up&nbsp;with&nbsp;g.param&nbsp;==&nbsp;nil<br>
<span class="lineno"></span>&nbsp;*&nbsp;when&nbsp;a&nbsp;channel&nbsp;involved&nbsp;in&nbsp;the&nbsp;sleep&nbsp;has<br>
<span class="lineno">80</span>&nbsp;*&nbsp;been&nbsp;closed.&nbsp;&nbsp;it&nbsp;is&nbsp;easiest&nbsp;to&nbsp;loop&nbsp;and&nbsp;re-run<br>
<span class="lineno"></span>&nbsp;*&nbsp;the&nbsp;operation;&nbsp;we&#39;ll&nbsp;see&nbsp;that&nbsp;it&#39;s&nbsp;now&nbsp;closed.<br>
<span class="lineno"></span>&nbsp;*/</span><br>
<span class="lineno"></span><span class="keyword" id="1491101">func</span>&nbsp;<span class="ident" id="1491106">chansend</span><span class="op" id="1491114">(</span><span class="ident" id="1491115">t</span>&nbsp;<span class="op" id="1491117">*</span><span class="ident" id="1491118">chantype</span><span class="op" id="1491126">,</span>&nbsp;<span class="ident" id="1491128">c</span>&nbsp;<span class="op" id="1491130">*</span><span class="ident" id="1491131">hchan</span><span class="op" id="1491136">,</span>&nbsp;<span class="ident" id="1491138">ep</span>&nbsp;<span class="ident" id="1491141">unsafe</span><span class="op" id="1491147">.</span><span class="ident" id="1491148">Pointer</span><span class="op" id="1491155">,</span>&nbsp;<span class="ident" id="1491157">block</span>&nbsp;<span class="builtintype" id="1491163">bool</span><span class="op" id="1491167">,</span>&nbsp;<span class="ident" id="1491169">callerpc</span>&nbsp;<span class="builtintype" id="1491178">uintptr</span><span class="op" id="1491185">)</span>&nbsp;<span class="builtintype" id="1491187">bool</span>&nbsp;<span class="op" id="1491192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491195">if</span>&nbsp;<span class="ident" id="1491198">raceenabled</span>&nbsp;<span class="op" id="1491210">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491214">raceReadObjectPC</span><span class="op" id="1491230">(</span><span class="ident" id="1491231">t</span><span class="op" id="1491232">.</span><span class="ident" id="1491233">elem</span><span class="op" id="1491237">,</span>&nbsp;<span class="ident" id="1491239">ep</span><span class="op" id="1491241">,</span>&nbsp;<span class="ident" id="1491243">callerpc</span><span class="op" id="1491251">,</span>&nbsp;<span class="ident" id="1491253">funcPC</span><span class="op" id="1491259">(</span><span class="ident" id="1491260">chansend</span><span class="op" id="1491268">)</span><span class="op" id="1491269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491276">if</span>&nbsp;<span class="ident" id="1491279">c</span>&nbsp;<span class="op" id="1491281">==</span>&nbsp;<span class="ident" id="1491284">nil</span>&nbsp;<span class="op" id="1491288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491292">if</span>&nbsp;<span class="op" id="1491295">!</span><span class="ident" id="1491296">block</span>&nbsp;<span class="op" id="1491302">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491307">return</span>&nbsp;<span class="builtintype" id="1491314">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491326">gopark</span><span class="op" id="1491332">(</span><span class="ident" id="1491333">nil</span><span class="op" id="1491336">,</span>&nbsp;<span class="ident" id="1491338">nil</span><span class="op" id="1491341">,</span>&nbsp;<span class="string" id="1491343">&#34;chan&nbsp;send&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1491365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491369">gothrow</span><span class="op" id="1491376">(</span><span class="string" id="1491377">&#34;unreachable&#34;</span><span class="op" id="1491390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491393">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491397">if</span>&nbsp;<span class="ident" id="1491400">debugChan</span>&nbsp;<span class="op" id="1491410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1491414">print</span><span class="op" id="1491419">(</span><span class="string" id="1491420">&#34;chansend:&nbsp;chan=&#34;</span><span class="op" id="1491437">,</span>&nbsp;<span class="ident" id="1491439">c</span><span class="op" id="1491440">,</span>&nbsp;<span class="string" id="1491442">&#34;\n&#34;</span><span class="op" id="1491446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1491453">if</span>&nbsp;<span class="ident" id="1491456">raceenabled</span>&nbsp;<span class="op" id="1491468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1491472">racereadpc</span><span class="op" id="1491482">(</span><span class="ident" id="1491483">unsafe</span><span class="op" id="1491489">.</span><span class="ident" id="1491490">Pointer</span><span class="op" id="1491497">(</span><span class="ident" id="1491498">c</span><span class="op" id="1491499">)</span><span class="op" id="1491500">,</span>&nbsp;<span class="ident" id="1491502">callerpc</span><span class="op" id="1491510">,</span>&nbsp;<span class="ident" id="1491512">funcPC</span><span class="op" id="1491518">(</span><span class="ident" id="1491519">chansend</span><span class="op" id="1491527">)</span><span class="op" id="1491528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1491531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491535">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491618">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491622">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491705">//&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491787">//&nbsp;(first&nbsp;c.closed&nbsp;and&nbsp;second&nbsp;c.recvq.first&nbsp;or&nbsp;c.qcount&nbsp;depending&nbsp;on&nbsp;kind&nbsp;of&nbsp;channel).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491875">//&nbsp;Because&nbsp;a&nbsp;closed&nbsp;channel&nbsp;cannot&nbsp;transition&nbsp;from&nbsp;&#39;ready&nbsp;for&nbsp;sending&#39;&nbsp;to</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1491950">//&nbsp;&#39;not&nbsp;ready&nbsp;for&nbsp;sending&#39;,&nbsp;even&nbsp;if&nbsp;the&nbsp;channel&nbsp;is&nbsp;closed&nbsp;between&nbsp;the&nbsp;two&nbsp;observations,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492039">//&nbsp;they&nbsp;imply&nbsp;a&nbsp;moment&nbsp;between&nbsp;the&nbsp;two&nbsp;when&nbsp;the&nbsp;channel&nbsp;was&nbsp;both&nbsp;not&nbsp;yet&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492120">//&nbsp;and&nbsp;not&nbsp;ready&nbsp;for&nbsp;sending.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492207">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;send&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492252">//</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492256">//&nbsp;It&nbsp;is&nbsp;okay&nbsp;if&nbsp;the&nbsp;reads&nbsp;are&nbsp;reordered&nbsp;here:&nbsp;if&nbsp;we&nbsp;observe&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492342">//&nbsp;ready&nbsp;for&nbsp;sending&nbsp;and&nbsp;then&nbsp;observe&nbsp;that&nbsp;it&nbsp;is&nbsp;not&nbsp;closed,&nbsp;that&nbsp;implies&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1492426">//&nbsp;channel&nbsp;wasn&#39;t&nbsp;closed&nbsp;during&nbsp;the&nbsp;first&nbsp;observation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492482">if</span>&nbsp;<span class="op" id="1492485">!</span><span class="ident" id="1492486">block</span>&nbsp;<span class="op" id="1492492">&amp;&amp;</span>&nbsp;<span class="ident" id="1492495">c</span><span class="op" id="1492496">.</span><span class="ident" id="1492497">closed</span>&nbsp;<span class="op" id="1492504">==</span>&nbsp;<span class="num" id="1492507">0</span>&nbsp;<span class="op" id="1492509">&amp;&amp;</span>&nbsp;<span class="op" id="1492512">(</span><span class="op" id="1492513">(</span><span class="ident" id="1492514">c</span><span class="op" id="1492515">.</span><span class="ident" id="1492516">dataqsiz</span>&nbsp;<span class="op" id="1492525">==</span>&nbsp;<span class="num" id="1492528">0</span>&nbsp;<span class="op" id="1492530">&amp;&amp;</span>&nbsp;<span class="ident" id="1492533">c</span><span class="op" id="1492534">.</span><span class="ident" id="1492535">recvq</span><span class="op" id="1492540">.</span><span class="ident" id="1492541">first</span>&nbsp;<span class="op" id="1492547">==</span>&nbsp;<span class="ident" id="1492550">nil</span><span class="op" id="1492553">)</span>&nbsp;<span class="op" id="1492555">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492560">(</span><span class="ident" id="1492561">c</span><span class="op" id="1492562">.</span><span class="ident" id="1492563">dataqsiz</span>&nbsp;<span class="op" id="1492572">&gt;</span>&nbsp;<span class="num" id="1492574">0</span>&nbsp;<span class="op" id="1492576">&amp;&amp;</span>&nbsp;<span class="ident" id="1492579">c</span><span class="op" id="1492580">.</span><span class="ident" id="1492581">qcount</span>&nbsp;<span class="op" id="1492588">==</span>&nbsp;<span class="ident" id="1492591">c</span><span class="op" id="1492592">.</span><span class="ident" id="1492593">dataqsiz</span><span class="op" id="1492601">)</span><span class="op" id="1492602">)</span>&nbsp;<span class="op" id="1492604">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492608">return</span>&nbsp;<span class="builtintype" id="1492615">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492622">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492626">var</span>&nbsp;<span class="ident" id="1492630">t0</span>&nbsp;<span class="ident" id="1492633">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492640">if</span>&nbsp;<span class="ident" id="1492643">blockprofilerate</span>&nbsp;<span class="op" id="1492660">&gt;</span>&nbsp;<span class="num" id="1492662">0</span>&nbsp;<span class="op" id="1492664">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492668">t0</span>&nbsp;<span class="op" id="1492671">=</span>&nbsp;<span class="ident" id="1492673">cputicks</span><span class="op" id="1492681">(</span><span class="op" id="1492682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492689">lock</span><span class="op" id="1492693">(</span><span class="op" id="1492694">&amp;</span><span class="ident" id="1492695">c</span><span class="op" id="1492696">.</span><span class="ident" id="1492697">lock</span><span class="op" id="1492701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492704">if</span>&nbsp;<span class="ident" id="1492707">c</span><span class="op" id="1492708">.</span><span class="ident" id="1492709">closed</span>&nbsp;<span class="op" id="1492716">!=</span>&nbsp;<span class="num" id="1492719">0</span>&nbsp;<span class="op" id="1492721">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492725">unlock</span><span class="op" id="1492731">(</span><span class="op" id="1492732">&amp;</span><span class="ident" id="1492733">c</span><span class="op" id="1492734">.</span><span class="ident" id="1492735">lock</span><span class="op" id="1492739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1492743">panic</span><span class="op" id="1492748">(</span><span class="string" id="1492749">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1492773">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492780">if</span>&nbsp;<span class="ident" id="1492783">c</span><span class="op" id="1492784">.</span><span class="ident" id="1492785">dataqsiz</span>&nbsp;<span class="op" id="1492794">==</span>&nbsp;<span class="num" id="1492797">0</span>&nbsp;<span class="op" id="1492799">{</span>&nbsp;<span class="comment" id="1492801">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492826">sg</span>&nbsp;<span class="op" id="1492829">:=</span>&nbsp;<span class="ident" id="1492832">c</span><span class="op" id="1492833">.</span><span class="ident" id="1492834">recvq</span><span class="op" id="1492839">.</span><span class="ident" id="1492840">dequeue</span><span class="op" id="1492847">(</span><span class="op" id="1492848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492852">if</span>&nbsp;<span class="ident" id="1492855">sg</span>&nbsp;<span class="op" id="1492858">!=</span>&nbsp;<span class="ident" id="1492861">nil</span>&nbsp;<span class="op" id="1492865">{</span>&nbsp;<span class="comment" id="1492867">//&nbsp;found&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492898">if</span>&nbsp;<span class="ident" id="1492901">raceenabled</span>&nbsp;<span class="op" id="1492913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492919">racesync</span><span class="op" id="1492927">(</span><span class="ident" id="1492928">c</span><span class="op" id="1492929">,</span>&nbsp;<span class="ident" id="1492931">sg</span><span class="op" id="1492933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1492938">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492943">unlock</span><span class="op" id="1492949">(</span><span class="op" id="1492950">&amp;</span><span class="ident" id="1492951">c</span><span class="op" id="1492952">.</span><span class="ident" id="1492953">lock</span><span class="op" id="1492957">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1492963">recvg</span>&nbsp;<span class="op" id="1492969">:=</span>&nbsp;<span class="ident" id="1492972">sg</span><span class="op" id="1492974">.</span><span class="ident" id="1492975">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1492980">if</span>&nbsp;<span class="ident" id="1492983">sg</span><span class="op" id="1492985">.</span><span class="ident" id="1492986">elem</span>&nbsp;<span class="op" id="1492991">!=</span>&nbsp;<span class="ident" id="1492994">nil</span>&nbsp;<span class="op" id="1492998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493004">memmove</span><span class="op" id="1493011">(</span><span class="ident" id="1493012">unsafe</span><span class="op" id="1493018">.</span><span class="ident" id="1493019">Pointer</span><span class="op" id="1493026">(</span><span class="ident" id="1493027">sg</span><span class="op" id="1493029">.</span><span class="ident" id="1493030">elem</span><span class="op" id="1493034">)</span><span class="op" id="1493035">,</span>&nbsp;<span class="ident" id="1493037">ep</span><span class="op" id="1493039">,</span>&nbsp;<span class="builtintype" id="1493041">uintptr</span><span class="op" id="1493048">(</span><span class="ident" id="1493049">c</span><span class="op" id="1493050">.</span><span class="ident" id="1493051">elemsize</span><span class="op" id="1493059">)</span><span class="op" id="1493060">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493066">sg</span><span class="op" id="1493068">.</span><span class="ident" id="1493069">elem</span>&nbsp;<span class="op" id="1493074">=</span>&nbsp;<span class="ident" id="1493076">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493088">recvg</span><span class="op" id="1493093">.</span><span class="ident" id="1493094">param</span>&nbsp;<span class="op" id="1493100">=</span>&nbsp;<span class="ident" id="1493102">unsafe</span><span class="op" id="1493108">.</span><span class="ident" id="1493109">Pointer</span><span class="op" id="1493116">(</span><span class="ident" id="1493117">sg</span><span class="op" id="1493119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493124">if</span>&nbsp;<span class="ident" id="1493127">sg</span><span class="op" id="1493129">.</span><span class="ident" id="1493130">releasetime</span>&nbsp;<span class="op" id="1493142">!=</span>&nbsp;<span class="num" id="1493145">0</span>&nbsp;<span class="op" id="1493147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493153">sg</span><span class="op" id="1493155">.</span><span class="ident" id="1493156">releasetime</span>&nbsp;<span class="op" id="1493168">=</span>&nbsp;<span class="ident" id="1493170">cputicks</span><span class="op" id="1493178">(</span><span class="op" id="1493179">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493184">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493189">goready</span><span class="op" id="1493196">(</span><span class="ident" id="1493197">recvg</span><span class="op" id="1493202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493207">return</span>&nbsp;<span class="builtintype" id="1493214">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493221">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493226">if</span>&nbsp;<span class="op" id="1493229">!</span><span class="ident" id="1493230">block</span>&nbsp;<span class="op" id="1493236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493241">unlock</span><span class="op" id="1493247">(</span><span class="op" id="1493248">&amp;</span><span class="ident" id="1493249">c</span><span class="op" id="1493250">.</span><span class="ident" id="1493251">lock</span><span class="op" id="1493255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493260">return</span>&nbsp;<span class="builtintype" id="1493267">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493280">//&nbsp;no&nbsp;receiver&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493331">gp</span>&nbsp;<span class="op" id="1493334">:=</span>&nbsp;<span class="ident" id="1493337">getg</span><span class="op" id="1493341">(</span><span class="op" id="1493342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493346">mysg</span>&nbsp;<span class="op" id="1493351">:=</span>&nbsp;<span class="ident" id="1493354">acquireSudog</span><span class="op" id="1493366">(</span><span class="op" id="1493367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493371">mysg</span><span class="op" id="1493375">.</span><span class="ident" id="1493376">releasetime</span>&nbsp;<span class="op" id="1493388">=</span>&nbsp;<span class="num" id="1493390">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493394">if</span>&nbsp;<span class="ident" id="1493397">t0</span>&nbsp;<span class="op" id="1493400">!=</span>&nbsp;<span class="num" id="1493403">0</span>&nbsp;<span class="op" id="1493405">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493410">mysg</span><span class="op" id="1493414">.</span><span class="ident" id="1493415">releasetime</span>&nbsp;<span class="op" id="1493427">=</span>&nbsp;<span class="op" id="1493429">-</span><span class="num" id="1493430">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493438">mysg</span><span class="op" id="1493442">.</span><span class="ident" id="1493443">elem</span>&nbsp;<span class="op" id="1493448">=</span>&nbsp;<span class="ident" id="1493450">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493455">mysg</span><span class="op" id="1493459">.</span><span class="ident" id="1493460">waitlink</span>&nbsp;<span class="op" id="1493469">=</span>&nbsp;<span class="ident" id="1493471">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493477">gp</span><span class="op" id="1493479">.</span><span class="ident" id="1493480">waiting</span>&nbsp;<span class="op" id="1493488">=</span>&nbsp;<span class="ident" id="1493490">mysg</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493497">mysg</span><span class="op" id="1493501">.</span><span class="ident" id="1493502">g</span>&nbsp;<span class="op" id="1493504">=</span>&nbsp;<span class="ident" id="1493506">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493511">mysg</span><span class="op" id="1493515">.</span><span class="ident" id="1493516">selectdone</span>&nbsp;<span class="op" id="1493527">=</span>&nbsp;<span class="ident" id="1493529">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493535">gp</span><span class="op" id="1493537">.</span><span class="ident" id="1493538">param</span>&nbsp;<span class="op" id="1493544">=</span>&nbsp;<span class="ident" id="1493546">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493552">c</span><span class="op" id="1493553">.</span><span class="ident" id="1493554">sendq</span><span class="op" id="1493559">.</span><span class="ident" id="1493560">enqueue</span><span class="op" id="1493567">(</span><span class="ident" id="1493568">mysg</span><span class="op" id="1493572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493576">goparkunlock</span><span class="op" id="1493588">(</span><span class="op" id="1493589">&amp;</span><span class="ident" id="1493590">c</span><span class="op" id="1493591">.</span><span class="ident" id="1493592">lock</span><span class="op" id="1493596">,</span>&nbsp;<span class="string" id="1493598">&#34;chan&nbsp;send&#34;</span><span class="op" id="1493609">)</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493614">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493639">if</span>&nbsp;<span class="ident" id="1493642">mysg</span>&nbsp;<span class="op" id="1493647">!=</span>&nbsp;<span class="ident" id="1493650">gp</span><span class="op" id="1493652">.</span><span class="ident" id="1493653">waiting</span>&nbsp;<span class="op" id="1493661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493666">gothrow</span><span class="op" id="1493673">(</span><span class="string" id="1493674">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1493704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493708">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493712">gp</span><span class="op" id="1493714">.</span><span class="ident" id="1493715">waiting</span>&nbsp;<span class="op" id="1493723">=</span>&nbsp;<span class="ident" id="1493725">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493731">if</span>&nbsp;<span class="ident" id="1493734">gp</span><span class="op" id="1493736">.</span><span class="ident" id="1493737">param</span>&nbsp;<span class="op" id="1493743">==</span>&nbsp;<span class="ident" id="1493746">nil</span>&nbsp;<span class="op" id="1493750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493755">if</span>&nbsp;<span class="ident" id="1493758">c</span><span class="op" id="1493759">.</span><span class="ident" id="1493760">closed</span>&nbsp;<span class="op" id="1493767">==</span>&nbsp;<span class="num" id="1493770">0</span>&nbsp;<span class="op" id="1493772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493778">gothrow</span><span class="op" id="1493785">(</span><span class="string" id="1493786">&#34;chansend:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1493813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493818">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1493823">panic</span><span class="op" id="1493828">(</span><span class="string" id="1493829">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1493853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493861">gp</span><span class="op" id="1493863">.</span><span class="ident" id="1493864">param</span>&nbsp;<span class="op" id="1493870">=</span>&nbsp;<span class="ident" id="1493872">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493878">if</span>&nbsp;<span class="ident" id="1493881">mysg</span><span class="op" id="1493885">.</span><span class="ident" id="1493886">releasetime</span>&nbsp;<span class="op" id="1493898">&gt;</span>&nbsp;<span class="num" id="1493900">0</span>&nbsp;<span class="op" id="1493902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493907">blockevent</span><span class="op" id="1493917">(</span><span class="ident" id="1493918">int64</span><span class="op" id="1493923">(</span><span class="ident" id="1493924">mysg</span><span class="op" id="1493928">.</span><span class="ident" id="1493929">releasetime</span><span class="op" id="1493940">)</span><span class="op" id="1493941">-</span><span class="ident" id="1493942">t0</span><span class="op" id="1493944">,</span>&nbsp;<span class="num" id="1493946">2</span><span class="op" id="1493947">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1493955">releaseSudog</span><span class="op" id="1493967">(</span><span class="ident" id="1493968">mysg</span><span class="op" id="1493972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1493976">return</span>&nbsp;<span class="builtintype" id="1493983">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1493989">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1493993">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494018">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;space&nbsp;to&nbsp;write&nbsp;our&nbsp;data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494060">var</span>&nbsp;<span class="ident" id="1494064">t1</span>&nbsp;<span class="ident" id="1494067">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494074">for</span>&nbsp;<span class="ident" id="1494078">c</span><span class="op" id="1494079">.</span><span class="ident" id="1494080">qcount</span>&nbsp;<span class="op" id="1494087">&gt;=</span>&nbsp;<span class="ident" id="1494090">c</span><span class="op" id="1494091">.</span><span class="ident" id="1494092">dataqsiz</span>&nbsp;<span class="op" id="1494101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494105">if</span>&nbsp;<span class="op" id="1494108">!</span><span class="ident" id="1494109">block</span>&nbsp;<span class="op" id="1494115">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494120">unlock</span><span class="op" id="1494126">(</span><span class="op" id="1494127">&amp;</span><span class="ident" id="1494128">c</span><span class="op" id="1494129">.</span><span class="ident" id="1494130">lock</span><span class="op" id="1494134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494139">return</span>&nbsp;<span class="builtintype" id="1494146">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494158">gp</span>&nbsp;<span class="op" id="1494161">:=</span>&nbsp;<span class="ident" id="1494164">getg</span><span class="op" id="1494168">(</span><span class="op" id="1494169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494173">mysg</span>&nbsp;<span class="op" id="1494178">:=</span>&nbsp;<span class="ident" id="1494181">acquireSudog</span><span class="op" id="1494193">(</span><span class="op" id="1494194">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494198">mysg</span><span class="op" id="1494202">.</span><span class="ident" id="1494203">releasetime</span>&nbsp;<span class="op" id="1494215">=</span>&nbsp;<span class="num" id="1494217">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494221">if</span>&nbsp;<span class="ident" id="1494224">t0</span>&nbsp;<span class="op" id="1494227">!=</span>&nbsp;<span class="num" id="1494230">0</span>&nbsp;<span class="op" id="1494232">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494237">mysg</span><span class="op" id="1494241">.</span><span class="ident" id="1494242">releasetime</span>&nbsp;<span class="op" id="1494254">=</span>&nbsp;<span class="op" id="1494256">-</span><span class="num" id="1494257">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494265">mysg</span><span class="op" id="1494269">.</span><span class="ident" id="1494270">g</span>&nbsp;<span class="op" id="1494272">=</span>&nbsp;<span class="ident" id="1494274">gp</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494279">mysg</span><span class="op" id="1494283">.</span><span class="ident" id="1494284">elem</span>&nbsp;<span class="op" id="1494289">=</span>&nbsp;<span class="ident" id="1494291">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494297">mysg</span><span class="op" id="1494301">.</span><span class="ident" id="1494302">selectdone</span>&nbsp;<span class="op" id="1494313">=</span>&nbsp;<span class="ident" id="1494315">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494321">c</span><span class="op" id="1494322">.</span><span class="ident" id="1494323">sendq</span><span class="op" id="1494328">.</span><span class="ident" id="1494329">enqueue</span><span class="op" id="1494336">(</span><span class="ident" id="1494337">mysg</span><span class="op" id="1494341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494345">goparkunlock</span><span class="op" id="1494357">(</span><span class="op" id="1494358">&amp;</span><span class="ident" id="1494359">c</span><span class="op" id="1494360">.</span><span class="ident" id="1494361">lock</span><span class="op" id="1494365">,</span>&nbsp;<span class="string" id="1494367">&#34;chan&nbsp;send&#34;</span><span class="op" id="1494378">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494383">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494419">if</span>&nbsp;<span class="ident" id="1494422">mysg</span><span class="op" id="1494426">.</span><span class="ident" id="1494427">releasetime</span>&nbsp;<span class="op" id="1494439">&gt;</span>&nbsp;<span class="num" id="1494441">0</span>&nbsp;<span class="op" id="1494443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494448">t1</span>&nbsp;<span class="op" id="1494451">=</span>&nbsp;<span class="ident" id="1494453">mysg</span><span class="op" id="1494457">.</span><span class="ident" id="1494458">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494476">releaseSudog</span><span class="op" id="1494488">(</span><span class="ident" id="1494489">mysg</span><span class="op" id="1494493">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494497">lock</span><span class="op" id="1494501">(</span><span class="op" id="1494502">&amp;</span><span class="ident" id="1494503">c</span><span class="op" id="1494504">.</span><span class="ident" id="1494505">lock</span><span class="op" id="1494509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494513">if</span>&nbsp;<span class="ident" id="1494516">c</span><span class="op" id="1494517">.</span><span class="ident" id="1494518">closed</span>&nbsp;<span class="op" id="1494525">!=</span>&nbsp;<span class="num" id="1494528">0</span>&nbsp;<span class="op" id="1494530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494535">unlock</span><span class="op" id="1494541">(</span><span class="op" id="1494542">&amp;</span><span class="ident" id="1494543">c</span><span class="op" id="1494544">.</span><span class="ident" id="1494545">lock</span><span class="op" id="1494549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1494554">panic</span><span class="op" id="1494559">(</span><span class="string" id="1494560">&#34;send&nbsp;on&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1494584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494588">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494591">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494595">//&nbsp;write&nbsp;our&nbsp;data&nbsp;into&nbsp;the&nbsp;channel&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494638">if</span>&nbsp;<span class="ident" id="1494641">raceenabled</span>&nbsp;<span class="op" id="1494653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494657">raceacquire</span><span class="op" id="1494668">(</span><span class="ident" id="1494669">chanbuf</span><span class="op" id="1494676">(</span><span class="ident" id="1494677">c</span><span class="op" id="1494678">,</span>&nbsp;<span class="ident" id="1494680">c</span><span class="op" id="1494681">.</span><span class="ident" id="1494682">sendx</span><span class="op" id="1494687">)</span><span class="op" id="1494688">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494692">racerelease</span><span class="op" id="1494703">(</span><span class="ident" id="1494704">chanbuf</span><span class="op" id="1494711">(</span><span class="ident" id="1494712">c</span><span class="op" id="1494713">,</span>&nbsp;<span class="ident" id="1494715">c</span><span class="op" id="1494716">.</span><span class="ident" id="1494717">sendx</span><span class="op" id="1494722">)</span><span class="op" id="1494723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494729">memmove</span><span class="op" id="1494736">(</span><span class="ident" id="1494737">chanbuf</span><span class="op" id="1494744">(</span><span class="ident" id="1494745">c</span><span class="op" id="1494746">,</span>&nbsp;<span class="ident" id="1494748">c</span><span class="op" id="1494749">.</span><span class="ident" id="1494750">sendx</span><span class="op" id="1494755">)</span><span class="op" id="1494756">,</span>&nbsp;<span class="ident" id="1494758">ep</span><span class="op" id="1494760">,</span>&nbsp;<span class="builtintype" id="1494762">uintptr</span><span class="op" id="1494769">(</span><span class="ident" id="1494770">c</span><span class="op" id="1494771">.</span><span class="ident" id="1494772">elemsize</span><span class="op" id="1494780">)</span><span class="op" id="1494781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494784">c</span><span class="op" id="1494785">.</span><span class="ident" id="1494786">sendx</span><span class="op" id="1494791">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494795">if</span>&nbsp;<span class="ident" id="1494798">c</span><span class="op" id="1494799">.</span><span class="ident" id="1494800">sendx</span>&nbsp;<span class="op" id="1494806">==</span>&nbsp;<span class="ident" id="1494809">c</span><span class="op" id="1494810">.</span><span class="ident" id="1494811">dataqsiz</span>&nbsp;<span class="op" id="1494820">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494824">c</span><span class="op" id="1494825">.</span><span class="ident" id="1494826">sendx</span>&nbsp;<span class="op" id="1494832">=</span>&nbsp;<span class="num" id="1494834">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1494837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494840">c</span><span class="op" id="1494841">.</span><span class="ident" id="1494842">qcount</span><span class="op" id="1494848">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1494853">//&nbsp;wake&nbsp;up&nbsp;a&nbsp;waiting&nbsp;receiver</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494884">sg</span>&nbsp;<span class="op" id="1494887">:=</span>&nbsp;<span class="ident" id="1494890">c</span><span class="op" id="1494891">.</span><span class="ident" id="1494892">recvq</span><span class="op" id="1494897">.</span><span class="ident" id="1494898">dequeue</span><span class="op" id="1494905">(</span><span class="op" id="1494906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494909">if</span>&nbsp;<span class="ident" id="1494912">sg</span>&nbsp;<span class="op" id="1494915">!=</span>&nbsp;<span class="ident" id="1494918">nil</span>&nbsp;<span class="op" id="1494922">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494926">recvg</span>&nbsp;<span class="op" id="1494932">:=</span>&nbsp;<span class="ident" id="1494935">sg</span><span class="op" id="1494937">.</span><span class="ident" id="1494938">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494942">unlock</span><span class="op" id="1494948">(</span><span class="op" id="1494949">&amp;</span><span class="ident" id="1494950">c</span><span class="op" id="1494951">.</span><span class="ident" id="1494952">lock</span><span class="op" id="1494956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1494960">if</span>&nbsp;<span class="ident" id="1494963">sg</span><span class="op" id="1494965">.</span><span class="ident" id="1494966">releasetime</span>&nbsp;<span class="op" id="1494978">!=</span>&nbsp;<span class="num" id="1494981">0</span>&nbsp;<span class="op" id="1494983">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1494988">sg</span><span class="op" id="1494990">.</span><span class="ident" id="1494991">releasetime</span>&nbsp;<span class="op" id="1495003">=</span>&nbsp;<span class="ident" id="1495005">cputicks</span><span class="op" id="1495013">(</span><span class="op" id="1495014">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495022">goready</span><span class="op" id="1495029">(</span><span class="ident" id="1495030">recvg</span><span class="op" id="1495035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495038">}</span>&nbsp;<span class="keyword" id="1495040">else</span>&nbsp;<span class="op" id="1495045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495049">unlock</span><span class="op" id="1495055">(</span><span class="op" id="1495056">&amp;</span><span class="ident" id="1495057">c</span><span class="op" id="1495058">.</span><span class="ident" id="1495059">lock</span><span class="op" id="1495063">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495069">if</span>&nbsp;<span class="ident" id="1495072">t1</span>&nbsp;<span class="op" id="1495075">&gt;</span>&nbsp;<span class="num" id="1495077">0</span>&nbsp;<span class="op" id="1495079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495083">blockevent</span><span class="op" id="1495093">(</span><span class="ident" id="1495094">t1</span><span class="op" id="1495096">-</span><span class="ident" id="1495097">t0</span><span class="op" id="1495099">,</span>&nbsp;<span class="num" id="1495101">2</span><span class="op" id="1495102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495108">return</span>&nbsp;<span class="builtintype" id="1495115">true</span><br>
<span class="lineno">255</span><span class="op" id="1495120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1495123">func</span>&nbsp;<span class="ident" id="1495128">closechan</span><span class="op" id="1495137">(</span><span class="ident" id="1495138">c</span>&nbsp;<span class="op" id="1495140">*</span><span class="ident" id="1495141">hchan</span><span class="op" id="1495146">)</span>&nbsp;<span class="op" id="1495148">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495151">if</span>&nbsp;<span class="ident" id="1495154">c</span>&nbsp;<span class="op" id="1495156">==</span>&nbsp;<span class="ident" id="1495159">nil</span>&nbsp;<span class="op" id="1495163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1495167">panic</span><span class="op" id="1495172">(</span><span class="string" id="1495173">&#34;close&nbsp;of&nbsp;nil&nbsp;channel&#34;</span><span class="op" id="1495195">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495202">lock</span><span class="op" id="1495206">(</span><span class="op" id="1495207">&amp;</span><span class="ident" id="1495208">c</span><span class="op" id="1495209">.</span><span class="ident" id="1495210">lock</span><span class="op" id="1495214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495217">if</span>&nbsp;<span class="ident" id="1495220">c</span><span class="op" id="1495221">.</span><span class="ident" id="1495222">closed</span>&nbsp;<span class="op" id="1495229">!=</span>&nbsp;<span class="num" id="1495232">0</span>&nbsp;<span class="op" id="1495234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495238">unlock</span><span class="op" id="1495244">(</span><span class="op" id="1495245">&amp;</span><span class="ident" id="1495246">c</span><span class="op" id="1495247">.</span><span class="ident" id="1495248">lock</span><span class="op" id="1495252">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1495256">panic</span><span class="op" id="1495261">(</span><span class="string" id="1495262">&#34;close&nbsp;of&nbsp;closed&nbsp;channel&#34;</span><span class="op" id="1495287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495294">if</span>&nbsp;<span class="ident" id="1495297">raceenabled</span>&nbsp;<span class="op" id="1495309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495313">callerpc</span>&nbsp;<span class="op" id="1495322">:=</span>&nbsp;<span class="ident" id="1495325">getcallerpc</span><span class="op" id="1495336">(</span><span class="ident" id="1495337">unsafe</span><span class="op" id="1495343">.</span><span class="ident" id="1495344">Pointer</span><span class="op" id="1495351">(</span><span class="op" id="1495352">&amp;</span><span class="ident" id="1495353">c</span><span class="op" id="1495354">)</span><span class="op" id="1495355">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495359">racewritepc</span><span class="op" id="1495370">(</span><span class="ident" id="1495371">unsafe</span><span class="op" id="1495377">.</span><span class="ident" id="1495378">Pointer</span><span class="op" id="1495385">(</span><span class="ident" id="1495386">c</span><span class="op" id="1495387">)</span><span class="op" id="1495388">,</span>&nbsp;<span class="ident" id="1495390">callerpc</span><span class="op" id="1495398">,</span>&nbsp;<span class="ident" id="1495400">funcPC</span><span class="op" id="1495406">(</span><span class="ident" id="1495407">closechan</span><span class="op" id="1495416">)</span><span class="op" id="1495417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495421">racerelease</span><span class="op" id="1495432">(</span><span class="ident" id="1495433">unsafe</span><span class="op" id="1495439">.</span><span class="ident" id="1495440">Pointer</span><span class="op" id="1495447">(</span><span class="ident" id="1495448">c</span><span class="op" id="1495449">)</span><span class="op" id="1495450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495457">c</span><span class="op" id="1495458">.</span><span class="ident" id="1495459">closed</span>&nbsp;<span class="op" id="1495466">=</span>&nbsp;<span class="num" id="1495468">1</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495472">//&nbsp;release&nbsp;all&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495496">for</span>&nbsp;<span class="op" id="1495500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495504">sg</span>&nbsp;<span class="op" id="1495507">:=</span>&nbsp;<span class="ident" id="1495510">c</span><span class="op" id="1495511">.</span><span class="ident" id="1495512">recvq</span><span class="op" id="1495517">.</span><span class="ident" id="1495518">dequeue</span><span class="op" id="1495525">(</span><span class="op" id="1495526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495530">if</span>&nbsp;<span class="ident" id="1495533">sg</span>&nbsp;<span class="op" id="1495536">==</span>&nbsp;<span class="ident" id="1495539">nil</span>&nbsp;<span class="op" id="1495543">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495548">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495560">gp</span>&nbsp;<span class="op" id="1495563">:=</span>&nbsp;<span class="ident" id="1495566">sg</span><span class="op" id="1495568">.</span><span class="ident" id="1495569">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495573">sg</span><span class="op" id="1495575">.</span><span class="ident" id="1495576">elem</span>&nbsp;<span class="op" id="1495581">=</span>&nbsp;<span class="ident" id="1495583">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495589">gp</span><span class="op" id="1495591">.</span><span class="ident" id="1495592">param</span>&nbsp;<span class="op" id="1495598">=</span>&nbsp;<span class="ident" id="1495600">nil</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495606">if</span>&nbsp;<span class="ident" id="1495609">sg</span><span class="op" id="1495611">.</span><span class="ident" id="1495612">releasetime</span>&nbsp;<span class="op" id="1495624">!=</span>&nbsp;<span class="num" id="1495627">0</span>&nbsp;<span class="op" id="1495629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495634">sg</span><span class="op" id="1495636">.</span><span class="ident" id="1495637">releasetime</span>&nbsp;<span class="op" id="1495649">=</span>&nbsp;<span class="ident" id="1495651">cputicks</span><span class="op" id="1495659">(</span><span class="op" id="1495660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495668">goready</span><span class="op" id="1495675">(</span><span class="ident" id="1495676">gp</span><span class="op" id="1495678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495681">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1495685">//&nbsp;release&nbsp;all&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495709">for</span>&nbsp;<span class="op" id="1495713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495717">sg</span>&nbsp;<span class="op" id="1495720">:=</span>&nbsp;<span class="ident" id="1495723">c</span><span class="op" id="1495724">.</span><span class="ident" id="1495725">sendq</span><span class="op" id="1495730">.</span><span class="ident" id="1495731">dequeue</span><span class="op" id="1495738">(</span><span class="op" id="1495739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495743">if</span>&nbsp;<span class="ident" id="1495746">sg</span>&nbsp;<span class="op" id="1495749">==</span>&nbsp;<span class="ident" id="1495752">nil</span>&nbsp;<span class="op" id="1495756">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495761">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495773">gp</span>&nbsp;<span class="op" id="1495776">:=</span>&nbsp;<span class="ident" id="1495779">sg</span><span class="op" id="1495781">.</span><span class="ident" id="1495782">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495786">sg</span><span class="op" id="1495788">.</span><span class="ident" id="1495789">elem</span>&nbsp;<span class="op" id="1495794">=</span>&nbsp;<span class="ident" id="1495796">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495802">gp</span><span class="op" id="1495804">.</span><span class="ident" id="1495805">param</span>&nbsp;<span class="op" id="1495811">=</span>&nbsp;<span class="ident" id="1495813">nil</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1495819">if</span>&nbsp;<span class="ident" id="1495822">sg</span><span class="op" id="1495824">.</span><span class="ident" id="1495825">releasetime</span>&nbsp;<span class="op" id="1495837">!=</span>&nbsp;<span class="num" id="1495840">0</span>&nbsp;<span class="op" id="1495842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495847">sg</span><span class="op" id="1495849">.</span><span class="ident" id="1495850">releasetime</span>&nbsp;<span class="op" id="1495862">=</span>&nbsp;<span class="ident" id="1495864">cputicks</span><span class="op" id="1495872">(</span><span class="op" id="1495873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495881">goready</span><span class="op" id="1495888">(</span><span class="ident" id="1495889">gp</span><span class="op" id="1495891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1495894">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1495897">unlock</span><span class="op" id="1495903">(</span><span class="op" id="1495904">&amp;</span><span class="ident" id="1495905">c</span><span class="op" id="1495906">.</span><span class="ident" id="1495907">lock</span><span class="op" id="1495911">)</span><br>
<span class="lineno"></span><span class="op" id="1495913">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1495916">//&nbsp;entry&nbsp;points&nbsp;for&nbsp;&lt;-&nbsp;c&nbsp;from&nbsp;compiled&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="1495960">//go:nosplit</span><br>
<span class="lineno">310</span><span class="keyword" id="1495973">func</span>&nbsp;<span class="ident" id="1495978">chanrecv1</span><span class="op" id="1495987">(</span><span class="ident" id="1495988">t</span>&nbsp;<span class="op" id="1495990">*</span><span class="ident" id="1495991">chantype</span><span class="op" id="1495999">,</span>&nbsp;<span class="ident" id="1496001">c</span>&nbsp;<span class="op" id="1496003">*</span><span class="ident" id="1496004">hchan</span><span class="op" id="1496009">,</span>&nbsp;<span class="ident" id="1496011">elem</span>&nbsp;<span class="ident" id="1496016">unsafe</span><span class="op" id="1496022">.</span><span class="ident" id="1496023">Pointer</span><span class="op" id="1496030">)</span>&nbsp;<span class="op" id="1496032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496035">chanrecv</span><span class="op" id="1496043">(</span><span class="ident" id="1496044">t</span><span class="op" id="1496045">,</span>&nbsp;<span class="ident" id="1496047">c</span><span class="op" id="1496048">,</span>&nbsp;<span class="ident" id="1496050">elem</span><span class="op" id="1496054">,</span>&nbsp;<span class="builtintype" id="1496056">true</span><span class="op" id="1496060">)</span><br>
<span class="lineno"></span><span class="op" id="1496062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1496065">//go:nosplit</span><br>
<span class="lineno">315</span><span class="keyword" id="1496078">func</span>&nbsp;<span class="ident" id="1496083">chanrecv2</span><span class="op" id="1496092">(</span><span class="ident" id="1496093">t</span>&nbsp;<span class="op" id="1496095">*</span><span class="ident" id="1496096">chantype</span><span class="op" id="1496104">,</span>&nbsp;<span class="ident" id="1496106">c</span>&nbsp;<span class="op" id="1496108">*</span><span class="ident" id="1496109">hchan</span><span class="op" id="1496114">,</span>&nbsp;<span class="ident" id="1496116">elem</span>&nbsp;<span class="ident" id="1496121">unsafe</span><span class="op" id="1496127">.</span><span class="ident" id="1496128">Pointer</span><span class="op" id="1496135">)</span>&nbsp;<span class="op" id="1496137">(</span><span class="ident" id="1496138">received</span>&nbsp;<span class="builtintype" id="1496147">bool</span><span class="op" id="1496151">)</span>&nbsp;<span class="op" id="1496153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496156">_</span><span class="op" id="1496157">,</span>&nbsp;<span class="ident" id="1496159">received</span>&nbsp;<span class="op" id="1496168">=</span>&nbsp;<span class="ident" id="1496170">chanrecv</span><span class="op" id="1496178">(</span><span class="ident" id="1496179">t</span><span class="op" id="1496180">,</span>&nbsp;<span class="ident" id="1496182">c</span><span class="op" id="1496183">,</span>&nbsp;<span class="ident" id="1496185">elem</span><span class="op" id="1496189">,</span>&nbsp;<span class="builtintype" id="1496191">true</span><span class="op" id="1496195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496198">return</span><br>
<span class="lineno"></span><span class="op" id="1496205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">320</span><span class="comment" id="1496208">//&nbsp;chanrecv&nbsp;receives&nbsp;on&nbsp;channel&nbsp;c&nbsp;and&nbsp;writes&nbsp;the&nbsp;received&nbsp;data&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span><span class="comment" id="1496278">//&nbsp;ep&nbsp;may&nbsp;be&nbsp;nil,&nbsp;in&nbsp;which&nbsp;case&nbsp;received&nbsp;data&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1496336">//&nbsp;If&nbsp;block&nbsp;==&nbsp;false&nbsp;and&nbsp;no&nbsp;elements&nbsp;are&nbsp;available,&nbsp;returns&nbsp;(false,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1496412">//&nbsp;Otherwise,&nbsp;if&nbsp;c&nbsp;is&nbsp;closed,&nbsp;zeros&nbsp;*ep&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;false).</span><br>
<span class="lineno"></span><span class="comment" id="1496479">//&nbsp;Otherwise,&nbsp;fills&nbsp;in&nbsp;*ep&nbsp;with&nbsp;an&nbsp;element&nbsp;and&nbsp;returns&nbsp;(true,&nbsp;true).</span><br>
<span class="lineno">325</span><span class="keyword" id="1496548">func</span>&nbsp;<span class="ident" id="1496553">chanrecv</span><span class="op" id="1496561">(</span><span class="ident" id="1496562">t</span>&nbsp;<span class="op" id="1496564">*</span><span class="ident" id="1496565">chantype</span><span class="op" id="1496573">,</span>&nbsp;<span class="ident" id="1496575">c</span>&nbsp;<span class="op" id="1496577">*</span><span class="ident" id="1496578">hchan</span><span class="op" id="1496583">,</span>&nbsp;<span class="ident" id="1496585">ep</span>&nbsp;<span class="ident" id="1496588">unsafe</span><span class="op" id="1496594">.</span><span class="ident" id="1496595">Pointer</span><span class="op" id="1496602">,</span>&nbsp;<span class="ident" id="1496604">block</span>&nbsp;<span class="builtintype" id="1496610">bool</span><span class="op" id="1496614">)</span>&nbsp;<span class="op" id="1496616">(</span><span class="ident" id="1496617">selected</span><span class="op" id="1496625">,</span>&nbsp;<span class="ident" id="1496627">received</span>&nbsp;<span class="builtintype" id="1496636">bool</span><span class="op" id="1496640">)</span>&nbsp;<span class="op" id="1496642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496645">//&nbsp;raceenabled:&nbsp;don&#39;t&nbsp;need&nbsp;to&nbsp;check&nbsp;ep,&nbsp;as&nbsp;it&nbsp;is&nbsp;always&nbsp;on&nbsp;the&nbsp;stack.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496717">if</span>&nbsp;<span class="ident" id="1496720">debugChan</span>&nbsp;<span class="op" id="1496730">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1496734">print</span><span class="op" id="1496739">(</span><span class="string" id="1496740">&#34;chanrecv:&nbsp;chan=&#34;</span><span class="op" id="1496757">,</span>&nbsp;<span class="ident" id="1496759">c</span><span class="op" id="1496760">,</span>&nbsp;<span class="string" id="1496762">&#34;\n&#34;</span><span class="op" id="1496766">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496773">if</span>&nbsp;<span class="ident" id="1496776">c</span>&nbsp;<span class="op" id="1496778">==</span>&nbsp;<span class="ident" id="1496781">nil</span>&nbsp;<span class="op" id="1496785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496789">if</span>&nbsp;<span class="op" id="1496792">!</span><span class="ident" id="1496793">block</span>&nbsp;<span class="op" id="1496799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1496804">return</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496817">gopark</span><span class="op" id="1496823">(</span><span class="ident" id="1496824">nil</span><span class="op" id="1496827">,</span>&nbsp;<span class="ident" id="1496829">nil</span><span class="op" id="1496832">,</span>&nbsp;<span class="string" id="1496834">&#34;chan&nbsp;receive&nbsp;(nil&nbsp;chan)&#34;</span><span class="op" id="1496859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1496863">gothrow</span><span class="op" id="1496870">(</span><span class="string" id="1496871">&#34;unreachable&#34;</span><span class="op" id="1496884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1496887">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496891">//&nbsp;Fast&nbsp;path:&nbsp;check&nbsp;for&nbsp;failed&nbsp;non-blocking&nbsp;operation&nbsp;without&nbsp;acquiring&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496974">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1496978">//&nbsp;After&nbsp;observing&nbsp;that&nbsp;the&nbsp;channel&nbsp;is&nbsp;not&nbsp;ready&nbsp;for&nbsp;receiving,&nbsp;we&nbsp;observe&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497063">//&nbsp;channel&nbsp;is&nbsp;not&nbsp;closed.&nbsp;Each&nbsp;of&nbsp;these&nbsp;observations&nbsp;is&nbsp;a&nbsp;single&nbsp;word-sized&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497145">//&nbsp;(first&nbsp;c.sendq.first&nbsp;or&nbsp;c.qcount,&nbsp;and&nbsp;second&nbsp;c.closed).</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497205">//&nbsp;Because&nbsp;a&nbsp;channel&nbsp;cannot&nbsp;be&nbsp;reopened,&nbsp;the&nbsp;later&nbsp;observation&nbsp;of&nbsp;the&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497284">//&nbsp;being&nbsp;not&nbsp;closed&nbsp;implies&nbsp;that&nbsp;it&nbsp;was&nbsp;also&nbsp;not&nbsp;closed&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497362">//&nbsp;first&nbsp;observation.&nbsp;We&nbsp;behave&nbsp;as&nbsp;if&nbsp;we&nbsp;observed&nbsp;the&nbsp;channel&nbsp;at&nbsp;that&nbsp;moment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497440">//&nbsp;and&nbsp;report&nbsp;that&nbsp;the&nbsp;receive&nbsp;cannot&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497488">//</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497492">//&nbsp;The&nbsp;order&nbsp;of&nbsp;operations&nbsp;is&nbsp;important&nbsp;here:&nbsp;reversing&nbsp;the&nbsp;operations&nbsp;can&nbsp;lead&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1497576">//&nbsp;incorrect&nbsp;behavior&nbsp;when&nbsp;racing&nbsp;with&nbsp;a&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497625">if</span>&nbsp;<span class="op" id="1497628">!</span><span class="ident" id="1497629">block</span>&nbsp;<span class="op" id="1497635">&amp;&amp;</span>&nbsp;<span class="op" id="1497638">(</span><span class="ident" id="1497639">c</span><span class="op" id="1497640">.</span><span class="ident" id="1497641">dataqsiz</span>&nbsp;<span class="op" id="1497650">==</span>&nbsp;<span class="num" id="1497653">0</span>&nbsp;<span class="op" id="1497655">&amp;&amp;</span>&nbsp;<span class="ident" id="1497658">c</span><span class="op" id="1497659">.</span><span class="ident" id="1497660">sendq</span><span class="op" id="1497665">.</span><span class="ident" id="1497666">first</span>&nbsp;<span class="op" id="1497672">==</span>&nbsp;<span class="ident" id="1497675">nil</span>&nbsp;<span class="op" id="1497679">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497684">c</span><span class="op" id="1497685">.</span><span class="ident" id="1497686">dataqsiz</span>&nbsp;<span class="op" id="1497695">&gt;</span>&nbsp;<span class="num" id="1497697">0</span>&nbsp;<span class="op" id="1497699">&amp;&amp;</span>&nbsp;<span class="ident" id="1497702">atomicloaduint</span><span class="op" id="1497716">(</span><span class="op" id="1497717">&amp;</span><span class="ident" id="1497718">c</span><span class="op" id="1497719">.</span><span class="ident" id="1497720">qcount</span><span class="op" id="1497726">)</span>&nbsp;<span class="op" id="1497728">==</span>&nbsp;<span class="num" id="1497731">0</span><span class="op" id="1497732">)</span>&nbsp;<span class="op" id="1497734">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497739">atomicload</span><span class="op" id="1497749">(</span><span class="op" id="1497750">&amp;</span><span class="ident" id="1497751">c</span><span class="op" id="1497752">.</span><span class="ident" id="1497753">closed</span><span class="op" id="1497759">)</span>&nbsp;<span class="op" id="1497761">==</span>&nbsp;<span class="num" id="1497764">0</span>&nbsp;<span class="op" id="1497766">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497770">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497782">var</span>&nbsp;<span class="ident" id="1497786">t0</span>&nbsp;<span class="ident" id="1497789">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497796">if</span>&nbsp;<span class="ident" id="1497799">blockprofilerate</span>&nbsp;<span class="op" id="1497816">&gt;</span>&nbsp;<span class="num" id="1497818">0</span>&nbsp;<span class="op" id="1497820">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497824">t0</span>&nbsp;<span class="op" id="1497827">=</span>&nbsp;<span class="ident" id="1497829">cputicks</span><span class="op" id="1497837">(</span><span class="op" id="1497838">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497845">lock</span><span class="op" id="1497849">(</span><span class="op" id="1497850">&amp;</span><span class="ident" id="1497851">c</span><span class="op" id="1497852">.</span><span class="ident" id="1497853">lock</span><span class="op" id="1497857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497860">if</span>&nbsp;<span class="ident" id="1497863">c</span><span class="op" id="1497864">.</span><span class="ident" id="1497865">dataqsiz</span>&nbsp;<span class="op" id="1497874">==</span>&nbsp;<span class="num" id="1497877">0</span>&nbsp;<span class="op" id="1497879">{</span>&nbsp;<span class="comment" id="1497881">//&nbsp;synchronous&nbsp;channel</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497906">if</span>&nbsp;<span class="ident" id="1497909">c</span><span class="op" id="1497910">.</span><span class="ident" id="1497911">closed</span>&nbsp;<span class="op" id="1497918">!=</span>&nbsp;<span class="num" id="1497921">0</span>&nbsp;<span class="op" id="1497923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497928">return</span>&nbsp;<span class="ident" id="1497935">recvclosed</span><span class="op" id="1497945">(</span><span class="ident" id="1497946">c</span><span class="op" id="1497947">,</span>&nbsp;<span class="ident" id="1497949">ep</span><span class="op" id="1497951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1497955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1497960">sg</span>&nbsp;<span class="op" id="1497963">:=</span>&nbsp;<span class="ident" id="1497966">c</span><span class="op" id="1497967">.</span><span class="ident" id="1497968">sendq</span><span class="op" id="1497973">.</span><span class="ident" id="1497974">dequeue</span><span class="op" id="1497981">(</span><span class="op" id="1497982">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1497986">if</span>&nbsp;<span class="ident" id="1497989">sg</span>&nbsp;<span class="op" id="1497992">!=</span>&nbsp;<span class="ident" id="1497995">nil</span>&nbsp;<span class="op" id="1497999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498004">if</span>&nbsp;<span class="ident" id="1498007">raceenabled</span>&nbsp;<span class="op" id="1498019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498025">racesync</span><span class="op" id="1498033">(</span><span class="ident" id="1498034">c</span><span class="op" id="1498035">,</span>&nbsp;<span class="ident" id="1498037">sg</span><span class="op" id="1498039">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498044">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498049">unlock</span><span class="op" id="1498055">(</span><span class="op" id="1498056">&amp;</span><span class="ident" id="1498057">c</span><span class="op" id="1498058">.</span><span class="ident" id="1498059">lock</span><span class="op" id="1498063">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498069">if</span>&nbsp;<span class="ident" id="1498072">ep</span>&nbsp;<span class="op" id="1498075">!=</span>&nbsp;<span class="ident" id="1498078">nil</span>&nbsp;<span class="op" id="1498082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498088">memmove</span><span class="op" id="1498095">(</span><span class="ident" id="1498096">ep</span><span class="op" id="1498098">,</span>&nbsp;<span class="ident" id="1498100">sg</span><span class="op" id="1498102">.</span><span class="ident" id="1498103">elem</span><span class="op" id="1498107">,</span>&nbsp;<span class="builtintype" id="1498109">uintptr</span><span class="op" id="1498116">(</span><span class="ident" id="1498117">c</span><span class="op" id="1498118">.</span><span class="ident" id="1498119">elemsize</span><span class="op" id="1498127">)</span><span class="op" id="1498128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498133">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498138">sg</span><span class="op" id="1498140">.</span><span class="ident" id="1498141">elem</span>&nbsp;<span class="op" id="1498146">=</span>&nbsp;<span class="ident" id="1498148">nil</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498155">gp</span>&nbsp;<span class="op" id="1498158">:=</span>&nbsp;<span class="ident" id="1498161">sg</span><span class="op" id="1498163">.</span><span class="ident" id="1498164">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498169">gp</span><span class="op" id="1498171">.</span><span class="ident" id="1498172">param</span>&nbsp;<span class="op" id="1498178">=</span>&nbsp;<span class="ident" id="1498180">unsafe</span><span class="op" id="1498186">.</span><span class="ident" id="1498187">Pointer</span><span class="op" id="1498194">(</span><span class="ident" id="1498195">sg</span><span class="op" id="1498197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498202">if</span>&nbsp;<span class="ident" id="1498205">sg</span><span class="op" id="1498207">.</span><span class="ident" id="1498208">releasetime</span>&nbsp;<span class="op" id="1498220">!=</span>&nbsp;<span class="num" id="1498223">0</span>&nbsp;<span class="op" id="1498225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498231">sg</span><span class="op" id="1498233">.</span><span class="ident" id="1498234">releasetime</span>&nbsp;<span class="op" id="1498246">=</span>&nbsp;<span class="ident" id="1498248">cputicks</span><span class="op" id="1498256">(</span><span class="op" id="1498257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498262">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498267">goready</span><span class="op" id="1498274">(</span><span class="ident" id="1498275">gp</span><span class="op" id="1498277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498282">selected</span>&nbsp;<span class="op" id="1498291">=</span>&nbsp;<span class="builtintype" id="1498293">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498301">received</span>&nbsp;<span class="op" id="1498310">=</span>&nbsp;<span class="builtintype" id="1498312">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498320">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498329">}</span><br>
<span class="lineno">390</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498334">if</span>&nbsp;<span class="op" id="1498337">!</span><span class="ident" id="1498338">block</span>&nbsp;<span class="op" id="1498344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498349">unlock</span><span class="op" id="1498355">(</span><span class="op" id="1498356">&amp;</span><span class="ident" id="1498357">c</span><span class="op" id="1498358">.</span><span class="ident" id="1498359">lock</span><span class="op" id="1498363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498368">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498377">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498382">//&nbsp;no&nbsp;sender&nbsp;available:&nbsp;block&nbsp;on&nbsp;this&nbsp;channel.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498431">gp</span>&nbsp;<span class="op" id="1498434">:=</span>&nbsp;<span class="ident" id="1498437">getg</span><span class="op" id="1498441">(</span><span class="op" id="1498442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498446">mysg</span>&nbsp;<span class="op" id="1498451">:=</span>&nbsp;<span class="ident" id="1498454">acquireSudog</span><span class="op" id="1498466">(</span><span class="op" id="1498467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498471">mysg</span><span class="op" id="1498475">.</span><span class="ident" id="1498476">releasetime</span>&nbsp;<span class="op" id="1498488">=</span>&nbsp;<span class="num" id="1498490">0</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498494">if</span>&nbsp;<span class="ident" id="1498497">t0</span>&nbsp;<span class="op" id="1498500">!=</span>&nbsp;<span class="num" id="1498503">0</span>&nbsp;<span class="op" id="1498505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498510">mysg</span><span class="op" id="1498514">.</span><span class="ident" id="1498515">releasetime</span>&nbsp;<span class="op" id="1498527">=</span>&nbsp;<span class="op" id="1498529">-</span><span class="num" id="1498530">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498534">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498538">mysg</span><span class="op" id="1498542">.</span><span class="ident" id="1498543">elem</span>&nbsp;<span class="op" id="1498548">=</span>&nbsp;<span class="ident" id="1498550">ep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498555">mysg</span><span class="op" id="1498559">.</span><span class="ident" id="1498560">waitlink</span>&nbsp;<span class="op" id="1498569">=</span>&nbsp;<span class="ident" id="1498571">nil</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498577">gp</span><span class="op" id="1498579">.</span><span class="ident" id="1498580">waiting</span>&nbsp;<span class="op" id="1498588">=</span>&nbsp;<span class="ident" id="1498590">mysg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498597">mysg</span><span class="op" id="1498601">.</span><span class="ident" id="1498602">g</span>&nbsp;<span class="op" id="1498604">=</span>&nbsp;<span class="ident" id="1498606">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498611">mysg</span><span class="op" id="1498615">.</span><span class="ident" id="1498616">selectdone</span>&nbsp;<span class="op" id="1498627">=</span>&nbsp;<span class="ident" id="1498629">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498635">gp</span><span class="op" id="1498637">.</span><span class="ident" id="1498638">param</span>&nbsp;<span class="op" id="1498644">=</span>&nbsp;<span class="ident" id="1498646">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498652">c</span><span class="op" id="1498653">.</span><span class="ident" id="1498654">recvq</span><span class="op" id="1498659">.</span><span class="ident" id="1498660">enqueue</span><span class="op" id="1498667">(</span><span class="ident" id="1498668">mysg</span><span class="op" id="1498672">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498676">goparkunlock</span><span class="op" id="1498688">(</span><span class="op" id="1498689">&amp;</span><span class="ident" id="1498690">c</span><span class="op" id="1498691">.</span><span class="ident" id="1498692">lock</span><span class="op" id="1498696">,</span>&nbsp;<span class="string" id="1498698">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1498712">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498717">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498741">if</span>&nbsp;<span class="ident" id="1498744">mysg</span>&nbsp;<span class="op" id="1498749">!=</span>&nbsp;<span class="ident" id="1498752">gp</span><span class="op" id="1498754">.</span><span class="ident" id="1498755">waiting</span>&nbsp;<span class="op" id="1498763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498768">gothrow</span><span class="op" id="1498775">(</span><span class="string" id="1498776">&#34;G&nbsp;waiting&nbsp;list&nbsp;is&nbsp;corrupted!&#34;</span><span class="op" id="1498806">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498810">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498814">gp</span><span class="op" id="1498816">.</span><span class="ident" id="1498817">waiting</span>&nbsp;<span class="op" id="1498825">=</span>&nbsp;<span class="ident" id="1498827">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498833">if</span>&nbsp;<span class="ident" id="1498836">mysg</span><span class="op" id="1498840">.</span><span class="ident" id="1498841">releasetime</span>&nbsp;<span class="op" id="1498853">&gt;</span>&nbsp;<span class="num" id="1498855">0</span>&nbsp;<span class="op" id="1498857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498862">blockevent</span><span class="op" id="1498872">(</span><span class="ident" id="1498873">mysg</span><span class="op" id="1498877">.</span><span class="ident" id="1498878">releasetime</span><span class="op" id="1498889">-</span><span class="ident" id="1498890">t0</span><span class="op" id="1498892">,</span>&nbsp;<span class="num" id="1498894">2</span><span class="op" id="1498895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1498899">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498903">haveData</span>&nbsp;<span class="op" id="1498912">:=</span>&nbsp;<span class="ident" id="1498915">gp</span><span class="op" id="1498917">.</span><span class="ident" id="1498918">param</span>&nbsp;<span class="op" id="1498924">!=</span>&nbsp;<span class="ident" id="1498927">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498933">gp</span><span class="op" id="1498935">.</span><span class="ident" id="1498936">param</span>&nbsp;<span class="op" id="1498942">=</span>&nbsp;<span class="ident" id="1498944">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1498950">releaseSudog</span><span class="op" id="1498962">(</span><span class="ident" id="1498963">mysg</span><span class="op" id="1498967">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1498972">if</span>&nbsp;<span class="ident" id="1498975">haveData</span>&nbsp;<span class="op" id="1498984">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1498989">//&nbsp;a&nbsp;sender&nbsp;sent&nbsp;us&nbsp;some&nbsp;data.&nbsp;It&nbsp;already&nbsp;wrote&nbsp;to&nbsp;ep.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499047">selected</span>&nbsp;<span class="op" id="1499056">=</span>&nbsp;<span class="builtintype" id="1499058">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499066">received</span>&nbsp;<span class="op" id="1499075">=</span>&nbsp;<span class="builtintype" id="1499077">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499085">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499094">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499099">lock</span><span class="op" id="1499103">(</span><span class="op" id="1499104">&amp;</span><span class="ident" id="1499105">c</span><span class="op" id="1499106">.</span><span class="ident" id="1499107">lock</span><span class="op" id="1499111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499115">if</span>&nbsp;<span class="ident" id="1499118">c</span><span class="op" id="1499119">.</span><span class="ident" id="1499120">closed</span>&nbsp;<span class="op" id="1499127">==</span>&nbsp;<span class="num" id="1499130">0</span>&nbsp;<span class="op" id="1499132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499137">gothrow</span><span class="op" id="1499144">(</span><span class="string" id="1499145">&#34;chanrecv:&nbsp;spurious&nbsp;wakeup&#34;</span><span class="op" id="1499172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499176">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499180">return</span>&nbsp;<span class="ident" id="1499187">recvclosed</span><span class="op" id="1499197">(</span><span class="ident" id="1499198">c</span><span class="op" id="1499199">,</span>&nbsp;<span class="ident" id="1499201">ep</span><span class="op" id="1499203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499210">//&nbsp;asynchronous&nbsp;channel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499235">//&nbsp;wait&nbsp;for&nbsp;some&nbsp;data&nbsp;to&nbsp;appear</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499268">var</span>&nbsp;<span class="ident" id="1499272">t1</span>&nbsp;<span class="ident" id="1499275">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499282">for</span>&nbsp;<span class="ident" id="1499286">c</span><span class="op" id="1499287">.</span><span class="ident" id="1499288">qcount</span>&nbsp;<span class="op" id="1499295">&lt;=</span>&nbsp;<span class="num" id="1499298">0</span>&nbsp;<span class="op" id="1499300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499304">if</span>&nbsp;<span class="ident" id="1499307">c</span><span class="op" id="1499308">.</span><span class="ident" id="1499309">closed</span>&nbsp;<span class="op" id="1499316">!=</span>&nbsp;<span class="num" id="1499319">0</span>&nbsp;<span class="op" id="1499321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499326">selected</span><span class="op" id="1499334">,</span>&nbsp;<span class="ident" id="1499336">received</span>&nbsp;<span class="op" id="1499345">=</span>&nbsp;<span class="ident" id="1499347">recvclosed</span><span class="op" id="1499357">(</span><span class="ident" id="1499358">c</span><span class="op" id="1499359">,</span>&nbsp;<span class="ident" id="1499361">ep</span><span class="op" id="1499363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499368">if</span>&nbsp;<span class="ident" id="1499371">t1</span>&nbsp;<span class="op" id="1499374">&gt;</span>&nbsp;<span class="num" id="1499376">0</span>&nbsp;<span class="op" id="1499378">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499384">blockevent</span><span class="op" id="1499394">(</span><span class="ident" id="1499395">t1</span><span class="op" id="1499397">-</span><span class="ident" id="1499398">t0</span><span class="op" id="1499400">,</span>&nbsp;<span class="num" id="1499402">2</span><span class="op" id="1499403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499413">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499427">if</span>&nbsp;<span class="op" id="1499430">!</span><span class="ident" id="1499431">block</span>&nbsp;<span class="op" id="1499437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499442">unlock</span><span class="op" id="1499448">(</span><span class="op" id="1499449">&amp;</span><span class="ident" id="1499450">c</span><span class="op" id="1499451">.</span><span class="ident" id="1499452">lock</span><span class="op" id="1499456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499461">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499475">//&nbsp;wait&nbsp;for&nbsp;someone&nbsp;to&nbsp;send&nbsp;an&nbsp;element</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499516">gp</span>&nbsp;<span class="op" id="1499519">:=</span>&nbsp;<span class="ident" id="1499522">getg</span><span class="op" id="1499526">(</span><span class="op" id="1499527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499531">mysg</span>&nbsp;<span class="op" id="1499536">:=</span>&nbsp;<span class="ident" id="1499539">acquireSudog</span><span class="op" id="1499551">(</span><span class="op" id="1499552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499556">mysg</span><span class="op" id="1499560">.</span><span class="ident" id="1499561">releasetime</span>&nbsp;<span class="op" id="1499573">=</span>&nbsp;<span class="num" id="1499575">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499579">if</span>&nbsp;<span class="ident" id="1499582">t0</span>&nbsp;<span class="op" id="1499585">!=</span>&nbsp;<span class="num" id="1499588">0</span>&nbsp;<span class="op" id="1499590">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499595">mysg</span><span class="op" id="1499599">.</span><span class="ident" id="1499600">releasetime</span>&nbsp;<span class="op" id="1499612">=</span>&nbsp;<span class="op" id="1499614">-</span><span class="num" id="1499615">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499623">mysg</span><span class="op" id="1499627">.</span><span class="ident" id="1499628">elem</span>&nbsp;<span class="op" id="1499633">=</span>&nbsp;<span class="ident" id="1499635">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499641">mysg</span><span class="op" id="1499645">.</span><span class="ident" id="1499646">g</span>&nbsp;<span class="op" id="1499648">=</span>&nbsp;<span class="ident" id="1499650">gp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499655">mysg</span><span class="op" id="1499659">.</span><span class="ident" id="1499660">selectdone</span>&nbsp;<span class="op" id="1499671">=</span>&nbsp;<span class="ident" id="1499673">nil</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499680">c</span><span class="op" id="1499681">.</span><span class="ident" id="1499682">recvq</span><span class="op" id="1499687">.</span><span class="ident" id="1499688">enqueue</span><span class="op" id="1499695">(</span><span class="ident" id="1499696">mysg</span><span class="op" id="1499700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499704">goparkunlock</span><span class="op" id="1499716">(</span><span class="op" id="1499717">&amp;</span><span class="ident" id="1499718">c</span><span class="op" id="1499719">.</span><span class="ident" id="1499720">lock</span><span class="op" id="1499724">,</span>&nbsp;<span class="string" id="1499726">&#34;chan&nbsp;receive&#34;</span><span class="op" id="1499740">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1499745">//&nbsp;someone&nbsp;woke&nbsp;us&nbsp;up&nbsp;-&nbsp;try&nbsp;again</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499781">if</span>&nbsp;<span class="ident" id="1499784">mysg</span><span class="op" id="1499788">.</span><span class="ident" id="1499789">releasetime</span>&nbsp;<span class="op" id="1499801">&gt;</span>&nbsp;<span class="num" id="1499803">0</span>&nbsp;<span class="op" id="1499805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499810">t1</span>&nbsp;<span class="op" id="1499813">=</span>&nbsp;<span class="ident" id="1499815">mysg</span><span class="op" id="1499819">.</span><span class="ident" id="1499820">releasetime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499838">releaseSudog</span><span class="op" id="1499850">(</span><span class="ident" id="1499851">mysg</span><span class="op" id="1499855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499859">lock</span><span class="op" id="1499863">(</span><span class="op" id="1499864">&amp;</span><span class="ident" id="1499865">c</span><span class="op" id="1499866">.</span><span class="ident" id="1499867">lock</span><span class="op" id="1499871">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499874">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499878">if</span>&nbsp;<span class="ident" id="1499881">raceenabled</span>&nbsp;<span class="op" id="1499893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499897">raceacquire</span><span class="op" id="1499908">(</span><span class="ident" id="1499909">chanbuf</span><span class="op" id="1499916">(</span><span class="ident" id="1499917">c</span><span class="op" id="1499918">,</span>&nbsp;<span class="ident" id="1499920">c</span><span class="op" id="1499921">.</span><span class="ident" id="1499922">recvx</span><span class="op" id="1499927">)</span><span class="op" id="1499928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499932">racerelease</span><span class="op" id="1499943">(</span><span class="ident" id="1499944">chanbuf</span><span class="op" id="1499951">(</span><span class="ident" id="1499952">c</span><span class="op" id="1499953">,</span>&nbsp;<span class="ident" id="1499955">c</span><span class="op" id="1499956">.</span><span class="ident" id="1499957">recvx</span><span class="op" id="1499962">)</span><span class="op" id="1499963">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1499966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1499969">if</span>&nbsp;<span class="ident" id="1499972">ep</span>&nbsp;<span class="op" id="1499975">!=</span>&nbsp;<span class="ident" id="1499978">nil</span>&nbsp;<span class="op" id="1499982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1499986">memmove</span><span class="op" id="1499993">(</span><span class="ident" id="1499994">ep</span><span class="op" id="1499996">,</span>&nbsp;<span class="ident" id="1499998">chanbuf</span><span class="op" id="1500005">(</span><span class="ident" id="1500006">c</span><span class="op" id="1500007">,</span>&nbsp;<span class="ident" id="1500009">c</span><span class="op" id="1500010">.</span><span class="ident" id="1500011">recvx</span><span class="op" id="1500016">)</span><span class="op" id="1500017">,</span>&nbsp;<span class="builtintype" id="1500019">uintptr</span><span class="op" id="1500026">(</span><span class="ident" id="1500027">c</span><span class="op" id="1500028">.</span><span class="ident" id="1500029">elemsize</span><span class="op" id="1500037">)</span><span class="op" id="1500038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500044">memclr</span><span class="op" id="1500050">(</span><span class="ident" id="1500051">chanbuf</span><span class="op" id="1500058">(</span><span class="ident" id="1500059">c</span><span class="op" id="1500060">,</span>&nbsp;<span class="ident" id="1500062">c</span><span class="op" id="1500063">.</span><span class="ident" id="1500064">recvx</span><span class="op" id="1500069">)</span><span class="op" id="1500070">,</span>&nbsp;<span class="builtintype" id="1500072">uintptr</span><span class="op" id="1500079">(</span><span class="ident" id="1500080">c</span><span class="op" id="1500081">.</span><span class="ident" id="1500082">elemsize</span><span class="op" id="1500090">)</span><span class="op" id="1500091">)</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500095">c</span><span class="op" id="1500096">.</span><span class="ident" id="1500097">recvx</span><span class="op" id="1500102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500106">if</span>&nbsp;<span class="ident" id="1500109">c</span><span class="op" id="1500110">.</span><span class="ident" id="1500111">recvx</span>&nbsp;<span class="op" id="1500117">==</span>&nbsp;<span class="ident" id="1500120">c</span><span class="op" id="1500121">.</span><span class="ident" id="1500122">dataqsiz</span>&nbsp;<span class="op" id="1500131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500135">c</span><span class="op" id="1500136">.</span><span class="ident" id="1500137">recvx</span>&nbsp;<span class="op" id="1500143">=</span>&nbsp;<span class="num" id="1500145">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500148">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500151">c</span><span class="op" id="1500152">.</span><span class="ident" id="1500153">qcount</span><span class="op" id="1500159">--</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1500164">//&nbsp;ping&nbsp;a&nbsp;sender&nbsp;now&nbsp;that&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500206">sg</span>&nbsp;<span class="op" id="1500209">:=</span>&nbsp;<span class="ident" id="1500212">c</span><span class="op" id="1500213">.</span><span class="ident" id="1500214">sendq</span><span class="op" id="1500219">.</span><span class="ident" id="1500220">dequeue</span><span class="op" id="1500227">(</span><span class="op" id="1500228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500231">if</span>&nbsp;<span class="ident" id="1500234">sg</span>&nbsp;<span class="op" id="1500237">!=</span>&nbsp;<span class="ident" id="1500240">nil</span>&nbsp;<span class="op" id="1500244">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500248">gp</span>&nbsp;<span class="op" id="1500251">:=</span>&nbsp;<span class="ident" id="1500254">sg</span><span class="op" id="1500256">.</span><span class="ident" id="1500257">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500261">unlock</span><span class="op" id="1500267">(</span><span class="op" id="1500268">&amp;</span><span class="ident" id="1500269">c</span><span class="op" id="1500270">.</span><span class="ident" id="1500271">lock</span><span class="op" id="1500275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500279">if</span>&nbsp;<span class="ident" id="1500282">sg</span><span class="op" id="1500284">.</span><span class="ident" id="1500285">releasetime</span>&nbsp;<span class="op" id="1500297">!=</span>&nbsp;<span class="num" id="1500300">0</span>&nbsp;<span class="op" id="1500302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500307">sg</span><span class="op" id="1500309">.</span><span class="ident" id="1500310">releasetime</span>&nbsp;<span class="op" id="1500322">=</span>&nbsp;<span class="ident" id="1500324">cputicks</span><span class="op" id="1500332">(</span><span class="op" id="1500333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500337">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500341">goready</span><span class="op" id="1500348">(</span><span class="ident" id="1500349">gp</span><span class="op" id="1500351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500354">}</span>&nbsp;<span class="keyword" id="1500356">else</span>&nbsp;<span class="op" id="1500361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500365">unlock</span><span class="op" id="1500371">(</span><span class="op" id="1500372">&amp;</span><span class="ident" id="1500373">c</span><span class="op" id="1500374">.</span><span class="ident" id="1500375">lock</span><span class="op" id="1500379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500386">if</span>&nbsp;<span class="ident" id="1500389">t1</span>&nbsp;<span class="op" id="1500392">&gt;</span>&nbsp;<span class="num" id="1500394">0</span>&nbsp;<span class="op" id="1500396">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500400">blockevent</span><span class="op" id="1500410">(</span><span class="ident" id="1500411">t1</span><span class="op" id="1500413">-</span><span class="ident" id="1500414">t0</span><span class="op" id="1500416">,</span>&nbsp;<span class="num" id="1500418">2</span><span class="op" id="1500419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500425">selected</span>&nbsp;<span class="op" id="1500434">=</span>&nbsp;<span class="builtintype" id="1500436">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500442">received</span>&nbsp;<span class="op" id="1500451">=</span>&nbsp;<span class="builtintype" id="1500453">true</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500459">return</span><br>
<span class="lineno"></span><span class="op" id="1500466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500469">//&nbsp;recvclosed&nbsp;is&nbsp;a&nbsp;helper&nbsp;function&nbsp;for&nbsp;chanrecv.&nbsp;&nbsp;Handles&nbsp;cleanup</span><br>
<span class="lineno"></span><span class="comment" id="1500535">//&nbsp;when&nbsp;the&nbsp;receiver&nbsp;encounters&nbsp;a&nbsp;closed&nbsp;channel.</span><br>
<span class="lineno">515</span><span class="comment" id="1500585">//&nbsp;Caller&nbsp;must&nbsp;hold&nbsp;c.lock,&nbsp;recvclosed&nbsp;will&nbsp;release&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1500647">func</span>&nbsp;<span class="ident" id="1500652">recvclosed</span><span class="op" id="1500662">(</span><span class="ident" id="1500663">c</span>&nbsp;<span class="op" id="1500665">*</span><span class="ident" id="1500666">hchan</span><span class="op" id="1500671">,</span>&nbsp;<span class="ident" id="1500673">ep</span>&nbsp;<span class="ident" id="1500676">unsafe</span><span class="op" id="1500682">.</span><span class="ident" id="1500683">Pointer</span><span class="op" id="1500690">)</span>&nbsp;<span class="op" id="1500692">(</span><span class="ident" id="1500693">selected</span><span class="op" id="1500701">,</span>&nbsp;<span class="ident" id="1500703">recevied</span>&nbsp;<span class="builtintype" id="1500712">bool</span><span class="op" id="1500716">)</span>&nbsp;<span class="op" id="1500718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500721">if</span>&nbsp;<span class="ident" id="1500724">raceenabled</span>&nbsp;<span class="op" id="1500736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500740">raceacquire</span><span class="op" id="1500751">(</span><span class="ident" id="1500752">unsafe</span><span class="op" id="1500758">.</span><span class="ident" id="1500759">Pointer</span><span class="op" id="1500766">(</span><span class="ident" id="1500767">c</span><span class="op" id="1500768">)</span><span class="op" id="1500769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500772">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500775">unlock</span><span class="op" id="1500781">(</span><span class="op" id="1500782">&amp;</span><span class="ident" id="1500783">c</span><span class="op" id="1500784">.</span><span class="ident" id="1500785">lock</span><span class="op" id="1500789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500792">if</span>&nbsp;<span class="ident" id="1500795">ep</span>&nbsp;<span class="op" id="1500798">!=</span>&nbsp;<span class="ident" id="1500801">nil</span>&nbsp;<span class="op" id="1500805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1500809">memclr</span><span class="op" id="1500815">(</span><span class="ident" id="1500816">ep</span><span class="op" id="1500818">,</span>&nbsp;<span class="builtintype" id="1500820">uintptr</span><span class="op" id="1500827">(</span><span class="ident" id="1500828">c</span><span class="op" id="1500829">.</span><span class="ident" id="1500830">elemsize</span><span class="op" id="1500838">)</span><span class="op" id="1500839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1500842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1500845">return</span>&nbsp;<span class="builtintype" id="1500852">true</span><span class="op" id="1500856">,</span>&nbsp;<span class="builtintype" id="1500858">false</span><br>
<span class="lineno">525</span><span class="op" id="1500864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1500867">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1500890">//</span><br>
<span class="lineno"></span><span class="comment" id="1500893">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno">530</span><span class="comment" id="1500905">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;c&nbsp;&lt;-&nbsp;v:</span><br>
<span class="lineno"></span><span class="comment" id="1500921">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1500933">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1500945">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1500957">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno">535</span><span class="comment" id="1500962">//</span><br>
<span class="lineno"></span><span class="comment" id="1500965">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1500971">//</span><br>
<span class="lineno"></span><span class="comment" id="1500974">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbsend(c,&nbsp;v)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501001">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">540</span><span class="comment" id="1501013">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501025">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1501037">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1501042">//</span><br>
<span class="lineno"></span><span class="keyword" id="1501045">func</span>&nbsp;<span class="ident" id="1501050">selectnbsend</span><span class="op" id="1501062">(</span><span class="ident" id="1501063">t</span>&nbsp;<span class="op" id="1501065">*</span><span class="ident" id="1501066">chantype</span><span class="op" id="1501074">,</span>&nbsp;<span class="ident" id="1501076">c</span>&nbsp;<span class="op" id="1501078">*</span><span class="ident" id="1501079">hchan</span><span class="op" id="1501084">,</span>&nbsp;<span class="ident" id="1501086">elem</span>&nbsp;<span class="ident" id="1501091">unsafe</span><span class="op" id="1501097">.</span><span class="ident" id="1501098">Pointer</span><span class="op" id="1501105">)</span>&nbsp;<span class="op" id="1501107">(</span><span class="ident" id="1501108">selected</span>&nbsp;<span class="builtintype" id="1501117">bool</span><span class="op" id="1501121">)</span>&nbsp;<span class="op" id="1501123">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501126">return</span>&nbsp;<span class="ident" id="1501133">chansend</span><span class="op" id="1501141">(</span><span class="ident" id="1501142">t</span><span class="op" id="1501143">,</span>&nbsp;<span class="ident" id="1501145">c</span><span class="op" id="1501146">,</span>&nbsp;<span class="ident" id="1501148">elem</span><span class="op" id="1501152">,</span>&nbsp;<span class="builtintype" id="1501154">false</span><span class="op" id="1501159">,</span>&nbsp;<span class="ident" id="1501161">getcallerpc</span><span class="op" id="1501172">(</span><span class="ident" id="1501173">unsafe</span><span class="op" id="1501179">.</span><span class="ident" id="1501180">Pointer</span><span class="op" id="1501187">(</span><span class="op" id="1501188">&amp;</span><span class="ident" id="1501189">t</span><span class="op" id="1501190">)</span><span class="op" id="1501191">)</span><span class="op" id="1501192">)</span><br>
<span class="lineno"></span><span class="op" id="1501194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1501197">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1501220">//</span><br>
<span class="lineno">550</span><span class="comment" id="1501223">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501235">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1501252">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1501264">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1501276">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">555</span><span class="comment" id="1501288">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1501293">//</span><br>
<span class="lineno"></span><span class="comment" id="1501296">//&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="1501302">//</span><br>
<span class="lineno"></span><span class="comment" id="1501305">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;selectnbrecv(&amp;v,&nbsp;c)&nbsp;{</span><br>
<span class="lineno">560</span><span class="comment" id="1501333">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1501345">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501357">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1501369">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1501374">//</span><br>
<span class="lineno">565</span><span class="keyword" id="1501377">func</span>&nbsp;<span class="ident" id="1501382">selectnbrecv</span><span class="op" id="1501394">(</span><span class="ident" id="1501395">t</span>&nbsp;<span class="op" id="1501397">*</span><span class="ident" id="1501398">chantype</span><span class="op" id="1501406">,</span>&nbsp;<span class="ident" id="1501408">elem</span>&nbsp;<span class="ident" id="1501413">unsafe</span><span class="op" id="1501419">.</span><span class="ident" id="1501420">Pointer</span><span class="op" id="1501427">,</span>&nbsp;<span class="ident" id="1501429">c</span>&nbsp;<span class="op" id="1501431">*</span><span class="ident" id="1501432">hchan</span><span class="op" id="1501437">)</span>&nbsp;<span class="op" id="1501439">(</span><span class="ident" id="1501440">selected</span>&nbsp;<span class="builtintype" id="1501449">bool</span><span class="op" id="1501453">)</span>&nbsp;<span class="op" id="1501455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501458">selected</span><span class="op" id="1501466">,</span>&nbsp;<span class="ident" id="1501468">_</span>&nbsp;<span class="op" id="1501470">=</span>&nbsp;<span class="ident" id="1501472">chanrecv</span><span class="op" id="1501480">(</span><span class="ident" id="1501481">t</span><span class="op" id="1501482">,</span>&nbsp;<span class="ident" id="1501484">c</span><span class="op" id="1501485">,</span>&nbsp;<span class="ident" id="1501487">elem</span><span class="op" id="1501491">,</span>&nbsp;<span class="builtintype" id="1501493">false</span><span class="op" id="1501498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501501">return</span><br>
<span class="lineno"></span><span class="op" id="1501508">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">570</span><span class="comment" id="1501511">//&nbsp;compiler&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1501534">//</span><br>
<span class="lineno"></span><span class="comment" id="1501537">//&nbsp;&nbsp;&nbsp;&nbspselect&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501549">//&nbsp;&nbsp;&nbsp;&nbspcase&nbsp;v,&nbsp;ok&nbsp;=&nbsp;&lt;-c:</span><br>
<span class="lineno"></span><span class="comment" id="1501570">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno">575</span><span class="comment" id="1501582">//&nbsp;&nbsp;&nbsp;&nbspdefault:</span><br>
<span class="lineno"></span><span class="comment" id="1501594">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno"></span><span class="comment" id="1501606">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1501611">//</span><br>
<span class="lineno"></span><span class="comment" id="1501614">//&nbsp;as</span><br>
<span class="lineno">580</span><span class="comment" id="1501620">//</span><br>
<span class="lineno"></span><span class="comment" id="1501623">//&nbsp;&nbsp;&nbsp;&nbspif&nbsp;c&nbsp;!=&nbsp;nil&nbsp;&amp;&amp;&nbsp;selectnbrecv2(&amp;v,&nbsp;&amp;ok,&nbsp;c)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501669">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;foo</span><br>
<span class="lineno"></span><span class="comment" id="1501681">//&nbsp;&nbsp;&nbsp;&nbsp}&nbsp;else&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="1501693">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp...&nbsp;bar</span><br>
<span class="lineno">585</span><span class="comment" id="1501705">//&nbsp;&nbsp;&nbsp;&nbsp}</span><br>
<span class="lineno"></span><span class="comment" id="1501710">//</span><br>
<span class="lineno"></span><span class="keyword" id="1501713">func</span>&nbsp;<span class="ident" id="1501718">selectnbrecv2</span><span class="op" id="1501731">(</span><span class="ident" id="1501732">t</span>&nbsp;<span class="op" id="1501734">*</span><span class="ident" id="1501735">chantype</span><span class="op" id="1501743">,</span>&nbsp;<span class="ident" id="1501745">elem</span>&nbsp;<span class="ident" id="1501750">unsafe</span><span class="op" id="1501756">.</span><span class="ident" id="1501757">Pointer</span><span class="op" id="1501764">,</span>&nbsp;<span class="ident" id="1501766">received</span>&nbsp;<span class="op" id="1501775">*</span><span class="builtintype" id="1501776">bool</span><span class="op" id="1501780">,</span>&nbsp;<span class="ident" id="1501782">c</span>&nbsp;<span class="op" id="1501784">*</span><span class="ident" id="1501785">hchan</span><span class="op" id="1501790">)</span>&nbsp;<span class="op" id="1501792">(</span><span class="ident" id="1501793">selected</span>&nbsp;<span class="builtintype" id="1501802">bool</span><span class="op" id="1501806">)</span>&nbsp;<span class="op" id="1501808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1501811">//&nbsp;TODO(khr):&nbsp;just&nbsp;return&nbsp;2&nbsp;values&nbsp;from&nbsp;this&nbsp;function,&nbsp;now&nbsp;that&nbsp;it&nbsp;is&nbsp;in&nbsp;Go.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1501889">selected</span><span class="op" id="1501897">,</span>&nbsp;<span class="op" id="1501899">*</span><span class="ident" id="1501900">received</span>&nbsp;<span class="op" id="1501909">=</span>&nbsp;<span class="ident" id="1501911">chanrecv</span><span class="op" id="1501919">(</span><span class="ident" id="1501920">t</span><span class="op" id="1501921">,</span>&nbsp;<span class="ident" id="1501923">c</span><span class="op" id="1501924">,</span>&nbsp;<span class="ident" id="1501926">elem</span><span class="op" id="1501930">,</span>&nbsp;<span class="builtintype" id="1501932">false</span><span class="op" id="1501937">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1501940">return</span><br>
<span class="lineno"></span><span class="op" id="1501947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1501950">func</span>&nbsp;<span class="ident" id="1501955">reflect_chansend</span><span class="op" id="1501971">(</span><span class="ident" id="1501972">t</span>&nbsp;<span class="op" id="1501974">*</span><span class="ident" id="1501975">chantype</span><span class="op" id="1501983">,</span>&nbsp;<span class="ident" id="1501985">c</span>&nbsp;<span class="op" id="1501987">*</span><span class="ident" id="1501988">hchan</span><span class="op" id="1501993">,</span>&nbsp;<span class="ident" id="1501995">elem</span>&nbsp;<span class="ident" id="1502000">unsafe</span><span class="op" id="1502006">.</span><span class="ident" id="1502007">Pointer</span><span class="op" id="1502014">,</span>&nbsp;<span class="ident" id="1502016">nb</span>&nbsp;<span class="builtintype" id="1502019">bool</span><span class="op" id="1502023">)</span>&nbsp;<span class="op" id="1502025">(</span><span class="ident" id="1502026">selected</span>&nbsp;<span class="builtintype" id="1502035">bool</span><span class="op" id="1502039">)</span>&nbsp;<span class="op" id="1502041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502044">return</span>&nbsp;<span class="ident" id="1502051">chansend</span><span class="op" id="1502059">(</span><span class="ident" id="1502060">t</span><span class="op" id="1502061">,</span>&nbsp;<span class="ident" id="1502063">c</span><span class="op" id="1502064">,</span>&nbsp;<span class="ident" id="1502066">elem</span><span class="op" id="1502070">,</span>&nbsp;<span class="op" id="1502072">!</span><span class="ident" id="1502073">nb</span><span class="op" id="1502075">,</span>&nbsp;<span class="ident" id="1502077">getcallerpc</span><span class="op" id="1502088">(</span><span class="ident" id="1502089">unsafe</span><span class="op" id="1502095">.</span><span class="ident" id="1502096">Pointer</span><span class="op" id="1502103">(</span><span class="op" id="1502104">&amp;</span><span class="ident" id="1502105">t</span><span class="op" id="1502106">)</span><span class="op" id="1502107">)</span><span class="op" id="1502108">)</span><br>
<span class="lineno">595</span><span class="op" id="1502110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1502113">func</span>&nbsp;<span class="ident" id="1502118">reflect_chanrecv</span><span class="op" id="1502134">(</span><span class="ident" id="1502135">t</span>&nbsp;<span class="op" id="1502137">*</span><span class="ident" id="1502138">chantype</span><span class="op" id="1502146">,</span>&nbsp;<span class="ident" id="1502148">c</span>&nbsp;<span class="op" id="1502150">*</span><span class="ident" id="1502151">hchan</span><span class="op" id="1502156">,</span>&nbsp;<span class="ident" id="1502158">nb</span>&nbsp;<span class="builtintype" id="1502161">bool</span><span class="op" id="1502165">,</span>&nbsp;<span class="ident" id="1502167">elem</span>&nbsp;<span class="ident" id="1502172">unsafe</span><span class="op" id="1502178">.</span><span class="ident" id="1502179">Pointer</span><span class="op" id="1502186">)</span>&nbsp;<span class="op" id="1502188">(</span><span class="ident" id="1502189">selected</span>&nbsp;<span class="builtintype" id="1502198">bool</span><span class="op" id="1502202">,</span>&nbsp;<span class="ident" id="1502204">received</span>&nbsp;<span class="builtintype" id="1502213">bool</span><span class="op" id="1502217">)</span>&nbsp;<span class="op" id="1502219">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502222">return</span>&nbsp;<span class="ident" id="1502229">chanrecv</span><span class="op" id="1502237">(</span><span class="ident" id="1502238">t</span><span class="op" id="1502239">,</span>&nbsp;<span class="ident" id="1502241">c</span><span class="op" id="1502242">,</span>&nbsp;<span class="ident" id="1502244">elem</span><span class="op" id="1502248">,</span>&nbsp;<span class="op" id="1502250">!</span><span class="ident" id="1502251">nb</span><span class="op" id="1502253">)</span><br>
<span class="lineno"></span><span class="op" id="1502255">}</span><br>
<span class="lineno">600</span><br>
<span class="lineno"></span><span class="keyword" id="1502258">func</span>&nbsp;<span class="ident" id="1502263">reflect_chanlen</span><span class="op" id="1502278">(</span><span class="ident" id="1502279">c</span>&nbsp;<span class="op" id="1502281">*</span><span class="ident" id="1502282">hchan</span><span class="op" id="1502287">)</span>&nbsp;<span class="builtintype" id="1502289">int</span>&nbsp;<span class="op" id="1502293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502296">if</span>&nbsp;<span class="ident" id="1502299">c</span>&nbsp;<span class="op" id="1502301">==</span>&nbsp;<span class="ident" id="1502304">nil</span>&nbsp;<span class="op" id="1502308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502312">return</span>&nbsp;<span class="num" id="1502319">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502322">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502325">return</span>&nbsp;<span class="builtintype" id="1502332">int</span><span class="op" id="1502335">(</span><span class="ident" id="1502336">c</span><span class="op" id="1502337">.</span><span class="ident" id="1502338">qcount</span><span class="op" id="1502344">)</span><br>
<span class="lineno"></span><span class="op" id="1502346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1502349">func</span>&nbsp;<span class="ident" id="1502354">reflect_chancap</span><span class="op" id="1502369">(</span><span class="ident" id="1502370">c</span>&nbsp;<span class="op" id="1502372">*</span><span class="ident" id="1502373">hchan</span><span class="op" id="1502378">)</span>&nbsp;<span class="builtintype" id="1502380">int</span>&nbsp;<span class="op" id="1502384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502387">if</span>&nbsp;<span class="ident" id="1502390">c</span>&nbsp;<span class="op" id="1502392">==</span>&nbsp;<span class="ident" id="1502395">nil</span>&nbsp;<span class="op" id="1502399">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502403">return</span>&nbsp;<span class="num" id="1502410">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502413">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502416">return</span>&nbsp;<span class="builtintype" id="1502423">int</span><span class="op" id="1502426">(</span><span class="ident" id="1502427">c</span><span class="op" id="1502428">.</span><span class="ident" id="1502429">dataqsiz</span><span class="op" id="1502437">)</span><br>
<span class="lineno"></span><span class="op" id="1502439">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="keyword" id="1502442">func</span>&nbsp;<span class="op" id="1502447">(</span><span class="ident" id="1502448">q</span>&nbsp;<span class="op" id="1502450">*</span><span class="ident" id="1502451">waitq</span><span class="op" id="1502456">)</span>&nbsp;<span class="ident" id="1502458">enqueue</span><span class="op" id="1502465">(</span><span class="ident" id="1502466">sgp</span>&nbsp;<span class="op" id="1502470">*</span><span class="ident" id="1502471">sudog</span><span class="op" id="1502476">)</span>&nbsp;<span class="op" id="1502478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502481">sgp</span><span class="op" id="1502484">.</span><span class="ident" id="1502485">next</span>&nbsp;<span class="op" id="1502490">=</span>&nbsp;<span class="ident" id="1502492">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502497">if</span>&nbsp;<span class="ident" id="1502500">q</span><span class="op" id="1502501">.</span><span class="ident" id="1502502">first</span>&nbsp;<span class="op" id="1502508">==</span>&nbsp;<span class="ident" id="1502511">nil</span>&nbsp;<span class="op" id="1502515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502519">q</span><span class="op" id="1502520">.</span><span class="ident" id="1502521">first</span>&nbsp;<span class="op" id="1502527">=</span>&nbsp;<span class="ident" id="1502529">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502535">q</span><span class="op" id="1502536">.</span><span class="ident" id="1502537">last</span>&nbsp;<span class="op" id="1502542">=</span>&nbsp;<span class="ident" id="1502544">sgp</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502550">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502558">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502561">q</span><span class="op" id="1502562">.</span><span class="ident" id="1502563">last</span><span class="op" id="1502567">.</span><span class="ident" id="1502568">next</span>&nbsp;<span class="op" id="1502573">=</span>&nbsp;<span class="ident" id="1502575">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502580">q</span><span class="op" id="1502581">.</span><span class="ident" id="1502582">last</span>&nbsp;<span class="op" id="1502587">=</span>&nbsp;<span class="ident" id="1502589">sgp</span><br>
<span class="lineno"></span><span class="op" id="1502593">}</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span><span class="keyword" id="1502596">func</span>&nbsp;<span class="op" id="1502601">(</span><span class="ident" id="1502602">q</span>&nbsp;<span class="op" id="1502604">*</span><span class="ident" id="1502605">waitq</span><span class="op" id="1502610">)</span>&nbsp;<span class="ident" id="1502612">dequeue</span><span class="op" id="1502619">(</span><span class="op" id="1502620">)</span>&nbsp;<span class="op" id="1502622">*</span><span class="ident" id="1502623">sudog</span>&nbsp;<span class="op" id="1502629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502632">for</span>&nbsp;<span class="op" id="1502636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502640">sgp</span>&nbsp;<span class="op" id="1502644">:=</span>&nbsp;<span class="ident" id="1502647">q</span><span class="op" id="1502648">.</span><span class="ident" id="1502649">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502657">if</span>&nbsp;<span class="ident" id="1502660">sgp</span>&nbsp;<span class="op" id="1502664">==</span>&nbsp;<span class="ident" id="1502667">nil</span>&nbsp;<span class="op" id="1502671">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502676">return</span>&nbsp;<span class="ident" id="1502683">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502693">q</span><span class="op" id="1502694">.</span><span class="ident" id="1502695">first</span>&nbsp;<span class="op" id="1502701">=</span>&nbsp;<span class="ident" id="1502703">sgp</span><span class="op" id="1502706">.</span><span class="ident" id="1502707">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502714">sgp</span><span class="op" id="1502717">.</span><span class="ident" id="1502718">next</span>&nbsp;<span class="op" id="1502723">=</span>&nbsp;<span class="ident" id="1502725">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502731">if</span>&nbsp;<span class="ident" id="1502734">q</span><span class="op" id="1502735">.</span><span class="ident" id="1502736">last</span>&nbsp;<span class="op" id="1502741">==</span>&nbsp;<span class="ident" id="1502744">sgp</span>&nbsp;<span class="op" id="1502748">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1502753">q</span><span class="op" id="1502754">.</span><span class="ident" id="1502755">last</span>&nbsp;<span class="op" id="1502760">=</span>&nbsp;<span class="ident" id="1502762">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502773">//&nbsp;if&nbsp;sgp&nbsp;participates&nbsp;in&nbsp;a&nbsp;select&nbsp;and&nbsp;is&nbsp;already&nbsp;signaled,&nbsp;ignore&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502845">if</span>&nbsp;<span class="ident" id="1502848">sgp</span><span class="op" id="1502851">.</span><span class="ident" id="1502852">selectdone</span>&nbsp;<span class="op" id="1502863">!=</span>&nbsp;<span class="ident" id="1502866">nil</span>&nbsp;<span class="op" id="1502870">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1502875">//&nbsp;claim&nbsp;the&nbsp;right&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502907">if</span>&nbsp;<span class="op" id="1502910">*</span><span class="ident" id="1502911">sgp</span><span class="op" id="1502914">.</span><span class="ident" id="1502915">selectdone</span>&nbsp;<span class="op" id="1502926">!=</span>&nbsp;<span class="num" id="1502929">0</span>&nbsp;<span class="op" id="1502931">||</span>&nbsp;<span class="op" id="1502934">!</span><span class="ident" id="1502935">cas</span><span class="op" id="1502938">(</span><span class="ident" id="1502939">sgp</span><span class="op" id="1502942">.</span><span class="ident" id="1502943">selectdone</span><span class="op" id="1502953">,</span>&nbsp;<span class="num" id="1502955">0</span><span class="op" id="1502956">,</span>&nbsp;<span class="num" id="1502958">1</span><span class="op" id="1502959">)</span>&nbsp;<span class="op" id="1502961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502967">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1502983">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1502988">return</span>&nbsp;<span class="ident" id="1502995">sgp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1503000">}</span><br>
<span class="lineno"></span><span class="op" id="1503002">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="keyword" id="1503005">func</span>&nbsp;<span class="ident" id="1503010">racesync</span><span class="op" id="1503018">(</span><span class="ident" id="1503019">c</span>&nbsp;<span class="op" id="1503021">*</span><span class="ident" id="1503022">hchan</span><span class="op" id="1503027">,</span>&nbsp;<span class="ident" id="1503029">sg</span>&nbsp;<span class="op" id="1503032">*</span><span class="ident" id="1503033">sudog</span><span class="op" id="1503038">)</span>&nbsp;<span class="op" id="1503040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503043">racerelease</span><span class="op" id="1503054">(</span><span class="ident" id="1503055">chanbuf</span><span class="op" id="1503062">(</span><span class="ident" id="1503063">c</span><span class="op" id="1503064">,</span>&nbsp;<span class="num" id="1503066">0</span><span class="op" id="1503067">)</span><span class="op" id="1503068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503071">raceacquireg</span><span class="op" id="1503083">(</span><span class="ident" id="1503084">sg</span><span class="op" id="1503086">.</span><span class="ident" id="1503087">g</span><span class="op" id="1503088">,</span>&nbsp;<span class="ident" id="1503090">chanbuf</span><span class="op" id="1503097">(</span><span class="ident" id="1503098">c</span><span class="op" id="1503099">,</span>&nbsp;<span class="num" id="1503101">0</span><span class="op" id="1503102">)</span><span class="op" id="1503103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503106">racereleaseg</span><span class="op" id="1503118">(</span><span class="ident" id="1503119">sg</span><span class="op" id="1503121">.</span><span class="ident" id="1503122">g</span><span class="op" id="1503123">,</span>&nbsp;<span class="ident" id="1503125">chanbuf</span><span class="op" id="1503132">(</span><span class="ident" id="1503133">c</span><span class="op" id="1503134">,</span>&nbsp;<span class="num" id="1503136">0</span><span class="op" id="1503137">)</span><span class="op" id="1503138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1503141">raceacquire</span><span class="op" id="1503152">(</span><span class="ident" id="1503153">chanbuf</span><span class="op" id="1503160">(</span><span class="ident" id="1503161">c</span><span class="op" id="1503162">,</span>&nbsp;<span class="num" id="1503164">0</span><span class="op" id="1503165">)</span><span class="op" id="1503166">)</span><br>
<span class="lineno">655</span><span class="op" id="1503168">}</span>
</div>
</body>
</html>
