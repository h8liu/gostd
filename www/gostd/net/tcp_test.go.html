<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="8483324">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8483379">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8483433">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="8483484">package</span>&nbsp;<span class="ident" id="8483492">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8483497">import</span>&nbsp;<span class="op" id="8483504">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483507">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483514">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483520">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483531">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483542">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483550">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8483561">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="8483568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8483571">func</span>&nbsp;<span class="ident" id="8483576">BenchmarkTCP4OneShot</span><span class="op" id="8483596">(</span><span class="ident" id="8483597">b</span>&nbsp;<span class="op" id="8483599">*</span><span class="ident" id="8483600">testing</span><span class="op" id="8483607">.</span><span class="ident" id="8483608">B</span><span class="op" id="8483609">)</span>&nbsp;<span class="op" id="8483611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8483614">benchmarkTCP</span><span class="op" id="8483626">(</span><span class="ident" id="8483627">b</span><span class="op" id="8483628">,</span>&nbsp;<span class="builtintype" id="8483630">false</span><span class="op" id="8483635">,</span>&nbsp;<span class="builtintype" id="8483637">false</span><span class="op" id="8483642">,</span>&nbsp;<span class="string" id="8483644">&#34;127.0.0.1:0&#34;</span><span class="op" id="8483657">)</span><br>
<span class="lineno"></span><span class="op" id="8483659">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8483662">func</span>&nbsp;<span class="ident" id="8483667">BenchmarkTCP4OneShotTimeout</span><span class="op" id="8483694">(</span><span class="ident" id="8483695">b</span>&nbsp;<span class="op" id="8483697">*</span><span class="ident" id="8483698">testing</span><span class="op" id="8483705">.</span><span class="ident" id="8483706">B</span><span class="op" id="8483707">)</span>&nbsp;<span class="op" id="8483709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8483712">benchmarkTCP</span><span class="op" id="8483724">(</span><span class="ident" id="8483725">b</span><span class="op" id="8483726">,</span>&nbsp;<span class="builtintype" id="8483728">false</span><span class="op" id="8483733">,</span>&nbsp;<span class="builtintype" id="8483735">true</span><span class="op" id="8483739">,</span>&nbsp;<span class="string" id="8483741">&#34;127.0.0.1:0&#34;</span><span class="op" id="8483754">)</span><br>
<span class="lineno"></span><span class="op" id="8483756">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8483759">func</span>&nbsp;<span class="ident" id="8483764">BenchmarkTCP4Persistent</span><span class="op" id="8483787">(</span><span class="ident" id="8483788">b</span>&nbsp;<span class="op" id="8483790">*</span><span class="ident" id="8483791">testing</span><span class="op" id="8483798">.</span><span class="ident" id="8483799">B</span><span class="op" id="8483800">)</span>&nbsp;<span class="op" id="8483802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8483805">benchmarkTCP</span><span class="op" id="8483817">(</span><span class="ident" id="8483818">b</span><span class="op" id="8483819">,</span>&nbsp;<span class="builtintype" id="8483821">true</span><span class="op" id="8483825">,</span>&nbsp;<span class="builtintype" id="8483827">false</span><span class="op" id="8483832">,</span>&nbsp;<span class="string" id="8483834">&#34;127.0.0.1:0&#34;</span><span class="op" id="8483847">)</span><br>
<span class="lineno"></span><span class="op" id="8483849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8483852">func</span>&nbsp;<span class="ident" id="8483857">BenchmarkTCP4PersistentTimeout</span><span class="op" id="8483887">(</span><span class="ident" id="8483888">b</span>&nbsp;<span class="op" id="8483890">*</span><span class="ident" id="8483891">testing</span><span class="op" id="8483898">.</span><span class="ident" id="8483899">B</span><span class="op" id="8483900">)</span>&nbsp;<span class="op" id="8483902">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8483905">benchmarkTCP</span><span class="op" id="8483917">(</span><span class="ident" id="8483918">b</span><span class="op" id="8483919">,</span>&nbsp;<span class="builtintype" id="8483921">true</span><span class="op" id="8483925">,</span>&nbsp;<span class="builtintype" id="8483927">true</span><span class="op" id="8483931">,</span>&nbsp;<span class="string" id="8483933">&#34;127.0.0.1:0&#34;</span><span class="op" id="8483946">)</span><br>
<span class="lineno"></span><span class="op" id="8483948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8483951">func</span>&nbsp;<span class="ident" id="8483956">BenchmarkTCP6OneShot</span><span class="op" id="8483976">(</span><span class="ident" id="8483977">b</span>&nbsp;<span class="op" id="8483979">*</span><span class="ident" id="8483980">testing</span><span class="op" id="8483987">.</span><span class="ident" id="8483988">B</span><span class="op" id="8483989">)</span>&nbsp;<span class="op" id="8483991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8483994">if</span>&nbsp;<span class="op" id="8483997">!</span><span class="ident" id="8483998">supportsIPv6</span>&nbsp;<span class="op" id="8484011">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484015">b</span><span class="op" id="8484016">.</span><span class="ident" id="8484017">Skip</span><span class="op" id="8484021">(</span><span class="string" id="8484022">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8484045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484048">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484051">benchmarkTCP</span><span class="op" id="8484063">(</span><span class="ident" id="8484064">b</span><span class="op" id="8484065">,</span>&nbsp;<span class="builtintype" id="8484067">false</span><span class="op" id="8484072">,</span>&nbsp;<span class="builtintype" id="8484074">false</span><span class="op" id="8484079">,</span>&nbsp;<span class="string" id="8484081">&#34;[::1]:0&#34;</span><span class="op" id="8484090">)</span><br>
<span class="lineno"></span><span class="op" id="8484092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="8484095">func</span>&nbsp;<span class="ident" id="8484100">BenchmarkTCP6OneShotTimeout</span><span class="op" id="8484127">(</span><span class="ident" id="8484128">b</span>&nbsp;<span class="op" id="8484130">*</span><span class="ident" id="8484131">testing</span><span class="op" id="8484138">.</span><span class="ident" id="8484139">B</span><span class="op" id="8484140">)</span>&nbsp;<span class="op" id="8484142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484145">if</span>&nbsp;<span class="op" id="8484148">!</span><span class="ident" id="8484149">supportsIPv6</span>&nbsp;<span class="op" id="8484162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484166">b</span><span class="op" id="8484167">.</span><span class="ident" id="8484168">Skip</span><span class="op" id="8484172">(</span><span class="string" id="8484173">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8484196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484202">benchmarkTCP</span><span class="op" id="8484214">(</span><span class="ident" id="8484215">b</span><span class="op" id="8484216">,</span>&nbsp;<span class="builtintype" id="8484218">false</span><span class="op" id="8484223">,</span>&nbsp;<span class="builtintype" id="8484225">true</span><span class="op" id="8484229">,</span>&nbsp;<span class="string" id="8484231">&#34;[::1]:0&#34;</span><span class="op" id="8484240">)</span><br>
<span class="lineno">45</span><span class="op" id="8484242">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8484245">func</span>&nbsp;<span class="ident" id="8484250">BenchmarkTCP6Persistent</span><span class="op" id="8484273">(</span><span class="ident" id="8484274">b</span>&nbsp;<span class="op" id="8484276">*</span><span class="ident" id="8484277">testing</span><span class="op" id="8484284">.</span><span class="ident" id="8484285">B</span><span class="op" id="8484286">)</span>&nbsp;<span class="op" id="8484288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484291">if</span>&nbsp;<span class="op" id="8484294">!</span><span class="ident" id="8484295">supportsIPv6</span>&nbsp;<span class="op" id="8484308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484312">b</span><span class="op" id="8484313">.</span><span class="ident" id="8484314">Skip</span><span class="op" id="8484318">(</span><span class="string" id="8484319">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8484342">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484348">benchmarkTCP</span><span class="op" id="8484360">(</span><span class="ident" id="8484361">b</span><span class="op" id="8484362">,</span>&nbsp;<span class="builtintype" id="8484364">true</span><span class="op" id="8484368">,</span>&nbsp;<span class="builtintype" id="8484370">false</span><span class="op" id="8484375">,</span>&nbsp;<span class="string" id="8484377">&#34;[::1]:0&#34;</span><span class="op" id="8484386">)</span><br>
<span class="lineno"></span><span class="op" id="8484388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8484391">func</span>&nbsp;<span class="ident" id="8484396">BenchmarkTCP6PersistentTimeout</span><span class="op" id="8484426">(</span><span class="ident" id="8484427">b</span>&nbsp;<span class="op" id="8484429">*</span><span class="ident" id="8484430">testing</span><span class="op" id="8484437">.</span><span class="ident" id="8484438">B</span><span class="op" id="8484439">)</span>&nbsp;<span class="op" id="8484441">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484444">if</span>&nbsp;<span class="op" id="8484447">!</span><span class="ident" id="8484448">supportsIPv6</span>&nbsp;<span class="op" id="8484461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484465">b</span><span class="op" id="8484466">.</span><span class="ident" id="8484467">Skip</span><span class="op" id="8484471">(</span><span class="string" id="8484472">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8484495">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484498">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484501">benchmarkTCP</span><span class="op" id="8484513">(</span><span class="ident" id="8484514">b</span><span class="op" id="8484515">,</span>&nbsp;<span class="builtintype" id="8484517">true</span><span class="op" id="8484521">,</span>&nbsp;<span class="builtintype" id="8484523">true</span><span class="op" id="8484527">,</span>&nbsp;<span class="string" id="8484529">&#34;[::1]:0&#34;</span><span class="op" id="8484538">)</span><br>
<span class="lineno"></span><span class="op" id="8484540">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="8484543">func</span>&nbsp;<span class="ident" id="8484548">benchmarkTCP</span><span class="op" id="8484560">(</span><span class="ident" id="8484561">b</span>&nbsp;<span class="op" id="8484563">*</span><span class="ident" id="8484564">testing</span><span class="op" id="8484571">.</span><span class="ident" id="8484572">B</span><span class="op" id="8484573">,</span>&nbsp;<span class="ident" id="8484575">persistent</span><span class="op" id="8484585">,</span>&nbsp;<span class="ident" id="8484587">timeout</span>&nbsp;<span class="builtintype" id="8484595">bool</span><span class="op" id="8484599">,</span>&nbsp;<span class="ident" id="8484601">laddr</span>&nbsp;<span class="builtintype" id="8484607">string</span><span class="op" id="8484613">)</span>&nbsp;<span class="op" id="8484615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484618">const</span>&nbsp;<span class="ident" id="8484624">msgLen</span>&nbsp;<span class="op" id="8484631">=</span>&nbsp;<span class="num" id="8484633">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484638">conns</span>&nbsp;<span class="op" id="8484644">:=</span>&nbsp;<span class="ident" id="8484647">b</span><span class="op" id="8484648">.</span><span class="ident" id="8484649">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484652">numConcurrent</span>&nbsp;<span class="op" id="8484666">:=</span>&nbsp;<span class="ident" id="8484669">runtime</span><span class="op" id="8484676">.</span><span class="ident" id="8484677">GOMAXPROCS</span><span class="op" id="8484687">(</span><span class="op" id="8484688">-</span><span class="num" id="8484689">1</span><span class="op" id="8484690">)</span>&nbsp;<span class="op" id="8484692">*</span>&nbsp;<span class="num" id="8484694">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484697">msgs</span>&nbsp;<span class="op" id="8484702">:=</span>&nbsp;<span class="num" id="8484705">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484708">if</span>&nbsp;<span class="ident" id="8484711">persistent</span>&nbsp;<span class="op" id="8484722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484726">conns</span>&nbsp;<span class="op" id="8484732">=</span>&nbsp;<span class="ident" id="8484734">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484750">msgs</span>&nbsp;<span class="op" id="8484755">=</span>&nbsp;<span class="ident" id="8484757">b</span><span class="op" id="8484758">.</span><span class="ident" id="8484759">N</span>&nbsp;<span class="op" id="8484761">/</span>&nbsp;<span class="ident" id="8484763">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484771">if</span>&nbsp;<span class="ident" id="8484774">msgs</span>&nbsp;<span class="op" id="8484779">==</span>&nbsp;<span class="num" id="8484782">0</span>&nbsp;<span class="op" id="8484784">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484789">msgs</span>&nbsp;<span class="op" id="8484794">=</span>&nbsp;<span class="num" id="8484796">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484804">if</span>&nbsp;<span class="ident" id="8484807">conns</span>&nbsp;<span class="op" id="8484813">&gt;</span>&nbsp;<span class="ident" id="8484815">b</span><span class="op" id="8484816">.</span><span class="ident" id="8484817">N</span>&nbsp;<span class="op" id="8484819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484824">conns</span>&nbsp;<span class="op" id="8484830">=</span>&nbsp;<span class="ident" id="8484832">b</span><span class="op" id="8484833">.</span><span class="ident" id="8484834">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484838">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8484841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484844">sendMsg</span>&nbsp;<span class="op" id="8484852">:=</span>&nbsp;<span class="keyword" id="8484855">func</span><span class="op" id="8484859">(</span><span class="ident" id="8484860">c</span>&nbsp;<span class="ident" id="8484862">Conn</span><span class="op" id="8484866">,</span>&nbsp;<span class="ident" id="8484868">buf</span>&nbsp;<span class="op" id="8484872">[</span><span class="op" id="8484873">]</span><span class="builtintype" id="8484874">byte</span><span class="op" id="8484878">)</span>&nbsp;<span class="builtintype" id="8484880">bool</span>&nbsp;<span class="op" id="8484885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484889">n</span><span class="op" id="8484890">,</span>&nbsp;<span class="ident" id="8484892">err</span>&nbsp;<span class="op" id="8484896">:=</span>&nbsp;<span class="ident" id="8484899">c</span><span class="op" id="8484900">.</span><span class="ident" id="8484901">Write</span><span class="op" id="8484906">(</span><span class="ident" id="8484907">buf</span><span class="op" id="8484910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484914">if</span>&nbsp;<span class="ident" id="8484917">n</span>&nbsp;<span class="op" id="8484919">!=</span>&nbsp;<span class="builtinfunc" id="8484922">len</span><span class="op" id="8484925">(</span><span class="ident" id="8484926">buf</span><span class="op" id="8484929">)</span>&nbsp;<span class="op" id="8484931">||</span>&nbsp;<span class="ident" id="8484934">err</span>&nbsp;<span class="op" id="8484938">!=</span>&nbsp;<span class="ident" id="8484941">nil</span>&nbsp;<span class="op" id="8484945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8484950">b</span><span class="op" id="8484951">.</span><span class="ident" id="8484952">Logf</span><span class="op" id="8484956">(</span><span class="string" id="8484957">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8484975">,</span>&nbsp;<span class="ident" id="8484977">err</span><span class="op" id="8484980">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8484985">return</span>&nbsp;<span class="builtintype" id="8484992">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485004">return</span>&nbsp;<span class="builtintype" id="8485011">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485020">recvMsg</span>&nbsp;<span class="op" id="8485028">:=</span>&nbsp;<span class="keyword" id="8485031">func</span><span class="op" id="8485035">(</span><span class="ident" id="8485036">c</span>&nbsp;<span class="ident" id="8485038">Conn</span><span class="op" id="8485042">,</span>&nbsp;<span class="ident" id="8485044">buf</span>&nbsp;<span class="op" id="8485048">[</span><span class="op" id="8485049">]</span><span class="builtintype" id="8485050">byte</span><span class="op" id="8485054">)</span>&nbsp;<span class="builtintype" id="8485056">bool</span>&nbsp;<span class="op" id="8485061">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485065">for</span>&nbsp;<span class="ident" id="8485069">read</span>&nbsp;<span class="op" id="8485074">:=</span>&nbsp;<span class="num" id="8485077">0</span><span class="op" id="8485078">;</span>&nbsp;<span class="ident" id="8485080">read</span>&nbsp;<span class="op" id="8485085">!=</span>&nbsp;<span class="builtinfunc" id="8485088">len</span><span class="op" id="8485091">(</span><span class="ident" id="8485092">buf</span><span class="op" id="8485095">)</span><span class="op" id="8485096">;</span>&nbsp;<span class="op" id="8485098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485103">n</span><span class="op" id="8485104">,</span>&nbsp;<span class="ident" id="8485106">err</span>&nbsp;<span class="op" id="8485110">:=</span>&nbsp;<span class="ident" id="8485113">c</span><span class="op" id="8485114">.</span><span class="ident" id="8485115">Read</span><span class="op" id="8485119">(</span><span class="ident" id="8485120">buf</span><span class="op" id="8485123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485128">read</span>&nbsp;<span class="op" id="8485133">+=</span>&nbsp;<span class="ident" id="8485136">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485141">if</span>&nbsp;<span class="ident" id="8485144">err</span>&nbsp;<span class="op" id="8485148">!=</span>&nbsp;<span class="ident" id="8485151">nil</span>&nbsp;<span class="op" id="8485155">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485161">b</span><span class="op" id="8485162">.</span><span class="ident" id="8485163">Logf</span><span class="op" id="8485167">(</span><span class="string" id="8485168">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8485185">,</span>&nbsp;<span class="ident" id="8485187">err</span><span class="op" id="8485190">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485196">return</span>&nbsp;<span class="builtintype" id="8485203">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485212">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485220">return</span>&nbsp;<span class="builtintype" id="8485227">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485233">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485236">ln</span><span class="op" id="8485238">,</span>&nbsp;<span class="ident" id="8485240">err</span>&nbsp;<span class="op" id="8485244">:=</span>&nbsp;<span class="ident" id="8485247">Listen</span><span class="op" id="8485253">(</span><span class="string" id="8485254">&#34;tcp&#34;</span><span class="op" id="8485259">,</span>&nbsp;<span class="ident" id="8485261">laddr</span><span class="op" id="8485266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485269">if</span>&nbsp;<span class="ident" id="8485272">err</span>&nbsp;<span class="op" id="8485276">!=</span>&nbsp;<span class="ident" id="8485279">nil</span>&nbsp;<span class="op" id="8485283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485287">b</span><span class="op" id="8485288">.</span><span class="ident" id="8485289">Fatalf</span><span class="op" id="8485295">(</span><span class="string" id="8485296">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8485315">,</span>&nbsp;<span class="ident" id="8485317">err</span><span class="op" id="8485320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485326">defer</span>&nbsp;<span class="ident" id="8485332">ln</span><span class="op" id="8485334">.</span><span class="ident" id="8485335">Close</span><span class="op" id="8485340">(</span><span class="op" id="8485341">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485344">serverSem</span>&nbsp;<span class="op" id="8485354">:=</span>&nbsp;<span class="builtinfunc" id="8485357">make</span><span class="op" id="8485361">(</span><span class="keyword" id="8485362">chan</span>&nbsp;<span class="builtintype" id="8485367">bool</span><span class="op" id="8485371">,</span>&nbsp;<span class="ident" id="8485373">numConcurrent</span><span class="op" id="8485386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8485389">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485403">go</span>&nbsp;<span class="keyword" id="8485406">func</span><span class="op" id="8485410">(</span><span class="op" id="8485411">)</span>&nbsp;<span class="op" id="8485413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485417">for</span>&nbsp;<span class="op" id="8485421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485426">c</span><span class="op" id="8485427">,</span>&nbsp;<span class="ident" id="8485429">err</span>&nbsp;<span class="op" id="8485433">:=</span>&nbsp;<span class="ident" id="8485436">ln</span><span class="op" id="8485438">.</span><span class="ident" id="8485439">Accept</span><span class="op" id="8485445">(</span><span class="op" id="8485446">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485451">if</span>&nbsp;<span class="ident" id="8485454">err</span>&nbsp;<span class="op" id="8485458">!=</span>&nbsp;<span class="ident" id="8485461">nil</span>&nbsp;<span class="op" id="8485465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485471">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485480">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485485">serverSem</span>&nbsp;<span class="op" id="8485495">&lt;-</span>&nbsp;<span class="builtintype" id="8485498">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8485506">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485531">go</span>&nbsp;<span class="keyword" id="8485534">func</span><span class="op" id="8485538">(</span><span class="ident" id="8485539">c</span>&nbsp;<span class="ident" id="8485541">Conn</span><span class="op" id="8485545">)</span>&nbsp;<span class="op" id="8485547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485553">defer</span>&nbsp;<span class="keyword" id="8485559">func</span><span class="op" id="8485563">(</span><span class="op" id="8485564">)</span>&nbsp;<span class="op" id="8485566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485573">c</span><span class="op" id="8485574">.</span><span class="ident" id="8485575">Close</span><span class="op" id="8485580">(</span><span class="op" id="8485581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485588">&lt;-</span><span class="ident" id="8485590">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485604">}</span><span class="op" id="8485605">(</span><span class="op" id="8485606">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485612">if</span>&nbsp;<span class="ident" id="8485615">timeout</span>&nbsp;<span class="op" id="8485623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485630">c</span><span class="op" id="8485631">.</span><span class="ident" id="8485632">SetDeadline</span><span class="op" id="8485643">(</span><span class="ident" id="8485644">time</span><span class="op" id="8485648">.</span><span class="ident" id="8485649">Now</span><span class="op" id="8485652">(</span><span class="op" id="8485653">)</span><span class="op" id="8485654">.</span><span class="ident" id="8485655">Add</span><span class="op" id="8485658">(</span><span class="ident" id="8485659">time</span><span class="op" id="8485663">.</span><span class="ident" id="8485664">Hour</span><span class="op" id="8485668">)</span><span class="op" id="8485669">)</span>&nbsp;<span class="comment" id="8485671">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485706">var</span>&nbsp;<span class="ident" id="8485710">buf</span>&nbsp;<span class="op" id="8485714">[</span><span class="ident" id="8485715">msgLen</span><span class="op" id="8485721">]</span><span class="builtintype" id="8485722">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485731">for</span>&nbsp;<span class="ident" id="8485735">m</span>&nbsp;<span class="op" id="8485737">:=</span>&nbsp;<span class="num" id="8485740">0</span><span class="op" id="8485741">;</span>&nbsp;<span class="ident" id="8485743">m</span>&nbsp;<span class="op" id="8485745">&lt;</span>&nbsp;<span class="ident" id="8485747">msgs</span><span class="op" id="8485751">;</span>&nbsp;<span class="ident" id="8485753">m</span><span class="op" id="8485754">++</span>&nbsp;<span class="op" id="8485757">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485764">if</span>&nbsp;<span class="op" id="8485767">!</span><span class="ident" id="8485768">recvMsg</span><span class="op" id="8485775">(</span><span class="ident" id="8485776">c</span><span class="op" id="8485777">,</span>&nbsp;<span class="ident" id="8485779">buf</span><span class="op" id="8485782">[</span><span class="op" id="8485783">:</span><span class="op" id="8485784">]</span><span class="op" id="8485785">)</span>&nbsp;<span class="op" id="8485787">||</span>&nbsp;<span class="op" id="8485790">!</span><span class="ident" id="8485791">sendMsg</span><span class="op" id="8485798">(</span><span class="ident" id="8485799">c</span><span class="op" id="8485800">,</span>&nbsp;<span class="ident" id="8485802">buf</span><span class="op" id="8485805">[</span><span class="op" id="8485806">:</span><span class="op" id="8485807">]</span><span class="op" id="8485808">)</span>&nbsp;<span class="op" id="8485810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485818">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485840">}</span><span class="op" id="8485841">(</span><span class="ident" id="8485842">c</span><span class="op" id="8485843">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8485850">}</span><span class="op" id="8485851">(</span><span class="op" id="8485852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485855">clientSem</span>&nbsp;<span class="op" id="8485865">:=</span>&nbsp;<span class="builtinfunc" id="8485868">make</span><span class="op" id="8485872">(</span><span class="keyword" id="8485873">chan</span>&nbsp;<span class="builtintype" id="8485878">bool</span><span class="op" id="8485882">,</span>&nbsp;<span class="ident" id="8485884">numConcurrent</span><span class="op" id="8485897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485900">for</span>&nbsp;<span class="ident" id="8485904">i</span>&nbsp;<span class="op" id="8485906">:=</span>&nbsp;<span class="num" id="8485909">0</span><span class="op" id="8485910">;</span>&nbsp;<span class="ident" id="8485912">i</span>&nbsp;<span class="op" id="8485914">&lt;</span>&nbsp;<span class="ident" id="8485916">conns</span><span class="op" id="8485921">;</span>&nbsp;<span class="ident" id="8485923">i</span><span class="op" id="8485924">++</span>&nbsp;<span class="op" id="8485927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8485931">clientSem</span>&nbsp;<span class="op" id="8485941">&lt;-</span>&nbsp;<span class="builtintype" id="8485944">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8485951">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485975">go</span>&nbsp;<span class="keyword" id="8485978">func</span><span class="op" id="8485982">(</span><span class="op" id="8485983">)</span>&nbsp;<span class="op" id="8485985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8485990">defer</span>&nbsp;<span class="keyword" id="8485996">func</span><span class="op" id="8486000">(</span><span class="op" id="8486001">)</span>&nbsp;<span class="op" id="8486003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486009">&lt;-</span><span class="ident" id="8486011">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486024">}</span><span class="op" id="8486025">(</span><span class="op" id="8486026">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486031">c</span><span class="op" id="8486032">,</span>&nbsp;<span class="ident" id="8486034">err</span>&nbsp;<span class="op" id="8486038">:=</span>&nbsp;<span class="ident" id="8486041">Dial</span><span class="op" id="8486045">(</span><span class="string" id="8486046">&#34;tcp&#34;</span><span class="op" id="8486051">,</span>&nbsp;<span class="ident" id="8486053">ln</span><span class="op" id="8486055">.</span><span class="ident" id="8486056">Addr</span><span class="op" id="8486060">(</span><span class="op" id="8486061">)</span><span class="op" id="8486062">.</span><span class="ident" id="8486063">String</span><span class="op" id="8486069">(</span><span class="op" id="8486070">)</span><span class="op" id="8486071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486076">if</span>&nbsp;<span class="ident" id="8486079">err</span>&nbsp;<span class="op" id="8486083">!=</span>&nbsp;<span class="ident" id="8486086">nil</span>&nbsp;<span class="op" id="8486090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486096">b</span><span class="op" id="8486097">.</span><span class="ident" id="8486098">Logf</span><span class="op" id="8486102">(</span><span class="string" id="8486103">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8486120">,</span>&nbsp;<span class="ident" id="8486122">err</span><span class="op" id="8486125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486131">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486141">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486146">defer</span>&nbsp;<span class="ident" id="8486152">c</span><span class="op" id="8486153">.</span><span class="ident" id="8486154">Close</span><span class="op" id="8486159">(</span><span class="op" id="8486160">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486165">if</span>&nbsp;<span class="ident" id="8486168">timeout</span>&nbsp;<span class="op" id="8486176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486182">c</span><span class="op" id="8486183">.</span><span class="ident" id="8486184">SetDeadline</span><span class="op" id="8486195">(</span><span class="ident" id="8486196">time</span><span class="op" id="8486200">.</span><span class="ident" id="8486201">Now</span><span class="op" id="8486204">(</span><span class="op" id="8486205">)</span><span class="op" id="8486206">.</span><span class="ident" id="8486207">Add</span><span class="op" id="8486210">(</span><span class="ident" id="8486211">time</span><span class="op" id="8486215">.</span><span class="ident" id="8486216">Hour</span><span class="op" id="8486220">)</span><span class="op" id="8486221">)</span>&nbsp;<span class="comment" id="8486223">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486256">var</span>&nbsp;<span class="ident" id="8486260">buf</span>&nbsp;<span class="op" id="8486264">[</span><span class="ident" id="8486265">msgLen</span><span class="op" id="8486271">]</span><span class="builtintype" id="8486272">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486280">for</span>&nbsp;<span class="ident" id="8486284">m</span>&nbsp;<span class="op" id="8486286">:=</span>&nbsp;<span class="num" id="8486289">0</span><span class="op" id="8486290">;</span>&nbsp;<span class="ident" id="8486292">m</span>&nbsp;<span class="op" id="8486294">&lt;</span>&nbsp;<span class="ident" id="8486296">msgs</span><span class="op" id="8486300">;</span>&nbsp;<span class="ident" id="8486302">m</span><span class="op" id="8486303">++</span>&nbsp;<span class="op" id="8486306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486312">if</span>&nbsp;<span class="op" id="8486315">!</span><span class="ident" id="8486316">sendMsg</span><span class="op" id="8486323">(</span><span class="ident" id="8486324">c</span><span class="op" id="8486325">,</span>&nbsp;<span class="ident" id="8486327">buf</span><span class="op" id="8486330">[</span><span class="op" id="8486331">:</span><span class="op" id="8486332">]</span><span class="op" id="8486333">)</span>&nbsp;<span class="op" id="8486335">||</span>&nbsp;<span class="op" id="8486338">!</span><span class="ident" id="8486339">recvMsg</span><span class="op" id="8486346">(</span><span class="ident" id="8486347">c</span><span class="op" id="8486348">,</span>&nbsp;<span class="ident" id="8486350">buf</span><span class="op" id="8486353">[</span><span class="op" id="8486354">:</span><span class="op" id="8486355">]</span><span class="op" id="8486356">)</span>&nbsp;<span class="op" id="8486358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486365">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486380">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486384">}</span><span class="op" id="8486385">(</span><span class="op" id="8486386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486392">for</span>&nbsp;<span class="ident" id="8486396">i</span>&nbsp;<span class="op" id="8486398">:=</span>&nbsp;<span class="num" id="8486401">0</span><span class="op" id="8486402">;</span>&nbsp;<span class="ident" id="8486404">i</span>&nbsp;<span class="op" id="8486406">&lt;</span>&nbsp;<span class="ident" id="8486408">numConcurrent</span><span class="op" id="8486421">;</span>&nbsp;<span class="ident" id="8486423">i</span><span class="op" id="8486424">++</span>&nbsp;<span class="op" id="8486427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486431">clientSem</span>&nbsp;<span class="op" id="8486441">&lt;-</span>&nbsp;<span class="builtintype" id="8486444">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486451">serverSem</span>&nbsp;<span class="op" id="8486461">&lt;-</span>&nbsp;<span class="builtintype" id="8486464">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486470">}</span><br>
<span class="lineno"></span><span class="op" id="8486472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8486475">func</span>&nbsp;<span class="ident" id="8486480">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="8486512">(</span><span class="ident" id="8486513">b</span>&nbsp;<span class="op" id="8486515">*</span><span class="ident" id="8486516">testing</span><span class="op" id="8486523">.</span><span class="ident" id="8486524">B</span><span class="op" id="8486525">)</span>&nbsp;<span class="op" id="8486527">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486530">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8486561">(</span><span class="ident" id="8486562">b</span><span class="op" id="8486563">,</span>&nbsp;<span class="string" id="8486565">&#34;127.0.0.1:0&#34;</span><span class="op" id="8486578">)</span><br>
<span class="lineno">160</span><span class="op" id="8486580">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8486583">func</span>&nbsp;<span class="ident" id="8486588">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="8486620">(</span><span class="ident" id="8486621">b</span>&nbsp;<span class="op" id="8486623">*</span><span class="ident" id="8486624">testing</span><span class="op" id="8486631">.</span><span class="ident" id="8486632">B</span><span class="op" id="8486633">)</span>&nbsp;<span class="op" id="8486635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8486638">if</span>&nbsp;<span class="op" id="8486641">!</span><span class="ident" id="8486642">supportsIPv6</span>&nbsp;<span class="op" id="8486655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486659">b</span><span class="op" id="8486660">.</span><span class="ident" id="8486661">Skip</span><span class="op" id="8486665">(</span><span class="string" id="8486666">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8486689">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8486692">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8486695">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8486726">(</span><span class="ident" id="8486727">b</span><span class="op" id="8486728">,</span>&nbsp;<span class="string" id="8486730">&#34;[::1]:0&#34;</span><span class="op" id="8486739">)</span><br>
<span class="lineno"></span><span class="op" id="8486741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8486744">func</span>&nbsp;<span class="ident" id="8486749">benchmarkTCPConcurrentReadWrite</span><span class="op" id="8486780">(</span><span class="ident" id="8486781">b</span>&nbsp;<span class="op" id="8486783">*</span><span class="ident" id="8486784">testing</span><span class="op" id="8486791">.</span><span class="ident" id="8486792">B</span><span class="op" id="8486793">,</span>&nbsp;<span class="ident" id="8486795">laddr</span>&nbsp;<span class="builtintype" id="8486801">string</span><span class="op" id="8486807">)</span>&nbsp;<span class="op" id="8486809">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8486812">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8486870">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8486953">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8487035">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487086">b</span><span class="op" id="8487087">.</span><span class="ident" id="8487088">StopTimer</span><span class="op" id="8487097">(</span><span class="op" id="8487098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487102">P</span>&nbsp;<span class="op" id="8487104">:=</span>&nbsp;<span class="ident" id="8487107">runtime</span><span class="op" id="8487114">.</span><span class="ident" id="8487115">GOMAXPROCS</span><span class="op" id="8487125">(</span><span class="num" id="8487126">0</span><span class="op" id="8487127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487130">N</span>&nbsp;<span class="op" id="8487132">:=</span>&nbsp;<span class="ident" id="8487135">b</span><span class="op" id="8487136">.</span><span class="ident" id="8487137">N</span>&nbsp;<span class="op" id="8487139">/</span>&nbsp;<span class="ident" id="8487141">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487144">W</span>&nbsp;<span class="op" id="8487146">:=</span>&nbsp;<span class="num" id="8487149">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8487156">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487195">clients</span>&nbsp;<span class="op" id="8487203">:=</span>&nbsp;<span class="builtinfunc" id="8487206">make</span><span class="op" id="8487210">(</span><span class="op" id="8487211">[</span><span class="op" id="8487212">]</span><span class="ident" id="8487213">Conn</span><span class="op" id="8487217">,</span>&nbsp;<span class="ident" id="8487219">P</span><span class="op" id="8487220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487223">servers</span>&nbsp;<span class="op" id="8487231">:=</span>&nbsp;<span class="builtinfunc" id="8487234">make</span><span class="op" id="8487238">(</span><span class="op" id="8487239">[</span><span class="op" id="8487240">]</span><span class="ident" id="8487241">Conn</span><span class="op" id="8487245">,</span>&nbsp;<span class="ident" id="8487247">P</span><span class="op" id="8487248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487251">ln</span><span class="op" id="8487253">,</span>&nbsp;<span class="ident" id="8487255">err</span>&nbsp;<span class="op" id="8487259">:=</span>&nbsp;<span class="ident" id="8487262">Listen</span><span class="op" id="8487268">(</span><span class="string" id="8487269">&#34;tcp&#34;</span><span class="op" id="8487274">,</span>&nbsp;<span class="ident" id="8487276">laddr</span><span class="op" id="8487281">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487284">if</span>&nbsp;<span class="ident" id="8487287">err</span>&nbsp;<span class="op" id="8487291">!=</span>&nbsp;<span class="ident" id="8487294">nil</span>&nbsp;<span class="op" id="8487298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487302">b</span><span class="op" id="8487303">.</span><span class="ident" id="8487304">Fatalf</span><span class="op" id="8487310">(</span><span class="string" id="8487311">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8487330">,</span>&nbsp;<span class="ident" id="8487332">err</span><span class="op" id="8487335">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487341">defer</span>&nbsp;<span class="ident" id="8487347">ln</span><span class="op" id="8487349">.</span><span class="ident" id="8487350">Close</span><span class="op" id="8487355">(</span><span class="op" id="8487356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487359">done</span>&nbsp;<span class="op" id="8487364">:=</span>&nbsp;<span class="builtinfunc" id="8487367">make</span><span class="op" id="8487371">(</span><span class="keyword" id="8487372">chan</span>&nbsp;<span class="builtintype" id="8487377">bool</span><span class="op" id="8487381">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487384">go</span>&nbsp;<span class="keyword" id="8487387">func</span><span class="op" id="8487391">(</span><span class="op" id="8487392">)</span>&nbsp;<span class="op" id="8487394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487398">for</span>&nbsp;<span class="ident" id="8487402">p</span>&nbsp;<span class="op" id="8487404">:=</span>&nbsp;<span class="num" id="8487407">0</span><span class="op" id="8487408">;</span>&nbsp;<span class="ident" id="8487410">p</span>&nbsp;<span class="op" id="8487412">&lt;</span>&nbsp;<span class="ident" id="8487414">P</span><span class="op" id="8487415">;</span>&nbsp;<span class="ident" id="8487417">p</span><span class="op" id="8487418">++</span>&nbsp;<span class="op" id="8487421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487426">s</span><span class="op" id="8487427">,</span>&nbsp;<span class="ident" id="8487429">err</span>&nbsp;<span class="op" id="8487433">:=</span>&nbsp;<span class="ident" id="8487436">ln</span><span class="op" id="8487438">.</span><span class="ident" id="8487439">Accept</span><span class="op" id="8487445">(</span><span class="op" id="8487446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487451">if</span>&nbsp;<span class="ident" id="8487454">err</span>&nbsp;<span class="op" id="8487458">!=</span>&nbsp;<span class="ident" id="8487461">nil</span>&nbsp;<span class="op" id="8487465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487471">b</span><span class="op" id="8487472">.</span><span class="ident" id="8487473">Errorf</span><span class="op" id="8487479">(</span><span class="string" id="8487480">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8487499">,</span>&nbsp;<span class="ident" id="8487501">err</span><span class="op" id="8487504">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487510">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487525">servers</span><span class="op" id="8487532">[</span><span class="ident" id="8487533">p</span><span class="op" id="8487534">]</span>&nbsp;<span class="op" id="8487536">=</span>&nbsp;<span class="ident" id="8487538">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487546">done</span>&nbsp;<span class="op" id="8487551">&lt;-</span>&nbsp;<span class="builtintype" id="8487554">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487560">}</span><span class="op" id="8487561">(</span><span class="op" id="8487562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487565">for</span>&nbsp;<span class="ident" id="8487569">p</span>&nbsp;<span class="op" id="8487571">:=</span>&nbsp;<span class="num" id="8487574">0</span><span class="op" id="8487575">;</span>&nbsp;<span class="ident" id="8487577">p</span>&nbsp;<span class="op" id="8487579">&lt;</span>&nbsp;<span class="ident" id="8487581">P</span><span class="op" id="8487582">;</span>&nbsp;<span class="ident" id="8487584">p</span><span class="op" id="8487585">++</span>&nbsp;<span class="op" id="8487588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487592">c</span><span class="op" id="8487593">,</span>&nbsp;<span class="ident" id="8487595">err</span>&nbsp;<span class="op" id="8487599">:=</span>&nbsp;<span class="ident" id="8487602">Dial</span><span class="op" id="8487606">(</span><span class="string" id="8487607">&#34;tcp&#34;</span><span class="op" id="8487612">,</span>&nbsp;<span class="ident" id="8487614">ln</span><span class="op" id="8487616">.</span><span class="ident" id="8487617">Addr</span><span class="op" id="8487621">(</span><span class="op" id="8487622">)</span><span class="op" id="8487623">.</span><span class="ident" id="8487624">String</span><span class="op" id="8487630">(</span><span class="op" id="8487631">)</span><span class="op" id="8487632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487636">if</span>&nbsp;<span class="ident" id="8487639">err</span>&nbsp;<span class="op" id="8487643">!=</span>&nbsp;<span class="ident" id="8487646">nil</span>&nbsp;<span class="op" id="8487650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487655">b</span><span class="op" id="8487656">.</span><span class="ident" id="8487657">Fatalf</span><span class="op" id="8487663">(</span><span class="string" id="8487664">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8487681">,</span>&nbsp;<span class="ident" id="8487683">err</span><span class="op" id="8487686">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487694">clients</span><span class="op" id="8487701">[</span><span class="ident" id="8487702">p</span><span class="op" id="8487703">]</span>&nbsp;<span class="op" id="8487705">=</span>&nbsp;<span class="ident" id="8487707">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487713">&lt;-</span><span class="ident" id="8487715">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487722">b</span><span class="op" id="8487723">.</span><span class="ident" id="8487724">StartTimer</span><span class="op" id="8487734">(</span><span class="op" id="8487735">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487739">var</span>&nbsp;<span class="ident" id="8487743">wg</span>&nbsp;<span class="ident" id="8487746">sync</span><span class="op" id="8487750">.</span><span class="ident" id="8487751">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487762">wg</span><span class="op" id="8487764">.</span><span class="ident" id="8487765">Add</span><span class="op" id="8487768">(</span><span class="num" id="8487769">4</span>&nbsp;<span class="op" id="8487771">*</span>&nbsp;<span class="ident" id="8487773">P</span><span class="op" id="8487774">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487777">for</span>&nbsp;<span class="ident" id="8487781">p</span>&nbsp;<span class="op" id="8487783">:=</span>&nbsp;<span class="num" id="8487786">0</span><span class="op" id="8487787">;</span>&nbsp;<span class="ident" id="8487789">p</span>&nbsp;<span class="op" id="8487791">&lt;</span>&nbsp;<span class="ident" id="8487793">P</span><span class="op" id="8487794">;</span>&nbsp;<span class="ident" id="8487796">p</span><span class="op" id="8487797">++</span>&nbsp;<span class="op" id="8487800">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8487804">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487824">go</span>&nbsp;<span class="keyword" id="8487827">func</span><span class="op" id="8487831">(</span><span class="ident" id="8487832">c</span>&nbsp;<span class="ident" id="8487834">Conn</span><span class="op" id="8487838">)</span>&nbsp;<span class="op" id="8487840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487845">defer</span>&nbsp;<span class="ident" id="8487851">wg</span><span class="op" id="8487853">.</span><span class="ident" id="8487854">Done</span><span class="op" id="8487858">(</span><span class="op" id="8487859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487864">var</span>&nbsp;<span class="ident" id="8487868">buf</span>&nbsp;<span class="op" id="8487872">[</span><span class="num" id="8487873">1</span><span class="op" id="8487874">]</span><span class="builtintype" id="8487875">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487883">for</span>&nbsp;<span class="ident" id="8487887">i</span>&nbsp;<span class="op" id="8487889">:=</span>&nbsp;<span class="num" id="8487892">0</span><span class="op" id="8487893">;</span>&nbsp;<span class="ident" id="8487895">i</span>&nbsp;<span class="op" id="8487897">&lt;</span>&nbsp;<span class="ident" id="8487899">N</span><span class="op" id="8487900">;</span>&nbsp;<span class="ident" id="8487902">i</span><span class="op" id="8487903">++</span>&nbsp;<span class="op" id="8487906">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487912">v</span>&nbsp;<span class="op" id="8487914">:=</span>&nbsp;<span class="builtintype" id="8487917">byte</span><span class="op" id="8487921">(</span><span class="ident" id="8487922">i</span><span class="op" id="8487923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8487929">for</span>&nbsp;<span class="ident" id="8487933">w</span>&nbsp;<span class="op" id="8487935">:=</span>&nbsp;<span class="num" id="8487938">0</span><span class="op" id="8487939">;</span>&nbsp;<span class="ident" id="8487941">w</span>&nbsp;<span class="op" id="8487943">&lt;</span>&nbsp;<span class="ident" id="8487945">W</span><span class="op" id="8487946">;</span>&nbsp;<span class="ident" id="8487948">w</span><span class="op" id="8487949">++</span>&nbsp;<span class="op" id="8487952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487959">v</span>&nbsp;<span class="op" id="8487961">*=</span>&nbsp;<span class="ident" id="8487964">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8487970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487976">buf</span><span class="op" id="8487979">[</span><span class="num" id="8487980">0</span><span class="op" id="8487981">]</span>&nbsp;<span class="op" id="8487983">=</span>&nbsp;<span class="ident" id="8487985">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8487991">_</span><span class="op" id="8487992">,</span>&nbsp;<span class="ident" id="8487994">err</span>&nbsp;<span class="op" id="8487998">:=</span>&nbsp;<span class="ident" id="8488001">c</span><span class="op" id="8488002">.</span><span class="ident" id="8488003">Write</span><span class="op" id="8488008">(</span><span class="ident" id="8488009">buf</span><span class="op" id="8488012">[</span><span class="op" id="8488013">:</span><span class="op" id="8488014">]</span><span class="op" id="8488015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488021">if</span>&nbsp;<span class="ident" id="8488024">err</span>&nbsp;<span class="op" id="8488028">!=</span>&nbsp;<span class="ident" id="8488031">nil</span>&nbsp;<span class="op" id="8488035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488042">b</span><span class="op" id="8488043">.</span><span class="ident" id="8488044">Errorf</span><span class="op" id="8488050">(</span><span class="string" id="8488051">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8488069">,</span>&nbsp;<span class="ident" id="8488071">err</span><span class="op" id="8488074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488081">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488092">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488101">}</span><span class="op" id="8488102">(</span><span class="ident" id="8488103">clients</span><span class="op" id="8488110">[</span><span class="ident" id="8488111">p</span><span class="op" id="8488112">]</span><span class="op" id="8488113">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8488118">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488169">pipe</span>&nbsp;<span class="op" id="8488174">:=</span>&nbsp;<span class="builtinfunc" id="8488177">make</span><span class="op" id="8488181">(</span><span class="keyword" id="8488182">chan</span>&nbsp;<span class="builtintype" id="8488187">byte</span><span class="op" id="8488191">,</span>&nbsp;<span class="num" id="8488193">128</span><span class="op" id="8488196">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8488201">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488221">go</span>&nbsp;<span class="keyword" id="8488224">func</span><span class="op" id="8488228">(</span><span class="ident" id="8488229">s</span>&nbsp;<span class="ident" id="8488231">Conn</span><span class="op" id="8488235">)</span>&nbsp;<span class="op" id="8488237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488242">defer</span>&nbsp;<span class="ident" id="8488248">wg</span><span class="op" id="8488250">.</span><span class="ident" id="8488251">Done</span><span class="op" id="8488255">(</span><span class="op" id="8488256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488261">var</span>&nbsp;<span class="ident" id="8488265">buf</span>&nbsp;<span class="op" id="8488269">[</span><span class="num" id="8488270">1</span><span class="op" id="8488271">]</span><span class="builtintype" id="8488272">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488280">for</span>&nbsp;<span class="ident" id="8488284">i</span>&nbsp;<span class="op" id="8488286">:=</span>&nbsp;<span class="num" id="8488289">0</span><span class="op" id="8488290">;</span>&nbsp;<span class="ident" id="8488292">i</span>&nbsp;<span class="op" id="8488294">&lt;</span>&nbsp;<span class="ident" id="8488296">N</span><span class="op" id="8488297">;</span>&nbsp;<span class="ident" id="8488299">i</span><span class="op" id="8488300">++</span>&nbsp;<span class="op" id="8488303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488309">_</span><span class="op" id="8488310">,</span>&nbsp;<span class="ident" id="8488312">err</span>&nbsp;<span class="op" id="8488316">:=</span>&nbsp;<span class="ident" id="8488319">s</span><span class="op" id="8488320">.</span><span class="ident" id="8488321">Read</span><span class="op" id="8488325">(</span><span class="ident" id="8488326">buf</span><span class="op" id="8488329">[</span><span class="op" id="8488330">:</span><span class="op" id="8488331">]</span><span class="op" id="8488332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488338">if</span>&nbsp;<span class="ident" id="8488341">err</span>&nbsp;<span class="op" id="8488345">!=</span>&nbsp;<span class="ident" id="8488348">nil</span>&nbsp;<span class="op" id="8488352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488359">b</span><span class="op" id="8488360">.</span><span class="ident" id="8488361">Errorf</span><span class="op" id="8488367">(</span><span class="string" id="8488368">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8488385">,</span>&nbsp;<span class="ident" id="8488387">err</span><span class="op" id="8488390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488397">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488414">pipe</span>&nbsp;<span class="op" id="8488419">&lt;-</span>&nbsp;<span class="ident" id="8488422">buf</span><span class="op" id="8488425">[</span><span class="num" id="8488426">0</span><span class="op" id="8488427">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488436">}</span><span class="op" id="8488437">(</span><span class="ident" id="8488438">servers</span><span class="op" id="8488445">[</span><span class="ident" id="8488446">p</span><span class="op" id="8488447">]</span><span class="op" id="8488448">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8488453">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488473">go</span>&nbsp;<span class="keyword" id="8488476">func</span><span class="op" id="8488480">(</span><span class="ident" id="8488481">s</span>&nbsp;<span class="ident" id="8488483">Conn</span><span class="op" id="8488487">)</span>&nbsp;<span class="op" id="8488489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488494">defer</span>&nbsp;<span class="ident" id="8488500">wg</span><span class="op" id="8488502">.</span><span class="ident" id="8488503">Done</span><span class="op" id="8488507">(</span><span class="op" id="8488508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488513">var</span>&nbsp;<span class="ident" id="8488517">buf</span>&nbsp;<span class="op" id="8488521">[</span><span class="num" id="8488522">1</span><span class="op" id="8488523">]</span><span class="builtintype" id="8488524">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488532">for</span>&nbsp;<span class="ident" id="8488536">i</span>&nbsp;<span class="op" id="8488538">:=</span>&nbsp;<span class="num" id="8488541">0</span><span class="op" id="8488542">;</span>&nbsp;<span class="ident" id="8488544">i</span>&nbsp;<span class="op" id="8488546">&lt;</span>&nbsp;<span class="ident" id="8488548">N</span><span class="op" id="8488549">;</span>&nbsp;<span class="ident" id="8488551">i</span><span class="op" id="8488552">++</span>&nbsp;<span class="op" id="8488555">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488561">v</span>&nbsp;<span class="op" id="8488563">:=</span>&nbsp;<span class="op" id="8488566">&lt;-</span><span class="ident" id="8488568">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488577">for</span>&nbsp;<span class="ident" id="8488581">w</span>&nbsp;<span class="op" id="8488583">:=</span>&nbsp;<span class="num" id="8488586">0</span><span class="op" id="8488587">;</span>&nbsp;<span class="ident" id="8488589">w</span>&nbsp;<span class="op" id="8488591">&lt;</span>&nbsp;<span class="ident" id="8488593">W</span><span class="op" id="8488594">;</span>&nbsp;<span class="ident" id="8488596">w</span><span class="op" id="8488597">++</span>&nbsp;<span class="op" id="8488600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488607">v</span>&nbsp;<span class="op" id="8488609">*=</span>&nbsp;<span class="ident" id="8488612">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488618">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488624">buf</span><span class="op" id="8488627">[</span><span class="num" id="8488628">0</span><span class="op" id="8488629">]</span>&nbsp;<span class="op" id="8488631">=</span>&nbsp;<span class="ident" id="8488633">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488639">_</span><span class="op" id="8488640">,</span>&nbsp;<span class="ident" id="8488642">err</span>&nbsp;<span class="op" id="8488646">:=</span>&nbsp;<span class="ident" id="8488649">s</span><span class="op" id="8488650">.</span><span class="ident" id="8488651">Write</span><span class="op" id="8488656">(</span><span class="ident" id="8488657">buf</span><span class="op" id="8488660">[</span><span class="op" id="8488661">:</span><span class="op" id="8488662">]</span><span class="op" id="8488663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488669">if</span>&nbsp;<span class="ident" id="8488672">err</span>&nbsp;<span class="op" id="8488676">!=</span>&nbsp;<span class="ident" id="8488679">nil</span>&nbsp;<span class="op" id="8488683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488690">b</span><span class="op" id="8488691">.</span><span class="ident" id="8488692">Errorf</span><span class="op" id="8488698">(</span><span class="string" id="8488699">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8488717">,</span>&nbsp;<span class="ident" id="8488719">err</span><span class="op" id="8488722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488729">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488740">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488750">s</span><span class="op" id="8488751">.</span><span class="ident" id="8488752">Close</span><span class="op" id="8488757">(</span><span class="op" id="8488758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488762">}</span><span class="op" id="8488763">(</span><span class="ident" id="8488764">servers</span><span class="op" id="8488771">[</span><span class="ident" id="8488772">p</span><span class="op" id="8488773">]</span><span class="op" id="8488774">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8488779">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488799">go</span>&nbsp;<span class="keyword" id="8488802">func</span><span class="op" id="8488806">(</span><span class="ident" id="8488807">c</span>&nbsp;<span class="ident" id="8488809">Conn</span><span class="op" id="8488813">)</span>&nbsp;<span class="op" id="8488815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488820">defer</span>&nbsp;<span class="ident" id="8488826">wg</span><span class="op" id="8488828">.</span><span class="ident" id="8488829">Done</span><span class="op" id="8488833">(</span><span class="op" id="8488834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488839">var</span>&nbsp;<span class="ident" id="8488843">buf</span>&nbsp;<span class="op" id="8488847">[</span><span class="num" id="8488848">1</span><span class="op" id="8488849">]</span><span class="builtintype" id="8488850">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488858">for</span>&nbsp;<span class="ident" id="8488862">i</span>&nbsp;<span class="op" id="8488864">:=</span>&nbsp;<span class="num" id="8488867">0</span><span class="op" id="8488868">;</span>&nbsp;<span class="ident" id="8488870">i</span>&nbsp;<span class="op" id="8488872">&lt;</span>&nbsp;<span class="ident" id="8488874">N</span><span class="op" id="8488875">;</span>&nbsp;<span class="ident" id="8488877">i</span><span class="op" id="8488878">++</span>&nbsp;<span class="op" id="8488881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488887">_</span><span class="op" id="8488888">,</span>&nbsp;<span class="ident" id="8488890">err</span>&nbsp;<span class="op" id="8488894">:=</span>&nbsp;<span class="ident" id="8488897">c</span><span class="op" id="8488898">.</span><span class="ident" id="8488899">Read</span><span class="op" id="8488903">(</span><span class="ident" id="8488904">buf</span><span class="op" id="8488907">[</span><span class="op" id="8488908">:</span><span class="op" id="8488909">]</span><span class="op" id="8488910">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488916">if</span>&nbsp;<span class="ident" id="8488919">err</span>&nbsp;<span class="op" id="8488923">!=</span>&nbsp;<span class="ident" id="8488926">nil</span>&nbsp;<span class="op" id="8488930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488937">b</span><span class="op" id="8488938">.</span><span class="ident" id="8488939">Errorf</span><span class="op" id="8488945">(</span><span class="string" id="8488946">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8488963">,</span>&nbsp;<span class="ident" id="8488965">err</span><span class="op" id="8488968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8488975">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8488991">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8488996">c</span><span class="op" id="8488997">.</span><span class="ident" id="8488998">Close</span><span class="op" id="8489003">(</span><span class="op" id="8489004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489008">}</span><span class="op" id="8489009">(</span><span class="ident" id="8489010">clients</span><span class="op" id="8489017">[</span><span class="ident" id="8489018">p</span><span class="op" id="8489019">]</span><span class="op" id="8489020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489026">wg</span><span class="op" id="8489028">.</span><span class="ident" id="8489029">Wait</span><span class="op" id="8489033">(</span><span class="op" id="8489034">)</span><br>
<span class="lineno"></span><span class="op" id="8489036">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="8489039">type</span>&nbsp;<span class="ident" id="8489044">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="8489063">struct</span>&nbsp;<span class="op" id="8489070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489073">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8489087">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489095">litAddrOrName</span>&nbsp;<span class="builtintype" id="8489109">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489117">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="8489131">*</span><span class="ident" id="8489132">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8489141">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8489155">error</span><br>
<span class="lineno"></span><span class="op" id="8489161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8489164">var</span>&nbsp;<span class="ident" id="8489168">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8489188">=</span>&nbsp;<span class="op" id="8489190">[</span><span class="op" id="8489191">]</span><span class="ident" id="8489192">resolveTCPAddrTest</span><span class="op" id="8489210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489213">{</span><span class="string" id="8489214">&#34;tcp&#34;</span><span class="op" id="8489219">,</span>&nbsp;<span class="string" id="8489221">&#34;127.0.0.1:0&#34;</span><span class="op" id="8489234">,</span>&nbsp;<span class="op" id="8489236">&amp;</span><span class="ident" id="8489237">TCPAddr</span><span class="op" id="8489244">{</span><span class="ident" id="8489245">IP</span><span class="op" id="8489247">:</span>&nbsp;<span class="ident" id="8489249">IPv4</span><span class="op" id="8489253">(</span><span class="num" id="8489254">127</span><span class="op" id="8489257">,</span>&nbsp;<span class="num" id="8489259">0</span><span class="op" id="8489260">,</span>&nbsp;<span class="num" id="8489262">0</span><span class="op" id="8489263">,</span>&nbsp;<span class="num" id="8489265">1</span><span class="op" id="8489266">)</span><span class="op" id="8489267">,</span>&nbsp;<span class="ident" id="8489269">Port</span><span class="op" id="8489273">:</span>&nbsp;<span class="num" id="8489275">0</span><span class="op" id="8489276">}</span><span class="op" id="8489277">,</span>&nbsp;<span class="ident" id="8489279">nil</span><span class="op" id="8489282">}</span><span class="op" id="8489283">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489286">{</span><span class="string" id="8489287">&#34;tcp4&#34;</span><span class="op" id="8489293">,</span>&nbsp;<span class="string" id="8489295">&#34;127.0.0.1:65535&#34;</span><span class="op" id="8489312">,</span>&nbsp;<span class="op" id="8489314">&amp;</span><span class="ident" id="8489315">TCPAddr</span><span class="op" id="8489322">{</span><span class="ident" id="8489323">IP</span><span class="op" id="8489325">:</span>&nbsp;<span class="ident" id="8489327">IPv4</span><span class="op" id="8489331">(</span><span class="num" id="8489332">127</span><span class="op" id="8489335">,</span>&nbsp;<span class="num" id="8489337">0</span><span class="op" id="8489338">,</span>&nbsp;<span class="num" id="8489340">0</span><span class="op" id="8489341">,</span>&nbsp;<span class="num" id="8489343">1</span><span class="op" id="8489344">)</span><span class="op" id="8489345">,</span>&nbsp;<span class="ident" id="8489347">Port</span><span class="op" id="8489351">:</span>&nbsp;<span class="num" id="8489353">65535</span><span class="op" id="8489358">}</span><span class="op" id="8489359">,</span>&nbsp;<span class="ident" id="8489361">nil</span><span class="op" id="8489364">}</span><span class="op" id="8489365">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489369">{</span><span class="string" id="8489370">&#34;tcp&#34;</span><span class="op" id="8489375">,</span>&nbsp;<span class="string" id="8489377">&#34;[::1]:1&#34;</span><span class="op" id="8489386">,</span>&nbsp;<span class="op" id="8489388">&amp;</span><span class="ident" id="8489389">TCPAddr</span><span class="op" id="8489396">{</span><span class="ident" id="8489397">IP</span><span class="op" id="8489399">:</span>&nbsp;<span class="ident" id="8489401">ParseIP</span><span class="op" id="8489408">(</span><span class="string" id="8489409">&#34;::1&#34;</span><span class="op" id="8489414">)</span><span class="op" id="8489415">,</span>&nbsp;<span class="ident" id="8489417">Port</span><span class="op" id="8489421">:</span>&nbsp;<span class="num" id="8489423">1</span><span class="op" id="8489424">}</span><span class="op" id="8489425">,</span>&nbsp;<span class="ident" id="8489427">nil</span><span class="op" id="8489430">}</span><span class="op" id="8489431">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489434">{</span><span class="string" id="8489435">&#34;tcp6&#34;</span><span class="op" id="8489441">,</span>&nbsp;<span class="string" id="8489443">&#34;[::1]:65534&#34;</span><span class="op" id="8489456">,</span>&nbsp;<span class="op" id="8489458">&amp;</span><span class="ident" id="8489459">TCPAddr</span><span class="op" id="8489466">{</span><span class="ident" id="8489467">IP</span><span class="op" id="8489469">:</span>&nbsp;<span class="ident" id="8489471">ParseIP</span><span class="op" id="8489478">(</span><span class="string" id="8489479">&#34;::1&#34;</span><span class="op" id="8489484">)</span><span class="op" id="8489485">,</span>&nbsp;<span class="ident" id="8489487">Port</span><span class="op" id="8489491">:</span>&nbsp;<span class="num" id="8489493">65534</span><span class="op" id="8489498">}</span><span class="op" id="8489499">,</span>&nbsp;<span class="ident" id="8489501">nil</span><span class="op" id="8489504">}</span><span class="op" id="8489505">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489509">{</span><span class="string" id="8489510">&#34;tcp&#34;</span><span class="op" id="8489515">,</span>&nbsp;<span class="string" id="8489517">&#34;[::1%en0]:1&#34;</span><span class="op" id="8489530">,</span>&nbsp;<span class="op" id="8489532">&amp;</span><span class="ident" id="8489533">TCPAddr</span><span class="op" id="8489540">{</span><span class="ident" id="8489541">IP</span><span class="op" id="8489543">:</span>&nbsp;<span class="ident" id="8489545">ParseIP</span><span class="op" id="8489552">(</span><span class="string" id="8489553">&#34;::1&#34;</span><span class="op" id="8489558">)</span><span class="op" id="8489559">,</span>&nbsp;<span class="ident" id="8489561">Port</span><span class="op" id="8489565">:</span>&nbsp;<span class="num" id="8489567">1</span><span class="op" id="8489568">,</span>&nbsp;<span class="ident" id="8489570">Zone</span><span class="op" id="8489574">:</span>&nbsp;<span class="string" id="8489576">&#34;en0&#34;</span><span class="op" id="8489581">}</span><span class="op" id="8489582">,</span>&nbsp;<span class="ident" id="8489584">nil</span><span class="op" id="8489587">}</span><span class="op" id="8489588">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489591">{</span><span class="string" id="8489592">&#34;tcp6&#34;</span><span class="op" id="8489598">,</span>&nbsp;<span class="string" id="8489600">&#34;[::1%911]:2&#34;</span><span class="op" id="8489613">,</span>&nbsp;<span class="op" id="8489615">&amp;</span><span class="ident" id="8489616">TCPAddr</span><span class="op" id="8489623">{</span><span class="ident" id="8489624">IP</span><span class="op" id="8489626">:</span>&nbsp;<span class="ident" id="8489628">ParseIP</span><span class="op" id="8489635">(</span><span class="string" id="8489636">&#34;::1&#34;</span><span class="op" id="8489641">)</span><span class="op" id="8489642">,</span>&nbsp;<span class="ident" id="8489644">Port</span><span class="op" id="8489648">:</span>&nbsp;<span class="num" id="8489650">2</span><span class="op" id="8489651">,</span>&nbsp;<span class="ident" id="8489653">Zone</span><span class="op" id="8489657">:</span>&nbsp;<span class="string" id="8489659">&#34;911&#34;</span><span class="op" id="8489664">}</span><span class="op" id="8489665">,</span>&nbsp;<span class="ident" id="8489667">nil</span><span class="op" id="8489670">}</span><span class="op" id="8489671">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489675">{</span><span class="string" id="8489676">&#34;&#34;</span><span class="op" id="8489678">,</span>&nbsp;<span class="string" id="8489680">&#34;127.0.0.1:0&#34;</span><span class="op" id="8489693">,</span>&nbsp;<span class="op" id="8489695">&amp;</span><span class="ident" id="8489696">TCPAddr</span><span class="op" id="8489703">{</span><span class="ident" id="8489704">IP</span><span class="op" id="8489706">:</span>&nbsp;<span class="ident" id="8489708">IPv4</span><span class="op" id="8489712">(</span><span class="num" id="8489713">127</span><span class="op" id="8489716">,</span>&nbsp;<span class="num" id="8489718">0</span><span class="op" id="8489719">,</span>&nbsp;<span class="num" id="8489721">0</span><span class="op" id="8489722">,</span>&nbsp;<span class="num" id="8489724">1</span><span class="op" id="8489725">)</span><span class="op" id="8489726">,</span>&nbsp;<span class="ident" id="8489728">Port</span><span class="op" id="8489732">:</span>&nbsp;<span class="num" id="8489734">0</span><span class="op" id="8489735">}</span><span class="op" id="8489736">,</span>&nbsp;<span class="ident" id="8489738">nil</span><span class="op" id="8489741">}</span><span class="op" id="8489742">,</span>&nbsp;<span class="comment" id="8489744">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489764">{</span><span class="string" id="8489765">&#34;&#34;</span><span class="op" id="8489767">,</span>&nbsp;<span class="string" id="8489769">&#34;[::1]:0&#34;</span><span class="op" id="8489778">,</span>&nbsp;<span class="op" id="8489780">&amp;</span><span class="ident" id="8489781">TCPAddr</span><span class="op" id="8489788">{</span><span class="ident" id="8489789">IP</span><span class="op" id="8489791">:</span>&nbsp;<span class="ident" id="8489793">ParseIP</span><span class="op" id="8489800">(</span><span class="string" id="8489801">&#34;::1&#34;</span><span class="op" id="8489806">)</span><span class="op" id="8489807">,</span>&nbsp;<span class="ident" id="8489809">Port</span><span class="op" id="8489813">:</span>&nbsp;<span class="num" id="8489815">0</span><span class="op" id="8489816">}</span><span class="op" id="8489817">,</span>&nbsp;<span class="ident" id="8489819">nil</span><span class="op" id="8489822">}</span><span class="op" id="8489823">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="8489833">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489854">{</span><span class="string" id="8489855">&#34;tcp&#34;</span><span class="op" id="8489860">,</span>&nbsp;<span class="string" id="8489862">&#34;:12345&#34;</span><span class="op" id="8489870">,</span>&nbsp;<span class="op" id="8489872">&amp;</span><span class="ident" id="8489873">TCPAddr</span><span class="op" id="8489880">{</span><span class="ident" id="8489881">Port</span><span class="op" id="8489885">:</span>&nbsp;<span class="num" id="8489887">12345</span><span class="op" id="8489892">}</span><span class="op" id="8489893">,</span>&nbsp;<span class="ident" id="8489895">nil</span><span class="op" id="8489898">}</span><span class="op" id="8489899">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8489903">{</span><span class="string" id="8489904">&#34;http&#34;</span><span class="op" id="8489910">,</span>&nbsp;<span class="string" id="8489912">&#34;127.0.0.1:0&#34;</span><span class="op" id="8489925">,</span>&nbsp;<span class="ident" id="8489927">nil</span><span class="op" id="8489930">,</span>&nbsp;<span class="ident" id="8489932">UnknownNetworkError</span><span class="op" id="8489951">(</span><span class="string" id="8489952">&#34;http&#34;</span><span class="op" id="8489958">)</span><span class="op" id="8489959">}</span><span class="op" id="8489960">,</span><br>
<span class="lineno"></span><span class="op" id="8489962">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="8489965">func</span>&nbsp;<span class="ident" id="8489970">init</span><span class="op" id="8489974">(</span><span class="op" id="8489975">)</span>&nbsp;<span class="op" id="8489977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8489980">if</span>&nbsp;<span class="ident" id="8489983">ifi</span>&nbsp;<span class="op" id="8489987">:=</span>&nbsp;<span class="ident" id="8489990">loopbackInterface</span><span class="op" id="8490007">(</span><span class="op" id="8490008">)</span><span class="op" id="8490009">;</span>&nbsp;<span class="ident" id="8490011">ifi</span>&nbsp;<span class="op" id="8490015">!=</span>&nbsp;<span class="ident" id="8490018">nil</span>&nbsp;<span class="op" id="8490022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490026">index</span>&nbsp;<span class="op" id="8490032">:=</span>&nbsp;<span class="ident" id="8490035">fmt</span><span class="op" id="8490038">.</span><span class="ident" id="8490039">Sprintf</span><span class="op" id="8490046">(</span><span class="string" id="8490047">&#34;%v&#34;</span><span class="op" id="8490051">,</span>&nbsp;<span class="ident" id="8490053">ifi</span><span class="op" id="8490056">.</span><span class="ident" id="8490057">Index</span><span class="op" id="8490062">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490066">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8490086">=</span>&nbsp;<span class="builtinfunc" id="8490088">append</span><span class="op" id="8490094">(</span><span class="ident" id="8490095">resolveTCPAddrTests</span><span class="op" id="8490114">,</span>&nbsp;<span class="op" id="8490116">[</span><span class="op" id="8490117">]</span><span class="ident" id="8490118">resolveTCPAddrTest</span><span class="op" id="8490136">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490141">{</span><span class="string" id="8490142">&#34;tcp6&#34;</span><span class="op" id="8490148">,</span>&nbsp;<span class="string" id="8490150">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8490162">+</span>&nbsp;<span class="ident" id="8490164">ifi</span><span class="op" id="8490167">.</span><span class="ident" id="8490168">Name</span>&nbsp;<span class="op" id="8490173">+</span>&nbsp;<span class="string" id="8490175">&#34;]:3&#34;</span><span class="op" id="8490180">,</span>&nbsp;<span class="op" id="8490182">&amp;</span><span class="ident" id="8490183">TCPAddr</span><span class="op" id="8490190">{</span><span class="ident" id="8490191">IP</span><span class="op" id="8490193">:</span>&nbsp;<span class="ident" id="8490195">ParseIP</span><span class="op" id="8490202">(</span><span class="string" id="8490203">&#34;fe80::1&#34;</span><span class="op" id="8490212">)</span><span class="op" id="8490213">,</span>&nbsp;<span class="ident" id="8490215">Port</span><span class="op" id="8490219">:</span>&nbsp;<span class="num" id="8490221">3</span><span class="op" id="8490222">,</span>&nbsp;<span class="ident" id="8490224">Zone</span><span class="op" id="8490228">:</span>&nbsp;<span class="ident" id="8490230">zoneToString</span><span class="op" id="8490242">(</span><span class="ident" id="8490243">ifi</span><span class="op" id="8490246">.</span><span class="ident" id="8490247">Index</span><span class="op" id="8490252">)</span><span class="op" id="8490253">}</span><span class="op" id="8490254">,</span>&nbsp;<span class="ident" id="8490256">nil</span><span class="op" id="8490259">}</span><span class="op" id="8490260">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490265">{</span><span class="string" id="8490266">&#34;tcp6&#34;</span><span class="op" id="8490272">,</span>&nbsp;<span class="string" id="8490274">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="8490286">+</span>&nbsp;<span class="ident" id="8490288">index</span>&nbsp;<span class="op" id="8490294">+</span>&nbsp;<span class="string" id="8490296">&#34;]:4&#34;</span><span class="op" id="8490301">,</span>&nbsp;<span class="op" id="8490303">&amp;</span><span class="ident" id="8490304">TCPAddr</span><span class="op" id="8490311">{</span><span class="ident" id="8490312">IP</span><span class="op" id="8490314">:</span>&nbsp;<span class="ident" id="8490316">ParseIP</span><span class="op" id="8490323">(</span><span class="string" id="8490324">&#34;fe80::1&#34;</span><span class="op" id="8490333">)</span><span class="op" id="8490334">,</span>&nbsp;<span class="ident" id="8490336">Port</span><span class="op" id="8490340">:</span>&nbsp;<span class="num" id="8490342">4</span><span class="op" id="8490343">,</span>&nbsp;<span class="ident" id="8490345">Zone</span><span class="op" id="8490349">:</span>&nbsp;<span class="ident" id="8490351">index</span><span class="op" id="8490356">}</span><span class="op" id="8490357">,</span>&nbsp;<span class="ident" id="8490359">nil</span><span class="op" id="8490362">}</span><span class="op" id="8490363">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490367">}</span><span class="op" id="8490368">...</span><span class="op" id="8490371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490374">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490377">if</span>&nbsp;<span class="ident" id="8490380">ips</span><span class="op" id="8490383">,</span>&nbsp;<span class="ident" id="8490385">err</span>&nbsp;<span class="op" id="8490389">:=</span>&nbsp;<span class="ident" id="8490392">LookupIP</span><span class="op" id="8490400">(</span><span class="string" id="8490401">&#34;localhost&#34;</span><span class="op" id="8490412">)</span><span class="op" id="8490413">;</span>&nbsp;<span class="ident" id="8490415">err</span>&nbsp;<span class="op" id="8490419">==</span>&nbsp;<span class="ident" id="8490422">nil</span>&nbsp;<span class="op" id="8490426">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="8490429">len</span><span class="op" id="8490432">(</span><span class="ident" id="8490433">ips</span><span class="op" id="8490436">)</span>&nbsp;<span class="op" id="8490438">&gt;</span>&nbsp;<span class="num" id="8490440">1</span>&nbsp;<span class="op" id="8490442">&amp;&amp;</span>&nbsp;<span class="ident" id="8490445">supportsIPv4</span>&nbsp;<span class="op" id="8490458">&amp;&amp;</span>&nbsp;<span class="ident" id="8490461">supportsIPv6</span>&nbsp;<span class="op" id="8490474">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490478">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8490498">=</span>&nbsp;<span class="builtinfunc" id="8490500">append</span><span class="op" id="8490506">(</span><span class="ident" id="8490507">resolveTCPAddrTests</span><span class="op" id="8490526">,</span>&nbsp;<span class="op" id="8490528">[</span><span class="op" id="8490529">]</span><span class="ident" id="8490530">resolveTCPAddrTest</span><span class="op" id="8490548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490553">{</span><span class="string" id="8490554">&#34;tcp&#34;</span><span class="op" id="8490559">,</span>&nbsp;<span class="string" id="8490561">&#34;localhost:5&#34;</span><span class="op" id="8490574">,</span>&nbsp;<span class="op" id="8490576">&amp;</span><span class="ident" id="8490577">TCPAddr</span><span class="op" id="8490584">{</span><span class="ident" id="8490585">IP</span><span class="op" id="8490587">:</span>&nbsp;<span class="ident" id="8490589">IPv4</span><span class="op" id="8490593">(</span><span class="num" id="8490594">127</span><span class="op" id="8490597">,</span>&nbsp;<span class="num" id="8490599">0</span><span class="op" id="8490600">,</span>&nbsp;<span class="num" id="8490602">0</span><span class="op" id="8490603">,</span>&nbsp;<span class="num" id="8490605">1</span><span class="op" id="8490606">)</span><span class="op" id="8490607">,</span>&nbsp;<span class="ident" id="8490609">Port</span><span class="op" id="8490613">:</span>&nbsp;<span class="num" id="8490615">5</span><span class="op" id="8490616">}</span><span class="op" id="8490617">,</span>&nbsp;<span class="ident" id="8490619">nil</span><span class="op" id="8490622">}</span><span class="op" id="8490623">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490628">{</span><span class="string" id="8490629">&#34;tcp4&#34;</span><span class="op" id="8490635">,</span>&nbsp;<span class="string" id="8490637">&#34;localhost:6&#34;</span><span class="op" id="8490650">,</span>&nbsp;<span class="op" id="8490652">&amp;</span><span class="ident" id="8490653">TCPAddr</span><span class="op" id="8490660">{</span><span class="ident" id="8490661">IP</span><span class="op" id="8490663">:</span>&nbsp;<span class="ident" id="8490665">IPv4</span><span class="op" id="8490669">(</span><span class="num" id="8490670">127</span><span class="op" id="8490673">,</span>&nbsp;<span class="num" id="8490675">0</span><span class="op" id="8490676">,</span>&nbsp;<span class="num" id="8490678">0</span><span class="op" id="8490679">,</span>&nbsp;<span class="num" id="8490681">1</span><span class="op" id="8490682">)</span><span class="op" id="8490683">,</span>&nbsp;<span class="ident" id="8490685">Port</span><span class="op" id="8490689">:</span>&nbsp;<span class="num" id="8490691">6</span><span class="op" id="8490692">}</span><span class="op" id="8490693">,</span>&nbsp;<span class="ident" id="8490695">nil</span><span class="op" id="8490698">}</span><span class="op" id="8490699">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490704">{</span><span class="string" id="8490705">&#34;tcp6&#34;</span><span class="op" id="8490711">,</span>&nbsp;<span class="string" id="8490713">&#34;localhost:7&#34;</span><span class="op" id="8490726">,</span>&nbsp;<span class="op" id="8490728">&amp;</span><span class="ident" id="8490729">TCPAddr</span><span class="op" id="8490736">{</span><span class="ident" id="8490737">IP</span><span class="op" id="8490739">:</span>&nbsp;<span class="ident" id="8490741">IPv6loopback</span><span class="op" id="8490753">,</span>&nbsp;<span class="ident" id="8490755">Port</span><span class="op" id="8490759">:</span>&nbsp;<span class="num" id="8490761">7</span><span class="op" id="8490762">}</span><span class="op" id="8490763">,</span>&nbsp;<span class="ident" id="8490765">nil</span><span class="op" id="8490768">}</span><span class="op" id="8490769">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490773">}</span><span class="op" id="8490774">...</span><span class="op" id="8490777">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8490780">}</span><br>
<span class="lineno"></span><span class="op" id="8490782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8490785">func</span>&nbsp;<span class="ident" id="8490790">TestResolveTCPAddr</span><span class="op" id="8490808">(</span><span class="ident" id="8490809">t</span>&nbsp;<span class="op" id="8490811">*</span><span class="ident" id="8490812">testing</span><span class="op" id="8490819">.</span><span class="ident" id="8490820">T</span><span class="op" id="8490821">)</span>&nbsp;<span class="op" id="8490823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490826">for</span>&nbsp;<span class="ident" id="8490830">_</span><span class="op" id="8490831">,</span>&nbsp;<span class="ident" id="8490833">tt</span>&nbsp;<span class="op" id="8490836">:=</span>&nbsp;<span class="keyword" id="8490839">range</span>&nbsp;<span class="ident" id="8490845">resolveTCPAddrTests</span>&nbsp;<span class="op" id="8490865">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490869">addr</span><span class="op" id="8490873">,</span>&nbsp;<span class="ident" id="8490875">err</span>&nbsp;<span class="op" id="8490879">:=</span>&nbsp;<span class="ident" id="8490882">ResolveTCPAddr</span><span class="op" id="8490896">(</span><span class="ident" id="8490897">tt</span><span class="op" id="8490899">.</span><span class="ident" id="8490900">net</span><span class="op" id="8490903">,</span>&nbsp;<span class="ident" id="8490905">tt</span><span class="op" id="8490907">.</span><span class="ident" id="8490908">litAddrOrName</span><span class="op" id="8490921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8490925">if</span>&nbsp;<span class="ident" id="8490928">err</span>&nbsp;<span class="op" id="8490932">!=</span>&nbsp;<span class="ident" id="8490935">tt</span><span class="op" id="8490937">.</span><span class="ident" id="8490938">err</span>&nbsp;<span class="op" id="8490942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8490947">t</span><span class="op" id="8490948">.</span><span class="ident" id="8490949">Fatalf</span><span class="op" id="8490955">(</span><span class="string" id="8490956">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8490991">,</span>&nbsp;<span class="ident" id="8490993">tt</span><span class="op" id="8490995">.</span><span class="ident" id="8490996">net</span><span class="op" id="8490999">,</span>&nbsp;<span class="ident" id="8491001">tt</span><span class="op" id="8491003">.</span><span class="ident" id="8491004">litAddrOrName</span><span class="op" id="8491017">,</span>&nbsp;<span class="ident" id="8491019">err</span><span class="op" id="8491022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491030">if</span>&nbsp;<span class="op" id="8491033">!</span><span class="ident" id="8491034">reflect</span><span class="op" id="8491041">.</span><span class="ident" id="8491042">DeepEqual</span><span class="op" id="8491051">(</span><span class="ident" id="8491052">addr</span><span class="op" id="8491056">,</span>&nbsp;<span class="ident" id="8491058">tt</span><span class="op" id="8491060">.</span><span class="ident" id="8491061">addr</span><span class="op" id="8491065">)</span>&nbsp;<span class="op" id="8491067">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491072">t</span><span class="op" id="8491073">.</span><span class="ident" id="8491074">Fatalf</span><span class="op" id="8491080">(</span><span class="string" id="8491081">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8491121">,</span>&nbsp;<span class="ident" id="8491123">tt</span><span class="op" id="8491125">.</span><span class="ident" id="8491126">net</span><span class="op" id="8491129">,</span>&nbsp;<span class="ident" id="8491131">tt</span><span class="op" id="8491133">.</span><span class="ident" id="8491134">litAddrOrName</span><span class="op" id="8491147">,</span>&nbsp;<span class="ident" id="8491149">addr</span><span class="op" id="8491153">,</span>&nbsp;<span class="ident" id="8491155">tt</span><span class="op" id="8491157">.</span><span class="ident" id="8491158">addr</span><span class="op" id="8491162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491166">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491170">if</span>&nbsp;<span class="ident" id="8491173">err</span>&nbsp;<span class="op" id="8491177">==</span>&nbsp;<span class="ident" id="8491180">nil</span>&nbsp;<span class="op" id="8491184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491189">str</span>&nbsp;<span class="op" id="8491193">:=</span>&nbsp;<span class="ident" id="8491196">addr</span><span class="op" id="8491200">.</span><span class="ident" id="8491201">String</span><span class="op" id="8491207">(</span><span class="op" id="8491208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491213">addr1</span><span class="op" id="8491218">,</span>&nbsp;<span class="ident" id="8491220">err</span>&nbsp;<span class="op" id="8491224">:=</span>&nbsp;<span class="ident" id="8491227">ResolveTCPAddr</span><span class="op" id="8491241">(</span><span class="ident" id="8491242">tt</span><span class="op" id="8491244">.</span><span class="ident" id="8491245">net</span><span class="op" id="8491248">,</span>&nbsp;<span class="ident" id="8491250">str</span><span class="op" id="8491253">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491258">if</span>&nbsp;<span class="ident" id="8491261">err</span>&nbsp;<span class="op" id="8491265">!=</span>&nbsp;<span class="ident" id="8491268">nil</span>&nbsp;<span class="op" id="8491272">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491278">t</span><span class="op" id="8491279">.</span><span class="ident" id="8491280">Fatalf</span><span class="op" id="8491286">(</span><span class="string" id="8491287">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="8491325">,</span>&nbsp;<span class="ident" id="8491327">tt</span><span class="op" id="8491329">.</span><span class="ident" id="8491330">net</span><span class="op" id="8491333">,</span>&nbsp;<span class="ident" id="8491335">str</span><span class="op" id="8491338">,</span>&nbsp;<span class="ident" id="8491340">tt</span><span class="op" id="8491342">.</span><span class="ident" id="8491343">litAddrOrName</span><span class="op" id="8491356">,</span>&nbsp;<span class="ident" id="8491358">err</span><span class="op" id="8491361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491371">if</span>&nbsp;<span class="op" id="8491374">!</span><span class="ident" id="8491375">reflect</span><span class="op" id="8491382">.</span><span class="ident" id="8491383">DeepEqual</span><span class="op" id="8491392">(</span><span class="ident" id="8491393">addr1</span><span class="op" id="8491398">,</span>&nbsp;<span class="ident" id="8491400">addr</span><span class="op" id="8491404">)</span>&nbsp;<span class="op" id="8491406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491412">t</span><span class="op" id="8491413">.</span><span class="ident" id="8491414">Fatalf</span><span class="op" id="8491420">(</span><span class="string" id="8491421">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="8491471">,</span>&nbsp;<span class="ident" id="8491473">tt</span><span class="op" id="8491475">.</span><span class="ident" id="8491476">net</span><span class="op" id="8491479">,</span>&nbsp;<span class="ident" id="8491481">str</span><span class="op" id="8491484">,</span>&nbsp;<span class="ident" id="8491486">tt</span><span class="op" id="8491488">.</span><span class="ident" id="8491489">litAddrOrName</span><span class="op" id="8491502">,</span>&nbsp;<span class="ident" id="8491504">addr1</span><span class="op" id="8491509">,</span>&nbsp;<span class="ident" id="8491511">addr</span><span class="op" id="8491515">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491527">}</span><br>
<span class="lineno"></span><span class="op" id="8491529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="8491532">var</span>&nbsp;<span class="ident" id="8491536">tcpListenerNameTests</span>&nbsp;<span class="op" id="8491557">=</span>&nbsp;<span class="op" id="8491559">[</span><span class="op" id="8491560">]</span><span class="keyword" id="8491561">struct</span>&nbsp;<span class="op" id="8491568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491571">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8491577">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491585">laddr</span>&nbsp;<span class="op" id="8491591">*</span><span class="ident" id="8491592">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="8491600">}</span><span class="op" id="8491601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491604">{</span><span class="string" id="8491605">&#34;tcp4&#34;</span><span class="op" id="8491611">,</span>&nbsp;<span class="op" id="8491613">&amp;</span><span class="ident" id="8491614">TCPAddr</span><span class="op" id="8491621">{</span><span class="ident" id="8491622">IP</span><span class="op" id="8491624">:</span>&nbsp;<span class="ident" id="8491626">IPv4</span><span class="op" id="8491630">(</span><span class="num" id="8491631">127</span><span class="op" id="8491634">,</span>&nbsp;<span class="num" id="8491636">0</span><span class="op" id="8491637">,</span>&nbsp;<span class="num" id="8491639">0</span><span class="op" id="8491640">,</span>&nbsp;<span class="num" id="8491642">1</span><span class="op" id="8491643">)</span><span class="op" id="8491644">}</span><span class="op" id="8491645">}</span><span class="op" id="8491646">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491649">{</span><span class="string" id="8491650">&#34;tcp4&#34;</span><span class="op" id="8491656">,</span>&nbsp;<span class="op" id="8491658">&amp;</span><span class="ident" id="8491659">TCPAddr</span><span class="op" id="8491666">{</span><span class="op" id="8491667">}</span><span class="op" id="8491668">}</span><span class="op" id="8491669">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491672">{</span><span class="string" id="8491673">&#34;tcp4&#34;</span><span class="op" id="8491679">,</span>&nbsp;<span class="ident" id="8491681">nil</span><span class="op" id="8491684">}</span><span class="op" id="8491685">,</span><br>
<span class="lineno"></span><span class="op" id="8491687">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8491690">func</span>&nbsp;<span class="ident" id="8491695">TestTCPListenerName</span><span class="op" id="8491714">(</span><span class="ident" id="8491715">t</span>&nbsp;<span class="op" id="8491717">*</span><span class="ident" id="8491718">testing</span><span class="op" id="8491725">.</span><span class="ident" id="8491726">T</span><span class="op" id="8491727">)</span>&nbsp;<span class="op" id="8491729">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491732">if</span>&nbsp;<span class="ident" id="8491735">testing</span><span class="op" id="8491742">.</span><span class="ident" id="8491743">Short</span><span class="op" id="8491748">(</span><span class="op" id="8491749">)</span>&nbsp;<span class="op" id="8491751">||</span>&nbsp;<span class="op" id="8491754">!</span><span class="op" id="8491755">*</span><span class="ident" id="8491756">testExternal</span>&nbsp;<span class="op" id="8491769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491773">t</span><span class="op" id="8491774">.</span><span class="ident" id="8491775">Skip</span><span class="op" id="8491779">(</span><span class="string" id="8491780">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8491821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491828">for</span>&nbsp;<span class="ident" id="8491832">_</span><span class="op" id="8491833">,</span>&nbsp;<span class="ident" id="8491835">tt</span>&nbsp;<span class="op" id="8491838">:=</span>&nbsp;<span class="keyword" id="8491841">range</span>&nbsp;<span class="ident" id="8491847">tcpListenerNameTests</span>&nbsp;<span class="op" id="8491868">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491872">ln</span><span class="op" id="8491874">,</span>&nbsp;<span class="ident" id="8491876">err</span>&nbsp;<span class="op" id="8491880">:=</span>&nbsp;<span class="ident" id="8491883">ListenTCP</span><span class="op" id="8491892">(</span><span class="ident" id="8491893">tt</span><span class="op" id="8491895">.</span><span class="ident" id="8491896">net</span><span class="op" id="8491899">,</span>&nbsp;<span class="ident" id="8491901">tt</span><span class="op" id="8491903">.</span><span class="ident" id="8491904">laddr</span><span class="op" id="8491909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491913">if</span>&nbsp;<span class="ident" id="8491916">err</span>&nbsp;<span class="op" id="8491920">!=</span>&nbsp;<span class="ident" id="8491923">nil</span>&nbsp;<span class="op" id="8491927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491932">t</span><span class="op" id="8491933">.</span><span class="ident" id="8491934">Fatalf</span><span class="op" id="8491940">(</span><span class="string" id="8491941">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8491963">,</span>&nbsp;<span class="ident" id="8491965">err</span><span class="op" id="8491968">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8491972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8491976">defer</span>&nbsp;<span class="ident" id="8491982">ln</span><span class="op" id="8491984">.</span><span class="ident" id="8491985">Close</span><span class="op" id="8491990">(</span><span class="op" id="8491991">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8491995">la</span>&nbsp;<span class="op" id="8491998">:=</span>&nbsp;<span class="ident" id="8492001">ln</span><span class="op" id="8492003">.</span><span class="ident" id="8492004">Addr</span><span class="op" id="8492008">(</span><span class="op" id="8492009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492013">if</span>&nbsp;<span class="ident" id="8492016">a</span><span class="op" id="8492017">,</span>&nbsp;<span class="ident" id="8492019">ok</span>&nbsp;<span class="op" id="8492022">:=</span>&nbsp;<span class="ident" id="8492025">la</span><span class="op" id="8492027">.</span><span class="op" id="8492028">(</span><span class="op" id="8492029">*</span><span class="ident" id="8492030">TCPAddr</span><span class="op" id="8492037">)</span><span class="op" id="8492038">;</span>&nbsp;<span class="op" id="8492040">!</span><span class="ident" id="8492041">ok</span>&nbsp;<span class="op" id="8492044">||</span>&nbsp;<span class="ident" id="8492047">a</span><span class="op" id="8492048">.</span><span class="ident" id="8492049">Port</span>&nbsp;<span class="op" id="8492054">==</span>&nbsp;<span class="num" id="8492057">0</span>&nbsp;<span class="op" id="8492059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492064">t</span><span class="op" id="8492065">.</span><span class="ident" id="8492066">Fatalf</span><span class="op" id="8492072">(</span><span class="string" id="8492073">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="8492134">,</span>&nbsp;<span class="ident" id="8492136">la</span><span class="op" id="8492138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492142">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492145">}</span><br>
<span class="lineno">375</span><span class="op" id="8492147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8492150">func</span>&nbsp;<span class="ident" id="8492155">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="8492182">(</span><span class="ident" id="8492183">t</span>&nbsp;<span class="op" id="8492185">*</span><span class="ident" id="8492186">testing</span><span class="op" id="8492193">.</span><span class="ident" id="8492194">T</span><span class="op" id="8492195">)</span>&nbsp;<span class="op" id="8492197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492200">if</span>&nbsp;<span class="ident" id="8492203">testing</span><span class="op" id="8492210">.</span><span class="ident" id="8492211">Short</span><span class="op" id="8492216">(</span><span class="op" id="8492217">)</span>&nbsp;<span class="op" id="8492219">||</span>&nbsp;<span class="op" id="8492222">!</span><span class="op" id="8492223">*</span><span class="ident" id="8492224">testExternal</span>&nbsp;<span class="op" id="8492237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492241">t</span><span class="op" id="8492242">.</span><span class="ident" id="8492243">Skip</span><span class="op" id="8492247">(</span><span class="string" id="8492248">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="8492289">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492295">if</span>&nbsp;<span class="op" id="8492298">!</span><span class="ident" id="8492299">supportsIPv6</span>&nbsp;<span class="op" id="8492312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492316">t</span><span class="op" id="8492317">.</span><span class="ident" id="8492318">Skip</span><span class="op" id="8492322">(</span><span class="string" id="8492323">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="8492346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492349">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492352">ifi</span>&nbsp;<span class="op" id="8492356">:=</span>&nbsp;<span class="ident" id="8492359">loopbackInterface</span><span class="op" id="8492376">(</span><span class="op" id="8492377">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492380">if</span>&nbsp;<span class="ident" id="8492383">ifi</span>&nbsp;<span class="op" id="8492387">==</span>&nbsp;<span class="ident" id="8492390">nil</span>&nbsp;<span class="op" id="8492394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492398">t</span><span class="op" id="8492399">.</span><span class="ident" id="8492400">Skip</span><span class="op" id="8492404">(</span><span class="string" id="8492405">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="8492435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492441">laddr</span>&nbsp;<span class="op" id="8492447">:=</span>&nbsp;<span class="ident" id="8492450">ipv6LinkLocalUnicastAddr</span><span class="op" id="8492474">(</span><span class="ident" id="8492475">ifi</span><span class="op" id="8492478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492481">if</span>&nbsp;<span class="ident" id="8492484">laddr</span>&nbsp;<span class="op" id="8492490">==</span>&nbsp;<span class="string" id="8492493">&#34;&#34;</span>&nbsp;<span class="op" id="8492496">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492500">t</span><span class="op" id="8492501">.</span><span class="ident" id="8492502">Skip</span><span class="op" id="8492506">(</span><span class="string" id="8492507">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="8492551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492558">type</span>&nbsp;<span class="ident" id="8492563">test</span>&nbsp;<span class="keyword" id="8492568">struct</span>&nbsp;<span class="op" id="8492575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492579">net</span><span class="op" id="8492582">,</span>&nbsp;<span class="ident" id="8492584">addr</span>&nbsp;&nbsp;<span class="builtintype" id="8492590">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492599">nameLookup</span>&nbsp;<span class="builtintype" id="8492610">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492619">var</span>&nbsp;<span class="ident" id="8492623">tests</span>&nbsp;<span class="op" id="8492629">=</span>&nbsp;<span class="op" id="8492631">[</span><span class="op" id="8492632">]</span><span class="ident" id="8492633">test</span><span class="op" id="8492637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492641">{</span><span class="string" id="8492642">&#34;tcp&#34;</span><span class="op" id="8492647">,</span>&nbsp;<span class="string" id="8492649">&#34;[&#34;</span>&nbsp;<span class="op" id="8492653">+</span>&nbsp;<span class="ident" id="8492655">laddr</span>&nbsp;<span class="op" id="8492661">+</span>&nbsp;<span class="string" id="8492663">&#34;%&#34;</span>&nbsp;<span class="op" id="8492667">+</span>&nbsp;<span class="ident" id="8492669">ifi</span><span class="op" id="8492672">.</span><span class="ident" id="8492673">Name</span>&nbsp;<span class="op" id="8492678">+</span>&nbsp;<span class="string" id="8492680">&#34;]:0&#34;</span><span class="op" id="8492685">,</span>&nbsp;<span class="builtintype" id="8492687">false</span><span class="op" id="8492692">}</span><span class="op" id="8492693">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492697">{</span><span class="string" id="8492698">&#34;tcp6&#34;</span><span class="op" id="8492704">,</span>&nbsp;<span class="string" id="8492706">&#34;[&#34;</span>&nbsp;<span class="op" id="8492710">+</span>&nbsp;<span class="ident" id="8492712">laddr</span>&nbsp;<span class="op" id="8492718">+</span>&nbsp;<span class="string" id="8492720">&#34;%&#34;</span>&nbsp;<span class="op" id="8492724">+</span>&nbsp;<span class="ident" id="8492726">ifi</span><span class="op" id="8492729">.</span><span class="ident" id="8492730">Name</span>&nbsp;<span class="op" id="8492735">+</span>&nbsp;<span class="string" id="8492737">&#34;]:0&#34;</span><span class="op" id="8492742">,</span>&nbsp;<span class="builtintype" id="8492744">false</span><span class="op" id="8492749">}</span><span class="op" id="8492750">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492753">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492756">switch</span>&nbsp;<span class="ident" id="8492763">runtime</span><span class="op" id="8492770">.</span><span class="ident" id="8492771">GOOS</span>&nbsp;<span class="op" id="8492776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492779">case</span>&nbsp;<span class="string" id="8492784">&#34;darwin&#34;</span><span class="op" id="8492792">,</span>&nbsp;<span class="string" id="8492794">&#34;freebsd&#34;</span><span class="op" id="8492803">,</span>&nbsp;<span class="string" id="8492805">&#34;openbsd&#34;</span><span class="op" id="8492814">,</span>&nbsp;<span class="string" id="8492816">&#34;netbsd&#34;</span><span class="op" id="8492824">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492828">tests</span>&nbsp;<span class="op" id="8492834">=</span>&nbsp;<span class="builtinfunc" id="8492836">append</span><span class="op" id="8492842">(</span><span class="ident" id="8492843">tests</span><span class="op" id="8492848">,</span>&nbsp;<span class="op" id="8492850">[</span><span class="op" id="8492851">]</span><span class="ident" id="8492852">test</span><span class="op" id="8492856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492861">{</span><span class="string" id="8492862">&#34;tcp&#34;</span><span class="op" id="8492867">,</span>&nbsp;<span class="string" id="8492869">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8492883">+</span>&nbsp;<span class="ident" id="8492885">ifi</span><span class="op" id="8492888">.</span><span class="ident" id="8492889">Name</span>&nbsp;<span class="op" id="8492894">+</span>&nbsp;<span class="string" id="8492896">&#34;]:0&#34;</span><span class="op" id="8492901">,</span>&nbsp;<span class="builtintype" id="8492903">true</span><span class="op" id="8492907">}</span><span class="op" id="8492908">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492913">{</span><span class="string" id="8492914">&#34;tcp6&#34;</span><span class="op" id="8492920">,</span>&nbsp;<span class="string" id="8492922">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="8492936">+</span>&nbsp;<span class="ident" id="8492938">ifi</span><span class="op" id="8492941">.</span><span class="ident" id="8492942">Name</span>&nbsp;<span class="op" id="8492947">+</span>&nbsp;<span class="string" id="8492949">&#34;]:0&#34;</span><span class="op" id="8492954">,</span>&nbsp;<span class="builtintype" id="8492956">true</span><span class="op" id="8492960">}</span><span class="op" id="8492961">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8492965">}</span><span class="op" id="8492966">...</span><span class="op" id="8492969">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8492972">case</span>&nbsp;<span class="string" id="8492977">&#34;linux&#34;</span><span class="op" id="8492984">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8492988">tests</span>&nbsp;<span class="op" id="8492994">=</span>&nbsp;<span class="builtinfunc" id="8492996">append</span><span class="op" id="8493002">(</span><span class="ident" id="8493003">tests</span><span class="op" id="8493008">,</span>&nbsp;<span class="op" id="8493010">[</span><span class="op" id="8493011">]</span><span class="ident" id="8493012">test</span><span class="op" id="8493016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493021">{</span><span class="string" id="8493022">&#34;tcp&#34;</span><span class="op" id="8493027">,</span>&nbsp;<span class="string" id="8493029">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8493047">+</span>&nbsp;<span class="ident" id="8493049">ifi</span><span class="op" id="8493052">.</span><span class="ident" id="8493053">Name</span>&nbsp;<span class="op" id="8493058">+</span>&nbsp;<span class="string" id="8493060">&#34;]:0&#34;</span><span class="op" id="8493065">,</span>&nbsp;<span class="builtintype" id="8493067">true</span><span class="op" id="8493071">}</span><span class="op" id="8493072">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493077">{</span><span class="string" id="8493078">&#34;tcp6&#34;</span><span class="op" id="8493084">,</span>&nbsp;<span class="string" id="8493086">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="8493104">+</span>&nbsp;<span class="ident" id="8493106">ifi</span><span class="op" id="8493109">.</span><span class="ident" id="8493110">Name</span>&nbsp;<span class="op" id="8493115">+</span>&nbsp;<span class="string" id="8493117">&#34;]:0&#34;</span><span class="op" id="8493122">,</span>&nbsp;<span class="builtintype" id="8493124">true</span><span class="op" id="8493128">}</span><span class="op" id="8493129">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493133">}</span><span class="op" id="8493134">...</span><span class="op" id="8493137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493143">for</span>&nbsp;<span class="ident" id="8493147">_</span><span class="op" id="8493148">,</span>&nbsp;<span class="ident" id="8493150">tt</span>&nbsp;<span class="op" id="8493153">:=</span>&nbsp;<span class="keyword" id="8493156">range</span>&nbsp;<span class="ident" id="8493162">tests</span>&nbsp;<span class="op" id="8493168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493172">ln</span><span class="op" id="8493174">,</span>&nbsp;<span class="ident" id="8493176">err</span>&nbsp;<span class="op" id="8493180">:=</span>&nbsp;<span class="ident" id="8493183">Listen</span><span class="op" id="8493189">(</span><span class="ident" id="8493190">tt</span><span class="op" id="8493192">.</span><span class="ident" id="8493193">net</span><span class="op" id="8493196">,</span>&nbsp;<span class="ident" id="8493198">tt</span><span class="op" id="8493200">.</span><span class="ident" id="8493201">addr</span><span class="op" id="8493205">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493209">if</span>&nbsp;<span class="ident" id="8493212">err</span>&nbsp;<span class="op" id="8493216">!=</span>&nbsp;<span class="ident" id="8493219">nil</span>&nbsp;<span class="op" id="8493223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8493228">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8493274">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493323">t</span><span class="op" id="8493324">.</span><span class="ident" id="8493325">Logf</span><span class="op" id="8493329">(</span><span class="string" id="8493330">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8493349">,</span>&nbsp;<span class="ident" id="8493351">err</span><span class="op" id="8493354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493359">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493374">defer</span>&nbsp;<span class="ident" id="8493380">ln</span><span class="op" id="8493382">.</span><span class="ident" id="8493383">Close</span><span class="op" id="8493388">(</span><span class="op" id="8493389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493393">if</span>&nbsp;<span class="ident" id="8493396">la</span><span class="op" id="8493398">,</span>&nbsp;<span class="ident" id="8493400">ok</span>&nbsp;<span class="op" id="8493403">:=</span>&nbsp;<span class="ident" id="8493406">ln</span><span class="op" id="8493408">.</span><span class="ident" id="8493409">Addr</span><span class="op" id="8493413">(</span><span class="op" id="8493414">)</span><span class="op" id="8493415">.</span><span class="op" id="8493416">(</span><span class="op" id="8493417">*</span><span class="ident" id="8493418">TCPAddr</span><span class="op" id="8493425">)</span><span class="op" id="8493426">;</span>&nbsp;<span class="op" id="8493428">!</span><span class="ident" id="8493429">ok</span>&nbsp;<span class="op" id="8493432">||</span>&nbsp;<span class="op" id="8493435">!</span><span class="ident" id="8493436">tt</span><span class="op" id="8493438">.</span><span class="ident" id="8493439">nameLookup</span>&nbsp;<span class="op" id="8493450">&amp;&amp;</span>&nbsp;<span class="ident" id="8493453">la</span><span class="op" id="8493455">.</span><span class="ident" id="8493456">Zone</span>&nbsp;<span class="op" id="8493461">==</span>&nbsp;<span class="string" id="8493464">&#34;&#34;</span>&nbsp;<span class="op" id="8493467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493472">t</span><span class="op" id="8493473">.</span><span class="ident" id="8493474">Fatalf</span><span class="op" id="8493480">(</span><span class="string" id="8493481">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8493537">,</span>&nbsp;<span class="ident" id="8493539">la</span><span class="op" id="8493541">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493545">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493550">done</span>&nbsp;<span class="op" id="8493555">:=</span>&nbsp;<span class="builtinfunc" id="8493558">make</span><span class="op" id="8493562">(</span><span class="keyword" id="8493563">chan</span>&nbsp;<span class="builtintype" id="8493568">int</span><span class="op" id="8493571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493575">go</span>&nbsp;<span class="ident" id="8493578">transponder</span><span class="op" id="8493589">(</span><span class="ident" id="8493590">t</span><span class="op" id="8493591">,</span>&nbsp;<span class="ident" id="8493593">ln</span><span class="op" id="8493595">,</span>&nbsp;<span class="ident" id="8493597">done</span><span class="op" id="8493601">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493606">c</span><span class="op" id="8493607">,</span>&nbsp;<span class="ident" id="8493609">err</span>&nbsp;<span class="op" id="8493613">:=</span>&nbsp;<span class="ident" id="8493616">Dial</span><span class="op" id="8493620">(</span><span class="ident" id="8493621">tt</span><span class="op" id="8493623">.</span><span class="ident" id="8493624">net</span><span class="op" id="8493627">,</span>&nbsp;<span class="ident" id="8493629">ln</span><span class="op" id="8493631">.</span><span class="ident" id="8493632">Addr</span><span class="op" id="8493636">(</span><span class="op" id="8493637">)</span><span class="op" id="8493638">.</span><span class="ident" id="8493639">String</span><span class="op" id="8493645">(</span><span class="op" id="8493646">)</span><span class="op" id="8493647">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493651">if</span>&nbsp;<span class="ident" id="8493654">err</span>&nbsp;<span class="op" id="8493658">!=</span>&nbsp;<span class="ident" id="8493661">nil</span>&nbsp;<span class="op" id="8493665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493670">t</span><span class="op" id="8493671">.</span><span class="ident" id="8493672">Fatalf</span><span class="op" id="8493678">(</span><span class="string" id="8493679">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8493696">,</span>&nbsp;<span class="ident" id="8493698">err</span><span class="op" id="8493701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493709">defer</span>&nbsp;<span class="ident" id="8493715">c</span><span class="op" id="8493716">.</span><span class="ident" id="8493717">Close</span><span class="op" id="8493722">(</span><span class="op" id="8493723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493727">if</span>&nbsp;<span class="ident" id="8493730">la</span><span class="op" id="8493732">,</span>&nbsp;<span class="ident" id="8493734">ok</span>&nbsp;<span class="op" id="8493737">:=</span>&nbsp;<span class="ident" id="8493740">c</span><span class="op" id="8493741">.</span><span class="ident" id="8493742">LocalAddr</span><span class="op" id="8493751">(</span><span class="op" id="8493752">)</span><span class="op" id="8493753">.</span><span class="op" id="8493754">(</span><span class="op" id="8493755">*</span><span class="ident" id="8493756">TCPAddr</span><span class="op" id="8493763">)</span><span class="op" id="8493764">;</span>&nbsp;<span class="op" id="8493766">!</span><span class="ident" id="8493767">ok</span>&nbsp;<span class="op" id="8493770">||</span>&nbsp;<span class="op" id="8493773">!</span><span class="ident" id="8493774">tt</span><span class="op" id="8493776">.</span><span class="ident" id="8493777">nameLookup</span>&nbsp;<span class="op" id="8493788">&amp;&amp;</span>&nbsp;<span class="ident" id="8493791">la</span><span class="op" id="8493793">.</span><span class="ident" id="8493794">Zone</span>&nbsp;<span class="op" id="8493799">==</span>&nbsp;<span class="string" id="8493802">&#34;&#34;</span>&nbsp;<span class="op" id="8493805">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493810">t</span><span class="op" id="8493811">.</span><span class="ident" id="8493812">Fatalf</span><span class="op" id="8493818">(</span><span class="string" id="8493819">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8493875">,</span>&nbsp;<span class="ident" id="8493877">la</span><span class="op" id="8493879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8493883">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8493887">if</span>&nbsp;<span class="ident" id="8493890">ra</span><span class="op" id="8493892">,</span>&nbsp;<span class="ident" id="8493894">ok</span>&nbsp;<span class="op" id="8493897">:=</span>&nbsp;<span class="ident" id="8493900">c</span><span class="op" id="8493901">.</span><span class="ident" id="8493902">RemoteAddr</span><span class="op" id="8493912">(</span><span class="op" id="8493913">)</span><span class="op" id="8493914">.</span><span class="op" id="8493915">(</span><span class="op" id="8493916">*</span><span class="ident" id="8493917">TCPAddr</span><span class="op" id="8493924">)</span><span class="op" id="8493925">;</span>&nbsp;<span class="op" id="8493927">!</span><span class="ident" id="8493928">ok</span>&nbsp;<span class="op" id="8493931">||</span>&nbsp;<span class="op" id="8493934">!</span><span class="ident" id="8493935">tt</span><span class="op" id="8493937">.</span><span class="ident" id="8493938">nameLookup</span>&nbsp;<span class="op" id="8493949">&amp;&amp;</span>&nbsp;<span class="ident" id="8493952">ra</span><span class="op" id="8493954">.</span><span class="ident" id="8493955">Zone</span>&nbsp;<span class="op" id="8493960">==</span>&nbsp;<span class="string" id="8493963">&#34;&#34;</span>&nbsp;<span class="op" id="8493966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8493971">t</span><span class="op" id="8493972">.</span><span class="ident" id="8493973">Fatalf</span><span class="op" id="8493979">(</span><span class="string" id="8493980">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="8494036">,</span>&nbsp;<span class="ident" id="8494038">ra</span><span class="op" id="8494040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494044">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494049">if</span>&nbsp;<span class="ident" id="8494052">_</span><span class="op" id="8494053">,</span>&nbsp;<span class="ident" id="8494055">err</span>&nbsp;<span class="op" id="8494059">:=</span>&nbsp;<span class="ident" id="8494062">c</span><span class="op" id="8494063">.</span><span class="ident" id="8494064">Write</span><span class="op" id="8494069">(</span><span class="op" id="8494070">[</span><span class="op" id="8494071">]</span><span class="builtintype" id="8494072">byte</span><span class="op" id="8494076">(</span><span class="string" id="8494077">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="8494107">)</span><span class="op" id="8494108">)</span><span class="op" id="8494109">;</span>&nbsp;<span class="ident" id="8494111">err</span>&nbsp;<span class="op" id="8494115">!=</span>&nbsp;<span class="ident" id="8494118">nil</span>&nbsp;<span class="op" id="8494122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494127">t</span><span class="op" id="8494128">.</span><span class="ident" id="8494129">Fatalf</span><span class="op" id="8494135">(</span><span class="string" id="8494136">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8494159">,</span>&nbsp;<span class="ident" id="8494161">err</span><span class="op" id="8494164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494172">b</span>&nbsp;<span class="op" id="8494174">:=</span>&nbsp;<span class="builtinfunc" id="8494177">make</span><span class="op" id="8494181">(</span><span class="op" id="8494182">[</span><span class="op" id="8494183">]</span><span class="builtintype" id="8494184">byte</span><span class="op" id="8494188">,</span>&nbsp;<span class="num" id="8494190">32</span><span class="op" id="8494192">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494196">if</span>&nbsp;<span class="ident" id="8494199">_</span><span class="op" id="8494200">,</span>&nbsp;<span class="ident" id="8494202">err</span>&nbsp;<span class="op" id="8494206">:=</span>&nbsp;<span class="ident" id="8494209">c</span><span class="op" id="8494210">.</span><span class="ident" id="8494211">Read</span><span class="op" id="8494215">(</span><span class="ident" id="8494216">b</span><span class="op" id="8494217">)</span><span class="op" id="8494218">;</span>&nbsp;<span class="ident" id="8494220">err</span>&nbsp;<span class="op" id="8494224">!=</span>&nbsp;<span class="ident" id="8494227">nil</span>&nbsp;<span class="op" id="8494231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494236">t</span><span class="op" id="8494237">.</span><span class="ident" id="8494238">Fatalf</span><span class="op" id="8494244">(</span><span class="string" id="8494245">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8494267">,</span>&nbsp;<span class="ident" id="8494269">err</span><span class="op" id="8494272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494281">&lt;-</span><span class="ident" id="8494283">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494289">}</span><br>
<span class="lineno"></span><span class="op" id="8494291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8494294">func</span>&nbsp;<span class="ident" id="8494299">TestTCPConcurrentAccept</span><span class="op" id="8494322">(</span><span class="ident" id="8494323">t</span>&nbsp;<span class="op" id="8494325">*</span><span class="ident" id="8494326">testing</span><span class="op" id="8494333">.</span><span class="ident" id="8494334">T</span><span class="op" id="8494335">)</span>&nbsp;<span class="op" id="8494337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494340">defer</span>&nbsp;<span class="ident" id="8494346">runtime</span><span class="op" id="8494353">.</span><span class="ident" id="8494354">GOMAXPROCS</span><span class="op" id="8494364">(</span><span class="ident" id="8494365">runtime</span><span class="op" id="8494372">.</span><span class="ident" id="8494373">GOMAXPROCS</span><span class="op" id="8494383">(</span><span class="num" id="8494384">4</span><span class="op" id="8494385">)</span><span class="op" id="8494386">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494389">ln</span><span class="op" id="8494391">,</span>&nbsp;<span class="ident" id="8494393">err</span>&nbsp;<span class="op" id="8494397">:=</span>&nbsp;<span class="ident" id="8494400">Listen</span><span class="op" id="8494406">(</span><span class="string" id="8494407">&#34;tcp&#34;</span><span class="op" id="8494412">,</span>&nbsp;<span class="string" id="8494414">&#34;127.0.0.1:0&#34;</span><span class="op" id="8494427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494430">if</span>&nbsp;<span class="ident" id="8494433">err</span>&nbsp;<span class="op" id="8494437">!=</span>&nbsp;<span class="ident" id="8494440">nil</span>&nbsp;<span class="op" id="8494444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494448">t</span><span class="op" id="8494449">.</span><span class="ident" id="8494450">Fatalf</span><span class="op" id="8494456">(</span><span class="string" id="8494457">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8494476">,</span>&nbsp;<span class="ident" id="8494478">err</span><span class="op" id="8494481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494487">const</span>&nbsp;<span class="ident" id="8494493">N</span>&nbsp;<span class="op" id="8494495">=</span>&nbsp;<span class="num" id="8494497">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494501">var</span>&nbsp;<span class="ident" id="8494505">wg</span>&nbsp;<span class="ident" id="8494508">sync</span><span class="op" id="8494512">.</span><span class="ident" id="8494513">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494524">wg</span><span class="op" id="8494526">.</span><span class="ident" id="8494527">Add</span><span class="op" id="8494530">(</span><span class="ident" id="8494531">N</span><span class="op" id="8494532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494535">for</span>&nbsp;<span class="ident" id="8494539">i</span>&nbsp;<span class="op" id="8494541">:=</span>&nbsp;<span class="num" id="8494544">0</span><span class="op" id="8494545">;</span>&nbsp;<span class="ident" id="8494547">i</span>&nbsp;<span class="op" id="8494549">&lt;</span>&nbsp;<span class="ident" id="8494551">N</span><span class="op" id="8494552">;</span>&nbsp;<span class="ident" id="8494554">i</span><span class="op" id="8494555">++</span>&nbsp;<span class="op" id="8494558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494562">go</span>&nbsp;<span class="keyword" id="8494565">func</span><span class="op" id="8494569">(</span><span class="op" id="8494570">)</span>&nbsp;<span class="op" id="8494572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494577">for</span>&nbsp;<span class="op" id="8494581">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494587">c</span><span class="op" id="8494588">,</span>&nbsp;<span class="ident" id="8494590">err</span>&nbsp;<span class="op" id="8494594">:=</span>&nbsp;<span class="ident" id="8494597">ln</span><span class="op" id="8494599">.</span><span class="ident" id="8494600">Accept</span><span class="op" id="8494606">(</span><span class="op" id="8494607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494613">if</span>&nbsp;<span class="ident" id="8494616">err</span>&nbsp;<span class="op" id="8494620">!=</span>&nbsp;<span class="ident" id="8494623">nil</span>&nbsp;<span class="op" id="8494627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494634">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494650">c</span><span class="op" id="8494651">.</span><span class="ident" id="8494652">Close</span><span class="op" id="8494657">(</span><span class="op" id="8494658">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494668">wg</span><span class="op" id="8494670">.</span><span class="ident" id="8494671">Done</span><span class="op" id="8494675">(</span><span class="op" id="8494676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494680">}</span><span class="op" id="8494681">(</span><span class="op" id="8494682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494688">attempts</span>&nbsp;<span class="op" id="8494697">:=</span>&nbsp;<span class="num" id="8494700">10</span>&nbsp;<span class="op" id="8494703">*</span>&nbsp;<span class="ident" id="8494705">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494708">fails</span>&nbsp;<span class="op" id="8494714">:=</span>&nbsp;<span class="num" id="8494717">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494720">d</span>&nbsp;<span class="op" id="8494722">:=</span>&nbsp;<span class="op" id="8494725">&amp;</span><span class="ident" id="8494726">Dialer</span><span class="op" id="8494732">{</span><span class="ident" id="8494733">Timeout</span><span class="op" id="8494740">:</span>&nbsp;<span class="num" id="8494742">200</span>&nbsp;<span class="op" id="8494746">*</span>&nbsp;<span class="ident" id="8494748">time</span><span class="op" id="8494752">.</span><span class="ident" id="8494753">Millisecond</span><span class="op" id="8494764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494767">for</span>&nbsp;<span class="ident" id="8494771">i</span>&nbsp;<span class="op" id="8494773">:=</span>&nbsp;<span class="num" id="8494776">0</span><span class="op" id="8494777">;</span>&nbsp;<span class="ident" id="8494779">i</span>&nbsp;<span class="op" id="8494781">&lt;</span>&nbsp;<span class="ident" id="8494783">attempts</span><span class="op" id="8494791">;</span>&nbsp;<span class="ident" id="8494793">i</span><span class="op" id="8494794">++</span>&nbsp;<span class="op" id="8494797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494801">c</span><span class="op" id="8494802">,</span>&nbsp;<span class="ident" id="8494804">err</span>&nbsp;<span class="op" id="8494808">:=</span>&nbsp;<span class="ident" id="8494811">d</span><span class="op" id="8494812">.</span><span class="ident" id="8494813">Dial</span><span class="op" id="8494817">(</span><span class="string" id="8494818">&#34;tcp&#34;</span><span class="op" id="8494823">,</span>&nbsp;<span class="ident" id="8494825">ln</span><span class="op" id="8494827">.</span><span class="ident" id="8494828">Addr</span><span class="op" id="8494832">(</span><span class="op" id="8494833">)</span><span class="op" id="8494834">.</span><span class="ident" id="8494835">String</span><span class="op" id="8494841">(</span><span class="op" id="8494842">)</span><span class="op" id="8494843">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494847">if</span>&nbsp;<span class="ident" id="8494850">err</span>&nbsp;<span class="op" id="8494854">!=</span>&nbsp;<span class="ident" id="8494857">nil</span>&nbsp;<span class="op" id="8494861">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494866">fails</span><span class="op" id="8494871">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494876">}</span>&nbsp;<span class="keyword" id="8494878">else</span>&nbsp;<span class="op" id="8494883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494888">c</span><span class="op" id="8494889">.</span><span class="ident" id="8494890">Close</span><span class="op" id="8494895">(</span><span class="op" id="8494896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8494903">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494906">ln</span><span class="op" id="8494908">.</span><span class="ident" id="8494909">Close</span><span class="op" id="8494914">(</span><span class="op" id="8494915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494918">wg</span><span class="op" id="8494920">.</span><span class="ident" id="8494921">Wait</span><span class="op" id="8494925">(</span><span class="op" id="8494926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8494929">if</span>&nbsp;<span class="ident" id="8494932">fails</span>&nbsp;<span class="op" id="8494938">&gt;</span>&nbsp;<span class="ident" id="8494940">attempts</span><span class="op" id="8494948">/</span><span class="num" id="8494949">9</span>&nbsp;<span class="op" id="8494951">{</span>&nbsp;<span class="comment" id="8494953">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8494983">t</span><span class="op" id="8494984">.</span><span class="ident" id="8494985">Fatalf</span><span class="op" id="8494991">(</span><span class="string" id="8494992">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495018">,</span>&nbsp;<span class="ident" id="8495020">fails</span><span class="op" id="8495025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495028">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495031">if</span>&nbsp;<span class="ident" id="8495034">fails</span>&nbsp;<span class="op" id="8495040">&gt;</span>&nbsp;<span class="num" id="8495042">0</span>&nbsp;<span class="op" id="8495044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495048">t</span><span class="op" id="8495049">.</span><span class="ident" id="8495050">Logf</span><span class="op" id="8495054">(</span><span class="string" id="8495055">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="8495078">,</span>&nbsp;<span class="ident" id="8495080">fails</span><span class="op" id="8495085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495088">}</span><br>
<span class="lineno"></span><span class="op" id="8495090">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="8495093">func</span>&nbsp;<span class="ident" id="8495098">TestTCPReadWriteMallocs</span><span class="op" id="8495121">(</span><span class="ident" id="8495122">t</span>&nbsp;<span class="op" id="8495124">*</span><span class="ident" id="8495125">testing</span><span class="op" id="8495132">.</span><span class="ident" id="8495133">T</span><span class="op" id="8495134">)</span>&nbsp;<span class="op" id="8495136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495139">if</span>&nbsp;<span class="ident" id="8495142">testing</span><span class="op" id="8495149">.</span><span class="ident" id="8495150">Short</span><span class="op" id="8495155">(</span><span class="op" id="8495156">)</span>&nbsp;<span class="op" id="8495158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495162">t</span><span class="op" id="8495163">.</span><span class="ident" id="8495164">Skip</span><span class="op" id="8495168">(</span><span class="string" id="8495169">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="8495206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495212">ln</span><span class="op" id="8495214">,</span>&nbsp;<span class="ident" id="8495216">err</span>&nbsp;<span class="op" id="8495220">:=</span>&nbsp;<span class="ident" id="8495223">Listen</span><span class="op" id="8495229">(</span><span class="string" id="8495230">&#34;tcp&#34;</span><span class="op" id="8495235">,</span>&nbsp;<span class="string" id="8495237">&#34;127.0.0.1:0&#34;</span><span class="op" id="8495250">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495253">if</span>&nbsp;<span class="ident" id="8495256">err</span>&nbsp;<span class="op" id="8495260">!=</span>&nbsp;<span class="ident" id="8495263">nil</span>&nbsp;<span class="op" id="8495267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495271">t</span><span class="op" id="8495272">.</span><span class="ident" id="8495273">Fatalf</span><span class="op" id="8495279">(</span><span class="string" id="8495280">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495299">,</span>&nbsp;<span class="ident" id="8495301">err</span><span class="op" id="8495304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495310">defer</span>&nbsp;<span class="ident" id="8495316">ln</span><span class="op" id="8495318">.</span><span class="ident" id="8495319">Close</span><span class="op" id="8495324">(</span><span class="op" id="8495325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495328">var</span>&nbsp;<span class="ident" id="8495332">server</span>&nbsp;<span class="ident" id="8495339">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495345">errc</span>&nbsp;<span class="op" id="8495350">:=</span>&nbsp;<span class="builtinfunc" id="8495353">make</span><span class="op" id="8495357">(</span><span class="keyword" id="8495358">chan</span>&nbsp;<span class="builtintype" id="8495363">error</span><span class="op" id="8495368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495371">go</span>&nbsp;<span class="keyword" id="8495374">func</span><span class="op" id="8495378">(</span><span class="op" id="8495379">)</span>&nbsp;<span class="op" id="8495381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495385">var</span>&nbsp;<span class="ident" id="8495389">err</span>&nbsp;<span class="builtintype" id="8495393">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495401">server</span><span class="op" id="8495407">,</span>&nbsp;<span class="ident" id="8495409">err</span>&nbsp;<span class="op" id="8495413">=</span>&nbsp;<span class="ident" id="8495415">ln</span><span class="op" id="8495417">.</span><span class="ident" id="8495418">Accept</span><span class="op" id="8495424">(</span><span class="op" id="8495425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495429">errc</span>&nbsp;<span class="op" id="8495434">&lt;-</span>&nbsp;<span class="ident" id="8495437">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495442">}</span><span class="op" id="8495443">(</span><span class="op" id="8495444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495447">client</span><span class="op" id="8495453">,</span>&nbsp;<span class="ident" id="8495455">err</span>&nbsp;<span class="op" id="8495459">:=</span>&nbsp;<span class="ident" id="8495462">Dial</span><span class="op" id="8495466">(</span><span class="string" id="8495467">&#34;tcp&#34;</span><span class="op" id="8495472">,</span>&nbsp;<span class="ident" id="8495474">ln</span><span class="op" id="8495476">.</span><span class="ident" id="8495477">Addr</span><span class="op" id="8495481">(</span><span class="op" id="8495482">)</span><span class="op" id="8495483">.</span><span class="ident" id="8495484">String</span><span class="op" id="8495490">(</span><span class="op" id="8495491">)</span><span class="op" id="8495492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495495">if</span>&nbsp;<span class="ident" id="8495498">err</span>&nbsp;<span class="op" id="8495502">!=</span>&nbsp;<span class="ident" id="8495505">nil</span>&nbsp;<span class="op" id="8495509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495513">t</span><span class="op" id="8495514">.</span><span class="ident" id="8495515">Fatalf</span><span class="op" id="8495521">(</span><span class="string" id="8495522">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495539">,</span>&nbsp;<span class="ident" id="8495541">err</span><span class="op" id="8495544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495547">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495550">if</span>&nbsp;<span class="ident" id="8495553">err</span>&nbsp;<span class="op" id="8495557">:=</span>&nbsp;<span class="op" id="8495560">&lt;-</span><span class="ident" id="8495562">errc</span><span class="op" id="8495566">;</span>&nbsp;<span class="ident" id="8495568">err</span>&nbsp;<span class="op" id="8495572">!=</span>&nbsp;<span class="ident" id="8495575">nil</span>&nbsp;<span class="op" id="8495579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495583">t</span><span class="op" id="8495584">.</span><span class="ident" id="8495585">Fatalf</span><span class="op" id="8495591">(</span><span class="string" id="8495592">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495611">,</span>&nbsp;<span class="ident" id="8495613">err</span><span class="op" id="8495616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495622">defer</span>&nbsp;<span class="ident" id="8495628">server</span><span class="op" id="8495634">.</span><span class="ident" id="8495635">Close</span><span class="op" id="8495640">(</span><span class="op" id="8495641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495644">var</span>&nbsp;<span class="ident" id="8495648">buf</span>&nbsp;<span class="op" id="8495652">[</span><span class="num" id="8495653">128</span><span class="op" id="8495656">]</span><span class="builtintype" id="8495657">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495663">mallocs</span>&nbsp;<span class="op" id="8495671">:=</span>&nbsp;<span class="ident" id="8495674">testing</span><span class="op" id="8495681">.</span><span class="ident" id="8495682">AllocsPerRun</span><span class="op" id="8495694">(</span><span class="num" id="8495695">1000</span><span class="op" id="8495699">,</span>&nbsp;<span class="keyword" id="8495701">func</span><span class="op" id="8495705">(</span><span class="op" id="8495706">)</span>&nbsp;<span class="op" id="8495708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495712">_</span><span class="op" id="8495713">,</span>&nbsp;<span class="ident" id="8495715">err</span>&nbsp;<span class="op" id="8495719">:=</span>&nbsp;<span class="ident" id="8495722">server</span><span class="op" id="8495728">.</span><span class="ident" id="8495729">Write</span><span class="op" id="8495734">(</span><span class="ident" id="8495735">buf</span><span class="op" id="8495738">[</span><span class="op" id="8495739">:</span><span class="op" id="8495740">]</span><span class="op" id="8495741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495745">if</span>&nbsp;<span class="ident" id="8495748">err</span>&nbsp;<span class="op" id="8495752">!=</span>&nbsp;<span class="ident" id="8495755">nil</span>&nbsp;<span class="op" id="8495759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495764">t</span><span class="op" id="8495765">.</span><span class="ident" id="8495766">Fatalf</span><span class="op" id="8495772">(</span><span class="string" id="8495773">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495791">,</span>&nbsp;<span class="ident" id="8495793">err</span><span class="op" id="8495796">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495800">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495804">_</span><span class="op" id="8495805">,</span>&nbsp;<span class="ident" id="8495807">err</span>&nbsp;<span class="op" id="8495811">=</span>&nbsp;<span class="ident" id="8495813">io</span><span class="op" id="8495815">.</span><span class="ident" id="8495816">ReadFull</span><span class="op" id="8495824">(</span><span class="ident" id="8495825">client</span><span class="op" id="8495831">,</span>&nbsp;<span class="ident" id="8495833">buf</span><span class="op" id="8495836">[</span><span class="op" id="8495837">:</span><span class="op" id="8495838">]</span><span class="op" id="8495839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495843">if</span>&nbsp;<span class="ident" id="8495846">err</span>&nbsp;<span class="op" id="8495850">!=</span>&nbsp;<span class="ident" id="8495853">nil</span>&nbsp;<span class="op" id="8495857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495862">t</span><span class="op" id="8495863">.</span><span class="ident" id="8495864">Fatalf</span><span class="op" id="8495870">(</span><span class="string" id="8495871">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8495888">,</span>&nbsp;<span class="ident" id="8495890">err</span><span class="op" id="8495893">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495900">}</span><span class="op" id="8495901">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8495904">if</span>&nbsp;<span class="ident" id="8495907">mallocs</span>&nbsp;<span class="op" id="8495915">&gt;</span>&nbsp;<span class="num" id="8495917">0</span>&nbsp;<span class="op" id="8495919">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8495923">t</span><span class="op" id="8495924">.</span><span class="ident" id="8495925">Fatalf</span><span class="op" id="8495931">(</span><span class="string" id="8495932">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="8495955">,</span>&nbsp;<span class="ident" id="8495957">mallocs</span><span class="op" id="8495964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8495967">}</span><br>
<span class="lineno"></span><span class="op" id="8495969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="8495972">func</span>&nbsp;<span class="ident" id="8495977">TestTCPStress</span><span class="op" id="8495990">(</span><span class="ident" id="8495991">t</span>&nbsp;<span class="op" id="8495993">*</span><span class="ident" id="8495994">testing</span><span class="op" id="8496001">.</span><span class="ident" id="8496002">T</span><span class="op" id="8496003">)</span>&nbsp;<span class="op" id="8496005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496008">const</span>&nbsp;<span class="ident" id="8496014">conns</span>&nbsp;<span class="op" id="8496020">=</span>&nbsp;<span class="num" id="8496022">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496025">const</span>&nbsp;<span class="ident" id="8496031">msgLen</span>&nbsp;<span class="op" id="8496038">=</span>&nbsp;<span class="num" id="8496040">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496045">msgs</span>&nbsp;<span class="op" id="8496050">:=</span>&nbsp;<span class="builtintype" id="8496053">int</span><span class="op" id="8496056">(</span><span class="num" id="8496057">1e4</span><span class="op" id="8496060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496063">if</span>&nbsp;<span class="ident" id="8496066">testing</span><span class="op" id="8496073">.</span><span class="ident" id="8496074">Short</span><span class="op" id="8496079">(</span><span class="op" id="8496080">)</span>&nbsp;<span class="op" id="8496082">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496086">msgs</span>&nbsp;<span class="op" id="8496091">=</span>&nbsp;<span class="num" id="8496093">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496102">sendMsg</span>&nbsp;<span class="op" id="8496110">:=</span>&nbsp;<span class="keyword" id="8496113">func</span><span class="op" id="8496117">(</span><span class="ident" id="8496118">c</span>&nbsp;<span class="ident" id="8496120">Conn</span><span class="op" id="8496124">,</span>&nbsp;<span class="ident" id="8496126">buf</span>&nbsp;<span class="op" id="8496130">[</span><span class="op" id="8496131">]</span><span class="builtintype" id="8496132">byte</span><span class="op" id="8496136">)</span>&nbsp;<span class="builtintype" id="8496138">bool</span>&nbsp;<span class="op" id="8496143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496147">n</span><span class="op" id="8496148">,</span>&nbsp;<span class="ident" id="8496150">err</span>&nbsp;<span class="op" id="8496154">:=</span>&nbsp;<span class="ident" id="8496157">c</span><span class="op" id="8496158">.</span><span class="ident" id="8496159">Write</span><span class="op" id="8496164">(</span><span class="ident" id="8496165">buf</span><span class="op" id="8496168">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496172">if</span>&nbsp;<span class="ident" id="8496175">n</span>&nbsp;<span class="op" id="8496177">!=</span>&nbsp;<span class="builtinfunc" id="8496180">len</span><span class="op" id="8496183">(</span><span class="ident" id="8496184">buf</span><span class="op" id="8496187">)</span>&nbsp;<span class="op" id="8496189">||</span>&nbsp;<span class="ident" id="8496192">err</span>&nbsp;<span class="op" id="8496196">!=</span>&nbsp;<span class="ident" id="8496199">nil</span>&nbsp;<span class="op" id="8496203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496208">t</span><span class="op" id="8496209">.</span><span class="ident" id="8496210">Logf</span><span class="op" id="8496214">(</span><span class="string" id="8496215">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8496233">,</span>&nbsp;<span class="ident" id="8496235">err</span><span class="op" id="8496238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496243">return</span>&nbsp;<span class="builtintype" id="8496250">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496262">return</span>&nbsp;<span class="builtintype" id="8496269">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496278">recvMsg</span>&nbsp;<span class="op" id="8496286">:=</span>&nbsp;<span class="keyword" id="8496289">func</span><span class="op" id="8496293">(</span><span class="ident" id="8496294">c</span>&nbsp;<span class="ident" id="8496296">Conn</span><span class="op" id="8496300">,</span>&nbsp;<span class="ident" id="8496302">buf</span>&nbsp;<span class="op" id="8496306">[</span><span class="op" id="8496307">]</span><span class="builtintype" id="8496308">byte</span><span class="op" id="8496312">)</span>&nbsp;<span class="builtintype" id="8496314">bool</span>&nbsp;<span class="op" id="8496319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496323">for</span>&nbsp;<span class="ident" id="8496327">read</span>&nbsp;<span class="op" id="8496332">:=</span>&nbsp;<span class="num" id="8496335">0</span><span class="op" id="8496336">;</span>&nbsp;<span class="ident" id="8496338">read</span>&nbsp;<span class="op" id="8496343">!=</span>&nbsp;<span class="builtinfunc" id="8496346">len</span><span class="op" id="8496349">(</span><span class="ident" id="8496350">buf</span><span class="op" id="8496353">)</span><span class="op" id="8496354">;</span>&nbsp;<span class="op" id="8496356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496361">n</span><span class="op" id="8496362">,</span>&nbsp;<span class="ident" id="8496364">err</span>&nbsp;<span class="op" id="8496368">:=</span>&nbsp;<span class="ident" id="8496371">c</span><span class="op" id="8496372">.</span><span class="ident" id="8496373">Read</span><span class="op" id="8496377">(</span><span class="ident" id="8496378">buf</span><span class="op" id="8496381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496386">read</span>&nbsp;<span class="op" id="8496391">+=</span>&nbsp;<span class="ident" id="8496394">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496399">if</span>&nbsp;<span class="ident" id="8496402">err</span>&nbsp;<span class="op" id="8496406">!=</span>&nbsp;<span class="ident" id="8496409">nil</span>&nbsp;<span class="op" id="8496413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496419">t</span><span class="op" id="8496420">.</span><span class="ident" id="8496421">Logf</span><span class="op" id="8496425">(</span><span class="string" id="8496426">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8496443">,</span>&nbsp;<span class="ident" id="8496445">err</span><span class="op" id="8496448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496454">return</span>&nbsp;<span class="builtintype" id="8496461">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496474">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496478">return</span>&nbsp;<span class="builtintype" id="8496485">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496495">ln</span><span class="op" id="8496497">,</span>&nbsp;<span class="ident" id="8496499">err</span>&nbsp;<span class="op" id="8496503">:=</span>&nbsp;<span class="ident" id="8496506">Listen</span><span class="op" id="8496512">(</span><span class="string" id="8496513">&#34;tcp&#34;</span><span class="op" id="8496518">,</span>&nbsp;<span class="string" id="8496520">&#34;127.0.0.1:0&#34;</span><span class="op" id="8496533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496536">if</span>&nbsp;<span class="ident" id="8496539">err</span>&nbsp;<span class="op" id="8496543">!=</span>&nbsp;<span class="ident" id="8496546">nil</span>&nbsp;<span class="op" id="8496550">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496554">t</span><span class="op" id="8496555">.</span><span class="ident" id="8496556">Fatalf</span><span class="op" id="8496562">(</span><span class="string" id="8496563">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8496582">,</span>&nbsp;<span class="ident" id="8496584">err</span><span class="op" id="8496587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496593">defer</span>&nbsp;<span class="ident" id="8496599">ln</span><span class="op" id="8496601">.</span><span class="ident" id="8496602">Close</span><span class="op" id="8496607">(</span><span class="op" id="8496608">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8496611">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496625">go</span>&nbsp;<span class="keyword" id="8496628">func</span><span class="op" id="8496632">(</span><span class="op" id="8496633">)</span>&nbsp;<span class="op" id="8496635">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496639">for</span>&nbsp;<span class="op" id="8496643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496648">c</span><span class="op" id="8496649">,</span>&nbsp;<span class="ident" id="8496651">err</span>&nbsp;<span class="op" id="8496655">:=</span>&nbsp;<span class="ident" id="8496658">ln</span><span class="op" id="8496660">.</span><span class="ident" id="8496661">Accept</span><span class="op" id="8496667">(</span><span class="op" id="8496668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496673">if</span>&nbsp;<span class="ident" id="8496676">err</span>&nbsp;<span class="op" id="8496680">!=</span>&nbsp;<span class="ident" id="8496683">nil</span>&nbsp;<span class="op" id="8496687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496693">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496702">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8496707">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496732">go</span>&nbsp;<span class="keyword" id="8496735">func</span><span class="op" id="8496739">(</span><span class="ident" id="8496740">c</span>&nbsp;<span class="ident" id="8496742">Conn</span><span class="op" id="8496746">)</span>&nbsp;<span class="op" id="8496748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496754">defer</span>&nbsp;<span class="ident" id="8496760">c</span><span class="op" id="8496761">.</span><span class="ident" id="8496762">Close</span><span class="op" id="8496767">(</span><span class="op" id="8496768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496774">var</span>&nbsp;<span class="ident" id="8496778">buf</span>&nbsp;<span class="op" id="8496782">[</span><span class="ident" id="8496783">msgLen</span><span class="op" id="8496789">]</span><span class="builtintype" id="8496790">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496799">for</span>&nbsp;<span class="ident" id="8496803">m</span>&nbsp;<span class="op" id="8496805">:=</span>&nbsp;<span class="num" id="8496808">0</span><span class="op" id="8496809">;</span>&nbsp;<span class="ident" id="8496811">m</span>&nbsp;<span class="op" id="8496813">&lt;</span>&nbsp;<span class="ident" id="8496815">msgs</span><span class="op" id="8496819">;</span>&nbsp;<span class="ident" id="8496821">m</span><span class="op" id="8496822">++</span>&nbsp;<span class="op" id="8496825">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496832">if</span>&nbsp;<span class="op" id="8496835">!</span><span class="ident" id="8496836">recvMsg</span><span class="op" id="8496843">(</span><span class="ident" id="8496844">c</span><span class="op" id="8496845">,</span>&nbsp;<span class="ident" id="8496847">buf</span><span class="op" id="8496850">[</span><span class="op" id="8496851">:</span><span class="op" id="8496852">]</span><span class="op" id="8496853">)</span>&nbsp;<span class="op" id="8496855">||</span>&nbsp;<span class="op" id="8496858">!</span><span class="ident" id="8496859">sendMsg</span><span class="op" id="8496866">(</span><span class="ident" id="8496867">c</span><span class="op" id="8496868">,</span>&nbsp;<span class="ident" id="8496870">buf</span><span class="op" id="8496873">[</span><span class="op" id="8496874">:</span><span class="op" id="8496875">]</span><span class="op" id="8496876">)</span>&nbsp;<span class="op" id="8496878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496886">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496903">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496908">}</span><span class="op" id="8496909">(</span><span class="ident" id="8496910">c</span><span class="op" id="8496911">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496915">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8496918">}</span><span class="op" id="8496919">(</span><span class="op" id="8496920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8496923">done</span>&nbsp;<span class="op" id="8496928">:=</span>&nbsp;<span class="builtinfunc" id="8496931">make</span><span class="op" id="8496935">(</span><span class="keyword" id="8496936">chan</span>&nbsp;<span class="builtintype" id="8496941">bool</span><span class="op" id="8496945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8496948">for</span>&nbsp;<span class="ident" id="8496952">i</span>&nbsp;<span class="op" id="8496954">:=</span>&nbsp;<span class="num" id="8496957">0</span><span class="op" id="8496958">;</span>&nbsp;<span class="ident" id="8496960">i</span>&nbsp;<span class="op" id="8496962">&lt;</span>&nbsp;<span class="ident" id="8496964">conns</span><span class="op" id="8496969">;</span>&nbsp;<span class="ident" id="8496971">i</span><span class="op" id="8496972">++</span>&nbsp;<span class="op" id="8496975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8496979">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497003">go</span>&nbsp;<span class="keyword" id="8497006">func</span><span class="op" id="8497010">(</span><span class="op" id="8497011">)</span>&nbsp;<span class="op" id="8497013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497018">defer</span>&nbsp;<span class="keyword" id="8497024">func</span><span class="op" id="8497028">(</span><span class="op" id="8497029">)</span>&nbsp;<span class="op" id="8497031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8497037">done</span>&nbsp;<span class="op" id="8497042">&lt;-</span>&nbsp;<span class="builtintype" id="8497045">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497053">}</span><span class="op" id="8497054">(</span><span class="op" id="8497055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8497060">c</span><span class="op" id="8497061">,</span>&nbsp;<span class="ident" id="8497063">err</span>&nbsp;<span class="op" id="8497067">:=</span>&nbsp;<span class="ident" id="8497070">Dial</span><span class="op" id="8497074">(</span><span class="string" id="8497075">&#34;tcp&#34;</span><span class="op" id="8497080">,</span>&nbsp;<span class="ident" id="8497082">ln</span><span class="op" id="8497084">.</span><span class="ident" id="8497085">Addr</span><span class="op" id="8497089">(</span><span class="op" id="8497090">)</span><span class="op" id="8497091">.</span><span class="ident" id="8497092">String</span><span class="op" id="8497098">(</span><span class="op" id="8497099">)</span><span class="op" id="8497100">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497105">if</span>&nbsp;<span class="ident" id="8497108">err</span>&nbsp;<span class="op" id="8497112">!=</span>&nbsp;<span class="ident" id="8497115">nil</span>&nbsp;<span class="op" id="8497119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8497125">t</span><span class="op" id="8497126">.</span><span class="ident" id="8497127">Logf</span><span class="op" id="8497131">(</span><span class="string" id="8497132">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="8497149">,</span>&nbsp;<span class="ident" id="8497151">err</span><span class="op" id="8497154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497160">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497170">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497175">defer</span>&nbsp;<span class="ident" id="8497181">c</span><span class="op" id="8497182">.</span><span class="ident" id="8497183">Close</span><span class="op" id="8497188">(</span><span class="op" id="8497189">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497194">var</span>&nbsp;<span class="ident" id="8497198">buf</span>&nbsp;<span class="op" id="8497202">[</span><span class="ident" id="8497203">msgLen</span><span class="op" id="8497209">]</span><span class="builtintype" id="8497210">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497218">for</span>&nbsp;<span class="ident" id="8497222">m</span>&nbsp;<span class="op" id="8497224">:=</span>&nbsp;<span class="num" id="8497227">0</span><span class="op" id="8497228">;</span>&nbsp;<span class="ident" id="8497230">m</span>&nbsp;<span class="op" id="8497232">&lt;</span>&nbsp;<span class="ident" id="8497234">msgs</span><span class="op" id="8497238">;</span>&nbsp;<span class="ident" id="8497240">m</span><span class="op" id="8497241">++</span>&nbsp;<span class="op" id="8497244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497250">if</span>&nbsp;<span class="op" id="8497253">!</span><span class="ident" id="8497254">sendMsg</span><span class="op" id="8497261">(</span><span class="ident" id="8497262">c</span><span class="op" id="8497263">,</span>&nbsp;<span class="ident" id="8497265">buf</span><span class="op" id="8497268">[</span><span class="op" id="8497269">:</span><span class="op" id="8497270">]</span><span class="op" id="8497271">)</span>&nbsp;<span class="op" id="8497273">||</span>&nbsp;<span class="op" id="8497276">!</span><span class="ident" id="8497277">recvMsg</span><span class="op" id="8497284">(</span><span class="ident" id="8497285">c</span><span class="op" id="8497286">,</span>&nbsp;<span class="ident" id="8497288">buf</span><span class="op" id="8497291">[</span><span class="op" id="8497292">:</span><span class="op" id="8497293">]</span><span class="op" id="8497294">)</span>&nbsp;<span class="op" id="8497296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497303">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497313">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497318">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497322">}</span><span class="op" id="8497323">(</span><span class="op" id="8497324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8497330">for</span>&nbsp;<span class="ident" id="8497334">i</span>&nbsp;<span class="op" id="8497336">:=</span>&nbsp;<span class="num" id="8497339">0</span><span class="op" id="8497340">;</span>&nbsp;<span class="ident" id="8497342">i</span>&nbsp;<span class="op" id="8497344">&lt;</span>&nbsp;<span class="ident" id="8497346">conns</span><span class="op" id="8497351">;</span>&nbsp;<span class="ident" id="8497353">i</span><span class="op" id="8497354">++</span>&nbsp;<span class="op" id="8497357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497361">&lt;-</span><span class="ident" id="8497363">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8497369">}</span><br>
<span class="lineno"></span><span class="op" id="8497371">}</span>
</div>
</body>
</html>
