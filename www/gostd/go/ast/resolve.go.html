<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/ast</h2>
<ul>
<li><a href="/gostd/go/ast/ast.go.html">ast.go</a></li>
<li><a href="/gostd/go/ast/ast_test.go.html">ast_test.go</a></li>
<li><a href="/gostd/go/ast/commentmap.go.html">commentmap.go</a></li>
<li><a href="/gostd/go/ast/commentmap_test.go.html">commentmap_test.go</a></li>
<li><a href="/gostd/go/ast/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/go/ast/filter.go.html">filter.go</a></li>
<li><a href="/gostd/go/ast/filter_test.go.html">filter_test.go</a></li>
<li><a href="/gostd/go/ast/import.go.html">import.go</a></li>
<li><a href="/gostd/go/ast/print.go.html">print.go</a></li>
<li><a href="/gostd/go/ast/print_test.go.html">print_test.go</a></li>
<li><a href="/gostd/go/ast/resolve.go.html" class="current">resolve.go</a></li>
<li><a href="/gostd/go/ast/scope.go.html">scope.go</a></li>
<li><a href="/gostd/go/ast/walk.go.html">walk.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2857099">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2857154">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2857208">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="2857259">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2857296">package</span>&nbsp;<span class="ident" id="2857304">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2857309">import</span>&nbsp;<span class="op" id="2857316">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2857319">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2857326">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2857340">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="2857352">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="2857362">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="2857365">type</span>&nbsp;<span class="ident" id="2857370">pkgBuilder</span>&nbsp;<span class="keyword" id="2857381">struct</span>&nbsp;<span class="op" id="2857388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857391">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="2857398">*</span><span class="ident" id="2857399">token</span><span class="op" id="2857404">.</span><span class="ident" id="2857405">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857414">errors</span>&nbsp;<span class="ident" id="2857421">scanner</span><span class="op" id="2857428">.</span><span class="ident" id="2857429">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="2857439">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="2857442">func</span>&nbsp;<span class="op" id="2857447">(</span><span class="ident" id="2857448">p</span>&nbsp;<span class="op" id="2857450">*</span><span class="ident" id="2857451">pkgBuilder</span><span class="op" id="2857461">)</span>&nbsp;<span class="builtintype" id="2857463">error</span><span class="op" id="2857468">(</span><span class="ident" id="2857469">pos</span>&nbsp;<span class="ident" id="2857473">token</span><span class="op" id="2857478">.</span><span class="ident" id="2857479">Pos</span><span class="op" id="2857482">,</span>&nbsp;<span class="ident" id="2857484">msg</span>&nbsp;<span class="builtintype" id="2857488">string</span><span class="op" id="2857494">)</span>&nbsp;<span class="op" id="2857496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857499">p</span><span class="op" id="2857500">.</span><span class="ident" id="2857501">errors</span><span class="op" id="2857507">.</span><span class="ident" id="2857508">Add</span><span class="op" id="2857511">(</span><span class="ident" id="2857512">p</span><span class="op" id="2857513">.</span><span class="ident" id="2857514">fset</span><span class="op" id="2857518">.</span><span class="ident" id="2857519">Position</span><span class="op" id="2857527">(</span><span class="ident" id="2857528">pos</span><span class="op" id="2857531">)</span><span class="op" id="2857532">,</span>&nbsp;<span class="ident" id="2857534">msg</span><span class="op" id="2857537">)</span><br>
<span class="lineno"></span><span class="op" id="2857539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="2857542">func</span>&nbsp;<span class="op" id="2857547">(</span><span class="ident" id="2857548">p</span>&nbsp;<span class="op" id="2857550">*</span><span class="ident" id="2857551">pkgBuilder</span><span class="op" id="2857561">)</span>&nbsp;<span class="ident" id="2857563">errorf</span><span class="op" id="2857569">(</span><span class="ident" id="2857570">pos</span>&nbsp;<span class="ident" id="2857574">token</span><span class="op" id="2857579">.</span><span class="ident" id="2857580">Pos</span><span class="op" id="2857583">,</span>&nbsp;<span class="ident" id="2857585">format</span>&nbsp;<span class="builtintype" id="2857592">string</span><span class="op" id="2857598">,</span>&nbsp;<span class="ident" id="2857600">args</span>&nbsp;<span class="op" id="2857605">...</span><span class="keyword" id="2857608">interface</span><span class="op" id="2857617">{</span><span class="op" id="2857618">}</span><span class="op" id="2857619">)</span>&nbsp;<span class="op" id="2857621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857624">p</span><span class="op" id="2857625">.</span><span class="builtintype" id="2857626">error</span><span class="op" id="2857631">(</span><span class="ident" id="2857632">pos</span><span class="op" id="2857635">,</span>&nbsp;<span class="ident" id="2857637">fmt</span><span class="op" id="2857640">.</span><span class="ident" id="2857641">Sprintf</span><span class="op" id="2857648">(</span><span class="ident" id="2857649">format</span><span class="op" id="2857655">,</span>&nbsp;<span class="ident" id="2857657">args</span><span class="op" id="2857661">...</span><span class="op" id="2857664">)</span><span class="op" id="2857665">)</span><br>
<span class="lineno"></span><span class="op" id="2857667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2857670">func</span>&nbsp;<span class="op" id="2857675">(</span><span class="ident" id="2857676">p</span>&nbsp;<span class="op" id="2857678">*</span><span class="ident" id="2857679">pkgBuilder</span><span class="op" id="2857689">)</span>&nbsp;<span class="ident" id="2857691">declare</span><span class="op" id="2857698">(</span><span class="ident" id="2857699">scope</span><span class="op" id="2857704">,</span>&nbsp;<span class="ident" id="2857706">altScope</span>&nbsp;<span class="op" id="2857715">*</span><span class="ident" id="2857716">Scope</span><span class="op" id="2857721">,</span>&nbsp;<span class="ident" id="2857723">obj</span>&nbsp;<span class="op" id="2857727">*</span><span class="ident" id="2857728">Object</span><span class="op" id="2857734">)</span>&nbsp;<span class="op" id="2857736">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857739">alt</span>&nbsp;<span class="op" id="2857743">:=</span>&nbsp;<span class="ident" id="2857746">scope</span><span class="op" id="2857751">.</span><span class="ident" id="2857752">Insert</span><span class="op" id="2857758">(</span><span class="ident" id="2857759">obj</span><span class="op" id="2857762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2857765">if</span>&nbsp;<span class="ident" id="2857768">alt</span>&nbsp;<span class="op" id="2857772">==</span>&nbsp;<span class="ident" id="2857775">nil</span>&nbsp;<span class="op" id="2857779">&amp;&amp;</span>&nbsp;<span class="ident" id="2857782">altScope</span>&nbsp;<span class="op" id="2857791">!=</span>&nbsp;<span class="ident" id="2857794">nil</span>&nbsp;<span class="op" id="2857798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2857802">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857861">alt</span>&nbsp;<span class="op" id="2857865">=</span>&nbsp;<span class="ident" id="2857867">altScope</span><span class="op" id="2857875">.</span><span class="ident" id="2857876">Lookup</span><span class="op" id="2857882">(</span><span class="ident" id="2857883">obj</span><span class="op" id="2857886">.</span><span class="ident" id="2857887">Name</span><span class="op" id="2857891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2857894">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2857897">if</span>&nbsp;<span class="ident" id="2857900">alt</span>&nbsp;<span class="op" id="2857904">!=</span>&nbsp;<span class="ident" id="2857907">nil</span>&nbsp;<span class="op" id="2857911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857915">prevDecl</span>&nbsp;<span class="op" id="2857924">:=</span>&nbsp;<span class="string" id="2857927">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2857932">if</span>&nbsp;<span class="ident" id="2857935">pos</span>&nbsp;<span class="op" id="2857939">:=</span>&nbsp;<span class="ident" id="2857942">alt</span><span class="op" id="2857945">.</span><span class="ident" id="2857946">Pos</span><span class="op" id="2857949">(</span><span class="op" id="2857950">)</span><span class="op" id="2857951">;</span>&nbsp;<span class="ident" id="2857953">pos</span><span class="op" id="2857956">.</span><span class="ident" id="2857957">IsValid</span><span class="op" id="2857964">(</span><span class="op" id="2857965">)</span>&nbsp;<span class="op" id="2857967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2857972">prevDecl</span>&nbsp;<span class="op" id="2857981">=</span>&nbsp;<span class="ident" id="2857983">fmt</span><span class="op" id="2857986">.</span><span class="ident" id="2857987">Sprintf</span><span class="op" id="2857994">(</span><span class="string" id="2857995">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="2858027">,</span>&nbsp;<span class="ident" id="2858029">p</span><span class="op" id="2858030">.</span><span class="ident" id="2858031">fset</span><span class="op" id="2858035">.</span><span class="ident" id="2858036">Position</span><span class="op" id="2858044">(</span><span class="ident" id="2858045">pos</span><span class="op" id="2858048">)</span><span class="op" id="2858049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2858053">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2858057">p</span><span class="op" id="2858058">.</span><span class="builtintype" id="2858059">error</span><span class="op" id="2858064">(</span><span class="ident" id="2858065">obj</span><span class="op" id="2858068">.</span><span class="ident" id="2858069">Pos</span><span class="op" id="2858072">(</span><span class="op" id="2858073">)</span><span class="op" id="2858074">,</span>&nbsp;<span class="ident" id="2858076">fmt</span><span class="op" id="2858079">.</span><span class="ident" id="2858080">Sprintf</span><span class="op" id="2858087">(</span><span class="string" id="2858088">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="2858119">,</span>&nbsp;<span class="ident" id="2858121">obj</span><span class="op" id="2858124">.</span><span class="ident" id="2858125">Name</span><span class="op" id="2858129">,</span>&nbsp;<span class="ident" id="2858131">prevDecl</span><span class="op" id="2858139">)</span><span class="op" id="2858140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2858143">}</span><br>
<span class="lineno"></span><span class="op" id="2858145">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2858148">func</span>&nbsp;<span class="ident" id="2858153">resolve</span><span class="op" id="2858160">(</span><span class="ident" id="2858161">scope</span>&nbsp;<span class="op" id="2858167">*</span><span class="ident" id="2858168">Scope</span><span class="op" id="2858173">,</span>&nbsp;<span class="ident" id="2858175">ident</span>&nbsp;<span class="op" id="2858181">*</span><span class="ident" id="2858182">Ident</span><span class="op" id="2858187">)</span>&nbsp;<span class="builtintype" id="2858189">bool</span>&nbsp;<span class="op" id="2858194">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2858197">for</span>&nbsp;<span class="op" id="2858201">;</span>&nbsp;<span class="ident" id="2858203">scope</span>&nbsp;<span class="op" id="2858209">!=</span>&nbsp;<span class="ident" id="2858212">nil</span><span class="op" id="2858215">;</span>&nbsp;<span class="ident" id="2858217">scope</span>&nbsp;<span class="op" id="2858223">=</span>&nbsp;<span class="ident" id="2858225">scope</span><span class="op" id="2858230">.</span><span class="ident" id="2858231">Outer</span>&nbsp;<span class="op" id="2858237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2858241">if</span>&nbsp;<span class="ident" id="2858244">obj</span>&nbsp;<span class="op" id="2858248">:=</span>&nbsp;<span class="ident" id="2858251">scope</span><span class="op" id="2858256">.</span><span class="ident" id="2858257">Lookup</span><span class="op" id="2858263">(</span><span class="ident" id="2858264">ident</span><span class="op" id="2858269">.</span><span class="ident" id="2858270">Name</span><span class="op" id="2858274">)</span><span class="op" id="2858275">;</span>&nbsp;<span class="ident" id="2858277">obj</span>&nbsp;<span class="op" id="2858281">!=</span>&nbsp;<span class="ident" id="2858284">nil</span>&nbsp;<span class="op" id="2858288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2858293">ident</span><span class="op" id="2858298">.</span><span class="ident" id="2858299">Obj</span>&nbsp;<span class="op" id="2858303">=</span>&nbsp;<span class="ident" id="2858305">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2858312">return</span>&nbsp;<span class="builtintype" id="2858319">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2858326">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2858329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2858332">return</span>&nbsp;<span class="builtintype" id="2858339">false</span><br>
<span class="lineno"></span><span class="op" id="2858345">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2858348">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="2858405">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="2858463">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="2858513">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="2858573">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="2858642">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="2858707">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="2858772">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="2858836">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="2858851">type</span>&nbsp;<span class="ident" id="2858856">Importer</span>&nbsp;<span class="keyword" id="2858865">func</span><span class="op" id="2858869">(</span><span class="ident" id="2858870">imports</span>&nbsp;<span class="keyword" id="2858878">map</span><span class="op" id="2858881">[</span><span class="builtintype" id="2858882">string</span><span class="op" id="2858888">]</span><span class="op" id="2858889">*</span><span class="ident" id="2858890">Object</span><span class="op" id="2858896">,</span>&nbsp;<span class="ident" id="2858898">path</span>&nbsp;<span class="builtintype" id="2858903">string</span><span class="op" id="2858909">)</span>&nbsp;<span class="op" id="2858911">(</span><span class="ident" id="2858912">pkg</span>&nbsp;<span class="op" id="2858916">*</span><span class="ident" id="2858917">Object</span><span class="op" id="2858923">,</span>&nbsp;<span class="ident" id="2858925">err</span>&nbsp;<span class="builtintype" id="2858929">error</span><span class="op" id="2858934">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="2858937">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="2859016">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="2859095">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="2859175">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="2859252">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="2859329">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="2859406">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="2859464">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="2859542">//</span><br>
<span class="lineno"></span><span class="keyword" id="2859545">func</span>&nbsp;<span class="ident" id="2859550">NewPackage</span><span class="op" id="2859560">(</span><span class="ident" id="2859561">fset</span>&nbsp;<span class="op" id="2859566">*</span><span class="ident" id="2859567">token</span><span class="op" id="2859572">.</span><span class="ident" id="2859573">FileSet</span><span class="op" id="2859580">,</span>&nbsp;<span class="ident" id="2859582">files</span>&nbsp;<span class="keyword" id="2859588">map</span><span class="op" id="2859591">[</span><span class="builtintype" id="2859592">string</span><span class="op" id="2859598">]</span><span class="op" id="2859599">*</span><span class="ident" id="2859600">File</span><span class="op" id="2859604">,</span>&nbsp;<span class="ident" id="2859606">importer</span>&nbsp;<span class="ident" id="2859615">Importer</span><span class="op" id="2859623">,</span>&nbsp;<span class="ident" id="2859625">universe</span>&nbsp;<span class="op" id="2859634">*</span><span class="ident" id="2859635">Scope</span><span class="op" id="2859640">)</span>&nbsp;<span class="op" id="2859642">(</span><span class="op" id="2859643">*</span><span class="ident" id="2859644">Package</span><span class="op" id="2859651">,</span>&nbsp;<span class="builtintype" id="2859653">error</span><span class="op" id="2859658">)</span>&nbsp;<span class="op" id="2859660">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2859663">var</span>&nbsp;<span class="ident" id="2859667">p</span>&nbsp;<span class="ident" id="2859669">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2859681">p</span><span class="op" id="2859682">.</span><span class="ident" id="2859683">fset</span>&nbsp;<span class="op" id="2859688">=</span>&nbsp;<span class="ident" id="2859690">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2859697">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2859724">pkgName</span>&nbsp;<span class="op" id="2859732">:=</span>&nbsp;<span class="string" id="2859735">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2859739">pkgScope</span>&nbsp;<span class="op" id="2859748">:=</span>&nbsp;<span class="ident" id="2859751">NewScope</span><span class="op" id="2859759">(</span><span class="ident" id="2859760">universe</span><span class="op" id="2859768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2859771">for</span>&nbsp;<span class="ident" id="2859775">_</span><span class="op" id="2859776">,</span>&nbsp;<span class="ident" id="2859778">file</span>&nbsp;<span class="op" id="2859783">:=</span>&nbsp;<span class="keyword" id="2859786">range</span>&nbsp;<span class="ident" id="2859792">files</span>&nbsp;<span class="op" id="2859798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2859802">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2859832">switch</span>&nbsp;<span class="ident" id="2859839">name</span>&nbsp;<span class="op" id="2859844">:=</span>&nbsp;<span class="ident" id="2859847">file</span><span class="op" id="2859851">.</span><span class="ident" id="2859852">Name</span><span class="op" id="2859856">.</span><span class="ident" id="2859857">Name</span><span class="op" id="2859861">;</span>&nbsp;<span class="op" id="2859863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2859867">case</span>&nbsp;<span class="ident" id="2859872">pkgName</span>&nbsp;<span class="op" id="2859880">==</span>&nbsp;<span class="string" id="2859883">&#34;&#34;</span><span class="op" id="2859885">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2859890">pkgName</span>&nbsp;<span class="op" id="2859898">=</span>&nbsp;<span class="ident" id="2859900">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2859907">case</span>&nbsp;<span class="ident" id="2859912">name</span>&nbsp;<span class="op" id="2859917">!=</span>&nbsp;<span class="ident" id="2859920">pkgName</span><span class="op" id="2859927">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2859932">p</span><span class="op" id="2859933">.</span><span class="ident" id="2859934">errorf</span><span class="op" id="2859940">(</span><span class="ident" id="2859941">file</span><span class="op" id="2859945">.</span><span class="ident" id="2859946">Package</span><span class="op" id="2859953">,</span>&nbsp;<span class="string" id="2859955">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="2859980">,</span>&nbsp;<span class="ident" id="2859982">name</span><span class="op" id="2859986">,</span>&nbsp;<span class="ident" id="2859988">pkgName</span><span class="op" id="2859995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860000">continue</span>&nbsp;<span class="comment" id="2860009">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860031">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860036">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860089">for</span>&nbsp;<span class="ident" id="2860093">_</span><span class="op" id="2860094">,</span>&nbsp;<span class="ident" id="2860096">obj</span>&nbsp;<span class="op" id="2860100">:=</span>&nbsp;<span class="keyword" id="2860103">range</span>&nbsp;<span class="ident" id="2860109">file</span><span class="op" id="2860113">.</span><span class="ident" id="2860114">Scope</span><span class="op" id="2860119">.</span><span class="ident" id="2860120">Objects</span>&nbsp;<span class="op" id="2860128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860133">p</span><span class="op" id="2860134">.</span><span class="ident" id="2860135">declare</span><span class="op" id="2860142">(</span><span class="ident" id="2860143">pkgScope</span><span class="op" id="2860151">,</span>&nbsp;<span class="ident" id="2860153">nil</span><span class="op" id="2860156">,</span>&nbsp;<span class="ident" id="2860158">obj</span><span class="op" id="2860161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860165">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860172">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860242">imports</span>&nbsp;<span class="op" id="2860250">:=</span>&nbsp;<span class="builtinfunc" id="2860253">make</span><span class="op" id="2860257">(</span><span class="keyword" id="2860258">map</span><span class="op" id="2860261">[</span><span class="builtintype" id="2860262">string</span><span class="op" id="2860268">]</span><span class="op" id="2860269">*</span><span class="ident" id="2860270">Object</span><span class="op" id="2860276">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860280">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860342">for</span>&nbsp;<span class="ident" id="2860346">_</span><span class="op" id="2860347">,</span>&nbsp;<span class="ident" id="2860349">file</span>&nbsp;<span class="op" id="2860354">:=</span>&nbsp;<span class="keyword" id="2860357">range</span>&nbsp;<span class="ident" id="2860363">files</span>&nbsp;<span class="op" id="2860369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860373">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860427">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860466">if</span>&nbsp;<span class="ident" id="2860469">file</span><span class="op" id="2860473">.</span><span class="ident" id="2860474">Name</span><span class="op" id="2860478">.</span><span class="ident" id="2860479">Name</span>&nbsp;<span class="op" id="2860484">!=</span>&nbsp;<span class="ident" id="2860487">pkgName</span>&nbsp;<span class="op" id="2860495">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860500">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860516">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860564">importErrors</span>&nbsp;<span class="op" id="2860577">:=</span>&nbsp;<span class="builtintype" id="2860580">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860588">fileScope</span>&nbsp;<span class="op" id="2860598">:=</span>&nbsp;<span class="ident" id="2860601">NewScope</span><span class="op" id="2860609">(</span><span class="ident" id="2860610">pkgScope</span><span class="op" id="2860618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860622">for</span>&nbsp;<span class="ident" id="2860626">_</span><span class="op" id="2860627">,</span>&nbsp;<span class="ident" id="2860629">spec</span>&nbsp;<span class="op" id="2860634">:=</span>&nbsp;<span class="keyword" id="2860637">range</span>&nbsp;<span class="ident" id="2860643">file</span><span class="op" id="2860647">.</span><span class="ident" id="2860648">Imports</span>&nbsp;<span class="op" id="2860656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860661">if</span>&nbsp;<span class="ident" id="2860664">importer</span>&nbsp;<span class="op" id="2860673">==</span>&nbsp;<span class="ident" id="2860676">nil</span>&nbsp;<span class="op" id="2860680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860686">importErrors</span>&nbsp;<span class="op" id="2860699">=</span>&nbsp;<span class="builtintype" id="2860701">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860710">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860727">path</span><span class="op" id="2860731">,</span>&nbsp;<span class="ident" id="2860733">_</span>&nbsp;<span class="op" id="2860735">:=</span>&nbsp;<span class="ident" id="2860738">strconv</span><span class="op" id="2860745">.</span><span class="ident" id="2860746">Unquote</span><span class="op" id="2860753">(</span><span class="ident" id="2860754">spec</span><span class="op" id="2860758">.</span><span class="ident" id="2860759">Path</span><span class="op" id="2860763">.</span><span class="ident" id="2860764">Value</span><span class="op" id="2860769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860774">pkg</span><span class="op" id="2860777">,</span>&nbsp;<span class="ident" id="2860779">err</span>&nbsp;<span class="op" id="2860783">:=</span>&nbsp;<span class="ident" id="2860786">importer</span><span class="op" id="2860794">(</span><span class="ident" id="2860795">imports</span><span class="op" id="2860802">,</span>&nbsp;<span class="ident" id="2860804">path</span><span class="op" id="2860808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860813">if</span>&nbsp;<span class="ident" id="2860816">err</span>&nbsp;<span class="op" id="2860820">!=</span>&nbsp;<span class="ident" id="2860823">nil</span>&nbsp;<span class="op" id="2860827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860833">p</span><span class="op" id="2860834">.</span><span class="ident" id="2860835">errorf</span><span class="op" id="2860841">(</span><span class="ident" id="2860842">spec</span><span class="op" id="2860846">.</span><span class="ident" id="2860847">Path</span><span class="op" id="2860851">.</span><span class="ident" id="2860852">Pos</span><span class="op" id="2860855">(</span><span class="op" id="2860856">)</span><span class="op" id="2860857">,</span>&nbsp;<span class="string" id="2860859">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="2860885">,</span>&nbsp;<span class="ident" id="2860887">path</span><span class="op" id="2860891">,</span>&nbsp;<span class="ident" id="2860893">err</span><span class="op" id="2860896">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2860902">importErrors</span>&nbsp;<span class="op" id="2860915">=</span>&nbsp;<span class="builtintype" id="2860917">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2860926">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2860938">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2860943">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861003">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861064">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861127">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861176">name</span>&nbsp;<span class="op" id="2861181">:=</span>&nbsp;<span class="ident" id="2861184">pkg</span><span class="op" id="2861187">.</span><span class="ident" id="2861188">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2861196">if</span>&nbsp;<span class="ident" id="2861199">spec</span><span class="op" id="2861203">.</span><span class="ident" id="2861204">Name</span>&nbsp;<span class="op" id="2861209">!=</span>&nbsp;<span class="ident" id="2861212">nil</span>&nbsp;<span class="op" id="2861216">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861222">name</span>&nbsp;<span class="op" id="2861227">=</span>&nbsp;<span class="ident" id="2861229">spec</span><span class="op" id="2861233">.</span><span class="ident" id="2861234">Name</span><span class="op" id="2861238">.</span><span class="ident" id="2861239">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2861247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861253">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2861284">if</span>&nbsp;<span class="ident" id="2861287">name</span>&nbsp;<span class="op" id="2861292">==</span>&nbsp;<span class="string" id="2861295">&#34;.&#34;</span>&nbsp;<span class="op" id="2861299">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861305">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2861349">for</span>&nbsp;<span class="ident" id="2861353">_</span><span class="op" id="2861354">,</span>&nbsp;<span class="ident" id="2861356">obj</span>&nbsp;<span class="op" id="2861360">:=</span>&nbsp;<span class="keyword" id="2861363">range</span>&nbsp;<span class="ident" id="2861369">pkg</span><span class="op" id="2861372">.</span><span class="ident" id="2861373">Data</span><span class="op" id="2861377">.</span><span class="op" id="2861378">(</span><span class="op" id="2861379">*</span><span class="ident" id="2861380">Scope</span><span class="op" id="2861385">)</span><span class="op" id="2861386">.</span><span class="ident" id="2861387">Objects</span>&nbsp;<span class="op" id="2861395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861402">p</span><span class="op" id="2861403">.</span><span class="ident" id="2861404">declare</span><span class="op" id="2861411">(</span><span class="ident" id="2861412">fileScope</span><span class="op" id="2861421">,</span>&nbsp;<span class="ident" id="2861423">pkgScope</span><span class="op" id="2861431">,</span>&nbsp;<span class="ident" id="2861433">obj</span><span class="op" id="2861436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2861442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2861447">}</span>&nbsp;<span class="keyword" id="2861449">else</span>&nbsp;<span class="keyword" id="2861454">if</span>&nbsp;<span class="ident" id="2861457">name</span>&nbsp;<span class="op" id="2861462">!=</span>&nbsp;<span class="string" id="2861465">&#34;_&#34;</span>&nbsp;<span class="op" id="2861469">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861475">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861528">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861583">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861640">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861668">obj</span>&nbsp;<span class="op" id="2861672">:=</span>&nbsp;<span class="ident" id="2861675">NewObj</span><span class="op" id="2861681">(</span><span class="ident" id="2861682">Pkg</span><span class="op" id="2861685">,</span>&nbsp;<span class="ident" id="2861687">name</span><span class="op" id="2861691">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861697">obj</span><span class="op" id="2861700">.</span><span class="ident" id="2861701">Decl</span>&nbsp;<span class="op" id="2861706">=</span>&nbsp;<span class="ident" id="2861708">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861717">obj</span><span class="op" id="2861720">.</span><span class="ident" id="2861721">Data</span>&nbsp;<span class="op" id="2861726">=</span>&nbsp;<span class="ident" id="2861728">pkg</span><span class="op" id="2861731">.</span><span class="ident" id="2861732">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2861741">p</span><span class="op" id="2861742">.</span><span class="ident" id="2861743">declare</span><span class="op" id="2861750">(</span><span class="ident" id="2861751">fileScope</span><span class="op" id="2861760">,</span>&nbsp;<span class="ident" id="2861762">pkgScope</span><span class="op" id="2861770">,</span>&nbsp;<span class="ident" id="2861772">obj</span><span class="op" id="2861775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2861780">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2861784">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861789">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2861814">if</span>&nbsp;<span class="ident" id="2861817">importErrors</span>&nbsp;<span class="op" id="2861830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861835">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861894">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2861953">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="2862012">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862051">pkgScope</span><span class="op" id="2862059">.</span><span class="ident" id="2862060">Outer</span>&nbsp;<span class="op" id="2862066">=</span>&nbsp;<span class="ident" id="2862068">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2862074">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862078">i</span>&nbsp;<span class="op" id="2862080">:=</span>&nbsp;<span class="num" id="2862083">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2862087">for</span>&nbsp;<span class="ident" id="2862091">_</span><span class="op" id="2862092">,</span>&nbsp;<span class="ident" id="2862094">ident</span>&nbsp;<span class="op" id="2862100">:=</span>&nbsp;<span class="keyword" id="2862103">range</span>&nbsp;<span class="ident" id="2862109">file</span><span class="op" id="2862113">.</span><span class="ident" id="2862114">Unresolved</span>&nbsp;<span class="op" id="2862125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2862130">if</span>&nbsp;<span class="op" id="2862133">!</span><span class="ident" id="2862134">resolve</span><span class="op" id="2862141">(</span><span class="ident" id="2862142">fileScope</span><span class="op" id="2862151">,</span>&nbsp;<span class="ident" id="2862153">ident</span><span class="op" id="2862158">)</span>&nbsp;<span class="op" id="2862160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862166">p</span><span class="op" id="2862167">.</span><span class="ident" id="2862168">errorf</span><span class="op" id="2862174">(</span><span class="ident" id="2862175">ident</span><span class="op" id="2862180">.</span><span class="ident" id="2862181">Pos</span><span class="op" id="2862184">(</span><span class="op" id="2862185">)</span><span class="op" id="2862186">,</span>&nbsp;<span class="string" id="2862188">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="2862209">,</span>&nbsp;<span class="ident" id="2862211">ident</span><span class="op" id="2862216">.</span><span class="ident" id="2862217">Name</span><span class="op" id="2862221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862227">file</span><span class="op" id="2862231">.</span><span class="ident" id="2862232">Unresolved</span><span class="op" id="2862242">[</span><span class="ident" id="2862243">i</span><span class="op" id="2862244">]</span>&nbsp;<span class="op" id="2862246">=</span>&nbsp;<span class="ident" id="2862248">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862258">i</span><span class="op" id="2862259">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2862265">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2862270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862274">file</span><span class="op" id="2862278">.</span><span class="ident" id="2862279">Unresolved</span>&nbsp;<span class="op" id="2862290">=</span>&nbsp;<span class="ident" id="2862292">file</span><span class="op" id="2862296">.</span><span class="ident" id="2862297">Unresolved</span><span class="op" id="2862307">[</span><span class="num" id="2862308">0</span><span class="op" id="2862309">:</span><span class="ident" id="2862310">i</span><span class="op" id="2862311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862315">pkgScope</span><span class="op" id="2862323">.</span><span class="ident" id="2862324">Outer</span>&nbsp;<span class="op" id="2862330">=</span>&nbsp;<span class="ident" id="2862332">universe</span>&nbsp;<span class="comment" id="2862341">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="2862366">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="2862370">p</span><span class="op" id="2862371">.</span><span class="ident" id="2862372">errors</span><span class="op" id="2862378">.</span><span class="ident" id="2862379">Sort</span><span class="op" id="2862383">(</span><span class="op" id="2862384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="2862387">return</span>&nbsp;<span class="op" id="2862394">&amp;</span><span class="ident" id="2862395">Package</span><span class="op" id="2862402">{</span><span class="ident" id="2862403">pkgName</span><span class="op" id="2862410">,</span>&nbsp;<span class="ident" id="2862412">pkgScope</span><span class="op" id="2862420">,</span>&nbsp;<span class="ident" id="2862422">imports</span><span class="op" id="2862429">,</span>&nbsp;<span class="ident" id="2862431">files</span><span class="op" id="2862436">}</span><span class="op" id="2862437">,</span>&nbsp;<span class="ident" id="2862439">p</span><span class="op" id="2862440">.</span><span class="ident" id="2862441">errors</span><span class="op" id="2862447">.</span><span class="ident" id="2862448">Err</span><span class="op" id="2862451">(</span><span class="op" id="2862452">)</span><br>
<span class="lineno"></span><span class="op" id="2862454">}</span>
</div>
</body>
</html>
