<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html" class="current">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4191590">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4191645">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4191699">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4191750">//&nbsp;TLS&nbsp;low&nbsp;level&nbsp;connection&nbsp;and&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191796">package</span>&nbsp;<span class="ident" id="4191804">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4191809">import</span>&nbsp;<span class="op" id="4191816">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191819">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191828">&#34;crypto/cipher&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191845">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191862">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191877">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191887">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191894">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191900">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191907">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4191915">&#34;time&#34;</span><br>
<span class="lineno">20</span><span class="op" id="4191922">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4191925">//&nbsp;A&nbsp;Conn&nbsp;represents&nbsp;a&nbsp;secured&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4191968">//&nbsp;It&nbsp;implements&nbsp;the&nbsp;net.Conn&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="4192009">type</span>&nbsp;<span class="ident" id="4192014">Conn</span>&nbsp;<span class="keyword" id="4192019">struct</span>&nbsp;<span class="op" id="4192026">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192029">//&nbsp;constant</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192042">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192051">net</span><span class="op" id="4192054">.</span><span class="ident" id="4192055">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192061">isClient</span>&nbsp;<span class="builtintype" id="4192070">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192077">//&nbsp;constant&nbsp;after&nbsp;handshake;&nbsp;protected&nbsp;by&nbsp;handshakeMutex</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192135">handshakeMutex</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192153">sync</span><span class="op" id="4192157">.</span><span class="ident" id="4192158">Mutex</span>&nbsp;<span class="comment" id="4192164">//&nbsp;handshakeMutex&nbsp;&lt;&nbsp;in.Mutex,&nbsp;out.Mutex,&nbsp;errMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192215">handshakeErr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4192233">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192244">//&nbsp;error&nbsp;resulting&nbsp;from&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192279">vers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4192297">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192308">//&nbsp;TLS&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192324">haveVers</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4192342">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192353">//&nbsp;version&nbsp;has&nbsp;been&nbsp;negotiated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192385">config</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192403">*</span><span class="ident" id="4192404">Config</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192414">//&nbsp;configuration&nbsp;passed&nbsp;to&nbsp;constructor</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192454">handshakeComplete</span>&nbsp;<span class="builtintype" id="4192472">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192478">didResume</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4192496">bool</span>&nbsp;<span class="comment" id="4192501">//&nbsp;whether&nbsp;this&nbsp;connection&nbsp;was&nbsp;a&nbsp;session&nbsp;resumption</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192554">cipherSuite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4192572">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192580">ocspResponse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4192598">[</span><span class="op" id="4192599">]</span><span class="builtintype" id="4192600">byte</span>&nbsp;<span class="comment" id="4192605">//&nbsp;stapled&nbsp;OCSP&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192631">peerCertificates</span>&nbsp;&nbsp;<span class="op" id="4192649">[</span><span class="op" id="4192650">]</span><span class="op" id="4192651">*</span><span class="ident" id="4192652">x509</span><span class="op" id="4192656">.</span><span class="ident" id="4192657">Certificate</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192670">//&nbsp;verifiedChains&nbsp;contains&nbsp;the&nbsp;certificate&nbsp;chains&nbsp;that&nbsp;we&nbsp;built,&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192739">//&nbsp;opposed&nbsp;to&nbsp;the&nbsp;ones&nbsp;presented&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192788">verifiedChains</span>&nbsp;<span class="op" id="4192803">[</span><span class="op" id="4192804">]</span><span class="op" id="4192805">[</span><span class="op" id="4192806">]</span><span class="op" id="4192807">*</span><span class="ident" id="4192808">x509</span><span class="op" id="4192812">.</span><span class="ident" id="4192813">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192826">//&nbsp;serverName&nbsp;contains&nbsp;the&nbsp;server&nbsp;name&nbsp;indicated&nbsp;by&nbsp;the&nbsp;client,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4192899">serverName</span>&nbsp;<span class="builtintype" id="4192910">string</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192918">//&nbsp;firstFinished&nbsp;contains&nbsp;the&nbsp;first&nbsp;Finished&nbsp;hash&nbsp;sent&nbsp;during&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4192985">//&nbsp;handshake.&nbsp;This&nbsp;is&nbsp;the&nbsp;&#34;tls-unique&#34;&nbsp;channel&nbsp;binding&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193048">firstFinished</span>&nbsp;<span class="op" id="4193062">[</span><span class="num" id="4193063">12</span><span class="op" id="4193065">]</span><span class="builtintype" id="4193066">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193073">clientProtocol</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4193096">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193104">clientProtocolFallback</span>&nbsp;<span class="builtintype" id="4193127">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193134">//&nbsp;input/output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193151">in</span><span class="op" id="4193153">,</span>&nbsp;<span class="ident" id="4193155">out</span>&nbsp;&nbsp;<span class="ident" id="4193160">halfConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193173">//&nbsp;in.Mutex&nbsp;&lt;&nbsp;out.Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193198">rawInput</span>&nbsp;<span class="op" id="4193207">*</span><span class="ident" id="4193208">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193220">//&nbsp;raw&nbsp;input,&nbsp;right&nbsp;off&nbsp;the&nbsp;wire</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193254">input</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4193263">*</span><span class="ident" id="4193264">block</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4193276">//&nbsp;application&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193316">hand</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193325">bytes</span><span class="op" id="4193330">.</span><span class="ident" id="4193331">Buffer</span>&nbsp;<span class="comment" id="4193338">//&nbsp;handshake&nbsp;data&nbsp;waiting&nbsp;to&nbsp;be&nbsp;read</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4193377">tmp</span>&nbsp;<span class="op" id="4193381">[</span><span class="num" id="4193382">16</span><span class="op" id="4193384">]</span><span class="builtintype" id="4193385">byte</span><br>
<span class="lineno"></span><span class="op" id="4193390">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4193393">//&nbsp;Access&nbsp;to&nbsp;net.Conn&nbsp;methods.</span><br>
<span class="lineno"></span><span class="comment" id="4193424">//&nbsp;Cannot&nbsp;just&nbsp;embed&nbsp;net.Conn&nbsp;because&nbsp;that&nbsp;would</span><br>
<span class="lineno"></span><span class="comment" id="4193473">//&nbsp;export&nbsp;the&nbsp;struct&nbsp;field&nbsp;too.</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4193506">//&nbsp;LocalAddr&nbsp;returns&nbsp;the&nbsp;local&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4193554">func</span>&nbsp;<span class="op" id="4193559">(</span><span class="ident" id="4193560">c</span>&nbsp;<span class="op" id="4193562">*</span><span class="ident" id="4193563">Conn</span><span class="op" id="4193567">)</span>&nbsp;<span class="ident" id="4193569">LocalAddr</span><span class="op" id="4193578">(</span><span class="op" id="4193579">)</span>&nbsp;<span class="ident" id="4193581">net</span><span class="op" id="4193584">.</span><span class="ident" id="4193585">Addr</span>&nbsp;<span class="op" id="4193590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193593">return</span>&nbsp;<span class="ident" id="4193600">c</span><span class="op" id="4193601">.</span><span class="ident" id="4193602">conn</span><span class="op" id="4193606">.</span><span class="ident" id="4193607">LocalAddr</span><span class="op" id="4193616">(</span><span class="op" id="4193617">)</span><br>
<span class="lineno"></span><span class="op" id="4193619">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="4193622">//&nbsp;RemoteAddr&nbsp;returns&nbsp;the&nbsp;remote&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="4193672">func</span>&nbsp;<span class="op" id="4193677">(</span><span class="ident" id="4193678">c</span>&nbsp;<span class="op" id="4193680">*</span><span class="ident" id="4193681">Conn</span><span class="op" id="4193685">)</span>&nbsp;<span class="ident" id="4193687">RemoteAddr</span><span class="op" id="4193697">(</span><span class="op" id="4193698">)</span>&nbsp;<span class="ident" id="4193700">net</span><span class="op" id="4193703">.</span><span class="ident" id="4193704">Addr</span>&nbsp;<span class="op" id="4193709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4193712">return</span>&nbsp;<span class="ident" id="4193719">c</span><span class="op" id="4193720">.</span><span class="ident" id="4193721">conn</span><span class="op" id="4193725">.</span><span class="ident" id="4193726">RemoteAddr</span><span class="op" id="4193736">(</span><span class="op" id="4193737">)</span><br>
<span class="lineno"></span><span class="op" id="4193739">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="comment" id="4193742">//&nbsp;SetDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;and&nbsp;write&nbsp;deadlines&nbsp;associated&nbsp;with&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4193823">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;and&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="comment" id="4193885">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4193992">func</span>&nbsp;<span class="op" id="4193997">(</span><span class="ident" id="4193998">c</span>&nbsp;<span class="op" id="4194000">*</span><span class="ident" id="4194001">Conn</span><span class="op" id="4194005">)</span>&nbsp;<span class="ident" id="4194007">SetDeadline</span><span class="op" id="4194018">(</span><span class="ident" id="4194019">t</span>&nbsp;<span class="ident" id="4194021">time</span><span class="op" id="4194025">.</span><span class="ident" id="4194026">Time</span><span class="op" id="4194030">)</span>&nbsp;<span class="builtintype" id="4194032">error</span>&nbsp;<span class="op" id="4194038">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194041">return</span>&nbsp;<span class="ident" id="4194048">c</span><span class="op" id="4194049">.</span><span class="ident" id="4194050">conn</span><span class="op" id="4194054">.</span><span class="ident" id="4194055">SetDeadline</span><span class="op" id="4194066">(</span><span class="ident" id="4194067">t</span><span class="op" id="4194068">)</span><br>
<span class="lineno">80</span><span class="op" id="4194070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4194073">//&nbsp;SetReadDeadline&nbsp;sets&nbsp;the&nbsp;read&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4194145">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Read&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4194197">func</span>&nbsp;<span class="op" id="4194202">(</span><span class="ident" id="4194203">c</span>&nbsp;<span class="op" id="4194205">*</span><span class="ident" id="4194206">Conn</span><span class="op" id="4194210">)</span>&nbsp;<span class="ident" id="4194212">SetReadDeadline</span><span class="op" id="4194227">(</span><span class="ident" id="4194228">t</span>&nbsp;<span class="ident" id="4194230">time</span><span class="op" id="4194234">.</span><span class="ident" id="4194235">Time</span><span class="op" id="4194239">)</span>&nbsp;<span class="builtintype" id="4194241">error</span>&nbsp;<span class="op" id="4194247">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194250">return</span>&nbsp;<span class="ident" id="4194257">c</span><span class="op" id="4194258">.</span><span class="ident" id="4194259">conn</span><span class="op" id="4194263">.</span><span class="ident" id="4194264">SetReadDeadline</span><span class="op" id="4194279">(</span><span class="ident" id="4194280">t</span><span class="op" id="4194281">)</span><br>
<span class="lineno"></span><span class="op" id="4194283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4194286">//&nbsp;SetWriteDeadline&nbsp;sets&nbsp;the&nbsp;write&nbsp;deadline&nbsp;on&nbsp;the&nbsp;underlying&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="4194360">//&nbsp;A&nbsp;zero&nbsp;value&nbsp;for&nbsp;t&nbsp;means&nbsp;Write&nbsp;will&nbsp;not&nbsp;time&nbsp;out.</span><br>
<span class="lineno">90</span><span class="comment" id="4194413">//&nbsp;After&nbsp;a&nbsp;Write&nbsp;has&nbsp;timed&nbsp;out,&nbsp;the&nbsp;TLS&nbsp;state&nbsp;is&nbsp;corrupt&nbsp;and&nbsp;all&nbsp;future&nbsp;writes&nbsp;will&nbsp;return&nbsp;the&nbsp;same&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="4194520">func</span>&nbsp;<span class="op" id="4194525">(</span><span class="ident" id="4194526">c</span>&nbsp;<span class="op" id="4194528">*</span><span class="ident" id="4194529">Conn</span><span class="op" id="4194533">)</span>&nbsp;<span class="ident" id="4194535">SetWriteDeadline</span><span class="op" id="4194551">(</span><span class="ident" id="4194552">t</span>&nbsp;<span class="ident" id="4194554">time</span><span class="op" id="4194558">.</span><span class="ident" id="4194559">Time</span><span class="op" id="4194563">)</span>&nbsp;<span class="builtintype" id="4194565">error</span>&nbsp;<span class="op" id="4194571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4194574">return</span>&nbsp;<span class="ident" id="4194581">c</span><span class="op" id="4194582">.</span><span class="ident" id="4194583">conn</span><span class="op" id="4194587">.</span><span class="ident" id="4194588">SetWriteDeadline</span><span class="op" id="4194604">(</span><span class="ident" id="4194605">t</span><span class="op" id="4194606">)</span><br>
<span class="lineno"></span><span class="op" id="4194608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="4194611">//&nbsp;A&nbsp;halfConn&nbsp;represents&nbsp;one&nbsp;direction&nbsp;of&nbsp;the&nbsp;record&nbsp;layer</span><br>
<span class="lineno"></span><span class="comment" id="4194670">//&nbsp;connection,&nbsp;either&nbsp;sending&nbsp;or&nbsp;receiving.</span><br>
<span class="lineno"></span><span class="keyword" id="4194714">type</span>&nbsp;<span class="ident" id="4194719">halfConn</span>&nbsp;<span class="keyword" id="4194728">struct</span>&nbsp;<span class="op" id="4194735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194738">sync</span><span class="op" id="4194742">.</span><span class="ident" id="4194743">Mutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194751">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4194759">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4194771">//&nbsp;first&nbsp;permanent&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194797">version</span>&nbsp;<span class="builtintype" id="4194805">uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4194817">//&nbsp;protocol&nbsp;version</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194838">cipher</span>&nbsp;&nbsp;<span class="keyword" id="4194846">interface</span><span class="op" id="4194855">{</span><span class="op" id="4194856">}</span>&nbsp;<span class="comment" id="4194858">//&nbsp;cipher&nbsp;algorithm</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194879">mac</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194887">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194900">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4194908">[</span><span class="num" id="4194909">8</span><span class="op" id="4194910">]</span><span class="builtintype" id="4194911">byte</span>&nbsp;<span class="comment" id="4194916">//&nbsp;64-bit&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194943">bfree</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4194951">*</span><span class="ident" id="4194952">block</span>&nbsp;&nbsp;<span class="comment" id="4194959">//&nbsp;list&nbsp;of&nbsp;free&nbsp;blocks</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4194984">nextCipher</span>&nbsp;<span class="keyword" id="4194995">interface</span><span class="op" id="4195004">{</span><span class="op" id="4195005">}</span>&nbsp;<span class="comment" id="4195007">//&nbsp;next&nbsp;encryption&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195033">nextMac</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195044">macFunction</span>&nbsp;<span class="comment" id="4195056">//&nbsp;next&nbsp;MAC&nbsp;algorithm</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4195080">//&nbsp;used&nbsp;to&nbsp;save&nbsp;allocating&nbsp;a&nbsp;new&nbsp;buffer&nbsp;for&nbsp;each&nbsp;MAC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195135">inDigestBuf</span><span class="op" id="4195146">,</span>&nbsp;<span class="ident" id="4195148">outDigestBuf</span>&nbsp;<span class="op" id="4195161">[</span><span class="op" id="4195162">]</span><span class="builtintype" id="4195163">byte</span><br>
<span class="lineno"></span><span class="op" id="4195168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4195171">func</span>&nbsp;<span class="op" id="4195176">(</span><span class="ident" id="4195177">hc</span>&nbsp;<span class="op" id="4195180">*</span><span class="ident" id="4195181">halfConn</span><span class="op" id="4195189">)</span>&nbsp;<span class="ident" id="4195191">setErrorLocked</span><span class="op" id="4195205">(</span><span class="ident" id="4195206">err</span>&nbsp;<span class="builtintype" id="4195210">error</span><span class="op" id="4195215">)</span>&nbsp;<span class="builtintype" id="4195217">error</span>&nbsp;<span class="op" id="4195223">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195226">hc</span><span class="op" id="4195228">.</span><span class="ident" id="4195229">err</span>&nbsp;<span class="op" id="4195233">=</span>&nbsp;<span class="ident" id="4195235">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195240">return</span>&nbsp;<span class="ident" id="4195247">err</span><br>
<span class="lineno"></span><span class="op" id="4195251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4195254">func</span>&nbsp;<span class="op" id="4195259">(</span><span class="ident" id="4195260">hc</span>&nbsp;<span class="op" id="4195263">*</span><span class="ident" id="4195264">halfConn</span><span class="op" id="4195272">)</span>&nbsp;<span class="builtintype" id="4195274">error</span><span class="op" id="4195279">(</span><span class="op" id="4195280">)</span>&nbsp;<span class="builtintype" id="4195282">error</span>&nbsp;<span class="op" id="4195288">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195291">hc</span><span class="op" id="4195293">.</span><span class="ident" id="4195294">Lock</span><span class="op" id="4195298">(</span><span class="op" id="4195299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195302">err</span>&nbsp;<span class="op" id="4195306">:=</span>&nbsp;<span class="ident" id="4195309">hc</span><span class="op" id="4195311">.</span><span class="ident" id="4195312">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195317">hc</span><span class="op" id="4195319">.</span><span class="ident" id="4195320">Unlock</span><span class="op" id="4195326">(</span><span class="op" id="4195327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195330">return</span>&nbsp;<span class="ident" id="4195337">err</span><br>
<span class="lineno"></span><span class="op" id="4195341">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="comment" id="4195344">//&nbsp;prepareCipherSpec&nbsp;sets&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno"></span><span class="comment" id="4195400">//&nbsp;that&nbsp;a&nbsp;subsequent&nbsp;changeCipherSpec&nbsp;will&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="4195448">func</span>&nbsp;<span class="op" id="4195453">(</span><span class="ident" id="4195454">hc</span>&nbsp;<span class="op" id="4195457">*</span><span class="ident" id="4195458">halfConn</span><span class="op" id="4195466">)</span>&nbsp;<span class="ident" id="4195468">prepareCipherSpec</span><span class="op" id="4195485">(</span><span class="ident" id="4195486">version</span>&nbsp;<span class="builtintype" id="4195494">uint16</span><span class="op" id="4195500">,</span>&nbsp;<span class="ident" id="4195502">cipher</span>&nbsp;<span class="keyword" id="4195509">interface</span><span class="op" id="4195518">{</span><span class="op" id="4195519">}</span><span class="op" id="4195520">,</span>&nbsp;<span class="ident" id="4195522">mac</span>&nbsp;<span class="ident" id="4195526">macFunction</span><span class="op" id="4195537">)</span>&nbsp;<span class="op" id="4195539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195542">hc</span><span class="op" id="4195544">.</span><span class="ident" id="4195545">version</span>&nbsp;<span class="op" id="4195553">=</span>&nbsp;<span class="ident" id="4195555">version</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195564">hc</span><span class="op" id="4195566">.</span><span class="ident" id="4195567">nextCipher</span>&nbsp;<span class="op" id="4195578">=</span>&nbsp;<span class="ident" id="4195580">cipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195588">hc</span><span class="op" id="4195590">.</span><span class="ident" id="4195591">nextMac</span>&nbsp;<span class="op" id="4195599">=</span>&nbsp;<span class="ident" id="4195601">mac</span><br>
<span class="lineno"></span><span class="op" id="4195605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4195608">//&nbsp;changeCipherSpec&nbsp;changes&nbsp;the&nbsp;encryption&nbsp;and&nbsp;MAC&nbsp;states</span><br>
<span class="lineno">135</span><span class="comment" id="4195666">//&nbsp;to&nbsp;the&nbsp;ones&nbsp;previously&nbsp;passed&nbsp;to&nbsp;prepareCipherSpec.</span><br>
<span class="lineno"></span><span class="keyword" id="4195721">func</span>&nbsp;<span class="op" id="4195726">(</span><span class="ident" id="4195727">hc</span>&nbsp;<span class="op" id="4195730">*</span><span class="ident" id="4195731">halfConn</span><span class="op" id="4195739">)</span>&nbsp;<span class="ident" id="4195741">changeCipherSpec</span><span class="op" id="4195757">(</span><span class="op" id="4195758">)</span>&nbsp;<span class="builtintype" id="4195760">error</span>&nbsp;<span class="op" id="4195766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195769">if</span>&nbsp;<span class="ident" id="4195772">hc</span><span class="op" id="4195774">.</span><span class="ident" id="4195775">nextCipher</span>&nbsp;<span class="op" id="4195786">==</span>&nbsp;<span class="builtintype" id="4195789">nil</span>&nbsp;<span class="op" id="4195793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195797">return</span>&nbsp;<span class="ident" id="4195804">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195824">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195827">hc</span><span class="op" id="4195829">.</span><span class="ident" id="4195830">cipher</span>&nbsp;<span class="op" id="4195837">=</span>&nbsp;<span class="ident" id="4195839">hc</span><span class="op" id="4195841">.</span><span class="ident" id="4195842">nextCipher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195854">hc</span><span class="op" id="4195856">.</span><span class="ident" id="4195857">mac</span>&nbsp;<span class="op" id="4195861">=</span>&nbsp;<span class="ident" id="4195863">hc</span><span class="op" id="4195865">.</span><span class="ident" id="4195866">nextMac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195875">hc</span><span class="op" id="4195877">.</span><span class="ident" id="4195878">nextCipher</span>&nbsp;<span class="op" id="4195889">=</span>&nbsp;<span class="builtintype" id="4195891">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195896">hc</span><span class="op" id="4195898">.</span><span class="ident" id="4195899">nextMac</span>&nbsp;<span class="op" id="4195907">=</span>&nbsp;<span class="builtintype" id="4195909">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195914">for</span>&nbsp;<span class="ident" id="4195918">i</span>&nbsp;<span class="op" id="4195920">:=</span>&nbsp;<span class="keyword" id="4195923">range</span>&nbsp;<span class="ident" id="4195929">hc</span><span class="op" id="4195931">.</span><span class="ident" id="4195932">seq</span>&nbsp;<span class="op" id="4195936">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4195940">hc</span><span class="op" id="4195942">.</span><span class="ident" id="4195943">seq</span><span class="op" id="4195946">[</span><span class="ident" id="4195947">i</span><span class="op" id="4195948">]</span>&nbsp;<span class="op" id="4195950">=</span>&nbsp;<span class="num" id="4195952">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4195955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4195958">return</span>&nbsp;<span class="builtintype" id="4195965">nil</span><br>
<span class="lineno"></span><span class="op" id="4195969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4195972">//&nbsp;incSeq&nbsp;increments&nbsp;the&nbsp;sequence&nbsp;number.</span><br>
<span class="lineno"></span><span class="keyword" id="4196014">func</span>&nbsp;<span class="op" id="4196019">(</span><span class="ident" id="4196020">hc</span>&nbsp;<span class="op" id="4196023">*</span><span class="ident" id="4196024">halfConn</span><span class="op" id="4196032">)</span>&nbsp;<span class="ident" id="4196034">incSeq</span><span class="op" id="4196040">(</span><span class="op" id="4196041">)</span>&nbsp;<span class="op" id="4196043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196046">for</span>&nbsp;<span class="ident" id="4196050">i</span>&nbsp;<span class="op" id="4196052">:=</span>&nbsp;<span class="num" id="4196055">7</span><span class="op" id="4196056">;</span>&nbsp;<span class="ident" id="4196058">i</span>&nbsp;<span class="op" id="4196060">&gt;=</span>&nbsp;<span class="num" id="4196063">0</span><span class="op" id="4196064">;</span>&nbsp;<span class="ident" id="4196066">i</span><span class="op" id="4196067">--</span>&nbsp;<span class="op" id="4196070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196074">hc</span><span class="op" id="4196076">.</span><span class="ident" id="4196077">seq</span><span class="op" id="4196080">[</span><span class="ident" id="4196081">i</span><span class="op" id="4196082">]</span><span class="op" id="4196083">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196088">if</span>&nbsp;<span class="ident" id="4196091">hc</span><span class="op" id="4196093">.</span><span class="ident" id="4196094">seq</span><span class="op" id="4196097">[</span><span class="ident" id="4196098">i</span><span class="op" id="4196099">]</span>&nbsp;<span class="op" id="4196101">!=</span>&nbsp;<span class="num" id="4196104">0</span>&nbsp;<span class="op" id="4196106">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196111">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196123">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196127">//&nbsp;Not&nbsp;allowed&nbsp;to&nbsp;let&nbsp;sequence&nbsp;number&nbsp;wrap.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196172">//&nbsp;Instead,&nbsp;must&nbsp;renegotiate&nbsp;before&nbsp;it&nbsp;does.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196218">//&nbsp;Not&nbsp;likely&nbsp;enough&nbsp;to&nbsp;bother.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4196251">panic</span><span class="op" id="4196256">(</span><span class="string" id="4196257">&#34;TLS:&nbsp;sequence&nbsp;number&nbsp;wraparound&#34;</span><span class="op" id="4196290">)</span><br>
<span class="lineno"></span><span class="op" id="4196292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="4196295">//&nbsp;resetSeq&nbsp;resets&nbsp;the&nbsp;sequence&nbsp;number&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span><span class="keyword" id="4196343">func</span>&nbsp;<span class="op" id="4196348">(</span><span class="ident" id="4196349">hc</span>&nbsp;<span class="op" id="4196352">*</span><span class="ident" id="4196353">halfConn</span><span class="op" id="4196361">)</span>&nbsp;<span class="ident" id="4196363">resetSeq</span><span class="op" id="4196371">(</span><span class="op" id="4196372">)</span>&nbsp;<span class="op" id="4196374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196377">for</span>&nbsp;<span class="ident" id="4196381">i</span>&nbsp;<span class="op" id="4196383">:=</span>&nbsp;<span class="keyword" id="4196386">range</span>&nbsp;<span class="ident" id="4196392">hc</span><span class="op" id="4196394">.</span><span class="ident" id="4196395">seq</span>&nbsp;<span class="op" id="4196399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196403">hc</span><span class="op" id="4196405">.</span><span class="ident" id="4196406">seq</span><span class="op" id="4196409">[</span><span class="ident" id="4196410">i</span><span class="op" id="4196411">]</span>&nbsp;<span class="op" id="4196413">=</span>&nbsp;<span class="num" id="4196415">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196418">}</span><br>
<span class="lineno">170</span><span class="op" id="4196420">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4196423">//&nbsp;removePadding&nbsp;returns&nbsp;an&nbsp;unpadded&nbsp;slice,&nbsp;in&nbsp;constant&nbsp;time,&nbsp;which&nbsp;is&nbsp;a&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="4196503">//&nbsp;of&nbsp;the&nbsp;input.&nbsp;It&nbsp;also&nbsp;returns&nbsp;a&nbsp;byte&nbsp;which&nbsp;is&nbsp;equal&nbsp;to&nbsp;255&nbsp;if&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4196580">//&nbsp;was&nbsp;valid&nbsp;and&nbsp;0&nbsp;otherwise.&nbsp;See&nbsp;RFC&nbsp;2246,&nbsp;section&nbsp;6.2.3.2</span><br>
<span class="lineno">175</span><span class="keyword" id="4196640">func</span>&nbsp;<span class="ident" id="4196645">removePadding</span><span class="op" id="4196658">(</span><span class="ident" id="4196659">payload</span>&nbsp;<span class="op" id="4196667">[</span><span class="op" id="4196668">]</span><span class="builtintype" id="4196669">byte</span><span class="op" id="4196673">)</span>&nbsp;<span class="op" id="4196675">(</span><span class="op" id="4196676">[</span><span class="op" id="4196677">]</span><span class="builtintype" id="4196678">byte</span><span class="op" id="4196682">,</span>&nbsp;<span class="builtintype" id="4196684">byte</span><span class="op" id="4196688">)</span>&nbsp;<span class="op" id="4196690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196693">if</span>&nbsp;<span class="builtinfunc" id="4196696">len</span><span class="op" id="4196699">(</span><span class="ident" id="4196700">payload</span><span class="op" id="4196707">)</span>&nbsp;<span class="op" id="4196709">&lt;</span>&nbsp;<span class="num" id="4196711">1</span>&nbsp;<span class="op" id="4196713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4196717">return</span>&nbsp;<span class="ident" id="4196724">payload</span><span class="op" id="4196731">,</span>&nbsp;<span class="num" id="4196733">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4196736">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196740">paddingLen</span>&nbsp;<span class="op" id="4196751">:=</span>&nbsp;<span class="ident" id="4196754">payload</span><span class="op" id="4196761">[</span><span class="builtinfunc" id="4196762">len</span><span class="op" id="4196765">(</span><span class="ident" id="4196766">payload</span><span class="op" id="4196773">)</span><span class="op" id="4196774">-</span><span class="num" id="4196775">1</span><span class="op" id="4196776">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196779">t</span>&nbsp;<span class="op" id="4196781">:=</span>&nbsp;<span class="builtintype" id="4196784">uint</span><span class="op" id="4196788">(</span><span class="builtinfunc" id="4196789">len</span><span class="op" id="4196792">(</span><span class="ident" id="4196793">payload</span><span class="op" id="4196800">)</span><span class="op" id="4196801">-</span><span class="num" id="4196802">1</span><span class="op" id="4196803">)</span>&nbsp;<span class="op" id="4196805">-</span>&nbsp;<span class="builtintype" id="4196807">uint</span><span class="op" id="4196811">(</span><span class="ident" id="4196812">paddingLen</span><span class="op" id="4196822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196825">//&nbsp;if&nbsp;len(payload)&nbsp;&gt;=&nbsp;(paddingLen&nbsp;-&nbsp;1)&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196891">good</span>&nbsp;<span class="op" id="4196896">:=</span>&nbsp;<span class="builtintype" id="4196899">byte</span><span class="op" id="4196903">(</span><span class="builtintype" id="4196904">int32</span><span class="op" id="4196909">(</span><span class="op" id="4196910">^</span><span class="ident" id="4196911">t</span><span class="op" id="4196912">)</span>&nbsp;<span class="op" id="4196914">&gt;&gt;</span>&nbsp;<span class="num" id="4196917">31</span><span class="op" id="4196919">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4196923">toCheck</span>&nbsp;<span class="op" id="4196931">:=</span>&nbsp;<span class="num" id="4196934">255</span>&nbsp;<span class="comment" id="4196938">//&nbsp;the&nbsp;maximum&nbsp;possible&nbsp;padding&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4196978">//&nbsp;The&nbsp;length&nbsp;of&nbsp;the&nbsp;padded&nbsp;data&nbsp;is&nbsp;public,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;an&nbsp;if&nbsp;here</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197048">if</span>&nbsp;<span class="ident" id="4197051">toCheck</span><span class="op" id="4197058">+</span><span class="num" id="4197059">1</span>&nbsp;<span class="op" id="4197061">&gt;</span>&nbsp;<span class="builtinfunc" id="4197063">len</span><span class="op" id="4197066">(</span><span class="ident" id="4197067">payload</span><span class="op" id="4197074">)</span>&nbsp;<span class="op" id="4197076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197080">toCheck</span>&nbsp;<span class="op" id="4197088">=</span>&nbsp;<span class="builtinfunc" id="4197090">len</span><span class="op" id="4197093">(</span><span class="ident" id="4197094">payload</span><span class="op" id="4197101">)</span>&nbsp;<span class="op" id="4197103">-</span>&nbsp;<span class="num" id="4197105">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4197108">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197112">for</span>&nbsp;<span class="ident" id="4197116">i</span>&nbsp;<span class="op" id="4197118">:=</span>&nbsp;<span class="num" id="4197121">0</span><span class="op" id="4197122">;</span>&nbsp;<span class="ident" id="4197124">i</span>&nbsp;<span class="op" id="4197126">&lt;</span>&nbsp;<span class="ident" id="4197128">toCheck</span><span class="op" id="4197135">;</span>&nbsp;<span class="ident" id="4197137">i</span><span class="op" id="4197138">++</span>&nbsp;<span class="op" id="4197141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197145">t</span>&nbsp;<span class="op" id="4197147">:=</span>&nbsp;<span class="builtintype" id="4197150">uint</span><span class="op" id="4197154">(</span><span class="ident" id="4197155">paddingLen</span><span class="op" id="4197165">)</span>&nbsp;<span class="op" id="4197167">-</span>&nbsp;<span class="builtintype" id="4197169">uint</span><span class="op" id="4197173">(</span><span class="ident" id="4197174">i</span><span class="op" id="4197175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4197179">//&nbsp;if&nbsp;i&nbsp;&lt;=&nbsp;paddingLen&nbsp;then&nbsp;the&nbsp;MSB&nbsp;of&nbsp;t&nbsp;is&nbsp;zero</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197229">mask</span>&nbsp;<span class="op" id="4197234">:=</span>&nbsp;<span class="builtintype" id="4197237">byte</span><span class="op" id="4197241">(</span><span class="builtintype" id="4197242">int32</span><span class="op" id="4197247">(</span><span class="op" id="4197248">^</span><span class="ident" id="4197249">t</span><span class="op" id="4197250">)</span>&nbsp;<span class="op" id="4197252">&gt;&gt;</span>&nbsp;<span class="num" id="4197255">31</span><span class="op" id="4197257">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197261">b</span>&nbsp;<span class="op" id="4197263">:=</span>&nbsp;<span class="ident" id="4197266">payload</span><span class="op" id="4197273">[</span><span class="builtinfunc" id="4197274">len</span><span class="op" id="4197277">(</span><span class="ident" id="4197278">payload</span><span class="op" id="4197285">)</span><span class="op" id="4197286">-</span><span class="num" id="4197287">1</span><span class="op" id="4197288">-</span><span class="ident" id="4197289">i</span><span class="op" id="4197290">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197294">good</span>&nbsp;<span class="op" id="4197299">&amp;^=</span>&nbsp;<span class="ident" id="4197303">mask</span><span class="op" id="4197307">&amp;</span><span class="ident" id="4197308">paddingLen</span>&nbsp;<span class="op" id="4197319">^</span>&nbsp;<span class="ident" id="4197321">mask</span><span class="op" id="4197325">&amp;</span><span class="ident" id="4197326">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4197329">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4197333">//&nbsp;We&nbsp;AND&nbsp;together&nbsp;the&nbsp;bits&nbsp;of&nbsp;good&nbsp;and&nbsp;replicate&nbsp;the&nbsp;result&nbsp;across</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4197402">//&nbsp;all&nbsp;the&nbsp;bits.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197420">good</span>&nbsp;<span class="op" id="4197425">&amp;=</span>&nbsp;<span class="ident" id="4197428">good</span>&nbsp;<span class="op" id="4197433">&lt;&lt;</span>&nbsp;<span class="num" id="4197436">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197439">good</span>&nbsp;<span class="op" id="4197444">&amp;=</span>&nbsp;<span class="ident" id="4197447">good</span>&nbsp;<span class="op" id="4197452">&lt;&lt;</span>&nbsp;<span class="num" id="4197455">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197458">good</span>&nbsp;<span class="op" id="4197463">&amp;=</span>&nbsp;<span class="ident" id="4197466">good</span>&nbsp;<span class="op" id="4197471">&lt;&lt;</span>&nbsp;<span class="num" id="4197474">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197477">good</span>&nbsp;<span class="op" id="4197482">=</span>&nbsp;<span class="builtintype" id="4197484">uint8</span><span class="op" id="4197489">(</span><span class="builtintype" id="4197490">int8</span><span class="op" id="4197494">(</span><span class="ident" id="4197495">good</span><span class="op" id="4197499">)</span>&nbsp;<span class="op" id="4197501">&gt;&gt;</span>&nbsp;<span class="num" id="4197504">7</span><span class="op" id="4197505">)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197509">toRemove</span>&nbsp;<span class="op" id="4197518">:=</span>&nbsp;<span class="ident" id="4197521">good</span><span class="op" id="4197525">&amp;</span><span class="ident" id="4197526">paddingLen</span>&nbsp;<span class="op" id="4197537">+</span>&nbsp;<span class="num" id="4197539">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197542">return</span>&nbsp;<span class="ident" id="4197549">payload</span><span class="op" id="4197556">[</span><span class="op" id="4197557">:</span><span class="builtinfunc" id="4197558">len</span><span class="op" id="4197561">(</span><span class="ident" id="4197562">payload</span><span class="op" id="4197569">)</span><span class="op" id="4197570">-</span><span class="builtintype" id="4197571">int</span><span class="op" id="4197574">(</span><span class="ident" id="4197575">toRemove</span><span class="op" id="4197583">)</span><span class="op" id="4197584">]</span><span class="op" id="4197585">,</span>&nbsp;<span class="ident" id="4197587">good</span><br>
<span class="lineno"></span><span class="op" id="4197592">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span><span class="comment" id="4197595">//&nbsp;removePaddingSSL30&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;removePadding&nbsp;in&nbsp;the&nbsp;case&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4197673">//&nbsp;protocol&nbsp;version&nbsp;is&nbsp;SSLv3.&nbsp;In&nbsp;this&nbsp;version,&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;padding</span><br>
<span class="lineno"></span><span class="comment" id="4197748">//&nbsp;are&nbsp;random&nbsp;and&nbsp;cannot&nbsp;be&nbsp;checked.</span><br>
<span class="lineno"></span><span class="keyword" id="4197785">func</span>&nbsp;<span class="ident" id="4197790">removePaddingSSL30</span><span class="op" id="4197808">(</span><span class="ident" id="4197809">payload</span>&nbsp;<span class="op" id="4197817">[</span><span class="op" id="4197818">]</span><span class="builtintype" id="4197819">byte</span><span class="op" id="4197823">)</span>&nbsp;<span class="op" id="4197825">(</span><span class="op" id="4197826">[</span><span class="op" id="4197827">]</span><span class="builtintype" id="4197828">byte</span><span class="op" id="4197832">,</span>&nbsp;<span class="builtintype" id="4197834">byte</span><span class="op" id="4197838">)</span>&nbsp;<span class="op" id="4197840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197843">if</span>&nbsp;<span class="builtinfunc" id="4197846">len</span><span class="op" id="4197849">(</span><span class="ident" id="4197850">payload</span><span class="op" id="4197857">)</span>&nbsp;<span class="op" id="4197859">&lt;</span>&nbsp;<span class="num" id="4197861">1</span>&nbsp;<span class="op" id="4197863">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197867">return</span>&nbsp;<span class="ident" id="4197874">payload</span><span class="op" id="4197881">,</span>&nbsp;<span class="num" id="4197883">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4197886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4197890">paddingLen</span>&nbsp;<span class="op" id="4197901">:=</span>&nbsp;<span class="builtintype" id="4197904">int</span><span class="op" id="4197907">(</span><span class="ident" id="4197908">payload</span><span class="op" id="4197915">[</span><span class="builtinfunc" id="4197916">len</span><span class="op" id="4197919">(</span><span class="ident" id="4197920">payload</span><span class="op" id="4197927">)</span><span class="op" id="4197928">-</span><span class="num" id="4197929">1</span><span class="op" id="4197930">]</span><span class="op" id="4197931">)</span>&nbsp;<span class="op" id="4197933">+</span>&nbsp;<span class="num" id="4197935">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197938">if</span>&nbsp;<span class="ident" id="4197941">paddingLen</span>&nbsp;<span class="op" id="4197952">&gt;</span>&nbsp;<span class="builtinfunc" id="4197954">len</span><span class="op" id="4197957">(</span><span class="ident" id="4197958">payload</span><span class="op" id="4197965">)</span>&nbsp;<span class="op" id="4197967">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197971">return</span>&nbsp;<span class="ident" id="4197978">payload</span><span class="op" id="4197985">,</span>&nbsp;<span class="num" id="4197987">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4197990">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4197994">return</span>&nbsp;<span class="ident" id="4198001">payload</span><span class="op" id="4198008">[</span><span class="op" id="4198009">:</span><span class="builtinfunc" id="4198010">len</span><span class="op" id="4198013">(</span><span class="ident" id="4198014">payload</span><span class="op" id="4198021">)</span><span class="op" id="4198022">-</span><span class="ident" id="4198023">paddingLen</span><span class="op" id="4198033">]</span><span class="op" id="4198034">,</span>&nbsp;<span class="num" id="4198036">255</span><br>
<span class="lineno"></span><span class="op" id="4198040">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span><span class="keyword" id="4198043">func</span>&nbsp;<span class="ident" id="4198048">roundUp</span><span class="op" id="4198055">(</span><span class="ident" id="4198056">a</span><span class="op" id="4198057">,</span>&nbsp;<span class="ident" id="4198059">b</span>&nbsp;<span class="builtintype" id="4198061">int</span><span class="op" id="4198064">)</span>&nbsp;<span class="builtintype" id="4198066">int</span>&nbsp;<span class="op" id="4198070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198073">return</span>&nbsp;<span class="ident" id="4198080">a</span>&nbsp;<span class="op" id="4198082">+</span>&nbsp;<span class="op" id="4198084">(</span><span class="ident" id="4198085">b</span><span class="op" id="4198086">-</span><span class="ident" id="4198087">a</span><span class="op" id="4198088">%</span><span class="ident" id="4198089">b</span><span class="op" id="4198090">)</span><span class="op" id="4198091">%</span><span class="ident" id="4198092">b</span><br>
<span class="lineno"></span><span class="op" id="4198094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span><span class="comment" id="4198097">//&nbsp;cbcMode&nbsp;is&nbsp;an&nbsp;interface&nbsp;for&nbsp;block&nbsp;ciphers&nbsp;using&nbsp;cipher&nbsp;block&nbsp;chaining.</span><br>
<span class="lineno"></span><span class="keyword" id="4198171">type</span>&nbsp;<span class="ident" id="4198176">cbcMode</span>&nbsp;<span class="keyword" id="4198184">interface</span>&nbsp;<span class="op" id="4198194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198197">cipher</span><span class="op" id="4198203">.</span><span class="ident" id="4198204">BlockMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198215">SetIV</span><span class="op" id="4198220">(</span><span class="op" id="4198221">[</span><span class="op" id="4198222">]</span><span class="builtintype" id="4198223">byte</span><span class="op" id="4198227">)</span><br>
<span class="lineno"></span><span class="op" id="4198229">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="4198232">//&nbsp;decrypt&nbsp;checks&nbsp;and&nbsp;strips&nbsp;the&nbsp;mac&nbsp;and&nbsp;decrypts&nbsp;the&nbsp;data&nbsp;in&nbsp;b.&nbsp;Returns&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4198307">//&nbsp;success&nbsp;boolean,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;to&nbsp;skip&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;record&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4198387">//&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;application&nbsp;payload,&nbsp;and&nbsp;an&nbsp;optional&nbsp;alert&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4198457">func</span>&nbsp;<span class="op" id="4198462">(</span><span class="ident" id="4198463">hc</span>&nbsp;<span class="op" id="4198466">*</span><span class="ident" id="4198467">halfConn</span><span class="op" id="4198475">)</span>&nbsp;<span class="ident" id="4198477">decrypt</span><span class="op" id="4198484">(</span><span class="ident" id="4198485">b</span>&nbsp;<span class="op" id="4198487">*</span><span class="ident" id="4198488">block</span><span class="op" id="4198493">)</span>&nbsp;<span class="op" id="4198495">(</span><span class="ident" id="4198496">ok</span>&nbsp;<span class="builtintype" id="4198499">bool</span><span class="op" id="4198503">,</span>&nbsp;<span class="ident" id="4198505">prefixLen</span>&nbsp;<span class="builtintype" id="4198515">int</span><span class="op" id="4198518">,</span>&nbsp;<span class="ident" id="4198520">alertValue</span>&nbsp;<span class="ident" id="4198531">alert</span><span class="op" id="4198536">)</span>&nbsp;<span class="op" id="4198538">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4198541">//&nbsp;pull&nbsp;out&nbsp;payload</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198562">payload</span>&nbsp;<span class="op" id="4198570">:=</span>&nbsp;<span class="ident" id="4198573">b</span><span class="op" id="4198574">.</span><span class="ident" id="4198575">data</span><span class="op" id="4198579">[</span><span class="ident" id="4198580">recordHeaderLen</span><span class="op" id="4198595">:</span><span class="op" id="4198596">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198600">macSize</span>&nbsp;<span class="op" id="4198608">:=</span>&nbsp;<span class="num" id="4198611">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198614">if</span>&nbsp;<span class="ident" id="4198617">hc</span><span class="op" id="4198619">.</span><span class="ident" id="4198620">mac</span>&nbsp;<span class="op" id="4198624">!=</span>&nbsp;<span class="builtintype" id="4198627">nil</span>&nbsp;<span class="op" id="4198631">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198635">macSize</span>&nbsp;<span class="op" id="4198643">=</span>&nbsp;<span class="ident" id="4198645">hc</span><span class="op" id="4198647">.</span><span class="ident" id="4198648">mac</span><span class="op" id="4198651">.</span><span class="ident" id="4198652">Size</span><span class="op" id="4198656">(</span><span class="op" id="4198657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198664">paddingGood</span>&nbsp;<span class="op" id="4198676">:=</span>&nbsp;<span class="builtintype" id="4198679">byte</span><span class="op" id="4198683">(</span><span class="num" id="4198684">255</span><span class="op" id="4198687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198690">explicitIVLen</span>&nbsp;<span class="op" id="4198704">:=</span>&nbsp;<span class="num" id="4198707">0</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4198711">//&nbsp;decrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198723">if</span>&nbsp;<span class="ident" id="4198726">hc</span><span class="op" id="4198728">.</span><span class="ident" id="4198729">cipher</span>&nbsp;<span class="op" id="4198736">!=</span>&nbsp;<span class="builtintype" id="4198739">nil</span>&nbsp;<span class="op" id="4198743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198747">switch</span>&nbsp;<span class="ident" id="4198754">c</span>&nbsp;<span class="op" id="4198756">:=</span>&nbsp;<span class="ident" id="4198759">hc</span><span class="op" id="4198761">.</span><span class="ident" id="4198762">cipher</span><span class="op" id="4198768">.</span><span class="op" id="4198769">(</span><span class="keyword" id="4198770">type</span><span class="op" id="4198774">)</span>&nbsp;<span class="op" id="4198776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198780">case</span>&nbsp;<span class="ident" id="4198785">cipher</span><span class="op" id="4198791">.</span><span class="ident" id="4198792">Stream</span><span class="op" id="4198798">:</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198803">c</span><span class="op" id="4198804">.</span><span class="ident" id="4198805">XORKeyStream</span><span class="op" id="4198817">(</span><span class="ident" id="4198818">payload</span><span class="op" id="4198825">,</span>&nbsp;<span class="ident" id="4198827">payload</span><span class="op" id="4198834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198838">case</span>&nbsp;<span class="ident" id="4198843">cipher</span><span class="op" id="4198849">.</span><span class="ident" id="4198850">AEAD</span><span class="op" id="4198854">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198859">explicitIVLen</span>&nbsp;<span class="op" id="4198873">=</span>&nbsp;<span class="num" id="4198875">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198880">if</span>&nbsp;<span class="builtinfunc" id="4198883">len</span><span class="op" id="4198886">(</span><span class="ident" id="4198887">payload</span><span class="op" id="4198894">)</span>&nbsp;<span class="op" id="4198896">&lt;</span>&nbsp;<span class="ident" id="4198898">explicitIVLen</span>&nbsp;<span class="op" id="4198912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4198918">return</span>&nbsp;<span class="builtintype" id="4198925">false</span><span class="op" id="4198930">,</span>&nbsp;<span class="num" id="4198932">0</span><span class="op" id="4198933">,</span>&nbsp;<span class="ident" id="4198935">alertBadRecordMAC</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4198956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198961">nonce</span>&nbsp;<span class="op" id="4198967">:=</span>&nbsp;<span class="ident" id="4198970">payload</span><span class="op" id="4198977">[</span><span class="op" id="4198978">:</span><span class="num" id="4198979">8</span><span class="op" id="4198980">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4198985">payload</span>&nbsp;<span class="op" id="4198993">=</span>&nbsp;<span class="ident" id="4198995">payload</span><span class="op" id="4199002">[</span><span class="num" id="4199003">8</span><span class="op" id="4199004">:</span><span class="op" id="4199005">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199011">var</span>&nbsp;<span class="ident" id="4199015">additionalData</span>&nbsp;<span class="op" id="4199030">[</span><span class="num" id="4199031">13</span><span class="op" id="4199033">]</span><span class="builtintype" id="4199034">byte</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4199042">copy</span><span class="op" id="4199046">(</span><span class="ident" id="4199047">additionalData</span><span class="op" id="4199061">[</span><span class="op" id="4199062">:</span><span class="op" id="4199063">]</span><span class="op" id="4199064">,</span>&nbsp;<span class="ident" id="4199066">hc</span><span class="op" id="4199068">.</span><span class="ident" id="4199069">seq</span><span class="op" id="4199072">[</span><span class="op" id="4199073">:</span><span class="op" id="4199074">]</span><span class="op" id="4199075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4199080">copy</span><span class="op" id="4199084">(</span><span class="ident" id="4199085">additionalData</span><span class="op" id="4199099">[</span><span class="num" id="4199100">8</span><span class="op" id="4199101">:</span><span class="op" id="4199102">]</span><span class="op" id="4199103">,</span>&nbsp;<span class="ident" id="4199105">b</span><span class="op" id="4199106">.</span><span class="ident" id="4199107">data</span><span class="op" id="4199111">[</span><span class="op" id="4199112">:</span><span class="num" id="4199113">3</span><span class="op" id="4199114">]</span><span class="op" id="4199115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199120">n</span>&nbsp;<span class="op" id="4199122">:=</span>&nbsp;<span class="builtinfunc" id="4199125">len</span><span class="op" id="4199128">(</span><span class="ident" id="4199129">payload</span><span class="op" id="4199136">)</span>&nbsp;<span class="op" id="4199138">-</span>&nbsp;<span class="ident" id="4199140">c</span><span class="op" id="4199141">.</span><span class="ident" id="4199142">Overhead</span><span class="op" id="4199150">(</span><span class="op" id="4199151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199156">additionalData</span><span class="op" id="4199170">[</span><span class="num" id="4199171">11</span><span class="op" id="4199173">]</span>&nbsp;<span class="op" id="4199175">=</span>&nbsp;<span class="builtintype" id="4199177">byte</span><span class="op" id="4199181">(</span><span class="ident" id="4199182">n</span>&nbsp;<span class="op" id="4199184">&gt;&gt;</span>&nbsp;<span class="num" id="4199187">8</span><span class="op" id="4199188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199193">additionalData</span><span class="op" id="4199207">[</span><span class="num" id="4199208">12</span><span class="op" id="4199210">]</span>&nbsp;<span class="op" id="4199212">=</span>&nbsp;<span class="builtintype" id="4199214">byte</span><span class="op" id="4199218">(</span><span class="ident" id="4199219">n</span><span class="op" id="4199220">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199225">var</span>&nbsp;<span class="ident" id="4199229">err</span>&nbsp;<span class="builtintype" id="4199233">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199242">payload</span><span class="op" id="4199249">,</span>&nbsp;<span class="ident" id="4199251">err</span>&nbsp;<span class="op" id="4199255">=</span>&nbsp;<span class="ident" id="4199257">c</span><span class="op" id="4199258">.</span><span class="ident" id="4199259">Open</span><span class="op" id="4199263">(</span><span class="ident" id="4199264">payload</span><span class="op" id="4199271">[</span><span class="op" id="4199272">:</span><span class="num" id="4199273">0</span><span class="op" id="4199274">]</span><span class="op" id="4199275">,</span>&nbsp;<span class="ident" id="4199277">nonce</span><span class="op" id="4199282">,</span>&nbsp;<span class="ident" id="4199284">payload</span><span class="op" id="4199291">,</span>&nbsp;<span class="ident" id="4199293">additionalData</span><span class="op" id="4199307">[</span><span class="op" id="4199308">:</span><span class="op" id="4199309">]</span><span class="op" id="4199310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199315">if</span>&nbsp;<span class="ident" id="4199318">err</span>&nbsp;<span class="op" id="4199322">!=</span>&nbsp;<span class="builtintype" id="4199325">nil</span>&nbsp;<span class="op" id="4199329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199335">return</span>&nbsp;<span class="builtintype" id="4199342">false</span><span class="op" id="4199347">,</span>&nbsp;<span class="num" id="4199349">0</span><span class="op" id="4199350">,</span>&nbsp;<span class="ident" id="4199352">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199373">}</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199378">b</span><span class="op" id="4199379">.</span><span class="ident" id="4199380">resize</span><span class="op" id="4199386">(</span><span class="ident" id="4199387">recordHeaderLen</span>&nbsp;<span class="op" id="4199403">+</span>&nbsp;<span class="ident" id="4199405">explicitIVLen</span>&nbsp;<span class="op" id="4199419">+</span>&nbsp;<span class="builtinfunc" id="4199421">len</span><span class="op" id="4199424">(</span><span class="ident" id="4199425">payload</span><span class="op" id="4199432">)</span><span class="op" id="4199433">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199437">case</span>&nbsp;<span class="ident" id="4199442">cbcMode</span><span class="op" id="4199449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199454">blockSize</span>&nbsp;<span class="op" id="4199464">:=</span>&nbsp;<span class="ident" id="4199467">c</span><span class="op" id="4199468">.</span><span class="ident" id="4199469">BlockSize</span><span class="op" id="4199478">(</span><span class="op" id="4199479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199484">if</span>&nbsp;<span class="ident" id="4199487">hc</span><span class="op" id="4199489">.</span><span class="ident" id="4199490">version</span>&nbsp;<span class="op" id="4199498">&gt;=</span>&nbsp;<span class="ident" id="4199501">VersionTLS11</span>&nbsp;<span class="op" id="4199514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199520">explicitIVLen</span>&nbsp;<span class="op" id="4199534">=</span>&nbsp;<span class="ident" id="4199536">blockSize</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199555">if</span>&nbsp;<span class="builtinfunc" id="4199558">len</span><span class="op" id="4199561">(</span><span class="ident" id="4199562">payload</span><span class="op" id="4199569">)</span><span class="op" id="4199570">%</span><span class="ident" id="4199571">blockSize</span>&nbsp;<span class="op" id="4199581">!=</span>&nbsp;<span class="num" id="4199584">0</span>&nbsp;<span class="op" id="4199586">||</span>&nbsp;<span class="builtinfunc" id="4199589">len</span><span class="op" id="4199592">(</span><span class="ident" id="4199593">payload</span><span class="op" id="4199600">)</span>&nbsp;<span class="op" id="4199602">&lt;</span>&nbsp;<span class="ident" id="4199604">roundUp</span><span class="op" id="4199611">(</span><span class="ident" id="4199612">explicitIVLen</span><span class="op" id="4199625">+</span><span class="ident" id="4199626">macSize</span><span class="op" id="4199633">+</span><span class="num" id="4199634">1</span><span class="op" id="4199635">,</span>&nbsp;<span class="ident" id="4199637">blockSize</span><span class="op" id="4199646">)</span>&nbsp;<span class="op" id="4199648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199654">return</span>&nbsp;<span class="builtintype" id="4199661">false</span><span class="op" id="4199666">,</span>&nbsp;<span class="num" id="4199668">0</span><span class="op" id="4199669">,</span>&nbsp;<span class="ident" id="4199671">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199692">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199698">if</span>&nbsp;<span class="ident" id="4199701">explicitIVLen</span>&nbsp;<span class="op" id="4199715">&gt;</span>&nbsp;<span class="num" id="4199717">0</span>&nbsp;<span class="op" id="4199719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199725">c</span><span class="op" id="4199726">.</span><span class="ident" id="4199727">SetIV</span><span class="op" id="4199732">(</span><span class="ident" id="4199733">payload</span><span class="op" id="4199740">[</span><span class="op" id="4199741">:</span><span class="ident" id="4199742">explicitIVLen</span><span class="op" id="4199755">]</span><span class="op" id="4199756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199762">payload</span>&nbsp;<span class="op" id="4199770">=</span>&nbsp;<span class="ident" id="4199772">payload</span><span class="op" id="4199779">[</span><span class="ident" id="4199780">explicitIVLen</span><span class="op" id="4199793">:</span><span class="op" id="4199794">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199799">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199804">c</span><span class="op" id="4199805">.</span><span class="ident" id="4199806">CryptBlocks</span><span class="op" id="4199817">(</span><span class="ident" id="4199818">payload</span><span class="op" id="4199825">,</span>&nbsp;<span class="ident" id="4199827">payload</span><span class="op" id="4199834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4199839">if</span>&nbsp;<span class="ident" id="4199842">hc</span><span class="op" id="4199844">.</span><span class="ident" id="4199845">version</span>&nbsp;<span class="op" id="4199853">==</span>&nbsp;<span class="ident" id="4199856">VersionSSL30</span>&nbsp;<span class="op" id="4199869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199875">payload</span><span class="op" id="4199882">,</span>&nbsp;<span class="ident" id="4199884">paddingGood</span>&nbsp;<span class="op" id="4199896">=</span>&nbsp;<span class="ident" id="4199898">removePaddingSSL30</span><span class="op" id="4199916">(</span><span class="ident" id="4199917">payload</span><span class="op" id="4199924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199929">}</span>&nbsp;<span class="keyword" id="4199931">else</span>&nbsp;<span class="op" id="4199936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199942">payload</span><span class="op" id="4199949">,</span>&nbsp;<span class="ident" id="4199951">paddingGood</span>&nbsp;<span class="op" id="4199963">=</span>&nbsp;<span class="ident" id="4199965">removePadding</span><span class="op" id="4199978">(</span><span class="ident" id="4199979">payload</span><span class="op" id="4199986">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4199991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4199996">b</span><span class="op" id="4199997">.</span><span class="ident" id="4199998">resize</span><span class="op" id="4200004">(</span><span class="ident" id="4200005">recordHeaderLen</span>&nbsp;<span class="op" id="4200021">+</span>&nbsp;<span class="ident" id="4200023">explicitIVLen</span>&nbsp;<span class="op" id="4200037">+</span>&nbsp;<span class="builtinfunc" id="4200039">len</span><span class="op" id="4200042">(</span><span class="ident" id="4200043">payload</span><span class="op" id="4200050">)</span><span class="op" id="4200051">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200057">//&nbsp;note&nbsp;that&nbsp;we&nbsp;still&nbsp;have&nbsp;a&nbsp;timing&nbsp;side-channel&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200116">//&nbsp;MAC&nbsp;check,&nbsp;below.&nbsp;An&nbsp;attacker&nbsp;can&nbsp;align&nbsp;the&nbsp;record</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200173">//&nbsp;so&nbsp;that&nbsp;a&nbsp;correct&nbsp;padding&nbsp;will&nbsp;cause&nbsp;one&nbsp;less&nbsp;hash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200230">//&nbsp;block&nbsp;to&nbsp;be&nbsp;calculated.&nbsp;Then&nbsp;they&nbsp;can&nbsp;iteratively</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200286">//&nbsp;decrypt&nbsp;a&nbsp;record&nbsp;by&nbsp;breaking&nbsp;each&nbsp;byte.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200336">//&nbsp;&#34;Password&nbsp;Interception&nbsp;in&nbsp;a&nbsp;SSL/TLS&nbsp;Channel&#34;,&nbsp;Brice</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200394">//&nbsp;Canvel&nbsp;et&nbsp;al.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200414">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200420">//&nbsp;However,&nbsp;our&nbsp;behavior&nbsp;matches&nbsp;OpenSSL,&nbsp;so&nbsp;we&nbsp;leak</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200476">//&nbsp;only&nbsp;as&nbsp;much&nbsp;as&nbsp;they&nbsp;do.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200506">default</span><span class="op" id="4200513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4200518">panic</span><span class="op" id="4200523">(</span><span class="string" id="4200524">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4200545">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4200549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4200552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200556">//&nbsp;check,&nbsp;strip&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200577">if</span>&nbsp;<span class="ident" id="4200580">hc</span><span class="op" id="4200582">.</span><span class="ident" id="4200583">mac</span>&nbsp;<span class="op" id="4200587">!=</span>&nbsp;<span class="builtintype" id="4200590">nil</span>&nbsp;<span class="op" id="4200594">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200598">if</span>&nbsp;<span class="builtinfunc" id="4200601">len</span><span class="op" id="4200604">(</span><span class="ident" id="4200605">payload</span><span class="op" id="4200612">)</span>&nbsp;<span class="op" id="4200614">&lt;</span>&nbsp;<span class="ident" id="4200616">macSize</span>&nbsp;<span class="op" id="4200624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200629">return</span>&nbsp;<span class="builtintype" id="4200636">false</span><span class="op" id="4200641">,</span>&nbsp;<span class="num" id="4200643">0</span><span class="op" id="4200644">,</span>&nbsp;<span class="ident" id="4200646">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4200666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4200671">//&nbsp;strip&nbsp;mac&nbsp;off&nbsp;payload,&nbsp;b.data</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200706">n</span>&nbsp;<span class="op" id="4200708">:=</span>&nbsp;<span class="builtinfunc" id="4200711">len</span><span class="op" id="4200714">(</span><span class="ident" id="4200715">payload</span><span class="op" id="4200722">)</span>&nbsp;<span class="op" id="4200724">-</span>&nbsp;<span class="ident" id="4200726">macSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200736">b</span><span class="op" id="4200737">.</span><span class="ident" id="4200738">data</span><span class="op" id="4200742">[</span><span class="num" id="4200743">3</span><span class="op" id="4200744">]</span>&nbsp;<span class="op" id="4200746">=</span>&nbsp;<span class="builtintype" id="4200748">byte</span><span class="op" id="4200752">(</span><span class="ident" id="4200753">n</span>&nbsp;<span class="op" id="4200755">&gt;&gt;</span>&nbsp;<span class="num" id="4200758">8</span><span class="op" id="4200759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200763">b</span><span class="op" id="4200764">.</span><span class="ident" id="4200765">data</span><span class="op" id="4200769">[</span><span class="num" id="4200770">4</span><span class="op" id="4200771">]</span>&nbsp;<span class="op" id="4200773">=</span>&nbsp;<span class="builtintype" id="4200775">byte</span><span class="op" id="4200779">(</span><span class="ident" id="4200780">n</span><span class="op" id="4200781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200785">b</span><span class="op" id="4200786">.</span><span class="ident" id="4200787">resize</span><span class="op" id="4200793">(</span><span class="ident" id="4200794">recordHeaderLen</span>&nbsp;<span class="op" id="4200810">+</span>&nbsp;<span class="ident" id="4200812">explicitIVLen</span>&nbsp;<span class="op" id="4200826">+</span>&nbsp;<span class="ident" id="4200828">n</span><span class="op" id="4200829">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200833">remoteMAC</span>&nbsp;<span class="op" id="4200843">:=</span>&nbsp;<span class="ident" id="4200846">payload</span><span class="op" id="4200853">[</span><span class="ident" id="4200854">n</span><span class="op" id="4200855">:</span><span class="op" id="4200856">]</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4200860">localMAC</span>&nbsp;<span class="op" id="4200869">:=</span>&nbsp;<span class="ident" id="4200872">hc</span><span class="op" id="4200874">.</span><span class="ident" id="4200875">mac</span><span class="op" id="4200878">.</span><span class="ident" id="4200879">MAC</span><span class="op" id="4200882">(</span><span class="ident" id="4200883">hc</span><span class="op" id="4200885">.</span><span class="ident" id="4200886">inDigestBuf</span><span class="op" id="4200897">,</span>&nbsp;<span class="ident" id="4200899">hc</span><span class="op" id="4200901">.</span><span class="ident" id="4200902">seq</span><span class="op" id="4200905">[</span><span class="num" id="4200906">0</span><span class="op" id="4200907">:</span><span class="op" id="4200908">]</span><span class="op" id="4200909">,</span>&nbsp;<span class="ident" id="4200911">b</span><span class="op" id="4200912">.</span><span class="ident" id="4200913">data</span><span class="op" id="4200917">[</span><span class="op" id="4200918">:</span><span class="ident" id="4200919">recordHeaderLen</span><span class="op" id="4200934">]</span><span class="op" id="4200935">,</span>&nbsp;<span class="ident" id="4200937">payload</span><span class="op" id="4200944">[</span><span class="op" id="4200945">:</span><span class="ident" id="4200946">n</span><span class="op" id="4200947">]</span><span class="op" id="4200948">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4200953">if</span>&nbsp;<span class="ident" id="4200956">subtle</span><span class="op" id="4200962">.</span><span class="ident" id="4200963">ConstantTimeCompare</span><span class="op" id="4200982">(</span><span class="ident" id="4200983">localMAC</span><span class="op" id="4200991">,</span>&nbsp;<span class="ident" id="4200993">remoteMAC</span><span class="op" id="4201002">)</span>&nbsp;<span class="op" id="4201004">!=</span>&nbsp;<span class="num" id="4201007">1</span>&nbsp;<span class="op" id="4201009">||</span>&nbsp;<span class="ident" id="4201012">paddingGood</span>&nbsp;<span class="op" id="4201024">!=</span>&nbsp;<span class="num" id="4201027">255</span>&nbsp;<span class="op" id="4201031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201036">return</span>&nbsp;<span class="builtintype" id="4201043">false</span><span class="op" id="4201048">,</span>&nbsp;<span class="num" id="4201050">0</span><span class="op" id="4201051">,</span>&nbsp;<span class="ident" id="4201053">alertBadRecordMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201073">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201077">hc</span><span class="op" id="4201079">.</span><span class="ident" id="4201080">inDigestBuf</span>&nbsp;<span class="op" id="4201092">=</span>&nbsp;<span class="ident" id="4201094">localMAC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201107">hc</span><span class="op" id="4201109">.</span><span class="ident" id="4201110">incSeq</span><span class="op" id="4201116">(</span><span class="op" id="4201117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201121">return</span>&nbsp;<span class="builtintype" id="4201128">true</span><span class="op" id="4201132">,</span>&nbsp;<span class="ident" id="4201134">recordHeaderLen</span>&nbsp;<span class="op" id="4201150">+</span>&nbsp;<span class="ident" id="4201152">explicitIVLen</span><span class="op" id="4201165">,</span>&nbsp;<span class="num" id="4201167">0</span><br>
<span class="lineno">335</span><span class="op" id="4201169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4201172">//&nbsp;padToBlockSize&nbsp;calculates&nbsp;the&nbsp;needed&nbsp;padding&nbsp;block,&nbsp;if&nbsp;any,&nbsp;for&nbsp;a&nbsp;payload.</span><br>
<span class="lineno"></span><span class="comment" id="4201250">//&nbsp;On&nbsp;exit,&nbsp;prefix&nbsp;aliases&nbsp;payload&nbsp;and&nbsp;extends&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;last&nbsp;full</span><br>
<span class="lineno"></span><span class="comment" id="4201325">//&nbsp;block&nbsp;of&nbsp;payload.&nbsp;finalBlock&nbsp;is&nbsp;a&nbsp;fresh&nbsp;slice&nbsp;which&nbsp;contains&nbsp;the&nbsp;contents&nbsp;of</span><br>
<span class="lineno">340</span><span class="comment" id="4201405">//&nbsp;any&nbsp;suffix&nbsp;of&nbsp;payload&nbsp;as&nbsp;well&nbsp;as&nbsp;the&nbsp;needed&nbsp;padding&nbsp;to&nbsp;make&nbsp;finalBlock&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4201481">//&nbsp;full&nbsp;block.</span><br>
<span class="lineno"></span><span class="keyword" id="4201496">func</span>&nbsp;<span class="ident" id="4201501">padToBlockSize</span><span class="op" id="4201515">(</span><span class="ident" id="4201516">payload</span>&nbsp;<span class="op" id="4201524">[</span><span class="op" id="4201525">]</span><span class="builtintype" id="4201526">byte</span><span class="op" id="4201530">,</span>&nbsp;<span class="ident" id="4201532">blockSize</span>&nbsp;<span class="builtintype" id="4201542">int</span><span class="op" id="4201545">)</span>&nbsp;<span class="op" id="4201547">(</span><span class="ident" id="4201548">prefix</span><span class="op" id="4201554">,</span>&nbsp;<span class="ident" id="4201556">finalBlock</span>&nbsp;<span class="op" id="4201567">[</span><span class="op" id="4201568">]</span><span class="builtintype" id="4201569">byte</span><span class="op" id="4201573">)</span>&nbsp;<span class="op" id="4201575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201578">overrun</span>&nbsp;<span class="op" id="4201586">:=</span>&nbsp;<span class="builtinfunc" id="4201589">len</span><span class="op" id="4201592">(</span><span class="ident" id="4201593">payload</span><span class="op" id="4201600">)</span>&nbsp;<span class="op" id="4201602">%</span>&nbsp;<span class="ident" id="4201604">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201615">paddingLen</span>&nbsp;<span class="op" id="4201626">:=</span>&nbsp;<span class="ident" id="4201629">blockSize</span>&nbsp;<span class="op" id="4201639">-</span>&nbsp;<span class="ident" id="4201641">overrun</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201650">prefix</span>&nbsp;<span class="op" id="4201657">=</span>&nbsp;<span class="ident" id="4201659">payload</span><span class="op" id="4201666">[</span><span class="op" id="4201667">:</span><span class="builtinfunc" id="4201668">len</span><span class="op" id="4201671">(</span><span class="ident" id="4201672">payload</span><span class="op" id="4201679">)</span><span class="op" id="4201680">-</span><span class="ident" id="4201681">overrun</span><span class="op" id="4201688">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201691">finalBlock</span>&nbsp;<span class="op" id="4201702">=</span>&nbsp;<span class="builtinfunc" id="4201704">make</span><span class="op" id="4201708">(</span><span class="op" id="4201709">[</span><span class="op" id="4201710">]</span><span class="builtintype" id="4201711">byte</span><span class="op" id="4201715">,</span>&nbsp;<span class="ident" id="4201717">blockSize</span><span class="op" id="4201726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4201729">copy</span><span class="op" id="4201733">(</span><span class="ident" id="4201734">finalBlock</span><span class="op" id="4201744">,</span>&nbsp;<span class="ident" id="4201746">payload</span><span class="op" id="4201753">[</span><span class="builtinfunc" id="4201754">len</span><span class="op" id="4201757">(</span><span class="ident" id="4201758">payload</span><span class="op" id="4201765">)</span><span class="op" id="4201766">-</span><span class="ident" id="4201767">overrun</span><span class="op" id="4201774">:</span><span class="op" id="4201775">]</span><span class="op" id="4201776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201779">for</span>&nbsp;<span class="ident" id="4201783">i</span>&nbsp;<span class="op" id="4201785">:=</span>&nbsp;<span class="ident" id="4201788">overrun</span><span class="op" id="4201795">;</span>&nbsp;<span class="ident" id="4201797">i</span>&nbsp;<span class="op" id="4201799">&lt;</span>&nbsp;<span class="ident" id="4201801">blockSize</span><span class="op" id="4201810">;</span>&nbsp;<span class="ident" id="4201812">i</span><span class="op" id="4201813">++</span>&nbsp;<span class="op" id="4201816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4201820">finalBlock</span><span class="op" id="4201830">[</span><span class="ident" id="4201831">i</span><span class="op" id="4201832">]</span>&nbsp;<span class="op" id="4201834">=</span>&nbsp;<span class="builtintype" id="4201836">byte</span><span class="op" id="4201840">(</span><span class="ident" id="4201841">paddingLen</span>&nbsp;<span class="op" id="4201852">-</span>&nbsp;<span class="num" id="4201854">1</span><span class="op" id="4201855">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4201858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201861">return</span><br>
<span class="lineno"></span><span class="op" id="4201868">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4201871">//&nbsp;encrypt&nbsp;encrypts&nbsp;and&nbsp;macs&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno">355</span><span class="keyword" id="4201915">func</span>&nbsp;<span class="op" id="4201920">(</span><span class="ident" id="4201921">hc</span>&nbsp;<span class="op" id="4201924">*</span><span class="ident" id="4201925">halfConn</span><span class="op" id="4201933">)</span>&nbsp;<span class="ident" id="4201935">encrypt</span><span class="op" id="4201942">(</span><span class="ident" id="4201943">b</span>&nbsp;<span class="op" id="4201945">*</span><span class="ident" id="4201946">block</span><span class="op" id="4201951">,</span>&nbsp;<span class="ident" id="4201953">explicitIVLen</span>&nbsp;<span class="builtintype" id="4201967">int</span><span class="op" id="4201970">)</span>&nbsp;<span class="op" id="4201972">(</span><span class="builtintype" id="4201973">bool</span><span class="op" id="4201977">,</span>&nbsp;<span class="ident" id="4201979">alert</span><span class="op" id="4201984">)</span>&nbsp;<span class="op" id="4201986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4201989">//&nbsp;mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4201997">if</span>&nbsp;<span class="ident" id="4202000">hc</span><span class="op" id="4202002">.</span><span class="ident" id="4202003">mac</span>&nbsp;<span class="op" id="4202007">!=</span>&nbsp;<span class="builtintype" id="4202010">nil</span>&nbsp;<span class="op" id="4202014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202018">mac</span>&nbsp;<span class="op" id="4202022">:=</span>&nbsp;<span class="ident" id="4202025">hc</span><span class="op" id="4202027">.</span><span class="ident" id="4202028">mac</span><span class="op" id="4202031">.</span><span class="ident" id="4202032">MAC</span><span class="op" id="4202035">(</span><span class="ident" id="4202036">hc</span><span class="op" id="4202038">.</span><span class="ident" id="4202039">outDigestBuf</span><span class="op" id="4202051">,</span>&nbsp;<span class="ident" id="4202053">hc</span><span class="op" id="4202055">.</span><span class="ident" id="4202056">seq</span><span class="op" id="4202059">[</span><span class="num" id="4202060">0</span><span class="op" id="4202061">:</span><span class="op" id="4202062">]</span><span class="op" id="4202063">,</span>&nbsp;<span class="ident" id="4202065">b</span><span class="op" id="4202066">.</span><span class="ident" id="4202067">data</span><span class="op" id="4202071">[</span><span class="op" id="4202072">:</span><span class="ident" id="4202073">recordHeaderLen</span><span class="op" id="4202088">]</span><span class="op" id="4202089">,</span>&nbsp;<span class="ident" id="4202091">b</span><span class="op" id="4202092">.</span><span class="ident" id="4202093">data</span><span class="op" id="4202097">[</span><span class="ident" id="4202098">recordHeaderLen</span><span class="op" id="4202113">+</span><span class="ident" id="4202114">explicitIVLen</span><span class="op" id="4202127">:</span><span class="op" id="4202128">]</span><span class="op" id="4202129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202134">n</span>&nbsp;<span class="op" id="4202136">:=</span>&nbsp;<span class="builtinfunc" id="4202139">len</span><span class="op" id="4202142">(</span><span class="ident" id="4202143">b</span><span class="op" id="4202144">.</span><span class="ident" id="4202145">data</span><span class="op" id="4202149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202153">b</span><span class="op" id="4202154">.</span><span class="ident" id="4202155">resize</span><span class="op" id="4202161">(</span><span class="ident" id="4202162">n</span>&nbsp;<span class="op" id="4202164">+</span>&nbsp;<span class="builtinfunc" id="4202166">len</span><span class="op" id="4202169">(</span><span class="ident" id="4202170">mac</span><span class="op" id="4202173">)</span><span class="op" id="4202174">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4202178">copy</span><span class="op" id="4202182">(</span><span class="ident" id="4202183">b</span><span class="op" id="4202184">.</span><span class="ident" id="4202185">data</span><span class="op" id="4202189">[</span><span class="ident" id="4202190">n</span><span class="op" id="4202191">:</span><span class="op" id="4202192">]</span><span class="op" id="4202193">,</span>&nbsp;<span class="ident" id="4202195">mac</span><span class="op" id="4202198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202202">hc</span><span class="op" id="4202204">.</span><span class="ident" id="4202205">outDigestBuf</span>&nbsp;<span class="op" id="4202218">=</span>&nbsp;<span class="ident" id="4202220">mac</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4202225">}</span><br>
<span class="lineno">365</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202229">payload</span>&nbsp;<span class="op" id="4202237">:=</span>&nbsp;<span class="ident" id="4202240">b</span><span class="op" id="4202241">.</span><span class="ident" id="4202242">data</span><span class="op" id="4202246">[</span><span class="ident" id="4202247">recordHeaderLen</span><span class="op" id="4202262">:</span><span class="op" id="4202263">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4202267">//&nbsp;encrypt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202279">if</span>&nbsp;<span class="ident" id="4202282">hc</span><span class="op" id="4202284">.</span><span class="ident" id="4202285">cipher</span>&nbsp;<span class="op" id="4202292">!=</span>&nbsp;<span class="builtintype" id="4202295">nil</span>&nbsp;<span class="op" id="4202299">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202303">switch</span>&nbsp;<span class="ident" id="4202310">c</span>&nbsp;<span class="op" id="4202312">:=</span>&nbsp;<span class="ident" id="4202315">hc</span><span class="op" id="4202317">.</span><span class="ident" id="4202318">cipher</span><span class="op" id="4202324">.</span><span class="op" id="4202325">(</span><span class="keyword" id="4202326">type</span><span class="op" id="4202330">)</span>&nbsp;<span class="op" id="4202332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202336">case</span>&nbsp;<span class="ident" id="4202341">cipher</span><span class="op" id="4202347">.</span><span class="ident" id="4202348">Stream</span><span class="op" id="4202354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202359">c</span><span class="op" id="4202360">.</span><span class="ident" id="4202361">XORKeyStream</span><span class="op" id="4202373">(</span><span class="ident" id="4202374">payload</span><span class="op" id="4202381">,</span>&nbsp;<span class="ident" id="4202383">payload</span><span class="op" id="4202390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202394">case</span>&nbsp;<span class="ident" id="4202399">cipher</span><span class="op" id="4202405">.</span><span class="ident" id="4202406">AEAD</span><span class="op" id="4202410">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202415">payloadLen</span>&nbsp;<span class="op" id="4202426">:=</span>&nbsp;<span class="builtinfunc" id="4202429">len</span><span class="op" id="4202432">(</span><span class="ident" id="4202433">b</span><span class="op" id="4202434">.</span><span class="ident" id="4202435">data</span><span class="op" id="4202439">)</span>&nbsp;<span class="op" id="4202441">-</span>&nbsp;<span class="ident" id="4202443">recordHeaderLen</span>&nbsp;<span class="op" id="4202459">-</span>&nbsp;<span class="ident" id="4202461">explicitIVLen</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202478">b</span><span class="op" id="4202479">.</span><span class="ident" id="4202480">resize</span><span class="op" id="4202486">(</span><span class="builtinfunc" id="4202487">len</span><span class="op" id="4202490">(</span><span class="ident" id="4202491">b</span><span class="op" id="4202492">.</span><span class="ident" id="4202493">data</span><span class="op" id="4202497">)</span>&nbsp;<span class="op" id="4202499">+</span>&nbsp;<span class="ident" id="4202501">c</span><span class="op" id="4202502">.</span><span class="ident" id="4202503">Overhead</span><span class="op" id="4202511">(</span><span class="op" id="4202512">)</span><span class="op" id="4202513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202518">nonce</span>&nbsp;<span class="op" id="4202524">:=</span>&nbsp;<span class="ident" id="4202527">b</span><span class="op" id="4202528">.</span><span class="ident" id="4202529">data</span><span class="op" id="4202533">[</span><span class="ident" id="4202534">recordHeaderLen</span>&nbsp;<span class="op" id="4202550">:</span>&nbsp;<span class="ident" id="4202552">recordHeaderLen</span><span class="op" id="4202567">+</span><span class="ident" id="4202568">explicitIVLen</span><span class="op" id="4202581">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202586">payload</span>&nbsp;<span class="op" id="4202594">:=</span>&nbsp;<span class="ident" id="4202597">b</span><span class="op" id="4202598">.</span><span class="ident" id="4202599">data</span><span class="op" id="4202603">[</span><span class="ident" id="4202604">recordHeaderLen</span><span class="op" id="4202619">+</span><span class="ident" id="4202620">explicitIVLen</span><span class="op" id="4202633">:</span><span class="op" id="4202634">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202639">payload</span>&nbsp;<span class="op" id="4202647">=</span>&nbsp;<span class="ident" id="4202649">payload</span><span class="op" id="4202656">[</span><span class="op" id="4202657">:</span><span class="ident" id="4202658">payloadLen</span><span class="op" id="4202668">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202674">var</span>&nbsp;<span class="ident" id="4202678">additionalData</span>&nbsp;<span class="op" id="4202693">[</span><span class="num" id="4202694">13</span><span class="op" id="4202696">]</span><span class="builtintype" id="4202697">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4202705">copy</span><span class="op" id="4202709">(</span><span class="ident" id="4202710">additionalData</span><span class="op" id="4202724">[</span><span class="op" id="4202725">:</span><span class="op" id="4202726">]</span><span class="op" id="4202727">,</span>&nbsp;<span class="ident" id="4202729">hc</span><span class="op" id="4202731">.</span><span class="ident" id="4202732">seq</span><span class="op" id="4202735">[</span><span class="op" id="4202736">:</span><span class="op" id="4202737">]</span><span class="op" id="4202738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4202743">copy</span><span class="op" id="4202747">(</span><span class="ident" id="4202748">additionalData</span><span class="op" id="4202762">[</span><span class="num" id="4202763">8</span><span class="op" id="4202764">:</span><span class="op" id="4202765">]</span><span class="op" id="4202766">,</span>&nbsp;<span class="ident" id="4202768">b</span><span class="op" id="4202769">.</span><span class="ident" id="4202770">data</span><span class="op" id="4202774">[</span><span class="op" id="4202775">:</span><span class="num" id="4202776">3</span><span class="op" id="4202777">]</span><span class="op" id="4202778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202783">additionalData</span><span class="op" id="4202797">[</span><span class="num" id="4202798">11</span><span class="op" id="4202800">]</span>&nbsp;<span class="op" id="4202802">=</span>&nbsp;<span class="builtintype" id="4202804">byte</span><span class="op" id="4202808">(</span><span class="ident" id="4202809">payloadLen</span>&nbsp;<span class="op" id="4202820">&gt;&gt;</span>&nbsp;<span class="num" id="4202823">8</span><span class="op" id="4202824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202829">additionalData</span><span class="op" id="4202843">[</span><span class="num" id="4202844">12</span><span class="op" id="4202846">]</span>&nbsp;<span class="op" id="4202848">=</span>&nbsp;<span class="builtintype" id="4202850">byte</span><span class="op" id="4202854">(</span><span class="ident" id="4202855">payloadLen</span><span class="op" id="4202865">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202871">c</span><span class="op" id="4202872">.</span><span class="ident" id="4202873">Seal</span><span class="op" id="4202877">(</span><span class="ident" id="4202878">payload</span><span class="op" id="4202885">[</span><span class="op" id="4202886">:</span><span class="num" id="4202887">0</span><span class="op" id="4202888">]</span><span class="op" id="4202889">,</span>&nbsp;<span class="ident" id="4202891">nonce</span><span class="op" id="4202896">,</span>&nbsp;<span class="ident" id="4202898">payload</span><span class="op" id="4202905">,</span>&nbsp;<span class="ident" id="4202907">additionalData</span><span class="op" id="4202921">[</span><span class="op" id="4202922">:</span><span class="op" id="4202923">]</span><span class="op" id="4202924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202928">case</span>&nbsp;<span class="ident" id="4202933">cbcMode</span><span class="op" id="4202940">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4202945">blockSize</span>&nbsp;<span class="op" id="4202955">:=</span>&nbsp;<span class="ident" id="4202958">c</span><span class="op" id="4202959">.</span><span class="ident" id="4202960">BlockSize</span><span class="op" id="4202969">(</span><span class="op" id="4202970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4202975">if</span>&nbsp;<span class="ident" id="4202978">explicitIVLen</span>&nbsp;<span class="op" id="4202992">&gt;</span>&nbsp;<span class="num" id="4202994">0</span>&nbsp;<span class="op" id="4202996">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203002">c</span><span class="op" id="4203003">.</span><span class="ident" id="4203004">SetIV</span><span class="op" id="4203009">(</span><span class="ident" id="4203010">payload</span><span class="op" id="4203017">[</span><span class="op" id="4203018">:</span><span class="ident" id="4203019">explicitIVLen</span><span class="op" id="4203032">]</span><span class="op" id="4203033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203039">payload</span>&nbsp;<span class="op" id="4203047">=</span>&nbsp;<span class="ident" id="4203049">payload</span><span class="op" id="4203056">[</span><span class="ident" id="4203057">explicitIVLen</span><span class="op" id="4203070">:</span><span class="op" id="4203071">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203081">prefix</span><span class="op" id="4203087">,</span>&nbsp;<span class="ident" id="4203089">finalBlock</span>&nbsp;<span class="op" id="4203100">:=</span>&nbsp;<span class="ident" id="4203103">padToBlockSize</span><span class="op" id="4203117">(</span><span class="ident" id="4203118">payload</span><span class="op" id="4203125">,</span>&nbsp;<span class="ident" id="4203127">blockSize</span><span class="op" id="4203136">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203141">b</span><span class="op" id="4203142">.</span><span class="ident" id="4203143">resize</span><span class="op" id="4203149">(</span><span class="ident" id="4203150">recordHeaderLen</span>&nbsp;<span class="op" id="4203166">+</span>&nbsp;<span class="ident" id="4203168">explicitIVLen</span>&nbsp;<span class="op" id="4203182">+</span>&nbsp;<span class="builtinfunc" id="4203184">len</span><span class="op" id="4203187">(</span><span class="ident" id="4203188">prefix</span><span class="op" id="4203194">)</span>&nbsp;<span class="op" id="4203196">+</span>&nbsp;<span class="builtinfunc" id="4203198">len</span><span class="op" id="4203201">(</span><span class="ident" id="4203202">finalBlock</span><span class="op" id="4203212">)</span><span class="op" id="4203213">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203218">c</span><span class="op" id="4203219">.</span><span class="ident" id="4203220">CryptBlocks</span><span class="op" id="4203231">(</span><span class="ident" id="4203232">b</span><span class="op" id="4203233">.</span><span class="ident" id="4203234">data</span><span class="op" id="4203238">[</span><span class="ident" id="4203239">recordHeaderLen</span><span class="op" id="4203254">+</span><span class="ident" id="4203255">explicitIVLen</span><span class="op" id="4203268">:</span><span class="op" id="4203269">]</span><span class="op" id="4203270">,</span>&nbsp;<span class="ident" id="4203272">prefix</span><span class="op" id="4203278">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203283">c</span><span class="op" id="4203284">.</span><span class="ident" id="4203285">CryptBlocks</span><span class="op" id="4203296">(</span><span class="ident" id="4203297">b</span><span class="op" id="4203298">.</span><span class="ident" id="4203299">data</span><span class="op" id="4203303">[</span><span class="ident" id="4203304">recordHeaderLen</span><span class="op" id="4203319">+</span><span class="ident" id="4203320">explicitIVLen</span><span class="op" id="4203333">+</span><span class="builtinfunc" id="4203334">len</span><span class="op" id="4203337">(</span><span class="ident" id="4203338">prefix</span><span class="op" id="4203344">)</span><span class="op" id="4203345">:</span><span class="op" id="4203346">]</span><span class="op" id="4203347">,</span>&nbsp;<span class="ident" id="4203349">finalBlock</span><span class="op" id="4203359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203363">default</span><span class="op" id="4203370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4203375">panic</span><span class="op" id="4203380">(</span><span class="string" id="4203381">&#34;unknown&nbsp;cipher&nbsp;type&#34;</span><span class="op" id="4203402">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203406">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4203413">//&nbsp;update&nbsp;length&nbsp;to&nbsp;include&nbsp;MAC&nbsp;and&nbsp;any&nbsp;block&nbsp;padding&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203476">n</span>&nbsp;<span class="op" id="4203478">:=</span>&nbsp;<span class="builtinfunc" id="4203481">len</span><span class="op" id="4203484">(</span><span class="ident" id="4203485">b</span><span class="op" id="4203486">.</span><span class="ident" id="4203487">data</span><span class="op" id="4203491">)</span>&nbsp;<span class="op" id="4203493">-</span>&nbsp;<span class="ident" id="4203495">recordHeaderLen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203512">b</span><span class="op" id="4203513">.</span><span class="ident" id="4203514">data</span><span class="op" id="4203518">[</span><span class="num" id="4203519">3</span><span class="op" id="4203520">]</span>&nbsp;<span class="op" id="4203522">=</span>&nbsp;<span class="builtintype" id="4203524">byte</span><span class="op" id="4203528">(</span><span class="ident" id="4203529">n</span>&nbsp;<span class="op" id="4203531">&gt;&gt;</span>&nbsp;<span class="num" id="4203534">8</span><span class="op" id="4203535">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203538">b</span><span class="op" id="4203539">.</span><span class="ident" id="4203540">data</span><span class="op" id="4203544">[</span><span class="num" id="4203545">4</span><span class="op" id="4203546">]</span>&nbsp;<span class="op" id="4203548">=</span>&nbsp;<span class="builtintype" id="4203550">byte</span><span class="op" id="4203554">(</span><span class="ident" id="4203555">n</span><span class="op" id="4203556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203559">hc</span><span class="op" id="4203561">.</span><span class="ident" id="4203562">incSeq</span><span class="op" id="4203568">(</span><span class="op" id="4203569">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203573">return</span>&nbsp;<span class="builtintype" id="4203580">true</span><span class="op" id="4203584">,</span>&nbsp;<span class="num" id="4203586">0</span><br>
<span class="lineno"></span><span class="op" id="4203588">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span><span class="comment" id="4203591">//&nbsp;A&nbsp;block&nbsp;is&nbsp;a&nbsp;simple&nbsp;data&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="keyword" id="4203627">type</span>&nbsp;<span class="ident" id="4203632">block</span>&nbsp;<span class="keyword" id="4203638">struct</span>&nbsp;<span class="op" id="4203645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203648">data</span>&nbsp;<span class="op" id="4203653">[</span><span class="op" id="4203654">]</span><span class="builtintype" id="4203655">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203661">off</span>&nbsp;&nbsp;<span class="builtintype" id="4203666">int</span>&nbsp;<span class="comment" id="4203670">//&nbsp;index&nbsp;for&nbsp;Read</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203689">link</span>&nbsp;<span class="op" id="4203694">*</span><span class="ident" id="4203695">block</span><br>
<span class="lineno"></span><span class="op" id="4203701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4203704">//&nbsp;resize&nbsp;resizes&nbsp;block&nbsp;to&nbsp;be&nbsp;n&nbsp;bytes,&nbsp;growing&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="4203765">func</span>&nbsp;<span class="op" id="4203770">(</span><span class="ident" id="4203771">b</span>&nbsp;<span class="op" id="4203773">*</span><span class="ident" id="4203774">block</span><span class="op" id="4203779">)</span>&nbsp;<span class="ident" id="4203781">resize</span><span class="op" id="4203787">(</span><span class="ident" id="4203788">n</span>&nbsp;<span class="builtintype" id="4203790">int</span><span class="op" id="4203793">)</span>&nbsp;<span class="op" id="4203795">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203798">if</span>&nbsp;<span class="ident" id="4203801">n</span>&nbsp;<span class="op" id="4203803">&gt;</span>&nbsp;<span class="builtinfunc" id="4203805">cap</span><span class="op" id="4203808">(</span><span class="ident" id="4203809">b</span><span class="op" id="4203810">.</span><span class="ident" id="4203811">data</span><span class="op" id="4203815">)</span>&nbsp;<span class="op" id="4203817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203821">b</span><span class="op" id="4203822">.</span><span class="ident" id="4203823">reserve</span><span class="op" id="4203830">(</span><span class="ident" id="4203831">n</span><span class="op" id="4203832">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4203835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4203838">b</span><span class="op" id="4203839">.</span><span class="ident" id="4203840">data</span>&nbsp;<span class="op" id="4203845">=</span>&nbsp;<span class="ident" id="4203847">b</span><span class="op" id="4203848">.</span><span class="ident" id="4203849">data</span><span class="op" id="4203853">[</span><span class="num" id="4203854">0</span><span class="op" id="4203855">:</span><span class="ident" id="4203856">n</span><span class="op" id="4203857">]</span><br>
<span class="lineno"></span><span class="op" id="4203859">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="4203862">//&nbsp;reserve&nbsp;makes&nbsp;sure&nbsp;that&nbsp;block&nbsp;contains&nbsp;a&nbsp;capacity&nbsp;of&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4203936">func</span>&nbsp;<span class="op" id="4203941">(</span><span class="ident" id="4203942">b</span>&nbsp;<span class="op" id="4203944">*</span><span class="ident" id="4203945">block</span><span class="op" id="4203950">)</span>&nbsp;<span class="ident" id="4203952">reserve</span><span class="op" id="4203959">(</span><span class="ident" id="4203960">n</span>&nbsp;<span class="builtintype" id="4203962">int</span><span class="op" id="4203965">)</span>&nbsp;<span class="op" id="4203967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203970">if</span>&nbsp;<span class="builtinfunc" id="4203973">cap</span><span class="op" id="4203976">(</span><span class="ident" id="4203977">b</span><span class="op" id="4203978">.</span><span class="ident" id="4203979">data</span><span class="op" id="4203983">)</span>&nbsp;<span class="op" id="4203985">&gt;=</span>&nbsp;<span class="ident" id="4203988">n</span>&nbsp;<span class="op" id="4203990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4203994">return</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204005">m</span>&nbsp;<span class="op" id="4204007">:=</span>&nbsp;<span class="builtinfunc" id="4204010">cap</span><span class="op" id="4204013">(</span><span class="ident" id="4204014">b</span><span class="op" id="4204015">.</span><span class="ident" id="4204016">data</span><span class="op" id="4204020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204023">if</span>&nbsp;<span class="ident" id="4204026">m</span>&nbsp;<span class="op" id="4204028">==</span>&nbsp;<span class="num" id="4204031">0</span>&nbsp;<span class="op" id="4204033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204037">m</span>&nbsp;<span class="op" id="4204039">=</span>&nbsp;<span class="num" id="4204041">1024</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204047">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204050">for</span>&nbsp;<span class="ident" id="4204054">m</span>&nbsp;<span class="op" id="4204056">&lt;</span>&nbsp;<span class="ident" id="4204058">n</span>&nbsp;<span class="op" id="4204060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204064">m</span>&nbsp;<span class="op" id="4204066">*=</span>&nbsp;<span class="num" id="4204069">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204075">data</span>&nbsp;<span class="op" id="4204080">:=</span>&nbsp;<span class="builtinfunc" id="4204083">make</span><span class="op" id="4204087">(</span><span class="op" id="4204088">[</span><span class="op" id="4204089">]</span><span class="builtintype" id="4204090">byte</span><span class="op" id="4204094">,</span>&nbsp;<span class="builtinfunc" id="4204096">len</span><span class="op" id="4204099">(</span><span class="ident" id="4204100">b</span><span class="op" id="4204101">.</span><span class="ident" id="4204102">data</span><span class="op" id="4204106">)</span><span class="op" id="4204107">,</span>&nbsp;<span class="ident" id="4204109">m</span><span class="op" id="4204110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4204113">copy</span><span class="op" id="4204117">(</span><span class="ident" id="4204118">data</span><span class="op" id="4204122">,</span>&nbsp;<span class="ident" id="4204124">b</span><span class="op" id="4204125">.</span><span class="ident" id="4204126">data</span><span class="op" id="4204130">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204133">b</span><span class="op" id="4204134">.</span><span class="ident" id="4204135">data</span>&nbsp;<span class="op" id="4204140">=</span>&nbsp;<span class="ident" id="4204142">data</span><br>
<span class="lineno"></span><span class="op" id="4204147">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4204150">//&nbsp;readFromUntil&nbsp;reads&nbsp;from&nbsp;r&nbsp;into&nbsp;b&nbsp;until&nbsp;b&nbsp;contains&nbsp;at&nbsp;least&nbsp;n&nbsp;bytes</span><br>
<span class="lineno"></span><span class="comment" id="4204221">//&nbsp;or&nbsp;else&nbsp;returns&nbsp;an&nbsp;error.</span><br>
<span class="lineno">445</span><span class="keyword" id="4204250">func</span>&nbsp;<span class="op" id="4204255">(</span><span class="ident" id="4204256">b</span>&nbsp;<span class="op" id="4204258">*</span><span class="ident" id="4204259">block</span><span class="op" id="4204264">)</span>&nbsp;<span class="ident" id="4204266">readFromUntil</span><span class="op" id="4204279">(</span><span class="ident" id="4204280">r</span>&nbsp;<span class="ident" id="4204282">io</span><span class="op" id="4204284">.</span><span class="ident" id="4204285">Reader</span><span class="op" id="4204291">,</span>&nbsp;<span class="ident" id="4204293">n</span>&nbsp;<span class="builtintype" id="4204295">int</span><span class="op" id="4204298">)</span>&nbsp;<span class="builtintype" id="4204300">error</span>&nbsp;<span class="op" id="4204306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204309">//&nbsp;quick&nbsp;case</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204324">if</span>&nbsp;<span class="builtinfunc" id="4204327">len</span><span class="op" id="4204330">(</span><span class="ident" id="4204331">b</span><span class="op" id="4204332">.</span><span class="ident" id="4204333">data</span><span class="op" id="4204337">)</span>&nbsp;<span class="op" id="4204339">&gt;=</span>&nbsp;<span class="ident" id="4204342">n</span>&nbsp;<span class="op" id="4204344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204348">return</span>&nbsp;<span class="builtintype" id="4204355">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204360">}</span><br>
<span class="lineno">450</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204364">//&nbsp;read&nbsp;until&nbsp;have&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204392">b</span><span class="op" id="4204393">.</span><span class="ident" id="4204394">reserve</span><span class="op" id="4204401">(</span><span class="ident" id="4204402">n</span><span class="op" id="4204403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204406">for</span>&nbsp;<span class="op" id="4204410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204414">m</span><span class="op" id="4204415">,</span>&nbsp;<span class="ident" id="4204417">err</span>&nbsp;<span class="op" id="4204421">:=</span>&nbsp;<span class="ident" id="4204424">r</span><span class="op" id="4204425">.</span><span class="ident" id="4204426">Read</span><span class="op" id="4204430">(</span><span class="ident" id="4204431">b</span><span class="op" id="4204432">.</span><span class="ident" id="4204433">data</span><span class="op" id="4204437">[</span><span class="builtinfunc" id="4204438">len</span><span class="op" id="4204441">(</span><span class="ident" id="4204442">b</span><span class="op" id="4204443">.</span><span class="ident" id="4204444">data</span><span class="op" id="4204448">)</span><span class="op" id="4204449">:</span><span class="builtinfunc" id="4204450">cap</span><span class="op" id="4204453">(</span><span class="ident" id="4204454">b</span><span class="op" id="4204455">.</span><span class="ident" id="4204456">data</span><span class="op" id="4204460">)</span><span class="op" id="4204461">]</span><span class="op" id="4204462">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204466">b</span><span class="op" id="4204467">.</span><span class="ident" id="4204468">data</span>&nbsp;<span class="op" id="4204473">=</span>&nbsp;<span class="ident" id="4204475">b</span><span class="op" id="4204476">.</span><span class="ident" id="4204477">data</span><span class="op" id="4204481">[</span><span class="num" id="4204482">0</span>&nbsp;<span class="op" id="4204484">:</span>&nbsp;<span class="builtinfunc" id="4204486">len</span><span class="op" id="4204489">(</span><span class="ident" id="4204490">b</span><span class="op" id="4204491">.</span><span class="ident" id="4204492">data</span><span class="op" id="4204496">)</span><span class="op" id="4204497">+</span><span class="ident" id="4204498">m</span><span class="op" id="4204499">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204503">if</span>&nbsp;<span class="builtinfunc" id="4204506">len</span><span class="op" id="4204509">(</span><span class="ident" id="4204510">b</span><span class="op" id="4204511">.</span><span class="ident" id="4204512">data</span><span class="op" id="4204516">)</span>&nbsp;<span class="op" id="4204518">&gt;=</span>&nbsp;<span class="ident" id="4204521">n</span>&nbsp;<span class="op" id="4204523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204528">//&nbsp;TODO(bradfitz,agl):&nbsp;slightly&nbsp;suspicious</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4204574">//&nbsp;that&nbsp;we&#39;re&nbsp;throwing&nbsp;away&nbsp;r.Read&#39;s&nbsp;err&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204624">break</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204632">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204636">if</span>&nbsp;<span class="ident" id="4204639">err</span>&nbsp;<span class="op" id="4204643">!=</span>&nbsp;<span class="builtintype" id="4204646">nil</span>&nbsp;<span class="op" id="4204650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204655">return</span>&nbsp;<span class="ident" id="4204662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204671">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204674">return</span>&nbsp;<span class="builtintype" id="4204681">nil</span><br>
<span class="lineno"></span><span class="op" id="4204685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4204688">func</span>&nbsp;<span class="op" id="4204693">(</span><span class="ident" id="4204694">b</span>&nbsp;<span class="op" id="4204696">*</span><span class="ident" id="4204697">block</span><span class="op" id="4204702">)</span>&nbsp;<span class="ident" id="4204704">Read</span><span class="op" id="4204708">(</span><span class="ident" id="4204709">p</span>&nbsp;<span class="op" id="4204711">[</span><span class="op" id="4204712">]</span><span class="builtintype" id="4204713">byte</span><span class="op" id="4204717">)</span>&nbsp;<span class="op" id="4204719">(</span><span class="ident" id="4204720">n</span>&nbsp;<span class="builtintype" id="4204722">int</span><span class="op" id="4204725">,</span>&nbsp;<span class="ident" id="4204727">err</span>&nbsp;<span class="builtintype" id="4204731">error</span><span class="op" id="4204736">)</span>&nbsp;<span class="op" id="4204738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204741">n</span>&nbsp;<span class="op" id="4204743">=</span>&nbsp;<span class="builtinfunc" id="4204745">copy</span><span class="op" id="4204749">(</span><span class="ident" id="4204750">p</span><span class="op" id="4204751">,</span>&nbsp;<span class="ident" id="4204753">b</span><span class="op" id="4204754">.</span><span class="ident" id="4204755">data</span><span class="op" id="4204759">[</span><span class="ident" id="4204760">b</span><span class="op" id="4204761">.</span><span class="ident" id="4204762">off</span><span class="op" id="4204765">:</span><span class="op" id="4204766">]</span><span class="op" id="4204767">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204770">b</span><span class="op" id="4204771">.</span><span class="ident" id="4204772">off</span>&nbsp;<span class="op" id="4204776">+=</span>&nbsp;<span class="ident" id="4204779">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204782">return</span><br>
<span class="lineno"></span><span class="op" id="4204789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4204792">//&nbsp;newBlock&nbsp;allocates&nbsp;a&nbsp;new&nbsp;block,&nbsp;from&nbsp;hc&#39;s&nbsp;free&nbsp;list&nbsp;if&nbsp;possible.</span><br>
<span class="lineno">475</span><span class="keyword" id="4204860">func</span>&nbsp;<span class="op" id="4204865">(</span><span class="ident" id="4204866">hc</span>&nbsp;<span class="op" id="4204869">*</span><span class="ident" id="4204870">halfConn</span><span class="op" id="4204878">)</span>&nbsp;<span class="ident" id="4204880">newBlock</span><span class="op" id="4204888">(</span><span class="op" id="4204889">)</span>&nbsp;<span class="op" id="4204891">*</span><span class="ident" id="4204892">block</span>&nbsp;<span class="op" id="4204898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204901">b</span>&nbsp;<span class="op" id="4204903">:=</span>&nbsp;<span class="ident" id="4204906">hc</span><span class="op" id="4204908">.</span><span class="ident" id="4204909">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204916">if</span>&nbsp;<span class="ident" id="4204919">b</span>&nbsp;<span class="op" id="4204921">==</span>&nbsp;<span class="builtintype" id="4204924">nil</span>&nbsp;<span class="op" id="4204928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4204932">return</span>&nbsp;<span class="builtinfunc" id="4204939">new</span><span class="op" id="4204942">(</span><span class="ident" id="4204943">block</span><span class="op" id="4204948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4204951">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204954">hc</span><span class="op" id="4204956">.</span><span class="ident" id="4204957">bfree</span>&nbsp;<span class="op" id="4204963">=</span>&nbsp;<span class="ident" id="4204965">b</span><span class="op" id="4204966">.</span><span class="ident" id="4204967">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204973">b</span><span class="op" id="4204974">.</span><span class="ident" id="4204975">link</span>&nbsp;<span class="op" id="4204980">=</span>&nbsp;<span class="builtintype" id="4204982">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4204987">b</span><span class="op" id="4204988">.</span><span class="ident" id="4204989">resize</span><span class="op" id="4204995">(</span><span class="num" id="4204996">0</span><span class="op" id="4204997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205000">return</span>&nbsp;<span class="ident" id="4205007">b</span><br>
<span class="lineno"></span><span class="op" id="4205009">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="comment" id="4205012">//&nbsp;freeBlock&nbsp;returns&nbsp;a&nbsp;block&nbsp;to&nbsp;hc&#39;s&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="4205060">//&nbsp;The&nbsp;protocol&nbsp;is&nbsp;such&nbsp;that&nbsp;each&nbsp;side&nbsp;only&nbsp;has&nbsp;a&nbsp;block&nbsp;or&nbsp;two&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="4205126">//&nbsp;its&nbsp;free&nbsp;list&nbsp;at&nbsp;a&nbsp;time,&nbsp;so&nbsp;there&#39;s&nbsp;no&nbsp;need&nbsp;to&nbsp;worry&nbsp;about</span><br>
<span class="lineno"></span><span class="comment" id="4205188">//&nbsp;trimming&nbsp;the&nbsp;list,&nbsp;etc.</span><br>
<span class="lineno">490</span><span class="keyword" id="4205215">func</span>&nbsp;<span class="op" id="4205220">(</span><span class="ident" id="4205221">hc</span>&nbsp;<span class="op" id="4205224">*</span><span class="ident" id="4205225">halfConn</span><span class="op" id="4205233">)</span>&nbsp;<span class="ident" id="4205235">freeBlock</span><span class="op" id="4205244">(</span><span class="ident" id="4205245">b</span>&nbsp;<span class="op" id="4205247">*</span><span class="ident" id="4205248">block</span><span class="op" id="4205253">)</span>&nbsp;<span class="op" id="4205255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205258">b</span><span class="op" id="4205259">.</span><span class="ident" id="4205260">link</span>&nbsp;<span class="op" id="4205265">=</span>&nbsp;<span class="ident" id="4205267">hc</span><span class="op" id="4205269">.</span><span class="ident" id="4205270">bfree</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205277">hc</span><span class="op" id="4205279">.</span><span class="ident" id="4205280">bfree</span>&nbsp;<span class="op" id="4205286">=</span>&nbsp;<span class="ident" id="4205288">b</span><br>
<span class="lineno"></span><span class="op" id="4205290">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="4205293">//&nbsp;splitBlock&nbsp;splits&nbsp;a&nbsp;block&nbsp;after&nbsp;the&nbsp;first&nbsp;n&nbsp;bytes,</span><br>
<span class="lineno"></span><span class="comment" id="4205347">//&nbsp;returning&nbsp;a&nbsp;block&nbsp;with&nbsp;those&nbsp;n&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4205393">//&nbsp;block&nbsp;with&nbsp;the&nbsp;remainder.&nbsp;&nbsp;the&nbsp;latter&nbsp;may&nbsp;be&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4205446">func</span>&nbsp;<span class="op" id="4205451">(</span><span class="ident" id="4205452">hc</span>&nbsp;<span class="op" id="4205455">*</span><span class="ident" id="4205456">halfConn</span><span class="op" id="4205464">)</span>&nbsp;<span class="ident" id="4205466">splitBlock</span><span class="op" id="4205476">(</span><span class="ident" id="4205477">b</span>&nbsp;<span class="op" id="4205479">*</span><span class="ident" id="4205480">block</span><span class="op" id="4205485">,</span>&nbsp;<span class="ident" id="4205487">n</span>&nbsp;<span class="builtintype" id="4205489">int</span><span class="op" id="4205492">)</span>&nbsp;<span class="op" id="4205494">(</span><span class="op" id="4205495">*</span><span class="ident" id="4205496">block</span><span class="op" id="4205501">,</span>&nbsp;<span class="op" id="4205503">*</span><span class="ident" id="4205504">block</span><span class="op" id="4205509">)</span>&nbsp;<span class="op" id="4205511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205514">if</span>&nbsp;<span class="builtinfunc" id="4205517">len</span><span class="op" id="4205520">(</span><span class="ident" id="4205521">b</span><span class="op" id="4205522">.</span><span class="ident" id="4205523">data</span><span class="op" id="4205527">)</span>&nbsp;<span class="op" id="4205529">&lt;=</span>&nbsp;<span class="ident" id="4205532">n</span>&nbsp;<span class="op" id="4205534">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205538">return</span>&nbsp;<span class="ident" id="4205545">b</span><span class="op" id="4205546">,</span>&nbsp;<span class="builtintype" id="4205548">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4205553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205556">bb</span>&nbsp;<span class="op" id="4205559">:=</span>&nbsp;<span class="ident" id="4205562">hc</span><span class="op" id="4205564">.</span><span class="ident" id="4205565">newBlock</span><span class="op" id="4205573">(</span><span class="op" id="4205574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205577">bb</span><span class="op" id="4205579">.</span><span class="ident" id="4205580">resize</span><span class="op" id="4205586">(</span><span class="builtinfunc" id="4205587">len</span><span class="op" id="4205590">(</span><span class="ident" id="4205591">b</span><span class="op" id="4205592">.</span><span class="ident" id="4205593">data</span><span class="op" id="4205597">)</span>&nbsp;<span class="op" id="4205599">-</span>&nbsp;<span class="ident" id="4205601">n</span><span class="op" id="4205602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4205605">copy</span><span class="op" id="4205609">(</span><span class="ident" id="4205610">bb</span><span class="op" id="4205612">.</span><span class="ident" id="4205613">data</span><span class="op" id="4205617">,</span>&nbsp;<span class="ident" id="4205619">b</span><span class="op" id="4205620">.</span><span class="ident" id="4205621">data</span><span class="op" id="4205625">[</span><span class="ident" id="4205626">n</span><span class="op" id="4205627">:</span><span class="op" id="4205628">]</span><span class="op" id="4205629">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4205632">b</span><span class="op" id="4205633">.</span><span class="ident" id="4205634">data</span>&nbsp;<span class="op" id="4205639">=</span>&nbsp;<span class="ident" id="4205641">b</span><span class="op" id="4205642">.</span><span class="ident" id="4205643">data</span><span class="op" id="4205647">[</span><span class="num" id="4205648">0</span><span class="op" id="4205649">:</span><span class="ident" id="4205650">n</span><span class="op" id="4205651">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4205654">return</span>&nbsp;<span class="ident" id="4205661">b</span><span class="op" id="4205662">,</span>&nbsp;<span class="ident" id="4205664">bb</span><br>
<span class="lineno"></span><span class="op" id="4205667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4205670">//&nbsp;readRecord&nbsp;reads&nbsp;the&nbsp;next&nbsp;TLS&nbsp;record&nbsp;from&nbsp;the&nbsp;connection</span><br>
<span class="lineno">510</span><span class="comment" id="4205730">//&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4205769">//&nbsp;c.in.Mutex&nbsp;&lt;=&nbsp;L;&nbsp;c.input&nbsp;==&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword" id="4205805">func</span>&nbsp;<span class="op" id="4205810">(</span><span class="ident" id="4205811">c</span>&nbsp;<span class="op" id="4205813">*</span><span class="ident" id="4205814">Conn</span><span class="op" id="4205818">)</span>&nbsp;<span class="ident" id="4205820">readRecord</span><span class="op" id="4205830">(</span><span class="ident" id="4205831">want</span>&nbsp;<span class="ident" id="4205836">recordType</span><span class="op" id="4205846">)</span>&nbsp;<span class="builtintype" id="4205848">error</span>&nbsp;<span class="op" id="4205854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205857">//&nbsp;Caller&nbsp;must&nbsp;be&nbsp;in&nbsp;sync&nbsp;with&nbsp;connection:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205901">//&nbsp;handshake&nbsp;data&nbsp;if&nbsp;handshake&nbsp;not&nbsp;yet&nbsp;completed,</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4205952">//&nbsp;else&nbsp;application&nbsp;data.&nbsp;&nbsp;(We&nbsp;don&#39;t&nbsp;support&nbsp;renegotiation.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206014">switch</span>&nbsp;<span class="ident" id="4206021">want</span>&nbsp;<span class="op" id="4206026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206029">default</span><span class="op" id="4206036">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206040">c</span><span class="op" id="4206041">.</span><span class="ident" id="4206042">sendAlert</span><span class="op" id="4206051">(</span><span class="ident" id="4206052">alertInternalError</span><span class="op" id="4206070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206074">return</span>&nbsp;<span class="ident" id="4206081">c</span><span class="op" id="4206082">.</span><span class="ident" id="4206083">in</span><span class="op" id="4206085">.</span><span class="ident" id="4206086">setErrorLocked</span><span class="op" id="4206100">(</span><span class="ident" id="4206101">errors</span><span class="op" id="4206107">.</span><span class="ident" id="4206108">New</span><span class="op" id="4206111">(</span><span class="string" id="4206112">&#34;tls:&nbsp;unknown&nbsp;record&nbsp;type&nbsp;requested&#34;</span><span class="op" id="4206148">)</span><span class="op" id="4206149">)</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206152">case</span>&nbsp;<span class="ident" id="4206157">recordTypeHandshake</span><span class="op" id="4206176">,</span>&nbsp;<span class="ident" id="4206178">recordTypeChangeCipherSpec</span><span class="op" id="4206204">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206208">if</span>&nbsp;<span class="ident" id="4206211">c</span><span class="op" id="4206212">.</span><span class="ident" id="4206213">handshakeComplete</span>&nbsp;<span class="op" id="4206231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206236">c</span><span class="op" id="4206237">.</span><span class="ident" id="4206238">sendAlert</span><span class="op" id="4206247">(</span><span class="ident" id="4206248">alertInternalError</span><span class="op" id="4206266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206271">return</span>&nbsp;<span class="ident" id="4206278">c</span><span class="op" id="4206279">.</span><span class="ident" id="4206280">in</span><span class="op" id="4206282">.</span><span class="ident" id="4206283">setErrorLocked</span><span class="op" id="4206297">(</span><span class="ident" id="4206298">errors</span><span class="op" id="4206304">.</span><span class="ident" id="4206305">New</span><span class="op" id="4206308">(</span><span class="string" id="4206309">&#34;tls:&nbsp;handshake&nbsp;or&nbsp;ChangeCipherSpec&nbsp;requested&nbsp;after&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4206380">)</span><span class="op" id="4206381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206385">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206388">case</span>&nbsp;<span class="ident" id="4206393">recordTypeApplicationData</span><span class="op" id="4206418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206422">if</span>&nbsp;<span class="op" id="4206425">!</span><span class="ident" id="4206426">c</span><span class="op" id="4206427">.</span><span class="ident" id="4206428">handshakeComplete</span>&nbsp;<span class="op" id="4206446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206451">c</span><span class="op" id="4206452">.</span><span class="ident" id="4206453">sendAlert</span><span class="op" id="4206462">(</span><span class="ident" id="4206463">alertInternalError</span><span class="op" id="4206481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206486">return</span>&nbsp;<span class="ident" id="4206493">c</span><span class="op" id="4206494">.</span><span class="ident" id="4206495">in</span><span class="op" id="4206497">.</span><span class="ident" id="4206498">setErrorLocked</span><span class="op" id="4206512">(</span><span class="ident" id="4206513">errors</span><span class="op" id="4206519">.</span><span class="ident" id="4206520">New</span><span class="op" id="4206523">(</span><span class="string" id="4206524">&#34;tls:&nbsp;application&nbsp;data&nbsp;record&nbsp;requested&nbsp;before&nbsp;handshake&nbsp;complete&#34;</span><span class="op" id="4206590">)</span><span class="op" id="4206591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206595">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206598">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4206601">Again</span><span class="op" id="4206606">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206609">if</span>&nbsp;<span class="ident" id="4206612">c</span><span class="op" id="4206613">.</span><span class="ident" id="4206614">rawInput</span>&nbsp;<span class="op" id="4206623">==</span>&nbsp;<span class="builtintype" id="4206626">nil</span>&nbsp;<span class="op" id="4206630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206634">c</span><span class="op" id="4206635">.</span><span class="ident" id="4206636">rawInput</span>&nbsp;<span class="op" id="4206645">=</span>&nbsp;<span class="ident" id="4206647">c</span><span class="op" id="4206648">.</span><span class="ident" id="4206649">in</span><span class="op" id="4206651">.</span><span class="ident" id="4206652">newBlock</span><span class="op" id="4206660">(</span><span class="op" id="4206661">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4206664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4206667">b</span>&nbsp;<span class="op" id="4206669">:=</span>&nbsp;<span class="ident" id="4206672">c</span><span class="op" id="4206673">.</span><span class="ident" id="4206674">rawInput</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206685">//&nbsp;Read&nbsp;header,&nbsp;payload.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206711">if</span>&nbsp;<span class="ident" id="4206714">err</span>&nbsp;<span class="op" id="4206718">:=</span>&nbsp;<span class="ident" id="4206721">b</span><span class="op" id="4206722">.</span><span class="ident" id="4206723">readFromUntil</span><span class="op" id="4206736">(</span><span class="ident" id="4206737">c</span><span class="op" id="4206738">.</span><span class="ident" id="4206739">conn</span><span class="op" id="4206743">,</span>&nbsp;<span class="ident" id="4206745">recordHeaderLen</span><span class="op" id="4206760">)</span><span class="op" id="4206761">;</span>&nbsp;<span class="ident" id="4206763">err</span>&nbsp;<span class="op" id="4206767">!=</span>&nbsp;<span class="builtintype" id="4206770">nil</span>&nbsp;<span class="op" id="4206774">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206778">//&nbsp;RFC&nbsp;suggests&nbsp;that&nbsp;EOF&nbsp;without&nbsp;an&nbsp;alertCloseNotify&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206836">//&nbsp;an&nbsp;error,&nbsp;but&nbsp;popular&nbsp;web&nbsp;sites&nbsp;seem&nbsp;to&nbsp;do&nbsp;this,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206890">//&nbsp;so&nbsp;we&nbsp;can&#39;t&nbsp;make&nbsp;it&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206925">//&nbsp;if&nbsp;err&nbsp;==&nbsp;io.EOF&nbsp;{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206949">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;io.ErrUnexpectedEOF</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4206981">//&nbsp;}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4206988">if</span>&nbsp;<span class="ident" id="4206991">e</span><span class="op" id="4206992">,</span>&nbsp;<span class="ident" id="4206994">ok</span>&nbsp;<span class="op" id="4206997">:=</span>&nbsp;<span class="ident" id="4207000">err</span><span class="op" id="4207003">.</span><span class="op" id="4207004">(</span><span class="ident" id="4207005">net</span><span class="op" id="4207008">.</span><span class="ident" id="4207009">Error</span><span class="op" id="4207014">)</span><span class="op" id="4207015">;</span>&nbsp;<span class="op" id="4207017">!</span><span class="ident" id="4207018">ok</span>&nbsp;<span class="op" id="4207021">||</span>&nbsp;<span class="op" id="4207024">!</span><span class="ident" id="4207025">e</span><span class="op" id="4207026">.</span><span class="ident" id="4207027">Temporary</span><span class="op" id="4207036">(</span><span class="op" id="4207037">)</span>&nbsp;<span class="op" id="4207039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207044">c</span><span class="op" id="4207045">.</span><span class="ident" id="4207046">in</span><span class="op" id="4207048">.</span><span class="ident" id="4207049">setErrorLocked</span><span class="op" id="4207063">(</span><span class="ident" id="4207064">err</span><span class="op" id="4207067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207075">return</span>&nbsp;<span class="ident" id="4207082">err</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207090">typ</span>&nbsp;<span class="op" id="4207094">:=</span>&nbsp;<span class="ident" id="4207097">recordType</span><span class="op" id="4207107">(</span><span class="ident" id="4207108">b</span><span class="op" id="4207109">.</span><span class="ident" id="4207110">data</span><span class="op" id="4207114">[</span><span class="num" id="4207115">0</span><span class="op" id="4207116">]</span><span class="op" id="4207117">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207121">//&nbsp;No&nbsp;valid&nbsp;TLS&nbsp;record&nbsp;has&nbsp;a&nbsp;type&nbsp;of&nbsp;0x80,&nbsp;however&nbsp;SSLv2&nbsp;handshakes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207190">//&nbsp;start&nbsp;with&nbsp;a&nbsp;uint16&nbsp;length&nbsp;where&nbsp;the&nbsp;MSB&nbsp;is&nbsp;set&nbsp;and&nbsp;the&nbsp;first&nbsp;record</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207263">//&nbsp;is&nbsp;always&nbsp;&lt;&nbsp;256&nbsp;bytes&nbsp;long.&nbsp;Therefore&nbsp;typ&nbsp;==&nbsp;0x80&nbsp;strongly&nbsp;suggests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207335">//&nbsp;an&nbsp;SSLv2&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207356">if</span>&nbsp;<span class="ident" id="4207359">want</span>&nbsp;<span class="op" id="4207364">==</span>&nbsp;<span class="ident" id="4207367">recordTypeHandshake</span>&nbsp;<span class="op" id="4207387">&amp;&amp;</span>&nbsp;<span class="ident" id="4207390">typ</span>&nbsp;<span class="op" id="4207394">==</span>&nbsp;<span class="num" id="4207397">0x80</span>&nbsp;<span class="op" id="4207402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207406">c</span><span class="op" id="4207407">.</span><span class="ident" id="4207408">sendAlert</span><span class="op" id="4207417">(</span><span class="ident" id="4207418">alertProtocolVersion</span><span class="op" id="4207438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207442">return</span>&nbsp;<span class="ident" id="4207449">c</span><span class="op" id="4207450">.</span><span class="ident" id="4207451">in</span><span class="op" id="4207453">.</span><span class="ident" id="4207454">setErrorLocked</span><span class="op" id="4207468">(</span><span class="ident" id="4207469">errors</span><span class="op" id="4207475">.</span><span class="ident" id="4207476">New</span><span class="op" id="4207479">(</span><span class="string" id="4207480">&#34;tls:&nbsp;unsupported&nbsp;SSLv2&nbsp;handshake&nbsp;received&#34;</span><span class="op" id="4207523">)</span><span class="op" id="4207524">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207527">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207531">vers</span>&nbsp;<span class="op" id="4207536">:=</span>&nbsp;<span class="builtintype" id="4207539">uint16</span><span class="op" id="4207545">(</span><span class="ident" id="4207546">b</span><span class="op" id="4207547">.</span><span class="ident" id="4207548">data</span><span class="op" id="4207552">[</span><span class="num" id="4207553">1</span><span class="op" id="4207554">]</span><span class="op" id="4207555">)</span><span class="op" id="4207556">&lt;&lt;</span><span class="num" id="4207558">8</span>&nbsp;<span class="op" id="4207560">|</span>&nbsp;<span class="builtintype" id="4207562">uint16</span><span class="op" id="4207568">(</span><span class="ident" id="4207569">b</span><span class="op" id="4207570">.</span><span class="ident" id="4207571">data</span><span class="op" id="4207575">[</span><span class="num" id="4207576">2</span><span class="op" id="4207577">]</span><span class="op" id="4207578">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207581">n</span>&nbsp;<span class="op" id="4207583">:=</span>&nbsp;<span class="builtintype" id="4207586">int</span><span class="op" id="4207589">(</span><span class="ident" id="4207590">b</span><span class="op" id="4207591">.</span><span class="ident" id="4207592">data</span><span class="op" id="4207596">[</span><span class="num" id="4207597">3</span><span class="op" id="4207598">]</span><span class="op" id="4207599">)</span><span class="op" id="4207600">&lt;&lt;</span><span class="num" id="4207602">8</span>&nbsp;<span class="op" id="4207604">|</span>&nbsp;<span class="builtintype" id="4207606">int</span><span class="op" id="4207609">(</span><span class="ident" id="4207610">b</span><span class="op" id="4207611">.</span><span class="ident" id="4207612">data</span><span class="op" id="4207616">[</span><span class="num" id="4207617">4</span><span class="op" id="4207618">]</span><span class="op" id="4207619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207622">if</span>&nbsp;<span class="ident" id="4207625">c</span><span class="op" id="4207626">.</span><span class="ident" id="4207627">haveVers</span>&nbsp;<span class="op" id="4207636">&amp;&amp;</span>&nbsp;<span class="ident" id="4207639">vers</span>&nbsp;<span class="op" id="4207644">!=</span>&nbsp;<span class="ident" id="4207647">c</span><span class="op" id="4207648">.</span><span class="ident" id="4207649">vers</span>&nbsp;<span class="op" id="4207654">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207658">c</span><span class="op" id="4207659">.</span><span class="ident" id="4207660">sendAlert</span><span class="op" id="4207669">(</span><span class="ident" id="4207670">alertProtocolVersion</span><span class="op" id="4207690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207694">return</span>&nbsp;<span class="ident" id="4207701">c</span><span class="op" id="4207702">.</span><span class="ident" id="4207703">in</span><span class="op" id="4207705">.</span><span class="ident" id="4207706">setErrorLocked</span><span class="op" id="4207720">(</span><span class="ident" id="4207721">fmt</span><span class="op" id="4207724">.</span><span class="ident" id="4207725">Errorf</span><span class="op" id="4207731">(</span><span class="string" id="4207732">&#34;tls:&nbsp;received&nbsp;record&nbsp;with&nbsp;version&nbsp;%x&nbsp;when&nbsp;expecting&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4207796">,</span>&nbsp;<span class="ident" id="4207798">vers</span><span class="op" id="4207802">,</span>&nbsp;<span class="ident" id="4207804">c</span><span class="op" id="4207805">.</span><span class="ident" id="4207806">vers</span><span class="op" id="4207810">)</span><span class="op" id="4207811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207817">if</span>&nbsp;<span class="ident" id="4207820">n</span>&nbsp;<span class="op" id="4207822">&gt;</span>&nbsp;<span class="ident" id="4207824">maxCiphertext</span>&nbsp;<span class="op" id="4207838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4207842">c</span><span class="op" id="4207843">.</span><span class="ident" id="4207844">sendAlert</span><span class="op" id="4207853">(</span><span class="ident" id="4207854">alertRecordOverflow</span><span class="op" id="4207873">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207877">return</span>&nbsp;<span class="ident" id="4207884">c</span><span class="op" id="4207885">.</span><span class="ident" id="4207886">in</span><span class="op" id="4207888">.</span><span class="ident" id="4207889">setErrorLocked</span><span class="op" id="4207903">(</span><span class="ident" id="4207904">fmt</span><span class="op" id="4207907">.</span><span class="ident" id="4207908">Errorf</span><span class="op" id="4207914">(</span><span class="string" id="4207915">&#34;tls:&nbsp;oversized&nbsp;record&nbsp;received&nbsp;with&nbsp;length&nbsp;%d&#34;</span><span class="op" id="4207962">,</span>&nbsp;<span class="ident" id="4207964">n</span><span class="op" id="4207965">)</span><span class="op" id="4207966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4207969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4207972">if</span>&nbsp;<span class="op" id="4207975">!</span><span class="ident" id="4207976">c</span><span class="op" id="4207977">.</span><span class="ident" id="4207978">haveVers</span>&nbsp;<span class="op" id="4207987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4207991">//&nbsp;First&nbsp;message,&nbsp;be&nbsp;extra&nbsp;suspicious:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208032">//&nbsp;this&nbsp;might&nbsp;not&nbsp;be&nbsp;a&nbsp;TLS&nbsp;client.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208069">//&nbsp;Bail&nbsp;out&nbsp;before&nbsp;reading&nbsp;a&nbsp;full&nbsp;&#39;body&#39;,&nbsp;if&nbsp;possible.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208126">//&nbsp;The&nbsp;current&nbsp;max&nbsp;version&nbsp;is&nbsp;3.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208163">//&nbsp;If&nbsp;the&nbsp;version&nbsp;is&nbsp;&gt;=&nbsp;16.0,&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208219">//&nbsp;Similarly,&nbsp;a&nbsp;clientHello&nbsp;message&nbsp;encodes&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208268">//&nbsp;well&nbsp;under&nbsp;a&nbsp;kilobyte.&nbsp;&nbsp;If&nbsp;the&nbsp;length&nbsp;is&nbsp;&gt;=&nbsp;12&nbsp;kB,</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208324">//&nbsp;it&#39;s&nbsp;probably&nbsp;not&nbsp;real.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208353">if</span>&nbsp;<span class="op" id="4208356">(</span><span class="ident" id="4208357">typ</span>&nbsp;<span class="op" id="4208361">!=</span>&nbsp;<span class="ident" id="4208364">recordTypeAlert</span>&nbsp;<span class="op" id="4208380">&amp;&amp;</span>&nbsp;<span class="ident" id="4208383">typ</span>&nbsp;<span class="op" id="4208387">!=</span>&nbsp;<span class="ident" id="4208390">want</span><span class="op" id="4208394">)</span>&nbsp;<span class="op" id="4208396">||</span>&nbsp;<span class="ident" id="4208399">vers</span>&nbsp;<span class="op" id="4208404">&gt;=</span>&nbsp;<span class="num" id="4208407">0x1000</span>&nbsp;<span class="op" id="4208414">||</span>&nbsp;<span class="ident" id="4208417">n</span>&nbsp;<span class="op" id="4208419">&gt;=</span>&nbsp;<span class="num" id="4208422">0x3000</span>&nbsp;<span class="op" id="4208429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208434">c</span><span class="op" id="4208435">.</span><span class="ident" id="4208436">sendAlert</span><span class="op" id="4208445">(</span><span class="ident" id="4208446">alertUnexpectedMessage</span><span class="op" id="4208468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208473">return</span>&nbsp;<span class="ident" id="4208480">c</span><span class="op" id="4208481">.</span><span class="ident" id="4208482">in</span><span class="op" id="4208484">.</span><span class="ident" id="4208485">setErrorLocked</span><span class="op" id="4208499">(</span><span class="ident" id="4208500">fmt</span><span class="op" id="4208503">.</span><span class="ident" id="4208504">Errorf</span><span class="op" id="4208510">(</span><span class="string" id="4208511">&#34;tls:&nbsp;first&nbsp;record&nbsp;does&nbsp;not&nbsp;look&nbsp;like&nbsp;a&nbsp;TLS&nbsp;handshake&#34;</span><span class="op" id="4208565">)</span><span class="op" id="4208566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208570">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208576">if</span>&nbsp;<span class="ident" id="4208579">err</span>&nbsp;<span class="op" id="4208583">:=</span>&nbsp;<span class="ident" id="4208586">b</span><span class="op" id="4208587">.</span><span class="ident" id="4208588">readFromUntil</span><span class="op" id="4208601">(</span><span class="ident" id="4208602">c</span><span class="op" id="4208603">.</span><span class="ident" id="4208604">conn</span><span class="op" id="4208608">,</span>&nbsp;<span class="ident" id="4208610">recordHeaderLen</span><span class="op" id="4208625">+</span><span class="ident" id="4208626">n</span><span class="op" id="4208627">)</span><span class="op" id="4208628">;</span>&nbsp;<span class="ident" id="4208630">err</span>&nbsp;<span class="op" id="4208634">!=</span>&nbsp;<span class="builtintype" id="4208637">nil</span>&nbsp;<span class="op" id="4208641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208645">if</span>&nbsp;<span class="ident" id="4208648">err</span>&nbsp;<span class="op" id="4208652">==</span>&nbsp;<span class="ident" id="4208655">io</span><span class="op" id="4208657">.</span><span class="ident" id="4208658">EOF</span>&nbsp;<span class="op" id="4208662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208667">err</span>&nbsp;<span class="op" id="4208671">=</span>&nbsp;<span class="ident" id="4208673">io</span><span class="op" id="4208675">.</span><span class="ident" id="4208676">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208695">}</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208699">if</span>&nbsp;<span class="ident" id="4208702">e</span><span class="op" id="4208703">,</span>&nbsp;<span class="ident" id="4208705">ok</span>&nbsp;<span class="op" id="4208708">:=</span>&nbsp;<span class="ident" id="4208711">err</span><span class="op" id="4208714">.</span><span class="op" id="4208715">(</span><span class="ident" id="4208716">net</span><span class="op" id="4208719">.</span><span class="ident" id="4208720">Error</span><span class="op" id="4208725">)</span><span class="op" id="4208726">;</span>&nbsp;<span class="op" id="4208728">!</span><span class="ident" id="4208729">ok</span>&nbsp;<span class="op" id="4208732">||</span>&nbsp;<span class="op" id="4208735">!</span><span class="ident" id="4208736">e</span><span class="op" id="4208737">.</span><span class="ident" id="4208738">Temporary</span><span class="op" id="4208747">(</span><span class="op" id="4208748">)</span>&nbsp;<span class="op" id="4208750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208755">c</span><span class="op" id="4208756">.</span><span class="ident" id="4208757">in</span><span class="op" id="4208759">.</span><span class="ident" id="4208760">setErrorLocked</span><span class="op" id="4208774">(</span><span class="ident" id="4208775">err</span><span class="op" id="4208778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208786">return</span>&nbsp;<span class="ident" id="4208793">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208798">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4208802">//&nbsp;Process&nbsp;message.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208823">b</span><span class="op" id="4208824">,</span>&nbsp;<span class="ident" id="4208826">c</span><span class="op" id="4208827">.</span><span class="ident" id="4208828">rawInput</span>&nbsp;<span class="op" id="4208837">=</span>&nbsp;<span class="ident" id="4208839">c</span><span class="op" id="4208840">.</span><span class="ident" id="4208841">in</span><span class="op" id="4208843">.</span><span class="ident" id="4208844">splitBlock</span><span class="op" id="4208854">(</span><span class="ident" id="4208855">b</span><span class="op" id="4208856">,</span>&nbsp;<span class="ident" id="4208858">recordHeaderLen</span><span class="op" id="4208873">+</span><span class="ident" id="4208874">n</span><span class="op" id="4208875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208878">ok</span><span class="op" id="4208880">,</span>&nbsp;<span class="ident" id="4208882">off</span><span class="op" id="4208885">,</span>&nbsp;<span class="ident" id="4208887">err</span>&nbsp;<span class="op" id="4208891">:=</span>&nbsp;<span class="ident" id="4208894">c</span><span class="op" id="4208895">.</span><span class="ident" id="4208896">in</span><span class="op" id="4208898">.</span><span class="ident" id="4208899">decrypt</span><span class="op" id="4208906">(</span><span class="ident" id="4208907">b</span><span class="op" id="4208908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4208911">if</span>&nbsp;<span class="op" id="4208914">!</span><span class="ident" id="4208915">ok</span>&nbsp;<span class="op" id="4208918">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208922">c</span><span class="op" id="4208923">.</span><span class="ident" id="4208924">in</span><span class="op" id="4208926">.</span><span class="ident" id="4208927">setErrorLocked</span><span class="op" id="4208941">(</span><span class="ident" id="4208942">c</span><span class="op" id="4208943">.</span><span class="ident" id="4208944">sendAlert</span><span class="op" id="4208953">(</span><span class="ident" id="4208954">err</span><span class="op" id="4208957">)</span><span class="op" id="4208958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4208961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208964">b</span><span class="op" id="4208965">.</span><span class="ident" id="4208966">off</span>&nbsp;<span class="op" id="4208970">=</span>&nbsp;<span class="ident" id="4208972">off</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4208977">data</span>&nbsp;<span class="op" id="4208982">:=</span>&nbsp;<span class="ident" id="4208985">b</span><span class="op" id="4208986">.</span><span class="ident" id="4208987">data</span><span class="op" id="4208991">[</span><span class="ident" id="4208992">b</span><span class="op" id="4208993">.</span><span class="ident" id="4208994">off</span><span class="op" id="4208997">:</span><span class="op" id="4208998">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209001">if</span>&nbsp;<span class="builtinfunc" id="4209004">len</span><span class="op" id="4209007">(</span><span class="ident" id="4209008">data</span><span class="op" id="4209012">)</span>&nbsp;<span class="op" id="4209014">&gt;</span>&nbsp;<span class="ident" id="4209016">maxPlaintext</span>&nbsp;<span class="op" id="4209029">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209033">err</span>&nbsp;<span class="op" id="4209037">:=</span>&nbsp;<span class="ident" id="4209040">c</span><span class="op" id="4209041">.</span><span class="ident" id="4209042">sendAlert</span><span class="op" id="4209051">(</span><span class="ident" id="4209052">alertRecordOverflow</span><span class="op" id="4209071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209075">c</span><span class="op" id="4209076">.</span><span class="ident" id="4209077">in</span><span class="op" id="4209079">.</span><span class="ident" id="4209080">freeBlock</span><span class="op" id="4209089">(</span><span class="ident" id="4209090">b</span><span class="op" id="4209091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209095">return</span>&nbsp;<span class="ident" id="4209102">c</span><span class="op" id="4209103">.</span><span class="ident" id="4209104">in</span><span class="op" id="4209106">.</span><span class="ident" id="4209107">setErrorLocked</span><span class="op" id="4209121">(</span><span class="ident" id="4209122">err</span><span class="op" id="4209125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209132">switch</span>&nbsp;<span class="ident" id="4209139">typ</span>&nbsp;<span class="op" id="4209143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209146">default</span><span class="op" id="4209153">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209157">c</span><span class="op" id="4209158">.</span><span class="ident" id="4209159">in</span><span class="op" id="4209161">.</span><span class="ident" id="4209162">setErrorLocked</span><span class="op" id="4209176">(</span><span class="ident" id="4209177">c</span><span class="op" id="4209178">.</span><span class="ident" id="4209179">sendAlert</span><span class="op" id="4209188">(</span><span class="ident" id="4209189">alertUnexpectedMessage</span><span class="op" id="4209211">)</span><span class="op" id="4209212">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209216">case</span>&nbsp;<span class="ident" id="4209221">recordTypeAlert</span><span class="op" id="4209236">:</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209240">if</span>&nbsp;<span class="builtinfunc" id="4209243">len</span><span class="op" id="4209246">(</span><span class="ident" id="4209247">data</span><span class="op" id="4209251">)</span>&nbsp;<span class="op" id="4209253">!=</span>&nbsp;<span class="num" id="4209256">2</span>&nbsp;<span class="op" id="4209258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209263">c</span><span class="op" id="4209264">.</span><span class="ident" id="4209265">in</span><span class="op" id="4209267">.</span><span class="ident" id="4209268">setErrorLocked</span><span class="op" id="4209282">(</span><span class="ident" id="4209283">c</span><span class="op" id="4209284">.</span><span class="ident" id="4209285">sendAlert</span><span class="op" id="4209294">(</span><span class="ident" id="4209295">alertUnexpectedMessage</span><span class="op" id="4209317">)</span><span class="op" id="4209318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209323">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209335">if</span>&nbsp;<span class="ident" id="4209338">alert</span><span class="op" id="4209343">(</span><span class="ident" id="4209344">data</span><span class="op" id="4209348">[</span><span class="num" id="4209349">1</span><span class="op" id="4209350">]</span><span class="op" id="4209351">)</span>&nbsp;<span class="op" id="4209353">==</span>&nbsp;<span class="ident" id="4209356">alertCloseNotify</span>&nbsp;<span class="op" id="4209373">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209378">c</span><span class="op" id="4209379">.</span><span class="ident" id="4209380">in</span><span class="op" id="4209382">.</span><span class="ident" id="4209383">setErrorLocked</span><span class="op" id="4209397">(</span><span class="ident" id="4209398">io</span><span class="op" id="4209400">.</span><span class="ident" id="4209401">EOF</span><span class="op" id="4209404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209409">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209421">switch</span>&nbsp;<span class="ident" id="4209428">data</span><span class="op" id="4209432">[</span><span class="num" id="4209433">0</span><span class="op" id="4209434">]</span>&nbsp;<span class="op" id="4209436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209440">case</span>&nbsp;<span class="ident" id="4209445">alertLevelWarning</span><span class="op" id="4209462">:</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4209467">//&nbsp;drop&nbsp;on&nbsp;the&nbsp;floor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209491">c</span><span class="op" id="4209492">.</span><span class="ident" id="4209493">in</span><span class="op" id="4209495">.</span><span class="ident" id="4209496">freeBlock</span><span class="op" id="4209505">(</span><span class="ident" id="4209506">b</span><span class="op" id="4209507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209512">goto</span>&nbsp;<span class="ident" id="4209517">Again</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209525">case</span>&nbsp;<span class="ident" id="4209530">alertLevelError</span><span class="op" id="4209545">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209550">c</span><span class="op" id="4209551">.</span><span class="ident" id="4209552">in</span><span class="op" id="4209554">.</span><span class="ident" id="4209555">setErrorLocked</span><span class="op" id="4209569">(</span><span class="op" id="4209570">&amp;</span><span class="ident" id="4209571">net</span><span class="op" id="4209574">.</span><span class="ident" id="4209575">OpError</span><span class="op" id="4209582">{</span><span class="ident" id="4209583">Op</span><span class="op" id="4209585">:</span>&nbsp;<span class="string" id="4209587">&#34;remote&nbsp;error&#34;</span><span class="op" id="4209601">,</span>&nbsp;<span class="ident" id="4209603">Err</span><span class="op" id="4209606">:</span>&nbsp;<span class="ident" id="4209608">alert</span><span class="op" id="4209613">(</span><span class="ident" id="4209614">data</span><span class="op" id="4209618">[</span><span class="num" id="4209619">1</span><span class="op" id="4209620">]</span><span class="op" id="4209621">)</span><span class="op" id="4209622">}</span><span class="op" id="4209623">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209627">default</span><span class="op" id="4209634">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209639">c</span><span class="op" id="4209640">.</span><span class="ident" id="4209641">in</span><span class="op" id="4209643">.</span><span class="ident" id="4209644">setErrorLocked</span><span class="op" id="4209658">(</span><span class="ident" id="4209659">c</span><span class="op" id="4209660">.</span><span class="ident" id="4209661">sendAlert</span><span class="op" id="4209670">(</span><span class="ident" id="4209671">alertUnexpectedMessage</span><span class="op" id="4209693">)</span><span class="op" id="4209694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209698">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209702">case</span>&nbsp;<span class="ident" id="4209707">recordTypeChangeCipherSpec</span><span class="op" id="4209733">:</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209737">if</span>&nbsp;<span class="ident" id="4209740">typ</span>&nbsp;<span class="op" id="4209744">!=</span>&nbsp;<span class="ident" id="4209747">want</span>&nbsp;<span class="op" id="4209752">||</span>&nbsp;<span class="builtinfunc" id="4209755">len</span><span class="op" id="4209758">(</span><span class="ident" id="4209759">data</span><span class="op" id="4209763">)</span>&nbsp;<span class="op" id="4209765">!=</span>&nbsp;<span class="num" id="4209768">1</span>&nbsp;<span class="op" id="4209770">||</span>&nbsp;<span class="ident" id="4209773">data</span><span class="op" id="4209777">[</span><span class="num" id="4209778">0</span><span class="op" id="4209779">]</span>&nbsp;<span class="op" id="4209781">!=</span>&nbsp;<span class="num" id="4209784">1</span>&nbsp;<span class="op" id="4209786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209791">c</span><span class="op" id="4209792">.</span><span class="ident" id="4209793">in</span><span class="op" id="4209795">.</span><span class="ident" id="4209796">setErrorLocked</span><span class="op" id="4209810">(</span><span class="ident" id="4209811">c</span><span class="op" id="4209812">.</span><span class="ident" id="4209813">sendAlert</span><span class="op" id="4209822">(</span><span class="ident" id="4209823">alertUnexpectedMessage</span><span class="op" id="4209845">)</span><span class="op" id="4209846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209851">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209863">err</span>&nbsp;<span class="op" id="4209867">:=</span>&nbsp;<span class="ident" id="4209870">c</span><span class="op" id="4209871">.</span><span class="ident" id="4209872">in</span><span class="op" id="4209874">.</span><span class="ident" id="4209875">changeCipherSpec</span><span class="op" id="4209891">(</span><span class="op" id="4209892">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209896">if</span>&nbsp;<span class="ident" id="4209899">err</span>&nbsp;<span class="op" id="4209903">!=</span>&nbsp;<span class="builtintype" id="4209906">nil</span>&nbsp;<span class="op" id="4209910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4209915">c</span><span class="op" id="4209916">.</span><span class="ident" id="4209917">in</span><span class="op" id="4209919">.</span><span class="ident" id="4209920">setErrorLocked</span><span class="op" id="4209934">(</span><span class="ident" id="4209935">c</span><span class="op" id="4209936">.</span><span class="ident" id="4209937">sendAlert</span><span class="op" id="4209946">(</span><span class="ident" id="4209947">err</span><span class="op" id="4209950">.</span><span class="op" id="4209951">(</span><span class="ident" id="4209952">alert</span><span class="op" id="4209957">)</span><span class="op" id="4209958">)</span><span class="op" id="4209959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4209963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4209967">case</span>&nbsp;<span class="ident" id="4209972">recordTypeApplicationData</span><span class="op" id="4209997">:</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210001">if</span>&nbsp;<span class="ident" id="4210004">typ</span>&nbsp;<span class="op" id="4210008">!=</span>&nbsp;<span class="ident" id="4210011">want</span>&nbsp;<span class="op" id="4210016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210021">c</span><span class="op" id="4210022">.</span><span class="ident" id="4210023">in</span><span class="op" id="4210025">.</span><span class="ident" id="4210026">setErrorLocked</span><span class="op" id="4210040">(</span><span class="ident" id="4210041">c</span><span class="op" id="4210042">.</span><span class="ident" id="4210043">sendAlert</span><span class="op" id="4210052">(</span><span class="ident" id="4210053">alertUnexpectedMessage</span><span class="op" id="4210075">)</span><span class="op" id="4210076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210081">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210089">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210093">c</span><span class="op" id="4210094">.</span><span class="ident" id="4210095">input</span>&nbsp;<span class="op" id="4210101">=</span>&nbsp;<span class="ident" id="4210103">b</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210107">b</span>&nbsp;<span class="op" id="4210109">=</span>&nbsp;<span class="builtintype" id="4210111">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210117">case</span>&nbsp;<span class="ident" id="4210122">recordTypeHandshake</span><span class="op" id="4210141">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210145">//&nbsp;TODO(rsc):&nbsp;Should&nbsp;at&nbsp;least&nbsp;pick&nbsp;off&nbsp;connection&nbsp;close.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210204">if</span>&nbsp;<span class="ident" id="4210207">typ</span>&nbsp;<span class="op" id="4210211">!=</span>&nbsp;<span class="ident" id="4210214">want</span>&nbsp;<span class="op" id="4210219">{</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210224">return</span>&nbsp;<span class="ident" id="4210231">c</span><span class="op" id="4210232">.</span><span class="ident" id="4210233">in</span><span class="op" id="4210235">.</span><span class="ident" id="4210236">setErrorLocked</span><span class="op" id="4210250">(</span><span class="ident" id="4210251">c</span><span class="op" id="4210252">.</span><span class="ident" id="4210253">sendAlert</span><span class="op" id="4210262">(</span><span class="ident" id="4210263">alertNoRenegotiation</span><span class="op" id="4210283">)</span><span class="op" id="4210284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210292">c</span><span class="op" id="4210293">.</span><span class="ident" id="4210294">hand</span><span class="op" id="4210298">.</span><span class="ident" id="4210299">Write</span><span class="op" id="4210304">(</span><span class="ident" id="4210305">data</span><span class="op" id="4210309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210316">if</span>&nbsp;<span class="ident" id="4210319">b</span>&nbsp;<span class="op" id="4210321">!=</span>&nbsp;<span class="builtintype" id="4210324">nil</span>&nbsp;<span class="op" id="4210328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210332">c</span><span class="op" id="4210333">.</span><span class="ident" id="4210334">in</span><span class="op" id="4210336">.</span><span class="ident" id="4210337">freeBlock</span><span class="op" id="4210346">(</span><span class="ident" id="4210347">b</span><span class="op" id="4210348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210354">return</span>&nbsp;<span class="ident" id="4210361">c</span><span class="op" id="4210362">.</span><span class="ident" id="4210363">in</span><span class="op" id="4210365">.</span><span class="ident" id="4210366">err</span><br>
<span class="lineno"></span><span class="op" id="4210370">}</span><br>
<span class="lineno">665</span><br>
<span class="lineno"></span><span class="comment" id="4210373">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno"></span><span class="comment" id="4210413">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4210434">func</span>&nbsp;<span class="op" id="4210439">(</span><span class="ident" id="4210440">c</span>&nbsp;<span class="op" id="4210442">*</span><span class="ident" id="4210443">Conn</span><span class="op" id="4210447">)</span>&nbsp;<span class="ident" id="4210449">sendAlertLocked</span><span class="op" id="4210464">(</span><span class="ident" id="4210465">err</span>&nbsp;<span class="ident" id="4210469">alert</span><span class="op" id="4210474">)</span>&nbsp;<span class="builtintype" id="4210476">error</span>&nbsp;<span class="op" id="4210482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210485">switch</span>&nbsp;<span class="ident" id="4210492">err</span>&nbsp;<span class="op" id="4210496">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210499">case</span>&nbsp;<span class="ident" id="4210504">alertNoRenegotiation</span><span class="op" id="4210524">,</span>&nbsp;<span class="ident" id="4210526">alertCloseNotify</span><span class="op" id="4210542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210546">c</span><span class="op" id="4210547">.</span><span class="ident" id="4210548">tmp</span><span class="op" id="4210551">[</span><span class="num" id="4210552">0</span><span class="op" id="4210553">]</span>&nbsp;<span class="op" id="4210555">=</span>&nbsp;<span class="ident" id="4210557">alertLevelWarning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210576">default</span><span class="op" id="4210583">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210587">c</span><span class="op" id="4210588">.</span><span class="ident" id="4210589">tmp</span><span class="op" id="4210592">[</span><span class="num" id="4210593">0</span><span class="op" id="4210594">]</span>&nbsp;<span class="op" id="4210596">=</span>&nbsp;<span class="ident" id="4210598">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210615">}</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210618">c</span><span class="op" id="4210619">.</span><span class="ident" id="4210620">tmp</span><span class="op" id="4210623">[</span><span class="num" id="4210624">1</span><span class="op" id="4210625">]</span>&nbsp;<span class="op" id="4210627">=</span>&nbsp;<span class="builtintype" id="4210629">byte</span><span class="op" id="4210633">(</span><span class="ident" id="4210634">err</span><span class="op" id="4210637">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210640">c</span><span class="op" id="4210641">.</span><span class="ident" id="4210642">writeRecord</span><span class="op" id="4210653">(</span><span class="ident" id="4210654">recordTypeAlert</span><span class="op" id="4210669">,</span>&nbsp;<span class="ident" id="4210671">c</span><span class="op" id="4210672">.</span><span class="ident" id="4210673">tmp</span><span class="op" id="4210676">[</span><span class="num" id="4210677">0</span><span class="op" id="4210678">:</span><span class="num" id="4210679">2</span><span class="op" id="4210680">]</span><span class="op" id="4210681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4210684">//&nbsp;closeNotify&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;in&nbsp;that&nbsp;it&nbsp;isn&#39;t&nbsp;an&nbsp;error:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210745">if</span>&nbsp;<span class="ident" id="4210748">err</span>&nbsp;<span class="op" id="4210752">!=</span>&nbsp;<span class="ident" id="4210755">alertCloseNotify</span>&nbsp;<span class="op" id="4210772">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210776">return</span>&nbsp;<span class="ident" id="4210783">c</span><span class="op" id="4210784">.</span><span class="ident" id="4210785">out</span><span class="op" id="4210788">.</span><span class="ident" id="4210789">setErrorLocked</span><span class="op" id="4210803">(</span><span class="op" id="4210804">&amp;</span><span class="ident" id="4210805">net</span><span class="op" id="4210808">.</span><span class="ident" id="4210809">OpError</span><span class="op" id="4210816">{</span><span class="ident" id="4210817">Op</span><span class="op" id="4210819">:</span>&nbsp;<span class="string" id="4210821">&#34;local&nbsp;error&#34;</span><span class="op" id="4210834">,</span>&nbsp;<span class="ident" id="4210836">Err</span><span class="op" id="4210839">:</span>&nbsp;<span class="ident" id="4210841">err</span><span class="op" id="4210844">}</span><span class="op" id="4210845">)</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4210848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210851">return</span>&nbsp;<span class="builtintype" id="4210858">nil</span><br>
<span class="lineno"></span><span class="op" id="4210862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4210865">//&nbsp;sendAlert&nbsp;sends&nbsp;a&nbsp;TLS&nbsp;alert&nbsp;message.</span><br>
<span class="lineno">685</span><span class="comment" id="4210905">//&nbsp;L&nbsp;&lt;&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="4210925">func</span>&nbsp;<span class="op" id="4210930">(</span><span class="ident" id="4210931">c</span>&nbsp;<span class="op" id="4210933">*</span><span class="ident" id="4210934">Conn</span><span class="op" id="4210938">)</span>&nbsp;<span class="ident" id="4210940">sendAlert</span><span class="op" id="4210949">(</span><span class="ident" id="4210950">err</span>&nbsp;<span class="ident" id="4210954">alert</span><span class="op" id="4210959">)</span>&nbsp;<span class="builtintype" id="4210961">error</span>&nbsp;<span class="op" id="4210967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4210970">c</span><span class="op" id="4210971">.</span><span class="ident" id="4210972">out</span><span class="op" id="4210975">.</span><span class="ident" id="4210976">Lock</span><span class="op" id="4210980">(</span><span class="op" id="4210981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4210984">defer</span>&nbsp;<span class="ident" id="4210990">c</span><span class="op" id="4210991">.</span><span class="ident" id="4210992">out</span><span class="op" id="4210995">.</span><span class="ident" id="4210996">Unlock</span><span class="op" id="4211002">(</span><span class="op" id="4211003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211006">return</span>&nbsp;<span class="ident" id="4211013">c</span><span class="op" id="4211014">.</span><span class="ident" id="4211015">sendAlertLocked</span><span class="op" id="4211030">(</span><span class="ident" id="4211031">err</span><span class="op" id="4211034">)</span><br>
<span class="lineno">690</span><span class="op" id="4211036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4211039">//&nbsp;writeRecord&nbsp;writes&nbsp;a&nbsp;TLS&nbsp;record&nbsp;with&nbsp;the&nbsp;given&nbsp;type&nbsp;and&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4211106">//&nbsp;to&nbsp;the&nbsp;connection&nbsp;and&nbsp;updates&nbsp;the&nbsp;record&nbsp;layer&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="4211163">//&nbsp;c.out.Mutex&nbsp;&lt;=&nbsp;L.</span><br>
<span class="lineno">695</span><span class="keyword" id="4211184">func</span>&nbsp;<span class="op" id="4211189">(</span><span class="ident" id="4211190">c</span>&nbsp;<span class="op" id="4211192">*</span><span class="ident" id="4211193">Conn</span><span class="op" id="4211197">)</span>&nbsp;<span class="ident" id="4211199">writeRecord</span><span class="op" id="4211210">(</span><span class="ident" id="4211211">typ</span>&nbsp;<span class="ident" id="4211215">recordType</span><span class="op" id="4211225">,</span>&nbsp;<span class="ident" id="4211227">data</span>&nbsp;<span class="op" id="4211232">[</span><span class="op" id="4211233">]</span><span class="builtintype" id="4211234">byte</span><span class="op" id="4211238">)</span>&nbsp;<span class="op" id="4211240">(</span><span class="ident" id="4211241">n</span>&nbsp;<span class="builtintype" id="4211243">int</span><span class="op" id="4211246">,</span>&nbsp;<span class="ident" id="4211248">err</span>&nbsp;<span class="builtintype" id="4211252">error</span><span class="op" id="4211257">)</span>&nbsp;<span class="op" id="4211259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211262">b</span>&nbsp;<span class="op" id="4211264">:=</span>&nbsp;<span class="ident" id="4211267">c</span><span class="op" id="4211268">.</span><span class="ident" id="4211269">out</span><span class="op" id="4211272">.</span><span class="ident" id="4211273">newBlock</span><span class="op" id="4211281">(</span><span class="op" id="4211282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211285">for</span>&nbsp;<span class="builtinfunc" id="4211289">len</span><span class="op" id="4211292">(</span><span class="ident" id="4211293">data</span><span class="op" id="4211297">)</span>&nbsp;<span class="op" id="4211299">&gt;</span>&nbsp;<span class="num" id="4211301">0</span>&nbsp;<span class="op" id="4211303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211307">m</span>&nbsp;<span class="op" id="4211309">:=</span>&nbsp;<span class="builtinfunc" id="4211312">len</span><span class="op" id="4211315">(</span><span class="ident" id="4211316">data</span><span class="op" id="4211320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211324">if</span>&nbsp;<span class="ident" id="4211327">m</span>&nbsp;<span class="op" id="4211329">&gt;</span>&nbsp;<span class="ident" id="4211331">maxPlaintext</span>&nbsp;<span class="op" id="4211344">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211349">m</span>&nbsp;<span class="op" id="4211351">=</span>&nbsp;<span class="ident" id="4211353">maxPlaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211372">explicitIVLen</span>&nbsp;<span class="op" id="4211386">:=</span>&nbsp;<span class="num" id="4211389">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211393">explicitIVIsSeq</span>&nbsp;<span class="op" id="4211409">:=</span>&nbsp;<span class="builtintype" id="4211412">false</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211421">var</span>&nbsp;<span class="ident" id="4211425">cbc</span>&nbsp;<span class="ident" id="4211429">cbcMode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211439">if</span>&nbsp;<span class="ident" id="4211442">c</span><span class="op" id="4211443">.</span><span class="ident" id="4211444">out</span><span class="op" id="4211447">.</span><span class="ident" id="4211448">version</span>&nbsp;<span class="op" id="4211456">&gt;=</span>&nbsp;<span class="ident" id="4211459">VersionTLS11</span>&nbsp;<span class="op" id="4211472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211477">var</span>&nbsp;<span class="ident" id="4211481">ok</span>&nbsp;<span class="builtintype" id="4211484">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211492">if</span>&nbsp;<span class="ident" id="4211495">cbc</span><span class="op" id="4211498">,</span>&nbsp;<span class="ident" id="4211500">ok</span>&nbsp;<span class="op" id="4211503">=</span>&nbsp;<span class="ident" id="4211505">c</span><span class="op" id="4211506">.</span><span class="ident" id="4211507">out</span><span class="op" id="4211510">.</span><span class="ident" id="4211511">cipher</span><span class="op" id="4211517">.</span><span class="op" id="4211518">(</span><span class="ident" id="4211519">cbcMode</span><span class="op" id="4211526">)</span><span class="op" id="4211527">;</span>&nbsp;<span class="ident" id="4211529">ok</span>&nbsp;<span class="op" id="4211532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211538">explicitIVLen</span>&nbsp;<span class="op" id="4211552">=</span>&nbsp;<span class="ident" id="4211554">cbc</span><span class="op" id="4211557">.</span><span class="ident" id="4211558">BlockSize</span><span class="op" id="4211567">(</span><span class="op" id="4211568">)</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211573">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211581">if</span>&nbsp;<span class="ident" id="4211584">explicitIVLen</span>&nbsp;<span class="op" id="4211598">==</span>&nbsp;<span class="num" id="4211601">0</span>&nbsp;<span class="op" id="4211603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4211608">if</span>&nbsp;<span class="ident" id="4211611">_</span><span class="op" id="4211612">,</span>&nbsp;<span class="ident" id="4211614">ok</span>&nbsp;<span class="op" id="4211617">:=</span>&nbsp;<span class="ident" id="4211620">c</span><span class="op" id="4211621">.</span><span class="ident" id="4211622">out</span><span class="op" id="4211625">.</span><span class="ident" id="4211626">cipher</span><span class="op" id="4211632">.</span><span class="op" id="4211633">(</span><span class="ident" id="4211634">cipher</span><span class="op" id="4211640">.</span><span class="ident" id="4211641">AEAD</span><span class="op" id="4211645">)</span><span class="op" id="4211646">;</span>&nbsp;<span class="ident" id="4211648">ok</span>&nbsp;<span class="op" id="4211651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211657">explicitIVLen</span>&nbsp;<span class="op" id="4211671">=</span>&nbsp;<span class="num" id="4211673">8</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211679">//&nbsp;The&nbsp;AES-GCM&nbsp;construction&nbsp;in&nbsp;TLS&nbsp;has&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211725">//&nbsp;explicit&nbsp;nonce&nbsp;so&nbsp;that&nbsp;the&nbsp;nonce&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211772">//&nbsp;random.&nbsp;However,&nbsp;the&nbsp;nonce&nbsp;is&nbsp;only&nbsp;8&nbsp;bytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211822">//&nbsp;which&nbsp;is&nbsp;too&nbsp;small&nbsp;for&nbsp;a&nbsp;secure,&nbsp;random</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211869">//&nbsp;nonce.&nbsp;Therefore&nbsp;we&nbsp;use&nbsp;the&nbsp;sequence&nbsp;number</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4211920">//&nbsp;as&nbsp;the&nbsp;nonce.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211941">explicitIVIsSeq</span>&nbsp;<span class="op" id="4211957">=</span>&nbsp;<span class="builtintype" id="4211959">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211967">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4211971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4211975">b</span><span class="op" id="4211976">.</span><span class="ident" id="4211977">resize</span><span class="op" id="4211983">(</span><span class="ident" id="4211984">recordHeaderLen</span>&nbsp;<span class="op" id="4212000">+</span>&nbsp;<span class="ident" id="4212002">explicitIVLen</span>&nbsp;<span class="op" id="4212016">+</span>&nbsp;<span class="ident" id="4212018">m</span><span class="op" id="4212019">)</span><br>
<span class="lineno">725</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212023">b</span><span class="op" id="4212024">.</span><span class="ident" id="4212025">data</span><span class="op" id="4212029">[</span><span class="num" id="4212030">0</span><span class="op" id="4212031">]</span>&nbsp;<span class="op" id="4212033">=</span>&nbsp;<span class="builtintype" id="4212035">byte</span><span class="op" id="4212039">(</span><span class="ident" id="4212040">typ</span><span class="op" id="4212043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212047">vers</span>&nbsp;<span class="op" id="4212052">:=</span>&nbsp;<span class="ident" id="4212055">c</span><span class="op" id="4212056">.</span><span class="ident" id="4212057">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212064">if</span>&nbsp;<span class="ident" id="4212067">vers</span>&nbsp;<span class="op" id="4212072">==</span>&nbsp;<span class="num" id="4212075">0</span>&nbsp;<span class="op" id="4212077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212082">//&nbsp;Some&nbsp;TLS&nbsp;servers&nbsp;fail&nbsp;if&nbsp;the&nbsp;record&nbsp;version&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212135">//&nbsp;greater&nbsp;than&nbsp;TLS&nbsp;1.0&nbsp;for&nbsp;the&nbsp;initial&nbsp;ClientHello.</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212191">vers</span>&nbsp;<span class="op" id="4212196">=</span>&nbsp;<span class="ident" id="4212198">VersionTLS10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212217">b</span><span class="op" id="4212218">.</span><span class="ident" id="4212219">data</span><span class="op" id="4212223">[</span><span class="num" id="4212224">1</span><span class="op" id="4212225">]</span>&nbsp;<span class="op" id="4212227">=</span>&nbsp;<span class="builtintype" id="4212229">byte</span><span class="op" id="4212233">(</span><span class="ident" id="4212234">vers</span>&nbsp;<span class="op" id="4212239">&gt;&gt;</span>&nbsp;<span class="num" id="4212242">8</span><span class="op" id="4212243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212247">b</span><span class="op" id="4212248">.</span><span class="ident" id="4212249">data</span><span class="op" id="4212253">[</span><span class="num" id="4212254">2</span><span class="op" id="4212255">]</span>&nbsp;<span class="op" id="4212257">=</span>&nbsp;<span class="builtintype" id="4212259">byte</span><span class="op" id="4212263">(</span><span class="ident" id="4212264">vers</span><span class="op" id="4212268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212272">b</span><span class="op" id="4212273">.</span><span class="ident" id="4212274">data</span><span class="op" id="4212278">[</span><span class="num" id="4212279">3</span><span class="op" id="4212280">]</span>&nbsp;<span class="op" id="4212282">=</span>&nbsp;<span class="builtintype" id="4212284">byte</span><span class="op" id="4212288">(</span><span class="ident" id="4212289">m</span>&nbsp;<span class="op" id="4212291">&gt;&gt;</span>&nbsp;<span class="num" id="4212294">8</span><span class="op" id="4212295">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212299">b</span><span class="op" id="4212300">.</span><span class="ident" id="4212301">data</span><span class="op" id="4212305">[</span><span class="num" id="4212306">4</span><span class="op" id="4212307">]</span>&nbsp;<span class="op" id="4212309">=</span>&nbsp;<span class="builtintype" id="4212311">byte</span><span class="op" id="4212315">(</span><span class="ident" id="4212316">m</span><span class="op" id="4212317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212321">if</span>&nbsp;<span class="ident" id="4212324">explicitIVLen</span>&nbsp;<span class="op" id="4212338">&gt;</span>&nbsp;<span class="num" id="4212340">0</span>&nbsp;<span class="op" id="4212342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212347">explicitIV</span>&nbsp;<span class="op" id="4212358">:=</span>&nbsp;<span class="ident" id="4212361">b</span><span class="op" id="4212362">.</span><span class="ident" id="4212363">data</span><span class="op" id="4212367">[</span><span class="ident" id="4212368">recordHeaderLen</span>&nbsp;<span class="op" id="4212384">:</span>&nbsp;<span class="ident" id="4212386">recordHeaderLen</span><span class="op" id="4212401">+</span><span class="ident" id="4212402">explicitIVLen</span><span class="op" id="4212415">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212420">if</span>&nbsp;<span class="ident" id="4212423">explicitIVIsSeq</span>&nbsp;<span class="op" id="4212439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4212445">copy</span><span class="op" id="4212449">(</span><span class="ident" id="4212450">explicitIV</span><span class="op" id="4212460">,</span>&nbsp;<span class="ident" id="4212462">c</span><span class="op" id="4212463">.</span><span class="ident" id="4212464">out</span><span class="op" id="4212467">.</span><span class="ident" id="4212468">seq</span><span class="op" id="4212471">[</span><span class="op" id="4212472">:</span><span class="op" id="4212473">]</span><span class="op" id="4212474">)</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212479">}</span>&nbsp;<span class="keyword" id="4212481">else</span>&nbsp;<span class="op" id="4212486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212492">if</span>&nbsp;<span class="ident" id="4212495">_</span><span class="op" id="4212496">,</span>&nbsp;<span class="ident" id="4212498">err</span>&nbsp;<span class="op" id="4212502">=</span>&nbsp;<span class="ident" id="4212504">io</span><span class="op" id="4212506">.</span><span class="ident" id="4212507">ReadFull</span><span class="op" id="4212515">(</span><span class="ident" id="4212516">c</span><span class="op" id="4212517">.</span><span class="ident" id="4212518">config</span><span class="op" id="4212524">.</span><span class="ident" id="4212525">rand</span><span class="op" id="4212529">(</span><span class="op" id="4212530">)</span><span class="op" id="4212531">,</span>&nbsp;<span class="ident" id="4212533">explicitIV</span><span class="op" id="4212543">)</span><span class="op" id="4212544">;</span>&nbsp;<span class="ident" id="4212546">err</span>&nbsp;<span class="op" id="4212550">!=</span>&nbsp;<span class="builtintype" id="4212553">nil</span>&nbsp;<span class="op" id="4212557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212564">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212579">}</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4212587">copy</span><span class="op" id="4212591">(</span><span class="ident" id="4212592">b</span><span class="op" id="4212593">.</span><span class="ident" id="4212594">data</span><span class="op" id="4212598">[</span><span class="ident" id="4212599">recordHeaderLen</span><span class="op" id="4212614">+</span><span class="ident" id="4212615">explicitIVLen</span><span class="op" id="4212628">:</span><span class="op" id="4212629">]</span><span class="op" id="4212630">,</span>&nbsp;<span class="ident" id="4212632">data</span><span class="op" id="4212636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212640">c</span><span class="op" id="4212641">.</span><span class="ident" id="4212642">out</span><span class="op" id="4212645">.</span><span class="ident" id="4212646">encrypt</span><span class="op" id="4212653">(</span><span class="ident" id="4212654">b</span><span class="op" id="4212655">,</span>&nbsp;<span class="ident" id="4212657">explicitIVLen</span><span class="op" id="4212670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212674">_</span><span class="op" id="4212675">,</span>&nbsp;<span class="ident" id="4212677">err</span>&nbsp;<span class="op" id="4212681">=</span>&nbsp;<span class="ident" id="4212683">c</span><span class="op" id="4212684">.</span><span class="ident" id="4212685">conn</span><span class="op" id="4212689">.</span><span class="ident" id="4212690">Write</span><span class="op" id="4212695">(</span><span class="ident" id="4212696">b</span><span class="op" id="4212697">.</span><span class="ident" id="4212698">data</span><span class="op" id="4212702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212706">if</span>&nbsp;<span class="ident" id="4212709">err</span>&nbsp;<span class="op" id="4212713">!=</span>&nbsp;<span class="builtintype" id="4212716">nil</span>&nbsp;<span class="op" id="4212720">{</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212725">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212737">n</span>&nbsp;<span class="op" id="4212739">+=</span>&nbsp;<span class="ident" id="4212742">m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212746">data</span>&nbsp;<span class="op" id="4212751">=</span>&nbsp;<span class="ident" id="4212753">data</span><span class="op" id="4212757">[</span><span class="ident" id="4212758">m</span><span class="op" id="4212759">:</span><span class="op" id="4212760">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4212763">}</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212766">c</span><span class="op" id="4212767">.</span><span class="ident" id="4212768">out</span><span class="op" id="4212771">.</span><span class="ident" id="4212772">freeBlock</span><span class="op" id="4212781">(</span><span class="ident" id="4212782">b</span><span class="op" id="4212783">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212787">if</span>&nbsp;<span class="ident" id="4212790">typ</span>&nbsp;<span class="op" id="4212794">==</span>&nbsp;<span class="ident" id="4212797">recordTypeChangeCipherSpec</span>&nbsp;<span class="op" id="4212824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212828">err</span>&nbsp;<span class="op" id="4212832">=</span>&nbsp;<span class="ident" id="4212834">c</span><span class="op" id="4212835">.</span><span class="ident" id="4212836">out</span><span class="op" id="4212839">.</span><span class="ident" id="4212840">changeCipherSpec</span><span class="op" id="4212856">(</span><span class="op" id="4212857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4212861">if</span>&nbsp;<span class="ident" id="4212864">err</span>&nbsp;<span class="op" id="4212868">!=</span>&nbsp;<span class="builtintype" id="4212871">nil</span>&nbsp;<span class="op" id="4212875">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212880">//&nbsp;Cannot&nbsp;call&nbsp;sendAlert&nbsp;directly,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4212918">//&nbsp;because&nbsp;we&nbsp;already&nbsp;hold&nbsp;c.out.Mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212961">c</span><span class="op" id="4212962">.</span><span class="ident" id="4212963">tmp</span><span class="op" id="4212966">[</span><span class="num" id="4212967">0</span><span class="op" id="4212968">]</span>&nbsp;<span class="op" id="4212970">=</span>&nbsp;<span class="ident" id="4212972">alertLevelError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4212991">c</span><span class="op" id="4212992">.</span><span class="ident" id="4212993">tmp</span><span class="op" id="4212996">[</span><span class="num" id="4212997">1</span><span class="op" id="4212998">]</span>&nbsp;<span class="op" id="4213000">=</span>&nbsp;<span class="builtintype" id="4213002">byte</span><span class="op" id="4213006">(</span><span class="ident" id="4213007">err</span><span class="op" id="4213010">.</span><span class="op" id="4213011">(</span><span class="ident" id="4213012">alert</span><span class="op" id="4213017">)</span><span class="op" id="4213018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213023">c</span><span class="op" id="4213024">.</span><span class="ident" id="4213025">writeRecord</span><span class="op" id="4213036">(</span><span class="ident" id="4213037">recordTypeAlert</span><span class="op" id="4213052">,</span>&nbsp;<span class="ident" id="4213054">c</span><span class="op" id="4213055">.</span><span class="ident" id="4213056">tmp</span><span class="op" id="4213059">[</span><span class="num" id="4213060">0</span><span class="op" id="4213061">:</span><span class="num" id="4213062">2</span><span class="op" id="4213063">]</span><span class="op" id="4213064">)</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213069">return</span>&nbsp;<span class="ident" id="4213076">n</span><span class="op" id="4213077">,</span>&nbsp;<span class="ident" id="4213079">c</span><span class="op" id="4213080">.</span><span class="ident" id="4213081">out</span><span class="op" id="4213084">.</span><span class="ident" id="4213085">setErrorLocked</span><span class="op" id="4213099">(</span><span class="op" id="4213100">&amp;</span><span class="ident" id="4213101">net</span><span class="op" id="4213104">.</span><span class="ident" id="4213105">OpError</span><span class="op" id="4213112">{</span><span class="ident" id="4213113">Op</span><span class="op" id="4213115">:</span>&nbsp;<span class="string" id="4213117">&#34;local&nbsp;error&#34;</span><span class="op" id="4213130">,</span>&nbsp;<span class="ident" id="4213132">Err</span><span class="op" id="4213135">:</span>&nbsp;<span class="ident" id="4213137">err</span><span class="op" id="4213140">}</span><span class="op" id="4213141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213151">return</span><br>
<span class="lineno"></span><span class="op" id="4213158">}</span><br>
<span class="lineno">770</span><br>
<span class="lineno"></span><span class="comment" id="4213161">//&nbsp;readHandshake&nbsp;reads&nbsp;the&nbsp;next&nbsp;handshake&nbsp;message&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4213216">//&nbsp;the&nbsp;record&nbsp;layer.</span><br>
<span class="lineno"></span><span class="comment" id="4213237">//&nbsp;c.in.Mutex&nbsp;&lt;&nbsp;L;&nbsp;c.out.Mutex&nbsp;&lt;&nbsp;L.</span><br>
<span class="lineno"></span><span class="keyword" id="4213273">func</span>&nbsp;<span class="op" id="4213278">(</span><span class="ident" id="4213279">c</span>&nbsp;<span class="op" id="4213281">*</span><span class="ident" id="4213282">Conn</span><span class="op" id="4213286">)</span>&nbsp;<span class="ident" id="4213288">readHandshake</span><span class="op" id="4213301">(</span><span class="op" id="4213302">)</span>&nbsp;<span class="op" id="4213304">(</span><span class="keyword" id="4213305">interface</span><span class="op" id="4213314">{</span><span class="op" id="4213315">}</span><span class="op" id="4213316">,</span>&nbsp;<span class="builtintype" id="4213318">error</span><span class="op" id="4213323">)</span>&nbsp;<span class="op" id="4213325">{</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213328">for</span>&nbsp;<span class="ident" id="4213332">c</span><span class="op" id="4213333">.</span><span class="ident" id="4213334">hand</span><span class="op" id="4213338">.</span><span class="ident" id="4213339">Len</span><span class="op" id="4213342">(</span><span class="op" id="4213343">)</span>&nbsp;<span class="op" id="4213345">&lt;</span>&nbsp;<span class="num" id="4213347">4</span>&nbsp;<span class="op" id="4213349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213353">if</span>&nbsp;<span class="ident" id="4213356">err</span>&nbsp;<span class="op" id="4213360">:=</span>&nbsp;<span class="ident" id="4213363">c</span><span class="op" id="4213364">.</span><span class="ident" id="4213365">in</span><span class="op" id="4213367">.</span><span class="ident" id="4213368">err</span><span class="op" id="4213371">;</span>&nbsp;<span class="ident" id="4213373">err</span>&nbsp;<span class="op" id="4213377">!=</span>&nbsp;<span class="builtintype" id="4213380">nil</span>&nbsp;<span class="op" id="4213384">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213389">return</span>&nbsp;<span class="builtintype" id="4213396">nil</span><span class="op" id="4213399">,</span>&nbsp;<span class="ident" id="4213401">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213411">if</span>&nbsp;<span class="ident" id="4213414">err</span>&nbsp;<span class="op" id="4213418">:=</span>&nbsp;<span class="ident" id="4213421">c</span><span class="op" id="4213422">.</span><span class="ident" id="4213423">readRecord</span><span class="op" id="4213433">(</span><span class="ident" id="4213434">recordTypeHandshake</span><span class="op" id="4213453">)</span><span class="op" id="4213454">;</span>&nbsp;<span class="ident" id="4213456">err</span>&nbsp;<span class="op" id="4213460">!=</span>&nbsp;<span class="builtintype" id="4213463">nil</span>&nbsp;<span class="op" id="4213467">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213472">return</span>&nbsp;<span class="builtintype" id="4213479">nil</span><span class="op" id="4213482">,</span>&nbsp;<span class="ident" id="4213484">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213497">data</span>&nbsp;<span class="op" id="4213502">:=</span>&nbsp;<span class="ident" id="4213505">c</span><span class="op" id="4213506">.</span><span class="ident" id="4213507">hand</span><span class="op" id="4213511">.</span><span class="ident" id="4213512">Bytes</span><span class="op" id="4213517">(</span><span class="op" id="4213518">)</span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213521">n</span>&nbsp;<span class="op" id="4213523">:=</span>&nbsp;<span class="builtintype" id="4213526">int</span><span class="op" id="4213529">(</span><span class="ident" id="4213530">data</span><span class="op" id="4213534">[</span><span class="num" id="4213535">1</span><span class="op" id="4213536">]</span><span class="op" id="4213537">)</span><span class="op" id="4213538">&lt;&lt;</span><span class="num" id="4213540">16</span>&nbsp;<span class="op" id="4213543">|</span>&nbsp;<span class="builtintype" id="4213545">int</span><span class="op" id="4213548">(</span><span class="ident" id="4213549">data</span><span class="op" id="4213553">[</span><span class="num" id="4213554">2</span><span class="op" id="4213555">]</span><span class="op" id="4213556">)</span><span class="op" id="4213557">&lt;&lt;</span><span class="num" id="4213559">8</span>&nbsp;<span class="op" id="4213561">|</span>&nbsp;<span class="builtintype" id="4213563">int</span><span class="op" id="4213566">(</span><span class="ident" id="4213567">data</span><span class="op" id="4213571">[</span><span class="num" id="4213572">3</span><span class="op" id="4213573">]</span><span class="op" id="4213574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213577">if</span>&nbsp;<span class="ident" id="4213580">n</span>&nbsp;<span class="op" id="4213582">&gt;</span>&nbsp;<span class="ident" id="4213584">maxHandshake</span>&nbsp;<span class="op" id="4213597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213601">return</span>&nbsp;<span class="builtintype" id="4213608">nil</span><span class="op" id="4213611">,</span>&nbsp;<span class="ident" id="4213613">c</span><span class="op" id="4213614">.</span><span class="ident" id="4213615">in</span><span class="op" id="4213617">.</span><span class="ident" id="4213618">setErrorLocked</span><span class="op" id="4213632">(</span><span class="ident" id="4213633">c</span><span class="op" id="4213634">.</span><span class="ident" id="4213635">sendAlert</span><span class="op" id="4213644">(</span><span class="ident" id="4213645">alertInternalError</span><span class="op" id="4213663">)</span><span class="op" id="4213664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213667">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213670">for</span>&nbsp;<span class="ident" id="4213674">c</span><span class="op" id="4213675">.</span><span class="ident" id="4213676">hand</span><span class="op" id="4213680">.</span><span class="ident" id="4213681">Len</span><span class="op" id="4213684">(</span><span class="op" id="4213685">)</span>&nbsp;<span class="op" id="4213687">&lt;</span>&nbsp;<span class="num" id="4213689">4</span><span class="op" id="4213690">+</span><span class="ident" id="4213691">n</span>&nbsp;<span class="op" id="4213693">{</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213697">if</span>&nbsp;<span class="ident" id="4213700">err</span>&nbsp;<span class="op" id="4213704">:=</span>&nbsp;<span class="ident" id="4213707">c</span><span class="op" id="4213708">.</span><span class="ident" id="4213709">in</span><span class="op" id="4213711">.</span><span class="ident" id="4213712">err</span><span class="op" id="4213715">;</span>&nbsp;<span class="ident" id="4213717">err</span>&nbsp;<span class="op" id="4213721">!=</span>&nbsp;<span class="builtintype" id="4213724">nil</span>&nbsp;<span class="op" id="4213728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213733">return</span>&nbsp;<span class="builtintype" id="4213740">nil</span><span class="op" id="4213743">,</span>&nbsp;<span class="ident" id="4213745">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213755">if</span>&nbsp;<span class="ident" id="4213758">err</span>&nbsp;<span class="op" id="4213762">:=</span>&nbsp;<span class="ident" id="4213765">c</span><span class="op" id="4213766">.</span><span class="ident" id="4213767">readRecord</span><span class="op" id="4213777">(</span><span class="ident" id="4213778">recordTypeHandshake</span><span class="op" id="4213797">)</span><span class="op" id="4213798">;</span>&nbsp;<span class="ident" id="4213800">err</span>&nbsp;<span class="op" id="4213804">!=</span>&nbsp;<span class="builtintype" id="4213807">nil</span>&nbsp;<span class="op" id="4213811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213816">return</span>&nbsp;<span class="builtintype" id="4213823">nil</span><span class="op" id="4213826">,</span>&nbsp;<span class="ident" id="4213828">err</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4213837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213840">data</span>&nbsp;<span class="op" id="4213845">=</span>&nbsp;<span class="ident" id="4213847">c</span><span class="op" id="4213848">.</span><span class="ident" id="4213849">hand</span><span class="op" id="4213853">.</span><span class="ident" id="4213854">Next</span><span class="op" id="4213858">(</span><span class="num" id="4213859">4</span>&nbsp;<span class="op" id="4213861">+</span>&nbsp;<span class="ident" id="4213863">n</span><span class="op" id="4213864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213867">var</span>&nbsp;<span class="ident" id="4213871">m</span>&nbsp;<span class="ident" id="4213873">handshakeMessage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213891">switch</span>&nbsp;<span class="ident" id="4213898">data</span><span class="op" id="4213902">[</span><span class="num" id="4213903">0</span><span class="op" id="4213904">]</span>&nbsp;<span class="op" id="4213906">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213909">case</span>&nbsp;<span class="ident" id="4213914">typeClientHello</span><span class="op" id="4213929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213933">m</span>&nbsp;<span class="op" id="4213935">=</span>&nbsp;<span class="builtinfunc" id="4213937">new</span><span class="op" id="4213940">(</span><span class="ident" id="4213941">clientHelloMsg</span><span class="op" id="4213955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4213958">case</span>&nbsp;<span class="ident" id="4213963">typeServerHello</span><span class="op" id="4213978">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4213982">m</span>&nbsp;<span class="op" id="4213984">=</span>&nbsp;<span class="builtinfunc" id="4213986">new</span><span class="op" id="4213989">(</span><span class="ident" id="4213990">serverHelloMsg</span><span class="op" id="4214004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214007">case</span>&nbsp;<span class="ident" id="4214012">typeNewSessionTicket</span><span class="op" id="4214032">:</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214036">m</span>&nbsp;<span class="op" id="4214038">=</span>&nbsp;<span class="builtinfunc" id="4214040">new</span><span class="op" id="4214043">(</span><span class="ident" id="4214044">newSessionTicketMsg</span><span class="op" id="4214063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214066">case</span>&nbsp;<span class="ident" id="4214071">typeCertificate</span><span class="op" id="4214086">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214090">m</span>&nbsp;<span class="op" id="4214092">=</span>&nbsp;<span class="builtinfunc" id="4214094">new</span><span class="op" id="4214097">(</span><span class="ident" id="4214098">certificateMsg</span><span class="op" id="4214112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214115">case</span>&nbsp;<span class="ident" id="4214120">typeCertificateRequest</span><span class="op" id="4214142">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214146">m</span>&nbsp;<span class="op" id="4214148">=</span>&nbsp;<span class="op" id="4214150">&amp;</span><span class="ident" id="4214151">certificateRequestMsg</span><span class="op" id="4214172">{</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214177">hasSignatureAndHash</span><span class="op" id="4214196">:</span>&nbsp;<span class="ident" id="4214198">c</span><span class="op" id="4214199">.</span><span class="ident" id="4214200">vers</span>&nbsp;<span class="op" id="4214205">&gt;=</span>&nbsp;<span class="ident" id="4214208">VersionTLS12</span><span class="op" id="4214220">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214227">case</span>&nbsp;<span class="ident" id="4214232">typeCertificateStatus</span><span class="op" id="4214253">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214257">m</span>&nbsp;<span class="op" id="4214259">=</span>&nbsp;<span class="builtinfunc" id="4214261">new</span><span class="op" id="4214264">(</span><span class="ident" id="4214265">certificateStatusMsg</span><span class="op" id="4214285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214288">case</span>&nbsp;<span class="ident" id="4214293">typeServerKeyExchange</span><span class="op" id="4214314">:</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214318">m</span>&nbsp;<span class="op" id="4214320">=</span>&nbsp;<span class="builtinfunc" id="4214322">new</span><span class="op" id="4214325">(</span><span class="ident" id="4214326">serverKeyExchangeMsg</span><span class="op" id="4214346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214349">case</span>&nbsp;<span class="ident" id="4214354">typeServerHelloDone</span><span class="op" id="4214373">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214377">m</span>&nbsp;<span class="op" id="4214379">=</span>&nbsp;<span class="builtinfunc" id="4214381">new</span><span class="op" id="4214384">(</span><span class="ident" id="4214385">serverHelloDoneMsg</span><span class="op" id="4214403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214406">case</span>&nbsp;<span class="ident" id="4214411">typeClientKeyExchange</span><span class="op" id="4214432">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214436">m</span>&nbsp;<span class="op" id="4214438">=</span>&nbsp;<span class="builtinfunc" id="4214440">new</span><span class="op" id="4214443">(</span><span class="ident" id="4214444">clientKeyExchangeMsg</span><span class="op" id="4214464">)</span><br>
<span class="lineno">820</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214467">case</span>&nbsp;<span class="ident" id="4214472">typeCertificateVerify</span><span class="op" id="4214493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214497">m</span>&nbsp;<span class="op" id="4214499">=</span>&nbsp;<span class="op" id="4214501">&amp;</span><span class="ident" id="4214502">certificateVerifyMsg</span><span class="op" id="4214522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214527">hasSignatureAndHash</span><span class="op" id="4214546">:</span>&nbsp;<span class="ident" id="4214548">c</span><span class="op" id="4214549">.</span><span class="ident" id="4214550">vers</span>&nbsp;<span class="op" id="4214555">&gt;=</span>&nbsp;<span class="ident" id="4214558">VersionTLS12</span><span class="op" id="4214570">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214577">case</span>&nbsp;<span class="ident" id="4214582">typeNextProtocol</span><span class="op" id="4214598">:</span><br>
<span class="lineno">825</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214602">m</span>&nbsp;<span class="op" id="4214604">=</span>&nbsp;<span class="builtinfunc" id="4214606">new</span><span class="op" id="4214609">(</span><span class="ident" id="4214610">nextProtoMsg</span><span class="op" id="4214622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214625">case</span>&nbsp;<span class="ident" id="4214630">typeFinished</span><span class="op" id="4214642">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214646">m</span>&nbsp;<span class="op" id="4214648">=</span>&nbsp;<span class="builtinfunc" id="4214650">new</span><span class="op" id="4214653">(</span><span class="ident" id="4214654">finishedMsg</span><span class="op" id="4214665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214668">default</span><span class="op" id="4214675">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214679">return</span>&nbsp;<span class="builtintype" id="4214686">nil</span><span class="op" id="4214689">,</span>&nbsp;<span class="ident" id="4214691">c</span><span class="op" id="4214692">.</span><span class="ident" id="4214693">in</span><span class="op" id="4214695">.</span><span class="ident" id="4214696">setErrorLocked</span><span class="op" id="4214710">(</span><span class="ident" id="4214711">c</span><span class="op" id="4214712">.</span><span class="ident" id="4214713">sendAlert</span><span class="op" id="4214722">(</span><span class="ident" id="4214723">alertUnexpectedMessage</span><span class="op" id="4214745">)</span><span class="op" id="4214746">)</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4214749">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214753">//&nbsp;The&nbsp;handshake&nbsp;message&nbsp;unmarshallers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214793">//&nbsp;expect&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;keep&nbsp;references&nbsp;to&nbsp;data,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4214843">//&nbsp;so&nbsp;pass&nbsp;in&nbsp;a&nbsp;fresh&nbsp;copy&nbsp;that&nbsp;won&#39;t&nbsp;be&nbsp;overwritten.</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4214898">data</span>&nbsp;<span class="op" id="4214903">=</span>&nbsp;<span class="builtinfunc" id="4214905">append</span><span class="op" id="4214911">(</span><span class="op" id="4214912">[</span><span class="op" id="4214913">]</span><span class="builtintype" id="4214914">byte</span><span class="op" id="4214918">(</span><span class="builtintype" id="4214919">nil</span><span class="op" id="4214922">)</span><span class="op" id="4214923">,</span>&nbsp;<span class="ident" id="4214925">data</span><span class="op" id="4214929">...</span><span class="op" id="4214932">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214936">if</span>&nbsp;<span class="op" id="4214939">!</span><span class="ident" id="4214940">m</span><span class="op" id="4214941">.</span><span class="ident" id="4214942">unmarshal</span><span class="op" id="4214951">(</span><span class="ident" id="4214952">data</span><span class="op" id="4214956">)</span>&nbsp;<span class="op" id="4214958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4214962">return</span>&nbsp;<span class="builtintype" id="4214969">nil</span><span class="op" id="4214972">,</span>&nbsp;<span class="ident" id="4214974">c</span><span class="op" id="4214975">.</span><span class="ident" id="4214976">in</span><span class="op" id="4214978">.</span><span class="ident" id="4214979">setErrorLocked</span><span class="op" id="4214993">(</span><span class="ident" id="4214994">c</span><span class="op" id="4214995">.</span><span class="ident" id="4214996">sendAlert</span><span class="op" id="4215005">(</span><span class="ident" id="4215006">alertUnexpectedMessage</span><span class="op" id="4215028">)</span><span class="op" id="4215029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215032">}</span><br>
<span class="lineno">840</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215035">return</span>&nbsp;<span class="ident" id="4215042">m</span><span class="op" id="4215043">,</span>&nbsp;<span class="builtintype" id="4215045">nil</span><br>
<span class="lineno"></span><span class="op" id="4215049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4215052">//&nbsp;Write&nbsp;writes&nbsp;data&nbsp;to&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4215092">func</span>&nbsp;<span class="op" id="4215097">(</span><span class="ident" id="4215098">c</span>&nbsp;<span class="op" id="4215100">*</span><span class="ident" id="4215101">Conn</span><span class="op" id="4215105">)</span>&nbsp;<span class="ident" id="4215107">Write</span><span class="op" id="4215112">(</span><span class="ident" id="4215113">b</span>&nbsp;<span class="op" id="4215115">[</span><span class="op" id="4215116">]</span><span class="builtintype" id="4215117">byte</span><span class="op" id="4215121">)</span>&nbsp;<span class="op" id="4215123">(</span><span class="builtintype" id="4215124">int</span><span class="op" id="4215127">,</span>&nbsp;<span class="builtintype" id="4215129">error</span><span class="op" id="4215134">)</span>&nbsp;<span class="op" id="4215136">{</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215139">if</span>&nbsp;<span class="ident" id="4215142">err</span>&nbsp;<span class="op" id="4215146">:=</span>&nbsp;<span class="ident" id="4215149">c</span><span class="op" id="4215150">.</span><span class="ident" id="4215151">Handshake</span><span class="op" id="4215160">(</span><span class="op" id="4215161">)</span><span class="op" id="4215162">;</span>&nbsp;<span class="ident" id="4215164">err</span>&nbsp;<span class="op" id="4215168">!=</span>&nbsp;<span class="builtintype" id="4215171">nil</span>&nbsp;<span class="op" id="4215175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215179">return</span>&nbsp;<span class="num" id="4215186">0</span><span class="op" id="4215187">,</span>&nbsp;<span class="ident" id="4215189">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215198">c</span><span class="op" id="4215199">.</span><span class="ident" id="4215200">out</span><span class="op" id="4215203">.</span><span class="ident" id="4215204">Lock</span><span class="op" id="4215208">(</span><span class="op" id="4215209">)</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215212">defer</span>&nbsp;<span class="ident" id="4215218">c</span><span class="op" id="4215219">.</span><span class="ident" id="4215220">out</span><span class="op" id="4215223">.</span><span class="ident" id="4215224">Unlock</span><span class="op" id="4215230">(</span><span class="op" id="4215231">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215235">if</span>&nbsp;<span class="ident" id="4215238">err</span>&nbsp;<span class="op" id="4215242">:=</span>&nbsp;<span class="ident" id="4215245">c</span><span class="op" id="4215246">.</span><span class="ident" id="4215247">out</span><span class="op" id="4215250">.</span><span class="ident" id="4215251">err</span><span class="op" id="4215254">;</span>&nbsp;<span class="ident" id="4215256">err</span>&nbsp;<span class="op" id="4215260">!=</span>&nbsp;<span class="builtintype" id="4215263">nil</span>&nbsp;<span class="op" id="4215267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215271">return</span>&nbsp;<span class="num" id="4215278">0</span><span class="op" id="4215279">,</span>&nbsp;<span class="ident" id="4215281">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215286">}</span><br>
<span class="lineno">855</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215290">if</span>&nbsp;<span class="op" id="4215293">!</span><span class="ident" id="4215294">c</span><span class="op" id="4215295">.</span><span class="ident" id="4215296">handshakeComplete</span>&nbsp;<span class="op" id="4215314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215318">return</span>&nbsp;<span class="num" id="4215325">0</span><span class="op" id="4215326">,</span>&nbsp;<span class="ident" id="4215328">alertInternalError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215352">//&nbsp;SSL&nbsp;3.0&nbsp;and&nbsp;TLS&nbsp;1.0&nbsp;are&nbsp;susceptible&nbsp;to&nbsp;a&nbsp;chosen-plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215414">//&nbsp;attack&nbsp;when&nbsp;using&nbsp;block&nbsp;mode&nbsp;ciphers&nbsp;due&nbsp;to&nbsp;predictable&nbsp;IVs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215479">//&nbsp;This&nbsp;can&nbsp;be&nbsp;prevented&nbsp;by&nbsp;splitting&nbsp;each&nbsp;Application&nbsp;Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215540">//&nbsp;record&nbsp;into&nbsp;two&nbsp;records,&nbsp;effectively&nbsp;randomizing&nbsp;the&nbsp;IV.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215601">//</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215605">//&nbsp;http://www.openssl.org/~bodo/tls-cbc.txt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215650">//&nbsp;https://bugzilla.mozilla.org/show_bug.cgi?id=665814</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4215706">//&nbsp;http://www.imperialviolet.org/2012/01/15/beastfollowup.html</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215771">var</span>&nbsp;<span class="ident" id="4215775">m</span>&nbsp;<span class="builtintype" id="4215777">int</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215782">if</span>&nbsp;<span class="builtinfunc" id="4215785">len</span><span class="op" id="4215788">(</span><span class="ident" id="4215789">b</span><span class="op" id="4215790">)</span>&nbsp;<span class="op" id="4215792">&gt;</span>&nbsp;<span class="num" id="4215794">1</span>&nbsp;<span class="op" id="4215796">&amp;&amp;</span>&nbsp;<span class="ident" id="4215799">c</span><span class="op" id="4215800">.</span><span class="ident" id="4215801">vers</span>&nbsp;<span class="op" id="4215806">&lt;=</span>&nbsp;<span class="ident" id="4215809">VersionTLS10</span>&nbsp;<span class="op" id="4215822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215826">if</span>&nbsp;<span class="ident" id="4215829">_</span><span class="op" id="4215830">,</span>&nbsp;<span class="ident" id="4215832">ok</span>&nbsp;<span class="op" id="4215835">:=</span>&nbsp;<span class="ident" id="4215838">c</span><span class="op" id="4215839">.</span><span class="ident" id="4215840">out</span><span class="op" id="4215843">.</span><span class="ident" id="4215844">cipher</span><span class="op" id="4215850">.</span><span class="op" id="4215851">(</span><span class="ident" id="4215852">cipher</span><span class="op" id="4215858">.</span><span class="ident" id="4215859">BlockMode</span><span class="op" id="4215868">)</span><span class="op" id="4215869">;</span>&nbsp;<span class="ident" id="4215871">ok</span>&nbsp;<span class="op" id="4215874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4215879">n</span><span class="op" id="4215880">,</span>&nbsp;<span class="ident" id="4215882">err</span>&nbsp;<span class="op" id="4215886">:=</span>&nbsp;<span class="ident" id="4215889">c</span><span class="op" id="4215890">.</span><span class="ident" id="4215891">writeRecord</span><span class="op" id="4215902">(</span><span class="ident" id="4215903">recordTypeApplicationData</span><span class="op" id="4215928">,</span>&nbsp;<span class="ident" id="4215930">b</span><span class="op" id="4215931">[</span><span class="op" id="4215932">:</span><span class="num" id="4215933">1</span><span class="op" id="4215934">]</span><span class="op" id="4215935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215940">if</span>&nbsp;<span class="ident" id="4215943">err</span>&nbsp;<span class="op" id="4215947">!=</span>&nbsp;<span class="builtintype" id="4215950">nil</span>&nbsp;<span class="op" id="4215954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4215960">return</span>&nbsp;<span class="ident" id="4215967">n</span><span class="op" id="4215968">,</span>&nbsp;<span class="ident" id="4215970">c</span><span class="op" id="4215971">.</span><span class="ident" id="4215972">out</span><span class="op" id="4215975">.</span><span class="ident" id="4215976">setErrorLocked</span><span class="op" id="4215990">(</span><span class="ident" id="4215991">err</span><span class="op" id="4215994">)</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4215999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216004">m</span><span class="op" id="4216005">,</span>&nbsp;<span class="ident" id="4216007">b</span>&nbsp;<span class="op" id="4216009">=</span>&nbsp;<span class="num" id="4216011">1</span><span class="op" id="4216012">,</span>&nbsp;<span class="ident" id="4216014">b</span><span class="op" id="4216015">[</span><span class="num" id="4216016">1</span><span class="op" id="4216017">:</span><span class="op" id="4216018">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216029">n</span><span class="op" id="4216030">,</span>&nbsp;<span class="ident" id="4216032">err</span>&nbsp;<span class="op" id="4216036">:=</span>&nbsp;<span class="ident" id="4216039">c</span><span class="op" id="4216040">.</span><span class="ident" id="4216041">writeRecord</span><span class="op" id="4216052">(</span><span class="ident" id="4216053">recordTypeApplicationData</span><span class="op" id="4216078">,</span>&nbsp;<span class="ident" id="4216080">b</span><span class="op" id="4216081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216084">return</span>&nbsp;<span class="ident" id="4216091">n</span>&nbsp;<span class="op" id="4216093">+</span>&nbsp;<span class="ident" id="4216095">m</span><span class="op" id="4216096">,</span>&nbsp;<span class="ident" id="4216098">c</span><span class="op" id="4216099">.</span><span class="ident" id="4216100">out</span><span class="op" id="4216103">.</span><span class="ident" id="4216104">setErrorLocked</span><span class="op" id="4216118">(</span><span class="ident" id="4216119">err</span><span class="op" id="4216122">)</span><br>
<span class="lineno"></span><span class="op" id="4216124">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4216127">//&nbsp;Read&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;a&nbsp;net.Error&nbsp;with&nbsp;Timeout()&nbsp;==&nbsp;true</span><br>
<span class="lineno">885</span><span class="comment" id="4216205">//&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and&nbsp;SetReadDeadline.</span><br>
<span class="lineno"></span><span class="keyword" id="4216271">func</span>&nbsp;<span class="op" id="4216276">(</span><span class="ident" id="4216277">c</span>&nbsp;<span class="op" id="4216279">*</span><span class="ident" id="4216280">Conn</span><span class="op" id="4216284">)</span>&nbsp;<span class="ident" id="4216286">Read</span><span class="op" id="4216290">(</span><span class="ident" id="4216291">b</span>&nbsp;<span class="op" id="4216293">[</span><span class="op" id="4216294">]</span><span class="builtintype" id="4216295">byte</span><span class="op" id="4216299">)</span>&nbsp;<span class="op" id="4216301">(</span><span class="ident" id="4216302">n</span>&nbsp;<span class="builtintype" id="4216304">int</span><span class="op" id="4216307">,</span>&nbsp;<span class="ident" id="4216309">err</span>&nbsp;<span class="builtintype" id="4216313">error</span><span class="op" id="4216318">)</span>&nbsp;<span class="op" id="4216320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216323">if</span>&nbsp;<span class="ident" id="4216326">err</span>&nbsp;<span class="op" id="4216330">=</span>&nbsp;<span class="ident" id="4216332">c</span><span class="op" id="4216333">.</span><span class="ident" id="4216334">Handshake</span><span class="op" id="4216343">(</span><span class="op" id="4216344">)</span><span class="op" id="4216345">;</span>&nbsp;<span class="ident" id="4216347">err</span>&nbsp;<span class="op" id="4216351">!=</span>&nbsp;<span class="builtintype" id="4216354">nil</span>&nbsp;<span class="op" id="4216358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216362">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216370">}</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216373">if</span>&nbsp;<span class="builtinfunc" id="4216376">len</span><span class="op" id="4216379">(</span><span class="ident" id="4216380">b</span><span class="op" id="4216381">)</span>&nbsp;<span class="op" id="4216383">==</span>&nbsp;<span class="num" id="4216386">0</span>&nbsp;<span class="op" id="4216388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216392">//&nbsp;Put&nbsp;this&nbsp;after&nbsp;Handshake,&nbsp;in&nbsp;case&nbsp;people&nbsp;were&nbsp;calling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216451">//&nbsp;Read(nil)&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of&nbsp;the&nbsp;Handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216504">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216512">}</span><br>
<span class="lineno">895</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4216516">c</span><span class="op" id="4216517">.</span><span class="ident" id="4216518">in</span><span class="op" id="4216520">.</span><span class="ident" id="4216521">Lock</span><span class="op" id="4216525">(</span><span class="op" id="4216526">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216529">defer</span>&nbsp;<span class="ident" id="4216535">c</span><span class="op" id="4216536">.</span><span class="ident" id="4216537">in</span><span class="op" id="4216539">.</span><span class="ident" id="4216540">Unlock</span><span class="op" id="4216546">(</span><span class="op" id="4216547">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216551">//&nbsp;Some&nbsp;OpenSSL&nbsp;servers&nbsp;send&nbsp;empty&nbsp;records&nbsp;in&nbsp;order&nbsp;to&nbsp;randomize&nbsp;the</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216621">//&nbsp;CBC&nbsp;IV.&nbsp;So&nbsp;this&nbsp;loop&nbsp;ignores&nbsp;a&nbsp;limited&nbsp;number&nbsp;of&nbsp;empty&nbsp;records.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216689">const</span>&nbsp;<span class="ident" id="4216695">maxConsecutiveEmptyRecords</span>&nbsp;<span class="op" id="4216722">=</span>&nbsp;<span class="num" id="4216724">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216729">for</span>&nbsp;<span class="ident" id="4216733">emptyRecordCount</span>&nbsp;<span class="op" id="4216750">:=</span>&nbsp;<span class="num" id="4216753">0</span><span class="op" id="4216754">;</span>&nbsp;<span class="ident" id="4216756">emptyRecordCount</span>&nbsp;<span class="op" id="4216773">&lt;=</span>&nbsp;<span class="ident" id="4216776">maxConsecutiveEmptyRecords</span><span class="op" id="4216802">;</span>&nbsp;<span class="ident" id="4216804">emptyRecordCount</span><span class="op" id="4216820">++</span>&nbsp;<span class="op" id="4216823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216827">for</span>&nbsp;<span class="ident" id="4216831">c</span><span class="op" id="4216832">.</span><span class="ident" id="4216833">input</span>&nbsp;<span class="op" id="4216839">==</span>&nbsp;<span class="builtintype" id="4216842">nil</span>&nbsp;<span class="op" id="4216846">&amp;&amp;</span>&nbsp;<span class="ident" id="4216849">c</span><span class="op" id="4216850">.</span><span class="ident" id="4216851">in</span><span class="op" id="4216853">.</span><span class="ident" id="4216854">err</span>&nbsp;<span class="op" id="4216858">==</span>&nbsp;<span class="builtintype" id="4216861">nil</span>&nbsp;<span class="op" id="4216865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216870">if</span>&nbsp;<span class="ident" id="4216873">err</span>&nbsp;<span class="op" id="4216877">:=</span>&nbsp;<span class="ident" id="4216880">c</span><span class="op" id="4216881">.</span><span class="ident" id="4216882">readRecord</span><span class="op" id="4216892">(</span><span class="ident" id="4216893">recordTypeApplicationData</span><span class="op" id="4216918">)</span><span class="op" id="4216919">;</span>&nbsp;<span class="ident" id="4216921">err</span>&nbsp;<span class="op" id="4216925">!=</span>&nbsp;<span class="builtintype" id="4216928">nil</span>&nbsp;<span class="op" id="4216932">{</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4216938">//&nbsp;Soft&nbsp;error,&nbsp;like&nbsp;EAGAIN</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216969">return</span>&nbsp;<span class="num" id="4216976">0</span><span class="op" id="4216977">,</span>&nbsp;<span class="ident" id="4216979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4216990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4216994">if</span>&nbsp;<span class="ident" id="4216997">err</span>&nbsp;<span class="op" id="4217001">:=</span>&nbsp;<span class="ident" id="4217004">c</span><span class="op" id="4217005">.</span><span class="ident" id="4217006">in</span><span class="op" id="4217008">.</span><span class="ident" id="4217009">err</span><span class="op" id="4217012">;</span>&nbsp;<span class="ident" id="4217014">err</span>&nbsp;<span class="op" id="4217018">!=</span>&nbsp;<span class="builtintype" id="4217021">nil</span>&nbsp;<span class="op" id="4217025">{</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217030">return</span>&nbsp;<span class="num" id="4217037">0</span><span class="op" id="4217038">,</span>&nbsp;<span class="ident" id="4217040">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217051">n</span><span class="op" id="4217052">,</span>&nbsp;<span class="ident" id="4217054">err</span>&nbsp;<span class="op" id="4217058">=</span>&nbsp;<span class="ident" id="4217060">c</span><span class="op" id="4217061">.</span><span class="ident" id="4217062">input</span><span class="op" id="4217067">.</span><span class="ident" id="4217068">Read</span><span class="op" id="4217072">(</span><span class="ident" id="4217073">b</span><span class="op" id="4217074">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217078">if</span>&nbsp;<span class="ident" id="4217081">c</span><span class="op" id="4217082">.</span><span class="ident" id="4217083">input</span><span class="op" id="4217088">.</span><span class="ident" id="4217089">off</span>&nbsp;<span class="op" id="4217093">&gt;=</span>&nbsp;<span class="builtinfunc" id="4217096">len</span><span class="op" id="4217099">(</span><span class="ident" id="4217100">c</span><span class="op" id="4217101">.</span><span class="ident" id="4217102">input</span><span class="op" id="4217107">.</span><span class="ident" id="4217108">data</span><span class="op" id="4217112">)</span>&nbsp;<span class="op" id="4217114">{</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217119">c</span><span class="op" id="4217120">.</span><span class="ident" id="4217121">in</span><span class="op" id="4217123">.</span><span class="ident" id="4217124">freeBlock</span><span class="op" id="4217133">(</span><span class="ident" id="4217134">c</span><span class="op" id="4217135">.</span><span class="ident" id="4217136">input</span><span class="op" id="4217141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217146">c</span><span class="op" id="4217147">.</span><span class="ident" id="4217148">input</span>&nbsp;<span class="op" id="4217154">=</span>&nbsp;<span class="builtintype" id="4217156">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217167">//&nbsp;If&nbsp;a&nbsp;close-notify&nbsp;alert&nbsp;is&nbsp;waiting,&nbsp;read&nbsp;it&nbsp;so&nbsp;that</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217224">//&nbsp;we&nbsp;can&nbsp;return&nbsp;(n,&nbsp;EOF)&nbsp;instead&nbsp;of&nbsp;(n,&nbsp;nil),&nbsp;to&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217283">//&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217336">//&nbsp;connection&nbsp;is&nbsp;now&nbsp;closed.&nbsp;This&nbsp;eliminates&nbsp;a&nbsp;race</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217390">//&nbsp;where&nbsp;the&nbsp;HTTP&nbsp;response&nbsp;reading&nbsp;goroutine&nbsp;would</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217443">//&nbsp;otherwise&nbsp;not&nbsp;observe&nbsp;the&nbsp;EOF&nbsp;until&nbsp;its&nbsp;next&nbsp;read,</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217499">//&nbsp;by&nbsp;which&nbsp;time&nbsp;a&nbsp;client&nbsp;goroutine&nbsp;might&nbsp;have&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217556">//&nbsp;tried&nbsp;to&nbsp;reuse&nbsp;the&nbsp;HTTP&nbsp;connection&nbsp;for&nbsp;a&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217606">//&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217620">//&nbsp;See&nbsp;https://codereview.appspot.com/76400046</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4217669">//&nbsp;and&nbsp;http://golang.org/issue/3514</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217707">if</span>&nbsp;<span class="ident" id="4217710">ri</span>&nbsp;<span class="op" id="4217713">:=</span>&nbsp;<span class="ident" id="4217716">c</span><span class="op" id="4217717">.</span><span class="ident" id="4217718">rawInput</span><span class="op" id="4217726">;</span>&nbsp;<span class="ident" id="4217728">ri</span>&nbsp;<span class="op" id="4217731">!=</span>&nbsp;<span class="builtintype" id="4217734">nil</span>&nbsp;<span class="op" id="4217738">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217744">n</span>&nbsp;<span class="op" id="4217746">!=</span>&nbsp;<span class="num" id="4217749">0</span>&nbsp;<span class="op" id="4217751">&amp;&amp;</span>&nbsp;<span class="ident" id="4217754">err</span>&nbsp;<span class="op" id="4217758">==</span>&nbsp;<span class="builtintype" id="4217761">nil</span>&nbsp;<span class="op" id="4217765">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217771">c</span><span class="op" id="4217772">.</span><span class="ident" id="4217773">input</span>&nbsp;<span class="op" id="4217779">==</span>&nbsp;<span class="builtintype" id="4217782">nil</span>&nbsp;<span class="op" id="4217786">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4217789">len</span><span class="op" id="4217792">(</span><span class="ident" id="4217793">ri</span><span class="op" id="4217795">.</span><span class="ident" id="4217796">data</span><span class="op" id="4217800">)</span>&nbsp;<span class="op" id="4217802">&gt;</span>&nbsp;<span class="num" id="4217804">0</span>&nbsp;<span class="op" id="4217806">&amp;&amp;</span>&nbsp;<span class="ident" id="4217809">recordType</span><span class="op" id="4217819">(</span><span class="ident" id="4217820">ri</span><span class="op" id="4217822">.</span><span class="ident" id="4217823">data</span><span class="op" id="4217827">[</span><span class="num" id="4217828">0</span><span class="op" id="4217829">]</span><span class="op" id="4217830">)</span>&nbsp;<span class="op" id="4217832">==</span>&nbsp;<span class="ident" id="4217835">recordTypeAlert</span>&nbsp;<span class="op" id="4217851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217856">if</span>&nbsp;<span class="ident" id="4217859">recErr</span>&nbsp;<span class="op" id="4217866">:=</span>&nbsp;<span class="ident" id="4217869">c</span><span class="op" id="4217870">.</span><span class="ident" id="4217871">readRecord</span><span class="op" id="4217881">(</span><span class="ident" id="4217882">recordTypeApplicationData</span><span class="op" id="4217907">)</span><span class="op" id="4217908">;</span>&nbsp;<span class="ident" id="4217910">recErr</span>&nbsp;<span class="op" id="4217917">!=</span>&nbsp;<span class="builtintype" id="4217920">nil</span>&nbsp;<span class="op" id="4217924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4217930">err</span>&nbsp;<span class="op" id="4217934">=</span>&nbsp;<span class="ident" id="4217936">recErr</span>&nbsp;<span class="comment" id="4217943">//&nbsp;will&nbsp;be&nbsp;io.EOF&nbsp;on&nbsp;closeNotify</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217979">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4217983">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4217988">if</span>&nbsp;<span class="ident" id="4217991">n</span>&nbsp;<span class="op" id="4217993">!=</span>&nbsp;<span class="num" id="4217996">0</span>&nbsp;<span class="op" id="4217998">||</span>&nbsp;<span class="ident" id="4218001">err</span>&nbsp;<span class="op" id="4218005">!=</span>&nbsp;<span class="builtintype" id="4218008">nil</span>&nbsp;<span class="op" id="4218012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218017">return</span>&nbsp;<span class="ident" id="4218024">n</span><span class="op" id="4218025">,</span>&nbsp;<span class="ident" id="4218027">err</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218040">return</span>&nbsp;<span class="num" id="4218047">0</span><span class="op" id="4218048">,</span>&nbsp;<span class="ident" id="4218050">io</span><span class="op" id="4218052">.</span><span class="ident" id="4218053">ErrNoProgress</span><br>
<span class="lineno"></span><span class="op" id="4218067">}</span><br>
<span class="lineno">945</span><br>
<span class="lineno"></span><span class="comment" id="4218070">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4218102">func</span>&nbsp;<span class="op" id="4218107">(</span><span class="ident" id="4218108">c</span>&nbsp;<span class="op" id="4218110">*</span><span class="ident" id="4218111">Conn</span><span class="op" id="4218115">)</span>&nbsp;<span class="ident" id="4218117">Close</span><span class="op" id="4218122">(</span><span class="op" id="4218123">)</span>&nbsp;<span class="builtintype" id="4218125">error</span>&nbsp;<span class="op" id="4218131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218134">var</span>&nbsp;<span class="ident" id="4218138">alertErr</span>&nbsp;<span class="builtintype" id="4218147">error</span><br>
<span class="lineno"></span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218155">c</span><span class="op" id="4218156">.</span><span class="ident" id="4218157">handshakeMutex</span><span class="op" id="4218171">.</span><span class="ident" id="4218172">Lock</span><span class="op" id="4218176">(</span><span class="op" id="4218177">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218180">defer</span>&nbsp;<span class="ident" id="4218186">c</span><span class="op" id="4218187">.</span><span class="ident" id="4218188">handshakeMutex</span><span class="op" id="4218202">.</span><span class="ident" id="4218203">Unlock</span><span class="op" id="4218209">(</span><span class="op" id="4218210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218213">if</span>&nbsp;<span class="ident" id="4218216">c</span><span class="op" id="4218217">.</span><span class="ident" id="4218218">handshakeComplete</span>&nbsp;<span class="op" id="4218236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218240">alertErr</span>&nbsp;<span class="op" id="4218249">=</span>&nbsp;<span class="ident" id="4218251">c</span><span class="op" id="4218252">.</span><span class="ident" id="4218253">sendAlert</span><span class="op" id="4218262">(</span><span class="ident" id="4218263">alertCloseNotify</span><span class="op" id="4218279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218282">}</span><br>
<span class="lineno">955</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218286">if</span>&nbsp;<span class="ident" id="4218289">err</span>&nbsp;<span class="op" id="4218293">:=</span>&nbsp;<span class="ident" id="4218296">c</span><span class="op" id="4218297">.</span><span class="ident" id="4218298">conn</span><span class="op" id="4218302">.</span><span class="ident" id="4218303">Close</span><span class="op" id="4218308">(</span><span class="op" id="4218309">)</span><span class="op" id="4218310">;</span>&nbsp;<span class="ident" id="4218312">err</span>&nbsp;<span class="op" id="4218316">!=</span>&nbsp;<span class="builtintype" id="4218319">nil</span>&nbsp;<span class="op" id="4218323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218327">return</span>&nbsp;<span class="ident" id="4218334">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218342">return</span>&nbsp;<span class="ident" id="4218349">alertErr</span><br>
<span class="lineno">960</span><span class="op" id="4218358">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4218361">//&nbsp;Handshake&nbsp;runs&nbsp;the&nbsp;client&nbsp;or&nbsp;server&nbsp;handshake</span><br>
<span class="lineno"></span><span class="comment" id="4218410">//&nbsp;protocol&nbsp;if&nbsp;it&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;run.</span><br>
<span class="lineno"></span><span class="comment" id="4218450">//&nbsp;Most&nbsp;uses&nbsp;of&nbsp;this&nbsp;package&nbsp;need&nbsp;not&nbsp;call&nbsp;Handshake</span><br>
<span class="lineno">965</span><span class="comment" id="4218503">//&nbsp;explicitly:&nbsp;the&nbsp;first&nbsp;Read&nbsp;or&nbsp;Write&nbsp;will&nbsp;call&nbsp;it&nbsp;automatically.</span><br>
<span class="lineno"></span><span class="keyword" id="4218570">func</span>&nbsp;<span class="op" id="4218575">(</span><span class="ident" id="4218576">c</span>&nbsp;<span class="op" id="4218578">*</span><span class="ident" id="4218579">Conn</span><span class="op" id="4218583">)</span>&nbsp;<span class="ident" id="4218585">Handshake</span><span class="op" id="4218594">(</span><span class="op" id="4218595">)</span>&nbsp;<span class="builtintype" id="4218597">error</span>&nbsp;<span class="op" id="4218603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218606">c</span><span class="op" id="4218607">.</span><span class="ident" id="4218608">handshakeMutex</span><span class="op" id="4218622">.</span><span class="ident" id="4218623">Lock</span><span class="op" id="4218627">(</span><span class="op" id="4218628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218631">defer</span>&nbsp;<span class="ident" id="4218637">c</span><span class="op" id="4218638">.</span><span class="ident" id="4218639">handshakeMutex</span><span class="op" id="4218653">.</span><span class="ident" id="4218654">Unlock</span><span class="op" id="4218660">(</span><span class="op" id="4218661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218664">if</span>&nbsp;<span class="ident" id="4218667">err</span>&nbsp;<span class="op" id="4218671">:=</span>&nbsp;<span class="ident" id="4218674">c</span><span class="op" id="4218675">.</span><span class="ident" id="4218676">handshakeErr</span><span class="op" id="4218688">;</span>&nbsp;<span class="ident" id="4218690">err</span>&nbsp;<span class="op" id="4218694">!=</span>&nbsp;<span class="builtintype" id="4218697">nil</span>&nbsp;<span class="op" id="4218701">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218705">return</span>&nbsp;<span class="ident" id="4218712">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218720">if</span>&nbsp;<span class="ident" id="4218723">c</span><span class="op" id="4218724">.</span><span class="ident" id="4218725">handshakeComplete</span>&nbsp;<span class="op" id="4218743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218747">return</span>&nbsp;<span class="builtintype" id="4218754">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218759">}</span><br>
<span class="lineno">975</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218763">if</span>&nbsp;<span class="ident" id="4218766">c</span><span class="op" id="4218767">.</span><span class="ident" id="4218768">isClient</span>&nbsp;<span class="op" id="4218777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218781">c</span><span class="op" id="4218782">.</span><span class="ident" id="4218783">handshakeErr</span>&nbsp;<span class="op" id="4218796">=</span>&nbsp;<span class="ident" id="4218798">c</span><span class="op" id="4218799">.</span><span class="ident" id="4218800">clientHandshake</span><span class="op" id="4218815">(</span><span class="op" id="4218816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218819">}</span>&nbsp;<span class="keyword" id="4218821">else</span>&nbsp;<span class="op" id="4218826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4218830">c</span><span class="op" id="4218831">.</span><span class="ident" id="4218832">handshakeErr</span>&nbsp;<span class="op" id="4218845">=</span>&nbsp;<span class="ident" id="4218847">c</span><span class="op" id="4218848">.</span><span class="ident" id="4218849">serverHandshake</span><span class="op" id="4218864">(</span><span class="op" id="4218865">)</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4218868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4218871">return</span>&nbsp;<span class="ident" id="4218878">c</span><span class="op" id="4218879">.</span><span class="ident" id="4218880">handshakeErr</span><br>
<span class="lineno"></span><span class="op" id="4218893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4218896">//&nbsp;ConnectionState&nbsp;returns&nbsp;basic&nbsp;TLS&nbsp;details&nbsp;about&nbsp;the&nbsp;connection.</span><br>
<span class="lineno">985</span><span class="keyword" id="4218963">func</span>&nbsp;<span class="op" id="4218968">(</span><span class="ident" id="4218969">c</span>&nbsp;<span class="op" id="4218971">*</span><span class="ident" id="4218972">Conn</span><span class="op" id="4218976">)</span>&nbsp;<span class="ident" id="4218978">ConnectionState</span><span class="op" id="4218993">(</span><span class="op" id="4218994">)</span>&nbsp;<span class="ident" id="4218996">ConnectionState</span>&nbsp;<span class="op" id="4219012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219015">c</span><span class="op" id="4219016">.</span><span class="ident" id="4219017">handshakeMutex</span><span class="op" id="4219031">.</span><span class="ident" id="4219032">Lock</span><span class="op" id="4219036">(</span><span class="op" id="4219037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219040">defer</span>&nbsp;<span class="ident" id="4219046">c</span><span class="op" id="4219047">.</span><span class="ident" id="4219048">handshakeMutex</span><span class="op" id="4219062">.</span><span class="ident" id="4219063">Unlock</span><span class="op" id="4219069">(</span><span class="op" id="4219070">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219074">var</span>&nbsp;<span class="ident" id="4219078">state</span>&nbsp;<span class="ident" id="4219084">ConnectionState</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219101">state</span><span class="op" id="4219106">.</span><span class="ident" id="4219107">HandshakeComplete</span>&nbsp;<span class="op" id="4219125">=</span>&nbsp;<span class="ident" id="4219127">c</span><span class="op" id="4219128">.</span><span class="ident" id="4219129">handshakeComplete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219148">if</span>&nbsp;<span class="ident" id="4219151">c</span><span class="op" id="4219152">.</span><span class="ident" id="4219153">handshakeComplete</span>&nbsp;<span class="op" id="4219171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219175">state</span><span class="op" id="4219180">.</span><span class="ident" id="4219181">Version</span>&nbsp;<span class="op" id="4219189">=</span>&nbsp;<span class="ident" id="4219191">c</span><span class="op" id="4219192">.</span><span class="ident" id="4219193">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219200">state</span><span class="op" id="4219205">.</span><span class="ident" id="4219206">NegotiatedProtocol</span>&nbsp;<span class="op" id="4219225">=</span>&nbsp;<span class="ident" id="4219227">c</span><span class="op" id="4219228">.</span><span class="ident" id="4219229">clientProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219246">state</span><span class="op" id="4219251">.</span><span class="ident" id="4219252">DidResume</span>&nbsp;<span class="op" id="4219262">=</span>&nbsp;<span class="ident" id="4219264">c</span><span class="op" id="4219265">.</span><span class="ident" id="4219266">didResume</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219278">state</span><span class="op" id="4219283">.</span><span class="ident" id="4219284">NegotiatedProtocolIsMutual</span>&nbsp;<span class="op" id="4219311">=</span>&nbsp;<span class="op" id="4219313">!</span><span class="ident" id="4219314">c</span><span class="op" id="4219315">.</span><span class="ident" id="4219316">clientProtocolFallback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219341">state</span><span class="op" id="4219346">.</span><span class="ident" id="4219347">CipherSuite</span>&nbsp;<span class="op" id="4219359">=</span>&nbsp;<span class="ident" id="4219361">c</span><span class="op" id="4219362">.</span><span class="ident" id="4219363">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219377">state</span><span class="op" id="4219382">.</span><span class="ident" id="4219383">PeerCertificates</span>&nbsp;<span class="op" id="4219400">=</span>&nbsp;<span class="ident" id="4219402">c</span><span class="op" id="4219403">.</span><span class="ident" id="4219404">peerCertificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219423">state</span><span class="op" id="4219428">.</span><span class="ident" id="4219429">VerifiedChains</span>&nbsp;<span class="op" id="4219444">=</span>&nbsp;<span class="ident" id="4219446">c</span><span class="op" id="4219447">.</span><span class="ident" id="4219448">verifiedChains</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219465">state</span><span class="op" id="4219470">.</span><span class="ident" id="4219471">ServerName</span>&nbsp;<span class="op" id="4219482">=</span>&nbsp;<span class="ident" id="4219484">c</span><span class="op" id="4219485">.</span><span class="ident" id="4219486">serverName</span><br>
<span class="lineno">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219499">if</span>&nbsp;<span class="op" id="4219502">!</span><span class="ident" id="4219503">c</span><span class="op" id="4219504">.</span><span class="ident" id="4219505">didResume</span>&nbsp;<span class="op" id="4219515">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219520">state</span><span class="op" id="4219525">.</span><span class="ident" id="4219526">TLSUnique</span>&nbsp;<span class="op" id="4219536">=</span>&nbsp;<span class="ident" id="4219538">c</span><span class="op" id="4219539">.</span><span class="ident" id="4219540">firstFinished</span><span class="op" id="4219553">[</span><span class="op" id="4219554">:</span><span class="op" id="4219555">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4219562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219566">return</span>&nbsp;<span class="ident" id="4219573">state</span><br>
<span class="lineno"></span><span class="op" id="4219579">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4219582">//&nbsp;OCSPResponse&nbsp;returns&nbsp;the&nbsp;stapled&nbsp;OCSP&nbsp;response&nbsp;from&nbsp;the&nbsp;TLS&nbsp;server,&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="4219656">//&nbsp;any.&nbsp;(Only&nbsp;valid&nbsp;for&nbsp;client&nbsp;connections.)</span><br>
<span class="lineno">1010</span><span class="keyword" id="4219701">func</span>&nbsp;<span class="op" id="4219706">(</span><span class="ident" id="4219707">c</span>&nbsp;<span class="op" id="4219709">*</span><span class="ident" id="4219710">Conn</span><span class="op" id="4219714">)</span>&nbsp;<span class="ident" id="4219716">OCSPResponse</span><span class="op" id="4219728">(</span><span class="op" id="4219729">)</span>&nbsp;<span class="op" id="4219731">[</span><span class="op" id="4219732">]</span><span class="builtintype" id="4219733">byte</span>&nbsp;<span class="op" id="4219738">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4219741">c</span><span class="op" id="4219742">.</span><span class="ident" id="4219743">handshakeMutex</span><span class="op" id="4219757">.</span><span class="ident" id="4219758">Lock</span><span class="op" id="4219762">(</span><span class="op" id="4219763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219766">defer</span>&nbsp;<span class="ident" id="4219772">c</span><span class="op" id="4219773">.</span><span class="ident" id="4219774">handshakeMutex</span><span class="op" id="4219788">.</span><span class="ident" id="4219789">Unlock</span><span class="op" id="4219795">(</span><span class="op" id="4219796">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4219800">return</span>&nbsp;<span class="ident" id="4219807">c</span><span class="op" id="4219808">.</span><span class="ident" id="4219809">ocspResponse</span><br>
<span class="lineno">1015</span><span class="op" id="4219822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4219825">//&nbsp;VerifyHostname&nbsp;checks&nbsp;that&nbsp;the&nbsp;peer&nbsp;certificate&nbsp;chain&nbsp;is&nbsp;valid&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4219895">//&nbsp;connecting&nbsp;to&nbsp;host.&nbsp;&nbsp;If&nbsp;so,&nbsp;it&nbsp;returns&nbsp;nil;&nbsp;if&nbsp;not,&nbsp;it&nbsp;returns&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="4219970">//&nbsp;describing&nbsp;the&nbsp;problem.</span><br>
<span class="lineno">1020</span><span class="keyword" id="4219997">func</span>&nbsp;<span class="op" id="4220002">(</span><span class="ident" id="4220003">c</span>&nbsp;<span class="op" id="4220005">*</span><span class="ident" id="4220006">Conn</span><span class="op" id="4220010">)</span>&nbsp;<span class="ident" id="4220012">VerifyHostname</span><span class="op" id="4220026">(</span><span class="ident" id="4220027">host</span>&nbsp;<span class="builtintype" id="4220032">string</span><span class="op" id="4220038">)</span>&nbsp;<span class="builtintype" id="4220040">error</span>&nbsp;<span class="op" id="4220046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4220049">c</span><span class="op" id="4220050">.</span><span class="ident" id="4220051">handshakeMutex</span><span class="op" id="4220065">.</span><span class="ident" id="4220066">Lock</span><span class="op" id="4220070">(</span><span class="op" id="4220071">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220074">defer</span>&nbsp;<span class="ident" id="4220080">c</span><span class="op" id="4220081">.</span><span class="ident" id="4220082">handshakeMutex</span><span class="op" id="4220096">.</span><span class="ident" id="4220097">Unlock</span><span class="op" id="4220103">(</span><span class="op" id="4220104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220107">if</span>&nbsp;<span class="op" id="4220110">!</span><span class="ident" id="4220111">c</span><span class="op" id="4220112">.</span><span class="ident" id="4220113">isClient</span>&nbsp;<span class="op" id="4220122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220126">return</span>&nbsp;<span class="ident" id="4220133">errors</span><span class="op" id="4220139">.</span><span class="ident" id="4220140">New</span><span class="op" id="4220143">(</span><span class="string" id="4220144">&#34;tls:&nbsp;VerifyHostname&nbsp;called&nbsp;on&nbsp;TLS&nbsp;server&nbsp;connection&#34;</span><span class="op" id="4220197">)</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220203">if</span>&nbsp;<span class="op" id="4220206">!</span><span class="ident" id="4220207">c</span><span class="op" id="4220208">.</span><span class="ident" id="4220209">handshakeComplete</span>&nbsp;<span class="op" id="4220227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220231">return</span>&nbsp;<span class="ident" id="4220238">errors</span><span class="op" id="4220244">.</span><span class="ident" id="4220245">New</span><span class="op" id="4220248">(</span><span class="string" id="4220249">&#34;tls:&nbsp;handshake&nbsp;has&nbsp;not&nbsp;yet&nbsp;been&nbsp;performed&#34;</span><span class="op" id="4220292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4220295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4220298">return</span>&nbsp;<span class="ident" id="4220305">c</span><span class="op" id="4220306">.</span><span class="ident" id="4220307">peerCertificates</span><span class="op" id="4220323">[</span><span class="num" id="4220324">0</span><span class="op" id="4220325">]</span><span class="op" id="4220326">.</span><span class="ident" id="4220327">VerifyHostname</span><span class="op" id="4220341">(</span><span class="ident" id="4220342">host</span><span class="op" id="4220346">)</span><br>
<span class="lineno">1030</span><span class="op" id="4220348">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
