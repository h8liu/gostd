<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html" class="current">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3751613">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3751668">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3751722">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3751773">//&nbsp;OFB&nbsp;(Output&nbsp;Feedback)&nbsp;Mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3751805">package</span>&nbsp;<span class="ident" id="3751813">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3751821">type</span>&nbsp;<span class="ident" id="3751826">ofb</span>&nbsp;<span class="keyword" id="3751830">struct</span>&nbsp;<span class="op" id="3751837">{</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751840">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751848">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751855">cipher</span>&nbsp;&nbsp;<span class="op" id="3751863">[</span><span class="op" id="3751864">]</span><span class="builtintype" id="3751865">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751871">out</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3751879">[</span><span class="op" id="3751880">]</span><span class="builtintype" id="3751881">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3751887">outUsed</span>&nbsp;<span class="builtintype" id="3751895">int</span><br>
<span class="lineno"></span><span class="op" id="3751899">}</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="comment" id="3751902">//&nbsp;NewOFB&nbsp;returns&nbsp;a&nbsp;Stream&nbsp;that&nbsp;encrypts&nbsp;or&nbsp;decrypts&nbsp;using&nbsp;the&nbsp;block&nbsp;cipher&nbsp;b</span><br>
<span class="lineno"></span><span class="comment" id="3751980">//&nbsp;in&nbsp;output&nbsp;feedback&nbsp;mode.&nbsp;The&nbsp;initialization&nbsp;vector&nbsp;iv&#39;s&nbsp;length&nbsp;must&nbsp;be&nbsp;equal</span><br>
<span class="lineno"></span><span class="comment" id="3752060">//&nbsp;to&nbsp;b&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno"></span><span class="keyword" id="3752082">func</span>&nbsp;<span class="ident" id="3752087">NewOFB</span><span class="op" id="3752093">(</span><span class="ident" id="3752094">b</span>&nbsp;<span class="ident" id="3752096">Block</span><span class="op" id="3752101">,</span>&nbsp;<span class="ident" id="3752103">iv</span>&nbsp;<span class="op" id="3752106">[</span><span class="op" id="3752107">]</span><span class="builtintype" id="3752108">byte</span><span class="op" id="3752112">)</span>&nbsp;<span class="ident" id="3752114">Stream</span>&nbsp;<span class="op" id="3752121">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752124">blockSize</span>&nbsp;<span class="op" id="3752134">:=</span>&nbsp;<span class="ident" id="3752137">b</span><span class="op" id="3752138">.</span><span class="ident" id="3752139">BlockSize</span><span class="op" id="3752148">(</span><span class="op" id="3752149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752152">if</span>&nbsp;<span class="builtinfunc" id="3752155">len</span><span class="op" id="3752158">(</span><span class="ident" id="3752159">iv</span><span class="op" id="3752161">)</span>&nbsp;<span class="op" id="3752163">!=</span>&nbsp;<span class="ident" id="3752166">blockSize</span>&nbsp;<span class="op" id="3752176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752180">return</span>&nbsp;<span class="ident" id="3752187">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752195">bufSize</span>&nbsp;<span class="op" id="3752203">:=</span>&nbsp;<span class="ident" id="3752206">streamBufferSize</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752224">if</span>&nbsp;<span class="ident" id="3752227">bufSize</span>&nbsp;<span class="op" id="3752235">&lt;</span>&nbsp;<span class="ident" id="3752237">blockSize</span>&nbsp;<span class="op" id="3752247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752251">bufSize</span>&nbsp;<span class="op" id="3752259">=</span>&nbsp;<span class="ident" id="3752261">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752275">x</span>&nbsp;<span class="op" id="3752277">:=</span>&nbsp;<span class="op" id="3752280">&amp;</span><span class="ident" id="3752281">ofb</span><span class="op" id="3752284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752288">b</span><span class="op" id="3752289">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752297">b</span><span class="op" id="3752298">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752302">cipher</span><span class="op" id="3752308">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3752311">make</span><span class="op" id="3752315">(</span><span class="op" id="3752316">[</span><span class="op" id="3752317">]</span><span class="builtintype" id="3752318">byte</span><span class="op" id="3752322">,</span>&nbsp;<span class="ident" id="3752324">blockSize</span><span class="op" id="3752333">)</span><span class="op" id="3752334">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752338">out</span><span class="op" id="3752341">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752347">make</span><span class="op" id="3752351">(</span><span class="op" id="3752352">[</span><span class="op" id="3752353">]</span><span class="builtintype" id="3752354">byte</span><span class="op" id="3752358">,</span>&nbsp;<span class="num" id="3752360">0</span><span class="op" id="3752361">,</span>&nbsp;<span class="ident" id="3752363">bufSize</span><span class="op" id="3752370">)</span><span class="op" id="3752371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752375">outUsed</span><span class="op" id="3752382">:</span>&nbsp;<span class="num" id="3752384">0</span><span class="op" id="3752385">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752388">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752392">copy</span><span class="op" id="3752396">(</span><span class="ident" id="3752397">x</span><span class="op" id="3752398">.</span><span class="ident" id="3752399">cipher</span><span class="op" id="3752405">,</span>&nbsp;<span class="ident" id="3752407">iv</span><span class="op" id="3752409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752412">return</span>&nbsp;<span class="ident" id="3752419">x</span><br>
<span class="lineno"></span><span class="op" id="3752421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3752424">func</span>&nbsp;<span class="op" id="3752429">(</span><span class="ident" id="3752430">x</span>&nbsp;<span class="op" id="3752432">*</span><span class="ident" id="3752433">ofb</span><span class="op" id="3752436">)</span>&nbsp;<span class="ident" id="3752438">refill</span><span class="op" id="3752444">(</span><span class="op" id="3752445">)</span>&nbsp;<span class="op" id="3752447">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752450">bs</span>&nbsp;<span class="op" id="3752453">:=</span>&nbsp;<span class="ident" id="3752456">x</span><span class="op" id="3752457">.</span><span class="ident" id="3752458">b</span><span class="op" id="3752459">.</span><span class="ident" id="3752460">BlockSize</span><span class="op" id="3752469">(</span><span class="op" id="3752470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752473">remain</span>&nbsp;<span class="op" id="3752480">:=</span>&nbsp;<span class="builtinfunc" id="3752483">len</span><span class="op" id="3752486">(</span><span class="ident" id="3752487">x</span><span class="op" id="3752488">.</span><span class="ident" id="3752489">out</span><span class="op" id="3752492">)</span>&nbsp;<span class="op" id="3752494">-</span>&nbsp;<span class="ident" id="3752496">x</span><span class="op" id="3752497">.</span><span class="ident" id="3752498">outUsed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752507">if</span>&nbsp;<span class="ident" id="3752510">remain</span>&nbsp;<span class="op" id="3752517">&gt;</span>&nbsp;<span class="ident" id="3752519">x</span><span class="op" id="3752520">.</span><span class="ident" id="3752521">outUsed</span>&nbsp;<span class="op" id="3752529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752533">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752541">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752544">copy</span><span class="op" id="3752548">(</span><span class="ident" id="3752549">x</span><span class="op" id="3752550">.</span><span class="ident" id="3752551">out</span><span class="op" id="3752554">,</span>&nbsp;<span class="ident" id="3752556">x</span><span class="op" id="3752557">.</span><span class="ident" id="3752558">out</span><span class="op" id="3752561">[</span><span class="ident" id="3752562">x</span><span class="op" id="3752563">.</span><span class="ident" id="3752564">outUsed</span><span class="op" id="3752571">:</span><span class="op" id="3752572">]</span><span class="op" id="3752573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752576">x</span><span class="op" id="3752577">.</span><span class="ident" id="3752578">out</span>&nbsp;<span class="op" id="3752582">=</span>&nbsp;<span class="ident" id="3752584">x</span><span class="op" id="3752585">.</span><span class="ident" id="3752586">out</span><span class="op" id="3752589">[</span><span class="op" id="3752590">:</span><span class="builtinfunc" id="3752591">cap</span><span class="op" id="3752594">(</span><span class="ident" id="3752595">x</span><span class="op" id="3752596">.</span><span class="ident" id="3752597">out</span><span class="op" id="3752600">)</span><span class="op" id="3752601">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752604">for</span>&nbsp;<span class="ident" id="3752608">remain</span>&nbsp;<span class="op" id="3752615">&lt;</span>&nbsp;<span class="builtinfunc" id="3752617">len</span><span class="op" id="3752620">(</span><span class="ident" id="3752621">x</span><span class="op" id="3752622">.</span><span class="ident" id="3752623">out</span><span class="op" id="3752626">)</span><span class="op" id="3752627">-</span><span class="ident" id="3752628">bs</span>&nbsp;<span class="op" id="3752631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752635">x</span><span class="op" id="3752636">.</span><span class="ident" id="3752637">b</span><span class="op" id="3752638">.</span><span class="ident" id="3752639">Encrypt</span><span class="op" id="3752646">(</span><span class="ident" id="3752647">x</span><span class="op" id="3752648">.</span><span class="ident" id="3752649">cipher</span><span class="op" id="3752655">,</span>&nbsp;<span class="ident" id="3752657">x</span><span class="op" id="3752658">.</span><span class="ident" id="3752659">cipher</span><span class="op" id="3752665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3752669">copy</span><span class="op" id="3752673">(</span><span class="ident" id="3752674">x</span><span class="op" id="3752675">.</span><span class="ident" id="3752676">out</span><span class="op" id="3752679">[</span><span class="ident" id="3752680">remain</span><span class="op" id="3752686">:</span><span class="op" id="3752687">]</span><span class="op" id="3752688">,</span>&nbsp;<span class="ident" id="3752690">x</span><span class="op" id="3752691">.</span><span class="ident" id="3752692">cipher</span><span class="op" id="3752698">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752702">remain</span>&nbsp;<span class="op" id="3752709">+=</span>&nbsp;<span class="ident" id="3752712">bs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752719">x</span><span class="op" id="3752720">.</span><span class="ident" id="3752721">out</span>&nbsp;<span class="op" id="3752725">=</span>&nbsp;<span class="ident" id="3752727">x</span><span class="op" id="3752728">.</span><span class="ident" id="3752729">out</span><span class="op" id="3752732">[</span><span class="op" id="3752733">:</span><span class="ident" id="3752734">remain</span><span class="op" id="3752740">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752743">x</span><span class="op" id="3752744">.</span><span class="ident" id="3752745">outUsed</span>&nbsp;<span class="op" id="3752753">=</span>&nbsp;<span class="num" id="3752755">0</span><br>
<span class="lineno"></span><span class="op" id="3752757">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="3752760">func</span>&nbsp;<span class="op" id="3752765">(</span><span class="ident" id="3752766">x</span>&nbsp;<span class="op" id="3752768">*</span><span class="ident" id="3752769">ofb</span><span class="op" id="3752772">)</span>&nbsp;<span class="ident" id="3752774">XORKeyStream</span><span class="op" id="3752786">(</span><span class="ident" id="3752787">dst</span><span class="op" id="3752790">,</span>&nbsp;<span class="ident" id="3752792">src</span>&nbsp;<span class="op" id="3752796">[</span><span class="op" id="3752797">]</span><span class="builtintype" id="3752798">byte</span><span class="op" id="3752802">)</span>&nbsp;<span class="op" id="3752804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752807">for</span>&nbsp;<span class="builtinfunc" id="3752811">len</span><span class="op" id="3752814">(</span><span class="ident" id="3752815">src</span><span class="op" id="3752818">)</span>&nbsp;<span class="op" id="3752820">&gt;</span>&nbsp;<span class="num" id="3752822">0</span>&nbsp;<span class="op" id="3752824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3752828">if</span>&nbsp;<span class="ident" id="3752831">x</span><span class="op" id="3752832">.</span><span class="ident" id="3752833">outUsed</span>&nbsp;<span class="op" id="3752841">&gt;=</span>&nbsp;<span class="builtinfunc" id="3752844">len</span><span class="op" id="3752847">(</span><span class="ident" id="3752848">x</span><span class="op" id="3752849">.</span><span class="ident" id="3752850">out</span><span class="op" id="3752853">)</span><span class="op" id="3752854">-</span><span class="ident" id="3752855">x</span><span class="op" id="3752856">.</span><span class="ident" id="3752857">b</span><span class="op" id="3752858">.</span><span class="ident" id="3752859">BlockSize</span><span class="op" id="3752868">(</span><span class="op" id="3752869">)</span>&nbsp;<span class="op" id="3752871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752876">x</span><span class="op" id="3752877">.</span><span class="ident" id="3752878">refill</span><span class="op" id="3752884">(</span><span class="op" id="3752885">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752893">n</span>&nbsp;<span class="op" id="3752895">:=</span>&nbsp;<span class="ident" id="3752898">xorBytes</span><span class="op" id="3752906">(</span><span class="ident" id="3752907">dst</span><span class="op" id="3752910">,</span>&nbsp;<span class="ident" id="3752912">src</span><span class="op" id="3752915">,</span>&nbsp;<span class="ident" id="3752917">x</span><span class="op" id="3752918">.</span><span class="ident" id="3752919">out</span><span class="op" id="3752922">[</span><span class="ident" id="3752923">x</span><span class="op" id="3752924">.</span><span class="ident" id="3752925">outUsed</span><span class="op" id="3752932">:</span><span class="op" id="3752933">]</span><span class="op" id="3752934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752938">dst</span>&nbsp;<span class="op" id="3752942">=</span>&nbsp;<span class="ident" id="3752944">dst</span><span class="op" id="3752947">[</span><span class="ident" id="3752948">n</span><span class="op" id="3752949">:</span><span class="op" id="3752950">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752954">src</span>&nbsp;<span class="op" id="3752958">=</span>&nbsp;<span class="ident" id="3752960">src</span><span class="op" id="3752963">[</span><span class="ident" id="3752964">n</span><span class="op" id="3752965">:</span><span class="op" id="3752966">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3752970">x</span><span class="op" id="3752971">.</span><span class="ident" id="3752972">outUsed</span>&nbsp;<span class="op" id="3752980">+=</span>&nbsp;<span class="ident" id="3752983">n</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3752986">}</span><br>
<span class="lineno"></span><span class="op" id="3752988">}</span>
</div>
</body>
</html>
